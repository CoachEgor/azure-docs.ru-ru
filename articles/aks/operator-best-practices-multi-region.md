---
title: Высокая доступность и аварийное восстановление в службе Azure Kubernetes (AKS)
description: Изучите рекомендации оператора кластера для достижения максимального времени работы приложений, обеспечения высокой доступности и подготовки к аварийному восстановлению в службе Azure Kubernetes Service (AKS).
services: container-service
author: lastcoolnameleft
ms.topic: conceptual
ms.date: 11/28/2018
ms.author: thfalgou
ms.custom: fasttrack-edit
ms.openlocfilehash: 3c1f0bb715b3c3bf9b3a3350ab11e26834aa84c8
ms.sourcegitcommit: c5661c5cab5f6f13b19ce5203ac2159883b30c0e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2020
ms.locfileid: "80528661"
---
# <a name="best-practices-for-business-continuity-and-disaster-recovery-in-azure-kubernetes-service-aks"></a>Рекомендации по обеспечению непрерывности бизнес-процессов и аварийного восстановления в Службе Azure Kubernetes (AKS)

При управлении кластерами в Службе Azure Kubernetes (AKS) время бесперебойной работы приложений является важным аспектом. AKS обеспечивает высокий уровень доступности, объединяя несколько узлов в одну группу доступности. Но эти несколько узлов не защищают вашу систему от сбоя региона. Чтобы максимально увеличить время простоя, планируйте заранее, чтобы сохранить непрерывность бизнеса и подготовиться к аварийному восстановлению.

В этой статье основное внимание уделяется планированию непрерывности бизнеса и аварийного восстановления в АКС. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Планирование кластеров AKS в нескольких регионах.
> * Трафик маршрутов через несколько кластеров с помощью Azure Traffic Manager.
> * Используйте георепликацию для реестров изображений контейнеров.
> * Планирование состояния приложения в нескольких кластерах.
> * Реплицировать хранение в нескольких регионах.

## <a name="plan-for-multiregion-deployment"></a>План многорегионального развертывания

**Лучшая практика:** При развертывании нескольких кластеров AKS выбирайте регионы, в которых доступна AKS, и используйте парные области.

Кластер AKS развертывается в одном регионе. Чтобы защитить систему от сбоя в регионе, развернуть приложение в нескольких кластерах AKS в разных регионах. При планировании развертывания кластера AKS следует:

* [**Доступность региона AKS**](https://docs.microsoft.com/azure/aks/quotas-skus-regions#region-availability): Выберите регионы, близкие к пользователям. АКС постоянно расширяется в новые регионы.
* [**Области сопряжения Azure:**](https://docs.microsoft.com/azure/best-practices-availability-paired-regions)Для вашего географического района выберите два региона, которые в паре друг с другом. Парные регионы координируют обновления платформ ы и при необходимости отдают приоритет усилиям по восстановлению.
* **Доступность сервиса**: Решите, должны ли ваши парные регионы быть горячими/горячими, горячими/теплыми или горячими/холодными. Вы хотите запустить оба региона одновременно, с одним регионом *готовы* начать обслуживать трафик? Или вы хотите, чтобы в одном регионе было время, чтобы подготовиться к обслуживаемому трафику?

Доступность акС и парные регионы являются совместным соображением. Развертывайте кластеры AKS в парах регионах, для которых настроено совместное управление аварийным восстановлением при региональных сбоях. Например, AKS доступны в регионах Восточная часть США и Западная часть США. Эти регионы являются парными. Выберите эти два региона при создании стратегии AKS BC/DR.

При развертывании приложения добавьте еще один шаг к конвейеру CI/CD для развертывания в этих нескольких кластерах AKS. Если не обновлять конвейеры развертывания, приложения могут быть развернуты только в одном из регионов и кластеров AKS. Трафик клиентов, направленный на второстепенный регион, не будет получать последние обновления кода.

## <a name="use-azure-traffic-manager-to-route-traffic"></a>Использование диспетчера трафика Azure для маршрутизации трафика

**Лучшая практика:** Менеджер трафика Azure может направлять клиентов к их близкому кластеру AKS и экземпляру приложений. Для наилучшей производительности и избыточности направьте весь трафик приложений через traffic Manager, прежде чем он перейдет в кластер AKS.

Если у вас есть несколько кластеров AKS в разных регионах, используйте диспетчер трафика для управления потоками трафика в приложения, которые работают в каждом кластере. [Диспетчер трафика Azure](https://docs.microsoft.com/azure/traffic-manager/) — это подсистема балансировки нагрузки на основе DNS, которая может распределять сетевой трафик между регионами. Используйте диспетчер трафика для маршрутизации пользователей на основе времени отклика кластера или на основе географии.

![AKS с менеджером по трафику](media/operator-best-practices-bc-dr/aks-azure-traffic-manager.png)

Клиенты, имеющие единый кластер AKS, обычно подключаются к исправному сервису или DNS-названию данного приложения. В развертывании нескольких кластеров клиенты должны подключиться к имени DNS-менеджера трафика, которое указывает на службы в каждом кластере AKS. Определите эти службы с помощью конечных точек traffic Manager. Каждая конечная точка является *IP-адресом баланса нагрузки на службу.* Используйте эту конфигурацию для направления сетевого трафика из конечных точек менеджера трафика в одном регионе в конечную точку в другом регионе.

![Географическая скорость через диспетчер ауд](media/operator-best-practices-bc-dr/traffic-manager-geographic-routing.png)

Диспетчер трафика выполняет поиск DNS и возвращает наиболее подходящую конечную точку пользователя. Вложенные профили могут расставить приоритеты основного местоположения. Например, пользователи должны обычно подключаться к своему близкому географическому региону. Если в этом регионе возникла проблема, диспетчер трафика направляет пользователей во вторичный регион. Такой подход гарантирует, что клиенты могут подключиться к экземпляру приложения, даже если их ближайший географический регион недоступен.

Для получения информации о том, как настроить конечные точки и правила, [см.](https://docs.microsoft.com/azure/traffic-manager/traffic-manager-configure-geographic-routing-method)

### <a name="layer-7-application-routing-with-azure-front-door-service"></a>Routing приложений уровня 7 с помощью службы передних дверей Azure

Диспетчер трафика использует DNS (слой 3) для формирования трафика. [Служба передних дверей Azure](https://docs.microsoft.com/azure/frontdoor/front-door-overview) предоставляет опцию ruouting HTTP/HTTPS (слой 7). Дополнительные функции службы Передних дверей Azure включают прекращение TLS, пользовательский домен, брандмауэр веб-приложений, переписывание URL и сродство сеансов. Оцените требования к трафику для приложения, чтобы выбрать оптимальное решение.

### <a name="interconnect-regions-with-global-virtual-network-peering"></a>Взаимосвязь регионов с глобальной виртуальной сети пиринга

Если кластерам нужно разговаривать друг с другом, подключение обеих виртуальных сетей друг к другу может быть достигнуто с [помощью виртуальной сети пиринга.](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) Эта технология соединяет виртуальные сети друг с другом, обеспечивая высокую пропускную способность в магистральной сети Корпорации Майкрософт, даже в различных географических регионах.

Предпосылкой для работы виртуальных сетей, в которых работают кластеры AKS, является использование стандартного баланса нагрузки в кластере AKS, чтобы службы Kubernetes были доступны в виртуальной сети.

## <a name="enable-geo-replication-for-container-images"></a>Включение георепликации для образов контейнеров

**Лучшая практика:** Храните изображения контейнеров в реестре контейнеров Azure и гео-реплицируйте реестр в каждом регионе AKS.

Чтобы развернуть и выполнить приложения в AKS, вам нужен определенный способ хранить и извлекать образы контейнеров. Контейнерный реестр интегрируется с AKS, поэтому он может надежно хранить изображения контейнеров или диаграммы helm. Реестр контейнеров поддерживает мультимастерную георепликацию для автоматического воспроизведения изображений в регионах Azure по всему миру. 

Для повышения производительности и доступности используйте георепликацию реестра контейнеров для создания реестра в каждом регионе, где есть кластер AKS. Затем каждый кластер AKS вытягивает изображения контейнеров из локального реестра контейнеров в одном регионе:

![Георепликация реестра контейнеров для изображений контейнеров](media/operator-best-practices-bc-dr/acr-geo-replication.png)

При использовании георепликации контейнерного реестра для вытягивания изображений из одного региона результаты:

* **Быстрее:** Вы извлекаете изображения из высокоскоростных сетевых соединений с низкой задержкой в пределах того же региона Azure.
* **Более надежный:** Если область недоступна, кластер AKS вытягивает изображения из доступного реестра контейнеров.
* **Дешевле**: Между центрами обработки данных нет платы за выход из сети.

Георепликация является особенностью контейнерных реестров *Premium* SKU. Для получения информации о том, как [Container Registry geo-replication](https://docs.microsoft.com/azure/container-registry/container-registry-geo-replication)настроить георепликацию, см.

## <a name="remove-service-state-from-inside-containers"></a>Удаление состояния службы из контейнеров

**Лучшая практика**: Там, где это возможно, не храните состояние обслуживания внутри контейнера. Вместо этого используйте платформу Azure в качестве службы (PaaS), которая поддерживает репликацию многорегионов.

*Состояние службы* относится к данным в памяти или на диске, которые требуется службе для функционирования. Сюда входят структуры данных и переменные-члены, которые считываются и записываются службой. В зависимости от того, как будет архитектура службы, состояние может также включать файлы или другие ресурсы, которые хранятся на диске. Например, в состояние могут быть включены файлы, которые база данных использует для хранения данных и журналов транзакций.

Состояние может быть либо экстернализовано, либо перемещено с кодом, который манипулирует состоянием. Как правило, вы экстернализуете состояние с помощью базы данных или другого хранилища данных, который работает на разных машинах по сети или который иссякает на одной и той же машине.

Контейнеры и микрослужбы наиболее устойчивы, когда процессы, которые проходят внутри них, не сохраняют состояние. Поскольку приложения почти всегда содержат некоторые состояния, используйте такое решение PaaS, например, база данных Azure для MyS'L, база данных Azure для PostgreS-L или базу данных Azure S'L.

Для создания портативных приложений см.

* [Методология приложения из 12 факторов](https://12factor.net/)
* [Выполнение веб-приложения в нескольких регионах Azure](https://docs.microsoft.com/azure/architecture/reference-architectures/app-service-web-app/multi-region)

## <a name="create-a-storage-migration-plan"></a>Создание плана миграции хранилища

**Лучшая практика:** Если вы используете хранилище Azure, подготовьте и проверьте, как перенести хранилище из основной области в область резервного копирования.

Приложения могут использовать для своих данных хранилище Azure. Поскольку приложения распределены по нескольким кластерам AKS в разных регионах, необходимо синхронизировать хранилище. Вот два общих способа репликации хранилища:

* Асинхронная репликация на основе инфраструктуры
* асинхронная репликация на основе приложений;

### <a name="infrastructure-based-asynchronous-replication"></a>Асинхронная репликация на основе инфраструктуры

Приложениямогут постоянно хранить даже после удаления стручка. В Kubernetes можно использовать постоянные объемы для сохранения хранения данных. Стойкие тома устанавливаются на узла VM, а затем подвергаются стручки. Постоянные тома следуют за стручками, даже если стручки перемещаются в другой узла внутри одного и того же кластера.

Используемая стратегия репликации зависит от решения для хранения данных. Общие решения для хранения данных, такие как [Gluster,](https://docs.gluster.org/en/latest/Administrator%20Guide/Geo%20Replication/) [Ceph,](https://docs.ceph.com/docs/master/cephfs/disaster-recovery/) [Rook](https://rook.io/docs/rook/v1.2/ceph-disaster-recovery.html)и [Portworx,](https://docs.portworx.com/scheduler/kubernetes/going-production-with-k8s.html#disaster-recovery-with-cloudsnaps) предоставляют свои собственные рекомендации по аварийному восстановлению и репликации.

Типичная стратегия заключается в обеспечении общей точки хранения, где приложения могут писать свои данные. Затем эти данные реплицируются в другие регионы и предоставляются для локального доступа.

![Асинхронная репликация на основе инфраструктуры](media/operator-best-practices-bc-dr/aks-infra-based-async-repl.png)

При использовании управляемых дисков Azure можно выбрать решения репликации и DR:

* [Велеро на Лазурном берегу](https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure/blob/master/README.md)
* [Azure Site Recovery](https://azure.microsoft.com/blog/asr-managed-disks-between-azure-regions/)

### <a name="application-based-asynchronous-replication"></a>асинхронная репликация на основе приложений;

Kubernetes в настоящее время не обеспечивает нативную реализацию для асинхронной репликации на основе приложений. Поскольку контейнеры и Kubernetes слабо связаны, любой традиционный подход к применению или языку должен работать. Как правило, сами приложения реплицируют запросы на хранение, которые затем записываются на основное хранилище данных каждого кластера.

![асинхронная репликация на основе приложений;](media/operator-best-practices-bc-dr/aks-app-based-async-repl.png)

## <a name="next-steps"></a>Дальнейшие действия

В этой статье основное внимание уделяется вопросам непрерывности бизнеса и восстановления аварийности для кластеров AKS. Для получения дополнительной информации о кластерных операциях в AKS см.

* [Многотенность и кластерная изоляция][aks-best-practices-cluster-isolation]
* [Основные функции планировщика Kubernetes][aks-best-practices-scheduler]

<!-- INTERNAL LINKS -->
[aks-best-practices-scheduler]: operator-best-practices-scheduler.md
[aks-best-practices-cluster-isolation]: operator-best-practices-cluster-isolation.md
