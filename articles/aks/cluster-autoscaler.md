---
title: Использование средства автомасштабирования кластера в Службе контейнеров Azure
description: Узнайте, как использовать средство автомасштабирования кластера для автомасштабирования кластера в Службе контейнеров Azure в соответствии с требованиями приложения.
services: container-service
author: mlearned
ms.service: container-service
ms.topic: article
ms.date: 07/08/2019
ms.author: mlearned
ms.openlocfilehash: 3ce080871ff2a38efcc75f6ff6b584af14014879
ms.sourcegitcommit: 2e4b99023ecaf2ea3d6d3604da068d04682a8c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67666006"
---
# <a name="preview---automatically-scale-a-cluster-to-meet-application-demands-on-azure-kubernetes-service-aks"></a>Preview — автоматическое масштабирование кластера в соответствии с требованиями приложения в службе Azure Kubernetes (AKS)

Чтобы удовлетворить растущие требования приложения к Службе контейнеров Azure (AKS), вы можете изменить число узлов, на которых выполняются рабочие нагрузки. Компоненты кластера автомасштабирования могут отслеживать нехватку назначенных pod в кластере, связанную с ограничениями на ресурсы. При обнаружении проблем число узлов увеличивается в соответствии с требованиями приложения. Также регулярно проверяется наличие узлов с малым числом запущенных pod, при их обнаружении число узлов соответствующим образом снижается. Такая возможность автоматически масштабировать количество узлов в кластере AKS обеспечивает эффективное и экономное использование кластера.

В этой статье показано, как включить и администрировать средство автомасштабирования для кластера AKS. Автомасштабирования кластера следует тестировать только в предварительной версии в кластерах AKS на одном узле пула.

> [!IMPORTANT]
> Функции предварительной версии AKS: самообслуживания, согласиться. Они предназначены для сбора отзывов и ошибки нашего сообщества. В предварительной версии эти функции не предназначены для использования в рабочей среде. Функции в общедоступной предварительной версии подпадают под поддержки «оптимальных затрат». Помощь от групп разработчиков AKS Техническая поддержка доступна во время рабочих часов тихоокеанского часового пояса (по тихоокеанскому времени) только. Дополнительные сведения обратитесь в следующие справочные статьи:
>
> * [Политики поддержки AKS][aks-support-policies]
> * [Часто задаваемые вопросы о поддержке Azure][aks-faq]

## <a name="before-you-begin"></a>Перед началом работы

Здесь предполагается, что вы используете Azure CLI версии 2.0.65 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

### <a name="install-aks-preview-cli-extension"></a>Установка расширения интерфейса командной строки aks-preview

Чтобы использовать инструмент автомасштабирования кластера, вам потребуется *предварительной версии aks* CLI версия расширения 0.4.1 или более поздней версии. Установка *предварительной версии aks* расширение Azure CLI с помощью [добавить расширения az][az-extension-add] command, then check for any available updates using the [az extension update][az-extension-update] команда::

```azurecli-interactive
# Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
```

### <a name="register-scale-set-feature-provider"></a>Регистрация поставщика компонента масштабируемых наборов

Чтобы создать службу AKS, которая использует масштабируемые наборы, необходимо также включить соответствующий флаг компонента в своей подписке. Чтобы зарегистрировать *VMSSPreview* флаг, используйте [az функция register][az-feature-register] команды, как показано в следующем примере:

> [!CAUTION]
> При регистрации компонента для подписки, вы не можете сейчас отменить регистрацию этой функции. После включения некоторые возможности предварительной версии, можно использовать значения по умолчанию для всех кластеров AKS, затем создается в подписке. Не включайте функции предварительной версии на рабочие подписки. Используйте отдельную подписку для тестирования функции предварительной версии и собирайте отзывы.

```azurecli-interactive
az feature register --name VMSSPreview --namespace Microsoft.ContainerService
```

Через несколько минут отобразится состояние *Registered* (Зарегистрировано). Вы можете проверить состояние регистрации с помощью [список функций az][az-feature-list] команды:

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/VMSSPreview')].{Name:name,State:properties.state}"
```

Когда все будет готово, обновить регистрацию *Microsoft.ContainerService* поставщик ресурсов с помощью [az provider register][az-provider-register] команды:

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

## <a name="limitations"></a>Ограничения

При создании и управление кластерами AKS, использовать инструмент автомасштабирования кластера, применяются следующие ограничения:

* Нельзя использовать надстройку маршрутизации HTTP приложения.

## <a name="about-the-cluster-autoscaler"></a>Сведения о средстве автомасштабирования кластера

Чтобы учитывать постоянно меняющиеся требования приложения, например регулярное изменение нагрузки в течение дня или недели, часто требуется механизм автомасштабирования кластера. Для кластеров AKS существуют два способа масштабирования.

* **Средство автомасштабирования кластера** отслеживает невозможность назначить на узел новые pod, связанную с ограниченными ресурсами. При возникновении такой ситуации число узлов в кластере автоматически повышается.
* **Средство горизонтального автомасштабирования pod** использует сервер метрик в кластере Kubernetes для отслеживания потребностей pod в ресурсах. Если службе нужно больше ресурсов, количество pod автоматически увеличивается в соответствии с требованиями.

![Средство автомасштабирования кластера и средство горизонтального автомасштабирования pod часто используются вместе, чтобы учитывать любые изменения требований приложения.](media/autoscaler/cluster-autoscaler.png)

Оба этих средства могут уменьшать количество pod и узлов, когда в них отпадает надобность. Средство автомасштабирования кластера уменьшает количество узлов, если в течение определенного периода времени существует неиспользуемая емкость. Pod на узле, который будет удаляться, безопасно перемещаются средством автомасштабирования в другое расположение в том же кластере. Средство автомасштабирования кластера не сможет уменьшить масштаб, если pod невозможно переместить, например в следующих ситуациях:

* если pod создан напрямую на узле, а не через объект контроллера, например в наборе развертывания или реплик;
* если бюджет неработоспособности pod имеет слишком строгие условия и не допускает снижение числа pod ниже определенного порогового значения;
* если pod использует селекторы узла или свойства удаления сходства, которые невозможно выполнить, так как они запланированы на другом узле.

Дополнительные сведения о том, как кластер автомасштабирования не удается масштабировать см. в разделе [типы модулей может предотвратить удаление узла кластера автомасштабирования?][autoscaler-scaledown]

Средство автомасштабирования кластера использует параметры запуска для выбора интервалов времени между событиями масштабирования, пороговых значений для ресурсов и т. п. Эти параметры определяются платформой Azure и пока не доступны для настройки вручную. Дополнительные сведения о параметрах автомасштабирования кластера используется, см. в разделе [Каковы параметры автомасштабирования кластера?][autoscaler-parameters].

Упомянутые два средства автомасштабирования могут работать вместе, и часто оба средства развертываются в кластере. При совместной работе средство горизонтального автомасштабирования pod берет на себя управление числом pod, необходимых для удовлетворения требований приложения. Средство автомасштабирования кластера контролирует, в свою очередь, количество узлов для работы запланированного числа pod.

> [!NOTE]
> При использовании средства автомасштабирования кластера отключается возможность масштабирования вручную. Позвольте этому средству самостоятельно определять необходимое количество узлов. Если вы предпочитаете выполнять масштабирование кластера вручную, [отключите средство автомасштабирования кластера](#disable-the-cluster-autoscaler).

## <a name="create-an-aks-cluster-and-enable-the-cluster-autoscaler"></a>Создание кластера AKS и включение средства автомасштабирования кластера

Если вам нужно создать кластер AKS, используйте [создать az aks][az-aks-create] команды. В параметре *--kubernetes-version* укажите версию не ниже минимально необходимой, как описано выше в разделе [Перед началом работы](#before-you-begin). Чтобы включить и настроить средство автомасштабирования кластера, примените параметр *--enable-cluster-autoscaler* и укажите минимальное ( *--min-count*) и максимальное ( *--max-count*) число узлов.

> [!IMPORTANT]
> Компонент Kubernetes является средством автомасштабирования кластера. Хотя в кластере AKS используется масштабируемый набор виртуальных машин для узлов, не включайте и не изменяйте вручную параметры автомасштабирования масштабируемого набора на портале Azure или с помощью Azure CLI. Разрешите средству автомасштабирования кластера Kubernetes устанавливать необходимые параметры масштабирования. Дополнительные сведения см. в разделе [. можно ли изменить ресурсы AKS в группе ресурсов узла?](faq.md#can-i-modify-tags-and-other-properties-of-the-aks-resources-in-the-node-resource-group)

В следующем примере создается кластер AKS с масштабируемым набором виртуальных машин, включенным средством автомасштабирования кластера и числом узлов в диапазоне от *1* до *3*:

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location canadaeast

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --enable-vmss \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Создание кластера и настройка параметров автомасштабирования кластера занимает несколько минут.

### <a name="enable-the-cluster-autoscaler-on-an-existing-aks-cluster"></a>Включение средства автомасштабирования кластера для существующего кластера AKS

Вы можете включить средство автомасштабирования кластера для существующего кластера AKS, который соответствует требованиям из предыдущего раздела [Перед началом работы](#before-you-begin). Используйте [обновление az aks][az-aks-update] команды и решили *--enable кластера автомасштабирования*, затем указать узел *count - min* и *--максимальное число* . В следующем примере включается средство автомасштабирования кластера для существующего кластера и настраивается диапазон от *1* до *3* для числа узлов:

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Если минимальное число узлов имеет значение больше, чем существующее количество узлов в кластере, потребуется несколько минут для создания дополнительных узлов.

## <a name="change-the-cluster-autoscaler-settings"></a>Изменение параметров средства автомасштабирования кластера

На предыдущем шаге при создании и обновлении кластера AKS мы указывали для средства автомасштабирования кластера минимальное число узлов *1* и максимальное число узлов *3*. По мере изменения требований приложения вы можете скорректировать настроенное количество узлов для средства автомасштабирования кластера.

Чтобы изменить число узлов, используйте [обновление az aks][az-aks-update] команду и укажите минимальное и максимальное значение. В следующем примере для параметра *--min-count* указывается значение *1*, а для параметра *--max-count* — значение *5*:

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

> [!NOTE]
> На этапе предварительной версии вы не можете задать более высокое минимальное число узлов, чем уже настроено для кластера. Например, если у вас есть кластер с минимальным числом узлов *1*, вы не сможете указать значение min-count *3*.

Отслеживайте производительность приложений и служб, а затем корректируйте диапазон числа узлов для средства автомасштабирования кластера в соответствии с требуемой производительностью.

## <a name="disable-the-cluster-autoscaler"></a>Отключение средства автомасштабирования кластера

Если вы больше не хотите использовать инструмент автомасштабирования кластера, его можно отключить с помощью [обновление az aks][az-aks-update] команды. При отключении средства автомасштабирования кластера узлы не удаляются.

Чтобы удалить средство автомасштабирования кластера, укажите параметр *--disable-cluster-autoscaler*, как показано в следующем примере:

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --disable-cluster-autoscaler
```

Вы можете вручную масштабировать кластер с помощью [az aks масштабирования][az-aks-scale] команды. Если вы используете средство горизонтального автомасштабирования pod, оно будет и далее работать после отключения средства автомасштабирования кластера, но при исчерпании ресурсов существующих узлов оно не сможет назначить новые pod.

## <a name="next-steps"></a>Следующие шаги

В этой статье показано, как автоматически масштабировать количество узлов AKS. Также вы можете использовать средство горизонтального автомасштабирования pod для автоматической настройки числа pod, на которых выполняется приложение. Инструкции по использованию автомасштабирования горизонтальной pod см. в разделе [масштабирование приложений в AKS][aks-scale-apps].

<!-- LINKS - internal -->
[aks-upgrade]: upgrade-cluster.md
[azure-cli-install]: /cli/azure/install-azure-cli
[az-aks-show]: /cli/azure/aks#az-aks-show
[az-extension-add]: /cli/azure/extension#az-extension-add
[aks-scale-apps]: tutorial-kubernetes-scale.md
[az-aks-create]: /cli/azure/aks#az-aks-create
[az-aks-scale]: /cli/azure/aks#az-aks-scale
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update

<!-- LINKS - external -->
[az-aks-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview
[autoscaler-scaledown]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node
[autoscaler-parameters]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca
