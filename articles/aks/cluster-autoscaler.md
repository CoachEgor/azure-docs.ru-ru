---
title: Использование средства автомасштабирования кластера в Службе контейнеров Azure
description: Узнайте, как использовать средство автомасштабирования кластера для автомасштабирования кластера в Службе контейнеров Azure в соответствии с требованиями приложения.
services: container-service
ms.topic: article
ms.date: 07/18/2019
ms.openlocfilehash: 2baa64779713d0bac063e1d2c06107ba2ab291fb
ms.sourcegitcommit: eefb0f30426a138366a9d405dacdb61330df65e7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81617542"
---
# <a name="automatically-scale-a-cluster-to-meet-application-demands-on-azure-kubernetes-service-aks"></a>Автоматическое масштабирование кластера в соответствии с требованиями приложения в Службе контейнеров Azure

Чтобы удовлетворить растущие требования приложения к Службе контейнеров Azure (AKS), вы можете изменить число узлов, на которых выполняются рабочие нагрузки. Компоненты кластера автомасштабирования могут отслеживать нехватку назначенных pod в кластере, связанную с ограничениями на ресурсы. При обнаружении проблем количество узлов в пуле узлов увеличивается для удовлетворения потребностей приложения. Также регулярно проверяется наличие узлов с малым числом запущенных pod, при их обнаружении число узлов соответствующим образом снижается. Такая возможность автоматически масштабировать количество узлов в кластере AKS обеспечивает эффективное и экономное использование кластера.

В этой статье показано, как включить и администрировать средство автомасштабирования для кластера AKS.

## <a name="before-you-begin"></a>Подготовка к работе

Эта статья требует, чтобы вы запускали версию Azure CLI 2.0.76 или позже. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

## <a name="limitations"></a>Ограничения

При создании и управлении кластерами AKS, использующихся кластеркластер кластером кластера, применяются следующие ограничения:

* Надстройка http-руитирования приложения не может быть использована.

## <a name="about-the-cluster-autoscaler"></a>Сведения о средстве автомасштабирования кластера

Чтобы учитывать постоянно меняющиеся требования приложения, например регулярное изменение нагрузки в течение дня или недели, часто требуется механизм автомасштабирования кластера. Для кластеров AKS существуют два способа масштабирования.

* **Средство автомасштабирования кластера** отслеживает невозможность назначить на узел новые pod, связанную с ограниченными ресурсами. Затем кластер автоматически увеличивает количество узлов.
* **Средство горизонтального автомасштабирования pod** использует сервер метрик в кластере Kubernetes для отслеживания потребностей pod в ресурсах. Если приложению требуется больше ресурсов, количество стручков автоматически увеличивается для удовлетворения спроса.

![Средство автомасштабирования кластера и средство горизонтального автомасштабирования pod часто используются вместе, чтобы учитывать любые изменения требований приложения.](media/autoscaler/cluster-autoscaler.png)

Как горизонтальный стручок autoscaler и кластера autoscaler также может уменьшить количество стручков и узлов по мере необходимости. Средство автомасштабирования кластера уменьшает количество узлов, если в течение определенного периода времени существует неиспользуемая емкость. Pod на узле, который будет удаляться, безопасно перемещаются средством автомасштабирования в другое расположение в том же кластере. Средство автомасштабирования кластера не сможет уменьшить масштаб, если pod невозможно переместить, например в следующих ситуациях:

* Стручок создается непосредственно и не поддерживается объектом контроллера, например набором развертывания или реплики.
* если бюджет неработоспособности pod имеет слишком строгие условия и не допускает снижение числа pod ниже определенного порогового значения;
* если pod использует селекторы узла или свойства удаления сходства, которые невозможно выполнить, так как они запланированы на другом узле.

Дополнительные сведения о причинах, которые препятствуют средству автомасштабирования уменьшать масштаб, описаны в разделе [What types of pods can prevent CA from removing a node?][autoscaler-scaledown] (Какие типы pod могут помешать средству автомасштабирования кластера удалить узел?).

Средство автомасштабирования кластера использует параметры запуска для выбора интервалов времени между событиями масштабирования, пороговых значений для ресурсов и т. п. Эти параметры определяются платформой Azure и пока не доступны для настройки вручную. Дополнительные сведения о параметрах, используемых средством автомасштабирования кластера, см. в разделе [What are the parameters to CA?][autoscaler-parameters] (Какие параметры использует средство автомасштабирования кластера?).

Кластерные и горизонтальные автоскалаторы стручка могут работать вместе и часто развертываются в кластере. При совместной работе средство горизонтального автомасштабирования pod берет на себя управление числом pod, необходимых для удовлетворения требований приложения. Средство автомасштабирования кластера контролирует, в свою очередь, количество узлов для работы запланированного числа pod.

> [!NOTE]
> При использовании средства автомасштабирования кластера отключается возможность масштабирования вручную. Позвольте этому средству самостоятельно определять необходимое количество узлов. Если вы предпочитаете выполнять масштабирование кластера вручную, [отключите средство автомасштабирования кластера](#disable-the-cluster-autoscaler).

## <a name="create-an-aks-cluster-and-enable-the-cluster-autoscaler"></a>Создание кластера AKS и включение средства автомасштабирования кластера

Если вам нужен новый кластер AKS, выполните команду [az aks create][az-aks-create]. Для включения и настройки кластерного автоскалатора на пуле узлов для кластера используйте параметр *--включить-кластер-автоскалатор* и укажите узла *--мин-счет* и *--макс-счет.*

> [!IMPORTANT]
> Компонент Kubernetes является средством автомасштабирования кластера. Хотя в кластере AKS используется масштабируемый набор виртуальных машин для узлов, не включайте и не изменяйте вручную параметры автомасштабирования масштабируемого набора на портале Azure или с помощью Azure CLI. Разрешите средству автомасштабирования кластера Kubernetes устанавливать необходимые параметры масштабирования. Для получения дополнительной [Can I modify the AKS resources in the node resource group?](faq.md#can-i-modify-tags-and-other-properties-of-the-aks-resources-in-the-node-resource-group) информации см.

Следующий пример создает кластер AKS с единым пулом узлов, опирающийся на виртуальный набор масштабов машины. Он также позволяет кластера autoscaler на пул узла для кластера и устанавливает не менее *1* и максимум *3* узла:

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location eastus

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --vm-set-type VirtualMachineScaleSets \
  --load-balancer-sku standard \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Создание кластера и настройка параметров автомасштабирования кластера занимает несколько минут.

## <a name="change-the-cluster-autoscaler-settings"></a>Изменение параметров средства автомасштабирования кластера

> [!IMPORTANT]
> Если в кластере AKS есть несколько пулов узлов, перейдите к [автомасштабу с разделом пулов нескольких агентов.](#use-the-cluster-autoscaler-with-multiple-node-pools-enabled) Кластеры с несколькими пулами `az aks nodepool` агентов требуют использования набора команд `az aks`для изменения определенных свойств пула узлов вместо.

На предыдущем этапе создания кластера AKS или обновления существующего пула узлов минимальный узла кластера autoscaler был установлен до *1,* а максимальное количество узлов было установлено до *3.* По мере изменения требований приложения вы можете скорректировать настроенное количество узлов для средства автомасштабирования кластера.

Чтобы изменить количество узлов, используйте команду [обновления az aks.][az-aks-update]

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

Вышеприведенный пример обновляет кластерный автоскейлер на одном пуле узлов в *myAKSCluster* минимум *до 1* и максимум *5* узлов.

> [!NOTE]
> Вы не можете установить более высокое минимальное количество узлов, чем в настоящее время установлен для пула узлов. Например, если у вас есть кластер с минимальным числом узлов *1*, вы не сможете указать значение min-count *3*.

Отслеживайте производительность приложений и служб, а затем корректируйте диапазон числа узлов для средства автомасштабирования кластера в соответствии с требуемой производительностью.

## <a name="using-the-autoscaler-profile"></a>Использование профиля автоскалатора

Вы также можете настроить более детали кластерного автоскалатора, изменив значения по умолчанию в профиле автоскалатора кластера. Например, событие снижения масштаба происходит после того, как узлы недостаточно используются через 10 минут. Если у вас были рабочие нагрузки, которые работали каждые 15 минут, вы можете изменить профиль автоскалатора, чтобы сократить масштаб использования под используемыми узлами через 15 или 20 минут. При включании кластерного автоскалатора используется профиль по умолчанию, если не указано различные параметры. Профиль автоскейлизатора кластера имеет следующие параметры, которые можно обновить:

| Параметр                          | Описание                                                                              | Значение по умолчанию |
|----------------------------------|------------------------------------------------------------------------------------------|---------------|
| сканирование-интервал                    | Как часто кластер переоценивается для масштабирования вверх или вниз                                    | 10 с    |
| масштаб-вниз-задержка-после добавления       | Как долго после масштабирования, что масштабирование вниз оценка возобновляется                               | 10 минут.    |
| масштаб-вниз-задержка-после удаления    | Как долго после удаления узла, что уменьшение масштаба оценки возобновляется                          | сканирование-интервал |
| масштабирование-задержка-после сбоя   | Как долго после сбоя масштабирования, что оценка масштабирования дауна возобновляется                     | 3 минуты     |
| масштаб-вниз-ненужное время         | Как долго узла следует не нужно, прежде чем он имеет право на масштаб вниз                  | 10 минут.    |
| масштабирование-неготовое время          | Как долго неготовый узла должен быть ненужным, прежде чем он имеет право на масштаб вниз         | 20 минут    |
| порог использования | Уровень использования удовобных средств, определяемый как сумма запрошенных ресурсов, разделенных по мощности, ниже которой узла можно рассматривать для снижения масштаба | 0,5 |
| макс-благодатно-прекращение-сек     | Максимальное количество секунд, что кластерный автоскейлист ждет завершения стручка при попытке сбить узла. | 600 секунд   |
| баланс-подобные узлы-группы | Обнаружение аналогичных пулов узлов и баланс числа узлов между ними | false |

> [!IMPORTANT]
> Профиль кластерного автоскалатора влияет на все пулы узлов, которые используют автоскалатор кластера. Вы не можете установить профиль автоскалатора на пул узлов.

### <a name="install-aks-preview-cli-extension"></a>Установка расширения интерфейса командной строки aks-preview

Чтобы настроить профиль параметров кластерного автоскейла, вам нужна версия расширения *CLI aks-preview* 0.4.30 или выше. Установите расширение *aks-preview* Azure CLI с помощью команды [расширения az,][az-extension-add] а затем проверьте наличие доступных обновлений с помощью команды [обновления расширения аз:][az-extension-update]

```azurecli-interactive
# Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
```

### <a name="set-the-cluster-autoscaler-profile-on-an-existing-aks-cluster"></a>Установите профиль кластерного автоскалатора на существующем кластере AKS

Используйте команду [обновления az aks][az-aks-update] с параметром *кластера-автоскалатора для* настройки профиля кластера автоскалатора в кластере. Следующий пример настраивает настройки интервала сканирования как 30 в профиле.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --cluster-autoscaler-profile scan-interval=30s
```

При включании кластерного автоскалатора в пулах узлов в кластере эти кластеры также будут использовать профиль автоскалатора кластера. Пример:

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name mynodepool \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

> [!IMPORTANT]
> При настройке профиля автоскалатора кластера любые существующие пулы узлов с включенным кластерным автоматом начнут использовать профиль немедленно.

### <a name="set-the-cluster-autoscaler-profile-when-creating-an-aks-cluster"></a>Установите профиль кластерного автоскалатора при создании кластера AKS

При создании кластера можно также использовать параметр *кластера-автоскалатора.- профиль.* Пример:

```azurecli-interactive
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3 \
  --cluster-autoscaler-profile scan-interval=30s
```

Вышеупомянутая команда создает кластер AKS и определяет интервал сканирования как 30 секунд для профиля автоскалатора кластера. Команда также позволяет кластера autoscaler на исходном пуле узлов, устанавливает минимальное количество узлов до 1 и максимальное количество узлов до 3.

### <a name="reset-cluster-autoscaler-profile-to-default-values"></a>Сбросить профиль автоскалатора кластера на значения по умолчанию

Используйте команду [обновления az aks][az-aks-update] для сбросить профиль кластерного автоскалатора в кластере.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --cluster-autoscaler-profile ""
```

## <a name="disable-the-cluster-autoscaler"></a>Отключение средства автомасштабирования кластера

Если вы больше не хотите использовать кластерный автоскейл, вы можете отключить его с помощью команды [обновления az aks,][az-aks-update] указав *параметры --отключить-кластер-автошкал.* При отключении средства автомасштабирования кластера узлы не удаляются.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --disable-cluster-autoscaler
```

Вы можете вручную масштабировать кластер после отключения кластерного автоскалатора с помощью команды [масштаба az aks.][az-aks-scale] Если вы используете горизонтальный автоматический автомат, эта функция продолжает работать с отключенным автоматическим кластером, но стручки могут оказаться неведомыми, если все ресурсы узлов используются.

## <a name="re-enable-a-disabled-cluster-autoscaler"></a>Повторное включение отключенного кластерного автоскалатора

Если вы хотите повторно включить кластерный автоскейлер на существующем кластере, можно повторно включить его с помощью команды [обновления az aks,][az-aks-update] указав параметры обновления az aks, указав параметры *--включить кластер-автоскалатор,* *--мин-счет,* и *--максимум-счет* параметров.

## <a name="retrieve-cluster-autoscaler-logs-and-status"></a>Извлечение журналов и статуса кластерного автоскалатора

Для диагностики и отладки событий autoscaler журналы и статус могут быть извлечены из дополнения autoscaler.

AKS управляет кластерным автоматом от вашего имени и запускает его в управляемой плоскости управления. Для просмотра необходимо настроить журналы мастер-узлов.

Для настройки журналов, которые должны быть перемещены из кластерного автоскалатора в Log Analytics, выполните следующие действия.

1. Навеяйте правило для диагностических журналов, чтобы подтолкнуть журналы кластера-автоскалатора к аналитике журналов. [Инструкции подробно описаны здесь,](https://docs.microsoft.com/azure/aks/view-master-logs#enable-diagnostics-logs)убедитесь, что вы проверить поле `cluster-autoscaler` при выборе вариантов для "Журналы".
1. Нажмите на раздел "Логи" в кластере через портал Azure.
1. Ввеки следующий пример запроса в Log Analytics:

```
AzureDiagnostics
| where Category == "cluster-autoscaler"
```

Вы должны видеть журналы, аналогичные следующему примеру, пока есть журналы для извлечения.

![Логи аналитики журналов журналов](media/autoscaler/autoscaler-logs.png)

Кластер autoscaler будет также выписать состояние здоровья `cluster-autoscaler-status`на конфигурацию под названием . Чтобы получить эти журналы, `kubectl` выполните следующую команду. Состояние работоспособности будет сообщено для каждого пула узлов, настроенного с помощью кластерного автоскалатора.

```
kubectl get configmap -n kube-system cluster-autoscaler-status -o yaml
```

Чтобы узнать больше о том, что регистрируется из автоскалайзера, прочитайте часто задаваемые вопросы о [проекте Kubernetes/autoscaler GitHub](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#ca-doesnt-work-but-it-used-to-work-yesterday-why).

## <a name="use-the-cluster-autoscaler-with-multiple-node-pools-enabled"></a>Используйте кластерный автоскейлс с включенным несколькими пулами узлов

Кластерный автомат можно использовать вместе с [включенными несколькими пулями узлов.](use-multiple-node-pools.md) Следуйте этому документу, чтобы узнать, как включить несколько пулов узлов и добавить дополнительные пулы узлов в существующий кластер. При совместном использовании обеих функций в каждом отдельном пуле узлов в кластере можно передавать уникальные правила автоматического масштабирования каждому из них.

Ниже команда предполагает, что вы следовали [первоначальным инструкциям](#create-an-aks-cluster-and-enable-the-cluster-autoscaler) ранее в этом документе, и вы хотите обновить максимальный счет существующего пула узлов от *3* до *5.* Используйте команду [обновления az aks nodepool][az-aks-nodepool-update] для обновления настроек существующего пула узлов.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

Кластерный автоскейлер может быть отключен с [обновлением az aks nodepool][az-aks-nodepool-update] и прохождением `--disable-cluster-autoscaler` параметра.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --disable-cluster-autoscaler
```

Если вы хотите повторно включить кластерный автоскейлер на существующем кластере, можно повторно включить его с помощью команды [обновления az aks nodepool,][az-aks-nodepool-update] указав *параметры --включить-кластер-автоскалатор,* *--мин-счет*, и *--максимум-счет* параметров.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье показано, как автоматически масштабировать количество узлов AKS. Также вы можете использовать средство горизонтального автомасштабирования pod для автоматической настройки числа pod, на которых выполняется приложение. Инструкции по использованию средства горизонтального автомасштабирования pod см. в статье [Руководство. Масштабирование приложений в Службе Azure Kubernetes (AKS)][aks-scale-apps].

<!-- LINKS - internal -->
[aks-faq]: faq.md
[aks-scale-apps]: tutorial-kubernetes-scale.md
[aks-support-policies]: support-policies.md
[aks-upgrade]: upgrade-cluster.md
[autoscaler-profile-properties]: #using-the-autoscaler-profile
[azure-cli-install]: /cli/azure/install-azure-cli
[az-aks-show]: /cli/azure/aks#az-aks-show
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[az-aks-create]: /cli/azure/aks#az-aks-create
[az-aks-scale]: /cli/azure/aks#az-aks-scale
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register

<!-- LINKS - external -->
[az-aks-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview
[az-aks-nodepool-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview#enable-cluster-auto-scaler-for-a-node-pool
[autoscaler-scaledown]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node
[autoscaler-parameters]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca
