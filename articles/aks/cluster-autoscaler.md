---
title: Использование средства автомасштабирования кластера в Службе контейнеров Azure
description: Узнайте, как использовать средство автомасштабирования кластера для автомасштабирования кластера в Службе контейнеров Azure в соответствии с требованиями приложения.
services: container-service
ms.topic: article
ms.date: 07/18/2019
ms.openlocfilehash: 0b94865d81afc56c24d470012c668662f003a1b8
ms.sourcegitcommit: 99ac4a0150898ce9d3c6905cbd8b3a5537dd097e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/25/2020
ms.locfileid: "77596255"
---
# <a name="automatically-scale-a-cluster-to-meet-application-demands-on-azure-kubernetes-service-aks"></a>Автоматическое масштабирование кластера в соответствии с требованиями приложения в Службе контейнеров Azure

Чтобы удовлетворить растущие требования приложения к Службе контейнеров Azure (AKS), вы можете изменить число узлов, на которых выполняются рабочие нагрузки. Компоненты кластера автомасштабирования могут отслеживать нехватку назначенных pod в кластере, связанную с ограничениями на ресурсы. При обнаружении проблем количество узлов в пуле узлов увеличивается в соответствии с потребностями приложения. Также регулярно проверяется наличие узлов с малым числом запущенных pod, при их обнаружении число узлов соответствующим образом снижается. Такая возможность автоматически масштабировать количество узлов в кластере AKS обеспечивает эффективное и экономное использование кластера.

В этой статье показано, как включить и администрировать средство автомасштабирования для кластера AKS.

## <a name="before-you-begin"></a>Перед началом

Для работы с этой статьей требуется Azure CLI версии 2.0.76 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

## <a name="limitations"></a>Ограничения

При создании кластеров AKS, использующих Автомасштабирование кластера, и управлении ими применяются следующие ограничения.

* Не удается использовать надстройку маршрутизации приложений HTTP.

## <a name="about-the-cluster-autoscaler"></a>Сведения о средстве автомасштабирования кластера

Чтобы учитывать постоянно меняющиеся требования приложения, например регулярное изменение нагрузки в течение дня или недели, часто требуется механизм автомасштабирования кластера. Для кластеров AKS существуют два способа горизонтального уменьшения масштаба:

* **Средство автомасштабирования кластера** отслеживает невозможность назначить на узел новые pod, связанную с ограниченными ресурсами. Затем кластер автоматически увеличит количество узлов.
* **Средство горизонтального автомасштабирования pod** использует сервер метрик в кластере Kubernetes для отслеживания потребностей pod в ресурсах. Если приложению требуется больше ресурсов, число модулей Pod автоматически увеличивается в соответствии с потребностями.

![Средство автомасштабирования кластера и средство горизонтального автомасштабирования pod часто используются вместе, чтобы учитывать любые изменения требований приложения.](media/autoscaler/cluster-autoscaler.png)

И Автомасштабирование по горизонтали, и Автомасштабирование кластера также могут при необходимости уменьшить количество модулей Pod и узлов. Средство автомасштабирования кластера уменьшает количество узлов, если в течение определенного периода времени существует неиспользуемая емкость. Pod на узле, который будет удаляться, безопасно перемещаются средством автомасштабирования в другое расположение в том же кластере. Средство автомасштабирования кластера не сможет уменьшить масштаб, если pod невозможно переместить, например в следующих ситуациях:

* Модуль POD создается напрямую и не поддерживается объектом контроллера, например развертыванием или набором реплик.
* если бюджет неработоспособности pod имеет слишком строгие условия и не допускает снижение числа pod ниже определенного порогового значения;
* если pod использует селекторы узла или свойства удаления сходства, которые невозможно выполнить, так как они запланированы на другом узле.

Дополнительные сведения о том, как не удается масштабировать автоматическое масштабирование кластера, см. в разделе [какие типы модулей типов данных могут препятствовать удалению узла с помощью автомасштабирования кластера?][autoscaler-scaledown]

Средство автомасштабирования кластера использует параметры запуска для выбора интервалов времени между событиями масштабирования, пороговых значений для ресурсов и т. п. Эти параметры определяются платформой Azure и пока не доступны для настройки вручную. Дополнительные сведения о том, какие параметры использует Автомасштабирование кластера, см. в разделе [что такое параметры автомасштабирования кластера?][autoscaler-parameters]

Модуль автомасштабирования кластера и горизонтального модуля Pod может работать вместе и часто развертываться в кластере. При совместной работе средство горизонтального автомасштабирования pod берет на себя управление числом pod, необходимых для удовлетворения требований приложения. Средство автомасштабирования кластера контролирует, в свою очередь, количество узлов для работы запланированного числа pod.

> [!NOTE]
> При использовании средства автомасштабирования кластера отключается возможность масштабирования вручную. Позвольте этому средству самостоятельно определять необходимое количество узлов. Если вы предпочитаете выполнять масштабирование кластера вручную, [отключите средство автомасштабирования кластера](#disable-the-cluster-autoscaler).

## <a name="create-an-aks-cluster-and-enable-the-cluster-autoscaler"></a>Создание кластера AKS и включение средства автомасштабирования кластера

Если необходимо создать кластер AKS, используйте команду [AZ AKS Create][az-aks-create] . Чтобы включить и настроить Автомасштабирование кластера в пуле узлов для кластера, используйте параметр *--Enable-Cluster-Автомасштабирование* и укажите Node *--min-Count* и *--Max-Count*.

> [!IMPORTANT]
> Компонент Kubernetes является средством автомасштабирования кластера. Хотя в кластере AKS используется масштабируемый набор виртуальных машин для узлов, не включайте и не изменяйте вручную параметры автомасштабирования масштабируемого набора на портале Azure или с помощью Azure CLI. Разрешите средству автомасштабирования кластера Kubernetes устанавливать необходимые параметры масштабирования. Дополнительные сведения см. в разделе [можно ли изменить ресурсы AKS в группе ресурсов узла?](faq.md#can-i-modify-tags-and-other-properties-of-the-aks-resources-in-the-node-resource-group)

В следующем примере создается кластер AKS с одним пулом узлов, поддерживаемым масштабируемым набором виртуальных машин. Он также включает Автомасштабирование кластера в пуле узлов для кластера и задает минимум *1* и максимум *3* узла:

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location eastus

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --vm-set-type VirtualMachineScaleSets \
  --load-balancer-sku standard \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Создание кластера и настройка параметров автомасштабирования кластера занимает несколько минут.

## <a name="change-the-cluster-autoscaler-settings"></a>Изменение параметров средства автомасштабирования кластера

> [!IMPORTANT]
> Если в кластере AKS имеется несколько пулов узлов, перейдите к [разделу Автомасштабирование с несколькими пулами агентов](#use-the-cluster-autoscaler-with-multiple-node-pools-enabled). Кластеры с несколькими пулами агентов нуждаются в использовании `az aks nodepool` набора команд для изменения свойств пула узлов вместо `az aks`.

На предыдущем шаге, чтобы создать кластер AKS или обновить существующий пул узлов, для параметра минимальное число узлов автомасштабирования кластера было установлено значение *1*, а для параметра Максимальное число узлов — значение *3*. По мере изменения требований приложения вы можете скорректировать настроенное количество узлов для средства автомасштабирования кластера.

Чтобы изменить число узлов, используйте команду [AZ AKS Update][az-aks-update] .

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

В приведенном выше примере Автомасштабирование кластера обновляется в пуле с одним узлом в *myAKSCluster* , не менее *1* и не более *5* узлов.

> [!NOTE]
> Вы не можете задать максимальное число узлов, превышающее значение, заданное для пула узлов. Например, если у вас есть кластер с минимальным числом узлов *1*, вы не сможете указать значение min-count *3*.

Отслеживайте производительность приложений и служб, а затем корректируйте диапазон числа узлов для средства автомасштабирования кластера в соответствии с требуемой производительностью.

## <a name="using-the-autoscaler-profile"></a>Использование профиля автомасштабирования

Вы также можете настроить более детализированные сведения об автомасштабировании кластера, изменив значения по умолчанию в профиле автомасштабирования в масштабе кластера. Например, событие уменьшения масштаба происходит после 10-минутного использования узлов. Если у вас есть рабочие нагрузки, которые выполнялись каждые 15 минут, может потребоваться изменить профиль автомасштабирования, чтобы уменьшить масштаб для использования узлов после 15 или 20 минут. При включении автомасштабирования кластера используется профиль по умолчанию, если не заданы другие параметры. Профиль автомасштабирования кластера имеет следующие параметры, которые можно обновить.

| Параметр                          | Описание                                                                              | Значение по умолчанию |
|----------------------------------|------------------------------------------------------------------------------------------|---------------|
| интервал сканирования                    | Частота повторной вычисления кластера для увеличения или уменьшения масштаба                                    | 10 секунд    |
| уменьшение масштаба с задержкой после добавления       | Сколько времени после увеличения масштаба, возобновление оценки                               | 10 минут.    |
| уменьшение масштаба с задержкой после удаления    | Как долго после удаления узла возобновляется вычисление масштаба                          | интервал сканирования |
| уменьшение масштаба с задержкой после сбоя   | Время после сбоя уменьшения масштаба для возобновления оценки                     | 3 минуты     |
| Необязательное горизонтальное масштабирование         | Как долго узел должен быть ненужным, прежде чем он сможет масштабироваться                  | 10 минут.    |
| горизонтальное масштабирование-время чтения          | Сколько времени непрочтенный узел должен быть ненужным, прежде чем он сможет масштабироваться         | 20 минут    |
| понижение уровня использования — порог | Уровень использования узла, определенный как сумма запрошенных ресурсов, деленная на емкость, ниже которой можно считать узел для уменьшения масштаба. | 0.5 |
| Максимальное — мягкое прерывание-с     | Максимальное количество секунд, в течение которых модуль автомасштабирования кластера ожидает завершения работы Pod при попытке масштабирования узла. | 600 секунд   |

> [!IMPORTANT]
> Профиль автомасштабирования кластера влияет на все пулы узлов, которые используют Автомасштабирование кластера. Нельзя задать профиль автомасштабирования для пула узлов.

### <a name="install-aks-preview-cli-extension"></a>Установка расширения интерфейса командной строки aks-preview

Чтобы задать профиль параметров автомасштабирования кластера, требуется расширение CLI *AKS-Preview* версии 0.4.30 или более поздней. Установите расширение Azure CLI *AKS-Preview* с помощью команды [AZ Extension Add][az-extension-add] , а затем проверьте наличие доступных обновлений с помощью команды [AZ Extension Update][az-extension-update] .

```azurecli-interactive
# Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
```

### <a name="set-the-cluster-autoscaler-profile-on-an-existing-aks-cluster"></a>Настройка профиля автомасштабирования кластера в существующем кластере AKS

Используйте команду [AZ AKS Update][az-aks-update] с параметром *cluster-ScaleY-Profile* , чтобы задать профиль автомасштабирования кластера в кластере. В следующем примере параметр интервала сканирования настраивается как 30 в профиле.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --cluster-autoscaler-profile scan-interval=30s
```

При включении автомасштабирования кластера в пулах узлов в кластере эти кластеры также будут использовать профиль автомасштабирования кластера. Например:

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name mynodepool \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

> [!IMPORTANT]
> При настройке профиля автомасштабирования кластера все существующие пулы узлов с включенным автомасштабированием кластера будут немедленно запущены с использованием профиля.

### <a name="set-the-cluster-autoscaler-profile-when-creating-an-aks-cluster"></a>Настройка профиля автомасштабирования кластера при создании кластера AKS

При создании кластера также можно использовать параметр *cluster-ScaleY-Profile* . Например:

```azurecli-interactive
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3 \
  --cluster-autoscaler-profile scan-interval=30s
```

Приведенная выше команда создает кластер AKS и определяет интервал сканирования в 30 секунд для профиля автомасштабирования в масштабе кластера. Команда также включает Автомасштабирование кластера в начальном пуле узлов, устанавливает минимальное число узлов в 1, а максимальное число узлов — 3.

### <a name="reset-cluster-autoscaler-profile-to-default-values"></a>Сбросить профиль автомасштабирования кластера к значениям по умолчанию

Используйте команду [AZ AKS Update][az-aks-update] , чтобы сбросить профиль автомасштабирования кластера в кластере.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --cluster-autoscaler-profile ""
```

## <a name="disable-the-cluster-autoscaler"></a>Отключение средства автомасштабирования кластера

Если вы больше не хотите использовать Автомасштабирование кластера, его можно отключить с помощью команды [AZ AKS Update][az-aks-update] , указав параметр *--Disable-Cluster-автоscale* . При отключении средства автомасштабирования кластера узлы не удаляются.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --disable-cluster-autoscaler
```

Вы можете вручную масштабировать кластер после отключения автомасштабирования кластера с помощью команды [AZ AKS Scale][az-aks-scale] . Если вы используете горизонтальный Автомасштабирование Pod, эта функция продолжит работать с отключенным автомасштабированием кластера, однако в случае, если все ресурсы узла используются, они могут не планироваться.

## <a name="re-enable-a-disabled-cluster-autoscaler"></a>Повторное включение автомасштабирования отключенного кластера

Если вы хотите повторно включить Автомасштабирование кластера в существующем кластере, можно повторно включить его с помощью команды [AZ AKS Update][az-aks-update] , указав параметры *--Enable-Cluster-автомасштабирования*, *--min-Count*и *--Max-Count* .

## <a name="retrieve-cluster-autoscaler-logs-and-status"></a>Получение журналов и состояния автомасштабирования кластера

Для диагностики и отладки событий автомасштабирования можно получить журналы и состояние из надстройки автомасштабирования.

AKS управляет автомасштабированием кластера от вашего имени и запускает его в управляемой плоскости управления. Журналы главного узла должны быть настроены для просмотра в результате.

Чтобы настроить принудительную отправку журналов из автомасштабирования кластера в Log Analytics, выполните следующие действия.

1. Настройте правило для журналов диагностики для отправки журналов автоматического масштабирования кластера в Log Analytics. [Здесь подробно описано](https://docs.microsoft.com/azure/aks/view-master-logs#enable-diagnostics-logs), как установить флажок для `cluster-autoscaler` при выборе параметров для "журналы".
1. Щелкните раздел "журналы" в кластере с помощью портал Azure.
1. Введите следующий пример запроса в Log Analytics:

```
AzureDiagnostics
| where Category == "cluster-autoscaler"
```

Если имеются журналы для извлечения, вы должны увидеть журналы, аналогичные приведенным в следующем примере.

![Журналы Log Analytics](media/autoscaler/autoscaler-logs.png)

Автоматическое масштабирование кластера также записывает состояние работоспособности в ConfigMap с именем `cluster-autoscaler-status`. Чтобы получить эти журналы, выполните следующую команду `kubectl`. Состояние работоспособности будет выводиться для каждого пула узлов, настроенного с помощью автомасштабирования кластера.

```
kubectl get configmap -n kube-system cluster-autoscaler-status -o yaml
```

Дополнительные сведения о том, что входит в журнал из автомасштабирования, см. в разделе часто задаваемых вопросов по [проекту Kubernetes/автомасштабирования GitHub](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#ca-doesnt-work-but-it-used-to-work-yesterday-why).

## <a name="use-the-cluster-autoscaler-with-multiple-node-pools-enabled"></a>Использование автомасштабирования кластера с включенным пулом нескольких узлов

Автомасштабирование кластера можно использовать совместно с несколькими включенными [пулами узлов](use-multiple-node-pools.md) . Следуйте этому документу, чтобы узнать, как включить несколько пулов узлов и добавить дополнительные пулы узлов в существующий кластер. При одновременном использовании обеих функций вы включаете Автомасштабирование кластера в каждом отдельном пуле узлов в кластере и может передавать каждому из них уникальные правила автомасштабирования.

Приведенная ниже команда предполагает, что вы предполагали [начальные инструкции](#create-an-aks-cluster-and-enable-the-cluster-autoscaler) ранее в этом документе и хотите обновить максимальное число существующих пулов узлов с *3* до *5*. Используйте команду [AZ AKS нодепул Update][az-aks-nodepool-update] для обновления параметров существующего пула узлов.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

Вы можете отключить Автомасштабирование кластера, выполнив команду [AZ AKS нодепул Update][az-aks-nodepool-update] и передав параметр `--disable-cluster-autoscaler`.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --disable-cluster-autoscaler
```

Если вы хотите повторно включить Автомасштабирование кластера в существующем кластере, можно повторно включить его с помощью команды [AZ AKS нодепул Update][az-aks-nodepool-update] , указав параметры *--Enable-Cluster-автомасштабирования*, *--min-Count*и *--Max-Count* .

## <a name="next-steps"></a>Следующие шаги

В этой статье показано, как автоматически масштабировать количество узлов AKS. Также вы можете использовать средство горизонтального автомасштабирования pod для автоматической настройки числа pod, на которых выполняется приложение. Инструкции по использованию автомасштабирования по горизонтали Pod см. в разделе [масштабирование приложений в AKS][aks-scale-apps].

<!-- LINKS - internal -->
[aks-faq]: faq.md
[aks-scale-apps]: tutorial-kubernetes-scale.md
[aks-support-policies]: support-policies.md
[aks-upgrade]: upgrade-cluster.md
[autoscaler-profile-properties]: #using-the-autoscaler-profile
[azure-cli-install]: /cli/azure/install-azure-cli
[az-aks-show]: /cli/azure/aks#az-aks-show
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[az-aks-create]: /cli/azure/aks#az-aks-create
[az-aks-scale]: /cli/azure/aks#az-aks-scale
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register

<!-- LINKS - external -->
[az-aks-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview
[az-aks-nodepool-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview#enable-cluster-auto-scaler-for-a-node-pool
[autoscaler-scaledown]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node
[autoscaler-parameters]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca
