---
title: Использование средства автомасштабирования кластера в Службе контейнеров Azure
description: Узнайте, как использовать средство автомасштабирования кластера для автомасштабирования кластера в Службе контейнеров Azure в соответствии с требованиями приложения.
services: container-service
author: mlearned
ms.service: container-service
ms.topic: article
ms.date: 07/18/2019
ms.author: mlearned
ms.openlocfilehash: 09610782f211b4cfb80a1291b73ab543328376a3
ms.sourcegitcommit: 198c3a585dd2d6f6809a1a25b9a732c0ad4a704f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2019
ms.locfileid: "68424183"
---
# <a name="preview---automatically-scale-a-cluster-to-meet-application-demands-on-azure-kubernetes-service-aks"></a>Предварительная версия. Автоматическое масштабирование кластера в соответствии с потребностями приложений в службе Kubernetes Azure (AKS)

Чтобы удовлетворить растущие требования приложения к Службе контейнеров Azure (AKS), вы можете изменить число узлов, на которых выполняются рабочие нагрузки. Компоненты кластера автомасштабирования могут отслеживать нехватку назначенных pod в кластере, связанную с ограничениями на ресурсы. При обнаружении проблем количество узлов в пуле узлов увеличивается в соответствии с потребностями приложения. Также регулярно проверяется наличие узлов с малым числом запущенных pod, при их обнаружении число узлов соответствующим образом снижается. Такая возможность автоматически масштабировать количество узлов в кластере AKS обеспечивает эффективное и экономное использование кластера.

В этой статье показано, как включить и администрировать средство автомасштабирования для кластера AKS. Автомасштабирование кластера следует тестировать только в предварительной версии кластеров AKS.

> [!IMPORTANT]
> Функции предварительной версии AKS — это самостоятельная служба. Они предоставляются для сбора отзывов и ошибок от нашего сообщества. В предварительной версии эти функции не предназначены для использования в рабочей среде. Функции в общедоступной предварительной версии доступны в рамках поддержки "наилучших усилий". Помощь из группы технической поддержки AKS можно получить только в течение часового пояса в рабочее время (PST). Дополнительные сведения см. в следующих статьях поддержки:
>
> * [Политики поддержки AKS][aks-support-policies]
> * [Часто задаваемые вопросы о поддержке Azure][aks-faq]

## <a name="before-you-begin"></a>Перед началом работы

Для работы с этой статьей требуется Azure CLI версии 2.0.65 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

### <a name="install-aks-preview-cli-extension"></a>Установка расширения интерфейса командной строки aks-preview

Для использования автомасштабирования кластера требуется расширение CLI *AKS-Preview* версии 0.4.4 или более поздней. Установите расширение Azure CLI *AKS-Preview* с помощью команды [AZ Extension Add][az-extension-add] command, then check for any available updates using the [az extension update][az-extension-update] :

```azurecli-interactive
# Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
```

### <a name="register-scale-set-feature-provider"></a>Регистрация поставщика компонента масштабируемых наборов

Чтобы создать службу AKS, которая использует масштабируемые наборы, необходимо также включить соответствующий флаг компонента в своей подписке. Чтобы зарегистрировать флаг функции *вмсспревиев* , используйте команду [AZ Feature Register][az-feature-register] , как показано в следующем примере:

> [!CAUTION]
> Регистрация компонента в подписке в данный момент невозможна. После включения функций предварительной версии можно использовать значения по умолчанию для всех кластеров AKS, созданных в подписке. Не включайте предварительные версии функций в производственных подписках. Используйте отдельную подписку для тестирования функций предварительной версии и сбора отзывов.

```azurecli-interactive
az feature register --name VMSSPreview --namespace Microsoft.ContainerService
```

Через несколько минут отобразится состояние *Registered* (Зарегистрировано). Проверить состояние регистрации можно с помощью команды [AZ Feature List][az-feature-list] .

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/VMSSPreview')].{Name:name,State:properties.state}"
```

Когда все будет готово, обновите регистрацию поставщика ресурсов *Microsoft. ContainerService* с помощью команды [AZ Provider Register][az-provider-register] :

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

## <a name="limitations"></a>Ограничения

При создании кластеров AKS, использующих Автомасштабирование кластера, и управлении ими применяются следующие ограничения.

* Не удается использовать надстройку маршрутизации приложений HTTP.

## <a name="about-the-cluster-autoscaler"></a>Сведения о средстве автомасштабирования кластера

Чтобы учитывать постоянно меняющиеся требования приложения, например регулярное изменение нагрузки в течение дня или недели, часто требуется механизм автомасштабирования кластера. Для кластеров AKS существуют два способа масштабирования.

* **Средство автомасштабирования кластера** отслеживает невозможность назначить на узел новые pod, связанную с ограниченными ресурсами. При возникновении такой ситуации число узлов в кластере автоматически повышается.
* **Средство горизонтального автомасштабирования pod** использует сервер метрик в кластере Kubernetes для отслеживания потребностей pod в ресурсах. Если службе нужно больше ресурсов, количество pod автоматически увеличивается в соответствии с требованиями.

![Средство автомасштабирования кластера и средство горизонтального автомасштабирования pod часто используются вместе, чтобы учитывать любые изменения требований приложения.](media/autoscaler/cluster-autoscaler.png)

Оба этих средства могут уменьшать количество pod и узлов, когда в них отпадает надобность. Средство автомасштабирования кластера уменьшает количество узлов, если в течение определенного периода времени существует неиспользуемая емкость. Pod на узле, который будет удаляться, безопасно перемещаются средством автомасштабирования в другое расположение в том же кластере. Средство автомасштабирования кластера не сможет уменьшить масштаб, если pod невозможно переместить, например в следующих ситуациях:

* если pod создан напрямую на узле, а не через объект контроллера, например в наборе развертывания или реплик;
* если бюджет неработоспособности pod имеет слишком строгие условия и не допускает снижение числа pod ниже определенного порогового значения;
* если pod использует селекторы узла или свойства удаления сходства, которые невозможно выполнить, так как они запланированы на другом узле.

Дополнительные сведения о том, как не удается масштабировать автоматическое масштабирование кластера, см. в разделе [какие типы модулей типов данных могут препятствовать удалению узла с помощью автомасштабирования кластера?][autoscaler-scaledown]

Средство автомасштабирования кластера использует параметры запуска для выбора интервалов времени между событиями масштабирования, пороговых значений для ресурсов и т. п. Эти параметры определяются платформой Azure и пока не доступны для настройки вручную. Дополнительные сведения о том, какие параметры использует Автомасштабирование кластера, см. в разделе [что такое параметры автомасштабирования кластера?][autoscaler-parameters]

Упомянутые два средства автомасштабирования могут работать вместе, и часто оба средства развертываются в кластере. При совместной работе средство горизонтального автомасштабирования pod берет на себя управление числом pod, необходимых для удовлетворения требований приложения. Средство автомасштабирования кластера контролирует, в свою очередь, количество узлов для работы запланированного числа pod.

> [!NOTE]
> При использовании средства автомасштабирования кластера отключается возможность масштабирования вручную. Позвольте этому средству самостоятельно определять необходимое количество узлов. Если вы предпочитаете выполнять масштабирование кластера вручную, [отключите средство автомасштабирования кластера](#disable-the-cluster-autoscaler).

## <a name="create-an-aks-cluster-and-enable-the-cluster-autoscaler"></a>Создание кластера AKS и включение средства автомасштабирования кластера

Если необходимо создать кластер AKS, используйте команду [AZ AKS Create][az-aks-create] . Чтобы включить и настроить Автомасштабирование кластера в пуле узлов для кластера, используйте параметр *--Enable-Cluster-* Автомасштабирование и укажите Node *--min-Count* и *--Max-Count*.

> [!IMPORTANT]
> Компонент Kubernetes является средством автомасштабирования кластера. Хотя в кластере AKS используется масштабируемый набор виртуальных машин для узлов, не включайте и не изменяйте вручную параметры автомасштабирования масштабируемого набора на портале Azure или с помощью Azure CLI. Разрешите средству автомасштабирования кластера Kubernetes устанавливать необходимые параметры масштабирования. Дополнительные сведения см. в разделе [можно ли изменить ресурсы AKS в группе ресурсов узла?](faq.md#can-i-modify-tags-and-other-properties-of-the-aks-resources-in-the-node-resource-group)

В следующем примере создается кластер AKS с масштабируемым набором виртуальных машин. Он также включает Автомасштабирование кластера в пуле узлов для кластера и задает минимум *1* и максимум *3* узла:

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location eastus

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --enable-vmss \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

> [!NOTE]
> Если при выполнении указан параметр *--kubernetes-Version* , `az aks create`то эта версия должна соответствовать минимальному номеру версии или превышать его, как описано в предыдущем разделе [перед началом](#before-you-begin) работы.

Создание кластера и настройка параметров автомасштабирования кластера занимает несколько минут.

### <a name="enable-the-cluster-autoscaler-on-an-existing-node-pool-in-an-aks-cluster"></a>Включение автомасштабирования кластера в существующем пуле узлов в кластере AKS

Вы можете включить Автомасштабирование кластера в пуле узлов в кластере AKS, который соответствует требованиям, описанным в предыдущем разделе [перед началом](#before-you-begin) . Используйте команду [AZ AKS нодепул Update][az-aks-nodepool-update] , чтобы включить Автомасштабирование кластера в пуле узлов.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name mynodepool \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Приведенный выше пример включает Автомасштабирование кластера в пуле узлов *минодепул* в *myAKSCluster* и задает не менее *1* и не более *3* узлов. Если минимальное число узлов больше, чем существующее число узлов в пуле узлов, создание дополнительных узлов займет несколько минут.

## <a name="change-the-cluster-autoscaler-settings"></a>Изменение параметров средства автомасштабирования кластера

На предыдущем шаге, чтобы создать кластер AKS или обновить существующий пул узлов, для параметра минимальное число узлов автомасштабирования кластера было установлено значение *1*, а для параметра Максимальное число узлов — значение *3*. По мере изменения требований приложения вы можете скорректировать настроенное количество узлов для средства автомасштабирования кластера.

Чтобы изменить число узлов, используйте команду [AZ AKS нодепул Update][az-aks-nodepool-update] .

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name mynodepool \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

В приведенном выше примере выполняется обновление автомасштабирования кластера в пуле узлов *минодепул* в *myAKSCluster* до *1* и максимум *5* узлов.

> [!NOTE]
> На этапе предварительной версии нельзя задать большее минимальное число узлов, чем в настоящее время задано для пула узлов. Например, если у вас есть кластер с минимальным числом узлов *1*, вы не сможете указать значение min-count *3*.

Отслеживайте производительность приложений и служб, а затем корректируйте диапазон числа узлов для средства автомасштабирования кластера в соответствии с требуемой производительностью.

## <a name="disable-the-cluster-autoscaler"></a>Отключение средства автомасштабирования кластера

Если вы больше не хотите использовать Автомасштабирование кластера, его можно отключить с помощью команды [AZ AKS нодепул Update][az-aks-nodepool-update] , указав параметр *--Disable-Cluster-автоscale* . При отключении средства автомасштабирования кластера узлы не удаляются.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name mynodepool \
  --disable-cluster-autoscaler
```

Вы можете вручную масштабировать кластер с помощью команды [AZ AKS Scale][az-aks-scale] . Если вы используете средство горизонтального автомасштабирования pod, оно будет и далее работать после отключения средства автомасштабирования кластера, но при исчерпании ресурсов существующих узлов оно не сможет назначить новые pod.

## <a name="next-steps"></a>Следующие шаги

В этой статье показано, как автоматически масштабировать количество узлов AKS. Также вы можете использовать средство горизонтального автомасштабирования pod для автоматической настройки числа pod, на которых выполняется приложение. Инструкции по использованию автомасштабирования по горизонтали Pod см. в разделе [масштабирование приложений в AKS][aks-scale-apps].

<!-- LINKS - internal -->
[aks-upgrade]: upgrade-cluster.md
[azure-cli-install]: /cli/azure/install-azure-cli
[az-aks-show]: /cli/azure/aks#az-aks-show
[az-extension-add]: /cli/azure/extension#az-extension-add
[aks-scale-apps]: tutorial-kubernetes-scale.md
[az-aks-create]: /cli/azure/aks#az-aks-create
[az-aks-scale]: /cli/azure/aks#az-aks-scale
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update

<!-- LINKS - external -->
[az-aks-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview
[az-aks-nodepool-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview#enable-cluster-auto-scaler-for-a-node-pool
[autoscaler-scaledown]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node
[autoscaler-parameters]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca
