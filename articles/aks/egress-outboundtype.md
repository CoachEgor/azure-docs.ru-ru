---
title: Настройка определяемых пользователем маршрутов в службе Azure Kubernetes (AKS)
description: Узнайте, как определить пользовательский маршрут исходящего трафика в службе Azure Kubernetes (AKS)
services: container-service
ms.topic: article
ms.author: juluk
ms.date: 06/29/2020
author: jluk
ms.openlocfilehash: 5fe674fa7ab6a6a3f222a215ebc6912549776fee
ms.sourcegitcommit: d8b8768d62672e9c287a04f2578383d0eb857950
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88067364"
---
# <a name="customize-cluster-egress-with-a-user-defined-route"></a>Настройка исходящего трафика кластера с помощью определяемого пользователем маршрута

Исходящий трафик из кластера AKS можно настроить в соответствии с конкретными сценариями. По умолчанию AKS будет подготавливать Стандартный номер SKU Load Balancer, который будет настроен и использован для исходящего трафика. Однако настройка по умолчанию может не соответствовать требованиям всех сценариев, если общедоступные IP-адреса запрещены или для исходящего трафика требуются дополнительные прыжки.

В этой статье описывается настройка маршрута исходящего трафика кластера для поддержки пользовательских сетевых сценариев, например тех, которые запрещают использование общедоступных IP-адресов и требуют наличия кластера за сетевым виртуальным устройством (NVA).

## <a name="prerequisites"></a>Предварительные требования
* Интерфейс командной строки Azure 2.0.81 или более поздней версии
* Версия API `2020-01-01` или выше


## <a name="limitations"></a>Ограничения
* Аутбаундтипе можно определить только во время создания кластера и не может быть обновлено позже.
* Для настройки `outboundType` требуются кластеры AKS с `vm-set-type` `VirtualMachineScaleSets` и `load-balancer-sku` `Standard`.
* Чтобы задать для `outboundType` значение `UDR`, необходимо использовать определяемый пользователем маршрут с действительными исходящими подключениями для кластера.
* Если для `outboundType` задано значение `UDR`, это подразумевает, что исходный IP-адрес входящего трафика, маршрутизируемого на балансировщик нагрузки, может **не соответствовать** конечному адресу исходящего трафика кластера.

## <a name="overview-of-outbound-types-in-aks"></a>Общие сведения о типах исходящих подключений в AKS

Кластер AKS можно настроить с помощью уникального `outboundType` типа «балансировщик нагрузки» и определяемой пользователем маршрутизации.

> [!IMPORTANT]
> Тип исходящего трафика влияет только на исходящий трафик кластера. Дополнительные сведения см. в разделе Настройка входных [контроллеров](ingress-basic.md).

> [!NOTE]
> Вы можете использовать собственную [таблицу маршрутов][byo-route-table] с сетями UDR и кубенет. Убедитесь, что удостоверение кластера (субъект-служба или управляемое удостоверение) имеет разрешения участника для таблицы настраиваемых маршрутов.

### <a name="outbound-type-of-loadbalancer"></a>Тип исходящего трафика балансировщика нагрузки

Если `loadBalancer` задано значение, AKS автоматически выполняет следующую настройку. Балансировщик нагрузки используется для исходящего трафика через назначенный общедоступный IP-адрес AKS. Тип исходящего трафика `loadBalancer` поддерживает службы Kubernetes типа `loadBalancer`, которые ожидают исходящий трафик из балансировщика нагрузки, созданного поставщиком ресурсов AKS.

Следующая конфигурация выполняется с помощью AKS.
   * Общедоступный IP-адрес подготавливается для исходящего трафика кластера.
   * Общедоступный IP-адрес назначается ресурсу балансировщика нагрузки.
   * Серверные пулы для подсистемы балансировки нагрузки настраиваются для узлов агентов в кластере.

Ниже приведена топология сети, развернутая в кластерах AKS по умолчанию, которая использует `outboundType` `loadBalancer`.

![outboundtype-lb](media/egress-outboundtype/outboundtype-lb.png)

### <a name="outbound-type-of-userdefinedrouting"></a>Тип исходящего трафика userDefinedRouting

> [!NOTE]
> Использование типа исходящего трафика является сложным сетевым сценарием и требует правильной настройки сети.

Если `userDefinedRouting` задано значение, AKS не будет автоматически настраивать пути выхода. Настройка исходящего трафика должна быть выполнена вами.

Кластер AKS должен быть развернут в существующей виртуальной сети с подсетью, которая ранее была настроена, так как при отсутствии использования архитектуры "Стандартный балансировщик нагрузки" (SLB) необходимо установить явный выход. Таким образом, для этой архитектуры требуется явная отправка исходящего трафика на устройство, например брандмауэр, шлюз, прокси-сервер или разрешение преобразования сетевых адресов (NAT) с помощью общедоступного IP-адреса, назначенного стандартному балансировщик нагрузки или устройству.

Поставщик ресурсов AKS развернет стандартный балансировщик нагрузки (SLB). В подсистеме балансировки нагрузки не настроены никакие правила и [плата не взимается до тех пор, пока не будет помещено правило](https://azure.microsoft.com/pricing/details/load-balancer/). AKS **не будет** автоматически подготавливать общедоступный IP-адрес для интерфейса SLB или автоматически настраивать внутренний пул подсистемы балансировки нагрузки.

## <a name="deploy-a-cluster-with-outbound-type-of-udr-and-azure-firewall"></a>Развертывание кластера с типом исходящего трафика UDR и брандмауэром Azure

Чтобы проиллюстрировать применение кластера с типом исходящего трафика с помощью определяемого пользователем маршрута, можно настроить кластер в виртуальной сети с помощью брандмауэра Azure в своей подсети. См. Этот пример в [примере ограничения трафика с помощью брандмауэра Azure](limit-egress-traffic.md#restrict-egress-traffic-using-azure-firewall).

> [!IMPORTANT]
> Для исходящего типа UDR требуется маршрут для 0.0.0.0/0 и назначения следующего прыжка NVA (сетевого виртуального модуля) в таблице маршрутов.
> Таблица маршрутов уже имеет значение по умолчанию 0.0.0.0/0 для Интернета, без общедоступного IP-адреса для SNAT. только что добавление этого маршрута не даст вам исходящего трафика. AKS проверит, что вы не создадите маршрут 0.0.0.0/0, указывающий на Интернет, а не NVA, шлюз и т. д.


## <a name="next-steps"></a>Дальнейшие действия

См. раздел [Обзор сетевой UDR Azure](../virtual-network/virtual-networks-udr-overview.md).

См. раздел [Сведения о создании, изменении и удалении таблицы маршрутизации](../virtual-network/manage-route-table.md).

<!-- LINKS - internal -->
[az-aks-get-credentials]: /cli/azure/aks?view=azure-cli-latest#az-aks-get-credentials
[byo-route-table]: configure-kubenet.md#bring-your-own-subnet-and-route-table-with-kubenet
