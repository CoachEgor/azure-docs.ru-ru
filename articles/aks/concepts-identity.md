---
title: Основные понятия доступа и идентификации в Службе Azure Kubernetes (AKS)
description: Узнайте о доступе и идентификации в Службе Azure Kubernetes (AKS), включая интеграцию Azure Active Directory, управление доступом на основе ролей (RBAC) Kubernetes, роли и привязки.
services: container-service
ms.topic: conceptual
ms.date: 07/07/2020
author: palma21
ms.author: jpalma
ms.openlocfilehash: edb6a8e04537a74b7ea7d4c9bd9bd27fdc39e402
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "88007086"
---
# <a name="access-and-identity-options-for-azure-kubernetes-service-aks"></a>Возможности контроля доступа и идентификации в Службе Azure Kubernetes (AKS)

Существуют различные способы проверки подлинности, управления доступом, авторизации и защиты кластеров Kubernetes. С помощью управления доступом на основе ролей Kubernetes (RBAC) можно предоставлять пользователям, группам и учетным записям служб доступ только к необходимым ресурсам. С помощью службы Azure Kubernetes Service (AKS) можно дополнительно улучшить структуру безопасности и разрешений, используя Azure Active Directory и Azure RBAC. Эти подходы помогут защитить доступ к кластеру и предоставить только минимальные необходимые разрешения для разработчиков и операторов.

В этой статье рассматриваются основные понятия, которые помогут настроить аутентификацию и назначить разрешения в AKS:

- [Kubernetes управления доступом на основе ролей (RBAC)](#kubernetes-role-based-access-control-rbac)
  - [Элементы Role и ClusterRole](#roles-and-clusterroles)
  - [элементы RoleBinding и ClusterRoleBinding](#rolebindings-and-clusterrolebindings). 
  - [учетные записи службы Kubernetes (AKS)](#kubernetes-service-accounts);
- [Интеграция Azure Active Directory](#azure-active-directory-integration)
- [Azure RBAC](#azure-role-based-access-control-azure-rbac)
  - [Azure RBAC для авторизации доступа к ресурсу AKS](#azure-rbac-to-authorize-access-to-the-aks-resource)
  - [Авторизация Azure RBAC для Kubernetes (Предварительная версия)](#azure-rbac-for-kubernetes-authorization-preview)


## <a name="kubernetes-role-based-access-control-rbac"></a>Kubernetes управления доступом на основе ролей (RBAC)

Чтобы обеспечить детальную фильтрацию действий, которые пользователи могут выполнять, Kubernetes использует управление доступом на основе ролей (RBAC). Этот механизм управления позволяет назначить пользователям или группам пользователей разрешение на выполнение каких-либо действий. Это может быть создание или изменение ресурсов, просмотр журналов выполнения рабочих нагрузок приложений и т. п. Эти разрешения могут охватывать отдельное пространство имен или весь кластер AKS. Благодаря управлению доступом на основе ролей Kubernetes можно создать *роли*, чтобы определить разрешения, и затем назначить эти роли пользователям с помощью *привязок ролей*.

Дополнительные сведения см. в статье об [Использовании авторизации RBAC][kubernetes-rbac].


### <a name="roles-and-clusterroles"></a>Элементы Role и ClusterRole

Прежде чем назначить пользователям разрешения с помощью управления доступом на основе ролей Kubernetes, необходимо определить эти разрешения как элемент *Role*. Роли Kubernetes *предоставляют* разрешения. Нет концепции разрешения *Deny* .

Роли используются для предоставления разрешений в пространстве имен. Если вам нужно предоставить разрешения для доступа во всем кластере или для доступа к кластерным ресурсам за пределами данного пространства имен, вместо этого можно использовать элементы *ClusterRole*.

Элемент ClusterRole действует аналогичным образом, предоставляя разрешения для ресурсов, но его можно применить к ресурсам в пределах всего кластера, не в определенном пространстве имен.

### <a name="rolebindings-and-clusterrolebindings"></a>Элементы RoleBinding и ClusterRoleBinding

После определения ролей, предоставляющих разрешения для ресурсов, можно назначить эти разрешения RBAC Kubernetes с помощью элемента *RoleBinding*. Если кластер AKS [интегрируется с Azure Active Directory](#azure-active-directory-integration), то привязки пользователей Azure AD получают разрешения на выполнение действий в кластере. см. статью [Управление доступом к ресурсам кластера с помощью управления доступом на основе ролей и удостоверений Azure Active Directory](azure-ad-rbac.md).

Привязки роли используются для назначения ролей для определенного пространства имен. Такой подход позволяет логически разделить отдельный кластер AKS, предоставив пользователям доступ только к ресурсам приложений в назначенных им пространствах имен. Если вам нужно привязать роли для доступа во всем кластере или для доступа к кластерным ресурсам за пределами данного пространства имен, вместо этого можно использовать элементы *ClusterRoleBinding*.

Элемент ClusterRoleBinding действует аналогичным образом, привязывая роли к пользователям, но его можно применить к ресурсам в пределах всего кластера, а не в определенном пространстве имен. Такой подход позволяет предоставить администраторам или инженерам службы поддержки доступ ко всем ресурсам в кластере AKS.


> [!NOTE]
> Любые действия кластера, выполняемые Microsoft/AKS, выполняются с согласия пользователя во встроенной роли Kubernetes `aks-service` и встроенной привязке ролей `aks-service-rolebinding` . Эта роль позволяет AKS устранять неполадки в работе кластера и диагностировать их, но не может изменять разрешения и создавать роли или привязки ролей, а также другие действия с высоким уровнем привилегий. Доступ к роли доступен только в рамках активных запросов в службу поддержки с JIT-доступом. Узнайте больше о [политиках поддержки AKS](support-policies.md).


### <a name="kubernetes-service-accounts"></a>Учетные записи службы Kubernetes

Одним из основных типов пользователя в Kubernetes является *учетная запись службы*. Учетная запись службы существует в API Kubernetes. Этот же API используется для управлению ею. Учетные данные для учетных записей службы хранятся в виде секретов Kubernetes, что позволяет использовать их авторизованным элементам pod для взаимодействия с сервером API. Большинство запросов к API содержат маркер аутентификации для учетной записи службы или обычной учетной записи пользователя.

Обычные учетные записи пользователей предоставляют более традиционный доступ для администраторов или разработчиков, а не только служб и процессов. Kubernetes сама по себе не предоставляет решение для управления удостоверениями, в котором хранятся обычные учетные записи пользователей и пароли. Подобные внешние решения по управлению удостоверениями могут интегрироваться в Kubernetes. Для кластеров AKS таким интегрированным решением по управлению удостоверениями является Azure Active Directory.

Дополнительные сведения о возможностях идентификации в Kubernetes см. в разделе об [аутентификации Kubernetes][kubernetes-authentication].

## <a name="azure-active-directory-integration"></a>Интеграция Azure Active Directory

Безопасность кластеров AKS можно повысить благодаря интеграции Azure Active Directory (AD). Azure AD — это мультитенантный облачный каталог и служба управления удостоверениями, созданные после десятилетий разработки корпоративных решений по управлению удостоверениями. В этом решении объединены базовые службы каталогов, функции управления доступом к приложениям и защита идентификации. С помощью Azure AD можно интегрировать локальные удостоверения в кластеры AKS, чтобы обеспечить централизованную защиту учетных записей и управление ими.

![Интеграция Azure Active Directory с кластерами AKS](media/concepts-identity/aad-integration.png)

При использовании кластеров Azure AKS, интегрированных с Azure AD, можно предоставить пользователям или группам доступ к ресурсам Kubernetes, размещенным в определенном пространстве имен или кластере. Для получения контекста конфигурации `kubectl` пользователь может выполнить команду [az aks get-credentials][az-aks-get-credentials]. Когда пользователь взаимодействует с кластером AKS с `kubectl` , ему предлагается выполнить вход с использованием учетных данных Azure AD. Такой подход обеспечивает единый источник для управления учетными записями пользователя и хранения паролей. Пользователь имеет доступ только к ресурсам, определенным администратором кластера.

Кластеры AKS проходят аутентификацию Azure AD с помощью OpenID Connect. OpenID Connect представляет собой уровень идентификации на основе протокола OAuth 2.0. Дополнительные сведения о OpenID Connect Connect см. в [документации по Open ID Connect][openid-connect]. В кластере Kubernetes [Проверка подлинности маркеров веб-перехватчика][webhook-token-docs] используется для проверки маркеров проверки подлинности. Настройка такой проверка подлинности и ее управление являются частью кластера AKS.

### <a name="webhook-and-api-server"></a>Веб-перехватчик и сервер API

![Поток проверки подлинности веб-перехватчика и сервера API](media/concepts-identity/auth-flow.png)

Как показано на рисунке выше, сервер API вызывает сервер веб-перехватчика AKS и выполняет следующие действия:

1. Клиентское приложение Azure AD используется kubectl для входа пользователей с использованием [потока предоставления авторизации устройства OAuth 2,0](../active-directory/develop/v2-oauth2-device-code.md).
2. Azure AD предоставляет access_token, id_token и refresh_token.
3. Пользователь выполняет запрос к kubectl с помощью access_token из kubeconfig.
4. Kubectl отправляет access_token в Аписервер.
5. Сервер API настроен с сервером веб-перехватчика проверки подлинности для выполнения проверки.
6. Сервер веб-перехватчика проверки подлинности подтверждает правильность подписи JSON Web Token, проверив открытый ключ подписывания Azure AD.
7. Серверное приложение использует предоставленные пользователем учетные данные для запроса членства пользователя, вошедшего в систему, из MS API Graph.
8. Ответ отправляется в Аписервер со сведениями о пользователе, такими как утверждение имени участника-пользователя (UPN) маркера доступа, и членство пользователя в группе на основе идентификатора объекта.
9. API выполняет авторизацию на основе роли Kubernetes/Ролебиндинг.
10. После авторизации сервер API вернет ответ в kubectl.
11. Kubectl предоставляет пользователю отзыв.
 
**Сведения о том, как интегрировать AKS с AAD, см. [здесь](managed-aad.md).**

## <a name="azure-role-based-access-control-azure-rbac"></a>Управление доступом Azure на основе ролей (Azure RBAC)

RBAC Azure — это система авторизации на основе [Azure Resource Manager](../azure-resource-manager/management/overview.md), которая обеспечивает широкие возможности управления доступом к ресурсам Azure.

 Azure RBAC предназначен для работы с ресурсами в подписке Azure, тогда как Kubernetes RBAC предназначен для работы с ресурсами Kubernetes в кластере AKS. 

С помощью управления доступом на основе ролей Azure можно создать *определение роли*, описывающее предоставляемые разрешения. Затем пользователю или группе назначается это определение роли с помощью *назначения роли* для определенной *области*, которая может быть отдельным ресурсом, группой ресурсов или в рамках подписки.

Дополнительные сведения см. в статье [что такое управление доступом на основе ролей Azure (Azure RBAC)?][azure-rbac]

Для полной работы с кластером AKS требуется два уровня доступа: 
1. [Получите доступ к ресурсу AKS в подписке Azure](#azure-rbac-to-authorize-access-to-the-aks-resource). Этот процесс позволяет управлять масштабированием или обновлением кластера с помощью интерфейсов API AKS, а также извлекать kubeconfig.
2. Доступ к API Kubernetes. Этот доступ управляется либо с помощью [KUBERNETES RBAC](#kubernetes-role-based-access-control-rbac) (традиционного), либо путем [интеграции Azure RBAC с AKS для авторизации Kubernetes](#azure-rbac-for-kubernetes-authorization-preview) .

### <a name="azure-rbac-to-authorize-access-to-the-aks-resource"></a>Azure RBAC для авторизации доступа к ресурсу AKS

С помощью Azure RBAC вы можете предоставить пользователям (или удостоверениям) детальный доступ к ресурсам AKS в одной или нескольких подписках. Например, у вас может быть [роль участника службы Azure Kubernetes](../role-based-access-control/built-in-roles.md#azure-kubernetes-service-contributor-role) , которая позволяет выполнять такие действия, как масштабирование и обновление кластера. Хотя другой пользователь может иметь [роль администратора кластера службы Kubernetes Azure](../role-based-access-control/built-in-roles.md#azure-kubernetes-service-cluster-admin-role) , которая предоставляет только разрешение на извлечение kubeconfig администратора.

Кроме того, вы можете предоставить пользователю роль общего [участника](../role-based-access-control/built-in-roles.md#contributor) , которая будет охватывать указанные выше разрешения и все возможные действия в ресурсе AKS за исключением управления разрешениями.

См [. Дополнительные](control-kubeconfig-access.md)сведения об использовании Azure RBAC для защиты доступа к файлу kubeconfig, который предоставляет доступ к API Kubernetes.

### <a name="azure-rbac-for-kubernetes-authorization-preview"></a>Авторизация Azure RBAC для Kubernetes (Предварительная версия)

С помощью интеграции RBAC Azure AKS будет использовать сервер веб-перехватчика Kubernetes Authorization для управления разрешениями и назначениями ресурсов кластера K8s, интегрированных с Azure AD, используя определение роли Azure и назначения ролей.

![Поток авторизации Azure RBAC для Kubernetes](media/concepts-identity/azure-rbac-k8s-authz-flow.png)

Как показано на схеме выше, при использовании интеграции с Azure RBAC все запросы к API Kubernetes будут следовать тому же потоку проверки подлинности, как описано в [разделе Azure Active Integration](#azure-active-directory-integration). 

Но после этого, вместо того чтобы просто полагаться на Kubernetes RBAC для авторизации, запрос на самом деле будет авторизован Azure, пока идентификатор, который сделал запрос, существует в AAD. Если удостоверение не существует в AAD, например учетная запись службы Kubernetes, то Azure RBAC не запустится и будет обычной Kubernetes RBAC.

В этом сценарии можно предоставить пользователям одну из четырех встроенных ролей или создать пользовательские роли, как это делается с Kubernetes ролями, но в этом случае с помощью механизмов и API-интерфейсов RBAC в Azure. 

Эта функция позволяет, например, не только предоставлять пользователям разрешения на доступ к ресурсу AKS в подписках, но и задавать им роль и разрешения, которые они будут иметь в каждом из кластеров, управляющих доступом к API Kubernetes. Например, можно предоставить `Azure Kubernetes Service RBAC Viewer` роль в области действия подписки, и ее получатель сможет перечислить и получить все объекты Kubernetes из всех кластеров, но не изменять их.


#### <a name="built-in-roles"></a>Встроенные роли

AKS предоставляет следующие четыре встроенных роли. Они похожи на [встроенные роли Kubernetes](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles) , но с несколькими отличиями, такими как поддержка КРДС. Полный список действий, разрешенных каждой встроенной ролью, см. [здесь](../role-based-access-control/built-in-roles.md).

| Роль                                | Описание  |
|-------------------------------------|--------------|
| Средство просмотра RBAC службы Azure Kubernetes  | Разрешает доступ только для чтения для просмотра большинства объектов в пространстве имен. Он не позволяет просматривать роли или привязки ролей. Эта роль не разрешает просмотр `Secrets` , так как чтение содержимого секретов обеспечивает доступ к `ServiceAccount` учетным данным в пространстве имен, что позволило бы получить доступ к API как к любому `ServiceAccount` из пространств имен (форма укрупнения привилегий).  |
| Модуль записи RBAC службы Azure Kubernetes | Разрешает доступ для чтения и записи к большинству объектов в пространстве имен. Эта роль не позволяет просматривать или изменять роли или привязки ролей. Однако эта роль позволяет получать доступ к классам Pod `Secrets` и запускать их как любые учетная запись службы в пространстве имен, поэтому его можно использовать для получения уровней доступа API любых учетная запись службы в пространстве имен. |
| Администратор RBAC службы Azure Kubernetes  | Предоставляет административный доступ, предназначенный для предоставления в пространстве имен. Разрешает доступ для чтения и записи к большинству ресурсов в пространстве имен (или области кластера), включая возможность создания ролей и привязок ролей в пространстве имен. Эта роль не разрешает доступ на запись к квоте ресурса или пространству имен. |
| Администратор кластера RBAC службы Azure Kubernetes  | Разрешает доступ суперпользователя для выполнения любых действий с любым ресурсом. Он предоставляет полный контроль над каждым ресурсом в кластере и во всех пространствах имен. |

**Узнайте, как использовать Azure RBAC для авторизации Kubernetes [здесь](manage-azure-rbac.md).**

## <a name="next-steps"></a>Дальнейшие шаги

- Чтобы приступить к работе с Azure AD и управлению доступом на основе ролей Kubernetes, ознакомьтесь с разделом [Интеграция Azure Active Directory со службой Azure Kubernetes][aks-aad].
- Соответствующие рекомендации см. в разделе рекомендации [по проверке подлинности и авторизации в AKS][operator-best-practices-identity].
- Чтобы приступить к работе с Azure RBAC для авторизации Kubernetes, см. статью [Использование Azure RBAC для авторизации доступа в кластере службы Kubernetes Azure (AKS)](manage-azure-rbac.md).
- Чтобы приступить к защите файла kubeconfig, см. раздел [ограничение доступа к файлу конфигурации кластера](control-kubeconfig-access.md) .

Дополнительные сведения о ключевых понятиях Kubernetes и AKS приведены в следующих статьях:

- [Кластеры и рабочие нагрузки Kubernetes и AKS][aks-concepts-clusters-workloads]
- [Безопасность Kubernetes и AKS][aks-concepts-security]
- [Виртуальные сети Kubernetes и AKS][aks-concepts-network]
- [Хранилище Kubernetes и AKS][aks-concepts-storage]
- [Масштабирование Kubernetes и AKS][aks-concepts-scale]

<!-- LINKS - External -->
[kubernetes-authentication]: https://kubernetes.io/docs/reference/access-authn-authz/authentication
[webhook-token-docs]: https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication
[kubernetes-rbac]: https://kubernetes.io/docs/reference/access-authn-authz/rbac/

<!-- LINKS - Internal -->
[openid-connect]: ../active-directory/develop/v2-protocols-oidc.md
[az-aks-get-credentials]: /cli/azure/aks#az-aks-get-credentials
[azure-rbac]: ../role-based-access-control/overview.md
[aks-aad]: managed-aad.md
[aks-concepts-clusters-workloads]: concepts-clusters-workloads.md
[aks-concepts-security]: concepts-security.md
[aks-concepts-scale]: concepts-scale.md
[aks-concepts-storage]: concepts-storage.md
[aks-concepts-network]: concepts-network.md
[operator-best-practices-identity]: operator-best-practices-identity.md
