---
title: Ограничить исходящий трафик в службе Azure Kubernetes (AKS)
description: Узнайте, какие порты и адреса необходимы для управления исходящий трафик в службе Azure Kubernetes (AKS)
services: container-service
author: iainfoulds
ms.service: container-service
ms.topic: article
ms.date: 05/14/2019
ms.author: iainfou
ms.openlocfilehash: de0ba13a527569e446a44c275b7323d4487f53b6
ms.sourcegitcommit: 36c50860e75d86f0d0e2be9e3213ffa9a06f4150
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2019
ms.locfileid: "65780294"
---
# <a name="preview---limit-egress-traffic-for-cluster-nodes-and-control-access-to-required-ports-and-services-in-azure-kubernetes-service-aks"></a>Предварительная версия — ограничение исходящий трафик для узлов кластера и управление доступом для требуемых портов и служб в службе Azure Kubernetes (AKS)

По умолчанию кластерах AKS имеют неограниченный доступ к Интернету для исходящего трафика (исходящий трафик). Этот уровень доступа к сети позволяет узлам и службам, при запуске для доступа к внешним ресурсам, при необходимости. Если вы хотите ограничить исходящий трафик, ограниченное число порты и адреса должны быть доступны для поддержки задачи обслуживания работоспособность кластера. Затем кластер настроен на использование только базовой системы образы контейнера из реестра контейнеров Microsoft (MCR) или реестр контейнеров Azure (ACR), не внешние общедоступных репозиториях.

В этой статье подробно, какие сетевые порты и полные доменные имена (FQDN) являются обязательные и необязательные, если ограничить исходящий трафик в кластере AKS.  Эта функция в настоящее время находится на стадии предварительной версии.

> [!IMPORTANT]
> Компоненты предварительной версии AKS, самообслуживания и согласиться. Предварительные версии предоставляются для сбора отзывов и ошибки нашего сообщества. Тем не менее они не поддерживаются в службе технической поддержки Azure. Если создать кластер, или добавить эти компоненты в имеющиеся кластеры, этого кластера не поддерживается, пока эта функция больше не находится в предварительной версии и этапах общедоступная (GA).
>
> При возникновении проблем с помощью функции предварительной версии, [сообщите о них в репозитории AKS GitHub] [ aks-github] именем функции предварительной версии в заголовке ошибки.

## <a name="before-you-begin"></a>Перед началом работы

Требуется Azure CLI версии 2.0.61 или более поздней версии установлен и настроен. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][install-azure-cli].

Чтобы создать кластер AKS, можно ограничить исходящий трафик, необходимо сначала включите флаг компонента по вашей подписке. Эта функция регистрация настраивает все кластеры AKS, создаваемый для использования базовой системы образы контейнера из MCR или ACR. Чтобы зарегистрировать *AKSLockingDownEgressPreview* флаг, используйте [az функция register] [ az-feature-register] команды, как показано в следующем примере:

```azurecli-interactive
az feature register --name AKSLockingDownEgressPreview --namespace Microsoft.ContainerService
```

Через несколько минут отобразится состояние *Registered* (Зарегистрировано). Можно проверить состояние регистрации с помощью [список функций az] [ az-feature-list] команды:

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/AKSLockingDownEgressPreview')].{Name:name,State:properties.state}"
```

Когда все будет готово, обновить регистрацию *Microsoft.ContainerService* поставщика ресурсов с помощью [az provider register] [ az-provider-register] команды:

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

## <a name="egress-traffic-overview"></a>Обзор исходящего трафика

Для управления и рабочие узлы в кластере AKS требуется доступ к определенных портов и полные доменные имена (FQDN). Эти действия может быть для взаимодействия с сервером API, загрузите и установите основные компоненты кластера Kubernetes и обновления для системы безопасности узла. По умолчанию исходящий трафик (исходящий) Интернет-трафик не ограничено для узлов в кластере AKS. Кластер может получайте образы контейнеров базовой системой из внешних репозиториях.

Для повышения безопасности кластера AKS, может потребоваться ограничить исходящий трафик. Кластер настроен для извлечения образов контейнеров из MCR или ACR базовой системы. Если вы блокируете исходящий трафик таким образом, необходимо определить определенные порты и полных доменных имен, чтобы узлы могли взаимодействовать с обязательным внешними службами AKS. Без этих авторизованных портов и полных доменных имен узлов AKS не может связаться с сервером API или установка основных компонентов.

Можно использовать [брандмауэр Azure] [ azure-firewall] или сторонний брандмауэр для защиты вашей исходящий трафик и определить их требуется порты и адреса.

В AKS существует два набора порты и адреса.

* [Порты и адреса, необходимые для кластеров в AKS](#required-ports-and-addresses-for-aks-clusters) сведения о минимальных требованиях к авторизованным исходящий трафик.
* [Необязательно рекомендуется адреса и порты для кластеров в AKS](#optional-recommended-addresses-and-ports-for-aks-clusters) не являются обязательными для всех сценариев, но интеграция с другими службами, такие как Azure Monitor не будет работать правильно. Просмотрите этот список дополнительных портов и полных доменных имен и разрешить все службы и компоненты, используемые в кластере AKS.

> [!NOTE]
> Ограничение исходящего трафика работает только на новых кластерах AKS, созданные после включения регистрации флаг компонента. Для существующих кластеров [выполните операцию обновления кластера] [ aks-upgrade] с помощью `az aks upgrade` команды перед ограничить исходящий трафик.

## <a name="required-ports-and-addresses-for-aks-clusters"></a>Требуемые порты и адреса для кластеров в AKS

Следующие исходящие порты и правила сети необходимы для кластера AKS:

* TCP-порт *443*
* TCP-порт *9000*

Следующими полными именами домена / правил приложения требуются:

| Полное доменное имя                      | Port      | Использование      |
|---------------------------|-----------|----------|
| *. azmk8s.io               | HTTPS:443 | Этот адрес является конечной точкой сервера API. |
| aksrepos.azurecr.io       | HTTPS:443 | Этот адрес необходим для доступа к образов в реестр контейнеров Azure (ACR). |
| *.blob.core.windows.net   | HTTPS:443 | Этот адрес является серверным хранилищем для изображений, хранящихся в ACR. |
| mcr.microsoft.com         | HTTPS:443 | Этот адрес необходим для доступа к образов в реестр контейнеров (MCR). |
| management.azure.com      | HTTPS:443 | Этот адрес является обязательным для операций Kubernetes GET/PUT. |
| login.microsoftonline.com | HTTPS:443 | Этот адрес необходим для проверки подлинности Azure Active Directory. |

## <a name="optional-recommended-addresses-and-ports-for-aks-clusters"></a>Рекомендуется использовать необязательно, адреса и порты для кластеров в AKS

Следующие исходящие порты / правил сети не являются обязательными для AKS кластеров для правильной, но их рекомендуется:

* UDP-порт *123* для синхронизации времени NTP
* UDP-порт *53* для DNS

Следующими полными именами домена / правил приложения рекомендуются для AKS кластеров для правильной работы:

| Полное доменное имя                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| *.ubuntu.com                            | HTTP:80   | Этот адрес позволяет загрузить исправления и обновления узлов кластера Linux. |
| Packages.Microsoft.com                  | HTTPS:443 | Этот адрес — это репозиторий пакетов Microsoft используется для кэшированных *apt-get* операций. |
| dc.services.visualstudio.com            | HTTPS:443 | Рекомендуется для правильного метрик и мониторинг с помощью Azure Monitor. |
| *.opinsights.azure.com                  | HTTPS:443 | Рекомендуется для правильного метрик и мониторинг с помощью Azure Monitor. |
| *.monitoring.azure.com                  | HTTPS:443 | Рекомендуется для правильного метрик и мониторинг с помощью Azure Monitor. |
| gov-prod-policy-data.trafficmanager.net | HTTPS:443 | Этот адрес используется для корректной работы "Политика Azure" (сейчас в предварительной версии в AKS). |
| apt.dockerproject.org                   | HTTPS:443 | Этот адрес используется для установки драйвер и операции на узлах, на основе графического Процессора. |
| nvidia.github.io                        | HTTPS:443 | Этот адрес используется для установки драйвер и операции на узлах, на основе графического Процессора. |

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, какие порты и адреса, чтобы разрешить, если ограничить исходящий трафик для кластера. Также можно определить как модули, сами могут взаимодействовать и какие ограничения у них есть в пределах кластера. Дополнительные сведения см. в разделе [защиты трафика между модулей с помощью политик сети в AKS][network-policy].

<!-- LINKS - external -->
[aks-github]: https://github.com/azure/aks/issues]

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[network-policy]: use-network-policies.md
[azure-firewall]: ../firewall/overview.md
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-upgrade]: upgrade-cluster.md
