---
title: Ограничить трафик исходящего трафика в службе Kubernetes Azure (AKS)
description: Сведения о том, какие порты и адреса требуются для управления исходящим трафиком в службе Kubernetes Azure (AKS)
services: container-service
author: mlearned
ms.service: container-service
ms.topic: article
ms.date: 01/21/2020
ms.author: mlearned
ms.openlocfilehash: df8b4d7ea44f885ee0fed0479ba87a4bc9ba1a29
ms.sourcegitcommit: a9b1f7d5111cb07e3462973eb607ff1e512bc407
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2020
ms.locfileid: "76310175"
---
# <a name="control-egress-traffic-for-cluster-nodes-in-azure-kubernetes-service-aks"></a>Управление трафиком исходящего трафика для узлов кластера в службе Kubernetes Azure (AKS)

По умолчанию кластеры AKS имеют неограниченный исходящий доступ к Интернету. Этот уровень доступа к сети позволяет узлам и службам, которые выполняются при необходимости, обращаться к внешним ресурсам. Если вы хотите ограничить трафик исходящего трафика, ограниченное число портов и адресов должно быть доступно для поддержания работоспособных задач обслуживания кластера. Кластер настроен по умолчанию для использования только базовых образов системных контейнеров из реестра контейнеров Майкрософт (мкр) или реестра контейнеров Azure (записи контроля доступа). Настройте предпочитаемый брандмауэр и правила безопасности, чтобы разрешить эти порты и адреса.

В этой статье описывается, какие сетевые порты и полные доменные имена (FQDN) являются обязательными, а также необязательно, если трафик исходящего трафика в кластере AKS ограничивается.

> [!IMPORTANT]
> В этом документе рассматривается только способ блокировки трафика, в котором находится подсеть AKS. AKS не имеет требований к входящим сообщениям.  Блокировка трафика внутренней подсети с помощью групп безопасности сети (группы безопасности сети) и брандмауэров не поддерживается. Для управления и блокировки трафика в кластере используйте [политики сети][network-policy].

## <a name="before-you-begin"></a>Перед началом работы

Требуется Azure CLI версии 2.0.66 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][install-azure-cli].

## <a name="egress-traffic-overview"></a>Обзор исходящего трафика

Для целей управления и эксплуатации узлы в кластере AKS должны иметь доступ к определенным портам и полным доменным именам (FQDN). Эти действия могут быть взаимодействующими с сервером API или загружать, а затем устанавливать компоненты кластера Core Kubernetes и обновления безопасности узла. По умолчанию исходящий трафик Интернета не ограничен для узлов в кластере AKS. Кластер может извлекать базовые образы системных контейнеров из внешних репозиториев.

Для повышения безопасности кластера AKS может потребоваться ограничить трафик исходящего трафика. Кластер настроен на извлечение базовых образов системных контейнеров из мкр или записи контроля доступа. Если трафик исходящего трафика блокируется таким образом, определите определенные порты и полные доменные имена, чтобы разрешить узлам AKS правильно взаимодействовать с необходимыми внешними службами. Без этих полномочных портов и полных доменных имен узлы AKS не смогут взаимодействовать с сервером API или устанавливать основные компоненты.

Вы можете использовать [брандмауэр Azure][azure-firewall] или стороннее устройство брандмауэра для защиты исходящего трафика и определить необходимые порты и адреса. AKS не создает эти правила автоматически. Следующие порты и адреса предназначены для справки при создании соответствующих правил в сетевом брандмауэре.

> [!IMPORTANT]
> При использовании брандмауэра Azure для ограничения трафика выхода и создания определяемого пользователем маршрута (UDR) для принудительного выхода всего исходящего трафика убедитесь, что в брандмауэре создано соответствующее правило ДНаТ, чтобы правильно разрешить входящий трафик. Использование брандмауэра Azure с UDR нарушает настройку входящих данных из-за асимметричной маршрутизации. (Проблема возникает, если подсеть AKS имеет маршрут по умолчанию, который переходит на частный IP-адрес брандмауэра, но используется общедоступная подсистема балансировки нагрузки — входящий или Kubernetes служба типа: Подсистема балансировки нагрузки). В этом случае входящий трафик подсистемы балансировки нагрузки поступает через общедоступный IP-адрес, а обратный путь проходит через частный IP-адрес брандмауэра. Так как брандмауэр является отслеживанием состояния, он удаляет возвращаемый пакет, так как брандмауэр не имеет сведений о установленном сеансе. Сведения о том, как интегрировать брандмауэр Azure с входящими данными или подсистемой балансировки нагрузки служб, см. в статье [Интеграция брандмауэра Azure с azure Load Balancer (цен. Категория "Стандартный")](https://docs.microsoft.com/azure/firewall/integrate-lb).
> Вы можете заблокировать трафик для TCP-порта 9000 и TCP-порта 22, используя сетевое правило между IP и IP для рабочего узла исходящего трафика для сервера API.

В AKS есть два набора портов и адресов:

* [Необходимые порты и адрес для кластеров AKS](#required-ports-and-addresses-for-aks-clusters) сведения о минимальных требованиях к зарегистрированному исходящего трафика.
* [Необязательные Рекомендуемые адреса и порты для кластеров AKS](#optional-recommended-addresses-and-ports-for-aks-clusters) не требуются для всех сценариев, но интеграция с другими службами, такими как Azure Monitor, будет работать неправильно. Ознакомьтесь со списком дополнительных портов и полных доменных имен и Авторизуйте любые службы и компоненты, используемые в кластере AKS.

> [!NOTE]
> Ограничение исходящего трафика работает только в новых кластерах AKS. Для существующих кластеров [выполните операцию обновления кластера][aks-upgrade] с помощью команды `az aks upgrade`, прежде чем ограничить трафик исходящего трафика.

## <a name="required-ports-and-addresses-for-aks-clusters"></a>Необходимые порты и адреса для кластеров AKS

Для кластера AKS требуются следующие исходящие порты и правила сети.

* TCP-порт *443*
* TCP [Ипаддрофйоураписервер]: 443 требуется, если у вас есть приложение, которое должно взаимодействовать с сервером API.  Это изменение можно задать после создания кластера.
* TCP-порт *9000* и TCP-порт *22* для внешнего модуля туннелирования для взаимодействия с конечным сервером на сервере API.
    * Чтобы получить более конкретные сведения, см. раздел * *. HCP.\<расположение\>. azmk8s.IO* и * *. Тун.\<расположение\>. azmk8s.IO* адреса в следующей таблице.
* UDP-порт *123* для синхронизации времени по протоколу NTP (узлы Linux).
* UDP-порт *53* для DNS также требуется при наличии модулей, напрямую обращающихся к серверу API.

Необходимо следующее полное доменное имя или правила приложения:
- Azure (глобальный)

| Полное доменное имя.                       | Port      | Использование      |
|----------------------------|-----------|----------|
| *. HCP. Расположение\<\>. azmk8s.io | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. Замените *расположение\<\>* регионом, в котором развернут кластер AKS. |
| *. Тун. Расположение\<\>. azmk8s.io | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. Замените *расположение\<\>* регионом, в котором развернут кластер AKS. |
| aksrepos.azurecr.io        | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Azure (запись контроля доступа). В этом реестре содержатся сторонние изображения и диаграммы (например, сервер метрик, ядро DNS и т. д.), необходимые для функционирования кластера во время обновления и масштабирования кластера.|
| *.blob.core.windows.net    | HTTPS:443 | Этот адрес является хранилищем серверной части для образов, хранящихся в записи контроля доступа. |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Microsoft (мкр). В этом реестре содержатся образы и диаграммы от сторонних производителей (например, значок Кита и т. д.), необходимые для функционирования кластера во время обновления и масштабирования кластера. |
| *.cdn.mscr.io              | HTTPS:443 | Этот адрес необходим для хранилища мкр, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.azure.com       | HTTPS:443 | Этот адрес необходим для операций получения/размещения Kubernetes. |
| login.microsoftonline.com  | HTTPS:443 | Этот адрес необходим для Azure Active Directory проверки подлинности. |
| ntp.ubuntu.com             | UDP: 123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес является репозиторием пакетов Майкрософт, используемым для кэшированных операций *apt-get* .  Примерами пакетов являются значок Кита, PowerShell и Azure CLI. |
| acs-mirror.azureedge.net   | HTTPS:443 | Этот адрес предназначен для репозитория, необходимого для установки необходимых двоичных файлов, таких как кубенет и Azure CNI. |
- Azure China 21Vianet

| Полное доменное имя.                       | Port      | Использование      |
|----------------------------|-----------|----------|
| *. HCP. Расположение\<\>. cx.prod.service.azk8s.cn | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. Замените *расположение\<\>* регионом, в котором развернут кластер AKS. |
| *. Тун. Расположение\<\>. cx.prod.service.azk8s.cn | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. Замените *расположение\<\>* регионом, в котором развернут кластер AKS. |
| *. azk8s.cn        | HTTPS:443 | Этот адрес необходим для скачивания необходимых двоичных файлов и образов|
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Microsoft (мкр). В этом реестре содержатся образы и диаграммы от сторонних производителей (например, значок Кита и т. д.), необходимые для функционирования кластера во время обновления и масштабирования кластера. |
| *.cdn.mscr.io              | HTTPS:443 | Этот адрес необходим для хранилища мкр, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.chinacloudapi.cn       | HTTPS:443 | Этот адрес необходим для операций получения/размещения Kubernetes. |
| login.chinacloudapi.cn  | HTTPS:443 | Этот адрес необходим для Azure Active Directory проверки подлинности. |
| ntp.ubuntu.com             | UDP: 123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес является репозиторием пакетов Майкрософт, используемым для кэшированных операций *apt-get* .  Примерами пакетов являются значок Кита, PowerShell и Azure CLI. |
- Azure для государственных организаций

| Полное доменное имя.                       | Port      | Использование      |
|----------------------------|-----------|----------|
| *. HCP. Расположение\<\>. cx.aks.containerservice.azure.us | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. Замените *расположение\<\>* регионом, в котором развернут кластер AKS. |
| *. Тун. Расположение\<\>. cx.aks.containerservice.azure.us | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. Замените *расположение\<\>* регионом, в котором развернут кластер AKS. |
| aksrepos.azurecr.io        | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Azure (запись контроля доступа). В этом реестре содержатся сторонние изображения и диаграммы (например, сервер метрик, ядро DNS и т. д.), необходимые для функционирования кластера во время обновления и масштабирования кластера.|
| *.blob.core.windows.net    | HTTPS:443 | Этот адрес является хранилищем серверной части для образов, хранящихся в записи контроля доступа. |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Microsoft (мкр). В этом реестре содержатся образы и диаграммы от сторонних производителей (например, значок Кита и т. д.), необходимые для функционирования кластера во время обновления и масштабирования кластера. |
| *.cdn.mscr.io              | HTTPS:443 | Этот адрес необходим для хранилища мкр, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.usgovcloudapi.net       | HTTPS:443 | Этот адрес необходим для операций получения/размещения Kubernetes. |
| login.microsoftonline.us  | HTTPS:443 | Этот адрес необходим для Azure Active Directory проверки подлинности. |
| ntp.ubuntu.com             | UDP: 123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес является репозиторием пакетов Майкрософт, используемым для кэшированных операций *apt-get* .  Примерами пакетов являются значок Кита, PowerShell и Azure CLI. |
| acs-mirror.azureedge.net   | HTTPS:443 | Этот адрес предназначен для репозитория, необходимого для установки необходимых двоичных файлов, таких как кубенет и Azure CNI. |
## <a name="optional-recommended-addresses-and-ports-for-aks-clusters"></a>Необязательные Рекомендуемые адреса и порты для кластеров AKS

Следующие исходящие порты и сетевые правила являются необязательными для кластера AKS:

Для правильной работы кластеров AKS рекомендуется следующее полное доменное имя/правила приложения:

| Полное доменное имя.                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| security.ubuntu.com, azure.archive.ubuntu.com, changelogs.ubuntu.com | HTTP: 80   | Этот адрес позволяет узлам кластера Linux скачивать необходимые исправления и обновления для системы безопасности. |

## <a name="required-addresses-and-ports-for-gpu-enabled-aks-clusters"></a>Необходимые адреса и порты для кластеров AKS с поддержкой GPU

Для кластеров AKS, в которых включен GPU, требуются следующие правила полного доменного имени и приложения:

| Полное доменное имя.                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| nvidia.github.io | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |
| us.download.nvidia.com | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |
| apt.dockerproject.org | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |

## <a name="required-addresses-and-ports-with-azure-monitor-for-containers-enabled"></a>Обязательные адреса и порты с включенным Azure Monitor для контейнеров

Для кластеров AKS, в которых включены Azure Monitor для контейнеров, требуются следующие полные доменные имена и правила приложения:

| Полное доменное имя.                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| dc.services.visualstudio.com | HTTPS:443  | Это для правильных метрик и мониторинга телеметрии с помощью Azure Monitor. |
| *.ods.opinsights.azure.com    | HTTPS:443 | Он используется Azure Monitor для приема данных log Analytics. |
| *.oms.opinsights.azure.com | HTTPS:443 | Этот адрес используется omsagent, который используется для проверки подлинности службы log Analytics. |
|*.microsoftonline.com | HTTPS:443 | Используется для проверки подлинности и отправки метрик в Azure Monitor. |
|*. monitoring.azure.com | HTTPS:443 | Используется для отправки данных метрик в Azure Monitor. |

## <a name="required-addresses-and-ports-with-azure-dev-spaces-enabled"></a>Обязательные адреса и порты с включенным Azure Dev Spaces

Для кластеров AKS, в которых включен Azure Dev Spaces, требуются следующие правила полного доменного имени и приложения:

| Полное доменное имя.                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| cloudflare.docker.com | HTTPS:443 | Этот адрес используется для извлечения образов Linux Alpine и других Azure Dev Spaces |
| gcr.io | HTTP: 443 | Этот адрес используется для извлечения образов Helm/с. |
| storage.googleapis.com | HTTP: 443 | Этот адрес используется для извлечения образов Helm/с. |
| аздс —<guid>.<location>. azds.io | HTTPS:443 | Для взаимодействия с Azure Dev Spaces серверных служб для контроллера. Точное полное доменное имя можно найти в "Датапланефкдн" в% USERPROFILE%\.аздс\сеттингс.жсон |

## <a name="required-addresses-and-ports-for-aks-clusters-with-azure-policy-in-public-preview-enabled"></a>Обязательные адреса и порты для кластеров AKS с включенной политикой Azure (в общедоступной предварительной версии)

> [!CAUTION]
> Ниже приведены некоторые функции, доступные в предварительной версии.  Рекомендации в этой статье могут быть изменены по мере перехода функции в общедоступную предварительную версию и на будущие этапы выпуска.

Для кластеров AKS, в которых включена политика Azure, требуются следующие полные доменные имена и правила приложения.

| Полное доменное имя.                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| gov-prod-policy-data.trafficmanager.net | HTTPS:443 | Этот адрес используется для правильной работы политики Azure. (сейчас находится в предварительной версии в AKS) |
| raw.githubusercontent.com | HTTPS:443 | Этот адрес используется для извлечения встроенных политик из GitHub, чтобы обеспечить правильную работу политики Azure. (сейчас находится в предварительной версии в AKS) |
| *. GK.<location>. azmk8s.io | HTTPS:443 | Надстройка политики Azure, которая обращается к конечной точке аудита привратника, работающей на главном сервере, для получения результатов аудита. |
| dc.services.visualstudio.com | HTTPS:443 | Надстройка политики Azure, которая отправляет данные телеметрии в конечную точку Application Insights. |

## <a name="required-by-windows-server-based-nodes-in-public-preview-enabled"></a>Требуется для узлов на базе Windows Server (в общедоступной предварительной версии)

> [!CAUTION]
> Ниже приведены некоторые функции, доступные в предварительной версии.  Рекомендации в этой статье могут быть изменены по мере перехода функции в общедоступную предварительную версию и на будущие этапы выпуска.

Для кластеров AKS на основе Windows Server требуется следующее полное доменное имя или правила приложения:

| Полное доменное имя.                                    | Port      | Использование      |
|-----------------------------------------|-----------|----------|
| onegetcdn.azureedge.net, winlayers.blob.core.windows.net, winlayers.cdn.mscr.io, go.microsoft.com | HTTPS:443 | Установка двоичных файлов, связанных с Windows |
| mp.microsoft.com, www<span></span>. msftconnecttest.com, ctldl.windowsupdate.com | HTTP: 80 | Установка двоичных файлов, связанных с Windows |
| kms.core.windows.net | TCP: 1688 | Установка двоичных файлов, связанных с Windows |


## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, какие порты и адреса следует разрешить при ограничении исходящего трафика для кластера. Вы также можете определить, как сами модули Pod могут взаимодействовать и какие ограничения они имеют в кластере. Дополнительные сведения см. [в статье Защита трафика между модулями Pod с помощью сетевых политик в AKS][network-policy].

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[network-policy]: use-network-policies.md
[azure-firewall]: ../firewall/overview.md
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-upgrade]: upgrade-cluster.md
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
