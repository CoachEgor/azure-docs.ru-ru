---
title: Ограничьте трафик в службе Azure Kubernetes (AKS)
description: Узнайте, какие порты и адреса необходимы для контроля трафика в службе Azure Kubernetes (AKS)
services: container-service
ms.topic: article
ms.date: 03/10/2020
ms.openlocfilehash: 2cd7aeea272d22615d3ba3d3db6acc2c84d22cca
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79080178"
---
# <a name="control-egress-traffic-for-cluster-nodes-in-azure-kubernetes-service-aks"></a>Контроль трафика для кластерных узлов в службе Azure Kubernetes (AKS)

По умолчанию кластеры AKS имеют неограниченный исходящий (выход) доступ в Интернет. Этот уровень сетевого доступа позволяет узлам и службам, которые вы запускаете, получить доступ к внешним ресурсам по мере необходимости. Если вы хотите ограничить трафик, ограниченное число портов и адресов должно быть доступно для поддержания работоспособного обслуживания кластеров. Кластер настроен по умолчанию только для использования изображений контейнеров базовой системы из реестра контейнеров Майкрософт (MCR) или реестра контейнеров Azure (ACR). Нанимите предпочитаемый брандмауэр и правила безопасности, чтобы эти требуемые порты и адреса.

В этой статье подробно описаны, какие сетевые порты и полностью квалифицированные доменные имена (F-DN) необходимы и необязательны, если вы ограничиваете трафик в кластере AKS.

> [!IMPORTANT]
> Этот документ охватывает только то, как заблокировать трафик, покидающий подсеть AKS. У AKS нет требований к проникновению.  Блокировка внутреннего подсетевого трафика с использованием групп сетевой безопасности (НСГ) и брандмауэров не поддерживается. Для управления и блокировки трафика в кластере используйте [сетевые политики.][network-policy]

## <a name="before-you-begin"></a>Перед началом

Вам нужна версия Azure CLI 2.0.66 или более поздняя установка и настройка. Чтобы узнать версию, выполните команду `az --version`. Если вам нужно установить или обновить, [см.][install-azure-cli]

## <a name="egress-traffic-overview"></a>Обзор исходящего трафика

Для целей управления и эксплуатации узлы в кластере АКС должны получить доступ к определенным портам и полностью квалифицированным доменным именам (ФЗН). Эти действия могут заключаться в общении с сервером API или в загрузке и установке основных компонентов кластера Kubernetes и обновлений безопасности узлов. По умолчанию, выход (исходящий) интернет-трафик не ограничен для узлов в кластере AKS. Кластер может вытащить изображения контейнеров базовой системы из внешних хранилищ.

Чтобы повысить безопасность кластера AKS, возможно, вы захотите ограничить трафик. Кластер настроен для вытягивания изображений контейнеров базовой системы из MCR или ACR. Если таким образом заблокировать трафик выхода, определите конкретные порты и F-DN, чтобы узлы AKS могли правильно общаться с необходимыми внешними службами. Без этих авторизованных портов и F-DN не узлы AKS не могут общаться с сервером API или устанавливать основные компоненты.

Вы можете использовать [Azure Firewall][azure-firewall] или прибор брандмауэра от третьей стороны для обеспечения безопасности трафика и определения необходимых портов и адресов. AKS не создает эти правила автоматически для вас. Следующие порты и адреса для справки при создании соответствующих правил в сетевом брандмауэре.

> [!IMPORTANT]
> При использовании Azure Firewall для ограничения трафика и создания пользовательского маршрута (UDR), чтобы заставить весь трафик, убедитесь, что вы создаете соответствующее правило DNAT в Брандмауэре, чтобы правильно разрешить трафик входа. Использование Брандмауэра Azure с UDR нарушает настройку входа из-за асимметричной реукторы. (Проблема возникает, если подсеть AKS имеет маршрут по умолчанию, который идет на частный IP-адрес брандмауэра, но вы используете общественный балансер нагрузки - вход или Kubernetes службы типа: LoadBalancer). В этом случае входящий трафик подсистемы балансировки нагрузки поступает через общедоступный IP-адрес, а обратный путь проходит через частный IP-адрес брандмауэра. Поскольку брандмауэр является stateful, он отбрасывает возвращающийся пакет, потому что брандмауэр не знает об установленном сеансе. Чтобы узнать, как интегрировать Брандмауэр Azure с балансом нагрузки на вход или обслуживание, [см.](https://docs.microsoft.com/azure/firewall/integrate-lb)
> Вы можете заблокировать трафик для порта TCP 9000, порта TCP 22 и порта UDP 1194, используя сетевое правило между IP-адресом для выхода рабочего узла (ы) и IP для сервера API.

В AKS есть два набора портов и адресов:

* [Необходимые порты и адрес кластеров AKS](#required-ports-and-addresses-for-aks-clusters) подробно излагают минимальные требования к разрешенному трафику.
* [Дополнительные рекомендуемые адреса и порты для кластеров AKS](#optional-recommended-addresses-and-ports-for-aks-clusters) не требуются для всех сценариев, но интеграция с другими службами, такими как Azure Monitor, не будет работать правильно. Просмотрите этот список дополнительных портов и F-DN, а также авторизируйте любые службы и компоненты, используемые в кластере AKS.

> [!NOTE]
> Ограничение трафика на вывоз работает только на новых кластерах AKS. Для существующих кластеров [выполните операцию обновления кластера][aks-upgrade] с помощью `az aks upgrade` команды, прежде чем ограничить трафик выхода.

## <a name="required-ports-and-addresses-for-aks-clusters"></a>Необходимые порты и адреса для кластеров AKS

Для кластера AKS требуются следующие правила исходящих портов/сетей:

* Порт TCP *443*
* TCP (IPAddrOfYourAPIServer):443 требуется, если у вас есть приложение, которое должно поговорить с сервером API.  Это изменение может быть установлено после создания кластера.
* TCP порт *9000*, TCP порт *22* и UDP порт *1194* для туннеля передней стручка для связи с концом туннеля на сервере API.
    * Чтобы получить более конкретную информацию,*\< см. местоположение\>.azmk8s.io* и *.tun.\< местоположение\>.azmk8s.io* адреса в следующей таблице.
* UdP port *123* для синхронизации времени сетевого времени (NTP) (узлы Linux).
* UdP port *53* для DNS также требуется, если у вас есть стручки, непосредственно доступные серверу API.

Требуются следующие правила применения ФЗДН/приложения:

> [!IMPORTANT]
> ***.blob.core.windows.net и aksrepos.azurecr.io** больше не требуются правила F-DN для блокировки выхода.  Для существующих кластеров [выполните операцию обновления кластеров][aks-upgrade] с помощью `az aks upgrade` команды для удаления этих правил.

> [!IMPORTANT]
> На смену cdn.mscr.io был заменен data.mcr.microsoft.com для областей общедоступных облаков Azure. Пожалуйста, обновите существующие правила брандмауэра, чтобы изменения вступили в силу.

- Azure (глобальный)

| Полное доменное имя.                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| К.Хкп. \<расположение\>.azmk8s.io | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для связи сервера Node <-> API. Замените * \<местоположение\> * областью, в которой развернут кластер AKS. |
| Кв. \<расположение\>.azmk8s.io | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для связи сервера Node <-> API. Замените * \<местоположение\> * областью, в которой развернут кластер AKS. |
| В.cdn.mscr.io       | HTTPS:443 | Этот адрес необходим для хранения MCR, поддерживаемого сетью доставки контента Azure (CDN). |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к изображениям в реестре контейнеров Майкрософт (MCR). Этот реестр содержит изображения/диаграммы от первого участника (например, moby и т.д.), необходимые для функционирования кластера во время обновления и масштабирования кластера |
| В.data.mcr.microsoft.com             | HTTPS:443 | Этот адрес необходим для хранения MCR, поддерживаемого сетью доставки контента Azure (CDN). |
| management.azure.com       | HTTPS:443 | Этот адрес необходим для операций Kubernetes GET/PUT. |
| login.microsoftonline.com  | HTTPS:443 | Этот адрес необходим для проверки подлинности active Directory Azure. |
| ntp.ubuntu.com             | UDP:123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес — репозиторий пакетов Майкрософт, используемый для *операций кэшированных apt-get.*  Пример пакетов включают Moby, PowerShell и Azure CLI. |
| acs-mirror.azureedge.net      | HTTPS:443 | Этот адрес предназначен для репозитория, необходимого для установки необходимых биений, таких как kubenet и Azure CNI. |

- Azure China 21Vianet

| Полное доменное имя.                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| К.Хкп. \<расположение\>.cx.prod.service.azk8s.cn | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для связи сервера Node <-> API. Замените * \<местоположение\> * областью, в которой развернут кластер AKS. |
| Кв. \<расположение\>.cx.prod.service.azk8s.cn | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для связи сервера Node <-> API. Замените * \<местоположение\> * областью, в которой развернут кластер AKS. |
| В.azk8s.cn        | HTTPS:443 | Этот адрес необходим для загрузки необходимых бинарных файлов и изображений|
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к изображениям в реестре контейнеров Майкрософт (MCR). Этот реестр содержит изображения/диаграммы от первого участника (например, moby и т.д.), необходимые для функционирования кластера во время обновления и масштабирования кластера |
| В.cdn.mscr.io       | HTTPS:443 | Этот адрес необходим для хранения MCR, поддерживаемого сетью доставки контента Azure (CDN). |
| В.data.mcr.microsoft.com             | HTTPS:443 | Этот адрес необходим для хранения MCR, поддерживаемого сетью доставки контента Azure (CDN). |
| management.chinacloudapi.cn       | HTTPS:443 | Этот адрес необходим для операций Kubernetes GET/PUT. |
| login.chinacloudapi.cn  | HTTPS:443 | Этот адрес необходим для проверки подлинности active Directory Azure. |
| ntp.ubuntu.com             | UDP:123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес — репозиторий пакетов Майкрософт, используемый для *операций кэшированных apt-get.*  Пример пакетов включают Moby, PowerShell и Azure CLI. |

- Azure для государственных организаций

| Полное доменное имя.                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| К.Хкп. \<расположение\>.cx.aks.containerservice.azure.us | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для связи сервера Node <-> API. Замените * \<местоположение\> * областью, в которой развернут кластер AKS. |
| Кв. \<расположение\>.cx.aks.containerservice.azure.us | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для связи сервера Node <-> API. Замените * \<местоположение\> * областью, в которой развернут кластер AKS. |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к изображениям в реестре контейнеров Майкрософт (MCR). Этот реестр содержит изображения/диаграммы от первого участника (например, moby и т.д.), необходимые для функционирования кластера во время обновления и масштабирования кластера |
|В.cdn.mscr.io              | HTTPS:443 | Этот адрес необходим для хранения MCR, поддерживаемого сетью доставки контента Azure (CDN). |
| В.data.mcr.microsoft.com             | HTTPS:443 | Этот адрес необходим для хранения MCR, поддерживаемого сетью доставки контента Azure (CDN). |
| management.usgovcloudapi.net       | HTTPS:443 | Этот адрес необходим для операций Kubernetes GET/PUT. |
| login.microsoftonline.us  | HTTPS:443 | Этот адрес необходим для проверки подлинности active Directory Azure. |
| ntp.ubuntu.com             | UDP:123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес — репозиторий пакетов Майкрософт, используемый для *операций кэшированных apt-get.*  Пример пакетов включают Moby, PowerShell и Azure CLI. |
| acs-mirror.azureedge.net      | HTTPS:443 | Этот адрес предназначен для репозитория, необходимого для установки необходимых биений, таких как kubenet и Azure CNI. |

## <a name="optional-recommended-addresses-and-ports-for-aks-clusters"></a>Дополнительные рекомендуемые адреса и порты для кластеров AKS

Следующие правила исходящих портов/сетей не являются обязательными для кластера AKS:

Следующие правила применения ФЗДН рекомендуются для правильного функционирования кластеров AKS:

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| security.ubuntu.com, azure.archive.ubuntu.com, changelogs.ubuntu.com | HTTP:80   | Этот адрес позволяет кластерным узлам Linux загружать необходимые патчи и обновления безопасности. |

## <a name="required-addresses-and-ports-for-gpu-enabled-aks-clusters"></a>Требуемые адреса и порты для gPU включены кластеры AKS

Для кластеров AKS с включенным графическим процессором требуются следующие правила F-DN/application:

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| nvidia.github.io | HTTPS:443 | Этот адрес используется для правильной установки драйвера и работы на узлах на основе графического процессора. |
| us.download.nvidia.com | HTTPS:443 | Этот адрес используется для правильной установки драйвера и работы на узлах на основе графического процессора. |
| apt.dockerproject.org | HTTPS:443 | Этот адрес используется для правильной установки драйвера и работы на узлах на основе графического процессора. |

## <a name="required-addresses-and-ports-with-azure-monitor-for-containers-enabled"></a>Необходимые адреса и порты с включенным Azure Monitor для контейнеров

Для кластеров AKS, в которых включен Azure Monitor для контейнеров, требуются следующие правила применения:

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| dc.services.visualstudio.com | HTTPS:443    | Это для правильного метрик и мониторинга телеметрии с помощью Azure Monitor. |
| *.ods.opinsights.azure.com    | HTTPS:443    | Это используется Azure Monitor для получения данных аналитики журналов. |
| *.oms.opinsights.azure.com | HTTPS:443 | Этот адрес используется omsagent, который используется для проверки подлинности службы анализа журналов. |
|*.microsoftonline.com | HTTPS:443 | Это используется для проверки подлинности и отправки метрик в Azure Monitor. |
|В.monitoring.azure.com | HTTPS:443 | Это используется для отправки данных метрик в Azure Monitor. |

## <a name="required-addresses-and-ports-with-azure-dev-spaces-enabled"></a>Необходимые адреса и порты с включенными пространствами Azure Dev

Для кластеров AKS, в которых включены пространства Azure Dev Spaces, требуются следующие правила f-DN/application:

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| cloudflare.docker.com | HTTPS:443 | Этот адрес используется для получения linux альпийских и других azure Dev Пространства изображения |
| gcr.io | HTTP:443 | Этот адрес используется для получения изображений руля/тилера |
| storage.googleapis.com | HTTP:443 | Этот адрес используется для получения изображений руля/тилера |
| azds-гид\<\>. \<расположение\>.azds.io | HTTPS:443 | Для связи с бэкэнд-сервисами Azure Dev Spaces для вашего контроллера. Точный ФЗДН можно найти в "dataplaneFqdn" в\.%USERPROFILE% azds'settings.json |

## <a name="required-addresses-and-ports-for-aks-clusters-with-azure-policy-in-public-preview-enabled"></a>Требуемые адреса и порты для кластеров AKS с включенной политикой Azure (в общедоступном предварительном просмотре)

> [!CAUTION]
> Некоторые из приведенных ниже функций приведены в предварительном просмотре.  Предложения в этой статье могут быть изменены по мере того, как функция переходит к общедоступному предварительному просмотру и будущим этапам выпуска.

Для кластеров AKS, в которых включена политика Azure, требуются следующие правила применения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| gov-prod-policy-data.trafficmanager.net | HTTPS:443 | Этот адрес используется для правильной работы политики Azure. (в настоящее время в предварительном просмотре в AKS) |
| raw.githubusercontent.com | HTTPS:443 | Этот адрес используется для вытягивания встроенных политик из GitHub для обеспечения правильной работы политики Azure. (в настоящее время в предварительном просмотре в AKS) |
| К.Гк. \<расположение\>.azmk8s.io | HTTPS:443    | Надстройка политики Azure, которая говорит с конечным пунктом аудита Gatekeeper, запущенным на главном сервере, чтобы получить результаты аудита. |
| dc.services.visualstudio.com | HTTPS:443 | Надстройка политики Azure, которая отправляет данные телеметрии в конечную точку приложений. |

## <a name="required-by-windows-server-based-nodes-in-public-preview-enabled"></a>Требуется узлами на основе Windows Server (в общедоступном предварительном просмотре)

> [!CAUTION]
> Некоторые из приведенных ниже функций приведены в предварительном просмотре.  Предложения в этой статье могут быть изменены по мере того, как функция переходит к общедоступному предварительному просмотру и будущим этапам выпуска.

Для кластеров AKS на базе AKS на базе Windows Server требуются следующие правила F-DN/приложения:

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| onegetcdn.azureedge.net, winlayers.blob.core.windows.net, winlayers.cdn.mscr.io, go.microsoft.com | HTTPS:443 | Установка файловых файлов, связанных с окнами |
| mp.microsoft.com,<span></span>www.msftconnecttest.com, ctldl.windowsupdate.com | HTTP:80 | Установка файловых файлов, связанных с окнами |
| kms.core.windows.net | TCP:1688 | Установка файловых файлов, связанных с окнами |


## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, какие порты и адреса разрешить, если ограничить трафик для кластера. Вы также можете определить, как стручки сами могут общаться и какие ограничения они имеют в кластере. Для получения дополнительной информации [см. Безопасный трафик между стручками с использованием сетевых политик в AKS.][network-policy]

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[network-policy]: use-network-policies.md
[azure-firewall]: ../firewall/overview.md
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-upgrade]: upgrade-cluster.md
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
