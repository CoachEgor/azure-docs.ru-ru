---
title: Ограничить трафик исходящего трафика в службе Kubernetes Azure (AKS)
description: Сведения о том, какие порты и адреса требуются для управления исходящим трафиком в службе Kubernetes Azure (AKS)
services: container-service
author: mlearned
ms.service: container-service
ms.topic: article
ms.date: 06/06/2019
ms.author: mlearned
ms.openlocfilehash: cf9dc304efea8874d16953f74bf88a4317760819
ms.sourcegitcommit: 18061d0ea18ce2c2ac10652685323c6728fe8d5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/15/2019
ms.locfileid: "69031834"
---
# <a name="preview---limit-egress-traffic-for-cluster-nodes-and-control-access-to-required-ports-and-services-in-azure-kubernetes-service-aks"></a>Предварительный просмотр — ограничить трафик исходящего трафика для узлов кластера и управлять доступом к необходимым портам и службам в службе Kubernetes Azure (AKS)

По умолчанию кластеры AKS имеют неограниченный исходящий доступ к Интернету. Этот уровень доступа к сети позволяет узлам и службам, которые выполняются при необходимости, обращаться к внешним ресурсам. Если вы хотите ограничить трафик исходящего трафика, ограниченное число портов и адресов должно быть доступно для поддержания работоспособных задач обслуживания кластера. После этого кластер настраивается на использование только базовых образов системных контейнеров из реестра контейнеров (мкр) или реестра контейнеров Azure (записи контроля доступа), а не внешних общедоступных репозиториев. Необходимо настроить предпочитаемый брандмауэр и правила безопасности, чтобы разрешить эти порты и адреса.

В этой статье описывается, какие сетевые порты и полные доменные имена (FQDN) являются обязательными, а также необязательно, если трафик исходящего трафика в кластере AKS ограничивается.  Эта функция в настоящее время находится на стадии предварительной версии.

> [!IMPORTANT]
> Функции предварительной версии AKS — это самостоятельная служба. Предварительные версии предоставляются "как есть" и "как есть" и исключаются из соглашений об уровне обслуживания и ограниченной гарантии. Предварительные версии AKS частично покрываются службой поддержки клиентов на основе лучших усилий. Таким образом, эти функции не предназначены для использования в рабочей среде. Дополнительные сведения об отсутствии см. в следующих статьях поддержки:
>
> * [Политики поддержки AKS][aks-support-policies]
> * [Часто задаваемые вопросы о поддержке Azure][aks-faq]

## <a name="before-you-begin"></a>Перед началом работы

Требуется Azure CLI версии 2.0.66 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][install-azure-cli].

Чтобы создать кластер AKS, который может ограничить трафик исходящего трафика, сначала включите в подписке флаг функции. Эта регистрация компонента настраивает все кластеры AKS, созданные для использования базовых образов системных контейнеров, из мкр или записи контроля доступа. Чтобы зарегистрировать флаг функции *акслоккингдовнегресспревиев* , используйте команду [AZ Feature Register][az-feature-register] , как показано в следующем примере:

> [!CAUTION]
> Регистрация компонента в подписке в данный момент невозможна. После включения функций предварительной версии можно использовать значения по умолчанию для всех кластеров AKS, созданных в подписке. Не включайте предварительные версии функций в производственных подписках. Используйте отдельную подписку для тестирования функций предварительной версии и сбора отзывов.

```azurecli-interactive
az feature register --name AKSLockingDownEgressPreview --namespace Microsoft.ContainerService
```

Через несколько минут отобразится состояние *Registered* (Зарегистрировано). Проверить состояние регистрации можно с помощью команды [AZ Feature List][az-feature-list] .

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/AKSLockingDownEgressPreview')].{Name:name,State:properties.state}"
```

Когда все будет готово, обновите регистрацию поставщика ресурсов *Microsoft. ContainerService* с помощью команды [AZ Provider Register][az-provider-register] :

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

## <a name="egress-traffic-overview"></a>Обзор исходящего трафика

Для целей управления и эксплуатации узлы в кластере AKS должны иметь доступ к определенным портам и полным доменным именам (FQDN). Эти действия могут быть взаимодействующими с сервером API или загружать, а затем устанавливать компоненты кластера Core Kubernetes и обновления безопасности узла. По умолчанию исходящий трафик Интернета не ограничен для узлов в кластере AKS. Кластер может извлекать базовые образы системных контейнеров из внешних репозиториев.

Для повышения безопасности кластера AKS может потребоваться ограничить трафик исходящего трафика. Кластер настроен на извлечение базовых образов системных контейнеров из мкр или записи контроля доступа. Если трафик исходящего трафика блокируется таким образом, необходимо определить определенные порты и полные доменные имена, чтобы узлы AKS могли правильно взаимодействовать с необходимыми внешними службами. Без этих полномочных портов и полных доменных имен узлы AKS не смогут взаимодействовать с сервером API или устанавливать основные компоненты.

Вы можете использовать [брандмауэр Azure][azure-firewall] или стороннее устройство брандмауэра для защиты исходящего трафика и определить необходимые порты и адреса. AKS не создает эти правила автоматически. Следующие порты и адреса предназначены для справки при создании соответствующих правил в сетевом брандмауэре.

В AKS есть два набора портов и адресов:

* [Необходимые порты и адрес для кластеров AKS](#required-ports-and-addresses-for-aks-clusters) сведения о минимальных требованиях к зарегистрированному исходящего трафика.
* Необязательные [Рекомендуемые адреса и порты для кластеров AKS](#optional-recommended-addresses-and-ports-for-aks-clusters) не требуются для всех сценариев, но интеграция с другими службами, такими как Azure Monitor, будет работать неправильно. Ознакомьтесь со списком дополнительных портов и полных доменных имен и Авторизуйте любые службы и компоненты, используемые в кластере AKS.

> [!NOTE]
> Ограничение исходящего трафика работает только для новых кластеров AKS, созданных после включения регистрации флага функции. Для существующих кластеров [выполните операцию обновления кластера][aks-upgrade] с помощью команды `az aks upgrade` , прежде чем ограничить трафик исходящего трафика.

## <a name="required-ports-and-addresses-for-aks-clusters"></a>Необходимые порты и адреса для кластеров AKS

Для кластера AKS требуются следующие исходящие порты и правила сети.

* TCP-порт *443*
* TCP-порт *9000* и TCP-порт *22* для внешнего модуля туннелирования для взаимодействия с конечным сервером на сервере API.
    * Чтобы получить более конкретные сведения, см. раздел * *.\< HCP. Location\>. azmk8s.IO* и * *. Тун.\< адреса\>Location. azmk8s.IO* в следующей таблице.

Необходимо следующее полное доменное имя или правила приложения:

| Полное доменное имя                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| *. HCP. \<Location\>. azmk8s.IO | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. *Замените\<расположение\>* на регион, в котором развернут кластер AKS. |
| *. Тун. \<Location\>. azmk8s.IO | HTTPS:443, TCP:22, TCP:9000 | Этот адрес является конечной точкой сервера API. *Замените\<расположение\>* на регион, в котором развернут кластер AKS. |
| aksrepos.azurecr.io        | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Azure (запись контроля доступа). |
| *.blob.core.windows.net    | HTTPS:443 | Этот адрес является хранилищем серверной части для образов, хранящихся в записи контроля доступа. |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Microsoft (мкр). |
| *.cdn.mscr.io              | HTTPS:443 | Этот адрес необходим для хранилища мкр, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.azure.com       | HTTPS:443 | Этот адрес необходим для операций получения/размещения Kubernetes. |
| login.microsoftonline.com  | HTTPS:443 | Этот адрес необходим для Azure Active Directory проверки подлинности. |
| api.snapcraft.io           | HTTPS: 443, HTTP: 80 | Этот адрес необходим для установки пакетов привязки на узлах Linux. |
| ntp.ubuntu.com             | UDP: 123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| *. docker.io                | HTTPS:443 | Этот адрес необходим для извлечения требуемых образов контейнеров для передней части туннеля. |

## <a name="optional-recommended-addresses-and-ports-for-aks-clusters"></a>Необязательные Рекомендуемые адреса и порты для кластеров AKS

* UDP-порт *53* для DNS

Для правильной работы кластеров AKS рекомендуется следующее полное доменное имя/правила приложения:

| Полное доменное имя                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| *. ubuntu.com                            | HTTP: 80   | Этот адрес позволяет узлам кластера Linux скачивать необходимые исправления и обновления для системы безопасности. |
| packages.microsoft.com                  | HTTPS:443 | Этот адрес является репозиторием пакетов Майкрософт, используемым для кэшированных операций *apt-get* . |
| dc.services.visualstudio.com            | HTTPS:443 | Рекомендуется для правильных метрик и мониторинга с помощью Azure Monitor. |
| *. opinsights.azure.com                  | HTTPS:443 | Рекомендуется для правильных метрик и мониторинга с помощью Azure Monitor. |
| *. monitoring.azure.com                  | HTTPS:443 | Рекомендуется для правильных метрик и мониторинга с помощью Azure Monitor. |
| gov-prod-policy-data.trafficmanager.net | HTTPS:443 | Этот адрес используется для правильной работы политики Azure (в настоящее время доступна в предварительной версии в AKS). |
| apt.dockerproject.org                   | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |
| nvidia.github.io                        | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |

## <a name="next-steps"></a>Следующие шаги

В этой статье вы узнали, какие порты и адреса следует разрешить при ограничении исходящего трафика для кластера. Вы также можете определить, как сами модули Pod могут взаимодействовать и какие ограничения они имеют в кластере. Дополнительные сведения см. [в статье Защита трафика между модулями Pod с помощью сетевых политик в AKS][network-policy].

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[network-policy]: use-network-policies.md
[azure-firewall]: ../firewall/overview.md
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-upgrade]: upgrade-cluster.md
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
