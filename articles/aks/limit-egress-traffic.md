---
title: Ограничения для исходящего трафика в Службе Azure Kubernetes (AKS)
description: Сведения о том, какие порты и адреса используются для управления исходящим трафиком в службе Azure Kubernetes (AKS)
services: container-service
ms.topic: article
ms.date: 03/10/2020
ms.openlocfilehash: 194e799daf107220c28404001d223e521dceeb3f
ms.sourcegitcommit: 64fc70f6c145e14d605db0c2a0f407b72401f5eb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2020
ms.locfileid: "83870908"
---
# <a name="control-egress-traffic-for-cluster-nodes-in-azure-kubernetes-service-aks"></a>Управление исходящим трафиком для узлов кластера в службе Azure Kubernetes (AKS)

По умолчанию кластеры AKS имеют неограниченный исходящий доступ к Интернету. Такой уровень сетевого доступа позволяет работающим узлам и службам обращаться к внешним ресурсам по мере необходимости. Если вы хотите ограничить исходящий трафик, нужно сохранить доступ для ограниченного числа портов и адресов, чтобы обеспечить работоспособность для задач обслуживания кластера. По умолчанию кластер использует для базовой системы только образы контейнеров из Реестра контейнеров Майкрософт (MCR) или Реестра контейнеров Azure (ACR). Настройте разрешения для этих портов и адресов в правилах выбранного брандмауэра и в правилах безопасности.

В этой статье перечисляются сетевые порты и полные доменные имена, которые являются обязательными и необязательными для кластера AKS, если вы решите ограничить исходящий трафик.

> [!IMPORTANT]
> В этом документе рассматривается только блокировка трафика, выходящего из подсети AKS. Служба контейнеров Azure не имеет никаких требований к входящему трафику.  Блокировка трафика внутри подсети с помощью групп безопасности сети и брандмауэров не поддерживается. Для управления трафиком и его блокировки внутри кластера используйте [политики сети][network-policy].

## <a name="before-you-begin"></a>Перед началом

Необходимо установить и настроить Azure CLI версии 2.0.66 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][install-azure-cli].

## <a name="egress-traffic-overview"></a>Обзор исходящего трафика

Для управления и эксплуатации узлам в кластере AKS нужен доступ к определенным портам и полным доменным именам (FQDN). Это может быть связано с передачей данных на сервер API или скачиванием и установкой базовых компонентов кластера Kubernetes и обновлений для системы безопасности узла. По умолчанию исходящий доступ в Интернет для узлов в кластере AKS не ограничивается. Кластер может извлекать образы контейнеров базовой системы из внешних репозиториев.

Для повышения безопасности кластера AKS вы можете ограничить исходящий трафик. В кластере настроено извлечение образов контейнеров для базовой системы из реестра MCR или ACR. Если вы выбрали такой метод блокировки исходящего трафика, определите порты и полные доменные имена, которые позволят узлам AKS правильно взаимодействовать с необходимыми внешними службами. Без доступа к этим авторизованным портам и FQDN узлы кластера AKS не смогут взаимодействовать с сервером API или устанавливать базовые компоненты.

Для защиты исходящего трафика и настройки исключений для обязательных портов и адресов вы можете использовать [Брандмауэр Azure][azure-firewall] или средства сторонних производителей. AKS не создает эти правила автоматически. Приведенный далее список портов и адресов поможет вам правильно настроить правила в брандмауэре сети.

> [!IMPORTANT]
> Если для ограничения исходящего трафика вы примените Брандмауэр Azure и создадите определяемый пользователем маршрут для передачи всего исходящего трафика, обязательно создайте в брандмауэре соответствующее правило DNAT, чтобы правильно пропускать входящий трафик. Использование Брандмауэра Azure в сочетании с определяемыми пользователем маршрутами нарушает передачу входящего трафика из-за асимметричной маршрутизации. (Проблема возникает, если подсеть AKS имеет маршрут по умолчанию для передачи данных на частный IP-адрес брандмауэра, а параллельно с ним используется общедоступная подсистема балансировки нагрузки для входящего трафика или служба Kubernetes с типом LoadBalancer.) В этом случае входящий трафик подсистемы балансировки нагрузки поступает через общедоступный IP-адрес, а обратный путь проходит через частный IP-адрес брандмауэра. Так как брандмауэр отслеживает состояние и не имеет информации об активных сеансах, он отбрасывает возвращаемые пакеты. Сведения о том, как интегрировать Брандмауэр Azure с подсистемой балансировки нагрузки для входящего трафика или служб, см. в статье [Интеграция Брандмауэра Azure с Azure Load Balancer (цен. категория "Стандартный")](https://docs.microsoft.com/azure/firewall/integrate-lb).
> Вы можете ограничить трафик для TCP-порта 9000, TCP-порта 22 и UDP-порта 1194, настроив правило сети между IP-адресом рабочего узла для исходящего трафика и IP-адресом сервера API.

Для AKS есть два набора портов и адресов.

* [Обязательные порты и адреса для кластеров AKS](#required-ports-and-addresses-for-aks-clusters) — сведения о минимально необходимых требованиях к допустимому исходящему трафику.
* [Рекомендуемые адреса и порты для кластеров AKS](#optional-recommended-addresses-and-ports-for-aks-clusters) — сведения о ресурсах, которые требуются не для всех сценариев, но обеспечивают интеграцию с другими службами, такими как Azure Monitor. Ознакомьтесь со списком необязательных портов и FQDN и разрешите только те из них, которые используются службами и компонентами вашего кластера AKS.

> [!NOTE]
> Ограничение исходящего трафика работает только для новых кластеров AKS. Для существующих кластеров [выполните операцию обновления кластера][aks-upgrade] с помощью команды `az aks upgrade`, чтобы получить возможность ограничивать исходящий трафик.

## <a name="required-ports-and-addresses-for-aks-clusters"></a>Обязательные порты и адреса для кластеров AKS

Для работы кластера AKS требуются следующие исходящие порты и правила сети.

* TCP-порт *443*
* TCP [IP-адрес сервера API]:443 требуется, если у вас есть приложение, которое должно взаимодействовать с сервером API.  Это значение можно изменить после создания кластера.
* TCP-порт *9000*, TCP-порт *22* и UDP-порт *1194* для взаимодействия pod на внешней стороне туннеля с сервером API на внутренней стороне туннеля.
    * Дополнительные сведения см. в комментариях к адресам * *.hcp.\<расположение\>.azmk8s.io* и * *.tun.\<расположение\>.azmk8s.io* в следующей таблице.
* UDP-порт *123* для синхронизации времени по протоколу NTP (узлы Linux).
* UDP-порт *53* для DNS также является обязательным, если ваши pod напрямую обращаются к серверу API.

Приведенные ниже FQDN и правила приложения являются обязательными.

> [!IMPORTANT]
> * **.blob.core.windows.net и aksrepos.azurecr.io** теперь не нужно включать в правила FQDN при блокировке исходящего трафика.  Для существующих кластеров [выполните операцию обновления кластера][aks-upgrade] с помощью команды `az aks upgrade`, чтобы можно было удалить эти правила.

> [!IMPORTANT]
> *.cdn.mscr.io был заменен на *.data.mcr.microsoft.com для всех регионов общедоступного облака Azure. Обновите существующие правила брандмауэра, чтобы эти изменения вступили в силу.

- Azure (глобальный)

| Полное доменное имя.                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| *.hcp.\<расположение\>.azmk8s.io | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для обмена данными между узлом и сервером API. Замените заполнитель *\<расположение\>* значением для региона, в котором развернут кластер AKS. |
| *.tun.\<расположение\>.azmk8s.io | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для обмена данными между узлом и сервером API. Замените заполнитель *\<расположение\>* значением для региона, в котором развернут кластер AKS. |
| *.cdn.mscr.io       | HTTPS:443 | Этот адрес необходим для хранилища MCR, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Майкрософт (MCR). В этом реестре содержатся основные образы и диаграммы (например, moby), необходимые для функционирования кластера в периоды обновления и масштабирования кластера. |
| *.data.mcr.microsoft.com             | HTTPS:443 | Этот адрес необходим для хранилища MCR, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.azure.com       | HTTPS:443 | Этот адрес необходим для операций Kubernetes GET и PUT. |
| login.microsoftonline.com  | HTTPS:443 | Этот адрес необходим для проверки подлинности Azure Active Directory. |
| ntp.ubuntu.com             | UDP:123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес содержит репозиторий пакетов Майкрософт, которые используются для кэширования операций *apt-get*.  Например, здесь хранятся пакеты для Moby, PowerShell и Azure CLI. |
| acs-mirror.azureedge.net      | HTTPS:443 | Это адрес для репозитория, необходимого для установки обязательных двоичных файлов, таких как kubenet и Azure CNI. |

- Azure China 21Vianet

| Полное доменное имя.                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| *.hcp.\<расположение\>.cx.prod.service.azk8s.cn | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для обмена данными между узлом и сервером API. Замените заполнитель *\<расположение\>* значением для региона, в котором развернут кластер AKS. |
| *.tun.\<расположение\>.cx.prod.service.azk8s.cn | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для обмена данными между узлом и сервером API. Замените заполнитель *\<расположение\>* значением для региона, в котором развернут кластер AKS. |
| *.azk8s.cn        | HTTPS:443 | Этот адрес требуется для скачивания необходимых двоичных файлов и образов.|
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Майкрософт (MCR). В этом реестре содержатся основные образы и диаграммы (например, moby), необходимые для функционирования кластера в периоды обновления и масштабирования кластера. |
| *.cdn.mscr.io       | HTTPS:443 | Этот адрес необходим для хранилища MCR, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| *.data.mcr.microsoft.com             | HTTPS:443 | Этот адрес необходим для хранилища MCR, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.chinacloudapi.cn       | HTTPS:443 | Этот адрес необходим для операций Kubernetes GET и PUT. |
| login.chinacloudapi.cn  | HTTPS:443 | Этот адрес необходим для проверки подлинности Azure Active Directory. |
| ntp.ubuntu.com             | UDP:123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес содержит репозиторий пакетов Майкрософт, которые используются для кэширования операций *apt-get*.  Например, здесь хранятся пакеты для Moby, PowerShell и Azure CLI. |

- Azure для государственных организаций

| Полное доменное имя.                       | Порт      | Использование      |
|----------------------------|-----------|----------|
| *.hcp.\<расположение\>.cx.aks.containerservice.azure.us | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для обмена данными между узлом и сервером API. Замените заполнитель *\<расположение\>* значением для региона, в котором развернут кластер AKS. |
| *.tun.\<расположение\>.cx.aks.containerservice.azure.us | HTTPS:443, TCP:22, TCP:9000, UDP:1194 | Этот адрес необходим для обмена данными между узлом и сервером API. Замените заполнитель *\<расположение\>* значением для региона, в котором развернут кластер AKS. |
| mcr.microsoft.com          | HTTPS:443 | Этот адрес необходим для доступа к образам в реестре контейнеров Майкрософт (MCR). В этом реестре содержатся основные образы и диаграммы (например, moby), необходимые для функционирования кластера в периоды обновления и масштабирования кластера. |
|*.cdn.mscr.io              | HTTPS:443 | Этот адрес необходим для хранилища MCR, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| *.data.mcr.microsoft.com             | HTTPS:443 | Этот адрес необходим для хранилища MCR, поддерживаемого сетью доставки содержимого (CDN) Azure. |
| management.usgovcloudapi.net       | HTTPS:443 | Этот адрес необходим для операций Kubernetes GET и PUT. |
| login.microsoftonline.us  | HTTPS:443 | Этот адрес необходим для проверки подлинности Azure Active Directory. |
| ntp.ubuntu.com             | UDP:123   | Этот адрес необходим для синхронизации времени NTP на узлах Linux. |
| packages.microsoft.com     | HTTPS:443 | Этот адрес содержит репозиторий пакетов Майкрософт, которые используются для кэширования операций *apt-get*.  Например, здесь хранятся пакеты для Moby, PowerShell и Azure CLI. |
| acs-mirror.azureedge.net      | HTTPS:443 | Это адрес для репозитория, необходимого для установки обязательных двоичных файлов, таких как kubenet и Azure CNI. |

## <a name="optional-recommended-addresses-and-ports-for-aks-clusters"></a>Рекомендуемые (необязательные) адреса и порты для кластеров AKS

Для работы кластера AKS рекомендуются следующие исходящие порты и правила сети.

Для правильной работы кластеров AKS рекомендуется использовать следующие FQDN и правила приложения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| security.ubuntu.com, azure.archive.ubuntu.com, changelogs.ubuntu.com | HTTP:80   | Этот адрес позволяет узлам кластера Linux скачивать необходимые исправления и обновления для системы безопасности. |

## <a name="required-addresses-and-ports-for-gpu-enabled-aks-clusters"></a>Необходимые адреса и порты для кластеров AKS с поддержкой GPU

Для работы кластеров AKS с поддержкой GPU требуются следующие FQDN и правила приложения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| nvidia.github.io | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |
| us.download.nvidia.com | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |
| apt.dockerproject.org | HTTPS:443 | Этот адрес используется для правильной установки и работы драйвера на узлах на основе GPU. |

## <a name="required-addresses-and-ports-with-azure-monitor-for-containers-enabled"></a>Обязательные адреса и порты с поддержкой Azure Monitor для контейнеров

Для работы кластеров AKS с поддержкой Azure Monitor для контейнеров требуются следующие FQDN и правила приложения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| dc.services.visualstudio.com | HTTPS:443    | Используется для правильного получения метрик и мониторинга телеметрии при использовании Azure Monitor. |
| *.ods.opinsights.azure.com    | HTTPS:443    | Используется в Azure Monitor для приема данных Log Analytics. |
| *.oms.opinsights.azure.com | HTTPS:443 | Этот адрес используется агентом omsagent, который нужен для проверки подлинности службы Log Analytics. |
|*.microsoftonline.com | HTTPS:443 | Используется для проверки подлинности и отправки метрик в Azure Monitor. |
|*.monitoring.azure.com | HTTPS:443 | Используется для отправки данных метрик в Azure Monitor. |

## <a name="required-addresses-and-ports-with-azure-dev-spaces-enabled"></a>Обязательные адреса и порты с поддержкой Azure Dev Spaces

Для работы кластеров AKS с поддержкой Azure Dev Spaces требуются следующие FQDN и правила приложения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| cloudflare.docker.com | HTTPS:443 | Этот адрес используется для извлечения образов Linux Alpine и других образов Azure Dev Spaces. |
| gcr.io | HTTPS:443 | Этот адрес используется для извлечения образов Helm и Tiller. |
| storage.googleapis.com | HTTPS:443 | Этот адрес используется для извлечения образов Helm и Tiller. |
| azds-\<guid\>.\<расположение\>.azds.io | HTTPS:443 | Для взаимодействия с внутренними службами Azure Dev Spaces для контроллера. Точное имя FQDN указано в параметре dataplaneFqdn в файле %USERPROFILE%\.azds\settings.json |

## <a name="required-addresses-and-ports-for-aks-clusters-with-azure-policy-in-public-preview-enabled"></a>Обязательные адреса и порты для кластеров AKS с поддержкой службы "Политика Azure" (в общедоступной предварительной версии)

> [!CAUTION]
> Некоторые из приведенных ниже функций предоставляются в предварительной версии.  Рекомендации в этой статье могут быть изменены по мере выпуска функций и перехода в режим общедоступной предварительной версии.

Для работы кластеров AKS с поддержкой службы "Политика Azure" требуются следующие FQDN и правила приложения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| gov-prod-policy-data.trafficmanager.net | HTTPS:443 | Этот адрес используется для правильной работы службы "Политика Azure" (сейчас предоставляется в AKS в предварительной версии). |
| raw.githubusercontent.com | HTTPS:443 | Этот адрес используется для извлечения встроенных политик из GitHub, чтобы обеспечить правильную работу службы "Политика Azure" (сейчас предоставляется в AKS в предварительной версии). |
| *.gk.\<расположение\>.azmk8s.io | HTTPS:443    | Надстройка службы "Политика Azure", которая обращается для получения результатов аудита к конечной точке аудита Gatekeeper, работающей на главном сервере. |
| dc.services.visualstudio.com | HTTPS:443 | Надстройка службы "Политика Azure", которая отправляет данные телеметрии в конечную точку Application Insights. |

## <a name="required-by-windows-server-based-nodes-enabled"></a>Требуется для поддержки узлов на базе Windows Server

Для работы кластеров AKS с пулами узлов на основе Windows Server требуются следующие FQDN и правила приложения.

| Полное доменное имя.                                    | Порт      | Использование      |
|-----------------------------------------|-----------|----------|
| onegetcdn.azureedge.net, winlayers.blob.core.windows.net, winlayers.cdn.mscr.io, go.microsoft.com | HTTPS:443 | Для установки двоичных файлов, связанных с Windows. |
| mp.microsoft.com, www<span></span>.msftconnecttest.com, ctldl.windowsupdate.com | HTTP:80 | Для установки двоичных файлов, связанных с Windows. |
| kms.core.windows.net | TCP:1688 | Для установки двоичных файлов, связанных с Windows. |

## <a name="next-steps"></a>Дальнейшие действия

Из этой статьи вы узнали, какие порты и адреса нужно разрешить при ограничении исходящего трафика для кластера. Вы также можете решить, какое взаимодействие разрешить между самими pod и какие ограничения применять в кластере. Дополнительные сведения см. в статье [Защита трафика между группами pod с использованием политик сети в Службе Azure Kubernetes (AKS)][network-policy].

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[network-policy]: use-network-policies.md
[azure-firewall]: ../firewall/overview.md
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[aks-upgrade]: upgrade-cluster.md
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
