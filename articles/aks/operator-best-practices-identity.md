---
title: Рекомендации для оператора— идентификация в службах Azure Kubernetes (AKS)
description: Ознакомьтесь с рекомендациями по управлению аутентификацией и авторизацией для кластеров в службе Azure Kubernetes (AKS) для операторов кластеров.
services: container-service
ms.topic: conceptual
ms.date: 04/24/2019
ms.openlocfilehash: 5ff5bdaced46a20dec3e7c5d7fb029f9428a12f2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77594776"
---
# <a name="best-practices-for-authentication-and-authorization-in-azure-kubernetes-service-aks"></a>Рекомендации по аутентификации и авторизации в службе Azure Kubernetes (AKS)

Если вы развертываете и обслуживаете кластеры в службе Azure Kubernetes (AKS), вам необходимо реализовать способы управления доступом к ресурсам и службам. Без этих элементов управления учетные записи могут иметь доступ к ненужным ресурсам и службам. Также может быть сложно отслеживать, какой набор учетных данных использовался для внесения изменений.

В этой статье с рекомендациями рассматривается управление доступом и идентификацией для кластеров AKS с точки зрения оператора кластера. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Аутентификация пользователей кластера AKS с помощью Azure Active Directory
> * Управление доступом к ресурсам на основе ролей (RBAC)
> * Использование управляемого удостоверения для аутентификации в других службах

## <a name="use-azure-active-directory"></a>Использование Azure Active Directory

**Рекомендация**. Разверните кластеры AKS с интеграцией Azure AD. Использование Azure AD позволяет централизовать компонент управления идентификацией. Любые изменения в статусе учетной записи пользователя или группы автоматически обновляются при доступе к кластеру AKS. Используйте роли или роли кластера и привязки, как описано в следующем разделе, чтобы предоставить пользователям или группам минимальные разрешения.

Разработчикам и владельцам приложений кластера Kubernetes нужен доступ к различным ресурсам. Kubernetes не предоставляет решение для управления взаимодействием пользователей с ресурсами. Обычно кластер интегрируется с существующим решением для идентификации. Azure Active Directory (AD) предоставляет решение для управления идентификацией корпоративного уровня и может интегрироваться с кластерами AKS.

Интегрировав кластеры AKS с Azure, вы создаете *роли* или *роли кластера*, которые определяют права доступа к ресурсам. Затем вы *привязываете* роли к пользователям или группам из Azure AD. Такое управление доступом на основе ролей Kubernetes (RBAC) рассматривается в следующем разделе. Интеграция с Azure AD и управление доступом к ресурсам показаны на следующей схеме:

![Аутентификация на уровне кластера для интеграции Azure Active Directory с AKS](media/operator-best-practices-identity/cluster-level-authentication-flow.png)

1. Разработчик выполняет аутентификацию с помощью Azure AD.
1. Конечная точка выдачи маркера Azure AD выдает маркер доступа.
1. Разработчик выполняет действие, используя маркер Azure AD, например `kubectl create pod`
1. Kubernetes проверяет маркер в Azure Active Directory и извлекает информацию о членстве разработчика в группах.
1. Применяются управление доступом на основе ролей Kubernetes (RBAC) и политики кластера.
1. Успех запроса разработчика зависит от предыдущей проверки членства в группах Azure AD, RBAC Kubernetes и политик.

Чтобы создать кластер AKS, который использует Azure AD, ознакомьтесь с разделом [Интеграция Azure Active Directory с AKS][aks-aad].

## <a name="use-role-based-access-controls-rbac"></a>Использование управления доступом на основе ролей (RBAC)

**Рекомендация**. Используйте RBAC Kubernetes для определения разрешений пользователей или групп на доступ к ресурсам в кластере. Создайте роли и привязки, которые назначают минимальные разрешения. Интегрируйте кластер с Azure AD, чтобы любое изменение статуса пользователя или участия в группах автоматически обновлялось и права на доступ к ресурсам кластера оставались актуальными.

Kubernetes позволяет контролировать доступом к ресурсам в кластере с высокой точностью. Разрешения можно определить на уровне кластера или для определенных пространств имен. Вы можете определить ресурсы, которыми можно управлять, и необходимые для этого разрешения. Затем эти роли применяются к пользователям или группам с связыванием. Дополнительную информацию о *ролях*, *ролях кластера* и *привязках* см. в разделе [Параметры доступа и идентификации для службы Azure Kubernetes (AKS)][aks-concepts-identity].

Например, вы можете создать роль, предоставляющую полный доступ к ресурсам в пространстве имен *finance-app*, как показано в следующем примере манифеста YAML:

```yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: finance-app-full-access-role
  namespace: finance-app
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
```

Затем создается RoleBinding, который связывает *разработчика\@* пользователя Azure AD1 contoso.com с RoleBinding, как показано в следующем манифесте YAML:

```yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: finance-app-full-access-role-binding
  namespace: finance-app
subjects:
- kind: User
  name: developer1@contoso.com
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: finance-app-full-access-role
  apiGroup: rbac.authorization.k8s.io
```

Когда *contoso.com\@developer1* проверяется на основе кластера AKS, они имеют полное разрешение на ресурсы в пространстве имен *финансового приложения.* Таким образом, вы логически разделяете и контролируете доступ к ресурсам. RBAC Kubernetes следует использовать вместе с интеграцией с Azure AD, как описано в предыдущем разделе.

Чтобы узнать, как использовать группы Azure AD для управления доступом к ресурсам Kubernetes с помощью RBAC, см. [Управление доступом к кластерным ресурсам с помощью элементов управления доступом на основе ролей и идентификаторами Active Directory В AKS.][azure-ad-rbac]

## <a name="use-pod-identities"></a>Использование удостоверений pod

**Рекомендация**. Не используйте фиксированные учетные данные в контейнерах pod или образах контейнеров из-за высокого риска раскрытия или применения не по назначению. Используйте удостоверения pod для автоматического запроса доступа с помощью центрального решения для идентификации Azure AD. Идентификационные данные pod предназначены только для использования с помощью стручков Linux и изображений контейнеров.

Контейнерам pod необходимы учетные данные для доступа к другим службам Azure, таким как Cosmos DB, Key Vault или хранилище BLOB-объектов. Эти учетные данные для доступа можно определить с помощью образа контейнера или внедрить в виде секрета Kubernetes, но их необходимо создать и назначить вручную. Часто учетные данные используются в разных контейнерах pod и не сменяются регулярно.

Управляемые идентификаторы ресурсов Azure (в настоящее время реализованы как связанный с проектом с открытым исходным кодом AKS) позволяют автоматически запрашивать доступ к службам через Azure AD. Вы определяете учетные данные для контейнеров pod не вручную, а запрашиваете маркер доступа в режиме реального времени и можете использовать его для доступа только к назначенным службам. Оператор кластера развертывает два компонента в AKS, чтобы контейнеры pod могли использовать управляемые идентификаторы:

* **Сервер Node Management Identity (NMI)** — это контейнеры pod, которые работают как DaemonSet на каждом узле кластера AKS. Сервер NMI ожидает передачи запросов pod к службам Azure.
* **Контроллер управляемых удостоверений (Managed Identity Controller, MIC)** — это центральные контейнеры pod с разрешениями на запрос данных на сервере API Kubernetes и проверками сопоставления удостоверений Azure, соответствующего контейнерам pod.

Когда контейнеры pod запрашивают доступ к службе Azure, сетевые правила перенаправляют трафик на сервер Node Management Identity (NMI). Сервер NMI идентифицирует контейнеры pod, которые запрашивают доступ к службам Azure, на основе их удаленного адреса и запрашивает данные в контроллере управляемых удостоверений (MIC). MIC проверяет наличие сопоставлений удостоверений Azure в кластере AKS, и после этого сервер NMI запрашивает маркер доступа в Azure Active Directory (AD) на основе сопоставления удостоверений pod. Azure AD предоставляет доступ к серверу NMI, который возвращается контейнерам pod. Контейнеры pod затем могут использовать этот маркер доступа для запроса доступа к службам в Azure.

В следующем примере разработчик создает контейнеры pod, использующие управляемое удостоверение для запроса доступа к экземпляру Azure SQL Server:

![Удостоверения Pod позволяют контейнерам pod автоматически запрашивать доступ к другим службам](media/operator-best-practices-identity/pod-identities.png)

1. Сначала оператор кластера создает учетную запись службы, которая может использоваться для сопоставления удостоверений, когда контейнеры pod запрашивают доступ к службам.
1. Сервер NMI и MIC развертываются для передачи запросов pod на получение маркеров доступа в Azure AD.
1. Разработчик развертывает контейнеры pod с управляемым удостоверением, которые запрашивают маркер доступа через сервер NMI.
1. Маркер возвращается контейнерам pod и используется для доступа к экземпляру Azure SQL Server.

> [!NOTE]
> Управляемые идентификаторы стручка — проект с открытым исходным кодом и не поддерживается технической поддержкой Azure.

Чтобы использовать удостоверения pod, назначьте [удостоверения Azure Active Directory для приложений Kubernetes][aad-pod-identity].

## <a name="next-steps"></a>Дальнейшие действия

В этой статье с рекомендациями мы рассказали об аутентификации и авторизации для кластера и ресурсов. Чтобы реализовать некоторые из этих рекомендаций, ознакомьтесь со следующими статьями:

* [Интеграция службы Azure Active Directory с AKS][aks-aad]
* [Использование управляемых удостоверений для ресурсов Azure с AKS][aad-pod-identity]

Дополнительную информацию об операциях кластера в AKS см. в рекомендациях на такие темы:

* [Мультитенантность и изоляция кластера][aks-best-practices-cluster-isolation]
* [Основные функции планировщика Kubernetes][aks-best-practices-scheduler]
* [Дополнительные функции планировщика Kubernetes][aks-best-practices-advanced-scheduler]

<!-- EXTERNAL LINKS -->
[aad-pod-identity]: https://github.com/Azure/aad-pod-identity

<!-- INTERNAL LINKS -->
[aks-concepts-identity]: concepts-identity.md
[aks-aad]: azure-ad-integration-cli.md
[managed-identities:]: ../active-directory/managed-identities-azure-resources/overview.md
[aks-best-practices-scheduler]: operator-best-practices-scheduler.md
[aks-best-practices-advanced-scheduler]: operator-best-practices-advanced-scheduler.md
[aks-best-practices-cluster-isolation]: operator-best-practices-cluster-isolation.md
[azure-ad-rbac]: azure-ad-rbac.md
