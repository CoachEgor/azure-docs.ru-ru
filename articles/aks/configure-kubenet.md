---
title: Настройка сети kubenet в Службе Azure Kubernetes (AKS)
description: Узнайте, как настроить сеть kubenet (базовую) в Службе Azure Kubernetes (AKS), чтобы развернуть кластер AKS в существующей виртуальной сети и подсети.
services: container-service
author: iainfoulds
ms.service: container-service
ms.topic: article
ms.date: 01/31/2019
ms.author: iainfou
ms.reviewer: nieberts, jomore
ms.openlocfilehash: 4d2ab19fafc265d70028d5ee192efc60a5a8eaff
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64709875"
---
# <a name="use-kubenet-networking-with-your-own-ip-address-ranges-in-azure-kubernetes-service-aks"></a>Использование сети kubenet с пользовательскими диапазонами IP-адресов в Службе Azure Kubernetes (AKS)

По умолчанию в кластерах AKS используется [kubenet][kubenet], а виртуальная сеть и подсеть Azure создаются автоматически. С помощью *kubenet* узлы получают IP-адрес из подсети виртуальной сети Azure. Объекты pod получают IP-адрес из логически отличного адресного пространства в подсеть узлов виртуальной сети Azure. Затем настраивается преобразование сетевых адресов (NAT) таким образом, чтобы объекты pod могли получить доступ к ресурсам в виртуальной сети Azure. Исходный IP-адрес трафика преобразуется в первичный IP-адрес узла. Такой подход значительно уменьшает количество IP-адресов, которые необходимо зарезервировать в пространстве сети для объектов pod.

С помощью [сетевого интерфейса контейнеров Azure (CNI)][cni-networking] каждый объект pod получает IP-адрес из подсети, и к этому объекту pod можно получить прямой доступ. Эти IP-адреса должны быть уникальными во всей сети, и их следует планировать заранее. Для каждого узла предусмотрен параметр конфигурации, в котором указывается максимальное число объектов pod, которые он поддерживает. Затем на каждом узле заранее резервируется эквивалентное число IP-адресов для этого узла. Этот подход требует дополнительного планирования и часто приводит к исчерпанию IP-адресов или необходимости повторно создавать кластеры в подсети большего размера по мере увеличения потребностей вашего приложения.

В этой статье показано, как с помощью сети *kubenet* создать и использовать подсеть виртуальной сети для кластера AKS. Дополнительные сведения о сетях см. в статье [Основные понятия сети в Службе Azure Kubernetes (AKS)][aks-network-concepts].

## <a name="before-you-begin"></a>Перед началом работы

Кроме того, вам необходимо установить и настроить службу Azure CLI версии 2.0.56 или более поздней. Чтобы узнать версию, выполните команду  `az --version`. Если вам необходимо выполнить установку или обновление, см. статью  [Установка Azure CLI][install-azure-cli].

## <a name="overview-of-kubenet-networking-with-your-own-subnet"></a>Общие сведения о сети kubenet с использованием пользовательской подсети

Во многих средах виртуальные сети и подсети уже определены и для них выделены диапазоны IP-адресов. Эти ресурсы виртуальной сети используются для поддержки нескольких служб и приложений. Чтобы установить сетевое подключение, в кластерах AKS можно использовать *kubenet* (базовую сеть) или Azure CNI (*расширенную сеть*).

При использовании *kubenet* IP-адрес в подсети виртуальной сети получают только узлы. Объекты Pod не могут взаимодействовать напрямую. Для подключения между объектами pod в узлах применяются определяемая пользователем маршрутизация (UDR) и IP-пересылка. Можно также развернуть объекты pod за службой, которая получает назначенный IP-адрес и распределяет нагрузку трафика для приложения. На приведенной ниже схеме показано, как узлы AKS (но не объекты pod) получают IP-адрес в подсети виртуальной сети:

![Модель сети kubenet с кластером AKS](media/use-kubenet/kubenet-overview.png)

Azure поддерживает не более 400 маршрутов в UDR, поэтому в кластере AKS не может быть больше 400 узлов. *Kubenet* не поддерживает такие функции AKS, как [виртуальные узлы][virtual-nodes] или политики сети.

Благодаря *Azure CNI* каждый объект pod получает IP-адрес в IP-подсети и может напрямую взаимодействовать с другими объектами pod и службами. Размер кластеров может соответствовать размеру указанного диапазона IP-адресов. Тем не менее диапазон IP-адресов следует планировать заранее. Все эти IP-адреса используются узлами AKS в зависимости от максимального числа поддерживаемых объектов pod. Дополнительные сетевые функции и сценарии, такие как [виртуальные узлы][virtual-nodes] или политики сети, поддерживаются в *Azure CNI*.

### <a name="ip-address-availability-and-exhaustion"></a>Доступность и исчерпание IP-адресов

При применении *Azure CNI* распространенной проблемой является слишком малый диапазон назначенных IP-адресов для последующего добавления дополнительных узлов при масштабировании или обновлении кластера. Кроме того, группа специалистов по работе с сетями также не сможет обеспечить достаточно большой диапазон IP-адресов в соответствии с прогнозируемыми требованиями приложения.

В этом случае можно создать кластер AKS, в котором используется *kubenet*, и подключиться к существующей подсети виртуальной сети. Такой подход позволяет узлам получать определенные IP-адреса без необходимости заранее резервировать большое количество IP-адресов для всех потенциальных объектов pod, которые могут выполняться в кластере.

Благодаря *kubenet* можно использовать гораздо меньший диапазон IP-адресов и поддерживать большие кластеры и требования приложения. Например, даже в диапазоне IP-адресов */27* можно запустить кластер с 20–25 узлами и иметь достаточно места для масштабирования или обновления. Этот размер кластера будет поддерживать до *2200–2750* объектов pod (по умолчанию максимум 110 объектов pod на каждом узле).

Приведенные ниже базовые расчеты показывают разницу между моделями сети.

- **kubenet**. Простой диапазон IP-адресов */24* может поддерживать до *251* узла в кластере (каждая подсеть виртуальной сети Azure резервирует первые три IP-адреса для операций управления).
  - Это число узлов может поддерживать до *27 610* объектов pod (по умолчанию максимум 110 объектов pod на каждом узле с *kubenet*).
- **Azure CNI**. Такой же базовый диапазон подсети */24* поддерживает только до *8* узлов в кластере.
  - Это число узлов может поддерживать только до *240* объектов pod (по умолчанию максимум 30 объектов pod на каждом узле с *Azure CNI*).

> [!NOTE]
> В этих максимальных значениях не учитываются операции обновления или масштабирования. На практике не рекомендуется запускать максимальное количество узлов, которые поддерживает диапазон IP-адресов подсети. Следует оставить несколько IP-адресов для использования во время операций масштабирования или обновления.

### <a name="virtual-network-peering-and-expressroute-connections"></a>Пиринг виртуальных сетей и подключения ExpressRoute

Для подключения к локальным ресурсам и в случае с *kubenet*, и в случае с *Azure CNI* можно использовать [пиринг виртуальных сетей Azure][vnet-peering] или [подключения ExpressRoute][express-route]. Следует тщательно планировать диапазоны IP-адресов, чтобы избежать перекрытия и неправильной маршрутизации трафика. Например, во многих локальных сетях используется диапазон *10.0.0.0/8*, который объявляется через подключение ExpressRoute. Рекомендуется создавать кластеры AKS в подсетях виртуальной сети Azure за пределами этого диапазона адресов, например *172.26.0.0/16*.

### <a name="choose-a-network-model-to-use"></a>Выбор модели сети

При выборе сетевого подключаемого модуля для кластера AKS обычно учитывается баланс гибкости и потребностей в расширенной конфигурации. Приведенные ниже рекомендации помогут понять, какая из моделей сети больше всего подходит для конкретной ситуации.

Используйте *kubenet* в следующих случаях:

- У вас ограниченное пространство IP-адресов.
- Большая часть обмена данными между объектами pod происходит в пределах кластера.
- Вам не требуются расширенные возможности, такие как виртуальные узлы или политики сети.

Используйте *Azure CNI* в следующих случаях:

- У вас есть достаточный диапазон IP-адресов.
- Объекты pod обмениваются данными в основном с ресурсами за пределами кластера.
- Вам не нужно управлять определяемыми пользователем маршрутами.
- Вам требуются расширенные возможности, такие как виртуальные узлы или политики сети.

> [!NOTE]
> Kuberouter дает возможность включить политики сети, при использовании kubenet и можно установить в качестве daemonset в кластере AKS. Имейте в виду, kube маршрутизатор является по-прежнему в бета-версии и нет поддержка предоставляется корпорацией Майкрософт для проекта.

## <a name="create-a-virtual-network-and-subnet"></a>Создание виртуальной сети и подсети

Чтобы приступить к работе с *kubenet* и собственной подсетью виртуальной сети, сначала создайте группу ресурсов с помощью команды [az group create][az-group-create]. В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *eastus*.

```azurecli-interactive
az group create --name myResourceGroup --location eastus
```

Если у вас нет существующей виртуальной сети и подсети, создайте эти сетевые ресурсы с помощью команды [az network vnet create][az-network-vnet-create]. В приведенном ниже примере создается виртуальная сеть с именем *myVnet* и префиксом адреса *10.0.0.0/8*. Также создается подсеть с именем *myAKSSubnet* и префиксом адреса *10.240.0.0/16*.

```azurecli-interactive
az network vnet create \
    --resource-group myResourceGroup \
    --name myAKSVnet \
    --address-prefixes 10.0.0.0/8 \
    --subnet-name myAKSSubnet \
    --subnet-prefix 10.240.0.0/16
```

## <a name="create-a-service-principal-and-assign-permissions"></a>Создание субъекта-службы и назначение разрешений

Для взаимодействия с API-интерфейсами Azure кластеру AKS требуется субъект-служба Azure Active Directory. Субъект-служба должен иметь разрешения на управление виртуальной сетью и подсетью, которые используются узлами AKS. Создайте субъект-службу с помощью команды [az ad sp create-for-rbac][az-ad-sp-create-for-rbac]:

```azurecli-interactive
az ad sp create-for-rbac --skip-assignment
```

В приведенном ниже примере выходных данных показан идентификатор приложения и пароль для субъекта-службы. Эти значения используются в дополнительных действиях, чтобы назначить роль субъекту-службе, а затем создать кластер AKS:

```console
$ az ad sp create-for-rbac --skip-assignment

{
  "appId": "476b3636-5eda-4c0e-9751-849e70b5cfad",
  "displayName": "azure-cli-2019-01-09-22-29-24",
  "name": "http://azure-cli-2019-01-09-22-29-24",
  "password": "a1024cd7-af7b-469f-8fd7-b293ecbb174e",
  "tenant": "72f998bf-85f1-41cf-92ab-2e7cd014db46"
}
```

Чтобы назначить правильное делегирование в оставшихся действиях, получите необходимые идентификаторы ресурсов с помощью команд [az network vnet show][az-network-vnet-show] и [az network vnet subnet show][az-network-vnet-subnet-show]. Эти идентификаторы ресурсов хранятся как переменные и указываются в оставшихся действиях:

```azurecli-interactive
VNET_ID=$(az network vnet show --resource-group myResourceGroup --name myAKSVnet --query id -o tsv)
SUBNET_ID=$(az network vnet subnet show --resource-group myResourceGroup --vnet-name myAKSVnet --name myAKSSubnet --query id -o tsv)
```

Теперь назначьте субъекту-службе кластера AKS разрешение *Участник* для виртуальной сети с помощью команды [az role assignment create][az-role-assignment-create]. Предоставить свой собственный  *\<appId >* как показано в выходных данных из предыдущей команды для создания субъекта-службы:

```azurecli-interactive
az role assignment create --assignee <appId> --scope $VNET_ID --role Contributor
```

## <a name="create-an-aks-cluster-in-the-virtual-network"></a>Создание кластера AKS в виртуальной сети

Вы создали виртуальную сеть и подсеть, а также создали и назначили разрешения для субъекта-службы, чтобы использовать эти сетевые ресурсы. Теперь создайте кластер AKS в виртуальной сети и подсети с помощью команды [az aks create][az-aks-create]. Определить собственный субъект-службу  *\<appId >* и  *\<пароль >*, как показано в выходных данных из предыдущей команды для создания субъекта-службы.

Приведенные ниже диапазоны IP-адресов также определяются в процессе создания кластера:

* *--service-cidr* используется для назначения IP-адреса внутренним службам в кластере AKS. Этот диапазон IP-адресов не должен использоваться где-либо еще в сетевой среде. Сюда входят все диапазоны в локальной сети, если вы подключаетесь или планируете подключаться к виртуальным сетям Azure с помощью Express Route или VPN-подключения типа "сеть — сеть".

* Адрес *--dns-service-ip* должен быть адресом *.10* диапазона IP-адресов вашей службы.

* Диапазон *--pod-cidr* должен быть большим адресным пространством, которое не используется где-либо еще в сетевой среде. Сюда входят все диапазоны в локальной сети, если вы подключаетесь или планируете подключаться к виртуальным сетям Azure с помощью Express Route или VPN-подключения типа "сеть — сеть".
    * Этот диапазон адресов должен быть достаточно большим, чтобы вместить количество узлов, до которых вы планируете масштабировать среду. Этот диапазон адресов нельзя изменить после развертывания кластера, если потребуются адреса для дополнительных узлов.
    * Диапазон IP-адресов объектов pod используется для назначения адресного пространства */24* каждому узлу в кластере. В приведенном ниже примере *--pod cidr* *192.168.0.0/16* назначает первому узлу *192.168.0.0/24*, второму узлу — *192.168.1.0/24* и третьему узлу — *192.168.2.0/24*.
    * При масштабировании или обновлении кластера платформа Azure продолжает назначать диапазон IP-адресов объектов pod каждому новому узлу.

```azurecli-interactive
az aks create \
    --resource-group myResourceGroup \
    --name myAKSCluster \
    --node-count 3 \
    --network-plugin kubenet \
    --service-cidr 10.0.0.0/16 \
    --dns-service-ip 10.0.0.10 \
    --pod-cidr 192.168.0.0/16 \
    --docker-bridge-address 172.17.0.1/16 \
    --vnet-subnet-id $SUBNET_ID \
    --service-principal <appId> \
    --client-secret <password>
```

При создании кластера AKS создается группа безопасности сети и таблица маршрутов. Этим сетевым ресурсам осуществляется с плоскостью управления AKS. Группа безопасности сети, автоматически связывается с виртуальными сетевыми адаптерами на узлах. Таблица маршрутов автоматически связывается с подсетью виртуальной сети. Правила группы безопасности сети и таблицы маршрутов и автоматически обновляются при создании и предоставления доступа к службам.

## <a name="next-steps"></a>Дальнейшие действия

При развертывании кластера AKS в подсети существующей виртуальной сети его можно использовать в обычном режиме. Начните [создавать приложения с помощью Azure Dev Spaces][dev-spaces] или [с помощью Draft][use-draft] либо [развертывать приложения с помощью Helm][use-helm].

<!-- LINKS - External -->
[dev-spaces]: https://docs.microsoft.com/azure/dev-spaces/
[cni-networking]: https://github.com/Azure/azure-container-networking/blob/master/docs/cni.md
[kubenet]: https://kubernetes.io/docs/concepts/cluster-administration/network-plugins/#kubenet

<!-- LINKS - Internal -->
[install-azure-cli]: /cli/azure/install-azure-cli
[aks-network-concepts]: concepts-network.md
[az-group-create]: /cli/azure/group#az-group-create
[az-network-vnet-create]: /cli/azure/network/vnet#az-network-vnet-create
[az-ad-sp-create-for-rbac]: /cli/azure/ad/sp#az-ad-sp-create-for-rbac
[az-network-vnet-show]: /cli/azure/network/vnet#az-network-vnet-show
[az-network-vnet-subnet-show]: /cli/azure/network/vnet/subnet#az-network-vnet-subnet-show
[az-role-assignment-create]: /cli/azure/role/assignment#az-role-assignment-create
[az-aks-create]: /cli/azure/aks#az-aks-create
[use-helm]: kubernetes-helm.md
[use-draft]: kubernetes-draft.md
[virtual-nodes]: virtual-nodes-cli.md
[vnet-peering]: ../virtual-network/virtual-network-peering-overview.md
[express-route]: ../expressroute/expressroute-introduction.md
