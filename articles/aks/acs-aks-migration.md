---
title: Миграция со службы контейнеров Azure (ACS) на службу Azure Kubernetes (AKS)
description: Миграция со службы контейнеров Azure (ACS) на службу Azure Kubernetes (AKS)
services: container-service
author: noelbundick
manager: jeconnoc
ms.service: container-service
ms.topic: article
ms.date: 06/13/2018
ms.author: nobun
ms.custom: mvc
ms.openlocfilehash: 910c96988ec0a8b8aa7b6ac8ce287c4fdc59e177
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60467567"
---
# <a name="migrating-from-azure-container-service-acs-to-azure-kubernetes-service-aks"></a>Миграция со службы контейнеров Azure (ACS) на службу Azure Kubernetes (AKS)

Этот документ поможет вам спланировать и выполнить успешную миграцию со службы контейнеров Azure с Kubernetes (ACS) на службу Azure Kubernetes (AKS). В этом руководстве описаны различия между службами ACS и AKS, представлен обзор процесса миграции и приведены советы по принятию ключевых решений.

## <a name="differences-between-acs-and-aks"></a>Различия между службами ACS и AKS

Службы ACS и AKS различаются в нескольких ключевых областях, которые влияют на миграцию. Ознакомьтесь с ними и учтите указанные далее различия перед тем, как приступать к миграции.

* Узлы AKS используют службу [Управляемые диски](../virtual-machines/windows/managed-disks-overview.md)
    * Перед подключением неуправляемых дисков к узлам AKS их нужно будет преобразовать
    * Настраиваемые объекты `StorageClass` для дисков Azure потребуется перевести из состояния `unmanaged` в состояние `managed`
    * Любой объект `PersistentVolumes` должен использовать `kind: Managed`
* Служба AKS в настоящее время поддерживает только один пул агентов
* В настоящее время узлы под управлением Windows Server находятся в режиме [закрытой предварительной версии](https://azure.microsoft.com/blog/kubernetes-on-azure/)
* Проверьте список [поддерживаемых регионов](https://docs.microsoft.com/azure/aks/container-service-quotas) AKS
* AKS — это управляемая служба с размещенной панелью управления Kubernetes. Может потребоваться изменить приложения, если ранее вы изменяли конфигурацию мастеров ACS

### <a name="differences-between-kubernetes-versions"></a>Различия между версиями Kubernetes

Если вы переносите в более новой версии Kubernetes (например: 1.7.x для 1.9.x), существуют некоторые изменения, чтобы k8s API, которые потребуют вашего внимания.

* [Миграция с ThirdPartyResource на CustomResourceDefinition](https://kubernetes.io/docs/tasks/access-kubernetes-api/migrate-third-party-resource/)
* [Изменения API рабочих нагрузок в версиях 1.8 и 1.9](https://kubernetes.io/docs/reference/workloads-18-19/).

## <a name="migration-considerations"></a>Рекомендации по переносу

### <a name="agent-pools"></a>Пулы агентов

Хотя служба AKS управляет панелью управления Kubernetes, вы можете определить размер и количество узлов, которые требуется включить в новый кластер. Если нужно добиться сопоставления 1:1 между службами ACS и AKS, необходимо записать данные существующего узла ACS. Эти данные будут использоваться при создании нового кластера AKS.

Пример:

| Name | Количество | Размер виртуальной машины | Операционная система |
| --- | --- | --- | --- |
| agentpool0 | 3 | Standard_D8_v2 | Linux |
| agentpool1 | 1 | Standard_D2_v2 |  Windows |

Так как дополнительные виртуальные машины будут развернуты в рамках подписки во время миграции, следует убедиться, что квоты и ограничения достаточны для этих ресурсов. Чтобы узнать больше, просмотрите [ограничения по подпискам и службам Azure](https://docs.microsoft.com/azure/azure-subscription-service-limits). Чтобы проверить текущие квоты, перейдите к [колонке подписок](https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade) на портале Azure, выберите свою подписку, а затем — `Usage + quotas`.

### <a name="networking"></a>Сеть

Миграция сложных приложений обычно выполняется в течение некоторого времени, а не одномоментно. Это означает, что для взаимодействия в рамках сети могут потребоваться старые и новые среды. Приложения, которые ранее могли использовать для связи службы `ClusterIP`, могут потребовать использования типа `LoadBalancer` и соответствующей защиты.

Чтобы завершить миграцию, нужно будет указать на новые службы, работающие в AKS. Для перенаправления трафика рекомендуется обновить DNS, указав на подсистему Load Balancer, которая размещена перед кластером AKS.

### <a name="stateless-applications"></a>Приложения без отслеживания состояния

Перенос приложений без отслеживания состояния — это самый простой случай. Нужно применить свои определения YAML к новому кластеру, убедиться, что все работает должным образом, и перенаправить трафик, чтобы сделать новый кластер активным.

### <a name="stateful-applications"></a>Приложения с отслеживанием состояния

Миграция приложений с отслеживанием состояния требует тщательного планирования, чтобы предотвратить потерю данных или незапланированный простой.

#### <a name="highly-available-applications"></a>Приложения с высокой доступностью

Некоторые приложения с отслеживанием состояния могут развертываться в конфигурации с высокой доступностью и копировать данные между репликами. Если ваше текущее развертывание подходит под это описание, можно создать новый элемент в новом кластере AKS и выполнить миграцию с минимальным влиянием на подчиненные вызывающие объекты. Для миграции по этому сценарию обычно используется следующий порядок действий.

1. Создание новой вторичной реплики в AKS
2. Ожидание репликации данных
3. Отработка отказа для превращения вторичной реплики в первичную
4. Направление трафика в кластер AKS

#### <a name="migrating-persistent-volumes"></a>Миграция постоянных томов

Существует несколько факторов, которые следует учитывать, если вы переносите существующие постоянные тома в службу AKS. Как правило, используется следующий порядок действий.

1. Заморозка записей в приложении (требуется время простоя, необязательное действие)
2. Создание теневых копий дисков
3. Создание новых управляемых дисков из теневых копий
4. Создание постоянных томов в службе AKS
5. Обновление спецификаций Pod для [использования существующих томов](https://docs.microsoft.com/azure/aks/azure-disk-volume) вместо PersistentVolumeClaims (статической подготовки)
6. Развертывание приложения в AKS
7. Проверка
8. Направление трафика в кластер AKS

> **Важно!** Если вы не захотите замораживания операций записи, нужно будет реплицировать данные в новое развертывание, как будут отсутствовать данные, которые были записаны с момента моментального снимка диска

Существуют инструменты с открытым кодом, которые помогут создать управляемые диски и перенести тома между кластерами Kubernetes.

* [noelbundick/azure-cli-disk-extension](https://github.com/noelbundick/azure-cli-disk-copy-extension): копирование и конвертация дисков между группами ресурсов и областями Azure
* [yaron2/azure-kube-cli](https://github.com/yaron2/azure-kube-cli): нумерация томов ACS Kubernetes и их перенос в кластер AKS

#### <a name="azure-files"></a>Файлы Azure

В отличие от дисков, файлы Azure можно одновременно подключить к нескольким узлам. Ни Azure, ни Kubernetes не препятствуют созданию Pod в кластере AKS, который в это же время используется кластером ACS. Чтобы предотвратить потерю данных и непредвиденные события, следует убедиться, что эти два кластера не ведут запись в одни и те же файлы одновременно.

Если в приложении может иметься несколько реплик, указывающих на один файловый ресурс, можно воспользоваться порядком действий для миграции приложений без отслеживания состояния и выполнить развертывание определений YAML в новом кластере.

В противном случае для миграции возможен следующий порядок действий.

1. Развертывание приложения в службе AKS с нулевым количеством реплик
2. Масштабирование приложения в ACS до значения 0 (приводит к простою)
3. Масштабирование приложения в AKS до значения 1
4. Проверка
5. Направление трафика в кластер AKS

Если нужно начать с пустым ресурсом, а затем создать копию исходных данных, для переноса данных можно использовать команды [`az storage file copy`](https://docs.microsoft.com/cli/azure/storage/file/copy?view=azure-cli-latest).

### <a name="deployment-strategy"></a>Стратегия развертывания

Рекомендуется использовать свой существующий конвейер CI/CD для развертывания удачной конфигурации в AKS. Следует клонировать существующие задачи развертывания и убедиться, что файл `kubeconfig` указывает на новый кластер AKS.

Если сделать это невозможно, потребуется экспортировать определения ресурса из службы ACS, а затем применить их к службе AKS. Для экспорта объектов можно использовать `kubectl`.

```console
kubectl get deployment -o=yaml --export > deployments.yaml
```

Существует также несколько инструментов с открытым кодом, которые могут оказаться полезными в зависимости от ваших потребностей.

* [heptio/ark](https://github.com/heptio/ark): требуется k8s 1.7
* [yaron2/azure-kube-cli](https://github.com/yaron2/azure-kube-cli)
* [mhausenblas/reshifter](https://github.com/mhausenblas/reshifter)

## <a name="migration-steps"></a>Этапы миграции

### <a name="1-create-an-aks-cluster"></a>1. Создание кластера AKS

Можно следовать документации, чтобы [создать кластер AKS](https://docs.microsoft.com/azure/aks/create-cluster) с помощью портала Azure, Azure CLI или шаблона Resource Manager.

> Примеры шаблонов Azure Resource Manager для AKS можно найти в репозитории [Azure/AKS](https://github.com/Azure/AKS/tree/master/examples/vnet) на сайте GitHub

### <a name="2-modify-applications"></a>2. Изменение приложений

Внесите необходимые изменения в определения YAML. Пример: замените `apps/v1beta1` на `apps/v1` для параметра `Deployments`

### <a name="3-optional-migrate-volumes"></a>3. Перенос томов (необязательно)

Перенесите тома из кластера ACS в кластер AKS. Дополнительные сведения можно найти в разделе [Миграция постоянных томов](#migrating-persistent-volumes).

### <a name="4-deploy-applications"></a>4. Развертывание приложений

Используйте систему CI/CD для развертывания приложений в службе AKS или kubectl для применения определений YAML.

### <a name="5-validate"></a>5. Проверка

Убедитесь, что приложение работает должным образом и что все участвующие в миграции данные были скопированы.

### <a name="6-redirect-traffic"></a>6. Перенаправление трафика

Обновите DNS, чтобы указать на развертывание AKS.

### <a name="7-post-migration-tasks"></a>7. Задачи после переноса данных

Если был выполнен перенос томов, но записи не замораживались, необходимо скопировать эти данные в новый кластер.
