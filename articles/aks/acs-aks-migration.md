---
title: Перенос из службы контейнеров Azure (ACS) в службе Azure Kubernetes (AKS)
description: Перенос из службы контейнеров Azure (ACS) в службе Azure Kubernetes (AKS).
services: container-service
author: noelbundick
manager: jeconnoc
ms.service: container-service
ms.topic: article
ms.date: 06/13/2018
ms.author: nobun
ms.custom: mvc
ms.openlocfilehash: dcee8da943603fb0978caf9992be76347ca197d6
ms.sourcegitcommit: 59fd8dc19fab17e846db5b9e262a25e1530e96f3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2019
ms.locfileid: "65977713"
---
# <a name="migrate-from-azure-container-service-acs-to-azure-kubernetes-service-aks"></a>Перенос из службы контейнеров Azure (ACS) в службе Azure Kubernetes (AKS)

Эта статья поможет вам спланировать и выполнить успешный переход между службы контейнеров Azure (ACS) с помощью Kubernetes и службы Azure Kubernetes (AKS). Чтобы помочь вам принимать ключевые решения, в этом руководстве описаны различия между службой ACS и AKS и обзор процесса миграции.

## <a name="differences-between-acs-and-aks"></a>Различия между службами ACS и AKS

ACS и AKS различаются несколько ключевых областей, которые влияют на миграцию. Перед выполнением любой миграции необходимо просмотреть и планируете учитывать следующие различия:

* Узлы AKS используют [управляемые диски](../virtual-machines/windows/managed-disks-overview.md).
    * Неуправляемые диски должны быть преобразованы, прежде чем их можно прикреплять к узлам AKS.
    * Custom `StorageClass` объекты для дисков Azure должны быть изменены с `unmanaged` для `managed`.
    * Любой `PersistentVolumes` следует использовать `kind: Managed`.
* Служба AKS поддерживает [несколько пулов узлов](https://docs.microsoft.com/azure/aks/use-multiple-node-pools) (в настоящее время в предварительной версии).
* Узлы, на основе Windows Server находятся в настоящее время в [предварительной версии в AKS](https://azure.microsoft.com/blog/kubernetes-on-azure/).
* Служба AKS поддерживает ограниченный набор [регионах](https://docs.microsoft.com/azure/aks/quotas-skus-regions).
* AKS — это управляемая служба с размещенной панелью управления Kubernetes. Может потребоваться изменить приложения, если ранее вы изменили конфигурацию образцы ACS.

## <a name="differences-between-kubernetes-versions"></a>Различия между версиями Kubernetes

Если вы переносите в более новой версии Kubernetes (например, с 1.7.x для 1.9.x), изучите следующие ресурсы для понимания несколько изменений в API Kubernetes:

* [Переход на CustomResourceDefinition ThirdPartyResource](https://kubernetes.io/docs/tasks/access-kubernetes-api/migrate-third-party-resource/)
* [Рабочие нагрузки API изменения в версии 1.8 к версии 1.9](https://kubernetes.io/docs/reference/workloads-18-19/)

## <a name="migration-considerations"></a>Рекомендации по переносу

### <a name="agent-pools"></a>Пулы агентов

Несмотря на то, что AKS управляет плоскость управления Kubernetes, вы по-прежнему определить размер и количество узлов для включения в новый кластер. Если нужно добиться сопоставления 1:1 между службами ACS и AKS, необходимо записать данные существующего узла ACS. Эти данные можно используйте при создании нового кластера AKS.

Пример:

| ИМЯ | Количество | Размер виртуальной машины | Операционная система |
| --- | --- | --- | --- |
| agentpool0 | 3 | Standard_D8_v2 | Linux |
| agentpool1 | 1 | Standard_D2_v2 |  Windows |

Так как дополнительные виртуальные машины будут развернуты в рамках подписки во время миграции, следует убедиться, что квоты и ограничения достаточны для этих ресурсов. 

Дополнительные сведения см. в разделе [подписки Azure и ограничения службы](https://docs.microsoft.com/azure/azure-subscription-service-limits). Чтобы проверить текущие квоты, на портале Azure перейдите к [колонке "подписки"](https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade), выберите свою подписку, а затем выберите **использование и квоты**.

### <a name="networking"></a>Сеть

Миграция сложных приложений обычно выполняется в течение некоторого времени, а не одномоментно. Это означает, что старые и новые среды может потребоваться взаимодействовать по сети. Приложения, которые ранее использовали `ClusterIP` может потребоваться взаимодействовать в качестве типа `LoadBalancer` и быть надежно защищены.

Чтобы завершить миграцию, нужно будет указать клиентам новых служб, запущенных в AKS. Мы рекомендуем, что для перенаправления трафика путем обновления DNS, чтобы в подсистему балансировки нагрузки, который размещается перед кластера AKS.

### <a name="stateless-applications"></a>Приложений без отслеживания состояния

Перенос приложений без отслеживания состояния — это самый простой случай. Будем применять свои определения YAML в новый кластер, убедитесь, что все работает правильно и перенаправление трафика для активации нового кластера.

### <a name="stateful-applications"></a>Приложения с отслеживанием состояния

Тщательно планировать миграцию с отслеживанием состояния приложений, чтобы избежать потери данных или возникает событие незапланированного простоя.

#### <a name="highly-available-applications"></a>Высокодоступные приложения

Вы можете развернуть несколько приложений с отслеживанием состояния в конфигурации высокой доступности. Эти приложения можно скопировать данные между репликами. Если вы сейчас используете такого типа развертывания, можно создать новый элемент в новом кластере AKS, а затем перенести с минимальным влиянием на подчиненным вызывающим объектам. Как правило являются пошаговом руководстве по миграции для этого сценария:

1. Создайте новую вторичную реплику в AKS.
2. Дождитесь данных для репликации.
3. Не более чем превратить вторичную реплику новую первичной.
4. Направляют трафик в кластере AKS.

#### <a name="migrating-persistent-volumes"></a>Миграция постоянные тома

Если вы переносите существующие постоянные тома в AKS, обычно будет выполните следующие действия.

1. Замораживание записывает в приложение. (Этот шаг является необязательным и приводит к простою.)
2. Создать моментальные снимки дисков.
3. Создание новых управляемых дисков из моментальных снимков.
4. Создайте постоянные тома в AKS.
5. Обновить спецификации pod для [использовать существующие тома](https://docs.microsoft.com/azure/aks/azure-disk-volume) вместо того чтобы PersistentVolumeClaims (статического предоставления).
6. Развертывание приложения в AKS.
7. Проверьте.
8. Направляют трафик в кластере AKS.

> [!IMPORTANT]
> Если вы не захотите замораживания операций записи, нужно будет реплицировать данные в новом развертывании. В противном случае вы не сможете получить данные, которые были записаны после заняло моментальные снимки дисков.

Некоторые средства с открытым исходным кодом, помогут вам создать управляемые диски и перенести тома между кластерами Kubernetes:

* [Расширение Azure CLI копирование диска](https://github.com/noelbundick/azure-cli-disk-copy-extension) копирует и преобразует диски в группах ресурсов и регионах Azure.
* [Расширение Azure Kube CLI](https://github.com/yaron2/azure-kube-cli) перечисляет томах ACS Kubernetes и переносит их в кластере AKS.

#### <a name="azure-files"></a>Файлы Azure

В отличие от дисков, файлы Azure можно одновременно подключить к нескольким узлам. В кластере AKS Azure и Kubernetes не запрещает создание группу pod, по-прежнему использует кластера ACS. Чтобы предотвратить потерю данных и непредвиденное поведение, убедитесь, что кластеры не запись в те же файлы в то же время.

Если приложение можно разместить несколько реплик, которые указывают на тот же файловый ресурс, выполните действия без отслеживания состояния миграции и развернуть свои определения YAML в новом кластере. В противном случае для миграции возможен следующий порядок действий.

1. Развертывание приложения для AKS с числом реплики, равным 0.
2. Увеличение масштаба приложения на ACS 0. (Этот шаг требуется время простоя).
3. Масштабирование приложения в AKS до 1.
4. Проверьте.
5. Направляют трафик в кластере AKS.

Если вы хотите начать с пустой общего ресурса и сделать копию исходных данных, можно использовать [ `az storage file copy` ](https://docs.microsoft.com/cli/azure/storage/file/copy?view=azure-cli-latest) команд для переноса данных.

### <a name="deployment-strategy"></a>Стратегия развертывания

Мы рекомендуем использовать имеющимся конвейером CI/CD для развертывания удачной конфигурации в AKS. Клонировать существующие задачи развертывания и убедитесь, что `kubeconfig` указывает на новый кластер AKS.

Если это невозможно, экспортировать определения ресурсов из службы ACS, а затем применить их к AKS. Для экспорта объектов можно использовать `kubectl`.

```console
kubectl get deployment -o=yaml --export > deployments.yaml
```

В зависимости от потребностей развертывания помогут несколько средств с открытым исходным кодом:

* [Velero](https://github.com/heptio/ark) (это средство требует Kubernetes 1.7).
* [Расширение Azure Kube CLI](https://github.com/yaron2/azure-kube-cli)
* [ReShifter](https://github.com/mhausenblas/reshifter)

## <a name="migration-steps"></a>Этапы миграции

1. [Создание кластера AKS](https://docs.microsoft.com/azure/aks/create-cluster) через портал Azure, Azure CLI или шаблона Azure Resource Manager.

   > [!NOTE]
   > Найти примеры шаблонов Azure Resource Manager для AKS в [Azure/AKS](https://github.com/Azure/AKS/tree/master/examples/vnet) репозитории на сайте GitHub.

2. Внесите необходимые изменения для определений YAML. Например, замените `apps/v1beta1` с `apps/v1` для `Deployments`.

3. [Перенести тома](#migrating-persistent-volumes) (необязательно) в кластере ACS для кластера AKS.

4. Используйте систему Непрерывной интеграции и развертывания приложений для AKS. Или используйте команду kubectl применить определения YAML.

5. Проверьте. Убедитесь, что ваши приложения работают должным образом и что все перенесенные данные скопированы через.

6. Перенаправить трафик. Обновите DNS, чтобы указать на развертывание AKS.

7. Завершите задачи, выполняемые после миграции. Если перенести тома и не стал замораживания операций записи, скопируйте эти данные на новый кластер.
