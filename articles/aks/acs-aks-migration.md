---
title: Миграция из службы контейнеров Azure (ACS) в службу Kubernetes Azure (AKS)
description: Миграция из службы контейнеров Azure (ACS) в службу Azure Kubernetes (AKS).
services: container-service
author: noelbundick
manager: jeconnoc
ms.service: container-service
ms.topic: article
ms.date: 06/13/2018
ms.author: nobun
ms.custom: mvc
ms.openlocfilehash: 66f76a8a706f60df786786cbd1ce00b7eafd8d7e
ms.sourcegitcommit: cd70273f0845cd39b435bd5978ca0df4ac4d7b2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2019
ms.locfileid: "71097884"
---
# <a name="migrate-from-azure-container-service-acs-to-azure-kubernetes-service-aks"></a>Миграция из службы контейнеров Azure (ACS) в службу Kubernetes Azure (AKS)

Эта статья поможет вам спланировать и выполнить успешную миграцию между службой контейнеров Azure (ACS) с помощью Kubernetes и службы Kubernetes Azure (AKS). Чтобы помочь вам принять основные решения, в этом руководством описаны различия между ACS и AKS и приведены общие сведения о процессе миграции.

## <a name="differences-between-acs-and-aks"></a>Различия между службами ACS и AKS

Службы ACS и AKS отличаются в некоторых ключевых областях, влияющих на миграцию. Перед миграцией необходимо ознакомиться с приведенными ниже отличиями и спланировать их.

* Узлы AKS используют [управляемые диски](../virtual-machines/windows/managed-disks-overview.md).
    * Неуправляемые диски должны быть преобразованы, прежде чем их можно будет присоединить к узлам AKS.
    * Пользовательские `StorageClass` объекты для дисков Azure необходимо изменить с `unmanaged` на `managed`.
    * Все `PersistentVolumes` должны использовать `kind: Managed`.
* AKS поддерживает [несколько пулов узлов](https://docs.microsoft.com/azure/aks/use-multiple-node-pools) (в настоящее время находится на этапе предварительной версии).
* Узлы, основанные на Windows Server, сейчас доступны в [предварительной версии в AKS](https://azure.microsoft.com/blog/kubernetes-on-azure/).
* AKS поддерживает ограниченный набор [регионов](https://docs.microsoft.com/azure/aks/quotas-skus-regions).
* AKS — это управляемая служба с размещенной панелью управления Kubernetes. Если вы ранее изменили конфигурацию главных серверов ACS, вам может потребоваться внести изменения в приложения.

## <a name="differences-between-kubernetes-versions"></a>Различия между версиями Kubernetes

Если вы выполняете миграцию на более новую версию Kubernetes, ознакомьтесь со следующими материалами, чтобы понять стратегии управления версиями Kubernetes.

* [Политика поддержки Kubernetes версий и отклонений версий](https://kubernetes.io/docs/setup/release/version-skew-policy/#supported-versions)

## <a name="migration-considerations"></a>Рекомендации по переносу

### <a name="agent-pools"></a>Пулы агентов

Несмотря на то, что AKS управляет плоскостью управления Kubernetes, вы по-прежнему определяете размер и количество узлов, включаемых в новый кластер. Если нужно добиться сопоставления 1:1 между службами ACS и AKS, необходимо записать данные существующего узла ACS. Используйте эти данные при создании нового кластера AKS.

Пример:

| Название | Count | Размер виртуальной машины | Операционная система |
| --- | --- | --- | --- |
| agentpool0 | 3 | Standard_D8_v2 | Linux |
| agentpool1 | 1 | Standard_D2_v2 | Windows |

Так как дополнительные виртуальные машины будут развернуты в рамках подписки во время миграции, следует убедиться, что квоты и ограничения достаточны для этих ресурсов. 

Дополнительные сведения см. в статье [Подписка Azure и ограничения службы](https://docs.microsoft.com/azure/azure-subscription-service-limits). Чтобы проверить текущие квоты, в портал Azure перейдите в [колонку подписки](https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade), выберите свою подписку и щелкните **использование + квоты**.

### <a name="networking"></a>Сети

Миграция сложных приложений обычно выполняется в течение некоторого времени, а не одномоментно. Это означает, что старым и новым средам может потребоваться взаимодействие по сети. Приложения, для которых `ClusterIP` ранее использовались службы для взаимодействия, могут быть предоставлены как тип `LoadBalancer` и должны быть защищены соответствующим образом.

Чтобы завершить миграцию, необходимо указать клиентам новые службы, работающие на AKS. Мы рекомендуем перенаправить трафик, обновив DNS, чтобы указать Load Balancer, расположенную перед кластером AKS.

### <a name="stateless-applications"></a>Приложения без отслеживания состояния

Перенос приложений без отслеживания состояния — это самый простой случай. Вы примените определения YAML к новому кластеру, убедитесь, что все работает правильно, и перенаправьте трафик, чтобы активировать новый кластер.

### <a name="stateful-applications"></a>Приложения с отслеживанием состояния

Тщательно спланируйте миграцию приложений с отслеживанием состояния, чтобы избежать потери данных или непредвиденного простоя.

#### <a name="highly-available-applications"></a>Приложения с высоким уровнем доступности

Вы можете развернуть некоторые приложения с отслеживанием состояния в конфигурации высокой доступности. Эти приложения могут копировать данные между репликами. Если вы сейчас используете такое развертывание, вы можете создать новый элемент в новом кластере AKS, а затем выполнить миграцию с минимальным влиянием на нижестоящий вызывающий объект. Как правило, этапы миграции для этого сценария:

1. Создайте новую вторичную реплику на AKS.
2. Дождитесь завершения репликации данных.
3. Выполните отработку отказа, чтобы сделать вторичную реплику новой базой данных-источником.
4. Укажите трафик к кластеру AKS.

#### <a name="migrating-persistent-volumes"></a>Перенос постоянных томов

При переносе существующих постоянных томов в AKS, как правило, необходимо выполнить следующие действия:

1. Замораживание записи в приложение. (Этот шаг является необязательным и требует простоя.)
2. Создание моментальных снимков дисков.
3. Создание управляемых дисков из моментальных снимков.
4. Создайте постоянные тома в AKS.
5. Обновите спецификации Pod, чтобы [использовать существующие тома](https://docs.microsoft.com/azure/aks/azure-disk-volume) , а не персистентволумеклаимс (статическая подготовка).
6. Разверните приложение в AKS.
7. Проверить.
8. Укажите трафик к кластеру AKS.

> [!IMPORTANT]
> Если вы решили не заморозить операции записи, необходимо реплицировать данные в новое развертывание. В противном случае данные, записанные после создания моментальных снимков диска, будут пропущены.

Некоторые средства с открытым кодом могут помочь в создании управляемых дисков и переносе томов между кластерами Kubernetes:

* [Azure CLIное расширение копирования дисков](https://github.com/noelbundick/azure-cli-disk-copy-extension) копирует и преобразует диски в группах ресурсов и регионах Azure.
* [Расширение CLI Azure KUBE](https://github.com/yaron2/azure-kube-cli) перечисляет тома Kubernetes ACS и переносит их в кластер AKS.

#### <a name="azure-files"></a>Файлы Azure

В отличие от дисков, файлы Azure можно одновременно подключить к нескольким узлам. В кластере AKS Azure и Kubernetes не препятствуют созданию Pod, который по-прежнему используется кластером ACS. Чтобы избежать потери данных и непредвиденного поведения, убедитесь, что кластеры не записывают одни и те же файлы одновременно.

Если в приложении может размещаться несколько реплик, которые указывают на один и тот же общий файловый ресурс, следуйте шагам миграции без отслеживания состояния и разверните определения YAML в новом кластере. В противном случае для миграции возможен следующий порядок действий.

1. Разверните приложение в AKS с нулевым числом реплик.
2. Масштабировать приложение на ACS до 0. (Для этого шага требуется время простоя.)
3. Масштабировать приложение на AKS до 1.
4. Проверить.
5. Укажите трафик к кластеру AKS.

Если вы хотите начать с пустой общей папки и создать копию исходных данных, можно использовать [`az storage file copy`](https://docs.microsoft.com/cli/azure/storage/file/copy?view=azure-cli-latest) команды для переноса данных.

### <a name="deployment-strategy"></a>Стратегия развертывания

Мы рекомендуем использовать существующий конвейер CI/CD для развертывания известной конфигурации в AKS. Клонировать существующие задачи развертывания и убедиться, что `kubeconfig` они указывают на новый кластер AKS.

Если это невозможно, экспортируйте определения ресурсов из ACS, а затем примените их к AKS. Для экспорта объектов можно использовать `kubectl`.

```console
kubectl get deployment -o=yaml --export > deployments.yaml
```

В зависимости от потребностей развертывания может помочь несколько средств с открытым кодом.

* [Велеро](https://github.com/heptio/ark) (Для этого средства требуется Kubernetes 1,7.)
* [Расширение CLI Azure KUBE](https://github.com/yaron2/azure-kube-cli)
* [Сдвиг](https://github.com/mhausenblas/reshifter)

## <a name="migration-steps"></a>Этапы миграции

1. [Создайте кластер AKS](https://docs.microsoft.com/azure/aks/create-cluster) с помощью шаблона портал Azure, Azure CLI или Azure Resource Manager.

   > [!NOTE]
   > Найдите примеры Azure Resource Manager шаблонов для AKS в репозитории [Azure/AKS](https://github.com/Azure/AKS/tree/master/examples/vnet) на сайте GitHub.

2. Внесите необходимые изменения в определения YAML. Например, замените `apps/v1beta1` `apps/v1` на for `Deployments`.

3. [Миграция томов](#migrating-persistent-volumes) (необязательно) из кластера ACS в кластер AKS.

4. Используйте систему CI/CD для развертывания приложений в AKS. Или используйте kubectl для применения определений YAML.

5. Проверить. Убедитесь, что ваши приложения работают должным образом и все перенесенные данные были скопированы.

6. Перенаправление трафика. Обновите DNS, чтобы указать на развертывание AKS.

7. Завершите задачи, выполняемые после миграции. Если вы перенесли тома и решили не заморозить операции записи, скопируйте эти данные в новый кластер.
