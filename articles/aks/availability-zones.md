---
title: Использование зон доступности в службе Azure Kubernetes (AKS)
description: Узнайте, как создать кластер, который распределяет узлы в зонах доступности в службе Azure Kubernetes (AKS)
services: container-service
author: iainfoulds
ms.service: container-service
ms.topic: article
ms.date: 06/24/2019
ms.author: iainfou
ms.openlocfilehash: 0f99386aa9eeb75a990507e383c32412fb39eceb
ms.sourcegitcommit: 64798b4f722623ea2bb53b374fb95e8d2b679318
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67840684"
---
# <a name="preview---create-an-azure-kubernetes-service-aks-cluster-that-uses-availability-zones"></a>Preview — создание кластера Azure Kubernetes Service (AKS), который использует зоны доступности

Кластер Azure Kubernetes Service (AKS) распределяет ресурсы, такие как узлы и хранилища на логические разделы базовых Azure вычислительной инфраструктурой. Такая модель развертывания гарантирует, что на узлах запускается в отдельных доменах сбоя и обновления в одном ЦОД Azure. AKS кластеров, развернутых с этим поведением по умолчанию запланированных событий обслуживания или обеспечить высокий уровень доступности для защиты от сбоев оборудования.

Чтобы обеспечить более высокий уровень доступности приложений, можно распространять кластерах AKS в зонах доступности. Эти зоны являются физически разделенными центрами обработки данных в пределах заданного региона. При распределении кластерные компоненты в нескольких зонах, кластера AKS может допустить сбой в одной из этих зон. Приложения и операции управления продолжают быть доступны, даже если возникла проблема с одной весь центр обработки данных.

В этой статье показано, как создать кластер AKS и распределить компоненты узла в зонах доступности. Эта функция в настоящее время находится на стадии предварительной версии.

> [!IMPORTANT]
> Функции предварительной версии AKS: самообслуживания, согласиться. Они предназначены для сбора отзывов и ошибки нашего сообщества. В предварительной версии эти функции не предназначены для использования в рабочей среде. Функции в общедоступной предварительной версии подпадают под поддержки «оптимальных затрат». Помощь от групп разработчиков AKS Техническая поддержка доступна во время рабочих часов тихоокеанского часового пояса (по тихоокеанскому времени) только. Дополнительные сведения обратитесь в следующие справочные статьи:
>
> * [Политики поддержки AKS][aks-support-policies]
> * [Часто задаваемые вопросы о поддержке Azure][aks-faq]

## <a name="before-you-begin"></a>Перед началом работы

Требуется Azure CLI версии 2.0.66 или более поздней версии установлен и настроен. Чтобы узнать версию, выполните команду  `az --version`. Если требуется выполнить установку или обновление, см. в разделе [установить Azure CLI][install-azure-cli].

### <a name="install-aks-preview-cli-extension"></a>Установка расширения интерфейса командной строки aks-preview

Чтобы создать кластер AKS, используйте зоны доступности, вам потребуется *предварительной версии aks* CLI версия расширения 0.4.1 или более поздней версии. Установка *предварительной версии aks* расширение Azure CLI с помощью [добавить расширения az][az-extension-add] command, then check for any available updates using the [az extension update][az-extension-update] команда::

```azurecli-interactive
# Install the aks-preview extension
az extension add --name aks-preview

# Update the extension to make sure you have the latest version installed
az extension update --name aks-preview
```

### <a name="register-feature-flags-for-your-subscription"></a>Регистрация флагов компонентов для вашей подписки

Чтобы создать кластер AKS, зоны доступности, необходимо сначала включите некоторые флаги компонентов в вашей подписке. Кластеры используют виртуальной машины масштабируемого набора для управления развертыванием и конфигурацию узлов Kubernetes. *Стандартный* SKU подсистемы балансировки нагрузки Azure также необходим для обеспечения устойчивости сетевых компонентов для маршрутизации трафика в этом кластере. Зарегистрировать *AvailabilityZonePreview*, *AKSAzureStandardLoadBalancer*, и *VMSSPreview* флаги компонентов с помощью [az функция register][az-feature-register] команды, как показано в следующем примере:

> [!CAUTION]
> При регистрации компонента для подписки, вы не можете сейчас отменить регистрацию этой функции. После включения некоторые возможности предварительной версии, можно использовать значения по умолчанию для всех кластеров AKS, затем создается в подписке. Не включайте функции предварительной версии на рабочие подписки. Используйте отдельную подписку для тестирования функции предварительной версии и собирайте отзывы.

```azurecli-interactive
az feature register --name AvailabilityZonePreview --namespace Microsoft.ContainerService
az feature register --name AKSAzureStandardLoadBalancer --namespace Microsoft.ContainerService
az feature register --name VMSSPreview --namespace Microsoft.ContainerService
```

Через несколько минут отобразится состояние *Registered* (Зарегистрировано). Вы можете проверить состояние регистрации с помощью [список функций az][az-feature-list] команды:

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/AvailabilityZonePreview')].{Name:name,State:properties.state}"
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/AKSAzureStandardLoadBalancer')].{Name:name,State:properties.state}"
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/VMSSPreview')].{Name:name,State:properties.state}"
```

Когда все будет готово, обновить регистрацию *Microsoft.ContainerService* поставщик ресурсов с помощью [az provider register][az-provider-register] команды:

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

## <a name="limitations-and-region-availability"></a>Ограничения и доступность по регионам

В настоящее время кластерах AKS можно создать с помощью зон доступности в следующих регионах:

* Восток США 2
* Северная Европа
* Юго-Восточная Азия
* Западная Европа
* Западный регион США 2

При создании кластера AKS с помощью зон доступности применяются следующие ограничения:

* Зоны доступности можно включить только в том случае, при создании кластера.
* Параметры зоны доступности нельзя обновить после создания кластера. Не удается обновить кластер зоны существующих, отличных от доступности, чтобы использовать зоны доступности.
* Зоны доступности для кластера AKS нельзя отключить после его создания.
* Выбранный размер узла (номер SKU виртуальной Машины) должны быть доступны во всех зонах доступности.
* Кластеры с включенными зонами требуют доступности используйте стандартный балансировщиков нагрузки Azure для распространения в зонах.
* Необходимо использовать Kubernetes версии 1.13.5 или более поздней версии, чтобы развернуть стандартный подсистемы балансировки нагрузки.

AKS кластеры, использующие зон доступности необходимо использовать Azure load balancer *стандартный* SKU. Значение по умолчанию *основные* SKU подсистемы балансировки нагрузки Azure не поддерживает распределение в зонах доступности. Дополнительные сведения и ограничения, стандарт подсистемы балансировки нагрузки, см. в разделе [ограничения предварительной версии стандартных SKU подсистемы балансировки нагрузки Azure][standard-lb-limitations].

### <a name="azure-disks-limitations"></a>Ограничения на диски Azure

Тома, использующие Azure управляемых дисков в настоящее время не зональных ресурсов. Запланировать повторное выполнение в другой зоне из их исходного зоны модулей нельзя легко повторно подключить их предыдущих дисков. Рекомендуется для запуска рабочих нагрузок без отслеживания состояния, не требующих постоянное хранилище, может встретиться зональные проблем.

Если необходимо запускать рабочие нагрузки с отслеживанием состояния, используйте taints и tolerations в вашей спецификации pod сообщить планировщик Kubernetes, чтобы создать POD, содержащихся в той же зоне, что диски. Кроме того используйте хранилище на основе сети, например файлов Azure, которое можно присоединить к модулей, так как они плану между зонами.

## <a name="overview-of-availability-zones-for-aks-clusters"></a>Общие сведения о зонах доступности для AKS кластеров

Зоны доступности являются предложением, обеспечивающим высокий уровень доступности и защищающим приложения и данные от сбоев центров обработки данных. Зоны — уникальные физические расположения в регионе Azure. Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Чтобы обеспечить отказоустойчивость, во всех включенных регионах используются минимум три отдельные зоны. Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных. Избыточные между зонами службы реплицируют приложения и данные в зонах доступности, чтобы обеспечить защиту от возникновения единых точек отказа.

Дополнительные сведения см. в разделе [что такое зоны доступности в Azure?][az-overview].

AKS кластеров, которые развертываются с помощью зон доступности можно распределить узлы в нескольких зонах в одном регионе. Например, кластер в *восточная часть США 2* регионе могут создавать узлы во всех трех зонах доступности в *восточная часть США 2*. Это распределение ресурсов кластера AKS повышает доступность кластера, так как они устойчивым к сбоям из определенной зоне.

![Распределение узлов AKS в зонах доступности](media/availability-zones/aks-availability-zones.png)

В из-за сбоя зоны, узлы можно Реорганизация вручную или с помощью автомасштабирования кластера. Если в одной зоне становится недоступным, приложения будет продолжать работать.

## <a name="create-an-aks-cluster-across-availability-zones"></a>Создание кластера AKS в зонах доступности

При создании кластера с помощью [создать az aks][az-aks-create] команде `--node-zones` параметр определяет, какие узлы агента зон развертываются в. Компоненты плоскости управления AKS для кластера также распределены между зонами в наибольшее доступные конфигурации при создании типа кластера, указывающее `--node-zones` параметра.

Если вы не определили любые зоны для пула агентов по умолчанию при создании кластера AKS, компоненты плоскости управления AKS для кластера не будет использовать зоны доступности. Вы можете добавить дополнительный узел пулы (сейчас в предварительной версии в AKS) с помощью [добавьте az aks nodepool][az-aks-nodepool-add] команду и укажите `--node-zones` для этих новых узлов, агент, однако компоненты плоскости управления оставаться без зона доступности Знание. Невозможно изменить сведения о поясе для пул узлов или AKS управлять компонентами плоскость после их развертывания.

В следующем примере создается кластер службы контейнеров AZURE с именем *myAKSCluster* в группе ресурсов с именем *myResourceGroup*. Общее количество *3* узлы создаются - один агент в зоне *1*по одной в *2*и затем ты в *3*. Компоненты плоскости управления AKS также распределяются по зон в наибольшее доступные конфигурации, так как они определяются как процесс создания частью кластера.

```azurecli-interactive
az group create --name myResourceGroup --location eastus2

az aks create \
    --resource-group myResourceGroup \
    --name myAKSCluster \
    --kubernetes-version 1.13.5 \
    --generate-ssh-keys \
    --enable-vmss \
    --load-balancer-sku standard \
    --node-count 3 \
    --node-zones 1 2 3
```

Создание кластера AKS занимает несколько минут.

## <a name="verify-node-distribution-across-zones"></a>Проверьте распределение узлов в зонах

Когда кластер будет готов, список узлов агентов в масштабируемом наборе, в какой зоне доступности, они развертываются в см. в разделе.

Сначала необходимо получить учетные данные кластера AKS с помощью [az aks get-credentials][az-aks-get-credentials] команды:

```azurecli-interactive
az aks get-credentials --resource-group myResourceGroup --name myAKSCluster
```

Затем используйте [описания kubectl][kubectl-describe] команду, чтобы получить список узлов в кластере. Фильтрация по *failure-domain.beta.kubernetes.io/zone* значение, как показано в следующем примере:

```console
kubectl describe nodes | grep -e "Name:" -e "failure-domain.beta.kubernetes.io/zone"
```

В следующем примере выходных данных показаны три узла, распределенные по заданной области и зоны доступности, такие как *eastus2-1* для первой зоны доступности и *eastus2-2* для второго Зона доступности:

```console
Name:       aks-nodepool1-28993262-vmss000000
            failure-domain.beta.kubernetes.io/zone=eastus2-1
Name:       aks-nodepool1-28993262-vmss000001
            failure-domain.beta.kubernetes.io/zone=eastus2-2
Name:       aks-nodepool1-28993262-vmss000002
            failure-domain.beta.kubernetes.io/zone=eastus2-3
```

По мере добавления дополнительных узлов пул агентов, платформа Azure автоматически распределяет базовых виртуальных машин в зонах доступности.

## <a name="next-steps"></a>Следующие шаги

В этой статье описывается, как создать кластер AKS, который использует зоны доступности. Дополнительные рекомендации по высокой доступности кластеров см. в разделе [советы и рекомендации для бизнеса непрерывности и аварийного восстановления в AKS][best-practices-bc-dr].

<!-- LINKS - internal -->
[install-azure-cli]: /cli/azure/install-azure-cli
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register
[az-aks-create]: /cli/azure/aks#az-aks-create
[az-overview]: ../availability-zones/az-overview.md
[best-practices-bc-dr]: operator-best-practices-multi-region.md
[aks-support-policies]: support-policies.md
[aks-faq]: faq.md
[standard-lb-limitations]: load-balancer-standard.md#limitations
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[az-aks-nodepool-add]: /cli/azure/ext/aks-preview/aks/nodepool#ext-aks-preview-az-aks-nodepool-add
[az-aks-get-credentials]: /cli/azure/aks?view=azure-cli-latest#az-aks-get-credentials

<!-- LINKS - external -->
[kubectl-describe]: https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#describe
