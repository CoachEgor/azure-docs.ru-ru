---
title: Использование управляемых удостоверений в службе Kubernetes Azure
description: Узнайте, как использовать управляемые удостоверения в службе Kubernetes Azure (AKS).
services: container-service
author: mlearned
ms.topic: article
ms.date: 07/10/2020
ms.author: mlearned
ms.openlocfilehash: 27ae1d1a2c6309bdac2410dca4b48abf27d8ea0b
ms.sourcegitcommit: f7e160c820c1e2eb57dc480b2a8fd6bef7053e91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/10/2020
ms.locfileid: "86231987"
---
# <a name="use-managed-identities-in-azure-kubernetes-service"></a>Использование управляемых удостоверений в службе Kubernetes Azure

В настоящее время кластер Azure Kubernetes Service (AKS) (в частности, поставщик облачных служб Kubernetes) требует удостоверения для создания дополнительных ресурсов, таких как подсистемы балансировки нагрузки и управляемые диски в Azure. Это может быть *управляемое удостоверение* или субъект- *Служба*. При использовании [субъекта-службы](kubernetes-service-principal.md)необходимо предоставить один или AKS от вашего имени. Если вы используете управляемое удостоверение, оно будет создано автоматически AKS. Кластеры, использующие субъекты-службы, в конечном итоге достигают состояния, в котором необходимо обновить субъект-службу, чтобы обеспечить работу кластера. Управление субъектами-службами повышает сложность, поэтому вместо этого проще использовать управляемые удостоверения. Те же требования к разрешениям применяются и к субъектам-службам, и к управляемым удостоверениям.

*Управляемые удостоверения* по сути являются оболочкой для субъектов-служб и упрощают их управление. Поворот учетных данных для MI происходит автоматически каждые 46 дней в соответствии с Azure Active Directory по умолчанию. AKS использует управляемые системой и назначенные пользователем типы удостоверений. В настоящее время эти удостоверения неизменяемы. Дополнительные сведения см. в статье об [управляемых удостоверениях для ресурсов Azure](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview).

## <a name="before-you-begin"></a>Перед началом

Необходимо установить следующий ресурс:

- Azure CLI версии 2.8.0 или более поздней.

## <a name="limitations"></a>Ограничения

* Новые управляемые удостоверения в настоящее время не поддерживаются.
* Кластеры AKS с управляемыми удостоверениями могут быть включены только во время создания кластера.
* Существующие кластеры AKS не могут быть обновлены или обновлены для включения управляемых удостоверений.
* Во время операций **обновления** кластера управляемое удостоверение временно недоступно.

## <a name="summary-of-managed-identities"></a>Сводка по управляемым удостоверениям

AKS использует несколько управляемых удостоверений для встроенных служб и надстроек.

| Идентификация                       | Имя    | Вариант использования | Разрешения по умолчанию | Приведите свое удостоверение
|----------------------------|-----------|----------|
| Уровень управления | не видно | Используется AKS для управления сетевыми ресурсами, например для создания балансировщика нагрузки для входящих, общедоступных IP-адресов и т. д.| Роль участника для группы ресурсов узла | Сейчас не поддерживается
| kubelet | Имя кластера AKS — ажентпул | Проверка подлинности с помощью реестра контейнеров Azure (запись контроля доступа) | Роль читателя для группы ресурсов узла | Сейчас не поддерживается
| Дополнительно | азуренпм | Удостоверение не требуется | Н/Д | Нет
| Дополнительно | Мониторинг сети Азурекни | Удостоверение не требуется | Н/Д | Нет
| Дополнительно | азуреполици (привратник) | Удостоверение не требуется | Н/Д | Нет
| Дополнительно | азуреполици | Удостоверение не требуется | Н/Д | Нет
| Дополнительно | Calico | Удостоверение не требуется | Н/Д | Нет
| Дополнительно | Панель мониторинга | Удостоверение не требуется | Н/Д | Нет
| Дополнительно | хттпаппликатионраутинг | Управляет необходимыми сетевыми ресурсами | Роль читателя для группы ресурсов Node, роль участника для зоны DNS | Нет
| Дополнительно | Шлюз приложений входящего трафика | Управляет необходимыми сетевыми ресурсами| Роль участника для группы ресурсов узла | Нет
| Дополнительно | omsagent | Используется для отправки метрик AKS в Azure Monitor | Роль издателя метрик мониторинга | Нет
| Дополнительно | Виртуальный узел (АЦиконнектор) | Управляет необходимыми сетевыми ресурсами для службы "экземпляры контейнеров Azure" (ACI) | Роль участника для группы ресурсов узла | Нет


## <a name="create-an-aks-cluster-with-managed-identities"></a>Создание кластера AKS с управляемыми удостоверениями

Теперь можно создать кластер AKS с управляемыми удостоверениями с помощью следующих команд интерфейса командной строки.

Сначала создайте группу ресурсов Azure:

```azurecli-interactive
# Create an Azure resource group
az group create --name myResourceGroup --location westus2
```

Затем создайте кластер AKS:

```azurecli-interactive
az aks create -g myResourceGroup -n myManagedCluster --enable-managed-identity
```

Успешное создание кластера с помощью управляемых удостоверений содержит следующие сведения о профиле субъекта-службы:

```json
"servicePrincipalProfile": {
    "clientId": "msi"
  }
```

Используйте следующую команду, чтобы запросить ObjectID управляемого удостоверения плоскости управления:

```azurecli-interactive
az aks show -g myResourceGroup -n MyManagedCluster --query "identity"
```

Результат должен выглядеть следующим образом:

```json
{
  "principalId": "<object_id>",   
  "tenantId": "<tenant_id>",      
  "type": "SystemAssigned"                                 
}
```

> [!NOTE]
> Для создания и использования собственной виртуальной сети, статического IP-адреса или подключенного диска Azure, где ресурсы выходят за пределы группы ресурсов рабочего узла, используйте PrincipalID управляемого удостоверения, назначенного системой кластера, для выполнения назначения ролей. Дополнительные сведения о назначении ролей см. в статье [Делегирование доступа к другим ресурсам Azure](kubernetes-service-principal.md#delegate-access-to-other-azure-resources).
>
> Предоставление разрешений на управляемое удостоверение кластера, используемое поставщиком облачных служб Azure, может занять 60 минут для заполнения.

Наконец, получите учетные данные для доступа к кластеру:

```azurecli-interactive
az aks get-credentials --resource-group myResourceGroup --name MyManagedCluster
```

Кластер будет создан через несколько минут. Затем можно развернуть рабочие нагрузки приложений в новом кластере и взаимодействовать с ним так же, как и с кластерами AKS на основе субъектов-служб.

## <a name="next-steps"></a>Дальнейшие действия
* Используйте [шаблоны Azure Resource Manager (ARM)][aks-arm-template] для создания кластеров с поддержкой управляемого удостоверения.

<!-- LINKS - external -->
[aks-arm-template]: https://docs.microsoft.com/azure/templates/microsoft.containerservice/managedclusters
