---
title: rbИнтеграция Azure Active Directory со службой Azure Kubernetes
description: Как создавать кластеры службы Kubernetes с поддержкой Azure Active Directory Azure (AKS)
services: container-service
author: mlearned
ms.service: container-service
ms.topic: article
ms.date: 04/26/2019
ms.author: mlearned
ms.openlocfilehash: 80137023643630e8472a70fcca6cb656aeba7123
ms.sourcegitcommit: 6a42dd4b746f3e6de69f7ad0107cc7ad654e39ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2019
ms.locfileid: "67616386"
---
# <a name="integrate-azure-active-directory-with-azure-kubernetes-service"></a>rbИнтеграция Azure Active Directory со службой Azure Kubernetes

Служба Azure Kubernetes (AKS) можно настроить для использования Azure Active Directory (Azure AD) для проверки подлинности пользователя. В этой конфигурации можно вход кластера AKS с помощью маркер проверки подлинности Azure AD.

Администраторы кластера можно настроить на основе участия пользователя удостоверения или directory группе управления Kubernetes доступа на основе ролей (RBAC).

В этой статье описано, как:

- Разверните необходимые компоненты для AKS и Azure AD.
- Развертывание Azure AD с поддержкой кластера.
- Создайте базовый роль RBAC в кластере AKS с помощью портала Azure.

Эти действия также можно выполнить с помощью [Azure CLI][azure-ad-cli].

> [!NOTE]
> Azure AD можно включить только в том случае, при создании нового кластера с поддержкой RBAC. Вы не можете включить эту службу в существующем кластере AKS.

## <a name="authentication-details"></a>Подробные сведения о проверке подлинности

Проверка подлинности Azure AD предоставляется AKS кластеров с OpenID Connect. OpenID Connect представляет собой уровень идентификации на основе протокола OAuth 2.0.

Дополнительные сведения об OpenID Connect, см. в разделе [авторизации доступа к веб-приложений с помощью OpenID Connect и Azure AD][open-id-connect].

В кластере Kubernetes маркер проверки подлинности веб-перехватчика используется для маркеров проверки подлинности. Настройка такой проверка подлинности и ее управление являются частью кластера AKS.

Дополнительные сведения о веб-перехватчика токена проверки подлинности, см. в разделе [токена проверки подлинности веб-перехватчика][kubernetes-webhook] раздел в документации по Kubernetes.

Для проверки подлинности Azure AD для кластера AKS, создаются два приложения Azure AD. Первое приложение являются серверным компонентом, который обеспечивает проверку подлинности пользователя. Второе приложение — это клиентский компонент, который используется при появлении интерфейсом командной строки для проверки подлинности. Это клиентское приложение использует серверное приложение за фактическую проверку подлинности учетных данных, предоставленных клиентом.

> [!NOTE]
> При настройке Azure AD для аутентификации AKS, настраиваются два приложения Azure AD. Администратор клиента Azure, необходимо выполнить шаги, чтобы делегировать разрешения для каждого приложения.

## <a name="create-the-server-application"></a>Создание серверного приложения

Первое приложение Azure AD применяется для получения членства в группе Azure AD пользователя. Чтобы создать это приложение на портале Azure:

1. Последовательно выберите элементы **Azure Active Directory** > **Регистрация приложений** > **Новая регистрация**.

    1\. Присвойте приложению имя, например *AKSAzureADServer*.

    2\. Для **поддерживаемые типы учетных записей**выберите **учетных записей в организации каталога только**.
    
    В. Выберите **Web** качестве URI переадресации введите, а затем введите любое значение формате URI, таких как *https://aksazureadserver* .

    Г. Выберите **зарегистрировать** после окончания.

2. Выберите **манифеста**, а затем измените **groupMembershipClaims:** значение как **все**. Когда вы закончите с обновлениями, выберите **Сохранить**.

    ![Обновление членства в группе — установка значения All](media/aad-integration/edit-manifest.png)

3. В левой части приложения Azure AD, выберите **сертификаты и секреты**.

    1\. Выберите **+ новый секрет клиента**.

    2\. Добавьте описание ключа, например *сервера Azure AD AKS*. Выберите срок действия, а затем выберите **добавить**.

    В. Обратите внимание, значение ключа, которая отображается только в данный момент. При развертывании кластера AKS Azure AD с поддержкой, это значение называется секрет приложения сервера.

4. В левой части приложения Azure AD, выберите **разрешения API**, а затем выберите **+ добавить разрешение**.

    1\. В разделе **API-интерфейсов Microsoft**выберите **Microsoft Graph**.

    2\. Выберите **делегированные разрешения**, а затем установите флажок рядом с полем **Directory > Directory.Read.All (чтение данных каталога)** .

    В. Если значение по умолчанию делегированное разрешение для **пользователя > User.Read (вход и чтение профиля пользователя)** не существует, установите флажок рядом с ним.

    Г. Выберите **разрешения приложения**, а затем установите флажок рядом с полем **Directory > Directory.Read.All (чтение данных каталога)** .

    ![Задать разрешения graph](media/aad-integration/graph-permissions.png)

    Д. Выберите **добавить разрешения** чтобы сохранить изменения.

    f. В разделе **дать согласие**выберите **предоставления согласия администратора**. Эта кнопка не недоступен, если текущая учетная запись не является администратором клиента

    При предоставляются разрешения на портале отображается следующее уведомление:

   ![Уведомление об успешном предоставлении разрешений](media/aad-integration/permissions-granted.png)

5. В левой части приложения Azure AD, выберите **предоставляют API**, а затем выберите **+ добавить область**.
    
    1\. Введите **имя области**, **отображаемое имя согласия администратора**, а затем **описание согласия администратора** например *AKSAzureADServer*.

    2\. Убедитесь, что **состояние** присваивается **включено**.

    ![Предоставление серверного приложения как интерфейс API для использования с другими службами](media/aad-integration/expose-api.png)

    В. Выберите **добавить область**.

6. Вернитесь к приложению **Обзор** страницы и запишите **идентификатор приложения (клиент)** . При развертывании кластера AKS Azure AD с поддержкой, это значение называется идентификатор сервера приложения.

    ![Получение идентификатора приложения](media/aad-integration/application-id.png)

## <a name="create-the-client-application"></a>Создание клиентского приложения

Второе приложение Azure AD используется при входе с использованием интерфейса командной строки Kubernetes (kubectl).

1. Последовательно выберите элементы **Azure Active Directory** > **Регистрация приложений** > **Новая регистрация**.

    1\. Присвойте приложению имя, например *AKSAzureADClient*.

    2\. Для **поддерживаемые типы учетных записей**выберите **учетных записей в организации каталога только**.

    В. Выберите **Web** качестве URI переадресации введите, а затем введите любое значение формате URI, например *https://aksazureadclient* .

    Г. Выберите **зарегистрировать** после окончания.

2. В левой части приложения Azure AD, выберите **разрешения API**, а затем выберите **+ добавить разрешение**.

    1\. Выберите **Мои API**, а затем выберите приложения сервера Azure AD, созданные на предыдущем шаге, такие как *AKSAzureADServer*.

    2\. Выберите **делегированные разрешения**, а затем установите флажок рядом с серверного приложения Azure AD.

    ![Настройка разрешений для приложения](media/aad-integration/select-api.png)

    В. Выберите **добавить разрешения**.

    Г. В разделе **дать согласие**выберите **предоставления согласия администратора**. Эта кнопка недоступна, если текущая учетная запись не является администратором клиента При предоставлении разрешения, следующее уведомление отображается на портале:

    ![Уведомление об успешном предоставлении разрешений](media/aad-integration/permissions-granted.png)

3. В левой части приложения Azure AD, выберите **проверки подлинности**.

    - В разделе **тип клиента по умолчанию**выберите **Да** для **клиента следует считать общедоступным клиентом**.

5. В левой части приложения Azure AD запишите идентификатор приложения. При развертывании кластера AKS Azure AD с поддержкой, это значение называется идентификатор клиента приложения.

   ![Получение идентификатора приложения](media/aad-integration/application-id-client.png)

## <a name="get-the-tenant-id"></a>Получение идентификатора клиента

Затем получите идентификатор клиента Azure. Это значение используется при создании кластера AKS.

На портале Azure выберите **Azure Active Directory** > **свойства** и обратите внимание, **идентификатор каталога**. Вызывается при создании кластера AKS Azure AD с поддержкой, это значение идентификатора клиента.

![Получение идентификатора клиента Azure](media/aad-integration/tenant-id.png)

## <a name="deploy-the-aks-cluster"></a>Развертывание кластера AKS

Используйте [Создание группы az][az-group-create] команду, чтобы создать группу ресурсов в кластере AKS.

```azurecli
az group create --name myResourceGroup --location eastus
```

Используйте [создать az aks][az-aks-create] команду, чтобы развернуть кластер AKS. Затем замените значения в следующем примере команды. Использовать значения, собранные при создании приложения Azure AD для ИД сервера приложений, секрет приложения, идентификатор клиентского приложения и идентификатор клиента.

```azurecli
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --generate-ssh-keys \
  --aad-server-app-id b1536b67-29ab-4b63-b60f-9444d0c15df1 \
  --aad-server-app-secret wHYomLe2i1mHR2B3/d4sFrooHwADZccKwfoQwK2QHg= \
  --aad-client-app-id 8aaf8bd5-1bdd-4822-99ad-02bfaa63eea7 \
  --aad-tenant-id 72f988bf-0000-0000-0000-2d7cd011db47
```

Несколько минут для создания кластера AKS.

## <a name="create-an-rbac-binding"></a>Создать привязку RBAC

Прежде чем использовать учетную запись Azure Active Directory с кластером AKS, необходимо создать привязки роль или роли привязки кластера. Роли определяют разрешения для предоставления и применить их привязки к необходимых пользователей. Эти назначения могут применяться для определенного пространства имен или в масштабах всего кластера. Дополнительные сведения см. в разделе [авторизации с помощью RBAC][rbac-authorization].

Во-первых, используйте [az aks get-credentials][az-aks-get-credentials] с `--admin` аргумент для входа в кластер с административным доступом.

```azurecli
az aks get-credentials --resource-group myResourceGroup --name myAKSCluster --admin
```

Теперь создайте ClusterRoleBinding для учетной записи Azure AD, что вы хотите предоставить доступ к кластеру AKS. Следующий пример дает полный доступ к учетной записи для всех пространств имен в кластере:

- Если пользователь является привязка RBAC для того же клиента Azure AD, то разрешения на основе имени субъекта-пользователя (UPN). Перейти к шагу для создания манифеста для ClusterRoleBinding YAML.

- Если пользователь находится в другой каталог Azure AD клиента, запрашивать и использовать **objectId** свойство вместо этого. При необходимости получить идентификатор объекта для нужной учетной записи пользователя с помощью [show пользователя ad az][az-ad-user-show] команды. Укажите имя участника-пользователя (UPN) учетной записи, требуется:

    ```azurecli-interactive
    az ad user show --upn-or-object-id user@contoso.com --query objectId -o tsv
    ```

Создайте файл, такие как *rbac-aad-user.yaml*, а затем вставьте следующее содержимое. В последней строке, замените **userPrincipalName_or_objectId** с идентификатором имени участника-пользователя или объекта. Выбор зависит от того, является ли пользователь в одном клиенте Azure AD или нет.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: contoso-cluster-admins
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: userPrincipalName_or_objectId
```

Применение привязки с помощью [kubectl применить][kubectl-apply] команды, как показано в следующем примере:

```console
kubectl apply -f rbac-aad-user.yaml
```

Привязку роли также можно создать для всех членов группы Azure AD. Группы Azure AD указываются с помощью идентификатор объекта группы, как показано в следующем примере.

Создайте файл, такие как *rbac-aad-group.yaml*, а затем вставьте следующее содержимое. Обновите идентификатор объекта группы с помощью одного из имен, которое используется в клиенте Azure AD:

 ```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: contoso-cluster-admins
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
   kind: Group
   name: "894656e1-39f8-4bfe-b16a-510f61af6f41"
```

Применение привязки с помощью [kubectl применить][kubectl-apply] команды, как показано в следующем примере:

```console
kubectl apply -f rbac-aad-group.yaml
```

Дополнительные сведения о защите кластера Kubernetes с помощью RBAC см. в разделе [авторизации с помощью RBAC][rbac-authorization].

## <a name="access-the-cluster-with-azure-ad"></a>Доступ к кластеру с помощью Azure AD

Извлечь контекст для пользователя без прав администратора с помощью [az aks get-credentials][az-aks-get-credentials] команды.

```azurecli
az aks get-credentials --resource-group myResourceGroup --name myAKSCluster
```

После того, как `kubectl` команды вам будет предложено аутентифицироваться с помощью Azure. Следуйте инструкциям на экране инструкции, чтобы завершить процесс, как показано в следующем примере:

```console
$ kubectl get nodes

To sign in, use a web browser to open https://microsoft.com/devicelogin. Next, enter the code BUJHWDGNL to authenticate.

NAME                       STATUS    ROLES     AGE       VERSION
aks-nodepool1-79590246-0   Ready     agent     1h        v1.13.5
aks-nodepool1-79590246-1   Ready     agent     1h        v1.13.5
aks-nodepool1-79590246-2   Ready     agent     1h        v1.13.5
```

По завершении процесса кэшируется маркер проверки подлинности. Только будет предложено снова войти в систему после истечения срока действия маркера или файле конфигурации Kubernetes создается заново.

Если вы видите сообщение об ошибке авторизации, после успешного входа, проверьте следующие условия:

```console
error: You must be logged in to the server (Unauthorized)
```


- Соответствующий идентификатор объекта или имя участника-пользователя, зависимости, является ли учетная запись пользователя в одном клиенте Azure AD или не определен.
- Пользователь не является членом более чем 200 групп.
- Секрет, определенные в регистрации приложения для сервера совпадает со значением, настроенные с помощью `--aad-server-app-secret`.

## <a name="next-steps"></a>Следующие шаги

Чтобы использовать Azure AD — пользователи и группы для управления доступом к ресурсам кластера, см. в разделе [управления доступом к ресурсам кластера, с помощью управления доступом и удостоверениями Azure AD в AKS][azure-ad-rbac].

Дополнительные сведения о том, как безопасных кластеров Kubernetes см. в разделе [параметры доступа и удостоверений для AKS][rbac-authorization].

Дополнительные сведения об элементе управления удостоверениями и ресурсов, см. в разделе [советы и рекомендации для проверки подлинности и авторизации в AKS][operator-best-practices-identity].

<!-- LINKS - external -->
[kubernetes-webhook]:https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication
[kubectl-apply]: https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply

<!-- LINKS - internal -->
[az-aks-create]: /cli/azure/aks?view=azure-cli-latest#az-aks-create
[az-aks-get-credentials]: /cli/azure/aks?view=azure-cli-latest#az-aks-get-credentials
[az-group-create]: /cli/azure/group#az-group-create
[open-id-connect]:../active-directory/develop/v1-protocols-openid-connect-code.md
[az-ad-user-show]: /cli/azure/ad/user#az-ad-user-show
[rbac-authorization]: concepts-identity.md#role-based-access-controls-rbac
[operator-best-practices-identity]: operator-best-practices-identity.md
[azure-ad-rbac]: azure-ad-rbac.md
[azure-ad-cli]: azure-ad-integration-cli.md
