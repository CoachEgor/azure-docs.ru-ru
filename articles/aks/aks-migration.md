---
title: Мигрировать в службу Azure Kubernetes (AKS)
description: Мигрировать в службу Azure Kubernetes (AKS).
services: container-service
ms.topic: article
ms.date: 02/25/2020
ms.custom: mvc
ms.openlocfilehash: 8315560c679f9807715af14dc315fa3000be0472
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77624817"
---
# <a name="migrate-to-azure-kubernetes-service-aks"></a>Мигрировать в службу Azure Kubernetes (AKS)

Эта статья поможет вам спланировать и осуществить успешную миграцию в службу Azure Kubernetes Service (AKS). Чтобы помочь вам принимать ключевые решения, в этом руководстве приводится подробная информация о текущей рекомендуемой конфигурации для AKS. Эта статья не охватывает все сценарии, и, где это уместно, статья содержит ссылки на более подробную информацию для планирования успешной миграции.

Этот документ может быть использован для поддержки следующих сценариев:

* Миграция кластера AKS при поддержке [наборов доступности](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-availability-sets) в [наборы виртуальной шкалы машин](https://docs.microsoft.com/azure/virtual-machine-scale-sets/overview)
* Миграция кластера AKS для использования [балансиваля нагрузки Standard SKU](https://docs.microsoft.com/azure/aks/load-balancer-standard)
* Миграция из [контейнерной службы Azure (ACS) - выход на пенсию 31 января 2020](https://azure.microsoft.com/updates/azure-container-service-will-retire-on-january-31-2020/) года в AKS
* Переход от [двигателя AKS](https://docs.microsoft.com/azure-stack/user/azure-stack-kubernetes-aks-engine-overview?view=azs-1908) к AKS
* Миграция из не-Azure на основе кластеров Kubernetes к AKS

При миграции убедитесь, что целевая версия Kubernetes находится в поддерживаемом окне для AKS. При использовании старой версии она может оказаться не в пределах поддерживаемого диапазона и требует обновления версий, которые будут поддерживаться AKS. Для получения дополнительной информации можно узнать, как [AKS поддерживает версии Kubernetes.](https://docs.microsoft.com/azure/aks/supported-kubernetes-versions)

Если вы переигрываете в более новую версию Kubernetes, просмотрите [версию Kubernetes и политику поддержки перекоса версии.](https://kubernetes.io/docs/setup/release/version-skew-policy/#supported-versions)

Несколько инструментов с открытым исходным кодом могут помочь с миграцией, в зависимости от вашего сценария:

* [Велеро](https://velero.io/) (Требует Кубернете 1,7 ")
* [Расширение Azure Kube CLI](https://github.com/yaron2/azure-kube-cli)
* [ReShifter](https://github.com/mhausenblas/reshifter)

В этой статье мы обобщим детали миграции для:

> [!div class="checklist"]
> * AKS со стандартной нагрузкой балансизатор и виртуальные наборы шкалы машин
> * Существующие присоединенные службы Azure
> * Обеспечить действительные квоты
> * Высокая доступность и непрерывность бизнеса
> * Рассмотрение заявлений без гражданства
> * Рассмотрение приложений с состоянием
> * Развертывание конфигурации кластера

## <a name="aks-with-standard-load-balancer-and-virtual-machine-scale-sets"></a>AKS со стандартной нагрузкой балансизатор и виртуальные наборы шкалы машин

AKS – это управляемая услуга, предлагающая уникальные возможности с меньшими накладными расходами на управление. В результате управляемой службы необходимо выбрать из набора [регионов,](https://docs.microsoft.com/azure/aks/quotas-skus-regions) которые поддерживает AKS. Переход от существующего кластера к AKS может потребовать изменения существующих приложений, чтобы они оставались здоровыми на плоскости управления AKS.

Мы рекомендуем использовать кластеры AKS, поддерживаемые [наборами виртуальной шкалы машин](https://docs.microsoft.com/azure/virtual-machine-scale-sets) и [балансом стандартной нагрузки Azure,](https://docs.microsoft.com/azure/aks/load-balancer-standard) чтобы гарантировать, что вы получите такие функции, как [пулы нескольких узлов,](https://docs.microsoft.com/azure/aks/use-multiple-node-pools) [зоны доступности,](https://docs.microsoft.com/azure/availability-zones/az-overview) [авторизованные диапазоны IP,](https://docs.microsoft.com/azure/aks/api-server-authorized-ip-ranges) [кластер Autoscaler,](https://docs.microsoft.com/azure/aks/cluster-autoscaler) [Политика Azure для AKS](https://docs.microsoft.com/azure/governance/policy/concepts/rego-for-aks)и другие новые функции по мере их выпуска.

Кластеры AKS, поддерживаемые [наборами доступности виртуальных машин,](https://docs.microsoft.com/azure/virtual-machine-scale-sets/availability#availability-sets) не поддерживают многие из этих функций.

Следующий пример создает кластер AKS с пулом одного узла, опирающийся на виртуальный набор масштабов машины. Он использует стандартный балансера нагрузки. Он также позволяет кластера autoscaler на пул узла для кластера и устанавливает не менее *1* и максимум *3* узла:

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location eastus

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --vm-set-type VirtualMachineScaleSets \
  --load-balancer-sku standard \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

## <a name="existing-attached-azure-services"></a>Существующие присоединенные службы Azure

При миграции кластеров могут быть прикреплены внешние службы Azure. Они не требуют ресурсного отдыха, но для поддержания функциональности потребуется обновление соединений от предыдущих до новых кластеров.

* Реестр контейнеров Azure
* Log Analytics
* Application Insights
* Диспетчер трафика
* Учетная запись хранения
* Внешние базы данных

## <a name="ensure-valid-quotas"></a>Обеспечить действительные квоты

Так как дополнительные виртуальные машины будут развернуты в рамках подписки во время миграции, следует убедиться, что квоты и ограничения достаточны для этих ресурсов. Возможно, вам придется запросить увеличение [квоты vCPU.](https://docs.microsoft.com/azure/azure-portal/supportability/per-vm-quota-requests)

Возможно, вам придется запросить увеличение [для сетевых квот,](https://docs.microsoft.com/azure/azure-portal/supportability/networking-quota-requests) чтобы убедиться, что вы не исчерпаете ИП. Дополнительную информацию можно узнать [о сетевых и IP-диапазонах для AKS.](https://docs.microsoft.com/azure/aks/configure-kubenet)

Для получения дополнительной информации смотрите [ограничения подписки и обслуживания Azure.](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits) Чтобы проверить текущие квоты, на портале Azure перейдите на [лезвие подписки,](https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade)выберите подписку, а затем выберите **квоты «Использование и**использование».

## <a name="high-availability-and-business-continuity"></a>Высокая доступность и непрерывность бизнеса

Если приложение не может справиться со временем простоя, вам необходимо следовать рекомендациям для сценариев миграции с высокой доступностью.  Рекомендации по комплексу планирования непрерывности бизнеса, аварийному восстановлению и максимизации времени простоя выходят за рамки данного документа.  Узнайте больше о [рекомендациях по непрерывности бизнеса и аварийному восстановлению в службе Azure Kubernetes Service (AKS),](https://docs.microsoft.com/azure/aks/operator-best-practices-multi-region) чтобы узнать больше.

Миграция сложных приложений обычно выполняется в течение некоторого времени, а не одномоментно. Это означает, что старые и новые среды, возможно, потребуется общаться по сети. Приложения, которые `ClusterIP` ранее использовали службы для `LoadBalancer` связи, возможно, должны быть подвержены как тип и защищены надлежащим образом.

Чтобы завершить миграцию, необходимо указать клиентам на новые службы, работающие на AKS. Мы рекомендуем перенаправить трафик, обновив DNS, чтобы указать на балансер нагрузки, который находится перед кластером AKS.

[Менеджер azure Traffic](https://docs.microsoft.com/azure/traffic-manager/) может направлять клиентов в нужный экземпляр кластера и приложения Kubernetes.  Диспетчер трафика — это балансер нагрузки трафика на основе DNS, который может распределять сетевой трафик по регионам.  Для наилучшей производительности и избыточности направьте весь трафик приложений через traffic Manager, прежде чем он перейдет в кластер AKS.  В развертывании нескольких кластеров клиенты должны подключиться к имени DNS-менеджера трафика, которое указывает на службы в каждом кластере AKS. Определите эти службы с помощью конечных точек traffic Manager. Каждая конечная точка является *IP-адресом баланса нагрузки на службу.* Используйте эту конфигурацию для направления сетевого трафика из конечных точек менеджера трафика в одном регионе в конечную точку в другом регионе.

![AKS с менеджером по трафику](media/operator-best-practices-bc-dr/aks-azure-traffic-manager.png)

[Служба передних дверей Azure](https://docs.microsoft.com/azure/frontdoor/front-door-overview) — еще один вариант для движения трафика для кластеров AKS.  Azure Front Door Service позволяет определять, управлять и отслеживать глобальную маршрутизацию для вашего веб-трафика посредством оптимизации для обеспечения наилучшей производительности и мгновенной глобальной отработки отказа для обеспечения высокой доступности. 

### <a name="considerations-for-stateless-applications"></a>Рассмотрение заявлений без гражданства

Перенос приложений без отслеживания состояния — это самый простой случай. Примените определения ресурсов (YAML или Helm) к новому кластеру, убедитесь, что все работает как ожидалось, и перенаправьте трафик для активации нового кластера.

### <a name="considerations-for-stateful-applications"></a>Рассмотрение приложений с состоянием

Тщательно спланируйте миграцию приложений с состоянием, чтобы избежать потери данных или непредвиденных простоев.

При использовании файлов Azure можно смонтировать общий объем файла в виде объема в новый кластер:
* [Маунт Статические лазурные файлы как объем](https://docs.microsoft.com/azure/aks/azure-files-volume#mount-the-file-share-as-a-volume)

Если вы используете управляемые диски Azure, вы можете смонтировать диск только в том случае, если он не привязан к любому VM:
* [Маунт Статический Azure диск как объем](https://docs.microsoft.com/azure/aks/azure-disk-volume#mount-disk-as-volume)

Если ни один из этих подходов не работает, можно использовать резервные и восстановительные варианты:
* [Велеро на Лазурном берегу](https://github.com/heptio/velero/blob/master/site/docs/master/azure-config.md)

#### <a name="azure-files"></a>Файлы Azure

В отличие от дисков, файлы Azure можно одновременно подключить к нескольким узлам. В кластере AKS Azure и Kubernetes не помешают создать стручок, который по-прежнему использует кластер ACS. Чтобы предотвратить потерю данных и неожиданное поведение, убедитесь, что кластеры не пишут сятам в одни и те же файлы одновременно.

Если приложение может размещать несколько реплик, указывать на одну и ту же общую каши, следуйте шагам миграции без состояния и развертывайте определения YAML в новый кластер. В противном случае для миграции возможен следующий порядок действий.

* Проверка приложения работает правильно.
* Направьте живой трафик на новый кластер AKS.
* Отключите старое скопление.

Если вы хотите начать с пустой доли и сделать копию [`az storage file copy`](https://docs.microsoft.com/cli/azure/storage/file/copy?view=azure-cli-latest) исходных данных, можно использовать команды для переноса данных.


#### <a name="migrating-persistent-volumes"></a>Миграция постоянных объемов

Если вы переимаете существующие постоянные тома в AKS, вы, как правило, следуете следующим шагам:

* Квисс пишет в заявку. (Этот шаг является необязательным и требует простоя.)
* Сфотографать диски.
* Создание новых управляемых дисков из снимков.
* Создавайте постоянные объемы в AKS.
* Обновление спецификаций стручка для [использования существующих томов,](https://docs.microsoft.com/azure/aks/azure-disk-volume) а не persistentVolumeClaims (статическое подготовка).
* Развертывание приложения в AKS.
* Проверка приложения работает правильно.
* Направьте живой трафик на новый кластер AKS.

> [!IMPORTANT]
> Если вы решите не затихать записи, вам нужно будет воспроизвести данные в новое развертывание. В противном случае вы пропустите данные, которые были написаны после того, как вы сделали снимки диска.

Некоторые инструменты с открытым исходным кодом могут помочь вам создавать управляемые диски и мигрировать объемы между кластерами Kubernetes:

* [Расширение расширения Azure CLI Disk Copy](https://github.com/noelbundick/azure-cli-disk-copy-extension) копирует и преобразует диски в группах ресурсов и регионах Azure.
* [Расширение Azure Kube CLI](https://github.com/yaron2/azure-kube-cli) перечисляет объемы ACS Kubernetes и переносит их в кластер AKS.


### <a name="deployment-of-your-cluster-configuration"></a>Развертывание конфигурации кластера

Мы рекомендуем использовать существующий конвейер непрерывной интеграции (CI) и непрерывной доставки (CD) для развертывания известной хорошей конфигурации для AKS. Для создания и развертывания [приложений в AKS](https://docs.microsoft.com/azure/devops/pipelines/ecosystems/kubernetes/aks-template?view=azure-devops)можно использовать конвейеры Azure. Клонируйте существующие задачи развертывания `kubeconfig` и убедитесь, что укажите на новый кластер AKS.

Если это невозможно, экспортные определения ресурсов из существующего кластера Kubernetes, а затем применить их к AKS. Для экспорта объектов можно использовать `kubectl`.

```console
kubectl get deployment -o=yaml --export > deployments.yaml
```

### <a name="moving-existing-resources-to-another-region"></a>Перемещение имеющихся ресурсов в другой регион

Возможно, необходимо переместить кластер AKS в [другой регион, поддерживаемый AKS.][region-availability] Мы рекомендуем создать новый кластер в другом регионе, а затем развернуть ресурсы и приложения в новый кластер. Кроме того, если в кластере AKS работают такие службы, как [Azure Dev Spaces,][azure-dev-spaces] вам также необходимо установить и настроить эти службы в кластере в новом регионе.


В этой статье мы обобщили детали миграции для:

> [!div class="checklist"]
> * AKS со стандартной нагрузкой балансизатор и виртуальные наборы шкалы машин
> * Существующие присоединенные службы Azure
> * Обеспечить действительные квоты
> * Высокая доступность и непрерывность бизнеса
> * Рассмотрение заявлений без гражданства
> * Рассмотрение приложений с состоянием
> * Развертывание конфигурации кластера


[region-availability]: https://azure.microsoft.com/global-infrastructure/services/?products=kubernetes-service
[azure-dev-spaces]: https://docs.microsoft.com/azure/dev-spaces/