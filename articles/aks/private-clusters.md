---
title: Создание частного кластера служб Azure Kubernetes
description: Узнайте, как создать частный кластер Azure Kubernetes Service (AKS)
services: container-service
ms.topic: article
ms.date: 2/21/2020
ms.openlocfilehash: 87f52c5a749b531e5b0656e0b30ff0fe9c1a57bf
ms.sourcegitcommit: 632e7ed5449f85ca502ad216be8ec5dd7cd093cb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2020
ms.locfileid: "80398047"
---
# <a name="create-a-private-azure-kubernetes-service-cluster"></a>Создание частного кластера служб Azure Kubernetes

В частном кластере плоскость управления или сервер API имеет внутренние IP-адреса, которые определены в [документе RFC1918 - Адрес ночл.](https://tools.ietf.org/html/rfc1918) Используя частный кластер, можно гарантировать, что сетевой трафик между сервером API и пулами узлов остается только в частной сети.

Диспетчерская плоскость или сервер API находится в подконтрольной Azure Kubernetes Service (AKS). Кластер или пул узлов клиента находится в подписке клиента. Сервер и кластер или пул узлов могут общаться друг с другом через [службу Azure Private Link][private-link-service] в виртуальной сети сервера API и частную конечную точку, которая выставлена в подсети кластера AKS клиента.

## <a name="prerequisites"></a>Предварительные требования

* Версия Azure CLI 2.2.0 или позже

## <a name="create-a-private-aks-cluster"></a>Создание частного кластера AKS

### <a name="create-a-resource-group"></a>Создание группы ресурсов

Создайте группу ресурсов или используйте существующую группу ресурсов для кластера AKS.

```azurecli-interactive
az group create -l westus -n MyResourceGroup
```

### <a name="default-basic-networking"></a>Основные сети по умолчанию 

```azurecli-interactive
az aks create -n <private-cluster-name> -g <private-cluster-resource-group> --load-balancer-sku standard --enable-private-cluster  
```
Где *--включить-частный кластер* является обязательным флагом для частного кластера. 

### <a name="advanced-networking"></a>Сетевое взаимодействие уровня "Расширенный"  

```azurecli-interactive
az aks create \
    --resource-group <private-cluster-resource-group> \
    --name <private-cluster-name> \
    --load-balancer-sku standard \
    --enable-private-cluster \
    --network-plugin azure \
    --vnet-subnet-id <subnet-id> \
    --docker-bridge-address 172.17.0.1/16 \
    --dns-service-ip 10.2.0.10 \
    --service-cidr 10.2.0.0/24 
```
Где *--включить-частный кластер* является обязательным флагом для частного кластера. 

> [!NOTE]
> Если докерский мост адрес CIDR (172.17.0.1/16) столкновения с подсетью CIDR, изменить адрес моста Докер соответствующим образом.

## <a name="options-for-connecting-to-the-private-cluster"></a>Варианты подключения к частному кластеру

Конечная точка сервера API не имеет общедоступного IP-адреса. Для управления сервером API необходимо использовать VM, который имеет доступ к виртуальной сети Azure (VNet) кластера AKS. Существует несколько вариантов подключения к частному кластеру.

* Создайте VM в той же виртуальной сети Azure (VNet), что и кластер AKS.
* Используйте VM в отдельной сети и настроить [виртуальную сеть пиринга.][virtual-network-peering]  Более подробную информацию об этой опции можно узнать в разделе ниже.
* Используйте [экспресс-маршрут или VPN соединение.][express-route-or-VPN]

Создание VM в том же VNET, что и кластер AKS, является самым простым вариантом.  Экспресс-маршрут и VPN добавляют затраты и требуют дополнительной сложности сетей.  Виртуальная сеть пиринга требует от вас планировать свои диапазоны CIDR сети, чтобы убедиться, что нет перекрывающихся диапазонов.

## <a name="virtual-network-peering"></a>Пиринг между виртуальными сетями

Как уже упоминалось, вглядывание VNet является одним из способов доступа к вашему частному кластеру. Для использования вонючения VNet необходимо настроить связь между виртуальной сетью и частной зоной DNS.
    
1. Перейдите в группу ресурсов MC_ на портале Azure.  
2. Выберите частную зону DNS.   
3. В левом стеле выберите **виртуальную сетевую** ссылку.  
4. Создайте новую ссылку для добавления виртуальной сети VM в частную зону DNS. Ссылка на зону DNS занимает несколько минут.  
5. Вернитесь к группе ресурсов MC_ на портале Azure.  
6. В правильном стеку выберите виртуальную сеть. Виртуальное название сети в виде *aks-vnet-\**.  
7. В левой панели выберите **Peerings**.  
8. Выберите **Добавить,** добавить виртуальную сеть VM, а затем создать пиринг.  
9. Перейдите в виртуальную сеть, где у вас есть VM, выберите **Peerings**, выберите виртуальную сеть AKS, а затем создать пиринг. Если адрес колеблется в виртуальной сети AKS и столкновение виртуальной сети VM, пиринг выходит из строя. Для получения дополнительной информации, см [Виртуальная сеть пиринг][virtual-network-peering].

## <a name="hub-and-spoke-with-custom-dns"></a>Концентратор и говорил с пользовательскими DNS

[Архитектуры концентраторов и спиноков](https://docs.microsoft.com/azure/architecture/reference-architectures/hybrid-networking/hub-spoke) обычно используются для развертывания сетей в Azure. Во многих из этих развертываний настройки DNS в спинце VNets настроены для ссылки на центральный передовик DNS для разрешения DNS на основе помещения и Azure. При развертывании кластера AKS в такой сетевой среде необходимо учитывать некоторые особые соображения.

![Частный кластерный центр и говорил](media/private-clusters/aks-private-hub-spoke.png)

1. По умолчанию при подготовке частного кластера в группе управляемых ресурсов кластера создаются частная конечная точка (1) и частная зона DNS (2). Кластер использует запись A в частной зоне для решения IP частной конечной точки для связи с сервером API.

2. Частная зона DNS связана только с VNet, к которым прикрепляются кластерные узлы (3). Это означает, что частная конечная точка может быть решена только хостами в связанном VNet. В сценариях, где нет пользовательских DNS настроен на VNet (по умолчанию), это работает без проблемы, как хосты точки на 168.63.129.16 для DNS, которые могут решать записи в частной зоне DNS из-за ссылки.

3. В сценариях, где VNet, содержащий кластер, имеет пользовательские настройки DNS (4), развертывание кластера не удается, если частная зона DNS не подключена к VNet, которая содержит пользовательские DNS-разрешители (5). Эта ссылка может быть создана вручную после создания частной зоны во время кластерного подготовки или с помощью автоматизации при обнаружении создания зоны с использованием политики Azure или других механизмов развертывания событий (например, Azure Event Grid и Azure Functions).

## <a name="dependencies"></a>Зависимости  

* Служба Private Link поддерживается только на балансе Standard Azure Load Balancer. Базовый балансировка загрузки Azure не поддерживается.  
* Чтобы использовать пользовательский DNS-сервер, добавьте Azure DNS IP 168.63.129.16 в качестве сервера DNS на пользовательском DNS-сервере.

## <a name="limitations"></a>Ограничения 
* Диапазоны IP-насох не могут быть применены к частной конечной точке сервера Api, они применяются только к общедоступному серверу API
* Зоны доступности в настоящее время поддерживаются для некоторых регионов, см. начало этого документа 
* [Ограничения службы обслуживания Azure Private Link][private-link-service] применяются к частным кластерам, частным конечным точкам Azure и конечным точкам виртуальных сетевых служб, которые в настоящее время не поддерживаются в одной виртуальной сети.
* Отсутствие поддержки виртуальных узлов в частном кластере для вращения частных контейнерных инстанций Azure (ACI) в частной виртуальной сети Azure
* Нет поддержки интеграции Azure DevOps из коробки с частными кластерами
* Для клиентов, которым необходимо включить реестр контейнеров Azure для работы с частными AKS, виртуальная сеть контейнерного реестра должна быть внедочена с виртуальной сетью кластера агентов.
* Нет текущей поддержки пространстваAzры Дев
* Отсутствие поддержки для преобразования существующих кластеров AKS в частные кластеры
* Удализация или изменение частной конечных точек в подсети клиента приведет к тому, что кластер перестанет функционировать. 
* Azure Monitor для контейнеров Live Data в настоящее время не поддерживается.


<!-- LINKS - internal -->
[az-provider-register]: /cli/azure/provider?view=azure-cli-latest#az-provider-register
[az-feature-list]: /cli/azure/feature?view=azure-cli-latest#az-feature-list
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[private-link-service]: /azure/private-link/private-link-service-overview
[virtual-network-peering]: ../virtual-network/virtual-network-peering-overview.md
[azure-bastion]: ../bastion/bastion-create-host-portal.md
[express-route-or-vpn]: ../expressroute/expressroute-about-virtual-network-gateways.md

