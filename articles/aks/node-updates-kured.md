---
title: Обновить и перезагрузить узлы Linux с помощью kured в службе Azure Kubernetes (AKS)
description: Узнайте, как обновить узлы Linux и автоматически перезагружать с kured в службе Azure Kubernetes (AKS)
services: container-service
author: mlearned
ms.service: container-service
ms.topic: article
ms.date: 02/28/2019
ms.author: mlearned
ms.openlocfilehash: 580d1316c2bfc6514a148ed6fba78a8e77bd880e
ms.sourcegitcommit: 6a42dd4b746f3e6de69f7ad0107cc7ad654e39ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/07/2019
ms.locfileid: "67614910"
---
# <a name="apply-security-and-kernel-updates-to-linux-nodes-in-azure-kubernetes-service-aks"></a>Применение параметров безопасности и обновлений ядра к узлам Linux в службе Azure Kubernetes (AKS)

Для защиты кластеров, обновления безопасности автоматически применяются к узлам Linux в AKS. Учитываются такие обновления, как исправления безопасности для операционной системы и обновления ядра. Чтобы завершить установку некоторых обновлений, нужно перезагрузить узел. AKS не автоматической перезагрузке эти узлы Linux для завершения процесса обновления.

Процесс обновления узлов Windows Server (в настоящее время в предварительной версии в AKS) немного отличается. Узлы Windows Server, не получают ежедневных обновлений. Вместо этого вы выполните обновление AKS, который развертывает новые узлы, последний базовый образ Windows Server и исправления. AKS кластеры, использующие узлов Windows Server, см. в разделе [обновить пуле узел в AKS][nodepool-upgrade].

В этой статье показано, как использовать с открытым кодом [kured (управляющая программа перезагрузки KUbernetes)][kured] для просмотра узлов Linux, которые требуют перезагрузки, а затем автоматически обрабатывать изменения расписания выполнения модулей и узел перезагрузите процесса.

> [!NOTE]
> `Kured` создается как проект Weaveworks с открытым кодом. Поддержка для этого проекта в AKS предоставляется только по мере возможности. Дополнительная поддержка можно найти в канал slack #weave сообщества.

## <a name="before-you-begin"></a>Перед началом работы

В этой статье предполагается, что у вас есть кластер AKS. Если вам нужен кластер AKS, см. в этом кратком руководстве AKS [с помощью Azure CLI][aks-quickstart-cli] or [using the Azure portal][aks-quickstart-portal].

Вам также понадобится Azure CLI версии 2.0.59 или более поздней версии установлен и настроен. Чтобы узнать версию, выполните команду  `az --version`. Если требуется выполнить установку или обновление, см. в разделе [установить Azure CLI][install-azure-cli].

## <a name="understand-the-aks-node-update-experience"></a>Основные сведения об обновлении узла AKS

В кластере AKS узлы Kubernetes выполняются на виртуальных машинах Azure. Эти виртуальные машины под управлением Linux создаются на основе образа Ubuntu. В операционной системе настраивается автоматическая проверка наличия обновлений, выполняющаяся каждую ночь. Все доступные обновления безопасности или ядра скачиваются и устанавливаются автоматически.

![Процесс обновления и перезагрузка узла AKS с помощью kured](media/node-updates-kured/node-reboot-process.png)

Чтобы завершить установку некоторых обновлений системы безопасности, например обновлений ядра, нужно перезагрузить узел. Узел Linux, требующее перезагрузки создает файл с именем */var/run/reboot-required*. При этом перезагрузка не выполняется автоматически.

Вы можете использовать собственные рабочие процессы и системы для обработки запросов на перезагрузку узла или оркестрировать этот процесс с помощью `kured`. С помощью `kured`, [DaemonSet][DaemonSet] развертывается, запускает pod на каждом узле Linux в кластере. Эти группы pod, которые запускает DaemonSet, проверяют наличие файла */var/run/reboot-required* и при его обнаружении запускают перезагрузку узла.

### <a name="node-upgrades"></a>Обновления узлов

В AKS есть специальный дополнительный процесс для *обновления* кластера. Обычно обновление подразумевает переход на новую версию Kubernetes, а не просто обновления безопасности для узла. При обновлении AKS выполняются следующие действия:

* развертывание нового узла со всеми последними обновлениями безопасности и новой версией Kubernetes;
* блокировка старого узла и остановка процессов на нем;
* назначение выполнения pod на новом узле;
* удаление старого узла.

При обработке события обновления нельзя сохранить старую версию Kubernetes. Необходимо указать более новую версию Kubernetes. Чтобы обновить до последней версии Kubernetes, вы можете [обновление кластера AKS][aks-upgrade].

## <a name="deploy-kured-in-an-aks-cluster"></a>Развертывание kured в кластере AKS

Чтобы развернуть `kured` DaemonSet, примените приведенный ниже манифест в формате YAML, который мы взяли со страницы проекта на GitHub. Этот манифест позволяет создать роль и роль кластера, привязки и учетную запись службы, а затем развертывает DaemonSet с помощью `kured` версии 1.1.0, которая поддерживает кластеры AKS 1.9 и более поздней версии.

```console
kubectl apply -f https://github.com/weaveworks/kured/releases/download/1.2.0/kured-1.2.0-dockerhub.yaml
```

Также вы можете настроить дополнительные параметры для `kured`, например интеграцию с Prometheus или Slack. Дополнительные сведения о Дополнительные параметры конфигурации, см. в разделе [kured установки документация][kured-install].

## <a name="update-cluster-nodes"></a>Обновление узлов кластера

По умолчанию узлы Linux в AKS проверять наличие обновлений каждый вечер. Если вы не хотите ждать, обновление можно запустить вручную и убедиться, что `kured` выполняется правильно. Во-первых, выполните действия, чтобы [SSH к одному из узлов AKS][aks-ssh]. Получив SSH-подключение к узлу Linux, проверять наличие обновлений и применить их следующим образом:

```console
sudo apt-get update && sudo apt-get upgrade -y
```

Если эти обновления требуют перезагрузки узла, создается файл */var/run/reboot-required*. По умолчанию `Kured` каждые 60 минут проверяет наличие узлов, которые требуют перезагрузки.

## <a name="monitor-and-review-reboot-process"></a>Мониторинг и проверка процесса перезагрузки

Если одна из реплик DaemonSet определит, что узлу требуется перезагрузка, к этому узлу применяется блокировка через API Kubernetes. Такая блокировка запрещает размещение на этом узле дополнительных групп pod. Также блокировка гарантирует, что за один раз перезагружается только один узел. После применения блокировки на этом узле постепенно завершается выполнение всех групп pod, а затем узел перезагружается.

Можно отслеживать состояние узлов, с использованием [kubectl получить узлы][kubectl-get-nodes] команды. В следующем примере выходных данных показан узел с состоянием *SchedulingDisabled*, который готовится к процессу перезагрузки:

```
NAME                       STATUS                     ROLES     AGE       VERSION
aks-nodepool1-28993262-0   Ready,SchedulingDisabled   agent     1h        v1.11.7
```

После завершения процесса обновления можно просмотреть состояние узлов, с помощью [kubectl получить узлы][kubectl-get-nodes] с `--output wide` параметра. В представленной ниже новой версии выходных данных вы можете заметить разницу в значениях *KERNEL-VERSION* для базовых узлов. *Aks-nodepool1-28993262-0* была обновлена в предыдущем шаге и отображается версия ядра *4.15.0-1039-azure*. Узел *aks-nodepool1-28993262-1* , не был обновленные отображается версия ядра *4.15.0-1037-azure*.

```
NAME                       STATUS    ROLES     AGE       VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
aks-nodepool1-28993262-0   Ready     agent     1h        v1.11.7   10.240.0.4    <none>        Ubuntu 16.04.6 LTS   4.15.0-1039-azure   docker://3.0.4
aks-nodepool1-28993262-1   Ready     agent     1h        v1.11.7   10.240.0.5    <none>        Ubuntu 16.04.6 LTS   4.15.0-1037-azure   docker://3.0.4
```

## <a name="next-steps"></a>Следующие шаги

В этой статье описывается, как использовать `kured` для перезагрузки узлов Linux автоматически в рамках процесса обновления безопасности. Чтобы обновить до последней версии Kubernetes, вы можете [обновление кластера AKS][aks-upgrade].

AKS кластеры, использующие узлов Windows Server, см. в разделе [обновить пуле узел в AKS][nodepool-upgrade].

<!-- LINKS - external -->
[kured]: https://github.com/weaveworks/kured
[kured-install]: https://github.com/weaveworks/kured#installation
[kubectl-get-nodes]: https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[DaemonSet]: concepts-clusters-workloads.md#statefulsets-and-daemonsets
[aks-ssh]: ssh.md
[aks-upgrade]: upgrade-cluster.md
[nodepool-upgrade]: use-multiple-node-pools.md#upgrade-a-node-pool
