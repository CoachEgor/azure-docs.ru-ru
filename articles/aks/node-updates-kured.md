---
title: Обновление и перезагрузка узлов с помощью kured в Службе Azure Kubernetes (AKS)
description: Сведения об обновлении и автоматической перезагрузке узлов с помощью kured в Службе Azure Kubernetes (AKS)
services: container-service
author: iainfoulds
ms.service: container-service
ms.topic: article
ms.date: 02/28/2019
ms.author: iainfou
ms.openlocfilehash: 75057f6bd92fbdc805da2e0e36dc2bff7b069f26
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60465006"
---
# <a name="apply-security-and-kernel-updates-to-nodes-in-azure-kubernetes-service-aks"></a>Применение обновлений безопасности и ядра для узлов в Службе Azure Kubernetes (AKS)

Для защиты кластеров к их узлам в службе AKS автоматически применяются обновления безопасности. Учитываются такие обновления, как исправления безопасности для операционной системы и обновления ядра. Чтобы завершить установку некоторых обновлений, нужно перезагрузить узел. AKS не выполняет автоматическую перезагрузку для завершения обновления.

В этой статье показано, как применить средство с открытым кодом [kured (KUbernetes REboot Daemon — управляющая программа Kubernetes для перезагрузки)][kured] для отслеживания узлов, которые нужно перезагрузить, и автоматической корректировки расписания для перезагрузки выполняемых pod и узлов.

> [!NOTE]
> `Kured` создается как проект Weaveworks с открытым кодом. Поддержка для этого проекта в AKS предоставляется только по мере возможности. Дополнительную поддержку вы можете получить в канале slack #weave-community.

## <a name="before-you-begin"></a>Перед началом работы

В этой статье предполагается, что у вас есть кластер AKS. Если вам нужен кластер AKS, обратитесь к этому краткому руководству по работе с AKS [с помощью Azure CLI][aks-quickstart-cli] или [портала Azure][aks-quickstart-portal].

Вам также понадобится Azure CLI версии 2.0.59 или более поздней версии установлен и настроен. Чтобы узнать версию, выполните команду  `az --version`. Если вам необходимо выполнить установку или обновление, см. статью  [Установка Azure CLI][install-azure-cli].

## <a name="understand-the-aks-node-update-experience"></a>Основные сведения об обновлении узла AKS

В кластере AKS узлы Kubernetes выполняются на виртуальных машинах Azure. Эти виртуальные машины под управлением Linux создаются на основе образа Ubuntu. В операционной системе настраивается автоматическая проверка наличия обновлений, выполняющаяся каждую ночь. Все доступные обновления безопасности или ядра скачиваются и устанавливаются автоматически.

![Процесс обновления и перезагрузка узла AKS с помощью kured](media/node-updates-kured/node-reboot-process.png)

Чтобы завершить установку некоторых обновлений системы безопасности, например обновлений ядра, нужно перезагрузить узел. На узле, который нужно перезагрузить, создается файл с именем */var/run/reboot-required*. При этом перезагрузка не выполняется автоматически.

Вы можете использовать собственные рабочие процессы и системы для обработки запросов на перезагрузку узла или оркестрировать этот процесс с помощью `kured`. Для использования `kured` развертывается [DaemonSet][DaemonSet], который выполняет pod на каждом узле в кластере. Эти группы pod, которые запускает DaemonSet, проверяют наличие файла */var/run/reboot-required* и при его обнаружении запускают перезагрузку узла.

### <a name="node-upgrades"></a>Обновления узлов

В AKS есть специальный дополнительный процесс для *обновления* кластера. Обычно обновление подразумевает переход на новую версию Kubernetes, а не просто обновления безопасности для узла. При обновлении AKS выполняются следующие действия:

* развертывание нового узла со всеми последними обновлениями безопасности и новой версией Kubernetes;
* блокировка старого узла и остановка процессов на нем;
* назначение выполнения pod на новом узле;
* удаление старого узла.

При обработке события обновления нельзя сохранить старую версию Kubernetes. Необходимо указать более новую версию Kubernetes. Чтобы перейти на последнюю версию Kubernetes, вы можете [обновить кластер AKS][aks-upgrade].

## <a name="deploy-kured-in-an-aks-cluster"></a>Развертывание kured в кластере AKS

Чтобы развернуть `kured` DaemonSet, примените приведенный ниже манифест в формате YAML, который мы взяли со страницы проекта на GitHub. Этот манифест позволяет создать роль и роль кластера, привязки и учетную запись службы, а затем развертывает DaemonSet с помощью `kured` версии 1.1.0, которая поддерживает кластеры AKS 1.9 и более поздней версии.

```console
kubectl apply -f https://github.com/weaveworks/kured/releases/download/1.1.0/kured-1.1.0.yaml
```

Также вы можете настроить дополнительные параметры для `kured`, например интеграцию с Prometheus или Slack. Дополнительные сведения об этих параметрах конфигурации см. в [документации по установке kured][kured-install].

## <a name="update-cluster-nodes"></a>Обновление узлов кластера

По умолчанию узлы AKS проверяют наличие обновлений каждый вечер. Если вы не хотите ждать, обновление можно запустить вручную и убедиться, что `kured` выполняется правильно. Сначала установите [подключение по SSH к одному из узлов AKS][aks-ssh]. Создав SSH-подключение к узлу, проверьте наличие обновлений и примените их следующим образом:

```console
sudo apt-get update && sudo apt-get upgrade -y
```

Если эти обновления требуют перезагрузки узла, создается файл */var/run/reboot-required*. По умолчанию `Kured` каждые 60 минут проверяет наличие узлов, которые требуют перезагрузки.

## <a name="monitor-and-review-reboot-process"></a>Мониторинг и проверка процесса перезагрузки

Если одна из реплик DaemonSet определит, что узлу требуется перезагрузка, к этому узлу применяется блокировка через API Kubernetes. Такая блокировка запрещает размещение на этом узле дополнительных групп pod. Также блокировка гарантирует, что за один раз перезагружается только один узел. После применения блокировки на этом узле постепенно завершается выполнение всех групп pod, а затем узел перезагружается.

Состояние узлов можно отслеживать с помощью команды [kubectl get nodes][kubectl-get-nodes]. В следующем примере выходных данных показан узел с состоянием *SchedulingDisabled*, который готовится к процессу перезагрузки:

```
NAME                       STATUS                     ROLES     AGE       VERSION
aks-nodepool1-28993262-0   Ready,SchedulingDisabled   agent     1h        v1.11.7
```

После обновления вы можете проверить состояние узлов с помощью команды [kubectl get nodes][kubectl-get-nodes] с параметром `--output wide`. В представленной ниже новой версии выходных данных вы можете заметить разницу в значениях *KERNEL-VERSION* для базовых узлов. *Aks-nodepool1-28993262-0* была обновлена в предыдущем шаге и отображается версия ядра *4.15.0-1039-azure*. Узел *aks-nodepool1-28993262-1* , не был обновленные отображается версия ядра *4.15.0-1037-azure*.

```
NAME                       STATUS    ROLES     AGE       VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
aks-nodepool1-28993262-0   Ready     agent     1h        v1.11.7   10.240.0.4    <none>        Ubuntu 16.04.6 LTS   4.15.0-1039-azure   docker://3.0.4
aks-nodepool1-28993262-1   Ready     agent     1h        v1.11.7   10.240.0.5    <none>        Ubuntu 16.04.6 LTS   4.15.0-1037-azure   docker://3.0.4
```

## <a name="next-steps"></a>Дальнейшие действия

В этой статье описано использование `kured` для автоматической перезагрузки узлов при применении обновлений безопасности. Чтобы перейти на последнюю версию Kubernetes, вы можете [обновить кластер AKS][aks-upgrade].

<!-- LINKS - external -->
[kured]: https://github.com/weaveworks/kured
[kured-install]: https://github.com/weaveworks/kured#installation
[kubectl-get-nodes]: https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get

<!-- LINKS - internal -->
[aks-quickstart-cli]: kubernetes-walkthrough.md
[aks-quickstart-portal]: kubernetes-walkthrough-portal.md
[install-azure-cli]: /cli/azure/install-azure-cli
[DaemonSet]: concepts-clusters-workloads.md#statefulsets-and-daemonsets
[aks-ssh]: ssh.md
[aks-upgrade]: upgrade-cluster.md
