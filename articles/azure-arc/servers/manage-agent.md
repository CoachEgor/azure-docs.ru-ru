---
title: Управление агентом Azure ARC для серверов (Предварительная версия)
description: В этой статье описываются различные задачи управления, которые обычно выполняются в течение жизненного цикла службы "Дуга" для сервера, подключенного к компьютеру, на котором выполняется агент.
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-servers
author: mgoedtel
ms.author: magoedte
ms.date: 04/14/2020
ms.topic: conceptual
ms.openlocfilehash: 5ad2127b4cb9da3ca83aa04bd1885908a88dba62
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81308970"
---
# <a name="managing-and-maintaining-the-connected-machine-agent"></a>Управление агентом подключенного компьютера и его обслуживание

После первоначального развертывания службы "Дуга Azure для серверов (Предварительная версия)" на компьютере под управлением Windows или Linux может потребоваться перенастроить агент, обновить его или удалить с компьютера, если он достиг этапа прекращения использования в его жизненном цикле. Вы можете легко управлять этими задачами обслуживания вручную или автоматизировать этот процесс, сократив при этом эксплуатационные расходы и количество ошибок.

## <a name="upgrading-agent"></a>Обновление агента

Агент Azure Connected Machine для Windows и Linux можно обновить до последней версии вручную или автоматически в зависимости от требований. В следующей таблице описаны методы, поддерживаемые при обновлении агента.

| Операционная система | Метод перехода |
|------------------|----------------|
| Windows | Вручную<br> Центр обновления Windows |
| Ubuntu | [APT](https://help.ubuntu.com/lts/serverguide/apt.html) |
| SUSE Linux Enterprise Server | [zypper](https://en.opensuse.org/SDB:Zypper_usage_11.3) |
| RedHat Enterprise, Amazon, CentOS Linux | [Yum](https://wiki.centos.org/PackageManagement/Yum) | 

### <a name="windows-agent"></a>Агент Windows

Чтобы обновить агент на компьютере Windows до последней версии, агент доступен из Центр обновления Майкрософт и может быть развернут с помощью существующего процесса управления обновлениями программного обеспечения. Его также можно запустить вручную из командной строки, из скрипта или другого решения по автоматизации или из мастера пользовательского интерфейса, выполнив `AzureConnectedMachine.msi`команду. 

> [!NOTE]
> * Для обновления агента необходимо иметь разрешения *администратора* .
> * Для обновления вручную необходимо сначала загрузить и скопировать пакет установщика в папку на целевом сервере или в общей сетевой папке. 

Если вы не знакомы с параметрами командной строки для пакетов установщик Windows, ознакомьтесь со [стандартными параметрами командной строки Msiexec](https://docs.microsoft.com/windows/win32/msi/standard-installer-command-line-options) и [параметрами командной строки Msiexec](https://docs.microsoft.com/windows/win32/msi/command-line-options).

#### <a name="to-upgrade-using-the-setup-wizard"></a>Обновление с помощью мастера установки

1. Войдите в систему компьютера, используя учетную запись с правами администратора.

2. Выполните **азуреконнектедмачинеажент. msi** , чтобы запустить мастер установки.

Мастер установки обнаруживает, существует ли предыдущая версия, а затем автоматически выполняет обновление агента. После завершения обновления мастер установки автоматически закроется.

#### <a name="to-upgrade-from-the-command-line"></a>Обновление с помощью командной строки

1. Войдите в систему компьютера, используя учетную запись с правами администратора.

2. Чтобы автоматически обновить агент и создать файл журнала установки в `C:\Support\Logs` папке, выполните следующую команду.

    ```dos
    msiexec.exe /i AzureConnectedMachineAgent.msi /qn /l*v "C:\Support\Logs\Azcmagentupgradesetup.log"
    ```

### <a name="linux-agent"></a>Агент Linux

Чтобы обновить агент на компьютере Linux до последней версии, он включает две команды. Одна команда для обновления локального индекса пакетов со списком последних доступных пакетов из репозиториев и одной командой для обновления локального пакета. 

> [!NOTE]
> Чтобы обновить агент, необходимо иметь права доступа *root* или учетную запись с повышенными правами с помощью sudo.

#### <a name="upgrade-ubuntu"></a>Обновление Ubuntu

1. Чтобы обновить индекс локального пакета последними изменениями, внесенными в репозитории, выполните следующую команду:

    ```bash
    apt update
    ```

2. Чтобы обновить систему, выполните следующую команду:

    ```bash
    apt upgrade
    ```

Действия команды [APT](https://help.ubuntu.com/lts/serverguide/apt.html) , такие как установка и удаление пакетов, записываются в файл `/var/log/dpkg.log` журнала.

#### <a name="upgrade-red-hatcentosamazon-linux"></a>Обновление Red Hat/CentOS/Amazon Linux

1. Чтобы обновить индекс локального пакета последними изменениями, внесенными в репозитории, выполните следующую команду:

    ```bash
    yum check-update
    ```

2. Чтобы обновить систему, выполните следующую команду:

    ```bash
    yum update
    ```

Действия команды [Yum](https://access.redhat.com/articles/yum-cheat-sheet) , такие как установка и удаление пакетов, записываются в файл `/var/log/yum.log` журнала. 

#### <a name="upgrade-suse-linux-enterprise"></a>Обновление SUSE Linux Enterprise

1. Чтобы обновить индекс локального пакета последними изменениями, внесенными в репозитории, выполните следующую команду:

    ```bash
    zypper refresh
    ```

2. Чтобы обновить систему, выполните следующую команду:

    ```bash
    zypper update
    ```

Действия команды [zypper](https://en.opensuse.org/Portal:Zypper) , такие как установка и удаление пакетов, записываются в файл `/var/log/zypper.log` журнала. 

## <a name="about-the-azcmagent-tool"></a>О средстве Азкмажент

Средство Азкмажент (Азкмажент. exe) используется для настройки службы "Дуга Azure для серверов (Предварительная версия)" во время установки или для изменения начальной конфигурации агента после установки. Азкмажент. exe предоставляет параметры командной строки для настройки агента и просмотра его состояния:

* **Подключение** для подключения компьютера к службе "Дуга Azure"

* **Отключение** — отключение компьютера от дуги Azure

* **Повторное подключение** — повторное подключение отключенного компьютера к службе "Дуга" Azure

* **Показать** — Просмотр состояния агента и его свойств конфигурации (имя группы ресурсов, идентификатор подписки, версия и т. д.), которые могут помочь при устранении проблемы с агентом.

* **-h или--Help** -Отображение доступных параметров командной строки

    Например, чтобы просмотреть подробную справку по параметру **Reconnect** , введите `azcmagent reconnect -h`. 

* **-v или--verbose** -включить подробное ведение журнала

Вы можете выполнить **Подключение**, **Отключение**и **Повторное подключение** вручную, войдя в систему в интерактивном режиме, или автоматизировать с помощью того же субъекта-службы, который использовался для подключения нескольких агентов или с помощью [маркера доступа](../../active-directory/develop/access-tokens.md)платформы удостоверений Майкрософт. Если вы не использовали субъект-службу для регистрации компьютера в службе "Дуга Azure для серверов (Предварительная версия)", то для создания субъекта-службы ознакомьтесь со следующей [статьей](onboard-service-principal.md#create-a-service-principal-for-onboarding-at-scale) .

### <a name="connect"></a>Подключение

Этот параметр указывает ресурс в Azure Resource Manager, представляющий машину, созданную в Azure. Ресурс находится в указанной подписке и группе ресурсов, а данные о компьютере хранятся в регионе Azure, указанном `--location` параметром. Имя ресурса по умолчанию является именем узла этого компьютера, если оно не указано.

Затем сертификат, соответствующий назначенному системой идентификатору компьютера, загружается и сохраняется локально. После завершения этого шага служба метаданных компьютера, подключенного к Azure, и агент гостевой конфигурации начинают синхронизацию с Azure ARC для серверов (Предварительная версия).

Чтобы подключиться с помощью субъекта-службы, выполните следующую команду:

`azcmagent connect --service-principal-id <serviceprincipalAppID> --service-principal-secret <serviceprincipalPassword> --tenant-id <tenantID> --subscription-id <subscriptionID> --resource-group <ResourceGroupName> --location <resourceLocation>`

Чтобы подключиться с помощью маркера доступа, выполните следующую команду:

`azcmagent connect --access-token <> --subscription-id <subscriptionID> --resource-group <ResourceGroupName> --location <resourceLocation>`

Чтобы подключиться с учетными данными, вошедшими в систему с повышенными правами (интерактивным), выполните следующую команду:

`azcmagent connect --tenant-id <TenantID> --subscription-id <subscriptionID> --resource-group <ResourceGroupName> --location <resourceLocation>`

### <a name="disconnect"></a>Отключить

Этот параметр указывает ресурс в Azure Resource Manager, представляющий компьютер, удален в Azure. Он не удаляет агент с компьютера, это необходимо сделать в отдельном шаге. Если после отключения компьютера вы хотите повторно зарегистрировать его в службе "Дуга Azure для серверов (Предварительная версия)", используйте `azcmagent connect` для этого новый ресурс в Azure.

Чтобы отключиться с помощью субъекта-службы, выполните следующую команду:

`azcmagent disconnect --service-principal-id <serviceprincipalAppID> --service-principal-secret <serviceprincipalPassword> --tenant-id <tenantID>`

Чтобы отключиться с помощью маркера доступа, выполните следующую команду:

`azcmagent disconnect --access-token <accessToken>`

Чтобы отключиться от учетных данных, которые вошли в систему с повышенными правами (интерактивно), выполните следующую команду:

`azcmagent disconnect --tenant-id <tenantID>`

### <a name="reconnect"></a>Повтор соединения

Этот параметр повторно подключает уже зарегистрированный или подключенный компьютер с помощью дуги Azure для серверов (Предварительная версия). Это может потребоваться, если компьютер был выключен, по крайней мере 45 дней, срок действия его сертификата истекает. Этот параметр использует параметры проверки подлинности, предоставленные для получения новых учетных данных, соответствующих ресурсу Azure Resource Manager, представляющему этот компьютер.

Эта команда требует более высоких привилегий, чем роль [подключения компьютера, подключенного к Azure](overview.md#required-permissions) .

Чтобы повторно подключиться с помощью субъекта-службы, выполните следующую команду:

`azcmagent reconnect --service-principal-id <serviceprincipalAppID> --service-principal-secret <serviceprincipalPassword> --tenant-id <tenantID>`

Чтобы повторно подключиться с помощью маркера доступа, выполните следующую команду:

`azcmagent reconnect --access-token <accessToken>`

Чтобы подключиться повторно с учетными данными, вошедшими в систему с повышенными правами (интерактивно), выполните следующую команду:

`azcmagent reconnect --tenant-id <tenantID>`

## <a name="remove-the-agent"></a>Удаление агента

Выполните одно из следующих действий, чтобы удалить агент подключенного компьютера Windows или Linux с компьютера. Удаление агента не приводит к отмене регистрации компьютера в Arc для серверов (Предварительная версия). это отдельный процесс, который выполняется, когда больше не требуется управлять машиной в Azure.

### <a name="windows-agent"></a>Агент Windows

Оба следующих метода удаляют агент, но не удаляют папку *C:\Program филес\азуреконнектедмачинеажент* на компьютере.

#### <a name="uninstall-from-control-panel"></a>Удаление из панели управления

1. Чтобы удалить агент Windows с компьютера, выполните следующие действия:

    a. Войдите в систему компьютера, используя учетную запись с правами администратора.  
    b. Откройте **Панель управления**, выберите раздел **Программы и компоненты**.  
    c. В разделе **Программы и компоненты** выберите **Azure Connected Machine Agent** (Агент подключенного компьютера Azure), затем **Удалить**, а затем **Да**.  

    >[!NOTE]
    > Можно также запустить мастер установки агента, дважды щелкнув пакет установщика **AzureConnectedMachineAgent.msi**.

#### <a name="uninstall-from-the-command-line"></a>Удаление из командной строки

Чтобы вручную удалить агент из командной строки или использовать автоматизированный метод, например сценарий, можно использовать следующий пример. Сначала необходимо получить код продукта, который является идентификатором GUID, представляющим код участника пакета приложения, из операционной системы. Удаление выполняется с помощью командной строки Msiexec. exe `msiexec /x {Product Code}`.
    
1. откройте редактор реестра;

2. в разделе реестра `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall` найдите и скопируйте код GUID продукта;

3. Затем можно удалить агент с помощью команды msiexec, используя следующие примеры:

   * Из типа командной строки:

       ```dos
       msiexec.exe /x {product code GUID} /qn
       ```

   * Те же действия можно выполнить с помощью PowerShell.

       ```powershell
       Get-ChildItem -Path HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall | `
       Get-ItemProperty | `
       Where-Object {$_.DisplayName -eq "Azure Connected Machine Agent"} | `
       ForEach-Object {MsiExec.exe /x "$($_.PsChildName)" /qn}
       ```

### <a name="linux-agent"></a>Агент Linux

> [!NOTE]
> Чтобы удалить агент, необходимо иметь права доступа *root* или учетную запись с повышенными правами с помощью sudo.

Чтобы удалить агент Linux, используемая команда зависит от операционной системы Linux.

- Для Ubuntu выполните следующую команду:

    ```bash
    sudo apt purge azcmagent
    ```

- Для RHEL, CentOS и Amazon Linux выполните следующую команду:

    ```bash
    sudo yum remove azcmagent
    ```

- Для SLES выполните следующую команду:

    ```bash
    sudo zypper remove azcmagent
    ```

## <a name="unregister-machine"></a>Отмена регистрации компьютера

Если вы планируете запретить управление компьютером с помощью вспомогательных служб в Azure, выполните следующие действия, чтобы отменить регистрацию компьютера с помощью дуги для серверов (Предварительная версия). Эти действия можно выполнить либо до, либо после удаления агента подключенного компьютера с компьютера.

1. Перейдите на [портал Azure](https://aka.ms/hybridmachineportal) и откройте Azure Arc для серверов (предварительная версия).

2. Выберите компьютер в списке, щелкните значок с многоточием (**...**), а затем выберите пункт **Удалить**.
