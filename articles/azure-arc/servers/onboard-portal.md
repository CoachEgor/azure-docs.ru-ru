---
title: Подключение гибридных компьютеров к Azure из портал Azure
description: Из этой статьи вы узнаете, как установить агент и подключить компьютеры к Azure с помощью дуги Azure для серверов (Предварительная версия) из портал Azure.
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-servers
author: mgoedtel
ms.author: magoedte
ms.date: 02/12/2020
ms.topic: conceptual
ms.openlocfilehash: 12fc29cf12fba6325af3197e727d94b3073ef2ff
ms.sourcegitcommit: b07964632879a077b10f988aa33fa3907cbaaf0e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2020
ms.locfileid: "77192315"
---
# <a name="connect-hybrid-machines-to-azure-from-the-azure-portal"></a>Подключение гибридных компьютеров к Azure из портал Azure

Вы можете включить дугу Azure для серверов (Предварительная версия) для одного или небольшого числа компьютеров Windows или Linux в вашей среде, выполнив набор действий вручную. Или можно использовать автоматизированный метод, запустив сценарий шаблона, который мы предоставляем. Этот сценарий автоматизирует скачивание и установку обоих агентов.

Этот метод требует наличия разрешений администратора на компьютере для установки и настройки агента. В Linux с учетной записью root и в Windows вы являетесь членом локальной группы администраторов.

Прежде чем начать, обязательно ознакомьтесь с [предварительными](overview.md#prerequisites) требованиями и убедитесь, что подписка и ресурсы соответствуют требованиям.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="generate-the-installation-script-from-the-azure-portal"></a>Создание скрипта установки из портал Azure

Скрипт для автоматизации загрузки и установки, а также для установки подключения к службе "Дуга Azure" доступен в портал Azure. Чтобы завершить процесс, выполните следующие действия.

1. В браузере перейдите к [портал Azure](https://aka.ms/hybridmachineportal).

1. На странице " **Компьютеры (на основе дуги Azure** )" выберите **Добавить**, в левом верхнем углу или **в нижней** части средней области. 

1. На странице **Выбор метода** выберите элемент **Добавить компьютеры с помощью интерактивного скрипта** , а затем выберите **создать скрипт**.

1. На странице **Создание скрипта** выберите подписку и группу ресурсов, в которых вы хотите управлять компьютером в Azure. Выберите расположение Azure, в котором будут храниться метаданные компьютера.

    >[!NOTE]
    >Служба "Дуга Azure для серверов (Предварительная версия)" поддерживает только следующие регионы:
    >- WestUS2
    >- WestEurope
    >- вестасиа
    >
    >Ознакомьтесь с дополнительными замечаниями при [выборе региона в](overview.md#supported-regions) статье Обзор.

1. На странице **Создание скрипта** в раскрывающемся списке **Операционная система** выберите операционную систему, на которой будет выполняться сценарий.

1. Если компьютер обменивается данными через прокси-сервер для подключения к Интернету, нажмите кнопку **Далее: прокси-сервер**. 
1. На вкладке **прокси-сервер** укажите IP-адрес прокси-сервера или имя и номер порта, которые компьютер будет использовать для взаимодействия с прокси-сервером. Введите значение в формате `http://<proxyURL>:<proxyport>`. 
1. Выберите **Проверка и создать**.

1. На вкладке " **Проверка и генерация** " просмотрите сводные данные и нажмите кнопку **скачать**. Если вам все еще нужно внести изменения, нажмите кнопку **назад**.

## <a name="install-and-validate-the-agent-on-windows"></a>Установка и проверка агента в Windows

### <a name="install-manually"></a>Установка вручную
Агент подключенного компьютера можно установить вручную, запустив установщик Windows пакет *азуреконнектедмачинеажент. msi*. 

> [!NOTE]
> * Чтобы установить или удалить агент, необходимо иметь разрешения *администратора* .
> * Сначала необходимо загрузить и скопировать пакет установщика в папку на целевом сервере или в общей сетевой папке. При запуске пакета установщика без каких-либо параметров запускается мастер установки, который можно использовать для установки агента в интерактивном режиме.

Если компьютеру необходимо взаимодействовать через прокси-сервер со службой, после установки агента необходимо выполнить команду, описанную далее в этой статье. Это задает переменную системной среды прокси-сервера `https_proxy`.

В приведенной ниже таблице выделены параметры, поддерживаемые при установке агента из командной строки.

| Параметр | Описание |
|:--|:--|
| /? | Возвращает список параметров командной строки. |
| /S | Автоматическая установка без взаимодействия с пользователем. |

Например, чтобы запустить программу установки с параметром `/?`, введите `msiexec.exe /i AzureConnectedMachineAgent.msi /?`.

Файлы для агента подключенного компьютера устанавливаются в папку *C:\Program филес\азуреконнектедмачинеажент* по умолчанию. Если не удается запустить агент после завершения установки, просмотрите подробные сведения об ошибке в журналах. Каталог журнала — *%програмфилес%\азуреконнектедмачинеажентажент\логс*.

### <a name="install-with-the-scripted-method"></a>Установка с помощью метода сценария

1. Войдите на сервер.

1. Откройте командную строку PowerShell с повышенными привилегиями.

1. Перейдите к папке или общему ресурсу, в которую был скопирован скрипт, и выполните его на сервере, запустив скрипт `./OnboardingScript.ps1`.

### <a name="configure-the-agent-proxy-setting"></a>Настройка параметра прокси-сервера агента

Чтобы задать переменную среды прокси-сервера, выполните следующую команду:

```powershell
# If a proxy server is needed, execute these commands with the proxy URL and port.
[Environment]::SetEnvironmentVariable("https_proxy", "http://{proxy-url}:{proxy-port}", "Machine")
$env:https_proxy = [System.Environment]::GetEnvironmentVariable("https_proxy","Machine")
# For the changes to take effect, the agent service needs to be restarted after the proxy environment variable is set.
Restart-Service -Name himds
```

>[!NOTE]
>Агент не поддерживает настройку проверки подлинности прокси-сервера в этой предварительной версии.
>

### <a name="configure-agent-communication"></a>Настройка взаимодействия с агентом

После установки агента необходимо настроить агент для взаимодействия со службой Arc Azure, выполнив следующую команду:

`%ProgramFiles%\AzureConnectedMachineAgent\azcmagent.exe" connect --resource-group "<resourceGroupName>" --tenant-id "<tenantID>" --location "<regionName>" --subscription-id "<subscriptionID>"`

## <a name="install-and-validate-the-agent-on-linux"></a>Установка и проверка агента в Linux

Агент подключенного компьютера для Linux предоставляется в предпочтительном формате пакета для распространения (. RPM или. DEB), размещенный в [репозитории пакетов](https://packages.microsoft.com/)Майкрософт. [Пакет сценариев оболочки `Install_linux_azcmagent.sh`](https://aka.ms/azcmagent) выполняет следующие действия.

- Настраивает на главном компьютере загрузку пакета агента из packages.microsoft.com.
- Устанавливает пакет поставщика гибридных ресурсов.

При необходимости можно настроить агент с помощью сведений о прокси-сервере, включив параметр `--proxy "{proxy-url}:{proxy-port}"`.

Скрипт также содержит логику для обнаружения поддерживаемых и неподдерживаемых распределений и проверяет разрешения, необходимые для выполнения установки. 

В следующем примере выполняется скачивание агента и его установка.

```bash
# Download the installation package.
wget https://aka.ms/azcmagent -O ~/Install_linux_azcmagent.sh

# Install the connected machine agent. 
bash ~/Install_linux_azcmagent.sh
```

Чтобы скачать и установить агент, в том числе параметр `--proxy` для настройки агента для взаимодействия через прокси-сервер, выполните следующие команды:

```bash
# Download the installation package.
wget https://aka.ms/azcmagent -O ~/Install_linux_azcmagent.sh

# Install the connected machine agent. 
bash ~/Install_linux_azcmagent.sh --proxy "{proxy-url}:{proxy-port}"
```

### <a name="configure-the-agent-communication"></a>Настройка взаимодействия агента

После установки агента настройте его для взаимодействия со службой Arc Azure, выполнив следующую команду:

`/opt/azcmagent/bin/azcmagent.exe" connect --resource-group "<resourceGroupName>" --tenant-id "<tenantID>" --location "<regionName>" --subscription-id "<subscriptionID>"`

## <a name="verify-the-connection-with-azure-arc"></a>Проверка подключения с помощью дуги Azure

После установки агента и его настройки для подключения к службе "Дуга Azure для серверов (Предварительная версия)" перейдите к портал Azure, чтобы убедиться, что сервер успешно подключен. Просмотр компьютеров в [портал Azure](https://aka.ms/hybridmachineportal).

![Успешное соединение с сервером](./media/onboard-portal/arc-for-servers-successful-onboard.png)

## <a name="clean-up"></a>Очистка

Чтобы отключить компьютер от дуги Azure для серверов (Предварительная версия), выполните следующие действия.

1. Откройте дугу Azure для серверов (Предварительная версия), перейдя к [портал Azure](https://aka.ms/hybridmachineportal).

1. Выберите компьютер в списке, нажмите кнопку с многоточием ( **...** ), а затем выберите **Удалить**.

1. Чтобы удалить агент Windows с компьютера, выполните следующие действия.

    а. Войдите на компьютер, используя учетную запись с правами администратора.  
    б. На **панели управления**выберите **программы и компоненты**.  
    в. В окне **программы и компоненты**выберите **Агент подключенного компьютера Azure**, выберите **Удалить**, а затем нажмите **кнопку Да**.  

    >[!NOTE]
    > Можно также запустить мастер установки агента, дважды щелкнув пакет установщика **азуреконнектедмачинеажент. msi** .

    Если вы хотите создать скрипт для удаления агента, можно использовать следующий пример, который извлекает код продукта и удаляет агент с помощью командной строки Msiexec. exe — `msiexec /x {Product Code}`. Для этого:  
    
    а. Откройте редактор реестра.  
    б. В разделе `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall`раздела реестра найдите и скопируйте идентификатор GUID кода продукта.  
    в. После этого агент можно удалить с помощью команды msiexec.

    В следующем примере показано, как удалить агент.

    ```powershell
    Get-ChildItem -Path HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall | `
    Get-ItemProperty | `
    Where-Object {$_.DisplayName -eq "Azure Connected Machine Agent"} | `
    ForEach-Object {MsiExec.exe /x "$($_.PsChildName)" /qn}
    ```

1. Чтобы удалить агент Linux, выполните следующую команду:

      ```bash
      sudo apt purge hybridagent
      ```

## <a name="next-steps"></a>Следующие шаги

- Узнайте, как управлять компьютером с помощью [политики Azure](../../governance/policy/overview.md), например [гостевой конфигурации](../../governance/policy/concepts/guest-configuration.md)виртуальной машины, проверки того, что компьютер сообщает о предполагаемой log Analytics рабочей области, включить мониторинг с помощью [Azure Monitor с виртуальными машинами](../../azure-monitor/insights/vminsights-enable-at-scale-policy.md)и многое другое.

- Дополнительные сведения об [агенте log Analytics](../../azure-monitor/platform/log-analytics-agent.md). Агент Log Analytics для Windows и Linux необходим, если требуется заблаговременно отслеживать ОПЕРАЦИОНную систему и рабочие нагрузки, выполняемые на компьютере, управлять ею с помощью модулей Runbook автоматизации или таких решений, как Управление обновлениями, или использовать другие службы Azure, такие как [Центр безопасности Azure](../../security-center/security-center-intro.md).