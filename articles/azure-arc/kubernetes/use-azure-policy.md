---
title: Использование Политики Azure для применения конфигураций кластера в требуемом масштабе (предварительная версия)
services: azure-arc
ms.service: azure-arc
ms.date: 05/19/2020
ms.topic: article
author: mlearned
ms.author: mlearned
description: Использование Политики Azure для применения конфигураций кластера в требуемом масштабе
keywords: Kubernetes, Arc, Azure, K8s, контейнеры
ms.openlocfilehash: 4c013fe562d89bff4d1ce9c9f3e832e1b51c70f1
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85341371"
---
# <a name="use-azure-policy-to-apply-cluster-configurations-at-scale-preview"></a>Использование Политики Azure для применения конфигураций кластера в требуемом масштабе (предварительная версия)

## <a name="overview"></a>Обзор

Используйте политику Azure, чтобы обеспечить применение к каждому `Microsoft.Kubernetes/connectedclusters` ресурсу или ресурсу с поддержкой Git-Ops `Microsoft.ContainerService/managedClusters` конкретных `Microsoft.KubernetesConfiguration/sourceControlConfigurations` применений. Чтобы использовать Политику Azure, нужно выбрать существующее определение политики и создать назначение политики. При создании назначения политики вы устанавливаете область назначения: группа ресурсов или подписка Azure. Вы также задаете параметры для создаваемого объекта `sourceControlConfiguration`. После создания назначения подсистема управления политиками определит все ресурсы `connectedCluster` или `managedCluster`, находящиеся в области действия, и применит `sourceControlConfiguration` к каждому из них.

Если вы используете несколько репозиториев Git в качестве источников достоверных данных для каждого кластера (например, один репозиторий для центрального ИТ-оператора или оператора кластера и еще несколько — для команд, ответственных за приложения), этого можно добиться с помощью нескольких назначений политик, каждое из которых использует свой репозиторий Git.

## <a name="create-a-policy-assignment"></a>Создание назначения политики

1. На портале Azure перейдите к службе "Политика" и в разделе **Создание** боковой панели выберите пункт **Определения**.
2. Выберите встроенную политику "развернуть Гитопс в кластере Kubernetes" в категории "Kubernetes" и щелкните " **назначить**".
3. Задайте в качестве **области** группу управления, подписку или группу ресурсов, к которым будет применяться назначение политики.
4. Если требуется исключить какие-либо ресурсы из области политики, задайте **исключения**.
5. Присвойте назначению политики **имя** и **описание**, по которым его можно будет легко отличить.
6. Для параметра **Применение политик** должно быть обязательно задано значение *Включено*.
7. Выберите **Далее**.
8. Задайте значения параметров, которые будут использоваться при создании `sourceControlConfiguration`.
9. Выберите **Далее**.
10. Включите параметр **Создание задачи исправления**.
11. Убедитесь в том, что установлен флажок **Создать управляемое удостоверение** и что удостоверение будет иметь разрешения **участника**. Дополнительные сведения о необходимых разрешениях см. в [этом документе](https://docs.microsoft.com/azure/governance/policy/assign-policy-portal) и [комментарии в этом документе](https://docs.microsoft.com/azure/governance/policy/how-to/remediate-resources).
12. Выберите **Review + create** (Просмотреть и создать).

После создания назначения политики конфигурация `sourceControlConfiguration` будет применяться к каждому новому ресурсу `connectedCluster` (или ресурсу `managedCluster` с установленными агентами GitOps), который находится в области назначения. Для существующих кластеров необходимо вручную запустить задачу исправления. Как правило, назначение политики вступает в силу в течение 10–20 минут.

## <a name="verify-a-policy-assignment"></a>Проверка назначения политики

1. На портале Azure перейдите к одному из ресурсов `connectedCluster` и в разделе **Параметры** боковой панели выберите пункт **Политики**. (Интерфейс для управляемого кластера AKS еще не реализован, но готовится к выпуску.)
2. В списке должно отобразиться созданное ранее назначение политики, а **состояние соответствия** должно быть *Совместимое*.
3. В разделе **Параметры** боковой панели выберите пункт **Конфигурации**.
4. В списке должна присутствовать конфигурация `sourceControlConfiguration`, созданная назначением политики.
5. Используйте **kubectl** для опроса кластера: должны отобразиться пространство имен и артефакты, созданные конфигурацией `sourceControlConfiguration`.
6. В течение 5 минут в кластере должны появиться артефакты, описанные в манифестах в настроенном репозитории Git.

## <a name="next-steps"></a>Дальнейшие действия

* [Настройка Azure Monitor для контейнеров с кластерами Kubernetes с поддержкой Arc](./deploy-azure-monitor-for-containers.md)
