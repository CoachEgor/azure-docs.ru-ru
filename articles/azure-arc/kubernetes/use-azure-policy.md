---
title: Использование Политики Azure для применения конфигураций кластера в требуемом масштабе (предварительная версия)
services: azure-arc
ms.service: azure-arc
ms.date: 05/19/2020
ms.topic: article
author: mlearned
ms.author: mlearned
description: Использование Политики Azure для применения конфигураций кластера в требуемом масштабе
keywords: Kubernetes, Arc, Azure, K8s, контейнеры
ms.openlocfilehash: c017e9422733069ffd93f6dff72ecb884da057c4
ms.sourcegitcommit: a9784a3fd208f19c8814fe22da9e70fcf1da9c93
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/22/2020
ms.locfileid: "83779948"
---
# <a name="use-azure-policy-to-apply-cluster-configurations-at-scale-preview"></a>Использование Политики Azure для применения конфигураций кластера в требуемом масштабе (предварительная версия)

## <a name="overview"></a>Обзор

Используйте Политику Azure для принудительного применения определенных конфигураций `Microsoft.KubernetesConfiguration/sourceControlConfigurations` к каждому ресурсу `Microsoft.Kubernetes/connectedclusters` или ресурсу `Microsoft.ContainerService/managedClusters` с поддержкой Git-Ops.  Чтобы использовать Политику Azure, нужно выбрать существующее определение политики и создать назначение политики.  При создании назначения политики вы устанавливаете область назначения: группа ресурсов или подписка Azure.  Вы также задаете параметры для создаваемого объекта `sourceControlConfiguration`.  После создания назначения подсистема управления политиками определит все ресурсы `connectedCluster` или `managedCluster`, находящиеся в области действия, и применит `sourceControlConfiguration` к каждому из них.

Если вы используете несколько репозиториев Git в качестве источников достоверных данных для каждого кластера (например, один репозиторий для центрального ИТ-оператора или оператора кластера и еще несколько — для команд, ответственных за приложения), этого можно добиться с помощью нескольких назначений политик, каждое из которых использует свой репозиторий Git.

## <a name="create-a-custom-policy-definition"></a>Создание определения пользовательской политики

1. На портале Azure перейдите к службе "Политика" и в разделе **Создание** боковой панели выберите пункт **Определения**.
2. Выберите **+ Определение политики**.
3. Выберите в качестве **расположения определения** подписку или группу управления.  Таким образом, определяется наиболее широкая область, в которой можно использовать определение политики.
4. Присвойте политике **имя** и **описание**.
5. В разделе "Категория" выберите **Создать** и введите *Кластер Kubernetes — Azure Arc*.
6. В поле **Правило политики** вставьте содержимое из [примера определения политики](https://raw.githubusercontent.com/Azure/arc-k8s-demo/master/policy/Ensure-GitOps-configuration-for-Kubernetes-cluster.json).
7. **Сохраните** настройки.

Этот шаг в процессе создания пользовательского определения политики не потребуется после того, как политика станет встроенной.

## <a name="create-a-policy-assignment"></a>Создание назначения политики

1. На портале Azure перейдите к службе "Политика" и в разделе **Создание** боковой панели выберите пункт **Определения**.
2. Найдите созданное определение и выберите его.
3. В области действий страницы выберите **Назначить**.
4. Задайте в качестве **области** группу управления, подписку или группу ресурсов, к которым будет применяться назначение политики.
5. Если требуется исключить какие-либо ресурсы из области политики, задайте **исключения**.
6. Присвойте назначению политики **имя** и **описание**, по которым его можно будет легко отличить.
7. Для параметра **Применение политик** должно быть обязательно задано значение *Включено*.
8. Выберите **Далее**.
9. Задайте значения параметров, которые будут использоваться при создании `sourceControlConfiguration`.
10. Выберите **Далее**.
11. Включите параметр **Создание задачи исправления**.
12. Убедитесь в том, что установлен флажок **Создать управляемое удостоверение** и что удостоверение будет иметь разрешения **участника**.  Дополнительные сведения о необходимых разрешениях см. в [этом документе](https://docs.microsoft.com/azure/governance/policy/assign-policy-portal) и [комментарии в этом документе](https://docs.microsoft.com/azure/governance/policy/how-to/remediate-resources).
13. Выберите **Review + create** (Просмотреть и создать).

После создания назначения политики конфигурация `sourceControlConfiguration` будет применяться к каждому новому ресурсу `connectedCluster` (или ресурсу `managedCluster` с установленными агентами GitOps), который находится в области назначения.  Для существующих кластеров необходимо вручную запустить задачу исправления.  Как правило, назначение политики вступает в силу в течение 10–20 минут.

## <a name="verify-a-policy-assignment"></a>Проверка назначения политики

1. На портале Azure перейдите к одному из ресурсов `connectedCluster` и в разделе **Параметры** боковой панели выберите пункт **Политики**. (Интерфейс для управляемого кластера AKS еще не реализован, но готовится к выпуску.)
2. В списке должно отобразиться созданное ранее назначение политики, а **состояние соответствия** должно быть *Совместимое*.
3. В разделе **Параметры** боковой панели выберите пункт **Конфигурации**.
4. В списке должна присутствовать конфигурация `sourceControlConfiguration`, созданная назначением политики.
5. Используйте **kubectl** для опроса кластера: должны отобразиться пространство имен и артефакты, созданные конфигурацией `sourceControlConfiguration`.
6. В течение 5 минут в кластере должны появиться артефакты, описанные в манифестах в настроенном репозитории Git.

## <a name="next-steps"></a>Дальнейшие действия

* [Настройка Azure Monitor для контейнеров с кластерами Kubernetes с поддержкой Arc](./deploy-azure-monitor-for-containers.md)
