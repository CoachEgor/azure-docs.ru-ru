---
title: Резервное копирование и восстановление для Базы данных Azure для групп серверов Гипермасштабирования PostgreSQL
description: Резервное копирование и восстановление для Базы данных Azure для групп серверов Гипермасштабирования PostgreSQL
services: azure-arc
ms.service: azure-arc
ms.subservice: azure-arc-data
author: TheJY
ms.author: jeanyd
ms.reviewer: mikeray
ms.date: 09/22/2020
ms.topic: how-to
ms.openlocfilehash: dde4db7f3eb476b7645e910504e48fea8bb6df0c
ms.sourcegitcommit: f796e1b7b46eb9a9b5c104348a673ad41422ea97
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/30/2020
ms.locfileid: "91569716"
---
# <a name="backup-and-restore-for-azure-arc-enabled-postgresql-hyperscale-server-groups"></a>Резервное копирование и восстановление для PostgreSQLных групп серверов с поддержкой дуги Azure

Вы можете выполнить полное резервное копирование или восстановление группы серверов PostgreSQL в службе "Дуга" с поддержкой дуги Azure. После этого весь набор баз данных на всех узлах вашей дуги Azure, включенного в PostgreSQLную группу серверов, будет резервным копированием и восстановлением.
Чтобы создать резервную копию и восстановить ее, необходимо убедиться, что для группы серверов настроен класс хранения резервных копий. Сейчас необходимо указать класс хранилища резервных копий во время создания группы серверов. Пока вы не настроите группу серверов на использование класса хранилища резервных копий после создания.

[!INCLUDE [azure-arc-data-preview](../../../includes/azure-arc-data-preview.md)]

> [!CAUTION]
> Предварительная версия не поддерживает резервное копирование и восстановление для ядра postgres версии 11. Он поддерживает только резервное копирование и восстановление для postgres версии 12.

## <a name="verify-configuration"></a>Проверка конфигурации

Сначала убедитесь, что существующая группа серверов настроена для использования класса хранилища резервных копий.

После задания имени группы серверов выполните следующую команду:
```console
 azdata arc postgres server show -n postgres01
```
Взгляните на раздел Storage (хранилище) выходных данных:
```console
...
"storage": {
      "backups": {
        "className": "local-storage"
      },
      "data": {
        "className": "local-storage",
        "size": "5Gi"
      },
      "logs": {
        "className": "local-storage",
        "size": "5Gi"
      }
    }
...
```
Если вы видите имя класса хранения, указанного в разделе "резервное копирование" выходных данных этой команды, это означает, что ваша группа серверов настроена для использования класса хранилища резервных копий и готова к созданию резервных копий и восстановлению. Если раздел "резервные копии" не отображается, необходимо удалить и повторно создать группу серверов, чтобы настроить класс хранения резервных копий. На этом этапе Настройка класса хранилища резервных копий еще не возможна после создания группы серверов.

>[!IMPORTANT]
>Если группа серверов уже настроена для использования класса хранилища резервных копий, пропустите следующий шаг и перейдите непосредственно к шагу "выполнить полное резервное копирование вручную".

## <a name="create-a-server-group"></a>Создавать группу серверов 

Затем создайте группу серверов, настроенную для резервного копирования и восстановления.

Чтобы иметь возможность создавать резервные копии и восстанавливать их, необходимо создать сервер, настроенный с использованием класса хранения.

Чтобы получить список классов хранения, доступных в кластере Kubernetes, выполните следующую команду:

```console
kubectl get sc
```

<!--The general format of create server group command is documented [here](create-postgresql-instances.md)-->

```console
azdata arc postgres server create -n <name> --workers 2 --storage-class-backups <storage class name> [--storage-class-data <storage class name>] [--storage-class-logs <storage class name>]
```

Например, если вы создали простую среду на основе кубеадм:
```console
azdata arc postgres server create -n postgres01 --workers 2 --storage-class-backups local-storage
```

## <a name="take-manual-full-backup"></a>Выполнить полное резервное копирование вручную

Затем выполните полное резервное копирование вручную.

Чтобы создать полную резервную копию всех папок данных и журналов группы серверов, выполните следующую команду:

```console
azdata arc postgres backup create [--name <backup name>] --server-name <server group name> [--no-wait] 
```
Где:
- __имя__ указывает имя резервной копии.
- __имя сервера__ указывает на группу серверов.
- __нет-Wait__ указывает, что Командная строка не будет ждать завершения резервного копирования, чтобы вы могли продолжить использовать это окно командной строки.

>**Примечание**. команда, позволяющая получить список резервных копий, доступных для восстановления, пока не отображается, даты и времени, когда была сделана резервная копия. Поэтому рекомендуется указать имя резервной копии (с помощью параметра--Name), включающее сведения о дате и времени.

Эта команда координирует распределенное полное резервное копирование по всем узлам, составляющим группу серверов PostgreSQL с поддержкой дуги Azure. Иными словами, он будет создавать резервные копии всех данных в координаторе и рабочих узлах.

Пример:
```console
azdata arc postgres backup create --name MyBackup_Aug31_0730amPST --server-name postgres01
```

После завершения резервного копирования будет возвращен идентификатор, имя и состояние резервной копии. Пример:
```console
{
  "ID": "d134f51aa87f4044b5fb07cf95cf797f",
  "name": "MyBackup_Aug31_0730amPS",
  "state": "Done"
}
```

> [!NOTE]
> Пока нет возможности:
> - Планирование автоматического резервного копирования
> - Отображение хода выполнения резервного копирования

## <a name="list-backups"></a>Перечисление резервных копий

Список резервных копий, доступных для восстановления.

Чтобы получить список резервных копий, доступных для восстановления, выполните следующую команду:

```console
azdata arc postgres backup list --server-name <servergroup name>
```

Пример:
```console
azdata arc postgres backup list --server-name postgres01
```

Он возвратит выходные данные следующего вида:
```console
ID                                Name                      State    Timestamp
--------------------------------  ------------------------  -------  ------------------------------
d134f51aa87f4044b5fb07cf95cf797f  MyBackup_Aug31_0730amPST  Done     2020-08-31 14:30:00:00+00:00
```

Отметка времени указывает момент времени в формате UTC, в котором была сделана резервная копия.

## <a name="restore-a-backup"></a>Восстановление резервной копии

Чтобы восстановить резервную копию всей группы серверов, выполните команду:

```console
azdata arc postgres backup restore --server-name <server group name> --backup-id <backup id>
```

Где:
- __BACKUP-ID__ — это идентификатор резервной копии, отображаемый в команде list Backup (см. шаг 3).
Это приведет к координации распределенного полного восстановления по всем узлам, составляющим группу серверов PostgreSQL с поддержкой дуги Azure. Иными словами, он восстановит все данные в координаторе и рабочих узлах.

Пример:
```console
azdata arc postgres backup restore --server-name postgres01 --backup-id d134f51aa87f4044b5fb07cf95cf797f
```

После завершения операции восстановления она возвратит в командной строке следующий результат:
```console
{
  "ID": "d134f51aa87f4044b5fb07cf95cf797f",
  "state": "Done"
}
```
> [!NOTE]
> Пока нет возможности:
> - Восстановление резервной копии с указанием ее имени
> - Восстановление группы серверов под другим именем или в другой группе серверов
> - Отображение хода выполнения операции восстановления

## <a name="delete-backups"></a>Удаление резервных копий.
Невозможно задать срок хранения резервной копии в предварительной версии. Однако вы можете вручную удалить ненужные резервные копии.
Ниже приведена общая команда для удаления резервных копий.
```console
azdata arc postgres backup delete  [--server-name, -sn] {[--name, -n], -id}
```
Где:
- `--server-name` имя группы серверов, из которой пользователь хочет удалить резервную копию.
- `--name` Имя удаляемой резервной копии
- `-id`Идентификатор удаляемой резервной копии

> [!NOTE]
> `--name` и `-id` являются взаимоисключающими.

Вы можете получить имя и идентификатор резервных копий, выполнив команду list Backup, как описано в предыдущем абзаце.

Например, предположим, что в списке есть следующие резервные копии:
```console
azdata arc postgres backup list -sn postgres01
ID                                Name                    State
--------------------------------  ----------------------  -------
5b0481dfc1c94b4cac79dd56a1bb21f4  MyBackup091720200110am  Done
0cf39f1e92344e6db4cfa285d36c7b14  MyBackup091720200111am  Done
```
и вы хотите удалить первый из них, выполните следующую команду:
```console
azdata arc postgres backup delete -sn postgres01 -n MyBackup091720200110am
{
  "ID": "5b0481dfc1c94b4cac79dd56a1bb21f4",
  "name": "MyBackup091720200110am",
  "state": "Done"
}
```
Если вы хотите перечислить резервные копии на этом этапе, вы получите следующие выходные данные:
```console
azdata arc postgres backup list -sn postgres01
ID                                Name                    State
--------------------------------  ----------------------  -------
0cf39f1e92344e6db4cfa285d36c7b14  MyBackup091720200111am  Done
```

Чтобы получить дополнительные сведения о команде delete, выполните команду:
```console
azdata arc postgres backup delete --help
```

## <a name="next-steps"></a>Дальнейшие действия
- Дополнительные сведения о [масштабировании (Добавление рабочих узлов)](scale-out-postgresql-hyperscale-server-group.md) в группу серверов
- Дополнительные сведения о [масштабировании (увеличение или уменьшение объема памяти и виртуальных ядер)](scale-up-down-postgresql-hyperscale-server-group-using-cli.md) для группы серверов
