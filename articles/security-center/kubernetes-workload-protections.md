---
title: Защита рабочих нагрузок для рабочих нагрузок Kubernetes
description: Узнайте, как использовать набор рекомендаций по безопасности для защиты рабочей нагрузки в центре безопасности Azure Kubernetes
services: security-center
author: memildin
manager: rkarlin
ms.service: security-center
ms.topic: how-to
ms.date: 09/12/2020
ms.author: memildin
ms.openlocfilehash: 8a387adde6c74b8eb1ff950c5e6b5183e43d1f4f
ms.sourcegitcommit: 3792cf7efc12e357f0e3b65638ea7673651db6e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91448659"
---
# <a name="protect-your-kubernetes-workloads"></a>Защита рабочих нагрузок Kubernetes

На этой странице описывается, как использовать набор рекомендаций по безопасности центра безопасности Azure, выделенный для защиты рабочей нагрузки Kubernetes.

Дополнительные сведения об этих функциях см. в статье [рекомендации по защите рабочих нагрузок с помощью управления допуском Kubernetes](container-security.md#workload-protection-best-practices-using-kubernetes-admission-control)

Центр безопасности предлагает больше функций безопасности контейнеров, если вы включаете защитник Azure. В частности:

- Проверка реестров контейнеров на наличие уязвимостей с помощью [защитника Azure для реестров контейнеров](defender-for-container-registries-introduction.md)
- Получение оповещений об обнаружении угроз в реальном времени для вашего кластера K8s в [защитнике Azure для Kubernetes](defender-for-kubernetes-introduction.md)

> [!TIP]
> Список *всех* рекомендаций по безопасности, которые могут выводиться для кластеров и узлов Kubernetes, см. в [разделе контейнер](recommendations-reference.md#recs-containers) справочной таблицы рекомендации.



## <a name="availability"></a>Доступность

|Аспект|Сведения|
|----|:----|
|Состояние выпуска:|Предварительный просмотр|
|Цены|Free|
|Необходимые роли и разрешения:|**Владелец** или **администратор безопасности** для изменения назначения<br>**Читатель** для просмотра рекомендаций|
|Поддерживаемые кластеры|Требуется Kubernetes v 1.14 (или более поздняя версия)<br>Нет ресурса Подсекуритиполици (старая модель PSP) в кластерах<br>Узлы Windows не поддерживаются|
|Облако.|![Да](./media/icons/yes-icon.png) Коммерческие облака<br>![Нет](./media/icons/no-icon.png) National/независимых (US Gov, Китай gov, другое gov)|
|||


## <a name="set-up-your-workload-protection"></a>Настройка защиты рабочей нагрузки

Центр безопасности Azure включает набор рекомендаций, доступных при установке **надстройки политики Azure для Kubernetes**.

1. Чтобы настроить рекомендации, сначала необходимо установить надстройку:

    1. На странице рекомендации выполните поиск рекомендации с именем **надстройка политики Azure для Kubernetes, которая должна быть установлена и включена в кластерах**.

        :::image type="content" source="./media/defender-for-kubernetes-usage/recommendation-to-install-policy-add-on-for-kubernetes.png" alt-text="Рекомендация * * надстройка политики Azure для Kubernetes должна быть установлена и включена в кластерах * *":::

        > [!TIP]
        > Эта рекомендация включена в пять различных элементов управления безопасностью, и не имеет значения, выбранного на следующем шаге.

    1. В любом из элементов управления безопасностью выберите рекомендацию, чтобы просмотреть ресурсы, на которых можно установить надстройку, и выберите **исправить**. 

        :::image type="content" source="./media/defender-for-kubernetes-usage/recommendation-to-install-policy-add-on-for-kubernetes-details.png" alt-text="Рекомендация * * надстройка политики Azure для Kubernetes должна быть установлена и включена в кластерах * *":::

1. Примерно через 30 минут после завершения установки надстройки центр безопасности отображает состояние работоспособности кластеров для следующих рекомендаций, каждое в соответствующем элементе управления безопасностью, как показано ниже.

    > [!TIP]
    > Некоторые рекомендации имеют параметры, которые необходимо настроить с помощью политики Azure, чтобы эффективно использовать их. Например, чтобы воспользоваться преимуществами образов контейнеров рекомендаций, которые **должны быть развернуты только из доверенных реестров**, необходимо определить доверенные реестры.
    > 
    > Если вы не вводите необходимые параметры для рекомендаций, требующих настройки, рабочие нагрузки будут отображаться как неработоспособные.

    | Имя рекомендации                                                                   | Управление безопасностью                         | Требуется настройка |
    |---------------------------------------------------------------------------------------|------------------------------------------|------------------------|
    | Необходимо принудительно применять ограничения ЦП и памяти контейнера (Предварительная версия)                          | Защита приложений от атак от атак DDoS | Нет                     |
    | Следует избегать привилегированных контейнеров (Предварительная версия)                                     | Управление доступом и разрешениями            | Нет                     |
    | Для контейнеров (Предварительная версия) должна применяться неизменяемая (только для чтения) корневая файловая система     | Управление доступом и разрешениями            | Нет                     |
    | Необходимо избегать укрупнения привилегий в контейнере (Предварительная версия)                       | Управление доступом и разрешениями            | Нет                     |
    | Следует избегать запуска контейнеров от имени привилегированного пользователя (Предварительная версия)                           | Управление доступом и разрешениями            | Нет                     |
    | Следует избегать использования контейнеров, совместно использующих конфиденциальные пространства имен узлов (Предварительная версия)              | Управление доступом и разрешения            | Нет                     |
    | Для контейнеров (Предварительная версия) должны применяться минимальные привилегированные возможности Linux.       | Управление доступом и разрешениями            | **Да**                |
    | Использование подключений типа POD Хостпас должно быть ограничено известным списком (Предварительная версия)    | Управление доступом и разрешения            | **Да**                |
    | Контейнеры должны прослушивать только разрешенные порты (Предварительная версия)                              | Ограничение несанкционированного доступа к сети     | **Да**                |
    | Службы должны прослушивать только разрешенные порты (Предварительная версия)                                | Ограничение несанкционированного доступа к сети     | **Да**                |
    | Использование сетей узла и портов должно быть ограничено (Предварительная версия)                     | Ограничение несанкционированного доступа к сети     | **Да**                |
    | Переопределение или отключение контейнеров AppArmor для профиля должно быть ограничено (Предварительная версия) | Исправление конфигураций системы безопасности        | **Да**                |
    | Образы контейнеров должны развертываться только из доверенных реестров (Предварительная версия)            | Исправление уязвимостей                | **Да**                |


1. Чтобы получить рекомендации с параметрами, необходимо настроить параметры.

    1. В меню центра безопасности выберите пункт **Политика безопасности**.
    1. Выберите нужную подписку.
    1. В разделе **политика центра безопасности по умолчанию** выберите **Просмотреть действующую политику**.
    1. Выберите "ASC Default".
    1. Откройте вкладку **Параметры** и при необходимости измените значения.
    1. Выберите **Проверить и сохранить**.
    1. Щелкните **Сохранить**.


1. Чтобы применить любые рекомендации, 

    1. Откройте страницу сведений об рекомендации и выберите **запретить**:

        :::image type="content" source="./media/defender-for-kubernetes-usage/enforce-workload-protection-example.png" alt-text="Рекомендация * * надстройка политики Azure для Kubernetes должна быть установлена и включена в кластерах * *" центра безопасности и используйте фильтр типов ресурсов для **Kubernetes Services**.

    1. Выберите кластер для изучения и просмотрите доступные рекомендации. 

1. При просмотре рекомендаций из набора защиты рабочей нагрузки вы увидите число затронутых модулей Pod ("компоненты Kubernetes"), перечисленных рядом с кластером. Для получения списка конкретных модулей Pod выберите кластер и нажмите кнопку **выполнить действие**.

    :::image type="content" source="./media/defender-for-kubernetes-usage/view-affected-pods-for-recommendation.gif" alt-text="Рекомендация * * надстройка политики Azure для Kubernetes должна быть установлена и включена в кластерах * *"::: 

1. Чтобы протестировать принудительное применение, используйте два развертывания Kubernetes ниже:

    - Один предназначен для работоспособного развертывания, соответствующий набору рекомендаций по защите рабочей нагрузки.
    - Второй — для неработоспособного развертывания, не соответствующего *ни одной* из рекомендаций.

    Разверните файл example. YAML как есть или используйте их в качестве ссылки для исправления собственной рабочей нагрузки (шаг ВИИИ).  


## <a name="healthy-deployment-example-yaml-file"></a>Пример работоспособного развертывания. YAML файл

```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-healthy-deployment
  labels:
    app: redis
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
      annotations:
        apparmor.security.beta.kubernetes.io/pod: runtime/default
        container.apparmor.security.beta.kubernetes.io/redis: runtime/default
    spec:
      containers:
      - name: redis
        image: healthyClusterRegistry.azurecr.io/redis:latest
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 100m
            memory: 250Mi
        securityContext:
          privileged: false
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
---
apiVersion: v1
kind: Service
metadata:
  name: redis-healthy-service
spec:
  type: LoadBalancer
  selector:
    app: redis
  ports:
  - port: 80
    targetPort: 80
```

## <a name="unhealthy-deployment-example-yaml-file"></a>Пример неработоспособного развертывания. файл YAML

```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-unhealthy-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:      
      labels:
        app: nginx
    spec:
      hostNetwork: true
      hostPID: true 
      hostIPC: true
      containers:
      - name: nginx
        image: nginx:1.15.2
        ports:
        - containerPort: 9001
          hostPort: 9001
        securityContext:
          privileged: true
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: true
          runAsUser: 0
          capabilities:
            add:
              - NET_ADMIN
        volumeMounts:
        - mountPath: /test-pd
          name: test-volume
          readOnly: true
      volumes:
      - name: test-volume
        hostPath:
          # directory location on host
          path: /tmp
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-unhealthy-service
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - port: 6001
    targetPort: 9001
```



## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настроить защиту рабочей нагрузки Kubernetes. 

Другие связанные материалы см. на следующих страницах: 

- [Рекомендации центра безопасности для контейнеров](recommendations-reference.md#recs-containers)
- [Оповещения для уровня кластера AKS](alerts-reference.md#alerts-akscluster)
- [Оповещения для уровня узла контейнера](alerts-reference.md#alerts-containerhost)