---
title: JIT-доступ к виртуальным машинам в Центре безопасности Azure | Документация Майкрософт
description: В этом документе описано, как JIT-доступ в Центре безопасности Azure помогает управлять доступом к виртуальным машинам Azure.
services: security-center
documentationcenter: na
author: monhaber
manager: barbkess
editor: ''
ms.assetid: 671930b1-fc84-4ae2-bf7c-d34ea37ec5c7
ms.service: security-center
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 8/20/2019
ms.author: v-mohabe
ms.openlocfilehash: f3e6cc0464c8f395db7cac0ebf8a16230f5ebcbe
ms.sourcegitcommit: b3bad696c2b776d018d9f06b6e27bffaa3c0d9c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2019
ms.locfileid: "69872912"
---
# <a name="manage-virtual-machine-access-using-just-in-time"></a>Управление доступом к виртуальным машинам с помощью JIT-доступа

JIT-доступ к виртуальной машине позволяет заблокировать входящий трафик к виртуальным машинам Azure, снизить уязвимость к атакам и обеспечить удобный доступ к виртуальным машинам, когда это необходимо.

> [!NOTE]
> Функция JIT-доступа предоставляется в Центре безопасности Azure ценовой категории "Стандартный".  Дополнительные сведения о ценовых категориях центра безопасности см. на странице [Цены](security-center-pricing.md).


> [!NOTE]
> Механизм JIT-доступа Центра безопасности сейчас поддерживается только для виртуальных машин, развернутых с помощью Azure Resource Manager. Дополнительные сведения о классической модели развертывания и модели развертывания Resource Manager см. в разделе [Модель развертывания Azure Resource Manager и классическая модель развертывания](../azure-resource-manager/resource-manager-deployment-model.md).

## <a name="attack-scenario"></a>Сценарий атаки

Целью атак методом подбора часто становятся порты управления как средство получения доступа к виртуальной машине. В случае успешной атаки злоумышленник может установить контроль над виртуальной машиной и закрепиться в вашей среде.

Один из способов снижения вероятности атаки методом подбора — ограничить количество времени, в течение которого порт открыт. Порты управления не должны быть открыты всегда. Они должны быть открыты только при подключении к виртуальной машине, например для выполнения задач управления или обслуживания. Если включена JIT, центр безопасности использует [группу безопасности сети](../virtual-network/security-overview.md#security-rules) (NSG) и правила брандмауэра Azure, которые ограничивают доступ к портам управления, чтобы они не могли быть направлены злоумышленниками.

![Сценарий JIT-доступа](./media/security-center-just-in-time/just-in-time-scenario.png)

## <a name="how-does-jit-access-work"></a>Как работает JIT-доступ?

Если включен JIT-доступ, Центр безопасности создает правило группы безопасности сети для блокирования входящего трафика, поступающего на виртуальную машину Azure. Вы выбираете порты на виртуальной машине, для которых будет заблокирован входящий трафик. Этими портами управляет решение JIT-доступа.

Когда пользователь запрашивает доступ к виртуальной машине, Центр безопасности проверяет наличие у пользователя разрешений [управления доступом на основе ролей (RBAC)](../role-based-access-control/role-assignments-portal.md), которые позволяют предоставлять доступ к виртуальной машине. Если запрос утвержден, центр безопасности автоматически настраивает группы безопасности сети (группы безопасности сети) и брандмауэр Azure, чтобы разрешить входящий трафик к выбранным портам и запрошенным исходным IP-адресам или диапазонам, за указанный период времени. После истечения этого времени центр безопасности восстанавливает прежнее состояние групп безопасности сети. Однако это не прерывает установленные подключения.

 > [!NOTE]
 > Если запрос на JIT-доступ утвержден для виртуальной машины за брандмауэром Azure, центр безопасности автоматически изменяет правила политики NSG и брандмауэра. В течение указанного времени правила разрешают входящий трафик на выбранные порты и запрошенные исходные IP-адреса или диапазоны. По истечении этого времени центр безопасности восстанавливает правила брандмауэра и NSG в предыдущие состояния.


## <a name="permissions-needed-to-configure-and-use-jit"></a>Разрешения, необходимые для настройки и использования JIT-доступа

| Чтобы предоставить пользователю следующие возможности: | Разрешения для установки|
| --- | --- |
| Настройка или изменение политики JIT для виртуальной машины | *Назначьте следующие действия роли:*  <ul><li>В области подписки или группы ресурсов, связанной с виртуальной машиной:<br/> ```Microsoft.Security/locations/jitNetworkAccessPolicies/write``` </li><li> В области подписки, группы ресурсов или виртуальной машины: <br/>```Microsoft.Compute/virtualMachines/write```</li></ul> | 
| ||
|Запрос JIT-доступа к виртуальной машине | *Назначьте следующие действия пользователю:*  <ul><li>В области подписки или группы ресурсов, связанной с виртуальной машиной:<br/>  ```Microsoft.Security/locations/jitNetworkAccessPolicies/initiate/action``` </li><li>  В области подписки, группы ресурсов или виртуальной машины:<br/> ```Microsoft.Compute/virtualMachines/read``` </li></ul>|


## <a name="configure-jit-on-a-vm"></a>Настройка JIT на виртуальной машине

Существует три способа настройки политики JIT на виртуальной машине.

- [Настройка JIT-доступа в центре безопасности Azure](#jit-asc)
- [Настройка JIT-доступа в колонке виртуальной машины Azure](#jit-vm)
- [Программная настройка политики JIT на виртуальной машине](#jit-program)

## <a name="configure-jit-in-asc"></a>Настройка JIT-компилятора в ASC

В ASC можно настроить политику JIT и запросить доступ к виртуальной машине с помощью политики JIT.


### Настройка JIT-доступа на виртуальной машине в ASC<a name="jit-asc"></a>

1. Откройте панель мониторинга **центра безопасности**.

2. На левой панели выберите JIT- **доступ к виртуальной машине**.

    ![Плитка "JIT-доступ к виртуальной машине"](./media/security-center-just-in-time/just-in-time.png)

    Откроется окно **JIT-доступ к виртуальной машине**.

      ![Включение JIT-доступа](./media/security-center-just-in-time/enable-just-in-time.png)

    На плитке **JIT-доступ к виртуальной машине** содержатся сведения о состоянии виртуальных машин.

    - **Настроенные** — виртуальные машины, для которых была настроена поддержка JIT-доступа. Указываются сведения за последнюю неделю, которые включают число одобренных запросов, дату и время последнего доступа и последнего пользователя для каждой виртуальной машины.
    - **Рекомендуемые** — виртуальные машины, для которых JIT-доступ возможен, но пока не настроен. Мы рекомендуем включить JIT-доступ для всех этих виртуальных машин. 
    - **Нерекомендуемые** — причины, по которым виртуальная машина может попасть в эту группу, включают следующие:
      - Отсутствует группа безопасности сети — для решения JIT необходимо наличие группы безопасности сети.
      - Классическая виртуальная машина — JIT-доступ с использованием Центра безопасности сейчас поддерживается только для виртуальных машин, развернутых с помощью Azure Resource Manager. JIT-доступ для классической модели развертывания не поддерживается. 
      - Другие — виртуальная машина находится в этой категории, если JIT-решение отключено в политике безопасности подписки или группы ресурсов или если на виртуальной машине отсутствует общедоступный IP-адрес и отсутствует NSG.

3. Перейдите на вкладку **Рекомендуется**.

4. В разделе **Виртуальная машина**щелкните Виртуальные машины, которые необходимо включить. При этом устанавливается флажок рядом с виртуальной машиной.

5. Щелкните **включить JIT на виртуальных машинах**.
   -. В этой колонке отображаются порты по умолчанию, рекомендованные Центром безопасности Azure:
      - 22 — SSH;
      - 3389 — RDP;
      - 5985 — WinRM; 
      - 5986 — WinRM.
6. Можно также настроить пользовательские порты.

      1. Нажмите кнопку **Добавить**. Откроется окно **Добавление конфигурации порта** .
      2. Для каждого порта, выбранного для настройки (по умолчанию и настраиваемый), можно настроить следующие параметры.

    - **Тип протокола** — указывает, какой протокол разрешается для этого порта после утверждения запроса;
    - **Allowed source IP addresses** (Разрешенные IP-адреса источника) — диапазоны IP-адресов, с которых разрешается доступ к этому порту после утверждения запроса;
    - **Максимальное время запроса** — максимальный интервал времени, в течение которого может быть открыт этот порт.

     3. Нажмите кнопку **ОК**.

1. Нажмите кнопку **Сохранить**.

> [!NOTE]
>Если для виртуальной машины включен JIT-доступ к виртуальной машине, центр безопасности Azure создает правила "запретить весь входящий трафик" для выбранных портов в связанных группах безопасности сети и брандмауэре Azure. Если для выбранных портов были созданы другие правила, то существующие правила имеют приоритет над новым правилом "запретить весь входящий трафик". Если на выбранных портах нет существующих правил, то новые правила "запретить весь входящий трафик" будут иметь наивысший приоритет в группах безопасности сети и брандмауэре Azure.


## <a name="request-jit-access-via-asc"></a>Запрос JIT-доступа через ASC

Чтобы запросить доступ к виртуальной машине с помощью ASC, выполните следующие действия.

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Настроенные**.

2. В разделе **Виртуальная машина**щелкните Виртуальные машины, для которых требуется запросить доступ. В этом случае рядом с виртуальной машиной помещается галочка.


    - Значок в столбце **сведения о соединении** указывает, включен ли JIT в NSG или FW. Если он включен для обоих типов, отображается только значок брандмауэра.

    - Столбец **сведения о подключении** содержит правильные сведения, необходимые для подключения к виртуальной машине, а также указывает открытые порты.

      ![Запрос JIT-доступа](./media/security-center-just-in-time/request-just-in-time-access.png)

3. Щелкните **запросить доступ**. Откроется окно **запрос доступа** .

      ![Сведения о JIT](./media/security-center-just-in-time/just-in-time-details.png)

4. В колонке **Запрос на доступ** укажите для каждой виртуальной машины порты, которые нужно открыть, IP-адреса источников для этих портов и временной интервал, в течение которого будет открыт порт. Запрос доступа будет работать только для тех портов, которые настроены в политике JIT. Максимально допустимое время для каждого порта определяется в политике JIT.

5. Щелкните **открыть порты**.

> [!NOTE]
> Если пользователь запрашивает доступ через прокси-сервер, то параметр **Мой IP-адрес** может не работать. Возможно, потребуется определить полный диапазон IP-адресов организации.

## <a name="edit-a-jit-access-policy-via-asc"></a>Изменение политики JIT-доступа с помощью ASC

Вы можете изменить существующую политику JIT-доступа для виртуальной машины, добавив и настроив новый защищенный порт для этой виртуальной машины или изменив любой другой параметр уже настроенного защищенного порта.

Чтобы изменить существующую политику JIT для виртуальной машины, сделайте следующее.
1. На вкладке **Настроенные** в разделе **Виртуальные машины** выберите ту виртуальную машину, для которой нужно добавить порт, щелкнув многоточие в строке этой виртуальной машины. 

1. Выберите **Изменить**
1. В колонке **Настройка JIT-доступа к виртуальной машине** можно изменить существующие параметры уже защищенного порта или добавить новый порт. 
  ![JIT-доступ к виртуальной машине](./media/security-center-just-in-time/edit-policy.png)

## <a name="audit-jit-access-activity-in-asc"></a>Аудит действий JIT-доступа в ASC

Для просмотра действий виртуальной машины можно воспользоваться поиском по журналам. Для просмотра журналов выполните следующие действия:

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Настроенные**.
2. В разделе **виртуальные машины**выберите виртуальную машину для просмотра сведений, щелкнув три точки в строке для этой виртуальной машины и выбрав **Журнал действий** в меню. Откроется **Журнал действий** .

   ![Выбор журнала действий](./media/security-center-just-in-time/select-activity-log.png)

   В колонке **Журнал действий** отображается отфильтрованный список предыдущих операций для этой виртуальной машины, а также дата, время и подписка.

Чтобы скачать сведения журналов, воспользуйтесь ссылкой **Щелкните здесь, чтобы загрузить все элементы в формате CSV**.

Измените фильтры и нажмите кнопку **Применить** , чтобы создать поиск и журнал.



## Настройка JIT-доступа в колонке виртуальной машины Azure<a name="jit-vm"></a>

Для удобства вы можете подключаться к виртуальной машине с помощью JIT-доступа непосредственно из колонки виртуальной машины в Azure.

### <a name="configure-jit-access-on-a-vm-via-the-azure-vm-blade"></a>Настройка JIT-доступа на виртуальной машине с помощью колонки виртуальной машины Azure

Чтобы упростить развертывание доступа JIT на виртуальных машинах, вы можете установить виртуальную машину и разрешить JIT-доступ только непосредственно из виртуальной машины.

1. На портале Azure выберите **Виртуальные машины**.
2. Щелкните виртуальную машину, которой вы хотите ограничить JIT-доступ.
3. В меню выберите **Конфигурация**.
4. В разделе **Just-in-time-access** (JIT-доступ) щелкните **Включить JIT-политику**. 

Это обеспечивает JIT-доступ для виртуальной машины с помощью следующих параметров:

- Серверы Windows:
    - RDP-порт 3389;
    - максимальный интервал доступа 3 часа;
    - Для разрешенных IP-адресов источника задано значение Any
- Серверы Linux:
    - SSH-порт 22;
    - максимальный интервал доступа 3 часа;
    - Для разрешенных IP-адресов источника задано значение Any
     
Если в виртуальной машине уже включена функция JIT, вы увидите это при переходе на страницу конфигурации. Кроме того, вы можете перейти по этой ссылке, чтобы открыть политику в центре безопасности Azure для просмотра и изменения параметров.

![Настройка JIT в виртуальной машине](./media/security-center-just-in-time/jit-vm-config.png)

### <a name="request-jit-access-to-a-vm-via-the-azure-vm-blade"></a>Запрос JIT-доступа к виртуальной машине через колонку виртуальной машины Azure

На портале Azure при попытке подключиться к виртуальной машине Azure проверяет, настроена ли политика JIT-доступа для выбранной виртуальной машины.

- Если на виртуальной машине настроена политика JIT -доступа, вы можете щелкнуть **Запросить доступ** и получить доступ, который настроен в этой политике для выбранной виртуальной машины. 

  >![JIT-запрос](./media/security-center-just-in-time/jit-request.png)

  Доступ запрашивается со следующими параметрами по умолчанию:

  - **Исходный IP-адрес**: "Any" (*) (не может быть изменено)
  - **диапазон времени**: 3 часа (невозможно изменить)  <!--Isn't this set in the policy-->
  - **номер порта** Порт RDP 3389 для Windows или порт 22 для Linux (можно изменить)

    > [!NOTE]
    > После утверждения запроса для виртуальной машины, защищенной с помощью брандмауэра Azure, центр безопасности предоставляет пользователю правильные сведения о подключении (сопоставление портов из таблицы ДНАТ), используемые для подключения к виртуальной машине.

- Если JIT-доступ для виртуальной машины не настроен, вам будет предложено настроить для нее политику JIT-доступа.

  ![Сообщение о JIT-доступе](./media/security-center-just-in-time/jit-prompt.png)

## Программная настройка политики JIT на виртуальной машине<a name="jit-program"></a>

Вы можете настраивать и использовать JIT-доступ через интерфейсы REST API или с помощью PowerShell.

## <a name="jit-vm-access-via-rest-apis"></a>JIT-доступ к виртуальной машине через API-интерфейсы

Функцию JIT-доступа к виртуальной машине можно использовать через API Центра безопасности Azure. Этот API позволяет получать сведения о настроенных виртуальных машинах, добавлять новые виртуальные машины, запрашивать доступ к ним и выполнять другие действия. Дополнительные сведения о REST API для JIT-доступа см. в статье [Jit Network Access Policies](https://docs.microsoft.com/rest/api/securitycenter/jitnetworkaccesspolicies) (Политики JIT-доступа к сети).

## <a name="jit-vm-access-via-powershell"></a>JIT-доступ к виртуальной машине через PowerShell

Чтобы применять решение JIT-доступа к виртуальной машине через PowerShell, можно использовать официальные командлеты PowerShell Центра безопасности Azure, в частности `Set-AzJitNetworkAccessPolicy`.

В следующем примере задается политика JIT-доступа для конкретной виртуальной машины со следующими параметрами.

1.  Закрытие портов 22 и 3389.

2.  Задание максимального временного окна в 3 часа для каждого порта, чтобы они были открыты для каждого утвержденного запроса.
3.  Предоставление пользователю, который запрашивает доступ, разрешения на управление исходными IP-адресами, и предоставление пользователю возможности установить сеанс после утвержденного запроса на JIT-доступ.

В PowerShell выполните следующее.

1.  Присвойте виртуальной машине переменную, которая содержит политику JIT-доступа к этой виртуальной машине:

        $JitPolicy = (@{
         id="/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME"
        ports=(@{
             number=22;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"},
             @{
             number=3389;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"})})

2.  Поместите политику JIT-доступа к виртуальной машине в массив:
    
        $JitPolicyArr=@($JitPolicy)

3.  Настройте на выбранной виртуальной машине политику JIT-доступа:
    
        Set-AzJitNetworkAccessPolicy -Kind "Basic" -Location "LOCATION" -Name "default" -ResourceGroupName "RESOURCEGROUP" -VirtualMachine $JitPolicyArr 

#### <a name="request-access-to-a-vm-via-powershell"></a>Запрос доступа к виртуальной машине с помощью PowerShell

В следующем примере приведен запрос на JIT-доступ к выбранной виртуальной машине, где запрашивается открытие порта 22 для определенного IP-адреса и на определенное время.

В PowerShell выполните следующее.
1.  Настройка свойств запроса доступа к виртуальной машине.

        $JitPolicyVm1 = (@{
          id="/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME"
        ports=(@{
           number=22;
           endTimeUtc="2018-09-17T17:00:00.3658798Z";
           allowedSourceAddressPrefix=@("IPV4ADDRESS")})})
2.  Вставка параметров запроса доступа к виртуальной машине в массив.

        $JitPolicyArr=@($JitPolicyVm1)
3.  Отправка запроса на доступ (с использованием идентификатора ресурса, полученного на шаге 1).

        Start-AzJitNetworkAccessPolicy -ResourceId "/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Security/locations/LOCATION/jitNetworkAccessPolicies/default" -VirtualMachine $JitPolicyArr

Дополнительные сведения см. в документации по командлетам PowerShell.

## <a name="next-steps"></a>Следующие шаги
Из этой статьи вы узнали, как управлять доступом к виртуальным машинам Azure с помощью JIT-доступа в Центре безопасности.

Дополнительные сведения о Центре безопасности см. в следующих статьях:

- [Настройка политик безопасности](tutorial-security-policy.md) — сведения о настройке политик безопасности для подписок и групп ресурсов Azure.
- [Управление рекомендациями по безопасности](security-center-recommendations.md) — сведения об использовании рекомендаций для защиты ресурсов Azure.
- [Наблюдение за работоспособностью системы безопасности](security-center-monitoring.md) — сведения об отслеживании работоспособности ресурсов Azure.
- [Управление оповещениями безопасности](security-center-managing-and-responding-alerts.md) — сведения об управлении оповещениями системы безопасности и реагировании на них.
- [Мониторинг решений партнеров](security-center-partner-solutions.md) — сведения об отслеживании работоспособности решений партнеров.
- [Центр безопасности: часто задаваемые вопросы](security-center-faq.md). Часто задаваемые вопросы об использовании этой службы.
- [Блог по безопасности Azure](https://blogs.msdn.microsoft.com/azuresecurity/) — публикации блога, посвященные безопасности и соответствию требованиям в Azure.

