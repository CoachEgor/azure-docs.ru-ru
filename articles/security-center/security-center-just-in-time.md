---
title: JIT-доступ к виртуальным машинам в Центре безопасности Azure | Документация Майкрософт
description: В этом документе описано, как JIT-доступ в Центре безопасности Azure помогает управлять доступом к виртуальным машинам Azure.
services: security-center
documentationcenter: na
author: monhaber
manager: barbkess
editor: ''
ms.assetid: ''
ms.service: security-center
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 3/28/2019
ms.author: v-mohabe
ms.openlocfilehash: b07a89491343220c5c3411b5fc525f9b43f54e30
ms.sourcegitcommit: e9a46b4d22113655181a3e219d16397367e8492d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2019
ms.locfileid: "65968442"
---
# <a name="manage-virtual-machine-access-using-just-in-time"></a>Управление доступом к виртуальным машинам с помощью JIT-доступа

JIT-доступ к виртуальной машине позволяет заблокировать входящий трафик к виртуальным машинам Azure, снизить уязвимость к атакам и обеспечить удобный доступ к виртуальным машинам, когда это необходимо.

> [!NOTE]
> Функция JIT-доступа предоставляется в Центре безопасности Azure ценовой категории "Стандартный".  Дополнительные сведения о ценовых категориях центра безопасности см. на странице [Цены](security-center-pricing.md).
>
>

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="attack-scenario"></a>Сценарий атаки

Целью атак методом подбора часто становятся порты управления как средство получения доступа к виртуальной машине. В случае успешной атаки злоумышленник может установить контроль над виртуальной машиной и закрепиться в вашей среде.

Один из способов снижения вероятности атаки методом подбора — ограничить количество времени, в течение которого порт открыт. Порты управления не должны быть открыты всегда. Они должны быть открыты только при подключении к виртуальной машине, например для выполнения задач управления или обслуживания. Если JIT-доступ включен, Центр безопасности с помощью правил [группы безопасности сети](../virtual-network/security-overview.md#security-rules) ограничивает доступ к портам управления, чтобы они не стали целью злоумышленников.

![Сценарий JIT-доступа](./media/security-center-just-in-time/just-in-time-scenario.png)

## <a name="how-does-jit-access-work"></a>Как работает JIT-доступ?

Если включен JIT-доступ, Центр безопасности создает правило группы безопасности сети для блокирования входящего трафика, поступающего на виртуальную машину Azure. Вы выбираете порты на виртуальной машине, для которых будет заблокирован входящий трафик. Этими портами управляет решение JIT-доступа.

Когда пользователь запрашивает доступ к виртуальной машине, Центр безопасности проверяет наличие у пользователя разрешений [управления доступом на основе ролей (RBAC)](../role-based-access-control/role-assignments-portal.md), которые позволяют предоставлять доступ к виртуальной машине. Если запрос подтвержден, Центр безопасности автоматически настраивает группу безопасности сети, которая разрешает передачу входящего трафика через выбранные порты с указанных IP-адресов или диапазонов адресов на указанный период времени. После истечения этого времени центр безопасности восстанавливает прежнее состояние групп безопасности сети. Однако это не прерывает установленные подключения.

> [!NOTE]
> Механизм JIT-доступа Центра безопасности сейчас поддерживается только для виртуальных машин, развернутых с помощью Azure Resource Manager. Дополнительные сведения о классической модели развертывания и модели развертывания Resource Manager см. в разделе [Модель развертывания Azure Resource Manager и классическая модель развертывания](../azure-resource-manager/resource-manager-deployment-model.md).
>
>

JIT-доступ можно получить следующими способами.
- [Использование JIT-доступа в Центре безопасности Azure](#jit-asc).
- [Использование JIT-доступа в колонке виртуальной машины Azure](#jit-vm).

## Использование JIT-доступа в Центре безопасности Azure <a name="jit-asc"></a>

1. Откройте панель мониторинга **центра безопасности**.

2. На панели слева выберите **JIT-доступ к виртуальной машине**.

![Плитка "JIT-доступ к виртуальной машине"](./media/security-center-just-in-time/just-in-time.png)

Откроется окно **JIT-доступ к виртуальной машине**.

![Плитка "JIT-доступ к виртуальной машине"](./media/security-center-just-in-time/just-in-time-access.png)

На плитке **JIT-доступ к виртуальной машине** содержатся сведения о состоянии виртуальных машин.

- **Настроенные** — виртуальные машины, для которых была настроена поддержка JIT-доступа. Указываются сведения за последнюю неделю, которые включают число одобренных запросов, дату и время последнего доступа и последнего пользователя для каждой виртуальной машины.
- **Рекомендуемые** — виртуальные машины, для которых JIT-доступ возможен, но пока не настроен. Мы рекомендуем включить JIT-доступ для всех этих виртуальных машин. Подробные сведения см. в статье [Управление доступом к виртуальным машинам с помощью JIT](#jit-config).
- **Нерекомендуемые** — причины, по которым виртуальная машина может попасть в эту группу, включают следующие:
  - Отсутствует группа безопасности сети — для решения JIT необходимо наличие группы безопасности сети.
  - Классическая виртуальная машина — JIT-доступ с использованием Центра безопасности сейчас поддерживается только для виртуальных машин, развернутых с помощью Azure Resource Manager. JIT-доступ для классической модели развертывания не поддерживается.
  - Другое — виртуальная машина находится в этой категории, если решение JIT отключено в политике безопасности для подписки или группы ресурсов или если виртуальная машина не имеет общедоступного IP-адреса и для нее не создана группа безопасности сети.

### Настройка политики JIT-доступа<a name="jit-config"></a>

Чтобы выбрать виртуальные машины, для которых вы хотите включить JIT-доступ, выполните следующие действия:

1. В колонке **JIT-доступ к виртуальной машине** выберите вкладку **Рекомендуемые**.

   ![Включение JIT-доступа](./media/security-center-just-in-time/enable-just-in-time-access.png)

2. В разделе **Виртуальная машина** выберите виртуальные машины, доступ к которым нужно включить. При этом устанавливается флажок рядом с виртуальной машиной.
3. Выберите **Включить JIT-доступ для виртуальных машин**.
   1. В этой колонке отображаются порты по умолчанию, рекомендованные Центром безопасности Azure:
      - 22 — SSH;
      - 3389 — RDP;
      - 5985 — WinRM; 
      - 5986 — WinRM.
   2. Вы также можете настроить пользовательские порты. Для этого выберите действие **Добавить**. 
   3. В разделе **Добавление конфигурации порта** вы можете настроить для каждого порта (стандартного или пользовательского) следующие параметры:
      - **Тип протокола** — указывает, какой протокол разрешается для этого порта после утверждения запроса;
      - **Allowed source IP addresses** (Разрешенные IP-адреса источника) — диапазоны IP-адресов, с которых разрешается доступ к этому порту после утверждения запроса;
      - **Максимальное время запроса** — максимальный интервал времени, в течение которого может быть открыт этот порт.

4. Щелкните **Сохранить**.


> [!NOTE]
>При включении JIT-доступ к виртуальной Машине для виртуальной Машины центра безопасности Azure создает правила «запретить весь входящий трафик» для выбранных портов в группы безопасности сети, связанные с ним. Если другие правила была создана для выбранных портов, существующие правила имеют приоритет перед новые правила «запретить весь входящий трафик». Если нет существующих правил на выбранных портов, новые правила «запретить весь входящий трафик» имеют верхний приоритет в группах безопасности сети.
>

### <a name="request-jit-access-to-a-vm"></a>Запрос JIT-доступа к виртуальной машине

Чтобы запросить доступ к виртуальной машине, выполните следующие действия:
1.  В колонке **JIT-доступ к виртуальной машине** выберите **Настроенные**.
2.  В списке **виртуальных машин** установите флажки для тех виртуальных машин, на которых вы хотите включить JIT-доступ.
3.  Выберите **Запросить доступ**. 
  ![Запрос доступа к виртуальной машине](./media/security-center-just-in-time/request-access-to-a-vm.png)
4.  В колонке **Запрос на доступ** укажите для каждой виртуальной машины порты, которые нужно открыть, IP-адреса источников для этих портов и временной интервал, в течение которого будет открыт порт. Запрос доступа будет работать только для тех портов, которые настроены в политике JIT. Максимально допустимое время для каждого порта определяется в политике JIT.
5.  Выберите **Открыть порты**.

> [!NOTE]
> Если пользователь запрашивает доступ через прокси-сервер, то параметр **Мой IP-адрес** может не работать. Возможно, потребуется определить полный диапазон IP-адресов организации.

### <a name="editing-a-jit-access-policy"></a>Изменение политики JIT-доступа

Вы можете изменить существующую политику JIT-доступа для виртуальной машины, добавив и настроив новый защищенный порт для этой виртуальной машины или изменив любой другой параметр уже настроенного защищенного порта.

Чтобы изменить существующую политику JIT для виртуальной машины, сделайте следующее.
1. На вкладке **Настроенные** в разделе **Виртуальные машины** выберите ту виртуальную машину, для которой нужно добавить порт, щелкнув многоточие в строке этой виртуальной машины. 
2. Выберите **Изменить**
3. В колонке **Настройка JIT-доступа к виртуальной машине** можно изменить существующие параметры уже защищенного порта или добавить новый порт. Дополнительные сведения см. в статье [Управление доступом к виртуальным машинам с помощью JIT](#jit-config). 
  ![JIT-доступ к виртуальной машине](./media/security-center-just-in-time/edit-policy.png)

## Использование JIT-доступа в колонке виртуальной машины Azure <a name="jit-vm"></a>

Для удобства вы можете подключаться к виртуальной машине с помощью JIT-доступа непосредственно из колонки виртуальной машины в Azure.

### <a name="configuring-a-just-in-time-access-policy"></a>Настройка политики JIT-доступа 
Чтобы упростить развертывание доступа JIT на виртуальных машинах, вы можете установить виртуальную машину и разрешить JIT-доступ только непосредственно из виртуальной машины.

1. На портале Azure выберите **Виртуальные машины**.
2. Щелкните виртуальную машину, которой вы хотите ограничить JIT-доступ.
3. В меню выберите **Конфигурация**.
4. В разделе **Just-in-time-access** (JIT-доступ) щелкните **Включить JIT-политику**. 

Это обеспечивает JIT-доступ для виртуальной машины с помощью следующих параметров:

- Серверы Windows:
    - RDP-порт 3389;
    - максимальный интервал доступа 3 часа;
    - Разрешенные исходные IP-адреса имеет значение Any
- Серверы Linux:
    - SSH-порт 22;
    - максимальный интервал доступа 3 часа;
    - Разрешенные исходные IP-адреса имеет значение Any
     
Если в виртуальной машине уже включена функция JIT, вы увидите это при переходе на страницу конфигурации. Кроме того, вы можете перейти по этой ссылке, чтобы открыть политику в центре безопасности Azure для просмотра и изменения параметров.

![Настройка JIT в виртуальной машине](./media/security-center-just-in-time/jit-vm-config.png)

### <a name="requesting-jit-access-to-a-vm"></a>Запрос JIT-доступа к виртуальной машине

На портале Azure при попытке подключиться к виртуальной машине Azure проверяет, настроена ли политика JIT-доступа для выбранной виртуальной машины.

- Если JIT-доступ для виртуальной машины не настроен, вам будет предложено настроить для нее политику JIT-доступа.

  ![Сообщение о JIT-доступе](./media/security-center-just-in-time/jit-prompt.png)

- Если на виртуальной машине настроена политика JIT -доступа, вы можете щелкнуть **Запросить доступ** и получить доступ, который настроен в этой политике для выбранной виртуальной машины. Запрашивается доступ со следующими параметрами по умолчанию:
    - **Исходный IP-адрес**: «Any» (*) (не может быть изменено)
    - **диапазон времени**: 3 часа (не может быть изменено)
    - **номер порта** RDP порт 3389 для Windows / порт 22 для Linux (можно изменить номер порта в **подключиться к виртуальной машине** диалоговое окно.)


  >![Запрос JIT-доступа](./media/security-center-just-in-time/jit-request-access.png)

## <a name="auditing-jit-access-activity"></a>Аудит действий JIT-доступа

Для просмотра действий виртуальной машины можно воспользоваться поиском по журналам. Для просмотра журналов выполните следующие действия:

1. В колонке **JIT-доступ к виртуальной машине** перейдите на вкладку **Настроенные**.
2. В разделе **Виртуальные машины** выберите виртуальную машину, сведения о которой нужно просмотреть, щелкнув многоточие в строке для этой виртуальной машины. Откроется меню.
3. Выберите **Журнал действий** в меню. Откроется колонка **Журнал действий**.

   ![Выбор журнала действий](./media/security-center-just-in-time/select-activity-log.png)

   В колонке **Журнал действий** отображается отфильтрованный список предыдущих операций для этой виртуальной машины, а также дата, время и подписка.

Чтобы скачать сведения журналов, воспользуйтесь ссылкой **Щелкните здесь, чтобы загрузить все элементы в формате CSV**.

Чтобы изменить отображаемые сведения журнала, измените фильтры и нажмите **Применить**.


## <a name="permissions-needed-to-configure-and-use-jit"></a>Разрешения, необходимые для настройки и использования JIT-доступа

Установите эти обязательные разрешения, чтобы разрешить пользователю настраивать или изменять политику JIT-доступа для виртуальной машины.

Назначьте этой роли следующие *действия*. 
- В области подписки или группы ресурсов, связанной с виртуальной машиной:
  - Microsoft.Security/locations/jitNetworkAccessPolicies/write
- В области подписки, группы ресурсов или виртуальной машины:
  - Microsoft.Compute/virtualMachines/write 

Задайте эти привилегии, чтобы позволить пользователю успешно запрашивать JIT-доступ к виртуальной машине: Назначьте пользователю следующие *действия*:
- В области подписки или группы ресурсов, связанной с виртуальной машиной:
  - Microsoft.Security/locations/{the_location_of_the_VM}/jitNetworkAccessPolicies/ initiate/action
- В области подписки, группы ресурсов или виртуальной машины:
  - Microsoft.Compute/virtualMachines/read



## <a name="use-jit-programmatically"></a>Использование JIT-доступа программным способом
Вы можете настраивать и использовать JIT-доступ через интерфейсы REST API или с помощью PowerShell.

### <a name="using-just-in-time-vm-access-via-rest-apis"></a>Использование JIT-доступа к виртуальной машине через REST API

Функцию JIT-доступа к виртуальной машине можно использовать через API Центра безопасности Azure. Этот API позволяет получать сведения о настроенных виртуальных машинах, добавлять новые виртуальные машины, запрашивать доступ к ним и выполнять другие действия. Дополнительные сведения о REST API для JIT-доступа см. в статье [Jit Network Access Policies](https://docs.microsoft.com/rest/api/securitycenter/jitnetworkaccesspolicies) (Политики JIT-доступа к сети).

### <a name="using-jit-vm-access-via-powershell"></a>Использование JIT-доступа к виртуальной машине через PowerShell 

Чтобы применять решение JIT-доступа к виртуальной машине через PowerShell, можно использовать официальные командлеты PowerShell Центра безопасности Azure, в частности `Set-AzJitNetworkAccessPolicy`.

В следующем примере задается политика JIT-доступа для конкретной виртуальной машины со следующими параметрами.
1.  Закрытие портов 22 и 3389.
2.  Задание максимального временного окна в 3 часа для каждого порта, чтобы они были открыты для каждого утвержденного запроса.
3.  Предоставление пользователю, который запрашивает доступ, разрешения на управление исходными IP-адресами, и предоставление пользователю возможности установить сеанс после утвержденного запроса на JIT-доступ.

В PowerShell выполните следующее.

1.  Присвойте виртуальной машине переменную, которая содержит политику JIT-доступа к этой виртуальной машине:

        $JitPolicy = (@{
         id="/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME"
        ports=(@{
             number=22;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"},
             @{
             number=3389;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"})})

2.  Поместите политику JIT-доступа к виртуальной машине в массив:
    
        $JitPolicyArr=@($JitPolicy)

3.  Настройте на выбранной виртуальной машине политику JIT-доступа:
    
        Set-AzJitNetworkAccessPolicy -Kind "Basic" -Location "LOCATION" -Name "default" -ResourceGroupName "RESOURCEGROUP" -VirtualMachine $JitPolicyArr 

#### <a name="requesting-access-to-a-vm"></a>Запрос доступа к виртуальной машине

В следующем примере приведен запрос на JIT-доступ к выбранной виртуальной машине, где запрашивается открытие порта 22 для определенного IP-адреса и на определенное время.

В PowerShell выполните следующее.
1.  Настройка свойств запроса доступа к виртуальной машине.

        $JitPolicyVm1 = (@{
          id="/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME"
        ports=(@{
           number=22;
           endTimeUtc="2018-09-17T17:00:00.3658798Z";
           allowedSourceAddressPrefix=@("IPV4ADDRESS")})})
2.  Вставка параметров запроса доступа к виртуальной машине в массив.

        $JitPolicyArr=@($JitPolicyVm1)
3.  Отправка запроса на доступ (с использованием идентификатора ресурса, полученного на шаге 1).

        Start-AzJitNetworkAccessPolicy -ResourceId "/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Security/locations/LOCATION/jitNetworkAccessPolicies/default" -VirtualMachine $JitPolicyArr

Дополнительные сведения см. в документации по командлетам PowerShell.


## <a name="next-steps"></a>Дальнейшие действия
Из этой статьи вы узнали, как управлять доступом к виртуальным машинам Azure с помощью JIT-доступа в Центре безопасности.

Дополнительные сведения о Центре безопасности см. в следующих статьях:

- [Настройка политик безопасности](tutorial-security-policy.md) — сведения о настройке политик безопасности для подписок и групп ресурсов Azure.
- [Управление рекомендациями по безопасности](security-center-recommendations.md) — сведения об использовании рекомендаций для защиты ресурсов Azure.
- [Наблюдение за работоспособностью системы безопасности](security-center-monitoring.md) — сведения об отслеживании работоспособности ресурсов Azure.
- [Управление оповещениями безопасности](security-center-managing-and-responding-alerts.md) — сведения об управлении оповещениями системы безопасности и реагировании на них.
- [Мониторинг решений партнеров](security-center-partner-solutions.md) — сведения об отслеживании работоспособности решений партнеров.
- [Центр безопасности: часто задаваемые вопросы](security-center-faq.md). Часто задаваемые вопросы об использовании этой службы.
- [Блог по безопасности Azure](https://blogs.msdn.microsoft.com/azuresecurity/) — публикации блога, посвященные безопасности и соответствию требованиям в Azure.

