---
title: Переходные ошибки подключения - База данных Azure для MyS'L
description: Узнайте, как обрабатывать временные ошибки подключения и эффективно подключаться к базе данных Azure для MyS'L.
keywords: mysql соединение,строка соединения,проблемы соединения,переходная ошибка,ошибка соединения,соединяют эффективно
author: jan-eng
ms.author: janeng
ms.service: mysql
ms.topic: conceptual
ms.date: 3/18/2020
ms.openlocfilehash: 79c5c7e485cc9cb03757b8a981cef92d79b81c3d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79537182"
---
# <a name="handle-transient-errors-and-connect-efficiently-to-azure-database-for-mysql"></a>Обработка временных ошибок и эффективное подключение к базе данных Azure для MyS'L

В этой статье описывается, как обрабатывать временные ошибки и эффективно подключаться к базе данных Azure для MyS'L.

## <a name="transient-errors"></a>Временные ошибки

Временная ошибка, также известная как временный сбой, является ошибкой, которая устраняется автоматически. Чаще всего эти ошибки проявляются в виде сброса соединения с сервером базы данных. При этом невозможно установить новые подключения к серверу. Временные ошибки могут возникать, например, при сбое оборудования или сети. Другой причиной может быть новая версия службы PaaS, которая в настоящее время развернута. Большинство из этих событий автоматически смягчаются системой менее чем за 60 секунд. При проектировании и разработке приложений в облаке рекомендуется учитывать возможность временных ошибок. Нужно учитывать, что они могут произойти в любом компоненте в любое время, и предусмотреть соответствующую логику для таких ситуаций.

## <a name="handling-transient-errors"></a>Обработка временных ошибок

Временные ошибки следует обрабатывать с использованием логики повторных подключений. Нужно учитывать следующие ситуации.

* При попытке открыть соединение возникает ошибка.
* Неактивное подключение сбрасывается на стороне сервера. Попытка выполнить команду завершается сбоем.
* Активное подключение, по которому в настоящее время выполняется команда, сбрасывается.

Ошибки первого и второго типа достаточно просто устранить. Попробуйте открыть подключение еще раз. Когда вам это удастся, система устранит временную ошибку. Базу данных Azure для MySQL можно использовать снова. Мы рекомендуем подождать перед повторной попыткой подключения. Отключитесь, если исходные повторные попытки не дают результата. Таким образом, система может использовать все доступные ресурсы для устранения ошибки. Ниже приведен шаблон для выполнения.

* Подождите 5 секунд перед первой повторной попыткой.
* Для каждой следующей попытки увеличивайте время ожидания экспоненциально до 60 секунд.
* Задайте максимальное число повторных попыток, после чего приложение подтвердит сбой операции.

Когда происходит сбой подключения с активной транзакцией, управлять процессом восстановления становится сложнее. Существует два варианта: если транзакция была доступна только для чтения, вы можете безопасно повторно открыть подключение и повторить транзакцию. Если транзакция также писала в базу данных, необходимо определить, была ли транзакция откатной, или же она была выполнена до того, как произошла переходная ошибка. В этом случае вы можете просто не получить подтверждение коммита с сервера базы данных.

Один из способов сделать это — создать уникальный идентификатор на клиенте, который используется для всех повторных попыток. Вы передаете этот уникальный идентификатор как часть транзакции на сервер и сохраняете его в столбце с уникальным ограничением. Таким образом можно безопасно повторить транзакцию. Это будет успешно, если предыдущая транзакция была откатной и сгенерированный клиентом уникальный идентификатор еще не существует в системе. Произойдет сбой с оповещением о дубликате ключа, если уникальный идентификатор был сохранен ранее в результате успешной транзакции.

Если программа взаимодействует с Базой данных Azure для MySQL через стороннее программное обеспечение промежуточного слоя, спросите поставщика, предусмотрена ли в этом программном обеспечении логика повторных попыток в случае временных ошибок.

Не забудьте проверить логику повторных попыток. Например, попробуйте выполнить код при масштабировании или вниз вычислительных ресурсов базы данных Azure для сервера MyS'L. Ваше приложение должно без каких-либо проблем справиться с небольшим простоем во время этой операции.

## <a name="connect-efficiently-to-azure-database-for-mysql"></a>Эффективное подключение к базе данных Azure для MyS'L

Соединения баз данных являются ограниченным ресурсом, поэтому эффективное использование объединения соединений для доступа к базе данных Azure для MyS'L оптимизирует производительность. В нижеприведенном разделе объясняется, как использовать объединение соединений или постоянные соединения для более эффективного доступа к базе данных Azure для MyS'L.

## <a name="access-databases-by-using-connection-pooling-recommended"></a>Доступ к базам данных с помощью объединения соединений (рекомендуется)

Управление соединениями баз данных может оказать значительное влияние на производительность приложения в целом. Чтобы оптимизировать производительность приложения, цель должна заключаться в сокращении количества установленных подключений и времени на создание соединений в ключевых путях кода. Мы настоятельно рекомендуем использовать объединение соединений с базами данных или постоянные соединения для подключения к базе данных Azure для MyS'L. Объединение соединения баз данных обрабатывает создание, управление и распределение соединений баз данных. Когда программа запрашивает подключение базы данных, она отостоит приоритеты между распределением существующих простоемых соединений базы данных, а не созданием нового соединения. После завершения программы с использованием соединения базы данных соединение восстанавливается в рамках подготовки к дальнейшему использованию, а не просто закрывается.

Для лучшей иллюстрации в этой статье приводится [часть кода образца,](./sample-scripts-java-connection-pooling.md) в качестве примера — JAVA. Для получения дополнительной информации, [см. Apache общий DBCP](https://commons.apache.org/proper/commons-dbcp/).

> [!NOTE]
> Сервер настраивает механизм тайм-аута для закрытия соединения, которое находилось в простое состояние в течение некоторого времени, чтобы высвободить ресурсы. Обязательно настроили систему проверки, чтобы обеспечить эффективность постоянных подключений при их использовании. Для получения дополнительной информации [см. Системы проверки на стороне клиента, чтобы обеспечить эффективность постоянных подключений.](concepts-connectivity.md#configure-verification-mechanisms-in-clients-to-confirm-the-effectiveness-of-persistent-connections)

## <a name="access-databases-by-using-persistent-connections-recommended"></a>Доступ к базам данных с помощью постоянных соединений (рекомендуется)

Концепция постоянных соединений аналогична концепции объединения соединений. Замена коротких соединений постоянными соединениями требует лишь незначительных изменений в коде, но имеет большой эффект с точки зрения повышения производительности во многих типичных сценариях приложений.

## <a name="access-databases-by-using-wait-and-retry-mechanism-with-short-connections"></a>Доступ к базам данных с помощью механизма ожидания и повторной попытки с короткими соединениями

Если у вас есть ограничения ресурсов, мы настоятельно рекомендуем использовать объединение баз данных или постоянные соединения для доступа к базам данных. Если приложение использует короткие соединения и испытывают сбои в подключении при приближении к верхнему пределу количества одновременных соединений, можно попробовать механизм ожидания и повторной попытки. Вы можете установить соответствующее время ожидания, с более коротким временем ожидания после первой попытки. После этого вы можете попробовать ждать событий несколько раз.

## <a name="configure-verification-mechanisms-in-clients-to-confirm-the-effectiveness-of-persistent-connections"></a>Настройка механизмов проверки клиентов для подтверждения эффективности постоянных связей

Сервер настраивает механизм тайм-аута, чтобы закрыть соединение, которое в течение некоторого времени находилось в простое состояние, чтобы высвободить ресурсы. Когда клиент снова получает доступ к базе данных, это эквивалентно созданию нового запроса на подключение между клиентом и сервером. Для обеспечения эффективности подключений в процессе их использования назначайте механизм проверки на клиента. Как показано в следующем примере, можно использовать объединение соединения Tomcat JDBC для настройки этого механизма проверки.

Установив параметр TestOnBorrow, когда есть новый запрос, пул соединения автоматически проверяет эффективность любых доступных простоев соединений. Если такое соединение эффективно, то его непосредственно возвращенный в противном случае пул соединения снимает соединение. Затем пул соединения создает новое эффективное соединение и возвращает его. Этот процесс обеспечивает эффективный доступ к базе данных. 

Для получения информации о конкретных настройках, см. [JDBC connection pool official introduction document](https://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html#Common_Attributes) В основном необходимо установить следующие три параметра: TestOnBorrow (набор на истину), Валидация Кевери (набор select 1), и Валидация КевирТаймаут (установлен на 1). Ниже показан конкретный пример кода:

```java
public class SimpleTestOnBorrowExample {
      public static void main(String[] args) throws Exception {
          PoolProperties p = new PoolProperties();
          p.setUrl("jdbc:mysql://localhost:3306/mysql");
          p.setDriverClassName("com.mysql.jdbc.Driver");
          p.setUsername("root");
          p.setPassword("password");
            // The indication of whether objects will be validated by the idle object evictor (if any). 
            // If an object fails to validate, it will be dropped from the pool. 
            // NOTE - for a true value to have any effect, the validationQuery or validatorClassName parameter must be set to a non-null string. 
          p.setTestOnBorrow(true); 

            // The SQL query that will be used to validate connections from this pool before returning them to the caller.
            // If specified, this query does not have to return any data, it just can't throw a SQLException.
          p.setValidationQuery("SELECT 1");

            // The timeout in seconds before a connection validation queries fail. 
            // This works by calling java.sql.Statement.setQueryTimeout(seconds) on the statement that executes the validationQuery. 
            // The pool itself doesn't timeout the query, it is still up to the JDBC driver to enforce query timeouts. 
            // A value less than or equal to zero will disable this feature.
          p.setValidationQueryTimeout(1);
            // set other useful pool properties.
          DataSource datasource = new DataSource();
          datasource.setPoolProperties(p);

          Connection con = null;
          try {
            con = datasource.getConnection();
            // execute your query here
          } finally {
            if (con!=null) try {con.close();}catch (Exception ignore) {}
          }
      }
  }
```

## <a name="next-steps"></a>Дальнейшие действия

* [Узнайте, как устранить проблемы с подключением к Базе данных Azure для MySQL](howto-troubleshoot-common-connection-issues.md)
