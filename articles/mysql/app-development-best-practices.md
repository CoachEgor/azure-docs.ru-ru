---
title: Рекомендации по разработке приложений — База данных Azure для MySQL
description: Дополнительные сведения о рекомендациях при создании приложения с помощью базы данных Azure для MySQL
author: mksuni
ms.author: sumuth
ms.service: mysql
ms.topic: conceptual
ms.date: 08/11/2020
ms.openlocfilehash: 36f9cfa2369032351f6ed2948fc0c98c1648bcb6
ms.sourcegitcommit: ef055468d1cb0de4433e1403d6617fede7f5d00e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2020
ms.locfileid: "88259257"
---
# <a name="best-practices-for-building-applications-with-azure-database-for-mysql"></a>Рекомендации по созданию приложений с помощью базы данных Azure для MySQL 

Ниже приведены некоторые рекомендации по созданию приложений, готовых к работе в облаке, с помощью базы данных Azure для MySQL, которые могут сократить время разработки приложения. 

## <a name="application-and-database-resource-configuration"></a>Конфигурация ресурсов приложения и базы данных

### <a name="application-and-database-in-the-same-region"></a>Приложение и база данных в одном регионе
Убедитесь **, что все зависимости находятся в одном регионе**  при развертывании приложения в Azure. Распределение экземпляров по регионам или зонам доступности создает задержку в сети, что может повлиять на общую производительность приложения. 

### <a name="keep-your-mysql-server-secure"></a>Обеспечьте безопасность сервера MySQL
Сервер MySQL должен быть настроен как [безопасный](https://docs.microsoft.com/azure/mysql/concepts-security) и недоступный для общего доступа. Для защиты сервера используйте один из следующих вариантов. 
- [Правила брандмауэра](https://docs.microsoft.com/azure/mysql/concepts-firewall-rules) или
- [Виртуальные сети](https://docs.microsoft.com/azure/mysql/concepts-data-access-and-security-vnet) или 
- [Приватный канал](https://docs.microsoft.com/azure/mysql/concepts-data-access-security-private-link)

Для обеспечения безопасности необходимо всегда подключаться к серверу MySQL по **протоколу SSL** и настроить сервер MySQL и приложение для использования **TLS 1.2**. См. раздел [Настройка SSL/TLS](https://docs.microsoft.com/azure/mysql/concepts-ssl-connection-security). 

### <a name="tune-your-server-parameters"></a>Настройка параметров сервера
Для рабочих нагрузок с интенсивным чтением, которые настраивает эти параметры, "tmp_table_size и max_heap_table_size" могут помочь оптимизировать для повышения производительности. Чтобы вычислить значения, необходимые для tmp_table_size и max_heap_table_size, просмотрите общие значения памяти для каждого подключения и базовую память. Сумма параметров памяти для каждого подключения, исключая tmp_table_size, в сочетании с учетными записями базовой памяти для общего объема памяти сервера.

Чтобы вычислить максимально возможный размер tmp_table_size и max_heap_table_size, используйте следующую формулу:

```(total memory - (base memory + (sum of per-connection memory * # of connections)) / # of connections```

>[!NOTE]
> Общий объем памяти указывает общий объем памяти, установленной на сервере для виртуальных ядер.  Например, в общего назначения 2 Виртуальное ядро базы данных Azure для сервера MySQL общий объем памяти будет 5 ГБ * 2.  Дополнительные сведения о памяти для каждого уровня можно найти в документации по [ценовой](https://docs.microsoft.com/azure/mysql/concepts-pricing-tiers) категории.
> Базовая память указывает переменные памяти, такие как query_cache_size и innodb_buffer_pool_size, которые MySQL инициализирует и выделяет при запуске сервера.  Память для каждого подключения, например sort_buffer_size и join_buffer_size, является памятью, которая выделяется только в том случае, если она требуется запросу.

### <a name="create-a-non-admin-user"></a>Создание пользователя без прав администратора 
[Создавайте пользователей без прав администратора](https://docs.microsoft.com/azure/mysql/howto-create-users) для каждой базы данных. Как правило, имена пользователей определяются как имена баз данных.

### <a name="resetting-your-password"></a>Сброс пароля
Вы можете [сбросить пароль](https://docs.microsoft.com/azure/mysql/howto-create-manage-server-portal#update-admin-password) для сервера MySQL с помощью портал Azure. 

Сброс пароля сервера для рабочей базы данных может привести к отключению приложения. Это хороший шаблон для сброса пароля для любых рабочих нагрузок в нерабочее время, чтобы снизить влияние на работу конечных пользователей приложения.

## <a name="performance-and-resiliency"></a>Производительность и устойчивость 
Ниже приведены некоторые средства и шаблоны, которые можно использовать для отладки проблем с производительностью приложения.

### <a name="enable-slow-query-logs-identify-performance-issues"></a>Включение журналов медленных запросов выявление проблем с производительностью
На сервере можно включить [журналы запросов](https://docs.microsoft.com/azure/mysql/concepts-server-logs) и [аудита](https://docs.microsoft.com/azure/mysql/concepts-audit-logs) . Анализ медленных журналов запросов помогает определить узкие места производительности для устранения неполадок. 

Журналы аудита также доступны в журналах диагностики Azure в Azure Monitor журналах, концентраторах событий и учетной записи хранения. См. статью [Устранение проблем с производительностью запросов](https://docs.microsoft.com/azure/mysql/howto-troubleshoot-query-performance).

### <a name="use-connection-pooling"></a>Использование пула соединений
Управление подключениями к базе данных может оказать значительное влияние на производительность приложения в целом. Для оптимизации производительности необходимо уменьшить число установленных соединений и время установления соединений в путях кода ключей.  Используйте [пулы подключений](https://docs.microsoft.com/azure/mysql/concepts-connectivity#access-databases-by-using-connection-pooling-recommended) для подключения к базе данных Azure для MySQL, чтобы повысить устойчивость и производительность. 

[Проксискл](https://proxysql.com/), который является пулом подключений, может эффективно использоваться для управления соединениями. Использование пула подключений может уменьшить время бездействия подключений и повторно использовать существующие подключения, что поможет избежать проблем. Дополнительные сведения см. [в разделе Настройка проксискл](https://techcommunity.microsoft.com/t5/azure-database-for-mysql/connecting-efficiently-to-azure-database-for-mysql-with-proxysql/ba-p/1279842) . 

### <a name="retry-logic-to-handle-transient-errors"></a>Логика повторных попыток для обработки временных ошибок
Приложение может столкнуться с [временными ошибками](https://docs.microsoft.com/azure/mysql/concepts-connectivity#handling-transient-errors) , когда подключения к базе данных удаляются или удаляются периодически. В таких ситуациях сервер работает и работает после двух повторных попыток через 5-10 секунд. 

Хороший шаблон для выполнения повторных попыток — подождать 5 секунд перед первой попыткой, а затем выполнить каждую повторную попытку, увеличив время ожидания до 60 секунд. Ограничьте максимальное число повторных попыток, после которого приложение считает, что операция завершилась сбоем, поэтому вы можете продолжить исследование. Дополнительные сведения см. в разделе [Устранение ошибок подключения](https://docs.microsoft.com/azure/mysql/howto-troubleshoot-common-connection-issues) . 

### <a name="enable-read-replication-to-mitigate-failovers"></a>Включение репликации чтения для устранения отработки отказа
Для сценариев отработки отказа можно использовать [репликацию данных](https://docs.microsoft.com/azure/mysql/howto-data-in-replication) . При использовании реплики чтения происходит автоматическая отработка отказа между главным сервером и серверами реплики. Обратите внимание на задержку между главным и репликой, так как репликация выполняется асинхронно. На задержку сети может влиять множество факторов, таких как интенсивность выполнения рабочей нагрузки главного сервера и задержка между центрами обработки данных. В большинстве случаев задержка реплики составляет от нескольких секунд до пары минут.

## <a name="database-deployment"></a>Развертывание базы данных 

### <a name="configure-azure-database-for-mysql-task-in-your-cicd-deployment-pipeline"></a>Настройка задачи "база данных Azure для MySQL" в конвейере развертывания CI/CD
Иногда требуется развернуть изменения в базе данных. В таких случаях можно создать использование непрерывной интеграции (CI) и непрерывной поставки (CD) через [конвейеры Azure](https://azure.microsoft.com/services/devops/pipelines/) и использовать задачу [сервера MySQL](https://docs.microsoft.com/azure/devops/pipelines/tasks/deploy/azure-mysql-deployment?view=azure-devops) для обновления базы данных, запустив пользовательский скрипт в базе данных.

### <a name="manual-database-deployment"></a>Ручное развертывание базы данных 
При ручном развертывании базы данных ниже приведен хороший шаблон, который следует выполнить, чтобы свести к минимуму время простоя или снизить риск неудачного развертывания: 

1. Создание копии рабочей базы данных в новой базе данных с помощью [mysqldump](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html) или [MySQL Workbench](https://dev.mysql.com/doc/workbench/en/wb-admin-export-import-management.html) 
2. Обновите новую базу данных новыми изменениями схемы или обновлениями, необходимыми для базы данных. 
3. Перевод рабочей базы данных в состояние "только для чтения". В рабочей базе данных не должно быть операций записи, пока развертывание не будет завершено. 
4. Протестируйте приложение с обновленной базой данных, созданной на шаге 1.
5. Разверните изменения приложения и убедитесь, что приложение теперь использует новую базу данных с последними обновлениями. 
6. Используйте старую рабочую базу данных, чтобы можно было откатить изменения. Затем можно будет либо удалить старую рабочую базу данных, либо экспортировать ее в службу хранилища Azure, если это необходимо. 

>[!NOTE]
>  - Если приложение похоже на приложение для электронной коммерции, в котором вы не можете перевести его в состояние только для чтения, то после создания резервной копии необходимо развернуть изменения непосредственно в рабочей базе данных.  Эти изменения должны происходить в часы наименьшей нагрузки с низким трафиком в приложении, чтобы минимзе влияние, когда некоторые пользователи могут столкнуться с неудачными запросами. 
>  - Убедитесь, что код приложения также обрабатывает все неудачные запросы.

### <a name="use-mysql-native-metrics-to-see-if-your-workload-is-exceeding-in-memory-temporary-table-sizes"></a>Используйте собственные метрики MySQL, чтобы узнать, превышает ли ваша рабочая нагрузка размеры временных таблиц в памяти.
При интенсивном считывании рабочей нагрузки запросы, выполняемые на сервере MySQL, могут превысить размеры временных таблиц в памяти. Это может привести к тому, что ваш сервер переключается на запись временных таблиц на диск, что влияет на производительность приложения. Чтобы определить, будет ли сервер выполнять запись на диск в результате превышения временного размера таблицы, просмотрите следующие метрики:

```
show global status like 'created_tmp_disk_tables';
show global status like 'created_tmp_tables';
```
Метрика created_tmp_disk_tables указывает, сколько таблиц было создано на диске, а created_tmp_table метрика сообщает, сколько временных таблиц должно быть сформировано в памяти, заданной рабочей нагрузкой. Чтобы определить, будет ли выполнение определенного запроса использовать временные таблицы, выполните команду объяснить в запросе. Сведения в столбце "дополнительный" указывают на "использование временного", если запрос будет выполняться с использованием временных таблиц.

Чтобы вычислить процент рабочей нагрузки с запросами, которые сбрасываются на диски, используйте значения метрик в следующей формуле:

```(created_tmp_disk_tables / (created_tmp_disk_tables + created_tmp_tables)) * 100```

В идеале этот процент должен быть менее 25%. Если вы видите, что процент равен 25% или больше, мы рекомендуем изменить два параметра сервера: tmp_table_size и max_heap_table_si


## <a name="database-schema-and-queries"></a>Схема базы данных и запросы

Ниже приведены некоторые советы и рекомендации, которые следует учитывать при построении схемы базы данных и запросов.

### <a name="always-use-the-right-datatype-for-your--table-columns"></a>Всегда используйте правильный тип данных для столбцов таблицы
Использование правильных типов данных в зависимости от типа хранящихся в службах служб может оптимизировать хранилище и сократить количество ошибок, которые могут возникать из-за неправильного набора.

### <a name="use-indexes"></a>Использование индексов
Чтобы избежать снижения производительности запросов, можно использовать индексы. Индексы позволяют быстро находить строки с указанными столбцами. См. статью [Использование индексов в MySQL](https://dev.mysql.com/doc/refman/8.0/en/mysql-indexes.html).

### <a name="explain-your-select-queries"></a>ОБЪЯСНИТе запросы на ВЫБОРку
Используйте [Объяснение](https://dev.mysql.com/doc/refman/8.0/en/explain.html) , чтобы получить подробные сведения о том, что делает MySQL для выполнения запроса. Это может помочь выявить узкие места или проблемы с запросом. См. статью [Использование объяснения для профилирования производительности запросов](https://docs.microsoft.com/azure/mysql/howto-troubleshoot-query-performance).


