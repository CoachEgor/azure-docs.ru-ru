---
title: Использование Azure Active Directory — база данных Azure для MySQL — одиночный сервер
description: Узнайте, как настроить Azure Active Directory (Azure AD) для проверки подлинности с помощью базы данных Azure для MySQL — одиночного сервера
author: lfittl-msft
ms.author: lufittl
ms.service: mysql
ms.topic: conceptual
ms.date: 01/22/2019
ms.openlocfilehash: 10dae81bf0ca8958f7c10aebef501fc604c4839c
ms.sourcegitcommit: af6847f555841e838f245ff92c38ae512261426a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2020
ms.locfileid: "76706054"
---
# <a name="use-azure-active-directory-for-authenticating-with-mysql"></a>Использование Azure Active Directory для проверки подлинности с помощью MySQL

В этой статье описано, как настроить доступ Azure Active Directory к базе данных Azure для MySQL, а также как подключиться с помощью маркера Azure AD.

> [!IMPORTANT]
> Аутентификация Azure AD для базы данных Azure для MySQL в настоящее время доступна в общедоступной предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="setting-the-azure-ad-admin-user"></a>Настройка пользователя с правами администратора Azure AD

Только пользователь с правами администратора Azure AD может создавать и включать пользователей для проверки подлинности на основе Azure AD. Чтобы создать пользователя с правами администратора Azure AD, выполните следующие действия.

1. В портал Azure выберите экземпляр базы данных Azure для MySQL, который вы хотите включить для Azure AD.
2. В разделе Параметры выберите Active Directory администратор:

![Настройка администратора Azure AD][2]

3. Выберите допустимого пользователя Azure AD в клиенте клиента, чтобы быть администратором Azure AD.

> [!IMPORTANT]
> При настройке администратора новый пользователь добавляется в базу данных Azure для сервера MySQL с полными разрешениями администратора.

Для каждого сервера MySQL можно создать только одного администратора Azure AD и выбрать другой, перезапишу существующий администратор Azure AD, настроенный для этого сервера.

В следующем выпуске мы будем поддерживать указание группы Azure AD, а не отдельного пользователя для работы с несколькими администраторами, однако сейчас эта возможность еще не поддерживается.

## <a name="creating-azure-ad-users-in-azure-database-for-mysql"></a>Создание пользователей Azure AD в базе данных Azure для MySQL

Чтобы добавить пользователя Azure AD в базу данных Azure для MySQL, выполните следующие действия после подключения (см. следующий раздел о подключении).

1. Сначала убедитесь, что пользователь Azure AD `<user>@yourtenant.onmicrosoft.com` является допустимым пользователем в клиенте Azure AD.
2. Войдите в базу данных Azure для экземпляра MySQL в качестве пользователя с правами администратора Azure AD.
3. Создание `<user>@yourtenant.onmicrosoft.com` пользователей в базе данных Azure для MySQL.

**Пример**.

```sql
CREATE AADUSER 'user1@yourtenant.onmicrosoft.com';
```

Для имен пользователей, длина которых превышает 32 символов, рекомендуется использовать вместо них псевдоним, который будет использоваться при подключении: 

Пример:

```sql
CREATE AADUSER 'userWithLongName@yourtenant.onmicrosoft.com' as 'userDefinedShortName'; 
```

> [!NOTE]
> Проверка подлинности пользователя в Azure AD не дает пользователю никаких разрешений на доступ к объектам в базе данных Azure для MySQL. Необходимо предоставить пользователю необходимые разрешения вручную.

## <a name="creating-azure-ad-groups-in-azure-database-for-mysql"></a>Создание групп Azure AD в базе данных Azure для MySQL

Чтобы разрешить группе Azure AD доступ к базе данных, используйте тот же механизм, что и для пользователей, но вместо этого укажите имя группы:

**Пример**.

```sql
CREATE AADUSER 'Prod_DB_Readonly';
```

При входе в систему члены группы будут использовать свои персональные маркеры доступа, но подписывать с именем группы, указанным в качестве имени пользователя.

## <a name="connecting-to-azure-database-for-mysql-using-azure-ad"></a>Подключение к базе данных Azure для MySQL с помощью Azure AD

На следующей высокоуровневой схеме показан рабочий процесс использования аутентификации Azure AD с базой данных Azure для MySQL.

![Поток проверки подлинности][1]

Мы разработали интеграцию Azure AD для работы с общими инструментами MySQL, такими как CLI MySQL, которые не поддерживаются в Azure AD и поддерживают указание имени пользователя и пароля при подключении к MySQL. Мы передаем маркер Azure AD в качестве пароля, как показано на рисунке выше.

В настоящее время проверены следующие клиенты:

- мисклворкбенч 
- CLI MySQL

Мы также тестировали наиболее распространенные драйверы приложений. подробные сведения можно просмотреть в конце этой страницы.

Ниже приведены действия, которые необходимо выполнить пользователю или приложению для проверки подлинности в Azure AD.

### <a name="step-1-authenticate-with-azure-ad"></a>Шаг 1. Аутентификация в Azure AD

Убедитесь, что [Azure CLI установлен](/cli/azure/install-azure-cli).

Вызов средства Azure CLI для проверки подлинности в Azure AD. Для этого необходимо предоставить идентификатор пользователя и пароль Azure AD.

```
az login
```

Эта команда запустит окно браузера на странице аутентификации Azure AD.

> [!NOTE]
> Для выполнения этих действий можно также использовать Azure Cloud Shell.
> Имейте в виду, что при извлечении маркера доступа Azure AD в Azure Cloud Shell потребуется явно вызвать `az login` и снова войти (в отдельном окне с кодом). После выполнения этого входа команда `get-access-token` будет работать должным образом.

### <a name="step-2-retrieve-azure-ad-access-token"></a>Шаг 2. получение маркера доступа Azure AD

Вызовите средство Azure CLI, чтобы получить маркер доступа для пользователя, прошедшего проверку подлинности Azure AD, из шага 1, чтобы получить доступ к базе данных Azure для MySQL.

Пример (для общедоступного облака):

```shell
az account get-access-token --resource https://ossrdbms-aad.database.windows.net
```

Указанное выше значение ресурса должно быть указано в точности так, как показано. Для других облаков значение ресурса можно искать с помощью:

```shell
az cloud show
```

Для Azure CLI версии 2.0.71 и более поздней можно указать команду в следующей более удобной версии для всех облаков:

```shell
az account get-access-token --resource-type oss-rdbms
```

После успешной проверки подлинности Azure AD вернет маркер доступа:

```json
{
  "accessToken": "TOKEN",
  "expiresOn": "...",
  "subscription": "...",
  "tenant": "...",
  "tokenType": "Bearer"
}
```

Маркер — это базовая строка 64, которая кодирует все сведения о пользователе, прошедшем проверку подлинности, и предназначен для службы базы данных Azure для MySQL.

> [!NOTE]
> Срок действия маркера доступа составляет от 5 минут до 60 минут. Мы рекомендуем получить маркер доступа непосредственно перед запуском входа в базу данных Azure для MySQL.

### <a name="step-3-use-token-as-password-for-logging-in-with-mysql"></a>Шаг 3. Использование токена в качестве пароля для входа с помощью MySQL

При подключении необходимо использовать маркер доступа в качестве пароля пользователя MySQL. При использовании клиентов GUI, таких как Мисклворкбенч, для получения токена можно использовать метод выше. 

При использовании интерфейса командной строки можно использовать этот короткий способ подключения: 

**Пример (Linux/macOS):**

MySQL-h mydb.mysql.database.azure.com \--пользователь user@tenant.onmicrosoft.com@mydb \--Enable-открытый текст-подключаемый модуль \--Password =`az account get-access-token --resource-type oss-rdbms --output tsv --query accessToken`  

Обратите внимание на параметр "включить-неоткрытый текст — подключаемый модуль" — необходимо использовать аналогичную конфигурацию с другими клиентами, чтобы убедиться, что маркер отправляется на сервер без хэширования.

Теперь вы прошли проверку подлинности на сервере MySQL с помощью аутентификации Azure AD.

## <a name="token-validation"></a>Проверка токена

Проверка подлинности Azure AD в базе данных Azure для MySQL гарантирует, что пользователь находится на сервере MySQL и проверяет допустимость маркера, проверяя содержимое маркера. Выполняются следующие шаги проверки маркера:

-   Маркер подписан Azure AD и не был изменен
-   Маркер выдан Azure AD для клиента, связанного с сервером
-   Срок действия токена не истек
-   Токен предназначен для ресурса базы данных Azure для MySQL (а не для другого ресурса Azure).

## <a name="compatibility-with-application-drivers"></a>Совместимость с драйверами приложений

Большинство драйверов поддерживаются, но обязательно используйте параметры для отправки пароля в виде открытого текста, чтобы маркер отправлялся без изменений.

* C/C++
  * либмисклклиент: поддерживается
  * MySQL-Connector-c + +: поддерживается
* Java
  * Соединитель/J (MySQL-Connector-Java): поддерживается, должен использовать параметр `useSSL`
* Python
  * Соединитель/Python: поддерживается
* Ruby
  * mysql2: поддерживается
* .NET
  * MySQL-Connector-NET: Supported, необходимо добавить подключаемый модуль для mysql_clear_password
  * MySQL-NET/MySqlConnector: поддерживается
* Node.js
  * mysqljs: не поддерживается (не отправляет маркер в виде открытого текста без исправления)
  * node-mysql2: поддерживается
* Perl
  * ДБД:: MySQL: поддерживается
  * NET:: MySQL: не поддерживается
* Go
  * Go-SQL-Driver: поддерживается, добавьте `?tls=true&allowCleartextPasswords=true` в строку подключения

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь с общими концепциями [Azure Active Directory аутентификации с помощью базы данных Azure для MySQL — одиночного сервера](concepts-azure-ad-authentication.md) .

<!--Image references-->

[1]: ./media/concepts-azure-ad-authentication/authentication-flow.png
[2]: ./media/concepts-azure-ad-authentication/set-azure-ad-admin.png
