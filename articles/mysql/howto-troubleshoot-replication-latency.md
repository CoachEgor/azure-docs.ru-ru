---
title: Устранение задержки репликации — база данных Azure для MySQL
description: Узнайте, как устранить задержку репликации с использованием реплик чтения базы данных Azure для MySQL
keywords: MySQL, устранение неполадок, задержка репликации в секундах
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: troubleshooting
ms.date: 10/08/2020
ms.openlocfilehash: 16a502a53b4441faf68ea342e0bc865731d38b1a
ms.sourcegitcommit: fbb620e0c47f49a8cf0a568ba704edefd0e30f81
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91877113"
---
# <a name="troubleshoot-replication-latency-in-azure-database-for-mysql"></a>Устранение задержки репликации в базе данных Azure для MySQL

Функция [чтения реплики](concepts-read-replicas.md) позволяет реплицировать данные с сервера базы данных Azure для MySQL на сервер реплики только для чтения. Реплики чтения используются для масштабирования рабочей нагрузки путем маршрутизации запросов на чтение и отчетность от приложения к серверам-репликам. Это снижает нагрузку на основной сервер и повышает общую производительность и задержку приложения по мере его масштабирования. Реплики чтения асинхронно обновляются с помощью технологии репликации на основе позиции файла собственного двоичного журнала (binlog) ядра MySQL. Дополнительные сведения о репликации binlog MySQL см. в [этой статье](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html). 

Запаздывание репликации на вторичных репликах чтения зависит от числа факторов, включая, но не ограничиваясь 

- Задержки сети
- Объем транзакций на исходном сервере
- Уровень вычислений исходного и вторичного сервера реплики чтения
- Запросы, выполняющиеся на основном и на сервере-получателе. 

В этом документе вы узнаете, как устранить задержку репликации в базе данных Azure для MySQL. Кроме того, вы также узнаете о некоторых распространенных причинах повышения задержки репликации на серверах реплик.

## <a name="replication-concepts"></a>Основные понятия репликации

Если включен двоичный журнал, сервер-источник записывает зафиксированную транзакцию в двоичный журнал, который используется для репликации. Двоичный журнал включен по умолчанию для всех новых подготовленных серверов, поддерживающих хранилище объемом до 16 ТБ. На серверах реплик существует два потока, выполняющихся на каждом сервере реплики, один из которых называется потоком ввода-вывода, а другой — потоком SQL.

- **Поток ввода-вывода** подключается к исходному серверу и запрашивает обновленные двоичные журналы. После того как этот поток получит двоичные обновления журнала, они будут сохранены на сервере-реплике в локальном журнале, который называется журналом ретрансляции.
- **Поток SQL** считывает журнал ретрансляции и применяет изменения данных на серверах реплик.

## <a name="monitoring-replication-latency"></a>Мониторинг задержки репликации

Служба "база данных Azure для MySQL" предоставляет время задержки репликации в секундах в [Azure Monitor](concepts-monitoring.md). Эта метрика доступна только на серверах реплик чтения. Эта метрика вычисляется с помощью метрики seconds_behind_master, доступной в MySQL. Чтобы понять основную причину повышенной задержки репликации, подключитесь к серверу реплики с помощью [MySQL Workbench](connect-workbench.md) или [Azure Cloud Shell](https://shell.azure.com) и выполните следующую команду:

 Замените значения фактическим именем сервера реплики и именем входа администратора. Для имени пользователя администратора требуется "@ \<servername> " для базы данных Azure для MySQL:

  ```azurecli-interactive
  mysql --host=myreplicademoserver.mysql.database.azure.com --user=myadmin@mydemoserver -p 
  ```

  Вот так выглядит этот процесс в терминале Cloud Shell
  ```
  Requesting a Cloud Shell.Succeeded.
  Connecting terminal...

  Welcome to Azure Cloud Shell

  Type "az" to use Azure CLI
  Type "help" to learn about Cloud Shell

  user@Azure:~$mysql -h myreplicademoserver.mysql.database.azure.com -u myadmin@mydemoserver -p
  Enter password:
  Welcome to the MySQL monitor.  Commands end with ; or \g.
  Your MySQL connection id is 64796
  Server version: 5.6.42.0 Source distribution

  Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

  Oracle is a registered trademark of Oracle Corporation and/or its
  affiliates. Other names may be trademarks of their respective
  owners.

  Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
  mysql>
  ```
  В том же терминале Azure Cloud Shell выполните следующую команду.

  ```
  mysql> SHOW SLAVE STATUS;
  ```

  Типичный вывод будет выглядеть следующим образом:
  
>[!div class="mx-imgBorder"]
> :::image type="content" source="./media/howto-troubleshoot-replication-latency/show-status.png" alt-text="Мониторинг задержки репликации&quot;:::


Выходные данные содержат много информации, но обычно важно сосредоточиться только на следующих столбцах:

|Метрика|Описание|
|---|---|
|Slave_IO_State| Текущее состояние потока ввода-вывода. Как правило, состояние &quot;Ожидание отправки события главной роли&quot; при синхронизации. Однако если отображается состояние, например &quot;подключение к главному серверу&quot;, то реплика теряет соединение с главным сервером. Проверьте, работает ли мастер, или брандмауэр блокирует подключение.|
|Master_Log_File| Двоичный файл журнала, в который записывается образец.|
|Read_Master_Log_Pos| Представляет расположение в приведенном выше двоичном файле журнала, в котором выполняется запись в главной базе.|
|Relay_Master_Log_File| Указано. представляет двоичный файл журнала, который считывается сервером-репликой из главного сервера.|
|Slave_IO_Running| Указывает, запущен ли поток ввода-вывода. Значение должно быть &quot;Yes&quot;. Если значение равно &quot;NO&quot;, то, скорее всего, репликация будет нарушена.|
|Slave_SQL_Running| Указывает, работает ли поток SQL. Значение должно быть &quot;Yes&quot;. Если значение равно &quot;NO&quot;, то, скорее всего, репликация будет нарушена.|
|Exec_Master_Log_Pos| Отображает расположение Relay_Master_Log_File, к которой применяется реплика. При наличии задержки эта последовательность должно быть меньше Read_Master_Log_Pos.|
|Relay_Log_Space|Отображает верхний предел размера журнала ретрансляции. Чтобы проверить размер, выполнив запрос, можно отобразить глобальные переменные, например &quot;relay_log_space_limit&quot;.|
|Seconds_Behind_Master| Отображает задержку репликации в секундах.|
|Last_IO_Errno|Отображает код ошибки потока ввода-вывода, если таковой имеется. Дополнительные сведения об этих кодах см. в [документации по MySQL](https://dev.mysql.com/doc/refman/5.7/en/server-error-reference.html).|
|Last_IO_Error| Отображает сообщение об ошибке потока ввода-вывода, если оно есть.|
|Last_SQL_Errno|Отображает код ошибки потока SQL, если таковой имеется. Дополнительные сведения об этих кодах см. в [документации по MySQL](https://dev.mysql.com/doc/refman/5.7/en/server-error-reference.html).|
|Last_SQL_Error|Отображает сообщение об ошибке потока SQL, если оно есть.|
|Slave_SQL_Running_State| Указывает текущее состояние потока SQL. Обратите внимание, что &quot;системная блокировка&quot;, показанная в этом состоянии, является нормальным поведением. Состояние &quot;ожидание фиксации зависимой транзакции" нормально для просмотра состояния. Указывает, что реплика ожидает, пока главный объект обновит зафиксированные транзакции.|

Если Slave_IO_Running Да, а Slave_SQL_Running — Да, то репликация работает нормально. 

Далее необходимо проверить Last_IO_Errno, Last_IO_Error, Last_SQL_Errno и Last_SQL_Error.  Эти поля содержат номер ошибки и сообщение об ошибке самой последней ошибки, вызвавшей завершение потока SQL. Номер ошибки 0 и пустое сообщение означает отсутствие ошибки. Ненулевое значение ошибки должно быть подробно рассмотрено в статье Поиск кода ошибки в [документации по MySQL](https://dev.mysql.com/doc/refman/5.7/en/server-error-reference.html).

## <a name="common-scenarios-for-high-replication-latency"></a>Распространенные сценарии для высокой задержки репликации

### <a name="network-latency-or-high-cpu-on-source-server"></a>Задержка в сети или высокая загрузка ЦП на исходном сервере

Если вы видите приведенные ниже значения, наиболее распространенной причиной задержки репликации является высокая задержка в сети или высокий уровень потребления ресурсов ЦП на исходном сервере. В этом случае поток ввода-вывода выполняется и ожидает главного. Главный (исходный сервер) уже записался в двоичный файл журнала #20, тогда как реплика получена только до #10 файлов. Основные факторы, влияющие на высокую задержку репликации в этом сценарии, — скорость сети или высокая загрузка ЦП на исходном сервере.  В Azure задержка в сети в пределах региона обычно составляет в миллисекундах, а в разных регионах может пройти до секунд. В большинстве случаев задержка в потоке ввода-вывода для подключения к исходному серверу вызвана высокой загрузкой ЦП на исходном сервере, в результате которой обработка потока операций ввода-вывода будет замедлена. Это можно определить, отслеживая загрузку ЦП и просматривая количество одновременных подключений на исходном сервере с помощью Azure Monitor.

Если на исходном сервере не отображается высокая загрузка ЦП, возможные причины могут быть вызваны задержкой в сети. Если вы видите большую задержку в сети, мы рекомендуем проверить [страницу состояния Azure](https://status.azure.com/status) , чтобы убедиться в отсутствии известных проблем или простоев. 

```
Slave_IO_State: Waiting for master to send event
Master_Log_File: the binary file sequence is larger then Relay_Master_Log_File, e.g. mysql-bin.00020
Relay_Master_Log_File: the file sequence is smaller than Master_Log_File, e.g. mysql-bin.00010
```

### <a name="heavy-burst-of-transactions-on-source-server"></a>Интенсивный пакет транзакций на исходном сервере

Если наблюдать следующие значения, наиболее распространенной причиной задержки репликации является интенсивный пакет транзакций на исходном сервере. В выходных данных, несмотря на то, что реплика может получить двоичный журнал для главного сервера, поток ввода-вывода реплики указывает на то, что место в журнале ретрансляции уже заполнено. Таким образом, скорость сети не вызывает задержки, так как реплика уже пытается выполнить поиск настолько быстро, насколько это возможно. Вместо этого обновленный размер двоичного журнала превышает верхний предел пространства журнала ретрансляции. Для дальнейшего устранения этой проблемы на главном сервере должен быть включен [журнал запросов с высокой задержкой](concepts-server-logs.md) . Журналы медленного запроса позволяют выявление долго выполняющихся транзакций на исходном сервере. Для уменьшения задержки на сервере необходимо настроить определенные запросы. 

```
Slave_IO_State: Waiting for the slave SQL thread to free enough relay log space
Master_Log_File: the binary file sequence is larger then Relay_Master_Log_File, e.g. mysql-bin.00020
Relay_Master_Log_File: the file sequence is smaller then Master_Log_File, e.g. mysql-bin.00010
```

Ниже приведены распространенные причины задержки в этой категории.

#### <a name="replication-latency-due-to-data-load-on-source-server"></a>Задержка репликации из-за загрузки данных на исходном сервере
В некоторых случаях на исходных серверах существует еженедельная или ежемесячная загрузка данных. К сожалению, в этом случае задержка репликации не позволяет. В этом сценарии серверы реплики в конечном итоге перехватываются после завершения загрузки данных на исходном сервере.


### <a name="slowness-on-the-replica-server"></a>Медленная работа на сервере реплики

Если наблюдать следующие значения, наиболее распространенной причиной может быть ситуация на сервере реплики, требующем дальнейшего изучения. В этом сценарии, как показано в выходных данных, потоки операций ввода-вывода и потоков SQL работают нормально, и реплика считывает тот же двоичный файл журнала, что и записи в главной базе данных. Однако на сервере реплики возникает задержка, отражающая ту же транзакцию с исходного сервера. 

```
Slave_IO_State: Waiting for master to send event
Master_Log_File: The binary log file sequence equals to Relay_Master_Log_File, e.g. mysql-bin.000191
Read_Master_Log_Pos: The position of master server written to the above file is larger than Relay_Log_Pos, e.g. 103978138
Relay_Master_Log_File: mysql-bin.000191
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
Exec_Master_Log_Pos: The position of slave reads from master binary log file is smaller than Read_Master_Log_Pos, e.g. 13468882
Seconds_Behind_Master: There is latency and the value here is greater than 0
```

Ниже приведены распространенные причины задержки в этой категории.

#### <a name="no-primary-or-unique-key-on-a-table"></a>Нет первичного или уникального ключа в таблице

База данных Azure для MySQL использует репликацию на основе строк. При репликации на основе строк главный сервер записывает события в двоичный журнал об изменении отдельной строки таблицы. Поток SQL в свою очередь выполняет эти изменения в соответствующих строках таблицы на сервере реплики. Первичный или уникальный ключ таблицы не является одной из распространенных причин задержки репликации. Отсутствие первичных и уникальных ключей приводит к проверке всех строк в целевой таблице потоком SQL для применения изменений.

В MySQL первичный ключ — это связанный индекс, который обеспечивает высокую производительность запросов, так как он не может включать значения NULL. При использовании подсистемы хранилища InnoDB данные таблицы физически упорядочены для быстрого поиска и сортировки на основе первичного ключа. Поэтому рекомендуется добавить первичный ключ в таблицы на исходном сервере перед созданием сервера реплики. В этом сценарии необходимо добавить первичные ключи на исходном сервере и повторно создать реплики чтения, чтобы повысить задержку репликации.

Для определения таблиц с первичным ключом, отсутствующими на исходном сервере, можно использовать следующий запрос:

```sql 
select tab.table_schema as database_name, tab.table_name 
from information_schema.tables tab left join 
information_schema.table_constraints tco 
on tab.table_schema = tco.table_schema 
and tab.table_name = tco.table_name 
and tco.constraint_type = 'PRIMARY KEY' 
where tco.constraint_type is null 
and tab.table_schema not in('mysql', 'information_schema', 'performance_schema', 'sys') 
and tab.table_type = 'BASE TABLE' 
order by tab.table_schema, tab.table_name;

```

#### <a name="replication-latency-due-to-long-running-queries-on-replica-server"></a>Задержка репликации из-за долго выполняющихся запросов на сервере реплики

Возможно, что Рабочая нагрузка на сервере реплики может помешать потоку SQL справиться с потоком ввода-вывода. Это одна из распространенных причин высокой задержки репликации, если на сервере реплики долго выполняются запросы. В этом случае на сервере реплики должен быть включен [журнал запросов](concepts-server-logs.md) , чтобы помочь устранить эту неполадку. Медленные запросы могут увеличить потребление ресурсов или замедлить работу сервера, поэтому реплика не сможет выполнить запрос к главному серверу. В этом сценарии необходимо настроить низкоскоростные запросы. Более быстрые запросы предотвращают блокировку потока SQL и значительно улучшают задержку репликации.


#### <a name="replication-latency-due-to-ddl-queries-on-source-server"></a>Задержка репликации из-за запросов DDL на исходном сервере
При наличии длительной команды DDL, такой как [ALTER TABLE](https://dev.mysql.com/doc/refman/5.7/en/alter-table.html) , выполненной на исходном сервере, и, например, выполнение займет 1 час. В течение этого времени на исходном сервере могут параллельно выполняться тысячи других запросов. При репликации DDL в реплике для обеспечения согласованности базы данных ядру MySQL необходимо запустить DDL в одном потоке репликации. Таким образом, все остальные реплицированные запросы будут заблокированы, и потребуется подождать час или более, пока не завершится операция DDL на сервере реплики. Это справедливо независимо от оперативной операции DDL. При выполнении операций DDL репликация должна увидеть повышенную задержку репликации.

Если [журнал запросов](concepts-server-logs.md) на исходном сервере включен, то этот сценарий можно обнаружить, просмотрев журналы запросов с задержкой, чтобы узнать, была ли выполнена команда DDL на исходном сервере. Хотя удаление, переименование и создание индекса, следует использовать в качестве алгоритма размещения для инструкции ALTER TABLE, которая может состоять из копирования табличных данных и перестроения таблицы. Обычно поддерживается параллельное выполнение алгоритма обработки исключений DML, но блокировка монопольных метаданных для таблицы может быть предпринятой на этапах подготовки и выполнения операции. Таким образом, для инструкции CREATE INDEX операторы ALGORITHM и LOCK могут использоваться для того, чтобы повлиять на метод копирования таблицы и уровень параллелизма при чтении и записи, однако добавление ПОЛНОТЕКСТОВОГО или ПРОСТРАНСТВЕННОГО индекса по-прежнему предотвратит операции DML. См. пример создания индекса с предложениями ALGORITHM и LOCK:

```sql
ALTER TABLE table_name ADD INDEX index_name (column), ALGORITHM=INPLACE, LOCK=NONE;
```

К сожалению, для инструкции DDL, требующей блокировки, не удается избежать задержки репликации, так как эти типы операций DDL должны выполняться в часы пиковой нагрузки, например, во время ночь для снижения потенциального воздействия.

#### <a name="replication-latency-due-to-replica-server-lower-sku"></a>Задержка репликации из-за понижения номера SKU сервера реплики

Реплики чтения базы данных Azure для MySQL создаются с той же конфигурацией сервера, что и главный сервер. Вы можете изменить созданную конфигурацию сервера-реплики. Однако если сервер реплики будет понижен, то Рабочая нагрузка может привести к увеличению потребления ресурсов, что, в свою очередь, может привести к задержке репликации. Для этого можно наблюдать за потреблением ресурсов ЦП и памяти сервера реплики от Azure Monitor. В этом случае рекомендуется, чтобы конфигурация сервера реплики хранилась в значениях, превышающих источник, чтобы гарантировать, что реплика сможет поддерживать базу данных master.

#### <a name="improving-replication-latency-using-server-parameter-tuning-on-source-server"></a>Повышение задержки репликации с помощью настройки параметров сервера на исходном сервере

В базе данных Azure для MySQL репликация оптимизирована для выполнения параллельных потоков на репликах по умолчанию. Для рабочих нагрузок с высоким уровнем параллелизма на исходном сервере, где не удается обнаружить сервер реплики, задержка репликации может повыситься путем настройки параметров binlog_group_commit_sync_delay на исходном сервере. Этот параметр определяет, сколько микросекунд ожидает фиксации двоичного журнала перед синхронизацией двоичного файла журнала. Преимущество заключается в том, что вместо немедленного применения каждой зафиксированной транзакции Главная отправляет обновления двоичного журнала. Это сокращает количество операций ввода-вывода в реплике и помогает повысить производительность. В этом сценарии может быть полезно установить для binlog_group_commit_sync_delay значение 1000, а также отслеживать задержку репликации. Этот параметр следует устанавливать с осторожностью и использовать только для больших одновременных рабочих нагрузок. Для сценария с низким уровнем параллелизма с множеством одноэлементных транзакций установка binlog_group_commit_sync_delay может добавить к задержке, так как поток ввода-вывода ожидает массового обновления журнала в двоичном формате, в то время как немногие транзакции могут быть зафиксированы. 

## <a name="next-steps"></a>Дальнейшие шаги
См. Дополнительные сведения о [репликации Бинлог MySQL](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html).
