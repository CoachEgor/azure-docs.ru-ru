---
title: Обновление с помощью дампа и восстановления — база данных Azure для PostgreSQL — один сервер
description: Описывает несколько методов для создания дампа и восстановления баз данных для перехода на более позднюю версию базы данных Azure для PostgreSQL-Single Server.
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: how-to
ms.date: 11/05/2020
ms.openlocfilehash: 6dfcf0b2ec1d46821007123908a8e7ba8df29744
ms.sourcegitcommit: 7cc10b9c3c12c97a2903d01293e42e442f8ac751
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/06/2020
ms.locfileid: "93421776"
---
# <a name="upgrade-your-postgresql-database-using-dump-and-restore"></a>Обновление базы данных PostgreSQL с помощью дампа и восстановления

В базе данных Azure для PostgreSQL — один сервер рекомендуется обновить ядро СУБД PostgreSQL до более крупной основной версии с помощью одного из следующих методов:
* Автономный метод, использующий [Pg_dump](https://www.postgresql.org/docs/current/static/app-pgdump.html) PostgreSQL и [pg_restore](https://www.postgresql.org/docs/current/static/app-pgrestore.html). В этом методе сначала производится создание дампа с исходного сервера, а затем восстановление этого дампа на целевом сервере.
* Метод Online с использованием [**Database Migration Service**](https://docs.microsoft.com/azure/dms/tutorial-azure-postgresql-to-azure-postgresql-online-portal) (DMS). Этот метод обеспечивает синхронизацию целевой базы данных с источником и позволяет выбрать время отсечения. Однако существуют некоторые предварительные условия и ограничения, которые необходимо решить. 

При выборе между интерактивными и автономными методами можно использовать следующие рекомендации для выполнения обновлений основных версий.

| **База данных** | **Дамп/восстановление (вне сети)** | **DMS (в сети)** |
| ------ | :------: | :-----: |
| У вас небольшая база данных, которая может позволить себе просто обновить  | X | |
| Небольшие базы данных (< 10 ГБ)  | X | X | 
| Малый средний баз данных (10 ГБ – 100 ГБ) | X | X |
| Большие базы данных (> 100 ГБ) |  | X |
| Может позволить себе просто выполнить обновление (независимо от размера базы данных) | X |  |
| Можно ли обращаться к [необходимым компонентам](https://docs.microsoft.com/azure/dms/tutorial-azure-postgresql-to-azure-postgresql-online-portal#prerequisites) DMS, включая перезагрузку? |  | X |
| Можно ли избежать означающего и незанесенных в журнал таблиц во время процесса обновления? | |  X |

В этом пошаговом руководство описаны два примера методов обновления баз данных с помощью PostgreSQL pg_dump и pg_restoreных команд. Процесс в этом документе называется **обновлением** , если база данных  **перенесена** с исходного сервера на целевой сервер. 

> [!NOTE]
> PostgreSQL дамп и восстановление можно выполнять различными способами. Вы можете использовать различные методы, отличные от тех, которые упоминаются в этом документе. Например, чтобы сделать дамп, а затем выполнить восстановление из клиента PostgreSQL, ознакомьтесь с [документацией](./howto-migrate-using-dump-and-restore.md) по пошаговым процедурам и рекомендациям. Подробный синтаксис дампа и восстановления с дополнительными параметрами см. в статьях [pg_dump](https://www.postgresql.org/docs/current/static/app-pgdump.html) и [pg_restore](https://www.postgresql.org/docs/current/static/app-pgrestore.html). 


## <a name="prerequisites-for-using-dump-and-restore-with-azure-postgresql"></a>Предварительные требования для использования дампа и восстановления с помощью Azure PostgreSQL
 
Для пошагового руководства вам потребуется:
- База данных-источник под управлением 9,5, 9,6 или 10 (база данных Azure для PostgreSQL — один сервер).
- Целевой сервер базы данных с требуемым [сервером базы данных PostgreSQL основной версии Azure для PostgreSQL](quickstart-create-server-database-portal.md). 
- Установлена клиентская система (Linux) с PostgreSQL и [pg_dump](https://www.postgresql.org/docs/current/static/app-pgdump.html) и [pg_restore](https://www.postgresql.org/docs/current/static/app-pgrestore.html) программ командной строки. 
- Кроме того, можно использовать [Azure Cloud Shell](https://shell.azure.com) или, щелкнув Azure Cloud Shell в строке меню в правом верхнем углу [портал Azure](https://portal.azure.com). `az login`Перед выполнением команд dump и RESTORE потребуется выполнить вход в учетную запись.
- Расположение клиента PostgreSQL, например виртуальная машина, которая лучше всего работает в том же регионе, что и исходный и целевой серверы. 

## <a name="additional-details-and-considerations"></a>Дополнительные сведения и рекомендации
- Строку подключения к исходным и целевым базам данных можно найти, щелкнув "строки подключения" на портале. 
- Возможно, на сервере выполняется несколько баз данных. Список баз данных можно найти, подключившись к исходному серверу и запустив `\l` .
- Создайте соответствующие базы данных на целевом сервере базы данных.
- Можно пропустить обновление `azure_maintenance` или базы данных шаблонов.
- Ознакомьтесь с приведенными выше таблицами, чтобы определить, какая база данных подходит для этого режима миграции.
- Если вы хотите использовать Azure Cloud Shell, время ожидания сеанса истекает через 20 минут. Если размер базы данных составляет < 10 ГБ, то обновление может завершиться без истечения времени ожидания. В противном случае может возникнуть необходимость в открытом сеансе другими способами, например нажатием клавиши <Enter> один раз в 10-15 минут. 

> [!TIP] 
> - Если вы используете один и тот же пароль для исходной и целевой баз данных, можно задать `PGPASSWORD=yourPassword` переменную среды.  После этого вам не нужно указывать Password регистрируется для выполнения таких команд, как PSQL, pg_dump и pg_restore.  Аналогичным образом можно настроить дополнительные переменные `PGUSER` , например и `PGSSLMODE` другие. см. раздел [PostgreSQL Environment Variables](https://www.postgresql.org/docs/11/libpq-envars.html).
>  
> - Если серверу PostgreSQL требуются подключения TLS/SSL (по умолчанию в базе данных Azure для серверов PostgreSQL), задайте переменную среды, `PGSSLMODE=require` чтобы pg_restore средство подключается к TLS. Без TLS ошибка может быть прочитана  `FATAL:  SSL connection is required. Please specify SSL options and retry.`
>
> - В командной строке Windows выполните команду `SET PGSSLMODE=require` перед выполнением команды pg_restore. В Linux или Bash выполните команду `export PGSSLMODE=require` перед выполнением команды pg_restore.

## <a name="example-database-used-in-this-guide"></a>Пример базы данных, используемый в этом пошаговом руководству

 | **Описание** | **Значение** |
 | ------- | ------- |
 | Исходный сервер (v 9,5) | pg-95.postgres.database.azure.com |
 | База данных-источник | bench5gb |
 | Размер базы данных источника | 5 ГБ |
 | Имя пользователя источника | pg@pg-95 |
 | Целевой сервер (версии 11) | pg-11.postgres.database.azure.com |
 | Целевая база данных | bench5gb |
 | Имя целевого пользователя | pg@pg-11 |

## <a name="method-1-upgrade-with-streaming-backups-to-the-target"></a>Метод 1. обновление с помощью потоковой архивации на целевой объект 

В этом методе весь дамп базы данных передается непосредственно на целевой сервер базы данных и не сохраняет дамп в клиенте. Таким образом, его можно использовать с клиентом с ограниченным хранилищем, и даже можно запускать из Azure Cloud Shell. 

1. Убедитесь, что база данных существует на целевом сервере с помощью `\l` команды. Если база данных не существует, создайте ее.
   ```azurecli-interactive
    psql "host=myTargetServer port=5432 dbname=postgres user=myUser password=###### sslmode=mySSLmode"
    ```
    ```SQL
    postgres> \l   
    postgres> create database myTargetDB;
   ```

2. Запустите дамп и восстановите его как одну командную строку с помощью канала. 
    ```azurecli-interactive
    pg_dump -Fc -v --mySourceServer --port=5432 --username=myUser --dbname=mySourceDB | pg_restore -v --no-owner --host=myTargetServer --port=5432 --username=myUser --dbname=myTargetDB
    ```

    Например, примененная к объекту директива

    ```azurecli-interactive
    pg_dump -Fc -v --host=pg-95.postgres.database.azure.com --port=5432 --username=pg@pg-95 --dbname=bench5gb | pg_restore -v --no-owner --host=pg-11.postgres.database.azure.com --port=5432 --username=pg@pg-11 --dbname=bench5gb
    ```  
3. После завершения процесса обновления (миграции) можно протестировать приложение на целевом сервере. 
4. Повторите эту процедуру для всех баз данных на сервере.

 В следующей таблице показано время, затраченное на обновление с помощью этого метода. Данные заполняются с помощью [пгбенч](https://www.postgresql.org/docs/10/pgbench.html). Так как база данных может иметь разное количество объектов разного размера, чем пгбенч созданные таблицы и индексы, настоятельно рекомендуется протестировать дамп и восстановить базу данных, чтобы понять фактическое время, необходимое для обновления базы данных. 

| **Размер баз данных** | **Затраченное время** | 
| ----- | ------ |
| 1 ГБ  | 1-2 минут |
| 5 ГБ | 8-10 минут |
| 10 ГБ | 15-20 минут |
| 50 ГБ | 1 – 1,5 часа |
| 100 ГБ | 2,5 – 3 часа|
   
## <a name="method-2-upgrade-with-parallel-dump-and-restore"></a>Метод 2. обновление с параллельным дампом и восстановлением 

Этот метод полезен при наличии в базе данных нескольких больших таблиц и необходимости параллелизации процесса дампа и восстановления для этой базы данных. Для размещения архивных дампов баз данных требуется достаточно места на локальном диске. Этот параллельный процесс дампа и восстановления сокращает потребление времени для выполнения всего процесса миграции или обновления. Например, база данных пгбенч размером 50 ГБ, для которой выполнялась миграция 1 – 1,5 часа, была выполнена менее чем за 30 минут.

1. Для каждой базы данных на исходном сервере создайте соответствующую базу данных на целевом сервере.

   ```bash
    psql "host=myTargetServer port=5432 dbname=postgres user=myuser password=###### sslmode=mySSLmode"
    postgresl> create database myDB;
   ```
   Например, примененная к объекту директива
    ```bash
    psql "host=pg-11.postgres.database.azure.com port=5432 dbname=postgres user=pg@pg-11 password=###### sslmode=require"

    postgres> create database bench5gb;
    postgres> \q
    ```

2. Выполните команду pg_dump в формате каталога с числом заданий = 4 (число таблиц в базе данных). С более крупным уровнем вычислений и с большим количеством таблиц можно увеличить его до большего числа. Это pg_dump создаст каталог для хранения сжатых файлов для каждого задания.

    ```bash
    pg_dump -Fd -v --host=sourceServer --port=5432 --username=myUser --dbname=mySourceDB -j 4 -f myDumpDirectory
    ```
    Например, примененная к объекту директива
    ```bash
    pg_dump -Fd -v --host=pg-95.postgres.database.azure.com --port=5432 --username=pg@pg-95 --dbname=bench5gb -j 4 -f dump.dir
    ```

3. Затем восстановите резервную копию на целевом сервере.
    ```bash
    $ pg_restore -v --no-owner --host=myTargetServer --port=5432 --username=myUser --dbname=myTargetDB -j 4 myDumpDir
    ```
    Например, примененная к объекту директива
    ```bash
    $ pg_restore -v --no-owner --host=pg-11.postgres.database.azure.com --port=5432 --username=pg@pg-11 --dbname=bench5gb -j 4 dump.dir
    ```

> [!TIP]
> Описанный в этом документе процесс также можно использовать для обновления сервера базы данных Azure для PostgreSQL, который находится на этапе предварительной версии. Основное отличие заключается в том, что строка подключения для гибкого целевого сервера не имеет `@dbName` .  Например, если имя пользователя — `pg` , то имя пользователя одиночного сервера в строке подключения будет иметь значение `pg@pg-95` , а при использовании гибкого сервера можно просто использовать `pg` .

## <a name="next-steps"></a>Дальнейшие шаги

- Когда вы удовлетворены функцией целевой базы данных, можно удалить старый сервер базы данных. 
- Если вы хотите использовать ту же конечную точку базы данных, что и исходный сервер, то после удаления старого сервера базы данных-источника можно создать реплику чтения с прежним именем сервера базы данных. После установки стабильного состояния можно отключить реплику, которая сделает сервер реплики независимым сервером. Дополнительные сведения см. в разделе [репликация](./concepts-read-replicas.md) .
- Не забудьте проверить и протестировать эти команды в тестовой среде, прежде чем использовать их в рабочей среде.
