---
title: Ведение журнала аудита с помощью Пгаудит в базе данных Azure для PostgreSQL-Single Server
description: Основные понятия для ведения журнала аудита Пгаудит в базе данных Azure для PostgreSQL-Single Server.
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/18/2019
ms.openlocfilehash: 8b4cbe309e310ef1fc384224c952a6f04385b1dd
ms.sourcegitcommit: c79aa93d87d4db04ecc4e3eb68a75b349448cd17
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2019
ms.locfileid: "71092265"
---
# <a name="audit-logging-in-azure-database-for-postgresql---single-server"></a>Ведение журнала аудита в базе данных Azure для PostgreSQL — один сервер

Ведение журнала аудита действий базы данных в базе данных Azure для PostgreSQL — один сервер доступен через расширение аудита PostgreSQL: [пгаудит](https://www.pgaudit.org/). Пгаудит предоставляет подробные сведения о сеансе и (или) ведении журнала аудита объектов.

> [!NOTE]
> Пгаудит можно включить только на общего назначения и оптимизированных для памяти серверах.

## <a name="usage-considerations"></a>Рекомендации по использованию
По умолчанию инструкции журнала Пгаудит создаются вместе с обычными инструкциями журнала с помощью стандартного средства ведения журнала postgres. В базе данных Azure для PostgreSQL эти файлы журнала можно скачать с помощью портал Azure или интерфейса командной строки. Максимальный объем хранилища для коллекции файлов составляет 1 ГБ, а каждый файл доступен не более семи дней (по умолчанию — три дня). Эта служба является краткосрочным хранилищем.

Кроме того, можно настроить все журналы для передачи в службу журналов диагностики Azure Monitor. Если включить ведение журнала диагностики Azure Monitor, журналы автоматически отправляются (в формате JSON) в службу хранилища Azure, концентраторы событий и (или) Azure Monitor журналы в зависимости от вашего выбора.

Включение Пгаудит создает большой объем ведения журнала на сервере, что влияет на производительность и хранение журналов. Рекомендуется использовать службу журналов диагностики Azure, которая предлагает долгосрочные варианты хранения, а также функции анализа и оповещения. Рекомендуется отключить стандартное ведение журнала, чтобы снизить влияние дополнительного ведения журнала на производительность.

   1. Установите для параметра `logging_collector` значение OFF. 
   2. Перезапустите сервер, чтобы применить это изменение.

Чтобы узнать, как настроить ведение журнала для службы хранилища Azure, концентраторов событий или журналов Azure Monitor, перейдите к разделу журналы диагностики [статьи журналы сервера](concepts-server-logs.md).

## <a name="installing-pgaudit"></a>Установка Пгаудит

Чтобы установить Пгаудит, необходимо включить его в общие библиотеки предварительной загрузки сервера. Для вступления в силу `shared_preload_libraries` изменения параметра postgres требуется перезагрузка сервера. Параметры можно изменить с помощью [портал Azure](howto-configure-server-parameters-using-portal.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [REST API](/rest/api/postgresql/configurations/createorupdate).

Использование [портал Azure](https://portal.azure.com):

   1. Выберите сервер базы данных Azure для PostgreSQL.
   2. На боковой панели выберите **Параметры сервера**.
   3. Найдите параметр `shared_preload_libraries`.
   4. Выберите **пгаудит**.
   5. Перезапустите сервер, чтобы применить изменение.

   6. Подключение к серверу с помощью клиента (например, psql) и включение расширения Пгаудит
      ```SQL
      CREATE EXTENSION pgaudit;
      ```

> [!TIP]
> Если появится сообщение об ошибке, подтвердите перезапуск сервера после сохранения `shared_preload_libraries`.

## <a name="pgaudit-settings"></a>Параметры Пгаудит

Пгаудит позволяет настроить ведение журнала аудита для сеанса или объекта. [Ведение журнала аудита сеансов](https://github.com/pgaudit/pgaudit/blob/master/README.md#session-audit-logging) создает подробные журналы выполненных инструкций. [Ведение журнала аудита объектов](https://github.com/pgaudit/pgaudit/blob/master/README.md#object-audit-logging) — это область аудита для конкретных связей. Можно выбрать один или оба типа ведения журнала. 

> [!NOTE]
> Параметры Пгаудит указаны глобальный и не могут быть указаны на уровне базы данных или роли.

После [установки пгаудит](#installing-pgaudit)можно настроить его параметры, чтобы начать ведение журнала. В [документации по пгаудит](https://github.com/pgaudit/pgaudit/blob/master/README.md#settings) содержится определение каждого параметра. Сначала проверьте параметры и убедитесь, что вы получаете ожидаемое поведение.

> [!NOTE]
> Если `pgaudit.log_client` задано значение ON, журналы перенаправляются в клиентский процесс (например, psql), а не записываются в файл. Этот параметр обычно остается отключенным.

> [!NOTE]
> `pgaudit.log_level`включается, только `pgaudit.log_client` если включен. Кроме того, в портал Azure в настоящее время есть ошибка `pgaudit.log_level`: поле со списком отображается, что подразумевает возможность выбора нескольких уровней. Однако следует выбрать только один уровень. 

> [!NOTE]
> В базе данных Azure для PostgreSQL `pgaudit.log` не может быть задано `-` с помощью сочетания знака (минус), как описано в документации по пгаудит. Все обязательные классы инструкций (чтение, запись и т. д.) должны указываться отдельно.

### <a name="audit-log-format"></a>Формат журнала аудита
Каждая запись аудита обозначается `AUDIT:` рядом с началом строки журнала. Формат остальной части записи подробно описан в [документации по пгаудит](https://github.com/pgaudit/pgaudit/blob/master/README.md#format).

Если вам нужны другие поля для удовлетворения требований аудита, используйте параметр `log_line_prefix`postgres. `log_line_prefix`Строка, которая выводится в начале каждой строки журнала postgres. Например, следующий `log_line_prefix` параметр предоставляет метку времени, имя пользователя, имя базы данных и идентификатор процесса:

```
t=%m u=%u db=%d pid=[%p]:
```

Дополнительные `log_line_prefix`сведения см. в [документации по PostgreSQL](https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-LINE-PREFIX).

### <a name="getting-started"></a>Приступая к работе
Чтобы быстро приступить к работе `pgaudit.log` , `WRITE`присвойте параметру значение и откройте журналы, чтобы просмотреть выходные данные. 


## <a name="next-steps"></a>Следующие шаги
- [Сведения о ведении журнала в базе данных Azure для PostgreSQL](concepts-server-logs.md)
- Узнайте, как задать параметры с помощью [портал Azure](howto-configure-server-parameters-using-portal.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [REST API](/rest/api/postgresql/configurations/createorupdate).
