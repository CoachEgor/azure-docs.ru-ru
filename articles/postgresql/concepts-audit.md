---
title: Ведение журнала аудита — база данных Azure для PostgreSQL — один сервер
description: Основные понятия для ведения журнала аудита Пгаудит в базе данных Azure для PostgreSQL-Single Server.
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 10/14/2019
ms.openlocfilehash: c0ce1648d7b5f7c25044ed8f66eafcca7b0009f4
ms.sourcegitcommit: 380e3c893dfeed631b4d8f5983c02f978f3188bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2020
ms.locfileid: "75747339"
---
# <a name="audit-logging-in-azure-database-for-postgresql---single-server"></a>Ведение журнала аудита в базе данных Azure для PostgreSQL — один сервер

Ведение журнала аудита действий базы данных в базе данных Azure для PostgreSQL — один сервер доступен через расширение аудита PostgreSQL: [пгаудит](https://www.pgaudit.org/). Пгаудит предоставляет подробные сведения о сеансе и (или) ведении журнала аудита объектов.

> [!NOTE]
> Пгаудит находится на этапе предварительной версии в базе данных Azure для PostgreSQL.
> Расширение можно включить только для общего назначения и оптимизированных для памяти серверов.

Если вы хотите, чтобы журналы уровня ресурсов Azure для таких операций, как вычисление и масштабирование хранилища, см. в [журнале действий Azure](../azure-monitor/platform/platform-logs-overview.md).

## <a name="usage-considerations"></a>Особенности использования
По умолчанию выписки из журналов pgAudit создаются вместе с регулярными выписками с использованием стандартного средства ведения журнала Postgres. В Базе данных Azure для PostgreSQL эти файлы журнала можно скачать на портале Azure или с помощью интерфейса командной строки. Максимальный объем хранилища для коллекции файлов составляет 1 ГБ, а каждый файл доступен не более семи дней (по умолчанию — три дня). Эта служба является краткосрочным хранилищем.

Кроме того, можно настроить все журналы для передачи в службу журналов диагностики Azure Monitor. Если включить ведение журнала диагностики Azure Monitor, журналы автоматически отправляются (в формате JSON) в службу хранилища Azure, концентраторы событий и (или) Azure Monitor журналы в зависимости от вашего выбора.

Включение pgAudit приводит к созданию большого объема журналов на сервере, что влияет на производительность и хранение журналов. Мы рекомендуем использовать службу журналов диагностики Azure, которая предлагает варианты долговременного хранения, а также функции анализа и оповещений. Мы рекомендуем отключить стандартное ведение журнала, чтобы уменьшить влияние дополнительного ведения журнала на производительность:

   1. Задайте для параметра `logging_collector` значение OFF. 
   2. Перезапустите сервер, чтобы применить это изменение.

Чтобы узнать, как настроить ведение журнала для службы хранилища Azure, концентраторов событий или журналов Azure Monitor, перейдите к разделу журналы диагностики [статьи журналы сервера](concepts-server-logs.md).

## <a name="installing-pgaudit"></a>Установка Пгаудит

Чтобы установить Пгаудит, необходимо включить его в общие библиотеки предварительной загрузки сервера. Для вступления в силу изменения параметра `shared_preload_libraries` postgres требуется перезагрузка сервера. Параметры можно изменить с помощью [портал Azure](howto-configure-server-parameters-using-portal.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [REST API](/rest/api/postgresql/configurations/createorupdate).

Использование [портал Azure](https://portal.azure.com):

   1. Выберите сервер базы данных Azure для PostgreSQL.
   2. На боковой панели выберите **Параметры сервера**.
   3. Найдите параметр `shared_preload_libraries`.
   4. Выберите **пгаудит**.
   5. Перезапустите сервер, чтобы применить изменение.

   6. Подключение к серверу с помощью клиента (например, psql) и включение расширения Пгаудит
      ```SQL
      CREATE EXTENSION pgaudit;
      ```

> [!TIP]
> Если появится сообщение об ошибке, убедитесь, что сервер был перезагружен после сохранения `shared_preload_libraries`.

## <a name="pgaudit-settings"></a>Параметры Пгаудит

Пгаудит позволяет настроить ведение журнала аудита для сеанса или объекта. [Ведение журнала аудита сеансов](https://github.com/pgaudit/pgaudit/blob/master/README.md#session-audit-logging) создает подробные журналы выполненных инструкций. [Ведение журнала аудита объектов](https://github.com/pgaudit/pgaudit/blob/master/README.md#object-audit-logging) — это область аудита для конкретных связей. Можно выбрать один или оба типа ведения журнала. 

> [!NOTE]
> Параметры Пгаудит указаны глобальный и не могут быть указаны на уровне базы данных или роли.

После [установки пгаудит](#installing-pgaudit)можно настроить его параметры, чтобы начать ведение журнала. В [документации по пгаудит](https://github.com/pgaudit/pgaudit/blob/master/README.md#settings) содержится определение каждого параметра. Сначала проверьте параметры и убедитесь, что вы получаете ожидаемое поведение.

> [!NOTE]
> Если задать для параметра `pgaudit.log_client` значение ON, журналы будут перенаправляться в процесс клиента (например, psql) вместо записи в файл. Этот параметр обычно следует отключать.

> [!NOTE]
> `pgaudit.log_level` включается только при включенном `pgaudit.log_client`. Кроме того, в портал Azure в настоящее время есть ошибка `pgaudit.log_level`: поле со списком отображается, что означает, что можно выбрать несколько уровней. Однако должен быть выбран только один уровень. 

> [!NOTE]
> В базе данных Azure для PostgreSQL нельзя задать `pgaudit.log` с помощью ярлыка `-` (минус), как описано в документации по Пгаудит. Все необходимые классы операторов (READ, WRITE и т. д.) должны быть указаны отдельно.

### <a name="audit-log-format"></a>Формат журнала аудита
Каждая запись аудита обозначается `AUDIT:` около начала строки журнала. Формат остальной части записи подробно описан в [документации по пгаудит](https://github.com/pgaudit/pgaudit/blob/master/README.md#format).

Если вам нужны другие поля для удовлетворения требований аудита, используйте параметр postgres `log_line_prefix`. `log_line_prefix` — это строка, которая выводится в начале каждой строки журнала postgres. Например, следующий параметр `log_line_prefix` предоставляет метку времени, имя пользователя, имя базы данных и идентификатор процесса:

```
t=%m u=%u db=%d pid=[%p]:
```

Дополнительные сведения о `log_line_prefix`см. в [документации по PostgreSQL](https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-LINE-PREFIX).

### <a name="getting-started"></a>Начало работы
Чтобы быстро приступить к работе, присвойте параметру `pgaudit.log` значение `WRITE`и откройте журналы, чтобы просмотреть выходные данные. 


## <a name="next-steps"></a>Дальнейшие действия
- [Сведения о ведении журнала в базе данных Azure для PostgreSQL](concepts-server-logs.md)
- Узнайте, как задать параметры с помощью [портал Azure](howto-configure-server-parameters-using-portal.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [REST API](/rest/api/postgresql/configurations/createorupdate).
