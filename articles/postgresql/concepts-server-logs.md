---
title: Логи - База данных Azure для PostgreS'L - Единый сервер
description: Описывает конфигурацию, хранение и анализ журналов в базе данных Azure для PostgreS-L - Единый сервер
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 10/25/2019
ms.openlocfilehash: 2636e9a225002148e4cd79bb2176e0883aed623a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79280499"
---
# <a name="logs-in-azure-database-for-postgresql---single-server"></a>Входы в базу данных Azure для PostgreS'L - Единый сервер
База данных Azure для PostgreS'L позволяет настраивать и получать доступ к стандартным журналам Postgres. Эти журналы можно использовать для выявления, устранения неполадок и устранения ошибок конфигурации и неоптимальной производительности. Информация о регистрации, которая может быть настроена и получить доступ, включает ошибки, информацию о запросах, автоматические записи, соединения и контрольно-пропускные пункты. (Доступ к журналам транзакций недоступен).

Аудит регистрации предоставляется через расширение Postgres, pgaudit. Чтобы узнать больше, посетите [статью о аудиторских концепциях.](concepts-audit.md)


## <a name="configure-logging"></a>Настройка журнала 
Вы можете настроить стандарт Postgres для входа в систему на сервере с помощью параметров сервера регистрации. На каждой базе данных Azure `log_checkpoints` `log_connections` для сервера PostgreS'L, и находятся на по умолчанию. Чтобы ведение журнала соответствовало вашим требования, можно изменить дополнительные параметры. 

![База данных Azure для PostgreSQL. Параметры ведения журнала](./media/concepts-server-logs/log-parameters.png)

Чтобы узнать больше о параметрах журнала Postgres, посетите [разделы «Когда войти»](https://www.postgresql.org/docs/current/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHEN) и [«Что войти](https://www.postgresql.org/docs/current/runtime-config-logging.html#RUNTIME-CONFIG-LOGGING-WHAT) в разделы документации Postgres». Большинство, но не все параметры регистрации Postgres доступны для настройки в базе данных Azure для PostgreS'L.

Чтобы узнать, как настроить параметры в базе данных Azure для PostgreS'L, ознакомьтесь с [документацией портала](howto-configure-server-parameters-using-portal.md) или [документацией CLI.](howto-configure-server-parameters-using-cli.md) 

> [!NOTE]
> Настройка большого объема журналов, например журналы заявлений, может добавить значительные накладные расходы на производительность. 

## <a name="access-log-files"></a>Доступ к файлам .log
Формат журнала по умолчанию в базе данных Azure для PostgreS'L — это журнал .log. Линия образца из этого журнала выглядит следующим образом:

```
2019-10-14 17:00:03 UTC-5d773cc3.3c-LOG: connection received: host=101.0.0.6 port=34331 pid=16216
```

База данных Azure для PostgreS'L предоставляет краткосрочное место хранения файлов .log. Новый файл начинается каждые 1 час или 100 МБ, в зависимости от того, что приходит первым. Входы прикладываются к текущему файлу по мере их испускаемого из Postgres.  

Можно установить период хранения для этого кратковременного `log_retention_period` хранилища журналов с помощью параметра. Значению по умолчанию соответствует три дня, а максимальному значению семь. Краткосрочное место хранения может вместить до 1 ГБ файлов журнала. После 1 ГБ, старейшие файлы, независимо от периода хранения, будут удалены, чтобы освободить место для новых журналов. 

Для долгосрочного хранения журналов и анализа журналов можно загрузить файлы .log и переместить их в стороннюю службу. Вы можете скачать файлы с помощью [портала Azure,](howto-configure-server-logs-in-portal.md) [Azure CLI](howto-configure-server-logs-using-cli.md). Кроме того, можно настроить диагностические настройки Azure Monitor, которые автоматически испускают журналы (в формате JSON) в более долгосрочные места. Подробнее об этой опции читайте в разделе ниже. 

Вы можете остановить генерацию файлов .log, установив параметр `logging_collector` для OFF. Выключение генерации файлов .log рекомендуется, если вы используете диагностические настройки Azure Monitor. Такая конфигурация снизит влияние дополнительных журналов на производительность.

## <a name="diagnostic-logs"></a>Журналы диагностики
База данных Azure для PostgreS'L интегрирована с диагностическими настройками Azure Monitor. Диагностические настройки позволяют отправлять журналы Postgres в формате JSON в журналы Azure Monitor для анализа и оповещения, концентраторы событий для потоковой передачи и Azure Storage для архивирования. 

> [!IMPORTANT]
> Эта диагностическая функция для журналов серверов доступна только в [уровнях ценообразования](concepts-pricing-tiers.md)общего назначения и памяти.


### <a name="configure-diagnostic-settings"></a>Настройка параметров диагностики
Можно включить диагностические настройки для сервера Postgres с помощью портала Azure, CLI, REST API и Powershell. Категория журнала для выбора — **это PostgreS'Llogs.** (Есть другие журналы, которые можно настроить, если вы используете [магазин запросов.)](concepts-query-store.md)

Для включения диагностических журналов с помощью портала Azure:

   1. На портале перейдите в *Диагностические настройки* в меню навигации сервера Postgres.
   2. Выберите *Добавить Диагностическая настройка*.
   3. Назовите этот параметр. 
   4. Выберите предпочтительную конечную точку (учетная запись хранения, концентратор событий, аналитика журналов). 
   5. Выберите тип журнала **PostgreS'Llogs.**
   7. Сохраните вашу настройку.

Для включения диагностических журналов с помощью Powershell, CLI или REST API посетите статью [диагностических настроек.](../azure-monitor/platform/diagnostic-settings.md)

### <a name="access-diagnostic-logs"></a>Доступ к журналам диагностики

Способ доступа к журналам зависит от того, какую конечную точку вы выберете. В статье для хранения журналов смотрите статью учетной [записи журналов.](../azure-monitor/platform/resource-logs-collect-storage.md) Для концентраторов событий смотрите статью [журналов потоков Azure.](../azure-monitor/platform/resource-logs-stream-event-hubs.md)

Для журналов мониторинга Azure журналы отправляются в выбранное рабочее пространство. В журналах Postgres используется режим сбора **AzureDiagnostics,** поэтому их можно запрашивать из таблицы AzureDiagnostics. Поля в таблице описаны ниже. Подробнее о запросе и оповещения читайте в обзоре [запросов Azure Monitor Logry.](../azure-monitor/log-query/log-query-overview.md)

Ниже приведены запросы, которые вы можете попытаться начать. Можно настроить оповещения на основе запросов.

Поиск всех журналов Postgres для конкретного сервера в последний день
```
AzureDiagnostics
| where LogicalServerName_s == "myservername"
| where TimeGenerated > ago(1d) 
```

Поиск всех попыток подключения, не связанных с локальной хост-
```
AzureDiagnostics
| where Message contains "connection received" and Message !contains "host=127.0.0.1"
| where Category == "PostgreSQLLogs" and TimeGenerated > ago(6h)
```
Приведенный выше запрос будет отображать результаты за последние 6 часов для любого сервера Postgres, регистрируясь в этом рабочем пространстве.

### <a name="log-format"></a>Формат журнала

В следующей таблице описаны поля для типа **PostgreS'Llogs.** Порядок появления выбранных полей зависит от выбранной конечной точки вывода. 

|**Поле** | **Описание** |
|---|---|
| TenantId | Идентификатор клиента |
| SourceSystem | `Azure` |
| TimeGenerated [UTC] | Метка времени, когда журнал был записан в формате UTC |
| Тип | Тип журнала Всегда `AzureDiagnostics` |
| SubscriptionId | Идентификатор GUID для подписки, принадлежащей серверу |
| ResourceGroup | Имя группы ресурсов, принадлежащей серверу |
| ResourceProvider | Имя поставщика ресурсов. Всегда `MICROSOFT.DBFORPOSTGRESQL` |
| ResourceType | `Servers` |
| ResourceId | Универсальный код ресурса (URI) |
| Ресурс | Имя сервера |
| Категория | `PostgreSQLLogs` |
| OperationName | `LogEvent` |
| errorLevel | Уровень ведения журнала, например: LOG, ERROR, NOTICE |
| Сообщение | Первичное сообщение журнала | 
| Домен | Версия сервера, например: postgres 10 |
| Описание | Второстепенное сообщение журнала (если применимо) |
| ColumnName | Имя столбца (если применимо) |
| SchemaName | Имя схемы (если применимо) |
| DatatypeName | Имя типа данных (если применимо) |
| LogicalServerName | Имя сервера | 
| _ResourceId | Универсальный код ресурса (URI) |
| Prefix | Префикс строки журнала |


## <a name="next-steps"></a>Дальнейшие действия
- Дополнительные сведения о доступе к журналам см. в статье [Настройка журналов сервера и получение к ним доступа с помощью портала Azure](howto-configure-server-logs-in-portal.md) или [Настройка журналов сервера и получение к ним доступа с помощью Azure CLI](howto-configure-server-logs-using-cli.md).
- Дополнительные сведения см. в статье [Цены на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/).
- Подробнее о [журналах аудита](concepts-audit.md)
