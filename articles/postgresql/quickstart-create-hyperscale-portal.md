---
title: Краткое руководство. База данных Azure для PostgreSQL с решением Hyperscale (Citus) (предварительная версия)
description: Краткое руководство по созданию распределенных таблиц и выполнению к ним запросов с помощью Базы данных Azure для PostgreSQL с решением Hyperscale (Citus) (предварительная версия).
author: jonels-msft
ms.author: jonels
ms.service: postgresql
ms.subservice: hyperscale-citus
ms.custom: mvc
ms.topic: quickstart
ms.date: 05/06/2019
ms.openlocfilehash: 30de4da43569abf4d7bd668fd0fa481ecac23f4d
ms.sourcegitcommit: 0ae3139c7e2f9d27e8200ae02e6eed6f52aca476
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65080032"
---
# <a name="quickstart-create-an-azure-database-for-postgresql---hyperscale-citus-preview-in-the-azure-portal"></a>Краткое руководство. Создание Базы данных Azure для PostgreSQL" с решением Hyperscale (Citus) (предварительная версия) на портале Azure

База данных Azure для PostgreSQL — это управляемая служба, с помощью которой можно запускать и масштабировать базы данных PostgreSQL высокой доступности, а также управлять ими в облаке. Из этого краткого руководства вы узнаете, как создать серверную группу Базы данных Azure для PostgreSQL с решением Hyperscale (Citus) (предварительная версия) на портале Azure. Вы изучите распределение данных — сегментирование таблиц по узлам, прием данных и выполнение запросов, выполняемых на нескольких узлах.

Если у вас еще нет подписки Azure, создайте [бесплатную](https://azure.microsoft.com/free/) учетную запись Azure, прежде чем начинать работу.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Войдите на [портале Azure](https://portal.azure.com).

## <a name="create-an-azure-database-for-postgresql"></a>Создание базы данных Azure для PostgreSQL

Чтобы создать базу данных Azure для сервера PostgreSQL, сделайте следующее:
1. Щелкните **Создать ресурс** в верхнем левом углу окна портала Azure.
2. На странице **создания** выберите **Базы данных**, а на странице **Базы данных** щелкните **Azure Database for PostgreSQL** (База данных Azure для PostgreSQL).
3. Чтобы выполнить развертывание, нажмите кнопку **Создать** в разделе **Hyperscale (Citus) server group - PREVIEW** (Группа серверов Hyperscale (Citus) — предварительная версия).
4. Заполните форму для создания сервера, указав следующую информацию:
   - Под текстовым полем в разделе "Группа ресурсов" щелкните ссылку **Создать**. Присвойте группе ресурсов имя, например **myresourcegroup**.
   - Имя группы серверов. Введите уникальное имя для новой группы серверов, которое будет использоваться и для поддомена сервера.
   - Имя пользователя-администратора. Задайте уникальное имя пользователя, которое понадобится позже для подключения к базе данных.
   - Пароль. Должен содержать минимум восемь символов из таких трех категорий: латинские прописные и строчные буквы, цифры (0–9) и другие символы (!, $, #, % и т. д.).
   - Расположение. Задайте ближайшее к пользователям расположение, чтобы предоставить им максимально быстрый доступ к данным.

   > [!IMPORTANT]
   > Указанные здесь учетные данные и пароль администратора сервера понадобятся позже в этом руководстве, чтобы войти на сервер и в его базу данных. Запомните или запишите эту информацию для последующего использования.

5. Щелкните **Настройка группы серверов**. Не изменяйте настройки в этом разделе и щелкните **Сохранить**.
6. Щелкните **Просмотр и создание**, а затем — **Создать**, чтобы подготовить сервер к работе. Подготовка занимает несколько минут.
7. Произойдет переход на страницу отслеживания развертывания. Когда состояние изменится с **Развертывание выполняется** на **Развертывание выполнено**, щелкните пункт меню **Выходные данные** в левой части страницы.
8. На странице выходных данных будет указано имя узла-координатора, кнопка рядом с которым позволяет скопировать это значение в буфер обмена. Сохраните эту информацию на будущее.

## <a name="configure-a-server-level-firewall-rule"></a>Настройка правила брандмауэра на уровне сервера

База данных Azure для PostgreSQL с решением Hyperscale (Citus) (предварительная версия) использует брандмауэр на уровне сервера. По умолчанию брандмауэр блокирует подключение любых внешних приложений и средств к узлу-координатору и к базам данных на этом узле. Необходимо добавить правило, открывающее брандмауэр для определенного диапазона IP-адресов.

1. В разделе **Выходные данные**, в котором вы ранее скопировали имя узла-координатора, щелкните пункт меню **Обзор**.

2. Имя группы масштабирования для развертывания будет иметь префикс sg-. Найдите его в списке ресурсов и щелкните его.

3. В меню слева в разделе **Безопасность** щелкните **Брандмауэр**.

4. Щелкните ссылку **+ Добавить правило брандмауэра для текущего IP-адреса клиента**. В завершение нажмите кнопку **Сохранить**.

5. Выберите команду **Сохранить**.

   > [!NOTE]
   > Сервер PostgreSQL Azure обменивается данными через порт 5432. Если вы пытаетесь подключиться из корпоративной сети, исходящий трафик через порт 5432 может быть запрещен сетевым брандмауэром. В таком случае вы не сможете подключиться к серверу Базы данных SQL Azure, пока ваш ИТ-отдел не откроет порт 5432.
   >

## <a name="connect-to-the-database-using-psql-in-cloud-shell"></a>Подключение к базе данных с помощью psql в Cloud Shell

Теперь подключимся к серверу базы данных Azure для PostgreSQL с помощью служебной программы командной строки [psql](https://www.postgresql.org/docs/current/app-psql.html).
1. Запустите Azure Cloud Shell с помощью значка терминала в верхней области навигации.

   ![База данных Azure для PostgreSQL. Значок терминала Azure Cloud Shell](./media/quickstart-create-hyperscale-portal/psql-cloud-shell.png)

2. В браузере откроется служба Azure Cloud Shell, которая позволяет выполнять команды Bash.

   ![База данных Azure для PostgreSQL. Строка Bash в Azure Cloud Shell](./media/quickstart-create-hyperscale-portal/psql-bash.png)

3. Подключитесь к базе данных Azure для сервера PostgreSQL, выполнив команду psql в командной строке Cloud Shell. Используйте следующий формат, чтобы подключиться к серверу базы данных Azure для PostgreSQL с помощью служебной программы [psql](https://www.postgresql.org/docs/9.6/static/app-psql.html):
   ```bash
   psql --host=<myserver> --username=myadmin --dbname=citus
   ```

   Так, следующая команда устанавливает подключение к базе данных по умолчанию с именем **citus** на сервере PostgreSQL **mydemoserver.postgres.database.azure.com**, используя учетные данные для доступа. В ответ на запрос введите пароль администратора сервера.

   ```bash
   psql --host=mydemoserver.postgres.database.azure.com --username=myadmin --dbname=citus
   ```

## <a name="create-and-distribute-tables"></a>Создание и распределение таблиц

После подключения к узлу координатора Hyperscale с помощью psql можно выполнить некоторые основные задачи.

На серверах Hyperscale используется три вида таблиц:

- распределенные или сегментированные таблицы (распределенные в целях масштабирования для повышения производительности и работы в параллельном режиме);
- ссылочные таблицы (несколько копий);
- локальные таблицы (часто используется как внутренние таблицы администрирования).

В этом кратком руководстве основное внимание уделяется распределенным таблицам и работе с ними.

Мы будем использовать простую модель данных из репозитория GitHub с данными о пользователях и событиях. К событиям относится создание вилки, фиксации GIT, относящиеся к организации, и прочее.

Выполнив подключение с помощью psql, создадим таблицы. В консоли psql выполните такие команды:

```sql
CREATE TABLE github_events
(
    event_id bigint,
    event_type text,
    event_public boolean,
    repo_id bigint,
    payload jsonb,
    repo jsonb,
    user_id bigint,
    org jsonb,
    created_at timestamp
);

CREATE TABLE github_users
(
    user_id bigint,
    url text,
    login text,
    avatar_url text,
    gravatar_id text,
    display_login text
);
```

Поле `payload` в `github_events` содержит данные в формате JSONB. JSONB — это используемая в Postgres разновидность формата JSON с данными в двоичном формате. Этот формат обеспечивает более гибкую схему, которую можно хранить в одном столбце.

Postgres может создать индекс `GIN` для этого типа, который будет индексировать каждый ключ и значение внутри него. С помощью индекса можно быстрее и проще запрашивать полезные данные с различными условиями. Теперь создадим несколько индексов, прежде чем загружать данные. В psql выполните такие команды:

```sql
CREATE INDEX event_type_index ON github_events (event_type);
CREATE INDEX payload_index ON github_events USING GIN (payload jsonb_path_ops);
```

Далее мы поместим эти таблицы Postgres на узле координатора и распределим их по рабочим узлам с помощью решения Hyperscale. Для этого выполним запрос к каждой таблице, указав ключ для ее сегментирования. В этом примере мы будем сегментировать обе таблицы — с данными о пользователях и данными о событиях с помощью `user_id`.

```sql
SELECT create_distributed_table('github_events', 'user_id');
SELECT create_distributed_table('github_users', 'user_id');
```

Теперь можно загрузить данные. Скачайте два образца файлов — [users.csv](https://examples.citusdata.com/users.csv) и [events.csv](https://examples.citusdata.com/events.csv). После этого подключитесь к базе данных с помощью psql, запустив программу из каталога, в котором находятся скачанные файлы. Загрузите данные с помощью команды `\copy`.

```sql
\copy github_events from 'events.csv' WITH CSV
\copy github_users from 'users.csv' WITH CSV
```

## <a name="run-queries"></a>Выполнение запросов

Теперь можно приступить к выполнению запросов. Начнем с простого — `count (*)`, чтобы узнать, какой объем данных мы загрузили.

```sql
SELECT count(*) from github_events;
```

Замечательно. Мы вскоре вернемся к такого рода агрегированию, а пока выполним несколько других запросов. В столбце JSONB `payload` порядочный объем данных, но они различаются по типу события. События `PushEvent` содержат размер, который включает в себя число уникальных фиксаций для отправки. Его можно использовать для получения общего числа фиксации в час.

```sql
SELECT date_trunc('hour', created_at) AS hour,
       sum((payload->>'distinct_size')::int) AS num_commits
FROM github_events
WHERE event_type = 'PushEvent'
GROUP BY hour
ORDER BY hour;
```

До сих пор запросы касались исключительно данных github\_events, но можно объединить эти сведения с данными github\_users. Так как мы выполнили сегментирование пользователей и событий с помощью одного идентификатора (`user_id`), строки обеих таблиц с совпадающими идентификаторами пользователя будут [размещены вместе](http://docs.citusdata.com/en/stable/sharding/data_modeling.html#colocation) на одних и тех же узлах базы данных и их можно легко объединить.

Если объединить данные по `user_id`, решение Hyperscale сможет выполнить объединение в сегментах в параллельном режиме на рабочих узлах. Например, можно найти пользователей, создавших наибольшее количество репозиториев.

```sql
SELECT login, count(*)
FROM github_events ge
JOIN github_users gu
ON ge.user_id = gu.user_id
WHERE event_type = 'CreateEvent' AND
      payload @> '{"ref_type": "repository"}'
GROUP BY login
ORDER BY count(*) DESC;
```

## <a name="clean-up-resources"></a>Очистка ресурсов

На предыдущих шагах вы создали ресурсы Azure в группе серверов. Если эти ресурсы вам больше не нужны, удалите группу серверов. Нажмите кнопку **Удалить** на странице **Обзор**, чтобы удалить группу серверов. При появлении запроса на всплывающей странице проверьте имя группы серверов и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

Из этого краткого руководства вы узнали, как подготовить к работе группу серверов Hyperscale (Citus). Вы подключились к ней с помощью psql, создали схему и выполнили распределение данных.

Далее ознакомьтесь с руководством по созданию масштабируемых приложений с несколькими клиентами.
> [!div class="nextstepaction"]
> [Проектирование мультитенантной базы данных](https://aka.ms/hyperscale-tutorial-multi-tenant)
