---
title: Шифрование данных с помощью ключа, управляемого клиентом — база данных Azure для PostgreSQL — один сервер
description: Шифрование данных на одном сервере в базе данных Azure для PostgreSQL с помощью управляемого клиентом ключа позволяет создание собственных ключей (BYOK) для защиты данных. Он также позволяет организациям реализовать разделение обязанностей в управлении ключами и данными.
author: kummanish
ms.author: manishku
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/13/2020
ms.openlocfilehash: 20e01e681c382e3c9c69f76c95a90f709f409d6a
ms.sourcegitcommit: c29b7870f1d478cec6ada67afa0233d483db1181
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79297028"
---
# <a name="azure-database-for-postgresql-single-server-data-encryption-with-a-customer-managed-key"></a>Шифрование данных на одном сервере в базе данных Azure для PostgreSQL с помощью управляемого клиентом ключа

> [!NOTE]
> В настоящее время необходимо запросить доступ, чтобы использовать эту возможность. Для этого обратитесь в AskAzureDBforPostgreSQL@service.microsoft.com.

Шифрование данных с помощью ключей, управляемых клиентом, для сервера базы данных Azure для PostgreSQL позволяет создавать собственный ключ (BYOK) для защиты данных. Он также позволяет организациям реализовать разделение обязанностей в управлении ключами и данными. При шифровании, управляемом клиентом, вы несете ответственность за полное управление жизненным циклом ключа, разрешениями на использование ключа и аудитом операций с ключами.

Шифрование данных с ключами, управляемыми клиентом для базы данных Azure для PostgreSQL Single Server, задается на уровне сервера. Для данного сервера управляемый клиентом ключ, называемый ключом шифрования ключа (KEK), используется для шифрования ключа шифрования данных (DEK), используемого службой. KEK — это асимметричный ключ, хранящийся в принадлежащем заказчике и управляемом клиентом экземпляре [Azure Key Vault](../key-vault/key-Vault-secure-your-key-Vault.md) . Ключ шифрования ключа (KEK) и ключ шифрования данных (DEK) подробно описаны далее в этой статье.

Key Vault — это внешняя система управления ключами на основе облака. Он обладает высокой доступностью и предоставляет масштабируемое, безопасное хранилище для криптографических ключей RSA, при необходимости поддерживаемых аппаратными модулями безопасности (HSM) FIPS 140-2 уровня 2. Он не разрешает прямой доступ к сохраненному ключу, но обеспечивает службы шифрования и расшифровки для полномочных сущностей. Key Vault может создать ключ, импортировать его или [передать его с локального устройства HSM](../key-vault/key-Vault-hsm-protected-keys.md).

> [!NOTE]
> Эта функция доступна во всех регионах Azure, где служба "база данных Azure для PostgreSQL" поддерживает ценовые категории "общего назначения" и "оптимизировано для памяти".

## <a name="benefits"></a>Преимущества

Шифрование данных для одного сервера базы данных Azure для PostgreSQL обеспечивает следующие преимущества:

* Доступ к данным полностью контролируется с помощью возможности удалить ключ и сделать базу данных недоступной 
*    Полный контроль над ключевым циклом, включая вращение ключа для согласования с корпоративными политиками.
*    Централизованное управление и организация ключей в Azure Key Vault
*    Возможность реализации разделения обязанностей между должностными лицами, администраторами баз данных и системным администратором

## <a name="terminology-and-description"></a>Терминология и описание

**Ключ шифрования данных (DEK)** : симметричный ключ AES256, используемый для шифрования раздела или блока данных. Шифрование каждого блока данных другим ключом создает дополнительные сложности для выполнения атак в отношении зашифрованных данных. Доступ к DEK требуется поставщику ресурсов или экземпляру приложения, выполняющему шифрование или расшифровку определенного блока. При замене DEK новым ключом только данные в связанном блоке должны быть повторно зашифрованы с помощью нового ключа.

Ключ **шифрования ключа (KEK)** : ключ шифрования, используемый для шифрования DEK. KEK, который никогда не покидает Key Vault, позволяет шифровать и контролировать DEK. Сущность, имеющая доступ к KEK, может отличаться от сущности, для которой требуется DEK. Так как KEK требуется для расшифровки ключей DEK, его можно фактически рассматривать как единую точку, с помощью которой можно удалить ключи DEK (непосредственно удалив KEK).

DEK, зашифрованный с помощью ключи обмена ключами, хранятся отдельно. Только сущность с доступом к KEK может расшифровать эти DEK. Дополнительные сведения см. [в статье безопасность при шифровании неактивных](../security/fundamentals/encryption-atrest.md)данных.

## <a name="how-data-encryption-with-a-customer-managed-key-works"></a>Как работает шифрование данных с помощью управляемого клиентом ключа

![Схема, на которой показан обзор создание собственных ключей](media/concepts-data-access-and-security-data-encryption/postgresql-data-encryption-overview.png)

Чтобы сервер PostgreSQL использовал ключи, управляемые клиентом, хранящиеся в Key Vault для шифрования DEK, администратор Key Vault предоставляет следующие права доступа к серверу:

* **получить**: для получения общедоступной части и свойств ключа в хранилище ключей.
* **wrapKey**: чтобы иметь возможность зашифровать DEK.
* **unwrapKey**: чтобы иметь возможность расшифровывать DEK.

Администратор хранилища ключей может также [включить ведение журнала событий аудита Key Vault](../azure-monitor/insights/azure-key-vault.md), чтобы их можно было проследить позднее.

Если сервер настроен для использования управляемого клиентом ключа, хранящегося в хранилище ключей, сервер отправляет DEK в хранилище ключей для шифрования. Key Vault возвращает зашифрованный DEK, хранящийся в пользовательской базе данных. Аналогично, при необходимости сервер отправляет защищенный DEK в хранилище ключей для расшифровки. Аудиторы могут использовать Azure Monitor для просмотра журналов событий аудита Key Vault, если включено ведение журнала.

## <a name="requirements-for-configuring-data-encryption-for-azure-database-for-postgresql-single-server"></a>Требования для настройки шифрования данных для одного сервера базы данных Azure для PostgreSQL

Ниже приведены требования к настройке Key Vault.

* Key Vault и база данных Azure для PostgreSQL должны принадлежать одному клиенту Azure Active Directory (Azure AD). Межклиентские Key Vault и взаимодействия с сервером не поддерживаются. Перемещение ресурсов после этого требует перенастройки шифрования данных.
* Необходимо включить функцию обратимого удаления в хранилище ключей, чтобы защититься от потери данных при возникновении случайного удаления ключа (или Key Vault). Ресурсы с обратимым удалением хранятся в течение 90 дней, если только пользователь не восстановит их или не выполнит их очистку. Действия восстановления и очистки имеют собственные разрешения, связанные с политикой доступа Key Vault. Функция обратимого удаления отключена по умолчанию, но ее можно включить с помощью PowerShell или Azure CLI (Обратите внимание, что ее нельзя включить с помощью портал Azure).
* Предоставьте базе данных Azure для PostgreSQL односерверный доступ к хранилищу ключей с разрешениями Get, wrapKey и unwrapKey, используя уникальное управляемое удостоверение. В портал Azure уникальный идентификатор создается автоматически при включении шифрования данных на одном сервере PostgreSQL. Подробные пошаговые инструкции по использованию портал Azure см. [в статье шифрование данных для сервера базы данных Azure для PostgreSQL с помощью портал Azure](howto-data-encryption-portal.md) .

* Если вы используете брандмауэр с Key Vault, необходимо включить параметр **разрешить доверенным службам Майкрософт обход брандмауэра**.

Ниже приведены требования к настройке ключа, управляемого клиентом:

* Управляемый клиентом ключ, используемый для шифрования DEK, может быть только асимметричным, RSA 2028.
* Ключевая дата активации (если она задана) должна быть датой и временем в прошлом. Дата истечения срока действия (если она задана) должна быть будущей датой и временем.
* Ключ должен находиться в *включенном* состоянии.
* Если вы импортируете существующий ключ в хранилище ключей, убедитесь, что он предоставлен в поддерживаемых форматах файлов (`.pfx`, `.byok`, `.backup`).

## <a name="recommendations"></a>Рекомендации

При использовании шифрования данных с помощью ключа, управляемого клиентом, ниже приведены рекомендации по настройке Key Vault.

* Установите блокировку ресурсов на Key Vault, чтобы контролировать, кто может удалять этот критический ресурс и предотвращать случайное или несанкционированное удаление.
* Включите аудит и создание отчетов по всем ключам шифрования. Key Vault предоставляет журналы, которые легко внедрять в другие сведения о безопасности и средствах управления событиями. Azure Monitor Log Analytics — это один из примеров службы, которая уже интегрирована.

* Убедитесь, что Key Vault и база данных Azure для PostgreSQL расположены в одном регионе, чтобы обеспечить более быстрый доступ к операциям переноса и распаковки DEK.

Ниже приведены рекомендации по настройке ключа, управляемого клиентом:

* Помещайте копию управляемого клиентом ключа в безопасном месте или передайте ее в депонированную службу.

* Если Key Vault создает ключ, создайте резервную копию ключа, прежде чем использовать ключ в первый раз. Резервную копию можно восстановить только в Key Vault. Дополнительные сведения о команде Backup см. в разделе [BACKUP-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyVault/backup-azkeyVaultkey).

## <a name="inaccessible-customer-managed-key-condition"></a>Недоступное условие управляемого клиентом ключа

При настройке шифрования данных с помощью ключа, управляемого клиентом, в Key Vault требуется постоянный доступ к этому ключу, чтобы сервер оставался в сети. Если сервер теряет доступ к ключу, управляемому клиентом, в Key Vault, сервер начинает отклонять все подключения в течение 10 минут. Сервер выдает соответствующее сообщение об ошибке и изменяет состояние сервера на *недоступное*. Единственным действием, разрешенным в базе данных в этом состоянии, является ее удаление.

### <a name="accidental-key-access-revocation-from-key-vault"></a>Отзыв непреднамеренного доступа к ключу из Key Vault

Может случиться, что кто-то, имеющий достаточные права доступа к Key Vault случайно отключает доступ сервера к ключу следующим образом:

* Отмена разрешений Get, wrapKey и unwrapKey хранилища ключей с сервера.
* Удаление ключа.
* Идет Удаление хранилища ключей.
* Изменение правил брандмауэра для хранилища ключей.

* Удаление управляемого удостоверения сервера в Azure AD.

## <a name="monitor-the-customer-managed-key-in-key-vault"></a>Мониторинг ключа, управляемого клиентом, в Key Vault

Чтобы отслеживать состояние базы данных и включать предупреждения для потери прозрачного доступа к предохранителю шифрования данных, настройте следующие функции Azure:

* [Работоспособность ресурсов Azure](../service-health/resource-health-overview.md): недоступная база данных, которая потеряла доступ к ключу клиента, отображается как "недоступно" после того, как было отказано в первом соединении с базой данных.
* [Журнал действий](../service-health/alerts-activity-log-service-notifications.md). при сбое доступа к ключу клиента в управляемом клиентом Key Vault в журнал действий добавляются записи. При создании предупреждений для этих событий можно как можно скорее возобновить доступ.

* [Группы действий](../azure-monitor/platform/action-groups.md). Определите их, чтобы отправлять вам уведомления и оповещения в соответствии с вашими предпочтениями.

## <a name="restore-and-replicate-with-a-customers-managed-key-in-key-vault"></a>Восстановление и репликация с помощью управляемого ключа клиента в Key Vault

После того как база данных Azure для PostgreSQL с одним сервером шифруется с помощью управляемого ключа клиента, хранящегося в Key Vault, все вновь созданные копии сервера также шифруются. Эту новую копию можно создать с помощью локальной или географической операции или с помощью операций чтения реплик. Однако копию можно изменить, чтобы отразить управляемый ключ нового клиента для шифрования. При изменении ключа, управляемого клиентом, старые резервные копии сервера начинают использовать последний ключ.

Чтобы избежать проблем при настройке шифрования данных, управляемого клиентом, во время восстановления или создания реплики чтения, важно выполнить следующие действия на главном и восстановленной серверах/репликах.

* Запустите процесс восстановления или чтения реплики из базы данных master Azure для PostgreSQL Single Server.
* Сохранить только что созданный сервер (восстановленный или реплика) в недоступном состоянии, так как его уникальный идентификатор еще не предоставил разрешения на Key Vault.
* На восстановленном сервере-реплике повторно проверьте ключ, управляемый клиентом, в параметрах шифрования данных. Это гарантирует, что только что созданный сервер получает разрешения на перенос и отправку для ключа, хранящегося в Key Vault.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [настроить шифрование данных с помощью ключа, управляемого клиентом, для базы данных Azure для PostgreSQL на одном сервере, используя портал Azure](howto-data-encryption-portal.md).

