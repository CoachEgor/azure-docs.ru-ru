---
title: Шифрование данных одного сервера в базе данных Azure для PostgreSQL с помощью ключа, управляемого клиентом
description: Шифрование данных в базе данных Azure для PostgreSQL с помощью ключа, управляемого клиентом, позволяет создание собственных ключей (BYOK) для защиты данных в неактивных целях и позволяет организациям реализовать разделение обязанностей в управлении ключами и данными.
author: kummanish
ms.author: manishku
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/13/2020
ms.openlocfilehash: f9e60b2f1685e03a9daa7a4801f43799a21eb411
ms.sourcegitcommit: b5106424cd7531c7084a4ac6657c4d67a05f7068
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75940550"
---
# <a name="azure-database-for-postgresql-single-server-data-encryption-with-customer-managed-key"></a>Шифрование данных одного сервера в базе данных Azure для PostgreSQL с помощью ключа, управляемого клиентом

> [!NOTE]
> В настоящее время необходимо запросить доступ, чтобы использовать эту возможность. Для этого обратитесь в AskAzureDBforPostgreSQL@service.microsoft.com.

Шифрование данных в базе данных Azure для PostgreSQL с помощью ключа, управляемого клиентом, позволяет создание собственных ключей (BYOK) для защиты данных в неактивных целях и позволяет организациям реализовать разделение обязанностей в управлении ключами и данными. При шифровании, управляемом клиентом, вы несете ответственность за полный контроль над жизненным циклом ключа (создание ключа, передача, вращение, удаление), разрешения на использование ключа и аудит операций с ключами.

Для одного сервера базы данных Azure для PostgreSQL шифрование данных устанавливается на уровне сервера. В этой форме шифрования данных ключ используется для шифрования ключа шифрования базы данных (DEK), который является управляемым клиентом асимметричным ключом, хранящимся в принадлежащем заказчику и управляемом клиентом [Azure Key Vault (AKV)](../key-vault/key-Vault-secure-your-key-Vault.md), облачной системе управления внешними ключами. AKV является высокодоступным и предоставляет масштабируемое безопасное хранилище для криптографических ключей RSA, при необходимости поддерживаемое FIPS 140-2 уровня 2 проверенных аппаратных модулей безопасности (HSM). Он не разрешает прямой доступ к сохраненному ключу, но предоставляет службы шифрования и расшифровки с помощью ключа для полномочных сущностей. Ключ может быть создан Key Vault, импортирован или [передан в Key Vault с локального устройства HSM](../key-vault/key-Vault-hsm-protected-keys.md).

> [!NOTE]
> Эта функция доступна во всех регионах Azure, где база данных Azure для PostgreSQL поддерживает общего назначения и ценовые категории, оптимизированные для памяти.

## <a name="benefits"></a>Преимущества

Шифрование данных для одного сервера базы данных Azure для PostgreSQL обеспечивает следующие преимущества:

* Повышенная прозрачность и детальное управление и управление для ключа шифрования 
* Централизованное управление и организация ключей путем их размещения в Azure Key Vault. 
* Возможность реализации разделения обязанностей в управлении ключами и данными в Организации
* Отделение управления ключами от управления данными в Организации, поэтому Key Vault администратор может отозвать разрешения на доступ к ключам, чтобы сделать зашифрованную базу данных недоступной 
* Более высокий уровень доверия от конечных клиентов, так как Azure Key Vault спроектирован таким образом, что корпорация Майкрософт не может просматривать и извлекать ключи шифрования.

## <a name="terminology-and-description"></a>Терминология и описание

**Ключ шифрования данных (DEK)**  — симметричный ключ AES256 для шифрования раздела или блока данных. Шифрование каждого блока данных другим ключом создает дополнительные сложности для выполнения атак в отношении зашифрованных данных. Доступ к DEK требуется поставщику ресурсов или экземпляру приложения, выполняющему шифрование или расшифровку определенного блока. Когда DEK заменяется новым ключом, только данные в связанном блоке должны быть повторно зашифрованы с помощью нового ключа.

Ключ **шифрования ключа (KEK)** — ключ шифрования, используемый для шифрования ключей шифрования данных. Использование ключа шифрования ключа, который никогда не покидает Key Vault, позволяет шифровать и контролировать ключи шифрования данных. Сущность, у которой есть доступ к KEK, может быть отличной от сущности, требующей DEK. Так как KEK требуется для расшифровки ключей DEK, его можно фактически рассматривать как единую точку, с помощью которой можно удалить ключи DEK (непосредственно удалив KEK).

Ключи шифрования данных, зашифрованные с помощью ключей шифрования ключей, хранятся отдельно, и только сущность с доступом к ключу шифрования ключей может расшифровывать эти ключи шифрования данных. Дополнительные сведения см. [в статье безопасность при шифровании неактивных](../security/fundamentals/encryption-atrest.md)данных.

## <a name="how-data-encryption-with-customer-managed-key-works"></a>Как работает шифрование данных с помощью ключа, управляемого клиентом

![Обзор собственных ключей](media/concepts-data-access-and-security-data-encryption/postgresql-data-encryption-overview.png)

Чтобы сервер PostgreSQL мог использовать управляемые клиентом ключи, хранящиеся в AKV для шифрования DEK, администратор Key Vault должен предоставить серверу следующие права доступа, используя его уникальное удостоверение:

* **Get** — для получения общедоступной части и свойств ключа в Key Vault
* **wrapKey** — для обеспечения возможности защиты (шифрования) DEK
* **unwrapKey** — чтобы иметь возможность снять защиту (расшифровка) DEK

Key Vault администратор может также [включить ведение журнала событий Key Vault аудита](../azure-monitor/insights/azure-key-vault.md), чтобы их можно было проследить позднее.

Если сервер настроен для использования управляемого клиентом ключа, который хранится в Key Vault, сервер отправляет DEK в Key Vault для шифрования. Key Vault возвращает зашифрованный DEK, хранящийся в пользовательской базе данных. Аналогично, при необходимости сервер отправляет защищенные DEK на Key Vault для расшифровки. Аудиторы могут использовать Azure Monitor для просмотра журналов Key Vault AuditEvent, если ведение журнала включено.

## <a name="requirements-for-configuring-data-encryption-for-azure-database-for-postgresql-single-server"></a>Требования для настройки шифрования данных для одного сервера базы данных Azure для PostgreSQL

### <a name="requirements-for-configuring-akv"></a>Требования для настройки AKV

* Key Vault и база данных Azure для PostgreSQL должны принадлежать одному и тому же клиенту Azure Active Directory (AAD). Межклиентские Key Vault и взаимодействия с сервером не поддерживаются. Перемещение ресурсов после этого требует перенастройки шифрования данных. Дополнительные сведения о перемещении ресурсов.
* Функция обратимого удаления должна быть включена на Key Vault для защиты от случайного удаления ключа (или Key Vault). Обратимо удаленные ресурсы хранятся в течение 90 дней, если только они не будут восстановлены или очищены клиентом. Действия восстановления и очистки имеют собственные разрешения, связанные с политикой доступа Key Vault. Функция обратимого удаления отключена по умолчанию и может быть включена с помощью PowerShell или CLI. Его нельзя включить с помощью портал Azure.
* Предоставьте базе данных Azure для PostgreSQL односерверный доступ к Key Vault с разрешениями **Get, wrapKey, unwrapKey,** используя уникальное управляемое удостоверение. При использовании портал Azure уникальный идентификатор автоматически создается при включении шифрования данных на одном сервере PostgreSQL. Подробные пошаговые инструкции по использованию портал Azure см. в разделе [Настройка шифрования данных для одного сервера PostgreSQL](howto-data-encryption-portal.md) .

* При использовании брандмауэра с AKV необходимо включить параметр *разрешить доверенным службам Майкрософт обходить брандмауэр*.

### <a name="requirements-for-configuring-customer-managed-key"></a>Требования к настройке ключа, управляемого клиентом

* Управляемый клиентом ключ, используемый для шифрования DEK, может быть только асимметричным, RSA 2028.
* Ключевая дата активации (если она задана) должна быть датой и временем в прошлом. Дата истечения срока действия (если она задана) должна быть будущей датой и временем.
* Ключ должен находиться в *включенном* состоянии.
* При импорте существующего ключа в Key Vault убедитесь, что он предоставлен в поддерживаемых форматах файлов (`.pfx`, `.byok`, `.backup`).

## <a name="recommendations-when-using-data-encryption-using-customer-managed-key"></a>Рекомендации по использованию шифрования данных с помощью управляемого клиентом ключа

### <a name="recommendation-for-configuring-akv"></a>Рекомендации по настройке AKV

* Установите блокировку ресурсов на Key Vault, чтобы контролировать, кто может удалять этот критический ресурс и предотвращать случайное или несанкционированное удаление. Дополнительные сведения о блокировках ресурсов.
* Включите аудит и создание отчетов по всем ключам шифрования: Key Vault предоставляет журналы, которые легко внедрять в другие сведения о безопасности и средствах управления событиями. Azure Monitor Log Analytics — это один из примеров службы, которая уже интегрирована.

* Убедитесь, что Key Vault и один сервер базы данных Azure для PostgreSQL находятся в одном регионе, чтобы обеспечить более быстрый доступ к операциям переноса и распаковки DEK.

### <a name="recommendation-for-configuring-customer-managed-key"></a>Рекомендации по настройке ключа, управляемого клиентом

* Помещайте копию ключа, управляемого клиентом (KEK), в безопасном месте или передайте ее в депонированную службу.

* Если ключ создается в Key Vault, создайте резервную копию ключа, прежде чем использовать ключ в AKV в первый раз. Резервное копирование можно восстановить только в Azure Key Vault. Дополнительные сведения о команде [BACKUP-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyVault/backup-azkeyVaultkey) .

## <a name="inaccessible-customer-managed-key-condition"></a>Недоступное условие управляемого клиентом ключа

При настройке шифрования данных с помощью ключа, управляемого клиентом, в Azure Key Vault (AKV) непрерывный доступ к этому ключу необходим для того, чтобы сервер оставался в сети. Если сервер теряет доступ к ключу, управляемому клиентом, в AKV в течение 10 минут, сервер начинает отклонять все соединения с соответствующим сообщением об ошибке и изменяет состояние сервера на **недоступное**. Единственным действием, разрешенным в базе данных в недоступном состоянии, является ее удаление.

### <a name="accidental-key-access-revocation-from-the-azure-key-vault-akv"></a>Отзыв доступа по случайному ключу из Azure Key Vault (AKV)

Возможно, кто-то, имеющий достаточные права доступа к Key Vault случайно отключил доступ к этому разделу серверу:

* Key Vault Отмена разрешений Get, wrapKey, unwrapKey на сервере
* Удаление ключа
* Удаление Key Vault
* изменение правил брандмауэра Key Vault

* Удаление управляемого удостоверения сервера в Azure Active Directory

## <a name="monitoring-of-the-customer-managed-key-in-the-key-vault"></a>Мониторинг ключа, управляемого клиентом, в Key Vault

Чтобы отслеживать состояние базы данных и включать предупреждения для потери доступа к TDE предохранителю, настройте следующие функции Azure:

* [Работоспособность ресурсов Azure](../service-health/resource-health-overview.md) . недоступная база данных с потерянным доступом к ключу клиента будет отображаться как "недоступно" после того, как было отказано в первом подключении к базе данных.
* [Журнал действий](../service-health/alerts-activity-log-service-notifications.md) . при сбое доступа к ключу клиента в управляемом клиентом Key Vault в журнал действий добавляются записи. Создание оповещений для этих событий позволит возобновить доступ как можно скорее.

* [Группы действий](../azure-monitor/platform/action-groups.md) можно определить для отправки уведомлений и оповещений на основе ваших предпочтений, например электронной почты, SMS, Push/Voice, приложения логики, веб-перехватчика, ITSM или Runbook службы автоматизации.

## <a name="restore-and-replica-with-customers-managed-key-in-the-key-vault"></a>Восстановление и реплика с помощью управляемого ключа клиента в Key Vault

После того как база данных Azure для PostgreSQL с одним сервером шифруется с помощью управляемого ключа клиента, хранящегося в Key Vault, все созданные копии сервера (хотя локальные или геовосстановление или реплики чтения) также шифруются с тем же управляемый клиентом ключ. Однако их можно изменить в соответствии с управляемым ключом нового клиента для шифрования. При изменении ключа, управляемого клиентом, старые резервные копии сервера начнут использовать последний ключ.

Чтобы избежать проблем при установке шифрования данных, управляемого клиентом, во время восстановления или создания реплики на чтение, важно выполнить следующие действия на сервере-образце и восстановлении:

* Запустите процесс восстановления или чтения реплики из базы данных master Azure для PostgreSQL Single Server.
* Созданный сервер (восстановленная или реплика) находится в недоступном состоянии, так как его уникальный идентификатор еще не предоставил разрешения на Azure Key Vault (AKV)
* На восстановленном сервере-реплике повторно проверьте ключ, управляемый клиентом, в разделе Параметры шифрования данных, чтобы убедиться в том, что только что созданный сервер получает разрешения на кодирование и распаковку для ключа, хранящегося в AKV.

* Оба описанных выше действия должны быть выполнены, чтобы обеспечить сохранение шифрования данных на главном сервере, а также восстановленный или сервер реплики.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [настроить шифрование данных с помощью ключа, управляемого клиентом, для базы данных Azure для PostgreSQL на одном сервере, используя портал Azure](howto-data-encryption-portal.md).
