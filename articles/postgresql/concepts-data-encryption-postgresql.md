---
title: Шифрование данных с ключом, управляемым клиентом - База данных Azure для PostgreS'L - Единый сервер
description: База данных Azure для шифрования данных одного сервера PostgreS'L с ключом, управляемым клиентом, позволяет использовать свой собственный ключ (BYOK) для защиты данных в состоянии покоя. Он также позволяет организациям осуществлять разделение обязанностей в управлении ключами и данными.
author: kummanish
ms.author: manishku
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/13/2020
ms.openlocfilehash: 20e01e681c382e3c9c69f76c95a90f709f409d6a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79297028"
---
# <a name="azure-database-for-postgresql-single-server-data-encryption-with-a-customer-managed-key"></a>База данных Azure для шифрования данных единого сервера PostgreS'L с ключом, управляемым клиентом

> [!NOTE]
> В это время необходимо запросить доступ к этой возможности. Для этого свяжитесь с AskAzureDBforPostgreSQL@service.microsoft.comнами.

Шифрование данных с ключами, управляемыми клиентом для базы данных Azure для одного сервера PostgreS'L, позволяет вам принести свой собственный ключ (BYOK) для защиты данных в состоянии покоя. Он также позволяет организациям осуществлять разделение обязанностей в управлении ключами и данными. С помощью шифрования, управляемого клиентом, вы несете ответственность за жизненный цикл ключа, разрешения на использование ключей и аудит операций на ключах.

Шифрование данных с управляемыми клиентами ключами для базы данных Azure для одного сервера PostgreS'L устанавливается на уровне сервера. Для данного сервера ключ, управляемый клиентом, называемый ключом шифрования (KEK), используется для шифрования ключа шифрования данных (DEK), используемого службой. KEK — это асимметричный ключ, хранящийся в экземпляре [Azure Key Vault,](../key-vault/key-Vault-secure-your-key-Vault.md) принадлежащем клиенту и управляемому клиентом. Ключ шифрования (KEK) и ключ шифрования данных (DEK) описаны более подробно позже в этой статье.

Key Vault — это облачная внешняя система управления ключами. Он очень доступен и обеспечивает масштабируемое, безопасное хранилище для криптографических ключей RSA, дополнительно подкрепленное проверенными модулями аппаратной безопасности FIPS 140-2 Level 2 (HSM). Он не позволяет прямой доступ к сохраненному ключу, но предоставляет услуги шифрования и расшифровки уполномоченным организациям. Key Vault может генерировать ключ, импортировать его, или [иметь его переданы от предприимчивого устройства HSM.](../key-vault/key-Vault-hsm-protected-keys.md)

> [!NOTE]
> Эта функция доступна во всех регионах Azure, где база данных Azure для одного сервера PostgreS'L поддерживает уровни ценообразования «Общая цель» и «Оптимизация памяти».

## <a name="benefits"></a>Преимущества

Шифрование данных для базы данных Azure для единого сервера PostgreS'L обеспечивает следующие преимущества:

* Доступ к данным полностью контролируется вами, возможностью удалить ключ и сделать базу данных недоступной 
*    Полный контроль над ключевым жизненным циклом, включая вращение ключа для согласования с корпоративной политикой
*    Центральное управление и организация ключей в Azure Key Vault
*    Возможность осуществления разделения обязанностей между сотрудниками службы безопасности, администраторами администраторов баз данных и систем

## <a name="terminology-and-description"></a>Терминология и описание

**Ключ шифрования данных (DEK)**: симметричный ключ AES256, используемый для шифрования раздела или блокирования данных. Шифрование каждого блока данных другим ключом создает дополнительные сложности для выполнения атак в отношении зашифрованных данных. Доступ к DEK требуется поставщику ресурсов или экземпляру приложения, выполняющему шифрование или расшифровку определенного блока. При замене DEK новым ключом необходимо повторно шифровать данные в связанном с ним блоке.

**Ключ шифрования (KEK)**: Ключ шифрования, используемый для шифрования DEKs. KEK, который никогда не покидает Key Vault, позволяет шифровать и контролировать DEKs. Сущность, которая имеет доступ к KEK, может отличаться от сущности, требующей DEK. Так как KEK требуется для расшифровки ключей DEK, его можно фактически рассматривать как единую точку, с помощью которой можно удалить ключи DEK (непосредственно удалив KEK).

DEKs, зашифрованные с KEKs, хранятся отдельно. Расшифровать эти DEK может только организация, доступ к KEK. Для получения дополнительной информации, [см. Безопасность в шифровании в состоянии покоя](../security/fundamentals/encryption-atrest.md).

## <a name="how-data-encryption-with-a-customer-managed-key-works"></a>Как работает шифрование данных с ключом, управляемым клиентом

![Диаграмма, покажите обзор Bring Your Own Key](media/concepts-data-access-and-security-data-encryption/postgresql-data-encryption-overview.png)

Для того, чтобы сервер PostgreS'L использовал управляемые клиентом ключи, хранящиеся в Key Vault, для шифрования DEK, администратор Key Vault дает следующие права доступа к серверу:

* **получить**: Для извлечения общедоступной части и свойств ключа в хранилище ключей.
* **wrapKey**: Чтобы иметь возможность шифровать DEK.
* **unwrapKey**: Чтобы иметь возможность расшифровать DEK.

Администратор хранилища ключей также [может включить журнал событий аудита Key Vault,](../azure-monitor/insights/azure-key-vault.md)чтобы они могли быть проверены позже.

Когда сервер настроен на использование управляемого клиентом ключа, хранящегося в хранилище ключей, сервер отправляет DEK в хранилище ключей для шифрования. Key Vault возвращает зашифрованный DEK, который хранится в базе данных пользователей. Аналогичным образом, при необходимости сервер отправляет защищенный DEK в хранилище ключей для расшифровки. Аудиторы могут использовать Azure Monitor для проверки журналов событий аудита Key Vault, если ведется регистрация.

## <a name="requirements-for-configuring-data-encryption-for-azure-database-for-postgresql-single-server"></a>Требования к настройке шифрования данных для базы данных Azure для единого сервера PostgreS'L

Ниже приведены требования к настройке Key Vault:

* База данных Key Vault и Azure для одного сервера PostgreS'L должна принадлежать тому же арендатору Azure Active Directory (Azure AD). Кросс-арендатор Ключ Vault и взаимодействия сервера не поддерживаются. После этого перемещение ресурсов требует перенастройки шифрования данных.
* Необходимо включить функцию «мягкого удаления» в хранилище ключей, чтобы защититься от потери данных, если произойдет случайное удаление ключа (или Key Vault). Мягкие удаленные ресурсы сохраняются в течение 90 дней, если пользователь не восстанавливает или очищает их в то же время. Действия восстановления и очистки имеют свои собственные разрешения, связанные с политикой доступа Key Vault. Функция "мягкого удаления" отключена по умолчанию, но ее можно включить через PowerShell или Azure CLI (обратите внимание, что вы не можете включить ее через портал Azure).
* Предоставите базу данных Azure для доступа к единому серверу PostgreS'L с помощью разрешений get, wrapKey и unwrapKey, используя свою уникальную управляемую идентификацию. На портале Azure уникальная идентификация автоматически создается при включении шифрования данных на едином сервере PostgreS'L. Просматривайте [шифрование данных для базы данных Azure для единого сервера PostgreS'L, используя портал Azure](howto-data-encryption-portal.md) для получения подробных пошаговых инструкций при использовании портала Azure.

* При использовании брандмауэра с Key Vault необходимо включить **опцию Allow trusted Microsoft services для обхода брандмауэра.**

Ниже приведены требования к настройке ключа, управляемого клиентом:

* Управляемый клиентом ключ, который будет использоваться для шифрования DEK, может быть только асимметричным, RSA 2028.
* Дата активации ключа (если установлена) должна быть датой и временем в прошлом. Срок годности (если установлен) должен быть будущей датой и временем.
* Ключ должен находиться в состоянии *включено.*
* Если вы импортируете существующий ключ в хранилище ключей, не забудьте`.pfx`предоставить его в поддерживаемых форматах файлов (, `.byok`). `.backup`

## <a name="recommendations"></a>Рекомендации

При использовании шифрования данных с помощью ключа, управляемого клиентом, приведены рекомендации по настройке Key Vault:

* Установите блокировку ресурсов в Key Vault, чтобы контролировать, кто может удалить этот критический ресурс и предотвратить случайное или несанкционированное удаление.
* Включите аудит и отчетность по всем ключам шифрования. Key Vault предоставляет журналы, которые легко вводить в другие средства безопасности и управления событиями. Аналитика журналов Azure Monitor — один из примеров уже интегрированной службы.

* Убедитесь, что база данных Key Vault и Azure для одного сервера PostgreS'L будет базироваться в одном регионе, чтобы обеспечить более быстрый доступ к операциям DEK wrap and unwrap.

Вот рекомендации по настройке ключа, управляемого клиентом:

* Храните копию ключа, управляемого клиентом, в безопасном месте или депозитный счет на депозитный сервис.

* Если Key Vault генерирует ключ, создайте резервную часть ключа перед первым использованием ключа. Можно восстановить только резервную часть в Key Vault. Для получения дополнительной информации о команде резервного копирования, [см.](https://docs.microsoft.com/powershell/module/az.keyVault/backup-azkeyVaultkey)

## <a name="inaccessible-customer-managed-key-condition"></a>Недоступное ключевое состояние, управляемое клиентом

При настройке шифрования данных с помощью ключа, управляемого клиентом, в Key Vault необходим непрерывный доступ к этому ключу, чтобы сервер оставался в сети. Если сервер теряет доступ к ключу, управляемому клиентом в Key Vault, сервер начинает отказывать во всех соединениях в течение 10 минут. Сервер выдает соответствующее сообщение об ошибке и изменяет состояние сервера *на Недоступное.* Единственное действие, разрешенное в базе данных в этом состоянии, это ее исключение.

### <a name="accidental-key-access-revocation-from-key-vault"></a>Случайное отзыв доступа к ключу из Key Vault

Может случиться так, что кто-то с достаточными правами доступа к Key Vault случайно отключит доступ к серверу к ключу:

* Отмена разрешения хранилища ключей, оберточные и развернуть разрешения с сервера.
* Удаляю ключ.
* Удаляем хранилище ключей.
* Изменение правил брандмауэра хранилища ключей.

* Удаляем управляемый идентатор сервера в Azure AD.

## <a name="monitor-the-customer-managed-key-in-key-vault"></a>Мониторинг ключа, управляемого клиентом в Key Vault

Чтобы отслеживать состояние базы данных и предупреждать о потере прозрачного доступа к протекторашифрованию данных, назначайте следующие функции Azure:

* [Здоровье ресурсов Azure](../service-health/resource-health-overview.md): Недоступная база данных, потерявдоступную доступ к ключу клиента, показывает, как "Недоступный" после отказа в первом подключении к базе данных.
* [Журнал активности](../service-health/alerts-activity-log-service-notifications.md): Когда доступ к ключу клиента в управляемом клиентом Ключе Vault не удается, записи добавляются в журнал активности. Можно восстановить доступ как можно скорее, если вы создаете оповещения для этих событий.

* [Группы действий](../azure-monitor/platform/action-groups.md): Определите их для отправки вам уведомлений и оповещений на основе ваших предпочтений.

## <a name="restore-and-replicate-with-a-customers-managed-key-in-key-vault"></a>Восстановление и воспроизведение с помощью управляемого ключа клиента в Key Vault

После того, как база данных Azure для одного сервера PostgreS'L зашифрована с помощью управляемого ключа клиента, хранящегося в Key Vault, любая вновь созданная копия сервера также шифруется. Вы можете сделать эту новую копию либо через локальную или гео-восстановительные операции, или через прочитаны реплики. Тем не менее, копия может быть изменена, чтобы отразить управляемый ключ нового клиента для шифрования. При изменении ключа, управляемого клиентом, старые резервные копирования сервера начинают использовать последний ключ.

Чтобы избежать проблем при настройке шифрования данных, управляемых клиентом, во время создания воспроизведения или чтения реплик, важно следовать этим шагам на серверах master и восстановленным/репликационным серверам:

* Инициировать процесс создания реплики от основной базы данных Azure для одного сервера PostgreS'L.
* Храните вновь созданный сервер (восстановленный/реплика) в недоступном состоянии, так как его уникальная идентификация еще не получила разрешений на Key Vault.
* На восстановленном/репликационном сервере повторное использование ключа, управляемого клиентом, в настройках шифрования данных. Это гарантирует, что вновь созданный сервер получает разрешения на обертывание и разворачивание ключей, хранящихся в Key Vault.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [настроить шифрование данных с помощью управляемого клиентом ключа для базы данных Azure для единого сервера PostgreS'L с помощью портала Azure.](howto-data-encryption-portal.md)

