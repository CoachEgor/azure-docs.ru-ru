---
title: Читать реплики - База данных Azure для PostgreS'L - Единый сервер
description: В этой статье описывается функция чтения реплики в базе данных Azure для PostgreS-L - Один сервер.
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/23/2020
ms.openlocfilehash: 545d04bdede76a6ce25c9e4665f39c01ff6caa73
ms.sourcegitcommit: 31ef5e4d21aa889756fa72b857ca173db727f2c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81531989"
---
# <a name="read-replicas-in-azure-database-for-postgresql---single-server"></a>Читать реплики в базе данных Azure для PostgreS'L - Единый сервер

Компонент "Реплика чтения" позволяет реплицировать данные с сервера службы "База данных Azure для PostgreSQL" на сервер только для чтения. Вы можете реплицировать данные с главного сервера на несколько реплик (до пяти). Реплики асинхронно обновляются с использованием собственной технологии репликации ядра PostgreSQL.

Реплики — это новые серверы, которыми вы управляете как обычными серверами службы "База данных Azure для PostgreSQL". За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о создании реплик и управлении ими см. [здесь](howto-read-replicas-portal.md).

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения
Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения можно изолировать в реплики, направив рабочие нагрузки записи на главный сервер.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снимают с главного сервера нагрузку, связанную с записью. Этот компонент не предназначен для рабочих нагрузок с интенсивной записью.

В реплике чтения используется асинхронная репликация PostgreSQL. Этот компонент также не предназначен для сценариев синхронной репликации. Между поступлением данных на главный сервер и на реплики будет существенная задержка. Данные на реплике и на главном узле согласованы в конечном счете. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

## <a name="cross-region-replication"></a>Кросс-регион репликации
Вы можете создать реплику чтения в другой области с вашего главного сервера. Кросс-регион репликации может быть полезным для таких сценариев, как планирование аварийного восстановления или сближение данных с пользователями.

У вас может быть мастер-сервер в любой [базе данных Azure для региона PostgreS'L.](https://azure.microsoft.com/global-infrastructure/services/?products=postgresql) Мастер-сервер может иметь реплику в парной области или универсальных регионах реплики. На рисунке ниже показано, какие области реплик доступны в зависимости от основной области.

[![Читать регионы реплик](media/concepts-read-replica/read-replica-regions.png)](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>Универсальные регионы реплики
Вы всегда можете создать реплику чтения в любом из следующих регионов, независимо от того, где находится ваш основной сервер. Это универсальные регионы реплики:

Австралия Восток, Австралия юго-восток, Центральная часть США, Восточная Азия, Восточная ЧАСТЬ США, Восток США 2, Япония Восток, Япония Запад, Корея Центральной, Корея, Северная Центральная США, южная центральная часть США, юго-восточная Азия, Великобритания на юге, Запад Великобритании, Западная Европа, Западная США.

«West US 2 временно недоступен в качестве расположения реплики поперечного региона.


### <a name="paired-regions"></a>Пары регионов
В дополнение к универсальным регионам реплики можно создать считываемую реплику в парной области Azure на вашем главном сервере. Если вы не знаете пару вашего региона, вы можете узнать больше из [статьи Azure Paired Regions.](../best-practices-availability-paired-regions.md)

Если вы используете кросс-региональные реплики для планирования аварийного восстановления, мы рекомендуем создать реплику в парном регионе вместо одного из других регионов. Парные регионы избегают одновременных обновлений и приоритизируют физическую изоляцию и местожительство данных.  

Есть ограничения для рассмотрения: 

* Региональная доступность: База данных Azure для PostgreS'L доступна в West US 2, France Central, ОАЭ North и Germany Central. Однако их парные регионы недоступны.
    
* Однонаправленные пары: Некоторые области Azure спарены только в одном направлении. К таким регионам относятся Западная Индия, Бразилия на юге. 
   Это означает, что мастер-сервер в Западной Индии может создать реплику в южной Индии. Тем не менее, мастер-сервер в южной Индии не может создать реплику в Западной Индии. Это потому, что второстепенный регион Западной Индии является южная Индия, но вторичный регион южной Индии не Западная Индия.


## <a name="create-a-replica"></a>Создание реплики
При запуске рабочего процесса создания реплики создается пустой сервер службы "База данных Azure для PostgreSQL". Этот сервер заполняется данными, которые были на главном сервере. Время создания зависит от объема данных на главном сервере и времени, прошедшего с момента последнего еженедельного полного резервного копирования. Время может варьироваться от нескольких минут до нескольких часов.

Каждая реплика включена для [автоматического роста](concepts-pricing-tiers.md#storage-auto-grow)хранилища. Функция автоматического роста позволяет реплике идти в ногу с реплицированными к ней данными и предотвращать разрыв репликации, вызванный ошибками хранения.

Реплика чтения использует физическую (а не логическую) репликацию PostgreSQL. По умолчанию применяется потоковая передача данных репликации с использованием слотов репликации. При необходимости для наверстывания используется доставка журналов.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

## <a name="connect-to-a-replica"></a>Подключение к реплике
Создаваемая реплика не наследует от главного сервера правила брандмауэра или конечную точку службы виртуальной сети. Эти правила следует настроить для каждой реплики отдельно.

Реплика наследует от главного сервера учетную запись администратора. Также на реплики чтения копируются все учетные записи пользователей с главного сервера. К реплике чтения можно подключиться только с помощью учетных записей пользователей, доступных на главном сервере.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу службы "База данных Azure для PostgreSQL". Для сервера, названного **моей репликой** с именем пользователя **myadmin,** вы можете подключиться к реплике с помощью psql:

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации
База данных Azure для PostgreS'L предоставляет две метрики для мониторинга репликации. Эти две метрики **Являются Макс Лаг через реплики** и **реплики лаг**. Чтобы узнать, как просмотреть эти метрики, смотрите **раздел реплики монитора** [прочитаной реплики как к статье.](howto-read-replicas-portal.md)

Метрика **Max Lag Across Replicas** показывает отставание в байтах между мастером и самой отстающей репликой. Эта метрика доступна только на главном сервере.

Метрика **«Отставание реплики»** показывает время, прошедшее с момента последней воспроизведенной транзакции. Если на главном сервере не выполняются транзакции, метрика будет отображать соответствующее время задержки. Эта метрика доступна только для серверов реплики. Реплика Лаг `pg_stat_wal_receiver` рассчитывается из представления:

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp());
```

Настройте отправку предупреждений о достижении недопустимого для вашей рабочей нагрузки значения задержки реплики. 

Чтобы получить дополнительные сведения, напрямую запросите у главного сервера значение задержки репликации в байтах по всем репликам.

В PostgreSQL версии 10:

```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

В PostgreSQL 9.6 и более ранних версий:

```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> В случае перезапуска главного сервера или реплики чтения период, необходимый для перезапуска и наверстывания, будет отражаться в значении метрики задержки реплики.

## <a name="stop-replication"></a>Остановка репликации
Вы можете остановить репликацию между главным сервером и репликой. В этом случае реплика перезагрузится, чтобы удалить параметры репликации. После остановки репликации между главным сервером и репликой чтения реплика становится отдельным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Данные на изолированном сервере не синхронизируются с главным сервером.

> [!IMPORTANT]
> Это сервер нельзя снова преобразовать в реплику.
> Прежде, чем останавливать репликацию в реплике чтения убедитесь, что реплика содержит все необходимые данные.

При остановке репликации реплика теряет все ссылки на предыдущий мастер и другие реплики.

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).

## <a name="failover"></a>Отработка отказа
Автоматизированного сбоя между серверами master и replica не существует. 

Поскольку репликация асинхронна, между мастером и репликой существует отставание. На размер задержки может влиять ряд факторов, таких как большая рабочая нагрузка, работающая на главном сервере, и задержка между центрами обработки данных. В большинстве случаев отставание реплики колеблется от нескольких секунд до нескольких минут. Вы можете отслеживать фактический отставание репликации с помощью метрической *реплики Лаг*, который доступен для каждой реплики. Эта метрика показывает время, прошедшее с момента последней воспроизведенной транзакции. Мы рекомендуем вам определить, что ваш средний отставание, наблюдая ваши реплики отставание в течение определенного периода времени. Вы можете установить оповещение о задержке реплики, так что если он выходит за пределы ожидаемого диапазона, вы можете принять меры.

> [!Tip]
> Если вы не перейти к реплике, отставание в момент разграничения реплики из мастера будет указывать, сколько данных потеряно.

После того как вы решили, что хотите потерпеть неудачу на реплику, 

1. Остановка репликации к реплике<br/>
   Этот шаг необходим для того, чтобы сервер реплики мог принимать записи. В рамках этого процесса сервер реплики будет перезакпариваться и быть отсоединен от мастера. Как только вы инициируете репликацию стопа, процесс бэкэнда обычно занимает около 2 минут. Ознакомьтесь с разделом [stop replication](#stop-replication) этой статьи, чтобы понять последствия этого действия.
    
2. Направьте приложение на (бывшую) реплику<br/>
   Каждый сервер имеет уникальную строку соединения. Обновите приложение, чтобы указать на (бывшую) реплику вместо мастера.
    
После успешной обработки приложения читает и пишет, вы завершили failover. Количество простоев, которые можно получить в приложении, будет зависеть от того, когда вы обнаружите проблему и выполните шаги 1 и 2 выше.


## <a name="considerations"></a>Особенности

В этом разделе приведены рекомендации по использованию компонента "Реплика чтения".

### <a name="prerequisites"></a>Предварительные требования
Прежде чем создавать реплику, на главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".

### <a name="new-replicas"></a>Новые реплики
Реплики чтения создаются как новые серверы службы "База данных Azure для PostgreSQL". Существующий сервер нельзя снова преобразовать в реплику. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики
Реплика создается с помощью тех же параметров вычислений и хранения, что и мастер. После создания реплики вы можете независимо от главного сервера изменять следующие ее параметры: поколение вычислительных ресурсов, число виртуальных ядер, объем хранилища и период хранения резервных копий. Изменить также можно ценовую категорию (за исключением уровня "Базовый").

> [!IMPORTANT]
> Перед обновлением элемента настройки для воспроизведения до нового значения обновите конфигурацию реплики до равного или большего значения. Это позволит реплике справляться с нагрузкой, соответствующей новым параметрам главного сервера.

Postgres требует, чтобы параметр `max_connections` на реплике имел значение не ниже, чем на главном сервере. В противном случае реплика не запустится. В службе "База данных Azure для PostgreSQL" значение `max_connections` устанавливается в зависимости от номера SKU. Дополнительные сведения см. в статье [Ограничения в базе данных Azure для PostgreSQL](concepts-limits.md). 

Если вы попытаетесь обновить значения сервера, описанные выше, но не придерживаетесь ограничений, вы получите ошибку.

Правила брандмауэра, правила виртуальной сети и параметры параметров не наследуются от основного сервера к реплике при создании реплики или после этого.

### <a name="max_prepared_transactions"></a>max_prepared_transactions
[PostgreS'L требует,](https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS) `max_prepared_transactions` чтобы значение параметра на прочитанном реплике было больше или равнялась основной стоимости; в противном случае реплика не начнется. Если вы хотите `max_prepared_transactions` изменить на мастере, сначала измените его на репликах.

### <a name="stopped-replicas"></a>Остановленные реплики
Если вы решили остановить репликацию между главным сервером и репликой чтения, для применения таких изменений реплика будет перезапущена. Остановленная реплика становится отдельным сервером, который принимает операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-master-and-standalone-servers"></a>Удаленные главного и отдельного серверов
При удалении главного сервера все его реплики чтения становятся отдельными серверами. Чтобы применить такое изменение конфигурации, реплики будут перезапущены.

## <a name="next-steps"></a>Следующие шаги
* Дополнительные сведения см. в статье [Создание реплик чтения и управление ими с помощью портала Azure](howto-read-replicas-portal.md).
* Узнайте, как [создавать и управлять ремиссией чтения в Azure CLI и REST API.](howto-read-replicas-cli.md)
