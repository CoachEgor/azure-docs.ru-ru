---
title: 'Чтение реплики в базе данных Azure для PostgreSQL: один сервер'
description: 'В этой статье описывается функция чтения реплик в базе данных Azure для PostgreSQL: один сервер.'
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 06/14/2019
ms.openlocfilehash: c98247b0ba8b670a59dec9aa3ec87e949f1dda78
ms.sourcegitcommit: 72f1d1210980d2f75e490f879521bc73d76a17e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/14/2019
ms.locfileid: "67147928"
---
# <a name="read-replicas-in-azure-database-for-postgresql---single-server"></a>Чтение реплики в базе данных Azure для PostgreSQL: один сервер

Компонент "Реплика чтения" позволяет реплицировать данные с сервера службы "База данных Azure для PostgreSQL" на сервер только для чтения. Можно реплицировать с главного сервера до пяти реплик. Реплики асинхронно обновляются с использованием собственной технологии репликации ядра PostgreSQL.

> [!IMPORTANT]
> Можно создать чтения реплики, в том же регионе, что главный сервер, или в любом другом регионе Azure по своему усмотрению. Репликация между регионами в настоящее время находится в общедоступной предварительной версии.

Реплики — это новые серверы, которыми вы управляете как обычными серверами службы "База данных Azure для PostgreSQL". За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о создании реплик и управлении ими см. [здесь](howto-read-replicas-portal.md).

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения
Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения можно изолировать в реплики, направив рабочие нагрузки записи на главный сервер.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снимают с главного сервера нагрузку, связанную с записью. Этот компонент не предназначен для рабочих нагрузок с интенсивной записью.

В реплике чтения используется асинхронная репликация PostgreSQL. Этот компонент также не предназначен для сценариев синхронной репликации. Между поступлением данных на главный сервер и на реплики будет существенная задержка. Данные на реплике и на главном узле согласованы в конечном счете. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

Чтение реплик может повысить свой план аварийного восстановления. Сначала необходимо иметь реплику в другом регионе Azure с главного сервера. В случае сбоя региона можно остановить репликацию с использованием этой реплики и перенаправлять на него в вашей рабочей нагрузки. При остановке репликации позволяет реплике начинает принимать операции записи, а также считывает. Дополнительные сведения см. в [остановить репликацию](#stop-replication) раздел. 

## <a name="create-a-replica"></a>Создание реплики
На главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. (Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".)

При запуске рабочего процесса создания реплики создается пустой сервер службы "База данных Azure для PostgreSQL". Этот сервер заполняется данными, которые были на главном сервере. Время создания зависит от объема данных на главном сервере и времени, прошедшего с момента последнего еженедельного полного резервного копирования. Время может варьироваться от нескольких минут до нескольких часов.

Каждая реплика предусмотрена поддержка хранения [автоматическое увеличение](concepts-pricing-tiers.md#storage-auto-grow). Функция автоматического увеличения позволяет реплике всегда оставаться в курсе выполнена репликация данных и предотвратить разрыв в репликации, из-за ошибки хранилища.

Реплика чтения использует физическую (а не логическую) репликацию PostgreSQL. По умолчанию применяется потоковая передача данных репликации с использованием слотов репликации. При необходимости для наверстывания используется доставка журналов.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

## <a name="connect-to-a-replica"></a>Подключение к реплике
Создаваемая реплика не наследует от главного сервера правила брандмауэра или конечную точку службы виртуальной сети. Эти правила следует настроить для каждой реплики отдельно.

Реплика наследует от главного сервера учетную запись администратора. Также на реплики чтения копируются все учетные записи пользователей с главного сервера. К реплике чтения можно подключиться только с помощью учетных записей пользователей, доступных на главном сервере.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу службы "База данных Azure для PostgreSQL". Для сервера с именем **реплики** с именем пользователя администратора **myadmin**, можно подключиться к реплике с помощью psql:

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации
База данных Azure для PostgreSQL предоставляет две метрики для мониторинга репликации. Две метрики, **Максимальная задержка между реплик** и **Lag реплики**. Чтобы узнать, как просмотреть эти метрики, см. в разделе **отслеживать реплики** раздел [чтения реплики практическом](howto-read-replicas-portal.md).

**Максимальная задержка между реплик** Метрика показывает задержки в байтах между главным и реплики большинство отставания. Эта метрика доступна только на главном сервере.

**Lag реплики** Метрика показывает время с момента последнего воспроизведения транзакций. Если на главном сервере не выполняются транзакции, метрика будет отображать соответствующее время задержки. Эта метрика доступна реплики только для серверов. Задержка репликации вычисляется на основе `pg_stat_wal_receiver` представления:

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp());
```

Настройте отправку предупреждений о достижении недопустимого для вашей рабочей нагрузки значения задержки реплики. 

Чтобы получить дополнительные сведения, напрямую запросите у главного сервера значение задержки репликации в байтах по всем репликам.

В PostgreSQL версии 10:

```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), stat.replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

В PostgreSQL 9.6 и более ранних версий:

```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), stat.replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> В случае перезапуска главного сервера или реплики чтения период, необходимый для перезапуска и наверстывания, будет отражаться в значении метрики задержки реплики.

## <a name="stop-replication"></a>Остановка репликации
Вы можете остановить репликацию между главным сервером и репликой. В этом случае реплика перезагрузится, чтобы удалить параметры репликации. После остановки репликации между главным сервером и репликой чтения реплика становится отдельным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Данные на изолированном сервере не синхронизируются с главным сервером.

> [!IMPORTANT]
> Это сервер нельзя снова преобразовать в реплику.
> Прежде, чем останавливать репликацию в реплике чтения убедитесь, что реплика содержит все необходимые данные.

При остановке репликации реплика теряет все ссылки его предыдущий шаблон и других реплик. Нет без автоматической отработки отказа между основной и реплика. 

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).


## <a name="considerations"></a>Рекомендации

В этом разделе приведены рекомендации по использованию компонента "Реплика чтения".

### <a name="prerequisites"></a>Технические условия
Прежде чем создавать реплику, на главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".

### <a name="new-replicas"></a>Новые реплики
Реплики чтения создаются как новые серверы службы "База данных Azure для PostgreSQL". Существующий сервер нельзя снова преобразовать в реплику. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики
Реплика создается с той же конфигурацией сервера, что и у главного сервера. После создания реплики вы можете независимо от главного сервера изменять следующие ее параметры: поколение вычислительных ресурсов, число виртуальных ядер, объем хранилища и период хранения резервных копий. Изменить также можно ценовую категорию (за исключением уровня "Базовый").

> [!IMPORTANT]
> Прежде чем изменить параметры конфигурации на главном сервере, установите на каждой реплике такие же или более высокие значения. Это позволит реплике справляться с нагрузкой, соответствующей новым параметрам главного сервера.

Postgres требует, чтобы параметр `max_connections` на реплике имел значение не ниже, чем на главном сервере. В противном случае реплика не запустится. В службе "База данных Azure для PostgreSQL" значение `max_connections` устанавливается в зависимости от номера SKU. Дополнительные сведения см. в статье [Ограничения в базе данных Azure для PostgreSQL](concepts-limits.md). 

При попытке обновить значения сервера без соблюдения ограничений возникнет ошибка.

### <a name="maxpreparedtransactions"></a>max_prepared_transactions
[Требуется PostgreSQL](https://www.postgresql.org/docs/10/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS) значение `max_prepared_transactions` параметр чтения реплике, больше или равно значению master; в противном случае реплика не запускается. Если вы хотите изменить `max_prepared_transactions` на главном узле, изменить его на репликах.

### <a name="stopped-replicas"></a>Остановленные реплики
Если вы решили остановить репликацию между главным сервером и репликой чтения, для применения таких изменений реплика будет перезапущена. Остановленная реплика становится отдельным сервером, который принимает операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-master-and-standalone-servers"></a>Удаленные главного и отдельного серверов
При удалении главного сервера все его реплики чтения становятся отдельными серверами. Чтобы применить такое изменение конфигурации, реплики будут перезапущены.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения см. в статье [Создание реплик чтения и управление ими с помощью портала Azure](howto-read-replicas-portal.md).
