---
title: Чтение реплик в базе данных Azure для PostgreSQL — один сервер
description: В этой статье описывается функция чтения реплики в базе данных Azure для PostgreSQL-Single Server.
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 09/06/2019
ms.openlocfilehash: 1571fc449bd40063c531f9942fe9b51da56f783c
ms.sourcegitcommit: a4b5d31b113f520fcd43624dd57be677d10fc1c0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2019
ms.locfileid: "70764341"
---
# <a name="read-replicas-in-azure-database-for-postgresql---single-server"></a>Чтение реплик в базе данных Azure для PostgreSQL — один сервер

Компонент "Реплика чтения" позволяет реплицировать данные с сервера службы "База данных Azure для PostgreSQL" на сервер только для чтения. Вы можете реплицировать данные с главного сервера на несколько реплик (до пяти). Реплики асинхронно обновляются с использованием собственной технологии репликации ядра PostgreSQL.

Реплики — это новые серверы, которыми вы управляете как обычными серверами службы "База данных Azure для PostgreSQL". За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о создании реплик и управлении ими см. [здесь](howto-read-replicas-portal.md).

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения
Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения можно изолировать в реплики, направив рабочие нагрузки записи на главный сервер.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снимают с главного сервера нагрузку, связанную с записью. Этот компонент не предназначен для рабочих нагрузок с интенсивной записью.

В реплике чтения используется асинхронная репликация PostgreSQL. Этот компонент также не предназначен для сценариев синхронной репликации. Между поступлением данных на главный сервер и на реплики будет существенная задержка. Данные на реплике и на главном узле согласованы в конечном счете. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

## <a name="cross-region-replication"></a>Репликация между регионами
Вы можете создать реплику чтения в другом регионе на главном сервере. Репликация между регионами может быть полезной для таких сценариев, как планирование аварийного восстановления или передача данных ближе к пользователям.

Главный сервер можно использовать в любом [регионе базы данных Azure для PostgreSQL](https://azure.microsoft.com/global-infrastructure/services/?products=postgresql). Главный сервер может иметь реплику в связанном регионе или в регионах универсальной реплики. На рисунке ниже показано, какие регионы реплик доступны в зависимости от главного региона.

[![Чтение регионов реплики](media/concepts-read-replica/read-replica-regions.png)](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>Регионы универсальной реплики
Вы всегда можете создать реплику чтения в любом из следующих регионов, независимо от того, где находится главный сервер. Это регионы универсальной реплики:

Восточная Австралия, Юго-Восточная Австралия, Центральная часть США, Восточная Азия, Восточная часть США, Восточная часть США 2, Восточная Япония, Западная Япония, Центральная Корея, Юго-Запад, северо-центральная часть США, Северная Европа, Юго-Центральная часть США, Юго-Восточная Азия, южная часть Соединенного Королевства, западная часть Соединенного Королевства, Западная Европа, Западная часть США, Западная часть США 2.


### <a name="paired-regions"></a>Пары регионов
В дополнение к регионам универсальной реплики вы можете создать реплику чтения в парном регионе Azure главного сервера. Если вы не знакомы с парой регионов, дополнительные сведения см. в статье о [парных регионах Azure](../best-practices-availability-paired-regions.md).

Если для планирования аварийного восстановления используются межрегиональные реплики, рекомендуется создать реплику в парном регионе, а не в одном из других регионов. Парные регионы не допускают одновременного обновления и определения приоритетов физической изоляции и местонахождение данных.  

Существуют ограничения, которые следует учитывать: 

* Доступность по регионам База данных Azure для PostgreSQL доступна в западной части США 2, центральном Франции, севере в ОАЭ и Германии Central. Однако их парные регионы недоступны.
    
* Однонаправленные пары: Некоторые регионы Azure связаны только в одном направлении. В число этих регионов входит Западная Индия, Южная Бразилия. 
   Это означает, что главный сервер в Западной Индии может создать реплику в Южной Индии. Однако главный сервер в Южной Индии не может создать реплику в Западной Индии. Это связано с тем, что дополнительный регион "Западная Индия" — Южно-Индия, а дополнительный регион Южной Индии — не "Западная Индия".


## <a name="create-a-replica"></a>Создание реплики
На главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. (Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".)

При запуске рабочего процесса создания реплики создается пустой сервер службы "База данных Azure для PostgreSQL". Этот сервер заполняется данными, которые были на главном сервере. Время создания зависит от объема данных на главном сервере и времени, прошедшего с момента последнего еженедельного полного резервного копирования. Время может варьироваться от нескольких минут до нескольких часов.

Для каждой реплики включено [Автоматическое увеличение](concepts-pricing-tiers.md#storage-auto-grow)хранилища. Функция автоматического увеличения позволяет реплике хранить данные, реплицированные на нее, и предотвращать перерыв в репликации из-за ошибок, вызванных нехваткой хранилища.

Реплика чтения использует физическую (а не логическую) репликацию PostgreSQL. По умолчанию применяется потоковая передача данных репликации с использованием слотов репликации. При необходимости для наверстывания используется доставка журналов.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

## <a name="connect-to-a-replica"></a>Подключение к реплике
Создаваемая реплика не наследует от главного сервера правила брандмауэра или конечную точку службы виртуальной сети. Эти правила следует настроить для каждой реплики отдельно.

Реплика наследует от главного сервера учетную запись администратора. Также на реплики чтения копируются все учетные записи пользователей с главного сервера. К реплике чтения можно подключиться только с помощью учетных записей пользователей, доступных на главном сервере.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу службы "База данных Azure для PostgreSQL". Для сервера с именем **Моя реплика** и именем администратора **MyAdmin**можно подключиться к реплике с помощью psql:

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации
База данных Azure для PostgreSQL предоставляет две метрики для мониторинга репликации. Две метрики являются **максимальным запаздывание между репликами** и **задержкой реплики**. Сведения о том, как просмотреть эти метрики, см. в разделе **мониторинг реплики** [статьи инструкции по чтению реплики](howto-read-replicas-portal.md).

Метрика " **Максимальная задержка между репликами** " показывает задержку в байтах между главной и задержкой репликой. Эта метрика доступна только на главном сервере.

Метрика **запаздывания реплики** показывает время, прошедшее с момента последнего воспроизведения транзакции. Если на главном сервере не выполняются транзакции, метрика будет отображать соответствующее время задержки. Эта метрика доступна только для серверов реплик. Запаздывание реплики вычисляется из `pg_stat_wal_receiver` представления:

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp());
```

Настройте отправку предупреждений о достижении недопустимого для вашей рабочей нагрузки значения задержки реплики. 

Чтобы получить дополнительные сведения, напрямую запросите у главного сервера значение задержки репликации в байтах по всем репликам.

В PostgreSQL версии 10:

```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), stat.replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

В PostgreSQL 9.6 и более ранних версий:

```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), stat.replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> В случае перезапуска главного сервера или реплики чтения период, необходимый для перезапуска и наверстывания, будет отражаться в значении метрики задержки реплики.

## <a name="stop-replication"></a>Остановить репликацию
Вы можете остановить репликацию между главным сервером и репликой. В этом случае реплика перезагрузится, чтобы удалить параметры репликации. После остановки репликации между главным сервером и репликой чтения реплика становится отдельным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Данные на изолированном сервере не синхронизируются с главным сервером.

> [!IMPORTANT]
> Это сервер нельзя снова преобразовать в реплику.
> Прежде, чем останавливать репликацию в реплике чтения убедитесь, что реплика содержит все необходимые данные.

При отмене репликации реплика теряет все ссылки на предыдущие главные и другие реплики.

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).

## <a name="failover"></a>Отработка отказа
Автоматическая отработка отказа между главным сервером и серверами реплики отсутствует. 

Поскольку репликация является асинхронной, между главной и репликой возникает задержка. На количество запаздывания может влиять ряд факторов, таких как интенсивность рабочей нагрузки главного сервера и задержка между центрами обработки данных. В большинстве случаев задержка реплики находится в диапазоне от нескольких секунд до нескольких минут. Вы можете отвести фактическую задержку репликации с помощью *задержки реплики*метрики, доступной для каждой реплики. Эта метрика показывает время, прошедшее с момента последнего воспроизведения транзакции. Рекомендуется определить среднюю задержку, просматривая запаздывание реплики в течение определенного периода времени. Вы можете настроить оповещение о задержке реплики, чтобы, если она выходит за пределы ожидаемого диапазона, можно предпринять действия.

> [!Tip]
> Если выполняется отработка отказа в реплике, задержка во время десвязи реплики с главным будет указывать на количество потерянных данных.

После того как вы решили выполнить отработку отказа в реплику, 

1. Останавливает репликацию в реплику<br/>
   Этот шаг необходим для того, чтобы сервер реплики мог принимать операции записи. В рамках этого процесса сервер реплики будет перезапущен и десвязан с главным сервером. После инициации процесса репликации серверный процесс обычно занимает около 2 минут. Сведения о влиянии этого действия см. в разделе " [Завершение репликации](#stop-replication) " этой статьи.
    
2. Наведите приложение на реплику (бывшая)<br/>
   Каждый сервер имеет уникальную строку подключения. Обновите приложение так, чтобы оно указывало на (бывшая) реплику, а не на главную.
    
После успешной обработки операций чтения и записи приложение отработки отказа завершено. Время простоя, которое будет зависеть от работы приложения, зависит от того, обнаруживается ошибка и выполняются шаги 1 и 2, описанные выше.


## <a name="considerations"></a>Рекомендации

В этом разделе приведены рекомендации по использованию компонента "Реплика чтения".

### <a name="prerequisites"></a>Предварительные требования
Прежде чем создавать реплику, на главном сервере задайте для параметра `azure.replication_support` значение **REPLICA**. После изменения значения этого параметра сервер необходимо перезапустить, чтобы изменения вступили в силу. Параметр `azure.replication_support` применяется только к уровням "Общего назначения" и "Оптимизированный для операций в памяти".

### <a name="new-replicas"></a>Новые реплики
Реплики чтения создаются как новые серверы службы "База данных Azure для PostgreSQL". Существующий сервер нельзя снова преобразовать в реплику. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики
Реплика создается с использованием тех же параметров вычислений и хранилища, что и у главного сервера. После создания реплики вы можете независимо от главного сервера изменять следующие ее параметры: поколение вычислительных ресурсов, число виртуальных ядер, объем хранилища и период хранения резервных копий. Изменить также можно ценовую категорию (за исключением уровня "Базовый").

> [!IMPORTANT]
> Перед обновлением главного параметра до нового значения обновите конфигурацию реплики до равного или большего значения. Это позволит реплике справляться с нагрузкой, соответствующей новым параметрам главного сервера.

Postgres требует, чтобы параметр `max_connections` на реплике имел значение не ниже, чем на главном сервере. В противном случае реплика не запустится. В службе "База данных Azure для PostgreSQL" значение `max_connections` устанавливается в зависимости от номера SKU. Дополнительные сведения см. в статье [Ограничения в базе данных Azure для PostgreSQL](concepts-limits.md). 

При попытке обновить значения сервера без соблюдения ограничений возникнет ошибка.

### <a name="max_prepared_transactions"></a>max_prepared_transactions
[PostgreSQL требует](https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-PREPARED-TRANSACTIONS) , чтобы значение `max_prepared_transactions` параметра в реплике чтения было больше или равно главному значению; в противном случае реплика не будет запущена. Если вы хотите изменить `max_prepared_transactions` на главном мастере, сначала измените его на репликах.

### <a name="stopped-replicas"></a>Остановленные реплики
Если вы решили остановить репликацию между главным сервером и репликой чтения, для применения таких изменений реплика будет перезапущена. Остановленная реплика становится отдельным сервером, который принимает операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-master-and-standalone-servers"></a>Удаленные главного и отдельного серверов
При удалении главного сервера все его реплики чтения становятся отдельными серверами. Чтобы применить такое изменение конфигурации, реплики будут перезапущены.

## <a name="next-steps"></a>Следующие шаги
* Дополнительные сведения см. в статье [Создание реплик чтения и управление ими с помощью портала Azure](howto-read-replicas-portal.md).
* Узнайте, как [создавать реплики чтения и управлять ими в Azure CLI](howto-read-replicas-cli.md).
