---
title: Руководство по созданию Базы данных Azure для PostgreSQL (Гибкий сервер) и веб-приложения Службы приложений Azure в одной виртуальной сети
description: Краткое руководство по созданию Базы данных Azure для PostgreSQL (Гибкий сервер) с веб-приложением в той же виртуальной сети
author: mksuni
ms.author: sumuth
ms.service: postgresql
ms.devlang: azurecli
ms.topic: tutorial
ms.date: 09/22/2020
ms.custom: mvc, devx-track-azurecli
ms.openlocfilehash: 20401a3c96a9a20399c07d1a30370d27f2858e29
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "90929724"
---
# <a name="tutorial-create-an-azure-database-for-postgresql---flexible-server-with-app-services-web-app-in-virtual-network"></a>Руководство по созданию Базы данных Azure для PostgreSQL (Гибкий сервер) с веб-приложением Службы приложений в той же виртуальной сети

> [!IMPORTANT]
> Гибкий сервер Базы данных Azure для PostgreSQL предоставляется в режиме предварительной версии

В этом руководстве показано, как создать веб-приложение Службы приложений Azure с использованием предварительной версии Базы данных Azure для PostgreSQL (Гибкий сервер) в [виртуальной сети](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview).

В рамках этого руководства вы выполните следующие задачи:
>[!div class="checklist"]
> * создание гибкого сервера PostgreSQL в виртуальной сети;
> * Создание веб-приложения
> * добавление веб-приложения в виртуальную сеть;
> * подключение к Postgres из веб-приложения. 

## <a name="prerequisites"></a>Предварительные требования

Если у вас еще нет подписки Azure, создайте [бесплатную](https://azure.microsoft.com/free/) учетную запись Azure, прежде чем начинать работу.

Для этой статьи требуется запустить локально Azure CLI версии 2.0 или более поздней. Чтобы узнать, какая установлена версия, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli).

Вам потребуется выполнить вход в учетную запись с помощью команды [az login](/cli/azure/authenticate-azure-cli?view=interactive-log-in). Запишите свойство **id** из выходных данных команды для соответствующего имени подписки.

```azurecli
az login
```

Если вы используете несколько подписок, выберите соответствующую, в которой за ресурс будет взиматься плата. Выберите конкретный идентификатор подписки вашей учетной записи, выполнив команду [az account set](/cli/azure/account). Подставьте свойство **subscription ID** из выходных данных **az login** для своей подписки в заполнитель для идентификатора подписки.

```azurecli
az account set --subscription <subscription id>
```

## <a name="create-a-postgresql-flexible-server-in-a-new-virtual-network"></a>Создание гибкого сервера PostgreSQL в новой виртуальной сети

Создайте гибкий сервер с частным доступом в виртуальной сети с помощью следующей команды:
```azurecli
az postgres flexible-server create --resource-group myresourcegroup --location westus2
```
С помощью этой команды выполняются следующие действия (может занять несколько минут):

- Создайте группу ресурсов, если она еще не существует.
- Будет создано имя сервера, если оно не предоставлено.
- Создайте новую виртуальную сеть для нового сервера PostgreSQL. Запишите имя виртуальной сети и имя подсети, которые созданы для этого сервера, так как веб-приложение нужно будет добавить в ту же виртуальную сеть.
- Будет создано имя пользователя и пароль администратора для этого сервера, если они не предоставлены.
- Будет создана пустая база данных с именем **postgres**.

> [!NOTE]
> - Если вы не указали пароль, запишите тот, который будет создан для вас автоматически. Если вы забудете пароль, вам придется сбросить его с помощью команды ``` az postgres flexible-server update```.
> - Если вы не используете Среду службы приложений, нужно будет разрешить доступ со всех IP-адресов Azure с помощью этой команды. 
>  ```azurecli
>  az postgres flexible-server firewall-rule list --resource-group myresourcegroup --server-name mydemoserver --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0
>  ```


## <a name="create-a-web-app"></a>Создание веб-приложения
В этом разделе вы создадите узел приложения в приложении Службы приложений, подключите это приложение к базе данных Postgres, а затем развернете код на этом узле. Убедитесь, что в окне терминала вы находитесь в корне репозитория с кодом вашего приложения.

Создайте приложение Службы приложений (хост-процесс) с помощью команды az webapp up.

```azurecli
az webapp up --resource-group myresourcegroup --location westus2 --plan testappserviceplan --sku B1 --name mywebapp
```

> [!NOTE]
> - Для аргумента --location укажите то же расположение, что и для базы данных в предыдущем разделе.
> - Замените <app-name> уникальным в пределах платформы Azure именем (конечная точка сервера имеет адрес https://\<app-name>.azurewebsites.net). В значении <app-name> допускаются символы A-Z, 0–9 и "-". Рекомендуется использовать сочетание названия компании и идентификатора приложения.

С помощью этой команды выполняются следующие действия (может занять несколько минут):

- Создайте группу ресурсов, если она еще не существует. (В этой команде используется та же группа ресурсов, в которой ранее была создана база данных.)
- Будет создан план службы приложений ```testappserviceplan``` с ценовой категорией "Базовый" (B1), если он еще не существует. Аргументы --plan и --sku необязательны.
- Создается приложение Службы приложений, если оно еще не существует.
- Для приложения включается ведение журнала по умолчанию, если оно еще не включено.
- Передается репозиторий через развертывание на основе ZIP-файла с включенной автоматизацией сборки.

## <a name="add-the-web-app-to-the-virtual-network"></a>Добавление веб-приложения в виртуальную сеть
Используйте команду **az webapp vnet-integration**, чтобы добавить в веб-приложение региональную интеграцию с виртуальной сетью. Замените <vnet-name> и <subnet-name> именем виртуальной сети и подсети, которые использует гибкий сервер.

```azurecli
az webapp vnet-integration add -g myresourcegroup -n  mywebapp --vnet <vnet-name> --subnet <subnet-name>
```

## <a name="configure-environment-variables-to-connect-the-database"></a>Настройка переменных среды для подключения к базе данных
Теперь, когда код развернут в Службе приложений, следует подключить приложение к гибкому серверу в Azure. Код приложения должен находить сведения о базе данных в переменных среды. Чтобы задать в Службе приложений переменные среды, создайте параметры приложения с помощью команды ```az webapp config appsettings``` set.

```azurecli
az webapp config appsettings set --settings DBHOST="<postgres-server-name>.postgres.database.azure.com" DBNAME="postgres" DBUSER="<username>" DBPASS="<password>"
```


- Замените в команде ```postgres-server-name```,```username``` ```password``` параметрами только что созданного гибкого сервера.
- Замените <username> и <password> учетными данными, которые также создаются командой.
- Имена группы ресурсов и приложения извлекаются из кэшированных значений в файле .azure/config.
- Эта команда создает параметры с именами ```DBHOST```,```DBNAME```,```DBUSER``` и ```DBPASS```. Если в коде приложения для сведений о базе данных используется другое имя, укажите здесь имена параметров приложения, которые используются в коде.

## <a name="clean-up-resources"></a>Очистка ресурсов

Очистите все ресурсы, созданные при работе с этим руководством, с помощью приведенной ниже команды. Эта команда позволяет удалить все ресурсы в группе ресурсов.

```azurecli
az group delete -n myresourcegroup
```


## <a name="next-steps"></a>Следующие шаги
> [!div class="nextstepaction"]
> [Сопоставление существующего настраиваемого DNS-имени со Службой приложений Azure](https://docs.microsoft.com/azure/app-service/app-service-web-tutorial-custom-domain)