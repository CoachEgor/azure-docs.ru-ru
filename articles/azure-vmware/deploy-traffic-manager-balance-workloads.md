---
title: Развертывание диспетчера трафика для балансировки рабочих нагрузок решения Azure VMware (AVS)
description: Узнайте, как интегрировать диспетчер трафика с решением VMware для Azure (AVS), чтобы сбалансировать рабочие нагрузки приложений между несколькими конечными точками в разных регионах.
ms.topic: how-to
ms.date: 08/14/2020
ms.openlocfilehash: ed74bb0dfc533abadd50af32afc06c9cb4106193
ms.sourcegitcommit: 642988f1ac17cfd7a72ad38ce38ed7a5c2926b6c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94874312"
---
# <a name="deploy-traffic-manager-to-balance-azure-vmware-solution-avs-workloads"></a>Развертывание диспетчера трафика для балансировки рабочих нагрузок решения Azure VMware (AVS)

В этой статье описывается интеграция диспетчера трафика с решением VMware для Azure (AVS) для балансировки рабочих нагрузок приложений в нескольких конечных точках. Мы рассмотрим ситуацию, в которой диспетчер трафика направляет трафик между тремя шлюзами приложений, охватывающими несколько регионов AVS: Западная часть США, Западная Европа и локальная сеть в восточной части США. 

Диспетчер трафика Azure — это балансировщик нагрузки трафика на основе DNS, который позволяет оптимально распределять трафик между службами в глобальных регионах Azure. Он будет распределять трафик приложений между рабочими нагрузками Azure и внешними общедоступными конечными точками. Дополнительные сведения о диспетчере трафика см. в статье [что такое диспетчер трафика?](../traffic-manager/traffic-manager-overview.md)

Сначала ознакомьтесь с [предварительными требованиями](#prerequisites) . Затем мы рассмотрим следующие процедуры:

> [!div class="checklist"]
> * Проверка конфигурации шлюзов приложений
> * Проверка конфигурации сегмента НСКС-T
> * Создание профиля диспетчера трафика
> * Добавление внешних конечных точек в профиль диспетчера трафика

## <a name="topology"></a>Топология

Как показано на следующем рисунке, диспетчер трафика Azure обеспечивает балансировку нагрузки для приложений на уровне DNS между региональными конечными точками. Шлюзы приложений имеют элементы серверного пула, настроенные как серверы IIS и упоминаемые как внешние конечные точки AVS.

Подключение по виртуальной сети между двумя регионами частного облака AVS, Западная часть США и Западной Европа и локальным сервером в восточной части США использует шлюз ExpressRoute.   

:::image type="content" source="media/traffic-manager/traffic-manager-topology.png" alt-text="Схема архитектуры интеграции диспетчера трафика с решением VMware для Azure" lightbox="media/traffic-manager/traffic-manager-topology.png" border="false":::
 
## <a name="prerequisites"></a>Предварительные требования

- Три виртуальные машины, настроенные как серверы Microsoft IIS, работающие в разных регионах AVS: Западная часть США, Западная Европа и локальная. 

- Шлюз приложений с внешними конечными точками в западной части США, Западной Европе и локальной среде.

- Размещение с подключением к Интернету для проверки. 

## <a name="verify-configuration-of-your-application-gateways"></a>Проверка конфигурации шлюзов приложений

[Шлюз приложений Azure](https://azure.microsoft.com/services/application-gateway/) — это балансировщик нагрузки веб-трафика уровня 7, который позволяет управлять трафиком к веб-приложениям. Дополнительные сведения о шлюзе приложений см. в статье [что такое шлюз приложений Azure?](../application-gateway/overview.md) 

В этом сценарии три экземпляра шлюза приложений настраиваются как внешние конечные точки AVS. В шлюзах приложений виртуальные машины AVS настроены как участники серверного пула для балансировки нагрузки входящих запросов уровня 7. (Сведения о настройке шлюза приложений с виртуальными машинами AVS в качестве серверных пулов см. в статье [использование шлюза приложений Azure для защиты веб-приложений в решении VMware для Azure](protect-azure-vmware-solution-with-application-gateway.md).)  

Выполните следующие действия, чтобы проверить правильную конфигурацию шлюзов приложений.

1. Откройте портал Azure и выберите **шлюзы приложений** , чтобы просмотреть список текущих шлюзов приложений. 

    В этом сценарии мы настроили три шлюза приложений:
    - AVS-GW-WUS
    - AVS-GW-ЕУС (локальный)
    - AVS-GW-ВЕУ

    :::image type="content" source="media/traffic-manager/app-gateways-list-1.png" alt-text="Снимок экрана со списком настроенных шлюзов приложений на странице шлюза приложений." lightbox="media/traffic-manager/app-gateways-list-1.png":::

2. Выберите один из ранее развернутых шлюзов приложений. Откроется окно, в котором отображаются различные сведения о шлюзе приложений. Выберите **серверные пулы** , чтобы проверить конфигурацию одного из серверных пулов.

   :::image type="content" source="media/traffic-manager/backend-pool-config.png" alt-text="Снимок экрана со страницей шлюза приложений с подробными сведениями о выбранном шлюзе приложений." lightbox="media/traffic-manager/backend-pool-config.png":::
 
3. В этом случае в качестве веб-сервера будет указан один член внутреннего пула виртуальных машин с IP-адресом 172.29.1.10.
 
    :::image type="content" source="media/traffic-manager/backend-pool-ip-address.png" alt-text="Снимок экрана: страница &quot;изменение внутреннего пула&quot; с выделенным целевым IP-адресом.":::

    Аналогичным образом можно проверить конфигурацию других шлюзов приложений и членов серверного пула. 

## <a name="verify-configuration-of-the-nsx-t-segment"></a>Проверка конфигурации сегмента НСКС-T

Сегменты сети, созданные в НСКС-T Manager, используются в качестве сетей для виртуальных машин в vCenter. Дополнительные сведения см. в руководстве по [созданию сегмента сети НСКС-T в решении VMware для Azure (AVS)](tutorial-nsx-t-network-segment.md).

В нашем сценарии сегмент НСКС-T настраивается в среде AVS, в которой подключена виртуальная машина, входящая в серверный пул.

1. Выберите **сегменты** , чтобы просмотреть настроенные сегменты. В этом случае мы видим, что Contoso-segment1 подключен к шлюзу Contoso-T01, гибкому маршрутизатору уровня 1.

    :::image type="content" source="media/traffic-manager/nsx-t-segment-avs.png" alt-text="Снимок экрана, показывающий профили сегментов в НСКС-T Manager." lightbox="media/traffic-manager/nsx-t-segment-avs.png":::    

2. Выберите **шлюзы уровня 1** , чтобы просмотреть список шлюзов уровня 1 с числом связанных сегментов. Выберите сегмент, связанный с Contoso-T01. Откроется окно, в котором отображается логический интерфейс, настроенный на маршрутизаторе уровня 01. Это служит шлюзом для виртуальной машины, подключенной к сегменту серверного пула.

   :::image type="content" source="media/traffic-manager/nsx-t-segment-linked-2.png" alt-text="Снимок экрана, показывающий адрес шлюза выбранного сегмента.":::    

3. В клиенте vSphere ВИРТУАЛЬНОЙ машины выберите виртуальную машину, чтобы просмотреть сведения о ней. Обратите внимание, что его IP-адрес соответствует тому, что мы видели на шаге 3 предыдущего раздела: 172.29.1.10.

    :::image type="content" source="media/traffic-manager/nsx-t-vm-details.png" alt-text="Снимок экрана, показывающий сведения о виртуальной машине в клиенте VSphere." lightbox="media/traffic-manager/nsx-t-vm-details.png":::    

4. Выберите виртуальную машину, а затем щелкните **действия > изменить параметры** , чтобы проверить подключение к сегменту НСКС-T.

## <a name="create-your-traffic-manager-profile"></a>Создание профиля диспетчера трафика

1. Войдите на [портал Azure](https://rc.portal.azure.com/#home). В разделе **службы Azure > сетевые подключения** выберите **профили диспетчера трафика**.

2. Выберите **+ Добавить** , чтобы создать новый профиль диспетчера трафика.
 
3. Укажите имя профиля, метод маршрутизации (в этом сценарии мы будем использовать взвешенный, см. [методы маршрутизации диспетчера трафика](../traffic-manager/traffic-manager-routing-methods.md)), подписки и группы ресурсов и щелкните **создать**.

## <a name="add-external-endpoints-into-the-traffic-manager-profile"></a>Добавление внешних конечных точек в профиль диспетчера трафика

1. Выберите профиль диспетчера трафика в области результатов поиска, щелкните **конечные точки** , а затем **+ Добавить**.

2. Введите необходимые сведения: тип, имя, полное доменное имя (FQDN), IP-адрес и вес (в этом сценарии для каждой конечной точки назначается вес 1). Выберите **Добавить**. Будет создана внешняя конечная точка. Состояние монитора должно быть в **сети**. Повторите те же действия, чтобы создать еще две внешние конечные точки, одну в другом регионе и другую локальную. После создания все три будут отображаться в профиле диспетчера трафика, а все три должны быть в **сети**.

3. Щелкните **Обзор**. Скопируйте URL-адрес в поле **DNS-имя**.

   :::image type="content" source="media/traffic-manager/traffic-manager-endpoints.png" alt-text="Снимок экрана, показывающий общие сведения о конечной точке диспетчера трафика с выделенным DNS-именем." lightbox="media/traffic-manager/traffic-manager-endpoints.png"::: 

4. Вставьте URL-адрес имени DNS в браузере. На следующем снимке экрана показан трафик, направленный на регион Западной Европы.

   :::image type="content" source="media/traffic-manager/traffic-to-west-europe.png" alt-text="Снимок экрана: окно браузера, показывающее трафик, направленный в Западная Европа."::: 

5. Обновите свой браузер. На следующем снимке экрана показан трафик, направленный на другой набор элементов внутреннего пула в регионе "Западная часть США".

   :::image type="content" source="media/traffic-manager/traffic-to-west-us.png" alt-text="Снимок экрана окна браузера, показывающего трафик, направленный в Западная часть США."::: 

6. Снова обновите браузер. На следующем снимке экрана показан трафик, направленный на окончательный набор членов серверного пула в локальной среде.

   :::image type="content" source="media/traffic-manager/traffic-to-on-premises.png" alt-text="Снимок экрана: окно браузера, показывающее трафик, направляемый в локальную среду.":::

## <a name="next-steps"></a>Дальнейшие действия

См. также:

- [Использование шлюза приложений Azure в решении VMware для Azure (AVS)](protect-azure-vmware-solution-with-application-gateway.md)
- [Методы маршрутизации диспетчера трафика](../traffic-manager/traffic-manager-routing-methods.md)
- [Объединение служб балансировки нагрузки в Azure](../traffic-manager/traffic-manager-load-balancing-azure.md)
- [Измерение производительности диспетчера трафика](../traffic-manager/traffic-manager-performance-considerations.md)
