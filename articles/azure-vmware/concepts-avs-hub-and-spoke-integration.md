---
title: Концепция. Интеграция развертывания решения Azure VMware в центральную и периферийную архитектуру
description: Ознакомьтесь с рекомендациями по интеграции развертывания решения Azure VMware в существующую или новую архитектуру, а также в новой и периферийной архитектурах в Azure.
ms.topic: conceptual
ms.date: 09/09/2020
ms.openlocfilehash: a2007e159d23a02ca573fd833590651061c59973
ms.sourcegitcommit: 32c521a2ef396d121e71ba682e098092ac673b30
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2020
ms.locfileid: "91271738"
---
# <a name="integrate-azure-vmware-solution-in-a-hub-and-spoke-architecture"></a>Интеграция решения Azure VMware в центральную и периферийную архитектуру

В этой статье мы предоставляем рекомендации по интеграции развертывания решения Azure VMware в существующую или новую [центральную и лучевую архитектуру](/azure/architecture/reference-architectures/hybrid-networking/shared-services) в Azure. 

В сценарии "звезда" и "звезда" предполагается Гибридная облачная среда с рабочими нагрузками:

* Собственные Azure с использованием служб IaaS или PaaS
* Решение Azure VMware 
* vSphere в локальной среде

## <a name="architecture"></a>Architecture

*Центр* — это виртуальная сеть Azure, которая выступает в качестве центральной точки подключения к локальному и частному облаку решения Azure VMware. *Периферийные серверы* — это виртуальные сети, подключенные к концентратору для обеспечения взаимодействия между виртуальными сетями.

Трафик между локальным центром обработки данных, частным облаком решения Azure VMware и концентратором проходит через подключения Azure ExpressRoute. Резервные виртуальные сети обычно содержат рабочие нагрузки на основе IaaS, но могут иметь службы PaaS, такие как [Среда службы приложений](../app-service/environment/intro.md), которые имеют прямую интеграцию с виртуальной сетью или другие службы PaaS с включенной [частной связью Azure](../private-link/index.yml) .

На схеме показан пример развертывания на основе концентратора и периферийного сервера в Azure, подключенного к локальной среде и решению VMware для Azure с помощью ExpressRoute Global Reach.

:::image type="content" source="./media/hub-spoke/avs-hub-and-spoke-deployment.png" alt-text="Развертывание в центре решений Azure VMware и в периферийном развертывании" border="false":::

Архитектура имеет следующие основные компоненты:

-   **Локальный сайт:** Локальные центры данных клиента, подключенные к Azure через подключение ExpressRoute.

-   **Частное облако решения VMware для Azure:** Решение Azure VMware в SDDC, сформированное одним или несколькими кластерами vSphere, каждый из которых имеет максимум 16 узлов.

-   **Шлюз ExpressRoute:** Обеспечивает взаимодействие между частным облаком решения Azure VMware, общими службами в Центральной виртуальной сети и рабочими нагрузками, работающими в периферийных виртуальных сетях.

-   **Global REACH ExpressRoute:** Обеспечивает подключение между локальной средой и частным облаком решения VMware для Azure.


  > [!NOTE]
  > **Рекомендации по VPN-подключениям S2S:** Для рабочих развертываний Azure VMware в рабочей среде VPN-подключение Azure S2S не поддерживается из-за требований к сети для VMware ХККС. Однако его можно использовать для развертывания подтверждения концепции.


-   **Виртуальная сеть концентратора:** Действует как Центральная точка подключения к локальной сети и частное облако решения VMware для Azure.

-   **Периферийная виртуальная сеть**

    -   **Резервная звезда IaaS:** В узле IaaS хранятся рабочие нагрузки на основе Azure IaaS, в том числе группы доступности виртуальных машин и масштабируемые наборы виртуальной машины, а также соответствующие сетевые компоненты.

    -   **PaaS, сектор:** Платформа PaaS размещает службы PaaS Azure с использованием частной адресации благодаря [закрытой конечной точке](../private-link/private-endpoint-overview.md) и [частной ссылке](../private-link/private-link-overview.md).

-   **Брандмауэр Azure:** Выступает в качестве центральной части для сегментирования трафика между периферийными серверами и решениями Azure VMware.

-   **Шлюз приложений:** Предоставляет и защищает веб-приложения, которые выполняются в Azure IaaS, PaaS или виртуальных машинах Azure VMware (ВМ). Она интегрируется с другими службами, такими как управление API.

## <a name="network-and-security-considerations"></a>Вопросы, касающиеся сети и безопасности

Подключения ExpressRoute позволяют передавать трафик между локальной средой, решением VMware Azure и структурой сети Azure. Для реализации этого подключения в решении Azure VMware используется [Global REACH ExpressRoute](../expressroute/expressroute-global-reach.md) .

Так как шлюз ExpressRoute не обеспечивает транзитную маршрутизацию между подключенными цепями, локальное подключение также должно использовать ExpressRoute Global Reach для обмена данными между локальной средой vSphere и решением VMware Azure. 

* **Поток трафика решения "из локальной среды в Azure VMware"**

  :::image type="content" source="media/hub-spoke/on-prem-to-avs-traffic-flow.png" alt-text="Поток трафика решения "из локальной среды в Azure VMware"" border="false":::


* **Поток трафика виртуальной сети Azure VMware к концентратору**

  :::image type="content" source="media/hub-spoke/avs-to-hub-vnet-traffic-flow.png" alt-text="Поток трафика виртуальной сети Azure VMware к концентратору" border="false":::


Дополнительные сведения о сети и концепциях подключения для Azure VMware см. в [документации по продукту VMware для Azure](./concepts-networking.md).

### <a name="traffic-segmentation"></a>Сегментация трафика

[Брандмауэр Azure](../firewall/index.yml) — это центральная часть топологии концентратора и звезды, развернутая в виртуальной сети концентратора. Используйте брандмауэр Azure или другой поддерживаемый сетевой виртуальный модуль Azure, чтобы установить правила трафика и сегментировать обмен данными между разными периферийными и рабочими нагрузками решения Azure VMware.

Создайте таблицы маршрутов для направления трафика в брандмауэр Azure.  Для периферийных виртуальных сетей создайте маршрут, задающий маршрут по умолчанию внутреннему интерфейсу брандмауэра Azure. Таким образом, если рабочей нагрузке в виртуальной сети необходимо достичь адресного пространства решения Azure VMware, брандмауэр может оценить его и применить соответствующее правило трафика, чтобы разрешить или отклонить его.  

:::image type="content" source="media/hub-spoke/create-route-table-to-direct-traffic.png" alt-text="Создание таблиц маршрутов для направления трафика в брандмауэр Azure":::


> [!IMPORTANT]
> Маршрут с префиксом адреса 0.0.0.0/0 для параметра **GatewaySubnet** не поддерживается.

Задайте маршруты для конкретных сетей в соответствующей таблице маршрутов. Например, маршруты позволяют получить префиксы IP-адресов для управления решениями и рабочих нагрузок Azure VMware на периферийных рабочих нагрузках и наоборот.

:::image type="content" source="media/hub-spoke/specify-gateway-subnet-for-route-table.png" alt-text="Установка маршрутов для конкретных сетей в соответствующей таблице маршрутов":::

Второй уровень сегментации трафика с помощью групп безопасности сети в периферийных зонах и концентратора для создания более детализированной политики трафика.

> [!NOTE]
> **Трафик из локальной среды в решение VMware для Azure:** Трафик между локальными рабочими нагрузками, vSphere или другими, включается Global Reach, но трафик не проходит через брандмауэр Azure на концентраторе. В этом сценарии необходимо реализовать механизмы сегментирования трафика как локально, так и в решении VMware для Azure.

### <a name="application-gateway"></a>Шлюз приложений

Шлюзы приложений Azure версии v1 и v2 были протестированы с веб-приложениями, которые работают на виртуальных машинах Azure VMware в качестве серверного пула. Шлюз приложений в настоящее время является единственным поддерживаемым методом предоставления веб-приложений, выполняющихся на виртуальных машинах Azure VMware в Интернете. Он также может безопасно предоставлять приложения внутренним пользователям.

Дополнительные сведения и требования см. в статье о решении Azure VMware в [шлюзе приложений](./protect-avs-web-apps-with-app-gateway.md) .

:::image type="content" source="media/hub-spoke/avs-second-level-traffic-segmentation.png" alt-text="Второй уровень сегментации трафика с помощью групп безопасности сети" border="false":::


### <a name="jumpbox-and-azure-bastion"></a>Jumpbox и Azure бастиона

Доступ к среде решения Azure VMware с помощью Jumpbox, которая является виртуальной машиной Windows 10 или Windows Server, развернутой в подсети общей службы в виртуальной сети концентратора.

В целях безопасности рекомендуется развертывать [Microsoft Azure службу бастиона](../bastion/index.yml) в виртуальной сети Hub. Azure бастиона обеспечивает простой доступ по протоколу RDP и SSH к виртуальным машинам, развернутым в Azure, без необходимости подготавливать общедоступные IP-адреса к этим ресурсам. После подготовки службы бастиона Azure вы сможете получить доступ к выбранной виртуальной машине из портал Azure. После установления подключения откроется новая вкладка, на которой отображается рабочий стол Jumpbox, на котором можно получить доступ к плоскости управления частного облака решения VMware для Azure.

> [!IMPORTANT]
> Не предоставляйте общедоступный IP-адрес виртуальной машине Jumpbox или предоставляйте к общедоступному Интернету порт 3389/TCP. 


:::image type="content" source="media/hub-spoke/azure-bastion-hub-vnet.png" alt-text="Виртуальная сеть центра бастиона Azure" border="false":::


## <a name="azure-dns-resolution-considerations"></a>Рекомендации по разрешению Azure DNS

Для Azure DNSного разрешения можно использовать два варианта:

-   Используйте контроллеры домена Azure Active Directory (Azure AD), развернутые в центре (см. [рекомендации по идентификации](#identity-considerations)) в качестве серверов имен.

-   Развертывание и настройка частной зоны Azure DNS.

Наилучший подход состоит в том, чтобы обеспечить надежное разрешение имен для решения Azure VMware, локальной среды и Azure.

В качестве общей рекомендации по проектированию используйте существующую инфраструктуру Azure DNS (в нашем примере это Active Directory интегрированной службы DNS), развернутую по крайней мере на двух виртуальных машинах Azure, развернутых в виртуальной сети концентратора и настроенных в периферийных виртуальных сетях, чтобы использовать эти Azure DNS серверы в параметрах DNS.

Частная зона DNS Azure по-прежнему можно использовать там, где зона Частная зона DNS Azure связана с виртуальными сетями, а DNS-серверы используются в качестве гибридных арбитров конфликтов с условным перенаправлением в локальную среду или решение Azure VMware с использованием DNS, использующего клиентскую инфраструктуру Azure Частная зона DNS.

Существует несколько соображений, которые следует учитывать при Azure DNS частных зонах.

* Автоматическая регистрация должна быть включена для Azure DNS для автоматического управления жизненным циклом записей DNS для виртуальных машин, развернутых в периферийных виртуальных сетях.
* Максимальное число частных зон DNS, к которым может быть привязана виртуальная сеть с включенной авторегистрацией, — это только одна.
* Максимальное число частных зон DNS, к которым может быть привязана виртуальная сеть, — 1000 без включения авторегистрации.

Локальные и серверы решений VMware Azure можно настроить с помощью условных серверов пересылки для виртуальных машин сопоставителя в Azure для зоны Частная зона DNS Azure.

## <a name="identity-considerations"></a>Вопросы относительно удостоверений

В целях идентификации лучшим подходом является развертывание по крайней мере одного контроллера домена AD в концентраторе с использованием подсети общей службы. В идеале это два из них — распределенные по зонам или группы доступности виртуальных машин. Дополнительные сведения о расширении локального домена AD в Azure см. в статье [центр архитектуры Azure](/azure/architecture/reference-architectures/identity/adds-extend-domain) .

Кроме того, разверните другой контроллер домена на стороне решения VMware Azure, чтобы он работал в качестве удостоверения и источника DNS в среде vSphere.

Рекомендуется интегрировать [домен AD с Azure Active Directory](/azure/architecture/reference-architectures/identity/azure-ad)в качестве рекомендуемых рекомендаций.

<!-- LINKS - external -->
[Azure Architecture Center]: /azure/architecture/

[Hub & Spoke topology]: /azure/architecture/reference-architectures/hybrid-networking/hub-spoke

[Azure networking documentation]: ../networking/index.yml

<!-- LINKS - internal -->
