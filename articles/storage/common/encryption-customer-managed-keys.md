---
title: Использование управляемых клиентом ключей с Azure Key Vault для управления шифрованием учетной записи
titleSuffix: Azure Storage
description: Для защиты данных в учетной записи хранения можно использовать собственный ключ шифрования. При указании ключа, управляемого клиентом, этот ключ используется для защиты и контроля доступа к ключу, который шифрует ваши данные. Управляемые клиентом ключи обеспечивают большую гибкость при управлении элементами управления доступом.
services: storage
author: tamram
ms.service: storage
ms.date: 03/12/2020
ms.topic: conceptual
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: b2755d5aa5dbaa669fa2fdd8b84596e040b5dd6b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81456827"
---
# <a name="use-customer-managed-keys-with-azure-key-vault-to-manage-azure-storage-encryption"></a>Использование управляемых клиентом ключей с Azure Key Vault для управления шифрованием службы хранилища Azure

Для защиты данных в учетной записи хранения можно использовать собственный ключ шифрования. При указании ключа, управляемого клиентом, этот ключ используется для защиты и контроля доступа к ключу, который шифрует ваши данные. Управляемые клиентом ключи обеспечивают большую гибкость при управлении элементами управления доступом.

Для хранения ключей, управляемых клиентом, необходимо использовать Azure Key Vault. Можно либо создать собственные ключи и сохранить их в хранилище ключей, либо использовать Azure Key Vault API для создания ключей. Учетная запись хранения и хранилище ключей должны находиться в одном и том же регионе и в одном клиенте Azure Active Directory (Azure AD), но они могут находиться в разных подписках. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](../../key-vault/general/overview.md).

## <a name="about-customer-managed-keys"></a>Сведения о ключах, управляемых клиентом

На следующей схеме показано, как служба хранилища Azure использует Azure Active Directory и Azure Key Vault для выполнения запросов с помощью управляемого клиентом ключа:

![Схема работы ключей, управляемых клиентом, в службе хранилища Azure](media/encryption-customer-managed-keys/encryption-customer-managed-keys-diagram.png)

В следующем списке описаны пронумерованные шаги на схеме.

1. Администратор Azure Key Vault предоставляет разрешения на ключи шифрования для управляемого удостоверения, связанного с учетной записью хранения.
2. Администратор службы хранилища Azure настраивает шифрование с помощью управляемого клиентом ключа для учетной записи хранения.
3. Служба хранилища Azure использует управляемое удостоверение, связанное с учетной записью хранения, для проверки подлинности доступа к Azure Key Vault через Azure Active Directory.
4. Служба хранилища Azure заключает ключ шифрования учетной записи в ключ клиента в Azure Key Vault.
5. Для операций чтения и записи служба хранилища Azure отправляет запросы в Azure Key Vault для распаковки ключа шифрования учетной записи для выполнения операций шифрования и расшифровки.

## <a name="create-an-account-that-supports-customer-managed-keys-for-queues-and-tables"></a>Создание учетной записи, поддерживающей управляемые клиентом ключи для очередей и таблиц

Данные, хранящиеся в очереди и службах таблиц, не защищаются автоматически с помощью ключа, управляемого клиентом, если для учетной записи хранения включены ключи, управляемые клиентом. При необходимости эти службы можно настроить во время создания учетной записи хранения для включения в эту защиту.

Дополнительные сведения о создании учетной записи хранения, поддерживающей управляемые клиентом ключи для очередей и таблиц, см. в разделе [Создание учетной записи, поддерживающей управляемые клиентом ключи для таблиц и очередей](account-encryption-key-create.md).

Данные в больших двоичных объектах и файловых службах всегда защищаются ключами, управляемыми клиентом, если для учетной записи хранения настроены ключи, управляемые клиентом.

## <a name="enable-customer-managed-keys-for-a-storage-account"></a>Включение управляемых клиентом ключей для учетной записи хранения

Ключи, управляемые клиентом, могут быть включены только в существующих учетных записях хранения. Хранилище ключей должно быть подготовлено с политиками доступа, которые предоставляют ключевые разрешения для управляемого удостоверения, связанного с учетной записью хранения. Управляемое удостоверение доступно только после создания учетной записи хранения.

При настройке ключа, управляемого клиентом, служба хранилища Azure заключает корневой ключ шифрования данных для учетной записи с управляемым клиентом ключом в связанное хранилище ключей. Включение управляемых клиентом ключей не влияет на производительность и вступает в силу немедленно.

При изменении ключа, используемого для шифрования службы хранилища Azure, путем включения или отключения управляемых клиентом ключей, обновления ключа или указания другого ключа, шифрование корневого ключа изменяется, но данные в учетной записи хранения Azure не требуется повторно шифровать.

Если вы включаете или отключаете управляемые ключи клиента или изменяете ключ или версию ключа, Защита корневого ключа шифрования изменяется, но данные в учетной записи хранения Azure не требуют повторного шифрования.

Сведения об использовании управляемых клиентом ключей с Azure Key Vault для шифрования службы хранилища Azure см. в одной из следующих статей:

- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure из портал Azure](storage-encryption-keys-portal.md)
- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure из PowerShell](storage-encryption-keys-powershell.md)
- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure Azure CLI](storage-encryption-keys-cli.md)

> [!IMPORTANT]
> Управляемые клиентом ключи основываются на управляемых удостоверениях для ресурсов Azure — функции Azure AD. Сейчас управляемые удостоверения не поддерживаются в сценариях работы с разными каталогами. При настройке ключей, управляемых клиентом, в портал Azure управляемое удостоверение автоматически назначается вашей учетной записи хранения, как описано в этой статье. Если впоследствии вы перемещаете подписку, группу ресурсов или учетную запись хранения из одного каталога Azure AD в другой, управляемое удостоверение, связанное с учетной записью хранения, не передается в новый клиент, поэтому управляемые клиентом ключи могут перестать работать. Дополнительные сведения см. в статье **Передача подписки между каталогами Azure AD** в [часто задаваемых вопросах и известных проблемах с управляемыми удостоверениями для ресурсов Azure](../../active-directory/managed-identities-azure-resources/known-issues.md#transferring-a-subscription-between-azure-ad-directories).  

## <a name="store-customer-managed-keys-in-azure-key-vault"></a>Хранение ключей, управляемых клиентом, в Azure Key Vault

Чтобы включить управляемые клиентом ключи в учетной записи хранения, необходимо использовать Azure Key Vault для хранения ключей. Необходимо включить как **обратимое удаление** , так и **не очищать** свойства в хранилище ключей.

С шифрованием службы хранилища Azure поддерживаются только 2048-разрядные ключи RSA и RSA-HSM. Дополнительные сведения о ключах см. в разделе **Key Vault Keys** раздела [о Azure Key Vault ключах, секретах и сертификатах](../../key-vault/about-keys-secrets-and-certificates.md#key-vault-keys).

## <a name="rotate-customer-managed-keys"></a>Смена ключей, управляемых клиентом

Вы можете поворачивать ключ, управляемый клиентом, в Azure Key Vault в соответствии с политиками соответствия требованиям. При вращении ключа необходимо обновить учетную запись хранения, чтобы она использовала новый универсальный код ресурса (URI) версии ключа. Сведения об обновлении учетной записи хранения для использования новой версии ключа в портал Azure см. в разделе **обновление ключа версии раздела** [Настройка управляемых клиентом ключей для службы хранилища Azure с помощью портал Azure](storage-encryption-keys-portal.md).

При вращении ключа повторное шифрование данных в учетной записи хранения не инициируется. От пользователя не требуется предпринимать никаких действий.

## <a name="revoke-access-to-customer-managed-keys"></a>Отозвать доступ к ключам, управляемым клиентом

Вы можете в любое время отозвать доступ учетной записи хранения к ключу, управляемому клиентом. После отмены доступа к ключам, управляемым клиентом, или после отключения или удаления ключа клиенты не могут вызывать операции, считывающие или записывающие в большой двоичный объект или его метаданные. Попытки вызова любой из следующих операций завершатся ошибкой с кодом ошибки 403 (запрещено) для всех пользователей:

- [Вывод списка больших двоичных объектов](/rest/api/storageservices/list-blobs)при `include=metadata` вызове с параметром в URI запроса
- [Get BLOB (Получение BLOB-объекта)](/rest/api/storageservices/get-blob)
- [Get BLOB Properties (Получение свойств BLOB-объекта)](/rest/api/storageservices/get-blob-properties)
- [Get BLOB Metadata (Получение метаданных BLOB-объекта)](/rest/api/storageservices/get-blob-metadata)
- [Set Blob Metadata](/rest/api/storageservices/set-blob-metadata)
- [Большой двоичный объект моментальных снимков](/rest/api/storageservices/snapshot-blob)при вызове с заголовком `x-ms-meta-name` запроса
- [Copy Blob](/rest/api/storageservices/copy-blob)
- [Копировать большой двоичный объект из URL-адреса](/rest/api/storageservices/copy-blob-from-url)
- [Установка уровня большого двоичного объекта](/rest/api/storageservices/set-blob-tier)
- [Put Block](/rest/api/storageservices/put-block)
- [Разместить блок по URL-адресу](/rest/api/storageservices/put-block-from-url)
- [Append Block](/rest/api/storageservices/append-block)
- [Добавить блок из URL-адреса](/rest/api/storageservices/append-block-from-url)
- [вставка большого двоичного объекта](/rest/api/storageservices/put-blob);
- [Put Page](/rest/api/storageservices/put-page)
- [Размещение страницы по URL-адресу](/rest/api/storageservices/put-page-from-url)
- [Добавочное копирование большого двоичного объекта](/rest/api/storageservices/incremental-copy-blob)

Чтобы снова вызвать эти операции, восстановите доступ к ключу, управляемому клиентом.

Все операции с данными, которые не перечислены в этом разделе, могут продолжаться после отзыва ключей, управляемых клиентом, или отключения или удаления ключа.

Чтобы отозвать доступ к ключам, управляемым клиентом, используйте [PowerShell](storage-encryption-keys-powershell.md#revoke-customer-managed-keys) или [Azure CLI](storage-encryption-keys-cli.md#revoke-customer-managed-keys).

## <a name="customer-managed-keys-for-azure-managed-disks"></a>Управляемые клиентом ключи для управляемых дисков Azure

Ключи, управляемые клиентом, также доступны для управления шифрованием управляемых дисков Azure. Управляемые клиентом ключи ведут себя иначе для управляемых дисков, чем для ресурсов службы хранилища Azure. Дополнительные сведения см. в статье [Шифрование управляемых дисков Azure](../../virtual-machines/windows/disk-encryption.md) на стороне сервера для Windows или [Шифрование на стороне сервера для управляемых дисков Azure](../../virtual-machines/linux/disk-encryption.md) для Linux.

## <a name="next-steps"></a>Дальнейшие шаги

- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure из портал Azure](storage-encryption-keys-portal.md)
- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure из PowerShell](storage-encryption-keys-powershell.md)
- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure Azure CLI](storage-encryption-keys-cli.md)
- [Шифрование неактивных данных в службе хранилища Azure](storage-service-encryption.md)
