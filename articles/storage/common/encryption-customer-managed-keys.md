---
title: Используйте управляемые клиентами ключи с Azure Key Vault для управления шифрованием учетной записи
titleSuffix: Azure Storage
description: Вы можете использовать свой собственный ключ шифрования для защиты данных в вашей учетной записи хранения. Когда вы указываете ключ, управляемый клиентом, этот ключ используется для защиты и контроля доступа к ключу, который шифрует ваши данные. Управляемые клиентами ключи обеспечивают большую гибкость для управления элементами управления доступом.
services: storage
author: tamram
ms.service: storage
ms.date: 03/12/2020
ms.topic: conceptual
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: b2755d5aa5dbaa669fa2fdd8b84596e040b5dd6b
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81456827"
---
# <a name="use-customer-managed-keys-with-azure-key-vault-to-manage-azure-storage-encryption"></a>Используйте управляемые клиентами ключи с Azure Key Vault для управления шифрованием хранилища Azure

Вы можете использовать свой собственный ключ шифрования для защиты данных в вашей учетной записи хранения. Когда вы указываете ключ, управляемый клиентом, этот ключ используется для защиты и контроля доступа к ключу, который шифрует ваши данные. Управляемые клиентами ключи обеспечивают большую гибкость для управления элементами управления доступом.

Для хранения ключей, управляемых клиентом, необходимо использовать Azure Key Vault. Вы можете создать свои собственные ключи и хранить их в хранилище ключей, либо использовать AA-иносы Azure Key Vault для генерации ключей. Учетная запись и хранилище ключей должны находиться в одном регионе и в том же клиенте Azure Active Directory (Azure AD), но они могут быть в разных подписках. Для получения дополнительной информации о [What is Azure Key Vault?](../../key-vault/general/overview.md)Убежище ключей Azure см.

## <a name="about-customer-managed-keys"></a>О ключах, управляемых клиентами

На следующей диаграмме показано, как Azure Storage использует active Directory Azure и Хранилище ключей Azure для обработки запросов с помощью ключа, управляемого клиентом:

![Диаграмма, показывающая, как работают управляемые клиентами ключи в хранилище Azure](media/encryption-customer-managed-keys/encryption-customer-managed-keys-diagram.png)

В следующем списке объясняется пронумерованные шаги на диаграмме:

1. Администратор Azure Key Vault предоставляет разрешения на ключи шифрования управляемого идентатора, связанного с учетной записью хранения.
2. Администратор хранилища Azure настраивает шифрование с помощью управляемого клиентом ключа для учетной записи хранения.
3. Azure Storage использует управляемый имитизм, связанный с учетной записью хранения, для проверки подлинности доступа к Хранилищем ключей Azure через Active Directory Azure.
4. Azure Storage обертывает ключ шифрования учетной записи ключом клиента в Хранилище ключей Azure.
5. Для операций чтения/записи Azure Storage отправляет запросы в Хранилище ключей Azure для разворачивания ключа шифрования учетной записи для выполнения операций шифрования и расшифровки.

## <a name="create-an-account-that-supports-customer-managed-keys-for-queues-and-tables"></a>Создайте учетную запись, которая поддерживает управляемые клиентом ключи для очередей и таблиц

Данные, хранящиеся в службах очереди и таблицы, не защищены автоматически ключом, управляемым клиентом, когда ключи, управляемые клиентом, включены для учетной записи хранилища. Вы можете дополнительно настроить эти службы во время создания учетной записи хранилища для включения в эту защиту.

Для получения дополнительной информации о том, как создать учетную запись хранения, которая поддерживает управляемые клиентами ключи для очередей и таблиц, [см. Создать учетную запись, которая поддерживает управляемые клиентом ключи для таблиц и очередей.](account-encryption-key-create.md)

Данные в службах Blob и File всегда защищены ключами, управляемыми клиентом, когда ключи, управляемые клиентом, настроены для учетной записи хранилища.

## <a name="enable-customer-managed-keys-for-a-storage-account"></a>Включить ключи, управляемые клиентом для учетной записи хранилища

Управляемые клиентом ключи могут быть включены только на существующих учетных записях хранения. Хранилище ключей должно быть подготовлено с политиками доступа, которые предоставляют ключевые разрешения управляемому идентатору, связанного с учетной записью хранилища. Управляемая идентификация доступна только после создания учетной записи хранилища.

При настройке ключа, управляемого клиентом, Azure Storage обертывает ключ шифрования корневых данных для учетной записи с ключом, управляемым клиентом, в связанном хранилище ключей. Включение ключей, управляемых клиентом, не влияет на производительность и вступает в силу немедленно.

При изменении ключа, используемого для шифрования Azure Storage, путем включения или отключения ключей, управляемых клиентом, обновления ключевой версии или указания другого ключа, шифрование корневого ключа изменяется, но данные в вашей учетной записи Azure Storage не нужно повторно шифровать.

При вводе или отключении управляемых ключей клиента или при изменении ключа или ключевой версии защита ключа корневого шифрования изменяется, но данные в вашей учетной записи Azure Storage не нуждаются в повторном шифровании.

Чтобы узнать, как использовать управляемые клиентами ключи с помощью Azure Key Vault для шифрования Azure Storage, смотрите одну из следующих статей:

- [Настройка ключей, управляемых клиентами, с помощью шифрования Key Vault для хранения Azure с портала Azure](storage-encryption-keys-portal.md)
- [Настройка ключей, управляемых клиентами, с помощью Key Vault для шифрования хранилища Azure от PowerShell](storage-encryption-keys-powershell.md)
- [Настройка ключей, управляемых клиентами, с помощью шифрования Key Vault для хранения Azure из Azure CLI](storage-encryption-keys-cli.md)

> [!IMPORTANT]
> Управляемые клиентами ключи опираются на управляемые идентификаторы для ресурсов Azure, что является особенностью Azure AD. Сейчас управляемые удостоверения не поддерживаются в сценариях работы с разными каталогами. При настройке ключей, управляемых клиентом, на портале Azure автоматически присваивается учетная запись хранилища под крышкой. Если впоследствии из одного каталога Azure AD выведете учетную запись подписки, группы ресурсов или учетной записи хранилища, управляемая идентификация, связанная с учетной записью хранилища, не передается новому арендатору, поэтому ключи, управляемые клиентом, могут больше не работать. Для получения дополнительной информации см. **Передача подписки между каталогами Azure AD** в [часто задаваемых вопросах и известными проблемами с управляемыми идентификаторами для ресурсов Azure.](../../active-directory/managed-identities-azure-resources/known-issues.md#transferring-a-subscription-between-azure-ad-directories)  

## <a name="store-customer-managed-keys-in-azure-key-vault"></a>Храните ключи, управляемые клиентами в Хранилище ключей Azure

Чтобы включить ключи, управляемые клиентом в учетной записи хранилища, необходимо использовать Хранилище ключей Azure для хранения ключей. Вы должны включить свойства **Soft Delete** и Do **Not Purge** на хранилище ключей.

Только 2048-разрядные клавиши RSA и RSA-HSM поддерживаются шифрованием Azure Storage. Для получения дополнительной информации о ключах смотрите **ключи Убежища ключей** в [о клавишах, секретах и сертификатах Azure Key Vault.](../../key-vault/about-keys-secrets-and-certificates.md#key-vault-keys)

## <a name="rotate-customer-managed-keys"></a>Поверните клавиши, управляемые клиентом

Вы можете повернуть ключ, управляемый клиентом, в Azure Key Vault в соответствии с вашими политиками соответствия. При повороте ключа необходимо обновить учетную запись хранилища, чтобы использовать новую ключевую версию URI. Чтобы узнать, как обновить учетную запись хранилища, чтобы использовать новую версию ключа на портале Azure, смотрите раздел под названием **Обновление ключевой версии** в [Настройка ключей для хранения Azure, управляемых клиентами, с помощью портала Azure.](storage-encryption-keys-portal.md)

Вращение ключа не вызывает повторного шифрования данных в учетной записи хранилища. От пользователя не требуется никаких дальнейших действий.

## <a name="revoke-access-to-customer-managed-keys"></a>Отмена доступа к ключам, управляемым клиентами

Вы можете в любое время отозвать доступ учетной записи хранилища к ключу, управляемому клиентом. После того, как доступ к ключам, управляемым клиентом, аннулируется или после того, как ключ был отключен или удален, клиенты не могут вызывать операции, которые читаются с капли или ее метаданные. Попытки вызова любой из следующих операций не увенчаются отказом с кодом ошибки 403 (Запрещено) для всех пользователей:

- [Список Blobs](/rest/api/storageservices/list-blobs), `include=metadata` при вызове с параметром по запросу URI
- [Get BLOB (Получение BLOB-объекта)](/rest/api/storageservices/get-blob)
- [Get BLOB Properties (Получение свойств BLOB-объекта)](/rest/api/storageservices/get-blob-properties)
- [Get BLOB Metadata (Получение метаданных BLOB-объекта)](/rest/api/storageservices/get-blob-metadata)
- [Set Blob Metadata](/rest/api/storageservices/set-blob-metadata)
- [Снимок Blob](/rest/api/storageservices/snapshot-blob), `x-ms-meta-name` при вызове с заголовком запроса
- [Copy Blob](/rest/api/storageservices/copy-blob)
- [Копия Blob из URL](/rest/api/storageservices/copy-blob-from-url)
- [Установка уровня большого двоичного объекта](/rest/api/storageservices/set-blob-tier)
- [Put Block](/rest/api/storageservices/put-block)
- [Положите блок с URL](/rest/api/storageservices/put-block-from-url)
- [Append Block](/rest/api/storageservices/append-block)
- [Блок приложения с URL](/rest/api/storageservices/append-block-from-url)
- [вставка большого двоичного объекта](/rest/api/storageservices/put-blob);
- [Put Page](/rest/api/storageservices/put-page)
- [Поместите страницу с URL](/rest/api/storageservices/put-page-from-url)
- [Инкрементная копия Blob](/rest/api/storageservices/incremental-copy-blob)

Чтобы вызвать эти операции снова, восстановите доступ к ключу, управляемому клиентом.

Все операции данных, которые не перечислены в этом разделе, могут быть продолжены после отзыва ключей, управляемых клиентом, или отключения или удаления ключа.

Чтобы отозвать доступ к ключам, управляемым клиентом, используйте [PowerShell](storage-encryption-keys-powershell.md#revoke-customer-managed-keys) или [Azure CLI.](storage-encryption-keys-cli.md#revoke-customer-managed-keys)

## <a name="customer-managed-keys-for-azure-managed-disks"></a>Управляемые клиентами ключи для управляемых дисков Azure

Управляемые клиентами ключи также доступны для управления шифрованием управляемых дисков Azure. Управляемые заказчиком клавиши ведут себя по-разному для управляемых дисков, чем для ресурсов Хранения Azure. Для получения дополнительной информации смотрите [серверное шифрование управляемых дисков Azure](../../virtual-machines/windows/disk-encryption.md) для Windows или [бокового шифрования управляемых дисков Azure](../../virtual-machines/linux/disk-encryption.md) для Linux.

## <a name="next-steps"></a>Следующие шаги

- [Настройка ключей, управляемых клиентами, с помощью шифрования Key Vault для хранения Azure с портала Azure](storage-encryption-keys-portal.md)
- [Настройка ключей, управляемых клиентами, с помощью Key Vault для шифрования хранилища Azure от PowerShell](storage-encryption-keys-powershell.md)
- [Настройка ключей, управляемых клиентами, с помощью шифрования Key Vault для хранения Azure из Azure CLI](storage-encryption-keys-cli.md)
- [Шифрование хранилища Azure для данных в состоянии покоя](storage-service-encryption.md)
