---
title: Ведение журнала Аналитика Службы хранилища Azure
description: Узнайте, как заносить в журнал сведения о запросах к службе хранилища Azure.
author: normesta
ms.service: storage
ms.subservice: common
ms.topic: conceptual
ms.date: 03/11/2019
ms.author: normesta
ms.reviewer: fryu
ms.openlocfilehash: 36c6c914c96048825c82a8d1f590a7e805373c08
ms.sourcegitcommit: 670c38d85ef97bf236b45850fd4750e3b98c8899
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/08/2019
ms.locfileid: "68854601"
---
# <a name="azure-storage-analytics-logging"></a>Ведение журнала аналитики службы хранилища Azure

В аналитике хранилища регистрируется подробная информация об успешных и неудачных запросах к службе хранилища. Эта информация может использоваться для мониторинга отдельных запросов и диагностики неполадок в службе хранилища. Запросы вносятся в журнал наилучшим возможным образом.

 Ведение журнала Аналитика Службы хранилища для вашей учетной записи хранения не включено по умолчанию. Это можно сделать на [портале Azure](https://portal.azure.com/). Дополнительные сведения см. в статье [Мониторинг учетной записи хранения на портале Azure](/azure/storage/storage-monitor-storage-account). Аналитику хранилища также можно включить программно через REST API или клиентскую библиотеку. Используйте [Свойства получение свойств службы BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/Blob-Service-REST-API), [Получение свойств службы очередей](https://docs.microsoft.com/rest/api/storageservices/Get-Queue-Service-Properties)и [Получение свойств службы таблиц](https://docs.microsoft.com/rest/api/storageservices/Get-Table-Service-Properties) , чтобы включить аналитика службы хранилища для каждой службы.

 Записи журнала создаются только при получении запроса к конечной точке службы. Например, если учетная запись хранения имеет действие в конечной точке большого двоичного объекта, но не находится в конечных точках таблицы или очереди, будут созданы только журналы, относящиеся к службе BLOB-объектов.

> [!NOTE]
>  Ведение журнала Аналитика Службы хранилища в настоящее время доступно только для служб BLOB-объектов, очередей и таблиц. Однако учетная запись хранения класса Premium не поддерживается.

[!INCLUDE [storage-multi-protocol-access-preview](../../../includes/storage-multi-protocol-access-preview.md)]

## <a name="requests-logged-in-logging"></a>Регистрация в журнале запросов
### <a name="logging-authenticated-requests"></a>Ведение журналов запросов, прошедших аутентификацию

 Регистрируются запросы, прошедшие аутентификацию, следующих типов:

- Выполненные запросы
- Неудачные запросы, в том числе из-за ошибок, связанных с временем ожидания, регулированием, сетью, авторизацией и др.
- Запросы, использующие подписанный URL-адрес (SAS) или OAuth, включая неудачные и успешные запросы
- Запросы к данным аналитики.

  Запросы, выполненные в самой аналитике хранилища, такие как запросы на создание или удаление журнала, не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

### <a name="logging-anonymous-requests"></a>Ведение журналов анонимных запросов

 Регистрируются анонимные запросы следующих типов:

- Выполненные запросы
- ошибки сервера;
- Ошибки времени ожидания для клиента и сервера
- Неудачные запросы GET с кодом ошибки 304 (не изменено).

  Остальные неудачные анонимные запросы не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

## <a name="how-logs-are-stored"></a>Хранение журналов

Все журналы хранятся в блочных BLOB-объектах в контейнере с именем `$logs`, который автоматически создается при включении аналитика службы хранилища для учетной записи хранения. Контейнер находится в пространстве имен BLOB-объектов учетной записи хранения, например: `http://<accountname>.blob.core.windows.net/$logs`. `$logs` После включения аналитики хранилища этот контейнер нельзя удалить, но вы можете удалить его содержимое. Если вы используете средство просмотра хранилища для непосредственного перехода к контейнеру, вы увидите все большие двоичные объекты, содержащие данные журнала.

> [!NOTE]
>  `$logs` Контейнер не отображается при выполнении операции перечисления контейнеров, например в операции List Containers. Доступ к нему можно получить только непосредственно. Например, для доступа к BLOB-объектам в `$logs` контейнере можно использовать операцию "список больших двоичных объектов".

По мере регистрации запросов в аналитике хранилища промежуточные результаты передаются в качестве блоков. Периодически эти блоки фиксируются в аналитике хранилища и к ним предоставляется доступ как к большим двоичным объектам. Для отображения данных журнала в больших двоичных объектах в контейнере **$logs** может потребоваться до часа, поскольку частота, с которой служба хранилища очищает модули записи журнала. В журналах, созданных в один и тот же час, могут присутствовать повторяющиеся записи. Вы можете определить, является ли запись двойной, проверив идентификатор запроса **RequestId** и **номер операции**.

При наличии большого объема данных журнала с несколькими файлами для каждого часа можно использовать метаданные большого двоичного объекта для определения данных, содержащихся в журнале, изучив поля метаданных BLOB-объекта. Это также полезно, поскольку иногда бывает задержка при записи данных в файлы журнала: метаданные большого двоичного объекта предоставляют более точное указание содержимого BLOB-объекта, чем имя большого двоичного объекта.

Большинство средств обзора хранилища позволяют просматривать метаданные больших двоичных объектов. Эти сведения также можно прочитать с помощью PowerShell или программно. Следующий фрагмент кода PowerShell является примером фильтрации списка больших двоичных объектов журнала по имени для указания времени и метаданных для определения только тех журналов, которые содержат операции **записи** .  

 ```powershell
 Get-AzureStorageBlob -Container '$logs' |  
 Where-Object {  
     $_.Name -match 'table/2014/05/21/05' -and   
     $_.ICloudBlob.Metadata.LogType -match 'write'  
 } |  
 ForEach-Object {  
     "{0}  {1}  {2}  {3}" –f $_.Name,   
     $_.ICloudBlob.Metadata.StartTime,   
     $_.ICloudBlob.Metadata.EndTime,   
     $_.ICloudBlob.Metadata.LogType  
 }  
 ```  

Сведения о получении списка BLOB-объектов программным путем см. в разделе Перечисление [ресурсов BLOB-объектов](https://msdn.microsoft.com/library/azure/hh452233.aspx) и [Установка и получение свойств и метаданных для ресурсов BLOB-объектов](https://msdn.microsoft.com/library/azure/dd179404.aspx).  

### <a name="log-naming-conventions"></a>Соглашения об именовании журналов

 Каждый журнал будет записан в следующем формате:

 `<service-name>/YYYY/MM/DD/hhmm/<counter>.log`

 В следующей таблице приводится описание каждого атрибута в имени журнала.

|Атрибут|Описание|
|---------------|-----------------|
|`<service-name>`|имя службы хранилища. Например: `blob`, `table`или`queue`|
|`YYYY`|Год с четырьмя цифрами для журнала. Например: `2011`|
|`MM`|Месяц с двумя цифрами для журнала. Например: `07`|
|`DD`|День для журнала, состоящих из двух цифр. Например: `31`|
|`hh`|Час в два цифры, указывающий начальный час для журналов в формате UTC в 24 часа. Например: `18`|
|`mm`|Двузначное число, указывающее начальную минуту для журналов. **Примечание.**  Это значение не поддерживается в текущей версии Аналитика Службы хранилища, и его значение всегда `00`будет равно.|
|`<counter>`|Шестизначный счетчик с отсчетом от нуля, который показывает количество больших двоичных объектов журнала, созданных для службы хранилища в течение часа. Этот счетчик начинается с `000000`. Например: `000001`|

 Ниже приведен полный пример имени журнала, объединяющего приведенные выше примеры.

 `blob/2011/07/31/1800/000001.log`

 Ниже приведен пример универсального кода ресурса (URI), который можно использовать для доступа к указанному выше журналу.

 `https://<accountname>.blob.core.windows.net/$logs/blob/2011/07/31/1800/000001.log`

 При регистрации запроса хранилища имя результирующего журнала сопоставляется с часом завершения запрошенной операции. Например, если запрос к большому двоичному объекту был выполнен в 6:30 на 7/31/2011, то журнал будет записан со следующим префиксом:`blob/2011/07/31/1800/`

### <a name="log-metadata"></a>Метаданные журнала

 Все большие двоичные объекты журнала хранятся с метаданными, с помощью которых можно определить, какие данные журнала содержит большой двоичный объект. В следующей таблице описаны все атрибуты метаданных.

|Атрибут|Описание|
|---------------|-----------------|
|`LogType`|Описывает, содержит ли журнал информацию, относящуюся к операциям чтения, записи или удаления. Это значение может содержать данные одного типа или сочетание всех трех типов данных, разделенных запятыми.<br /><br /> Пример 1: `write`<br /><br /> Пример 2: `read,write`<br /><br /> Пример 3.`read,write,delete`|
|`StartTime`|Самое раннее время записи в журнале в виде `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:21:46Z`|
|`EndTime`|Последнее время записи в журнале в виде `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:22:09Z`|
|`LogVersion`|Версия формата журнала.|

 В следующем списке показаны полные примеры метаданных с использованием приведенных выше примеров.

-   `LogType=write`
-   `StartTime=2011-07-31T18:21:46Z`
-   `EndTime=2011-07-31T18:22:09Z`
-   `LogVersion=1.0`

## <a name="enable-storage-logging"></a>Включение ведения журнала хранилища

Ведение журнала хранилища можно включить с помощью портал Azure, PowerShell и пакетов SDK для службы хранилища.

### <a name="enable-storage-logging-using-the-azure-portal"></a>Включение ведения журнала хранилища с помощью портал Azure  

В портал Azure используйте колонку **параметры диагностики (классическая модель)** для управления ведением журнала хранилища, доступного из раздела **мониторинг (классическая модель)** в колонке **меню**учетной записи хранения.

Вы можете указать службы хранилища, которые требуется заносить в журнал, и срок хранения записанных данных (в днях).  

### <a name="enable-storage-logging-using-powershell"></a>Включение ведения журнала хранилища с помощью PowerShell  

 PowerShell можно использовать на локальном компьютере для настройки ведения журнала хранилища в учетной записи хранения с помощью командлета Azure PowerShell **Get-азуресторажесервицелоггингпроперти** для получения текущих параметров, а командлет  **Set-Азуресторажесервицелоггингпроперти** , чтобы изменить текущие параметры.  

 Командлеты, управляющие ведением журнала хранилища, используют параметр **логгингоператионс** , который представляет собой строку, содержащую разделенный запятыми список типов запросов для записи в журнал. Возможны три типа запросов: **Чтение**, **запись**и **Удаление**. Чтобы отключить ведение журнала, используйте значение **None** для параметра **логгингоператионс** .  

 Следующая команда переключается на ведение журнала запросов на чтение, запись и удаление в служба очередей в учетной записи хранения по умолчанию с сроком хранения в 5 дней.  

```powershell
Set-AzureStorageServiceLoggingProperty -ServiceType Queue -LoggingOperations read,write,delete -RetentionDays 5  
```  

 Следующая команда отключает ведение журнала для службы таблиц в учетной записи хранения по умолчанию:  

```powershell
Set-AzureStorageServiceLoggingProperty -ServiceType Table -LoggingOperations none  
```  

 Дополнительные сведения о настройке командлетов Azure PowerShell для работы с подпиской Azure и о выборе учетной записи хранения по умолчанию см. в статье с [общими сведениями об Azure PowerShell](https://azure.microsoft.com/documentation/articles/install-configure-powershell/).  

### <a name="enable-storage-logging-programmatically"></a>Программное включение ведения журнала хранилища  

 Кроме использования портал Azure или командлетов Azure PowerShell для управления ведением журнала хранилища можно также использовать один из интерфейсов API службы хранилища Azure. Например, при использовании языка .NET можно использовать клиентскую библиотеку хранилища.  

 Классы **CloudBlobClient**, **CloudQueueClient**и **CloudTableClient** имеют такие методы, как **Сетсервицепропертиес** и **сетсервицепропертиесасинк** , которые принимают объект **сервицепропертиес** в качестве параметр. Для настройки ведения журнала хранилища можно использовать объект **сервицепропертиес** . Например, в следующем C# фрагменте кода показано, как изменить журнал и срок хранения для журнала очереди:  

```csharp
var storageAccount = CloudStorageAccount.Parse(connStr);  
var queueClient = storageAccount.CreateCloudQueueClient();  
var serviceProperties = queueClient.GetServiceProperties();  

serviceProperties.Logging.LoggingOperations = LoggingOperations.All;  
serviceProperties.Logging.RetentionDays = 2;  

queueClient.SetServiceProperties(serviceProperties);  
```  

 Дополнительные сведения об использовании языка .NET для настройки ведения журнала хранилища см. в статье [Справочник по клиентской библиотеке хранилища](https://msdn.microsoft.com/library/azure/dn261237.aspx).  

 Общие сведения о настройке ведения журнала хранилища с помощью REST API см. в разделе [Включение и настройка аналитика службы хранилища](https://msdn.microsoft.com/library/azure/hh360996.aspx).  

## <a name="download-storage-logging-log-data"></a>Загрузка данных журнала хранилища

 Для просмотра и анализа данных журнала необходимо скачать большие двоичные объекты, содержащие интересующие вас данные журнала, на локальном компьютере. Многие средства обзора хранилища позволяют скачивать большие двоичные объекты из учетной записи хранения. Вы также можете загрузить данные журнала с помощью команды службы хранилища Azure, предоставляемой командой Azure Copy Tool (**AzCopy**).  

 Чтобы убедиться, что вы загрузили интересующие вас данные журнала и не хотите загружать одни и те же данные журнала несколько раз, сделайте следующее:  

-   Используйте соглашение об именовании даты и времени для больших двоичных объектов, содержащих данные журнала, чтобы определить, какие BLOB-объекты уже скачаны для анализа, чтобы избежать повторной загрузки одних и тех же данных.  

-   Используйте метаданные больших двоичных объектов, содержащих данные журнала, чтобы указать конкретный период, для которого BLOB-объект хранит данные журнала, чтобы указать точный большой двоичный объект, который необходимо скачать.  

> [!NOTE]
>  AzCopy является частью пакета SDK для Azure, но вы всегда можете скачать последнюю версию из [https://aka.ms/AzCopy](https://aka.ms/AzCopy). По умолчанию AzCopy устанавливается в папку C:\Program Files **(x86) \Microsoft SDKs\Windows азуре\азкопи**, и перед запуском средства в командной строке или окне PowerShell следует добавить эту папку в путь.  

 В следующем примере показано, как загрузить данные журнала для службы очередей в часы, начиная с 09 AM, 10 AM и 11 AM в 20 мая, 2014. Параметр **/s** приводит к тому, что AzCopy создает локальную структуру папок на основе значений даты и времени в именах файлов журнала; параметр **/v** заставляет AzCopy выдавать подробные выходные данные; параметр **/y** заставляет AzCopy перезаписывать любые локальные файлы. Замените **< йоурсторажеаккаунт\>**  именем своей учетной записи хранения и замените **< йоурсторажекэй\>**  на ключ учетной записи хранения.  

```
AzCopy 'http://<yourstorageaccount>.blob.core.windows.net/$logs/queue'  'C:\Logs\Storage' '2014/05/20/09' '2014/05/20/10' '2014/05/20/11' /sourceKey:<yourstoragekey> /S /V /Y  
```  

 AzCopy также имеет некоторые полезные параметры, управляющие тем, как оно задает время последнего изменения загружаемых файлов и будет ли оно пытаться скачивать файлы, которые уже существуют на локальном компьютере или более старые или более новые. Его также можно запустить в режиме, перезапускаемом. Для получения подробных сведений просмотрите справку, выполнив **AzCopy/?** кнопки.  

 Пример программной загрузки данных журнала см. в записи блога [запись в журнал хранилища Windows Azure: Использование журналов для мониторинга запросов](https://blogs.msdn.com/b/windowsazurestorage/archive/2011/08/03/windows-azure-storage-logging-using-logs-to-track-storage-requests.aspx) к хранилищу и поиска слова «думплогс» на странице.  

 После загрузки данных журнала можно просмотреть записи журнала в файлах. В этих файлах журнала используется текстовый формат с разделителями, в котором могут анализироваться многие средства чтения журнала, включая анализатор сообщений Майкрософт (Дополнительные сведения см. в разделе Руководство по [мониторингу, диагностике и устранению неполадок служба хранилища Microsoft Azure](storage-monitoring-diagnosing-troubleshooting.md)). Различные инструменты имеют различные средства для форматирования, фильтрации, сортировки, поиска в Active Directory содержимого файлов журнала. Дополнительные сведения о формате и содержимом журнала ведения журнала в хранилище см. в статьях [аналитика службы хранилища формат журнала](/rest/api/storageservices/storage-analytics-log-format) и [аналитика службы хранилища записанные операции и сообщения о состоянии](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages).

## <a name="next-steps"></a>Следующие шаги

* [Формат журналов аналитик хранилища](/rest/api/storageservices/storage-analytics-log-format)
* [Операции с протоколированием и сообщения о состоянии аналитик хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages)
* [Метрики Аналитика Службы хранилища (классическая модель)](storage-analytics-metrics.md)
