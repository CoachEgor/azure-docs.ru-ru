---
title: Ведение журналов аналитики хранилища Azure
description: Узнайте, как для записи сведений о запросов, сделанных к службе хранилища Azure.
services: storage
author: normesta
ms.service: storage
ms.topic: article
ms.date: 03/11/2019
ms.author: normesta
ms.reviewer: fryu
ms.subservice: common
ms.openlocfilehash: a77cf20be30361abf6590dbd53bdb07c327eb9d8
ms.sourcegitcommit: 0568c7aefd67185fd8e1400aed84c5af4f1597f9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65204997"
---
# <a name="azure-storage-analytics-logging"></a>Ведение журналов аналитики хранилища Azure

В аналитике хранилища регистрируется подробная информация об успешных и неудачных запросах к службе хранилища. Эта информация может использоваться для мониторинга отдельных запросов и диагностики неполадок в службе хранилища. Запросы вносятся в журнал наилучшим возможным образом.

 Ведение журнала Storage Analytics не включена по умолчанию для вашей учетной записи хранения. Это можно сделать на [портале Azure](https://portal.azure.com/). Дополнительные сведения см. в статье [Мониторинг учетной записи хранения на портале Azure](/azure/storage/storage-monitor-storage-account). Аналитику хранилища также можно включить программно через REST API или клиентскую библиотеку. Используйте [Get Blob Service Properties](https://docs.microsoft.com/rest/api/storageservices/Blob-Service-REST-API), [Get Queue Service Properties](https://docs.microsoft.com/rest/api/storageservices/Get-Queue-Service-Properties), и [Get Table Service Properties](https://docs.microsoft.com/rest/api/storageservices/Get-Table-Service-Properties) операции для включения аналитики хранилища для каждой службы.

 Записи журнала создаются только при получении запроса к конечной точке службы. Например если учетная запись хранения имеет действия в конечной точке BLOB-объектов, но не в ее конечных точках служб таблиц или очередей, будет создан только журналы, относящиеся к службе BLOB-объектов.

> [!NOTE]
>  Ведение журнала Storage Analytics в настоящее время доступна только для служб BLOB-объектов, очередей и таблиц. Тем не менее учетная запись хранения уровня "премиум" не поддерживается.

## <a name="requests-logged-in-logging"></a>Запросы на вход ведения журнала
### <a name="logging-authenticated-requests"></a>Ведение журналов запросов, прошедших аутентификацию

 Регистрируются запросы, прошедшие аутентификацию, следующих типов:

- Успешные запросы.
- Неудачные запросы, в том числе из-за ошибок, связанных с временем ожидания, регулированием, сетью, авторизацией и др.
- Запросы с использованием подписи общего доступа (SAS) или OAuth, в том числе неудачные и успешные запросы
- Запросы к данным аналитики.

  Запросы, выполненные в самой аналитике хранилища, такие как запросы на создание или удаление журнала, не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

### <a name="logging-anonymous-requests"></a>Ведение журналов анонимных запросов

 Регистрируются анонимные запросы следующих типов:

- Успешные запросы.
- ошибки сервера;
- Ошибки времени ожидания для клиента и сервера
- Неудачные запросы GET с кодом ошибки 304 (не изменено).

  Остальные неудачные анонимные запросы не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

## <a name="how-logs-are-stored"></a>Хранение журналов

Все журналы хранятся в блочных BLOB-объектов в контейнере с именем `$logs`, который автоматически создается при включении аналитики хранилища для учетной записи хранения. `$logs` Контейнер находится в пространстве имен BLOB-объектов учетной записи хранения, например: `http://<accountname>.blob.core.windows.net/$logs`. После включения аналитики хранилища этот контейнер нельзя удалить, но вы можете удалить его содержимое. Если вы используете средства обзора хранилища для перехода непосредственно к контейнеру, вы увидите, что все большие двоичные объекты, содержащие данные журнала.

> [!NOTE]
>  `$logs` Контейнер не отображается при выполнении операции листинга контейнеров, таких как операции списка контейнеров. Доступ к нему можно получить только непосредственно. Например, можно использовать операцию список больших двоичных объектов для доступа к BLOB-объектов в `$logs` контейнера.

По мере регистрации запросов в аналитике хранилища промежуточные результаты передаются в качестве блоков. Периодически эти блоки фиксируются в аналитике хранилища и к ним предоставляется доступ как к большим двоичным объектам. Он может занять до часа данных журнала в BLOB-объектов в **$logs** контейнер так как частота, с которой служба хранилища очищает записи в журнал. В журналах, созданных в один и тот же час, могут присутствовать повторяющиеся записи. Вы можете определить, является ли запись двойной, проверив идентификатор запроса **RequestId** и **номер операции**.

При наличии большого количества данных журнала с несколькими файлами за каждый час, метаданные большого двоичного объекта можно использовать для определения данных журнала с помощью проверки полей метаданных больших двоичных объектов. Это также полезно, так как существует иногда возможна задержка при записи данных в файлы журнала: метаданные содержат более точного обозначения содержимого больших двоичных объектов, чем имя большого двоичного объекта.

Большинство средств обзора хранилища позволяют просматривать метаданные больших двоичных объектов; Можно также прочитать эту информацию, с помощью PowerShell или программно. Следующий фрагмент кода PowerShell является примером фильтрации списка BLOB-объектов журнала по имени для указания времени, а также по метаданным с целью определения только тех журналов, содержащие **записи** операций.  

 ```powershell
 Get-AzureStorageBlob -Container '$logs' |  
 Where-Object {  
     $_.Name -match 'table/2014/05/21/05' -and   
     $_.ICloudBlob.Metadata.LogType -match 'write'  
 } |  
 ForEach-Object {  
     "{0}  {1}  {2}  {3}" –f $_.Name,   
     $_.ICloudBlob.Metadata.StartTime,   
     $_.ICloudBlob.Metadata.EndTime,   
     $_.ICloudBlob.Metadata.LogType  
 }  
 ```  

Сведения о программном см. в разделе [перечисление ресурсов BLOB-объектов](https://msdn.microsoft.com/library/azure/hh452233.aspx) и [параметр и получение свойств и метаданных для ресурсов BLOB-объектов](https://msdn.microsoft.com/library/azure/dd179404.aspx).  

### <a name="log-naming-conventions"></a>Соглашения об именовании журналов

 Каждый журнал записывается в следующем формате:

 `<service-name>/YYYY/MM/DD/hhmm/<counter>.log`

 В следующей таблице описан каждый атрибут в имени.

|Атрибут|ОПИСАНИЕ|
|---------------|-----------------|
|`<service-name>`|имя службы хранилища. Например: `blob`, `table`, или `queue`|
|`YYYY`|Четырехзначное обозначение года создания журнала. Например: `2011`|
|`MM`|Двухзначное обозначение месяца создания журнала. Например: `07`|
|`DD`|Двухзначное обозначение дня создания журнала. Например: `31`|
|`hh`|Формате часа из двух цифр, которое указывает час начала ведения журнала, в 24-часовом формате UTC. Например: `18`|
|`mm`|Код из двух цифр, которое указывает минуту начала ведения журналов. **Примечание.**  Это значение не поддерживается в текущей версии аналитики хранилища, и его значение всегда равно `00`.|
|`<counter>`|Шестизначный счетчик с отсчетом от нуля, который показывает количество больших двоичных объектов журнала, созданных для службы хранилища в течение часа. Этот счетчик начинается с `000000`. Например: `000001`|

 Ниже приведен пример полного имени журнала, которая объединяет приведенных выше примерах.

 `blob/2011/07/31/1800/000001.log`

 Ниже приведен пример URI, который может использоваться для доступа к указанному журналу.

 `https://<accountname>.blob.core.windows.net/$logs/blob/2011/07/31/1800/000001.log`

 При регистрации запроса хранилища имя результирующего журнала сопоставляется с часом завершения запрошенной операции. Например если запрос GetBlob был завершен в 18:30:00 на 7/31 июля 2011 года, журнал будет записан следующий префикс: `blob/2011/07/31/1800/`

### <a name="log-metadata"></a>Метаданные журнала

 Все большие двоичные объекты журнала хранятся с метаданными, с помощью которых можно определить, какие данные журнала содержит большой двоичный объект. В следующей таблице описаны каждый атрибут метаданных:

|Атрибут|ОПИСАНИЕ|
|---------------|-----------------|
|`LogType`|Описывает, содержит ли журнал информацию, относящуюся к операциям чтения, записи или удаления. Это значение может содержать данные одного типа или сочетание всех трех типов данных, разделенных запятыми.<br /><br /> Пример 1: `write`<br /><br /> Пример 2: `read,write`<br /><br /> Пример 3. `read,write,delete`|
|`StartTime`|Самое раннее время записи в журнале в форме `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:21:46Z`|
|`EndTime`|Время последней записи в журнале в форме `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:22:09Z`|
|`LogVersion`|Версия формата журнала.|

 В следующем списке приведены полный образец метаданных с помощью приведенных выше примерах:

-   `LogType=write`
-   `StartTime=2011-07-31T18:21:46Z`
-   `EndTime=2011-07-31T18:22:09Z`
-   `LogVersion=1.0`

## <a name="enable-storage-logging"></a>Включение ведения журнала хранилища

Вы можете включить ведение журнала хранилища с помощью портала Azure, PowerShell и пакетов SDK службы хранилища.

### <a name="enable-storage-logging-using-the-azure-portal"></a>Включение ведения журнала хранилища с помощью портала Azure  

На портале Azure, используйте **параметры диагностики (классические)** колонку управления ведением журнала, доступные из **мониторинг (Классическая модель)** часть учетной записи хранения **колонке меню** .

Можно указать службам хранилища, которые будут использоваться для входа и срок хранения (в днях) для данных журнала.  

### <a name="enable-storage-logging-using-powershell"></a>Включение ведения журнала хранилища с помощью PowerShell  

 Настройка ведения журнала хранилища в учетной записи хранения с помощью командлета Azure PowerShell можно использовать PowerShell на локальном компьютере **Get-AzureStorageServiceLoggingProperty** для получения текущих настроек и командлет  **SET-AzureStorageServiceLoggingProperty** изменение текущих параметров.  

 Используйте командлеты, управляющие ведения журнала хранилища **LoggingOperations** параметр, который является строка, содержащая разделенный запятыми список типов запросов в журнал. Три возможные типы запросов: **чтение**, **записи**, и **удалить**. Чтобы отключить ведение журнала, используйте значение **none** для **LoggingOperations** параметра.  

 Следующая команда изменяет ведения журнала для чтения, записывать и удалять запросы в службе очередей в учетной записи хранения по умолчанию с помощью параметра retention задано пять дней:  

```powershell
Set-AzureStorageServiceLoggingProperty -ServiceType Queue -LoggingOperations read,write,delete -RetentionDays 5  
```  

 Следующая команда отключает ведение журнала для службы таблиц в учетной записи хранения по умолчанию:  

```powershell
Set-AzureStorageServiceLoggingProperty -ServiceType Table -LoggingOperations none  
```  

 Дополнительные сведения о настройке командлетов Azure PowerShell для работы с подпиской Azure и о выборе учетной записи хранения по умолчанию см. в статье с [общими сведениями об Azure PowerShell](https://azure.microsoft.com/documentation/articles/install-configure-powershell/).  

### <a name="enable-storage-logging-programmatically"></a>Включить ведение журнала программными средствами  

 Помимо использования портала Azure или командлетов Azure PowerShell для управления ведением журнала, можно также использовать один из API службы хранилища Azure. Например если вы используете язык .NET можно использовать клиентскую библиотеку хранилища.  

 Классы **CloudBlobClient**, **CloudQueueClient**, и **CloudTableClient** все имеют методы, такие как **SetServiceProperties** и **SetServicePropertiesAsync** , принимающих **ServiceProperties** объект в качестве параметра. Можно использовать **ServiceProperties** объекта, чтобы настроить ведение журнала хранилища. Например, следующая C# фрагменте показано, как изменить регистрируемых и срок хранения для журнала очереди:  

```csharp
var storageAccount = CloudStorageAccount.Parse(connStr);  
var queueClient = storageAccount.CreateCloudQueueClient();  
var serviceProperties = queueClient.GetServiceProperties();  

serviceProperties.Logging.LoggingOperations = LoggingOperations.All;  
serviceProperties.Logging.RetentionDays = 2;  

queueClient.SetServiceProperties(serviceProperties);  
```  

 Дополнительные сведения о настройке ведения журнала хранилища с помощью языка .NET см. в разделе [Справочник по клиентской библиотеке хранилища](https://msdn.microsoft.com/library/azure/dn261237.aspx).  

 Общие сведения о настройке ведения журнала хранилища с помощью REST API, см. в разделе [Включение и Настройка аналитики хранилища](https://msdn.microsoft.com/library/azure/hh360996.aspx).  

## <a name="download-storage-logging-log-data"></a>Загрузить данные журнала по ведению журналов хранилища

 Для просмотра и анализа данных журнала, необходимо загрузить большие двоичные объекты, содержащие данные журнала, которые вам нужны на локальный компьютер. Многие средства обзора хранилища позволяют загружать большие двоичные объекты из учетной записи хранения; Можно также использовать командной строки Azure Copy Tool, предоставляемое группой хранилища Azure (**AzCopy**) для загрузки данных журнала.  

 Во избежание более одного раза загрузку данных журнала и убедитесь, что загрузка данных журнала, которые вас интересуют:  

-   Использовать дату и время соглашение об именовании для BLOB-объектов, содержащих данные журнала для отслеживания, какие уже загружены для анализа и предотвратить повторную загрузку и тех же данных более одного раза.  

-   Чтобы определить конкретный период, для которого большой двоичный объект содержит данные журнала, чтобы определить требуемый BLOB-объект, которые необходимо загрузить с помощью метаданных больших двоичных объектов, содержащих данные журнала.  

> [!NOTE]
>  AzCopy является частью пакета SDK для Azure, но всегда можно скачать последнюю версию из [ https://aka.ms/AzCopy ](https://aka.ms/AzCopy). По умолчанию AzCopy устанавливается в папке **C:\Program Files (x86) \Microsoft SDKs\Windows Azure\AzCopy**, и нужно добавить эту папку к пути, прежде чем пытаться запустить средство в командной строке или окне PowerShell.  

 В следующем примере показано, как можно загрузить данные журнала для службы очередей для часов, начиная с 09 AM, 10 AM и 11: 00 20 мая 2014 г. **/S** параметр вызывает средство AzCopy создает локальную структуру папок на основе даты и время в имени файла; **/V** параметр включает подробный вывод; **/Y** параметр включает перезапись локальных файлов. Замените **< yourstorageaccount\>**  с именем своей учетной записи хранения, а **< yourstoragekey\>**  — ключ учетной записи хранения.  

```
AzCopy 'http://<yourstorageaccount>.blob.core.windows.net/$logs/queue'  'C:\Logs\Storage' '2014/05/20/09' '2014/05/20/10' '2014/05/20/11' /sourceKey:<yourstoragekey> /S /V /Y  
```  

 AzCopy также имеет некоторые полезные параметры этого элемента управления, как он задает время последнего изменения загружаемых файлов и является ли он будет пытаться загрузить файлы, которые старше или новее, чем файлы, которые уже существуют на локальном компьютере. Его также можно запустить в режиме перезапуска. Для получения полной информации обратитесь к разделу справки, выполнив **AzCopy /?** команда.  

 Пример того, как программным способом загрузки данных журнала, см. в записи блога [ведение журнала хранилища Windows Azure: Использование журналов для отслеживания запросов к хранилищу](https://blogs.msdn.com/b/windowsazurestorage/archive/2011/08/03/windows-azure-storage-logging-using-logs-to-track-storage-requests.aspx) и выполните поиск по слову «DumpLogs» на странице.  

 После загрузки данных журнала, можно просмотреть записи журнала в файлах. Эти файлы журнала используйте формат текста с разделителями многие средствами чтения журналов может выполнить синтаксический анализ, включая Microsoft Message Analyzer (Дополнительные сведения см. в руководстве [мониторинг, диагностика и устранение неполадок хранилища Microsoft Azure](storage-monitoring-diagnosing-troubleshooting.md)). Различные средства предоставляют различные возможности для форматирования, фильтрации, сортировки и поиска содержимого файлов журнала. Дополнительные сведения о ведении журнала хранилища формат файла журнала и содержимом см. в разделе [формат журнала аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format) и [операции с протоколированием аналитики хранилища и сообщения о состоянии](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages).

## <a name="next-steps"></a>Дальнейшие действия

* [Формат журналов аналитик хранилища](/rest/api/storageservices/storage-analytics-log-format)
* [Операции с протоколированием и сообщения о состоянии аналитик хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages)
* [Метрики аналитики хранилища (Классическая модель)](storage-analytics-metrics.md)
