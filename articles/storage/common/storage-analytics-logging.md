---
title: Ведение журнала Аналитики Службы хранилища Azure
description: Узнайте, как войти в журнал данных о запросах, сделанных в отношении хранилища Azure.
author: normesta
ms.service: storage
ms.subservice: common
ms.topic: conceptual
ms.date: 03/11/2019
ms.author: normesta
ms.reviewer: fryu
ms.openlocfilehash: 5b94a97f1286e1273300014e4eef140be412436b
ms.sourcegitcommit: 0450ed87a7e01bbe38b3a3aea2a21881f34f34dd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2020
ms.locfileid: "80637186"
---
# <a name="azure-storage-analytics-logging"></a>Ведение журнала Аналитики Службы хранилища Azure

В аналитике хранилища регистрируется подробная информация об успешных и неудачных запросах к службе хранилища. Эта информация может использоваться для мониторинга отдельных запросов и диагностики неполадок в службе хранилища. Запросы вносятся в журнал наилучшим возможным образом.

 Ведение журнала "Аналитики Службы хранилища" по умолчанию для учетной записи хранения не предусмотрено. Это можно сделать на [портале Azure](https://portal.azure.com/). Дополнительные сведения см. в статье [Мониторинг учетной записи хранения на портале Azure](/azure/storage/storage-monitor-storage-account). Аналитику хранилища также можно включить программно через REST API или клиентскую библиотеку. Используйте [свойства обслуживания Get Blob,](https://docs.microsoft.com/rest/api/storageservices/Blob-Service-REST-API) [получите свойства обслуживания очереди](https://docs.microsoft.com/rest/api/storageservices/Get-Queue-Service-Properties)и получите операции [Таблица СервисСвойства](https://docs.microsoft.com/rest/api/storageservices/Get-Table-Service-Properties) для включения аналитики хранения для каждой службы.

 Записи журнала создаются только при получении запроса к конечной точке службы. Например, если учетная запись хранилища имеет активность в своей конечном пункте Blob, но не в конечных точках таблицы или очереди, будут созданы только журналы, относящиеся к службе Blob.

> [!NOTE]
>  Ведение журнала Аналитики Службы хранилища доступно только для служб BLOB-объектов, очередей и таблиц. При этом учетная запись хранения ценовой категории "Премиум" не поддерживается.

## <a name="requests-logged-in-logging"></a>Запросы, зарегистрированные в журнале
### <a name="logging-authenticated-requests"></a>Ведение журналов запросов, прошедших аутентификацию

 Регистрируются запросы, прошедшие аутентификацию, следующих типов:

- Успешные запросы.
- Неудачные запросы, в том числе из-за ошибок, связанных с временем ожидания, регулированием, сетью, авторизацией и др.
- Запросы, в которых используется подписанный URL-адрес (SAS) или OAuth, в том числе неудачные и успешные запросы.
- Запросы к данным аналитики.

  Запросы, выполненные в самой аналитике хранилища, такие как запросы на создание или удаление журнала, не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

### <a name="logging-anonymous-requests"></a>Ведение журналов анонимных запросов

 Регистрируются анонимные запросы следующих типов:

- Успешные запросы.
- ошибки сервера;
- Ошибки времени ожидания для клиента и сервера
- Неудачные запросы GET с кодом ошибки 304 (не изменено).

  Остальные неудачные анонимные запросы не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

## <a name="how-logs-are-stored"></a>Хранение журналов

Все журналы хранятся в блочных больших двоичных объектах в контейнере под названием `$logs`, который автоматически создается при включении аналитики хранилища для учетной записи хранилища. Контейнер `$logs` находится в пространстве имен капли на счете хранения, например: `http://<accountname>.blob.core.windows.net/$logs`. После включения аналитики хранилища этот контейнер нельзя удалить, но вы можете удалить его содержимое. Если вы используете инструмент хранения для непосредственной навигации по контейнеру, вы увидите все капли, которые содержат ваши данные о регистрации.

> [!NOTE]
>  Контейнер `$logs` не отображается при выполнении операции листинга контейнеров, например операции «Список контейнеров». Доступ к нему можно получить только непосредственно. Например, можно использовать операцию List Blobs для `$logs` доступа к каплям в контейнере.

По мере регистрации запросов в аналитике хранилища промежуточные результаты передаются в качестве блоков. Периодически эти блоки фиксируются в аналитике хранилища и к ним предоставляется доступ как к большим двоичным объектам. Это может занять до часа для журнала данных, чтобы появиться в капли в **контейнере $logs,** потому что частота, на которой служба хранения сбрасывает журнал писателей. В журналах, созданных в один и тот же час, могут присутствовать повторяющиеся записи. Вы можете определить, является ли запись двойной, проверив идентификатор запроса **RequestId** и **номер операции**.

Если каждый час появляется большой объем данных журнала в нескольких файлах, то для определения того, какие данные должны содержаться в журнале, следует руководствоваться метаданными blob-объектов в полях метаданных. Этот прием также полезен по той причине, что иногда при записи данных в файл журнала имеет место задержка. Метаданные содержат более точные сведения о содержимом blob-объекта, чем имя blob-объекта.

Большая часть средств обзора позволяет просматривать метаданные blob-объектов; кроме того, эти сведения также можно считывать с использованием оболочки PowerShell или программным способом. Следующий фрагмент команды PowerShell является примером фильтрации списка blob-объектов журнала по имени для указания времени, а также по метаданным с целью определения только тех журналов. которые содержат операции **записи**.  

 ```powershell
 Get-AzureStorageBlob -Container '$logs' |  
 Where-Object {  
     $_.Name -match 'table/2014/05/21/05' -and   
     $_.ICloudBlob.Metadata.LogType -match 'write'  
 } |  
 ForEach-Object {  
     "{0}  {1}  {2}  {3}" –f $_.Name,   
     $_.ICloudBlob.Metadata.StartTime,   
     $_.ICloudBlob.Metadata.EndTime,   
     $_.ICloudBlob.Metadata.LogType  
 }  
 ```  

Для получения информации о листинге капли программно, [см. Перечисление Blob ресурсов](https://msdn.microsoft.com/library/azure/hh452233.aspx) и [настройки и получения свойств и метаданных для Blob ресурсов](https://msdn.microsoft.com/library/azure/dd179404.aspx).  

### <a name="log-naming-conventions"></a>Соглашения об именовании журналов

 Каждый журнал записывается в следующем формате:

 `<service-name>/YYYY/MM/DD/hhmm/<counter>.log`

 В следующей таблице описан каждый атрибут в имени журнала.

|Атрибут|Описание|
|---------------|-----------------|
|`<service-name>`|имя службы хранилища. Например: `blob` `table`,`queue`|
|`YYYY`|Четырехзначное обозначение года создания журнала. Например: `2011`|
|`MM`|Двухзначное обозначение месяца создания журнала. Например: `07`|
|`DD`|Двухзначное обозначение дня создания журнала. Например: `31`|
|`hh`|Двухзначное обозначение часа, которое указывает час начала ведения журнала, в 24-часовом формате времени UTC. Например: `18`|
|`mm`|Двухзначное обозначение минуты, которое указывает минуту начала ведения журнала. **Примечание:**  Это значение не поддерживается в текущей версии Analytics `00`хранения, и его значение всегда будет.|
|`<counter>`|Шестизначный счетчик с отсчетом от нуля, который показывает количество больших двоичных объектов журнала, созданных для службы хранилища в течение часа. Этот счетчик начинается с `000000`. Например: `000001`|

 Ниже приведено полное имя журнала, в котором представлены вместе все упомянутые примеры.

 `blob/2011/07/31/1800/000001.log`

 Ниже приведен пример URI, который может использоваться для получения доступа к указанному журналу.

 `https://<accountname>.blob.core.windows.net/$logs/blob/2011/07/31/1800/000001.log`

 При регистрации запроса хранилища имя результирующего журнала сопоставляется с часом завершения запрошенной операции. Например, если запрос GetBlob был выполнен в 18:30 31 сентября 2011 года, журнал будет написан со следующей приставкой:`blob/2011/07/31/1800/`

### <a name="log-metadata"></a>Метаданные журнала

 Все большие двоичные объекты журнала хранятся с метаданными, с помощью которых можно определить, какие данные журнала содержит большой двоичный объект. В следующей таблице описан каждый атрибут метаданных.

|Атрибут|Описание|
|---------------|-----------------|
|`LogType`|Описывает, содержит ли журнал информацию, относящуюся к операциям чтения, записи или удаления. Это значение может содержать данные одного типа или сочетание всех трех типов данных, разделенных запятыми.<br /><br /> Пример 1: `write`<br /><br /> Пример 2: `read,write`<br /><br /> Пример 3:`read,write,delete`|
|`StartTime`|Время первой записи в журнале в форме `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:21:46Z`|
|`EndTime`|Время самой последней записи в журнале в форме `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:22:09Z`|
|`LogVersion`|Версия формата журнала.|

 В следующем списке отображается полный образец метаданных, в котором используются приведенные выше примеры.

-   `LogType=write`
-   `StartTime=2011-07-31T18:21:46Z`
-   `EndTime=2011-07-31T18:22:09Z`
-   `LogVersion=1.0`

## <a name="enable-storage-logging"></a>Включить журнал хранения

Вы можете включить журнал хранения с помощью портала Azure, PowerShell и SDK-хранилища.

### <a name="enable-storage-logging-using-the-azure-portal"></a>Включить журнал хранения с помощью портала Azure  

На портале Azure используйте лезвие **настроек Диагностики (классическое)** для управления журналом хранения данных, доступное из **раздела «Меню» учетной** записи хранилища. **Menu blade**

Можно указать службы хранения, которые необходимо войти, и период хранения (в днях) для зарегистрированных данных.  

### <a name="enable-storage-logging-using-powershell"></a>Включить журнал хранения с помощью PowerShell  

 Чтобы настроить ведение журнала хранилища для учетной записи хранения можно использовать оболочку PowerShell на локальном компьютере, выполнив командлет Azure PowerShell **Get-AzureStorageServiceLoggingProperty** для получения текущих настроек и командлет **Set-AzureStorageServiceLoggingProperty** для их изменения.  

 В командлетах, позволяющих управлять ведением журнала хранилища, используется параметр **LoggingOperations**, представляющий собой строку, содержащую разделенный запятыми список типов запросов, подлежащих занесению в журнал. Всего используются запросы трех типов - **чтение**, **запись** и **удаление**. Чтобы отключить ведение журнала, укажите в параметре **LoggingOperations** значение **none**.  

 Следующая команда включает журнал для чтения, записи и удаления запросов в службе очереди в учетной записи хранения по умолчанию с набором удержания до пяти дней:  

```powershell
Set-AzureStorageServiceLoggingProperty -ServiceType Queue -LoggingOperations read,write,delete -RetentionDays 5  
```  

 Следующая команда отключает ведение журнала для службы таблиц в учетной записи по умолчанию:  

```powershell
Set-AzureStorageServiceLoggingProperty -ServiceType Table -LoggingOperations none  
```  

 Дополнительные сведения о настройке командлетов Azure PowerShell для работы с подпиской Azure и о выборе учетной записи хранения по умолчанию см. в разделе [Установка и настройка Azure PowerShell](https://azure.microsoft.com/documentation/articles/install-configure-powershell/).  

### <a name="enable-storage-logging-programmatically"></a>Включить журнал хранения программно  

 Помимо использования портала Azure или cmdlets Azure PowerShell для управления журналами хранения данных, можно также использовать один из AAP-систем хранения данных Azure. Например, если используется язык .NET, можно использовать клиентскую библиотеку хранилища.  

 Классы **CloudBlobClient**, **CloudQueueClient** и **CloudTableClient** имеют такие методы как **SetServiceProperties** и **SetServicePropertiesAsync**, в которых объект **ServiceProperties** используется как параметр. Объект **ServiceProperties** может использоваться для настройки ведения журнала хранилища. Например, следующий фрагмент кода C# показывает, как настроить занесение тех или иных данных в журнал и задать период хранения для журнала очереди:  

```csharp
var storageAccount = CloudStorageAccount.Parse(connStr);  
var queueClient = storageAccount.CreateCloudQueueClient();  
var serviceProperties = queueClient.GetServiceProperties();  

serviceProperties.Logging.LoggingOperations = LoggingOperations.All;  
serviceProperties.Logging.RetentionDays = 2;  

queueClient.SetServiceProperties(serviceProperties);  
```  

 Для получения дополнительной информации об использовании языка .NET для настройки журналов хранения [данных](https://msdn.microsoft.com/library/azure/dn261237.aspx)см.  

 Для получения общей информации о настройке журналов хранения с помощью REST API [см. Включение и настройка аналитики хранения.](https://msdn.microsoft.com/library/azure/hh360996.aspx)  

## <a name="download-storage-logging-log-data"></a>Скачать данные журнала журнала журнала хранения

 Для просмотра и анализа данных журнала необходимо загрузить blob-объекты, содержащие требуемые данные журнала, на локальный компьютер. Многие инструменты для просмотра хранилищ позволяют загружать капли из учетной записи хранилища; Вы также можете использовать команду Azure Storage, предоставленную командной строкой Azure Copy Tool [AzCopy,](storage-use-azcopy-v10.md) для загрузки данных журнала.  
 
>[!NOTE]
> Контейнер `$logs` не интегрирован с Event Grid, поэтому вы не будете получать уведомления при написании файлов журнала. 

 Чтобы загрузить только требуемые данные и избежать повторной загрузки тех же данных журнала, сделайте следующее.  

-   Примените соглашение об именовании по дате и времени к blob-объектам, чтобы отслеживать, какие из них уже были загружены для анализа и предотвратить повторную загрузку данных.  

-   С помощью метаданных о blob-объектах, содержащих данные журнала, можно определить конкретный период, которому соответствуют содержащиеся в blob-объекте данные журнала. Это позволяет найти требуемый blob-объект.  

Чтобы начать работу с AzCopy, [см.](storage-use-azcopy-v10.md) 

Следующий пример показывает, каким образом можно загрузить данные журнала для службы очереди, время начала которых соответствует 9:00, 10:00 и 11:00 20 мая 2014 г.

```
azcopy copy 'https://mystorageaccount.blob.core.windows.net/$logs/queue' 'C:\Logs\Storage' --include-path '2014/05/20/09;2014/05/20/10;2014/05/20/11' --recursive
```

Чтобы узнать больше о том, как загрузить определенные файлы, [см.](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy-blobs?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#download-specific-files)

После загрузки данных журнала можно просматривать записи журнала в файлах.  В этих файлах журнала используется формат делимитированного текста, который могут анализировать многие инструменты чтения журналов, включая Microsoft Message Analyzer (для получения дополнительной информации см. руководство [по мониторингу, диагностике и устранению проблем Microsoft Azure Storage).](storage-monitoring-diagnosing-troubleshooting.md) Такие средства предоставляют различные возможности форматирования, фильтрации, сортировки и поиска содержимого файлов журнала. Для получения дополнительной информации о формате и содержимом [Storage Analytics Logged Operations and Status Messages](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages)файлов журнала «Регистратор журналов» [см.](/rest/api/storageservices/storage-analytics-log-format)

## <a name="next-steps"></a>Дальнейшие действия

* [Формат журналов аналитик хранилища](/rest/api/storageservices/storage-analytics-log-format)
* [Операции с протоколированием и сообщения о состоянии аналитик хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages)
* [Показатели аналитики хранения данных (классические)](storage-analytics-metrics.md)
