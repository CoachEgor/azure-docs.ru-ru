---
title: Копирование или перемещение данных в службу хранилища Azure с помощью AzCopy V10 | Документация Майкрософт
description: AzCopy — это служебная программа командной строки, которую можно использовать для копирования данных в учетные записи хранения, из или между ними. Эта статья поможет вам скачать AzCopy, подключиться к учетной записи хранения, а затем передавать файлы.
author: normesta
ms.service: storage
ms.topic: conceptual
ms.date: 10/23/2019
ms.author: normesta
ms.subservice: common
ms.openlocfilehash: c4e2681121a15e0b84a11c7cf35119c3f1b69f11
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75443726"
---
# <a name="get-started-with-azcopy"></a>Начало работы с AzCopy

AzCopy — это служебная программа командной строки, которую можно использовать для копирования больших двоичных объектов или файлов в учетную запись хранения или из нее. Эта статья поможет вам скачать AzCopy, подключиться к учетной записи хранения, а затем передавать файлы.

> [!NOTE]
> AzCopy **V10** — это Текущая поддерживаемая версия AzCopy.
>
> Если вам нужно использовать AzCopy **v 8.1**, см. раздел [Использование предыдущей версии AzCopy](#previous-version) этой статьи.

<a id="download-and-install-azcopy" />

## <a name="download-azcopy"></a>Скачивание AzCopy

Сначала скачайте исполняемый файл AzCopy V10 в любой каталог на компьютере. AzCopy V10 — это просто исполняемый файл, поэтому установка не требуется.

- [Windows 64-bit](https://aka.ms/downloadazcopy-v10-windows) (ZIP)
- [Windows 32-bit](https://aka.ms/downloadazcopy-v10-windows-32bit) (ZIP)
- [Linux](https://aka.ms/downloadazcopy-v10-linux) (TAR-файл)
- [MacOS](https://aka.ms/downloadazcopy-v10-mac) (ZIP-файл)

Эти файлы сжимаются как ZIP-файл (Windows и Mac) или tar-файл (Linux). Чтобы скачать и распаковать TAR файл в Linux, см. документацию по дистрибутиву Linux.

> [!NOTE]
> Если вы хотите копировать данные в службу [хранилища таблиц Azure](https://docs.microsoft.com/azure/storage/tables/table-storage-overview) и из нее, установите [AzCopy версии 7,3](https://aka.ms/downloadazcopynet).


## <a name="run-azcopy"></a>Запустить AzCopy

Для удобства рекомендуется добавить расположение исполняемого файла AzCopy в системный путь для простоты использования. Таким образом можно ввести `azcopy` из любого каталога в системе.

Если вы решили не добавлять каталог AzCopy в путь, необходимо будет изменить каталоги на расположение исполняемого файла AzCopy и ввести `azcopy` или `.\azcopy` в командных запросах Windows PowerShell.

Чтобы просмотреть список команд, введите `azcopy -h` и нажмите клавишу ВВОД.

Чтобы узнать об определенной команде, просто включите имя команды (например: `azcopy list -h`).

![Встроенная справка](media/storage-use-azcopy-v10/azcopy-inline-help.png)

Подробную справочную документацию по каждой команде и параметру команды см. в разделе [azcopy](storage-ref-azcopy.md)

> [!NOTE] 
> Как владелец учетной записи хранения Azure, вы не назначаете разрешения на доступ к данным автоматически. Прежде чем выполнять какие-либо осмысленные действия с AzCopy, необходимо решить, как вы будете предоставлять учетные данные авторизации для службы хранилища. 

## <a name="choose-how-youll-provide-authorization-credentials"></a>Выбор порядка предоставления учетных данных для авторизации

Учетные данные авторизации можно указать с помощью Azure Active Directory (AD) или с помощью маркера подписанного URL-адрес (SAS).

Используйте эту таблицу в качестве рекомендации:

| Тип хранилища | Текущий поддерживаемый метод авторизации |
|--|--|
|**Хранилище BLOB-объектов** | SAS & Azure AD |
|**Хранилище BLOB-объектов (иерархическое пространство имен)** | SAS & Azure AD |
|**Хранилище файлов** | Только SAS |

### <a name="option-1-use-azure-active-directory"></a>Вариант 1. Использование Azure Active Directory

С помощью Azure Active Directory можно указать учетные данные один раз вместо того, чтобы добавлять маркер SAS к каждой команде.  

> [!NOTE]
> В текущем выпуске, если вы планируете копировать большие двоичные объекты между учетными записями хранения, необходимо добавить маркер SAS к каждому исходному URL-адресу. Маркер SAS можно опустить только из URL-адреса назначения. Примеры см. в разделе [копирование больших двоичных объектов между учетными записями хранения](storage-use-azcopy-blobs.md).

Необходимый уровень авторизации зависит от того, планируется ли отправка файлов или просто их загрузка.

Если вы хотите просто скачать файлы, убедитесь, что [модуль чтения данных BLOB-объекта хранилища](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-reader) назначен вашему удостоверению пользователя, управляемому удостоверению или субъекту-службе.

> Удостоверения пользователей, управляемые удостоверения и субъекты-службы относятся к каждому типу *субъектов безопасности*, поэтому мы будем использовать термин « *субъект безопасности* » в оставшейся части этой статьи.

Если вы хотите передать файлы, убедитесь, что участнику безопасности назначена одна из этих ролей:

- [участник данных BLOB-объектов хранилища](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-queue-data-contributor);
- [владелец данных BLOB-объектов хранилища](https://docs.microsoft.com/azure/role-based-access-control/built-in-roles#storage-blob-data-owner);

Эти роли могут быть назначены субъекту безопасности в любой из этих областей:

- Контейнер (файловая система)
- Учетная запись хранения
- Группа ресурсов
- Subscription

Сведения о проверке и назначении ролей см. [в разделе Предоставление доступа к данным BLOB-объектов и очередей Azure с помощью RBAC в портал Azure](https://docs.microsoft.com/azure/storage/common/storage-auth-aad-rbac-portal?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

> [!NOTE]
> Помните, что для распространения назначения ролей RBAC может потребоваться до пяти минут.

Если субъект безопасности добавлен в список управления доступом (ACL) целевого контейнера или каталога, вам не нужно назначать одну из этих ролей субъекту безопасности. В списке управления доступом субъекту безопасности необходимо разрешение на запись в целевой каталог и разрешение EXECUTE для контейнера и каждого родительского каталога.

Дополнительные сведения см. [в разделе Контроль доступа в Azure Data Lake Storage 2-го поколения](https://docs.microsoft.com/azure/storage/blobs/data-lake-storage-access-control).

#### <a name="authenticate-a-user-identity"></a>Проверка подлинности удостоверения пользователя

Убедившись, что удостоверению пользователя предоставлен необходимый уровень авторизации, откройте командную строку, введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login
```

Если вы принадлежите к нескольким организациям, включите идентификатор клиента, к которому принадлежит учетная запись хранения.

```azcopy
azcopy login --tenant-id=<tenant-id>
```

Замените заполнитель `<tenant-id>` ИДЕНТИФИКАТОРом клиента организации, к которой принадлежит учетная запись хранения. Чтобы найти идентификатор клиента, выберите **Azure Active Directory > свойства > идентификатор каталога** в портал Azure.

Эта команда возвращает код проверки подлинности и URL-адрес веб-сайта. Откройте веб-сайт, укажите код и нажмите кнопку **Далее**.

![Создание контейнера](media/storage-use-azcopy-v10/azcopy-login.png)

Откроется окно входа. В этом окне войдите в свою учетную запись Azure с помощью соответствующих данных. Выполнив вход, можно закрыть окно браузера и начать работу с AzCopy.

<a id="service-principal" />

#### <a name="authenticate-a-service-principal"></a>Проверка подлинности субъекта-службы

Это отличный вариант, если вы планируете использовать AzCopy внутри сценария, который выполняется без взаимодействия с пользователем, особенно при работе в локальной среде. Если вы планируете запускать AzCopy на виртуальных машинах, работающих в Azure, управляемое удостоверение службы проще администрировать. Дополнительные сведения см. в разделе [Проверка подлинности управляемого удостоверения](#managed-identity) этой статьи.

Перед запуском скрипта необходимо войти в интерактивный режиме по крайней мере один раз, чтобы вы могли предоставить AzCopy с учетными данными субъекта-службы.  Эти учетные данные хранятся в защищенном и зашифрованном файле, поэтому сценарий не должен предоставлять эти конфиденциальные сведения.

Вы можете войти в свою учетную запись с помощью секрета клиента или пароля сертификата, связанного с регистрацией приложения субъекта-службы.

Дополнительные сведения о создании субъекта-службы см. в статье [как использовать портал для создания приложения Azure AD и субъекта-службы, которые могут получать доступ к ресурсам](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal).

Дополнительные сведения о субъектах-службах см. в разделе [объекты приложения и субъекта-службы в Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals)

##### <a name="using-a-client-secret"></a>Использование секрета клиента

Начните с установки переменной среды `AZCOPY_SPA_CLIENT_SECRET` в секрет клиента регистрации приложения субъекта-службы.

> [!NOTE]
> Обязательно задайте это значение в командной строке, а не в параметрах переменной среды операционной системы. Таким образом, значение будет доступно только текущему сеансу.

В этом примере показано, как это можно сделать в PowerShell.

```azcopy
$env:AZCOPY_SPA_CLIENT_SECRET="$(Read-Host -prompt "Enter key")"
```

> [!NOTE]
> Рассмотрите возможность использования запроса, как показано в этом примере. В этом случае ваш пароль не будет отображаться в журнале команд консоли.  

Затем введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login --service-principal --application-id <application-id> --tenant-id=<tenant-id>
```

Замените заполнитель `<application-id>` ИДЕНТИФИКАТОРом приложения для регистрации приложения субъекта-службы. Замените заполнитель `<tenant-id>` ИДЕНТИФИКАТОРом клиента организации, к которой принадлежит учетная запись хранения. Чтобы найти идентификатор клиента, выберите **Azure Active Directory > свойства > идентификатор каталога** в портал Azure. 

##### <a name="using-a-certificate"></a>Использование сертификата

Если вы предпочитаете использовать собственные учетные данные для авторизации, вы можете отправить сертификат в регистрацию приложения, а затем использовать этот сертификат для входа.

Кроме отправки сертификата в регистрацию приложения, вам также потребуется копия сертификата, сохраненная на компьютере или виртуальной машине, где будет выполняться AzCopy. Эта копия сертификата должна быть в. PFX или. Формат PEM и должен включать закрытый ключ. Закрытый ключ должен быть защищен паролем. Если вы используете Windows и ваш сертификат существует только в хранилище сертификатов, обязательно экспортируйте этот сертификат в PFX-файл (включая закрытый ключ). Инструкции см. в разделе [Export-PfxCertificate](https://docs.microsoft.com/powershell/module/pkiclient/export-pfxcertificate?view=win10-ps) .

Затем задайте для переменной среды `AZCOPY_SPA_CERT_PASSWORD` пароль сертификата.

> [!NOTE]
> Обязательно задайте это значение в командной строке, а не в параметрах переменной среды операционной системы. Таким образом, значение будет доступно только текущему сеансу.

В этом примере показано, как можно выполнить эту задачу в PowerShell.

```azcopy
$env:AZCOPY_SPA_CERT_PASSWORD="$(Read-Host -prompt "Enter key")"
```

Затем введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login --service-principal --certificate-path <path-to-certificate-file> --tenant-id=<tenant-id>
```

Замените заполнитель `<path-to-certificate-file>` относительным или полным путем к файлу сертификата. AzCopy сохраняет путь к этому сертификату, но не сохраняет копию сертификата, поэтому обязательно сохраните этот сертификат на месте. Замените заполнитель `<tenant-id>` ИДЕНТИФИКАТОРом клиента организации, к которой принадлежит учетная запись хранения. Чтобы найти идентификатор клиента, выберите **Azure Active Directory > свойства > идентификатор каталога** в портал Azure.

> [!NOTE]
> Рассмотрите возможность использования запроса, как показано в этом примере. В этом случае ваш пароль не будет отображаться в журнале команд консоли. 

<a id="managed-identity" />

#### <a name="authenticate-a-managed-identity"></a>Проверка подлинности управляемого удостоверения

Это отличный вариант, если вы планируете использовать AzCopy внутри сценария, который выполняется без участия пользователя, и сценарий выполняется из виртуальной машины Azure. При использовании этого параметра не нужно хранить учетные данные на виртуальной машине.

Вы можете войти в свою учетную запись с помощью управляемого удостоверения на уровне системы, которое вы включили на виртуальной машине, или с помощью идентификатора клиента, идентификатора объекта или идентификатора ресурса назначенного пользователю управляемого удостоверения, назначенного вашей виртуальной машине.

Дополнительные сведения о том, как включить управляемое удостоверение для всей системы или создать управляемое пользователем удостоверение, см. в статье [Настройка управляемых удостоверений для ресурсов Azure на виртуальной машине с помощью портал Azure](../../active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm.md#enable-system-assigned-managed-identity-on-an-existing-vm).

##### <a name="using-a-system-wide-managed-identity"></a>Использование управляемого удостоверения на уровне системы

Во-первых, убедитесь, что вы включили управляемое удостоверение на уровне системы на виртуальной машине. См. раздел [управляемое системой удостоверение](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#system-assigned-managed-identity).

Затем в командной консоли введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login --identity
```

##### <a name="using-a-user-assigned-managed-identity"></a>Использование управляемого удостоверения, назначенного пользователем

Во-первых, убедитесь, что на виртуальной машине вы включили управляемое удостоверение, назначенное пользователем. См. раздел [назначенное пользователем управляемое удостоверение](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#user-assigned-managed-identity).

Затем в командной консоли введите любую из следующих команд и нажмите клавишу ВВОД.

```azcopy
azcopy login --identity --identity-client-id "<client-id>"
```

Замените заполнитель `<client-id>` ИДЕНТИФИКАТОРом клиента управляемого удостоверения, назначенного пользователем.

```azcopy
azcopy login --identity --identity-object-id "<object-id>"
```

Замените заполнитель `<object-id>` ИДЕНТИФИКАТОРом объекта управляемого удостоверения, назначаемого пользователем.

```azcopy
azcopy login --identity --identity-resource-id "<resource-id>"
```

Замените заполнитель `<resource-id>` ИДЕНТИФИКАТОРом ресурса управляемого удостоверения, назначаемого пользователем.

### <a name="option-2-use-a-sas-token"></a>Вариант 2. Использование токена SAS

Маркер SAS можно добавить к каждому URL-адресу источника или назначения, который используется в командах AzCopy.

В этом примере команда рекурсивно копирует данные из локального каталога в контейнер больших двоичных объектов. Вымышленный маркер SAS добавляется в конец URL-адреса контейнера.

```azcopy
azcopy copy "C:\local\path" "https://account.blob.core.windows.net/mycontainer1/?sv=2018-03-28&ss=bjqt&srt=sco&sp=rwddgcup&se=2019-05-01T05:01:17Z&st=2019-04-30T21:01:17Z&spr=https&sig=MGCXiyEzbtttkr3ewJIh2AR8KrghSy1DGM9ovN734bQF4%3D" --recursive=true
```

Дополнительные сведения о маркерах SAS и их получении см. в разделе [использование подписанных URL-адресов (SAS)](https://docs.microsoft.com/azure/storage/common/storage-sas-overview).

## <a name="transfer-files"></a>Перенос файлов

После проверки подлинности удостоверения или получения маркера SAS можно начать передачу файлов.

Примеры команд см. в любой из этих статей.

- [Transfer data with AzCopy and blob storage](storage-use-azcopy-blobs.md) (Передача данных с помощью AzCopy и хранилища BLOB-объектов)

- [Transfer data with AzCopy and file storage](storage-use-azcopy-files.md) (Передача данных с помощью AzCopy и хранилища файлов)

- [Передача данных с помощью AzCopy и контейнеров Amazon S3](storage-use-azcopy-s3.md)

- [Перенос данных с помощью AzCopy и хранилища Azure Stack](https://docs.microsoft.com/azure-stack/user/azure-stack-storage-transfer#azcopy)

## <a name="use-azcopy-in-a-script"></a>Использование AzCopy в скрипте

### <a name="obtain-a-static-download-link"></a>Получение статической ссылки для скачивания

Со временем [ссылка для скачивания](#download-and-install-azcopy) AzCopy будет указывать на новые версии AzCopy. Если сценарий скачивает AzCopy, скрипт может перестать работать, если более новая версия AzCopy изменяет функции, от которых зависит сценарий.

Чтобы избежать этих проблем, получите статическую (неизменную) ссылку на текущую версию AzCopy. Таким образом, ваш сценарий скачивает одну и ту же версию AzCopy при каждом запуске.

Чтобы получить ссылку, выполните следующую команду:

| Операционная система  | Get-Help |
|--------|-----------|
| **Linux** | `curl -v https://aka.ms/downloadazcopy-v10-linux` |
| **Windows** | `(curl https://aka.ms/downloadazcopy-v10-windows -MaximumRedirection 0 -ErrorAction silentlycontinue).RawContent` |

> [!NOTE]
> Для Linux `--strip-components=1` в команде `tar` удаляет папку верхнего уровня, содержащую имя версии, и вместо этого извлекает двоичный файл непосредственно в текущую папку. Это позволяет обновлять скрипт с новой версией `azcopy`, обновляя только URL-адрес `wget`.

URL-адрес отображается в выходных данных этой команды. Затем скрипт может скачать AzCopy с помощью этого URL-адреса.

| Операционная система  | Get-Help |
|--------|-----------|
| **Linux** | `wget -O azcopy_v10.tar.gz https://aka.ms/downloadazcopy-v10-linux && tar -xf azcopy_v10.tar.gz --strip-components=1` |
| **Windows** | `Invoke-WebRequest https://azcopyvnext.azureedge.net/release20190517/azcopy_windows_amd64_10.1.2.zip -OutFile azcopyv10.zip <<Unzip here>>` |

### <a name="escape-special-characters-in-sas-tokens"></a>Экранирование специальных символов в маркерах SAS

В пакетных файлах с расширением `.cmd` необходимо экранировать `%` символы, отображаемые в маркерах SAS. Это можно сделать, добавив символ добавления `%` рядом с существующими `%` символами в строке токена SAS.

### <a name="run-scripts-by-using-jenkins"></a>Выполнение скриптов с помощью Jenkins

Если вы планируете использовать [Jenkins](https://jenkins.io/) для выполнения скриптов, убедитесь, что в начале скрипта размещена следующая команда.

```
/usr/bin/keyctl new_session
```

## <a name="use-azcopy-in-azure-storage-explorer"></a>Использование AzCopy в Обозреватель службы хранилища Azure

[Обозреватель службы хранилища](https://azure.microsoft.com/features/storage-explorer/) использует AzCopy для выполнения всех операций по переносу данных. Вы можете использовать [Обозреватель службы хранилища](https://azure.microsoft.com/features/storage-explorer/) , если хотите использовать преимущества производительности AzCopy, но вместо командной строки вы предпочитаете работать с файлами с помощью графического пользовательского интерфейса.

Обозреватель службы хранилища использует ключ учетной записи для выполнения операций, поэтому после входа в Обозреватель службы хранилища вам не потребуется предоставлять дополнительные учетные данные для авторизации.

<a id="previous-version" />

## <a name="use-the-previous-version-of-azcopy"></a>Использовать предыдущую версию AzCopy

Если вам нужно использовать предыдущую версию AzCopy (AzCopy версии 8.1), см. одну из следующих ссылок:

- [AzCopy в Windows (V8)](https://docs.microsoft.com/previous-versions/azure/storage/storage-use-azcopy)

- [AzCopy в Linux (V8)](https://docs.microsoft.com/previous-versions/azure/storage/storage-use-azcopy-linux)

## <a name="configure-optimize-and-troubleshoot-azcopy"></a>Настройка, оптимизация и устранение неполадок AzCopy

См. раздел [Настройка, оптимизация и устранение неполадок AzCopy](storage-use-azcopy-configure.md)

## <a name="next-steps"></a>Дальнейшие действия

Если у вас есть вопросы, проблемы или общие отзывы, отправьте их [на страницу GitHub](https://github.com/Azure/azure-storage-azcopy) .
