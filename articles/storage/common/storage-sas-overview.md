---
title: Грант ограниченный доступ к данным с общими подписями доступа (SAS)
titleSuffix: Azure Storage
description: Узнайте об использовании общих подписей доступа (SAS) для делегирования доступа к ресурсам хранения Azure, включая капли, очереди, таблицы и файлы.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 12/18/2019
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: 7a5967f52a187fe289c6fb1ca72af2d5fd17f010
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79255240"
---
# <a name="grant-limited-access-to-azure-storage-resources-using-shared-access-signatures-sas"></a>Предоставляетограниченный доступ к ресурсам хранения Azure с помощью общих подписей доступа (SAS)

Общая подпись доступа (SAS) обеспечивает безопасный делегированный доступ к ресурсам в учетной записи хранения без ущерба для безопасности ваших данных. С помощью SAS у вас есть детальный контроль над тем, как клиент может получить доступ к вашим данным. Вы можете контролировать, к каким ресурсам клиент может получить доступ, какие разрешения у него есть на этих ресурсах, и как долго SAS действителен, среди других параметров.

## <a name="types-of-shared-access-signatures"></a>Типы подписанных URL-адресов

Azure Storage поддерживает три типа общих подписей доступа:

- **Делегация пользователя SAS.** Делегация пользователей SAS защищена учетными данными Active Directory (Azure AD), а также разрешениями, указанными для SAS. Делегация пользователя SAS применяется только к хранению Blob.

    Для получения дополнительной информации о делегации пользователя SAS [см.](/rest/api/storageservices/create-user-delegation-sas)

- **SAS службы.** Служба SAS защищена ключом учетной записи хранилища. Служба SAS делегирует доступ к ресурсу только в одном из служб хранения Azure: хранилище Blob, хранилище очередей, хранилище таблиц ы или файлы Azure. 

    Для получения дополнительной информации об услуге SAS [см.](/rest/api/storageservices/create-service-sas)

- **SAS учетной записи.** Учетная запись SAS защищена ключом учетной записи хранилища. SAS учетной записи делегирует доступ к ресурсам в одной или нескольких службах хранилища. Все операции, доступные через службу или делегацию пользователей SAS, также доступны через учетную запись SAS. Кроме того, с помощью учетной записи SAS можно делегировать доступ к операциям, которые применяются на уровне службы, таким как **Get/Set Service Properties** и **Get Service Stats.** Вы также можете делегировать доступ к операциям чтения, записи и удаления в контейнерах больших двоичных объектов, таблицах, очередях и общих папках, которые запрещены в SAS службы. 

    Для получения дополнительной информации об учетной записи SAS [создайте учетную запись SAS (REST API).](/rest/api/storageservices/create-account-sas)

> [!NOTE]
> Корпорация Майкрософт рекомендует использовать по возможности учетные данные Azure AD в качестве наилучшей практики безопасности, а не использовать ключ учетной записи, который может быть более легко скомпрометирован. Когда для разработки приложения требуется общее количество подписей доступа для доступа к хранилищу Blob, используйте учетные данные Azure AD для создания SAS представительства пользователя, когда это возможно для обеспечения повышенной безопасности.

Подпись общего доступа может принимать одну из двух форм:

- **Специальные SAS:** При создании специального SAS время начала, время истечения срока действия и разрешения для SAS указаны в SAS URI (или подразумевается, если время начала опущено). Любой тип SAS может быть специальной SAS.
- **Служба SAS с сохраненной политикой доступа:** Политика сохраненного доступа определяется в контейнере ресурсов, который может быть контейнером с каплями, таблицей, очередью или долей файла. Политика сохраненного доступа может использоваться для управления ограничениями для одной или нескольких подписей общего доступа службы. При связывании службы SAS с сохраненной политикой&mdash;доступа SAS наследует ограничения времени&mdash;начала, времени истечения срока действия и разрешения, определенные для политики сохраненного доступа.

> [!NOTE]
> Делегация пользователя SAS или учетная запись SAS должны быть специальной SAS. Политики доступа сохранены не поддерживаются для делегации пользователя SAS или учетной записи SAS.

## <a name="how-a-shared-access-signature-works"></a>Принцип работы подписанного URL-адреса

Подписанный URL-адрес — это подписанный URI, который указывает на один или несколько ресурсов хранилища и содержит маркер с особым набором параметров запроса. Маркер определяет способы доступа к ресурсам, предоставляемые клиенту. Один из параметров запроса, подпись, построен из параметров SAS и подписан ключом, который использовался для создания SAS. Эта подпись используется в службе хранилища Azure для авторизации доступа к ресурсу хранилища.

### <a name="sas-signature"></a>Подпись SAS

Вы можете подписать SAS одним из двух способов:

- С *ключом делегирования пользователей,* созданным с помощью учетных данных Azure Active Directory (Azure AD). Делегация пользователя SAS подписывается ключом делегации пользователя.

    Чтобы получить ключ делегации пользователя и создать SAS, директору безопасности Azure AD необходимо назначить роль управления доступом на основе ролей (RBAC), которая включает в себя действия **Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKey.** Подробную информацию о роли RBAC с разрешениями на получение ключа делегации пользователя можно получить, [см.](/rest/api/storageservices/create-user-delegation-sas)

- С ключом учетной записи хранилища. Как служба SAS, так и учетная запись SAS подписаны ключом учетной записи хранилища. Чтобы создать SAS, который подписан ключом учетной записи, приложение должно иметь доступ к ключу учетной записи.

### <a name="sas-token"></a>Токен SAS

Токен SAS — это строка, которую вы создаете на стороне клиента, например, используя одну из клиентских библиотек Хранения Azure. Токен SAS никоим образом не отслеживается Хранилищем Azure. На стороне клиента можно создать неограниченное число маркеров SAS. После создания SAS можно распространить его среди клиентских приложений, которым необходим доступ к ресурсам в учетной записи хранилища.

Когда клиентское приложение предоставляет SAS URI в Хранилище Azure в рамках запроса, служба проверяет параметры SAS и подпись, чтобы убедиться, что он действителен для авторизации запроса. Если служба подтверждает эту подпись, выполнение запроса разрешается. В противном случае запрос отклоняется и происходит ошибка с кодом 403 (запрещено).

Вот пример службы SAS URI, отображающей ресурс URI и токен SAS:

![Компоненты сервиса SAS URI](./media/storage-sas-overview/sas-storage-uri.png)

## <a name="when-to-use-a-shared-access-signature"></a>Когда использовать общую подпись доступа

Используйте SAS, когда вы хотите обеспечить безопасный доступ к ресурсам в вашей учетной записи хранения для любого клиента, который в противном случае не имеет разрешений на эти ресурсы.

Распространенным сценарием использования подписей общего доступа является служба, где пользователи считывают и записывают собственные данные в вашей учетной записи хранения. В сценарии, где в учетной записи хранения хранятся пользовательские данные, существует два направления разработки:

1. Клиенты отправляют и скачивают данные с помощью службы интерфейсного прокси-сервера, выполняющей аутентификацию. Эта служба интерфейсного прокси-сервера позволяет проверять бизнес-правила, однако для больших объемов данных или крупных транзакций создание службы, поддерживающей масштабирование в соответствии с потребностями, может оказаться дорогостоящей или сложной задачей.

   ![Схема сценария. Служба интерфейсного прокси-сервера](./media/storage-sas-overview/sas-storage-fe-proxy-service.png)

1. Облегченная служба аутентифицирует клиент по мере необходимости, а затем создает SAS. Как только клиентское приложение получает SAS, они могут получить доступ к ресурсам учетной записи хранилища непосредственно с разрешениями, определенными SAS и для интервала, разрешенного SAS. Подпись общего доступа уменьшает потребность в маршрутизации всех данных через службу интерфейсного прокси-сервера.

   ![Схема сценария. Служба поставщика SAS](./media/storage-sas-overview/sas-storage-provider-service.png)

Многие реальные службы могут использовать сочетание этих двух подходов. Например, некоторые данные обрабатываются и проверяются через интерфейсный прокси-сервер, а другие данные сохраняются и (или) считываются непосредственно с помощью SAS.

Кроме того, SAS требуется для авторизации доступа к исходной объекту в операции копирования в определенных сценариях:

- При копировании большого двоичного объекта в другой большой двоичный объект, который относится к другой учетной записи хранения, необходимо использовать SAS для авторизации доступа к исходному большому двоичному объекту. По желанию вы можете использовать SAS еще и для авторизации доступа к конечному большому двоичному объекту.
- При копировании файла в другой файл, который относится к другой учетной записи хранения, необходимо использовать SAS для авторизации доступа к исходному файлу. По желанию вы можете использовать SAS еще и для авторизации доступа к конечному файлу.
- При копировании большого двоичного объекта в файл или файла в большой двоичный объект, необходимо использовать SAS для авторизации доступа к исходному объекту, даже если исходный и конечный объекты относятся к одной и той же учетной записи хранения.

## <a name="best-practices-when-using-sas"></a>Рекомендации по использованию SAS

При использовании подписей общего доступа в приложениях необходимо иметь в виду две потенциальные проблемы:

- В случае утечки подписи ей сможет пользоваться любой человек, что потенциально может нарушить безопасность вашей учетной записи хранения.
- Если срок действия подписи, предоставленной клиентскому приложению, истекает и приложение не может получить новую подпись из вашей службы, это может нарушить работу приложения.

Следующие рекомендации по использованию подписанных URL-адресов помогут нейтрализовать эти риски:

- **Всегда используйте HTTPS** для создания подписанного URL-адреса или его распространения. Если SAS передается по протоколу HTTP и перехватывается, посредством атак "злоумышленник в середине" злоумышленник сможет считать SAS и затем использовать его вместо предполагаемого пользователя, что может привести к раскрытию конфиденциальных данных или к повреждению данных злоумышленником.
- **По возможности используйте делегацию пользователей SAS.** Делегация пользователя SAS обеспечивает превосходную безопасность службы SAS или учетной записи SAS. Делегация пользователя SAS защищена учетными данными Azure AD, так что вам не нужно хранить ключ учетной записи с кодом.
- **Иметь план отзыва для SAS.** Убедитесь, что вы готовы ответить, если SAS скомпрометирован.
- **Определите политику сохраненного доступа для службы SAS.** Политики доступа, сохраненные, дают вам возможность отозвать разрешения для службы SAS без необходимости регенерации ключей учетной записи хранилища. Задайте для них очень большой (или бесконечный) срок действия и убедитесь, что он регулярно переносится на будущее время.
- **Используйте краткосрочное время истечения срока действия в специальном сервисе SAS или учетной записи SAS.** Таким образом, даже если SAS скомпрометирован, он будет действителен только в течение короткого времени. Это особенно важно в случаях, когда нельзя ссылаться на хранимую политику доступа. Небольшой срок также позволяет ограничить объем данных, который может быть записан в большой двоичный объект, путем ограничения времени на отправку этих данных.
- **Запрограммируйте автоматическое обновление подписи клиентами при необходимости.** Клиенты должны обновлять SAS задолго до окончания его срока действия, чтобы оставить время для повторных попыток в случае недоступности службы, предоставляющей SAS. Если SAS будет использоваться для небольшого числа кратковременных операций, которые должны быть завершены в течение заданного периода действия, такая мера может оказаться лишней, так как обновление SAS не предусматривается. Однако если имеется клиент, регулярно выполняющий запросы через подпись, то возможность истечения срока действия следует принять во внимание. Рекомендуется сбалансировать требование к кратковременности использования подписи (как указано ранее) с требованием того, чтобы клиент запрашивал обновление достаточно рано во избежание проблем, связанных с истечением срока действия SAS до завершения обновления.
- **Будьте осторожны со временем начала действия SAS.** Если задать для времени начала действия SAS значение **now**, то из-за разницы во времени (разницы в текущем времени на разных компьютерах) могут наблюдаться периодические сбои в течение первых нескольких минут. В общем, устанавливайте время начала действия на 15 минут или более в прошлом времени. Или не задавайте вообще. Так SAS будет немедленно становиться действительным во всех случаях. То же касается и времени истечения срока действия. Помните, что для каждого запроса может наблюдаться рассинхронизация по времени до 15 минут в любом направлении. Для клиентов, использующих версию REST, предшествующую версии 2012-02-12, максимальный срок действия SAS, который не ссылается на хранимую политику, составляет 1 час, а все политики, где указано большее время, вызовут сбой.
- **Будьте осторожны с форматом SAS datetime.** Если вы установите время начала и/или истечение срока действия SAS, для некоторых утилит (например, для утилиты командной строки AzCopy) вам нужен формат времени датирования, который будет '%Y-%m-%dT%H:%M:%S', в частности, включая секунды для того, чтобы работать с помощью токена SAS.  
- **Четко указывайте ресурс, к которому осуществляется доступ.** Из соображений безопасности рекомендуется предоставить пользователю минимально необходимый набор прав. Если пользователю требуется только доступ для чтения к отдельной сущности, предоставьте доступ на чтение к этой сущности, а не доступ на чтение, запись и удаление для всех сущностей. Это также позволяет уменьшить ущерб, если SAS скомпрометирован, так как такой SAS предоставляет меньше возможностей злоумышленнику.
- **Поймите, что ваша учетная запись будет выставлен счет за любое использование, в том числе через SAS.** Если вы предоставляете доступ к записи капли, пользователь может загрузить 200 ГБ капли. Если вы также предоставляете доступ на чтение, пользователь может скачать его 10 раз, в результате чего вам потребуется оплачивать исходящий трафик объемом 2 ТБ. Опять же, ограниченные разрешения помогают сузить спектр возможностей злоумышленников. Используйте краткосрочные подписи, чтобы снизить угрозу (но помните о влиянии рассинхронизации часов на время окончания действия).
- **Проверка данных, написанных с помощью SAS.**  Когда клиентское приложение записывает данные в вашу учетную запись хранения, помните, что эти данные могут стать источником проблем. Если приложение требует проверять достоверность или подлинность этих данных перед использованием, такую проверку следует выполнять после записи данных и перед их использованием в приложении. Такой подход также обеспечивает защиту от поврежденных или вредоносных данных, записываемых в вашу учетную запись как пользователем, который получил подпись правомерно, так и пользователем, использующим подпись после ее утечки.
- **Знайте, когда не использовать SAS.** Иногда риски, связанные с конкретной операцией в отношении учетной записи хранилища, перевешивают преимущества использования SAS. Для таких операций создавайте службу среднего уровня, которая записывает данные в вашу учетную запись хранения после выполнения проверки, проверки подлинности и аудита на основании бизнес-правил. Кроме того, иногда проще организовать управление доступом другим образом. Например, если вы хотите сделать все BLOB-объекты в контейнере общедоступными для чтения, вместо предоставления всем клиентам подписанного URL-адреса можно сделать этот контейнер общедоступным.
- **Для мониторинга приложения используйте журналы azure Monitor и Azure Storage.** Для наблюдения за любыми сбоями в сбоях авторизации из-за сбоя в работе службы провайдера SAS или непреднамеренного удаления политики доступа к хранилику можно использовать журналы Azure Monitor и хранения. Для получения дополнительной информации смотрите [метрики хранения Azure в](storage-metrics-in-azure-monitor.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) журнале Azure Monitor и Analytics хранения [azure.](storage-analytics-logging.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json)

## <a name="get-started-with-sas"></a>Начало работы с SAS

Для начала работы с общими подписями доступа смотрите следующие статьи для каждого типа SAS.

### <a name="user-delegation-sas"></a>Делегация пользователей SAS

- [Создание делегации пользователя SAS для контейнера или капли с Помощью PowerShell](../blobs/storage-blob-user-delegation-sas-create-powershell.md)
- [Создание делегации пользователя SAS для контейнера или капли с помощью Azure CLI](../blobs/storage-blob-user-delegation-sas-create-cli.md)
- [Создание делегации пользователя SAS для контейнера или капли с помощью .NET](../blobs/storage-blob-user-delegation-sas-create-dotnet.md)

### <a name="service-sas"></a>Сервис SAS

- [Создание сервиса SAS для контейнера или капли с помощью .NET](../blobs/storage-blob-service-sas-create-dotnet.md)

### <a name="account-sas"></a>Учетная запись SAS

- [Создание учетной записи SAS с помощью .NET](storage-account-sas-create-dotnet.md)

## <a name="next-steps"></a>Дальнейшие действия

- [Делегат доступ с общей подписью доступа (REST API)](/rest/api/storageservices/delegate-access-with-shared-access-signature)
- [Создание делегации пользователей SAS (REST API)](/rest/api/storageservices/create-user-delegation-sas)
- [Создание службы SAS (REST API)](/rest/api/storageservices/create-service-sas)
- [Создание учетной записи SAS (REST API)](/rest/api/storageservices/create-account-sas)
