---
title: Предоставление ограниченного доступа к данным с помощью подписанных URL-адресов (SAS)
titleSuffix: Azure Storage
description: Узнайте об использовании подписанных URL-адресов (SAS) для делегирования доступа к ресурсам службы хранилища Azure, включая большие двоичные объекты, очереди, таблицы и файлы.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 12/04/2019
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: e4a5f83e3f4d26c2321ed1b4c48a385d07e6489d
ms.sourcegitcommit: 8bd85510aee664d40614655d0ff714f61e6cd328
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2019
ms.locfileid: "74895156"
---
# <a name="grant-limited-access-to-azure-storage-resources-using-shared-access-signatures-sas"></a>Предоставление ограниченного доступа к ресурсам службы хранилища Azure с помощью подписанных URL-адресов (SAS)

Подписанный URL-адрес (SAS) обеспечивает безопасный делегированный доступ к ресурсам в вашей учетной записи хранения без ущерба для безопасности данных. С помощью SAS вы можете детально контролировать, как клиент может получить доступ к данным. Вы можете контролировать, к каким ресурсам клиент может получить доступ, какие разрешения они имеют на эти ресурсы и как долго они действительны, помимо других параметров.

## <a name="types-of-shared-access-signatures"></a>Типы подписанных URL-адресов

Служба хранилища Azure поддерживает три типа подписанных URL:

- **SAS делегирования пользователя (Предварительная версия).** SAS делегирования пользователя защищен с учетными данными Azure Active Directory (Azure AD), а также с разрешениями, указанными для SAS. SAS делегирования пользователя применяется только к хранилищу BLOB-объектов.

    Дополнительные сведения о сопоставлении безопасности для делегирования пользователей см. в статье [Создание SAS для делегирования пользователей (REST API)](/rest/api/storageservices/create-user-delegation-sas).

- **SAS службы.** SAS службы защищен с помощью ключа учетной записи хранения. SAS службы делегирует доступ к ресурсу только в одной из служб хранилища Azure: хранилище BLOB-объектов, хранилище очередей, хранилище таблиц или файлы Azure. 

    Дополнительные сведения об SAS службы см. в разделе [Создание SAS службы (REST API)](/rest/api/storageservices/create-service-sas).

- **SAS учетной записи.** SAS учетной записи защищен с помощью ключа учетной записи хранения. SAS учетной записи делегирует доступ к ресурсам в одной или нескольких службах хранилища. Все операции, доступные через SAS службы или делегирования пользователя, также доступны через SAS учетной записи. Кроме того, с помощью SAS учетной записи можно делегировать доступ к операциям, которые применяются на уровне службы, например **Get/Set Service Properties** и **Get Service stats** . Вы также можете делегировать доступ к операциям чтения, записи и удаления в контейнерах больших двоичных объектов, таблицах, очередях и общих папках, которые запрещены в SAS службы. 

    Чтобы получить дополнительные сведения о SAS учетной записи, [Создайте SAS учетной записи (REST API)](/rest/api/storageservices/create-account-sas).

> [!NOTE]
> Корпорация Майкрософт рекомендует использовать учетные данные Azure AD, если это возможно в целях безопасности, вместо использования ключа учетной записи, что может быть более легко скомпрометировано. Если для разработки приложения требуются подписанные URL-адрес для доступа к хранилищу BLOB-объектов, используйте учетные данные Azure AD для создания SAS делегирования пользователя, если это возможно для обеспечения высокого уровня безопасности.

Подпись общего доступа может принимать одну из двух форм:

- **Нерегламентированный SAS:** При создании нерегламентированного SAS время начала, время окончания срока действия и разрешения для SAS задаются в URI SAS (или подразумевается, если опущено время начала). Любой тип SAS может быть нерегламентированным SAS.
- **SAS службы с хранимой политикой доступа:** Хранимая политика доступа определяется в контейнере ресурсов, который может быть контейнером больших двоичных объектов, таблицей, очередью или общей папкой. Хранимую политику доступа можно использовать для управления ограничениями для одного или нескольких подписанных URL общих прав службы. При связывании SAS службы с хранимой политикой доступа SAS наследует ограничения&mdash;времени начала, времени окончания срока действия и разрешений,&mdash;определенных для хранимой политики доступа.

> [!NOTE]
> SAS для делегирования пользователей или SAS учетной записи должен быть нерегламентированным SAS. Хранимые политики доступа не поддерживаются для подписок на делегирование пользователей или SAS учетной записи.

## <a name="how-a-shared-access-signature-works"></a>Принцип работы подписанного URL-адреса

Подписанный URL-адрес — это подписанный URI, который указывает на один или несколько ресурсов хранилища и содержит маркер с особым набором параметров запроса. Маркер определяет способы доступа к ресурсам, предоставляемые клиенту. Один из параметров запроса, сигнатура, создается на основе параметров SAS и подписывается ключом, который использовался для создания SAS. Эта подпись используется в службе хранилища Azure для авторизации доступа к ресурсу хранилища.

### <a name="sas-signature"></a>Подпись SAS

Вы можете подписать SAS одним из двух способов:

- С помощью *ключа делегирования пользователя* , созданного с использованием учетных данных Azure Active Directory (Azure AD). Подписанный URL-адрес делегирования пользователя подписывается с помощью ключа делегирования пользователя.

    Чтобы получить ключ делегирования пользователя и создать SAS, участнику безопасности Azure AD должна быть назначена роль управления доступом на основе ролей (RBAC), которая включает действие **Microsoft. Storage/storageAccounts/блобсервицес/женератеусерделегатионкэй** . Подробные сведения о ролях RBAC с разрешениями на получение ключа делегирования пользователя см. в разделе [Создание SAS для делегирования пользователей (REST API)](/rest/api/storageservices/create-user-delegation-sas).

- С ключом учетной записи хранения. Как SAS службы, так и SAS учетной записи подписываются с помощью ключа учетной записи хранения. Чтобы создать SAS, подписанный с помощью ключа учетной записи, приложение должно иметь доступ к ключу учетной записи.

### <a name="sas-token"></a>Маркер SAS

Маркер SAS представляет собой строку, созданную на стороне клиента, например с помощью одной из клиентских библиотек службы хранилища Azure. По каким-либо образом служба хранилища Azure не следит за маркером SAS. На стороне клиента можно создать неограниченное число маркеров SAS. После создания SAS его можно распространить в клиентские приложения, которым требуется доступ к ресурсам в вашей учетной записи хранения.

Когда клиентское приложение предоставляет универсальный код ресурса (URI) SAS для службы хранилища Azure в рамках запроса, служба проверяет параметры и подпись SAS, чтобы убедиться, что она допустима для авторизации запроса. Если служба подтверждает эту подпись, выполнение запроса разрешается. В противном случае запрос отклоняется и происходит ошибка с кодом 403 (запрещено).

Ниже приведен пример URI-кода SAS службы, в котором показаны URI ресурса и маркер SAS:

![Компоненты URI SAS службы](./media/storage-sas-overview/sas-storage-uri.png)

## <a name="when-to-use-a-shared-access-signature"></a>Когда следует использовать подписанный URL-доступ

Используйте SAS, если вы хотите обеспечить безопасный доступ к ресурсам в вашей учетной записи хранения для любого клиента, который в противном случае не имеет разрешений для этих ресурсов.

Распространенным сценарием использования подписей общего доступа является служба, где пользователи считывают и записывают собственные данные в вашей учетной записи хранения. В сценарии, где в учетной записи хранения хранятся пользовательские данные, существует два направления разработки:

1. Клиенты отправляют и скачивают данные с помощью службы интерфейсного прокси-сервера, выполняющей аутентификацию. Эта служба интерфейсного прокси-сервера позволяет проверять бизнес-правила, однако для больших объемов данных или крупных транзакций создание службы, поддерживающей масштабирование в соответствии с потребностями, может оказаться дорогостоящей или сложной задачей.

   ![Схема сценария. Служба интерфейсного прокси-сервера](./media/storage-sas-overview/sas-storage-fe-proxy-service.png)

1. Облегченная служба аутентифицирует клиент по мере необходимости, а затем создает SAS. После того как клиентское приложение получит SAS, он сможет получить доступ к ресурсам учетной записи хранения непосредственно с разрешениями, определенными в SAS, и с интервалом, разрешенным SAS. Подпись общего доступа уменьшает потребность в маршрутизации всех данных через службу интерфейсного прокси-сервера.

   ![Схема сценария. Служба поставщика SAS](./media/storage-sas-overview/sas-storage-provider-service.png)

Многие реальные службы могут использовать сочетание этих двух подходов. Например, некоторые данные обрабатываются и проверяются через интерфейсный прокси-сервер, а другие данные сохраняются и (или) считываются непосредственно с помощью SAS.

Кроме того, SAS требуется для авторизации доступа к исходному объекту в операции копирования в определенных сценариях:

- При копировании большого двоичного объекта в другой большой двоичный объект, который относится к другой учетной записи хранения, необходимо использовать SAS для авторизации доступа к исходному большому двоичному объекту. По желанию вы можете использовать SAS еще и для авторизации доступа к конечному большому двоичному объекту.
- При копировании файла в другой файл, который относится к другой учетной записи хранения, необходимо использовать SAS для авторизации доступа к исходному файлу. По желанию вы можете использовать SAS еще и для авторизации доступа к конечному файлу.
- При копировании большого двоичного объекта в файл или файла в большой двоичный объект, необходимо использовать SAS для авторизации доступа к исходному объекту, даже если исходный и конечный объекты относятся к одной и той же учетной записи хранения.

## <a name="best-practices-when-using-sas"></a>Рекомендации по использованию SAS

При использовании подписей общего доступа в приложениях необходимо иметь в виду две потенциальные проблемы:

- В случае утечки подписи ей сможет пользоваться любой человек, что потенциально может нарушить безопасность вашей учетной записи хранения.
- Если срок действия подписи, предоставленной клиентскому приложению, истекает и приложение не может получить новую подпись из вашей службы, это может нарушить работу приложения.

Следующие рекомендации по использованию подписанных URL-адресов помогут нейтрализовать эти риски:

- **Всегда используйте HTTPS** для создания подписанного URL-адреса или его распространения. Если SAS передается по протоколу HTTP и перехватывается, посредством атак "злоумышленник в середине" злоумышленник сможет считать SAS и затем использовать его вместо предполагаемого пользователя, что может привести к раскрытию конфиденциальных данных или к повреждению данных злоумышленником.
- **По возможности используйте сопоставление безопасности делегирования пользователя.** SAS для делегирования пользователей обеспечивает более высокую безопасность для SAS службы или SAS учетной записи. SAS для делегирования пользователей защищен с помощью учетных данных Azure AD, поэтому вам не нужно хранить ключ учетной записи вместе с кодом.
- **Поставьте план отзыва для SAS.** Убедитесь, что вы готовы ответить, если SAS скомпрометирован.
- **Определите хранимую политику доступа для SAS службы.** Хранимые политики доступа дают возможность отзывать разрешения для SAS службы без необходимости повторного создания ключей учетной записи хранения. Задайте для них очень большой (или бесконечный) срок действия и убедитесь, что он регулярно переносится на будущее время.
- **Используйте приближается время истечения срока действия на SAS нерегламентированной службы SAS или SAS учетной записи.** Таким образом, даже если SAS скомпрометирован, он будет действителен только в течение короткого времени. Это особенно важно в случаях, когда нельзя ссылаться на хранимую политику доступа. Небольшой срок также позволяет ограничить объем данных, который может быть записан в большой двоичный объект, путем ограничения времени на отправку этих данных.
- **Запрограммируйте автоматическое обновление подписи клиентами при необходимости.** Клиенты должны обновлять SAS задолго до окончания его срока действия, чтобы оставить время для повторных попыток в случае недоступности службы, предоставляющей SAS. Если SAS будет использоваться для небольшого числа кратковременных операций, которые должны быть завершены в течение заданного периода действия, такая мера может оказаться лишней, так как обновление SAS не предусматривается. Однако если имеется клиент, регулярно выполняющий запросы через подпись, то возможность истечения срока действия следует принять во внимание. Рекомендуется сбалансировать требование к кратковременности использования подписи (как указано ранее) с требованием того, чтобы клиент запрашивал обновление достаточно рано во избежание проблем, связанных с истечением срока действия SAS до завершения обновления.
- **Будьте осторожны со временем начала действия SAS.** Если задать для времени начала действия SAS значение **now**, то из-за разницы во времени (разницы в текущем времени на разных компьютерах) могут наблюдаться периодические сбои в течение первых нескольких минут. В общем, устанавливайте время начала действия на 15 минут или более в прошлом времени. Или не задавайте вообще. Так SAS будет немедленно становиться действительным во всех случаях. То же касается и времени истечения срока действия. Помните, что для каждого запроса может наблюдаться рассинхронизация по времени до 15 минут в любом направлении. Для клиентов, использующих версию REST, предшествующую версии 2012-02-12, максимальный срок действия SAS, который не ссылается на хранимую политику, составляет 1 час, а все политики, где указано большее время, вызовут сбой.
- **Четко указывайте ресурс, к которому осуществляется доступ.** Из соображений безопасности рекомендуется предоставить пользователю минимально необходимый набор прав. Если пользователю требуется только доступ для чтения к отдельной сущности, предоставьте доступ на чтение к этой сущности, а не доступ на чтение, запись и удаление для всех сущностей. Это также позволяет уменьшить ущерб, если SAS скомпрометирован, так как такой SAS предоставляет меньше возможностей злоумышленнику.
- **Вы узнаете, что счет будет взиматься за использование, включая SAS.** Если вы предоставляете доступ на запись к большому двоичному объекту, пользователь может отправить большой двоичный объект размером 200 ГБ. Если вы также предоставляете доступ на чтение, пользователь может скачать его 10 раз, в результате чего вам потребуется оплачивать исходящий трафик объемом 2 ТБ. Опять же, ограниченные разрешения помогают сузить спектр возможностей злоумышленников. Используйте краткосрочные подписи, чтобы снизить угрозу (но помните о влиянии рассинхронизации часов на время окончания действия).
- **Проверка данных, записанных с помощью SAS.** Когда клиентское приложение записывает данные в вашу учетную запись хранения, помните, что эти данные могут стать источником проблем. Если приложение требует проверять достоверность или подлинность этих данных перед использованием, такую проверку следует выполнять после записи данных и перед их использованием в приложении. Такой подход также обеспечивает защиту от поврежденных или вредоносных данных, записываемых в вашу учетную запись как пользователем, который получил подпись правомерно, так и пользователем, использующим подпись после ее утечки.
- **Узнайте, когда не следует использовать SAS.** Иногда риски, связанные с определенной операцией с вашей учетной записью хранения, перевешивают преимущества использования SAS. Для таких операций создавайте службу среднего уровня, которая записывает данные в вашу учетную запись хранения после выполнения проверки, проверки подлинности и аудита на основании бизнес-правил. Кроме того, иногда проще организовать управление доступом другим образом. Например, если вы хотите сделать все BLOB-объекты в контейнере общедоступными для чтения, вместо предоставления всем клиентам подписанного URL-адреса можно сделать этот контейнер общедоступным.
- **Используйте Azure Monitor и журналы службы хранилища Azure для мониторинга приложения.** Вы можете использовать журналы Azure Monitor и аналитики хранилища, чтобы наблюдать за резкостью сбоев авторизации из-за сбоя в службе поставщика SAS или непреднамеренного удаления хранимой политики доступа. Дополнительные сведения см. [в разделе метрики службы хранилища Azure в Azure Monitor](storage-metrics-in-azure-monitor.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) и [аналитика службы хранилища Azure ведение журнала](storage-analytics-logging.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

## <a name="get-started-with-sas"></a>Начало работы с SAS

Чтобы приступить к работе с подписанными URL, ознакомьтесь со следующими статьями по каждому из типов SAS.

### <a name="user-delegation-sas"></a>SAS делегирования пользователя

- [Создание SAS для делегирования пользователя для контейнера или большого двоичного объекта с помощью PowerShell (Предварительная версия)](../blobs/storage-blob-user-delegation-sas-create-powershell.md)
- [Создание SAS для делегирования пользователя для контейнера или большого двоичного объекта с Azure CLI (Предварительная версия)](../blobs/storage-blob-user-delegation-sas-create-cli.md)
- [Создание SAS для делегирования пользователя для контейнера или большого двоичного объекта с помощью .NET (Предварительная версия)](../blobs/storage-blob-user-delegation-sas-create-dotnet.md)

### <a name="service-sas"></a>SAS службы

- [Создание SAS службы для контейнера или большого двоичного объекта с помощью .NET](../blobs/storage-blob-service-sas-create-dotnet.md)

### <a name="account-sas"></a>SAS учетной записи

- [Создание SAS учетной записи с помощью .NET](storage-account-sas-create-dotnet.md)

## <a name="next-steps"></a>Дальнейшие действия

- [Делегирование доступа с помощью подписанного URL-доступа (REST API)](/rest/api/storageservices/delegate-access-with-shared-access-signature)
- [Создание SAS для делегирования пользователей (REST API)](/rest/api/storageservices/create-user-delegation-sas)
- [Создание SAS службы (REST API)](/rest/api/storageservices/create-service-sas)
- [Создание SAS учетной записи (REST API)](/rest/api/storageservices/create-account-sas)
