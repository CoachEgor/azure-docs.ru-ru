---
title: Настройка брандмауэров службы хранилища Azure и виртуальных сетей | Документация Майкрософт
description: Настройте многоуровневую сетевую безопасность для своей учетной записи.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 01/21/2020
ms.author: tamram
ms.reviewer: santoshc
ms.subservice: common
ms.openlocfilehash: 77ad8579f31ce900a67e2ba3ddc53a5b034b6d42
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79454675"
---
# <a name="configure-azure-storage-firewalls-and-virtual-networks"></a>Настройка брандмауэров службы хранилища Azure и виртуальных сетей

Служба хранилища Azure предоставляет многоуровневую модель безопасности. Эта модель позволяет обеспечить и контролировать уровень доступа к учетным записям хранения, который требуется приложениям и корпоративным средам, в зависимости от типа и подмноза используемых сетей. При настройке сетевых правил доступ к учетной записи хранилища могут получить доступ только приложения, запрашивающие данные по указанному набору сетей. Вы можете ограничить доступ к учетной записи хранилища запросами, поступающими с указанных IP-адресов, IP-диапазонов или из списка подсетей в виртуальной сети Azure (VNet).

Учетные записи хранения имеют общедоступную точку, доступкую через Интернет. Вы также можете создать [Private Endpoints для вашей учетной записи хранения,](storage-private-endpoints.md)которая назначает частный IP-адрес из вашего VNet на учетную запись хранения и защищает весь трафик между вашим VNet и учетной записью хранилища по частной ссылке. Брандмауэр хранения Azure обеспечивает доступ к доступу к общедоступной конечной точке учетной записи хранилища. Вы также можете использовать брандмауэр, чтобы заблокировать доступ через публичную конечную точку при использовании частных конечных точек. Конфигурация брандмауэра хранилища также позволяет выбрать надежные службы платформы Azure для безопасного доступа к учетной записи хранилища.

Приложение, которое получает доступ к учетной записи хранилища, когда сетевые правила действуют, по-прежнему требует надлежащего разрешения запроса. Авторизация поддерживается учетными данными Active Directory (Azure AD) для капли и очередей, с действительным ключом доступа к учетной записи или с токеном SAS.

> [!IMPORTANT]
> Включение правил брандмауэра для учетной записи хранилища блокирует входящие запросы данных по умолчанию, если только запросы поступают от службы, работающей в виртуальной сети Azure (VNet) или с разрешенных общедоступных IP-адресов. Запросы от других служб Azure, в том числе портала Azure, служб метрики и ведения журналов, блокируются.
>
> Вы можете предоставить доступ к службам Azure, которые работают из VNet, разрешив трафик из подсети, хуснейкоторой экземплярслужбы. Можно также включить ограниченное количество сценариев через описанный ниже механизм [исключений.](#exceptions) Чтобы получить доступ к данным из учетной записи хранилища через портал Azure, необходимо находиться на машине в пределах доверенной границы (или IP или VNet), которую вы настроили.

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="scenarios"></a>Сценарии

Чтобы обезопасить учетную запись хранилища, сначала следует настроить правило, чтобы отказать в доступе к трафику из всех сетей (включая интернет-трафик) в общедоступной точке по умолчанию. Затем следует настроить правила, которые предоставляют доступ к трафику из определенных VNets. Вы также можете настроить правила, чтобы предоставить доступ к трафику из некоторых общедоступных диапазонов IP-адресов интернета, что позволяет подключение от конкретных интернет или на местах клиентов. Такая конфигурация позволяет создать для приложений границу в виде безопасной сети.

Можно объединить правила брандмауэра, которые позволяют получить доступ из определенных виртуальных сетей и от общедоступных диапазонов IP-адресов на одной и той же учетной записи хранения. Правила хранения брандмауэра могут быть применены к существующим учетным записям хранения или при создании новых учетных записей хранения.

Правила хранения брандмауэра применяются к общедоступной конечной точке учетной записи хранилища. Вам не нужны правила доступа к брандмауэру, позволяющие трафик для частных конечных точек учетной записи хранилища. Процесс утверждения создания частной конечной точки предоставляет неявный доступ к трафику из подсети, в котором размещаться частная конечная точка.

В службе хранилища Azure сетевые правила применяются ко всем сетевым протоколам, включая REST и SMB. Для доступа к данным с помощью таких инструментов, как портал Azure, исследователь хранения данных и АЗКопия, необходимо настроить четкие сетевые правила.

Как только правила сети применены, они распространяются на все запросы. Токены SAS, позволяющие получить доступ к конкретному IP-адресу, служат для ограничения доступа владельца токена, а не предоставляют доступ к каким-либо новым ресурсам, не указанным в настроенных сетевых правилах.

Правила сети не влияют на трафик дисков виртуальных машин (включая операции подключения и отключения, а также дисковые операции ввода-вывода). Сетевые правила обеспечивают безопасность во время доступа REST к страничным BLOB-объектам.

Классические учетные записи хранения не поддерживают брандмауэры и виртуальные сети.

Чтобы использовать неуправляемые диски в учетных записях хранения с действующими правилами сети относительно резервного копирования и восстановления виртуальных машин, необходимо создать исключение. Эта процедура описана в разделе [Исключения](#exceptions) данной статьи. Исключения брандмауэра не применяются к управляемым дискам, так как ими уже управляет Azure.

## <a name="change-the-default-network-access-rule"></a>Изменение сетевого правила доступа по умолчанию

По умолчанию учетные записи хранения принимают запросы на подключение от клиентов в сети. Для ограничения доступа из выбранных сетей необходимо сначала изменить действие по умолчанию.

> [!WARNING]
> Изменение сетевых правил может повлиять на возможность подключения приложений к службе хранилища Azure. Установка правила сети по умолчанию, чтобы **запретить** блокировать доступ к данным, если не применяются конкретные сетевые правила, которые **предоставляют** доступ. Предоставьте доступ для разрешенных сетей с помощью сетевых правил, прежде чем изменить правила по умолчанию и запретить доступ.

### <a name="managing-default-network-access-rules"></a>Управление сетевыми правилами доступа по умолчанию

Вы можете управлять сетевыми правилами доступа по умолчанию для учетных записей хранения с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Чтобы отказать в доступе по умолчанию, выберите разрешить доступ из **выбранных сетей.** Чтобы разрешить трафик из всех сетей, выберите разрешить доступ из **всех сетей.**

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Отобразите состояние правила по умолчанию для учетной записи хранения.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").DefaultAction
    ```

1. Настройте в правиле по умолчанию запрет сетевого доступа по умолчанию.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -DefaultAction Deny
    ```

1. Настройте в правиле по умолчанию разрешение сетевого доступа по умолчанию.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -DefaultAction Allow
    ```

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Отобразите состояние правила по умолчанию для учетной записи хранения.

    ```azurecli
    az storage account show --resource-group "myresourcegroup" --name "mystorageaccount" --query networkRuleSet.defaultAction
    ```

1. Настройте в правиле по умолчанию запрет сетевого доступа по умолчанию.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --default-action Deny
    ```

1. Настройте в правиле по умолчанию разрешение сетевого доступа по умолчанию.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --default-action Allow
    ```

## <a name="grant-access-from-a-virtual-network"></a>Предоставление доступа из виртуальной сети

Вы можете настроить учетные записи хранения, чтобы разрешить доступ только из определенных подсетей. Разрешенные подсети могут принадлежать VNet в той же подписке или в другой подписке, включая подписки, принадлежащие другому арендатору Active Directory Azure.

Включите [конечную точку службы](/azure/virtual-network/virtual-network-service-endpoints-overview) для службы хранилища Azure, входящей в нужную виртуальную сеть. Конечная точка службы направляет трафик из VNet по оптимальному пути к службе хранения Azure. Идентификационные данные подсети и виртуальной сети также передаются с каждым запросом. Администраторы могут настроить сетевые правила для учетной записи хранилища, которые позволяют получать запросы из определенных подсетей в VNet. Клиенты, которым предоставлен доступ по этим сетевым правилам, по прежнему должны выполнять требования авторизации учетной записи хранения, чтобы получать доступ к данным.

Каждая учетная запись хранения поддерживает до 100 правил виртуальной сети, которые можно объединить с [правилами IP-сети](#grant-access-from-an-internet-ip-range).

### <a name="available-virtual-network-regions"></a>Доступные регионы виртуальной сети

Как правило, конечные точки служб работают между виртуальными сетями и экземплярами служб в одном регионе Azure. При использовании конечных точек служб со службой хранилища Azure область применения расширяется и включает [связанный регион](/azure/best-practices-availability-paired-regions). Конечные точки служб обеспечивают непрерывность работы при отработке регионального отказа, а также доступ на чтение к экземплярам геоизбыточного хранилища (RA-GRS). Правила сети, предоставляющие доступ к учетной записи хранения из виртуальной сети, также предоставляют доступ к любому экземпляру RA-GRS.

Планируя аварийное восстановление на случай регионального сбоя, следует заранее создать виртуальные сети в связанном регионе. Включите конечные точки для службы хранилища Azure с применением сетевых правил, разрешающих доступ из этих альтернативных виртуальных сетей. Затем примените эти правила к учетным записям своего геоизбыточного хранилища.

> [!NOTE]
> Конечные точки службы не применяются к трафику за пределами региона виртуальной сети и заданного связанного региона. Сетевые правила, предоставляющие доступ к учетным записям хранения из виртуальных сетей, применяются только в основном регионе учетной записи хранения или в заданном связанном регионе.

### <a name="required-permissions"></a>Необходимые разрешения

Чтобы применить правило виртуальной сети к учетной записи хранения, у пользователя должны быть соответствующие разрешения для добавляемых подсетей. Это разрешение *Join Service to a Subnet* (Добавить службу к подсети), включенное во встроенную роль *Участник учетных записей хранения*. Его также можно добавить к определениям пользовательских ролей.

Учетная запись хранения данных и виртуальные сети, получивших доступ, могут быть в различных подписках, включая подписки, которые являются частью другого арендатора Azure AD.

> [!NOTE]
> Конфигурация правил, которые предоставляют доступ к подсетям в виртуальных сетях, которые являются частью другого арендатора Active Directory Azure, в настоящее время поддерживается только через Powershell, CLI и REST AI. Такие правила не могут быть настроены через портал Azure, хотя их можно просматривать на портале.

### <a name="managing-virtual-network-rules"></a>Управление правилами виртуальной сети

Правилами виртуальной сети для учетных записей хранения можно управлять с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. Чтобы предоставить доступ виртуальной сети с новым сетевым правилом, в разделе **Виртуальные сети** выберите команду **Добавить существующую виртуальную сеть**, укажите параметры для пунктов **Виртуальные сети** и **Подсети**, а затем нажмите **Добавить**. Чтобы создать виртуальную сеть и предоставить ей доступ, выберите команду **Добавить новую виртуальную сеть**. Укажите сведения, необходимые для создания виртуальной сети, а затем нажмите **Создать**.

    > [!NOTE]
    > Если конечная точка службы для службы хранилища Azure еще не настроена для выбранной виртуальной сети и подсетей, ее можно настроить в ходе этой операции.
    >
    > В настоящее время для выбора при создании правил отображаются только виртуальные сети, принадлежащие к тому же арендатору Active Directory Azure. Для предоставления доступа к подсети в виртуальной сети, принадлежащей другому арендатору, пожалуйста, используйте Powershell, CLI или REST AIS.

1. Если нужно удалить правила виртуальной сети или подсети, щелкните **...**, чтобы открыть контекстное меню для виртуальной сети или подсети, и выберите пункт **Удалить**.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Выведите список правил виртуальной сети.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").VirtualNetworkRules
    ```

1. Включите конечную точку службы для службы хранилища Azure в имеющейся виртуальной сети и подсети.

    ```powershell
    Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Set-AzVirtualNetworkSubnetConfig -Name "mysubnet" -AddressPrefix "10.0.0.0/24" -ServiceEndpoint "Microsoft.Storage" | Set-AzVirtualNetwork
    ```

1. Добавьте сетевое правило для виртуальной сети и подсети.

    ```powershell
    $subnet = Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Get-AzVirtualNetworkSubnetConfig -Name "mysubnet"
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -VirtualNetworkResourceId $subnet.Id
    ```

    > [!TIP]
    > Чтобы добавить сетевое правило для подсети в VNet, принадлежащем другому арендатору Azure AD, используйте полностью квалифицированный параметр **VirtualNetworkResourceId** в форме "/подписка/подписка-ID/resourceGroups/resourceGroup-Name/providers/Microsoft.Network/virtualNetworks/vNet-name/subnets/subnet-name".

1. Удалите сетевое правило для виртуальной сети и подсети.

    ```powershell
    $subnet = Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Get-AzVirtualNetworkSubnetConfig -Name "mysubnet"
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -VirtualNetworkResourceId $subnet.Id
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Выведите список правил виртуальной сети.

    ```azurecli
    az storage account network-rule list --resource-group "myresourcegroup" --account-name "mystorageaccount" --query virtualNetworkRules
    ```

1. Включите конечную точку службы для службы хранилища Azure в имеющейся виртуальной сети и подсети.

    ```azurecli
    az network vnet subnet update --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --service-endpoints "Microsoft.Storage"
    ```

1. Добавьте сетевое правило для виртуальной сети и подсети.

    ```azurecli
    $subnetid=(az network vnet subnet show --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --query id --output tsv)
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --subnet $subnetid
    ```

    > [!TIP]
    > Чтобы добавить правило для подсети в VNet, принадлежащее другому арендатору Azure AD, используйте\<полностью\>квалифицированный идентификатор\>подсети в форме "/подписка/подписка-ID /resourceGroups/resourceGroup-Name\<\</providers/Microsoft.Network/virtualNetworks/ vNet-name/subnets/\>\<subnet-name\>".
    >
    > Можно использовать параметр **подписки** для получения идентификатора подсети для VNet, принадлежащего другому арендатору Azure AD.

1. Удалите сетевое правило для виртуальной сети и подсети.

    ```azurecli
    $subnetid=(az network vnet subnet show --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --query id --output tsv)
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --subnet $subnetid
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

## <a name="grant-access-from-an-internet-ip-range"></a>Предоставление доступа из диапазона IP-адресов в Интернете

Вы можете настроить учетные записи хранения так, чтобы разрешить доступ из определенных диапазонов общедоступных IP-адресов в Интернете. Такая конфигурация позволяет предоставить доступ конкретным интернет-службам и локальным сетям, заблокировав при этом общий интернет-трафик.

Предоставьте разрешенные диапазоны адресов в Интернете, используя [нотацию CIDR](https://tools.ietf.org/html/rfc4632) в формате *16.17.18.0/24* или в виде отдельных IP-адресов, таких как *16.17.18.19*.

   > [!NOTE]
   > Небольшие адреса, использующие размеры с префиксом /31 или /32, не поддерживаются. Эти диапазоны следует настраивать с помощью отдельных правил для IP-адресов.

Правила IP-сети можно применять только для **общедоступных** IP-адресов в Интернете. Диапазоны IP-адресов, зарезервированные для частных сетей (как определено в документе [RFC 1918](https://tools.ietf.org/html/rfc1918#section-3)), запрещено использовать в правилах IP. Частные сети включают адреса, которые начинаются с _10.,_ _172.16.»_ - _172.31._ _192.168.*_

   > [!NOTE]
   > Правила IP-сети не затрагивают запросы, исходящие из того же региона Azure, к которому относится учетная запись хранения. Используйте [правила виртуальной сети](#grant-access-from-a-virtual-network) для разрешения запросов в одном и том же регионе.

  > [!NOTE]
  > Службы, развернутые в том же регионе, что и учетная запись хранения, используют частные IP-адреса Azure для связи. Таким образом, нельзя ограничивать доступ к определенным службам Azure на основе их общедоступного диапазона IP-адресов.

Только адреса IPV4 поддерживаются для настройки правил хранения брандмауэра.

Каждая учетная запись хранилища поддерживает до 100 правил IP-сети.

### <a name="configuring-access-from-on-premises-networks"></a>Настройка доступа из локальных сетей

Чтобы предоставить доступ из вашей локальной сети к учетной записи хранения в правиле IP-сети, необходимо определить IP-адреса для Интернета, которые используются в вашей сети. За помощью обращайтесь к администратору сети.

Если вы используете [ExpressRoute](/azure/expressroute/expressroute-introduction) для локальной среды, для общедоступного пиринга или пиринга Майкрософт, то вам необходимо определить используемые IP-адреса NAT. Для общедоступного пиринга в каждом канале ExpressRoute по умолчанию используется два IP-адреса NAT для трафика служб Azure, когда он входит в основную магистральную сеть Microsoft Azure. Для пиринга корпорации Майкрософт используемые IP-адреса NAT либо предоставляются заказчиком, либо предоставляются поставщиком услуг. Чтобы разрешить доступ к ресурсам служб, необходимо разрешить эти общедоступные IP-адреса в настройках брандмауэра IP-адресов ресурсов. Чтобы найти IP-адреса канала ExpressRoute для общедоступного пиринга, [отправьте запрос по ExpressRoute в службу поддержки](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Узнайте больше о [NAT для общедоступного пиринга и пиринга Майкрософт](/azure/expressroute/expressroute-nat#nat-requirements-for-azure-public-peering).

### <a name="managing-ip-network-rules"></a>Управление правилами IP-сети

Правилами IP-сети для учетных записей хранения можно управлять с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. Чтобы предоставить доступ к интернет-диапазону IP, введите IP-адрес или диапазон адресов (в формате CIDR) под диапазоном**адресов** **Firewall.** > 

1. Чтобы удалить правило IP-сети, щелкните значок корзины рядом с диапазоном адресов.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Выведите список правил IP-сети.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").IPRules
    ```

1. Добавьте правило сети для отдельного IP-адреса.

    ```powershell
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.19"
    ```

1. Добавьте правило сети для диапазона IP-адресов.

    ```powershell
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.0/24"
    ```

1. Удалите правило сети для отдельного IP-адреса.

    ```powershell
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.19"
    ```

1. Удалите правило сети для диапазона IP-адресов.

    ```powershell
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.0/24"
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Выведите список правил IP-сети.

    ```azurecli
    az storage account network-rule list --resource-group "myresourcegroup" --account-name "mystorageaccount" --query ipRules
    ```

1. Добавьте правило сети для отдельного IP-адреса.

    ```azurecli
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.19"
    ```

1. Добавьте правило сети для диапазона IP-адресов.

    ```azurecli
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.0/24"
    ```

1. Удалите правило сети для отдельного IP-адреса.

    ```azurecli
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.19"
    ```

1. Удалите правило сети для диапазона IP-адресов.

    ```azurecli
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.0/24"
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

## <a name="exceptions"></a>Исключения

Сетевые правила помогают создать безопасную среду для связей между приложениями и данными для большинства сценариев. Однако некоторые приложения зависят от служб Azure, которые не могут быть однозначно изолированы с помощью правил виртуальной сети или IP-адресов. Но такие услуги должны быть предоставлены для хранения, чтобы обеспечить полную функциональность приложения. В таких ситуациях можно использовать ***настройки Allow trusted Microsoft,чтобы*** обеспечить доступ к данным, журналам или аналитике.

### <a name="trusted-microsoft-services"></a>Доверенные службы Майкрософт

Некоторые службы Майкрософт работают из сетей, которые не могут быть включены в правила сети. Вы можете предоставить подмножество таких надежных служб Майкрософт доступ к учетной записи хранилища, сохраняя при этом сетевые правила для других приложений. Эти надежные службы будут использовать сильную аутентификацию для безопасного подключения к учетной записи хранилища. Мы включили два режима надежного доступа для служб Майкрософт.

- Ресурсы некоторых служб, **зарегистрированные в вашей подписке,** могут получить доступ к учетной записи хранилища **в той же подписке** для некоторых операций, таких как написание журналов или резервное копирование.
- Ресурсам некоторых служб может быть предоставлен явный доступ к учетной записи хранилища, **назначив роль RBAC** своей управляемой системе.


При вменить настройку **allow trusted Microsoft,** ресурсы следующих служб, зарегистрированных в той же подписке, что и ваша учетная запись хранилища, получают доступ к ограниченному набору операций, как описано:

| Служба                  | Имя поставщика ресурсов     | Разрешенные операции                 |
|:------------------------ |:-------------------------- |:---------------------------------- |
| Azure Backup             | Microsoft.RecoveryServices | Резервное копирование и восстановление неуправляемых дисков в виртуальных машинах IAAS. (Не требуется для управляемых дисков.) Ознакомьтесь с [дополнительными сведениями](/azure/backup/backup-introduction-to-azure-backup). |
| Azure Data Box           | Microsoft.DataBox          | Позволяет импортировать данные в Azure с помощью Box Data. Ознакомьтесь с [дополнительными сведениями](/azure/databox/data-box-overview). |
| Azure DevTest Labs       | Microsoft.DevTestLab       | Создание пользовательских образов и установка артефактов. Ознакомьтесь с [дополнительными сведениями](/azure/devtest-lab/devtest-lab-overview). |
| Сетка событий Azure         | Microsoft.EventGrid        | Включение публикации событий в хранилище BLOB-объектов и предоставление службе "Сетка событий" разрешения на публикацию в хранилище очередей. См. дополнительные сведения о [событиях хранилища BLOB-объектов](/azure/event-grid/event-sources) и [публикации в хранилище очередей](/azure/event-grid/event-handlers). |
| Центры событий Azure         | Microsoft.EventHub         | Архивация данных с помощью функции "Сбор" в Центрах событий. [Узнать больше](/azure/event-hubs/event-hubs-capture-overview). |
| Служба синхронизации файлов Azure          | Microsoft.StorageSync      | Позволяет преобразовать файловый сервер на преме в кэш для акций Azure File. Позволяет синхронизировать с несколькими участками, быстрое восстановление аварийности и резервное копирование в облаке. [Дополнительные сведения](../files/storage-sync-files-planning.md) |
| Azure HDInsight          | Microsoft.HDInsight        | Предоставить исходное содержимое файловой системы по умолчанию для нового кластера HDInsight. Ознакомьтесь с [дополнительными сведениями](/azure/hdinsight/hdinsight-hadoop-use-blob-storage). |
| Экспорт импорта Azure      | Microsoft.ImportExport     | Позволяет импортировать данные в Azure и экспортировать данные из Azure с помощью службы импорта/экспорта. Ознакомьтесь с [дополнительными сведениями](/azure/storage/common/storage-import-export-service).  |
| Azure Monitor            | Microsoft.Insights         | Позволяет записывать данные мониторинга в защищенную учетную запись хранения, включая журналы диагностики ресурсов, журналы входа в azure Active Directory и журналы аудита, а также журналы Microsoft Intune. Ознакомьтесь с [дополнительными сведениями](/azure/monitoring-and-diagnostics/monitoring-roles-permissions-security). |
| Сеть Azure         | Microsoft.Network.          | Хранение и анализ журналов сетевого трафика. Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/network-watcher/network-watcher-nsg-flow-logging-overview). |
| Azure Site Recovery      | Microsoft.SiteRecovery     | Включить репликацию для аварийного восстановления виртуальных машин Azure IaaS при использовании кэша с поддержкой брандмауэра, источника или учетных записей целевого хранилища.  Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-tutorial-enable-replication). |

Настройка **Allow trusted Microsoft также** позволяет определенному экземпляру нижеприведенных служб получить доступ к учетной записи хранилища, если вы явно [присвоите роль RBAC](storage-auth-aad.md#assign-rbac-roles-for-access-rights) [управляемому итору](../../active-directory/managed-identities-azure-resources/overview.md) для этого экземпляра ресурса. В этом случае область доступа для экземпляра соответствует роли RBAC, назначенной управляемому удостоверению.

| Служба                        | Имя поставщика ресурсов                 | Назначение            |
| :----------------------------- | :------------------------------------- | :----------------- |
| Когнитивный поиск Azure         | Microsoft.Search/searchServices        | Позволяет службам Cognitive Search получать доступ к учетным записям хранения для индексации, обработки и запросов. |
| Задачи Реестра контейнеров Azure | Microsoft.ContainerRegistry/registries | Задачи ACR могут получать доступ к учетным записям хранения при создании изображений контейнеров. |
| Фабрика данных Azure             | Microsoft.DataFactory/factories;        | Позволяет получить доступ к учетным записям хранения через время выполнения ADF. |
| Azure Data Share               | Microsoft.DataShare/учетные записи           | Позволяет получить доступ к учетным записям хранения через обмен данными. |
| Azure Logic Apps               | Microsoft.Logic/workflows              | Позволяет логическим приложениям получать доступ к учетным записям хранения данных. Ознакомьтесь с [дополнительными сведениями](/azure/logic-apps/create-managed-service-identity#authenticate-access-with-managed-identity). |
| Служба "Машинное обучение Azure" | Microsoft.MachineLearningServices      | Авторизованные рабочие места Машинного обучения Azure записывает выходные материалы эксперимента, модели и журналы в хранилище Blob и считывает данные. Ознакомьтесь с [дополнительными сведениями](/azure/machine-learning/service/how-to-enable-virtual-network#use-a-storage-account-for-your-workspace). | 
| Хранилище данных SQL Azure       | Microsoft.Sql                          | Позволяет импортировать и экспортировать данные из определенных экземпляров базы данных с помощью PolyBase. Ознакомьтесь с [дополнительными сведениями](/azure/sql-database/sql-database-vnet-service-endpoint-rule-overview). |
| Azure Stream Analytics         | Microsoft.StreamAnalytics             | Позволяет записать данные из задания потоковой передачи в хранилище Blob. Эта функция в настоящее время находится на стадии предварительной версии. Ознакомьтесь с [дополнительными сведениями](/azure/stream-analytics/blob-output-managed-identity). |
| Azure Synapse Analytics        | Microsoft.Synapse/рабочие пространства          | Обеспечивает доступ к данным в хранилище Azure от Synapse Analytics. |


### <a name="storage-analytics-data-access"></a>Доступ к данным аналитики хранилища

В некоторых случаях доступ для чтения журналов диагностики и метрик нужно получать за пределами сети. При настройке доверенного доступа служб к учетной записи хранилища можно разрешить доступ к считыванию файлов журналов, таблиц метрик или обоих. Дополнительные сведения о работе с аналитикой хранилища см. в [этой статье](/azure/storage/storage-analytics).

### <a name="managing-exceptions"></a>Управление исключениями

Исключениями из правил сети можно управлять с помощью портала Azure, PowerShell или Azure CLI v2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. В соответствии с **исключениями**выберите исключения, которые вы хотите предоставить.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Отобразите исключения для сетевых правил учетной записи хранения.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount").Bypass
    ```

1. Настройте исключения для сетевых правил учетной записи хранения.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -Bypass AzureServices,Metrics,Logging
    ```

1. Удалите исключения для сетевых правил учетной записи хранения.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -Bypass None
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе исключение не будет действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Отобразите исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account show --resource-group "myresourcegroup" --name "mystorageaccount" --query networkRuleSet.bypass
    ```

1. Настройте исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --bypass Logging Metrics AzureServices
    ```

1. Удалите исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --bypass None
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе исключение не будет действовать.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте больше о конечных точках службы Azure Network в [конечных точках службы.](/azure/virtual-network/virtual-network-service-endpoints-overview)

Углубиться в систему безопасности хранения Azure в [руководстве по безопасности хранилища Azure.](../blobs/security-recommendations.md)
