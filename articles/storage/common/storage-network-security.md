---
title: Настройка брандмауэров службы хранилища Azure и виртуальных сетей | Документация Майкрософт
description: Настройте многоуровневую сетевую безопасность для своей учетной записи.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 03/21/2019
ms.author: tamram
ms.reviewer: santoshc
ms.subservice: common
ms.openlocfilehash: af5b2a8c6894846ec529763f80c78bc50debabe6
ms.sourcegitcommit: c4700ac4ddbb0ecc2f10a6119a4631b13c6f946a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2019
ms.locfileid: "72965510"
---
# <a name="configure-azure-storage-firewalls-and-virtual-networks"></a>Настройка брандмауэров службы хранилища Azure и виртуальных сетей

Служба хранилища Azure предоставляет многоуровневую модель безопасности. Эта модель позволяет защищать и контролировать уровень доступа к учетным записям хранения, которые требуются приложениям и корпоративным средам, в зависимости от типа и подмножества используемых сетей. При настройке сетевых правил только приложения, запрашивающие данные через указанный набор сетей, могут получить доступ к учетной записи хранения. Вы можете ограничить доступ к учетной записи хранения запросами, источником которых являются указанные IP-адреса, диапазоны IP-адресов или список подсетей в виртуальной сети Azure (VNet).

Учетные записи хранения имеют общедоступную конечную точку, доступную через Интернет. Вы также можете создать [частные конечные точки для учетной записи хранения](storage-private-endpoints.md), которая назначает частный IP-адрес из виртуальной сети в учетную запись хранения, а также защищает весь трафик между виртуальной сетью и учетной записью хранения по частной ссылке. Брандмауэр службы хранилища Azure предоставляет доступ к контролю доступа для общедоступной конечной точки вашей учетной записи хранения. Кроме того, брандмауэр можно использовать для блокировки доступа через общедоступную конечную точку при использовании частных конечных точек. Конфигурация брандмауэра хранилища также позволяет безопасно выбрать Доверенные службы платформы Azure для безопасного доступа к учетной записи хранения.

Приложение, которое обращается к учетной записи хранения, когда действуют правила сети, по-прежнему требует соответствующей авторизации для запроса. Авторизация поддерживается с учетными данными Azure Active Directory (Azure AD) для больших двоичных объектов и очередей с допустимым ключом доступа к учетной записи или маркером SAS.

> [!IMPORTANT]
> Включение правил брандмауэра для вашей учетной записи хранения блокирует входящие запросы данных по умолчанию, если запросы не берутся из службы, работающей в виртуальной сети Azure (VNet), или из разрешенных общедоступных IP-адресов. Запросы от других служб Azure, в том числе портала Azure, служб метрики и ведения журналов, блокируются.
>
> Вы можете предоставить доступ к службам Azure, работающим в виртуальной сети, разрешив трафик из подсети, в которой размещен экземпляр службы. Можно также включить ограниченное количество сценариев с помощью механизма [исключений](#exceptions) , описанного ниже. Чтобы получить доступ к данным из учетной записи хранения с помощью портал Azure, необходимо находиться на компьютере в пределах доверенной границы (IP-адрес или виртуальная сеть), которые вы настроили.

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="scenarios"></a>Сценарии

Чтобы защитить учетную запись хранения, необходимо сначала настроить правило, запрещающее доступ к трафику из всех сетей (включая Интернет-трафик) в общедоступной конечной точке по умолчанию. Затем следует настроить правила, предоставляющие доступ к трафику из конкретных виртуальных сетей. Кроме того, можно настроить правила для предоставления доступа к трафику из диапазона общедоступных IP-адресов в Интернете, что позволяет устанавливать подключения от конкретных клиентов в Интернете или локальных клиентах. Такая конфигурация позволяет создать для приложений границу в виде безопасной сети.

Можно сочетать правила брандмауэра, которые разрешают доступ из конкретных виртуальных сетей и из диапазонов общедоступных IP-адресов в одной и той же учетной записи хранения. Правила брандмауэра хранилища можно применять к существующим учетным записям хранения или при создании новых учетных записей хранения.

Правила брандмауэра хранилища применяются к общедоступной конечной точке учетной записи хранения. Правила доступа брандмауэра не нужны, чтобы разрешить трафик для частных конечных точек учетной записи хранения. Процесс утверждения создания частной конечной точки предоставляет неявный доступ к трафику из подсети, в которой размещается частная конечная точка.

В службе хранилища Azure сетевые правила применяются ко всем сетевым протоколам, включая REST и SMB. Для доступа к данным с помощью таких средств, как портал Azure, Обозреватель службы хранилища и AZCopy, должны быть настроены явные правила сети.

Как только правила сети применены, они распространяются на все запросы. Токены SAS, позволяющие получить доступ к конкретному IP-адресу, служат для ограничения доступа владельца токена, а не предоставляют доступ к каким-либо новым ресурсам, не указанным в настроенных сетевых правилах.

Правила сети не влияют на трафик дисков виртуальных машин (включая операции подключения и отключения, а также дисковые операции ввода-вывода). Сетевые правила обеспечивают безопасность во время доступа REST к страничным BLOB-объектам.

Классические учетные записи хранения не поддерживают брандмауэры и виртуальные сети.

Чтобы использовать неуправляемые диски в учетных записях хранения с действующими правилами сети относительно резервного копирования и восстановления виртуальных машин, необходимо создать исключение. Эта процедура описана в разделе [Исключения](#exceptions) данной статьи. Исключения брандмауэра не применяются к управляемым дискам, так как ими уже управляет Azure.

## <a name="change-the-default-network-access-rule"></a>Изменение сетевого правила доступа по умолчанию

По умолчанию учетные записи хранения принимают запросы на подключение от клиентов в сети. Для ограничения доступа из выбранных сетей необходимо сначала изменить действие по умолчанию.

> [!WARNING]
> Изменение сетевых правил может повлиять на возможность подключения приложений к службе хранилища Azure. Если присвоить сетевому правилу по умолчанию значение **Deny** , блокируются все доступ к данным, если также не применяются определенные правила сети, **предоставляющие** доступ. Предоставьте доступ для разрешенных сетей с помощью сетевых правил, прежде чем изменить правила по умолчанию и запретить доступ.

### <a name="managing-default-network-access-rules"></a>Управление сетевыми правилами доступа по умолчанию

Вы можете управлять сетевыми правилами доступа по умолчанию для учетных записей хранения с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>портала Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Чтобы запретить доступ по умолчанию, разрешите доступ в разделе **Выбранные сети**. Чтобы разрешить передачу трафика из всех сетей, разрешите доступ в разделе **Все сети**.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Отобразите состояние правила по умолчанию для учетной записи хранения.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").DefaultAction
    ```

1. Настройте в правиле по умолчанию запрет сетевого доступа по умолчанию.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -DefaultAction Deny
    ```

1. Настройте в правиле по умолчанию разрешение сетевого доступа по умолчанию.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -DefaultAction Allow
    ```

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Отобразите состояние правила по умолчанию для учетной записи хранения.

    ```azurecli
    az storage account show --resource-group "myresourcegroup" --name "mystorageaccount" --query networkRuleSet.defaultAction
    ```

1. Настройте в правиле по умолчанию запрет сетевого доступа по умолчанию.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --default-action Deny
    ```

1. Настройте в правиле по умолчанию разрешение сетевого доступа по умолчанию.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --default-action Allow
    ```

## <a name="grant-access-from-a-virtual-network"></a>Предоставление доступа из виртуальной сети

Вы можете настроить учетные записи хранения, чтобы разрешить доступ только из конкретных подсетей. Разрешенные подсети могут принадлежать к виртуальной сети в одной подписке или в другой подписке, включая подписки, принадлежащие другому клиенту Azure Active Directory.

Включите [конечную точку службы](/azure/virtual-network/virtual-network-service-endpoints-overview) для службы хранилища Azure, входящей в нужную виртуальную сеть. Конечная точка службы направляет трафик из виртуальной сети в оптимальный путь к службе хранилища Azure. Удостоверения подсети и виртуальной сети также передаются вместе с каждым запросом. Затем администраторы могут настроить сетевые правила для учетной записи хранения, которая разрешает получение запросов из конкретных подсетей в виртуальной сети. Клиенты, которым предоставлен доступ по этим сетевым правилам, по прежнему должны выполнять требования авторизации учетной записи хранения, чтобы получать доступ к данным.

Каждая учетная запись хранения поддерживает до 100 правил виртуальной сети, которые можно объединить с [правилами IP-сети](#grant-access-from-an-internet-ip-range).

### <a name="available-virtual-network-regions"></a>Доступные регионы виртуальной сети

Как правило, конечные точки служб работают между виртуальными сетями и экземплярами служб в одном регионе Azure. При использовании конечных точек служб со службой хранилища Azure область применения расширяется и включает [связанный регион](/azure/best-practices-availability-paired-regions). Конечные точки служб обеспечивают непрерывность работы при отработке регионального отказа, а также доступ на чтение к экземплярам геоизбыточного хранилища (RA-GRS). Правила сети, предоставляющие доступ к учетной записи хранения из виртуальной сети, также предоставляют доступ к любому экземпляру RA-GRS.

Планируя аварийное восстановление на случай регионального сбоя, следует заранее создать виртуальные сети в связанном регионе. Включите конечные точки для службы хранилища Azure с применением сетевых правил, разрешающих доступ из этих альтернативных виртуальных сетей. Затем примените эти правила к учетным записям своего геоизбыточного хранилища.

> [!NOTE]
> Конечные точки службы не применяются к трафику за пределами региона виртуальной сети и заданного связанного региона. Сетевые правила, предоставляющие доступ к учетным записям хранения из виртуальных сетей, применяются только в основном регионе учетной записи хранения или в заданном связанном регионе.

### <a name="required-permissions"></a>Необходимые разрешения

Чтобы применить правило виртуальной сети к учетной записи хранения, у пользователя должны быть соответствующие разрешения для добавляемых подсетей. Это разрешение *Join Service to a Subnet* (Добавить службу к подсети), включенное во встроенную роль *Участник учетных записей хранения*. Его также можно добавить к определениям пользовательских ролей.

Учетная запись хранения и виртуальные сети, которым предоставлен доступ, могут находиться в разных подписках, включая подписки, которые являются частью другого клиента Azure AD.

> [!NOTE]
> Конфигурация правил, предоставляющих доступ к подсетям в виртуальных сетях, которые являются частью другого клиента Azure Active Directory, в настоящее время поддерживаются только с помощью PowerShell, интерфейса командной строки и API-интерфейсов RESTFUL. Такие правила нельзя настроить с помощью портал Azure, хотя они могут быть просмотрены на портале.

### <a name="managing-virtual-network-rules"></a>Управление правилами виртуальной сети

Правилами виртуальной сети для учетных записей хранения можно управлять с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>портала Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. Чтобы предоставить доступ виртуальной сети с новым сетевым правилом, в разделе **Виртуальные сети** выберите команду **Добавить существующую виртуальную сеть**, укажите параметры для пунктов **Виртуальные сети** и **Подсети**, а затем нажмите **Добавить**. Чтобы создать виртуальную сеть и предоставить ей доступ, выберите команду **Добавить новую виртуальную сеть**. Укажите сведения, необходимые для создания виртуальной сети, а затем нажмите **Создать**.

    > [!NOTE]
    > Если конечная точка службы для службы хранилища Azure еще не настроена для выбранной виртуальной сети и подсетей, ее можно настроить в ходе этой операции.
    >
    > В настоящее время для выбора при создании правила отображаются только виртуальные сети, принадлежащие одному и тому же клиенту Azure Active Directory. Чтобы предоставить доступ к подсети в виртуальной сети, принадлежащей другому клиенту, используйте PowerShell, интерфейс командной строки или API-интерфейсы RESTFUL.

1. Если нужно удалить правила виртуальной сети или подсети, щелкните **...** , чтобы открыть контекстное меню для виртуальной сети или подсети, и выберите пункт **Удалить**.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Выведите список правил виртуальной сети.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").VirtualNetworkRules
    ```

1. Включите конечную точку службы для службы хранилища Azure в имеющейся виртуальной сети и подсети.

    ```powershell
    Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Set-AzVirtualNetworkSubnetConfig -Name "mysubnet" -AddressPrefix "10.0.0.0/24" -ServiceEndpoint "Microsoft.Storage" | Set-AzVirtualNetwork
    ```

1. Добавьте сетевое правило для виртуальной сети и подсети.

    ```powershell
    $subnet = Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Get-AzVirtualNetworkSubnetConfig -Name "mysubnet"
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -VirtualNetworkResourceId $subnet.Id
    ```

    > [!TIP]
    > Чтобы добавить сетевое правило для подсети, принадлежащей другому клиенту Azure AD, используйте полный параметр **виртуалнетворкресаурцеид** в форме "/субскриптионс/субскриптион-ИД/ресаурцеграупс/ресаурцеграуп-наме/провидерс/Микрософт.Нетворк/виртуалнетворкс/внет-наме/субнетс/субнет-наме".

1. Удалите сетевое правило для виртуальной сети и подсети.

    ```powershell
    $subnet = Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Get-AzVirtualNetworkSubnetConfig -Name "mysubnet"
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -VirtualNetworkResourceId $subnet.Id
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Выведите список правил виртуальной сети.

    ```azurecli
    az storage account network-rule list --resource-group "myresourcegroup" --account-name "mystorageaccount" --query virtualNetworkRules
    ```

1. Включите конечную точку службы для службы хранилища Azure в имеющейся виртуальной сети и подсети.

    ```azurecli
    az network vnet subnet update --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --service-endpoints "Microsoft.Storage"
    ```

1. Добавьте сетевое правило для виртуальной сети и подсети.

    ```azurecli
    $subnetid=(az network vnet subnet show --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --query id --output tsv)
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --subnet $subnetid
    ```

    > [!TIP]
    > Чтобы добавить правило для подсети, принадлежащей другому клиенту Azure AD, используйте полный идентификатор подсети в форме "/Subscriptions/\<Subscription-ID\>/resourceGroups/\<resourceGroup-Name\>/Провидерс/Микрософт.Нетворк/виртуалнетворкс/\<vNet-Name\>/субнетс/\<Subnet-Name\>".
    > 
    > Чтобы получить идентификатор подсети для виртуальной сети, принадлежащей другому клиенту Azure AD, можно использовать параметр **Subscription** .

1. Удалите сетевое правило для виртуальной сети и подсети.

    ```azurecli
    $subnetid=(az network vnet subnet show --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --query id --output tsv)
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --subnet $subnetid
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

## <a name="grant-access-from-an-internet-ip-range"></a>Предоставление доступа из диапазона IP-адресов в Интернете

Вы можете настроить учетные записи хранения так, чтобы разрешить доступ из определенных диапазонов общедоступных IP-адресов в Интернете. Такая конфигурация позволяет предоставить доступ конкретным интернет-службам и локальным сетям, заблокировав при этом общий интернет-трафик.

Предоставьте разрешенные диапазоны адресов в Интернете, используя [нотацию CIDR](https://tools.ietf.org/html/rfc4632) в формате *16.17.18.0/24* или в виде отдельных IP-адресов, таких как *16.17.18.19*.

   > [!NOTE]
   > Небольшие адреса, использующие размеры с префиксом /31 или /32, не поддерживаются. Эти диапазоны следует настраивать с помощью отдельных правил для IP-адресов.

Правила IP-сети можно применять только для **общедоступных** IP-адресов в Интернете. Диапазоны IP-адресов, зарезервированные для частных сетей (как определено в документе [RFC 1918](https://tools.ietf.org/html/rfc1918#section-3)), запрещено использовать в правилах IP. К частным сетям относятся адреса, начинающиеся с _10.*_ , _172.16.*_  - _172.31.*_ и _192.168.*_ .

   > [!NOTE]
   > Правила IP-сети не затрагивают запросы, исходящие из того же региона Azure, к которому относится учетная запись хранения. Используйте [правила виртуальной сети](#grant-access-from-a-virtual-network) для разрешения запросов из того же региона.

  > [!NOTE]
  > Службы, развернутые в том же регионе, что и учетная запись хранения, используют частные IP-адреса Azure для обмена данными. Поэтому нельзя ограничить доступ к определенным службам Azure на основе их общедоступного диапазона входящих IP-адресов.

Для настройки правил брандмауэра хранилища поддерживаются только IPV4-адреса.

Каждая учетная запись хранения поддерживает до 100 правил сети IP.

### <a name="configuring-access-from-on-premises-networks"></a>Настройка доступа из локальных сетей

Чтобы предоставить доступ из вашей локальной сети к учетной записи хранения в правиле IP-сети, необходимо определить IP-адреса для Интернета, которые используются в вашей сети. За помощью обращайтесь к администратору сети.

Если вы используете [ExpressRoute](/azure/expressroute/expressroute-introduction) для локальной среды, для общедоступного пиринга или пиринга Майкрософт, то вам необходимо определить используемые IP-адреса NAT. Для общедоступного пиринга в каждом канале ExpressRoute по умолчанию используется два IP-адреса NAT для трафика служб Azure, когда он входит в основную магистральную сеть Microsoft Azure. Для пиринга Майкрософт используются IP-адреса NAT, предоставленные клиентом или поставщиком услуг. Чтобы разрешить доступ к ресурсам служб, необходимо разрешить эти общедоступные IP-адреса в настройках брандмауэра IP-адресов ресурсов. Чтобы найти IP-адреса канала ExpressRoute для общедоступного пиринга, [отправьте запрос по ExpressRoute в службу поддержки](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Узнайте больше о [NAT для общедоступного пиринга и пиринга Майкрософт](/azure/expressroute/expressroute-nat#nat-requirements-for-azure-public-peering).

### <a name="managing-ip-network-rules"></a>Управление правилами IP-сети

Правилами IP-сети для учетных записей хранения можно управлять с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>портала Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. Чтобы предоставить доступ к диапазону IP-адресов в Интернете, введите IP-адрес или диапазон адресов (в формате CIDR) в разделе **Брандмауэр** > **Диапазон адресов**.

1. Чтобы удалить правило IP-сети, щелкните значок корзины рядом с диапазоном адресов.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Выведите список правил IP-сети.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").IPRules
    ```

1. Добавьте правило сети для отдельного IP-адреса.

    ```powershell
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.19"
    ```

1. Добавьте правило сети для диапазона IP-адресов.

    ```powershell
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.0/24"
    ```

1. Удалите правило сети для отдельного IP-адреса.

    ```powershell
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.19"
    ```

1. Удалите правило сети для диапазона IP-адресов.

    ```powershell
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.0/24"
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Выведите список правил IP-сети.

    ```azurecli
    az storage account network-rule list --resource-group "myresourcegroup" --account-name "mystorageaccount" --query ipRules
    ```

1. Добавьте правило сети для отдельного IP-адреса.

    ```azurecli
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.19"
    ```

1. Добавьте правило сети для диапазона IP-адресов.

    ```azurecli
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.0/24"
    ```

1. Удалите правило сети для отдельного IP-адреса.

    ```azurecli
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.19"
    ```

1. Удалите правило сети для диапазона IP-адресов.

    ```azurecli
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.0/24"
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

## <a name="exceptions"></a>Исключения

Сетевые правила помогают создать безопасную среду для подключений между приложениями и данными для большинства сценариев. Однако некоторые приложения используют службы, которые не могут быть однозначно изолированы с помощью правил виртуальной сети или IP-адреса. Но такие службы должны быть предоставлены для хранения, чтобы обеспечить полную функциональность приложения. В таких ситуациях можно использовать параметр ***Разрешить доверенные службы Майкрософт...*** , чтобы разрешить доступ к данным, журналам или аналитике.

### <a name="trusted-microsoft-services"></a>Доверенные службы Майкрософт

Некоторые службы Майкрософт работают с сетями, которые не могут быть добавлены в правила сети. Вы можете разрешить доступ к учетной записи хранения подмножеству таких доверенных служб Майкрософт, сохраняя сетевые правила для других приложений. Затем эти службы могут использовать надежную проверку подлинности для безопасного подключения к учетной записи хранения. Мы включили два типа доверенного доступа для служб Майкрософт.

- Ресурсам некоторых служб может быть предоставлен доступ к операциям выбора, таким как запись журналов или резервное копирование.
- Доступ к определенному экземпляру некоторых служб может быть предоставлен путем [назначения роли RBAC](storage-auth-aad.md#assign-rbac-roles-for-access-rights) экземпляру ресурса.


При включении **разрешения доверенных служб Майкрософт...** исключение следующие службы (зарегистрированные в вашей подписке) получают доступ к учетной записи хранения для операций выбора, как описано ниже.

| Служба                  | Имя поставщика ресурсов     | Цель                            |
|:------------------------ |:-------------------------- |:---------------------------------- |
| Служба Azure Backup             | Microsoft.RecoveryServices | Резервное копирование и восстановление неуправляемых дисков в виртуальных машинах IAAS. (Не требуется для управляемых дисков.) [Узнайте больше](/azure/backup/backup-introduction-to-azure-backup). |
| Устройство Azure Data Box           | Microsoft.DataBox          | Позволяет импортировать данные в Azure с помощью Data Box. [Узнайте больше](/azure/databox/data-box-overview). |
| Azure DevTest Labs       | Microsoft.DevTestLab       | Создание пользовательских образов и установка артефактов. [Узнайте больше](/azure/devtest-lab/devtest-lab-overview). |
| Сетка событий Azure         | Microsoft.EventGrid        | Включение публикации событий в хранилище BLOB-объектов и предоставление службе "Сетка событий" разрешения на публикацию в хранилище очередей. См. дополнительные сведения о [событиях хранилища BLOB-объектов](/azure/event-grid/event-sources) и [публикации в хранилище очередей](/azure/event-grid/event-handlers). |
| Центры событий Azure         | Microsoft.EventHub         | Архивация данных с помощью функции "Сбор" в Центрах событий. [Подробнее](/azure/event-hubs/event-hubs-capture-overview) |
| Синхронизация файлов Azure          | Microsoft.StorageSync      | Позволяет преобразовать локальный файловый сервер в кэш для файловых ресурсов Azure. Обеспечивается многосайтовая синхронизация, быстрое аварийное восстановление и резервное копирование на стороне облака. [Дополнительные сведения](../files/storage-sync-files-planning.md) |
| Azure HDInsight          | Microsoft.HDInsight        | Подготавливает начальное содержимое файловой системы по умолчанию для нового кластера HDInsight. [Узнайте больше](https://azure.microsoft.com/blog/enhance-hdinsight-security-with-service-endpoints/). |
| Служба "Машинное обучение Azure" | Microsoft.MachineLearningServices | Полномочные Машинное обучение Azure рабочие области записывают выходные данные эксперимента, модели и журналы в хранилище BLOB-объектов. [Узнайте больше](/azure/machine-learning/service/how-to-enable-virtual-network#use-a-storage-account-for-your-workspace). | 
| Azure Monitor            | Microsoft.Insights         | Позволяет записывать данные мониторинга в защищенную учетную запись. [Дополнительные сведения](/azure/monitoring-and-diagnostics/monitoring-roles-permissions-security). |
| Сеть Azure         | Microsoft.Network.          | Хранение и анализ журналов сетевого трафика. [Узнайте больше](/azure/network-watcher/network-watcher-packet-capture-overview). |
| Восстановление сайтов Azure      | Microsoft.SiteRecovery     | Включите репликацию для аварийного восстановления виртуальных машин IaaS Azure при использовании кэша, источника или целевых учетных записей хранения с поддержкой брандмауэра.  [Узнайте больше](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-tutorial-enable-replication). |

Исключение " **Разрешить доверенные службы Майкрософт...** " позволяет определенным экземплярам этих служб получить доступ к учетной записи хранения, если [управляемому системному удостоверению, назначенному](../../active-directory/managed-identities-azure-resources/overview.md) для экземпляра, назначается роль RBAC.

| Служба                  | Имя поставщика ресурсов          | Цель                            |
| :----------------------- | :------------------------------ | :--------------------------------- |
| Фабрика данных Azure       | Microsoft.DataFactory/factories; | Разрешает доступ к учетным записям хранения через среду выполнения ADF. |
| Azure Logic Apps         | Microsoft.Logic/workflows       | Позволяет приложениям логики получать доступ к учетным записям хранения. |
| Хранилище данных SQL Azure | Microsoft.Sql                   | Позволяет импортировать и экспортировать данные из конкретных экземпляров базы данных SQL с помощью Polybase. [Узнайте больше](/azure/sql-database/sql-database-vnet-service-endpoint-rule-overview). |
| Azure Stream Analytics   | Microsoft.StreamAnalytics       | Позволяет записывать данные из задания потоковой передачи в хранилище BLOB-объектов. Эта функция в настоящее время находится на стадии предварительной версии. [Узнайте больше](../../stream-analytics/blob-output-managed-identity.md). |


### <a name="storage-analytics-data-access"></a>Доступ к данным аналитики хранилища

В некоторых случаях доступ для чтения журналов диагностики и метрик нужно получать за пределами сети. При настройке доверенных служб для доступа к учетной записи хранения можно разрешить доступ для чтения для файлов журнала, таблиц метрик или и того, и другого. Дополнительные сведения о работе с аналитикой хранилища см. в [этой статье](/azure/storage/storage-analytics).

### <a name="managing-exceptions"></a>Управление исключениями

Исключениями из правил сети можно управлять с помощью портала Azure, PowerShell или Azure CLI v2.

#### <a name="azure-portal"></a>портала Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. Щелкните меню параметров **Брандмауэры и виртуальные сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. В разделе **Исключения** выберите те исключения, которые нужно предоставить.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Отобразите исключения для сетевых правил учетной записи хранения.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount").Bypass
    ```

1. Настройте исключения для сетевых правил учетной записи хранения.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -Bypass AzureServices,Metrics,Logging
    ```

1. Удалите исключения для сетевых правил учетной записи хранения.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -Bypass None
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе исключение не будет действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Отобразите исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account show --resource-group "myresourcegroup" --name "mystorageaccount" --query networkRuleSet.bypass
    ```

1. Настройте исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --bypass Logging Metrics AzureServices
    ```

1. Удалите исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --bypass None
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе исключение не будет действовать.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о конечных точках службы сети Azure см. в статье [Конечные точки службы виртуальной сети](/azure/virtual-network/virtual-network-service-endpoints-overview).

Более подробную информацию о безопасности службы хранилища Azure см. в статье [Руководство по безопасности службы хранилища Azure](storage-security-guide.md).
