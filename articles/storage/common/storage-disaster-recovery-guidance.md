---
title: Аварийное восстановление и отработка отказа учетной записи хранения (предварительная версия) в службе хранилища Azure
description: Служба хранилища Azure поддерживает отработку отказа (предварительная версия) для учетных записей геоизбыточного хранилища. Отработка отказа учетной записи позволяет инициировать процесс отработки отказа для учетной записи хранения в тех случаях, когда основная конечная точка становится недоступной.
services: storage
author: tamram
ms.service: storage
ms.topic: article
ms.date: 02/25/2019
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: f9d68af12f6b2e98c77d0bd1b65a82c69588f203
ms.sourcegitcommit: f6ba5c5a4b1ec4e35c41a4e799fb669ad5099522
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65147618"
---
# <a name="disaster-recovery-and-storage-account-failover-preview-in-azure-storage"></a>Аварийное восстановление и отработка отказа учетной записи хранения (предварительная версия) в службе хранилища Azure

Корпорация Майкрософт стремится непрерывно поддерживать доступность служб Azure. Но иногда могут происходить незапланированные сбои служб. Если для вашего приложения важна устойчивость, мы рекомендуем использовать геоизбыточное хранилище, данные из которого реплицируются в другой регион. Кроме того, клиентам следует иметь план аварийного восстановления на случай регионального сбоя служб. Важной частью плана аварийного восстановления является подготовка к отработке отказа на вторичную конечную точку в случаях, когда основная конечная точка станет недоступной. 

Служба хранилища Azure поддерживает отработку отказа (предварительная версия) для учетных записей геоизбыточного хранилища. Отработка отказа учетной записи позволяет инициировать процесс отработки отказа для учетной записи хранения в тех случаях, когда основная конечная точка становится недоступной. Отработка отказа преобразует вторичную конечную точку в основную конечную точку учетной записи хранения. Когда отработка отказа завершится, клиенты смогут записывать данные в новую основную конечную точку.

В этой статье описываются концепции и процессы, применимые для отработки отказа учетной записи, а также обсуждается подготовка учетной записи хранения для восстановления, позволяющая снизить негативное влияние на клиентов. Сведения о том, как запустить отработку отказа учетной записи (предварительная версия) с помощью портала Azure или PowerShell, вы найдете в [этой статье](storage-initiate-account-failover.md).


[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="choose-the-right-redundancy-option"></a>Выбор правильного уровня избыточности

Все учетные записи хранения реплицируются для обеспечения избыточности. Выбор уровня избыточности для учетной записи зависит от требуемой степени устойчивости. Для защиты от региональных сбоев выберите геоизбыточное хранилище, с доступом на чтение (необязательно) из дополнительного региона.  

**Геоизбыточное хранилище (GRS)** асинхронно реплицирует данные между двумя географическими регионами, которые разделены сотнями километров. Если в основном регионе произойдет сбой, дополнительный регион берет на себя роль резервного источника данных. Вы сможете запустить отработку отказа, чтобы вторичная конечная точка стала основной конечной точкой.

**Геоизбыточное хранилище с доступом на чтение (RA-GRS)** предоставляет геоизбыточное хранилище с дополнительной возможностью доступна на чтение к вторичной конечной точке. В случае сбоя основной конечной точки все приложения, поддерживающие RA-GRS и высокий уровень доступности, сохраняют возможность чтения данных из вторичной конечной точки. Корпорация Майкрософт рекомендует применять RA-GRS для обеспечения максимальной устойчивости приложений.

Служба хранилища Azure предоставляет и другие варианты избыточности: хранилище, избыточное между зонами (ZRS), которое реплицирует данные между зонами доступности в одном регионе, и локально избыточное хранилище (LRS), которое реплицирует данные в одном центре обработки данных в одном регионе. Если для учетной записи хранения настроен вариант ZRS или LRS, такую учетную запись можно преобразовать для использования GRS или RA-GRS. Настройка учетной записи геоизбыточного хранилища влечет за собой дополнительные затраты. Дополнительные сведения см. в статье [Репликация службы хранилища Azure](storage-redundancy.md).

> [!WARNING]
> Геоизбыточное хранилище имеет риск потери данных. Данные реплицируются в дополнительный регион в асинхронном режиме, то есть существует некоторая задержка между записью в основной регион и в дополнительный регион. В случае сбоя будут потеряны все операции записи, которые выполнены на основной конечной точке, но еще не реплицированы на дополнительную конечную точку. 

## <a name="design-for-high-availability"></a>Учет высокого уровня доступности при проектировании

Очень важно, чтобы разработка приложений изначально велась с учетом высокого уровня доступности. Здесь представлены ресурсы Azure, которые помогут вам в разработке приложений и при планировании аварийного восстановления.

* [Проектирование устойчивых приложений для Azure](https://docs.microsoft.com/azure/architecture/resiliency/). Обзор основных понятий, применимых при разработке в Azure приложений с высоким уровнем доступности.
* [Контрольный список для обеспечения доступности](https://docs.microsoft.com/azure/architecture/checklist/availability). Контрольный список, позволяющий проверить соблюдение в приложении передовых рекомендаций по разработке для обеспечения доступности.
* [Проектирование высокодоступных приложений с использованием RA-GRS](storage-designing-ha-apps-with-ragrs.md). Руководство по проектированию, позволяющее применить в приложениях преимущества RA-GRS.
* [Руководство Создание высокодоступного приложения с помощью хранилища BLOB-объектов](../blobs/storage-create-geo-redundant-storage.md). В этом руководстве показано, как создавать приложения с высоким уровнем доступности, которые автоматически переключаются между конечными точками при моделировании сбоев и восстановления работоспособности. 

Кроме того, учитывайте следующие рекомендации, которые помогут поддерживать высокий уровень доступности для данных в хранилище Azure.

* **Диски**. Используйте [Azure Backup](https://azure.microsoft.com/services/backup/) для резервного копирования дисков, используемых виртуальными машинами Azure. Также рассмотрите возможность применить [Azure Site Recovery](https://azure.microsoft.com/services/site-recovery/) для защиты виртуальных машин на случай региональной аварии.
* **Блочные BLOB-объекты**. Включите [обратимое удаление](../blobs/storage-blob-soft-delete.md), чтобы предотвратить удаление и перезапись на уровне объектов, или скопируйте блочные BLOB-объекты в другую учетную запись хранения, относящуюся к другому региону, с помощью [AzCopy](storage-use-azcopy.md), [Azure PowerShell](storage-powershell-guide-full.md) или [библиотеки перемещения данных Azure](https://azure.microsoft.com/blog/introducing-azure-storage-data-movement-library-preview-2/).
* **Файлы**. С помощью [AzCopy](storage-use-azcopy.md) или [Azure PowerShell](storage-powershell-guide-full.md) скопируйте файлы в другую учетную запись хранения, относящуюся к другому региону.
* **Таблицы**. Используйте [AzCopy](storage-use-azcopy.md) для экспорта данных из таблиц в другую учетную запись хранения, относящуюся к другому региону.

## <a name="track-outages"></a>Отслеживание сбоев

Клиенты могут подписаться на использование [панели мониторинга Работоспособности служб Azure](https://azure.microsoft.com/status/), которая позволяет отслеживать работоспособность и состояние службы хранилища Azure и других служб Azure.

Кроме того, корпорация Майкрософт рекомендует учесть в приложении возможность сбоев при записи. Приложение должно информировать о сбоях при записи, чтобы вы своевременно получали сведения о возможных сбоях в основном регионе.

## <a name="understand-the-account-failover-process"></a>Сведения о процессе отработки отказа учетной записи

Отработка отказа учетной записи под управлением пользователя (предварительная версия) позволяет переместить всю учетную запись хранения в дополнительный регион, если основной регион становится недоступным по любой причине. Когда вы запустите отработку отказа в дополнительный регион, после ее завершения клиенты смогут записывать данные через дополнительную конечную точку. Отработка отказа обычно занимает около часа.

### <a name="how-an-account-failover-works"></a>Процесс отработки отказа учетной записи

В обычных условиях клиент записывает данные в учетную запись службы хранилища Azure в основном регионе, и все эти данные асинхронно реплицируются в дополнительный регион. Ниже представлен сценарий с доступным основным регионом:

![Клиенты записывают данные в учетную запись хранения в основном регионе](media/storage-disaster-recovery-guidance/primary-available.png)

Если основная конечная точка становится недоступной по любой причине, клиент не сможет записывать данные в эту учетную запись хранения. На следующем изображении представлен сценарий, в котором основная конечная точка стала недоступной, но восстановление еще не произошло:

![Основная конечная точка недоступна, клиенты не могут записывать данные](media/storage-disaster-recovery-guidance/primary-unavailable-before-failover.png)

Теперь клиент инициирует отработку отказа учетной записи на вторичную конечную точку. Процесс отработки отказа обновляет запись DNS, предоставленную службой хранилища Azure, и теперь вторичная конечная точка становится основной конечной точкой этой учетной записи хранения, как показано на следующем изображении:

![Клиент инициирует отработку отказа учетной записи на вторичную конечную точку](media/storage-disaster-recovery-guidance/failover-to-secondary.png)

Доступ на запись восстанавливается для учетных записей GRS и RA-GRS, как только обновится DNS-запись. Все запросы теперь направляются на новую основную конечную точку. После отработки отказа сохраняются все существующие конечные точки службы хранилища для больших двоичных объектов, таблиц, очередей и файлов.

> [!IMPORTANT]
> Когда завершится отработка отказа, учетная запись хранения станет локально избыточной в новой основной конечной точке. Чтобы возобновить репликацию на новую вторичную конченую точку, повторно настройте географически избыточное хранилище (GRS или RA-GRS) для этой учетной записи.
>
> Имейте в виду, что преобразование учетной записи из LRS в RA-GRS или GRS подразумевает дополнительные затраты. Эти затраты распространяются и на включение RA-GRS или GRS для учетной записи хранения в новом основном регионе после отработки отказа.  

### <a name="anticipate-data-loss"></a>Подготовка к потерям данных

> [!CAUTION]
> Отработка отказа учетной записи обычно сопровождается некоторой потерей данных. Важно хорошо понимать, какие последствия влечет за собой отработка отказа учетной записи.  

Как вы помните, данные реплицируются в дополнительный регион в асинхронном режиме, то есть всегда существует некоторая задержка между записью в основной регион и репликацией в дополнительный регион. Если основной регион становится недоступным, последние записанные данные, возможно, еще не реплицированы в дополнительный регион.

При запуске отработки отказа все данные в основном регионе утрачиваются, так как дополнительный регион теперь становится новым основным регионом, а учетная запись хранения и дальше действует как локально избыточное хранилище. Все данные, которые уже реплицированы на сервер-получатель, при отработке отказа сохраняются. Но те данные, которые записаны в основном регионе, но не успели реплицироваться в дополнительный регион, утрачиваются без возможности восстановления. 

Свойство **Время последней синхронизации** обозначает самое позднее время, за которое гарантирована запись данных из основного в дополнительный регион. Все данные до момента последней синхронизации будут доступны на вторичной конечной точке, а более поздние данные могут быть утрачены, если они еще не были реплицированы. Используйте это свойство в случае сбоя, чтобы оценить объем данных, которые вы можете потерять при запуске отработки отказа учетной записи. 

Мы рекомендуем проектировать приложение таким образом, чтобы время последней синхронизации позволяло оценить ожидаемую потерю данных. Например, если вы ведете журнал операций записи, у вас будет возможность сравнить время последней операции записи с временем последней синхронизации и определить, какие операции записи не синхронизированы в дополнительном регионе.

### <a name="use-caution-when-failing-back-to-the-original-primary"></a>Соблюдайте осторожность при возврате на исходную основную конечную точку

После отработки отказа из основного в дополнительный регион для учетной записи хранения применяется режим локально избыточного хранилища в новом основном регионе. Вы можете восстановить режим географической избыточности для этой учетной записи, настроив для нее использование GRS или RA-GRS. Как только вы включите географическую избыточность для учетной записи после отработки отказа, новый основной регион начинает репликацию данных в новый дополнительный регион, который до отработки отказа был основным регионом. Полная репликация существующих данных основного региона может потребовать значительного времени.

Когда завершится настройка географической избыточности для учетной записи хранения, вы сможете снова инициировать отработку отказа из нового основного региона в новый дополнительный. В этом случае регион, который был основным до отработки отказа, снова станет основным регионом в режиме локально избыточного хранилища. При этом утрачиваются все данные в регионе, который был основным после отработки отказа (исходном дополнительном регионе). Если большая часть данных в учетной записи хранения еще не была реплицирована на новый вторичный сервер перед восстановлением размещения, потери данных могут оказаться значительными. 

Чтобы избежать критических потерь данных, обязательно проверьте значение свойства **Время последней синхронизации** перед восстановлением размещения. Сравните время последней синхронизации с временем последней записи данных на новую первичную конечную точку, чтобы оценить ожидаемые потери данных. 

## <a name="initiate-an-account-failover"></a>Инициирование отработки отказа учетной записи

Вы можете инициировать отработку отказа учетной записи с помощью портала Azure, PowerShell, Azure CLI или API поставщика ресурсов службы хранилища Azure. Дополнительные сведения о запуске отработки отказа учетной записи (предварительная версия) вы найдете в [этой статье](storage-initiate-account-failover.md).

## <a name="about-the-preview"></a>Сведения о предварительной версии

Отработка отказа учетной записи доступна в предварительной версии для всех клиентов, которые используют GRS или RA-GRS для развертываний Azure Resource Manager. Поддерживаются учетные записи хранения следующих типов: общего назначения версии 1, общего назначения версии 2 и BLOB-объектов. Сейчас отработка отказа учетной записи доступна в следующих регионах.

- Западная часть США 2
- Центрально-западная часть США

Эта предварительная версия не предназначена для использования в рабочей среде. Соглашения об уровне обслуживания (SLA) для рабочих сред сейчас недоступны.

### <a name="register-for-the-preview"></a>Зарегистрируйтесь для использования предварительной версии

Чтобы зарегистрироваться для использования предварительной версии, выполните в PowerShell следующую команду. Обязательно замените заполнитель в скобках реальным идентификатором подписки:

```powershell
Connect-AzAccount -SubscriptionId <subscription-id>
Register-AzProviderFeature -FeatureName CustomerControlledFailover -ProviderNamespace Microsoft.Storage
```

Подтверждение регистрации для предварительного просмотра может потребовать 1–2 дня. Чтобы проверить подтверждение регистрации, выполните следующую команду:

```powershell
Get-AzProviderFeature -FeatureName CustomerControlledFailover -ProviderNamespace Microsoft.Storage
```

### <a name="additional-considerations"></a>Дополнительные замечания 

Изучите дополнительные рекомендации в этом разделе, чтобы понять влияние принудительной отработки отказа на приложения и службы в период действия предварительной версии.

#### <a name="azure-virtual-machines"></a>Виртуальные машины Azure

Отработка отказа учетной записи не распространяется на виртуальные машины Azure. Если основной регион становится недоступным и вы выполняете отработку отказа в дополнительный регион, после нее потребуется повторно создать виртуальные машины. 

#### <a name="azure-unmanaged-disks"></a>Неуправляемые диски Azure

Корпорация Майкрософт рекомендует преобразовать все неуправляемые диски в управляемые диски. Тем не менее, если вам потребуется отработка отказа учетной записи, которая содержит неуправляемые диски, подключенные к виртуальным машинам Azure, перед выполнением такой отработки отказа вам придется завершить работу виртуальной машины.

Неуправляемые диски содержатся в службе хранилища Azure в виде страничных BLOB-объектов. Пока виртуальная машина работает в Azure, все подключенные к ней неуправляемые диски считаются арендованными. Но отработка отказа учетной записи не может выполняться, пока существует аренда большого двоичного объекта. В этой ситуации выполните следующие действия.

1. Перед началом отработки отказа запишите имена всех неуправляемых дисков, их логические номера устройств (LUN) и имена виртуальных машин, к которым они подключены. Это упростит восстановление подключений после отработки отказа. 
2. Выключите виртуальную машину.
3. Удалите виртуальную машину, сохраняя файлы VHD для неуправляемых дисков. Зафиксируйте время удаления виртуальной машины.
4. Дождитесь, пока параметр **Время последней синхронизации** будет содержать более позднее время, чем время удаления виртуальной машины. Этот шаг очень важен! Если вторичная конечная точка не получит полностью файлы VHD перед отработкой отказа, то виртуальная машина в новом основном регионе может работать неправильно.
5. Запустите отработку отказа учетной записи.
6. Дождитесь, пока отработка отказа учетной записи завершится, и дополнительный регион станет новым основным регионом.
7. Создайте виртуальную машину в новом основном регионе и присоедините к ней виртуальные жесткие диски.
8. Запустите новую виртуальную машину.

Не забывайте, что все хранимые данные на временном диске теряются при выключении виртуальной машины.

### <a name="unsupported-features-or-services"></a>Неподдерживаемые функции и службы
Следующие функции и службы не поддерживаются для отработки отказа учетной записи в режиме предварительной версии.

- Служба синхронизации файлов Azure не поддерживает отработку отказа учетной записи хранения. Не следует применять отработку отказа для учетных записей хранения, которые содержат файловые ресурсы Azure, используемые в качестве облачных конечных точек в службе синхронизации файлов Azure. Это приведет к прекращению синхронизации или даже к непредвиденной потере данных, если некоторые файлы недавно стали многоуровневыми.  
- Невозможно выполнить отработку отказа для учетных записей хранения, которые используют иерархическое пространство имен Azure Data Lake Storage 2-го поколения.
- Невозможно выполнить отработку отказа для учетной записи хранения, которая содержит архивированные большие двоичные объекты. Размещайте архивированные большие двоичные объекты в отдельной учетной записи хранения, для которой не требуется отработка отказа.
- Невозможно выполнить отработку отказа для учетной записи хранения, которая содержит блочные BLOB-объекты уровня "Премиум". Учетные записи хранения, которые поддерживают блочные BLOB-объекты уровня "Премиум", сейчас не поддерживают географическую избыточность.
- После завершения отработки отказа следующие функции перестанут работать, если изначально включен: [Подписки на события](https://docs.microsoft.com/azure/storage/blobs/storage-blob-event-overview), [политики жизненного цикла](https://docs.microsoft.com/azure/storage/blobs/storage-lifecycle-management-concepts), [ведение журнала аналитики хранилища](https://docs.microsoft.com/rest/api/storageservices/about-storage-analytics-logging).

## <a name="copying-data-as-an-alternative-to-failover"></a>Копирование данных вместо отработки отказа

Если для вашей учетной записи хранения настроен режим RA-GRS, у вас есть доступ на чтение к данным в дополнительной конечной точке. В случае сбоя в основном регионе вы можете не применять отработку отказа, а просто скопировать данные из учетной записи хранения в дополнительном регионе в другую учетную запись в регионе, не испытывающем проблем, с помощью [AzCopy](storage-use-azcopy.md), [Azure PowerShell](storage-powershell-guide-full.md) или [библиотеки перемещения данных Azure](https://azure.microsoft.com/blog/introducing-azure-storage-data-movement-library-preview-2/). После этого направьте приложения в новую учетную запись хранения для всех операций чтения и записи.

## <a name="microsoft-managed-failover"></a>Отработка отказа под управлением корпорации Майкрософт

В экстренных ситуациях, когда значительная авария приводит к неработоспособности целого региона, корпорация Майкрософт может инициировать отработку отказа между регионами. В этом случае вам не нужно предпринимать какие-либо действия. До завершения отработки отказа под управлением корпорации Майкрософт вы не получите доступ на запись к учетной записи хранения. Приложения смогут считывать данные из дополнительного региона, если для учетной записи хранения настроен режим RA-GRS. 

## <a name="see-also"></a>См. также

* [Initiate a storage account failover (preview)](storage-initiate-account-failover.md) (Запуск отработки отказа учетной записи (предварительная версия))
* [Проектирование высокодоступных приложений с использованием RA-GRS](storage-designing-ha-apps-with-ragrs.md)
* [Руководство Создание высокодоступного приложения с помощью хранилища BLOB-объектов](../blobs/storage-create-geo-redundant-storage.md). 
