---
title: Сбой в восстановлении и хранении хранилища (предварительный просмотр)
titleSuffix: Azure Storage
description: Служба хранилища Azure поддерживает отработку отказа (предварительная версия) для учетных записей геоизбыточного хранилища. Отработка отказа учетной записи позволяет инициировать процесс отработки отказа для учетной записи хранения в тех случаях, когда основная конечная точка становится недоступной.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 01/23/2020
ms.author: tamram
ms.reviewer: artek
ms.subservice: common
ms.openlocfilehash: f7a8f6d0d3ab3b456c41128da9b689f6b7eda0f7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79365375"
---
# <a name="disaster-recovery-and-account-failover-preview"></a>Восстановление аварийного восстановления и сбой учетной записи (предварительный просмотр)

Корпорация Майкрософт стремится непрерывно поддерживать доступность служб Azure. Но иногда могут происходить незапланированные сбои служб. Если вашему приложению требуется устойчивость, корпорация Майкрософт рекомендует использовать геоизбыточное хранилище, чтобы ваши данные были скопированы во второй регион. Кроме того, клиентам следует иметь план аварийного восстановления на случай регионального сбоя служб. Важной частью плана аварийного восстановления является подготовка к отработке отказа на вторичную конечную точку в случаях, когда основная конечная точка станет недоступной.

Служба хранилища Azure поддерживает отработку отказа (предварительная версия) для учетных записей геоизбыточного хранилища. Отработка отказа учетной записи позволяет инициировать процесс отработки отказа для учетной записи хранения в тех случаях, когда основная конечная точка становится недоступной. Отработка отказа преобразует вторичную конечную точку в основную конечную точку учетной записи хранения. Когда отработка отказа завершится, клиенты смогут записывать данные в новую основную конечную точку.

[!INCLUDE [updated-for-az](../../../includes/storage-data-lake-gen2-support.md)]

В этой статье описываются концепции и процессы, применимые для отработки отказа учетной записи, а также обсуждается подготовка учетной записи хранения для восстановления, позволяющая снизить негативное влияние на клиентов. Сведения о том, как запустить отработку отказа учетной записи (предварительная версия) с помощью портала Azure или PowerShell, вы найдете в [этой статье](storage-initiate-account-failover.md).

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="choose-the-right-redundancy-option"></a>Выбор правильного уровня избыточности

Azure Storage поддерживает несколько копий учетной записи хранилища, чтобы обеспечить долговечность и высокую доступность. Выбор уровня избыточности для учетной записи зависит от требуемой степени устойчивости. Для защиты от региональных сбоев выберите геоизбыточное хранилище, с доступом на чтение (необязательно) из дополнительного региона.  

**Гео-избыточное хранилище (GRS) или гео-зонно-избыточное хранилище (ГЗРС) (предварительный просмотр)** копирует ваши данные асинхронно в двух географических регионах, которые находятся по крайней мере на сотни миль друг от друга. Если в основном регионе произойдет сбой, дополнительный регион берет на себя роль резервного источника данных. Вы сможете запустить отработку отказа, чтобы вторичная конечная точка стала основной конечной точкой.

**Гео-излишнее хранилища (RA-GRS) или геозоны-избыточного хранилища (RA-G'S) (предварительный просмотр)** обеспечивает геоизбыточное хранилище с дополнительным преимуществом доступа к вторичной конечной точке. В случае сбоя основной конечной точки все приложения, поддерживающие RA-GRS и высокий уровень доступности, сохраняют возможность чтения данных из вторичной конечной точки. Корпорация Майкрософт рекомендует применять RA-GRS для обеспечения максимальной устойчивости приложений.

Для получения дополнительной информации об избыточности [Azure Storage redundancy](storage-redundancy.md)в хранилище Azure см.

> [!WARNING]
> Геоизбыточное хранилище имеет риск потери данных. Данные копируются в вторичном регионе асинхронно, что означает задержку между тем, когда данные, записанные в первичный регион, записываются во вторичный регион. В случае сбоя операции на основной конечной точке, которые еще не были скопированы на вторичную конечную точку, будут потеряны.

## <a name="design-for-high-availability"></a>Учет высокого уровня доступности при проектировании

Очень важно, чтобы разработка приложений изначально велась с учетом высокого уровня доступности. Здесь представлены ресурсы Azure, которые помогут вам в разработке приложений и при планировании аварийного восстановления.

- [Разработка устойчивых приложений для Azure](/azure/architecture/checklist/resiliency-per-service): Обзор ключевых концепций проектирования высокодоступных приложений в Azure.
- [Контрольный список доступности](/azure/architecture/checklist/resiliency-per-service): Контрольный список для проверки того, что ваше приложение реализует лучшие методы проектирования для высокой доступности.
- [Проектирование высокодоступных приложений с использованием RA-GRS](storage-designing-ha-apps-with-ragrs.md): Руководство по проектированию для строительных приложений, чтобы воспользоваться преимуществами RA-GRS.
- [Учебник: Создайте высокодоступное приложение с помощью хранилища Blob:](../blobs/storage-create-geo-redundant-storage.md)учебник, который показывает, как построить высокодоступное приложение, которое автоматически переключается между конечными точками по мере имитации сбоев и восстановления. 

Кроме того, учитывайте следующие рекомендации, которые помогут поддерживать высокий уровень доступности для данных в хранилище Azure.

- **Диски:** Используйте [резервное копирование Azure](https://azure.microsoft.com/services/backup/) для резервного копирования VM-дисков, используемых виртуальными машинами Azure. Также рассмотрите возможность применить [Azure Site Recovery](https://azure.microsoft.com/services/site-recovery/) для защиты виртуальных машин на случай региональной аварии.
- **Блок капли:** Включите [мягкое удаление](../blobs/storage-blob-soft-delete.md) для защиты от удалений и перезаписей уровня объекта, или скопируйте блокировку капли на другую учетную запись в другом регионе с помощью [AzCopy,](storage-use-azcopy.md) [Azure PowerShell](storage-powershell-guide-full.md)или [библиотеки Движения данных Azure.](https://azure.microsoft.com/blog/introducing-azure-storage-data-movement-library-preview-2/)
- **Файлы:** Используйте [AzCopy](storage-use-azcopy.md) или [Azure PowerShell](storage-powershell-guide-full.md) для копирования файлов на другую учетную запись хранения в другом регионе.
- **Таблицы**. Используйте [AzCopy](storage-use-azcopy.md) для экспорта данных из таблиц в другую учетную запись хранения, относящуюся к другому региону.

## <a name="track-outages"></a>Отслеживание сбоев

Клиенты могут подписаться на использование [панели мониторинга Работоспособности служб Azure](https://azure.microsoft.com/status/), которая позволяет отслеживать работоспособность и состояние службы хранилища Azure и других служб Azure.

Кроме того, корпорация Майкрософт рекомендует учесть в приложении возможность сбоев при записи. Приложение должно информировать о сбоях при записи, чтобы вы своевременно получали сведения о возможных сбоях в основном регионе.

## <a name="understand-the-account-failover-process"></a>Сведения о процессе отработки отказа учетной записи

Отработка отказа учетной записи под управлением пользователя (предварительная версия) позволяет переместить всю учетную запись хранения в дополнительный регион, если основной регион становится недоступным по любой причине. Когда вы запустите отработку отказа в дополнительный регион, после ее завершения клиенты смогут записывать данные через дополнительную конечную точку. Отработка отказа обычно занимает около часа.

### <a name="how-an-account-failover-works"></a>Процесс отработки отказа учетной записи

При обычных обстоятельствах клиент записывает данные на учетную запись Хранилища Azure в основном регионе, и эти данные копируются асинхронно во вторичную область. Ниже представлен сценарий с доступным основным регионом:

![Клиенты записывают данные в учетную запись хранения в основном регионе](media/storage-disaster-recovery-guidance/primary-available.png)

Если основная конечная точка становится недоступной по любой причине, клиент не сможет записывать данные в эту учетную запись хранения. На следующем изображении представлен сценарий, в котором основная конечная точка стала недоступной, но восстановление еще не произошло:

![Основная конечная точка недоступна, клиенты не могут записывать данные](media/storage-disaster-recovery-guidance/primary-unavailable-before-failover.png)

Теперь клиент инициирует отработку отказа учетной записи на вторичную конечную точку. Процесс отработки отказа обновляет запись DNS, предоставленную службой хранилища Azure, и теперь вторичная конечная точка становится основной конечной точкой этой учетной записи хранения, как показано на следующем изображении:

![Клиент инициирует отработку отказа учетной записи на вторичную конечную точку](media/storage-disaster-recovery-guidance/failover-to-secondary.png)

Доступ на запись восстанавливается для учетных записей GRS и RA-GRS, как только обновится DNS-запись. Все запросы теперь направляются на новую основную конечную точку. После отработки отказа сохраняются все существующие конечные точки службы хранилища для больших двоичных объектов, таблиц, очередей и файлов.

> [!IMPORTANT]
> Когда завершится отработка отказа, учетная запись хранения станет локально избыточной в новой основной конечной точке. Чтобы возобновить репликацию на новую вторичную конченую точку, повторно настройте географически избыточное хранилище (GRS или RA-GRS) для этой учетной записи.
>
> Имейте в виду, что преобразование учетной записи из LRS в RA-GRS или GRS подразумевает дополнительные затраты. Эти затраты распространяются и на включение RA-GRS или GRS для учетной записи хранения в новом основном регионе после отработки отказа.  

### <a name="anticipate-data-loss"></a>Подготовка к потерям данных

> [!CAUTION]
> Отработка отказа учетной записи обычно сопровождается некоторой потерей данных. Важно хорошо понимать, какие последствия влечет за собой отработка отказа учетной записи.  

Поскольку данные написаны асинхронно от первичного региона до вторичного региона, всегда есть задержка, прежде чем запись в первичный регион копируется во вторичную область. Если первичный регион становится недоступен, последние записи, возможно, еще не были скопированы во второстепенный регион.

При запуске отработки отказа все данные в основном регионе утрачиваются, так как дополнительный регион теперь становится новым основным регионом, а учетная запись хранения и дальше действует как локально избыточное хранилище. Все данные, уже скопированные на вторичное, сохраняются при сбою. Однако любые данные, записанные на праймериз, которые также не были скопированы на вторичку, теряются навсегда.

Свойство **Время последней синхронизации** обозначает самое позднее время, за которое гарантирована запись данных из основного в дополнительный регион. Все данные до момента последней синхронизации будут доступны на вторичной конечной точке, а более поздние данные могут быть утрачены, если они еще не были реплицированы. Используйте это свойство в случае сбоя, чтобы оценить объем данных, которые вы можете потерять при запуске отработки отказа учетной записи.

Мы рекомендуем проектировать приложение таким образом, чтобы время последней синхронизации позволяло оценить ожидаемую потерю данных. Например, если вы ведете журнал операций записи, у вас будет возможность сравнить время последней операции записи с временем последней синхронизации и определить, какие операции записи не синхронизированы в дополнительном регионе.

### <a name="use-caution-when-failing-back-to-the-original-primary"></a>Соблюдайте осторожность при возврате на исходную основную конечную точку

После отработки отказа из основного в дополнительный регион для учетной записи хранения применяется режим локально избыточного хранилища в новом основном регионе. Вы можете восстановить режим географической избыточности для этой учетной записи, настроив для нее использование GRS или RA-GRS. Когда учетная запись настроена для геоизбыточности снова после сбоя, новый первичный регион немедленно начинает копировать данные в новый вторичный регион, который был основным до первоначального сбоя. Однако может потребоваться некоторое время, прежде чем существующие данные в первичном объеме будут полностью скопированы на новые вторичные.

Когда завершится настройка географической избыточности для учетной записи хранения, вы сможете снова инициировать отработку отказа из нового основного региона в новый дополнительный. В этом случае регион, который был основным до отработки отказа, снова станет основным регионом в режиме локально избыточного хранилища. При этом утрачиваются все данные в регионе, который был основным после отработки отказа (исходном дополнительном регионе). Если большая часть данных в учетной записи хранилища не была скопирована на новую вторичную, прежде чем вы отыснитесь назад, вы можете пострадать от значительной потери данных.

Чтобы избежать критических потерь данных, обязательно проверьте значение свойства **Время последней синхронизации** перед восстановлением размещения. Сравните время последней синхронизации с временем последней записи данных на новую первичную конечную точку, чтобы оценить ожидаемые потери данных. 

## <a name="initiate-an-account-failover"></a>Инициирование отработки отказа учетной записи

Вы можете инициировать отработку отказа учетной записи с помощью портала Azure, PowerShell, Azure CLI или API поставщика ресурсов службы хранилища Azure. Дополнительные сведения о запуске отработки отказа учетной записи (предварительная версия) вы найдете в [этой статье](storage-initiate-account-failover.md).

## <a name="about-the-preview"></a>Сведения о предварительной версии

Сбой учетной записи доступен в предварительном просмотре для всех клиентов, использующих GRS или RA-GRS с развертыванием менеджера ресурсов Azure. Поддерживаются учетные записи хранения следующих типов: общего назначения версии 1, общего назначения версии 2 и BLOB-объектов. Сбой учетной записи в настоящее время доступен во всех публичных регионах. Сбой счета недоступен в суверенных/национальных облаках в настоящее время.

Эта предварительная версия не предназначена для использования в рабочей среде. Соглашения об уровне обслуживания (SLA) для рабочих сред сейчас недоступны.

### <a name="additional-considerations"></a>Дополнительные сведения

Изучите дополнительные рекомендации в этом разделе, чтобы понять влияние принудительной отработки отказа на приложения и службы в период действия предварительной версии.

#### <a name="storage-account-containing-archived-blobs"></a>Учетная запись хранения, содержащая архивные капли

Учетные записи хранения, содержащие архивные капли поддержки учетной записи неудачу. После того, как неудача завершена, чтобы преобразовать учетную запись обратно в GRS или RA-GRS все архивные капли должны быть регидратированы в онлайн-уровня в первую очередь.

#### <a name="storage-resource-provider"></a>Поставщик ресурсов хранилища

После завершения сбоя клиенты могут снова читать и записывать данные хранилища Azure в новом первичном регионе. Однако поставщик ресурсов ресурсов Azure Storage не переувимся, поэтому операции по управлению ресурсами все равно должны осуществляться в основном регионе. Если основная область недоступна, вы не сможете выполнять операции управления на учетной записи хранилища.

Поскольку поставщик ресурсов ресурсов Azure Storage не завершает работу, свойство [местоположения](/dotnet/api/microsoft.azure.management.storage.models.trackedresource.location) возвращает исходное местоположение после завершения сбоя.

#### <a name="azure-virtual-machines"></a>Виртуальные машины Azure

Отработка отказа учетной записи не распространяется на виртуальные машины Azure. Если основной регион становится недоступным и вы выполняете отработку отказа в дополнительный регион, после нее потребуется повторно создать виртуальные машины. Кроме того, существует потенциальная потеря данных, связанная с сбой учетной записи. Корпорация Майкрософт рекомендует следующие рекомендации по [высокой доступности](../../virtual-machines/windows/manage-availability.md) и [аварийному восстановлению,](../../virtual-machines/virtual-machines-disaster-recovery-guidance.md) характерные для виртуальных машин в Azure.

#### <a name="azure-unmanaged-disks"></a>Неуправляемые диски Azure

Корпорация Майкрософт рекомендует преобразовать все неуправляемые диски в управляемые диски. Тем не менее, если вам потребуется отработка отказа учетной записи, которая содержит неуправляемые диски, подключенные к виртуальным машинам Azure, перед выполнением такой отработки отказа вам придется завершить работу виртуальной машины.

Неуправляемые диски содержатся в службе хранилища Azure в виде страничных BLOB-объектов. Пока виртуальная машина работает в Azure, все подключенные к ней неуправляемые диски считаются арендованными. Но отработка отказа учетной записи не может выполняться, пока существует аренда большого двоичного объекта. В этой ситуации выполните следующие действия.

1. Перед началом отработки отказа запишите имена всех неуправляемых дисков, их логические номера устройств (LUN) и имена виртуальных машин, к которым они подключены. Это упростит восстановление подключений после отработки отказа.
2. Выключите виртуальную машину.
3. Удалите виртуальную машину, сохраняя файлы VHD для неуправляемых дисков. Зафиксируйте время удаления виртуальной машины.
4. Дождитесь, пока параметр **Время последней синхронизации** будет содержать более позднее время, чем время удаления виртуальной машины. Этот шаг очень важен! Если вторичная конечная точка не получит полностью файлы VHD перед отработкой отказа, то виртуальная машина в новом основном регионе может работать неправильно.
5. Запустите отработку отказа учетной записи.
6. Дождитесь, пока отработка отказа учетной записи завершится, и дополнительный регион станет новым основным регионом.
7. Создайте виртуальную машину в новом основном регионе и присоедините к ней виртуальные жесткие диски.
8. Запустите новую виртуальную машину.

Не забывайте, что все хранимые данные на временном диске теряются при выключении виртуальной машины.

### <a name="unsupported-features-and-services"></a>Неподдерживаемые функции и службы

Следующие функции и службы не поддерживаются для сбоя учетной записи для предварительного выпуска:

- Служба синхронизации файлов Azure не поддерживает отработку отказа учетной записи хранения. Не следует применять отработку отказа для учетных записей хранения, которые содержат файловые ресурсы Azure, используемые в качестве облачных конечных точек в службе синхронизации файлов Azure. Это приведет к прекращению синхронизации или даже к непредвиденной потере данных, если некоторые файлы недавно стали многоуровневыми.
- Учетные записи хранения ADLS Gen2 (учетные записи с включенным иерархическим пространством имен) в настоящее время не поддерживаются.
- Невозможно выполнить отработку отказа для учетной записи хранения, которая содержит блочные BLOB-объекты уровня "Премиум". Учетные записи хранения, которые поддерживают блочные BLOB-объекты уровня "Премиум", сейчас не поддерживают географическую избыточность.
- Учетная запись хранения, содержащая любые [контейнеры с включенной политикой неизменяемости WORM,](../blobs/storage-blob-immutable-storage.md) не может быть сбой. Разблокированная/заблокированная политика удержания или законная удерживание на основе времени предотвращает сбой в целях поддержания соответствия требованиям.
- После завершения сбоя следующие функции могут прекратить работу, если изначально [включено: подписки на события,](../blobs/storage-blob-event-overview.md) [изменение](../blobs/storage-blob-change-feed.md) [ленты, политики жизненного цикла](../blobs/storage-lifecycle-management-concepts.md)и [журналирование аналитики хранения данных.](storage-analytics-logging.md)

## <a name="copying-data-as-an-alternative-to-failover"></a>Копирование данных вместо отработки отказа

Если для вашей учетной записи хранения настроен режим RA-GRS, у вас есть доступ на чтение к данным в дополнительной конечной точке. В случае сбоя в основном регионе вы можете не применять отработку отказа, а просто скопировать данные из учетной записи хранения в дополнительном регионе в другую учетную запись в регионе, не испытывающем проблем, с помощью [AzCopy](storage-use-azcopy.md), [Azure PowerShell](storage-powershell-guide-full.md) или [библиотеки перемещения данных Azure](https://azure.microsoft.com/blog/introducing-azure-storage-data-movement-library-preview-2/). После этого направьте приложения в новую учетную запись хранения для всех операций чтения и записи.

> [!CAUTION]
> Сбой учетной записи не должен использоваться в рамках стратегии миграции данных.


## <a name="microsoft-managed-failover"></a>Отработка отказа под управлением корпорации Майкрософт

В экстренных ситуациях, когда значительная авария приводит к неработоспособности целого региона, корпорация Майкрософт может инициировать отработку отказа между регионами. В этом случае вам не нужно предпринимать какие-либо действия. До завершения отработки отказа под управлением корпорации Майкрософт вы не получите доступ на запись к учетной записи хранения. Приложения смогут считывать данные из дополнительного региона, если для учетной записи хранения настроен режим RA-GRS. 

## <a name="see-also"></a>См. также

- [Initiate a storage account failover (preview)](storage-initiate-account-failover.md) (Запуск отработки отказа учетной записи (предварительная версия))
- [Разработка высокодоступных приложений с использованием RA-GRS](storage-designing-ha-apps-with-ragrs.md)
- [Учебник: Создайте высокодоступное приложение с помощью хранилища Blob](../blobs/storage-create-geo-redundant-storage.md) 
