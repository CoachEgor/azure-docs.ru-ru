---
title: Нанастройка, оптимизация и устранение неполадок AzCopy с помощью azure Storage Документы Майкрософт
description: Настроить, оптимизировать и устранить неполадки AzCopy.
author: normesta
ms.service: storage
ms.topic: conceptual
ms.date: 04/10/2020
ms.author: normesta
ms.subservice: common
ms.reviewer: dineshm
ms.openlocfilehash: 87a335f44a31436de735395adbee9035493cbbd2
ms.sourcegitcommit: 8dc84e8b04390f39a3c11e9b0eaf3264861fcafc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2020
ms.locfileid: "81263426"
---
# <a name="configure-optimize-and-troubleshoot-azcopy"></a>Configure, optimize, and troubleshoot AzCopy (Настройка, оптимизация и устранение неполадок с AzCopy)

AzCopy — это утилита командной строки, которую можно использовать для копирования капли или файлов в учетную запись или из учетной записи хранения. Эта статья помогает вам выполнять задачи расширенной конфигурации и помогает выснять проблемы, которые могут возникнуть при использовании AzCopy.

> [!NOTE]
> Если вы ищете контент, который поможет вам начать работу с AzCopy, см.
> - [Get started with AzCopy](storage-use-azcopy-v10.md) (Начало работы с AzCopy)
> - [Transfer data with AzCopy and blob storage](storage-use-azcopy-blobs.md) (Передача данных с помощью AzCopy и хранилища BLOB-объектов)
> - [Transfer data with AzCopy and file storage](storage-use-azcopy-files.md) (Передача данных с помощью AzCopy и хранилища файлов)
> - [Передача данных с помощью AzCopy и контейнеров Amazon S3](storage-use-azcopy-s3.md)

## <a name="configure-proxy-settings"></a>Настройка параметров прокси

Чтобы настроить настройки прокси для AzCopy, установите переменную среды. `https_proxy` Если вы работаете на AzCopy в Windows, AzCopy автоматически обнаруживает настройки прокси, поэтому вам не придется использовать эту настройку в Windows. Если вы решите использовать эту настройку в Windows, это переопределяет автоматическое обнаружение.

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | В командной строке используйте `set https_proxy=<proxy IP>:<proxy port>`.<br> В PowerShell используйте `$env:https_proxy="<proxy IP>:<proxy port>"`.|
| **Linux** | `export https_proxy=<proxy IP>:<proxy port>` |
| **MacOS** | `export https_proxy=<proxy IP>:<proxy port>` |

В настоящее время AzCopy не поддерживает прокси-данные, требующие аутентификации с помощью NTLM или Kerberos.

## <a name="optimize-performance"></a>Оптимизация производительности

Можно сравнивать производительность, а затем использовать команды и переменные среды, чтобы найти оптимальный компромисс между производительностью и потреблением ресурсов.

Этот раздел поможет вам выполнить следующие задачи оптимизации:

> [!div class="checklist"]
> * Запуск тестовых тестов
> * Оптимизация пропускной способности
> * Оптимизация использования памяти 
> * Оптимизация синхронизации файлов

### <a name="run-benchmark-tests"></a>Запуск тестовых тестов

Можно запустить тест на тестовую производительность на определенных контейнерах blob для просмотра общей статистики производительности и узких мест производительности. 

Используйте следующую команду для выполнения тестового теста на производительность.

|    |     |
|--------|-----------|
| **Синтаксис** | `azcopy bench 'https://<storage-account-name>.blob.core.windows.net/<container-name>'` |
| **Пример** | `azcopy bench 'https://mystorageaccount.blob.core.windows.net/mycontainer/myBlobDirectory?sv=2018-03-28&ss=bjqt&srs=sco&sp=rjklhjup&se=2019-05-10T04:37:48Z&st=2019-05-09T20:37:48Z&spr=https&sig=%2FSOVEFfsKDqRry4bk3qz1vAQFwY5DDzp2%2B%2F3Eykf%2FJLs%3D'` |

> [!TIP]
> Этот пример привязав аргументы пути к отдельным кавычкам (''). Используйте одиночные кавычки во всех командных оболочках, за исключением оболочки командования Windows (cmd.exe). Если вы используете оболочку командования Windows (cmd.exe), приложить аргументы пути с двойными кавычками ("") вместо отдельных котировок (').

Эта команда выполняет тест производительности, загружая тестовые данные в указанный пункт назначения. Тестовые данные генерируются в памяти, загружаются в пункт назначения, а затем удаляются из пункта назначения после завершения теста. Вы можете указать, сколько файлов для генерации и какого размера вы хотели бы, чтобы они были с помощью дополнительных параметров команды.

Для подробных справочных документов, см [azcopy скамейке](storage-ref-azcopy-bench.md).

Чтобы просмотреть подробное руководство `azcopy bench -h` справки для этой команды, введите, а затем нажмите клавишу ENTER.

### <a name="optimize-throughput"></a>Оптимизация пропускной способности

Флаг в `cap-mbps` командах можно использовать для размещения потолка на скорости пропускной скорости данных. Например, следующая команда возобновляет работу и `10` крышки пропускной всей для мегабит (МБ) в секунду. 

```azcopy
azcopy jobs resume <job-id> --cap-mbps 10
```

Пропускная часть может уменьшаться при передаче небольших файлов. Можно увеличить пропускную схему, `AZCOPY_CONCURRENCY_VALUE` установив переменную среды. Эта переменная определяет количество одновременных запросов, которые могут возникать.  

Если ваш компьютер имеет менее 5 процессоров, то значение `32`этой переменной устанавливается. В противном случае значение по умолчанию равно 16, умноженное на количество процессоров. Максимальное значение этой переменной по умолчанию, `3000`но вы можете вручную установить это значение выше или ниже. 

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_CONCURRENCY_VALUE=<value>` |
| **Linux** | `export AZCOPY_CONCURRENCY_VALUE=<value>` |
| **MacOS** | `export AZCOPY_CONCURRENCY_VALUE=<value>` |

Используйте `azcopy env` для проверки текущего значения этой переменной. Если значение пусто, то вы можете прочитать, какое значение используется, глядя в начале любого файла журнала AzCopy. Выбранное значение, и причина, по которой он был выбран, сообщается там.

Прежде чем установить эту переменную, мы рекомендуем вам запустить тест. В процессе тестирования эталона будет представлена рекомендуемая параллельная стоимость. Кроме того, если условия сети и полезные нагрузки `AUTO` различаются, установите эту переменную на слово, а не на определенное число. Это приведет к тому, что AzCopy всегда будет запускать тот же процесс автоматической настройки, который он использует в тестовых тестах.

### <a name="optimize-memory-use"></a>Оптимизация использования памяти

Установите `AZCOPY_BUFFER_GB` переменную среды, чтобы указать максимальное количество памяти системы, которое вы хотите использовать При загрузке и загрузке файлов.
Выразите это значение в гигабайтах (GB).

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_BUFFER_GB=<value>` |
| **Linux** | `export AZCOPY_BUFFER_GB=<value>` |
| **MacOS** | `export AZCOPY_BUFFER_GB=<value>` |

### <a name="optimize-file-synchronization"></a>Оптимизация синхронизации файлов

Команда [синхронизации](storage-ref-azcopy-sync.md) идентифицирует все файлы в пункте назначения, а затем сравнивает имена файлов и последние измененные метки времени перед началом операции синхронизации. Если у вас есть большое количество файлов, то вы можете улучшить производительность, устраняя эту переднюю обработку. 

Для этого используйте команду [копии азкопии](storage-ref-azcopy-copy.md) вместо этого и установите `--overwrite` флаг. `ifSourceNewer` AzCopy будет сравнивать файлы, как они копируются без выполнения каких-либо авансовых сканирований и сравнений. Это обеспечивает преимущество производительности в тех случаях, когда существует большое количество файлов для сравнения.

Команда [копии азкопии](storage-ref-azcopy-copy.md) не удаляет файлы из пункта назначения, поэтому, если вы хотите удалить файлы в пункте `--delete-destination` назначения, когда они `true` `prompt`больше не существуют в источнике, используйте команду [синхронизации azcopy](storage-ref-azcopy-sync.md) с флагом, установленным на значение или . 

## <a name="troubleshoot-issues"></a>Устранение неполадок

AzCopy создает файлы журналов и планирования для каждого задания. Вы можете использовать журналы для исследования и устранения возможных проблем. 

В журналах будет содержаться`UPLOADFAILED`состояние `COPYFAILED`сбоя (, и `DOWNLOADFAILED`), полный путь, и причина сбоя.

По умолчанию файлы журнала и `%USERPROFILE%\.azcopy` плана находятся `$HOME$\.azcopy` в каталоге Windows или каталоге на Mac и Linux, но вы можете изменить это местоположение, если хотите.

Соответствующая ошибка не обязательно является первой ошибкой, которая появляется в файле. Для ошибок, таких как сетевые ошибки, тайм-ауты и ошибки Server Busy, AzCopy будет повторно выполнять попытки до 20 раз, и обычно процесс повтора случается успешным.  Первая ошибка, которую вы видите, может быть чем-то безвредным, что было успешно повторено.  Таким образом, вместо того, чтобы смотреть на первую `UPLOADFAILED`ошибку в файле, искать ошибки, которые находятся рядом, `COPYFAILED`или `DOWNLOADFAILED`. 

> [!IMPORTANT]
> При отправке запроса в службу поддержки Майкрософт (или устранении проблемы с участием какой-либо третьей стороны) поделитесь отредактированной версией команды, которая требуется выполнить. Это гарантирует, что SAS не случайно поделилась с кем-либо. Вы можете найти исправленную версию в начале файла журнала.

### <a name="review-the-logs-for-errors"></a>Проверка журналов на наличие ошибок

Следующая команда получит все `UPLOADFAILED` ошибки `04dc9ca9-158f-7945-5933-564021086c79` со статусом из журнала:

**Окна (PowerShell)**

```
Select-String UPLOADFAILED .\04dc9ca9-158f-7945-5933-564021086c79.log
```

**Linux**

```
grep UPLOADFAILED .\04dc9ca9-158f-7945-5933-564021086c79.log
```

### <a name="view-and-resume-jobs"></a>Просмотр и возобновление задания

В рамках каждой операции передачи будет создано задание AzCopy. Используйте следующую команду для просмотра истории заданий:

```
azcopy jobs list
```

Чтобы просмотреть статистику задания, используйте следующую команду:

```
azcopy jobs show <job-id>
```

Чтобы отфильтровать операции передачи по состоянию, используйте следующую команду:

```
azcopy jobs show <job-id> --with-status=Failed
```

Используйте следующую команду для возобновления неудачного/отмененного задания. Эта команда использует свой идентификатор вместе с токеном SAS, поскольку он не является постоянным по соображениям безопасности:

```
azcopy jobs resume <job-id> --source-sas="<sas-token>"
azcopy jobs resume <job-id> --destination-sas="<sas-token>"
```

> [!TIP]
> Приложить аргументы пути, такие как токен SAS с одними цитатами (''). Используйте одиночные кавычки во всех командных оболочках, за исключением оболочки командования Windows (cmd.exe). Если вы используете оболочку командования Windows (cmd.exe), приложить аргументы пути с двойными кавычками ("") вместо отдельных котировок (').

При возобновлении работы AzCopy просматривает файл плана работы. Файл плана перечисляет все файлы, которые были идентифицированы для обработки при первом создании задания. При возобновлении работы AzCopy попытается передать все файлы, перечисленные в файле плана, которые еще не были переданы.

## <a name="change-the-location-of-the-plan-and-log-files"></a>Изменение местоположения файлов плана и журналов

По умолчанию файлы плана и `%USERPROFILE%\.azcopy` журнала находятся в `$HOME$\.azcopy` каталоге Windows или в каталоге mac и Linux. Вы можете изменить это местоположение.

### <a name="change-the-location-of-plan-files"></a>Изменение местоположения файлов плана

Используйте любую из этих команд.

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_JOB_PLAN_LOCATION=<value>` |
| **Linux** | `export AZCOPY_JOB_PLAN_LOCATION=<value>` |
| **MacOS** | `export AZCOPY_JOB_PLAN_LOCATION=<value>` |

Используйте `azcopy env` для проверки текущего значения этой переменной. Если значение пусто, файлы плана записываются в место по умолчанию.

### <a name="change-the-location-of-log-files"></a>Изменение местоположения файлов журналов

Используйте любую из этих команд.

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_LOG_LOCATION=<value>` |
| **Linux** | `export AZCOPY_LOG_LOCATION=<value>` |
| **MacOS** | `export AZCOPY_LOG_LOCATION=<value>` |

Используйте `azcopy env` для проверки текущего значения этой переменной. Если значение пусто, журналы записываются в место по умолчанию.

## <a name="change-the-default-log-level"></a>Изменение уровня ведения журнала по умолчанию

По умолчанию уровень журнала `INFO`AzCopy установлен на . Если вы хотите уменьшить многословность журнала, чтобы сэкономить пространство диска, перезапишите эту настройку, используя опцию. ``--log-level`` 

Доступные уровни `NONE` `DEBUG`журнала: , `PANIC`, `FATAL` `INFO` `WARNING`, `ERROR`, и .

## <a name="remove-plan-and-log-files"></a>Удалить файлы плана и журнала

Если вы хотите удалить все файлы плана и журнала из `azcopy jobs clean` локальной машины, чтобы сэкономить пространство диска, используйте команду.

Чтобы удалить файлы плана и журнал, `azcopy jobs rm <job-id>`связанные только с одним заданием, используйте. Замените `<job-id>` заполнителя в этом примере идентификатором задания.


