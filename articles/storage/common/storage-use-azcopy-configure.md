---
title: Настройка, оптимизация и устранение неполадок AzCopy в службе хранилища Azure | Документация Майкрософт
description: Настройка, оптимизация и устранение неполадок AzCopy.
author: normesta
ms.service: storage
ms.topic: conceptual
ms.date: 01/28/2020
ms.author: normesta
ms.subservice: common
ms.reviewer: dineshm
ms.openlocfilehash: 00ce40e24a01b765419186a609ecf19ce53c772b
ms.sourcegitcommit: 67e9f4cc16f2cc6d8de99239b56cb87f3e9bff41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2020
ms.locfileid: "76905263"
---
# <a name="configure-optimize-and-troubleshoot-azcopy"></a>Настройка, оптимизация и устранение неполадок AzCopy

AzCopy — это служебная программа командной строки, которую можно использовать для копирования больших двоичных объектов или файлов в учетную запись хранения или из нее. Эта статья поможет вам выполнить дополнительные задачи по настройке и устранить неполадки, которые могут возникнуть при использовании AzCopy.

> [!NOTE]
> Если вы ищете содержимое, которое поможет приступить к работе с AzCopy, ознакомьтесь со следующими статьями:
> - [Get started with AzCopy](storage-use-azcopy-v10.md) (Начало работы с AzCopy)
> - [Transfer data with AzCopy and blob storage](storage-use-azcopy-blobs.md) (Передача данных с помощью AzCopy и хранилища BLOB-объектов)
> - [Transfer data with AzCopy and file storage](storage-use-azcopy-files.md) (Передача данных с помощью AzCopy и хранилища файлов)
> - [Передача данных с помощью AzCopy и контейнеров Amazon S3](storage-use-azcopy-s3.md)

## <a name="configure-proxy-settings"></a>Настройка параметров прокси

Чтобы настроить параметры прокси-сервера для AzCopy, задайте переменную среды `https_proxy`. При запуске AzCopy в Windows AzCopy автоматически определяет параметры прокси-сервера, поэтому вам не нужно использовать этот параметр в Windows. Если вы решили использовать этот параметр в Windows, это приведет к переопределению автоматического обнаружения.

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | В командной строке используйте `set https_proxy=<proxy IP>:<proxy port>`.<br> В PowerShell используйте `$env:https_proxy="<proxy IP>:<proxy port>"`.|
| **Linux** | `export https_proxy=<proxy IP>:<proxy port>` |
| **MacOS** | `export https_proxy=<proxy IP>:<proxy port>` |

В настоящее время AzCopy не поддерживает прокси-серверы, для которых требуется проверка подлинности с помощью NTLM или Kerberos.

## <a name="optimize-performance"></a>Оптимизация производительности

Вы можете протестировать производительность, а затем использовать команды и переменные среды для поиска оптимального компромисса между производительностью и потреблением ресурсов.

Этот раздел поможет вам выполнить следующие задачи оптимизации:

> [!div class="checklist"]
> * Запуск тестов производительности
> * Оптимизация пропускной способности
> * Оптимизация использования памяти 
> * Оптимизация синхронизации файлов

### <a name="run-benchmark-tests"></a>Запуск тестов производительности

Вы можете запустить тест производительности для конкретных контейнеров больших двоичных объектов, чтобы просмотреть общую статистику производительности и узкие места в производительности идентификации. 

> [!NOTE]
> В текущем выпуске эта функция доступна только для контейнеров хранилища BLOB-объектов.

Используйте следующую команду, чтобы запустить тест производительности.

|    |     |
|--------|-----------|
| **Синтаксис** | `azcopy bench 'https://<storage-account-name>.blob.core.windows.net/<container-name>'` |
| **Пример** | `azcopy bench 'https://mystorageaccount.blob.core.windows.net/mycontainer/myBlobDirectory?sv=2018-03-28&ss=bjqt&srs=sco&sp=rjklhjup&se=2019-05-10T04:37:48Z&st=2019-05-09T20:37:48Z&spr=https&sig=%2FSOVEFfsKDqRry4bk3qz1vAQFwY5DDzp2%2B%2F3Eykf%2FJLs%3D'` |

> [!TIP]
> В этом примере аргументы пути заключаются в одинарные кавычки (' '). Используйте одинарные кавычки во всех командных оболочках, кроме командной оболочки Windows (cmd. exe). Если вы используете командную оболочку Windows (cmd. exe), заключите аргументы пути в двойные кавычки ("") вместо одинарных кавычек ("").

Эта команда запускает нагрузочный тест производительности, загружая проверочные данные в указанное место назначения. Тестовые данные создаются в памяти, передаются в место назначения, а затем удаляются из места назначения после завершения теста. Можно указать количество создаваемых файлов и размер, который нужно создать, с помощью необязательных параметров команды.

Подробную справочную документацию см. в разделе [azcopy Bench](storage-ref-azcopy-bench.md).

Чтобы просмотреть подробные справочные сведения для этой команды, введите `azcopy bench -h` и нажмите клавишу ВВОД.

### <a name="optimize-throughput"></a>Оптимизация пропускной способности

Вы можете использовать флаг `cap-mbps` в командах, чтобы поместить потолк на скорость передачи данных. Например, следующая команда возобновляет задание и пропускную способность CAPS для `10` мегабит (МБ) в секунду. 

```azcopy
azcopy jobs resume <job-id> --cap-mbps 10
```

Пропускная способность может уменьшиться при передаче небольших файлов. Можно увеличить пропускную способность, задав переменную среды `AZCOPY_CONCURRENCY_VALUE`. Эта переменная указывает количество одновременных запросов, которые могут быть выполнены.  

Если на компьютере установлено менее 5 ЦП, значение этой переменной задается равным `32`. В противном случае значение по умолчанию равно 16, умноженному на число ЦП. Максимальное значение по умолчанию для этой переменной — `3000`, но можно вручную задать это значение выше или ниже. 

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_CONCURRENCY_VALUE=<value>` |
| **Linux** | `export AZCOPY_CONCURRENCY_VALUE=<value>` |
| **MacOS** | `export AZCOPY_CONCURRENCY_VALUE=<value>` |

Используйте `azcopy env`, чтобы проверить текущее значение этой переменной. Если значение пустое, то можно считать, какое значение используется, просмотрев начало любого файла журнала AzCopy. Выбранное значение и причина, по которой он был выбран, включаются в отчет.

Перед установкой этой переменной рекомендуется запустить тест производительности. Процесс тестирования производительности будет сообщать о рекомендуемом значении параллелизма. Кроме того, если условия сети и полезные данные различаются, присвойте этой переменной слово `AUTO` вместо определенного числа. Это приведет к тому, что AzCopy всегда будет выполнять тот же процесс автоматической настройки, который используется в тестах производительности.

### <a name="optimize-memory-use"></a>Оптимизация использования памяти

Задайте переменную среды `AZCOPY_BUFFER_GB`, чтобы указать максимальный объем системной памяти, который будет использоваться AzCopy при скачивании и отправке файлов.
Выразить это значение в гигабайтах (ГБ).

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_BUFFER_GB=<value>` |
| **Linux** | `export AZCOPY_BUFFER_GB=<value>` |
| **MacOS** | `export AZCOPY_BUFFER_GB=<value>` |

### <a name="optimize-file-synchronization"></a>Оптимизация синхронизации файлов

Команда [Sync](storage-ref-azcopy-sync.md) определяет все файлы в месте назначения, а затем сравнивает имена файлов и метки времени последнего изменения перед началом операции синхронизации. Если у вас много файлов, можно повысить производительность, изменив эту обработку. 

Для этого используйте команду [azcopy Copy](storage-ref-azcopy-copy.md) , а для флага `--overwrite` значение `ifSourceNewer`. AzCopy будет сравнивать файлы при копировании без выполнения сквозной проверки и сравнения. Это обеспечивает производительность в тех случаях, когда требуется сравнить большое количество файлов.

Команда [azcopy Copy](storage-ref-azcopy-copy.md) не удаляет файлы из места назначения, поэтому если вы хотите удалить файлы в месте назначения, когда они больше не существуют в источнике, используйте команду [azcopy Sync](storage-ref-azcopy-sync.md) с флагом `--delete-destination`, установленным в значение `true` или `prompt`. 

## <a name="troubleshoot-issues"></a>Устранение неполадок

AzCopy создает файлы журналов и планов для каждого задания. Вы можете использовать журналы для исследования и устранения возможных проблем. 

Журналы будут содержать состояние сбоя (`UPLOADFAILED`, `COPYFAILED`и `DOWNLOADFAILED`), полный путь и причину сбоя.

По умолчанию файлы журнала и плана находятся в каталоге `%USERPROFILE%\.azcopy` в Windows или `$HOME$\.azcopy` Directory в Mac и Linux, но при необходимости вы можете изменить это расположение.

> [!IMPORTANT]
> При отправке запроса на служба поддержки Майкрософт (или при устранении неполадки, связанной с третьей стороной), предоставьте общий доступ к показана исправленная версия версии команды, которую нужно выполнить. Это гарантирует, что SAS не будет случайно предоставлен всем. Вы можете найти исправленную версию в начале файла журнала.

### <a name="review-the-logs-for-errors"></a>Проверка журналов на наличие ошибок

Следующая команда получит все ошибки с состоянием `UPLOADFAILED` из журнала `04dc9ca9-158f-7945-5933-564021086c79`:

**Windows (PowerShell)**

```
Select-String UPLOADFAILED .\04dc9ca9-158f-7945-5933-564021086c79.log
```

**Linux**

```
grep UPLOADFAILED .\04dc9ca9-158f-7945-5933-564021086c79.log
```

### <a name="view-and-resume-jobs"></a>Просмотр и возобновление задания

В рамках каждой операции передачи будет создано задание AzCopy. Чтобы просмотреть журнал заданий, используйте следующую команду:

```
azcopy jobs list
```

Чтобы просмотреть статистику задания, используйте следующую команду:

```
azcopy jobs show <job-id>
```

Чтобы отфильтровать операции передачи по состоянию, используйте следующую команду:

```
azcopy jobs show <job-id> --with-status=Failed
```

Используйте следующую команду, чтобы возобновить задание, завершившееся сбоем или отмененным. Эта команда использует свой идентификатор вместе с маркером SAS, так как он не является постоянным в целях безопасности:

```
azcopy jobs resume <job-id> --source-sas="<sas-token>"
azcopy jobs resume <job-id> --destination-sas="<sas-token>"
```

> [!TIP]
> Заключите аргументы пути, такие как маркер SAS, с одинарными кавычками (' '). Используйте одинарные кавычки во всех командных оболочках, кроме командной оболочки Windows (cmd. exe). Если вы используете командную оболочку Windows (cmd. exe), заключите аргументы пути в двойные кавычки ("") вместо одинарных кавычек ("").

При возобновлении задания AzCopy просматривает файл плана задания. В файле плана перечислены все файлы, обнаруженные для обработки при первом создании задания. При возобновлении задания AzCopy попытается перенести все файлы, перечисленные в файле плана, который еще не был передан.

## <a name="change-the-location-of-the-plan-and-log-files"></a>Изменение расположения файлов плана и журнала

По умолчанию файлы плана и журнала находятся в каталоге `%USERPROFILE%\.azcopy` в Windows или в каталоге `$HOME$\.azcopy` в Mac и Linux. Это расположение можно изменить.

### <a name="change-the-location-of-plan-files"></a>Изменение расположения файлов планов

Используйте любую из этих команд.

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_JOB_PLAN_LOCATION=<value>` |
| **Linux** | `export AZCOPY_JOB_PLAN_LOCATION=<value>` |
| **MacOS** | `export AZCOPY_JOB_PLAN_LOCATION=<value>` |

Используйте `azcopy env`, чтобы проверить текущее значение этой переменной. Если значение пустое, файлы планов записываются в расположение по умолчанию.

### <a name="change-the-location-of-log-files"></a>Изменение расположения файлов журнала

Используйте любую из этих команд.

| Операционная система | Get-Help  |
|--------|-----------|
| **Windows** | `set AZCOPY_LOG_LOCATION=<value>` |
| **Linux** | `export AZCOPY_LOG_LOCATION=<value>` |
| **MacOS** | `export AZCOPY_LOG_LOCATION=<value>` |

Используйте `azcopy env`, чтобы проверить текущее значение этой переменной. Если значение пустое, журналы записываются в расположение по умолчанию.

## <a name="change-the-default-log-level"></a>Изменение уровня ведения журнала по умолчанию

По умолчанию для AzCopy уровня ведения журнала задано значение `INFO`. Если вы хотите уменьшить уровень детализации журнала, чтобы сэкономить место на диске, перепишите этот параметр с помощью параметра ``--log-level``. 

Доступны следующие уровни журнала: `NONE`, `DEBUG`, `INFO`, `WARNING`, `ERROR`, `PANIC`и `FATAL`.

## <a name="remove-plan-and-log-files"></a>Удаление файлов плана и журнала

Если вы хотите удалить все файлы планов и журналов с локального компьютера, чтобы сэкономить место на диске, используйте команду `azcopy jobs clean`.

Чтобы удалить файлы плана и журнала, связанные только с одним заданием, используйте `azcopy jobs rm <job-id>`. Замените заполнитель `<job-id>` в этом примере идентификатором задания.


