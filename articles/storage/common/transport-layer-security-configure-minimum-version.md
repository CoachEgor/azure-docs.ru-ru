---
title: Настройка минимальной требуемой версии протокола TLS для учетной записи хранения
titleSuffix: Azure Storage
description: Настройте учетную запись хранения, чтобы требовать минимальную версию протокола TLS для клиентов, выполняющих запросы к службе хранилища Azure.
services: storage
author: tamram
ms.service: storage
ms.topic: how-to
ms.date: 07/08/2020
ms.author: tamram
ms.reviewer: fryu
ms.subservice: common
ms.openlocfilehash: ab83f0ee656dfc717284c1e26d10dcb814fe1c9e
ms.sourcegitcommit: 3541c9cae8a12bdf457f1383e3557eb85a9b3187
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86209863"
---
# <a name="configure-minimum-required-version-of-transport-layer-security-tls-for-a-storage-account"></a>Настройка минимальной требуемой версии протокола TLS для учетной записи хранения

Связь между клиентским приложением и учетной записью хранения Azure шифруется с помощью протокола TLS. TLS — это стандартный протокол шифрования, обеспечивающий конфиденциальность и целостность данных между клиентами и службами через Интернет. Дополнительные сведения о протоколе TLS см. в статье [безопасность транспортного уровня](https://en.wikipedia.org/wiki/Transport_Layer_Security).

Сейчас служба хранилища Azure поддерживает три версии протокола TLS: 1,0, 1,1 и 1,2. TLS 1,2 — это наиболее безопасная версия TLS. Служба хранилища Azure использует TLS 1,2 на общедоступных конечных точках HTTPs, но TLS 1,0 и TLS 1,1 по-прежнему поддерживаются для обеспечения обратной совместимости.

По умолчанию учетные записи хранения Azure позволяют клиентам отправлять и получать данные с использованием самой старой версии TLS, TLS 1,0 и более поздних версий. Чтобы обеспечить более строгие меры безопасности, можно настроить учетную запись хранения так, чтобы клиенты отправляли и получали данные с помощью более новой версии TLS. Если для учетной записи хранения требуется минимальная версия TLS, все запросы, выполненные с использованием более ранней версии, завершатся ошибкой.

В этой статье описывается, как настроить учетную запись хранения, чтобы требовать, чтобы клиенты отправляли запросы с минимальной версией TLS. Сведения о том, как указать определенную версию TLS при отправке запроса из клиентского приложения, см. [в разделе Настройка безопасности транспортного уровня (TLS) для клиентского приложения](transport-layer-security-configure-client-version.md).

## <a name="detect-the-tls-version-used-by-client-applications"></a>Определение версии TLS, используемой клиентскими приложениями

При применении минимальной версии TLS для учетной записи хранения вы рискуете отклонять запросы от клиентов, отправляющих данные с помощью более ранней версии TLS. Чтобы понять, как Настройка минимальной версии TLS может повлиять на клиентские приложения, корпорация Майкрософт рекомендует включить ведение журнала для учетной записи хранения Azure и проанализировать журналы через интервал времени, чтобы определить, какие версии клиентских приложений TLS используются.

Чтобы зарегистрировать запросы к учетной записи хранения Azure и определить версию TLS, используемую клиентом, можно использовать ведение журнала службы хранилища Azure в Azure Monitor (Предварительная версия). Дополнительные сведения см. в статье [мониторинг службы хранилища Azure](monitor-storage.md).

Ведение журнала службы хранилища Azure в Azure Monitor поддерживает использование запросов журналов для анализа данных журнала. Для запроса журналов можно использовать рабочую область Azure Log Analytics. Дополнительные сведения о запросах журналов см. в разделе [учебник. Начало работы с log Analytics запросами](../../azure-monitor/log-query/get-started-portal.md).

Чтобы записывать данные службы хранилища Azure с Azure Monitor и анализировать их с помощью Log Analytics Azure, необходимо сначала создать параметр диагностики, который указывает, какие типы запросов и какие услуги хранилища будут записывать данные. Чтобы создать параметр диагностики в портал Azure, выполните следующие действия.

1. Зарегистрируйтесь в [журнале службы хранилища Azure в Azure Monitor предварительной версии](https://forms.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRxW65f1VQyNCuBHMIMBV8qlUM0E0MFdPRFpOVTRYVklDSE1WUTcyTVAwOC4u).
1. Создайте новую рабочую область Log Analytics в подписке, которая содержит вашу учетную запись хранения Azure. После настройки ведения журнала для учетной записи хранения журналы будут доступны в рабочей области Log Analytics. Дополнительные сведения см. в статье [Create a Log Analytics workspace in the Azure portal](../../azure-monitor/learn/quick-create-workspace.md) (Создание рабочей области Log Analytics на портале Azure).
1. Войдите в свою учетную запись хранения на портале Azure.
1. В разделе Мониторинг выберите **параметры диагностики (Предварительная версия)**.
1. Выберите службу хранилища Azure, для которой требуется регистрировать запросы. Например, выберите **BLOB-объект** для записи запросов в хранилище BLOB-объектов.
1. Выберите **Добавить параметр диагностики**.
1. Укажите имя для параметра диагностики.
1. В разделе **сведения о категории**раздела **Журнал** выберите типы запросов для записи. Запросы на чтение, запись и удаление можно записывать в журнал. Например, при выборе **сторажереад** и **сторажеврите** будут регистрироваться запросы на чтение и запись к выбранной службе.
1. В разделе **сведения о назначении**выберите **Отправить log Analytics**. Выберите подписку и созданную ранее рабочую область Log Analytics, как показано на следующем рисунке.

    :::image type="content" source="media/transport-layer-security-configure-minimum-version/create-diagnostic-setting-logs.png" alt-text="Снимок экрана, показывающий, как создать параметр диагностики для запросов ведения журнала":::

После создания параметра диагностики запросы к учетной записи хранения затем регистрируются в соответствии с этим параметром. Дополнительные сведения см. в статье [Создание параметров диагностики для сбора журналов ресурсов и метрик в Azure](../../azure-monitor/platform/diagnostic-settings.md).

Ссылки на поля, доступные в журналах службы хранилища Azure в Azure Monitor, см. в разделе [журналы ресурсов (Предварительная версия)](monitor-storage-reference.md#resource-logs-preview).

### <a name="query-logged-requests-by-tls-version"></a>Запросы, регистрируемые в журнале по версии TLS

Журналы службы хранилища Azure в Azure Monitor включают версию TLS, используемую для отправки запроса в учетную запись хранения. Используйте свойство **тлсверсион** , чтобы проверить версию TLS зарегистрированного запроса.

Чтобы получить журналы за последние семь дней и определить, сколько запросов было выполнено в хранилище BLOB-объектов с каждой версией TLS, откройте рабочую область Log Analytics. Затем вставьте следующий запрос в новый запрос к журналу и запустите его. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```kusto
StorageBlobLogs
| where TimeGenerated > ago(7d) and AccountName == "<account-name>"
| summarize count() by TlsVersion
```

В результатах отображается количество запросов, выполненных с каждой версией TLS:

:::image type="content" source="media/transport-layer-security-configure-minimum-version/log-analytics-query-version.png" alt-text="Снимок экрана, показывающий результаты запроса log Analytics для возврата версии TLS":::

### <a name="query-logged-requests-by-caller-ip-address-and-user-agent-header"></a>Запрос зарегистрированных запросов по IP-адресу звонящего и заголовку агента пользователя

Журналы службы хранилища Azure в Azure Monitor также включают IP-адрес вызывающей стороны и заголовок агента пользователя, которые помогут оценить, какие клиентские приложения обращаются к учетной записи хранения. Вы можете проанализировать эти значения, чтобы решить, следует ли обновить клиентские приложения для использования более новой версии протокола TLS или можно ли не выполнять запрос клиента, если он не отправляется с минимальной версией TLS.

Чтобы получить журналы за последние семь дней и определить, какие клиенты предоставили запросы с версией TLS до TLS 1,2, вставьте следующий запрос в новый запрос к журналу и запустите его. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```kusto
StorageBlobLogs
| where TimeGenerated > ago(7d) and AccountName == "<account-name>" and TlsVersion != "TLS 1.2"
| project TlsVersion, CallerIpAddress, UserAgentHeader
```

## <a name="configure-the-minimum-tls-version-for-an-account"></a>Настройка минимальной версии TLS для учетной записи

Чтобы настроить минимальную версию TLS для учетной записи хранения, используйте портал Azure или Azure CLI, чтобы задать версию **минимумтлсверсион** для учетной записи. Это свойство доступно для всех учетных записей хранения, созданных с помощью модели развертывания Azure Resource Manager. Дополнительные сведения см. в разделе [Общие сведения об учетной записи хранения](storage-account-overview.md).

# <a name="portal"></a>[Портал](#tab/portal)

Чтобы настроить минимальную версию TLS для учетной записи хранения с портал Azure, выполните следующие действия.

1. Войдите в свою учетную запись хранения на портале Azure.
1. Выберите параметр **конфигурации** .
1. В разделе **Минимальная версия TLS**используйте раскрывающийся список, чтобы выбрать минимальную версию TLS, необходимую для доступа к данным в этой учетной записи хранения, как показано на следующем рисунке.

    :::image type="content" source="media/transport-layer-security-configure-minimum-version/configure-minimum-version-portal.png" alt-text="Снимок экрана, показывающий, как настроить минимальную версию TLS в портал Azure":::

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы настроить минимальную версию TLS для учетной записи хранения с Azure CLI, сначала получите идентификатор ресурса для своей учетной записи хранения, вызвав команду [AZ Resource-шоу](/cli/azure/resource#az-resource-show) . Затем вызовите команду [AZ Resource Update](/cli/azure/resource#az-resource-update) , чтобы задать свойство **минимумтлсверсион** для учетной записи хранения. Допустимые значения для **минимумтлсверсион** : `TLS1_0` , `TLS1_1` и `TLS1_2` .

В следующем примере для минимальной версии TLS устанавливается значение 1,2. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```azurecli-interactive
storage_account_id=$(az resource show \
  --name <storage-account> \
  --resource-group <resource-group> \
  --resource-type Microsoft.Storage/storageAccounts \
  --query id \
  --output tsv)

az resource update \
  --ids $storage_account_id \
  --set properties.minimumTlsVersion="TLS1_2"
```

---

> [!NOTE]
> После обновления минимальной версии TLS для учетной записи хранения может потребоваться до 30 секунд, прежде чем изменение будет полностью распространено.

## <a name="check-the-minimum-required-tls-version-for-an-account"></a>Проверка минимальной требуемой версии TLS для учетной записи

Чтобы определить минимальную требуемую версию TLS, настроенную для учетной записи хранения, проверьте свойство Azure Resource Manager **минимумтлсверсион** . Чтобы проверить это свойство для большого числа учетных записей хранения одновременно, используйте обозреватель графов ресурсов Azure.

Свойство **минимумтлсверсион** не задано по умолчанию и не возвращает значение, пока оно не будет явно задано. Учетная запись хранения по умолчанию позволяет разрешить запросы, отправленные с помощью TLS версии 1,0 или выше, если свойство имеет значение null.

### <a name="check-the-minimum-required-tls-version-for-a-single-storage-account"></a>Проверка минимальной требуемой версии TLS для одной учетной записи хранения

Чтобы проверить минимальную необходимую версию протокола TLS для одной учетной записи хранения с помощью Azure CLI, вызовите команду [AZ Resource-шоу](/cli/azure/resource#az-resource-show) и выполните запрос для свойства **минимумтлсверсион** :

```azurecli-interactive
az resource show \
    --name <storage-account> \
    --resource-group <resource-group> \
    --resource-type Microsoft.Storage/storageAccounts \
    --query properties.minimumTlsVersion \
    --output tsv
```

### <a name="check-the-minimum-required-tls-version-for-a-set-of-storage-accounts"></a>Проверка минимальной требуемой версии TLS для набора учетных записей хранения

Чтобы проверить минимальную необходимую версию протокола TLS в наборе учетных записей хранения с оптимальной производительностью, можно использовать обозреватель графа ресурсов Azure в портал Azure. Дополнительные сведения об использовании обозревателя графа ресурсов см. в статье [Краткое руководство. выполнение первого запроса Graph в Azure с помощью обозревателя Graph](/azure/governance/resource-graph/first-query-portal).

Выполнение следующего запроса в обозревателе графа ресурсов возвращает список учетных записей хранения и отображает минимальную версию TLS для каждой учетной записи:

```kusto
resources
| where type =~ 'Microsoft.Storage/storageAccounts'
| extend minimumTlsVersion = parse_json(properties).minimumTlsVersion
| project subscriptionId, resourceGroup, name, minimumTlsVersion
```

---

## <a name="test-the-minimum-tls-version-from-a-client"></a>Проверка минимальной версии TLS от клиента

Чтобы проверить, что минимальная требуемая версия TLS для учетной записи хранения запрещает вызовы, выполненные с использованием более ранней версии, можно настроить клиент на использование более ранней версии TLS. Дополнительные сведения о настройке клиента для использования определенной версии протокола TLS см. в статье [Настройка безопасности транспортного уровня (TLS) для клиентского приложения](transport-layer-security-configure-client-version.md).

Когда клиент обращается к учетной записи хранения с использованием версии TLS, которая не соответствует минимальной версии TLS, настроенной для учетной записи, служба хранилища Azure возвращает код ошибки 400 (неверный запрос) и сообщение, указывающее, что используемая версия TLS не разрешена для выполнения запросов к этой учетной записи хранения.

## <a name="next-steps"></a>Следующие шаги

- [Настройка протокола TLS для клиентского приложения](transport-layer-security-configure-client-version.md)
- [Рекомендации по обеспечению безопасности для хранилища BLOB-объектов](../blobs/security-recommendations.md)
