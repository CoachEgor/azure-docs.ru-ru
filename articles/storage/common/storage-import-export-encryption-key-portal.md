---
title: Используйте портал Azure для настройки ключей, управляемых клиентами для обслуживания импорта/экспорта
description: Узнайте, как использовать портал Azure для настройки ключей, управляемых клиентами, с помощью azure Key Vault для службы импорта/экспорта Azure. Управляемые клиентом ключи позволяют создавать, вращать, отключать и отменять элементы управления доступом.
services: storage
author: alkohli
ms.service: storage
ms.topic: how-to
ms.date: 03/12/2020
ms.author: alkohli
ms.subservice: common
ms.openlocfilehash: ca1327a547e8550e47ff37e4ba100fcbd2b7a79f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80282466"
---
# <a name="use-customer-managed-keys-in-azure-key-vault-for-importexport-service"></a>Используйте ключи, управляемые клиентами, в Сервисе Azure Key Vault для обслуживания импорта/экспорта

Azure Import/Export защищает клавиши BitLocker, используемые для блокировки дисков с помощью ключа шифрования. По умолчанию ключи BitLocker шифруются с помощью ключей, управляемых Корпорацией Майкрософт. Для дополнительного контроля над ключами шифрования вы также можете предоставить ключи, управляемые клиентом.

Ключи, управляемые клиентом, должны создаваться и храниться в Хранилище ключей Azure. Для получения дополнительной информации о [What is Azure Key Vault?](../../key-vault/key-vault-overview.md) Убежище ключей Azure см.

В этой статье показано, как использовать управляемые клиентами ключи с помощью службы импорта/экспорта на [портале Azure](https://portal.azure.com/).

## <a name="prerequisites"></a>Предварительные требования

Перед тем как начать, убедитесь в следующем:

1. Вы создали работу импорта или экспорта в рамках инструкций в:

    - [Создайте работу импорта для капли](storage-import-export-data-to-blobs.md).
    - [Создайте задания импорта для файлов.](storage-import-export-data-to-files.md)
    - [Создать экспортное задание для капли](storage-import-export-data-from-blobs.md)

2. У вас есть существующий AAzure Key Vault с ключом, который можно использовать для защиты ключа BitLocker. Чтобы узнать, как создать хранилище ключей с помощью портала Azure, [см.](../../key-vault/quick-create-portal.md)

    - **Мягкое удаление** и **не очищайте** устанавливаются на существующем Key Vault. Эти свойства не включены по умолчанию. Для обеспечения этих свойств в одной из следующих статей см. разделы под названием **"Включение в мягкое удаление** и **включение в защиту от чистки"** в одной из следующих статей:

        - [Как использовать мягкое удаление с PowerShell](../../key-vault/key-vault-soft-delete-powershell.md).
        - [Как использовать мягкое удаление с CLI](../../key-vault/key-vault-soft-delete-cli.md).
    - Существующее хранилище ключей должно иметь ключ RSA размером 2048 или более. Для получения дополнительной информации о ключах можно **ознакомиться с ключами Убежища** в [ключах, секретах и сертификатах Azure Key Vault.](../../key-vault/about-keys-secrets-and-certificates.md#key-vault-keys)
    - Хранилище ключей должно находиться в том же регионе, что и учетная запись хранилища данных.  
    - Если у вас нет существующего Убежища ключей Azure, вы также можете создать его в соответствии с описанной в следующем разделе.

## <a name="enable-keys"></a>Включить клавиши

Настройка ключа, управляемого клиентами для службы импорта/экспорта, является необязательной. По умолчанию служба импорта/экспорта использует управляемый корпорацией Майкрософт ключ для защиты ключа BitLocker. Для включения ключей, управляемых клиентами, на портале Azure выполните следующие действия:

1. Перейдите к лезвию **Обзора** для работы импорта.
2. В правом стене, **выберите, как ваши ключи BitLocker зашифрованы.**

    ![Выберите опцию шифрования](./media/storage-import-export-encryption-key-portal/encryption-key-1.png)

3. В лезвии **шифрования** можно просматривать и копировать ключ BitLocker. Под **типом шифрования**вы можете выбрать, как вы хотите защитить свой ключ BitLocker. По умолчанию используется ключ, управляемый корпорацией Майкрософт.

    ![Просмотр ключа BitLocker](./media/storage-import-export-encryption-key-portal/encryption-key-2.png)

4. У вас есть возможность указать ключ управления клиентом. После того как вы выбрали управляемый ключом клиента, **выберите хранилище ключа и ключ.**

    ![Выберите управляемый ключом клиента](./media/storage-import-export-encryption-key-portal/encryption-key-3.png)

5. В **ключе Select от** лезвия Azure Key Vault подписка автоматически заполняется. Для **хранилища ключей**можно выбрать существующее хранилище ключей из списка выпадающих.

    ![Выберите или создайте Хранилище ключей Azure](./media/storage-import-export-encryption-key-portal/encryption-key-4.png)

6. Вы также можете выбрать **Создание нового** для создания нового хранилища ключей. В **лезвии хранилища ключей Создайте**введите группу ресурсов и имя хранилища ключей. Примите все остальные значения по умолчанию. Выберите **Обзор и Создайте**.

    ![Создание нового хранилища ключей Azure](./media/storage-import-export-encryption-key-portal/encryption-key-5.png)

7. Просмотрите информацию, связанную с хранилищем ключей, и выберите **Создать.** Подождите пару минут, пока создание хранилища ключей будет завершено.

    ![Создание хранилища Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-6.png)

8. В **ключе Select от Azure Key Vault**можно выбрать ключ в существующем хранилище ключей.

9. Если вы создали новое хранилище ключей, выберите **Создать новый** для создания ключа. Размер ключа RSA может быть 2048 или больше.

    ![Создание нового ключа в Убежище ключей Azure](./media/storage-import-export-encryption-key-portal/encryption-key-7.png)

    Если мягкое удаление и защита от очистки не включены при создании хранилища ключей, хранилище ключей будет обновлено, чтобы иметь мягкое удаление и защиту очистки включен.

10. Укажите имя для ключа, примите другие по умолчанию и выберите **Создать.**

    ![Создание нового ключа](./media/storage-import-export-encryption-key-portal/encryption-key-8.png)

11. Выберите **версию,** а затем **выберите**. Вы уведомлены о создании ключа в хранилище ключей.

    ![Новый ключ, созданный в хранилище ключей](./media/storage-import-export-encryption-key-portal/encryption-key-9.png)

В лезвии **шифрования** можно увидеть хранилище ключей и выбранный ключ, выбранный для управляемого клиентом ключа.

## <a name="disable-keys"></a>Ключи отключаемых

Вы можете отключить только управляемые microsoft ключи и перейти к управляемым клиентам ключам на любом этапе работы по импорту/экспорту. Тем не менее, вы не можете отключить управляемый ключ клиента после того, как вы создали его.

## <a name="troubleshoot-customer-managed-key-errors"></a>Устранение проблем клиентов управляется ключевых ошибок

Если вы получаете какие-либо ошибки, связанные с управляемым ключом клиента, используйте следующую таблицу для устранения неполадок:

| Код ошибки     |Сведения     | Восстанавливаемых?    |
|----------------|------------|-----------------|
| CmkErrorAccessRevoked | Применяется ключ управления клиента, но ключ доступа в настоящее время отменен. Для получения дополнительной информации узнайте, как [включить доступ к ключу.](https://docs.microsoft.com/rest/api/keyvault/vaults/updateaccesspolicy)                                                      | Да, проверьте, если: <ol><li>Хранилище ключей по-прежнему имеет MSI в политике доступа.</li><li>Политика доступа предоставляет разрешения на получение, обертывание, развернуть.</li><li>Если хранилище ключей находится в vNet за брандмауэром, проверьте, включенли ли **надежные службы Майкрософт.**</li></ol>                                                                                            |
| CmkОшибкаИнвалид      | Применяется ключ управления клиента, но ключ отключен. Для получения дополнительной информации, см. [Enable the key](https://docs.microsoft.com/rest/api/keyvault/vaults/createorupdate)                                                                             | Да, включив ключевую версию     |
| CmkОшибкаНенайдено      | Применяется ключ управления клиента, но не может найти ключ. <br>Если ключ удален и удален после периода удержания, вы не можете восстановить ключ. При резервном копировании ключа можно восстановить ключ для решения этой проблемы. | Нет, ключ был удален, а также получил очищены после периода удержания. <br>Да, только если клиент имеет ключ резервного копирования и восстанавливает его.  |
| CmkErrorVaultNotFound | Применяется ключ управления клиента, но не может найти хранилище ключа, связанное с ключом.<br>Если вы удалили хранилище ключей, вы не сможете восстановить управляемый ключом клиента.  Если вы перенесли хранилище ключей другому арендатору, [см.](https://docs.microsoft.com/azure/key-vault/key-vault-subscription-move-fix) |   Нет, если клиент удалил хранилище ключей.<br> Да, если хранилище ключей подверглась миграции арендатора, сделайте одно из: <ol><li>вернуть хранилище ключей к старому арендатору.</li><li>установить идентификационную идентификацию - Нет, а затем вернуться к Identity и SystemAssigned, это удаляет и воссоздает идентификационную</li></ol><br>Примечание: Случай миграции арендатора основан на ограниченном понимании, необходимости проверить и подтвердить фактическое поведение, может быть пересмотрен позже. |

## <a name="next-steps"></a>Дальнейшие действия

- [Что такое Убежище ключей Azure?](https://docs.microsoft.com/azure/key-vault/key-vault-overview)
