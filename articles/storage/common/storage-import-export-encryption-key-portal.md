---
title: Использование портал Azure для настройки ключей, управляемых клиентом, для службы импорта и экспорта
description: Узнайте, как использовать портал Azure для настройки ключей, управляемых клиентом, с помощью Azure Key Vault для службы импорта и экспорта Azure. Ключи, управляемые клиентом, позволяют создавать, поворачивать, отключать и отзывать элементы управления доступом.
services: storage
author: alkohli
ms.service: storage
ms.topic: how-to
ms.date: 05/06/2020
ms.author: alkohli
ms.subservice: common
ms.openlocfilehash: 71426d131cdd46b176c387a31e3dc2ca66ae3761
ms.sourcegitcommit: f57297af0ea729ab76081c98da2243d6b1f6fa63
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82871165"
---
# <a name="use-customer-managed-keys-in-azure-key-vault-for-importexport-service"></a>Использование управляемых клиентом ключей в Azure Key Vault для службы импорта и экспорта

Служба импорта и экспорта Azure защищает ключи BitLocker, используемые для блокировки дисков, с помощью ключа шифрования. По умолчанию ключи BitLocker шифруются с помощью ключей, управляемых корпорацией Майкрософт. Для дополнительного контроля над ключами шифрования можно также предоставить ключи, управляемые клиентом.

Ключи, управляемые клиентом, должны быть созданы и сохранены в Azure Key Vault. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](../../key-vault/general/overview.md)

В этой статье показано, как использовать управляемые клиентом ключи с помощью службы импорта и экспорта в [портал Azure](https://portal.azure.com/).

## <a name="prerequisites"></a>Предварительные условия

Перед тем как начать, убедитесь в следующем:

1. Вы создали задание импорта или экспорта согласно инструкциям в следующих инструкциях:

    - [Создайте задание импорта для больших двоичных объектов](storage-import-export-data-to-blobs.md).
    - [Создайте задание импорта для файлов](storage-import-export-data-to-files.md).
    - [Создание задания экспорта для больших двоичных объектов](storage-import-export-data-from-blobs.md)

2. У вас уже есть Azure Key Vault с ключом, который можно использовать для защиты ключа BitLocker. Сведения о создании хранилища ключей с помощью портал Azure см. в разделе [Краткое руководство. Установка и извлечение секрета из Azure Key Vault с помощью портал Azure](../../key-vault/secrets/quick-create-portal.md).

    - **Обратимое удаление** и без **очистки** устанавливаются на существующие Key Vault. По умолчанию эти свойства отключены. Чтобы включить эти свойства, см. разделы с названием **Включение обратимого удаления** и **Включение защиты от очистки** в одной из следующих статей:

        - [Использование обратимого удаления с помощью PowerShell](../../key-vault/general/soft-delete-powershell.md).
        - [Использование обратимого удаления с помощью интерфейса командной строки](../../key-vault/general/soft-delete-cli.md).
    - Имеющееся хранилище ключей должно иметь ключ RSA размером 2048 или более. Дополнительные сведения о ключах см. в разделе **Key Vault Keys** раздела [о Azure Key Vault ключах, секретах и сертификатах](../../key-vault/about-keys-secrets-and-certificates.md#key-vault-keys).
    - Хранилище ключей должно находиться в том же регионе, что и учетная запись хранения для ваших данных.  
    - Если у вас нет Azure Key Vault, вы также можете создать ее в виде встроенных, как описано в следующем разделе.

## <a name="enable-keys"></a>Включить ключи

Настройка ключа, управляемого клиентом, для службы импорта и экспорта является необязательной. По умолчанию служба импорта и экспорта использует ключ, управляемый Майкрософт, для защиты ключа BitLocker. Чтобы включить управляемые клиентом ключи в портал Azure, выполните следующие действия.

1. Перейдите в колонку " **Обзор** " для задания импорта.
2. На правой панели выберите **выбрать метод шифрования ключей BitLocker**.

    ![Выбор параметра шифрования](./media/storage-import-export-encryption-key-portal/encryption-key-1.png)

3. В колонке **Шифрование** можно просмотреть и скопировать ключ BitLocker устройства. В разделе **тип шифрования**можно выбрать способ защиты ключа BitLocker. По умолчанию используется управляемый ключ Майкрософт.

    ![Просмотр ключа BitLocker](./media/storage-import-export-encryption-key-portal/encryption-key-2.png)

4. Имеется возможность указать ключ, управляемый клиентом. После выбора ключа, управляемого клиентом, **выберите хранилище ключей и ключ**.

    ![Выбор управляемого ключа клиента](./media/storage-import-export-encryption-key-portal/encryption-key-3.png)

5. В колонке **Выбор ключа из Azure Key Vault** подписка заполняется автоматически. В качестве **хранилища ключей**можно выбрать существующее хранилище ключей из раскрывающегося списка.

    ![Выберите или создайте Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-4.png)

6. Можно также выбрать **создать** , чтобы создать новое хранилище ключей. В **колонке создание хранилища ключей**введите группу ресурсов и имя хранилища ключей. Примите все остальные значения по умолчанию. Выберите **Review + Create** (Просмотреть и создать).

    ![Создание нового Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-5.png)

7. Проверьте сведения, связанные с хранилищем ключей, и нажмите кнопку **создать**. Подождите несколько минут, пока не завершится создание хранилища ключей.

    ![Создание хранилища Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-6.png)

8. В **разделе Выбор ключа из Azure Key Vault**можно выбрать ключ в существующем хранилище ключей.

9. Если вы создали новое хранилище ключей, выберите **создать** , чтобы создать ключ. Размер ключа RSA может быть 2048 или выше.

    ![Создание нового ключа в Azure Key Vault](./media/storage-import-export-encryption-key-portal/encryption-key-7.png)

    Если при создании хранилища ключей отключена защита от обратимого удаления и очистки, хранилище ключей будет обновлено для включения защиты от обратимого удаления и очистки.

10. Укажите имя ключа, примите другие значения по умолчанию и нажмите кнопку **создать**.

    ![Создать новый ключ](./media/storage-import-export-encryption-key-portal/encryption-key-8.png)

11. Выберите **версию** и нажмите кнопку **выбрать**. Вы получите извещение о том, что в хранилище ключей создан ключ.

    ![Новый ключ, созданный в хранилище ключей](./media/storage-import-export-encryption-key-portal/encryption-key-9.png)

В колонке **Шифрование** можно просмотреть хранилище ключей и ключ, выбранный для управляемого клиентом ключа.

> [!IMPORTANT]
> Вы можете отключить только управляемые ключи Майкрософт и перейти на управляемые ключи клиентов на любом этапе задания импорта и экспорта. Однако нельзя отключить управляемый клиентом ключ после его создания.

## <a name="troubleshoot-customer-managed-key-errors"></a>Устранение ошибок управляемых ключей клиентов

Если вы получаете ошибки, связанные с управляемым клиентом ключом, воспользуйтесь следующей таблицей для устранения неполадок:

| Код ошибки     |Сведения     | Восстанавливаемых?    |
|----------------|------------|-----------------|
| кмкерроракцессревокед | Применен ключ, управляемый клиентом, но доступ к ключу в настоящее время отменен. Дополнительные сведения см. в разделе [Включение доступа к ключам](https://docs.microsoft.com/rest/api/keyvault/vaults/updateaccesspolicy).                                                      | Да, проверить, если: <ol><li>Хранилище ключей по-прежнему имеет MSI в политике доступа.</li><li>Политика доступа предоставляет разрешения для получения, переноса, распаковки.</li><li>Если хранилище ключей находится в виртуальной сети за брандмауэром, установите флажок **разрешить включение доверенных служб Майкрософт** .</li></ol>                                                                                            |
| кмкерроркэйдисаблед      | Применен ключ, управляемый клиентом, но ключ отключен. Дополнительные сведения см. в разделе [Включение ключа](https://docs.microsoft.com/rest/api/keyvault/vaults/createorupdate).                                                                             | Да, включив версию ключа     |
| кмкерроркэйнотфаунд      | Применен ключ, управляемый клиентом, но не может найти хранилище ключей, связанное с ключом.<br>Если вы удалили хранилище ключей, вы не сможете восстановить ключ, управляемый клиентом.  Если вы перенесли хранилище ключей на другой клиент, см. статью [Изменение идентификатора клиента хранилища ключей после перемещения подписки](https://docs.microsoft.com/azure/key-vault/key-vault-subscription-move-fix). |   Если вы удалили хранилище ключей:<ol><li>Да, если она находится в течение длительного времени защиты, выполнив действия, описанные в статье [восстановление хранилища ключей](https://docs.microsoft.com/azure/key-vault/general/soft-delete-powershell#recovering-a-key-vault).</li><li>Нет, если он выходит за пределы продолжительности очистки от вирусов.</li></ol><br>В противном случае, если хранилище ключей прошло миграцию клиента, да, его можно восстановить, выполнив одно из следующих действий. <ol><li>Верните хранилище ключей к старому клиенту.</li><li>Установите `Identity = None` , а затем присвойте значение `Identity = SystemAssigned`. Это приведет к удалению и повторному созданию удостоверения после создания нового удостоверения. Включите `Get`разрешения `Wrap`, и `Unwrap` для нового удостоверения в политике доступа хранилища ключей.</li></ol>|

## <a name="next-steps"></a>Дальнейшие действия

- [Что такое Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-overview)?
