---
title: Шифрование службы хранилища Azure для неактивных данных | Документация Майкрософт
description: Служба хранилища Azure защищает данные, автоматически шифруя их перед сохранением в облаке. Вы можете использовать ключи, управляемые корпорацией Майкрософт, для шифрования учетной записи хранения или управлять шифрованием с помощью собственных ключей.
services: storage
author: tamram
ms.service: storage
ms.date: 10/02/2019
ms.topic: conceptual
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: 42c674e236d769d48f6f17fc43494ac006219a8a
ms.sourcegitcommit: 018e3b40e212915ed7a77258ac2a8e3a660aaef8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2019
ms.locfileid: "73795694"
---
# <a name="azure-storage-encryption-for-data-at-rest"></a>Шифрование неактивных данных в службе хранилища Azure

Служба хранилища Azure автоматически шифрует данные при сохранении их в облаке. Шифрование защищает ваши данные и помогает удовлетворить ваши обязательства по обеспечению безопасности и соответствия требованиям Организации. Данные в службе хранилища Azure шифруются и расшифровываются прозрачно с использованием 256-разрядного [шифрования AES](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard), одним из наиболее подданных блоков блочных шифров и совместимым с FIPS 140-2. Шифрование службы хранилища Azure аналогично шифрованию BitLocker в Windows.

Шифрование службы хранилища Azure включено для всех новых и существующих учетных записей хранения и не может быть отключено. Поскольку данные защищены по умолчанию, вам не нужно изменять код или приложения, чтобы воспользоваться преимуществами шифрования службы хранилища Azure.

Учетные записи хранения шифруются независимо от уровня производительности ("Стандартный" или "Премиум") или модели развертывания (Azure Resource Manager или классической версии). Все параметры избыточности службы хранилища Azure поддерживают шифрование, а все копии учетной записи хранения шифруются. Все ресурсы службы хранилища Azure шифруются, включая большие двоичные объекты, диски, файлы, очереди и таблицы. Все метаданные объекта также шифруются.

Шифрование не влияет на производительность службы хранилища Azure. Дополнительные затраты на шифрование службы хранилища Azure отсутствуют.

Дополнительные сведения о криптографических модулях, лежащих в основе шифрования службы хранилища Azure, см. в разделе [API шифрования: следующее поколение](https://docs.microsoft.com/windows/desktop/seccng/cng-portal).

## <a name="about-encryption-key-management"></a>Сведения об управлении ключами шифрования

Вы можете использовать ключи, управляемые корпорацией Майкрософт, для шифрования учетной записи хранения или управлять шифрованием с помощью собственных ключей. Если вы решили управлять шифрованием с помощью собственных ключей, у вас есть два варианта:

- Вы можете указать *ключ, управляемый клиентом* , который будет использоваться для шифрования и расшифровки всех данных в учетной записи хранения. Ключ, управляемый клиентом, используется для шифрования всех данных во всех службах в учетной записи хранения.
- Вы можете указать *предоставленный клиентом ключ* для операций с хранилищем BLOB-объектов. Клиент, выполняющий запрос на чтение или запись к хранилищу BLOB-объектов, может включать ключ шифрования в запрос, чтобы детально контролировать способ шифрования и расшифровки данных BLOB-объектов.

В следующей таблице сравниваются параметры управления ключами для шифрования службы хранилища Azure.

|                                        |    Ключи, управляемые корпорацией Майкрософт                             |    Ключи, управляемые клиентом                                                                                                                        |    Ключи, предоставляемые клиентом                                                          |
|----------------------------------------|-------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|    Операции шифрования и расшифровки    |    Таблицы Azure                                              |    Таблицы Azure                                                                                                                                        |    Таблицы Azure                                                                         |
|    Поддерживаемые службы хранилища Azure    |    Все                                                |    Хранилище BLOB-объектов, службы файлов Azure                                                                                                               |    Хранилище BLOB-объектов                                                                  |
|    Хранилище ключей                         |    Хранилище ключей (Майкрософт)    |    хранилищем ключей Azure                                                                                                                              |    Azure Key Vault или любое другое хранилище ключей                                                                 |
|    Ответственность за смену ключей         |    Microsoft                                          |    Клиент                                                                                                                                     |    Клиент                                                                      |
|    Использование ключа                           |    Microsoft                                          |    Портал Azure, REST API поставщика ресурсов хранилища, библиотеки управления хранилищем Azure, PowerShell, CLI        |    REST API хранилища Azure (хранилище BLOB-объектов), клиентские библиотеки службы хранилища Azure    |
|    Доступ к ключам                          |    Только Майкрософт                                     |    Майкрософт, клиент                                                                                                                    |    Только клиент                                                                 |

В следующих разделах каждый из параметров управления ключами описан более подробно.

## <a name="microsoft-managed-keys"></a>Ключи, управляемые корпорацией Майкрософт

По умолчанию учетная запись хранения использует ключи шифрования, управляемые корпорацией Майкрософт. Параметры шифрования для вашей учетной записи хранения можно просмотреть в разделе " **Шифрование** " [портал Azure](https://portal.azure.com), как показано на следующем рисунке.

![Просмотр учетной записи, зашифрованной с помощью ключей, управляемых корпорацией Майкрософт](media/storage-service-encryption/encryption-microsoft-managed-keys.png)

## <a name="customer-managed-keys"></a>Ключи, управляемые клиентом

Вы можете управлять шифрованием службы хранилища Azure на уровне учетной записи хранения с помощью собственных ключей. При указании ключа, управляемого клиентом, на уровне учетной записи хранения этот ключ используется для шифрования и расшифровки всех данных в учетной записи хранения, включая данные большого двоичного объекта, очереди, файла и таблицы.  Ключи, управляемые клиентом, обеспечивают большую гибкость при создании, повороте, отключении и отмене контроля доступа. Кроме того, можно выполнять аудит ключей шифрования, используемых для защиты данных.

Для хранения ключей, управляемых клиентом, необходимо использовать Azure Key Vault. Можно либо создать собственные ключи и сохранить их в хранилище ключей, либо использовать Azure Key Vault API для создания ключей. Учетная запись хранения и Key Vault должны быть расположены в одном регионе, но могут находиться в разных подписках. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](../../key-vault/key-vault-overview.md).

На этой схеме показано, как служба хранилища Azure использует Azure Active Directory и Azure Key Vault для выполнения запросов с помощью управляемого клиентом ключа:

![Схема работы ключей, управляемых клиентом, в службе хранилища Azure](media/storage-service-encryption/encryption-customer-managed-keys-diagram.png)

В следующем списке описаны пронумерованные шаги на схеме.

1. Администратор Azure Key Vault предоставляет разрешения на ключи шифрования для управляемого удостоверения, связанного с учетной записью хранения.
2. Администратор службы хранилища Azure настраивает шифрование с помощью управляемого клиентом ключа для учетной записи хранения.
3. Служба хранилища Azure использует управляемое удостоверение, связанное с учетной записью хранения, для проверки подлинности доступа к Azure Key Vault через Azure Active Directory.
4. Служба хранилища Azure заключает ключ шифрования учетной записи в ключ клиента в Azure Key Vault.
5. Для операций чтения и записи служба хранилища Azure отправляет запросы в Azure Key Vault для переноса и распаковки ключа шифрования учетной записи для выполнения операций шифрования и расшифровки.

Сведения о том, как отозвать доступ к управляемым клиентом ключам в учетной записи хранения, см. в статье [Azure Key Vault PowerShell](https://docs.microsoft.com/powershell/module/azurerm.keyvault/) и [Azure Key Vault CLI](https://docs.microsoft.com/cli/azure/keyvault). Отзыв доступа блокирует доступ ко всем данным в учетной записи хранения, так как ключ шифрования недоступен для службы хранилища Azure.

Ключи, управляемые клиентом, также доступны для управляемых дисков Azure в качестве общедоступной предварительной версии. ключи, управляемые клиентом, работают немного иначе для управляемых дисков, чем остальная часть хранилища. Дополнительные сведения см. в нашей [статье по теме](../../virtual-machines/linux/disk-encryption.md#customer-managed-keys-public-preview).

Сведения об использовании управляемых клиентом ключей с помощью службы хранилища Azure см. в одной из следующих статей:

- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure на портале Azure](storage-encryption-keys-portal.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure с помощью PowerShell](storage-encryption-keys-powershell.md)
- [Использование управляемых клиентом ключей с шифрованием службы хранилища Azure из Azure CLI](storage-encryption-keys-cli.md)

> [!IMPORTANT]
> Управляемые клиентом ключи используют управляемые удостоверения для ресурсов Azure, функции Azure Active Directory (Azure AD). При настройке ключей, управляемых клиентом, в портал Azure управляемое удостоверение автоматически назначается вашей учетной записи хранения, как описано в этой статье. Если впоследствии вы перемещаете подписку, группу ресурсов или учетную запись хранения из одного каталога Azure AD в другой, управляемое удостоверение, связанное с учетной записью хранения, не передается в новый клиент, поэтому управляемые клиентом ключи могут перестать работать. Дополнительные сведения см. в статье **Передача подписки между каталогами Azure AD** в [часто задаваемых вопросах и известных проблемах с управляемыми удостоверениями для ресурсов Azure](../../active-directory/managed-identities-azure-resources/known-issues.md#transferring-a-subscription-between-azure-ad-directories).  

## <a name="customer-provided-keys-preview"></a>Ключи, предоставленные клиентом (Предварительная версия)

Клиенты, выполняющие запросы к хранилищу BLOB-объектов Azure, имеют возможность предоставить ключ шифрования для отдельного запроса. Включение ключа шифрования в запрос обеспечивает детальный контроль над параметрами шифрования для операций с хранилищем BLOB-объектов. Предоставленные клиентом ключи (Предварительная версия) можно хранить в Azure Key Vault или в другом хранилище ключей.

### <a name="encrypting-read-and-write-operations"></a>Шифрование операций чтения и записи

Когда клиентское приложение предоставляет ключ шифрования для запроса, служба хранилища Azure прозрачно выполняет шифрование и расшифровку при чтении и записи данных больших двоичных объектов. Хэш SHA-256 ключа шифрования записывается вместе с содержимым большого двоичного объекта и используется для проверки того, что все последующие операции с BLOB-объектом используют один и тот же ключ шифрования. Служба хранилища Azure не хранит ключ шифрования, который клиент отправляет вместе с запросом, и не управляет им. Ключ безопасно удаляется сразу после завершения процесса шифрования или расшифровки.

Когда клиент создает или обновляет большой двоичный объект с помощью предоставленного клиентом ключа, последующие запросы на чтение и запись для этого большого двоичного объекта также должны предоставлять ключ. Если ключ не предоставлен по запросу для большого двоичного объекта, который уже зашифрован с помощью предоставленного клиентом ключа, запрос завершается ошибкой с кодом 409 (конфликт).

Если клиентское приложение отправляет ключ шифрования в запросе, а учетная запись хранения также шифруется с помощью ключа, управляемого Майкрософт, или ключа, управляемого клиентом, служба хранилища Azure использует ключ, указанный в запросе на шифрование и расшифровку.

Чтобы отправить ключ шифрования в рамках запроса, клиент должен установить безопасное подключение к службе хранилища Azure с помощью протокола HTTPS.

Каждый моментальный снимок BLOB-объекта может иметь свой собственный ключ шифрования.

### <a name="request-headers-for-specifying-customer-provided-keys"></a>Заголовки запроса для указания предоставленных клиентом ключей

Для вызовов RESTFUL клиенты могут использовать следующие заголовки для безопасной передачи сведений о ключе шифрования в запрос в хранилище BLOB-объектов:

|Заголовок запроса | Description (Описание) |
|---------------|-------------|
|`x-ms-encryption-key` |Требуется для запросов Write и Read. Значение ключа шифрования AES-256 в кодировке Base64. |
|`x-ms-encryption-key-sha256`| Требуется для запросов Write и Read. Значение SHA256 ключа шифрования в кодировке Base64. |
|`x-ms-encryption-algorithm` | Требуется для запросов записи, необязательных для запросов чтения. Задает алгоритм, используемый при шифровании данных с помощью заданного ключа. Должен быть AES256. |

Указание ключей шифрования для запроса является необязательным. Однако если указать один из указанных выше заголовков для операции записи, необходимо указать все эти заголовки.

### <a name="blob-storage-operations-supporting-customer-provided-keys"></a>Операции хранилища BLOB-объектов, поддерживающие предоставленные клиентом ключи

Следующие операции хранилища BLOB-объектов поддерживают отправку предоставленных клиентом ключей шифрования для запроса:

- [вставка большого двоичного объекта](/rest/api/storageservices/put-blob);
- [вставка списка блокировки](/rest/api/storageservices/put-block-list);
- [Put Block](/rest/api/storageservices/put-block)
- [Разместить блок по URL-адресу](/rest/api/storageservices/put-block-from-url)
- [Put Page](/rest/api/storageservices/put-page)
- [Размещение страницы по URL-адресу](/rest/api/storageservices/put-page-from-url)
- [Append Block](/rest/api/storageservices/append-block)
- [задание свойств службы BLOB-объекта](/rest/api/storageservices/set-blob-properties).
- [Set Blob Metadata](/rest/api/storageservices/set-blob-metadata)
- [Получение большого двоичного объекта](/rest/api/storageservices/get-blob)
- [Получение свойств большого двоичного объекта](/rest/api/storageservices/get-blob-properties)
- [Получение метаданных BLOB-объекта](/rest/api/storageservices/get-blob-metadata)
- [Большой двоичный объект моментальных снимков](/rest/api/storageservices/snapshot-blob)

### <a name="rotate-customer-provided-keys"></a>Поворачивайте ключи, предоставленные клиентом

Чтобы повернуть ключ шифрования, переданный в запросе, скачайте большой двоичный объект и повторно загрузите его с новым ключом шифрования.

> [!IMPORTANT]
> Портал Azure нельзя использовать для чтения или записи в контейнер или большой двоичный объект, зашифрованный с помощью ключа, указанного в запросе.
>
> Обязательно Защитите ключ шифрования, предоставленный в запросе к хранилищу BLOB-объектов, в безопасном хранилище ключей, например Azure Key Vault. Если выполнить операцию записи для контейнера или большого двоичного объекта без ключа шифрования, операция завершится ошибкой, а доступ к объекту будет потерян.

### <a name="example-use-a-customer-provided-key-to-upload-a-blob-in-net"></a>Пример. использование предоставленного клиентом ключа для отправки большого двоичного объекта в .NET

В следующем примере создается ключ, предоставленный клиентом, и этот ключ используется для отправки большого двоичного объекта. Код отправляет блок, а затем фиксирует список блокировок для записи большого двоичного объекта в службу хранилища Azure. Ключ предоставляется для объекта [BlobRequestOptions](/dotnet/api/microsoft.azure.storage.blob.blobrequestoptions) путем установки свойства [кустомерпровидедкэй](/dotnet/api/microsoft.azure.storage.blob.blobrequestoptions.customerprovidedkey) .

Ключ создается с помощью класса [AesCryptoServiceProvider](/dotnet/api/system.security.cryptography.aescryptoserviceprovider) . Чтобы создать экземпляр этого класса в коде, добавьте инструкцию `using`, которая ссылается на пространство имен `System.Security.Cryptography`:

```csharp
public static void UploadBlobWithClientKey(CloudBlobContainer container)
{
    // Create a new key using the Advanced Encryption Standard (AES) algorithm.
    AesCryptoServiceProvider keyAes = new AesCryptoServiceProvider();

    // Specify the key as an option on the request.
    BlobCustomerProvidedKey customerProvidedKey = new BlobCustomerProvidedKey(keyAes.Key);
    var options = new BlobRequestOptions
    {
        CustomerProvidedKey = customerProvidedKey
    };

    string blobName = "sample-blob-" + Guid.NewGuid();
    CloudBlockBlob blockBlob = container.GetBlockBlobReference(blobName);

    try
    {
        // Create an array of random bytes.
        byte[] buffer = new byte[1024];
        Random rnd = new Random();
        rnd.NextBytes(buffer);

        using (MemoryStream sourceStream = new MemoryStream(buffer))
        {
            // Write the array of random bytes to a block.
            int blockNumber = 1;
            string blockId = Convert.ToBase64String(Encoding.ASCII.GetBytes(string.Format("BlockId{0}",
                blockNumber.ToString("0000000"))));

            // Write the block to Azure Storage.
            blockBlob.PutBlock(blockId, sourceStream, null, null, options, null);

            // Commit the block list to write the blob.
            blockBlob.PutBlockList(new List<string>() { blockId }, null, options, null);
        }
    }
    catch (StorageException e)
    {
        Console.WriteLine(e.Message);
        Console.ReadLine();
        throw;
    }
}
```

## <a name="azure-storage-encryption-versus-disk-encryption"></a>Шифрование службы хранилища Azure и шифрование диска

При использовании шифрования службы хранилища Azure все учетные записи хранения Azure и содержащиеся в них ресурсы шифруются, включая страничные BLOB-объекты, которые поддерживают диски виртуальных машин Azure. Кроме того, диски виртуальной машины Azure могут быть зашифрованы с помощью [шифрования дисков Azure](../../security/azure-security-disk-encryption-overview.md). Шифрование дисков Azure использует стандартные отраслевые [BitLocker](https://docs.microsoft.com/windows/security/information-protection/bitlocker/bitlocker-overview) в Windows и [DM-](https://en.wikipedia.org/wiki/Dm-crypt) Encryption в Linux для предоставления решений шифрования на основе операционной системы, интегрированных с Azure Key Vault.

## <a name="next-steps"></a>Дальнейшие действия

- [Что такое хранилище ключей Azure?](../../key-vault/key-vault-overview.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure на портале Azure](storage-encryption-keys-portal.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure с помощью PowerShell](storage-encryption-keys-powershell.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure с помощью Azure CLI](storage-encryption-keys-cli.md)
