---
title: Шифрование неактивных данных в службе хранилища Azure
description: Служба хранилища Azure защищает данные, автоматически шифруя их перед сохранением в облаке. Вы можете использовать ключи, управляемые корпорацией Майкрософт, для шифрования учетной записи хранения или управлять шифрованием с помощью собственных ключей.
services: storage
author: tamram
ms.service: storage
ms.date: 01/10/2020
ms.topic: conceptual
ms.author: tamram
ms.reviewer: cbrooks
ms.subservice: common
ms.openlocfilehash: b74943ce3e3e67855a07fa32f15612bbb2351170
ms.sourcegitcommit: e9776e6574c0819296f28b43c9647aa749d1f5a6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2020
ms.locfileid: "75913097"
---
# <a name="azure-storage-encryption-for-data-at-rest"></a>Шифрование неактивных данных в службе хранилища Azure

Служба хранилища Azure автоматически шифрует данные при их сохранении в облаке. Шифрование службы хранилища Azure защищает ваши данные и помогает удовлетворить ваши обязательства по обеспечению безопасности и соответствия требованиям Организации.

## <a name="about-azure-storage-encryption"></a>О шифровании службы хранилища Azure

Данные в службе хранилища Azure шифруются и расшифровываются прозрачно с использованием 256-разрядного [шифрования AES](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard), одним из наиболее подданных блоков блочных шифров и совместимым с FIPS 140-2. Шифрование службы хранилища Azure аналогично шифрованию BitLocker в Windows.

Шифрование службы хранилища Azure включено для всех новых учетных записей хранения, включая как диспетчер ресурсов, так и классические учетные записи хранения. Шифрование службы хранилища Azure не может быть отключено. Поскольку данные защищены по умолчанию, вам не нужно изменять код или приложения, чтобы воспользоваться преимуществами шифрования службы хранилища Azure.

Учетные записи хранения шифруются независимо от уровня производительности ("Стандартный" или "Премиум") или модели развертывания (Azure Resource Manager или классической версии). Все параметры избыточности службы хранилища Azure поддерживают шифрование, а все копии учетной записи хранения шифруются. Все ресурсы службы хранилища Azure шифруются, включая большие двоичные объекты, диски, файлы, очереди и таблицы. Все метаданные объекта также шифруются.

Шифрование не влияет на производительность службы хранилища Azure. Дополнительные затраты на шифрование службы хранилища Azure отсутствуют.

Каждый блочный большой двоичный объект, добавочный большой двоичный объект или страничный BLOB-объект, записанный в службу хранилища Azure после 20 октября 2017, шифруется. Большие двоичные объекты, созданные до этой даты, продолжают шифроваться фоновым процессом. Чтобы принудительно выполнить шифрование большого двоичного объекта, созданного до 20 октября 2017, можно переписать большой двоичный объект. Сведения о проверке состояния шифрования большого двоичного объекта см. в разделе [Проверка состояния шифрования большого двоичного](../blobs/storage-blob-encryption-status.md)объекта.

Дополнительные сведения о криптографических модулях, лежащих в основе шифрования службы хранилища Azure, см. в разделе [API шифрования: следующее поколение](https://docs.microsoft.com/windows/desktop/seccng/cng-portal).

## <a name="about-encryption-key-management"></a>Сведения об управлении ключами шифрования

Вы можете использовать ключи, управляемые корпорацией Майкрософт, для шифрования учетной записи хранения или управлять шифрованием с помощью собственных ключей. Если вы решили управлять шифрованием с помощью собственных ключей, у вас есть два варианта:

- Вы можете указать *ключ, управляемый клиентом* , с помощью Azure Key Vault, который будет использоваться для шифрования и расшифровки данных в хранилище BLOB-объектов и в службе файлов Azure. <sup>1, 2</sup>
- Вы можете указать *предоставленный клиентом ключ* для операций с хранилищем BLOB-объектов. Клиент, выполняющий запрос на чтение или запись к хранилищу BLOB-объектов, может включать ключ шифрования в запрос, чтобы детально контролировать способ шифрования и расшифровки данных BLOB-объектов.

В следующей таблице сравниваются параметры управления ключами для шифрования службы хранилища Azure.

|                                        |    Ключи, управляемые корпорацией Майкрософт                             |    Ключи, управляемые клиентом                                                                                                                        |    Ключи, предоставляемые клиентом                                                          |
|----------------------------------------|-------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
|    Операции шифрования и расшифровки    |    Azure                                              |    Azure                                                                                                                                        |    Azure                                                                         |
|    Поддерживаемые службы хранилища Azure    |    Все                                                |    Хранилище BLOB-объектов, файлы Azure<sup>1, 2</sup>                                                                                                               |    Хранилище BLOB-объектов                                                                  |
|    Хранилище ключей                         |    Хранилище ключей (Майкрософт)    |    Azure Key Vault.                                                                                                                              |    Azure Key Vault или любое другое хранилище ключей                                                                 |
|    Ответственность за смену ключей         |    Майкрософт                                          |    Customer                                                                                                                                     |    Customer                                                                      |
|    Использование ключа                           |    Майкрософт                                          |    Портал Azure, REST API поставщика ресурсов хранилища, библиотеки управления хранилищем Azure, PowerShell, CLI        |    REST API хранилища Azure (хранилище BLOB-объектов), клиентские библиотеки службы хранилища Azure    |
|    Доступ к ключам                          |    Только Майкрософт                                     |    Майкрософт, клиент                                                                                                                    |    Только клиент                                                                 |

<sup>1</sup> сведения о создании учетной записи, поддерживающей использование управляемых клиентом ключей с хранилищем очередей, см. в разделе [Создание учетной записи, которая поддерживает управляемые клиентом ключи для очередей](account-encryption-key-create.md?toc=%2fazure%2fstorage%2fqueues%2ftoc.json).<br />
<sup>2</sup> дополнительные сведения о создании учетной записи, поддерживающей использование управляемых клиентом ключей с хранилищем таблиц, см. в разделе [Создание учетной записи, которая поддерживает управляемые клиентом ключи для таблиц](account-encryption-key-create.md?toc=%2fazure%2fstorage%2ftables%2ftoc.json).

В следующих разделах каждый из параметров управления ключами описан более подробно.

## <a name="microsoft-managed-keys"></a>Ключи, управляемые корпорацией Майкрософт

По умолчанию учетная запись хранения использует ключи шифрования, управляемые корпорацией Майкрософт. Параметры шифрования для вашей учетной записи хранения можно просмотреть в разделе " **Шифрование** " [портал Azure](https://portal.azure.com), как показано на следующем рисунке.

![Просмотр учетной записи, зашифрованной с помощью ключей, управляемых корпорацией Майкрософт](media/storage-service-encryption/encryption-microsoft-managed-keys.png)

## <a name="customer-managed-keys-with-azure-key-vault"></a>Ключи, управляемые клиентом, с Azure Key Vault

Вы можете управлять шифрованием службы хранилища Azure на уровне учетной записи хранения с помощью собственных ключей. При указании ключа, управляемого клиентом, на уровне учетной записи хранения этот ключ используется для защиты и контроля доступа к корневому ключу шифрования учетной записи хранения, который, в свою очередь, используется для шифрования и расшифровки всех данных больших двоичных объектов и файлов. Ключи, управляемые клиентом, обеспечивают большую гибкость при создании, повороте, отключении и отмене контроля доступа. Кроме того, можно выполнять аудит ключей шифрования, используемых для защиты данных.

Для хранения ключей, управляемых клиентом, необходимо использовать Azure Key Vault. Можно либо создать собственные ключи и сохранить их в хранилище ключей, либо использовать Azure Key Vault API для создания ключей. Учетная запись хранения и Key Vault должны быть расположены в одном регионе, но могут находиться в разных подписках. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](../../key-vault/key-vault-overview.md).

На этой схеме показано, как служба хранилища Azure использует Azure Active Directory и Azure Key Vault для выполнения запросов с помощью управляемого клиентом ключа:

![Схема работы ключей, управляемых клиентом, в службе хранилища Azure](media/storage-service-encryption/encryption-customer-managed-keys-diagram.png)

В следующем списке описаны пронумерованные шаги на схеме.

1. Администратор Azure Key Vault предоставляет разрешения на ключи шифрования для управляемого удостоверения, связанного с учетной записью хранения.
2. Администратор службы хранилища Azure настраивает шифрование с помощью управляемого клиентом ключа для учетной записи хранения.
3. Служба хранилища Azure использует управляемое удостоверение, связанное с учетной записью хранения, для проверки подлинности доступа к Azure Key Vault через Azure Active Directory.
4. Служба хранилища Azure заключает ключ шифрования учетной записи в ключ клиента в Azure Key Vault.
5. Для операций чтения и записи служба хранилища Azure отправляет запросы в Azure Key Vault для переноса и распаковки ключа шифрования учетной записи для выполнения операций шифрования и расшифровки.

### <a name="enable-customer-managed-keys-for-a-storage-account"></a>Включение управляемых клиентом ключей для учетной записи хранения

При включении шифрования с помощью управляемых клиентом ключей для учетной записи хранения служба хранилища Azure заключает ключ шифрования учетной записи в ключ, управляемый клиентом, в связанном хранилище ключей. Включение управляемых клиентом ключей не влияет на производительность, и учетная запись шифруется с новым ключом немедленно без задержки.

Новая учетная запись хранения всегда шифруется с помощью ключей, управляемых корпорацией Майкрософт. Невозможно включить управляемые клиентом ключи на момент создания учетной записи. Ключи, управляемые клиентом, хранятся в Azure Key Vault, а хранилище ключей должно быть подготовлено с помощью политик доступа, которые предоставляют ключевые разрешения для управляемого удостоверения, связанного с учетной записью хранения. Управляемое удостоверение доступно только после создания учетной записи хранения.

При изменении ключа, используемого для шифрования службы хранилища Azure, путем включения или отключения управляемых клиентом ключей, обновления ключа или указания другого ключа, шифрование корневого ключа изменяется, но данные в учетной записи хранения Azure не необходимо повторно зашифровать.

Сведения об использовании управляемых клиентом ключей с Azure Key Vault для шифрования службы хранилища Azure см. в одной из следующих статей:

- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure из портал Azure](storage-encryption-keys-portal.md)
- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure из PowerShell](storage-encryption-keys-powershell.md)
- [Настройка ключей, управляемых клиентом, с помощью Key Vault для шифрования службы хранилища Azure Azure CLI](storage-encryption-keys-cli.md)

> [!IMPORTANT]
> Управляемые клиентом ключи используют управляемые удостоверения для ресурсов Azure, функции Azure Active Directory (Azure AD). При настройке ключей, управляемых клиентом, в портал Azure управляемое удостоверение автоматически назначается вашей учетной записи хранения, как описано в этой статье. Если впоследствии вы перемещаете подписку, группу ресурсов или учетную запись хранения из одного каталога Azure AD в другой, управляемое удостоверение, связанное с учетной записью хранения, не передается в новый клиент, поэтому управляемые клиентом ключи могут перестать работать. Дополнительные сведения см. в статье **Передача подписки между каталогами Azure AD** в [часто задаваемых вопросах и известных проблемах с управляемыми удостоверениями для ресурсов Azure](../../active-directory/managed-identities-azure-resources/known-issues.md#transferring-a-subscription-between-azure-ad-directories).  

### <a name="store-customer-managed-keys-in-azure-key-vault"></a>Хранение ключей, управляемых клиентом, в Azure Key Vault

Чтобы включить управляемые клиентом ключи в учетной записи хранения, необходимо использовать Azure Key Vault для хранения ключей. Необходимо включить как **обратимое удаление** , так и **не очищать** свойства в хранилище ключей.

С шифрованием службы хранилища Azure поддерживаются только ключи RSA размером 2048. Дополнительные сведения о ключах см. в разделе **Key Vault Keys** раздела [о Azure Key Vault ключах, секретах и сертификатах](../../key-vault/about-keys-secrets-and-certificates.md#key-vault-keys).

Хранилище ключей должно находиться в той же подписке, что и учетная запись хранения. Служба хранилища Azure использует управляемые удостоверения для ресурсов Azure, чтобы пройти проверку подлинности в хранилище ключей для операций шифрования и расшифровки. Сейчас управляемые удостоверения не поддерживаются в сценариях работы с разными каталогами.

### <a name="rotate-customer-managed-keys"></a>Смена ключей, управляемых клиентом

Вы можете поворачивать ключ, управляемый клиентом, в Azure Key Vault в соответствии с политиками соответствия требованиям. При вращении ключа необходимо обновить учетную запись хранения, чтобы она использовала новый URI ключа. Сведения об обновлении учетной записи хранения для использования новой версии ключа в портал Azure см. в разделе **обновление ключа версии раздела** [Настройка управляемых клиентом ключей для службы хранилища Azure с помощью портал Azure](storage-encryption-keys-portal.md).

При вращении ключа повторное шифрование данных в учетной записи хранения не инициируется. От пользователя не требуется предпринимать никаких действий.

### <a name="revoke-access-to-customer-managed-keys"></a>Отозвать доступ к ключам, управляемым клиентом

Чтобы отозвать доступ к ключам, управляемым клиентом, используйте PowerShell или Azure CLI. Дополнительные сведения см. в разделе [Azure Key Vault PowerShell](/powershell/module/az.keyvault//) или [Azure Key Vault CLI](/cli/azure/keyvault). Отзыв доступа блокирует доступ ко всем данным в учетной записи хранения, так как ключ шифрования недоступен для службы хранилища Azure.

### <a name="customer-managed-keys-for-azure-managed-disks-preview"></a>Управляемые клиентом ключи для управляемых дисков Azure (Предварительная версия)

Ключи, управляемые клиентом, также доступны для управления шифрованием управляемых дисков Azure (Предварительная версия). Управляемые клиентом ключи ведут себя иначе для управляемых дисков, чем для ресурсов службы хранилища Azure. Дополнительные сведения см. в статье [Шифрование на стороне сервера для управляемых дисков Azure](../../virtual-machines/windows/disk-encryption.md) для Windows или [Шифрование на стороне сервера для управляемых дисков Azure](../../virtual-machines/linux/disk-encryption.md) для Linux.

## <a name="customer-provided-keys-preview"></a>Ключи, предоставленные клиентом (Предварительная версия)

Клиенты, выполняющие запросы к хранилищу BLOB-объектов Azure, имеют возможность предоставить ключ шифрования для отдельного запроса. Включение ключа шифрования в запрос обеспечивает детальный контроль над параметрами шифрования для операций с хранилищем BLOB-объектов. Предоставленные клиентом ключи (Предварительная версия) можно хранить в Azure Key Vault или в другом хранилище ключей.

Пример, демонстрирующий указание предоставленного клиентом ключа для запроса к хранилищу BLOB-объектов, см. в разделе [Указание предоставленного клиентом ключа для запроса к хранилищу BLOB-объектов с помощью .NET](../blobs/storage-blob-customer-provided-key.md). 

### <a name="encrypting-read-and-write-operations"></a>Шифрование операций чтения и записи

Когда клиентское приложение предоставляет ключ шифрования для запроса, служба хранилища Azure прозрачно выполняет шифрование и расшифровку при чтении и записи данных больших двоичных объектов. Служба хранилища Azure записывает хэш SHA-256 ключа шифрования вместе с содержимым большого двоичного объекта. Хэш используется для проверки того, что все последующие операции с BLOB-объектом используют один и тот же ключ шифрования. 

Служба хранилища Azure не хранит ключ шифрования, который клиент отправляет вместе с запросом, и не управляет им. Ключ безопасно удаляется сразу после завершения процесса шифрования или расшифровки.

Когда клиент создает или обновляет большой двоичный объект с помощью предоставленного клиентом ключа, последующие запросы на чтение и запись для этого большого двоичного объекта также должны предоставлять ключ. Если ключ не предоставлен по запросу для большого двоичного объекта, который уже зашифрован с помощью предоставленного клиентом ключа, запрос завершается ошибкой с кодом 409 (конфликт).

Если клиентское приложение отправляет ключ шифрования в запросе, а учетная запись хранения также шифруется с помощью ключа, управляемого Майкрософт, или ключа, управляемого клиентом, служба хранилища Azure использует ключ, указанный в запросе на шифрование и расшифровку.

Чтобы отправить ключ шифрования в рамках запроса, клиент должен установить безопасное подключение к службе хранилища Azure с помощью протокола HTTPS.

Каждый моментальный снимок BLOB-объекта может иметь свой собственный ключ шифрования.

### <a name="request-headers-for-specifying-customer-provided-keys"></a>Заголовки запроса для указания предоставленных клиентом ключей

Для вызовов RESTFUL клиенты могут использовать следующие заголовки для безопасной передачи сведений о ключе шифрования в запрос в хранилище BLOB-объектов:

|Заголовок запроса | Description |
|---------------|-------------|
|`x-ms-encryption-key` |Требуется для запросов Write и Read. Значение ключа шифрования AES-256 в кодировке Base64. |
|`x-ms-encryption-key-sha256`| Требуется для запросов Write и Read. Значение SHA256 ключа шифрования в кодировке Base64. |
|`x-ms-encryption-algorithm` | Требуется для запросов записи, необязательных для запросов чтения. Задает алгоритм, используемый при шифровании данных с помощью заданного ключа. Должен быть AES256. |

Указание ключей шифрования для запроса является необязательным. Однако если указать один из указанных выше заголовков для операции записи, необходимо указать все эти заголовки.

### <a name="blob-storage-operations-supporting-customer-provided-keys"></a>Операции хранилища BLOB-объектов, поддерживающие предоставленные клиентом ключи

Следующие операции хранилища BLOB-объектов поддерживают отправку предоставленных клиентом ключей шифрования для запроса:

- [вставка большого двоичного объекта](/rest/api/storageservices/put-blob);
- [вставка списка блокировки](/rest/api/storageservices/put-block-list);
- [Put Block](/rest/api/storageservices/put-block)
- [Разместить блок по URL-адресу](/rest/api/storageservices/put-block-from-url)
- [Put Page](/rest/api/storageservices/put-page)
- [Размещение страницы по URL-адресу](/rest/api/storageservices/put-page-from-url)
- [Append Block](/rest/api/storageservices/append-block)
- [задание свойств службы BLOB-объекта](/rest/api/storageservices/set-blob-properties).
- [Set Blob Metadata](/rest/api/storageservices/set-blob-metadata)
- [Получение большого двоичного объекта](/rest/api/storageservices/get-blob)
- [Получение свойств большого двоичного объекта](/rest/api/storageservices/get-blob-properties)
- [Получение метаданных BLOB-объекта](/rest/api/storageservices/get-blob-metadata)
- [Моментальный снимок BLOB-объекта](/rest/api/storageservices/snapshot-blob)

### <a name="rotate-customer-provided-keys"></a>Поворачивайте ключи, предоставленные клиентом

Чтобы повернуть ключ шифрования, переданный в запросе, скачайте большой двоичный объект и повторно загрузите его с новым ключом шифрования.

> [!IMPORTANT]
> Портал Azure нельзя использовать для чтения или записи в контейнер или большой двоичный объект, зашифрованный с помощью ключа, указанного в запросе.
>
> Обязательно Защитите ключ шифрования, предоставленный в запросе к хранилищу BLOB-объектов, в безопасном хранилище ключей, например Azure Key Vault. Если выполнить операцию записи для контейнера или большого двоичного объекта без ключа шифрования, операция завершится ошибкой, а доступ к объекту будет потерян.

## <a name="azure-storage-encryption-versus-disk-encryption"></a>Шифрование службы хранилища Azure и шифрование диска

Шифрование службы хранилища Azure шифрует страничные BLOB-объекты, которые выполняют резервное копирование дисков виртуальных машин Azure. Кроме того, все диски виртуальных машин Azure, включая локальные временные диски, при необходимости могут быть зашифрованы с помощью [шифрования дисков Azure](../../security/azure-security-disk-encryption-overview.md). Шифрование дисков Azure использует стандартные отраслевые [BitLocker](https://docs.microsoft.com/windows/security/information-protection/bitlocker/bitlocker-overview) в Windows и [DM-](https://en.wikipedia.org/wiki/Dm-crypt) Encryption в Linux для предоставления решений шифрования на основе операционной системы, интегрированных с Azure Key Vault.

## <a name="next-steps"></a>Дальнейшие действия

- [Что такое хранилище ключей Azure?](../../key-vault/key-vault-overview.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure на портале Azure](storage-encryption-keys-portal.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure с помощью PowerShell](storage-encryption-keys-powershell.md)
- [Настройка управляемых клиентом ключей для шифрования службы хранилища Azure с помощью Azure CLI](storage-encryption-keys-cli.md)
