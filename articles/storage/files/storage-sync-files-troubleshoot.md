---
title: Устранение неполадок службы "Синхронизация файлов Azure" | Документация Майкрософт
description: Устранение распространенных неполадок службы синхронизации файлов Azure.
author: jeffpatt24
ms.service: storage
ms.topic: conceptual
ms.date: 07/29/2019
ms.author: jeffpatt
ms.subservice: files
ms.openlocfilehash: 6771164c26c51e40d80d0c82b42f04c4f95c4c37
ms.sourcegitcommit: 1c2659ab26619658799442a6e7604f3c66307a89
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/10/2019
ms.locfileid: "72255103"
---
# <a name="troubleshoot-azure-file-sync"></a>Устранение неполадок службы "Синхронизация файлов Azure"
Используйте службу "Синхронизация файлов Azure", чтобы централизованно хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования Windows Server в быстрый кэш общего файлового ресурса Azure. Для локального доступа к данным вы можете использовать любой протокол, доступный в Windows Server, в том числе SMB, NFS и FTPS. Кроме того, вы можете создать любое количество кэшей в любом регионе.

Эта статья поможет диагностировать и устранить проблемы, возникающие при развертывании службы синхронизации файлов Azure. Кроме того, здесь описано, как собирать важные журналы из системы, если требуется более глубокое исследование проблемы. Если вы не нашли ответ на свой вопрос, свяжитесь с нами, используя следующие каналы (в порядке эскалации):

1. [Форум службы хранилища Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=windowsazuredata).
2. [UserVoice службы файлов Azure](https://feedback.azure.com/forums/217298-storage/category/180670-files).
3. Служба поддержки Майкрософт. Чтобы создать запрос на поддержку на портале Azure, на вкладке **Справка** нажмите кнопку **Справка и поддержка**, а затем выберите **Новый запрос на поддержку**.

## <a name="im-having-an-issue-with-azure-file-sync-on-my-server-sync-cloud-tiering-etc-should-i-remove-and-recreate-my-server-endpoint"></a>У меня возникла проблема со службой "Синхронизация файлов Azure" на сервере (синхронизация, распределение по уровням облака и т. д). Следует ли удалить конечную точку сервера и создать ее заново?
[!INCLUDE [storage-sync-files-remove-server-endpoint](../../../includes/storage-sync-files-remove-server-endpoint.md)]

## <a name="agent-installation-and-server-registration"></a>Установка агента и регистрация сервера
<a id="agent-installation-failures"></a>**Устранение сбоев при установке агента**  
Если при установке агента службы синхронизации файлов Azure происходит сбой, то в командной строке с повышенными привилегиями выполните следующую команду, чтобы включить ведение журнала во время установки агента:

```
StorageSyncAgent.msi /l*v AFSInstaller.log
```

Просмотрите файл installer.log, чтобы определить причину сбоя установки.

<a id="agent-installation-on-DC"></a>**Сбой установки агента на контроллере домена Active Directory**  
Если попытаться установить агент синхронизации на контроллере домена AD DS, где владелец роли PDC использует ОС Windows Server 2008 R2 или предыдущих версий, можно столкнуться с проблемой, когда будет возникать сбой установки агента синхронизации.

Чтобы устранить проблему, передайте роль PDC другому контроллеру домена, работающему под управлением Windows Server 2012 R2 или более поздней версии, а затем установите агент синхронизации.

<a id="server-registration-prerequisites"></a>При регистрации @no__t 1Server отображается следующее сообщение: "Pre-requisites are missing" (Отсутствуют требуемые компоненты)**

Это сообщение появляется, если модуль PowerShell az или AzureRM не установлен в PowerShell 5,1. 

> [!Note]  
> ServerRegistration. exe не поддерживает PowerShell 6. x. Для регистрации сервера можно использовать командлет Register-Азсторажесинксервер в PowerShell 6. x.

Чтобы установить модуль az или AzureRM в PowerShell 5,1, выполните следующие действия.

1. Введите **PowerShell** из командной строки с повышенными привилегиями и нажмите клавишу ВВОД.
2. Установите последний модуль az или AzureRM, следуя документации:
    - [AZ Module (требуется .NET 4.7.2)](https://go.microsoft.com/fwlink/?linkid=2062890)
    - [Модуль AzureRM]( https://go.microsoft.com/fwlink/?linkid=856959)
3. Запустите ServerRegistration.exe и завершите работу мастера, чтобы зарегистрировать сервер в службе синхронизации хранилища.

<a id="server-already-registered"></a>При регистрации @no__t 1Server отображается следующее сообщение: "This server is already registered" (Сервер уже зарегистрирован)** 

![Снимок экрана диалогового окна регистрации сервера с сообщением об ошибке Server is already registered (Сервер уже зарегистрирован)](media/storage-sync-files-troubleshoot/server-registration-1.png)

Это сообщение появляется, если сервер был зарегистрирован в службе синхронизации хранилища ранее. Для отмены регистрации сервера в текущей службе синхронизации хранилища и регистрации в новой службе синхронизации хранилища выполните действия, описанные в разделе [Отмена регистрации сервера в службе синхронизации хранилища](storage-sync-files-server-registration.md#unregister-the-server-with-storage-sync-service).

Если сервер не указан в списке **Зарегистрированные серверы** в службе синхронизации хранилища, выполните следующие команды PowerShell на сервере, регистрацию которого вы хотите отменить.

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Reset-StorageSyncServer
```

> [!Note]  
> Чтобы также удалить регистрацию кластера, если сервер является частью кластера, можно использовать необязательный параметр *Reset-StorageSyncServer-CleanClusterRegistration*.

<a id="web-site-not-trusted"></a>**Во время регистрации сервера приходят многочисленные ответы, указывающее, что веб-сайт является ненадежным. Почему?**  
Эта ошибка возникает, если во время регистрации сервера включена политика **усиленной безопасности Internet Explorer**. Дополнительные сведения о том, как правильно отключить политику **усиленной безопасности Internet Explorer**, см. в разделе [Подготовка сервера Windows к работе со службой синхронизации файлов Azure](storage-sync-files-deployment-guide.md#prepare-windows-server-to-use-with-azure-file-sync) в статье [Развертывание службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md).

<a id="server-registration-missing"></a>**Сервер не указан в списке зарегистрированных серверов на портале Azure**  
Если сервер не указан в списке **Зарегистрированные серверы** в службе синхронизации хранилища, сделайте следующее.
1. Войдите на сервер, который необходимо зарегистрировать.
2. Откройте проводник и перейдите в каталог установки агента синхронизации хранилища (расположение по умолчанию — C:\Program Files\Azure\StorageSyncAgent). 
3. Запустите ServerRegistration.exe и завершите работу мастера, чтобы зарегистрировать сервер в службе синхронизации хранилища.

## <a name="sync-group-management"></a>Управление группами синхронизации
<a id="cloud-endpoint-using-share"></a>**Создание облачной конечной точки завершается сбоем с такой ошибкой: "The specified Azure FileShare is already in use by a different CloudEndpoint" (Указанный общий файловый ресурс Azure уже используется другой облачной конечной точкой)**  
Эта ошибка возникает, если файловый ресурс Azure уже используется другой облачной конечной точкой. 

Если вы видите это сообщение, а общий файловый ресурс Azure сейчас не используется облачной конечной точкой, выполните следующие действия, чтобы очистить метаданные службы синхронизации файлов Azure для общего файлового ресурса Azure:

> [!Warning]  
> Если вы удалите метаданные для общего файлового ресурса Azure, который в это время используется облачной конечной точкой, это приведет к сбою операций синхронизации в службе синхронизации файлов Azure. 

1. На портале Azure перейдите к общему файловому ресурсу Azure.  
2. Щелкните общий файловый ресурс Azure правой кнопкой мыши и выберите **Изменить метаданные**.
3. Щелкните **SyncService** правой кнопкой мыши и выберите **Удалить**.

<a id="cloud-endpoint-authfailed"></a>**Создание облачной конечной точки завершается сбоем с такой ошибкой: "AuthorizationFailed"**  
Эта ошибка возникает, если учетная запись пользователя не имеет достаточных прав для создания облачной конечной точки. 

Чтобы создать облачную конечную точку, учетная запись пользователя должна иметь следующие разрешения авторизации Майкрософт:  
* Чтение: получение определения роли.
* Запись: Создать или изменить определение пользовательской роли
* Чтение: Получение назначения роли
* Запись: Создание назначения роли

Следующие встроенные роли имеют необходимые разрешения авторизации Майкрософт:  
* Владелец
* Администратор доступа пользователей

Чтобы определить, имеет ли ваша роль пользователя учетной записи необходимые разрешения:  
1. На портале Azure выберите **Группы ресурсов**.
2. Выберите группу ресурсов, в которой расположена учетная запись хранения, а затем выберите **Управление доступом (IAM)** .
3. Выберите вкладку **Назначения ролей**.
4. Выберите **роль** (например, владелец или участник) для учетной записи пользователя.
5. В списке **Поставщик ресурсов** выберите **Авторизация Майкрософт**. 
    * **Назначение ролей** должно иметь разрешения на **чтение** и **запись**.
    * **Определение роли** должно иметь разрешения на **чтение** и **запись**.

<a id="-2134375898"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "Мгмтсервержобфаилед" (код ошибки:-2134375898 или 0x80c80226)**  
Эта ошибка возникает, если путь к конечной точке сервера находится на системном томе и включено распределение по уровням облака. Но для системного тома не поддерживается распределение по уровням облака. Чтобы создать конечную точку сервера на системном томе, отключите распределение по уровням облака при ее создании.

<a id="-2147024894"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "Мгмтсервержобфаилед" (код ошибки:-2147024894 или 0x80070002)**  
Эта ошибка возникает, если указан недопустимый путь к конечной точке сервера. Убедитесь, что указанный путь к конечной точке сервера является локально подключенным томом NTFS. Обратите внимание, Синхронизация файлов Azure не поддерживает подключенные диски в качестве пути к конечной точке сервера.

<a id="-2134347507"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "Мгмтсервержобфаилед" (код ошибки:-2134347507 или 0x80c8710d)**  
Эта ошибка возникает из-за того, что Синхронизация файлов Azure не поддерживает конечные точки сервера для томов с сжатой папкой сведений о томах системы. Чтобы устранить эту проблему, распакуйте папку "сведения о системном томе". Если на томе хранится только папка System Volume Information, выполните следующие действия.

1. Загрузите средство [PsExec](https://docs.microsoft.com/sysinternals/downloads/psexec) .
2. Выполните следующую команду из командной строки с повышенными привилегиями, чтобы запустить командную строку с системной учетной записью: **PsExec. exe-i-s-d cmd**
3. В командной строке, работающей под системной учетной записью, введите следующие команды и нажмите клавишу ВВОД:   
    **CD/d "буква диска: \ сведения о системном томе"**  
    **Compact/u/s**

<a id="-2134376345"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "Мгмтсервержобфаилед" (код ошибки:-2134376345 или 0x80C80067)**  
Эта ошибка возникает, если достигнуто максимальное число конечных точек сервера на сервер. В настоящее время Синхронизация файлов Azure поддерживает до 30 конечных точек сервера на сервер. Дополнительные сведения см. в разделе [Синхронизация файлов Azure Scale targets](https://docs.microsoft.com/azure/storage/files/storage-files-scale-targets#azure-file-sync-scale-targets).

<a id="-2134376427"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "Мгмтсервержобфаилед" (код ошибки:-2134376427 или 0x80c80015)**  
Эта ошибка возникает, если другая конечная точка сервера уже выполняет синхронизацию указанного пути к конечной точке сервера. Синхронизация файлов Azure не поддерживает несколько конечных точек сервера, синхронизирующих один и тот же каталог или том.

<a id="-2134347757"></a>**Удаление конечной точки сервера завершается сбоем с такой ошибкой: "Мгмтсервержобекспиред" (код ошибки:-2134347757 или 0x80c87013)**  
Эта ошибка возникает, если сервер отключен или не подключен к сети. Если сервер больше не доступен, отмените его регистрацию на портале, что приведет к удалению конечных точек сервера. Чтобы удалить конечные точки сервера, выполните шаги, описанные в разделе [Отмена регистрации сервера в службе синхронизации хранилища](storage-sync-files-server-registration.md#unregister-the-server-with-storage-sync-service).

<a id="server-endpoint-provisioningfailed"></a>**Не удается открыть страницу свойств конечной точки сервера или обновить политику распределения по уровням облака**  
Эта проблема может возникнуть в случае сбоя операции управления на конечной точке сервера. Если страница свойств конечной точки сервера не открывается на портале Azure, попробуйте обновить конечную точку сервера, выполнив команды PowerShell с сервера, чтобы устранить эту проблему. 

```powershell
# Get the server endpoint id based on the server endpoint DisplayName property
Get-AzStorageSyncServerEndpoint `
    -ResourceGroupName myrgname `
    -StorageSyncServiceName storagesvcname `
    -SyncGroupName mysyncgroup | `
Tee-Object -Variable serverEndpoint

# Update the free space percent policy for the server endpoint
Set-AzStorageSyncServerEndpoint `
    -InputObject $serverEndpoint
    -CloudTiering `
    -VolumeFreeSpacePercent 60
```
<a id="server-endpoint-noactivity"></a>**Конечная точка сервера находится в состоянии работоспособности "Нет действия" или "Ожидание", а в колонке "Зарегистрированные серверы" для сервера показано состояние "Отображается как "Не в сети"**  

Эта проблема может возникнуть, если процесс отслеживания синхронизации хранилища не запущен или сервер не может связаться со службой "Синхронизация файлов Azure" из-за прокси-сервера или брандмауэра.

Чтобы устранить эту проблему, выполните описанные ниже шаги:

1. Откройте диспетчер задач на сервере и убедитесь, что процесс отслеживания синхронизации хранилища (AzureStorageSyncMonitor.exe) запущен. Если процесс не запущен, попробуйте сначала перезапустить сервер. Если перезапуск сервера не решил эту проблему, обновите до последней [версии агента](https://docs.microsoft.com/azure/storage/files/storage-files-release-notes) службы "Синхронизация файлов Azure".
2. Убедитесь, что параметры брандмауэра и прокси-сервера настроены правильно:
    - Если сервер находится за брандмауэром, убедитесь, что порт 443 для исходящих подключений разрешен. Если брандмауэр ограничивает трафик определенными доменами, подтвердите, что домены, перечисленные в [документации](https://docs.microsoft.com/azure/storage/files/storage-sync-files-firewall-and-proxy#firewall) брандмауэра, доступны.
    - Если сервер находится за прокси-сервером, настройте параметры прокси-сервера для компьютера или конкретного приложения, выполнив действия, описанные в [документации](https://docs.microsoft.com/azure/storage/files/storage-sync-files-firewall-and-proxy#proxy) прокси-сервера.

<a id="endpoint-noactivity-sync"></a>**Конечная точка сервера находится в состоянии работоспособности "Нет действия", а в колонке "Зарегистрированные серверы" для сервера показано состояние "В сети"**  

Состояние работоспособности конечной точки сервера "Нет действия" означает, что конечная точка сервера не выполнила действие синхронизации за последние два часа.

Конечная точка сервера может не выполнить действие синхронизации по следующим причинам.

- Установлена версия агента 4.3.0.0 или более старая, и на сервере существует активный сеанс синхронизации VSS (SnapshotSync). Когда сеанс синхронизации VSS активен для конечной точки сервера, другим конечным точкам на одном томе не удается запустить его, пока не завершится сеанс синхронизации VSS. Чтобы устранить эту проблему, установите версию агента 5.0.2.0 или более позднюю, которая поддерживает синхронизацию нескольких конечных точек сервера на томе, при активном сеансе синхронизации VSS.

    Чтобы проверить текущее действие синхронизации на сервере, ознакомьтесь с разделом [Как отслеживать ход выполнения текущего сеанса синхронизации?](#how-do-i-monitor-the-progress-of-a-current-sync-session).

- На сервере достигнуто максимальное количество параллельных сеансов синхронизации. 
    - Агент версии 4.х и более поздних: ограничение зависит от доступных системных ресурсов.
    - Агент версии 3.х: 2 активных сеанса синхронизации для каждого процессора или максимум 8 активных сеансов синхронизации для каждого сервера.

> [!Note]  
> Если в колонке "Зарегистрированные серверы" для сервера показано состояние "Отображается как "Не в сети", выполните шаги, описанные в разделе [Конечная точка сервера находится в состоянии работоспособности "Нет действия" или "Ожидание", а в колонке "Зарегистрированные серверы" для сервера показано состояние "Отображается как "Не в сети"](#server-endpoint-noactivity).

## <a name="sync"></a>Sync
<a id="afs-change-detection"></a>**Если файл создан непосредственно в файловом ресурсе Azure через SMB или портал, сколько времени требуется для синхронизации файла с серверами в группе синхронизации?**  
[!INCLUDE [storage-sync-files-change-detection](../../../includes/storage-sync-files-change-detection.md)]

<a id="serverendpoint-pending"></a>**Работоспособность конечной точки сервера находится в состоянии ожидания в течение нескольких часов**  
Эта ошибка возникает, если при создании облачной конечной точки вы указали общий файловый ресурс Azure, содержащий некоторые данные. Задание перечисления изменений, которое проверяет на наличие изменений в общем файловом ресурсе Azure, должно завершиться до синхронизации файлов между конечными точками облака и сервера. Время завершения задания зависит от размера пространства имен в общем файловом ресурсе Azure. После завершения задания перечисления изменений работоспособность конечной точки сервера должна обновиться.

### <a id="broken-sync"></a>Как выполнить мониторинг работоспособности синхронизации?
# <a name="portaltabportal1"></a>[Портал](#tab/portal1)
Внутри каждой группы синхронизации можно детализировать ее отдельные конечные точки сервера, чтобы просмотреть состояние последних завершенных сеансов синхронизации. Зеленый столбец работоспособности и значение 0 для параметра "Несинхронизирующиеся файлы" означает, что синхронизация работает должным образом. Если же это не так, ознакомьтесь с приведенным ниже списком распространенных ошибок синхронизации, а также со сведениями о том, как обработать файлы, которые не синхронизируются. 

![Снимок экрана портала Azure](media/storage-sync-files-troubleshoot/portal-sync-health.png)

# <a name="servertabserver"></a>[Server](#tab/server)
Перейдите в журналы телеметрии сервера, которые можно найти в средстве "Просмотр событий": `Applications and Services Logs\Microsoft\FileSync\Agent\Telemetry`. Событие 9102 соответствует завершенному сеансу синхронизации. Для получения последнего состояния синхронизации найдите последнее событие с идентификатором 9102. SyncDirection сообщит вам предназначение этого сеанса: передача или загрузка. Если результат HResult равен 0, сеанс синхронизации завершился успешно. Другой результат HResult означает, что во время синхронизации произошла ошибка. Ознакомьтесь со списком распространенных ошибок ниже. Если значение PerItemErrorCount больше 0, это означает, что некоторые файлы или папки не синхронизировались должным образом. Результат HResult может быть равен 0, а результат PerItemErrorCount при этом — больше 0.

Ниже приведен пример успешной отправки. Для краткости ниже перечислены только некоторые из значений, содержащиеся в каждом событии 9102. 

```
Replica Sync session completed.
SyncDirection: Upload,
HResult: 0, 
SyncFileCount: 2, SyncDirectoryCount: 0,
AppliedFileCount: 2, AppliedDirCount: 0, AppliedTombstoneCount 0, AppliedSizeBytes: 0.
PerItemErrorCount: 0,
TransferredFiles: 2, TransferredBytes: 0, FailedToTransferFiles: 0, FailedToTransferBytes: 0.
```

И наоборот, отправка, завершившаяся сбоем, может выглядеть примерно так:

```
Replica Sync session completed.
SyncDirection: Upload,
HResult: -2134364065,
SyncFileCount: 0, SyncDirectoryCount: 0, 
AppliedFileCount: 0, AppliedDirCount: 0, AppliedTombstoneCount 0, AppliedSizeBytes: 0.
PerItemErrorCount: 0, 
TransferredFiles: 0, TransferredBytes: 0, FailedToTransferFiles: 0, FailedToTransferBytes: 0.
```

Иногда сеансы синхронизации не выполняются в целом или содержат другое значение PerItemErrorCount, отличное от нуля, но тем не менее наблюдается прогресс и некоторые файлы успешно синхронизируются. Это можно увидеть в полях Applied* (AppliedFileCount, AppliedDirCount, AppliedTombstoneCount и AppliedSizeBytes) — в них содержатся сведения о том, насколько успешно продвигается сеанс синхронизации. Если несколько сеансов синхронизации подряд завершаются сбоем, а числа в полях Applied* увеличиваются, тогда нужно подождать повторной синхронизации, а не отправлять сразу же запрос в службу поддержки.

---

### <a name="how-do-i-monitor-the-progress-of-a-current-sync-session"></a>Как отслеживать ход выполнения текущего сеанса синхронизации?
# <a name="portaltabportal1"></a>[Портал](#tab/portal1)
В своей группе синхронизации перейдите в соответствующую конечную точку сервера и просмотрите раздел "Действие синхронизации" — вы увидите количество отправленных или загруженных файлов в текущем сеансе синхронизации. Обратите внимание, что это состояние будет отложено примерно на 5 минут, и если ваш сеанс синхронизации можно завершить в течение этого периода, об этом может не быть уведомлений на портале. 

# <a name="servertabserver"></a>[Server](#tab/server)
Просмотрите последнее событие 9302 в журнале телеметрии на сервере (в средстве "Просмотр событий" перейдите в папку Applications and Services Logs\Microsoft\FileSync\Agent\Telemetry). Это событие указывает состояние текущего сеанса синхронизации. TotalItemCount обозначает количество файлов, которые нужно синхронизировать, AppliedItemCount — количество файлов, которые были синхронизированы к настоящему времени, а PerItemErrorCount — количество файлов, синхронизация которых завершилась сбоем (сведения о том, как исправить эту проблему, см. ниже).

```
Replica Sync Progress. 
ServerEndpointName: <CI>sename</CI>, SyncGroupName: <CI>sgname</CI>, ReplicaName: <CI>rname</CI>, 
SyncDirection: Upload, CorrelationId: {AB4BA07D-5B5C-461D-AAE6-4ED724762B65}. 
AppliedItemCount: 172473, TotalItemCount: 624196. AppliedBytes: 51473711577, 
TotalBytes: 293363829906. 
AreTotalCountsFinal: true. 
PerItemErrorCount: 1006.
```
---

### <a name="how-do-i-know-if-my-servers-are-in-sync-with-each-other"></a>Как узнать, синхронизируются ли серверы между собой?
# <a name="portaltabportal1"></a>[Портал](#tab/portal1)
Для каждого сервера в данной группе синхронизации проверьте следующее:
- Метки времени последней попытки синхронизации для отправки и загрузки не устарели.
- Состояние отправки и загрузки имеет зеленый цвет.
- В поле "Действие синхронизации" нет файлов для синхронизации или их очень мало.
- В поле "Несинхронизирующиеся файлы" для отправки и загрузки стоит значение 0.

# <a name="servertabserver"></a>[Server](#tab/server)
Просмотрите завершенные сеансы синхронизации, которые отмечены событиями 9102 в журнале событий телеметрии для каждого сервера (в средстве "Просмотр событий" перейдите в `Applications and Services Logs\Microsoft\FileSync\Agent\Telemetry`). 

1. Вы можете проверить успешное завершение последних сеансов отправки и загрузки на заданном сервере. Для этого проверьте, чтобы для параметров HResult и PerItemErrorCount для отправки и загрузки стояло значение 0 (поле SyncDirection указывает тип заданного сеанса: отправка или загрузка). Обратите внимание, что если вы не видите недавно завершенного сеанса синхронизации, скорее всего, он выполняется в настоящий момент, чего с большой вероятностью можно ожидать, если вы только что добавили или изменили большой объем данных.
2. Когда сервер полностью синхронизирован с облаком и отсутствуют какие-либо изменения в синхронизации в любом направлении, вы увидите пустые сеансы синхронизации. Эти сеансы обозначаются событиями отправки и загрузки, в которых все поля Sync* (SyncFileCount, SyncDirCount, SyncTombstoneCount и SyncSizeBytes) равны нулю, а это означает, что объекты синхронизации отсутствовали. Обратите внимание, что эти пустые сеансы синхронизации могут отсутствовать на серверах с высокой активностью обработки данных, так как операция синхронизации всегда актуальна. Если действия синхронизации нет, пустые сеансы должны появляться каждые 30 минут. 
3. Если все серверы синхронизированы с облаком, то есть их недавние сеансы отправки и загрузки являются пустыми сеансами синхронизации, вы можете быть уверены в том, что система в целом синхронизирована. 
    
Обратите внимание, что если вы внесли изменения непосредственно в общем файловом ресурсе Azure, служба "Синхронизация файлов Azure" не обнаружит эти изменения до запуска задания перечисления изменений, которое инициируется каждые 24 часа. Можно получить уведомление сервера о состоянии синхронизации с облаком, когда фактически на нем нет последних изменений, внесенных непосредственно в общем файловом ресурсе Azure. 

---

### <a name="how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing"></a>Каким образом мне будет понятно, что есть определенные файлы и папки, которые не синхронизируются?
Если значение PerItemErrorCount на сервере или значение параметра "Несинхронизирующиеся файлы" на портале больше 0 для любого заданного сеанса синхронизации, это означает, что некоторые элементы синхронизировать не удалось. Файлы и папки могут иметь характеристики, препятствующие синхронизации. Эти характеристики могут быть постоянными и требуют явного действия для возобновления синхронизации, например удаления неподдерживаемых знаков из имени файла или папки. Также эти характеристики могут быть временными, то есть синхронизация файла или папки возобновляется автоматически. Например, файлы с открытыми дескрипторами автоматически возобновят синхронизацию при закрытии файла. Когда механизм службы "Синхронизация файлов Azure" обнаруживает такую проблему, создается журнал ошибок, который можно проанализировать, чтобы перечислить элементы, которые в настоящее время не синхронизируются должным образом.

Чтобы увидеть эти ошибки, запустите сценарий PowerShell **FileSyncErrorsReport.ps1** (расположенный в каталоге установки агента службы "Синхронизация файлов Azure"), чтобы определить файлы, которые не удалось синхронизировать из-за открытых дескрипторов, неподдерживаемых знаков или других проблем. Поле ItemPath указывает расположение файла относительно корневого каталога синхронизации. Ознакомьтесь со списком распространенных ошибок синхронизации ниже, чтобы применить действия по устранению.

#### <a name="troubleshooting-per-filedirectory-sync-errors"></a>Устранение ошибок синхронизации в каталоге или файле
**Журнал ItemResults — ошибки синхронизации по каждому элементу**  

| HRESULT | HRESULT (десятичное число) | Строка ошибки | Проблемы | Исправление |
|---------|-------------------|--------------|-------|-------------|
| 0x80070043 | — 2147942467 | ERROR_BAD_NET_NAME | Многоуровневый файл на сервере недоступен. Эта проблема возникает, если многоуровневый файл не был отозван перед удалением конечной точки сервера. | Сведения об устранении этой проблемы см. в разделе [многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint). |
| 0x80c80207 | -2134375929 | ECS_E_SYNC_CONSTRAINT_CONFLICT | Изменение файла или каталога пока невозможно синхронизировать, так как зависимая папка еще не синхронизирована. Этот элемент будет синхронизирован после синхронизации зависимых изменений. | Действия не требуются. |
| 0x8007007b | -2147024773 | ERROR_INVALID_NAME | Недопустимое имя файла или каталога. | Переименуйте соответствующий файл или каталог. Дополнительные сведения см. в разделе [Обработка неподдерживаемых знаков](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#handling-unsupported-characters). |
| 0x80c80255 | — 2134375851 | ECS_E_XSMB_REST_INCOMPATIBILITY | Недопустимое имя файла или каталога. | Переименуйте соответствующий файл или каталог. Дополнительные сведения см. в разделе [Обработка неподдерживаемых знаков](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#handling-unsupported-characters). |
| 0x80c80018 | -2134376424 | ECS_E_SYNC_FILE_IN_USE | Файл не может быть синхронизирован, так как он используется. По завершении использования файла он будет синхронизирован. | Действия не требуются. Служба "Синхронизация файлов Azure" раз в день создает на сервере временный моментальный снимок VSS для синхронизации файлов с открытыми дескрипторами. |
| 0x80c8031d | -2134375651 | ECS_E_CONCURRENCY_CHECK_FAILED | Файл был изменен, но это изменение еще не обнаружено синхронизацией. Синхронизация восстановится после обнаружения изменения. | Действия не требуются. |
| кодом | — 2147024894 | ERROR_FILE_NOT_FOUND | Файл был удален, и синхронизация не осведомлена об этом изменении. | Действия не требуются. Синхронизация прекращает запись в журнал этой ошибки, когда обнаружение изменений обнаруживает, что файл был удален. |
| 0x80c80205 | — 2134375931 | ECS_E_SYNC_ITEM_SKIP | Файл был пропущен, но будет синхронизирован во время следующего сеанса синхронизации. | Действия не требуются. |
| 0x80c8603e | -2134351810 | ECS_E_AZURE_STORAGE_SHARE_SIZE_LIMIT_REACHED | Невозможно синхронизировать файл, так как достигнут предел общей папки Azure. | Чтобы устранить эту проблему, обратитесь к разделу [Достигнут предельный размер хранилища общего файлового ресурса Azure](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#-2134351810). |
| 0x80c8027C | — 2134375812 | ECS_E_ACCESS_DENIED_EFS | Файл зашифрован неподдерживаемым решением (например, NTFS EFS). | Расшифровать файл и использовать поддерживаемое решение для шифрования. Список поддерживаемых решений см. в разделе [Решения для шифрования](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning#encryption-solutions) руководства по планированию. |
| 0x80c80283 | — 2160591491 | ECS_E_ACCESS_DENIED_DFSRRO | Файл находится в папке репликации DFS-R только для чтения. | Файл находится в папке репликации DFS-R только для чтения. Служба синхронизации файлов Azure не поддерживает конечные точки сервера в папках репликации DFS-R только для чтения. Дополнительные сведения см. в разделе [руководств по планированию](https://docs.microsoft.com/azure/storage/files/storage-sync-files-planning#distributed-file-system-dfs) . |
| 0x80070005 | -2147024891 | ERROR_ACCESS_DENIED | Файл имеет состояние "Ожидание удаления". | Действия не требуются. Файл будет удален после закрытия всех открытых дескрипторов файлов. |
| 0x80c86044 | — 2134351804 | ECS_E_AZURE_AUTHORIZATION_FAILED | Не удается синхронизировать файл, так как параметры брандмауэра и виртуальной сети в учетной записи хранения включены, а сервер не имеет доступа к учетной записи хранения. | Добавьте IP-адрес или виртуальную сеть сервера, выполнив действия, описанные в разделе [Настройка параметров брандмауэра и виртуальной сети](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings) в руководстве по развертыванию. |
| 0x80c80243 | — 2134375869 | ECS_E_SECURITY_DESCRIPTOR_SIZE_TOO_LARGE | Не удается синхронизировать файл, так как размер дескриптора безопасности превышает ограничение в 64 КИБ. | Чтобы устранить эту проблему, удалите записи управления доступом (ACE) для файла, чтобы уменьшить размер дескриптора безопасности. |
| 0x8000ffff | — 2147418113 | E_UNEXPECTED | Не удается синхронизировать файл из-за непредвиденной ошибки. | Если ошибка повторяется в течение нескольких дней, создайте обращение в службу поддержки. |
| 0x80070020 | — 2147024864 | ERROR_SHARING_VIOLATION | Файл не может быть синхронизирован, так как он используется. По завершении использования файла он будет синхронизирован. | Действия не требуются. |
| 0x80c80017 | -2134376425 | ECS_E_SYNC_OPLOCK_BROKEN | Файл был изменен во время синхронизации, поэтому его необходимо синхронизировать повторно. | Действия не требуются. |
| 0x80c80200 | — 2134375936 | ECS_E_SYNC_CONFLICT_NAME_EXISTS | Не удается синхронизировать файл, так как достигнуто максимальное число конфликтующих файлов. Синхронизация файлов Azure поддерживает файлы конфликтов 100 для каждого файла. Дополнительные сведения о конфликтах файлов см. в разделе Синхронизация файлов Azure [часто задаваемые вопросы](https://docs.microsoft.com/azure/storage/files/storage-files-faq#afs-conflict-resolution). | Чтобы устранить эту проблему, сократите число конфликтующих файлов. Файл будет синхронизирован, если число конфликтующих файлов меньше 100. |

#### <a name="handling-unsupported-characters"></a>Обработка неподдерживаемых знаков
Если в скрипте PowerShell **филесинцеррорсрепорт. ps1** выводятся сбои из-за неподдерживаемых символов (код ошибки 0x8007007B или 0x80c80255), следует удалить или переименовать символы в случае сбоя из соответствующих имен файлов. PowerShell, скорее всего, выведет эти знаки как вопросительные знаки или пустые прямоугольники, так как большинство из этих знаков не имеют стандартного визуального кодирования. [Средство оценки](storage-sync-files-planning.md#evaluation-cmdlet) можно использовать, чтобы идентифицировать знаки, которые не поддерживаются.

В приведенной ниже таблице содержатся все знаки Юникода, которые служба "Синхронизация файлов Azure" еще не поддерживает.

| Набор знаков | Количество знаков |
|---------------|-----------------|
| <ul><li>0x0000009D (osc: команда операционной системы)</li><li>0x00000090 (dcs: строка управления устройством)</li><li>0x0000008F (ss3: Single Shift Three)</li><li>0x00000081 (предустановленный большой набор октетов)</li><li>0x0000007F (del: удалить)</li><li>0x0000008D (ri: обратный перевод строки)</li></ul> | 6 |
| 0x0000FDD0 - 0x0000FDEF (арабские формы представления-a) | 32 |
| 0x0000FFF0 - 0x0000FFFF (специальные знаки) | 16 |
| <ul><li>0x0001FFFE - 0x0001FFFF = 2 (несимвольный)</li><li>0x0002FFFE - 0x0002FFFF = 2 (несимвольный)</li><li>0x0003FFFE - 0x0003FFFF = 2 (несимвольный)</li><li>0x0004FFFE - 0x0004FFFF = 2 (несимвольный)</li><li>0x0005FFFE - 0x0005FFFF = 2 (несимвольный)</li><li>0x0006FFFE - 0x0006FFFF = 2 (несимвольный)</li><li>0x0007FFFE - 0x0007FFFF = 2 (несимвольный)</li><li>0x0008FFFE - 0x0008FFFF = 2 (несимвольный)</li><li>0x0009FFFE - 0x0009FFFF = 2 (несимвольный)</li><li>0x000AFFFE - 0x000AFFFF = 2 (несимвольный)</li><li>0x000BFFFE - 0x000BFFFF = 2 (несимвольный)</li><li>0x000CFFFE - 0x000CFFFF = 2 (несимвольный)</li><li>0x000DFFFE - 0x000DFFFF = 2 (несимвольный)</li><li>0x000EFFFE - 0x000EFFFF = 2 (неопределенный)</li><li>0x000FFFFE - 0x000FFFFF = 2 (дополнительная область частного использования)</li></ul> | 30 |
| 0x0010FFFE, 0x0010FFFF | 2 |

### <a name="common-sync-errors"></a>Распространенные ошибки синхронизации
<a id="-2147023673"></a>**Сеанс синхронизации отменен.**  

| | |
|-|-|
| **HRESULT** | 0x800704c7 |
| **HRESULT (десятичное число)** | -2147023673 | 
| **Строка ошибки** | ERROR_CANCELLED |
| **Требуются действия по исправлению** | Нет |

Сеансы синхронизации могут завершиться ошибкой по разным причинам, включая перезапуск или обновление сервера, моментальные снимки VSS и т. д. Хотя эта ошибка выглядит так, будто требуются последующие действия, лучше проигнорировать ее, если только она не исчезнет в течение нескольких часов.

<a id="-2147012889"></a>**Не удается установить подключение к службе.**    

| | |
|-|-|
| **HRESULT** | 0x80072ee7 |
| **HRESULT (десятичное число)** | -2147012889 | 
| **Строка ошибки** | WININET_E_NAME_NOT_RESOLVED |
| **Требуются действия по исправлению** | Да |

[!INCLUDE [storage-sync-files-bad-connection](../../../includes/storage-sync-files-bad-connection.md)]

<a id="-2134376372"></a>**Служба применила регулирование к запросу пользователя.**  

| | |
|-|-|
| **HRESULT** | 0x80c8004c |
| **HRESULT (десятичное число)** | -2134376372 |
| **Строка ошибки** | ECS_E_USER_REQUEST_THROTTLED |
| **Требуются действия по исправлению** | Нет |

Никаких действий не требуется, сервер предпримет новую попытку. Если эта ошибка повторяется в течение нескольких часов, создайте запрос в службу поддержки.

<a id="-2134364043"></a>**Синхронизация блокируется до завершения обнаружения изменений после восстановления**  

| | |
|-|-|
| **HRESULT** | 0x80c83075 |
| **HRESULT (десятичное число)** | — 2134364043 |
| **Строка ошибки** | ECS_E_SYNC_BLOCKED_ON_CHANGE_DETECTION_POST_RESTORE |
| **Требуются действия по исправлению** | Нет |

Никаких действий не требуется. При восстановлении файла или общей папки (облачной конечной точки) с помощью Azure Backup синхронизация блокируется до завершения обнаружения изменений в файловом ресурсе Azure. Обнаружение изменений выполняется сразу после завершения восстановления, а длительность зависит от числа файлов в общей папке.

<a id="-2147216747"></a>**Не удалось выполнить синхронизацию, так как база данных синхронизации выгружена.**  

| | |
|-|-|
| **HRESULT** | 0x80041295 |
| **HRESULT (десятичное число)** | — 2147216747 |
| **Строка ошибки** | SYNC_E_METADATA_INVALID_OPERATION |
| **Требуются действия по исправлению** | Нет |

Эта ошибка обычно возникает, когда приложение резервного копирования создает моментальный снимок VSS и база данных синхронизации выгружается. Если эта ошибка повторяется в течение нескольких часов, создайте запрос в службу поддержки.

<a id="-2134364065"></a>**Служба синхронизации не может получить доступ к общему файловому ресурсу Azure, указанному в облачной конечной точке.**  

| | |
|-|-|
| **HRESULT** | 0x80c8305f |
| **HRESULT (десятичное число)** | -2134364065 |
| **Строка ошибки** | ECS_E_EXTERNAL_STORAGE_ACCOUNT_AUTHORIZATION_FAILED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что агент службы "Синхронизация файлов Azure" не может получить доступ к общему файловому ресурсу Azure, что может быть связано с тем, что этого ресурса или учетной записи хранения, где он размещен, больше нет. Вы можете устранить эту ошибку, выполнив следующие шаги:

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Проверьте наличие общего файлового ресурса Azure.](#troubleshoot-azure-file-share)
3. [Убедитесь, что служба "Синхронизация файлов Azure" имеет доступ к учетной записи хранения.](#troubleshoot-rbac)
4. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены должным образом (если они включены).](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings)

<a id="-2134364064"></a><a id="cannot-resolve-storage"></a>**Не удалось разрешить имя используемой учетной записи хранения.**  

| | |
|-|-|
| **HRESULT** | 0x80C83060 |
| **HRESULT (десятичное число)** | -2134364064 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_NAME_UNRESOLVED |
| **Требуются действия по исправлению** | Да |

1. Убедитесь, что вы можете разрешить DNS-имя хранилища с сервера.

    ```powershell
    Test-NetConnection -ComputerName <storage-account-name>.file.core.windows.net -Port 443
    ```
2. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
3. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены должным образом (если они включены).](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings)

<a id="-2134364022"></a><a id="storage-unknown-error"></a>**При доступе к учетной записи хранения произошла неизвестная ошибка.**  

| | |
|-|-|
| **HRESULT** | 0x80c8308a |
| **HRESULT (десятичное число)** | — 2134364022 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_UNKNOWN_ERROR |
| **Требуются действия по исправлению** | Да |

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены должным образом (если они включены).](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings)

<a id="-1906441138"></a>**Сбой синхронизации из-за проблемы с базой данных синхронизации.**  

| | |
|-|-|
| **HRESULT** | 0x8e5e044e |
| **HRESULT (десятичное число)** | -1906441138 |
| **Строка ошибки** | JET_errWriteConflict |
| **Требуются действия по исправлению** | Да |

Эта ошибка появляется, если есть проблема с внутренней базой данных, используемой службой "Синхронизация файлов Azure". Создайте запрос в службу поддержки, и мы свяжемся с вами, чтобы решить эту проблему.

<a id="-2134364053"></a>**Установленная на сервере версия агента Синхронизации файлов Azure не поддерживается.**  

| | |
|-|-|
| **HRESULT** | 0x80C8306B |
| **HRESULT (десятичное число)** | -2134364053 |
| **Строка ошибки** | ECS_E_AGENT_VERSION_BLOCKED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если установленная на сервере версия агента Синхронизации файлов Azure не поддерживается. Чтобы устранить эту проблему, [обновите]( https://docs.microsoft.com/azure/storage/files/storage-files-release-notes#upgrade-paths) до [поддерживаемой версии агента]( https://docs.microsoft.com/azure/storage/files/storage-files-release-notes#supported-versions).

<a id="-2134351810"></a>**Достигнут предельный размер хранилища общего файлового ресурса Azure.**  

| | |
|-|-|
| **HRESULT** | 0x80c8603e |
| **HRESULT (десятичное число)** | -2134351810 |
| **Строка ошибки** | ECS_E_AZURE_STORAGE_SHARE_SIZE_LIMIT_REACHED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если достигнут предельный размер хранилища общего файлового ресурса Azure, что может произойти, если для этого ресурса применяется квота или использование превышает установленные лимиты. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы файлов Azure](storage-files-scale-targets.md).

1. Перейдите в группу синхронизации в службе синхронизации хранилища.
2. В группе синхронизации выберите облачную конечную точку.
3. Обратите внимание на имя общего файлового ресурса Azure в открытой области.
4. Выберите учетную запись хранения, на которую есть ссылка. Если переход по ссылке завершится ошибкой, значит связанная учетная запись хранения была удалена.

    ![Снимок экрана с областью сведений об облачной конечной точке и ссылкой на учетную запись хранения.](media/storage-sync-files-troubleshoot/file-share-inaccessible-1.png)

5. Выберите **Файлы** для просмотра списка общих файловых ресурсов.
6. Щелкните многоточие в конце строки для общего файлового ресурса Azure, на который ссылается облачная конечная точка.
7. Проверьте, чтобы значение в поле **Использование** было ниже значения в поле **Квота**. Обратите внимание, что если альтернативная квота не указана, квота будет соответствовать [максимальному размеру общего файла Azure](storage-files-scale-targets.md).

    ![Снимок экрана свойств общего файлового ресурса Azure.](media/storage-sync-files-troubleshoot/file-share-limit-reached-1.png)

Если общий ресурс заполнен и квота не установлена, одним из возможных способов устранения этой проблемы является переопределение всех подпапок текущей конечной точки сервера в их собственные конечные точки сервера в отдельных группах синхронизации. Таким образом, каждая вложенная папка будет синхронизироваться в отдельном хранилище файловых ресурсов Azure.

<a id="-2134351824"></a>**Не удалось найти общий файловый ресурс Azure.**  

| | |
|-|-|
| **HRESULT** | 0x80c86030 |
| **HRESULT (десятичное число)** | -2134351824 |
| **Строка ошибки** | ECS_E_AZURE_FILE_SHARE_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, когда общий файловый ресурс Azure недоступен. Чтобы устранить ошибку, сделайте следующее:

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Проверьте наличие общего файлового ресурса Azure.](#troubleshoot-azure-file-share)

Если файловый ресурс Azure удален, создайте файловый ресурс и повторно создайте группу синхронизации. 

<a id="-2134364042"></a>**Синхронизация приостановлена, пока приостановлено использование этой подписки Azure.**  

| | |
|-|-|
| **HRESULT** | 0x80C83076 |
| **HRESULT (десятичное число)** | -2134364042 |
| **Строка ошибки** | ECS_E_SYNC_BLOCKED_ON_SUSPENDED_SUBSCRIPTION |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, когда использование подписки Azure приостановлено. Синхронизация будет восстановлена после восстановления подписки Azure. Дополнительные сведения см. в статье [Почему подписка Azure отключена и как активировать ее повторно?](../../billing/billing-subscription-become-disable.md)

<a id="-2134364052"></a>**Для учетной записи хранения настроен брандмауэр или виртуальные сети.**  

| | |
|-|-|
| **HRESULT** | 0x80c8306c |
| **HRESULT (десятичное число)** | -2134364052 |
| **Строка ошибки** | ECS_E_MGMT_STORAGEACLSNOTSUPPORTED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, когда файловый ресурс Azure недоступен из-за брандмауэра учетной записи хранения или если учетная запись хранения принадлежит виртуальной сети. Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены правильно. Дополнительные сведения см. в статье [Настройка параметров брандмауэра и виртуальной сети](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings). 

<a id="-2134375911"></a>**Сбой синхронизации из-за проблемы с базой данных синхронизации.**  

| | |
|-|-|
| **HRESULT** | 0x80c80219 |
| **HRESULT (десятичное число)** | -2134375911 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_WRITE_LOCK_TIMEOUT |
| **Требуются действия по исправлению** | Нет |

Эта ошибка обычно разрешается самостоятельно. Причины ее появления:

* большое число изменений файла на серверах в группе синхронизации;
* большое количество ошибок в отдельных файлах и каталогах.

Если эта ошибка сохраняется в течение более нескольких часов, создайте запрос в службу поддержки, и мы свяжемся с вами, чтобы решить эту проблему.

<a id="-2146762487"></a>**Серверу не удалось установить безопасное подключение. Облачная служба получила непредвиденный сертификат.**  

| | |
|-|-|
| **HRESULT** | 0x800b0109 |
| **HRESULT (десятичное число)** | -2146762487 |
| **Строка ошибки** | CERT_E_UNTRUSTEDROOT |
| **Требуются действия по исправлению** | Да |

Эта ошибка может возникнуть, если ваша организация использует прокси-сервер с завершающим действием SSL или вредоносный объект перехватывает трафик между вашим сервером и службой "Синхронизация файлов Azure". Если вы уверены, что это ожидаемое поведение (потому что ваша организация использует прокси-сервер с завершающим действием SSL), можно пропустить проверку сертификата с переопределением реестра.

1. Создайте значение реестра SkipVerifyingPinnedRootCertificate.

    ```powershell
    New-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Azure\StorageSync -Name SkipVerifyingPinnedRootCertificate -PropertyType DWORD -Value 1
    ```

2. Перезапустите службу синхронизации для зарегистрированного сервера.

    ```powershell
    Restart-Service -Name FileSyncSvc -Force
    ```

Если задать это значение реестра, агент службы "Синхронизация файлов Azure" будет принимать любые локально доверенные SSL-сертификаты при передаче данных между сервером и облачной службой.

<a id="-2147012894"></a>**Не удается установить подключение к службе.**  

| | |
|-|-|
| **HRESULT** | 0x80072ee2 |
| **HRESULT (десятичное число)** | -2147012894 |
| **Строка ошибки** | WININET_E_TIMEOUT |
| **Требуются действия по исправлению** | Да |

[!INCLUDE [storage-sync-files-bad-connection](../../../includes/storage-sync-files-bad-connection.md)]

<a id="-2134375680"></a>**Сбой синхронизации из-за проблемы с аутентификацией.**  

| | |
|-|-|
| **HRESULT** | 0x80c80300 |
| **HRESULT (десятичное число)** | -2134375680 |
| **Строка ошибки** | ECS_E_SERVER_CREDENTIAL_NEEDED |
| **Требуются действия по исправлению** | Да |

Эта ошибка обычно возникает из-за неправильного времени сервера. Если сервер работает на виртуальной машине, проверьте правильность времени на узле.

<a id="-2134364040"></a>**Не удалось выполнить синхронизацию из-за истечения срока действия сертификата.**  

| | |
|-|-|
| **HRESULT** | 0x80c83078 |
| **HRESULT (десятичное число)** | — 2134364040 |
| **Строка ошибки** | ECS_E_AUTH_SRV_CERT_EXPIRED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за истечения срока действия сертификата, используемого для проверки подлинности.

Чтобы убедиться, что срок действия сертификата истек, выполните следующие действия.  
1. Откройте оснастку MMC для сертификатов, выберите учетную запись компьютера и перейдите в каталог Certificates (локальный компьютер)\Personal\Certificates.
2. Проверьте, не истек ли срок действия сертификата проверки подлинности клиента.

Если срок действия сертификата проверки подлинности клиента истек, выполните следующие действия, чтобы устранить проблему.

1. Убедитесь, что установлен агент службы "Синхронизация файлов Azure" версии 4.0.1.0 или более поздней.
2. Выполните следующую команду PowerShell на сервере:

    ```powershell
    Reset-AzStorageSyncServerCertificate -ResourceGroupName <string> -StorageSyncServiceName <string>
    ```

<a id="-2134375896"></a>**Не удалось выполнить синхронизацию, так как сертификат проверки подлинности не найден.**  

| | |
|-|-|
| **HRESULT** | 0x80c80228 |
| **HRESULT (десятичное число)** | — 2134375896 |
| **Строка ошибки** | ECS_E_AUTH_SRV_CERT_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что не найден сертификат, используемый для проверки подлинности.

Чтобы устранить эту проблему, выполните описанные ниже шаги:

1. Убедитесь, что установлен агент службы "Синхронизация файлов Azure" версии 4.0.1.0 или более поздней.
2. Выполните следующую команду PowerShell на сервере:

    ```powershell
    Reset-AzStorageSyncServerCertificate -ResourceGroupName <string> -StorageSyncServiceName <string>
    ```

<a id="-2134364039"></a>**Не удалось выполнить синхронизацию, так как удостоверение проверки подлинности не найдено.**  

| | |
|-|-|
| **HRESULT** | 0x80c83079 |
| **HRESULT (десятичное число)** | — 2134364039 |
| **Строка ошибки** | ECS_E_AUTH_IDENTITY_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что удаление конечной точки сервера завершилось сбоем, а конечная точка находится в частично удаленном состоянии. Чтобы устранить эту проблему, повторите попытку удаления конечной точки сервера.

<a id="-1906441711"></a><a id="-2134375654"></a><a id="doesnt-have-enough-free-space"></a>**Недостаточно места на томе, где расположена конечная точка сервера.**  

| | |
|-|-|
| **HRESULT** | 0x8e5e0211 |
| **HRESULT (десятичное число)** | -1906441711 |
| **Строка ошибки** | JET_errLogDiskFull |
| **Требуются действия по исправлению** | Да |
| | |
| **HRESULT** | 0x80c8031a |
| **HRESULT (десятичное число)** | -2134375654 |
| **Строка ошибки** | ECS_E_NOT_ENOUGH_LOCAL_STORAGE |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если недостаточно места на томе. Эта ошибка обычно возникает из-за того, что файлы за пределами конечной точки сервера используют пространство на томе. Освободите место на томе, добавив дополнительные конечные точки сервера, переместив файлы на другой том или увеличив размер тома, на котором установлена конечная точка сервера.

<a id="-2134364145"></a><a id="replica-not-ready"></a>**Служба еще не готова к синхронизации с этой конечной точкой сервера.**  

| | |
|-|-|
| **HRESULT** | 0x80c8300f |
| **HRESULT (десятичное число)** | -2134364145 |
| **Строка ошибки** | ECS_E_REPLICA_NOT_READY |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает, потому что изменения в общем файловом ресурсе Azure осуществляются напрямую и продолжается их обнаружение. Синхронизация начнется после завершения обнаружения изменений.

[!INCLUDE [storage-sync-files-change-detection](../../../includes/storage-sync-files-change-detection.md)]

<a id="-2134375877"></a><a id="-2134375908"></a><a id="-2134375853"></a>**Сбой синхронизации из-за проблем с большим количеством отдельных файлов.**  

| | |
|-|-|
| **HRESULT** | 0x80c8023b |
| **HRESULT (десятичное число)** | — 2134375877 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_KNOWLEDGE_SOFT_LIMIT_REACHED |
| **Требуются действия по исправлению** | Да |
| | |
| **HRESULT** | 0x80c8021c |
| **HRESULT (десятичное число)** | -2134375908 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_KNOWLEDGE_LIMIT_REACHED |
| **Требуются действия по исправлению** | Да |
| | |
| **HRESULT** | 0x80c80253 |
| **HRESULT (десятичное число)** | -2134375853 |
| **Строка ошибки** | ECS_E_TOO_MANY_PER_ITEM_ERRORS |
| **Требуются действия по исправлению** | Да |

В случаях, когда много ошибок синхронизации на файл, сеансы синхронизации могут завершаться сбоем. <!-- To troubleshoot this state, see [Troubleshooting per file/directory sync errors]().-->

> [!NOTE]
> Служба "Синхронизация файлов Azure" раз в день создает на сервере временный моментальный снимок VSS для синхронизации файлов с открытыми дескрипторами.

<a id="-2134376423"></a>**Сбой синхронизации из-за проблемы с путем к конечной точке сервера.**  

| | |
|-|-|
| **HRESULT** | 0x80c80019 |
| **HRESULT (десятичное число)** | -2134376423 |
| **Строка ошибки** | ECS_E_SYNC_INVALID_PATH |
| **Требуются действия по исправлению** | Да |

Проверьте наличие пути в локальном томе NTFS, и чтобы он не являлся точкой повторного анализа или имеющейся конечной точкой сервера.

<a id="-2134375817"></a>**Синхронизация не удалась, так как версия драйвера фильтра несовместима с версией агента**  

| | |
|-|-|
| **HRESULT** | 0x80C80277 |
| **HRESULT (десятичное число)** | -2134375817 |
| **Строка ошибки** | ECS_E_INCOMPATIBLE_FILTER_VERSION |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что загруженная версия драйвера фильтра для распределения по уровням в облаке (StorageSync.sys) несовместима со службой агента синхронизации хранилища (FileSyncSvc). Если агент службы "Синхронизация файлов Azure" был обновлен, перезапустите сервер, чтобы завершить установку. Если ошибка продолжает возникать, удалите агент, перезапустите сервер и переустановите агент службы "Синхронизация файлов Azure".

<a id="-2134376373"></a>**В настоящее время служба недоступна.**  

| | |
|-|-|
| **HRESULT** | 0x80c8004b |
| **HRESULT (десятичное число)** | -2134376373 |
| **Строка ошибки** | ECS_E_SERVICE_UNAVAILABLE |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает, так как служба "Синхронизация файлов Azure" недоступна. Эта ошибка будет устранена при повторном доступе службы Синхронизация файлов Azure.

<a id="-2146233088"></a>**Сбой синхронизации из-за исключения.**  

| | |
|-|-|
| **HRESULT** | 0x80131500 |
| **HRESULT (десятичное число)** | — 2146233088 |
| **Строка ошибки** | COR_E_EXCEPTION |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает из-за исключения синхронизации. Если ошибка повторяется в течение нескольких часов, создайте запрос в службу поддержки.

<a id="-2134364045"></a>**Сбой синхронизации из-за отработки отказа учетной записи хранения в другой регион.**  

| | |
|-|-|
| **HRESULT** | 0x80c83073 |
| **HRESULT (десятичное число)** | — 2134364045 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_FAILED_OVER |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за отработки отказа учетной записи хранения в другой регион. Синхронизация файлов Azure не поддерживает функцию отработки отказа учетной записи хранения. Не следует применять отработку отказа для учетных записей хранения, которые содержат файловые ресурсы Azure, используемые в качестве облачных конечных точек в службе синхронизации файлов Azure. Это приведет к прекращению синхронизации или даже к непредвиденной потере данных, если некоторые файлы недавно стали многоуровневыми. Чтобы устранить эту проблему, переместите учетную запись хранения в основной регион.

<a id="-2134375922"></a>**Сбой синхронизации из-за временной проблемы с базой данных синхронизации.**  

| | |
|-|-|
| **HRESULT** | 0x80c8020e |
| **HRESULT (десятичное число)** | -2134375922 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_WRITE_LEASE_LOST |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает из-за внутренней проблемы с базой данных синхронизации. Эта ошибка будет устранена при повторных попытках синхронизации. Если эта ошибка сохраняется в течение продолжительного периода времени, создайте запрос в службу поддержки, и мы свяжемся с вами, чтобы решить эту проблему.

<a id="-2134364024"></a>**Сбой синхронизации из-за изменения в клиенте Azure Active Directory**  

| | |
|-|-|
| **HRESULT** | 0x80c83088 |
| **HRESULT (десятичное число)** | — 2134364024 | 
| **Строка ошибки** | ECS_E_INVALID_AAD_TENANT |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что Синхронизация файлов Azure в настоящее время не поддерживает перемещение подписки в другой клиент Azure Active Directory.
 
Чтобы устранить эту проблему, выполните одно из следующих действий.

- **Вариант 1 (рекомендуется)** : Переместить подписку обратно в исходный клиент Azure Active Directory
- **Вариант 2**. Удалите и повторно создайте текущую группу синхронизации. Если распределение по уровням в облаке включено на конечной точке сервера, удалите группу синхронизации, а затем выполните действия, описанные в разделе "распределение по [уровням облака]( https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint) ", чтобы удалить потерянные многоуровневые файлы перед повторной созданием групп синхронизации. 

<a id="-2134364010"></a>**Не удалось выполнить синхронизацию, так как исключение брандмауэра и виртуальной сети не настроено**  

| | |
|-|-|
| **HRESULT** | 0x80c83096 |
| **HRESULT (десятичное число)** | — 2134364010 | 
| **Строка ошибки** | ECS_E_MGMT_STORAGEACLSBYPASSNOTSET |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если параметры брандмауэра и виртуальной сети включены в учетной записи хранения и исключение "разрешить доступ к доверенным службам Майкрософт для доступа к этой учетной записи хранения" не проверяется. Чтобы устранить эту проблему, выполните действия, описанные в разделе [Настройка параметров брандмауэра и виртуальной сети](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings) в руководстве по развертыванию.

<a id="-2147024891"></a>**Не удалось выполнить синхронизацию, так как разрешения в папке системного тома указаны неверно.**  

| | |
|-|-|
| **HRESULT** | 0x80070005 |
| **HRESULT (десятичное число)** | -2147024891 |
| **Строка ошибки** | ERROR_ACCESS_DENIED |
| **Требуются действия по исправлению** | Да |

Эта ошибка может возникать, если учетная запись NT AUTHORITY\SYSTEM не имеет разрешений на доступ к папке сведений о системном томе на томе, где находится конечная точка сервера. Обратите внимание, что если отдельные файлы не синхронизируются с ERROR_ACCESS_DENIED, выполните действия, описанные в разделе [Устранение неполадок с ошибками синхронизации файлов и каталогов](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#troubleshooting-per-filedirectory-sync-errors) .

Чтобы устранить эту проблему, выполните описанные ниже шаги:

1. Загрузите средство [PsExec](https://docs.microsoft.com/sysinternals/downloads/psexec) .
2. Выполните следующую команду из командной строки с повышенными привилегиями, чтобы запустить командную строку с использованием системной учетной записи: **PsExec. exe-i-s-d cmd** 
3. В командной строке, работающей под системной учетной записью, выполните следующую команду, чтобы убедиться, что учетная запись NT AUTHORITY\SYSTEM не имеет доступа к папке системного тома: **cacls "буква диска: \ системный том"/T/c**
4. Если учетная запись NT AUTHORITY\SYSTEM не имеет доступа к папке System Volume Information, выполните следующую команду: **cacls "буква диска: \ системный том \"/T/E/g "NT AUTHORITY\SYSTEM: F"**
    - Если шаг #4 завершается с отказом в доступе, выполните следующую команду, чтобы стать владельцем папки системного тома, а затем повторите шаг #4: **takeown/A/R/f "буква диска: \ сведения о системном томе"**

<a id="-2134375810"></a>**Не удалось выполнить синхронизацию, так как файловый ресурс Azure удален и создан повторно.**  

| | |
|-|-|
| **HRESULT** | 0x80c8027e |
| **HRESULT (десятичное число)** | — 2134375810 |
| **Строка ошибки** | ECS_E_SYNC_REPLICA_ROOT_CHANGED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что Синхронизация файлов Azure не поддерживает удаление и повторное создание файлового ресурса Azure в одной группе синхронизации. 

Чтобы устранить эту проблему, удалите и повторно создайте группу синхронизации, выполнив следующие действия.

1. Удалите все конечные точки сервера в группе синхронизации.
2. Удалите облачную конечную точку. 
3. Удалите группу синхронизации.
4. Если распределение по уровням облака было включено на конечной точке сервера, удалите потерянные многоуровневые файлы на сервере, выполнив действия, описанные в [многоуровневых файлах, после удаления раздела серверной конечной точки](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint) .
5. Повторно создайте группу синхронизации.

### <a name="common-troubleshooting-steps"></a>Распространенные действия по устранению неполадок
<a id="troubleshoot-storage-account"></a>**Проверьте наличие учетной записи хранения.**  
# <a name="portaltabazure-portal"></a>[Портал](#tab/azure-portal)
1. Перейдите в группу синхронизации в службе синхронизации хранилища.
2. В группе синхронизации выберите облачную конечную точку.
3. Обратите внимание на имя общего файлового ресурса Azure в открытой области.
4. Выберите учетную запись хранения, на которую есть ссылка. Если переход по ссылке завершится ошибкой, значит связанная учетная запись хранения была удалена.
    ![Снимок экрана с областью сведений об облачной конечной точке и ссылкой на учетную запись хранения.](media/storage-sync-files-troubleshoot/file-share-inaccessible-1.png)

# <a name="powershelltabazure-powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell
# Variables for you to populate based on your configuration
$region = "<Az_Region>"
$resourceGroup = "<RG_Name>"
$syncService = "<storage-sync-service>"
$syncGroup = "<sync-group>"

# Log into the Azure account
Connect-AzAccount

# Check to ensure Azure File Sync is available in the selected Azure
# region.
$regions = [System.String[]]@()
Get-AzLocation | ForEach-Object { 
    if ($_.Providers -contains "Microsoft.StorageSync") { 
        $regions += $_.Location 
    } 
}

if ($regions -notcontains $region) {
    throw [System.Exception]::new("Azure File Sync is either not available in the " + `
        " selected Azure Region or the region is mistyped.")
}

# Check to ensure resource group exists
$resourceGroups = [System.String[]]@()
Get-AzResourceGroup | ForEach-Object { 
    $resourceGroups += $_.ResourceGroupName 
}

if ($resourceGroups -notcontains $resourceGroup) {
    throw [System.Exception]::new("The provided resource group $resourceGroup does not exist.")
}

# Check to make sure the provided Storage Sync Service
# exists.
$syncServices = [System.String[]]@()

Get-AzStorageSyncService -ResourceGroupName $resourceGroup | ForEach-Object {
    $syncServices += $_.StorageSyncServiceName
}

if ($syncServices -notcontains $syncService) {
    throw [System.Exception]::new("The provided Storage Sync Service $syncService does not exist.")
}

# Check to make sure the provided Sync Group exists
$syncGroups = [System.String[]]@()

Get-AzStorageSyncGroup -ResourceGroupName $resourceGroup -StorageSyncServiceName $syncService | ForEach-Object {
    $syncGroups += $_.SyncGroupName
}

if ($syncGroups -notcontains $syncGroup) {
    throw [System.Exception]::new("The provided sync group $syncGroup does not exist.")
}

# Get reference to cloud endpoint
$cloudEndpoint = Get-AzStorageSyncCloudEndpoint `
    -ResourceGroupName $resourceGroup `
    -StorageSyncServiceName $syncService `
    -SyncGroupName $syncGroup

# Get reference to storage account
$storageAccount = Get-AzStorageAccount | Where-Object { 
    $_.Id -eq $cloudEndpoint.StorageAccountResourceId
}

if ($storageAccount -eq $null) {
    throw [System.Exception]::new("The storage account referenced in the cloud endpoint does not exist.")
}
```
---

<a id="troubleshoot-azure-file-share"></a>**Проверьте наличие общего файлового ресурса Azure.**  
# <a name="portaltabazure-portal"></a>[Портал](#tab/azure-portal)
1. Щелкните **Обзор** в таблице содержания слева, чтобы вернуться на главную страницу учетной записи хранения.
2. Выберите **Файлы** для просмотра списка общих файловых ресурсов.
3. Проверьте, что файловый ресурс, на который ссылается облачная конечная точка, отображается в списке файловых ресурсов (это должно быть отмечено на шаге 1 выше).

# <a name="powershelltabazure-powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell
$fileShare = Get-AzStorageShare -Context $storageAccount.Context | Where-Object {
    $_.Name -eq $cloudEndpoint.AzureFileShareName -and
    $_.IsSnapshot -eq $false
}

if ($fileShare -eq $null) {
    throw [System.Exception]::new("The Azure file share referenced by the cloud endpoint does not exist")
}
```
---

<a id="troubleshoot-rbac"></a>**Убедитесь, что служба "Синхронизация файлов Azure" имеет доступ к учетной записи хранения.**  
# <a name="portaltabazure-portal"></a>[Портал](#tab/azure-portal)
1. Щелкните **Управление доступом (IAM)** в таблице содержимого слева.
1. Щелкните вкладку **Назначение ролей** и откройте список пользователей и приложений (*субъекты-службы*), имеющих доступ к вашей учетной записи хранения.
1. Проверьте наличие **гибридной службы "Синхронизация файлов"** в списке с ролью **модуля чтения и доступа к данным**. 

    ![Снимок экрана субъекта-службы гибридного Синхронизация файлов на вкладке "Управление доступом" учетной записи хранения](media/storage-sync-files-troubleshoot/file-share-inaccessible-3.png)

    Если **Hybrid File Sync Service** не отображается в списке, сделайте следующее:

    - Нажмите кнопку **Добавить**.
    - В поле **Роль** выберите **Модуль чтения и доступ к данным**.
    - В поле **выбора** введите фразу **Hybrid File Sync Service**, выберите роль и нажмите кнопку **Сохранить**.

# <a name="powershelltabazure-powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell    
$role = Get-AzRoleAssignment -Scope $storageAccount.Id | Where-Object { $_.DisplayName -eq "Hybrid File Sync Service" }

if ($role -eq $null) {
    throw [System.Exception]::new("The storage account does not have the Azure File Sync " + `
                "service principal authorized to access the data within the " + ` 
                "referenced Azure file share.")
}
```
---

### <a name="how-do-i-prevent-users-from-creating-files-containing-unsupported-characters-on-the-server"></a>Как на сервере запретить пользователям создавать файлы, содержащие неподдерживаемые знаки?
Вы можете использовать [фильтры блокировки файлов диспетчера ресурсов файлового сервера (FSRM)](https://docs.microsoft.com/windows-server/storage/fsrm/file-screening-management), чтобы блокировать создание на сервере файлов с неподдерживаемыми знаками в их именах. Возможно, это нужно будет сделать с помощью PowerShell, так как большинство неподдерживаемых знаков не выводятся, поэтому вам нужно сначала привести шестнадцатеричные представления к знаковым.

Сначала создайте группу файлов FSRM с помощью командлета [New-FsrmFileGroup](https://docs.microsoft.com/powershell/module/fileserverresourcemanager/new-fsrmfilegroup). В этом примере группа будет содержать только два неподдерживаемых знака, но вы можете включить в группу файлов столько знаков, сколько нужно.

```powershell
New-FsrmFileGroup -Name "Unsupported characters" -IncludePattern @(("*"+[char]0x00000090+"*"),("*"+[char]0x0000008F+"*"))
```

После определения группы файлов FSRM можно создать фильтр блокировки файлов FSRM с помощью командлета New-FsrmFileScreen.

```powershell
New-FsrmFileScreen -Path "E:\AFSdataset" -Description "Filter unsupported characters" -IncludeGroup "Unsupported characters"
```

> [!Important]  
> Обратите внимание, что фильтры блокировки файлов должны использоваться только для блокировки создания знаков, не поддерживаемых службой "Синхронизация файлов Azure". Если фильтры блокировки файлов используются в других сценариях, служба синхронизации будет постоянно пытаться загружать файлы из общего файлового ресурса Azure на сервер и будет заблокирована фильтром блокировки файлов, что приведет к большому объему исходящих данных. 

## <a name="cloud-tiering"></a>Распределение по уровням облака 
Существует два сценария сбоев при распределении по уровням облака.

- Во-первых, может произойти сбой распределения файлов, когда служба "Синхронизация файлов Azure" не может успешно перенести файл в Файлы Azure.
- Во-вторых, может произойти сбой получения файлов, когда фильтр файловой системы (StorageSync.sys) службы "Синхронизация файлов Azure" не может успешно скачать данные перенесенного в облако файла, когда пользователь пытается к нему обратиться.

Для каждого из сценариев есть два основных класса сбоев:

- Сбои облачного хранилища
    - *Временные проблемы с доступностью службы хранилища*. Подробнее этот вопрос рассматривается в [Соглашении об уровне обслуживания (SLA) для службы хранилища Azure](https://azure.microsoft.com/support/legal/sla/storage/v1_2/).
    - *Недоступность общего файлового ресурса Azure*. Такая ошибка обычно происходит, когда вы удаляете общий файловый ресурс Azure, который назначен в качестве облачной конечной точки в группе синхронизации.
    - *Недоступность учетной записи хранения*. Такая ошибка обычно происходит, когда вы удаляете учетную запись хранения, которая содержит общую папку Azure, назначенную в качестве облачной конечной точки для группы синхронизации. 
- Ошибки сервера 
  - *Не загружен фильтр файловой системы (StorageSync.sys) службы синхронизации файлов Azure*. Чтобы обслуживать запросы на сохранение и восстановление файлов, должен быть загружен фильтр файловой системы службы синхронизации файлов Azure. Может быть несколько причин, по которым фильтр не будет загружен. Но чаще всего это означает, что администратор вручную отключил его. Фильтр файловой системы службы "Синхронизация файлов Azure" должен быть постоянно загружен, чтобы эта служба работала правильно.
  - *Точка повторного анализа отсутствует, повреждена или непригодна по другим причинам*. Точка повторной обработки — это специальная структура данных о файле, которая состоит из двух частей.
    1. Тег повторной обработки указывает, какая операционная система нужна фильтру файловой системы (StorageSync.sys) службы "Синхронизация файлов Azure" для операций ввода-вывода с этим файлом. 
    2. Данные повторной обработки сообщают фильтру файловой системы URI файла на соответствующей облачной конечной точке (в общем файловом ресурсе Azure). 
        
       Наиболее распространенная проблема с точкой повторной обработки — неудачная попытка администратора изменить в ней тег или данные. 
  - *Проблемы с сетевым подключением* Чтобы выполнять сохранение и восстановление файлов, сервер должен иметь подключение к Интернету.

В следующих разделах описывается устранение неполадок с распределением по уровням облака, которое позволит определить возможные проблемы с облачным хранилищем или сервером.

### <a name="how-to-monitor-tiering-activity-on-a-server"></a>Мониторинг действий по распределению по уровням на сервере  
Чтобы отслеживать на сервере действие распределения по уровням, используйте идентификаторы события 9003, 9016 и 9029 в журнале событий телеметрии (расположенном в папке Applications and Services\Microsoft\FileSync\Agent в средстве "Просмотр событий").

- Идентификатор события 9003 обеспечивает распределение ошибок для конечной точки сервера. Например, общее число ошибок, код ошибки и т. д. Обратите внимание, что на каждый код ошибки регистрируется одно событие.
- Идентификатор события 9016 предоставляет результаты копий для тома. Например, процент свободного пространства, количество скопированных файлов в сеансе, количество файлов, копии которых создать не удалось, и т. д.
- Идентификатор события 9029 предоставляет сведения о сеансе копирования для конечной точки сервера. Например, количество попыток копирования файла в сеансе, количество файлов, распределенных по уровням в сеансе, количество уже распределенных по уровням файлов и т. д.

### <a name="how-to-monitor-recall-activity-on-a-server"></a>Мониторинг действий отзыва на сервере
Чтобы отслеживать на сервере действие отзыва, используйте идентификаторы события 9005, 9006, 9009 и 9059 в журнале событий телеметрии (расположенном в папке Applications and Services\Microsoft\FileSync\Agent в средстве "Просмотр событий").

- Идентификатор события 9005 обеспечивает надежность отзыва для конечной точки сервера. Например, общее число уникальных файлов, к которым получен доступ, общее число уникальных файлов, доступ к которым завершился сбоем, и т. д.
- Идентификатор события 9006 обеспечивает распределение ошибок отзыва для конечной точки сервера. Например, общее количество запросов, завершившихся сбоем, код ошибки и т. д. Обратите внимание, что на каждый код ошибки регистрируется одно событие.
- Идентификатор события 9009 предоставляет сведения о сеансе отзыва для конечной точки сервера. Например, DurationSeconds, CountFilesRecallSucceeded, CountFilesRecallFailed и др.
- Идентификатор события 9059 предоставляет сведения об отзыве приложения для конечной точки сервера. Например, ShareId, ApplicationName и TotalEgressNetworkBytes.

### <a name="how-to-troubleshoot-files-that-fail-to-tier"></a>Устранение неполадок при распределении файлов по уровням
Если файлы не удается распределить по уровням в службе файлов Azure, сделайте следующее:

1. В средстве "Просмотр событий" просмотрите журналы событий диагностики, операций и телеметрии, расположенные в папке Applications and Services\Microsoft\FileSync\Agent. 
   1. Проверьте наличие файлов в файловом ресурсе Azure.

      > [!NOTE]
      > Файлы должны быть синхронизированы с общими файловыми ресурсами Azure, прежде чем их можно будет распределить по уровням.

   2. Проверьте наличие подключения сервера к Интернету. 
   3. Убедитесь, что драйверы фильтра службы "Синхронизация файлов Azure" (StorageSync.sys и StorageSyncGuard.sys) запущены.
       - В командной строке с повышенными привилегиями запустите `fltmc`. Убедитесь, что указаны драйверы StorageSync.sys и StorageSyncGuard.sys фильтра файловой системы.

> [!NOTE]
> Идентификатор события 9003 регистрируется один раз в час в журнале событий телеметрии при сбое распределения файла по уровням (на один код ошибки регистрируется одно событие). Если для диагностики проблемы требуется дополнительная информация, следует использовать журналы диагностических и операционных событий.

### <a name="how-to-troubleshoot-files-that-fail-to-be-recalled"></a>Устранение неполадок в файлах, которые не удалось отозвать  
Если файлы не удалось отозвать:
1. В средстве "Просмотр событий" просмотрите журналы событий диагностики, операций и телеметрии, расположенные в папке Applications and Services\Microsoft\FileSync\Agent.
    1. Проверьте наличие файлов в файловом ресурсе Azure.
    2. Проверьте наличие подключения сервера к Интернету. 
    3. Откройте оснастку MMC служб и проверьте выполнение службы агента синхронизации хранилища (FileSyncSvc).
    4. Убедитесь, что драйверы фильтра службы "Синхронизация файлов Azure" (StorageSync.sys и StorageSyncGuard.sys) запущены.
        - В командной строке с повышенными привилегиями запустите `fltmc`. Убедитесь, что указаны драйверы StorageSync.sys и StorageSyncGuard.sys фильтра файловой системы.

> [!NOTE]
> Идентификатор события 9006 регистрируется один раз в час в журнале событий телеметрии при сбое отзыва файла (на один код ошибки регистрируется одно событие). Если для диагностики проблемы требуется дополнительная информация, следует использовать журналы диагностических и операционных событий.

### <a name="recall-errors-and-remediation"></a>Ошибки отзыва и исправление

| HRESULT | HRESULT (десятичное число) | Строка ошибки | Проблемы | Исправление |
|---------|-------------------|--------------|-------|-------------|
| 0x80070079 | — 121 | ERROR_SEM_TIMEOUT | Не удалось отозвать файл из-за истечения времени ожидания ввода-вывода. Эта проблема может возникнуть по нескольким причинам: ограничения ресурсов сервера, плохое сетевое подключение или проблема с хранилищем Azure (например, регулирование). | Действия не требуются. Если ошибка повторяется в течение нескольких часов, создайте обращение в службу поддержки. |
| 0x80070036 | — 2147024842 | ERROR_NETWORK_BUSY | Не удалось отозвать файл из-за проблемы в сети.  | Если ошибка повторяется, проверьте сетевое подключение к общему файловому ресурсу Azure. |
| 0x80c80037 | — 2134376393 | ECS_E_SYNC_SHARE_NOT_FOUND | Не удалось вспомнить файл, так как конечная точка сервера была удалена. | Сведения об устранении этой проблемы см. в разделе [многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](https://docs.microsoft.com/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint). |
| 0x80070005 | -2147024891 | ERROR_ACCESS_DENIED | Не удалось отозвать файл из-за ошибки отказа в доступе. Эта проблема может возникать, если параметры брандмауэра и виртуальной сети в учетной записи хранения включены и сервер не имеет доступа к учетной записи хранения. | Чтобы устранить эту проблему, добавьте IP-адрес или виртуальную сеть сервера, выполнив действия, описанные в разделе [Настройка параметров брандмауэра и виртуальной сети](https://docs.microsoft.com/azure/storage/files/storage-sync-files-deployment-guide?tabs=azure-portal#configure-firewall-and-virtual-network-settings) в руководстве по развертыванию. |
| 0x80c86002 | — 2134351870 | ECS_E_AZURE_RESOURCE_NOT_FOUND | Не удалось отозвать файл, так как он недоступен в общем файловом ресурсе Azure. | Чтобы устранить эту проблему, убедитесь, что файл существует в общем файловом ресурсе Azure. Если файл существует в общей папке Azure, выполните обновление до последней версии агента Синхронизация файлов Azure. |
| 0x80c8305f | -2134364065 | ECS_E_EXTERNAL_STORAGE_ACCOUNT_AUTHORIZATION_FAILED | Не удалось отозвать файл из-за ошибки авторизации в учетной записи хранения. | Чтобы устранить эту проблему, убедитесь, [Синхронизация файлов Azure имеет доступ к учетной записи хранения](https://docs.microsoft.com/en-us/azure/storage/files/storage-sync-files-troubleshoot?tabs=portal1%2Cazure-portal#troubleshoot-rbac). |

### <a name="tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint"></a>Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера
Многоуровневые файлы на сервере станут недоступными, если они не были отозваны перед удалением конечной точки сервера.

Ошибки, регистрируемые, если многоуровневые файлы недоступны
- При синхронизации файла код ошибки-2147942467 (0x80070043-ERROR_BAD_NET_NAME) заносится в журнал событий Итемресултс
- При повторном вызове файла код ошибки-2134376393 (0x80c80037-ECS_E_SYNC_SHARE_NOT_FOUND) заносится в журнал событий Рекаллресултс

Восстановление доступа к многоуровневым файлам возможно, если выполняются следующие условия.
- Конечная точка сервера была удалена за последние 30 дней
- Облачная конечная точка не удалена 
- Общая папка не была удалена
- Группа синхронизации не была удалена

Если выполняются указанные выше условия, можно восстановить доступ к файлам на сервере, повторно создав конечную точку сервера по тому же пути на сервере в той же группе синхронизации в течение 30 дней. 

Если приведенные выше условия не выполняются, восстановление доступа невозможно, так как эти многоуровневые файлы на сервере теперь являются потерянными. Выполните приведенные ниже инструкции, чтобы удалить потерянные многоуровневые файлы.

**Примечания**
- Если многоуровневые файлы недоступны на сервере, полный файл по-прежнему должен быть доступен, если вы напрямую обращаетесь к файловому ресурсу Azure.
- Чтобы предотвратить появление потерянных многоуровневых файлов в будущем, выполните действия, описанные в разделе [Удаление конечной](https://docs.microsoft.com/azure/storage/files/storage-sync-files-server-endpoint#remove-a-server-endpoint) точки сервера при удалении конечной точки сервера.

<a id="get-orphaned"></a>**Получение списка потерянных многоуровневых файлов** 

1. Убедитесь, что установлен агент Синхронизация файлов Azure версии 5.1 или более поздней.
2. Выполните следующие команды PowerShell, чтобы вывести список потерянных многоуровневых файлов:
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFiles = Get-StorageSyncOrphanedTieredFiles -path <server endpoint path>
$orphanFiles.OrphanedTieredFiles > OrphanTieredFiles.txt
```
3. Сохраните выходной файл Орфантиередфилес. txt в случае, если необходимо восстановить файлы из резервной копии после их удаления.

<a id="remove-orphaned"></a>**Удаление потерянных многоуровневых файлов** 

*Вариант 1. Удаление потерянных многоуровневых файлов @ no__t-0

Этот параметр удаляет потерянные многоуровневые файлы на сервере Windows Server, но требует удаления конечной точки сервера, если она существует по истечении 30 дней или подключения к другой группе синхронизации. Если файлы обновляются на сервере Windows Server или в файловом ресурсе Azure до повторного создания конечной точки сервера, возникнут конфликты файлов.

1. Убедитесь, что установлен агент Синхронизация файлов Azure версии 5.1 или более поздней.
2. Создайте резервную копию общего файлового ресурса Azure и расположения конечной точки сервера.
3. Удалите конечную точку сервера в группе синхронизации (если она существует), выполнив действия, описанные в разделе [Удаление конечной точки сервера](https://docs.microsoft.com/azure/storage/files/storage-sync-files-server-endpoint#remove-a-server-endpoint).

> [!Warning]  
> Если конечная точка сервера не была удалена перед использованием командлета Remove-Сторажесинкорфанедтиередфилес, удаление потерянного многоуровневого файла на сервере приведет к удалению полного файла в общем файловом ресурсе Azure. 

4. Выполните следующие команды PowerShell, чтобы вывести список потерянных многоуровневых файлов:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFiles = Get-StorageSyncOrphanedTieredFiles -path <server endpoint path>
$orphanFiles.OrphanedTieredFiles > OrphanTieredFiles.txt
```
5. Сохраните выходной файл Орфантиередфилес. txt в случае, если необходимо восстановить файлы из резервной копии после их удаления.
6. Выполните следующие команды PowerShell, чтобы удалить потерянные многоуровневые файлы:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFilesRemoved = Remove-StorageSyncOrphanedTieredFiles -Path <folder path containing orphaned tiered files> -Verbose
$orphanFilesRemoved.OrphanedTieredFiles > DeletedOrphanFiles.txt
```
**Примечания** 
- Многоуровневые файлы, измененные на сервере, которые не синхронизированы с общим файловым ресурсом Azure, будут удалены.
- Многоуровневые файлы, доступные (не имеющие пары), не будут удалены.
- Неуровневые файлы останутся на сервере.

7. Необязательно: Повторно создайте конечную точку сервера, если она была удалена на шаге 3.

*Вариант 2. Подключите файловый ресурс Azure и скопируйте файлы локально, которые были потеряны на сервере @ no__t-0

Этот параметр не требует удаления конечной точки сервера, но требует достаточно места на диске для копирования полных файлов на локальный компьютер.

1. [Подключите](https://docs.microsoft.com/azure/storage/files/storage-how-to-use-files-windows) файловый ресурс Azure на сервере Windows, который содержит потерянные многоуровневые файлы.
2. Выполните следующие команды PowerShell, чтобы вывести список потерянных многоуровневых файлов:
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFiles = Get-StorageSyncOrphanedTieredFiles -path <server endpoint path>
$orphanFiles.OrphanedTieredFiles > OrphanTieredFiles.txt
```
3. Используйте выходной файл Орфантиередфилес. txt для обнаружения потерянных многоуровневых файлов на сервере.
4. Перезапишите потерянные многоуровневые файлы, скопировав полный файл из файлового ресурса Azure на сервер Windows.

### <a name="how-to-troubleshoot-files-unexpectedly-recalled-on-a-server"></a>Устранение неполадок с неожиданным отзывом файлов на сервере  
Антивирусные программы, приложения архивации, а также другие приложения, которые считывают большое количество файлов, вызывают непреднамеренные отзывы, если они не учитывают автономный атрибут пропуска и пропускают чтение содержимого этих файлов. Пропуск автономных файлов для продуктов, поддерживающих эту возможность, позволяет избежать непреднамеренных отзывов во время операций, таких как антивирусные проверки или задания резервного копирования.

Обратитесь к поставщику программного обеспечения за информацией о том, как настроить решение, чтобы пропустить чтение автономных файлов.

Непреднамеренные отзывы также могут возникать в других сценариях, например при просмотре файлов в проводнике. Открытие папки с облачными многоуровневыми файлами в проводнике может привести к непреднамеренным отзывам на сервере. Это еще более вероятно, если на сервере включено антивирусное решение.

> [!NOTE]
>Чтобы определить, какие приложения вызывают отзывы, используйте идентификатор события 9059 в журнале событий телеметрии. Это событие обеспечивает распределение ошибок отзыва приложения для конечной точки сервера и регистрируется каждый час.

## <a name="general-troubleshooting"></a>Общие действия по устранению неполадок
При возникновении проблем на сервере со службой синхронизации файлов Azure для начала сделайте следующее:
1. В средстве "Просмотр событий" просмотрите журналы событий диагностики, операций и телеметрии.
    - Проблемы синхронизации, распределения по уровням и отзывов записываются в журналы событий диагностики, операций и телеметрии, которые расположены в папке Applications and Services\Microsoft\FileSync\Agent.
    - Проблемы, связанные с управлением сервером (например, параметры конфигурации), записываются в журналы событий диагностики и операций, которые расположены в папке Applications and Services\Microsoft\FileSync\Management.
2. Убедитесь, что служба "Синхронизация файлов Azure" выполняется на сервере.
    - Откройте оснастку MMC "Службы" и убедитесь, что выполняется служба агента синхронизации хранилища (FileSyncSvc).
3. Убедитесь, что драйверы фильтра службы "Синхронизация файлов Azure" (StorageSync.sys и StorageSyncGuard.sys) запущены.
    - В командной строке с повышенными привилегиями запустите `fltmc`. Убедитесь, что указаны драйверы StorageSync.sys и StorageSyncGuard.sys фильтра файловой системы.

Если проблема не устранена, запустите средство AFSDiag.
1. Создайте каталог (например, C:\Output), в котором будут сохранены выходные данные средства AFSDiag.
    > [!NOTE]
    >AFSDiag удалит все содержимое в выходном каталоге до сбора журналов. Укажите расположение выхода, которое не содержит данных.
2. Откройте окно PowerShell, а затем выполните следующие команды (нажимайте клавишу ВВОД после каждой команды).

    ```powershell
    cd "c:\Program Files\Azure\StorageSyncAgent"
    Import-Module .\afsdiag.ps1
    Debug-Afs c:\output # Note: Use the path created in step 1.
    ```

3. Для службы синхронизации файлов Azure в режиме ядра на уровне трассировки введите **1** (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
4. Для службы синхронизации файлов Azure в пользовательском режиме на уровне трассировки введите **1** (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
5. Воспроизведите проблему. После завершения введите **D**.
6. ZIP-файл, содержащий журналы и файлы трассировки, сохраняется в указанном вами каталоге выходных данных.

## <a name="see-also"></a>См. также
- [Мониторинг Синхронизации файлов Azure](storage-sync-files-monitoring.md)
- [Часто задаваемые вопросы о службе "Файлы Azure"](storage-files-faq.md)
- [Устранение неполадок службы файлов Azure в Windows](storage-troubleshoot-windows-file-connection-problems.md)
- [Устранение неполадок службы файлов Azure в Linux](storage-troubleshoot-linux-file-connection-problems.md)
