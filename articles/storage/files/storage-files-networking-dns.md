---
title: Настройка перенаправления DNS для Файлов Azure | Документация Майкрософт
description: Общие сведения о параметрах сети службы "Файлы Azure".
author: roygara
ms.service: storage
ms.topic: overview
ms.date: 3/19/2020
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 35dfbcb274721049f2160719222ca89038c93356
ms.sourcegitcommit: c2065e6f0ee0919d36554116432241760de43ec8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2020
ms.locfileid: "80069557"
---
# <a name="configuring-dns-forwarding-for-azure-files"></a>Настройка перенаправления DNS для Файлов Azure
Файлы Azure позволяют создавать частные конечные точки для учетных записей хранения, содержащих общие папки. Частные конечные точки используются для разных приложений — в частности для подключения к общим папкам Azure из локальной сети через подключения VPN или ExpressRoute с использованием частного пиринга. 

Чтобы подключения к учетной записи хранения устанавливались через сетевой туннель, полное доменное имя (FQDN) учетной записи хранения должно разрешаться в частный IP-адрес частной конечной точки. Для этого вам нужно перенаправить суффикс конечной точки хранилища (`core.windows.net` для регионов общедоступного облака) в службу частной зоны DNS Azure, которая доступна в виртуальной сети. В этом руководстве показано, как настроить перенаправление DNS для правильного разрешения в IP-адрес частной конечной точки учетной записи хранения.

Перед выполнением шагов, описанных в этом руководстве, настоятельно рекомендуем ознакомиться с руководством по [планированию развертывания Файлов Azure](storage-files-planning.md) и рекомендациями по [работе с сетями Файлов Azure](storage-files-networking-overview.md).

## <a name="overview"></a>Обзор
Файлы Azure предоставляют два основных типа конечных точек для доступа к общим папкам Azure: 
- общедоступные конечные точки, у которых есть общедоступный IP-адрес и к которым можно обращаться из любой точки мира;
- частные конечные точки, которые существуют только в виртуальной сети и имеют частный IP-адрес в пределах адресного пространства этой виртуальной сети.

Общедоступные и частные конечные точки размещаются в учетной записи хранения Azure. Учетная запись хранения — это конструкция управления, представляющая собой общий пул носителей, который можно использовать для развертывания нескольких общих папок и других ресурсов хранения, например контейнеров больших двоичных объектов или очередей.

Каждая учетная запись хранения имеет уникальное полное доменное имя (FQDN). Для регионов общедоступного облака полное доменное имя соответствует шаблону `storageaccount.file.core.windows.net`, где `storageaccount` обозначает имя учетной записи хранения. При выполнении запросов по этому имени, например при подключении общей папки к персональному компьютеру через SMB, операционная система выполняет поиск в DNS, чтобы разрешить полное доменное имя в IP-адрес, который она сможет использовать для отправки запросов SMB.

По умолчанию `storageaccount.file.core.windows.net` разрешается в IP-адрес общедоступной конечной точки. Общедоступная конечная точка учетной записи хранения размещается в кластере хранения Azure вместе с общедоступными конечными точками учетных записей хранения. Когда вы создаете частную конечную точку, частная зона DNS связывается с виртуальной сетью, в которую она добавлена. Запись типа CNAME связывает `storageaccount.file.core.windows.net` с записью типа A для частного IP-адреса частной конечной точки учетной записи хранения. Это позволяет использовать в виртуальной сети полное доменное имя `storageaccount.file.core.windows.net` и разрешать его в IP-адрес частной конечной точки.

Так как нашей целью является получение доступа из локальной сети к общим папкам Azure, размещенным в учетной записи хранения, через подключение VPN, ExpressRoute или другой сетевой туннель, нам нужно настроить на локальных DNS-серверах перенаправление в службу частной зоны DNS Azure всех запросов к Файлам Azure. Для этого необходимо настроить *условную переадресацию* для `*.core.windows.net` (или добавить соответствующий суффикс конечной точки хранилища для национальных облаков США, Германии или Китая) на DNS-сервер, размещенный в виртуальной сети Azure. Этот DNS-сервер рекурсивно перенаправит запрос в службу частной зоны DNS Azure, которая будет разрешать полное доменное имя учетной записи хранения в соответствующий частный IP-адрес.

Чтобы настроить перенаправление DNS для Файлов Azure, нужно запустить виртуальную машину для размещения DNS-сервера, который будет пересылать запросы. Но это нужно сделать только один раз для всех общих папок Azure, размещенных в виртуальной сети. Кроме того, это требование относится не только к Файлам Azure. Любая служба Azure с поддержкой частных конечных точек, к которым вы хотите получить доступ из локальной среды, может использовать перенаправление DNS, которое вы настроите в этом руководстве: хранилище BLOB-объектов Azure, SQL Azure, Cosmos DB и т. п. 

В этом руководстве описаны действия по настройке перенаправления DNS для конечной точки хранилища Azure, поэтому кроме Файлов Azure в службу закрытой зоны DNS Azure будут перенаправляться запросы на разрешение имен DNS для всех других служб хранилища Azure (хранилище BLOB-объектов Azure, хранилище таблиц Azure, Хранилище очередей Azure и т. д.). При желании можно также добавить дополнительные конечные точки для других служб Azure. Также будет настроено перенаправление DNS на локальные DNS-серверы, что позволит облачным ресурсам в виртуальной сети (таким, как сервер DFS-N) разрешать имена локальных виртуальных машин. 

## <a name="prerequisites"></a>Предварительные требования
Перед настройкой перенаправления DNS в Файлы Azure необходимо подготовить следующие компоненты:

- Учетная запись хранения с общей папкой Azure, которую вы хотите подключить. Чтобы узнать, как создать учетную запись хранения и общую папку Azure, ознакомьтесь с [этой статьей](storage-how-to-create-file-share.md).
- Частная конечная точка для учетной записи хранения. Чтобы узнать, как создать частную конечную точку для Файлов Azure, ознакомьтесь с [этой статьей](storage-files-networking-endpoints.md#create-a-private-endpoint).
- Модуль Azure PowerShell [последней версии](https://docs.microsoft.com/powershell/azure/install-az-ps).

> [!Important]  
> В этом руководстве предполагается, что вы используете в локальной среде DNS-сервер под управлением Windows Server. Все описанные в этом руководстве действия можно выполнить на любом DNS-сервере, а не только Windows DNS Server.

## <a name="manually-configuring-dns-forwarding"></a>Настройка перенаправления DNS вручную
Если у вас уже есть DNS-серверы в виртуальной сети Azure или вы предпочитаете развертывать собственные виртуальные машины в роли DNS-серверов любым другим образом, принятым в вашей организации, службу DNS можно настроить вручную с помощью встроенных в DNS-сервер командлетов PowerShell.

На локальных DNS-серверах создайте дополнительный сервер пересылки с помощью `Add-DnsServerConditionalForwarderZone`. Этот условный сервер пересылки нужно развернуть на всех локальных DNS-серверах, чтобы правильно и эффективно пересылать трафик в Azure. Не забудьте заменить `<azure-dns-server-ip>` соответствующими IP-адресами из своей среды.

```powershell
$vnetDnsServers = "<azure-dns-server-ip>", "<azure-dns-server-ip>"

$storageAccountEndpoint = Get-AzContext | `
    Select-Object -ExpandProperty Environment | `
    Select-Object -ExpandProperty StorageEndpointSuffix

Add-DnsServerConditionalForwarderZone `
        -Name $storageAccountEndpoint `
        -MasterServers $vnetDnsServers
```

На DNS-серверах в виртуальной сети Azure также нужно разместить сервер пересылки, чтобы запросы к зоне DNS учетной записи хранения направлялись в службу частной зоны DNS Azure, представленную этим зарезервированным IP-адресом `168.63.129.16`. (Не забудьте указать `$storageAccountEndpoint`, если вы выполняете команды в другом сеансе PowerShell.)

```powershell
Add-DnsServerConditionalForwarderZone `
        -Name $storageAccountEndpoint `
        -MasterServers "168.63.129.16"
```

## <a name="using-the-azure-files-hybrid-module-to-configure-dns-forwarding"></a>Использование гибридного модуля Файлов Azure для настройки перенаправления DNS
Чтобы максимально упростить перенаправление DNS, мы предоставили автоматизацию в гибридном модуле Файлов Azure. Командлеты для управления DNS, включенные в этот модуль, помогут развернуть DNS-серверы в виртуальной сети Azure и настроить перенаправление трафика к ним на локальных DNS-серверах. 

Если вы никогда не использовали гибридный модуль Файлов Azure, его необходимо сначала установить его на рабочей станции. Скачайте [последнюю версию](https://github.com/Azure-Samples/azure-files-samples/releases) гибридного модуля PowerShell для Файлов Azure.

```PowerShell
# Unzip the downloaded file
Expand-Archive -Path AzFilesHybrid.zip

# Change the execution policy to unblock importing AzFilesHybrid.psm1 module
Set-ExecutionPolicy -ExecutionPolicy Unrestricted

# Navigate to where AzFilesHybrid is unzipped and stored and run to copy the files into your path
.\AzFilesHybrid\CopyToPSPath.ps1 

# Import AzFilesHybrid module
Import-Module -Name AzFilesHybrid
```

Развертывание решения для перенаправления DNS включает два шага: создание набора правил перенаправления DNS, который определяет службы Azure для получения запросов, а также развертывание самих серверов пересылки DNS. 

Следующий пример перенаправляет запросы к учетной записи хранения, в том числе к Файлам Azure, хранилищу BLOB-объектов Azure, хранилищу таблиц Azure и Хранилищу очередей Azure. При желании вы можете включить в правило возможность перенаправления для любых дополнительных служб Azure, указав их в параметре `-AzureEndpoints` командлета `New-AzDnsForwardingRuleSet`. Не забудьте заменить `<virtual-network-resource-group>`, `<virtual-network-name>` и `<subnet-name>` соответствующими значениями из своей среды.

```PowerShell
# Create a rule set, which defines the forwarding rules
$ruleSet = New-AzDnsForwardingRuleSet -AzureEndpoints StorageAccountEndpoint

# Deploy and configure DNS forwarders
New-AzDnsForwarder `
        -DnsForwardingRuleSet $ruleSet `
        -VirtualNetworkResourceGroupName "<virtual-network-resource-group>" `
        -VirtualNetworkName "<virtual-network-name>" `
        -VirtualNetworkSubnetName "<subnet-name>"
```

Кроме того, вы можете предоставить дополнительные параметры:

| Имя параметра | Тип | Описание |
|----------------|------|-------------|
| `DnsServerResourceGroupName` | `string` | По умолчанию DNS-серверы развертываются в той же группе ресурсов, что и виртуальная сеть. Если такое поведения является нежелательным, этот параметр позволяет выбрать для развертывания альтернативную группу ресурсов. |
| `DnsForwarderRootName` | `string` | По умолчанию DNS-серверы, развернутые в Azure, получают имена `DnsFwder-*`, где символ звездочки заполняется итератором. Этот параметр изменяет корневую часть имени (т. е. `DnsFwder`). |
| `VmTemporaryPassword` | `SecureString` | По умолчанию для временной учетной записи по умолчанию, которая существует на виртуальной машине до присоединения к домену, выбирается случайный пароль. После присоединения к домену учетная запись по умолчанию будет отключена. |
| `DomainToJoin` | `string` | Домен, к которому будут присоединяться виртуальные машины для DNS-серверов. По умолчанию этот домен выбирается на основе домена того компьютера, на котором выполняются командлеты. |
| `DnsForwarderRedundancyCount` | `int` | Число виртуальных машин DNS для развертывания в виртуальной сети. По умолчанию `New-AzDnsForwarder` развертывает в виртуальной сети Azure два DNS-сервера, включив их в группу доступности для обеспечения избыточности. При желании это число можно изменить. |
| `OnPremDnsHostNames` | `HashSet<string>` | Определяемый вручную список локальных имен узлов DNS, на которых будут созданы серверы пересылки. Этот параметр позволяет не применять серверы пересылки на всех локальных DNS-серверах, например при наличии группы клиентов с указанием DNS-имен вручную. |
| `Credential` | `PSCredential` | Учетные данные, которые нужно использовать при обновлении DNS-серверов. Это удобно, когда у пользователя, выполнившего вход в систему, для учетной записи нет разрешений на изменение параметров DNS. |
| `SkipParentDomain` | `SwitchParameter` | По умолчанию серверы пересылки DNS применяются к домену самого высокого уровня, который существует в вашей среде. Например, если `northamerica.corp.contoso.com` является дочерним доменом `corp.contoso.com`, будет создан сервер пересылки для DNS-серверов, связанных с `corp.contoso.com`. Этот параметр приведет к созданию серверов пересылки в `northamerica.corp.contoso.com`. |

## <a name="confirm-dns-forwarders"></a>Подтверждение серверов пересылки DNS
Перед проверкой успешности применения серверов пересылки DNS мы рекомендуем очистить кэш DNS на локальной рабочей станции с помощью `Clear-DnsClientCache`. Чтобы проверить, удается ли успешно разрешить полное доменное имя учетной записи хранения, используйте `Resolve-DnsName` или `nslookup`.

```powershell
# Replace storageaccount.file.core.windows.net with the appropriate FQDN for your storage account.
# Note the proper suffix (core.windows.net) depends on the cloud your deployed in.
Resolve-DnsName -Name storageaccount.file.core.windows.net
```

Если разрешение имен будет выполнено успешно, разрешенный IP-адрес будет совпадать с IP-адресом вашей учетной записи хранения.

```Output
Name                              Type   TTL   Section    NameHost
----                              ----   ---   -------    --------
storageaccount.file.core.windows. CNAME  29    Answer     csostoracct.privatelink.file.core.windows.net
net

Name       : storageaccount.privatelink.file.core.windows.net
QueryType  : A
TTL        : 1769
Section    : Answer
IP4Address : 192.168.0.4
```

Если вы уже настроили подключение VPN или ExpressRoute, вы также можете с помощью `Test-NetConnection` проверить возможность TCP-подключения к учетной записи хранения.

```PowerShell
Test-NetConnection -ComputerName storageaccount.file.core.windows.net -CommonTCPPort SMB
```

## <a name="see-also"></a>См. также раздел
- [Планирование развертывания службы файлов Azure](storage-files-planning.md)
- [Рекомендации по работе с сетями Файлов Azure](storage-files-networking-overview.md)
- [Настройка сетевых конечных точек Файлов Azure](storage-files-networking-endpoints.md)