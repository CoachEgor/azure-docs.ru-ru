---
title: Рекомендации по работе с сетями службы "Файлы Azure" | Документация Майкрософт
description: Общие сведения о параметрах сети службы "Файлы Azure".
author: roygara
ms.service: storage
ms.topic: overview
ms.date: 10/19/2019
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 596479652478bffb6d18a90fc53d5972b3839408
ms.sourcegitcommit: b45ee7acf4f26ef2c09300ff2dba2eaa90e09bc7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73126540"
---
# <a name="azure-files-networking-considerations"></a>Рекомендации по работе с сетями службы "Файлы Azure" 
Подключиться к общей папке Azure можно двумя способами:

- Осуществление доступа к общей папке напрямую по протоколу SMB или FileREST. Этот шаблон доступа в основном используется, когда необходимо исключить максимально возможное количество локальных серверов.
- Создание кэша общей папки Azure на локальном сервере со службой "Синхронизация файлов Azure" и осуществление доступа к данным общей папки с локального сервера по выбранному вами протоколу (SMB, NFS, FTPS и т. д.) для вашего варианта использования. Этот шаблон доступа удобен, так как представляет собой лучшее сочетание производительности, характерной для локальных сред, масштабируемости облачных служб и бессерверных присоединяемых служб, например Azure Backup.

Эта статья посвящена настройке сети в тех случаях, когда необходим доступ к общей папке Azure напрямую, а не с помощью службы "Синхронизация файлов Azure". Дополнительные сведения о рекомендациях по работе с сетями для развертывания службы "Синхронизация файлов Azure" см. в статье [Azure File Sync proxy and firewall settings](storage-sync-files-firewall-and-proxy.md) (Параметры прокси-сервера и брандмауэра службы "Синхронизация файлов Azure").

## <a name="storage-account-settings"></a>Параметры учетной записи хранения
Учетная запись хранения — это конструкция управления, представляющая собой общий пул носителей, который можно использовать для развертывания нескольких общих папок и других ресурсов хранения, например контейнеров больших двоичных объектов или очередей. Учетные записи хранения Azure предоставляют два основных набора параметров для защиты сети: шифрование при передаче, брандмауэры и виртуальные сети.

### <a name="encryption-in-transit"></a>Шифрование при передаче
По умолчанию для всех учетных записей хранения Azure включено шифрование при передаче. Это означает, что при подключении общей папки по протоколу SMB или доступе к ней по протоколу FileREST (например, с помощью портала Azure, PowerShell, CLI или пакетов SDK Azure) служба "Файлы Azure" разрешит подключение, только если оно установлено по протоколу SMB версии 3.0 или более поздней с шифрованием или по HTTPS. Клиенты, не поддерживающие SMB 3.0, или клиенты, поддерживающие SMB 3.0, но без шифрования SMB, не смогут подключать общую папку Azure, если включено шифрование при передаче. Дополнительные сведения о том, какие операционные системы поддерживают SMB 3.0 с шифрованием, см. в подробной документации по [Windows](storage-how-to-use-files-windows.md), [macOS](storage-how-to-use-files-mac.md) и [Linux](storage-how-to-use-files-linux.md). Все текущие версии PowerShell, CLI и пакетов SDK поддерживают протокол HTTPS.  

В учетной записи хранения Azure шифрование при передаче можно отключить. Если шифрование отключено, служба "Файлы Azure" также разрешает подключение по протоколу SMB 2.1, SMB 3.0 без шифрования и незашифрованные вызовы API FileREST по протоколу HTTP. Основная причина отключения шифрования при передаче заключается в поддержке устаревшего приложения, которое должно выполняться в более старой версии операционной системы, например Windows Server 2008 R2 или более старой версии Linux. Служба "Файлы Azure" разрешает только подключения по протоколу SMB 2.1 в том же регионе Azure, что и общая папка Azure. Клиент SMB 2.1 за пределами региона Azure общей папки Azure, например в локальной среде или в другом регионе Azure, не сможет получить доступ к общей папке.

Дополнительные сведения о шифровании при передаче см. в статье [Require secure transfer in Azure Storage](../common/storage-require-secure-transfer.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (Требование безопасной передачи в службе хранилища Azure).

### <a name="firewalls-and-virtual-networks"></a>Брандмауэры и виртуальные сети 
Брандмауэр — это политика сети, в которой запросам разрешен доступ к общим папкам Azure и другим ресурсам хранилища в вашей учетной записи хранения. Если учетная запись хранения создается с параметрами сети по умолчанию, она не ограничена определенной сетью и, следовательно, доступна в Интернете. Это не означает, что любой пользователь в Интернете сможет получить доступ к данным, хранящимся в общих папках Azure, размещенных в вашей учетной записи хранения. Вместо этого учетная запись хранения будет принимать авторизованные запросы из любой сети. Запросы могут быть авторизованы с помощью ключа учетной записи хранения, маркера подписанного URL-адреса (только FileREST) или с помощью субъекта-пользователя Active Directory. 

Для ограничения доступа к определенным IP-адресам или диапазонам или к виртуальной сети в учетной записи хранения может использоваться политика брандмауэра. Как правило, большинство политик брандмауэра для учетной записи хранения ограничивает сетевой доступ к виртуальной сети. 

[Виртуальная сеть](../../virtual-network/virtual-networks-overview.md) похожа на традиционную сеть, с которой вы будете работать в собственном центре обработки данных. Она позволяет создавать защищенный коммуникационный канал для взаимодействия таких ресурсов Azure, как общие папки Azure, виртуальные машины, Базы данных SQL и т. д. Как и в случае с учетной записью хранения Azure или виртуальной машиной Azure, виртуальная сеть — это ресурс Azure, развернутый в группе ресурсов. При дополнительной конфигурации сети виртуальные сети Azure также можно подключить к локальным.

При добавлении в виртуальную сеть таких ресурсов, как виртуальная машина Azure, виртуальный сетевой интерфейс (NIC), подключенный к виртуальной машине, ограничивается именно этой виртуальной сетью. Это возможно, так как виртуальные машины Azure являются виртуализированными компьютерами, на которых есть NIC. Виртуальные машины предлагаются в составе семейства продуктов Azure "инфраструктура как услуга" или IaaS. Так как общие папки Azure являются бессерверными, у них отсутствует NIC для добавления в виртуальную сеть. Иначе говоря, служба "Файлы Azure" предоставляется в составе семейства продуктов Azure "платформа как услуга" или PaaS. Чтобы учетная запись хранения была частью виртуальной сети, Azure поддерживает концепцию служб PaaS, именуемых конечными точками службы. Конечная точка службы позволяет службам PaaS быть частью виртуальной сети. Дополнительные сведения о конечных точках служб см. в статье [Virtual Network Service Endpoints](../../virtual-network/virtual-network-service-endpoints-overview.md) (Конечные точки служб для виртуальной сети).

Учетную запись хранения можно добавить в одну или несколько виртуальных сетей. Дополнительные сведения о том, как добавить учетную запись хранения в виртуальную сеть или настроить другие параметры брандмауэра, см. в статье [Configure Azure Storage firewalls and virtual networks](../common/storage-network-security.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (Настройка брандмауэров и виртуальных сетей службы хранилища Azure).

## <a name="azure-networking"></a>Сетевые подключения Azure
По умолчанию службы Azure, включая службу "Файлы Azure", доступны через Интернет. Так как по умолчанию трафик к вашей учетной записи хранения шифруется (и подключения SMB 2.1 никогда не разрешаются из-за пределов региона Azure), доступ к общим папкам Azure через Интернет по своей природе не может быть небезопасным. В зависимости от политики или уникальных нормативных требований организации вам может потребоваться более ограниченный обмен данными с Azure. Поэтому Azure предоставляет несколько способов ограничения трафика из-за пределов Azure в службу "Файлы Azure". Вы можете дополнительно защитить сеть при доступе к общей папке Azure с помощью следующих предложений служб:

- [VPN-шлюз Azure](../../vpn-gateway/vpn-gateway-about-vpngateways.md). VPN-шлюз — это особый тип шлюза виртуальной сети, используемый для отправки зашифрованного трафика между виртуальной сетью Azure и альтернативным расположением (например, в локальной среде) через Интернет. VPN-шлюз Azure — это ресурс Azure, который можно развернуть в группе ресурсов вместе с учетной записью хранения или другими ресурсами Azure. VPN-шлюзы предоставляют два разных типа подключений:
    - Подключения шлюза [VPN "точка — сеть" (P2S)](../../vpn-gateway/point-to-site-about.md), которые являются VPN-подключениями между Azure и отдельным клиентом. Это решение в первую очередь полезно для устройств, которые не являются частью локальной сети организации, например для сотрудников, которым требуется возможность подключать свои общие папки Azure из дома, кафе или отеля, находясь в дороге. Чтобы использовать VPN-подключение P2S к службе "Файлы Azure", необходимо настроить это подключение для каждого клиента, которому требуется подключиться. 
    - [VPN "сеть — сеть" (S2S)](../../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti), которые являются VPN-подключениями между Azure и сетью вашей организации. VPN-подключение S2S позволяет настроить VPN-подключение один раз для VPN-сервера или устройства, размещенного в сети организации, а не настраивать каждое клиентское устройство, которому требуется доступ к общей папке Azure.
- [ExpressRoute](../../expressroute/expressroute-introduction.md), который позволяет создать определенный маршрут между Azure и локальной сетью, которая не проходит через Интернет. Так как ExpressRoute предоставляет выделенный путь между локальным центром обработки данных и Azure, ExpressRoute может быть полезен там, где производительность сети имеет значение. ExpressRoute также является хорошим вариантом, если политика или нормативные требования вашей организации предполагают детерминированный путь к ресурсам в облаке.

## <a name="securing-access-from-on-premises"></a>Защита доступа из локальной среды 
При переносе общих папок общего назначения (например, документов Office, PDF, CAD и т. д.) в службу "Файлы Azure" пользователи, как правило, по-прежнему будут иметь доступ к своим файлам из локальных устройств, таких как рабочие станции, ноутбуки и планшеты. Основное преимущество общей папки общего назначения заключается в том, что локальные пользователи могут безопасно осуществлять доступ к ним через Интернет или глобальную сеть.

Самый простой способ получить доступ к общей папке Azure из локальной среды — открыть локальную сеть для порта 445 (порта, используемого SMB) и подключить UNC-путь, предоставленный на портале Azure. Для этого не требуются специальные сети. Многие клиенты настороженно относятся к открытию порта 445 из-за устаревших руководств по безопасности относительно протокола SMB 1.0, который корпорация Майкрософт считает небезопасным для использования в Интернете. В службе "Файлы Azure" протокол SMB 1.0 не используется. 

Протокол SMB 3.0 разработан как протокол для общих папок с явным требованием безопасного использования в Интернете. Поэтому с точки зрения компьютерных сетей при использовании SMB версии 3.0 и более поздней открытие порта 445 не отличается от открытия порта 443, используемого для HTTPS-подключений. Вместо блокировки порта 445 для предотвращения передачи незащищенного трафика по протоколу SMB 1.0 корпорация Майкрософт рекомендует сделать следующее.

> [!Important]  
> Даже если вы решили оставить порт 445 закрытым для исходящего трафика, корпорация Майкрософт по-прежнему рекомендует выполнить следующие действия для удаления протокола SMB 1.0 из среды.

1. Убедитесь, что протокол SMB 1.0 удален или отключен на устройствах вашей организации. Все поддерживаемые версии Windows и Windows Server поддерживают удаление и отключение протокола SMB 1.0. Кроме того, начиная с Windows 10 версии 1709 протокол SMB 1.0 по умолчанию не установлен в Windows. Дополнительные сведения об отключении протокола SMB 1.0 см. на страницах со сведениями о конкретной ОС:
    - [Обеспечение безопасности Windows или Windows Server](storage-how-to-use-files-windows.md#securing-windowswindows-server).
    - [Обеспечение безопасности Linux](storage-how-to-use-files-linux.md#securing-linux).
1. Убедитесь, что ни для одного из продуктов в вашей организации не требуется протокол SMB 1.0, и удалите те из них, для которых он требуется. Мы поддерживаем [расчетную палату продуктов SMB1](https://aka.ms/stillneedssmb1), которая содержит все собственные продукты корпорации Майкрософт и сторонние продукты, известные корпорации Майкрософт, для которых требуется SMB 1.0. 
1. (Необязательно.) Используйте брандмауэр стороннего производителя в локальной сети организации, чтобы предотвратить передачу трафика по протоколу SMB 1.0.

Если согласно политике или нормативному требованию вашей организации требуется, чтобы порт 445 был заблокирован, можно туннелировать трафик через порт 443 с помощью VPN-шлюза Azure или ExpressRoute. Дополнительные сведения о конкретных действиях по развертыванию см. на страницах с инструкциями по настройке:
- [Настройка VPN-подключения "сеть — сеть" (S2S) для использования с Файлами Azure](storage-files-configure-s2s-vpn.md)
- [Настройка VPN-подключения "точка — сеть" (P2S) в Windows для использования с Файлами Azure](storage-files-configure-p2s-vpn-windows.md)
- [Настройка VPN-подключения "точка — сеть" (P2S) в Linux для использования с Файлами Azure](storage-files-configure-p2s-vpn-linux.md)

В организации могут быть дополнительные требования, заключающиеся в том, что трафик, исходящий из локального сайта, должен проходить по детерминированному пути к ресурсам в облаке. В этом случае ExpressRoute может удовлетворить это требование.

## <a name="securing-access-from-cloud-resources"></a>Защита доступа из облачных ресурсов
Как правило, когда локальное приложение ликвидируется и перемещается в облако, в то же время перемещается приложение и его данные. Это означает, что основным фактором для миграции по методике lift-and-shift является блокировка доступа к общей папке Azure и предоставление доступа только конкретным виртуальным машинам или службам Azure, которым требуется доступ к общей папке для работы. 

Вы можете использовать виртуальные сети, чтобы ограничить виртуальные машины или другие ресурсы Azure, которые могут устанавливать сетевые подключения (подключения SMB или вызовы REST API в общую папку Azure). Если в вашу учетную запись хранения разрешен незашифрованный трафик, мы рекомендуем поместить общую папку Azure в виртуальную сеть. В противном случае, принимая решение об использовании виртуальных сетей, следует руководствоваться бизнес-требованиями и политикой организации.

Основной причиной разрешения передачи незашифрованного трафика в общую папку Azure является поддержка Windows Server 2008 R2, Windows 7 или другой более старой ОС, осуществляющей доступ к общей папке Azure по протоколу SMB 2.1 (или SMB 3.0 без шифрования для некоторых дистрибутивов Linux). Мы не рекомендуем использовать SMB 2.1 или SMB 3.0 без шифрования в операционных системах, поддерживающих SMB версии 3.0 и выше с шифрованием.

## <a name="see-also"></a>См. также
- [Общие сведения о Файлах Azure](storage-files-introduction.md)
- [Планирование развертывания службы файлов Azure](storage-files-planning.md)