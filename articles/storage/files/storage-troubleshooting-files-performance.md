---
title: Руководство по устранению неполадок с производительностью файлов Azure
description: Устранение известных проблем с производительностью файловых ресурсов Azure. Выявлять потенциальные причины и связанные с ними обходные пути при обнаружении этих проблем.
author: gunjanj
ms.service: storage
ms.topic: troubleshooting
ms.date: 09/15/2020
ms.author: gunjanj
ms.subservice: files
ms.openlocfilehash: 9dfdbbd982503acc063ff88c74dfccde8677eaac
ms.sourcegitcommit: 8a1ba1ebc76635b643b6634cc64e137f74a1e4da
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2020
ms.locfileid: "94380238"
---
# <a name="troubleshoot-azure-files-performance-issues"></a>Устранение проблем с производительностью файлов Azure

В этой статье перечислены некоторые распространенные проблемы, связанные с файловыми ресурсами Azure. Он предоставляет потенциальные причины и способы их решения при обнаружении этих проблем.

## <a name="high-latency-low-throughput-and-general-performance-issues"></a>Высокая задержка, низкая пропускная способность и общие проблемы производительности

### <a name="cause-1-share-was-throttled"></a>Причина 1: ресурс был отрегулирован

Запросы регулируются при достижении предельных значений операций ввода-вывода, входящих или исходящих данных для общей папки. Сведения об ограничениях для файловых ресурсов уровня "Стандартный" и "Премиум" см. в разделе Общие папки [и целевые объекты масштабирования файлов](https://docs.microsoft.com/azure/storage/files/storage-files-scale-targets#file-share-and-file-scale-targets).

Чтобы убедиться, что ваша общая папка регулируется, можно использовать метрики Azure на портале.

1. Войдите в свою учетную запись хранения на портале Azure.

1. В меню слева в разделе **мониторинг** выберите **метрики**.

1. Выберите **файл** в качестве пространства имен метрик для своей области учетной записи хранения.

1. Выберите **транзакции** в качестве метрики.

1. Добавьте фильтр для **ResponseType** и проверьте, есть ли в запросах код ответа **СУКЦЕССВИССРОТТЛИНГ** (для SMB) или **ClientThrottlingError** (для остальных).

![Параметры метрик для Premium общие папки](media/storage-troubleshooting-premium-fileshares/metrics.png)

> [!NOTE]
> Чтобы получать оповещение в случае регулирования общей папки, см. статью [Создание оповещения при регулировании](#how-to-create-an-alert-if-a-file-share-is-throttled)общей папки.

### <a name="solution"></a>Решение

- Если используется стандартный общий файловый ресурс, включите [большие файловые ресурсы](https://docs.microsoft.com/azure/storage/files/storage-files-how-to-create-large-file-share?tabs=azure-portal) в учетной записи хранения. Большие файловые ресурсы поддерживают до 10 000 операций ввода-вывода в секунду на общую папку.
- Если вы используете файловый ресурс уровня "Премиум", увеличьте размер подготовленной общей папки, чтобы увеличить ограничение числа операций ввода-вывода в секунду. Дополнительные сведения см. в разделе [Общие сведения о подготовке к использованию файловых ресурсов Premium](https://docs.microsoft.com/azure/storage/files/storage-files-planning#understanding-provisioning-for-premium-file-shares) статьи Планирование работы с файлами Azure.

### <a name="cause-2-metadatanamespace-heavy-workload"></a>Причина 2. интенсивная рабочая нагрузка метаданных или пространства имен

Если большая часть ваших запросов является ориентированной на метаданные (например, CreateFile/OpenFile/клосефиле/куеринфо/куеридиректори), то задержка будет хуже по сравнению с операциями чтения и записи.

Чтобы убедиться, что большая часть ваших запросов является ориентированной на метаданные, можно использовать те же действия, что и выше. Кроме того, вместо добавления фильтра для **ResponseType** добавьте фильтр для **имени API**.

![Фильтр по имени API в метриках](media/storage-troubleshooting-premium-fileshares/MetadataMetrics.png)

### <a name="workaround"></a>Обходной путь

- Проверьте, можно ли изменить приложение, чтобы сократить количество операций с метаданными.
- Добавьте виртуальный жесткий диск в общую папку и подключите к нему виртуальный жесткий диск по протоколу SMB, чтобы выполнять операции с файлами. Этот подход работает для одного модуля записи и нескольких сценариев чтения и позволяет локальным операциям с метаданными обеспечить производительность, похожую на локальное хранилище с прямым подключением.

### <a name="cause-3-single-threaded-application"></a>Причина 3. однопотоковое приложение

Если приложение, используемое клиентом, является однопотоковым, это может привести к значительному снижению количества операций ввода-вывода в секунду и пропускной способности, чем максимально возможное значение в зависимости от размера подготовленного общего ресурса.

### <a name="solution"></a>Решение

- Увеличьте параллелизм приложений, увеличив число потоков.
- Переключитесь на приложения, где возможно параллелизм. Например, для операций копирования клиенты могут использовать AzCopy или Robocopy из клиентов Windows или **параллельную** команду на клиентах Linux.

## <a name="very-high-latency-for-requests"></a>Очень высокая задержка для запросов

### <a name="cause"></a>Причина

Виртуальная машина клиента может находиться в другом регионе, чем общая папка.

### <a name="solution"></a>Решение

- Запустите приложение из виртуальной машины, расположенной в том же регионе, что и общая папка.

## <a name="client-unable-to-achieve-maximum-throughput-supported-by-the-network"></a>Клиенту не удалось достичь максимальной пропускной способности, поддерживаемой сетью

Одной из возможных причин этого является отсутствие поддержки нескольких каналов SMB. Сейчас файловые ресурсы Azure поддерживают только один канал, поэтому между клиентской виртуальной машиной и сервером существует только одно подключение. Это отдельное подключение привязано к одному ядру на клиентской виртуальной машине, поэтому максимальная пропускная способность, достижимая с виртуальной машины, ограничивается одним ядром.

### <a name="workaround"></a>Обходной путь

- Получение виртуальной машины с большим количеством ядер может помочь повысить пропускную способность.
- Запуск клиентского приложения с нескольких виртуальных машин увеличит пропускную способность.

- По возможности используйте API-интерфейсы RESTFUL.

## <a name="throughput-on-linux-clients-is-significantly-lower-when-compared-to-windows-clients"></a>Пропускная способность клиентов Linux значительно ниже по сравнению с клиентами Windows.

### <a name="cause"></a>Причина

Это известная проблема с реализацией клиента SMB в Linux.

### <a name="workaround"></a>Обходной путь

- Распределите нагрузку между несколькими виртуальными машинами.
- На той же виртуальной машине используйте несколько точек подключения с параметром **ношаресокк** и Распределите нагрузку между этими точками подключения.
- В Linux попробуйте выполнить подключение с параметром **ностриктсинк** , чтобы избежать принудительного сброса SMB при каждом вызове **фсинк** . Для файлов Azure этот параметр не влияет на согласованность данных, но может привести к устаревшим метаданным файлов в листинге каталога (команда **ls-l** ). При непосредственном запросе метаданных файла (команда **stat** ) будут возвращены наиболее актуальные метаданные файла.

## <a name="high-latencies-for-metadata-heavy-workloads-involving-extensive-openclose-operations"></a>Высокие задержки для интенсивных рабочих нагрузок метаданных, включающих обширные операции открытия/закрытия.

### <a name="cause"></a>Причина

Отсутствие поддержки аренды каталогов.

### <a name="workaround"></a>Обходной путь

- По возможности Избегайте чрезмерного открытия или закрытия одного и того же каталога в течение короткого периода времени.
- Для виртуальных машин Linux увеличьте время ожидания кэша записи каталога, указав **актимео = \<sec>** в качестве параметра подключения. По умолчанию это одна секунда, поэтому может помочь большее значение, например три или пять.
- Для виртуальных машин Linux обновите ядро до 4,20 или более поздней версии.

## <a name="low-iops-on-centosrhel"></a>Низкие операции ввода-вывода в CentOS/RHEL

### <a name="cause"></a>Причина

Глубина ввода-вывода больше единицы не поддерживается в CentOS/RHEL.

### <a name="workaround"></a>Обходной путь

- Обновите до CentOS 8 или RHEL 8.
- Измените на Ubuntu.

## <a name="slow-file-copying-to-and-from-azure-files-in-linux"></a>Медленное копирование файлов в службе файлов Azure и из нее в Linux

Если вы испытываете медленное копирование файлов в файлы Azure и из них, ознакомьтесь с разделом [медленное копирование файлов в службу файлов Azure в Linux](storage-troubleshoot-linux-file-connection-problems.md#slow-file-copying-to-and-from-azure-files-in-linux) в разделе Руководство по устранению неполадок Linux.

## <a name="jitterysaw-tooth-pattern-for-iops"></a>Нарушение или Bluetooth шаблона для операций ввода-вывода

### <a name="cause"></a>Причина

Клиентское приложение постоянно превышает базовые показатели операций ввода-вывода. В настоящее время отсутствует сглаживание запроса на стороне службы, поэтому, если клиент превышает базовые операции ввода-вывода, он будет регулироваться службой. Такое регулирование может привести к тому, что клиент пойдет в Bluetooth последовательность операций ввода-вывода. В этом случае среднее число операций ввода-вывода в секунду, достигнутое клиентом, может быть ниже, чем базовые операции ввода-вывода.

### <a name="workaround"></a>Обходной путь

- Сократите нагрузку на запрос от клиентского приложения, чтобы общая папка не была отрегулирована.
- Увеличьте квоту общей папки, чтобы она не нарегулироваться.

## <a name="excessive-directoryopendirectoryclose-calls"></a>Чрезмерные вызовы Директорйопен/Директориклосе

### <a name="cause"></a>Причина

Если число вызовов Директорйопен/Директориклосе является частью основных вызовов API и вы не предполагаете, что клиент будет выполнять много вызовов, это может быть вызвано проблемой с антивирусной программой, установленной на виртуальной машине клиента Azure.

### <a name="workaround"></a>Обходной путь

- Исправление для этой проблемы доступно в [апреле-обновлении платформы для Windows](https://support.microsoft.com/help/4052623/update-for-windows-defender-antimalware-platform).

## <a name="file-creation-is-slower-than-expected"></a>Создание файла выполняется медленнее, чем ожидалось

### <a name="cause"></a>Причина

Рабочие нагрузки, которые опираются на создание большого количества файлов, не увидят существенного различия между производительностью файловых ресурсов класса Premium и стандартными файловыми ресурсами.

### <a name="workaround"></a>Обходной путь

- Отсутствует.

## <a name="slow-performance-from-windows-81-or-server-2012-r2"></a>Снижение производительности Windows 8.1 или сервера 2012 R2

### <a name="cause"></a>Причина

Больше ожидаемой задержки при доступе к файлам Azure для рабочих нагрузок с интенсивным вводом-выводом.

### <a name="workaround"></a>Обходной путь

- Установите доступное [исправление](https://support.microsoft.com/help/3114025/slow-performance-when-you-access-azure-files-storage-from-windows-8-1).

## <a name="how-to-create-an-alert-if-a-file-share-is-throttled"></a>Создание оповещения в случае регулирования общей папки

1. Перейдите к своей **учетной записи хранения** в **портал Azure**.
2. В разделе Мониторинг щелкните **оповещения** , а затем — **+ новое правило генерации оповещений**.
3. Щелкните **изменить ресурс** , выберите **тип файлового ресурса** для учетной записи хранения и нажмите кнопку **Готово**. Например, если имя учетной записи хранения — Contoso, выберите ресурс Contoso/File.
4. Нажмите кнопку **Выбрать условие** , чтобы добавить условие.
5. Вы увидите список сигналов, поддерживаемых для учетной записи хранения, и выберите метрику **транзакции** .
6. В колонке **Настройка логики сигнала** щелкните раскрывающийся список **имя измерения** и выберите **тип ответа**.
7. Щелкните раскрывающийся список **значения измерения** и выберите **СУКЦЕССВИССРОТТЛИНГ** (для SMB) или **ClientThrottlingError** (для остальных).

   > [!NOTE]
   > Если значение измерения Сукцессвиссроттлинг или ClientThrottlingError отсутствует в списке, это означает, что ресурс не был отрегулирован. Чтобы добавить значение измерения, щелкните **Добавить пользовательское значение** рядом с раскрывающимся списком **значения измерений** , **введите сукцессвиссроттлинг** или **ClientThrottlingError** , нажмите кнопку **ОК** , а затем повторите шаг #7.

8. Щелкните раскрывающийся список **имя измерения** и выберите **файловый ресурс**.
9. Щелкните раскрывающийся список **значения измерений** и выберите Общие папки, по которым необходимо создать оповещение.

   > [!NOTE]
   > Если общий файловый ресурс является стандартным общим ресурсом, выберите **все текущие и будущие значения**. В раскрывающемся списке значения измерений не будут перечислены общие папки, так как метрики для общего ресурса недоступны для стандартных файловых ресурсов. Предупреждения регулирования для стандартных файловых ресурсов будут активированы, если какая-либо общая папка в учетной записи хранения регулируется, а предупреждение не определит, какой файловый ресурс был отрегулирован. Так как метрики для общего ресурса недоступны для стандартных файловых ресурсов, рекомендуется использовать одну общую папку для каждой учетной записи хранения.

10. Определите **Параметры оповещения** (пороговое значение, оператор, гранулярность агрегирования и частоту оценки) и нажмите кнопку **Готово**.

    > [!TIP]
    > При использовании статического порога диаграмма метрик может помочь определить разумное пороговое значение, если общая папка в данный момент регулируется. Если используется динамическое пороговое значение, на диаграмме метрики будут отображаться рассчитанные пороговые значения на основе последних данных.

11. Щелкните **выбрать группу действий** , чтобы добавить **группу действий** (электронную почту, SMS и т. д.) в предупреждение, выбрав существующую группу действий или создав новую группу действий.
12. Заполните **сведения о предупреждении** , такие как **имя правила оповещения** , **Описание** и **серьезность**.
13. Щелкните **создать правило генерации оповещений** , чтобы создать оповещение.

Дополнительные сведения о настройке оповещений в Azure Monitor см. в разделе [Обзор оповещений в Microsoft Azure]( https://docs.microsoft.com/azure/azure-monitor/platform/alerts-overview).

## <a name="how-to-create-alerts-if-a-premium-file-share-is-trending-towards-being-throttled"></a>Создание оповещений в случае регулирования общего файлового ресурса уровня "Премиум"

1. Перейдите к своей **учетной записи хранения** в **портал Azure**.
2. В разделе Мониторинг щелкните **оповещения** , а затем — **+ новое правило генерации оповещений**.
3. Щелкните **изменить ресурс** , выберите **тип файлового ресурса** для учетной записи хранения и нажмите кнопку **Готово**. Например, если имя учетной записи хранения — Contoso, выберите ресурс Contoso/File.
4. Нажмите кнопку **Выбрать условие** , чтобы добавить условие.
5. Вы увидите список сигналов, поддерживаемых для учетной записи хранения, и выберите метрику исходящего **трафика** .

   > [!NOTE]
   > Необходимо создать три отдельных предупреждения, которые будут получать оповещения, когда количество входящих, исходящих или транзакций превышает установленное пороговое значение. Это связано с тем, что предупреждение срабатывает только при соблюдении всех условий. Поэтому, если все условия помещаются в одно оповещение, будет выдаваться предупреждение только в случае превышения пороговых значений для входящих, исходящих и транзакций.

6. Прокрутите страницу вниз. Щелкните раскрывающийся список **имя измерения** и выберите **файловый ресурс**.
7. Щелкните раскрывающийся список **значения измерений** и выберите Общие папки, по которым необходимо создать оповещение.
8. Определите **Параметры оповещения** (пороговое значение, оператор, гранулярность агрегирования и частоту оценки) и нажмите кнопку **Готово**.

   > [!NOTE]
   > Метрики исходящих, входящих и транзакций задаются в минуту, хотя вы подготавливаете исходящие, входящие и исходящие операции ввода-вывода в секунду. (Узнайте о степени детализации статистической обработки — > в минуту = более шумный, поэтому выберите diff один). Поэтому, например, если подготовленный исходящий трафик составляет 90 MiB/с и вы хотите, чтобы порог был 80% от подготовленного исходящего трафика, следует выбрать следующие параметры оповещения: 75497472 для **порогового значения** , больше или равно для **оператора** и среднее для **типа агрегирования**. В зависимости от того, насколько шумным требуется оповещение, можно выбрать, какие значения следует выбрать для детализации статистической обработки и частоты оценки. Например, если мне нужно, чтобы мое оповещение пропускало среднее значение за период времени в час, а я хотел, чтобы правило генерации оповещений выполнялось каждый час, я бы выбрали 1 час для **детализации статистической обработки** и 1 час для **частоты вычисления**.

9. Щелкните **выбрать группу действий** , чтобы добавить **группу действий** (электронную почту, SMS и т. д.) в предупреждение, выбрав существующую группу действий или создав новую группу действий.
10. Заполните **сведения о предупреждении** , такие как **имя правила оповещения** , **Описание** и **серьезность**.
11. Щелкните **создать правило генерации оповещений** , чтобы создать оповещение.

    > [!NOTE]
    > Чтобы получать уведомления о том, что файловый ресурс уровня "Премиум" близок к регулированию из-за подготовленного входящего трафика, выполните те же действия, за исключением шага 5, **выберите метрику** входящего трафика.

    > [!NOTE]
    > Чтобы получать уведомления о том, что общая папка уровня "Премиум" находится в состоянии, близкой к регулированию из-за подготовленных операций ввода/вывода, потребуется внести несколько изменений. На шаге 5 Выберите вместо этого метрику **транзакции** . Кроме того, для шага 10 единственным параметром для **типа агрегирования** является Total. Таким образом, пороговое значение будет зависеть от выбранной степени детализации статистической обработки. Например, если требуется, чтобы порог был 80% подготовленных базовых операций ввода-вывода, а для **гранулярности статистической обработки** выбрано 1 час, то **пороговое значение** будет равно базовому значению операций ввода-вывода (в байтах) x 0,8 x 3600. Помимо этих изменений, выполните те же действия, которые перечислены выше. 

Дополнительные сведения о настройке оповещений в Azure Monitor см. в разделе [Обзор оповещений в Microsoft Azure]( https://docs.microsoft.com/azure/azure-monitor/platform/alerts-overview).

## <a name="see-also"></a>См. также раздел
* [Устранение неполадок службы файлов Azure в Windows](storage-troubleshoot-windows-file-connection-problems.md)
* [Устранение неполадок службы файлов Azure в Linux](storage-troubleshoot-linux-file-connection-problems.md)
* [Часто задаваемые вопросы о службе файлов Azure](storage-files-faq.md)
