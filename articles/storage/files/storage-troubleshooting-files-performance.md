---
title: Руководство по устранению неполадок ВИО Лазурных файлов
description: Известные проблемы с производительностью с файлами Azure и связанными обходными путями.
author: gunjanj
ms.service: storage
ms.topic: conceptual
ms.date: 04/25/2019
ms.author: gunjanj
ms.subservice: files
ms.openlocfilehash: 09e55abcd97317b87f8a272afa51c6b4ace572e8
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77598091"
---
# <a name="troubleshoot-azure-files-performance-issues"></a>Проблемы устранения проблем в работе файлов Azure

В этой статье перечислены некоторые распространенные проблемы, связанные с акциями файлов Azure. Он обеспечивает потенциальные причины и обходные пути, когда эти проблемы встречаются.

## <a name="high-latency-low-throughput-and-general-performance-issues"></a>Высокая задержка, низкая пропускная способность и общие проблемы с производительностью

### <a name="cause-1-share-experiencing-throttling"></a>Причина 1: Доля испытывают регулирования

По умолчанию квота на премиальную акцию составляет 100 GiB, что обеспечивает 100 базовых IOPS (с потенциалом лопнуть до 300 в течение часа). Для получения дополнительной информации о подготовке и ее связи с IOPS, [см.](storage-files-planning.md#understanding-provisioning-for-premium-file-shares)

Чтобы подтвердить, задушилась ли ваша доля, вы можете использовать Azure Metrics на портале.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Выберите **все службы,** а затем поиск **метрики.**

1. Выберите **метрики**.

1. Выберите учетную запись хранения в качестве ресурса.

1. Выберите **файл** в качестве метрики пространства имен.

1. Выберите **транзакции** в качестве метрики.

1. Добавьте фильтр для **ResponseType** и проверьте, есть ли у запросов код ответа **SuccessWithThrottling** (для SMB) или **ClientThrottlingError** (для REST).

![Параметры метрик для премиум-файлошерных файлов](media/storage-troubleshooting-premium-fileshares/metrics.png)

> [!NOTE]
> Чтобы получить оповещение, если доля файла задушена, [см. Как создать оповещение, если доля файла задушена.](#how-to-create-an-alert-if-a-file-share-is-throttled)

### <a name="solution"></a>Решение

- Увеличьте емкость, подготовленную к акции, указав более высокую квоту на свою долю.

### <a name="cause-2-metadatanamespace-heavy-workload"></a>Причина 2: Метаданные /пространство имен большой нагрузки

Если большинство ваших запросов ориентированы на метаданные (например, createfile/openfile/closefile/queryinfo/querydirector/querydirectory), то задержка будет хуже по сравнению с операциями чтения/записи.

Чтобы подтвердить, что большинство запросов ориентированы на метаданные, можно использовать те же шаги, что и выше. За исключением вместо добавления фильтра для **ResponseType,** добавьте фильтр для **API Name.**

![Фильтр для имени API в метриках](media/storage-troubleshooting-premium-fileshares/MetadataMetrics.png)

### <a name="workaround"></a>Обходной путь

- Проверьте, можно ли модифицировать приложение, чтобы уменьшить количество операций метаданных.
- Добавьте VHD на долю файла и установите VHD над SMB от клиента для выполнения операций файлов против данных. Этот подход работает для одного писателя и нескольких сценариев читателей и позволяет операциям метаданных быть локальными, предлагая производительность, аналогичную локальному непосредственному хранению.

### <a name="cause-3-single-threaded-application"></a>Причина 3: Однопоточное приложение

Если используемое клиентом приложение является однопониматным, это может привести к значительно более низкому IOPS/пропускному способу, чем максимально возможное на основе вашего размера общего участия.

### <a name="solution"></a>Решение

- Увеличьте параллелизм приложений, увеличив количество потоков.
- Переключитесь на приложения, где возможен параллелизм. Например, для операций копирования клиенты могут использовать AzCopy или RoboCopy от клиентов Windows или **параллельную** команду на клиентах Linux.

## <a name="very-high-latency-for-requests"></a>Очень высокая задержка запросов

### <a name="cause"></a>Причина

Клиент VM может находиться в другом регионе, чем доля файлов.

### <a name="solution"></a>Решение

- Выполнить приложение из VM, который находится в том же регионе, что и доля файлов.

## <a name="client-unable-to-achieve-maximum-throughput-supported-by-the-network"></a>Клиент не может достичь максимальной пропускной связи, поддерживаемой сетью

Одной из потенциальных причин этого является отсутствие fo SMB многоканальной поддержки. В настоящее время файл Azure имеет только поддержку одного канала, поэтому существует только одно соединение от клиента VM к серверу. Это единое соединение привязано к одному ядру на клиентском VM, поэтому максимальная пропускная связь, достижимая от VM, связана одним ядром.

### <a name="workaround"></a>Обходной путь

- Получение VM с большим ядром может помочь улучшить пропускную работу.
- Запуск клиентского приложения с нескольких VMs увеличит пропускную связь.

- Используйте REST AIS, где это возможно.

## <a name="throughput-on-linux-clients-is-significantly-lower-when-compared-to-windows-clients"></a>По сравнению с клиентами Windows пропускная высочатся на клиентах Linux значительно ниже.

### <a name="cause"></a>Причина

Это известная проблема с реализацией клиента SMB на Linux.

### <a name="workaround"></a>Обходной путь

- Распределите нагрузку по нескольким ВМ.
- На том же VM используйте несколько точек крепления с опцией **nosharesock** и распределите нагрузку по этим точкам крепления.
- На Linux, попробуйте монтаж с **опцией nostrictsync,** чтобы избежать принуждения SMB флеш на каждом вызове **fsync.** Для Azure Files эта опция не препятствует согласованности данных, но может привести к устаревшей метадатке файлов в списке каталогов **(ls -l** команда). Непосредственно запрос метаданных файла **(команда stat)** вернет самые актуальные метаданные файлов.

## <a name="high-latencies-for-metadata-heavy-workloads-involving-extensive-openclose-operations"></a>Высокие просачивые данные для интенсивных рабочих нагрузок метаданных, связанных с обширными операциями открытого/близкого закрытия.

### <a name="cause"></a>Причина

Отсутствие поддержки для аренды каталога.

### <a name="workaround"></a>Обходной путь

- Если это возможно, избегайте чрезмерного открытия/закрытия ручки на том же каталоге в течение короткого периода времени.
- Для Linux VMs увеличьте тайм-аут входа в каталог, указав **>actimeo\<sec** в качестве опции крепления. По умолчанию, это одна секунда, так что большее значение, как три или пять может помочь.
- Для Linux VMs обновите ядро до 4,20 или выше.

## <a name="low-iops-on-centosrhel"></a>Низкий IOPS на CentOS/RHEL

### <a name="cause"></a>Причина

Глубина IO больше, чем одна не поддерживается на CentOS/RHEL.

### <a name="workaround"></a>Обходной путь

- Обновление до CentOS 8 / RHEL 8.
- Переход на Улунту.

## <a name="slow-file-copying-to-and-from-azure-files-in-linux"></a>Медленное копирование файлов в службе файлов Azure и из нее в Linux

Если вы испытываете медленное копирование файлов в и из файлов Azure, взгляните на [медленное копирование файлов в и из Azure Files в](storage-troubleshoot-linux-file-connection-problems.md#slow-file-copying-to-and-from-azure-files-in-linux) разделе Linux в руководстве по устранению неполадок Linux.

## <a name="jitterysaw-tooth-pattern-for-iops"></a>Дрожание/пила-зубшаблон для IOPS

### <a name="cause"></a>Причина

Клиентское приложение постоянно превышает базовый IOPS. В настоящее время нет сервисной стороны сглаживания нагрузки запроса, поэтому, если клиент превышает базовый IOPS, он будет задушен службой. Такое регулирование может привести к тому, что клиент будет испытывать нервную модель IOPS. В этом случае средний IOPS, достигнутый клиентом, может быть ниже базового IOPS.

### <a name="workaround"></a>Обходной путь

- Уменьшите нагрузку запроса из клиентского приложения, чтобы доля не задушилась.
- Увеличьте квоту доли, чтобы доля не задушилась.

## <a name="excessive-directoryopendirectoryclose-calls"></a>Чрезмерные вызовы DirectoryOpen/DirectoryClose

### <a name="cause"></a>Причина

Если число вызовов DirectoryOpen/DirectoryClose входит в число лучших вызовов API, и вы не ожидаете, что клиент будет делать так много звонков, это может быть проблема с антивирусом, установленным на клиенте Azure VM.

### <a name="workaround"></a>Обходной путь

- Исправление этой проблемы доступно в [апрельском обновлении платформы для Windows.](https://support.microsoft.com/help/4052623/update-for-windows-defender-antimalware-platform)

## <a name="file-creation-is-slower-than-expected"></a>Создание файлов происходит медленнее, чем ожидалось

### <a name="cause"></a>Причина

Рабочие нагрузки, которые полагаются на создание большого количества файлов, не увидят существенной разницы между производительностью премиальных файловых акций и стандартных файлов.

### <a name="workaround"></a>Обходной путь

- Нет.

## <a name="slow-performance-from-windows-81-or-server-2012-r2"></a>Медленная производительность от Windows 8.1 или Сервер 2012 R2

### <a name="cause"></a>Причина

Более высокая, чем ожидалось, задержка доступа к файлам Azure для интенсивных рабочих нагрузок.

### <a name="workaround"></a>Обходной путь

- Установите доступный [hotfix](https://support.microsoft.com/help/3114025/slow-performance-when-you-access-azure-files-storage-from-windows-8-1).

## <a name="how-to-create-an-alert-if-a-file-share-is-throttled"></a>Как создать оповещение, если доля файла задушена

1. На [портале Azure](https://portal.azure.com)нажмите на **монитор**. 

2. Нажмите **оповещения,** а затем нажмите **кнопку «Новое правило оповещения».**

3. Нажмите **Выберите,** чтобы выбрать **учетную запись хранения / файл ресурс,** который содержит долю файла, что вы хотите предупредить, а затем нажмите **Готово.** Например, если имя учетной записи хранилища является contoso, выберите ресурс contoso/file.

4. Нажмите **Добавить,** чтобы добавить условие.

5. Вы увидите список сигналов, поддерживаемых для учетной записи хранилища, выберите метрику **транзакций.**

6. На лезвии **логики сигнала Настройки** перейдите в измерение **типа «Ответ»,** щелкните **по значениям измерения** и выберите **SuccessWithThrottling** (для SMB) или **ClientThrottlingError** (для REST). 

  > [!NOTE]
  > Если значение измерения SuccessWithThrottling или ClientThrottlingError не перечислено, это означает, что ресурс не был задушен.  Чтобы добавить значение измерения, **+** щелкните рядом с **значениями измерения** drop-down, введите **SuccessWithThrottling** или **ClientThrottlingError,** нажмите **OK,** а затем повторите шаг #6.

7. Перейдите в измерение **обмена** **файлами,** щелкните значение измерения и выберите раздел файла (ы), о которых вы хотите предупредить. 

  > [!NOTE]
  > Если доля файла является стандартной долей файла, то значение измерения будет пустым, поскольку метрики на одну акцию недоступны для стандартных файлов. Сигналы о стандартных файловых долях будут срабатывать, если какая-либо доля файлов в учетной записи хранилища будет задушена и оповещение не определит, какая доля файлов была задушена. Поскольку метрики на одну акцию недоступны для стандартных файлов, рекомендация состоит в том, чтобы иметь одну долю файла на счет хранения. 

8. Определите **параметры оповещения** (порог, оператор, детализация агрегации и частота), которые используются для оценки правила предупреждения метрики и нажмите **Готово.**

  > [!TIP]
  > Если вы используете статический порог, метрическая диаграмма может помочь определить разумный порог, если доля файла в настоящее время задушена. Если вы используете динамический порог, метрическая диаграмма будет отображать рассчитанные пороги на основе последних данных.

9. Добавьте **группу действий** (электронная почта, SMS и т.д.) к предупреждению, выбрав существующую группу действий или создав новую группу действий.

10. Заполните **сведения оповещения,** такие как **название правила оповещения,** **Описание** и **серьезность.**

11. Нажмите **Создать правило оповещения** для создания оповещения.

Чтобы узнать больше о настройке оповещений в Azure Monitor, [см.]( https://docs.microsoft.com/azure/azure-monitor/platform/alerts-overview)
