---
title: Планирование развертывания службы "Синхронизация файлов Azure" | Документация Майкрософт
description: Узнайте, что необходимо учесть при планировании развертывания службы "Файлы Azure".
services: storage
author: roygara
ms.service: storage
ms.topic: article
ms.date: 2/7/2019
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: f29625ed8ddd6eabf8b75380d84d7a7b64396d7a
ms.sourcegitcommit: 37343b814fe3c95f8c10defac7b876759d6752c3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/24/2019
ms.locfileid: "63766864"
---
# <a name="planning-for-an-azure-file-sync-deployment"></a>Планирование развертывания службы синхронизации файлов Azure
Используйте службу "Синхронизация файлов Azure", чтобы централизованно хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования Windows Server в быстрый кэш общего файлового ресурса Azure. Для локального доступа к данным вы можете использовать любой протокол, доступный в Windows Server, в том числе SMB, NFS и FTPS. Кроме того, вы можете создать любое количество кэшей в любом регионе.

В этой статье описываются важные сведения о развертывании службы "Синхронизация файлов Azure". Мы также рекомендуем ознакомиться со статьей [Планирование развертывания службы файлов Azure](storage-files-planning.md). 

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="azure-file-sync-terminology"></a>Терминология службы синхронизации файлов Azure
Прежде чем углубиться в аспекты планирования развертывания службы синхронизации файлов Azure, очень важно понимать терминологию.

### <a name="storage-sync-service"></a>Служба синхронизации хранилища
Служба синхронизации хранилища — это ресурс Azure верхнего уровня для службы синхронизации файлов Azure. Ресурс службы синхронизации хранилища является одноранговым в отношении ресурса учетной записи хранения, поэтому его можно развернуть в группах ресурсов Azure. Необходим отдельный ресурс верхнего уровня в ресурсе учетной записи хранения, так как служба синхронизации хранилища может создавать синхронизированные связи с несколькими учетными записями хранения через несколько групп синхронизации. В подписке может быть развернуто несколько ресурсов служб синхронизации хранилища.

### <a name="sync-group"></a>Группа синхронизации
Группа синхронизации определяет топологию синхронизации для набора файлов. Конечные точки в группе синхронизации синхронизируются. Если, например, есть два отдельных набора файлов, которыми можно управлять с помощью службы "Синхронизация файлов Azure", следует создать две группы синхронизации и добавить различные конечные точки для каждой. Служба синхронизации хранилища может содержать любое количество групп синхронизации.  

### <a name="registered-server"></a>Зарегистрированный сервер
Объект "Зарегистрированный сервер" представляет собой отношение доверия между сервером (или кластером) и службой синхронизации хранилища. В экземпляре службы синхронизации хранилища можно зарегистрировать любое необходимое количество серверов. Тем не менее сервер (или кластер) можно зарегистрировать только в одной службе синхронизации хранилища.

### <a name="azure-file-sync-agent"></a>Агент службы синхронизации файлов Azure
Агент службы синхронизации файлов Azure — это скачиваемый пакет, позволяющий синхронизировать Windows Server с общим файловым ресурсом Azure. Агент службы синхронизации файлов Azure состоит из трех основных компонентов: 
- **FileSyncSvc.exe**. Фоновая служба Windows, отвечающая за отслеживание изменений в конечных точках сервера и запуск сеансов синхронизации в Azure.
- **StorageSync.sys**. Фильтр файловой системы службы синхронизации файлов Azure, отвечающий за распределение файлов по уровням компонента "Файлы Azure" (когда включено распределение по уровням облака).
- **Командлеты управления PowerShell**. Командлеты управления PowerShell, которые вы используете для взаимодействия с поставщиком ресурсов Azure Microsoft.StorageSync. Их можно найти в следующих расположениях (по умолчанию):
    - C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.PowerShell.Cmdlets.dll;
    - C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll.

### <a name="server-endpoint"></a>Конечная точка сервера
Конечная точка сервера представляет собой определенное расположение на зарегистрированном сервере, например папку в томе сервера. В томе может располагаться несколько конечных точек сервера, если их пространства имен не перекрываются (например, `F:\sync1` и `F:\sync2`). Политики распределения по уровням облака можно настроить отдельно для каждой конечной точки сервера. 

Можно создать конечную точку сервера с помощью точки подключения. Обратите внимание на то, что точки подключения в конечной точке сервера пропускаются.  

Можно создать конечную точку сервера на системном томе, но при этом есть два ограничения:
* Невозможно включить распределение по уровням облака.
* Не выполняется быстрое восстановление пространств имен (когда система быстро отключает все пространство имен, а затем начинает отзывать содержимое).


> [!Note]  
> Поддерживаются только тома без возможности удаления.  Диски, сопоставленные с удаленным общим ресурсом, не поддерживаются для пути конечной точки сервера.  Конечная точка сервера может находиться на системном томе Windows, который не поддерживает распределение по уровням облака.

Если вы добавляете в группу синхронизации в качестве конечной точки сервера некоторое расположение, которое содержит набор файлов, эти файлы объединяются с теми файлами, которые уже находятся в других конечных точках этой группы синхронизации.

### <a name="cloud-endpoint"></a>Облачная конечная точка
Облачная конечная точка является общим файловым ресурсом Azure, который входит в группу синхронизации. Все операции синхронизации для общего файлового ресурса Azure и сам файловый ресурс Azure могут относиться только к одной облачной конечной точке. Таким образом, файловый ресурс Azure может быть членом только одной группы синхронизации. Если вы добавляете в группу синхронизации в качестве конечной точки сервера общий файловый ресурс Azure, который содержит набор файлов, эти файлы объединяются с теми файлами, которые уже находятся в других конечных точках этой группы синхронизации.

> [!Important]  
> Служба "Синхронизация файлов Azure" поддерживает внесение изменений непосредственно в файловый ресурс Azure. Однако внесенные изменения сначала должны быть обнаружены заданием обнаружения изменений этой службы. Задание обнаружения изменений инициируется для облачной конечной точки каждые 24 часа. Кроме того, изменения, внесенные в файловый ресурс Azure с помощью протокола REST, не приведут к обновлению времени последнего изменения SMB и не будут распознаны как изменение службой синхронизации. Дополнительные сведения см. в статье [Часто задаваемые вопросы о службе файлов Azure](storage-files-faq.md#afs-change-detection).

### <a name="cloud-tiering"></a>Распределение по уровням облака 
Распределение по уровням в облаке — дополнительная функция Синхронизации файлов Azure, в которой часто используемые файлы кэшируются локально на сервере, а все другие файлы распределяются по уровням в файлах Azure на основе параметров политики. Для получения дополнительных сведений см. статью [Общие сведения о распределении по уровням в облаке](storage-sync-cloud-tiering.md).

## <a name="azure-file-sync-system-requirements-and-interoperability"></a>Системные требования к службе "Синхронизация файлов Azure" и ее возможности взаимодействия 
В этом разделе описываются системные требования к службе "Синхронизация файлов Azure" и ее возможности взаимодействия с компонентами и ролями Windows Server, а также с решениями сторонних производителей.

### <a name="evaluation-tool"></a>Средство оценки
Прежде чем развертывать службу "Синхронизация файлов Azure", следует оценить, совместима ли она с вашей системой, с помощью средства оценки этой службы. Это средство является командлетом Azure PowerShell, который проверяет наличие потенциальных проблем с файловой системой и набором данных, таких как неподдерживаемые символы или неподдерживаемая версия операционной системы. Обратите внимание, что проверки охватывают большинство, но не все возможности, описанные ниже. Мы рекомендуем прочесть всю оставшуюся часть этого раздела очень внимательно, чтобы осуществить развертывание надлежащим образом. 

#### <a name="download-instructions"></a>Инструкции по загрузке
1. Убедитесь, что у вас установлена последняя версия PackageManagement и PowerShellGet (это позволяет установить модули, используемые в предварительной версии).
    
    ```powershell
        Install-Module -Name PackageManagement -Repository PSGallery -Force
        Install-Module -Name PowerShellGet -Repository PSGallery -Force
    ```
 
2. Перезапустите PowerShell.
3. Установка модулей
    
    ```powershell
        Install-Module -Name Az.StorageSync -AllowPrerelease -AllowClobber -Force
    ```

#### <a name="usage"></a>Использование  
Средство оценки можно вызывать несколькими способами: можно выполнять системные проверки, проверки набора данных или и то, и другое. Выполнение проверки системы и набора данных: 

```powershell
    Invoke-AzStorageSyncCompatibilityCheck -Path <path>
```

Проверка только набора данных:
```powershell
    Invoke-AzStorageSyncCompatibilityCheck -Path <path> -SkipSystemChecks
```
 
Проверка только системных требований:
```powershell
    Invoke-AzStorageSyncCompatibilityCheck -ComputerName <computer name>
```
 
Отображение результатов в CSV-файле:
```powershell
    $errors = Invoke-AzStorageSyncCompatibilityCheck […]
    $errors | Select-Object -Property Type, Path, Level, Description | Export-Csv -Path <csv path>
```

### <a name="system-requirements"></a>Требования к системе
- Сервер под управлением Windows Server 2012 R2, Windows Server 2016 или Windows Server 2019.

    | Version | Поддерживаемые номера SKU | Поддерживаемые варианты развертывания |
    |---------|----------------|------------------------------|
    | Windows Server 2019 | Datacenter и Standard | Полное (сервер с пользовательским интерфейсом) |
    | Windows Server 2016 | Datacenter и Standard | Полное (сервер с пользовательским интерфейсом) |
    | Windows Server 2012 R2 | Datacenter и Standard | Полное (сервер с пользовательским интерфейсом) |

    Новые версии Windows Server будут добавляться по мере их выпуска. Более ранние версии Windows могут быть добавлены по запросу пользователей.

    > [!Important]  
    > Мы рекомендуем постоянно обновлять серверы, используемые со службой синхронизации файлов Azure, с помощью последних обновлений из Центра обновления Windows. 

- Сервер с объемом памяти не менее 2 ГиБ.

    > [!Important]  
    > Если сервер выполняется на виртуальной машине с включенной динамической памятью, в виртуальной машине должна быть настроена память объемом не менее 2048 МиБ.
    
- Локально подключенный том, отформатированный с помощью файловой системы NTFS.

### <a name="file-system-features"></a>Возможности файловой системы

| Функция | Состояние поддержки | Примечания |
|---------|----------------|-------|
| Списки управления доступом (ACL) | Полностью поддерживается | Списки управления доступом Windows сохраняются службой "Синхронизация файлов Azure" и принудительно используются Windows Server для конечных точек сервера. Списки управления доступом Windows (пока) не поддерживаются в службе "Файлы Azure", если доступ к ней осуществляется напрямую в облаке. |
| Жесткие связи. | Skipped | |
| Символические связи | Skipped | |
| Точки подключения | Частично поддерживаются | Точки подключения могут располагаться в корне конечной точки сервера, но они пропускаются, если содержатся в пространстве имен конечной точки сервера. |
| Соединения | Skipped | Например, папки DfrsrPrivate и DFSRoots распределенной файловой системы. |
| Точки повторного анализа | Skipped | |
| Сжатие NTFS | Полностью поддерживается | |
| Разреженные файлы | Полностью поддерживается | Разреженные файлы синхронизируются (не блокируются) в облако в качестве полного файла. При изменении содержимого файла в облаке (или на другом сервере) он перестанет быть разреженным, когда скачана измененная версия. |
| Альтернативные потоки данных (ADS) | Сохраняются, но не синхронизируются | Например, теги классификации, созданные инфраструктурой классификации файлов, не синхронизируются. Имеющиеся теги классификации для файлов в каждой из конечных точек сервера использоваться не будут. |

> [!Note]  
> Поддерживаются только тома NTFS. ReFS, FAT, FAT32 и другие файловые системы не поддерживаются.

### <a name="files-skipped"></a>Пропущенные файлы

| Файл или папка | Примечание |
|-|-|
| Desktop.ini | Системный файл |
| ethumbs.db$ | Временный файл для эскизов |
| ~$\*.\*; | Временный файл Office |
| \*.tmp; | Временный файл |
| \*.laccdb; | Файл блокировки базы данных Access|
| 635D02A9D91C401B97884B82B3BCDAEA.* | Внутренний файл синхронизации|
| \\System Volume Information | Папка для тома |
| $RECYCLE.BIN| Папка |
| \\SyncShareState | Папка для синхронизации |

### <a name="failover-clustering"></a>Отказоустойчивая кластеризация
Служба синхронизации файлов Azure поддерживает отказоустойчивую кластеризацию Windows Server для варианта развертывания "Файловый сервер общего использования". Отказоустойчивая кластеризация не поддерживается в вариантах "Масштабируемый файловый сервер для данных приложения" (SOFS) или в общих томах кластеров (CSV).

> [!Note]  
> Агент службы синхронизации файлов Azure должен быть установлен на каждом узле отказоустойчивого кластера для правильной работы синхронизации.

### <a name="data-deduplication"></a>Дедупликация данных
**Версия агента 5.0.2.0**   
Дедупликация данных поддерживается в томах с включенным распределением по уровням в облаке в Windows Server 2016 и Windows Server 2019. Включив дедупликацию в томе с включенным распределением по уровням в облаке, вы можете кэшировать больше файлов локально без выделения дополнительного объема памяти.

**Windows Server 2012 R2 или более ранняя версия агента**  
Для томов без распределения по уровням облака служба синхронизации файлов Azure поддерживает включение дедупликации данных Windows Server.

### <a name="distributed-file-system-dfs"></a>Распределенная файловая система (DFS)
Служба "Синхронизация файлов Azure" поддерживает взаимодействие с пространствами имен DFS (DFS-N) и репликацией DFS (DFS-R).

**Пространства имен DFS (DFS-N)**. Служба "Синхронизация файлов Azure" полностью поддерживается для серверов DFS-N. Вы можете установить агент службы "Синхронизация файлов Azure" на один или несколько членов DFS-N, чтобы синхронизировать данные между конечными точками сервера и облачными конечными точками. Дополнительные сведения см. в статье [Обзор пространств имен DFS](https://docs.microsoft.com/windows-server/storage/dfs-namespaces/dfs-overview).
 
**Репликация DFS (DFS-R)**. Так как DFS-R и служба "Синхронизация файлов Azure" выполняют аналогичные функции (репликацию), в большинстве случаев мы рекомендуем полностью заменить DFS-R синхронизацией файлов Azure. Но есть несколько сценариев, в которых DFS-R и службу "Синхронизация файлов Azure" есть смысл использовать вместе.

- Если выполняется миграция с развернутой службы DFS-R в развернутую службу "Синхронизация файлов Azure". Дополнительные сведения см. в статье [Развертывание службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md#migrate-a-dfs-replication-dfs-r-deployment-to-azure-file-sync).
- Если нет возможности подключить к Интернету напрямую каждый локальный сервер, на котором нужны копии файлов данных.
- Если серверы подразделений консолидируют данные на одном сервере-концентраторе, для которого вы намерены использовать службу "Синхронизация файлов Azure".

Если служба "Синхронизация файлов Azure" и DFS-R работают параллельно, следует учесть следующее.

1. В службе "Синхронизация файлов Azure" нужно отключить распределение по уровням облака для томов, на которых есть реплицируемые DFS-R папки.
2. Не следует настраивать конечные точки сервера для папок репликации DFS-R с доступом только для чтения.

Дополнительные сведения см. в статье [Обзор пространств имен DFS и репликации DFS](https://technet.microsoft.com/library/jj127250).

### <a name="sysprep"></a>Средство Sysprep
Использование средства sysprep на сервере, где установлен агент службы "Синхронизация файлов Azure", не поддерживается и может привести к непредвиденным результатам. Устанавливать агент и регистрировать сервер нужно после развертывания образа сервера и завершения мини-установки sysprep.

### <a name="windows-search"></a>Windows Search
Если на конечной точке сервера включено распределение по уровням облака, распределяемые по уровням файлы пропускаются и не индексируются службой Windows Search. Файлы, не распределяемые по уровням, индексируются должным образом.

### <a name="antivirus-solutions"></a>Антивирусные решения
Антивирусные программы работают путем сканирования файлов на наличие известного вредоносного кода, поэтому они могут вызвать отзыв файлов, распределенных по уровням. В агенте синхронизации файлов Azure начиная с версии 4.0 файлам, распределенным по уровням, задан атрибут безопасности Windows FILE_ATTRIBUTE_RECALL_ON_DATA_ACCESS. Рекомендуется обратиться к поставщику программного обеспечения за информацией о том, как настроить решение, чтобы пропускать чтение файлов с таким атрибутом (многие программы делают это автоматически).

Антивирусные решения Майкрософт — Защитник Windows и служба регистрации сертификатов для сетевых устройств (SCEP) автоматически пропускают чтение файлов с таким атрибутом. В ходе их тестирования обнаружилась небольшая проблема — при добавлении сервера в существующую группу синхронизации файлы размером меньше 800 байт отзываются (скачиваются) на новый сервер. Эти файлы останутся на новом сервере и не будут передаваться, так как они не соответствуют требованиям к размерам для уровней (более 64 КБ).

### <a name="backup-solutions"></a>Решения для архивации
Как и антивирусные решения, решения для архивации могут привести к отзыву многоуровневых файлов. Для архивации файловых ресурсов Azure мы рекомендуем использовать облачное решение для архивации вместо локального.

Если вы используете для резервного копирования локальное решение, резервное копирование должно выполняться на сервере в группе синхронизации с отключенным распределением по уровням облака. При восстановлении используйте параметры восстановления на уровне тома или файла. Файлы, восстановленные с помощью функции восстановления на уровне файлов, будут синхронизированы со всеми конечными точками в группе синхронизации, а существующие файлы — заменены версией, восстановленной из резервной копии.  При восстановлении на уровне тома новые версии файлов в файловом ресурсе Azure или других конечных точках сервера не заменяются.

> [!Note]  
> Восстановление исходного состояния системы (BMR) может привести к непредвиденным результатам и сейчас не поддерживается.

> [!Note]  
> Сейчас моментальные снимки VSS (включая предыдущих версий) не поддерживаются в томах, для которых включено распределение по уровням в облаке. Если включено распределение по уровням в облаке, используйте моментальные снимки файловых ресурсов Azure для восстановления файла из резервной копии.

### <a name="encryption-solutions"></a>Решения для шифрования
Поддержка для решений шифрования зависит от их реализации. Служба синхронизации файлов Azure точно работает со следующими компонентами и функциями:

- шифрование BitLocker;
- Azure Information Protection, Azure Rights Management Services (Azure RMS) и службы Active Directory RMS.

Служба синхронизации файлов Azure точно не работает со следующими компонентами:

- зашифрованная с помощью NTFS файловая система (EFS).

Как правило, служба синхронизации файлов Azure поддерживает взаимодействие с решениями шифрования, реализованными ниже файловой системы, например BitLocker, и с решениями, которые реализованы в файловом формате, например Azure Information Protection. Для решений, реализованных выше файловой системы (например, NTFS EFS), специальное взаимодействие не разработано.

### <a name="other-hierarchical-storage-management-hsm-solutions"></a>Другие решения по управлению иерархическим хранением (HSM)
Другие решения HSM не нужно использовать со службой синхронизации файлов Azure.

## <a name="region-availability"></a>Регионы доступности
Синхронизация файлов Azure доступна только в таких регионах:

| Регион | Расположение центра обработки данных |
|--------|---------------------|
| Восточная часть Австралии | Новый Южный Уэльс |
| Юго-Восточная часть Австралии | Виктория |
| Южная часть Бразилии | Состояние Паоло Сан |
| Центральная Канада | Торонто |
| Восточная Канада | Город Квебек |
| Центральная Индия | Пуна |
| Центральный регион США | Айова |
| Восточная Азия | Гонконг, САР |
| Восточная часть США | Виргиния |
| Восток США 2 | Виргиния |
| Центральная Корея| Сеул |
| Южная Корея| Пусан |
| Восточная часть Японии | Токио, Сайтама |
| Западная часть Японии | Осака |
| Центрально-северная часть США | Иллинойс |
| Северная Европа | Ирландия |
| Центрально-южная часть США | Техас |
| Южная Индия | Ченнай |
| Юго-Восточная Азия | Сингапур |
| Южная часть Великобритании | Лондон |
| Западная часть Великобритании | Кардифф |
| Западная Европа | Нидерланды |
| Запад США | Калифорния |

Синхронизация файлов Azure поддерживает только синхронизацию с файловым ресурсом Azure в том же регионе, что и служба синхронизации хранилища.

### <a name="azure-disaster-recovery"></a>Аварийное восстановление Azure
Для защиты от потери региона Azure служба "Синхронизация файлов Azure" интегрируется с вариантом обеспечения избыточности — [геоизбыточное хранилище](../common/storage-redundancy-grs.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (GRS). GRS работает с использованием репликации асинхронных блоков между хранилищем в основном регионе, в которым вы обычно работаете, и хранилищем в парном дополнительном регионе. В случае аварии, которая приводит к временному или постоянному переходу региона Azure в автономный режим, корпорация Майкрософт выполняет отработку отказа хранилища в парный регион. 

> [!Warning]  
> Если вы используете общую папку Azure в качестве конечной точки облака в учетной записи хранения GRS, нет необходимости выполнять отработку отказа учетной записи хранения. Это приведет к прекращению синхронизации или даже к непредвиденной потере данных, если некоторые файлы недавно стали многоуровневыми. В случае потери региона Azure корпорация Майкрософт активирует отработку отказа учетной записи хранения способом, который совместим со службой "Синхронизация файлов Azure".

Для поддержки интеграции отработки отказа между геоизбыточным хранилищем и службой "Синхронизация файлов Azure" все регионы этой службы сопоставляются с дополнительным регионом, который используется хранилищем. Ниже приведены эти пары.

| Основной регион      | Парный регион      |
|---------------------|--------------------|
| Восточная часть Австралии      | Юго-Восточная часть Австралии |
| Юго-Восточная часть Австралии | Восточная часть Австралии     |
| Центральная Канада      | Восточная Канада        |
| Восточная Канада         | Центральная Канада     |
| Центральная Индия       | Южная Индия        |
| Центральный регион США          | Восток США 2          |
| Восточная Азия           | Юго-Восточная Азия     |
| Восточная часть США             | Запад США            |
| Восток США 2           | Центральный регион США         |
| Центральная Корея       | Южная Корея        |
| Южная Корея         | Центральная Корея      |
| Северная Европа        | Западная Европа        |
| Центрально-северная часть США    | Центрально-южная часть США   |
| Южная Индия         | Центральная Индия      |
| Юго-Восточная Азия      | Восточная Азия          |
| Южная часть Великобритании            | Западная часть Великобритании            |
| Западная часть Великобритании             | Южная часть Великобритании           |
| Западная Европа         | Северная Европа       |
| Запад США             | Восточная часть США            |

## <a name="azure-file-sync-agent-update-policy"></a>Политика обновления агента службы синхронизации файлов Azure
[!INCLUDE [storage-sync-files-agent-update-policy](../../../includes/storage-sync-files-agent-update-policy.md)]

## <a name="next-steps"></a>Дальнейшие действия
* [Параметры брандмауэра и прокси-сервера Синхронизации файлов Azure](storage-sync-files-firewall-and-proxy.md)
* [Планирование развертывания службы файлов Azure](storage-files-planning.md)
* [Как развернуть службу файлов Azure](storage-files-deployment-guide.md)
* [Как развернуть службу синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md)
* [Мониторинг Синхронизации файлов Azure](storage-sync-files-monitoring.md)
