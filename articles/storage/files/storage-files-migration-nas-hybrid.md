---
title: Переход NAS в синхронизацию файлов Azure
description: Узнайте, как перенести файлы из локальных сетевых устройств хранения (NAS) в гибридное развертывание облака с помощью файлов Azure File Sync и Azure.
author: fauhse
ms.service: storage
ms.topic: conceptual
ms.date: 03/19/2020
ms.author: fauhse
ms.subservice: files
ms.openlocfilehash: 7b0c7a30580d3863a78e85b8b45287a598bbf394
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80247356"
---
# <a name="migrate-from-network-attached-storage-nas-to-a-hybrid-cloud-deployment-with-azure-file-sync"></a>Переход от сетевого хранилища (NAS) к гибридному развертыванию облака с синхронизацией файлов Azure

Azure File Sync работает в местах прямого присоединенного хранилища (DAS) и не поддерживает синхронизацию в местах хранения сетевого хранения (NAS).
Этот факт делает миграцию ваших файлов необходимой, и эта статья поможет вам при планировании и осуществлении такой миграции.

## <a name="migration-goals"></a>Цели миграции

Цель состоит в том, чтобы переместить акции, которые есть на вашем приборе NAS, на сервер Windows. Затем используйте Azure File Sync для гибридного развертывания облака. Эта миграция должна быть сделана таким образом, чтобы гарантировать целостность производственных данных, а также доступность во время миграции. Последнее требует сохранения времени простоя до минимума, так что он может вписаться в или лишь незначительно превысить обычные окна обслуживания.

## <a name="migration-overview"></a>Общие сведения о переносе

Как уже упоминалось в [статье обзора миграции](storage-files-migration-overview.md)Azure Files, важно использовать правильный инструмент копирования и подход. Ваш прибор NAS разоблачает акции Малого и Среднего бизнеса непосредственно в локальной сети. RoboCopy, встроенный Windows Server, является лучшим способом перемещения файлов в этом сценарии миграции.

- Фаза 1: [Определите, сколько нужного количества файлов Azure](#phase-1-identify-how-many-azure-file-shares-you-need)
- Фаза 2: [Предоставление подходящего Windows-сервера на месте](#phase-2-provision-a-suitable-windows-server-on-premises)
- Фаза 3: [Развертывание облачного ресурса Azure File Sync](#phase-3-deploy-the-azure-file-sync-cloud-resource)
- Этап 4: [Развертывание ресурсов хранения Azure](#phase-4-deploy-azure-storage-resources)
- Фаза 5: [Развертывание агента синхронизации файлов Azure](#phase-5-deploy-the-azure-file-sync-agent)
- Фаза 6: [Настройка синхронизации файлов Azure на сервере Windows](#phase-6-configure-azure-file-sync-on-the-windows-server)
- Фаза 7: [РобоКопия](#phase-7-robocopy)
- Фаза 8: [Вырез пользователя](#phase-8-user-cut-over)

## <a name="phase-1-identify-how-many-azure-file-shares-you-need"></a>Фаза 1: Определите, сколько нужного количества файлов Azure

[!INCLUDE [storage-files-migration-namespace-mapping](../../../includes/storage-files-migration-namespace-mapping.md)]

## <a name="phase-2-provision-a-suitable-windows-server-on-premises"></a>Фаза 2: Предоставление подходящего Windows-сервера на месте

* Создайте Windows Server 2019 - как минимум 2012R2 - в качестве виртуальной машины или физического сервера. Кластер сбоя Windows Server также поддерживается.
* Предоставление или добавление прямого прикрепленного хранилища (DAS по сравнению с NAS, которое не поддерживается).

    Объем резервирования может быть меньше, чем то, что вы используете в настоящее время на вашем приборе NAS, если вы используете функцию [многоуровневого многоуровневого уровня](storage-sync-cloud-tiering.md) Azure File Syncs.
    Однако при копировании файлов из большего пространства NAS на меньший объем Windows Server на более позднем этапе необходимо будет работать в пакетах:

    1. Перемещение набора файлов, которые помещаются на диск
    2. позволяют синхронизации файлов и многоуровневому облаку
    3. когда больше свободного пространства создается на томе, приступай к следующей партии файлов. 
    
    Этот пакетный подход можно избежать, присвоив эквивалентное пространство на сервере Windows Server, которое ваши файлы занимают на приборе NAS. Рассмотрим deduplication на NAS / Windows. Если вы не хотите постоянно фиксировать такое большое количество хранилища на сервер Windows, можно уменьшить размер громкости после миграции и перед настройкой политик и многоуровневых облаков. Это создает меньший локтевый кэш ваших файлов Azure.

Конфигурация ресурса (вычислять и оперативной памяти) развертываемого сервера Windows в основном зависит от количества элементов (файлов и папок), которые будут синхронизироваться. Мы рекомендуем идти с более высокой конфигурацией производительности, если у вас есть какие-либо проблемы.

[Узнайте, как размер сервера Windows на основе количества элементов (файлов и папок), которые необходимо синхронизировать.](storage-sync-files-planning.md#recommended-system-resources)

> [!NOTE]
> В ранее связанной статье представлена таблица с диапазоном памяти сервера (RAM). Вы можете сориентироваться на меньшее число для вашего сервера, но ожидать, что начальная синхронизация может занять значительно больше времени.

## <a name="phase-3-deploy-the-azure-file-sync-cloud-resource"></a>Фаза 3: Развертывание облачного ресурса Azure File Sync

[!INCLUDE [storage-files-migration-deploy-afs-sss](../../../includes/storage-files-migration-deploy-azure-file-sync-storage-sync-service.md)]

## <a name="phase-4-deploy-azure-storage-resources"></a>Этап 4: Развертывание ресурсов хранения Azure

На этом этапе проконсультируйтесь с таблицей отображения с первой фазы и используйте ее для предоставления правильного количества учетных записей хранения Azure и файлов в них.

[!INCLUDE [storage-files-migration-provision-azfs](../../../includes/storage-files-migration-provision-azure-file-share.md)]

## <a name="phase-5-deploy-the-azure-file-sync-agent"></a>Фаза 5: Развертывание агента синхронизации файлов Azure

[!INCLUDE [storage-files-migration-deploy-afs-agent](../../../includes/storage-files-migration-deploy-azure-file-sync-agent.md)]

## <a name="phase-6-configure-azure-file-sync-on-the-windows-server"></a>Фаза 6: Настройка синхронизации файлов Azure на сервере Windows

Ваш зарегистрированный на территории Windows Server должен быть готов и подключен к Интернету для этого процесса.

[!INCLUDE [storage-files-migration-configure-sync](../../../includes/storage-files-migration-configure-sync.md)]

> [!IMPORTANT]
> Облачное многоуровневое является функцией AFS, которая позволяет локальному серверу иметь меньше емкости для хранения, чем хранится в облаке, но при этом имеет полное пространство имен. Локально интересные данные также кэшируется локально для быстрой производительности доступа. Облачные многоуровневые характеристики — необязательная функция в Azure File Sync, «конечная точка сервера».

> [!WARNING]
> Если вы резервировали меньше памяти на вашем сервере Windows(ы), чем ваши данные, используемые на приборе NAS, то многоуровневое облако является обязательным. Если вы не включите многоуровневое облако, ваш сервер не освободит пространство для хранения всех файлов. Временно установите политику многоуровневого уровня для миграции до 99% свободного пространства. Обязательно вернитесь к настройкам уровня облака после завершения миграции и установите его на более долгосрочный полезный уровень.

Повторите шаги создания группы синхронизации и добавления соответствующей папки сервера в качестве конечной точки сервера для всех файлов Azure/ местоположений серверов, которые должны быть настроены для синхронизации.

После создания всех конечных точек сервера синхронизация работает. Можно создать тестовый файл и увидеть его синхронизацию с места расположения сервера с подключенной долей файла Azure (как описано в точке облачного в группе синхронизации).

Оба местоположения, папки серверов и файлы Azure в противном случае пусты и ожидают данных в любом месте. На следующем этапе вы начнете копировать файлы в Windows Server для синхронизации файлов Azure, чтобы переместить их в облако. В случае, если вы включили многоуровневое облако, сервер начнет уровень файлов, если вы бежите из емкости на локальном томе(ы).

## <a name="phase-7-robocopy"></a>Фаза 7: РобоКопия

Основным подходом к миграции является RoboCopy от вашего NAS-устройства до Windows Server и Azure File Sync в файловых долях Azure.

Запустите первую локальную копию в папку с целевым сервером Windows Server:

* Определите первое местоположение на вашем приборе NAS.
* Определите соответствующую папку на сервере Windows, на ней уже настроена синхронизация файлов Azure.
* Запуск копии с помощью RoboCopy

Следующая команда RoboCopy будет копировать файлы из хранилища NAS в папку с целевым сервером Windows Server. Сервер Windows будет синхронизировать его с разделом файлов Azure(ы). 

Если вы создали меньше памяти на вашем Сервере Windows, чем ваши файлы занимают на NAS прибор, то вы настроили многоуровневое облако. По мере того, как локальный объем Windows Server будет заполнен, [многоуровневые облачные серверы](storage-sync-cloud-tiering.md) будут использоваться и использовать уже успешно синхронизированные файлы. Облачные многоуровневые будут генерировать достаточно места для продолжения копирования с прибора NAS. Облачные многоуровневые проверки один раз в час, чтобы увидеть, что синхронизировалось и освободить дисковое пространство для достижения 99% объема свободного пространства.
Вполне возможно, что RoboCopy перемещает файлы быстрее, чем вы можете синхронизировать с облаком и уровнем локально, таким образом, иссякнет локальное дисковое пространство. RoboCopy потерпит неудачу. Рекомендуется работать через акции в последовательности, которая предотвращает это. Например, не запускать задания RoboCopy для всех акций одновременно или только движущихся акций, которые соответствуют текущему количеству свободного пространства на Сервере Windows, не говоря уже о нескольких.

```console
Robocopy /MT:32 /UNILOG:<file name> /TEE /B /MIR /COPYALL /DCOPY:DAT <SourcePath> <Dest.Path>
```

Фон:

:::row:::
   :::column span="1":::
      /MT
   :::column-end:::
   :::column span="1":::
      Позволяет RoboCopy работать многопоните. По умолчанию 8, макс 128.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /ИНИОЛОГ:\<имя файла\>
   :::column-end:::
   :::column span="1":::
      Состояние выводов в файл LOG как UNICODE (перезаписывает существующий журнал).
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /TEE
   :::column-end:::
   :::column span="1":::
      Выходы на консоль окна. Используется в сочетании с выводом в файл журнала.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /B
   :::column-end:::
   :::column span="1":::
      Запускает RoboCopy в том же режиме, что и резервное приложение. Это позволяет RoboCopy перемещать файлы, на которые у текущего пользователя нет разрешений.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /МИР
   :::column-end:::
   :::column span="1":::
      Позволяет запустить эту команду RoboCopy несколько раз, последовательно на той же цели / назначения. Он определяет то, что было скопировано ранее, и опускает его. Будут обработаны только изменения, дополнения и *"удаления",* которые произошли с момента последнего запуска. Если команда не была запущена раньше, ничего не опущено. Флаг */MIR* является отличным вариантом для исходных мест, которые все еще активно используются и изменяются.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /COPY:copyflag's
   :::column-end:::
   :::column span="1":::
      верность копии файла (по умолчанию /COPY:DAT), флаги копирования: D'Data, Атрибуты, T'Timestamps, S'Security-NTFS ACLs, Информация о владельце, информация о U'aUditing
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /КОПИАЛ
   :::column-end:::
   :::column span="1":::
      COPY ALL файл информация (эквивалент /COPY:DATSOU)
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /DCOPY:copyflag
   :::column-end:::
   :::column span="1":::
      верность копии каталогов (по умолчанию /DCOPY:DA), флаги копирования: D'Data, A'Attributes, T'Timestamps
   :::column-end:::
:::row-end:::

## <a name="phase-8-user-cut-over"></a>Фаза 8: Вырез пользователя

При первом запуске команды RoboCopy пользователи и приложения по-прежнему получают доступ к файлам на NAS и потенциально меняют их. Вполне возможно, что RoboCopy обработал каталог, переходит к следующему, а затем пользователь на месте источника (NAS) добавляет, изменяет или удаляет файл, который теперь не будет обработан в этом текущем запуске RoboCopy. Это ожидаемое поведение.

Первый запуск связан с перемещением основной части данных на ваш Windows Server и в облако через Azure File Sync. Эта первая копия может занять много времени, в зависимости от:

* пропускная способность загрузки
* пропускная способность загрузки
* скорость локальной сети и количество оптимального соответствия количества потоков RoboCopy
* количество элементов (файлов и папок), которые должны быть обработаны RoboCopy и Azure File Sync

После завершения первоначального запуска выполнить команду снова.

Во второй раз он закончит быстрее, потому что ему нужно только транспортировать изменения, которые произошли с момента последнего запуска. Во время этого второго запуска, по-прежнему, новые изменения могут накапливаться.

Повторите этот процесс до тех пор, пока вы не убедитесь, что время, необходимое для завершения RoboCopy для определенного местоположения находится в пределах приемлемого окна для простоя.

Если вы считаете время простоя приемлемым и вы готовы перейти местоположение NAS в автономном режиме: Для того, чтобы принять доступ пользователя в автономный режим, у вас есть возможность изменить ACLs на корне общего доступа, так что пользователи больше не могут получить доступ к местоположению или принять любой другой подходящий шаг что предотвращает изменение содержимого в этой папке на NAS.

Выполнить один последний раунд RoboCopy. Он подберет любые изменения, которые, возможно, были пропущены.
Как долго этот последний шаг принимает, зависит от скорости сканирования RoboCopy. Вы можете оценить время (что равно вашему времени простоя) путем измерения продолжительности предыдущего запуска.

Создайте общую часть в папке Windows Server и, возможно, отрегулируйте развертывание DFS-N, чтобы указать на нее. Обязательно установите те же разрешения на уровне общего участия, что и на вашей акции NAS SMB. Если у вас есть NAS, связанный с доменом корпоративного класса, то sID-файлы пользователя будут автоматически совпадать по мере того, как пользователи существуют в Active Directory, а RoboCopy копирует файлы и метаданные в полной точности. Если вы использовали локальных пользователей на NAS, вам необходимо воссоздать этих пользователей в качестве локальных пользователей Windows Server и сопоставить существующие SIDs RoboCopy, переведенные на ваш Windows Server, на SID-устройства новых локальных пользователей Windows Server.

Вы закончили миграцию акции / группы акций в общий корень или объем. (В зависимости от отображения с фазы 1)

Вы можете попробовать запустить несколько из этих копий параллельно. Рекомендуем обрабатывать область действия одной совместной части файла Azure одновременно.

> [!WARNING]
> После того как вы перевели все данные из NAS на сервер Windows, и ваша миграция завершена: Возвращение ***ко всем*** группам синхронизации в портале Azure и отрегулируйте значение свободного пространства, многоуровневого объема облака, до чего-то, лучше подходящего для использования кэша, скажем, 20%. 

Политика многоуровневого объема облачных вычислений действует на уровне громкости с потенциально несколькими конечными точками сервера, синхронизированными с ним. Если вы забудете настроить свободное пространство даже на одном сервере, синхронизация будет продолжать применять наиболее ограничительное правило и пытаться сохранить 99% свободного дискового пространства, что делает локальный кэш не работает, как вы могли бы ожидать. Если только ваша цель состоит в томе, где есть пространство имен для тома, который содержит только редко доступ к архивным данным, и вы резервируете остальную часть места для хранения для другого сценария.

## <a name="troubleshoot"></a>Устранение неполадок

Наиболее вероятной проблемой, с накоторпомощью может столкнуться, является то, что команда RoboCopy выходит из строя с *"Объемом полного"* на стороне Windows Server. Облачные многоуровневые действия один раз в час для эвакуации содержимого с локального диска Windows Server, который синхронизирован. Его цель состоит в том, чтобы достичь 99% свободного пространства на объем.

Позволяет синхронизировать прогресс и многоуровневое облако освободить дисковое пространство. Вы можете заметить, что в файл explorer на вашем Сервере Windows.

Когда ваш Windows Server имеет достаточную доступную емкость, повторное запуск команды решит проблему. Ничто не ломается, когда вы попадаете в эту ситуацию, и вы можете двигаться вперед с уверенностью. Неудобство выполнения команды снова является единственным следствием.

Проверьте ссылку в следующем разделе для устранения неполадок в azure File Sync.

## <a name="next-steps"></a>Дальнейшие действия

Существует больше, чтобы узнать об акциях файлов Azure и синхронизации файлов Azure. Следующие статьи помогают понять расширенные варианты, рекомендации, а также содержат помощь по устранению неполадок. Эти статьи ссылаются на [документацию совместного файла Azure](storage-files-introduction.md) по мере необходимости.

* [Обзор AFS](https://aka.ms/AFS)
* [Руководство по развертыванию AFS](storage-files-deployment-guide.md)
* [Устранение неполадок AFS](storage-sync-files-troubleshoot.md)
