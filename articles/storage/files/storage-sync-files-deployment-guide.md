---
title: Развертывание службы "Синхронизация файлов Azure" | Документация Майкрософт
description: Сведения о развертывании службы синхронизации файлов Azure от начала до конца.
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 07/19/2018
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: f2c4e762ebf10a5ca2120c13a52750a7781d60b9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79268071"
---
# <a name="deploy-azure-file-sync"></a>Развертывание Синхронизации файлов Azure
Используйте службу "Синхронизация файлов Azure", чтобы централизованно хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования Windows Server в быстрый кэш общего файлового ресурса Azure. Для локального доступа к данным вы можете использовать любой протокол, доступный в Windows Server, в том числе SMB, NFS и FTPS. Кроме того, вы можете создать любое количество кэшей в любом регионе.

Перед выполнением шагов, описанных в этом руководстве, настоятельно рекомендуем ознакомиться со статьями [Планирование развертывания службы файлов Azure](storage-files-planning.md) и [Планирование развертывания службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-planning.md).

## <a name="prerequisites"></a>Предварительные требования
* Файл Azure в том же регионе, где требуется развертывание синхронизации файлов Azure. Для получения дополнительной информации см.:
    - [Доступность по регионам](storage-sync-files-planning.md#azure-file-sync-region-availability). Здесь представлены сведения о регионах службы синхронизации файлов Azure.
    - [Создание общей папки в хранилище файлов Azure](storage-how-to-create-file-share.md). Здесь содержатся пошаговые инструкции по созданию общего файлового ресурса.
* По крайней мере один поддерживаемый экземпляр кластера Windows Server или Windows Server для синхронизации с Azure File Sync. Для получения дополнительной информации о поддерживаемых версиях Windows Server [см.](storage-sync-files-planning.md#windows-file-server-considerations)
* Модуль Az PowerShell может использоваться либо с PowerShell 5.1, либо с PowerShell 6. Вы можете использовать модуль Az PowerShell для синхронизации файлов Azure в любой поддерживаемой системе, включая неоконную систему, однако регистрационный cmdlet сервера всегда должен работать на экземпляре Windows Server, который вы регистрируете (это может быть сделано непосредственно или через PowerShell remoting). На Windows Server 2012 R2 вы можете убедиться, что вы работаете по крайней мере PowerShell 5.1. \* глядя на значение свойства **PSVersion** **$PSVersionTable** объекта:

    ```powershell
    $PSVersionTable.PSVersion
    ```

    Если значение PSVersion меньше 5.1.\*, как это будет в случае с большинством последних установок Windows Server 2012 R2, версию можно легко обновить, скачав и установив [Windows Management Framework (WMF) 5.1](https://www.microsoft.com/download/details.aspx?id=54616). Соответствующий пакет для загрузки и установки для Windows Server 2012 R2 **\*\*\*\*\*\*\*win8.1AndW2K12R2-KB -x64.msu**. 

    PowerShell 6 "может быть использован с любой поддерживаемой системой, и могут быть загружены через свою [страницу GitHub](https://github.com/PowerShell/PowerShell#get-powershell). 

    > [!Important]  
    > Если вы планируете использовать uI-иного иуза регистрации серверов, а не регистрироваться непосредственно в PowerShell, необходимо использовать PowerShell 5.1.

* Если вы решили использовать PowerShell 5.1, убедитесь, что по крайней мере .NET 4.7.2 установлен. Узнайте больше о [версиях рамочного соглашения .NET и зависимостях от](https://docs.microsoft.com/dotnet/framework/migration-guide/versions-and-dependencies) вашей системы.

    > [!Important]  
    > Если вы устанавливаете .NET 4.7.2 на Windows Server Core, вы должны установить с флагами `quiet` и `norestart` флаги или установка не удастся. Например, при установке .NET 4.8 команда будет выглядеть следующим образом:
    > ```PowerShell
    > Start-Process -FilePath "ndp48-x86-x64-allos-enu.exe" -ArgumentList "/q /norestart" -Wait
    > ```

* Модуль Az PowerShell, который можно установить, следуя инструкциям здесь: [Установите и назначайте Azure PowerShell.](https://docs.microsoft.com/powershell/azure/install-Az-ps)
     
    > [!Note]  
    > Модуль Az.StorageSync теперь устанавливается автоматически при установке модуля Az PowerShell.

## <a name="prepare-windows-server-to-use-with-azure-file-sync"></a>Подготовка сервера Windows к работе со службой синхронизации файлов Azure
Для каждого сервера, который вы собираетесь использовать с функцией "Синхронизация файлов Azure", включая каждый узел сервера в отказоустойчивом кластере, отключите **конфигурацию усиленной безопасности Internet Explorer**. Это необходимо только при начальной регистрации на сервере. Конфигурацию можно включить повторно после регистрации сервера.

# <a name="portal"></a>[Портал](#tab/azure-portal)
> [!Note]  
> Вы можете пропустить этот шаг, если развертываете синхронизацию файлов Azure в ядре Сервера Windows.

1. Откройте диспетчер сервера.
2. Щелкните **Локальный сервер**:  
    ![Элемент "Локальный сервер" в левой части пользовательского интерфейса диспетчера сервера](media/storage-sync-files-deployment-guide/prepare-server-disable-IEESC-1.PNG)
3. Перейдите по ссылке **Конфигурация усиленной безопасности Internet Explorer** на вложенной панели **Свойства**.  
    ![Панель "Конфигурация усиленной безопасности Internet Explorer" в пользовательском интерфейсе диспетчера сервера](media/storage-sync-files-deployment-guide/prepare-server-disable-IEESC-2.PNG)
4. В диалоговом окне **Конфигурация усиленной безопасности Internet Explorer** установите переключатель **Выкл.** в разделе **Администраторы** и **Пользователи**.  
    ![Всплывающее окно "Конфигурация усиленной безопасности Internet Explorer" с установленным переключателем "Выкл."](media/storage-sync-files-deployment-guide/prepare-server-disable-IEESC-3.png)

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
Чтобы отключить конфигурацию усиленной безопасности Internet Explorer, выполните следующую команду PowerShell с повышенными правами:

```powershell
$installType = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\").InstallationType

# This step is not required for Server Core
if ($installType -ne "Server Core") {
    # Disable Internet Explorer Enhanced Security Configuration 
    # for Administrators
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A7-37EF-4b3f-8CFC-4F3A74704073}" -Name "IsInstalled" -Value 0 -Force
    
    # Disable Internet Explorer Enhanced Security Configuration 
    # for Users
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components\{A509B1A8-37EF-4b3f-8CFC-4F3A74704073}" -Name "IsInstalled" -Value 0 -Force
    
    # Force Internet Explorer closed, if open. This is required to fully apply the setting.
    # Save any work you have open in the IE browser. This will not affect other browsers,
    # including Microsoft Edge.
    Stop-Process -Name iexplore -ErrorAction SilentlyContinue
}
``` 

---

## <a name="deploy-the-storage-sync-service"></a>Развертывание службы синхронизации хранилища 
Развертывание функции "Синхронизация файлов Azure" начинается с размещения ресурса **службы синхронизации хранилища** в группе ресурсов выбранной вами подписки. Мы рекомендуем выполнять подготовку по мере необходимости. Вы создадите отношение доверия между серверами и этим ресурсом, и сервер можно будет зарегистрировать только в одной службе синхронизации хранилища. В результате рекомендуется развертывать столько служб синхронизации хранилища, сколько необходимо для разделения групп серверов. Имейте в виду, что серверы из разных служб синхронизации хранилища не могут синхронизироваться друг с другом.

> [!Note]
> Служба синхронизации хранилища наследует разрешения на доступ из развернутой в ней группы ресурсов. Рекомендуется тщательно проверить, кому предоставлен доступ. Сущности с доступом на запись могут начать синхронизацию новых наборов файлов с серверов, зарегистрированных в этой службе синхронизации хранилища, и вызвать отправку потока данных в доступное для них хранилище Azure.

# <a name="portal"></a>[Портал](#tab/azure-portal)
Чтобы развернуть службу синхронизации данных, перейдите на [портал Azure,](https://portal.azure.com/)нажмите *«Создайте ресурс»,* а затем выйдите в поиск синхронизации файлов Azure. В результатах поиска выберите **синхронизацию файлов Azure,** а затем выберите **«Создать»** для открытия вкладки **Deploy Storage Sync.**

В открывшейся области введите следующие сведения:

- **Имя.** Уникальное имя (в подписке) для службы синхронизации хранилища.
- **Подписка.** Подписка, в которой будет создана служба синхронизации хранилища. В зависимости от стратегии конфигурации организации можно получить доступ к одной или нескольким подпискам. Подписка Azure — это базовый контейнер при выставлении счетов для каждой облачной службы (такой как "Файлы Azure").
- **Группа ресурсов.** Это логическая группа ресурсов Azure, таких как учетная запись хранения или служба синхронизации хранилища. Можно создать новую группу ресурсов или использовать существующую группу ресурсов для синхронизации файлов Azure. (Мы рекомендуем использовать группы ресурсов в качестве контейнеров для логического изолирования ресурсов для вашей организации, таких как группировка HR-ресурсов или ресурсов для конкретного проекта.)
- **Расположение**: Область, в которой требуется развертывание синхронизации файлов Azure. В этом списке доступны только поддерживаемые регионы.

По завершении выберите **Создать**, чтобы развернуть службу синхронизации хранилища.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
Заменить, `<Az_Region>` `<RG_Name>` `<my_storage_sync_service>` и с вашими собственными значениями, а затем использовать следующие команды для создания и развертывания службы синхронизации хранения:

```powershell
$hostType = (Get-Host).Name

if ($installType -eq "Server Core" -or $hostType -eq "ServerRemoteHost") {
    Connect-AzAccount -UseDeviceAuthentication
}
else {
    Connect-AzAccount
}

# this variable holds the Azure region you want to deploy 
# Azure File Sync into
$region = '<Az_Region>'

# Check to ensure Azure File Sync is available in the selected Azure
# region.
$regions = @()
Get-AzLocation | ForEach-Object { 
    if ($_.Providers -contains "Microsoft.StorageSync") { 
        $regions += $_.Location 
    } 
}

if ($regions -notcontains $region) {
    throw [System.Exception]::new("Azure File Sync is either not available in the selected Azure Region or the region is mistyped.")
}

# the resource group to deploy the Storage Sync Service into
$resourceGroup = '<RG_Name>'

# Check to ensure resource group exists and create it if doesn't
$resourceGroups = @()
Get-AzResourceGroup | ForEach-Object { 
    $resourceGroups += $_.ResourceGroupName 
}

if ($resourceGroups -notcontains $resourceGroup) {
    New-AzResourceGroup -Name $resourceGroup -Location $region
}

$storageSyncName = "<my_storage_sync_service>"
$storageSync = New-AzStorageSyncService -ResourceGroupName $resourceGroup -Name $storageSyncName -Location $region
```

---

## <a name="install-the-azure-file-sync-agent"></a>Установка агента службы синхронизации файлов Azure
Агент службы синхронизации файлов Azure — это скачиваемый пакет, позволяющий синхронизировать Windows Server с общим файловым ресурсом Azure. 

# <a name="portal"></a>[Портал](#tab/azure-portal)
Его можно скачать в [Центре загрузки Майкрософт](https://go.microsoft.com/fwlink/?linkid=858257). После скачивания дважды щелкните пакет MSI, чтобы начать установку агента службы синхронизации файлов Azure.

> [!Important]  
> Если службу синхронизации файлов Azure нужно использовать с отказоустойчивым кластером, агент службы синхронизации файлов Azure должен быть установлен на каждом узле в кластере. Каждый узел в кластере должен быть зарегистрирован для работы с Azure File Sync.

Таким образом, мы рекомендуем сделать следующее:
- Оставить путь установки по умолчанию (C:\Program Files\Azure\StorageSyncAgent), чтобы упростить устранение неполадок и обслуживание сервера.
- Включить Центр обновления Майкрософт, чтобы служба синхронизации файлов Azure поддерживалась в актуальном состоянии. Все обновления для агента службы синхронизации файлов Azure, включая обновления компонентов и исправления, будут выполняться из Центра обновления Майкрософт. Мы рекомендуем установить последнее обновление для синхронизации файлов Azure. Для получения дополнительной [Azure File Sync update policy](storage-sync-files-planning.md#azure-file-sync-agent-update-policy)информации см.

По завершении установки агента службы синхронизации файлов Azure пользовательский интерфейс регистрации сервера запустится автоматически. Перед регистрацией установите службу синхронизации хранилища. В разделе ниже ознакомьтесь со сведениями о создании службы синхронизации хранилища.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
Выполните следующий код PowerShell, чтобы загрузить соответствующую версию агента Синхронизации файлов Azure для своей ОС и установите ее в своей системе.

> [!Important]  
> Если службу синхронизации файлов Azure нужно использовать с отказоустойчивым кластером, агент службы синхронизации файлов Azure должен быть установлен на каждом узле в кластере. Для работы с Синхронизацией файлов Azure нужно зарегистрировать каждый узел в кластере.

```powershell
# Gather the OS version
$osver = [System.Environment]::OSVersion.Version

# Download the appropriate version of the Azure File Sync agent for your OS.
if ($osver.Equals([System.Version]::new(10, 0, 17763, 0))) {
    Invoke-WebRequest `
        -Uri https://aka.ms/afs/agent/Server2019 `
        -OutFile "StorageSyncAgent.msi" 
} elseif ($osver.Equals([System.Version]::new(10, 0, 14393, 0))) {
    Invoke-WebRequest `
        -Uri https://aka.ms/afs/agent/Server2016 `
        -OutFile "StorageSyncAgent.msi" 
} elseif ($osver.Equals([System.Version]::new(6, 3, 9600, 0))) {
    Invoke-WebRequest `
        -Uri https://aka.ms/afs/agent/Server2012R2 `
        -OutFile "StorageSyncAgent.msi" 
} else {
    throw [System.PlatformNotSupportedException]::new("Azure File Sync is only supported on Windows Server 2012 R2, Windows Server 2016, and Windows Server 2019")
}

# Install the MSI. Start-Process is used to PowerShell blocks until the operation is complete.
# Note that the installer currently forces all PowerShell sessions closed - this is a known issue.
Start-Process -FilePath "StorageSyncAgent.msi" -ArgumentList "/quiet" -Wait

# Note that this cmdlet will need to be run in a new session based on the above comment.
# You may remove the temp folder containing the MSI and the EXE installer
Remove-Item -Path ".\StorageSyncAgent.msi" -Recurse -Force
```

---

## <a name="register-windows-server-with-storage-sync-service"></a>Регистрация Windows Server в службе синхронизации хранилища
При регистрации Windows Server в службе синхронизации хранилища между сервером (или кластером) и службой синхронизации хранилища устанавливаются отношения доверия. Сервер можно зарегистрировать только в одной службе синхронизации хранилища, и он может синхронизироваться с другими серверами и файловыми ресурсами Azure, связанными с той же службой синхронизации хранилища.

> [!Note]
> При регистрации сервера используются ваши учетные данные Azure для создания отношения доверия между службой синхронизации хранилища и сервером Windows Server, но впоследствии сервер создает и использует собственное удостоверение, действительное, пока он остается зарегистрированным и пока действительным является текущий маркер SAS (SAS хранилища). Новый маркер SAS нельзя выдать серверу после сбоя его регистрации. Таким образом, исключается способность сервера получать доступ к файловым ресурсам Azure и любая синхронизация становится невозможной.

# <a name="portal"></a>[Портал](#tab/azure-portal)
После установки агента службы синхронизации файлов Azure пользовательский интерфейс регистрации сервера запустится автоматически. Если он не запустился, его можно открыть вручную, перейдя в расположение файла: C:\Program Files\Azure\StorageSyncAgent\ServerRegistration.exe. После открытия пользовательского интерфейса регистрации сервера выберите **Вход**, чтобы приступить к работе.

После входа в систему вам будет предложено ввести следующие сведения:

![Снимок экрана пользовательского интерфейса регистрации сервера](media/storage-sync-files-deployment-guide/register-server-scubed-1.png)

- **Подписка Azure.** Подписка, содержащая службу синхронизации хранилища (дополнительные сведения см. в разделе [Развертывание службы синхронизации хранилища](#deploy-the-storage-sync-service)). 
- **Группа ресурсов.** Группа ресурсов, содержащая службу синхронизации хранилища.
- **Служба синхронизации хранилища.** Имя службы синхронизации хранилища, которую необходимо зарегистрировать.

Выбрав соответствующую информацию, выберите **Зарегистрировать**, чтобы завершить регистрацию сервера. В рамках процесса регистрации будет запрошен дополнительный вход.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell
$registeredServer = Register-AzStorageSyncServer -ParentObject $storageSync
```

---

## <a name="create-a-sync-group-and-a-cloud-endpoint"></a>Создание группы синхронизации и конечной точки облака
Группа синхронизации определяет топологию синхронизации для набора файлов. Конечные точки в группе синхронизации синхронизируются. Группа синхронизации должна содержать одну облачную конечную точку, которая представляет собой общий файловый ресурс Azure, и одну или несколько конечных точек сервера. Конечная точка сервера представляет собой путь на зарегистрированном сервере. У сервера конечные точки могут быть в нескольких группах синхронизации. Вы можете создать необходимое число групп синхронизации, чтобы соответствующим образом описать желаемую топологию синхронизации.

Конечная точка облака является указателем файлового ресурса Azure. Все конечные точки сервера будут синхронизироваться с облачной конечной точкой, превращая ее в центр. Учетная запись хранения файлового ресурса Azure должна располагаться в том же регионе, что и служба синхронизации хранилища. Общий файловый ресурс Azure будет синхронизирован с одним исключением: будет подготовлена специальная папка, сопоставимая со скрытой папкой "System Volume Information" на томе NTFS. Этот каталог называется ".SystemShareInformation". Он содержит важные метаданные синхронизации, которые не синхронизируются с другими конечными точками. Не используйте и не удаляйте его!

> [!Important]  
> В группе синхронизации можно внести изменения в любую облачную конечную точку или конечную точку сервера в группе синхронизации и синхронизировать файлы в другие конечные точки. Если вы вносите изменения непосредственно в облачную конечную точку (общий файловый ресурс Azure), эти изменения сначала должны быть определены заданием обнаружения изменений службы "Синхронизация файлов Azure". Задание обнаружения изменений инициируется для облачной конечной точки каждые 24 часа. Дополнительные сведения см. в статье [Часто задаваемые вопросы о службе файлов Azure](storage-files-faq.md#afs-change-detection).

# <a name="portal"></a>[Портал](#tab/azure-portal)
Чтобы создать группу синхронизации, на [портале Azure](https://portal.azure.com/)перейдите в службу синхронизации хранения, а затем выберите **группу синхронизации:**

![Создание группы синхронизации на портале Azure](media/storage-sync-files-deployment-guide/create-sync-group-1.png)

В открывшейся области введите следующую информацию, чтобы создать группу синхронизации с облачной конечной точкой:

- **Имя группы синхронизации**: Имя создаваемых групп ы синхронных синхронизации. Это имя должно быть уникальным в службе синхронизации хранилища. Вы можете выбрать любое подходящее имя.
- **Подписка.** Подписка, в которой развернута служба синхронизации хранилища из шага [Развертывание службы синхронизации хранилища](#deploy-the-storage-sync-service).
- **Учетная запись хранения.** Если щелкнуть **Выберите учетную запись хранения**, отобразится другая область. В ней можно выбрать учетную запись хранения с файловым ресурсом Azure, с которым нужно синхронизироваться.
- **Общая папка Azure.** Имя синхронизируемого файлового ресурса Azure.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
Чтобы создать группу синхронизации, выполните следующую команду PowerShell. Замените `<my-sync-group>` нужным именем группы синхронизации.

```powershell
$syncGroupName = "<my-sync-group>"
$syncGroup = New-AzStorageSyncGroup -ParentObject $storageSync -Name $syncGroupName
```

После успешного создания группы синхронизации можно создать облачную конечную точку. Замените `<my-storage-account>` и `<my-file-share>` фактическими значениями.

```powershell
# Get or create a storage account with desired name
$storageAccountName = "<my-storage-account>"
$storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroup | Where-Object {
    $_.StorageAccountName -eq $storageAccountName
}

if ($storageAccount -eq $null) {
    $storageAccount = New-AzStorageAccount `
        -Name $storageAccountName `
        -ResourceGroupName $resourceGroup `
        -Location $region `
        -SkuName Standard_LRS `
        -Kind StorageV2 `
        -EnableHttpsTrafficOnly:$true
}

# Get or create an Azure file share within the desired storage account
$fileShareName = "<my-file-share>"
$fileShare = Get-AzStorageShare -Context $storageAccount.Context | Where-Object {
    $_.Name -eq $fileShareName -and $_.IsSnapshot -eq $false
}

if ($fileShare -eq $null) {
    $fileShare = New-AzStorageShare -Context $storageAccount.Context -Name $fileShareName
}

# Create the cloud endpoint
New-AzStorageSyncCloudEndpoint `
    -Name $fileShare.Name `
    -ParentObject $syncGroup `
    -StorageAccountResourceId $storageAccount.Id `
    -AzureFileShareName $fileShare.Name
```

---

## <a name="create-a-server-endpoint"></a>Создание конечной точки сервера
Конечная точка сервера представляет собой определенное расположение на зарегистрированном сервере, например папку в томе сервера. Конечная точка сервера должна представлять собой путь на зарегистрированном сервере (а не на установленном ресурсе), а для распределения по уровням облака путь должен располагаться в несистемном томе. Запоминающее устройство, подключаемое к сети (NAS), не поддерживается.

# <a name="portal"></a>[Портал](#tab/azure-portal)
Чтобы добавить конечную точку сервера, перейдите в недавно созданную группу синхронизации, а затем выберите **Конечную точку добавления сервера.**

![Добавление новой конечной точки сервера в области группы синхронизации](media/storage-sync-files-deployment-guide/create-sync-group-2.png)

В панели **конечных точек Add Server** введите следующую информацию для создания конечной точки сервера:

- **Зарегистрированный сервер**: Имя сервера или кластера, где вы хотите создать конечную точку сервера.
- **Путь**: Путь Windows Server, который будет синхронизирован как часть группы синхронизации.
- **Уровни в облаке.** Параметр, позволяющий включать и отключать распределение по уровням облака. С помощью этого параметра редко используемые файлы можно распределить по уровням компонента "Файлы Azure".
- **Объем Свободного пространства**: количество свободного пространства для резервирования на том, на котором находится конечная точка сервера. Например, если объем свободного места тома с единственной конечной точкой сервера равен 50 %, примерно половина объема данных будет распределена по уровням компонента "Файлы Azure". Независимо от того, включено ли распределение по уровням в облаке, общий файловый ресурс Azure всегда содержит полную копию данных в группе синхронизации.

Чтобы добавить конечную точку сервера, выберите **Создать.** Теперь ваши файлы будут синхронизироваться по всем общим файловым ресурсам Azure и Windows Server. 

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
Выполните следующие команды PowerShell для создания конечной точки сервера и замените `<your-server-endpoint-path>` и `<your-volume-free-space>` нужными значениями.

```powershell
$serverEndpointPath = "<your-server-endpoint-path>"
$cloudTieringDesired = $true
$volumeFreeSpacePercentage = <your-volume-free-space>

if ($cloudTieringDesired) {
    # Ensure endpoint path is not the system volume
    $directoryRoot = [System.IO.Directory]::GetDirectoryRoot($serverEndpointPath)
    $osVolume = "$($env:SystemDrive)\"
    if ($directoryRoot -eq $osVolume) {
        throw [System.Exception]::new("Cloud tiering cannot be enabled on the system volume")
    }

    # Create server endpoint
    New-AzStorageSyncServerEndpoint `
        -Name $registeredServer.FriendlyName `
        -SyncGroup $syncGroup `
        -ServerResourceId $registeredServer.ResourceId `
        -ServerLocalPath $serverEndpointPath `
        -CloudTiering `
        -VolumeFreeSpacePercent $volumeFreeSpacePercentage
} else {
    # Create server endpoint
    New-AzStorageSyncServerEndpoint `
        -Name $registeredServer.FriendlyName `
        -SyncGroup $syncGroup `
        -ServerResourceId $registeredServer.ResourceId `
        -ServerLocalPath $serverEndpointPath 
}
```

---

## <a name="configure-firewall-and-virtual-network-settings"></a>Настройка параметров брандмауэра и виртуальных сетей

### <a name="portal"></a>Портал
Если вы хотите настроить синхронизацию файлов Azure для работы с брандмауэром и настройками виртуальной сети, сделайте следующее:

1. С портала Azure перейдите на учетную запись хранения, которая необходимо обеспечить.
1. Выберите кнопку **Firewalls и виртуальных сетей** в левом меню.
1. Выберите **Выбранные сети** под **allow access от**.
1. Убедитесь, что ваши серверы IP или виртуальная сеть указана в соответствующем разделе.
1. Убедитесь, что **проверка доступа доверенных служб Майкрософт к этой учетной записи хранилища.**
1. Выберите **Сохранить,** чтобы сохранить настройки.

![Настройка брандмауэра и виртуальных настроек сети для работы с синхронизацией файлов Azure](media/storage-sync-files-deployment-guide/firewall-and-vnet.png)

## <a name="onboarding-with-azure-file-sync"></a>Подключение с помощью службы синхронизации файлов Azure
Ниже приведены рекомендуемые действия для первого подключения с помощью службы синхронизации файлов Azure с нулевым временем простоя и сохранением соответствия файлов и списка управления доступом (ACL):
 
1. Разверните службу синхронизации хранилища.
2. Создайте группу синхронизации.
3. Установите агент службы синхронизации файлов Azure на сервере с полным набором данных.
4. Зарегистрируйте этот сервер и создайте конечную точку сервера на общем ресурсе. 
5. Дождитесь, пока служба синхронизация выполнит полную отправку данных на общий файловый ресурс Azure (в облачную конечную точку).  
6. После завершения первоначальной отправки установите агент синхронизации файлов Azure на всех оставшихся серверах.
7. Создайте новые общие файловые ресурсы на всех оставшихся серверах.
8. Создайте серверные конечные точки на новых файловых ресурсах с политикой распределения по уровням облака, если необходимо. (Для этого требуется дополнительное хранилище, доступное для первоначальной настройки.)
9. Позволяет агенту Azure File Sync быстро восстановить полное пространство имен без фактической передачи данных. После полной синхронизации пространства имен служба синхронизации заполнит место на локальном диске на основе политики распределения по уровням облака для серверной конечной точки. 
10. Дождитесь завершения синхронизации и протестируйте топологию нужным образом. 
11. Перенаправьте пользователей и приложения в новую общую папку.
12. При необходимости можно удалить все повторяющиеся общие папки на серверах.
 
Если дополнительное место для первоначального подключения отсутствует, но требуется присоединиться к существующим общим папкам, можно предварительно заполнить данными общие файловые ресурсы Azure. Такой подход рекомендуется, только если вы допускаете время простоя и можете гарантировать отсутствие изменений данных на общих ресурсах сервера в процессе исходного подключения. 
 
1. Убедитесь, что данные на любом из серверов не могут изменяться в процессе посадки.
2. Предварительное семя файлazна делится с серверными данными, используя любой инструмент передачи данных по SMB, например, Robocopy, прямую копию SMB. AzCopy не передает данных по протоколу SMB, поэтому средство не удастся использовать для предварительной отправки данных.
3. Создайте топологию службы синхронизации файлов Azure с нужными серверными конечными точками, указывающими на существующие общие папки.
4. Дождитесь, пока процесс синхронизации завершит сверку на всех конечных точках. 
5. После этого можно открыть общие ресурсы для внесения изменений.
 
В настоящее время подход к предварительному посеву имеет несколько ограничений - 
- Полная точность для файлов не сохраняется. Например, файлы теряют списки управления доступом и метки времени.
- Изменения данных на сервере до полного запуска топологии синхронизации могут вызывать конфликты на серверных конечных точках.  
- После создания конечная точка облака Azure File Sync запускает процесс обнаружения файлов в облаке перед началом первоначальной синхронизации. Время, задеваемые для завершения этого процесса, варьируется в зависимости от различных факторов, таких как скорость сети, доступная пропускная способность, а также количество файлов и папок. По грубой оценке в рамках предварительной версии процесс обнаружения выполняется со скоростью приблизительно 10 файлов в секунду. Таким образом, даже если предварительное заполнение завершится быстро, полный запуск системы может выполняться значительно дольше, когда данные предварительно заполняются в облаке.

## <a name="self-service-restore-through-previous-versions-and-vss-volume-shadow-copy-service"></a>Самообслуживание восстанавливается с помощью предыдущих версий и VSS (Служба копирования теней объемов)

> [!IMPORTANT]
> Следующая информация может быть использована только с версией 9 (или выше) агента синхронизации хранилища. Версии ниже 9 не будут иметь смдлетов StorageSyncSelfService.

Предыдущие версии — это функция Windows, которая позволяет использовать снимки VSS на стороне сервера объема для представления восстановитенных версий файла клиенту SMB.
Это позволяет создать мощный сценарий, обычно называемый восстановлением самообслуживания, непосредственно для работников, обладающих информацией, а не в зависимости от восстановления от ИТ-адиона.

Снимки VSS и предыдущие версии работают независимо от синхронизации файлов Azure. Однако многоуровневое облако должно быть настроено на совместимый режим. Многие конечные точки сервера Azure File Sync могут существовать в том же объеме. Вы должны сделать следующий вызов PowerShell на объем, который имеет даже один сервер конечный момент, где вы планируете или используете облачные многоуровневые.

```powershell
Import-Module ‘<SyncAgentInstallPath>\StorageSync.Management.ServerCmdlets.dll’
Enable-StorageSyncSelfServiceRestore [-DriveLetter] <string> [[-Force]] 
```

Снимки VSS сделаны из всего тома. По умолчанию для данного тома может существовать до 64 снимков, при этом имеется достаточно места для хранения снимков. VSS обрабатывает это автоматически. График моментальных снимков по умолчанию делает два снимка в день с понедельника по пятницу. Это расписание настраивается с помощью запланированной задачи Windows. Выше PowerShell cmdlet делает две вещи:
1. Он настраивает облачное русло Azure File Syncs на заданный том, чтобы быть совместимым с предыдущими версиями, и гарантирует, что файл может быть восстановлен из предыдущей версии, даже если он был многоуровневым в облако на сервере. 
2. Это позволяет по умолчанию VSS график. Затем вы можете принять решение изменить его позже. 

> [!Note]  
> При этом необходимо обратить внимание на два важных момента.
>- Если вы используете параметр -Force, и VSS в настоящее время включен, то он перезапишет текущее расписание снимков VSS и заменит его графиком по умолчанию. Убедитесь, что вы сохраните пользовательскую конфигурацию перед запуском cmdlet.
> - Если вы используете этот cmdlet на кластерном узлах, вы также должны запустить его на всех других узлах в кластере! 

Для того, чтобы увидеть, если самообслуживание восстановить совместимость включена, вы можете запустить следующий cmdlet.

```powershell
    Get-StorageSyncSelfServiceRestore [[-Driveletter] <string>]
```

В нем будут указаны все тома на сервере, а также количество совместимых дней, совместимых с облачным уровнем для каждого из них. Это число автоматически рассчитывается на основе максимально возможных моментальных снимков на объем и графика моментального снимка по умолчанию. Таким образом, по умолчанию все предыдущие версии, представленные информационному работнику, могут быть использованы для восстановления. То же самое верно, если вы измените график по умолчанию, чтобы сделать больше снимков.
Однако, если вы измените расписание таким образом, что это приведет к доступному моментальному снимку на томе, который старше значения совместимых дней, то пользователи не смогут использовать этот старый снимок (предыдущая версия) для восстановления.

> [!Note]
> Включение системы самообслуживания может повлиять на потребление и выставление счетов на хранилище Azure. Это воздействие ограничено файлами, которые в настоящее время многоуровневы на сервере. Включение этой функции гарантирует наличие файловой версии в облаке, на которую можно ссылаться через предыдущую версию (снимок VSS).
>
> Если отключить функцию, потребление хранилища Azure будет постепенно снижаться до тех пор, пока не пройдет окно совместимых дней. Нет никакого способа ускорить это. 

Максимальное количество снимков VSS на один том (64), а также график выполнения по умолчанию, чтобы взять их, приводят к тому, что максимум 45 дней предыдущих версий может восстановить сотрудник информации, в зависимости от того, сколько снимков VSS можно хранить на вашем томе.

Если макс. 64 снимка VSS на объем не является правильной настройкой для вас, вы можете [изменить это значение через ключ реестра.](https://docs.microsoft.com/windows/win32/backup/registry-keys-for-backup-and-restore#maxshadowcopies)
Для того чтобы новый лимит вступил в силу, необходимо повторно запустить cmdlet, чтобы обеспечить совместимость предыдущей версии на каждом томе, который он был включен ранее, с флагом -Force, чтобы принять новое максимальное количество снимков VSS на объем во внимание. Это приведет к вновь рассчитанному числу совместимых дней. Обратите внимание, что это изменение вступит в силу только на новых многоуровневых файлах и перезапишет любые настройки в расписании VSS, который вы могли бы сделать.

## <a name="migrate-a-dfs-replication-dfs-r-deployment-to-azure-file-sync"></a>Перенос развертывания репликации DFS (DFS-R) в службу синхронизации файлов Azure
Чтобы перенести развертывание DFS-R в службу "Синхронизация файлов Azure", сделайте следующее:

1. Создайте группу синхронизации для представления топологии DFS-R, которую требуется заменить.
2. Начните с сервера с полным набором данных в топологии DFS-R, которую следует перенести. Установите службу "Синхронизация файлов" Azure на этом сервере.
3. Зарегистрируйте этот сервер и создайте серверную конечную точку для переноса первого сервера. Не включайте распределение по уровням облака.
4. Выполните синхронизацию всех данных с файловым ресурсом Azure (облачной конечной точкой).
5. Установите и зарегистрируйте агент синхронизации файлов Azure на каждом из оставшихся серверов DFS-R.
6. Отключите DFS-R. 
7. Создайте серверную конечную точку на каждом из серверов DFS-R. Не включайте распределение по уровням облака.
8. Дождитесь завершения синхронизации и протестируйте топологию нужным образом.
9. Снимите DFS-R с учета.
10. Теперь можно включить распределение по уровням облака на любой серверной конечной точке.

Дополнительные сведения см. в статье [Azure File Sync interop with Distributed File System (DFS)](storage-sync-files-planning.md#distributed-file-system-dfs) (Взаимодействие службы "Синхронизация файлов Azure" с распределенной файловой системой (DFS)).

## <a name="next-steps"></a>Дальнейшие действия
- [Добавление и удаление конечных точек сервера службы синхронизации файлов Azure](storage-sync-files-server-endpoint.md)
- [Регистрация и отмена регистрации сервера в службе синхронизации файлов Azure (предварительная версия)](storage-sync-files-server-registration.md)
- [Мониторинг службы "Синхронизация файлов Azure"](storage-sync-files-monitoring.md)
