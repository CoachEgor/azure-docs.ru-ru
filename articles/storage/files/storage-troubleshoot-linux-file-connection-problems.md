---
title: Устранение неполадок службы файлов Azure в Linux | Документация Майкрософт
description: Сведения об устранении неполадок со службой файлов Azure в Linux.
services: storage
author: jeffpatt24
tags: storage
ms.service: storage
ms.topic: article
ms.date: 10/16/2018
ms.author: jeffpatt
ms.subservice: files
ms.openlocfilehash: 232b4ca2ee4f3137069ed155cc82a5c5e3251420
ms.sourcegitcommit: 47ce9ac1eb1561810b8e4242c45127f7b4a4aa1a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67807276"
---
# <a name="troubleshoot-azure-files-problems-in-linux"></a>Устранение неполадок службы файлов Azure в Linux

В этой статье приведен список распространенных проблем, возникающих в службе файлов Azure при подключении из клиентов Linux. Кроме того, здесь представлены возможные причины этих проблем и способы их устранения. 

Помимо действий по устранению неполадок, описываемых в этой статье, можно использовать [AzFileDiagnostics](https://gallery.technet.microsoft.com/Troubleshooting-tool-for-02184089), чтобы обеспечить выполнение необходимых условий для клиента Linux. AzFileDiagnostics автоматизирует обнаружение большинства симптомов, упомянутых в этой статье. Это средство помогает настроить среду для оптимальной производительности. См. дополнительные сведения о [средстве устранения неполадок для общих файловых ресурсов Azure](https://support.microsoft.com/help/4022301/troubleshooter-for-azure-files-shares). Это средство предоставляет действия, которые помогут вам решить проблемы с подключением, сопоставлением и подключением общих файловых ресурсов Azure.

## <a name="cannot-connect-to-or-mount-an-azure-file-share"></a>Не удается подключиться к файловому ресурсу Azure или подключить ее

### <a name="cause"></a>Причина:

Ниже приведены распространенные причины этой проблемы:

- Вы используете клиент из несовместимого дистрибутива Linux. Мы рекомендуем использовать для подключения к файловому ресурсу Azure следующие дистрибутивы Linux:

|   | SMB 2.1 <br>(подключение на виртуальных машинах в том же регионе Azure) | SMB 3.0 <br>(подключение из локальной среды и между регионами) |
| --- | :---: | :---: |
| Сервер Ubuntu | 14.04 или более поздней версии | 16.04 или выше |
| RHEL | 7 или выше | 7.5+ |
| CentOS | 7 или выше |  7.5+ |
| Debian | 8+ |   |
| openSUSE | 13.2 или выше | 42.3+ |
| SUSE Linux Enterprise Server | 12 | 12 SP3 или выше |

- На клиенте не установлены служебные программы CIFS (cfs-utils).
- На клиенте не установлена минимальная необходимая версия SMB или CIFS 2.1.
- На клиенте не поддерживается шифрование SMB 3.0. Приведенной выше таблице содержит список дистрибутивов Linux, поддержку подключения из локальных и между регионами с помощью шифрования. В других дистрибутивах нужно использовать ядро 4.11 или более поздней версии.
- Вы пытаетесь подключиться к учетной записи хранения через TCP-порт 445, который не поддерживается.
- Вы пытаетесь подключиться к файловому ресурсу Azure с виртуальной машины Azure, которая не находится в одном регионе с учетной записью хранения.
- Если для учетной записи хранения включен параметр [Требуется безопасное перемещение]( https://docs.microsoft.com/azure/storage/common/storage-require-secure-transfer), то служба файлов Azure разрешает подключения только по протоколу SMB 3.0 с шифрованием.

### <a name="solution"></a>Решение

Чтобы устранить эту проблему, используйте [средство устранения неполадок с подключением в службе файлов Azure для Linux](https://gallery.technet.microsoft.com/Troubleshooting-tool-for-02184089). Это средство предоставляет следующие возможности:

* Помогает проверить среду выполнения клиента.
* Выявляет несовместимые конфигурации клиента, которые приведут к ошибкам доступа в файлах Azure.
* Предоставляет рекомендации для самостоятельного исправления.
* Собирает диагностические трассировки.

<a id="mounterror13"></a>
## <a name="mount-error13-permission-denied-when-you-mount-an-azure-file-share"></a>"Ошибка подключения(13). Отказ в разрешении" при подключении общего файлового ресурса Azure

### <a name="cause-1-unencrypted-communication-channel"></a>Причина 1. Незашифрованный коммуникационный канал

Из соображений безопасности, если коммуникационный канал не зашифрован, а попытка подключения осуществляется не из того же центра обработки данных, в котором находятся файловые ресурсы Azure, то подключение к ним Azure будет заблокировано. Незашифрованные подключения в одном центре обработки данных также могут быть заблокированы, если в учетной записи хранения включен параметр [Требуется безопасное перемещение](https://docs.microsoft.com/azure/storage/common/storage-require-secure-transfer). Шифрование коммуникационного канала выполняется, только если клиентская ОС пользователя поддерживает шифрование SMB.

Подробнее см. в статье [Предварительные требования для подключения файлового ресурса Azure с помощью Linux и пакета cifs-utils](https://docs.microsoft.com/azure/storage/files/storage-how-to-use-files-linux#prerequisites-for-mounting-an-azure-file-share-with-linux-and-the-cifs-utils-package). 

### <a name="solution-for-cause-1"></a>Решение для причины 1

1. Подключитесь из клиента, поддерживающего шифрование SMB, или из виртуальной машины, размещенной в том же центре обработки данных, что и учетная запись хранения Azure, используемая для файлового ресурса Azure.
2. Убедитесь, что параметр [Требуется безопасное перемещение](https://docs.microsoft.com/azure/storage/common/storage-require-secure-transfer) отключен в учетной записи хранения, если клиент не поддерживает шифрование SMB.

### <a name="cause-2-virtual-network-or-firewall-rules-are-enabled-on-the-storage-account"></a>Причина 2. Правила виртуальной сети или брандмауэра включены для учетной записи хранения 

Если для учетной записи хранения настроены правила виртуальной сети и брандмауэра, доступ сетевого трафика будет запрещен, если IP-адрес клиента или виртуальная сеть не разрешают доступ.

### <a name="solution-for-cause-2"></a>Решение для причины 2

Убедитесь, что правила виртуальной сети и брандмауэра настроены надлежащим образом для учетной записи хранения. Чтобы проверить, связана ли проблема с правилами виртуальной сети или брандмауэра, временно задайте для учетной записи хранения параметр **Разрешить доступ из всех сетей**. Подробнее см. в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей (предварительная версия)](https://docs.microsoft.com/azure/storage/common/storage-network-security).

<a id="permissiondenied"></a>
## <a name="permission-denied-disk-quota-exceeded-when-you-try-to-open-a-file"></a>Отображается сообщение "[permission denied] Disk quota exceeded" ([Отказано в разрешении]. Превышена дисковая квота) при попытке открыть файл

Работая в Linux, вы получаете сообщение об ошибке, которое имеет следующий вид.

**\<Имя файла > [отказано в доступе]: Превышена дисковая квота**

### <a name="cause"></a>Причина:

Достигнуто максимально допустимое число открытых дескрипторов, разрешенных для файла.

Установлена квота в 2000 открытых дескрипторов на один файл. По достижении этого ограничения вы увидите соответствующую ошибку.

### <a name="solution"></a>Решение

Сократите количество одновременно открытых дескрипторов, закрыв некоторые из них, и повторите операцию.

Чтобы просмотреть открытые дескрипторы для общей папки, каталога или файла, используйте [Get AzStorageFileHandle](https://docs.microsoft.com/powershell/module/az.storage/get-azstoragefilehandle) командлета PowerShell.  

Чтобы закрыть открытые дескрипторы для общей папки, каталога или файла, используйте [AzStorageFileHandle закрыть](https://docs.microsoft.com/powershell/module/az.storage/close-azstoragefilehandle) командлета PowerShell.

> [!Note]  
> Командлеты Get-AzStorageFileHandle и закрыть AzStorageFileHandle включаются в Az модуль PowerShell версии 2.4 или более поздней версии. Чтобы установить последнюю версию модуля Az PowerShell, см. в разделе [установить модуль Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps).

<a id="slowfilecopying"></a>
## <a name="slow-file-copying-to-and-from-azure-files-in-linux"></a>Медленное копирование файлов в службе файлов Azure и из нее в Linux

- Если определенные требования к минимальному размеру операций ввода-вывода отсутствуют, для оптимальной производительности мы рекомендуем использовать 1 МиБ.
- Используйте правильный метод копирования:
    - Используйте [AZCopy](../common/storage-use-azcopy.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) для передачи данных между двумя файловыми ресурсами.
    - Использование cp или дд в параллельном режиме может повысить скорость копирования, число потоков зависит от варианта использования и рабочей нагрузки. В следующих примерах используется шесть: 
    - Пример CP (cp используется размер блока по умолчанию в файловой системе как размер фрагмента данных): `find * -type f | parallel --will-cite -j 6 cp {} /mntpremium/ &`.
    - дд пример (эта команда явно задает размер блока 1 MiB). `find * -type f | parallel --will-cite-j 6 dd if={} of=/mnt/share/{} bs=1M`
    - Откройте исходный сторонние инструменты, например:
        - [Параллельный GNU](https://www.gnu.org/software/parallel/).
        - [Fpart](https://github.com/martymac/fpart) — Сортировка файлов и упаковывает их в секции.
        - [Fpsync](https://github.com/martymac/fpart/blob/master/tools/fpsync) -использует Fpart и средство для копирования для создания нескольких экземпляров для переноса данных из src_dir dst_url.
        - [С несколькими](https://github.com/pkolano/mutil) -многопоточных cp и контрольной суммы MD5 с учетом GNU coreutils.
- Установив размер файла заранее вместо чтобы каждая запись расширять записи, помогает повысить скорость копирования в сценариях, где известен размер файла. Если расширение необходимость записи избегать, можно задать размер файла назначения с `truncate - size <size><file>` команды. После этого `dd if=<source> of=<target> bs=1M conv=notrunc`команда скопирует исходный файл не нужно повторно обновить размер целевого файла. Например, можно задать размер целевого файла для каждого файла, который требуется скопировать (предположим, ресурс подключен/mnt/общей папке):
    - `$ for i in `` find * -type f``; do truncate --size ``stat -c%s $i`` /mnt/share/$i; done`
    - и - скопируйте файлы без расширения операции записи в параллельном режиме: `$find * -type f | parallel -j6 dd if={} of =/mnt/share/{} bs=1M conv=notrunc`

<a id="error115"></a>
## <a name="mount-error115-operation-now-in-progress-when-you-mount-azure-files-by-using-smb-30"></a>"Ошибка подключения(115). Операция выполняется" при подключении службы файлов Azure с помощью SMB 3.0

### <a name="cause"></a>Причина:

Сейчас некоторые дистрибутивы Linux не поддерживают функции шифрования в SMB 3.0. Из-за этого при попытке подключения службы файлов Azure с помощью SMB 3.0 пользователь может получить сообщение об ошибке 115. Сейчас SMB 3.0 с полным шифрованием поддерживается только в Ubuntu 16.04 или более поздней версии.

### <a name="solution"></a>Решение

Функция шифрования протокола SMB 3.0 для Linux появилась в ядре версии 4.11. Эта функция позволяет подключать файловый ресурс Azure из локальной среды или другого региона Azure. Эта функция входит в дистрибутивах Linux, перечисленные в [минимальный рекомендуемый версии с соответствующие возможности подключения (SMB версии 2.1 и SMB версии 3.0)](storage-how-to-use-files-linux.md#minimum-recommended-versions-with-corresponding-mount-capabilities-smb-version-21-vs-smb-version-30). В других дистрибутивах нужно использовать ядро 4.11 или более поздней версии.

Если используемый SMB-клиент Linux не поддерживает шифрование, подключите службу файлов Azure с помощью SMB 2.1 с виртуальной машины Linux в Azure, которая расположена в том же центре обработки данных, что и общий файловый ресурс. Убедитесь, что параметр [Требуется безопасное перемещение]( https://docs.microsoft.com/azure/storage/common/storage-require-secure-transfer) отключен в учетной записи хранения. 

<a id="authorizationfailureportal"></a>
## <a name="error-authorization-failure-when-browsing-to-an-azure-file-share-in-the-portal"></a>Ошибка «Сбой авторизации» при переходе по файловый ресурс Azure на портале

При переходе к общему файловому ресурсу Azure на портале, может появиться следующая ошибка.

Сбой авторизации  
Нет доступа

### <a name="cause-1-your-user-account-does-not-have-access-to-the-storage-account"></a>Причина 1. Учетная запись пользователя не имеет доступа к учетной записи хранения

### <a name="solution-for-cause-1"></a>Решение для причины 1

Перейдите в учетную запись хранения, в которой размещается общий файловый ресурс Azure, щелкните **Управление доступом (IAM)** и убедитесь, что учетная запись пользователя имеет доступ к учетной записи хранения. Подробнее см. в статье [Защита учетной записи хранения с помощью управления доступом на основе ролей (RBAC)](https://docs.microsoft.com/azure/storage/common/storage-security-guide#how-to-secure-your-storage-account-with-role-based-access-control-rbac).

### <a name="cause-2-virtual-network-or-firewall-rules-are-enabled-on-the-storage-account"></a>Причина 2. Правила виртуальной сети или брандмауэра включены для учетной записи хранения

### <a name="solution-for-cause-2"></a>Решение для причины 2

Убедитесь, что правила виртуальной сети и брандмауэра настроены надлежащим образом для учетной записи хранения. Чтобы проверить, связана ли проблема с правилами виртуальной сети или брандмауэра, временно задайте для учетной записи хранения параметр **Разрешить доступ из всех сетей**. Подробнее см. в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей (предварительная версия)](https://docs.microsoft.com/azure/storage/common/storage-network-security).

<a id="open-handles"></a>
## <a name="unable-to-delete-a-file-or-directory-in-an-azure-file-share"></a>Не удалось удалить файл или каталог в файловый ресурс Azure

### <a name="cause"></a>Причина:
Эта проблема обычно возникает, если файл или каталог имеет открытый дескриптор. 

### <a name="solution"></a>Решение

Если клиенты SMB закрыты все открытые дескрипторы и проблема продолжает возникать, сделайте следующее:

- Используйте [Get AzStorageFileHandle](https://docs.microsoft.com/powershell/module/az.storage/get-azstoragefilehandle) командлет PowerShell, чтобы просмотреть открытых дескрипторов.

- Используйте [AzStorageFileHandle закрыть](https://docs.microsoft.com/powershell/module/az.storage/close-azstoragefilehandle) командлет PowerShell, чтобы закрыть открытых дескрипторов. 

> [!Note]  
> Командлеты Get-AzStorageFileHandle и закрыть AzStorageFileHandle включаются в Az модуль PowerShell версии 2.4 или более поздней версии. Чтобы установить последнюю версию модуля Az PowerShell, см. в разделе [установить модуль Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps).

<a id="slowperformance"></a>
## <a name="slow-performance-on-an-azure-file-share-mounted-on-a-linux-vm"></a>Низкая производительность файлового ресурса Azure, подключенного к виртуальной машине Linux

### <a name="cause-1-caching"></a>Причина 1. Caching

Одной из возможных причин снижения производительности может быть отключенное кэширование. Кэширование может быть полезно, если вы обращаетесь к файл несколько раз, в противном случае это может быть нагрузку. Проверьте, если вы используете кэш перед его отключением.

### <a name="solution-for-cause-1"></a>Решение для причины 1

Чтобы проверить, отключено ли кэширование, найдите запись **cache=** .

Запись **cache=none** означает, что кэширование отключено. Повторно подключите общедоступный ресурс, введя команду mount по умолчанию или явно добавив в нее параметр **cache=strict**, чтобы включить режим кэширования по умолчанию или "строгий" режим кэширования соответственно.

В некоторых сценариях параметр подключения **serverino** может привести к тому, что команда **ls** формирует статистику для каждой записи каталога. Такое поведение приводит к снижению производительности при выводе содержимого больших каталогов. Параметры подключения можно просмотреть в записи **/etc/fstab**.

`//azureuser.file.core.windows.net/cifs /cifs cifs vers=2.1,serverino,username=xxx,password=xxx,dir_mode=0777,file_mode=0777`

Можно также проверить, правильные ли параметры используются, выполнив команду **sudo mount | grep cifs** и проверив ее выходные данные. Пример выходных данных этой команды приведен ниже.

```
//azureuser.file.core.windows.net/cifs on /cifs type cifs (rw,relatime,vers=2.1,sec=ntlmssp,cache=strict,username=xxx,domain=X,uid=0,noforceuid,gid=0,noforcegid,addr=192.168.10.1,file_mode=0777, dir_mode=0777,persistenthandles,nounix,serverino,mapposix,rsize=1048576,wsize=1048576,actimeo=1)
```

Если параметр **cache=strict** или **serverino** отсутствует, отключите и повторно подключите службу файлов Azure, выполнив команду mount из [этой статьи](../storage-how-to-use-files-linux.md). Затем еще раз проверьте наличие правильных параметров в записи **/etc/fstab**.

### <a name="cause-2-throttling"></a>Причина 2. Регулирование

Вполне возможно, наблюдается регулирование и запросы отправляются в очередь. Это можно проверить с помощью [метрики службы хранилища Azure в Azure Monitor](../common/storage-metrics-in-azure-monitor.md).

### <a name="solution-for-cause-2"></a>Решение для причины 2

Убедитесь, ваше приложение находится в пределах [целевые показатели масштабирования службы файлов Azure](storage-files-scale-targets.md#azure-files-scale-targets).

<a id="timestampslost"></a>
## <a name="time-stamps-were-lost-in-copying-files-from-windows-to-linux"></a>При копировании файлов из Windows в Linux были потеряны метки времени

На платформах Linux и Unix команда **cp -p** завершается сбоем, если файл 1 и файл 2 принадлежат разным пользователям.

### <a name="cause"></a>Причина:

Флаг принудительного применения **f** в COPYFILE приводит к выполнению команды **cp -p -f** в Unix. Этой команде также не удается сохранить метку времени файла, который вам не принадлежит.

### <a name="workaround"></a>Возможное решение

Используйте пользователя учетной записи хранения для копирования файлов.

- `Useadd : [storage account name]`
- `Passwd [storage account name]`
- `Su [storage account name]`
- `Cp -p filename.txt /share`

## <a name="ls-cannot-access-ltpathgt-inputoutput-error"></a>ls: cannot access '&lt;path&gt;': Input/output error (ls: невозможно получить доступ к "путь".Ошибка ввода-вывода)

Если вы попытаетесь перечислить файлы в общем файловом ресурсе Azure с помощью команды ls, команда зависнет. Вы увидите следующую ошибку:

**ls: cannot access'&lt;path&gt;': Input/output error** (ls: невозможно получить доступ к "путь".Ошибка ввода-вывода)


### <a name="solution"></a>Решение
Обновите ядро Linux до одной следующих версий, в которых эта проблема уже решена:

- 4.4.87+;
- 4.9.48+;
- 4.12.11+;
- любая версия не ниже 4.13.

## <a name="cannot-create-symbolic-links---ln-failed-to-create-symbolic-link-t-operation-not-supported"></a>Не удается создать символьные ссылки — ln: failed to create symbolic link 't': Operation not supported (ln: не удалось создать символьную ссылку "t". Операция не поддерживается)

### <a name="cause"></a>Причина:
По умолчанию при подключении файловых ресурсов Azure в Linux с помощью CIFS не поддерживается использование символьных ссылок (symlink). Ошибка будет выглядеть примерно так:
```
ln -s linked -n t
ln: failed to create symbolic link 't': Operation not supported
```
### <a name="solution"></a>Решение
Клиент CIFS в Linux не поддерживает создание символьных ссылок в стиле Windows по протоколу SMB 2 или 3. Сейчас клиент Linux поддерживает для операций создания и отслеживания символьные ссылки в другом стиле ([Minshall/French](https://wiki.samba.org/index.php/UNIX_Extensions#Minshall.2BFrench_symlinks)). Если клиенту требуются символьные ссылки, он может использовать параметр подключения mfsymlinks. Мы рекомендуем использовать mfsymlinks, так как этот формат используется компьютерами Mac.

Чтобы использовать символьные ссылки, добавьте следующий текст в конец команды подключения CIFS:

```
,mfsymlinks
```

Команда будет выглядеть примерно так:

```
sudo mount -t cifs //<storage-account-name>.file.core.windows.net/<share-name> <mount-point> -o vers=<smb-version>,username=<storage-account-name>,password=<storage-account-key>,dir_mode=0777,file_mode=0777,serverino,mfsymlinks
```

Теперь вы сможете создавать символьные ссылки, как описано на [вики-сайте](https://wiki.samba.org/index.php/UNIX_Extensions#Storing_symlinks_on_Windows_servers).

[!INCLUDE [storage-files-condition-headers](../../../includes/storage-files-condition-headers.md)]

<a id="error112"></a>
## <a name="mount-error112-host-is-down-because-of-a-reconnection-time-out"></a>"Ошибка подключения(112). Узел не работает" из-за истечения времени ожидания повторного подключения

Ошибка подключения (112) возникает в клиенте Linux, если он бездействует в течение длительного времени. Когда клиент долгое время бездействует, он отключается, и время ожидания его подключения истекает.  

### <a name="cause"></a>Причина:

Подключение может бездействовать по следующим причинам:

-   сбои сети, которые мешают повторно установить подключение TCP к серверу, если используется режим "мягкого" подключения (режим по умолчанию);
-   последние исправления повторного подключения, отсутствующие в ядрах предыдущих версий.

### <a name="solution"></a>Решение

Эта проблема повторного подключения в ядре Linux исправлена в рамках следующих изменений:

- [Исправление повторного подключения к неотложенному сеансу переподключения mb3 через продолжительное время после повторного подключения сокета](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/cifs?id=4fcd1813e6404dd4420c7d12fb483f9320f0bf93)
- [Вызов службы echo сразу же после повторного подключения сокета](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b8c600120fc87d53642476f48c8055b38d6e14c7)
- [CIFS: устранение возможного повреждения содержимого памяти во время повторного подключения](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=53e0e11efe9289535b060a51d4cf37c25e0d0f2b)
- [CIFS: устранение возможной двойной блокировки мьютекса во время повторного подключения — для ядра v4.9 и более поздних версий](https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=96a988ffeb90dba33a71c3826086fe67c897a183)

Тем не менее эти изменения могут быть перенесены еще не во все дистрибутивы Linux. Это исправление и другие исправления повторного подключения можно найти в [минимальный рекомендуемый версии с соответствующие возможности подключения (SMB версии 2.1 и SMB версии 3.0)](storage-how-to-use-files-linux.md#minimum-recommended-versions-with-corresponding-mount-capabilities-smb-version-21-vs-smb-version-30) раздел [использования файлов Azure с Linux](storage-how-to-use-files-linux.md)статьи. Это исправление можно получить, выполнив обновление до одной из этих рекомендуемых версий ядра.

### <a name="workaround"></a>Возможное решение

Можно обойти эту проблему, указав жесткое подключение. Жесткое подключение вынудит клиент ожидать установки подключения или явного прерывания. Вы можете использовать этот вариант, чтобы избежать ошибок из-за истечения времени ожидания сети. Тем не менее этот способ может породить неопределенное время ожидания. Будьте готовы останавливать подключения при необходимости.

Если не удается выполнить обновление до последних версий ядра, можно решить эту проблему, поместив в файловый ресурс Azure файл и перезаписывая его каждые 30 секунд (или чаще). Это должна быть операция записи, такая как перезапись даты создания или изменения файла. В противном случае можно получить кэшированные результаты, в итоге операция записи не активирует повторное подключение.

## <a name="need-help-contact-support"></a>Требуется помощь? Обратитесь в службу поддержки.

Если вам все еще нужна помощь, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), которая поможет быстро устранить проблему.
