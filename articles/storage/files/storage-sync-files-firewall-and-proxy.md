---
title: Локальные параметры брандмауэра и прокси-сервера для службы "Синхронизация файлов Azure" | Документация Майкрософт
description: Конфигурация локальной сети для службы "Синхронизация файлов Azure".
services: storage
author: roygara
ms.service: storage
ms.topic: article
ms.date: 06/24/2019
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 33d5be20682c8341932a2a0021ccda27583775bd
ms.sourcegitcommit: e9c866e9dad4588f3a361ca6e2888aeef208fc35
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/19/2019
ms.locfileid: "68335970"
---
# <a name="azure-file-sync-proxy-and-firewall-settings"></a>Параметры брандмауэра и прокси-сервера службы "Синхронизация файлов Azure"
Служба "Синхронизация файлов Azure" подключает локальные серверы к службе файлов Azure, обеспечивая синхронизацию нескольких сайтов и распределение данных по уровням облака. Таким образом локальный сервер должен быть подключен к Интернету. Администратор отдела ИТ должен выбрать наилучший путь подключения сервера к облачным службам Azure.

В этой статье описываются особые требования и возможности, позволяющие создать безопасное подключение сервера к службе "Синхронизация файлов Azure".

## <a name="overview"></a>Обзор
Служба "Синхронизация файлов Azure" действует как служба оркестрации между Windows Server, вашим файловым ресурсом Azure и несколькими другими службами Azure, которая синхронизирует данные, как описано в группе синхронизации. Чтобы служба "Синхронизация файлов Azure" работала правильно, необходимо настроить серверы для взаимодействия со следующими службами Azure.

- Служба хранилища Azure
- Синхронизация файлов Azure
- Azure Resource Manager
- Службы аутентификации

> [!Note]  
> Агент службы "Синхронизация файлов Azure" на сервере Windows инициирует все запросы к облачным службам, поэтому в брандмауэре следует учитывать только исходящий трафик. <br /> Ни одна из служб Azure не инициирует подключение к агенту службы "Синхронизация файлов Azure".

## <a name="ports"></a>Порты
Служба "Синхронизация файлов Azure" перемещает файлы данных и метаданные только по протоколу HTTPS, и порт 443 должен быть открыт для исходящего трафика.
В результате шифруется весь трафик.

## <a name="networks-and-special-connections-to-azure"></a>Сети и специальные подключения к Azure
Агент службы "Синхронизация файлов Azure" не накладывает какие-либо требования в отношении специальных каналов, например [ExpressRoute](../../expressroute/expressroute-introduction.md), в Azure.

Служба "Синхронизация файлов Azure" будет использовать все доступные средства связи с Azure, автоматически адаптируясь к различным характеристикам сетей (пропускной способности, задержке и т. д.). Кроме того, она предоставляет административный контроль для точной настройки. Некоторые возможности сейчас недоступны. Если вы хотите настроить определенное поведение, свяжитесь с нами с помощью сайта [UserVoice для службы файлов Azure](https://feedback.azure.com/forums/217298-storage?category_id=180670).

## <a name="proxy"></a>Прокси-сервер
Служба "Синхронизация файлов Azure" поддерживает параметры прокси-сервера для конкретных приложений и для всего компьютера.

**Параметры прокси-сервера для конкретных приложений** позволяют настроить прокси-сервер специально для трафика службы "Синхронизация файлов Azure". Параметры прокси-сервера для конкретных приложений поддерживаются в версии агента 4.0.1.0 и более поздних версиях. Их можно настроить во время установки агента или с помощью командлета PowerShell Set-StorageSyncProxyConfiguration.

Команды PowerShell для настройки параметров прокси-сервера для конкретных приложений:
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Set-StorageSyncProxyConfiguration -Address <url> -Port <port number> -ProxyCredential <credentials>
```
**Параметры прокси-сервера для компьютера** являются прозрачными для агента службы "Синхронизация файлов Azure", так как весь трафик сервера направляется через этот прокси-сервер.

Чтобы настроить параметры прокси-сервера для компьютера, выполните следующие действия: 

1. Настройте параметры прокси-сервера для приложений .NET 

   - Измените следующие два файла:  
     C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\machine.config  
     C:\Windows\Microsoft.NET\Framework\v4.0.30319\Config\machine.config

   - Добавьте раздел <system.net> в файлы machine.config (в раздел <system.serviceModel>).  Измените 127.0.01:8888 на IP-адрес и порт для прокси-сервера. 
     ```
      <system.net>
        <defaultProxy enabled="true" useDefaultCredentials="true">
          <proxy autoDetect="false" bypassonlocal="false" proxyaddress="http://127.0.0.1:8888" usesystemdefault="false" />
        </defaultProxy>
      </system.net>
     ```

2. Задайте параметры прокси-сервера WinHTTP 

   - Выполните следующую команду в командной строке с повышенными привилегиями или PowerShell, чтобы увидеть существующие параметры прокси-сервера:   

     netsh winhttp show proxy

   - Выполните следующую команду в командной строке с повышенными привилегиями или PowerShell, чтобы задать параметры прокси-сервера (измените 127.0.01:8888 на IP-адрес и порт для прокси-сервера):  

     netsh winhttp set proxy 127.0.0.1:8888

3. Перезапустите службу агента синхронизации хранилища, выполнив следующую команду в командной строке с повышенными привилегиями или PowerShell: 

      net stop filesyncsvc

      Примечание. Служба агента синхронизации хранилища (filesyncsvc) автоматически запустится после остановки.

## <a name="firewall"></a>Брандмауэр
Как упоминалось в предыдущем разделе, порт 443 необходимо открыть для исходящего трафика. В зависимости от политик в центре обработки данных, филиале или регионе, возможно необязательное или обязательное наложение дополнительных ограничений трафика, проходящего через этот порт в определенные домены.

В следующей таблице описаны требуемые домены для обмена данными.

| Служба | Конечная точка общедоступного облака | Конечная точка Azure для государственных организаций | Использование |
|---------|----------------|---------------|------------------------------|
| **Azure Resource Manager** | https://management.azure.com | https://management.usgovcloudapi.net | Любой вызов пользователя (например, PowerShell) проходит через этот URL-адрес, включая вызов для начальной регистрации сервера. |
| **Azure Active Directory** | https://login.windows.net | https://login.microsoftonline.us | Вызовы Azure Resource Manager должны осуществляться пользователем, прошедшим аутентификацию. Чтобы вызовы могли быть выполнены, этот URL-адрес используется для аутентификации пользователей. |
| **Azure Active Directory** | https://graph.windows.net/ | https://graph.windows.net/ | В ходе развертывания службы "Синхронизация файлов Azure" в подписке Azure Active Directory будет создан субъект-служба. Для этого используется данный URL-адрес. Этот субъект используется для делегирования минимального набора прав службе "Синхронизация файлов Azure". Пользователь, выполняющий начальную настройку службы "Синхронизация файлов Azure", должен иметь привилегии владельца подписки. |
| **Хранилище Azure** | &ast;.core.windows.net | &ast;. core.usgovcloudapi.net | Когда сервер скачивает файл, он эффективнее перемещает данные, если напрямую обращается к файловому ресурсу Azure в учетной записи хранения. Сервер имеет ключ SAS, предоставляющий доступ только к целевому файловому ресурсу. |
| **Служба "Синхронизация файлов Azure"** | &ast;.one.microsoft.com | &ast;. afs.azure.us | После начальной регистрации сервер получает URL-адрес экземпляра службы "Синхронизация файлов Azure" в этом регионе. Сервер может использовать этот URL-адрес для прямого и эффективного взаимодействия с экземпляром, выполняющим его синхронизацию. |
| **Microsoft PKI** | `https://www.microsoft.com/pki/mscorp`<br /><http://ocsp.msocsp.com> | `https://www.microsoft.com/pki/mscorp`<br /><http://ocsp.msocsp.com> | После установки агента службы "Синхронизация файлов Azure" с помощью URL-адреса PKI загружаются промежуточные сертификаты, обеспечивающие обмен данными между службой "Синхронизация файлов Azure" и файловым ресурсом Azure. С помощью URL-адреса OCSP проверяется состояние сертификата. |

> [!Important]
> Если разрешить передачу трафика в &ast;.one.microsoft.com, то с сервера будет передаваться не только трафик для службы синхронизации. В поддоменах могут размещаться многие другие службы Майкрософт.

Если &ast;.one.microsoft.com задает слишком много адресов, обмен данными с сервером можно ограничить, разрешив обмен данными только с региональными экземплярами службы "Синхронизация файлов Azure". Выбор экземпляров зависит от региона службы синхронизации хранилища, в котором развернут и зарегистрирован сервер. Этот регион называется "URL-адрес основной конечной точки" в таблице ниже.

В целях обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR) вы могли разместить файловые ресурсы Azure в учетной записи глобально избыточного хранилища (GRS). Если это так, тогда в случае продолжительного регионального сбоя будет выполнена отработка отказа файловых ресурсов Azure в связанный регион. Служба "Синхронизация файлов Azure" использует те же региональные связи, что и хранилище. Поэтому при использовании учетных записей хранения GRS необходимо включить дополнительные URL-адреса, чтобы разрешить серверу обращаться к связанному региону службы "Синхронизация файлов Azure". В таблице ниже такой регион называется парным. Кроме того, есть URL-адрес профиля диспетчера трафика, который также должен быть включен. Это позволяет гарантировать простое перенаправление трафика в парный регион в случае отработки отказа. Этот адрес называется "URL-адрес обнаружения" в таблице ниже.

| Облако  | Район | URL-адрес основной конечной точки | Парный регион | URL-адрес обнаружения |
|--------|--------|----------------------|---------------|---------------|
| Открытый |Восточная Австралия | HTTPS:\//kailani-Aue.One.Microsoft.com | Юго-восточная Австралия | HTTPS:\//TM-kailani-Aue.One.Microsoft.com |
| Открытый |Юго-восточная Австралия | HTTPS:\//kailani-AUS.One.Microsoft.com | Восточная Австралия | HTTPS:\//TM-kailani-AUS.One.Microsoft.com |
| Открытый | Южная Бразилия | https:\//brazilsouth01.afs.azure.net | Центрально-южная часть США | https:\//tm-brazilsouth01.afs.azure.net |
| Открытый | Центральная Канада | HTTPS:\//kailani-CAC.One.Microsoft.com | Восточная Канада | HTTPS:\//TM-kailani-CAC.One.Microsoft.com |
| Открытый | Восточная Канада | https:\//kailani-cae.one.microsoft.com | Центральная Канада | https:\//tm-kailani.cae.one.microsoft.com |
| Открытый | Центральная Индия | HTTPS:\//kailani-cIn.One.Microsoft.com | Южная Индия | HTTPS:\//TM-kailani-cIn.One.Microsoft.com |
| Открытый | Центральная часть США | HTTPS:\//kailani-CUS.One.Microsoft.com | Восточная часть США 2 | HTTPS:\//TM-kailani-CUS.One.Microsoft.com |
| Открытый | Восточная Азия | HTTPS:\//kailani11.One.Microsoft.com | Юго-Восточная Азия | HTTPS:\//TM-kailani11.One.Microsoft.com |
| Открытый | East US | HTTPS:\//kailani1.One.Microsoft.com | Западная часть США | HTTPS:\//TM-kailani1.One.Microsoft.com |
| Открытый | Восточная часть США 2 | HTTPS:\//kailani-ESS.One.Microsoft.com | Центральная часть США | HTTPS:\//TM-kailani-ESS.One.Microsoft.com |
| Открытый | Восточная Япония | HTTPS:\//japaneast01.AFS.Azure.NET | Западная Япония | HTTPS:\//TM-japaneast01.AFS.Azure.NET |
| Открытый | Западная Япония | HTTPS:\//japanwest01.AFS.Azure.NET | Восточная Япония | HTTPS:\//TM-japanwest01.AFS.Azure.NET |
| Открытый | Центральная Корея | https:\//koreacentral01.afs.azure.net/ | Республика Корея, южный регион | https:\//tm-koreacentral01.afs.azure.net/ |
| Открытый | Республика Корея, южный регион | https:\//koreasouth01.afs.azure.net/ | Центральная Корея | https:\//tm-koreasouth01.afs.azure.net/ |
| Открытый | Центрально-северная часть США | HTTPS:\//northcentralus01.AFS.Azure.NET | Центрально-южная часть США | https:\//tm-northcentralus01.afs.azure.net |
| Открытый | Северная Европа | HTTPS:\//kailani7.One.Microsoft.com | Западная Европа | HTTPS:\//TM-kailani7.One.Microsoft.com |
| Открытый | Центрально-южная часть США | HTTPS:\//southcentralus01.AFS.Azure.NET | Центрально-северная часть США | https:\//tm-southcentralus01.afs.azure.net |
| Открытый | Южная Индия | HTTPS:\//kailani-Sin.One.Microsoft.com | Центральная Индия | HTTPS:\//TM-kailani-Sin.One.Microsoft.com |
| Открытый | Юго-Восточная Азия | HTTPS:\//kailani10.One.Microsoft.com | Восточная Азия | HTTPS:\//TM-kailani10.One.Microsoft.com |
| Открытый | Южная часть Соединенного Королевства | HTTPS:\//kailani-UKS.One.Microsoft.com | Западная часть Соединенного Королевства | HTTPS:\//TM-kailani-UKS.One.Microsoft.com |
| Открытый | Западная часть Соединенного Королевства | HTTPS:\//kailani-UKW.One.Microsoft.com | Южная часть Соединенного Королевства | HTTPS:\//TM-kailani-UKW.One.Microsoft.com |
| Открытый | Центрально-западная часть США | HTTPS:\//westcentralus01.AFS.Azure.NET | Западная часть США 2 | https:\//tm-westcentralus01.afs.azure.net |
| Открытый | Западная Европа | HTTPS:\//kailani6.One.Microsoft.com | Северная Европа | HTTPS:\//TM-kailani6.One.Microsoft.com |
| Открытый | Западная часть США | HTTPS:\//kailani.One.Microsoft.com | East US | HTTPS:\//TM-kailani.One.Microsoft.com |
| Открытый | Западная часть США 2 | https:\//westus201.afs.azure.net | Центрально-западная часть США | https:\//tm-westus201.afs.azure.net |
| Правительство | US Gov (Аризона) | HTTPS:\//usgovarizona01.AFS.Azure.US | US Gov (Техас) | HTTPS:\//TM-usgovarizona01.AFS.Azure.US |
| Правительство | US Gov (Техас) | HTTPS:\//usgovtexas01.AFS.Azure.US | US Gov (Аризона) | HTTPS:\//TM-usgovtexas01.AFS.Azure.US |

- Если вы используете учетные записи хранения локально избыточного хранилища (LRS) или хранилища, избыточного в пределах зоны (ZRS), необходимо включить только URL-адрес, указанный в разделе "URL-адрес основной конечной точки".

- При использовании учетных записей хранения GRS включите три URL-адреса.

**Пример.** Вы развертываете службу синхронизации хранилища в `"West US"` и регистрируете свой сервер в ней. URL-адреса, позволяющие обмениваться данными с сервером для этого случая:

> - HTTPS:\//kailani.One.Microsoft.com (первичная конечная точка: западная часть США).
> - HTTPS:\//kailani1.One.Microsoft.com (парный регион отработки отказа: восточная часть США).
> - HTTPS:\//TM-kailani.One.Microsoft.com (URL-адрес обнаружения основного региона)

## <a name="summary-and-risk-limitation"></a>Сводка и ограничение рисков
Списки, приведенные ранее в этом документе, содержат URL-адреса, с которыми в настоящее время взаимодействует служба "Синхронизация файлов Azure". Брандмауэры должны иметь возможность разрешить исходящий трафик для этих доменов. Корпорация Майкрософт прилагает все усилия, чтобы этот список был актуальным.

Настройка домена с ограничивающими правилами брандмауэра может служить мерой повышения безопасности. Если используются такие конфигурации брандмауэров, необходимо помнить, что URL-адреса со временем добавляются и могут измениться. Периодически просматривайте эту статью.

## <a name="next-steps"></a>Следующие шаги
- [Планирование развертывания службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-planning.md)
- [Как развернуть службу синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md)
- [Мониторинг Синхронизации файлов Azure](storage-sync-files-monitoring.md)
