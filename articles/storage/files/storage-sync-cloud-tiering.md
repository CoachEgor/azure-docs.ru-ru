---
title: Общие сведения о распределении по уровням в облаке в Синхронизации файлов Azure | Документация Майкрософт
description: Сведения о функции распределения по уровням в облаке в Синхронизации файлов Azure
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 03/17/2020
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 11f9097fc4875f0a4300ac56dafe7af9a0b00c97
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79454624"
---
# <a name="cloud-tiering-overview"></a>Общие сведения о распределении по уровням в облаке
Распределение по уровням в облаке — дополнительная функция Синхронизации файлов Azure, в которой часто используемые файлы кэшируются локально на сервере, а все другие файлы распределяются по уровням в файлах Azure на основе параметров политики. При распределении файла фильтр файловой системы службы синхронизации файлов Azure (StorageSync.sys) локально заменяет файл указателем или точкой повторного анализа. Точка повторного анализа представляет URL-адрес к файлу в службе "Файлы Azure". Распределенный по уровням файл имеет автономный атрибут и набор атрибутов FILE_ATTRIBUTE_RECALL_ON_DATA_ACCESS в NTFS, чтобы сторонние приложения могли идентифицировать такие файлы.
 
Когда пользователь открывает многоуровневый файл, Azure File Sync беспрепятственно отсылает данные файлов из файлов Azure, не зная, что файл хранится в Azure. 
 
 > [!Important]  
 > Облачные многоуровневые промелии не поддерживаются в томе системы Windows.
    
 > [!Important]  
 > Чтобы отозвать файлы, которые были многоуровневыми, пропускная способность сети должна быть не менее 1 Мбит/с. Если пропускная способность сети составляет менее 1 Мбит/с, файлы могут не отозвать с ошибкой тайм-аута.

## <a name="cloud-tiering-faq"></a>Вопросы и ответы о распределении по уровням в облаке

<a id="afs-cloud-tiering"></a>
### <a name="how-does-cloud-tiering-work"></a>Как работает распределение по уровням в облаке?
Фильтр системы Синхронизации файлов Azure создает тепловую карту пространства имен каждой конечной точки сервера. Это позволяет отслеживать в динамике операции получения доступа (операции чтения и записи), а также, исходя из частоты и актуальности этих операций, присваивать соответствующую оценку для каждого файла. Часто используемый файл, который был недавно открыт, будет считаться "горячим", тогда как файл, который почти не используется и к которому не осуществлялся доступ в течение определенного времени будет считаться "холодным". Когда занятое файлами пространство на сервере превышает заданный лимит, самые "холодные" файлы будут перемещены в службу файлов Azure, чтобы обеспечить соответствие этому лимиту.

В версии 4.0 и выше агента службы "Синхронизация файлов Azure" вы можете дополнительно указать политику на основе даты на каждой конечной точке сервера, которая будет перемещать все файлы, которые не использовались и не изменялись в течение определенного количества дней, на другой уровень.

<a id="tiering-minimum-file-size"></a>
### <a name="what-is-the-minimum-file-size-for-a-file-to-tier"></a>Каков минимальный размер файла для файла до уровня?
Для версий агентов 9.x и новее минимальный размер файла для уровня файла на уровне основан на размере кластера файловой системы (двойной размер кластера файловой системы). Например, если размер кластера файловой системы NTFS составляет 4КБ, то минимальный размер файла для уровня файла составляет 8KB. Для версий агентов 8.x и старше минимальный размер файла для файла до уровня составляет 64KB.

<a id="afs-volume-free-space"></a>
### <a name="how-does-the-volume-free-space-tiering-policy-work"></a>Как работает политика распределения по уровням свободного пространства в томе?
Свободное пространство в томе — это свободное место резервируемое в томе, в котором расположена конечная точка сервера. Например, если объем свободного пространства составляет 20 % от пространства, в котором размещается одна серверная конечная точка, до 80 % этого пространства будет занято файлами, доступ к которым осуществляется чаще всего, а остальные файлы будут перемещены в Azure. Объем свободного пространства в томе учитывается на уровне всего тома, а не отдельных каталогов или групп синхронизации. 

<a id="volume-free-space-fastdr"></a>
### <a name="how-does-the-volume-free-space-tiering-policy-work-with-regards-to-new-server-endpoints"></a>Как работает политика распределения по уровням свободного пространства в томе с учетом новых конечных точек сервера?
Когда новая конечная точка сервера подготавливается и подключается к файловому ресурсу Azure, сервер сначала развернет пространство имен, а затем — сами файлы, пока не будет достигнут лимит свободного пространства в томе. Этот процесс также называется быстрым аварийным восстановлением или быстрым восстановлением пространства имен.

<a id="afs-effective-vfs"></a>
### <a name="how-is-volume-free-space-interpreted-when-i-have-multiple-server-endpoints-on-a-volume"></a>Как определяется свободное пространство в томе, если используется несколько конечных точек сервера?
Если в томе несколько конечных точек сервера, действительный предел свободного пространства в томе — это наибольший объем свободного места для любой конечной точке сервера в этом томе. Файлы будут распределяться по уровням в соответствии со схемой их использования. Это не зависит от того, к какой конечной точке сервера они относятся. Предположим, что в томе есть две конечные точки сервера, Endpoint1 и Endpoint2. Для Endpoint1 предел свободного пространства тома составляет 25 %, а для Endpoint2 — 50 %. В таком случае предел свободного пространства тома для обеих конечных точек сервера составит 50 %. 

<a id="date-tiering-policy"></a>
### <a name="how-does-the-date-tiering-policy-work-in-conjunction-with-the-volume-free-space-tiering-policy"></a>Как политика перемещения на другой уровень с учетом даты работает в сочетании с политикой перемещения на другой уровень с учетом свободного пространства в томе? 
При включении распределения по уровням в облаке на конечной точке сервера вы устанавливаете политику с учетом свободного пространства. Она всегда приоритетнее других политик, включая политику на основе даты. При необходимости вы можете включить политику на основе даты для каждой конечной точки сервера в этом томе, а это означает, что только файлы, к которым осуществлялся доступ (то есть на чтение или запись) в течение указанного в политике числа дней, будут сохраняться локально, а все неактивные файлы будут перемещаться на другие уровни. Имейте в виду, что политика с учетом свободного пространства тома всегда имеет приоритет, а когда свободного места на томе недостаточно, чтобы хранить определенное число файлов в течение заданного в политике количества дней, Синхронизация файлов Azure будет продолжать распределять по уровням самые долго неиспользуемые файлы, чтобы обеспечить соответствие нужному проценту свободного пространства тома.

Предположим, у вас есть политика распределения данных по уровням на основе даты с настроенным сроком в 60 дней и политика свободного пространства тома с настроенным объемом свободного пространства 20 %. Если после применения политики на основе даты остается менее 20 % свободного пространства в томе, политика с учетом свободного пространства переопределит политику на основе даты. Это приведет к увеличению количества перемещаемых файлов, например так, что срок, на основе которого перемещаются данные, хранящиеся на сервере, сократится с 60 дней до 45. И наоборот, эта политика будет принудительно перемещать файлы, выходящие за пределы диапазона времени, даже если вы не достигли порогового значения свободного пространства. Поэтому файл, которому уже 61 день, будет перемещен, даже если ваш том пуст.

<a id="volume-free-space-guidelines"></a>
### <a name="how-do-i-determine-the-appropriate-amount-of-volume-free-space"></a>Как определить необходимый объем свободного пространства в томе?
Объем данных, хранимых локально, определяется несколькими факторами: пропускной способностью, особенностями доступа к набору данных и бюджетом. Если пропускная способность низкая, можно хранить больше данных локально, чтобы обеспечить минимальную задержку для пользователей. В противном случае можно учитывать частоту изменения данных в рамках определенного периода. Например, если известно, что каждый месяц около 10 % набора данных объемом 1 ТБ изменяется или активно используется в ходе операций доступа, вы можете хранить локально 100 ГБ данных, предупреждая частый отзыв файлов. Если размер тома — 2 ТБ, вы можете хранить 5 % (или 100 ГБ) локально, освободив 95 % пространства в томе. Тем не менее мы рекомендуем добавить буфер для учетной записи на периоды более частого изменения данных. Другими словами, вы можете оставить меньше свободного пространства в томе, изменяя его по мере необходимости. 

Хранение большего объема данных локально означает снижение затрат на исходящий трафик, так как из Azure будет отзываться меньшее количество файлов. Но это также предполагает определенные затраты на больший объем локального хранилища. Развернув экземпляр Синхронизации файлов Azure, вы можете оценить исходящий трафик для вашей учетной записи хранения, чтобы примерно сопоставить объем свободного пространства в томе со своими потребностями. Если предположить, что учетная запись хранения содержит только облачную конечную точку Синхронизации файлов Azure (т. е. общий ресурс синхронизации), большой исходящий трафик указывает на то, что из облака отзывается большое количество файлов. В таком случае рекомендуется увеличить локальный кэш.

<a id="how-long-until-my-files-tier"></a>
### <a name="ive-added-a-new-server-endpoint-how-long-until-my-files-on-this-server-tier"></a>Добавлена новая конечная точка сервера. Сколько пройдет времени до того, как файлы на этом сервере начнут распределяться по уровням?
В версиях 4.0 и выше агента Azure File Sync, как только ваши файлы были загружены в раздел файлов Azure, они будут многоуровневыми в соответствии с вашими политиками, как только начнется следующий сеанс многоуровневого, что происходит один раз в час. В предыдущих версиях агентов сеанс распределения по уровням мог произойти по истечении 24 часов.

<a id="is-my-file-tiered"></a>
### <a name="how-can-i-tell-whether-a-file-has-been-tiered"></a>Как определить, что файл был перемещен?
Существует несколько способов определения перемещения файла в файловый ресурс Azure.
    
   *  **Проверьте атрибуты файла.**
     Щелкните файл правой кнопкой мыши, перейдите в раздел **Сведения** и прокрутите вниз до свойства **Атрибуты**. Перемещенному файлу будут заданы следующие атрибуты:     
        
        | Буква атрибута | Атрибут | Определение |
        |:----------------:|-----------|------------|
        | Объект | Архив | Указывает, что с помощью программного обеспечения для архивации должно быть выполнено резервное копирование файла. Этот атрибут задается всегда, независимо от того, перемещен файл или полностью расположен на диске. |
        | P | Разреженный файл | Указывает, что этот файл является разреженным. Это специализированный тип файла, который NTFS предлагает для эффективного использования при отсутствии файлового потока на диске. Служба синхронизации файлов Azure использует разреженные файлы, так как файл либо полностью перемещается, либо частично отзывается. Когда файл полностью перемещается, его файловый поток хранится только в облаке. Когда файл частично отзывается, часть этого файла уже на диске. Если файл полностью отозван на диск, служба синхронизации файлов Azure преобразует его из разреженного файла в обычный файл. Этот атрибут установлен только на Windows Server 2016 и старше.|
        | M | Напомним о доступе к данным | Означает, что данные файла не полностью представлены в локальном хранилище. Чтение файла приведет к тому, что по крайней мере часть содержимого файла будет извлечена из общего файла Azure, к которому подключена конечная точка сервера. Этот атрибут установлен только на Windows Server 2019. |
        | L | Точка повторного анализа | Указывает, что файл содержит точку повторного анализа. Она представляет собой специальный указатель, используемый фильтром файловой системы. Служба синхронизации файлов Azure использует точки повторного анализа, чтобы фильтр (StorageSync.sys) файловой системы в этой службе мог определить место хранения файла в облаке. Это обеспечивает прозрачный доступ без непосредственной осведомленности пользователя о задействовании службы синхронизации файлов Azure или о том, как получить доступ к файлу в файловом ресурсе Azure. После полного отзыва файла служба синхронизации файлов Azure удаляет точку повторного анализа из файла. |
        | O | Вне сети | Указывает, что некоторое (или все) содержимое файла не хранится на диске. После полного отзыва файла служба синхронизации файлов Azure удаляет этот атрибут. |

        ![Диалоговое окно свойств файла с выбранной вкладкой "Сведения"](media/storage-files-faq/azure-file-sync-file-attributes.png)
        
        Вы можете просмотреть атрибуты для всех файлов в папке. Для этого необходимо добавить поле **Атрибуты** в окно таблицы проводника. Щелкните правой кнопкой мыши имеющийся столбец (например, **Размер**), выберите **Дополнительно**, а затем в раскрывающемся списке выберите **Атрибуты**.
        
   * **Используйте `fsutil` для проверки точек повторного анализа в файле.**
       Как объяснялось выше, для перемещенного файла всегда задана точка повторного анализа. Она представляет собой специальный указатель, используемый фильтром файловой системы (StorageSync.sys) службы синхронизации файлов Azure. Проверить наличие точки повторного анализа для файла можно с помощью команды `fsutil`, выполнив ее в командной строке с повышенными привилегиями или сеансе PowerShell:
    
        ```powershell
        fsutil reparsepoint query <your-file-name>
        ```

        Если файл содержит точку повторного анализа, вы увидите сообщение **Значение тега повторной обработки: 0x8000001e**. Это гексадецимонное значение является значением точки репарации, принадлежащей Azure File Sync. Вывод также содержит данные репарата, которые представляют путь к файлу в резолютивном файле в резолютивном файле.

        > [!WARNING]  
        > С помощью команды `fsutil reparsepoint` можно также удалить точку повторного анализа. Не выполняйте эту команду, пока вы не получите прямое указание от инженерной команды службы синхронизации файлов Azure, так как ее выполнение может привести к потере данных. 

<a id="afs-recall-file"></a>

### <a name="a-file-i-want-to-use-has-been-tiered-how-can-i-recall-the-file-to-disk-to-use-it-locally"></a>Файл, который мне нужен, был распределен по уровням. Как мне отозвать его на диск для локального использования?
Самый простой способ отозвать файл на диск — открыть его. Фильтр файловой системы (StorageSync.sys) в службе синхронизации файлов Azure быстро скачает этот файл из файлового ресурса Azure без необходимости дополнительных действий. При открытии типов файлов, которые можно считать частично, например файлы мультимедиа или ZIP-файлы, их полная загрузка невозможна.

Вы также можете принудительно отозвать файл с помощью PowerShell. Этот вариант можно использовать, если вы хотите отозвать одновременно большое количество файлов (например, все файлы в папке). Откройте сеанс PowerShell на узле сервера, на котором установлена служба синхронизации файлов Azure, и выполните следующие команды PowerShell:
    
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Invoke-StorageSyncFileRecall -Path <path-to-to-your-server-endpoint>
```
Дополнительные параметры:
* `-Order CloudTieringPolicy`вспомнит о последних модифицированных файлах в первую очередь.  
* `-ThreadCount`определяет, сколько файлов можно отозвать параллельно.
* `-PerFileRetryCount`определяет, как часто будет предпринята попытка отзыва файла, который в настоящее время заблокирован.
* `-PerFileRetryDelaySeconds`определяет время в секундах между повторной попыткой вспомнить попытки и всегда должен использоваться в сочетании с предыдущим параметром.

> [!Note]  
> Если на локальном томе, на котором размещен сервер, недостаточно свободного места для отзыва всех многоуровневых данных, командлет `Invoke-StorageSyncFileRecall` завершится сбоем.  

<a id="sizeondisk-versus-size"></a>
### <a name="why-doesnt-the-size-on-disk-property-for-a-file-match-the-size-property-after-using-azure-file-sync"></a>Почему свойство файла *Размер на диске* не соответствует свойству *Размер* после использования Синхронизации файлов Azure? 
Проводник Windows предоставляет два свойства для представления размера файла: **Размер** и **Размер на диске**. Эти свойства немного отличаются. **Размер** означает полный размер файла. **Размер на диске** означает размер файлового потока, хранимого на диске. Значения для этих свойств могут отличаться по целому ряду причин, таких как сжатие, использование deduplication данных или многоуровневое облако с помощью Azure File Sync. Если файл многоуровнев к доле файла Azure, размер на диске равен нулю, поскольку поток файлов хранится в речке файла Azure, а не на диске. Файл также может быть перемещен частично (или частично отозван), что означает, что на диске размещается часть файла. Такое может случиться, когда файлы частично считываются приложениями, например мультимедийными проигрывателями или программами для сжатия. 

<a id="afs-force-tiering"></a>
### <a name="how-do-i-force-a-file-or-directory-to-be-tiered"></a>Как можно принудительно переместить файл или каталог?
Если функция распределения по уровням облака включена, файлы распределяются по уровням автоматически на основе последнего времени доступа и изменения, чтобы достичь процента свободного пространства тома, указанного для конечной точки облака. Тем не менее иногда вам может понадобиться распределить файл по уровням вручную. Это может быть полезно, если вам нужно сохранить большие файлы, которые не планируется использовать повторно в течение долгого времени, и освободить пространство на томе для других файлов и папок. Вы можете принудительно распределить файлы по уровням с помощью следующих команд PowerShell:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Invoke-StorageSyncCloudTiering -Path <file-or-directory-to-be-tiered>
```

<a id="afs-image-thumbnail"></a>
### <a name="why-are-my-tiered-files-not-showing-thumbnails-or-previews-in-windows-explorer"></a>Почему мои многоуровневые файлы не отображают эскизы или предварительные просмотры в Windows Explorer?
Для многоуровневых файлов, эскизов и предварительных просмотров не будет виден на конечной точке сервера. Такое поведение ожидается, так как функция кэша эскизов в Windows намеренно пропускает чтение файлов с атрибутом оффлайн. С включенным облачным уровнем чтения через многоуровневые файлы заставят их загрузить (отозвать).

Такое поведение не характерно для Синхронизации файлов Azure, Windows Explorer отображает "серый X" для любых файлов, которые имеют набор атрибутов в автономном режиме. Вы увидите значок X при доступе к файлам по SMB. Для подробного объяснения такого поведения, обратитесь к[https://blogs.msdn.microsoft.com/oldnewthing/20170503-00/?p=96105](https://blogs.msdn.microsoft.com/oldnewthing/20170503-00/?p=96105)


## <a name="next-steps"></a>Next Steps
* [Planning for an Azure File Sync Deployment](storage-sync-files-planning.md) (Планирование развертывания службы синхронизации файлов Azure)
