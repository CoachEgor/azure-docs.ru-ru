---
title: Руководство. Моделирование сбоя при чтении данных в основном регионе
titleSuffix: Azure Storage
description: Моделирование ошибки при чтении данных из основного региона, если для учетной записи хранения включено геоизбыточное хранилище с доступом для чтения (RA-GRS).
services: storage
author: tamram
ms.service: storage
ms.topic: tutorial
ms.date: 12/04/2019
ms.author: tamram
ms.reviewer: artek
ms.openlocfilehash: 44c5d037797d845aa9c68af2d7b8e5e45bf418fb
ms.sourcegitcommit: 8bd85510aee664d40614655d0ff714f61e6cd328
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2019
ms.locfileid: "74892453"
---
# <a name="tutorial-simulate-a-failure-in-reading-data-from-the-primary-region"></a>Руководство по Моделирование сбоя при чтении данных в основном регионе

Это руководство представляет собой вторую часть цикла. В нем вы узнаете больше о преимуществах [геоизбыточного хранилища с доступом на чтение](../common/storage-redundancy-grs.md#read-access-geo-redundant-storage) (RA-GRS) с помощью имитации сбоя.

Чтобы имитировать сбой, вы можете воспользоваться либо [статической маршрутизацией](#simulate-a-failure-with-an-invalid-static-route), либо [Fiddler](#simulate-a-failure-with-fiddler). Каждый из этих методов позволит вам имитировать сбой запросов к основной конечной точке учетной записи [геоизбыточного хранилища с доступом на чтение](../common/storage-redundancy-grs.md#read-access-geo-redundant-storage) (RA-GRS), что поспособствует чтению приложения из вторичной конечной точки.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

Из второй части цикла вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * запуск и приостановка приложения;
> * Имитация сбоя с помощью [недопустимого статического маршрута](#simulate-a-failure-with-an-invalid-static-route) или [Fiddler](#simulate-a-failure-with-fiddler)
> * имитация восстановления основной конечной точки.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем начать работу с этим руководством, завершите предыдущее руководство: [Обеспечение высокой доступности данных приложения в службе хранилище Azure][previous-tutorial].

Чтобы сымитировать сбой с помощью статической маршрутизации, необходимо использовать командную строку с повышенными привилегиями.

Для имитации сбоя с помощью Fiddler, сначала нужно его скачать и [установить](https://www.telerik.com/download/fiddler)

## <a name="simulate-a-failure-with-an-invalid-static-route"></a>Имитирование сбоя с помощью недопустимого статического маршрута

Вы можете создать недопустимый статический маршрут для всех запросов к основной конечной точке учетной записи хранения [геоизбыточного хранилища с доступом на чтение](../common/storage-redundancy-grs.md#read-access-geo-redundant-storage) (RA-GRS). В этом руководстве локальный узел используется в качестве шлюза для направления запросов в учетную запись хранения. Использование локального узла в качестве шлюза приводит к тому, что все запросы к основной конечной точке учетной записи хранения возвращаются обратно в узел, что впоследствии приводит к сбою. Выполните следующие действия, чтобы имитировать сбой и восстановление основной конечной точки с использованием недопустимого статического маршрута.

### <a name="start-and-pause-the-application"></a>Запуск и приостановка приложения

Используйте инструкции из [предыдущего руководства][previous-tutorial], чтобы запустить пример и скачать тестовый файл, подтверждая, что он поступает из основного хранилища. В зависимости от целевой платформы вы можете вручную приостановить пример или ждать подсказку.

### <a name="simulate-failure"></a>Имитация сбоя

Пока приложение приостановлено, откройте командную строку в Windows от имени администратора или запустите терминал с правами привилегированного пользователя в Linux.

Получите сведения о домене основной конечной точки учетной записи хранения, введя следующую команду в командной строке или терминале, заменив `STORAGEACCOUNTNAME` именем вашей учетной записи хранения.

```
nslookup STORAGEACCOUNTNAME.blob.core.windows.net
```

Скопируйте IP-адрес учетной записи хранения в текстовый редактор для последующего использования.

Чтобы получить IP-адрес локального узла, введите `ipconfig` в командной строке Windows или `ifconfig` — в терминале Linux.

Чтобы добавить статический маршрут для узла назначения, введите следующую команду в командной строке Windows или терминале Linux, заменив `<destination_ip>` на IP-адрес своей учетной записи хранения, а `<gateway_ip>` на IP-адрес локального хоста.

#### <a name="linux"></a>Linux

```
route add <destination_ip> gw <gateway_ip>
```

#### <a name="windows"></a>Windows

```
route add <destination_ip> <gateway_ip>
```

В окне с запущенным примером возобновите работу приложения или нажмите соответствующую клавишу, чтобы скачать пример файла, и подтвердите, что он поступил из вторичного хранилища. Затем можно снова приостановить пример или ждать подсказку.

### <a name="simulate-primary-endpoint-restoration"></a>имитация восстановления основной конечной точки.

Для повторной имитации функционирования первичной конечной точки удалите ее статический маршрут из таблицы маршрутизации. Таким образом все запросы к основной конечной точке смогут направляться через шлюз по умолчанию. Введите следующую команду в командной строке Windows или терминале Linux.

#### <a name="linux"></a>Linux

```
route del <destination_ip> gw <gateway_ip>
```

#### <a name="windows"></a>Windows

```
route delete <destination_ip>
```

Затем вы можете возобновить работу приложения или нажать соответствующую клавишу, чтобы снова скачать пример файла, на этот раз подтвердив, что он снова поступил из основного хранилища.

## <a name="simulate-a-failure-with-fiddler"></a>Имитация сбоя с Fiddler

Для имитации сбоя с помощью Fiddler нужно внедрить неудачный ответ на запросы к основной конечной точке учетной записи хранения RA-GRS.

Следующие действия объясняют, как имитировать сбой и восстановление основной конечной точки с помощью Fiddler.

### <a name="launch-fiddler"></a>Запуск Fiddler

Откройте Fiddler, выберите **Правила** и **Настроить правила**.

![Настройка правил Fiddler](media/storage-simulate-failure-ragrs-account-app/figure1.png)

Средство Fiddler ScriptEditor запускает и отображает файл **SampleRules.js**. Этот файл используется для настройки Fiddler.

Вставьте следующий пример кода в функцию `OnBeforeResponse`, заменив `STORAGEACCOUNTNAME` именем вашей учетной записи хранения. В зависимости от примера вам также может потребоваться заменить `HelloWorld` на имя загружаемого тестового файла (или префикса, например `sampleFile`). Новый код закомментирован, чтобы гарантировать, что он не запустится сразу.

Внеся изменения, сохраните их, выбрав **Файл** > **Сохранить**. Не закрывайте окно ScriptEditor для использования в следующих шагах.

```javascript
    /*
        // Simulate data center failure
        // After it is successfully downloading the blob, pause the code in the sample,
        // uncomment these lines of script, and save the script.
        // It will intercept the (probably successful) responses and send back a 503 error.
        // When you're ready to stop sending back errors, comment these lines of script out again
        //     and save the changes.

        if ((oSession.hostname == "STORAGEACCOUNTNAME.blob.core.windows.net")
            && (oSession.PathAndQuery.Contains("HelloWorld"))) {
            oSession.responseCode = 503;
        }
    */
```

![Вставка настраиваемого правила](media/storage-simulate-failure-ragrs-account-app/figure2.png)

### <a name="start-and-pause-the-application"></a>Запуск и приостановка приложения

Используйте инструкции из [предыдущего руководства][previous-tutorial], чтобы запустить пример и скачать тестовый файл, подтверждая, что он поступает из основного хранилища. В зависимости от целевой платформы вы можете вручную приостановить пример или ждать подсказку.

### <a name="simulate-failure"></a>Имитация сбоя

Когда приложение приостановлено, вернитесь к Fiddler и раскомментируйте пользовательское правило, сохраненное в функции `OnBeforeResponse`. Чтобы правило вступило в силу выберите **Файл** и **Сохранить** для сохранения изменений. Этот код отслеживает запросы к учетной записи хранения RA-GRS и возвращает код отклика `503 - Service Unavailable`, если путь содержит имя примера файла.

В окне с запущенным примером возобновите работу приложения или нажмите соответствующую клавишу, чтобы скачать пример файла, и подтвердите, что он поступил из вторичного хранилища. Затем можно снова приостановить пример или ждать подсказку.

### <a name="simulate-primary-endpoint-restoration"></a>имитация восстановления основной конечной точки.

В Fiddler удалите или закомментируйте настраиваемое правило. Чтобы убедиться, что правило больше не действует, выберите **Файл** и **Сохранить**.

В окне с запущенным примером возобновите работу приложения или нажмите соответствующую клавишу, чтобы скачать пример файла, и подтвердите, что он повторно поступил из первичного хранилища. Затем можно выйти из примера.

## <a name="next-steps"></a>Дополнительная информация

Во второй части этой серии руководств вы научились имитировать сбой для проверки геоизбыточного хранилища с доступом на чтение.

Чтобы получить дополнительные сведения о работе хранилища RA-GRS (и связанных рисках), ознакомьтесь со статьей:

> [!div class="nextstepaction"]
> [Разработка высокодоступных приложений c помощью RA-GRS](../common/storage-designing-ha-apps-with-ragrs.md)

[previous-tutorial]: storage-create-geo-redundant-storage.md
