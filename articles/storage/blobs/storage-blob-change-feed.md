---
title: Изменение корма в хранилище Azure Blob (Предварительный просмотр) Документы Майкрософт
description: Узнайте о журналах изменений в журнале каналов В Хранилище Azure Blob и о том, как их использовать.
author: normesta
ms.author: normesta
ms.date: 11/04/2019
ms.topic: conceptual
ms.service: storage
ms.subservice: blobs
ms.reviewer: sadodd
ms.openlocfilehash: ac111b06d578a0e9af8581ef2e8caeccfc4a291e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79536893"
---
# <a name="change-feed-support-in-azure-blob-storage-preview"></a>Изменение поддержки кормов в хранилище Azure Blob (Предварительный просмотр)

Цель юнита изменений заключается в предоставлении журналов транзакций всех изменений, которые происходят с каплями и метаданными капли в вашей учетной записи хранения. Подача изменения обеспечивает **упорядоченный,** **гарантированный,** **прочный,** **неизменяемый,** **читаемый журнал** этих изменений. Клиентские приложения могут читать эти журналы в любое время, либо в потоковом, либо в пакетном режиме. Лента изменений позволяет создавать эффективные и масштабируемые решения, которые обрабатывают события изменения, возникающие в вашей учетной записи Blob Storage по низкой цене.

[!INCLUDE [updated-for-az](../../../includes/storage-data-lake-gen2-support.md)]

Подача изменений хранится в виде [капли](https://docs.microsoft.com/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs) в специальном контейнере на вашем складе по стандартной стоимости цен на [капля.](https://azure.microsoft.com/pricing/details/storage/blobs/) Вы можете контролировать период хранения этих файлов в зависимости от ваших требований (см. [условия](#conditions) текущего выпуска). События изменения прикрепляются к ленте изменений в качестве записей в спецификации формата [Apache Avro:](https://avro.apache.org/docs/1.8.2/spec.html) компактный, быстрый, двоичный формат, который обеспечивает богатые структуры данных с встроенной схемой. Этот формат широко используется в экосистеме Hadoop, Stream Analytics и фабрике данных Azure.

Вы можете обрабатывать эти журналы асинхронно, постепенно или в полном объеме. Любое количество клиентских приложений может самостоятельно читать ленту изменений параллельно и в своем собственном темпе. Аналитические приложения, такие как [Apache Drill](https://drill.apache.org/docs/querying-avro-files/) или [Apache Spark,](https://spark.apache.org/docs/latest/sql-data-sources-avro.html) могут потреблять журналы непосредственно как файлы Avro, которые позволяют обрабатывать их по низкой цене, с высокой пропускной способностью и без необходимости написания пользовательского приложения.

Поддержка подачи изменений хорошо подходит для сценариев обработки данных на основе измененных объектов. Например, приложения могут:

  - Обновление вторичного индекса, синхронизация с кэшем, поисковой системой или любыми другими сценариями управления контентом.
  
  - Извлекайте идеи и метрики бизнес-аналитики, основанные на изменениях, которые происходят с вашими объектами, либо в потоковом режиме, либо в пакетном режиме.
  
  - Храните, аудит и анализ изменений в объектах в течение любого периода времени для обеспечения безопасности, соответствия требованиям или интеллекта для управления корпоративными данными.

  - Создавайте решения для резервного копирования, зеркала или репликации состояния объекта в вашей учетной записи для управления аварийными ситуациями или соответствия требованиям.

  - Создавайте конвейеры подключенных приложений, которые реагируют на изменения событий или планируют выполнение на основе созданного или измененного объекта.

> [!NOTE]
> Подача изменений обеспечивает прочную упорядоченную модель журнала изменений, которые происходят с каплей. Изменения записываются и доступны в журнале подачи изменений в течение нескольких минут после изменения. Если ваше приложение должно реагировать на события гораздо быстрее, чем это, рассмотреть вопрос об использовании [событий Blob storage](storage-blob-event-overview.md) вместо этого. [Blob Storage Events](storage-blob-event-overview.md) предоставляет одноразовые события в режиме реального времени, которые позволяют вашим функциям или приложениям Azure быстро реагировать на изменения, которые происходят с каплей. 

## <a name="enable-and-disable-the-change-feed"></a>Включить и отключить канал изменения

Для начала захвата и записи изменений необходимо включить канал изменений в учетной записи хранилища. Отойдите из канала изменения, чтобы остановить захват изменений. Вы можете включить и отключить изменения, используя шаблоны Менеджер ресурсов Azure на портале или Powershell.

Вот несколько вещей, которые необходимо иметь в виду при включании канала изменений.

- В каждом учетном записи хранилища есть только один канал изменения для службы blob, который хранится в **$blobchangefeed** контейнере.

- Создавать, обновлять и удалять изменения фиксируются только на уровне службы blob.

- Лента изменения фиксирует *все* изменения для всех доступных событий, которые происходят в учетной записи. Клиентские приложения могут при необходимости отфильтровывать типы событий. (См. [условия](#conditions) текущего выпуска).

- Только учетные записи хранения Данных GPv2 и Blob могут включить канал Change. Учетные записи Premium BlockBlobStorage и иерархическое пространство имен, включенные в настоящее время, не поддерживаются. Учетные записи хранения GPv1 не поддерживаются, но могут быть повышены до GPv2 без простоя, [см. Обновление до учетной записи хранения GPv2](../common/storage-account-upgrade.md) для получения дополнительной информации.

> [!IMPORTANT]
> Канал изменений находится в открытом предварительном просмотре и доступен в **регионах westcentralus** и **westus2.** Смотрите раздел [условий](#conditions) этой статьи. Чтобы зарегистрироваться в предварительном просмотре, [см.](#register) Необходимо зарегистрировать подписку, прежде чем включить канал изменения в учетных записях хранилища.

### <a name="portal"></a>[Портал](#tab/azure-portal)

Включить канал изменения в учетной записи хранилища с помощью портала Azure:

1. На [портале Azure](https://portal.azure.com/)выберите учетную запись хранения. 

2. Перейдите к опции **защиты данных** в **рамках службы Blob**Service.

3. Нажмите **включено** под **blob изменить канал**

4. Выберите кнопку **«Сохранить»** для подтверждения настроек защиты данных

![](media/storage-blob-soft-delete/storage-blob-soft-delete-portal-configuration.png)

### <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Включить канал изменения с помощью PowerShell:

1. Установите новейший PowershellGet.

   ```powershell
   Install-Module PowerShellGet –Repository PSGallery –Force
   ```

2. Закройте, а затем вновь откройте консоль Powershell.

3. Установите модуль предварительного просмотра **Az.Storage.**

   ```powershell
   Install-Module Az.Storage –Repository PSGallery -RequiredVersion 1.8.1-preview –AllowPrerelease –AllowClobber –Force
   ```

4. Чтобы выполнить проверку подлинности, войдите в подписку Azure с помощью команды `Connect-AzAccount` и следуйте инструкциям на экране.

   ```powershell
   Connect-AzAccount
   ```

5. Включить канал изменения для учетной записи хранилища.

   ```powershell
   Update-AzStorageBlobServiceProperty -EnableChangeFeed $true
   ```

### <a name="template"></a>[Шаблон](#tab/template)
Используйте шаблон менеджера ресурсов Azure, чтобы включить ленту изменений в существующей учетной записи хранения через портал Azure:

1. На портале Azure выберите **«Создайте ресурс».**

2. В строке **Поиск в Marketplace** введите **развертывание шаблона** и нажмите клавишу **ВВОД**.

3. Выберите **[развертывание пользовательского шаблона,](https://portal.azure.com/#create/Microsoft.Template)** а затем выберите **Построить свой собственный шаблон в редакторе.**

4. В шаблонредакторе вставьте в следующем json. Замените заполнитель `<accountName>` именем вашей учетной записи хранения.

   ```json
   {
       "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
       "contentVersion": "1.0.0.0",
       "parameters": {},
       "variables": {},
       "resources": [{
           "type": "Microsoft.Storage/storageAccounts/blobServices",
           "apiVersion": "2019-04-01",
           "name": "<accountName>/default",
           "properties": {
               "changeFeed": {
                   "enabled": true
               }
           } 
        }]
   }
   ```
    
5. Выберите кнопку **«Сохранить»,** укажите группу ресурсов учетной записи, а затем выберите кнопку **«Покупка»** для развертывания шаблона и включения ленты изменений.

---

## <a name="consume-the-change-feed"></a>Потребляйте канал изменения

Лента изменений производит несколько метаданных и файлов журналов. Эти файлы находятся в **$blobchangefeed** контейнере учетной записи хранилища. 

> [!NOTE]
> В текущем выпуске **контейнер $blobchangefeed** не отображается в Azure Storage Explorer или портале Azure. В настоящее время вы не можете видеть $blobchangefeed контейнер, когда вы называете ListContainers API, но вы можете позвонить в ListBlobs API непосредственно на контейнере, чтобы увидеть капли.

Клиентские приложения могут потреблять канал изменения, используя библиотеку процессора подачи на изменение капли, которая предоставляется с процессором SDK подачи Change. 

Смотрите [журналы изменений в лентах данных об изменении процесса в журнале Azure Blob Storage.](storage-blob-change-feed-how-to.md)

## <a name="understand-change-feed-organization"></a>Понимание организации подачи изменений

<a id="segment-index"></a>

### <a name="segments"></a>Сегменты

Лента изменений представляет собой журнал изменений, которые организованы в **почасовые** *сегменты,* но прилагаются к и обновляются каждые несколько минут. Эти сегменты создаются только тогда, когда в этот час происходят события изменения капли. Это позволяет клиенту приложение потреблять изменения, которые происходят в течение определенного диапазона времени без необходимости поиска через весь журнал. Чтобы узнать больше, смотрите [спецификации](#specifications).

Доступный почасовой сегмент ленты изменений описан в явном файле, который определяет пути файлов ленты изменения для этого сегмента. В списке `$blobchangefeed/idx/segments/` виртуального каталога показаны эти сегменты, заказанные временем. Путь сегмента описывает начало почасового диапазона времени, который представляет сегмент. Вы можете использовать этот список, чтобы отфильтровать интересующие вас сегменты журналов.

```text
Name                                                                    Blob Type    Blob Tier      Length  Content Type    
----------------------------------------------------------------------  -----------  -----------  --------  ----------------
$blobchangefeed/idx/segments/1601/01/01/0000/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/22/1810/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/22/1910/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/23/0110/meta.json                  BlockBlob                      584  application/json
```

> [!NOTE]
> Автоматически `$blobchangefeed/idx/segments/1601/01/01/0000/meta.json` создается при включении канала изменения. Вы можете спокойно игнорировать этот файл. Это всегда пустой файл инициализации. 

Файл сегмента`meta.json`манифеста () показывает путь файлов ленты `chunkFilePaths` изменения для этого сегмента в свойстве. Вот пример файла сегмента манифеста.

```json
{
    "version": 0,
    "begin": "2019-02-22T18:10:00.000Z",
    "intervalSecs": 3600,
    "status": "Finalized",
    "config": {
        "version": 0,
        "configVersionEtag": "0x8d698f0fba563db",
        "numShards": 2,
        "recordsFormat": "avro",
        "formatSchemaVersion": 1,
        "shardDistFnVersion": 1
    },
    "chunkFilePaths": [
        "$blobchangefeed/log/00/2019/02/22/1810/",
        "$blobchangefeed/log/01/2019/02/22/1810/"
    ],
    "storageDiagnostics": {
        "version": 0,
        "lastModifiedTime": "2019-02-22T18:11:01.187Z",
        "data": {
            "aid": "55e507bf-8006-0000-00d9-ca346706b70c"
        }
    }
}
```

> [!NOTE]
> Контейнер `$blobchangefeed` появляется только после включения функции канала изменения в учетной записи. Вам придется подождать несколько минут после включения канала изменения, прежде чем вы сможете перечислить капли в контейнере. 

<a id="log-files"></a>

### <a name="change-event-records"></a>Изменение записей событий

Файлы ленты изменений содержат ряд записей событий изменения. Каждая запись события изменения соответствует одному изменению отдельной капли. Записи сериализуются и записываются в файл с использованием спецификации формата [Apache Avro.](https://avro.apache.org/docs/1.8.2/spec.html) Записи можно прочитать с помощью спецификации формата avro. Для обработки файлов в этом формате доступно несколько библиотек.

Файлы подачи изменений хранятся в виртуальном `$blobchangefeed/log/` каталоге в виде капли [приложения.](https://docs.microsoft.com/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs) Первое изменение файла ленты `00000` под каждым путем `00000.avro`будет иметься в имени файла (например). Имя каждого последующего файла журнала, добавленного к этому пути, будет приравливаться к 1 (например: `00001.avro`).

Вот пример записи событий изменения из файла ленты изменений, преобразованной в Json.

```json
{
     "schemaVersion": 1,
     "topic": "/subscriptions/dd40261b-437d-43d0-86cf-ef222b78fd15/resourceGroups/sadodd/providers/Microsoft.Storage/storageAccounts/mytestaccount",
     "subject": "/blobServices/default/containers/mytestcontainer/blobs/mytestblob",
     "eventType": "BlobCreated",
     "eventTime": "2019-02-22T18:12:01.079Z",
     "id": "55e5531f-8006-0000-00da-ca3467000000",
     "data": {
         "api": "PutBlob",
         "clientRequestId": "edf598f4-e501-4750-a3ba-9752bb22df39",
         "requestId": "00000000-0000-0000-0000-000000000000",
         "etag": "0x8D698F13DCB47F6",
         "contentType": "application/octet-stream",
         "contentLength": 128,
         "blobType": "BlockBlob",
         "url": "",
         "sequencer": "000000000000000100000000000000060000000000006d8a",
         "storageDiagnostics": {
             "bid": "11cda41c-13d8-49c9-b7b6-bc55c41b3e75",
             "seq": "(6,5614,28042,28038)",
             "sid": "591651bd-8eb3-c864-1001-fcd187be3efd"
         }
  }
}
```

Для описания каждого свойства см. [схему событий Azure Event Grid для Blob Storage.](https://docs.microsoft.com/azure/event-grid/event-schema-blob-storage?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#event-properties)

> [!NOTE]
> Файлы лентизменения для сегмента не сразу отображаются после создания сегмента. Длительность задержки находится в пределах обычного интервала публикации задержки канала изменения, который находится в пределах нескольких минут после изменения.

<a id="specifications"></a>

## <a name="specifications"></a>Спецификации

- Записи событий изменения применяются только к ленте изменений. Как только эти записи придатится, они неизменяемы и позиция записи стабильна. Клиентские приложения могут поддерживать свою собственную контрольную точку на позиции чтения канала изменения.

- Записи событий изменения придатится в течение нескольких минут после изменения. Клиентские приложения могут использовать записи, поскольку они придативаются для потокового доступа или оптом в любое другое время.

- Записи событий изменения заказываются заказом на модификацию **на капля.** Порядок изменений в blobs не определен в Azure Blob Storage. Все изменения в предыдущем сегменте до любых изменений в последующих сегментах.

- Записи событий изменения сериализуются в файл журнала с помощью спецификации формата [Apache Avro 1.8.2.](https://avro.apache.org/docs/1.8.2/spec.html)

- Изменение записей `eventType` событий, где `Control` значение имеет внутреннее значение, не отражает изменения объектов в вашей учетной записи. Вы можете спокойно игнорировать эти записи.

- Значения в `storageDiagnonstics` пакете свойств предназначены только для внутреннего использования и не предназначены для использования вашим приложением. Ваши приложения не должны иметь договорную зависимость от этих данных. Вы можете безопасно игнорировать эти свойства.

- Время, представленное сегментом, **приблизительное** с границами 15 минут. Таким образом, чтобы обеспечить потребление всех записей в течение указанного времени, потребляйте последовательный предыдущий и следующий часовой сегмент.

- Каждый сегмент может иметь `chunkFilePaths` различное количество из-за внутреннего раздела потока журнала для управления пропускной стоимостью публикации. Файлы журнала `chunkFilePath` в каждом из них гарантированно содержат взаимоисключающие капли и могут потребляться и обрабатываться параллельно, не нарушая порядок модификаций на капля во время итерации.

- Сегменты начинаются `Publishing` в статусе. Как только попадатся записи к сегменту `Finalized`будет завершено, это будет . Файлы журнала в любом сегменте, `LastConsumable` датированном `$blobchangefeed/meta/Segments.json` датой свойства в файле, не должны потребляться вашим приложением. Вот пример `LastConsumable`свойства в файле: `$blobchangefeed/meta/Segments.json`

```json
{
    "version": 0,
    "lastConsumable": "2019-02-23T01:10:00.000Z",
    "storageDiagnostics": {
        "version": 0,
        "lastModifiedTime": "2019-02-23T02:24:00.556Z",
        "data": {
            "aid": "55e551e3-8006-0000-00da-ca346706bfe4",
            "lfz": "2019-02-22T19:10:00.000Z"
        }
    }
}

```

<a id="register"></a>

## <a name="register-your-subscription-preview"></a>Зарегистрируйте подписку (Предварительный просмотр)

Поскольку лента изменений находится только в общедоступном предварительном просмотре, для использования этой функции необходимо зарегистрировать подписку.

### <a name="register-by-using-powershell"></a>Зарегистрируйтесь с помощью PowerShell

В консоли PowerShell запустите следующие команды:

```powershell
Register-AzProviderFeature -FeatureName Changefeed -ProviderNamespace Microsoft.Storage
Register-AzResourceProvider -ProviderNamespace Microsoft.Storage
```
   
### <a name="register-by-using-azure-cli"></a>Зарегистрируйтесь с помощью Azure CLI

В оболочке Облака Azure запустите следующие команды:

```azurecli
az feature register --namespace Microsoft.Storage --name Changefeed
az provider register --namespace 'Microsoft.Storage'
```

<a id="conditions"></a>

## <a name="conditions-and-known-issues-preview"></a>Условия и известные проблемы (Предварительный просмотр)

В этом разделе описаны известные проблемы и условия в текущем публичном предварительном просмотре канала изменений. 
- Для предварительного просмотра необходимо сначала [зарегистрировать подписку,](#register) прежде чем включить канал изменения для учетной записи хранения данных в регионах westcentralus или westus2. 
- Лента изменений фиксирует только операции создания, обновления, удаления и копирования. Обновления метаданных в настоящее время не фиксируются в предварительном просмотре.
- Изменение записей событий для любого изменения может отображаться более одного раза в ленте изменений.
- Вы пока не можете управлять сроком службы файлов журнала извражаемых каналов, установив на них временную политику удержания, и вы не можете удалить капли 
- Свойство `url` файла журнала в настоящее время всегда пусто.
- Свойство `LastConsumable` файла segments.json не перечисляет самый первый сегмент, который завершается в ленте изменения. Эта проблема возникает только после завершения первого сегмента. Все последующие сегменты после первого `LastConsumable` часа точно фиксируются в свойстве.
- В настоящее **$blobchangefeed** время при вызове API ListContainers $blobchangefeed контейнер азначитера не отображаться на портале Azure или ВСкр
- Учетные записи хранения, которые ранее инициировали [сбой учетной записи,](../common/storage-disaster-recovery-guidance.md) могут иметь проблемы с неотображаемым файлом журнала. Любые будущие сбой учетной записи могут также повлиять на файл журнала во время предварительного просмотра.

## <a name="faq"></a>часто задаваемые вопросы

### <a name="what-is-the-difference-between-change-feed-and-storage-analytics-logging"></a>В чем разница между журналом Change feed и журналом Analytics для хранения данных?
В журналах analytics есть записи всех прочитаных, записных, списокных и удаленных операций с успешными и невыполненными запросами во всех операциях. Аналитика журналы являются наилучшими усилия и не гарантируется заказ.

Change feed — это решение, обеспечивающее транзакционный журнал успешных мутаций или изменений в вашей учетной записи, таких как создание, модификация и удаления капли. Изменение канала гарантирует, что все события будут записаны и отображены в порядке успешных изменений на капля, таким образом, вам не придется отфильтровывать шум от огромного объема прочитанных операций или неудачных запросов. Подача изменений фундаментально разработана и оптимизирована для разработки приложений, которые требуют определенных гарантий.

### <a name="should-i-use-change-feed-or-storage-events"></a>Должен ли я использовать события канала «Изменение» или «Хранение»?
Вы можете использовать обе функции, как Change feed и [blob хранения событий](storage-blob-event-overview.md) обеспечить ту же информацию с той же гарантией надежности доставки, с основным отличием является задержка, заказ и хранение записей событий. В течение нескольких минут после изменения лента Change публикует записи в журнале, а также гарантирует порядок операций изменения на каплю. События хранения перемещаются в режиме реального времени и могут не быть заказаны. События изменения канала надежно хранятся в учетной записи хранилища в виде стабильных журналов только для чтения с вашим собственным определенным удержанием, в то время как события хранения являются временными, которые будут потребляться обработчиком событий, если вы явно их храните. С помощью канала Change любое количество приложений может потреблять журналы в удобное для них время, используя Blob AIS или SDK. 

## <a name="next-steps"></a>Дальнейшие действия

- Смотрите пример того, как прочитать ленту изменений с помощью клиентского приложения .NET. Смотрите [журналы изменений в лентах данных об изменении процесса в журнале Azure Blob Storage.](storage-blob-change-feed-how-to.md)
- Узнайте о том, как реагировать на события в режиме реального времени. Смотрите [Реакцию на события хранения blob](storage-blob-event-overview.md)
- Подробнее о подробной информации о регистрации как для успешных, так и для неудачных операций для всех запросов. Посмотреть [журнал аналитики хранения данных Azure](../common/storage-analytics-logging.md)
