---
title: Запретить анонимный общий доступ на чтение к контейнерам и BLOB-объектам
titleSuffix: Azure Storage
description: ''
services: storage
author: tamram
ms.service: storage
ms.topic: how-to
ms.date: 07/06/2020
ms.author: tamram
ms.reviewer: fryu
ms.openlocfilehash: 90d7cd65bbc07524391f34fe0efce2b044664cef
ms.sourcegitcommit: 3541c9cae8a12bdf457f1383e3557eb85a9b3187
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86209933"
---
# <a name="prevent-anonymous-public-read-access-to-containers-and-blobs"></a>Запретить анонимный общий доступ на чтение к контейнерам и BLOB-объектам

Анонимный открытый доступ на чтение к контейнерам и BLOB-объектам в службе хранилища Azure является удобным способом совместного использования данных, но также может представлять угрозу безопасности. Важно обеспечить анонимный доступ с осторожностью и понять, как оценивать анонимный доступ к данным. Сложность работы, человеческий сбой или вредоносная атака на данные, которые являются общедоступными, могут привести к незначительным нарушениям данных. Корпорация Майкрософт рекомендует включить анонимный доступ только при необходимости в сценарии приложения.

По умолчанию учетная запись хранения позволяет пользователю с соответствующими разрешениями настраивать общий доступ к контейнерам и BLOB-объектам. Эту функцию можно отключить на уровне учетной записи хранения, чтобы контейнеры и большие двоичные объекты в учетной записи не могли быть настроены для общего доступа.

В этой статье описывается, как анализировать анонимные запросы к учетной записи хранения и как предотвратить анонимный доступ ко всей учетной записи хранения или к отдельному контейнеру.

## <a name="detect-anonymous-requests-from-client-applications"></a>Обнаружение анонимных запросов из клиентских приложений

При отключении общего доступа на чтение для учетной записи хранения вы рискуете отклонять запросы к контейнерам и BLOB-объектам, которые в настоящее время настроены для общего доступа. Отключение общего доступа для учетной записи хранения переопределяет параметры общего доступа для всех контейнеров в этой учетной записи хранения. Если для учетной записи хранения отключен общий доступ, все будущие анонимные запросы к этой учетной записи завершатся ошибкой.

Чтобы понять, как отключение общего доступа может повлиять на клиентские приложения, корпорация Майкрософт рекомендует включить ведение журнала и метрики для этой учетной записи и проанализировать шаблоны анонимных запросов за определенный промежуток времени. Используйте метрики, чтобы определить количество анонимных запросов к учетной записи хранения, и используйте журналы, чтобы определить, к каким контейнерам осуществляется анонимный доступ.

### <a name="monitor-anonymous-requests-with-metrics-explorer"></a>Мониторинг анонимных запросов с помощью обозреватель метрик

Чтобы отслеживание анонимных запросов к учетной записи хранения, используйте обозреватель метрик Azure в портал Azure. Дополнительные сведения о обозреватель метрик см. в статье [Приступая к работе с Azure обозреватель метрик](../../azure-monitor/platform/metrics-getting-started.md).

Чтобы создать метрику, которая отслеживает анонимные запросы, выполните следующие действия.

1. Войдите в свою учетную запись хранения на портале Azure. В разделе **мониторинг** выберите **метрики**.
1. Выберите **Добавить метрику**. В диалоговом окне **Метрика** укажите следующие значения:
    1. В поле область оставьте значение имя учетной записи хранения.
    1. Задайте **пространство имен метрики** *BLOB*. Эта метрика будет сообщать только о запросах к хранилищу BLOB-объектов.
    1. Задайте для поля **Метрика** значение *транзакции*.
    1. Задайте для поля **агрегирование** значение *Sum*.

    Новая метрика будет отображать сумму количества транзакций в хранилище BLOB-объектов за определенный промежуток времени. Результирующая метрика отображается, как показано на следующем рисунке:

    :::image type="content" source="media/anonymous-read-access-prevent/configure-metric-blob-transactions.png" alt-text="Снимок экрана, показывающий, как настроить метрику для суммирования транзакций BLOB-объектов":::

1. Затем нажмите кнопку **Добавить фильтр** , чтобы создать фильтр для метрики для анонимных запросов.
1. В диалоговом окне **Фильтр** укажите следующие значения:
    1. Задайте для **Свойства** значение *Проверка подлинности*.
    1. Задайте для поля **оператор** знак равенства (=).
    1. Задайте для поля **значения** значение *анонимно*.
1. В правом верхнем углу выберите интервал времени, по которому необходимо просмотреть метрику. Можно также указать, насколько детализирована Статистическая обработка запросов, указав интервалы в диапазоне от 1 минуты до 1 месяца.

После настройки метрики на диаграмме будут отображаться анонимные запросы. На следующем рисунке показаны анонимные запросы, агрегированные за последние тридцати минут.

:::image type="content" source="media/anonymous-read-access-prevent/metric-anonymous-blob-requests.png" alt-text="Снимок экрана, показывающий агрегированные анонимные запросы к хранилищу BLOB-объектов":::

Вы также можете настроить правило оповещения, чтобы уведомлять вас о том, что для учетной записи хранения выполняется определенное число анонимных запросов. Дополнительные сведения см. в статье [Создание и просмотр оповещений метрик, а также управление ими с помощью Azure Monitor](../../azure-monitor/platform/alerts-metric.md).

### <a name="analyze-logs-to-identify-containers-receiving-anonymous-requests"></a>Анализ журналов для выявления контейнеров, принимающих анонимные запросы

Журналы службы хранилища Azure записывают сведения о запросах к учетной записи хранения, в том числе о том, как был выполнен запрос. Можно проанализировать журналы, чтобы определить, какие контейнеры получают анонимные запросы.

Чтобы проверить анонимные запросы в учетной записи хранения Azure, можно использовать ведение журнала службы хранилища Azure Azure Monitor (Предварительная версия). Дополнительные сведения см. в статье [мониторинг службы хранилища Azure](../common/monitor-storage.md).

Ведение журнала службы хранилища Azure в Azure Monitor поддерживает использование запросов журналов для анализа данных журнала. Для запроса журналов можно использовать рабочую область Azure Log Analytics. Дополнительные сведения о запросах журналов см. в разделе [учебник. Начало работы с log Analytics запросами](../../azure-monitor/log-query/get-started-portal.md).

#### <a name="create-a-diagnostic-setting-in-the-azure-portal"></a>Создайте параметр диагностики в портал Azure

Чтобы записывать данные службы хранилища Azure с Azure Monitor и анализировать их с помощью Log Analytics Azure, необходимо сначала создать параметр диагностики, который указывает, какие типы запросов и какие услуги хранилища будут записывать данные. Чтобы создать параметр диагностики в портал Azure, выполните следующие действия.

1. Зарегистрируйтесь в [журнале службы хранилища Azure в Azure Monitor предварительной версии](https://forms.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbRxW65f1VQyNCuBHMIMBV8qlUM0E0MFdPRFpOVTRYVklDSE1WUTcyTVAwOC4u).
1. Создайте новую рабочую область Log Analytics в подписке, которая содержит вашу учетную запись хранения Azure. После настройки ведения журнала для учетной записи хранения журналы будут доступны в рабочей области Log Analytics. Дополнительные сведения см. в статье [Create a Log Analytics workspace in the Azure portal](../../azure-monitor/learn/quick-create-workspace.md) (Создание рабочей области Log Analytics на портале Azure).
1. Войдите в свою учетную запись хранения на портале Azure.
1. В разделе Мониторинг выберите **параметры диагностики (Предварительная версия)**.
1. Выберите **большой двоичный объект** для регистрации запросов к хранилищу BLOB-объектов.
1. Выберите **Добавить параметр диагностики**.
1. Укажите имя для параметра диагностики.
1. В разделе **сведения о категории**раздела **Журнал** выберите типы запросов для записи. Все анонимные запросы будут считаться запросами на чтение, поэтому выберите **сторажереад** для записи анонимных запросов.
1. В разделе **сведения о назначении**выберите **Отправить log Analytics**. Выберите подписку и созданную ранее рабочую область Log Analytics, как показано на следующем рисунке.

    :::image type="content" source="media/anonymous-read-access-prevent/create-diagnostic-setting-logs.png" alt-text="Снимок экрана, показывающий, как создать параметр диагностики для запросов ведения журнала":::

После создания параметра диагностики запросы к учетной записи хранения затем регистрируются в соответствии с этим параметром. Дополнительные сведения см. в статье [Создание параметров диагностики для сбора журналов ресурсов и метрик в Azure](../../azure-monitor/platform/diagnostic-settings.md).

Ссылки на поля, доступные в журналах службы хранилища Azure в Azure Monitor, см. в разделе [журналы ресурсов (Предварительная версия)](../common/monitor-storage-reference.md#resource-logs-preview).

#### <a name="query-logs-for-anonymous-requests"></a>Журналы запросов для анонимных запросов

Журналы службы хранилища Azure в Azure Monitor включают тип авторизации, который использовался для выполнения запроса к учетной записи хранения. В запросе журнала выполните фильтрацию по свойству **AuthenticationType** для просмотра анонимных запросов.

Чтобы получить журналы за последние семь дней для анонимных запросов к хранилищу BLOB-объектов, откройте рабочую область Log Analytics. Затем вставьте следующий запрос в новый запрос к журналу и запустите его. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```kusto
StorageBlobLogs
| where TimeGenerated > ago(7d) and AuthenticationType == "Anonymous"
| project TimeGenerated, AccountName, AuthenticationType, Uri
```

Вы также можете настроить правило генерации оповещений на основе этого запроса, чтобы уведомить вас об анонимных запросах. Дополнительные сведения см. в статье [Создание, просмотр и Управление оповещениями журнала с помощью Azure Monitor](../../azure-monitor/platform/alerts-log.md).

## <a name="remediate-anonymous-public-access"></a>Исправлять анонимный открытый доступ

После оценки анонимных запросов к контейнерам и BLOB-объектам в учетной записи хранения можно предпринять действия по ограничению или предотвращению общего доступа. Если некоторым контейнерам в вашей учетной записи хранения может потребоваться доступ для общего доступа, можно настроить параметр общего доступа для каждого контейнера в учетной записи хранения. Этот параметр обеспечивает наиболее детализированный контроль над открытым доступом. Дополнительные сведения см. [в разделе Установка общего уровня доступа для контейнера](anonymous-read-access-configure.md#set-the-public-access-level-for-a-container).

Для повышения безопасности можно отключить общий доступ для всей учетной записи хранения. Параметр общего доступа для учетной записи хранения переопределяет отдельные параметры для контейнеров в этой учетной записи. При отключении общего доступа для учетной записи хранения все контейнеры, настроенные для разрешения общего доступа, больше не будут доступны анонимно. Дополнительные сведения см. в статье [Включение или отключение общего доступа на чтение для учетной записи хранения](anonymous-read-access-configure.md#enable-or-disable-public-read-access-for-a-storage-account).

Если в сценарии требуется, чтобы определенные контейнеры были доступны для общего доступа, рекомендуется переместить эти контейнеры и их большие двоичные объекты в учетные записи хранения, зарезервированные для общего доступа. Затем можно отключить общий доступ для любых других учетных записей хранения.

### <a name="verify-that-public-access-to-a-blob-is-not-permitted"></a>Убедитесь, что общий доступ к большому двоичному объекту запрещен

Чтобы убедиться в том, что общий доступ к конкретному большому двоичному объекту запрещен, можно попытаться скачать большой двоичный объект с помощью его URL-адреса. Если загрузка прошла, большой двоичный объект остается общедоступным. Если большой двоичный объект недоступен из-за того, что для учетной записи хранения отключен общий доступ, появится сообщение об ошибке, указывающее, что общий доступ не разрешен в этой учетной записи хранения.

В следующем примере показано, как использовать PowerShell, чтобы попытаться скачать большой двоичный объект с помощью его URL-адреса. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```powershell
$url = "<absolute-url-to-blob>"
$downloadTo = "<file-path-for-download>"
Invoke-WebRequest -Uri $url -OutFile $downloadTo -ErrorAction Stop
```

### <a name="verify-that-modifying-the-containers-public-access-setting-is-not-permitted"></a>Убедитесь, что изменение параметра общего доступа контейнера не разрешено

Чтобы убедиться, что параметр общего доступа к контейнеру нельзя изменить после отключения общего доступа для учетной записи хранения, можно попытаться изменить параметр. Изменение параметра общего доступа к контейнеру завершится ошибкой, если для учетной записи хранения отключен общий доступ.

В следующем примере показано, как использовать PowerShell, чтобы попытаться изменить параметр общего доступа контейнера. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:

```powershell
$rgName = "<resource-group>"
$accountName = "<storage-account>"
$containerName = "<container-name>"

$storageAccount = Get-AzStorageAccount -ResourceGroupName $rgName -Name $accountName
$ctx = $storageAccount.Context

Set-AzStorageContainerAcl -Context $ctx -Container $containerName -Permission Blob
```

### <a name="verify-that-creating-a-container-with-public-access-enabled-is-not-permitted"></a>Убедитесь, что создание контейнера с включенным общим доступом не разрешено

Если для учетной записи хранения отключен общий доступ, вы не сможете создать новый контейнер с включенным общедоступным доступом. Для проверки можно попытаться создать контейнер с включенным общедоступным доступом.

В следующем примере показано, как использовать PowerShell, чтобы попытаться создать контейнер с включенным общедоступным доступом. Не забудьте заменить значения заполнителей в квадратных скобках собственными значениями:
 
```powershell
$rgName = "<resource-group>"
$accountName = "<storage-account>"
$containerName = "<container-name>"

$storageAccount = Get-AzStorageAccount -ResourceGroupName $rgName -Name $accountName
$ctx = $storageAccount.Context

New-AzStorageContainer -Name $containerName -Permission Blob -Context $ctx
```

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка анонимного общего доступа на чтение для контейнеров и больших двоичных объектов](anonymous-read-access-configure.md)
- [Анонимный доступ к открытым контейнерам и BLOB-объектам с помощью .NET](anonymous-read-access-client.md)