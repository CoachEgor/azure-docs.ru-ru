---
title: Управление жизненным циклом хранения azure
description: Узнайте, как создать правила для политики жизненного цикла, чтобы перевести данные из горячего уровня доступа на холодный и архивный.
author: mhopkins-msft
ms.author: mhopkins
ms.date: 05/21/2019
ms.service: storage
ms.subservice: common
ms.topic: conceptual
ms.reviewer: yzheng
ms.openlocfilehash: 238c12baf55b525a24107a727d09588ef06a6bef
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77598312"
---
# <a name="manage-the-azure-blob-storage-lifecycle"></a>Управление жизненным циклом хранилища BLOB-объектов Azure

Для каждого набора данных существуют уникальные требования к жизненному циклу. На ранних этапах жизненного цикла данных обращение к ним происходит часто. Но по мере устаревания данных потребность в доступе снижается очень быстро. Некоторые данные хранятся в облаке почти без использования, и после сохранения к ним обращаются крайне редко. Некоторые данные устаревают через несколько дней или месяцев после их создания, а другие наборы данных активно считываются и изменяются на протяжении всего времени существования. Управление жизненным циклом хранения Azure Blob предлагает богатую политику, основанную на правилах, для учетных записей gPv2 и Blob. Эти политики позволяют переводить данные на новые уровни доступа и удалять их по завершении жизненного цикла.

Политика управления жизненным циклом поддерживает следующие возможности.

- Перемещение больших двоичных объектов на более холодный уровень доступа (с горячего на холодный, с горячего на архивный, с холодного на архивный) для оптимального баланса производительности и стоимости.
- Удаление больших двоичных объектов в конце их жизненных циклов.
- Определение правил, выполняемых раз в день, на уровне учетной записи хранения.
- Применение правил к контейнерам или подмножествам больших двоичных объектов (с префиксами в качестве фильтров).

Рассмотрим сценарий, при котором данные получают частый доступ на ранних стадиях жизненного цикла, но лишь изредка через две недели. Данные, которые хранятся больше месяца, запрашиваются крайне редко. В этом сценарии для ранних этапов лучше всего выбрать горячий уровень хранилища. Прохладное хранилище наиболее подходит для случайного доступа. Архивное хранилище является лучшим вариантом уровня после того, как данные стареет в течение месяца. Выбирая уровни хранилища в зависимости от возраста данных, вы сможете создать наиболее экономичный вариант хранилища для конкретных потребностей. Чтобы достичь перемещения данных на более холодные уровни, можно использовать правила политики управления жизненным циклом.

[!INCLUDE [storage-multi-protocol-access-preview](../../../includes/storage-multi-protocol-access-preview.md)]

## <a name="storage-account-support"></a>Поддержка учетных записей хранения

Политика управления жизненным циклом доступна с учетными записями General Purpose v2 (GPv2), учетными записями хранения Blob и учетными записями хранения Premium Block Blob. На портале Azure можно обновить существующую учетную запись общего назначения (GPv1) до учетной записи GPv2. Дополнительные сведения об учетных записях хранения см. в статье [Общие сведения об учетной записи хранения](../common/storage-account-overview.md).  

## <a name="pricing"></a>Цены

Функция управления жизненным циклом является бесплатной. Клиенты оплачивают только обычную стоимость вызовов API [Отображение BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/list-blobs) и [Установка уровня BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/set-blob-tier). Операция удаления бесплатна. Дополнительные сведения см. на странице [цен на блочные BLOB-объекты](https://azure.microsoft.com/pricing/details/storage/blobs/).

## <a name="regional-availability"></a>Доступность по регионам

Функция управления жизненным циклом доступна во всех регионах Azure.

## <a name="add-or-remove-a-policy"></a>Добавление или удаление политики

Вы можете добавить, отсвазать или удалить политику, используя любой из следующих методов:

* [Портал Azure](https://portal.azure.com)
* [Лазурная силаШелл](https://github.com/Azure/azure-powershell/releases)
* [Лазурный CLI](https://docs.microsoft.com/cli/azure/install-azure-cli)
* [Интерфейсы REST API](https://docs.microsoft.com/rest/api/storagerp/managementpolicies)

Политика может быть прочитана или написана в полном объеме. Частичные обновления не поддерживаются. 

> [!NOTE]
> Если вы настроили для учетной записи хранения правила брандмауэра, запросы на управление жизненным циклом могут быть заблокированы. Вы можете разблокировать эти запросы, предоставив исключения для надежных служб Майкрософт. Дополнительные сведения см. в разделе об исключениях в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions).

В этой статье показано, как управлять политикой с помощью портала и методов PowerShell.  

# <a name="portal"></a>[Портал](#tab/azure-portal)

Существует два способа добавления политики через портал Azure. 

* [Представление списка портала Azure](#azure-portal-list-view)
* [Представление кода портала Azure](#azure-portal-code-view)

#### <a name="azure-portal-list-view"></a>Представление списка портала Azure

1. Войдите на [портал Azure](https://portal.azure.com).

2. На портале Azure ищите учетную запись хранения и выберите его. 

3. В соответствии с **Blob Service**выберите управление **жизненным циклом** для просмотра или изменения правил.

4. Выберите вкладку **просмотра списка.**

5. Выберите **правило добавить,** а затем заполните поля формы **набора действий.** В следующем примере капли перемещаются в охлажденный склад, если они не были изменены в течение 30 дней.

   ![На портале Azure установить страницу действий по управлению жизненным циклом](media/storage-lifecycle-management-concepts/lifecycle-management-action-set.png)

6. Выберите **набор фильтров** для добавления дополнительного фильтра. Затем выберите **Browse,** чтобы указать контейнер и папку, с помощью которой можно фильтровать.

   ![Страница фильтра управления жизненным циклом на портале Azure](media/storage-lifecycle-management-concepts/lifecycle-management-filter-set-browse.png)

8. Выберите **Обзор и добавьте** для просмотра параметров политики.

9. Выберите **Добавить,** чтобы добавить новую политику.

#### <a name="azure-portal-code-view"></a>Представление кода портала Azure
1. Войдите на [портал Azure](https://portal.azure.com).

2. На портале Azure ищите учетную запись хранения и выберите его.

3. В рамках **службы Blob**выберите **управление жизненным циклом** для просмотра или изменения политики.

4. Следующий JSON является примером политики, которая может быть вставлена во вкладку **представления кода.**

   ```json
   {
     "rules": [
       {
         "name": "ruleFoo",
         "enabled": true,
         "type": "Lifecycle",
         "definition": {
           "filters": {
             "blobTypes": [ "blockBlob" ],
             "prefixMatch": [ "container1/foo" ]
           },
           "actions": {
             "baseBlob": {
               "tierToCool": { "daysAfterModificationGreaterThan": 30 },
               "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
               "delete": { "daysAfterModificationGreaterThan": 2555 }
             },
             "snapshot": {
               "delete": { "daysAfterCreationGreaterThan": 90 }
             }
           }
         }
       }
     ]
   }
   ```

5. Нажмите кнопку **Сохранить**.

6. Для получения дополнительной информации об [Policy](#policy) этом [Rules](#rules) примере JSON см.

# <a name="powershell"></a>[Powershell](#tab/azure-powershell)

Следующий скрипт PowerShell можно использовать для добавления политики в учетную запись хранения. Переменная `$rgname` должна быть инициализирована с именем группы ресурсов. Переменная `$accountName` должна быть инициализирована с именем учетной записи хранилища.

```powershell
#Install the latest module
Install-Module -Name Az -Repository PSGallery

#Initialize the following with your resource group and storage account names
$rgname = ""
$accountName = ""

#Create a new action object
$action = Add-AzStorageAccountManagementPolicyAction -BaseBlobAction Delete -daysAfterModificationGreaterThan 2555
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -BaseBlobAction TierToArchive -daysAfterModificationGreaterThan 90
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -BaseBlobAction TierToCool -daysAfterModificationGreaterThan 30
$action = Add-AzStorageAccountManagementPolicyAction -InputObject $action -SnapshotAction Delete -daysAfterCreationGreaterThan 90

# Create a new filter object
# PowerShell automatically sets BlobType as “blockblob” because it is the only available option currently
$filter = New-AzStorageAccountManagementPolicyFilter -PrefixMatch ab,cd

#Create a new rule object
#PowerShell automatically sets Type as “Lifecycle” because it is the only available option currently
$rule1 = New-AzStorageAccountManagementPolicyRule -Name Test -Action $action -Filter $filter

#Set the policy
$policy = Set-AzStorageAccountManagementPolicy -ResourceGroupName $rgname -StorageAccountName $accountName -Rule $rule1
```

# <a name="template"></a>[Шаблон](#tab/template)

Определить управление жизненным циклом можно с помощью шаблонов Azure Resource Manager. Вот пример шаблона для развертывания учетной записи хранения RA-GRS GPv2 с политикой управления жизненным циклом.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {},
  "variables": {
    "storageAccountName": "[uniqueString(resourceGroup().id)]"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('storageAccountName')]",
      "location": "[resourceGroup().location]",
      "apiVersion": "2019-04-01",
      "sku": {
        "name": "Standard_RAGRS"
      },
      "kind": "StorageV2",
      "properties": {
        "networkAcls": {}
      }
    },
    {
      "name": "[concat(variables('storageAccountName'), '/default')]",
      "type": "Microsoft.Storage/storageAccounts/managementPolicies",
      "apiVersion": "2019-04-01",
      "dependsOn": [
        "[variables('storageAccountName')]"
      ],
      "properties": {
        "policy": {...}
      }
    }
  ],
  "outputs": {}
}
```

---

## <a name="policy"></a>Политика

Политика управления жизненным циклом представляет собой набор правил, оформленный в виде документа JSON.

```json
{
  "rules": [
    {
      "name": "rule1",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {...}
    },
    {
      "name": "rule2",
      "type": "Lifecycle",
      "definition": {...}
    }
  ]
}
```

Политика представляет собой набор правил:

| Имя параметра | Тип параметра | Примечания |
|----------------|----------------|-------|
| `rules`        | Массив объектов правил | В политике требуется по крайней мере одно правило. Можно определить до 100 правил в политике.|

Каждое правило в политике имеет несколько параметров:

| Имя параметра | Тип параметра | Примечания | Обязательно |
|----------------|----------------|-------|----------|
| `name`         | Строка |Имя правила может включать до 256 буквенно-цифровых символов. В именах правил учитывается регистр.  Имя должно быть уникальным в пределах политики. | True |
| `enabled`      | Логическое | Дополнительный булеан, позволяющий временно отключению правила. Значение по умолчанию верно, если оно не установлено. | False | 
| `type`         | Значение перечисления | Текущий допустимый `Lifecycle`тип . | True |
| `definition`   | Объект, который определяет правило жизненного цикла | Каждое определение состоит из набора фильтров и набора действий. | True |

## <a name="rules"></a>Правила

Каждое определение правила состоит из набора фильтров и набора действий. [Набор фильтров](#rule-filters) ограничивает действие правила определенным набором объектов в контейнере или имен объектов. [Набор операций](#rule-actions) вводит в действие уровень или удаляет действия в отфильтрованном наборе объектов.

### <a name="sample-rule"></a>Пример правила

Следующее правило образца фильтрует учетную запись для `container1` выполнения `foo`действий на объектах, которые существуют внутри, и начать с.  

>[!NOTE]
>Управление жизненным циклом поддерживает только тип блока капли.  

- установить для BLOB-объекта холодный уровень доступа через 30 дней после последнего изменения;
- установить для BLOB-объекта архивный уровень доступа через 90 дней после последнего изменения;
- удалить BLOB-объект спустя 2555 дней (7 лет) после последнего изменения;
- удалить моментальный снимок BLOB-объекта через 90 дней после создания моментального снимка.

```json
{
  "rules": [
    {
      "name": "ruleFoo",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 },
            "delete": { "daysAfterModificationGreaterThan": 2555 }
          },
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

### <a name="rule-filters"></a>Фильтры правила

Фильтры ограничивают действие правила определенным подмножеством BLOB-объектов в учетной записи хранения. Если определено несколько фильтров, для всех фильтров применяется логическая операция `AND`.

Доступны следующие фильтры:

| Имя фильтра | Тип фильтра | Примечания | Обязательный |
|-------------|-------------|-------|-------------|
| blobTypes   | Массив предустановленных значений перечисления. | Текущий релиз `blockBlob`поддерживает . | Да |
| prefixMatch | Массив строк, по которым выполняется сопоставление префиксов. Каждое правило может определить до 10 префиксов. Строка префикса должно начинаться с имени контейнера. Например, если вы хотите, чтобы `https://myaccount.blob.core.windows.net/container1/foo/...` соответствовать все капли под `container1/foo`для правила, prefixMatch является . | Если вы не определяете prefixMatch, это правило распространяется на все капли в учетной записи хранилища.  | нет |

### <a name="rule-actions"></a>Действия правила

Действия применяются к отфильтрованным каплям при выполнении состояния выполнения.

Управление жизненным циклом поддерживает многоуровневое и удаление каплей и удаление снимков капли. Определите в каждом правиле хотя бы одно действие для BLOB-объектов или моментальных снимков BLOB-объектов.

| Действие        | Базовый BLOB-объект                                   | Моментальный снимок      |
|---------------|---------------------------------------------|---------------|
| tierToCool    | Поддержка BLOB-объектов, размещенных на горячем уровне доступа         | Не поддерживается |
| tierToArchive | Поддержка BLOB-объектов, размещенных на горячем или холодном уровне доступа | Не поддерживается |
| удалить        | Поддерживается                                   | Поддерживается     |

>[!NOTE]
>Если для одного BLOB-объекта определено более одного действия, управление жизненным циклом применяет к нему более дешевое из этих действий. Например, действие `delete` дешевле, чем действие `tierToArchive`; а действие `tierToArchive` дешевле, чем действие `tierToCool`.

Условия выполнения основаны на возрасте. Возраст для базового BLOB-объекта определяется по времени последнего изменения, а для моментального снимка BLOB-объекта — по времени создания.

| Состояние выполнения действий             | Значение условия                          | Описание                             |
|----------------------------------|------------------------------------------|-----------------------------------------|
| daysAfterModificationGreaterThan | Целочисленное значение, указывающее возраст в днях | Условие для действий базового blob     |
| daysAfterCreationGreaterThan     | Целочисленное значение, указывающее возраст в днях | Условие для действий снимка blob |

## <a name="examples"></a>Примеры

Следующие примеры демонстрируют несколько типичных сценариев для правил политики жизненного цикла.

### <a name="move-aging-data-to-a-cooler-tier"></a>Перемещение старых данных на более холодный уровень

В следующем примере показано перемещение блочных BLOB-объектов с префиксом имени `container1/foo` или `container2/bar`. Эта политика перемещает BLOB-объекты, которые не изменялись более 30 дней, на холодный уровень, а которые не изменялись в течение 90 дней — на архивный уровень:

```json
{
  "rules": [
    {
      "name": "agingRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "container1/foo", "container2/bar" ]
        },
        "actions": {
          "baseBlob": {
            "tierToCool": { "daysAfterModificationGreaterThan": 30 },
            "tierToArchive": { "daysAfterModificationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

### <a name="archive-data-after-ingest"></a>Архивные данные после проглотения

Некоторые данные хранятся в облаке почти без использования. Следующая политика жизненного цикла настраивается на архивные данные вскоре после их поступления. В этом примере переходы блокируют `archivecontainer` капли в учетной записи хранилища в контейнере в уровень архива. Переход осуществляется, действуя на капли 0 дней после последнего измененного времени:

> [!NOTE] 
> Рекомендуется загружать капли непосредственно архив ногоуровня, чтобы быть более эффективным. Вы можете использовать заголовок уровня x-ms-acess для [PutBlob](https://docs.microsoft.com/rest/api/storageservices/put-blob) или [PutBlockList](https://docs.microsoft.com/rest/api/storageservices/put-block-list) с версией REST 2018-11-09 и более новыми или нашими последними библиотеками для хранения каблики. 

```json
{
  "rules": [
    {
      "name": "archiveRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "archivecontainer" ]
        },
        "actions": {
          "baseBlob": {
              "tierToArchive": { "daysAfterModificationGreaterThan": 0 }
          }
        }
      }
    }
  ]
}

```

### <a name="expire-data-based-on-age"></a>Устаревание данных на основе возраста

Ожидается, что срок действия некоторых данных истекает через несколько дней или месяцев после создания. Вы можете настроить политику управления жизненным циклом, чтобы удалять устаревшие данные при достижении определенного возраста. В следующем примере показана политика, которая удаляет все блоки старше 365 дней.

```json
{
  "rules": [
    {
      "name": "expirationRule",
      "enabled": true,
      "type": "Lifecycle",
      "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ]
        },
        "actions": {
          "baseBlob": {
            "delete": { "daysAfterModificationGreaterThan": 365 }
          }
        }
      }
    }
  ]
}
```

### <a name="delete-old-snapshots"></a>Удаление старых моментальных снимков

Для данных, которые часто изменяются и используются на протяжении их существования, часто используются моментальные снимки для отслеживания ранних версий данных. Вы можете создать политику, которая удаляет старые моментальные снимки при достижении определенного возраста. Возраст моментального снимка определяется от момента создания моментального снимка. Это правило политики удаляет моментальные снимки BLOB-объектов в пределах контейнера `activedata`, с момента создания которых прошло 90 или более дней.

```json
{
  "rules": [
    {
      "name": "snapshotRule",
      "enabled": true,
      "type": "Lifecycle",
    "definition": {
        "filters": {
          "blobTypes": [ "blockBlob" ],
          "prefixMatch": [ "activedata" ]
        },
        "actions": {
          "snapshot": {
            "delete": { "daysAfterCreationGreaterThan": 90 }
          }
        }
      }
    }
  ]
}
```

## <a name="faq"></a>часто задаваемые вопросы

**Я создал новую политику, почему действия не работают немедленно?**  
Платформа выполняет политики жизненного цикла один раз в день. После настройки политики может пройти до 24 часов, чтобы некоторые действия были запущены в первый раз.  

**Если я обновлюсь с существующей политикой, сколько времени требуется для выполнения действий?**  
Вступление в силу обновленного полиса занимает до 24 часов. После вступления политики в силу для выполнения действий может уйти до 24 часов. Таким образом, действия политики могут занять до 48 часов.   

**Я вручную регидратировал архивную каплю, как я могу предотвратить его от перемещения обратно в архив уровня временно?**  
Когда капля перемещается с одного уровня доступа на другой, ее последнее время изменения не меняется. Если вы вручную регидратируете архивную каплю до горячего уровня, она будет перенесена обратно на архивный уровень движком управления жизненным циклом. Отключите правило, которое влияет на эту каплю временно, чтобы предотвратить его архив снова. Повторно включите правило, когда капля может быть безопасно перемещена обратно в архивный уровень. Вы также можете скопировать капля в другое место, если он должен оставаться в горячем или прохладном уровне постоянно.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как восстанавливать данные после случайного удаления:

- [Soft delete for Azure Storage blobs](../blobs/storage-blob-soft-delete.md) (Обратимое удаление больших двоичных объектов службы хранилища Azure)
