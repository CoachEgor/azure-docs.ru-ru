---
title: Контрольный список производительности и масштабируемости для хранилища BLOB-объектов в службе хранилища Azure
description: Контрольный список проверенных методов использования хранилища BLOB-объектов при разработке высокопроизводительных приложений.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 10/10/2019
ms.author: tamram
ms.subservice: blobs
ms.openlocfilehash: 24d601dc2116b7daf315bb3c6f20c4dc0b6f6ce5
ms.sourcegitcommit: bb65043d5e49b8af94bba0e96c36796987f5a2be
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72382040"
---
# <a name="performance-and-scalability-checklist-for-blob-storage"></a>Контрольный список производительности и масштабируемости для хранилища BLOB-объектов

Корпорация Майкрософт разработала ряд проверенных методик разработки высокопроизводительных приложений с хранилищем BLOB-объектов. Этот контрольный список определяет основные методики, которые разработчики могут использовать для оптимизации производительности. При проектировании приложения и на протяжении всего процесса необходимо учитывать следующие рекомендации.

Хранилище Azure имеет целевые показатели масштабируемости и производительности для емкости, скорости транзакций и пропускной способности. Дополнительные сведения о целевых показателях масштабируемости службы хранилища Azure см. в статье [целевые показатели масштабируемости и производительности службы хранилища Azure для учетных записей хранения](../common/storage-scalability-targets.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

## <a name="checklist"></a>Контрольный список

В этой статье рассматриваются проверенные методы обеспечения производительности в контрольном списке, который можно выполнить при разработке приложения для хранения BLOB-объектов.

| Готово | Категория | Вопросы проектирования |
| --- | --- | --- |
| &nbsp; |Целевые показатели масштабируемости |[Можно ли спроектировать приложение так, чтобы оно использовало не больше максимального количества учетных записей хранения?](#maximum-number-of-storage-accounts) |
| &nbsp; |Целевые показатели масштабируемости |[Вы не помогаете подходить к емкости и пределам транзакций?](#capacity-and-transaction-targets) |
| &nbsp; |Целевые показатели масштабируемости |[Есть ли большое количество клиентов, одновременно обращающихся к одному большому двоичному объекту?](#multiple-clients-accessing-a-single-blob-concurrently) |
| &nbsp; |Целевые показатели масштабируемости |[Ваше приложение находится в целевых показателях масштабируемости для одного большого двоичного объекта?](#bandwidth-and-operations-per-blob) |
| &nbsp; |Секционирование |[Помогает ли ваше соглашения об именовании улучшить распределение нагрузки?](#partitioning) |
| &nbsp; |Работа в сети |[Имеют ли устройства на стороне клиента достаточно высокую пропускную способность и низкая задержка для достижения необходимой производительности?](#throughput) |
| &nbsp; |Работа в сети |[Есть ли на клиентских устройствах высококачественное сетевое подключение?](#link-quality) |
| &nbsp; |Работа в сети |[Является ли клиентское приложение в том же регионе, что и учетная запись хранения?](#location) |
| &nbsp; |Прямой клиентский доступ |[Используете ли вы подписанные URL-адрес (SAS) и общий доступ к ресурсам между источниками (CORS), чтобы обеспечить прямой доступ к службе хранилища Azure?](#sas-and-cors) |
| &nbsp; |Caching |[Данные кэширования приложения часто обращаются к данным и редко меняются?](#reading-data) |
| &nbsp; |Caching |[Обновляется ли пакетная обработка приложения путем их кэширования на клиенте и последующей их отправки в более крупные наборы?](#uploading-data-in-batches) |
| &nbsp; |Конфигурация .NET |[Вы используете .NET Core 2,1 или более поздней версии для достижения оптимальной производительности?](#use-net-core) |
| &nbsp; |Конфигурация .NET |[Вы настроили свой клиент на использование достаточного количества одновременных подключений?](#increase-default-connection-limit) |
| &nbsp; |Конфигурация .NET |[Для приложений .NET вы настроили .NET для использования достаточного количества потоков?](#increase-minimum-number-of-threads) |
| &nbsp; |Параллелизм |[Вы гарантируете, что параллелизм привязан надлежащим образом, чтобы не перегружать возможности клиента или подход к целевым показателям масштабируемости?](#unbounded-parallelism) |
| &nbsp; |Средства |[Используете ли вы последние версии клиентских библиотек и средств, предоставляемых корпорацией Майкрософт?](#client-libraries-and-tools) |
| &nbsp; |Повторы |[Вы используете политику повтора с экспоненциальным отходом для регулирования ошибок и времени ожидания?](#timeout-and-server-busy-errors) |
| &nbsp; |Повторы |[Ваше приложение избегает повторов неповторяемых ошибок?](#non-retryable-errors) |
| &nbsp; |Копирование больших двоичных объектов |[Копируются ли большие двоичные объекты наиболее эффективным способом?](#blob-copy-apis) |
| &nbsp; |Копирование больших двоичных объектов |[Используете ли вы последнюю версию AzCopy для операций с массовым копированием?](#use-azcopy) |
| &nbsp; |Копирование больших двоичных объектов |[Используете ли вы семейство Azure Data Box для импорта больших объемов данных?](#use-azure-data-box) |
| &nbsp; |Распространение содержимого |[Используете ли вы CDN для распределения содержимого?](#content-distribution) |
| &nbsp; |Использование метаданных |[Вы храните часто используемые метаданные, касающиеся BLOB-объектов, в их метаданных?](#use-metadata) |
| &nbsp; |Быстрая отправка |[При попытке быстро отправить один BLOB-объект вы осуществляете параллельную отправку блоков?](#upload-one-large-blob-quickly) |
| &nbsp; |Быстрая отправка |[При попытке быстро отправить множество BLOB-объектов вы отправляете BLOB-объекты параллельно?](#upload-many-blobs-quickly) |
| &nbsp; |Тип большого двоичного объекта |[Используете ли вы при необходимости страничные BLOB-объекты или блочные BLOB-объекты?](#choose-the-correct-type-of-blob) |

## <a name="scalability-targets"></a>Целевые показатели масштабируемости

Если приложение достигает одного из целевых показателей масштабируемости или превышает его, оно может столкнуться с увеличением задержки транзакций или запуском механизма регулировки количества запросов. Когда служба хранилища Azure выполняет регулирование приложения, она начинает возвращать коды ошибок 503 (сервер занят) или 500 (время ожидания операции). Предотвращение этих ошибок за счет ограничения целевых показателей масштабируемости является важной частью улучшения производительности приложения.

Дополнительные сведения о целевых показателях масштабируемости для служба очередей см. в статье [целевые показатели масштабируемости и производительности службы хранилища Azure](/azure/storage/common/storage-scalability-targets?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#azure-blob-storage-scale-targets).

### <a name="maximum-number-of-storage-accounts"></a>Максимальное число учетных записей хранения

Если вы приближаетесь к максимальному числу учетных записей хранения, разрешенному для определенной комбинации подписки или региона, оцените сценарий и определите, применимы ли какие-либо из следующих условий.

- Вы используете учетные записи хранения для хранения неуправляемых дисков и добавляете эти диски в виртуальные машины? В этом сценарии Корпорация Майкрософт рекомендует использовать управляемые диски. Масштабирование управляемых дисков выполняется автоматически и без необходимости создавать отдельные учетные записи хранения и управлять ими. Дополнительные сведения см. [в статье Введение в управляемые диски Azure](../../virtual-machines/windows/managed-disks-overview.md) .
- Вы используете одну учетную запись хранения для каждого клиента в целях изоляции данных? В этом сценарии Корпорация Майкрософт рекомендует использовать контейнер больших двоичных объектов для каждого клиента, а не всю учетную запись хранения. Служба хранилища Azure теперь позволяет назначать роли управления доступом на основе ролей (RBAC) для отдельных контейнеров. Дополнительные сведения см. [в разделе Предоставление доступа к данным BLOB-объектов и очередей Azure с помощью RBAC в портал Azure](../common/storage-auth-aad-rbac-portal.md).
- Вы используете несколько учетных записей хранения в сегментировании для увеличения количества входящих, исходящих, операций ввода-вывода в секунду или емкости? В этом сценарии Корпорация Майкрософт рекомендует использовать преимущества повышенных ограничений для учетных записей хранения, чтобы уменьшить количество учетных записей хранения, необходимых для рабочей нагрузки, если это возможно. Обратитесь в [службу поддержки Azure](https://azure.microsoft.com/support/options/) , чтобы запросить повышенные ограничения для вашей учетной записи хранения. Дополнительные сведения см. в статье [объявление более крупных учетных записей хранения с более высоким уровнем масштабирования](https://azure.microsoft.com/blog/announcing-larger-higher-scale-storage-accounts/).

### <a name="capacity-and-transaction-targets"></a>Целевые показатели емкости и транзакций

Если приложение достигает целевых показателей масштабируемости, когда речь идет об одной учетной записи хранения, рассмотрите вопрос об использовании одного из следующих подходов:  

- Если приложение обращается к целевому объекту транзакции, рассмотрите возможность использования учетных записей хранения блочных BLOB-объектов, оптимизированных для высокой скорости транзакций и низкой и постоянной задержки. Дополнительные сведения см. в статье [Общие сведения об учетной записи хранения](../common/storage-account-overview.md).
- Пересмотрите рабочую нагрузку, которая приводит к достижению приложением целевого показателя масштабируемости или его превышению. Вы можете спроектировать его по-другому, чтобы использовать меньшую полосу пропускания или производительность, или меньшее количество транзакций?
- Если приложение должно превысить одну из целевых показателей масштабируемости, создайте несколько учетных записей хранения и разбейте данные приложений между этими несколькими учетными записями хранения. При использовании этого подхода необходимо разработать приложение таким образом, чтобы в будущем для балансировки нагрузки в него можно было добавлять другие учетные записи хранения. Сами учетные записи хранения не изменяют никаких затрат, кроме использования с точки зрения хранения данных, выполненных транзакций или передачи данных.
- Если приложение приближается к целевым показателям пропускной способности, рассмотрите возможность сжатия данных на стороне клиента, чтобы уменьшить пропускную способность, необходимую для отправки данных в службу хранилища Azure.
    Сжатие данных может снизить пропускную способность и повысить производительность сети, а также негативное влияние на производительность. Оцените влияние дополнительных требований к производительности для сжатия и распаковки данных на стороне клиента. Помните, что хранение сжатых данных может усложнить устранение неполадок, поскольку может оказаться более сложной задачей при просмотре данных с помощью стандартных средств.
- Если приложение приближается к целевым показателям масштабируемости, убедитесь, что для повторных попыток используется экспоненциальная задержка. Лучше попытаться избежать достижения целевых показателей масштабируемости, реализовав рекомендации, описанные в этой статье. Однако при использовании экспоненциальной задержки для повторных попыток приложение будет быстро предпринимать попытки, что может привести к ухудшению регулирования. Дополнительные сведения см. в разделе [время ожидания и ошибки занятости сервера](#timeout-and-server-busy-errors).

### <a name="multiple-clients-accessing-a-single-blob-concurrently"></a>Несколько клиентов, одновременно обращающихся к одному большому двоичному объекту

При наличии большого числа клиентов, одновременно обращающихся к одному большому двоичному объекту, необходимо учитывать целевые показатели масштабируемости для каждого большого двоичного объекта и каждой учетной записи хранения. Точное число клиентов, которые могут получить доступ к одному большому двоичному объекту, зависит от таких факторов, как количество клиентов, запрашивающих BLOB-объект одновременно, размер большого двоичного объекта и условия сети.

Если большой двоичный объект может распространяться через сеть CDN, например изображения или видео, обслуживаемые с веб-сайта, можно использовать CDN. Дополнительные сведения см. в разделе [распространение содержимого](#content-distribution).

В других сценариях, например в научных моделировании, где данные конфиденциальны, у вас есть два варианта. Первый заключается в распределении доступа к рабочей нагрузке таким, чтобы доступ к большому двоичному объекту осуществлялся в течение некоторого времени и одновременно к нему осуществлялся доступ. Кроме того, можно временно скопировать большой двоичный объект в несколько учетных записей хранения, чтобы увеличить общее число операций ввода-вывода в секунду на большой двоичный объект и в учетных Результаты будут зависеть от поведения приложения, поэтому обязательно протестируйте шаблоны параллелизма во время проектирования.

### <a name="bandwidth-and-operations-per-blob"></a>Пропускная способность и операции на большой двоичный объект

Один большой двоичный объект поддерживает до 500 запросов в секунду. Если у вас есть несколько клиентов, которым необходимо считать один большой двоичный объект и вы можете превысить это ограничение, рассмотрите возможность использования учетной записи хранилища блочных BLOB-объектов. Учетная запись хранения блочного BLOB-объекта обеспечивает более высокий уровень запросов или операций ввода-вывода в секунду.

Для распределения операций в большом двоичном объекте можно также использовать сеть доставки содержимого (CDN), например Azure CDN. Дополнительные сведения о Azure CDN см. в разделе Общие сведения о [Azure CDN](../../cdn/cdn-overview.md).  

## <a name="partitioning"></a>Секционирование

Общие сведения о секционировании данных BLOB-объектов в хранилище Azure для повышения производительности. Служба хранилища Azure может обслуживать данные в одном разделе быстрее, чем данные, охватывающие несколько секций. Назвав соответствующие большие двоичные объекты, можно повысить эффективность запросов на чтение.

Хранилище BLOB-объектов использует схему секционирования на основе диапазона для масштабирования и балансировки нагрузки. Каждый BLOB-объект имеет ключ секции, состоящий из полного имени большого двоичного объекта (учетная запись + контейнер + BLOB-объект). Ключ секции используется для секционирования данных большого двоичного объекта в диапазоны. Затем диапазоны распределяются между хранилищем BLOB-объектов.

Секционирование на основе диапазонов означает, что соглашения об именовании, использующие лексическую сортировку (например, *мипайролл*, *миперформанце*, *мемплойис*и т. д.) или метки времени (*log20160101*, *log20160102*, *log20160102* и т. д.) , скорее всего, приведет к совместному размещению секций на одном сервере секционирования. , до увеличения нагрузки необходимо, чтобы они были разделены на меньшие диапазоны. Совместное размещение больших двоичных объектов на одном сервере секционирования повышает производительность, поэтому важная часть улучшения производительности включает в себя именование больших двоичных объектов способом, который наиболее эффективно организует их.

Например, все BLOB-объекты в контейнере могут обрабатываться одним и тем же сервером, пока нагрузка на эти BLOB-объекты не потребует дополнительного перераспределения диапазонов секций. Аналогичным образом группа нераспределенных учетных записей с именами, упорядоченными в лексической последовательности, может обслуживаться одним сервером до тех пор, пока нагрузка на одну или все из этих учетных записей не требует разбиения на несколько серверов секционирования.

Каждая операция балансировки нагрузки может вызывать задержку вызовов хранилища во время ее выполнения. Способность службы управлять резкой интенсивностью трафика в секцию ограничивается масштабируемостью односекционного сервера до тех пор, пока операция балансировки нагрузки не запустится и не будет перераспределять диапазон ключей секций.

Частоту выполнения таких операций можно уменьшить.  

- Если возможно, используйте большие двоичные объекты или размеры блоков, превышающие 4, для учетных записей хранения уровня "Стандартный" и более 256 КИБ для учетных записей хранения класса Premium. Больший размер большого двоичного объекта или блока автоматически активирует блочные BLOB-объекты высокой пропускной способности. Блочные BLOB-объекты с высокой пропускной способностью обеспечивают высокую производительность и не зависят от именования секций.
- Изучите соглашение об именовании, используемое для учетных записей, контейнеров, больших двоичных объектов, таблиц и очередей. Попробуйте предварительно исправить имена учетной записи, контейнера или BLOB-объекта с тремя цифрами, используя функцию хэширования, которая лучше подходит для ваших потребностей.
- Если данные упорядочиваются с помощью меток времени или числовых идентификаторов, убедитесь, что вы не используете шаблон трафика только для добавления (или только в начале). Эти шаблоны не подходят для системы секционирования на основе диапазона. Эти шаблоны могут привести к тому, что весь трафик помещается в одну секцию и ограничивает систему от эффективной балансировки нагрузки.

    Например, при наличии ежедневных операций, использующих большой двоичный объект с меткой времени, например *ГГГГММДД*, весь трафик для этой ежедневной операции направляется в один большой двоичный объект, обслуживаемый одним сервером секций. Определите, соответствуют ли ограничения для больших двоичных объектов и ограничения на секции в соответствии с вашими потребностями, и при необходимости рассмотрите возможность разбиения этой операции на несколько больших двоичных объектов. Аналогично, если данные временных рядов хранятся в таблицах, весь трафик может быть направлен к последней части пространства имен Key. Если вы используете числовые идентификаторы, добавьте префикс в идентификатор с тремя цифрами. Если используются метки времени, добавьте к метке времени значение секунд, например *ссииииммдд*. Если приложение выполняет операции перечисления и запроса, выберите функцию хэширования, которая ограничит количество запросов. В некоторых случаях может быть достаточно случайного префикса.
  
- Дополнительные сведения о схеме секционирования, используемой в службе хранилища Azure, см. в статье [хранилище Azure: высокодоступная служба облачного хранилища со строгой согласованностью](https://sigops.org/sosp/sosp11/current/2011-Cascais/printable/11-calder.pdf).

## <a name="networking"></a>Работа в сети

Ограничения физической сети приложения могут оказать значительное влияние на производительность. В следующих разделах описаны некоторые ограничения, которые могут возникнуть у пользователей.  

### <a name="client-network-capability"></a>Возможности клиентской сети

Пропускная способность и качество сетевого подключения играют важную роль в производительности приложения, как описано в следующих разделах.

#### <a name="throughput"></a>Пропускная способность

Что касается полосы пропускания, частой проблемой являются возможности клиента. Очень крупные экземпляры Azure имеют сетевые карты, обладающие большими возможностями, поэтому если необходимы более высокие сетевые ограничения от одной машины, следует рассмотреть возможность использования более крупного экземпляра или большего количества виртуальных машин. Если доступ к хранилищу Azure осуществляется из локального приложения, то применяется то же правило: Общие сведения о сетевых возможностях клиентского устройства и сетевое подключение к расположению хранилища Azure, а также их повышение по мере необходимости или разработка приложения для работы в своих возможностях.

#### <a name="link-quality"></a>Качество связи

Как и при любом использовании сети, учитывайте, что состояния сети, приводящие к ошибкам и потери пакетов, будут замедлять производительность.  Использование инструмента WireShark или NetMon может помочь в диагностике этой проблемы.  

### <a name="location"></a>Location

В любой распределенной среде наилучшее быстродействие достигается при нахождении клиента рядом с сервером. Для доступа к хранилищу Azure с наименьшей задержкой лучшим местом для клиента будет его нахождение в том же регионе Azure. Например, если у вас есть веб-приложение Azure, которое использует службу хранилища Azure, найдите их в одном регионе, например в Западная часть США или Юго-Восточная Азия. Совместное размещение ресурсов сокращает задержку и затраты, так как использование пропускной способности в пределах одного региона является бесплатным.  

Если клиентские приложения будут получать доступ к службе хранилища Azure, но не размещаются в Azure, например в приложениях для мобильных устройств или в локальных корпоративных службах, то поиск учетной записи хранения в регионе рядом с клиентами может сократить задержку. Если клиенты распределены широко (например, некоторые из Северная Америка и некоторые в Европе), рассмотрите возможность использования одной учетной записи хранения для региона. Такой подход легче реализовать, если данные, которые хранят приложения, предназначены для отдельных пользователей, и не требуют репликации между учетными записями хранения.

Для широкого распределения содержимого BLOB-объектов используйте сеть доставки данных, например Azure CDN. Для получения дополнительной информации о сети Azure CDN см. статью [Сеть кэширующих серверов](../../cdn/cdn-overview.md).  

## <a name="sas-and-cors"></a>SAS и CORS

Предположим, что вам нужно авторизовать код, такой как JavaScript, который выполняется в веб-браузере пользователя или в приложении мобильного телефона для доступа к данным в службе хранилища Azure. Один из подходов состоит в создании приложения службы, которое выступает в качестве прокси-сервера. Устройство пользователя выполняет проверку подлинности в службе, которая, в свою очередь, разрешает доступ к ресурсам службы хранилища Azure. Таким образом, на небезопасных устройствах можно не сообщать ключи своей учетной записи хранения. Однако этот подход приводит к значительной нагрузке на приложение службы, так как все данные, передаваемые между устройством пользователя и хранилищем Azure, должны проходить через приложение службы.

Вы можете не использовать приложение службы в качестве прокси-сервера для хранилища Azure с помощью подписанных URL-адресов (SAS). Используя SAS, вы можете разрешить устройству пользователя выполнять запросы непосредственно к службе хранилища Azure с помощью ограниченного маркера доступа. Например, если пользователь хочет отправить фотографию в приложение, приложение службы может создать SAS и отправить его на устройство пользователя. Маркер SAS может предоставить разрешение на запись в ресурс хранилища Azure в течение указанного интервала времени, по истечении которого срок действия маркера SAS истекает. Дополнительные сведения о подписанных URL-адресах см. в статье об [использование подписанных URL-адресов SAS в службе хранилища Azure](../common/storage-sas-overview.md).  

Как правило, веб-браузер не разрешает JavaScript на странице, размещенной на веб-сайте в одном домене, для выполнения определенных операций, таких как операции записи, в другой домен. Эта политика, называемая одной и той же политикой происхождения, предотвращает получение доступа к данным на другой веб-странице вредоносным сценарием на одной странице. Однако политика того же источника может быть ограничением при создании решения в облаке. Общий доступ к ресурсам в разных источниках (CORS) — это функция браузера, которая позволяет целевому домену взаимодействовать с браузером, который доверяет запросам, происходящим в исходном домене.

Например, предположим, что веб-приложение, работающее в Azure, выполняет запрос ресурса к учетной записи хранения Azure. Веб-приложение является исходным доменом, а учетная запись хранения — целевым доменом. Вы можете настроить CORS для любой из служб хранилища Azure, чтобы взаимодействовать с веб-браузером, для которого запросы из исходного домена являются доверенными для службы хранилища Azure. Дополнительные сведения о CORS см. в статье [Поддержка общего доступа к ресурсам в разных источниках (CORS) для службы хранилища Azure](/rest/api/storageservices/Cross-Origin-Resource-Sharing--CORS--Support-for-the-Azure-Storage-Services).  
  
SAS и CORS могут помочь избежать ненужной нагрузки на веб-приложение.  

## <a name="caching"></a>Caching

Кэширование играет важную роль в производительности. В следующих разделах рассматриваются рекомендации по кэшированию.

### <a name="reading-data"></a>Чтение данных

Как правило, чтение данных является предпочтительным для чтения в два раза. Рассмотрим пример веб-приложения, которое получило большой двоичный объект MiB 50 из службы хранилища Azure, который будет служить содержимым для пользователя. В идеале приложение кэширует большой двоичный объект локально на диск, а затем извлекает кэшированную версию для последующих запросов пользователей.

Одним из способов избежать извлечения большого двоичного объекта, если он не был изменен с момента кэширования, является уточнение операции GET с условным заголовком для времени изменения. Если время последнего изменения превышает время кэширования большого двоичного объекта, большой двоичный объект извлекается и повторно кэшируется. В противном случае кэшированный большой двоичный объект извлекается для оптимальной производительности.

Вы также можете разработать приложение, чтобы предположить, что большой двоичный объект остается неизменным в течение короткого периода после его получения. В этом случае приложению не нужно проверять, был ли изменен большой двоичный объект в течение этого интервала.

Данные конфигурации, данные подстановки и другие данные, часто используемые приложением, являются хорошим кандидатом для кэширования.  

Дополнительные сведения об использовании условных заголовков см. в разделе [Указание условных заголовков для операций службы BLOB-объектов](/rest/api/storageservices/specifying-conditional-headers-for-blob-service-operations).  

### <a name="uploading-data-in-batches"></a>Отправка данных в пакетах

В некоторых сценариях можно выполнить статистическую обработку данных локально, а затем периодически передать их в пакет, а не загружать каждый фрагмент данных немедленно. Например, предположим, что веб-приложение сохраняет файл журнала действий. Приложение может либо передавать сведения о каждом действии в таблицу (что требует большого количества операций с хранилищем), либо сохранять сведения о действиях в локальном файле журнала, а затем периодически отправлять все сведения о действиях в виде файла с разделителями в большой двоичный объект. Если размер каждой записи в журнале составляет 1 КБ, можно передать тысячи записей в одной транзакции. Одна транзакция поддерживает передачу большого двоичного объекта размером до 64 MiB. Разработчик приложения должен быть разработан для возможности клиентского устройства или сбоя передачи. Если данные действия необходимо скачать в течение интервала времени, а не для одного действия, рекомендуется использовать хранилище BLOB-объектов в хранилище таблиц.

## <a name="net-configuration"></a>Конфигурация .NET

В данном разделе перечислены несколько быстрых параметров конфигурации, которые можно использовать для значительного повышения производительности при использовании платформы .NET Framework.  При использовании других языков проверьте, применяются ли в выбранном языке подобные концепции.  

### <a name="use-net-core"></a>Использование .NET Core

Разрабатывайте приложения службы хранилища Azure с помощью .NET Core 2,1 или более поздней версии, чтобы воспользоваться преимуществами улучшений производительности. По возможности рекомендуется использовать .NET Core 3. x.

Дополнительные сведения об улучшениях производительности в .NET Core см. в следующих записях блога:

- [Улучшения производительности в .NET Core 3,0](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-3-0/)
- [Улучшения производительности в .NET Core 2,1](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-2-1/)

### <a name="increase-default-connection-limit"></a>Увеличить предельное число подключений по умолчанию

В .NET следующий код увеличивает ограничение числа подключений по умолчанию (обычно это два в клиентской среде или десять в серверной среде) до 100. В обычном случае следует установить значение, приблизительно соответствующее количеству потоков, используемых приложением. Установите ограничение на подключение перед открытием подключений.

```csharp
ServicePointManager.DefaultConnectionLimit = 100; //(Or More)  
```

Сведения о других языках программирования см. в документации, чтобы определить, как установить ограничение числа подключений.  

Дополнительные сведения см. в статье [веб-службы записи блога: одновременные подключения](https://blogs.msdn.microsoft.com/darrenj/2005/03/07/web-services-concurrent-connections/).  

### <a name="increase-minimum-number-of-threads"></a>Увеличение минимального числа потоков

При использовании синхронных вызовов вместе с асинхронными задачами может потребоваться увеличить число потоков в пуле потоков:

```csharp
ThreadPool.SetMinThreads(100,100); //(Determine the right number for your application)  
```

Дополнительные сведения см. в описании метода [ThreadPool. SetMinThreads](/dotnet/api/system.threading.threadpool.setminthreads) .  

## <a name="unbounded-parallelism"></a>Неограниченный параллелизм

Хотя параллелизм может быть очень полезен для повышения производительности, будьте внимательны при использовании неограниченного параллелизма, что означает отсутствие ограничений, наложенных на количество потоков или параллельных запросов. Не забудьте ограничить параллельные запросы для отправки или скачивания данных, доступа к нескольким секциям в одной учетной записи хранения или для доступа к нескольким элементам в одном разделе. Если параллелизм не ограничен, приложение может превышать возможности клиентского устройства или целевые показатели масштабируемости учетной записи хранения, что приводит к более длительным задержкам и регулированию.  

## <a name="client-libraries-and-tools"></a>Клиентские библиотеки и средства

Для лучшей производительности всегда используйте новейшие клиентские библиотеки и средства, предоставляемые корпорацией Майкрософт. Клиентские библиотеки службы хранилища Azure доступны для различных языков. Служба хранилища Azure также поддерживает PowerShell и Azure CLI. Корпорация Майкрософт активно разрабатывает эти клиентские библиотеки и средства с учетом производительности, постоянно обновляет их до последних версий служб и гарантирует, что они обрабатывают многие из проверенных методов производительности внутренним образом. Дополнительные сведения см. в [справочной документации по службе хранилища Azure](/azure/storage/#reference).

## <a name="handle-service-errors"></a>Обработку ошибок службы

Служба хранилища Azure возвращает ошибку, когда службе не удается обработать запрос. Сведения об ошибках, которые могут быть возвращены службой хранилища Azure в данном сценарии, полезны для оптимизации производительности.

### <a name="timeout-and-server-busy-errors"></a>Ошибки времени ожидания и занятости сервера

Служба хранилища Azure может регулировать приложение, если оно приближается к ограничениям масштабируемости. В некоторых случаях служба хранилища Azure не может обрабатывать запрос из-за некоторого временного условия. В обоих случаях служба может вернуть ошибку 503 (сервер занят) или 500 (время ожидания). Эти ошибки также могут возникать, если служба является перебалансировкой секций данных для обеспечения более высокой пропускной способности. Клиентское приложение обычно должно повторять операцию, которая вызывает одну из этих ошибок. Однако, если служба хранилища Azure регулирует приложение, так как оно превышает целевые показатели масштабируемости или даже если службе не удалось обработать запрос по какой-либо другой причине, агрессивные попытки могут привести к ухудшению проблемы. Рекомендуется использовать политику экспоненциальной повторной попытки, и клиентские библиотеки по умолчанию используют это поведение. Например, приложение может повторить действие через 2 секунды, затем через 4 секунды, затем через 10 секунд, затем через 30 секунд, а затем полностью отказаться от повторения. Таким образом, приложение значительно сокращает нагрузку на службу, а не усугубит поведение, которое может привести к регулированию.  

Ошибки подключения могут вызывать немедленные повторы, так как они не являются результатом регулирования количества запросов и, как ожидается, будут временными.  

### <a name="non-retryable-errors"></a>Ошибки, не допускающие повторения

Клиентские библиотеки выполняют повторные попытки с осведомленностью о том, какие ошибки можно повторить, а какие — нет. Однако если вы вызываете службу хранилища Azure REST API напрямую, есть некоторые ошибки, которые не следует повторять. Например, ошибка 400 (ошибочный запрос) означает, что клиентское приложение отправило запрос, который не удалось обработать, так как он не был в ожидаемой форме. Повторная отправка этого запроса приводит к тому же ответу каждый раз, поэтому нет точки в повторной попытке. Если вы вызываете службу хранилища Azure REST API напрямую, учитывайте возможные ошибки и необходимость повторной попытки.

Дополнительные сведения о кодах ошибок службы хранилища Azure см. в разделе [состояние и коды ошибок](/rest/api/storageservices/status-and-error-codes2).

## <a name="copying-and-moving-blobs"></a>Копирование и перемещение больших двоичных объектов

Служба хранилища Azure предоставляет ряд решений для копирования и перемещения больших двоичных объектов в учетной записи хранения, между учетными записями хранения и между локальными системами и облаком. В этом разделе описываются некоторые из этих параметров с точки зрения их влияния на производительность. Сведения о эффективном переносе данных в хранилище BLOB-объектов и из него см. в статье [Выбор решения Azure для передачи данных](../common/storage-choose-data-transfer-solution.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

### <a name="blob-copy-apis"></a>API копирования BLOB-объектов

Чтобы скопировать большие двоичные объекты в учетных записях хранения, используйте операцию [размещения блока из URL-адреса](/rest/api/storageservices/put-block-from-url) . Эта операция синхронно копирует данные из любого источника URL-адреса в блочный большой двоичный объект. Использование операции `Put Block from URL` может значительно снизить необходимую пропускную способность при переносе данных между учетными записями хранения. Поскольку операция копирования выполняется на стороне службы, вам не нужно скачивать и повторно отправлять данные.

Чтобы скопировать данные в одну и ту же учетную запись хранения, используйте операцию [копирования BLOB-объектов](/rest/api/storageservices/Copy-Blob) . Копирование данных в одной учетной записи хранения обычно выполняется быстро.  

### <a name="use-azcopy"></a>Использование AzCopy

Служебная программа командной строки AzCopy — это простой и эффективный вариант для выполнения групповой перемещения больших двоичных объектов в учетные записи хранения, из и между ними. AzCopy оптимизирован для этого сценария и может обеспечить высокую скорость передачи. AzCopy версии 10 использует операцию `Put Block From URL` для копирования данных большого двоичного объекта между учетными записями хранения. Дополнительные сведения см. в статье [копирование или перемещение данных в службу хранилища Azure с помощью AzCopy V10](/azure/storage/common/storage-use-azcopy-v10).  

### <a name="use-azure-data-box"></a>Использование Azure Data Box

Для импорта больших объемов данных в хранилище BLOB-объектов рассмотрите возможность использования семейства Azure Data Box для автономной передачи. Предоставляемые корпорацией Майкрософт устройства Data Box являются хорошим выбором для перемещения больших объемов данных в Azure, если вы ограничиваете время, доступность сети или расходы. Дополнительные сведения см. в [документации по Azure датабокс](/azure/databox/).

## <a name="content-distribution"></a>Распространение содержимого

Иногда приложение должно обслуживать одно и то же содержимое для многих пользователей (например, демонстрационный видеоролик о продукте, используемый на домашней странице веб-сайта), расположенном в одном или нескольких регионах. В этом сценарии используйте сеть доставки содержимого (CDN), например Azure CDN для распределения содержимого BLOB-объектов географически. В отличие от учетной записи хранилища Azure, которая существует в одном регионе и которая не может распространять содержимое с минимальной задержкой в другие регионы, сеть Azure CDN использует серверы, расположенные в нескольких центрах обработки данных по всему миру. Кроме того, сеть CDN обычно поддерживает гораздо более высокие ограничения на выходе, чем одна учетная запись хранения.  

Для получения дополнительной информации о сети Azure CDN см. статью [Сеть кэширующих серверов](../../cdn/cdn-overview.md).

## <a name="use-metadata"></a>Использование метаданных

Служба BLOB-объектов поддерживает запросы HEAD, которые могут включать свойства или метаданные большого двоичного объекта. Например, если приложению нужны данные из фотографии в формате "EXIF" (с форматом обмена изображениями), он может извлечь фотографию и извлечь ее. Чтобы сэкономить пропускную способность и повысить производительность, приложение может сохранять данные EXIF в метаданных большого двоичного объекта, когда приложение отправляет фотографию. Затем можно получить данные EXIF в метаданных, используя только запрос HEAD. Получение только метаданных, а не полного содержимого большого двоичного объекта экономит значительную пропускную способность и сокращает время обработки, необходимое для извлечения данных EXIF. Помните, что для большого двоичного объекта можно хранить 8 КИБ метаданных.  

## <a name="upload-blobs-quickly"></a>Быстрое отправку больших двоичных объектов

Чтобы быстро передать большие двоичные объекты, сначала определите, будет ли загружаться один или несколько больших двоичных объектов. Чтобы правильно выбрать метод работы, используйте сведения из приведенного ниже руководства.  

### <a name="upload-one-large-blob-quickly"></a>Быстрое перегрузка одного большого двоичного объекта

Чтобы быстро передать один большой большой двоичный объект, клиентское приложение может параллельно передавать блоки или страницы, учитывать из целевых показателей масштабируемости для отдельных больших двоичных объектов и учетной записи хранения в целом. Клиентские библиотеки службы хранилища Azure поддерживают отправку в параллельном режиме. Например, можно использовать следующие свойства, чтобы указать количество одновременных запросов, разрешенных в .NET или Java. Клиентские библиотеки для других поддерживаемых языков предоставляют аналогичные параметры.

- Для .NET задайте свойство [BlobRequestOptions. ParallelOperationThreadCount](/dotnet/api/microsoft.azure.storage.blob.blobrequestoptions.paralleloperationthreadcount) .
- Для Java/Android вызовите метод [BlobRequestOptions. сетконкуррентрекуесткаунт (окончательный целочисленный конкуррентрекуесткаунт)](/java/api/com.microsoft.azure.storage.blob._blob_request_options.setconcurrentrequestcount) .

### <a name="upload-many-blobs-quickly"></a>Быстрое перегрузка большого количества больших двоичных объектов

Чтобы быстро отправить множество BLOB-объектов, отправьте их параллельно. Передача в параллельном режиме выполняется быстрее, чем отправка одиночных больших двоичных объектов за раз с параллельной передачей на несколько секций, так как она распределяет нагрузку между несколькими разделами службы хранилища. AzCopy выполняет отправку параллельно по умолчанию и рекомендуется для этого сценария. Дополнительные сведения см. в статье Начало [работы с AzCopy](../common/storage-use-azcopy-v10.md).  

## <a name="choose-the-correct-type-of-blob"></a>Выберите правильный тип большого двоичного объекта

Служба хранилища Azure поддерживает блочные, добавочные и страничные BLOB-объекты. В данном случае использования выбор типа BLOB-объекта будет влиять на производительность и масштабируемость решения.

Блочные BLOB-объекты подходят, если требуется эффективно передавать большие объемы данных. Например, клиентское приложение, которое отправляет фотографии или видео в хранилище BLOB-объектов, будет нацелено на блочные BLOB-объекты.

Добавочные большие двоичные объекты похожи на блочные BLOB-объекты в том, что они состоят из блоков. При изменении добавляемого большого двоичного объекта блоки добавляются только в конец большого двоичного объекта. Добавочные BLOB-объекты полезны для таких сценариев, как ведение журнала, когда приложению необходимо добавить данные в существующий большой двоичный объект.

Страничные BLOB-объекты подходят, если приложению требуется выполнять случайные операции записи данных. Например, диски виртуальной машины Azure хранятся в виде страничных BLOB-объектов. Дополнительные сведения см. в разделе [понятие блочных BLOB-объектов, Добавление больших двоичных объектов и страничных больших двоичных объектов](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs).  

## <a name="next-steps"></a>Дальнейшие действия

- [Azure Storage scalability and performance targets for storage accounts](../common/storage-scalability-targets.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) (Целевые показатели масштабируемости и производительности службы хранилища Azure для учетных записей хранения)
- [Коды состояния и ошибок](/rest/api/storageservices/Status-and-Error-Codes2)
