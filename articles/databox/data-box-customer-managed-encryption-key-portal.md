---
title: Используйте портал Azure для настройки ключей, управляемых клиентом, для Azure Data Box
description: Узнайте, как использовать портал Azure для настройки ключей, управляемых клиентом, с помощью Azure Key Vault для Azure Data Box. Управляемые клиентом ключи позволяют создавать, менять, отключать и отзывать элементы управления доступом.
services: databox
author: alkohli
ms.service: databox
ms.topic: how-to
ms.date: 05/07/2020
ms.author: alkohli
ms.subservice: pod
ms.openlocfilehash: 31147d534109e0d74d33d102075c69eeb703496e
ms.sourcegitcommit: a07a01afc9bffa0582519b57aa4967d27adcf91a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/05/2020
ms.locfileid: "91739941"
---
# <a name="use-customer-managed-keys-in-azure-key-vault-for-azure-data-box"></a>Использование управляемых клиентом ключей в Azure Key Vault для Azure Data Box

Azure Data Box защищает ключ разблокировки устройства (также называемый паролем устройства), который используется для блокировки устройства с помощью ключа шифрования. По умолчанию ключ разблокировки устройства для заказа Data Box шифруется с помощью управляемого корпорацией Майкрософт ключа. Для дополнительного контроля над ключом разблокировки устройства можно также предоставить ключ, управляемый клиентом. 

Управляемые клиентом ключи должны быть созданы и сохранены в Azure Key Vault. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](../key-vault/general/overview.md).

В этой статье показано, как использовать управляемые клиентом ключи с Azure Data Box в [портал Azure](https://portal.azure.com/). Эта статья относится как к Azure Data Box устройствам, так и к Azure Data Box Heavyным устройствам.

## <a name="prerequisites"></a>Предварительные требования

Перед тем как начать, убедитесь в следующем:

1. Вы создали порядок Azure Data Box в соответствии с инструкциями в разделе [учебник. порядок Azure Data Box](data-box-deploy-ordered.md).

2. У вас уже есть Azure Key Vault с ключом, который можно использовать для защиты ключа разблокировки устройства. Сведения о создании Key Vault с помощью портала Azure см. в статье [Краткое руководство. Настройка и получение секрета из Azure Key Vault с помощью портала Azure](../key-vault/secrets/quick-create-portal.md).

    - **Обратимое удаление** и без **очистки** устанавливаются в существующем хранилище ключей. По умолчанию эти свойства отключены. Чтобы включить эти свойства, см. разделы **Включение обратимого удаления** и **Включение защиты от очистки** в одной из следующих статей:

        - [Как использовать обратимое удаление в Key Vault с помощью PowerShell](../key-vault/general/soft-delete-powershell.md).
        - [Как использовать обратимое удаление в Key Vault с помощью интерфейса командной строки](../key-vault/general/soft-delete-cli.md).
    - Существующее хранилище Key Vault должно иметь ключ RSA размером 2048 бит или более. Дополнительные сведения о ключах см. в разделе [сведения о ключах Azure Key Vault](../key-vault/keys/about-keys.md).
    - Хранилище ключей должно находиться в том же регионе, что и учетные записи хранения, используемые для данных. С ресурсом Azure Data Box можно связать несколько учетных записей хранения.
    - Если у вас нет хранилища ключей, его также можно создать, как описано в следующем разделе.

## <a name="enable-keys"></a>Включение ключей

Настройка ключа, управляемого клиентом, для Azure Data Box является необязательной. По умолчанию для защиты ключа BitLocker Data Box использует управляемый корпорацией Майкрософт ключ. Чтобы включить ключ, управляемый клиентом, в портал Azure выполните следующие действия.

1. Перейдите в колонку " **Обзор** " для заказа Data Box.

    ![Колонка "Обзор" заказа Data Box](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-1.png)

2. Перейдите в раздел **параметры > шифрование**. В разделе **тип шифрования**можно выбрать способ защиты ключа разблокировки устройства. По умолчанию для защиты пароля для разблокировки устройства используется управляемый корпорацией Майкрософт ключ. 

    ![Выбор параметра шифрования](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-2.png)

3. Выберите тип шифрования в качестве **управляемого клиентом ключа**. После выбора ключа, управляемого клиентом, **выберите хранилище ключей и ключ**.

    ![Выбор ключа, управляемого клиентом](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-3.png)

5. В колонке **Select key from Azure Key Vault** (Выбор ключа из Azure Key Vault) подписка заполняется автоматически. Для поля **Хранилище ключей** можно выбрать существующее хранилище Key Vault из раскрывающегося списка.

    ![Создание Azure Key Vault](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-31.png)

    Чтобы создать Key Vault, можно также выбрать **Создать**. В колонке **Создать Key Vault** введите группу ресурсов и имя Key Vault. Убедитесь, что включена **Защита от** **обратимого удаления** и очистки. Примите все остальные значения по умолчанию. Выберите **Review + Create** (Просмотреть и создать).

    ![Создание новой Azure Key Vault 2](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-4.png)

7. Проверьте сведения, связанные с Key Vault, и выберите **Создать**. Подождите несколько минут, пока не завершится создание Key Vault.

    ![Создание хранилища Azure Key Vault](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-5.png)

8. В колонке **Select key from Azure Key Vault** (Выбор ключа из Azure Key Vault) можно выбрать ключ в существующем Key Vault.

    ![Создать новый ключ в Azure Key Vault 3](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-6.png)

9. Если вы хотите создать новый ключ, выберите **создать** , чтобы создать ключ. Размер ключа RSA может быть 2048 бит или больше.

    ![Создать новый ключ в Azure Key Vault 4](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-61.png)

10. Укажите имя ключа, примите остальные значения по умолчанию и нажмите кнопку **Создать**. 

    ![Создание ключа](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-7.png)


11. Вы получите уведомление о том, что в Key Vault создан ключ. Выберите **версию** и нажмите кнопку **Выбрать**.

    ![Ключ, созданный в Key Vault](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-8.png)

12. На панели **тип шифрования** можно просмотреть хранилище ключей и ключ, выбранный для ключа, управляемого клиентом.

    ![Ключ и хранилище ключей для ключа, управляемого клиентом](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-9.png)

13. Сохраните ключ. 

    ![Сохранить ключ, управляемый клиентом](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-10.png)

    URL-адрес ключа отображается в разделе **тип шифрования**.

    ![URL-адрес ключа, управляемого клиентом](./media/data-box-customer-managed-encryption-key-portal/customer-managed-key-11.png)

> [!IMPORTANT]
> Вы можете отключить управляемый корпорацией Майкрософт ключ и перейти к ключу, управляемому клиентом, на любом этапе Data Box заказа. Однако после создания ключа, управляемого клиентом, нельзя переключиться обратно на ключ, управляемый корпорацией Майкрософт.

## <a name="troubleshoot-errors"></a>Устранение неполадок

Если вы получаете ошибки, связанные с ключом, управляемым клиентом, воспользуйтесь следующей таблицей для устранения неполадок.

| Код ошибки| Сведения об ошибке| Восстановимая|
|-------------|--------------|---------|
| ссемусерерроренкриптионкэйдисаблед| Не удалось получить ключ доступа, так как ключ, управляемый клиентом, отключен.| Да, включив версию ключа.|
| ссемусерерроренкриптионкэйекспиред| Не удалось получить ключ доступа, так как истек срок действия управляемого ключа клиента.| Да, включив версию ключа.|
| ссемусерерроркэйдетаилснотфаунд| Не удалось получить ключ доступа, так как не удалось найти ключ, управляемый клиентом.| Если вы удалили хранилище ключей, вы не сможете восстановить ключ, управляемый клиентом.  Если вы перенесли хранилище ключей на другой клиент, см. статью [Изменение идентификатора клиента хранилища ключей после перемещения подписки](../key-vault/general/move-subscription.md). Если вы удалили хранилище ключей:<ol><li>Да, если срок действия защиты от очистки не истек, выполните шаги, описанные в разделе [Восстановление хранилища ключей](../key-vault/general/soft-delete-powershell.md#recovering-a-key-vault).</li><li>Нет, если истек срок действия защиты от очистки.</li></ol><br>В противном случае, если хранилище ключей прошло миграцию клиента, да, его можно восстановить, выполнив одно из следующих действий. <ol><li>Верните Key Vault обратно на старый клиент.</li><li>Установите значение `Identity = None`, а затем верните обратно значение `Identity = SystemAssigned`. Это приведет к удалению и повторному созданию удостоверения сразу же после создания удостоверения. Включите для нового удостоверения разрешения `Get`, `Wrap` и `Unwrap` в политике доступа Key Vault.</li></ol> |
| ссемусерерроркэйваултбадрекуестексцептион| Не удалось получить ключ доступа при отмене доступа к ключу, управляемому клиентом.| Да, убедитесь, что: <ol><li>В Key Vault по-прежнему есть MSI в политике доступа.</li><li>Политика доступа предоставляет разрешения для получения, переноса, распаковки.</li><li>Если хранилище ключей находится в виртуальной сети за брандмауэром, установите флажок **разрешить включение доверенных служб Майкрософт** .</li></ol>|
| ссемусерерроркэйваултдетаилснотфаунд| Не удалось получить ключ доступа, так как не удалось найти связанное хранилище ключей для управляемого ключа клиента. | Если вы удалили хранилище ключей, вы не сможете восстановить ключ, управляемый клиентом.  Если вы перенесли хранилище ключей на другой клиент, см. статью [Изменение идентификатора клиента хранилища ключей после перемещения подписки](../key-vault/general/move-subscription.md). Если вы удалили хранилище ключей:<ol><li>Да, если срок действия защиты от очистки не истек, выполните шаги, описанные в разделе [Восстановление хранилища ключей](../key-vault/general/soft-delete-powershell.md#recovering-a-key-vault).</li><li>Нет, если истек срок действия защиты от очистки.</li></ol><br>В противном случае, если хранилище ключей прошло миграцию клиента, да, его можно восстановить, выполнив одно из следующих действий. <ol><li>Верните Key Vault обратно на старый клиент.</li><li>Установите значение `Identity = None`, а затем верните обратно значение `Identity = SystemAssigned`. Это приведет к удалению и повторному созданию удостоверения сразу же после создания удостоверения. Включите для нового удостоверения разрешения `Get`, `Wrap` и `Unwrap` в политике доступа Key Vault.</li></ol> |
| ссемусереррорсистемассигнедидентитябсент  | Не удалось получить ключ доступа, так как не удалось найти ключ, управляемый клиентом.| Да, убедитесь, что: <ol><li>В Key Vault по-прежнему есть MSI в политике доступа.</li><li>Удостоверение имеет назначенный системой тип.</li><li>Включите разрешения GET, Wrap и Unwrap для удостоверения в политике доступа хранилища ключей.</li></ol>|
| Общая ошибка  | Не удалось получить ключ доступа.| Это общая ошибка. Обратитесь в служба поддержки Майкрософт, чтобы устранить ошибку и определить дальнейшие действия.|


## <a name="next-steps"></a>Дальнейшие действия

- [Об Azure Key Vault](../key-vault/general/overview.md)
