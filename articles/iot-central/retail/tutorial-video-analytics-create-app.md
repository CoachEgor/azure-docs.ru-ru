---
title: Учебник по созданию видеоаналитики — приложения для распознавания объектов и движения в Azure IoT Central
description: В этом учебнике показано, как создать приложение видеоаналитики в IoT Central. Его можно создать, настроить и подключить к другим службам Azure.
services: iot-central
ms.service: iot-central
ms.subservice: iot-central-retail
ms.topic: tutorial
author: KishorIoT
ms.author: nandab
ms.date: 07/31/2020
ms.openlocfilehash: 897262dcdb8cbacd512f19823da375e2c603b97e
ms.sourcegitcommit: bfeae16fa5db56c1ec1fe75e0597d8194522b396
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/10/2020
ms.locfileid: "88037946"
---
# <a name="tutorial-create-a-video-analytics---object-and-motion-detection-application-in-azure-iot-central"></a>Руководство по созданию видеоаналитики — приложения для распознавания объектов и движения в Azure IoT Central

Узнайте, как разработчики решений создают приложения для видеоаналитики с помощью шаблона приложения *видеоаналитики для распознавания объектов и движения* в IoT Central, на устройствах Azure IoT Edge и в Службах мультимедиа Azure. Решение использует магазин розничной торговли, чтобы продемонстрировать, как удовлетворить стандартные бизнес-потребности для мониторинга с помощью камер безопасности. Решение использует автоматическое обнаружение объектов в видеоканале, чтобы быстро находить и распознавать интересующие события.

Пример приложения включает в себя два имитированных устройства и один шлюз IoT Edge. В следующих учебниках описаны два подхода, с которыми можно поэкспериментировать, а также сведения о возможностях шлюза.

* Создайте шлюз IoT Edge на виртуальной машине Azure и подключите имитируемую камеру.
* Создайте шлюз IoT Edge на реальном устройстве, например Intel NUC, и подключите реальную камеру.

В этом руководстве описано следующее:
> [!div class="checklist"]
> * Создание приложения розничного магазина с помощью шаблона видеоаналитики Azure IoT Central.
> * Настройка параметров приложения
> * Создание шаблона для устройства шлюза IoT Edge
> * Добавление имитированного устройства шлюза в приложение IoT Central.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этой серией учебников вам потребуется следующее:

* Подписка Azure. Если у вас еще нет подписки, создайте ее на [странице регистрации в Azure](https://aka.ms/createazuresubscription);
* Если вы используете реальную камеру, вам потребуется иметь подключение между устройством IoT Edge и камерой, а также канал **с потоковой передачей по протоколу RTSP**.

## <a name="initial-setup"></a>Начальная настройка

В этих учебниках вы обновите и используете несколько файлов конфигурации. Исходные версии этих файлов доступны в репозитории [LVA-gateway](https://github.com/Azure/live-video-analytics) на GitHub. Репозиторий также содержит текстовый файл блокнота, который можно скачать и использовать для записи значений конфигурации из развертываемых служб.

Создайте папку с именем *lva-configuration* на локальном компьютере, чтобы сохранить копии этих файлов. Затем щелкните правой кнопкой мыши каждую из следующих ссылок и выберите **Сохранить как**, чтобы сохранить файл в папку *lva-configuration*.

- [Scratchpad.txt](https://raw.githubusercontent.com/Azure/live-video-analytics/master/ref-apps/lva-edge-iot-central-gateway/setup/Scratchpad.txt)
- [deployment.amd64.json](https://raw.githubusercontent.com/Azure/live-video-analytics/master/ref-apps/lva-edge-iot-central-gateway/setup/deployment.amd64.json)
- [LvaEdgeGatewayDcm.json](https://raw.githubusercontent.com/Azure/live-video-analytics/master/ref-apps/lva-edge-iot-central-gateway/setup/LvaEdgeGatewayDcm.json)
- [state.json](https://raw.githubusercontent.com/Azure/live-video-analytics/master/ref-apps/lva-edge-iot-central-gateway/setup/state.json)

> [!NOTE]
> Репозиторий GitHub также содержит исходный код для модулей IoT Edge **LvaEdgeGatewayModule** и **lvaYolov3**. Дополнительные сведения о работе с исходным кодом см. в статье [Учебник по изменению и созданию модулей шлюза видеоаналитики в реальном времени](tutorial-video-analytics-build-module.md).

## <a name="deploy-and-configure-azure-media-services"></a>Развертывание и настройка Служб мультимедиа Azure

Решение использует учетную запись Служб мультимедиа Azure для хранения видеороликов распознавания объектов, сделанных с помощью устройства шлюза IoT Edge.

При создании учетной записи Служб мультимедиа выполните следующие действия.

- Укажите имя учетной записи, подписку Azure, расположение, группу ресурсов и учетную запись хранения. Создайте учетную запись хранения, используя параметры по умолчанию во время создания учетной записи Служб мультимедиа.

- Выберите регион **Восточная часть США** для расположения.

- Создайте группу ресурсов с именем *lva-rg* в регионе **Восточная часть США** для служб мультимедиа и учетных записей хранения. По завершении работы с учебниками можно легко удалить все ресурсы, удалив группу ресурсов *lva-rg*.

Создайте [учетную запись Служб мультимедиа на портале Azure](https://portal.azure.com/?r=1#create/Microsoft.MediaService).

> [!TIP]
> Во всех примерах в этих учебниках используется регион **Восточная часть США**. При желании можно использовать ближайший регион.

Запишите имя учетной записи **Служб мультимедиа** в файле *scratchpad.txt*.

После завершения развертывания перейдите к странице **Свойства** учетной записи **Служб мультимедиа**. Запишите **идентификатор ресурса** в файле *scratchpad.txt*. Это значение будет использоваться позже при настройке модуля IoT Edge.

Затем настройте субъект-службу Azure Active Directory для ресурса Служб мультимедиа. Выберите **Доступ к API**, а затем — **Проверка подлинности субъекта-службы**. Создайте приложение Azure Active Directory с тем же именем, что и ресурс Служб мультимедиа, а затем — секрет с описанием *Доступ к IoT Edge*.

:::image type="content" source="./media/tutorial-video-analytics-create-app/media-service-authentication.png" alt-text="Настройка приложения AAD для AMS":::

После создания секрета прокрутите вниз до раздела **Скопируйте свои учетные данные, чтобы подключить приложение субъекта-службы.** . Затем выберите **JSON**. Здесь можно скопировать всю информацию об учетных данных. Запишите эти сведения в файле *scratchpad.txt*. Они будут использоваться позже при настройке устройства IoT Edge.

> [!WARNING]
> Это единственная возможность просмотреть и сохранить секрет. Если вы потеряли его, необходимо создать другой секрет.

## <a name="create-the-azure-iot-central-application"></a>Создание приложения Azure IoT Central

В этом разделе вы создадите новое приложение Azure IoT Central на основе шаблона. Это приложение будет использоваться на всем протяжении серии учебников для создания полного решения.

Чтобы создать приложение Azure IoT Central, сделайте следующее:

1. Перейдите на веб-сайт [диспетчера приложений в Azure IoT Central](https://aka.ms/iotcentral).

1. Войдите, используя учетные данные для доступа к подписке Azure.

1. Чтобы начать создание приложения Azure IoT Central, выберите **Новое приложение** на странице **Сборка**.

1. Выберите **Розничная торговля**. На странице "Розничная торговля" отображается несколько шаблонов розничных приложений.

Создание приложения для видеоаналитики

1. Выберите шаблон приложения **Видеоаналитика — распознавание объектов и движения**. Этот шаблон включает шаблоны для всех устройств, используемых в учебнике. Шаблон также содержит панель мониторинга оператора для мониторинга видео.

1. Выберите **понятное имя** для приложения. Это приложение основано на вымышленном розничном магазине с именем Northwind Traders. В этом учебнике используется **имя приложения** *Видеоаналитика Northwind Trader*.

    > [!NOTE]
    > Если вы используете понятное **имя приложения**, все равно необходимо использовать уникальное значение для **URL-адреса приложения**.

1. Если у вас есть подписка Azure, выберите **каталог**, **подписку Azure** и **расположение** **Северная Америка**. Если у вас нет подписки, вы можете включить **семидневную бесплатную пробную версию** и указать необходимые контактные данные. В этом учебнике используются три устройства — две камеры и устройство IoT Edge. Поэтому, если вы не используете бесплатную пробную версию, плата за использование будет взиматься.

    Дополнительные сведения о каталогах, расположениях и подписках см. в кратком руководстве по [созданию приложения](../core/quick-deploy-iot-central.md).

1. Нажмите кнопку **создания**.

    :::image type="content" source="./media/tutorial-video-analytics-create-app/new-application.png" alt-text="Страница создания приложения Azure IoT Central":::

### <a name="retrieve-the-configuration-data"></a>Получение данных конфигурации

Далее в этом учебнике при настройке шлюза IoT Edge требуются данные конфигурации из приложения IoT Central. Устройству IoT Edge требуются эти сведения для регистрации и подключения к приложению.

В разделе **Администрирование** выберите **Ваше приложение** и запишите **URL-адрес приложения** и **идентификатор приложения** в файле *scratchpad.txt*.

:::image type="content" source="./media/tutorial-video-analytics-create-app/administration.png" alt-text="Администрирование":::

Выберите **Токены API** и создайте токен с именем **LVAEdgeToken** для роли **Оператор**.

:::image type="content" source="./media/tutorial-video-analytics-create-app/token.png" alt-text="Создание токена":::

Запишите маркер в файле *scratchpad.txt* для последующего использования. После закрытия диалогового окна вы не сможете снова просмотреть токен.

В разделе **Администрирование** выберите **Подключение устройства**, а затем — **SAS-IoT-Devices**.

Запишите **первичный ключ** для устройств в файле *scratchpad.txt*. Вы будете использовать *токен подписанного URL-адреса общего доступа основной группы* позже при настройке устройства IoT Edge.

## <a name="edit-the-deployment-manifest"></a>Изменение манифеста развертывания

Модуль IoT Edge развертывается с помощью манифеста развертывания. В IoT Central можно импортировать манифест как шаблон устройства, а затем разрешить IoT Central управлять развертыванием модуля.

Чтобы подготовить манифест развертывания, выполните следующие действия.

1. Откройте файл *deployment.amd64.json*, сохраненный в папке *lva-configuration*, с помощью текстового редактора.

1. Найдите параметры `LvaEdgeGatewayModule` и измените имя образа, как показано в следующем фрагменте кода:

    ```json
    "LvaEdgeGatewayModule": {
        "settings": {
            "image": "mcr.microsoft.com/lva-utilities/lva-edge-iotc-gateway:1.0-amd64",
    ```

1. Добавьте имя учетной записи Служб мультимедиа в узел `env` в разделе `LvaEdgeGatewayModule`. Вы записали это имя учетной записи в файле *scratchpad.txt*:

    ```json
    "env": {
        "lvaEdgeModuleId": {
            "value": "lvaEdge"
        },
        "amsAccountName": {
            "value": "<YOUR_AZURE_MEDIA_ACCOUNT_NAME>"
        }
    }
    ```

1. Шаблон не предоставляет эти свойства в IoT Central, поэтому необходимо добавить значения конфигурации Служб мультимедиа в манифест развертывания. Найдите модуль `lvaEdge` и замените заполнители значениями, которые вы записали в файле *scratchpad.txt* при создании учетной записи Служб мультимедиа.

    `azureMediaServicesArmId` является **идентификатором ресурса**, который вы записали в файле *scratchpad.txt* при создании учетной записи Служб мультимедиа.

    При создании субъекта-службы для учетной записи Служб мультимедиа вы записали `aadTenantId`, `aadServicePrincipalAppId` и `aadServicePrincipalSecret` в файле *scratchpad.txt*.

    ```json
    {
        "lvaEdge":{
        "properties.desired": {
            "applicationDataDirectory": "/var/lib/azuremediaservices",
            "azureMediaServicesArmId": "[Resource ID from scratchpad]",
            "aadTenantId": "[AADTenantID from scratchpad]",
            "aadServicePrincipalAppId": "[AadClientId from scratchpad]",
            "aadServicePrincipalSecret": "[AadSecret from scratchpad]",
            "aadEndpoint": "https://login.microsoftonline.com",
            "aadResourceId": "https://management.core.windows.net/",
            "armEndpoint": "https://management.azure.com/",
            "diagnosticsEventsOutputName": "AmsDiagnostics",
            "operationalMetricsOutputName": "AmsOperational",
            "logCategories": "Application,Event",
            "AllowUnsecuredEndpoints": "true",
            "TelemetryOptOut": false
            }
        }
    }
    ```

1. Сохраните изменения.

При необходимости вы можете заменить модуль Yolov3 на аппаратно-оптимизированный сервер модели [OpenVINO&trade; — модуль расширения искусственного интеллекта Edge](https://github.com/openvinotoolkit/model_server/tree/ams/extras/ams_wrapper) от Intel. Вы можете скачать пример манифеста развертывания [deployment.openvino.amd64.json](https://raw.githubusercontent.com/Azure/live-video-analytics/master/ref-apps/lva-edge-iot-central-gateway/setup/deployment.openvino.amd64.json). Этот манифест заменяет параметры конфигурации модуля `lvaYolov3` следующей конфигурацией:

```json
"OpenVINOModelServerEdgeAIExtensionModule": {
    "settings": {
        "image": "marketplace.azurecr.io/intel_corporation/open_vino",
        "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"4000/tcp\":[{\"HostPort\":\"4000\"}]}},\"Cmd\":[\"/ams_wrapper/start_ams.py\",\"--ams_port=4000\",\"--ovms_port=9000\"]}"
    },
    "type": "docker",
    "version": "1.0",
    "status": "running",
    "restartPolicy": "always"
}
```

## <a name="create-the-azure-iot-edge-gateway-device"></a>Создание устройства шлюза Azure IoT Edge

Приложение видеоаналитики для распознавания объектов и движения включает в себя шаблон устройства **детектора объектов LVA Edge**, а также шаблон **обнаружения движения LVA Edge**. В этом разделе вы создадите шаблон устройства шлюза с помощью манифеста развертывания и добавите устройство шлюза в приложение IoT Central.

### <a name="create-a-device-template-for-the-lva-edge-gateway"></a>Создание шаблона устройства для шлюза LVA Edge

Чтобы импортировать манифест развертывания и создать шаблон устройства **шлюза LVA Edge**, сделайте следующее:

1. В приложении IoT Central перейдите в раздел **Шаблоны устройств** и щелкните **+ Создать**.

1. На странице **Select template type** (Выбрать тип шаблона) выберите плитку **Azure IoT Edge**. Затем щелкните **Next: Настройка**.

1. На странице **Upload an Azure IoT Edge deployment manifest** (Отправка манифеста развертывания Azure IoT Edge) введите в качестве имени шаблона *шлюз LVA Edge* и установите флажок **Gateway device with downstream devices** (Устройство шлюза с подчиненными устройствами).

    Пока не выполняйте поиск манифеста развертывания. Если это сделать, мастер развертывания будет ожидать интерфейс для каждого модуля, но вам нужно предоставить интерфейс только для **LvaEdgeGatewayModule**. Вы отправите манифест позже.

    :::image type="content" source="./media/tutorial-video-analytics-create-app/upload-deployment-manifest.png" alt-text="Не отправляйте манифест развертывания":::

    По завершении выберите **Next: Review** (Далее: проверка).

1. На странице **Отзыв** выберите **Создать**.

### <a name="import-the-device-capability-model"></a>Импорт модели возможностей устройства

В каждом шаблоне устройства должна быть модель возможностей устройства. На странице **шлюза LVA Edge** выберите **Импорт модели возможностей**. Перейдите к папке *lva-configuration*, созданной ранее, и выберите файл *LvaEdgeGatewayDcm.json*.

Шаблон устройства **шлюза LVA Edge** теперь включает в себя **модуль шлюза LVA Edge**, а также три интерфейса: **Сведения об устройстве**, **параметры шлюза LVA Edge** и **интерфейс шлюза LVA Edge**.

### <a name="replace-the-manifest"></a>Замена манифеста

На странице **шлюза LVA Edge** выберите **+ Replace manifest** (+ Заменить манифест).

:::image type="content" source="./media/tutorial-video-analytics-create-app/replace-manifest.png" alt-text="Замена манифеста":::

Перейдите в папку *lva-configuration* и выберите файл манифеста *deployment.amd64.json*, который вы изменили ранее. Щелкните **Отправить**. После завершения проверки нажмите кнопку **Заменить**.

### <a name="add-relationships"></a>Добавление связей

В шаблоне устройства **шлюза LVA Edge** в разделе **Modules/LVA Edge Gateway Module** (Модули/Модуль шлюза LVA Edge) выберите **Связи**. Выберите **+ Add relationship** (+ Добавить связь) и добавьте две следующие связи:

|Отображаемое имя               |Имя          |Назначение |
|-------------------------- |------------- |------ |
|Детектор движения LVA Edge   |Используйте значение по умолчанию.   |Устройство детектора движения LVA Edge |
|Детектор объектов LVA Edge   |Используйте значение по умолчанию.   |Устройство детектора объектов LVA Edge |

Затем нажмите кнопку **Save** (Сохранить).

:::image type="content" source="media/tutorial-video-analytics-create-app/relationships.png" alt-text="Добавление связей":::

### <a name="add-views"></a>Добавление представлений

Шаблон **шлюза LVA Edge** не содержит определений представлений.

Чтобы добавить такое представление в шаблон устройства, выполните следующие действия.

1. В шаблоне устройства **шлюза LVA Edge** перейдите в раздел **Представления** и выберите плитку **Визуализация устройства**.

1. В качестве имени представления введите *устройство шлюза LVA Edge*.

1. Добавьте в представление следующие плитки:

    * Плитка со свойствами **сведений об устройстве**: **модель устройства**, **производитель**, **операционная система**, **архитектура процессора**, **программное обеспечение**, **общий объем памяти** и **общий объем хранилища**.
    * Плитка графика с данными телеметрии **объема свободной памяти** и **работоспособности системы**.
    * Плитка журнала событий со следующими событиями: **создание камеры**, **удаление камеры**, **перезапуск модуля**, **запущенный модуль** и **остановленный модуль**.
    * Плитка последнего известного значения 2x1, показывающая телеметрию **состояния клиента IoT Central**.
    * Плитка последнего известного значения 2x1, показывающая телеметрию **состояния модуля**.
    * Плитка последнего известного значения 1x1, показывающая телеметрию **работоспособности системы**.
    * Плитка последнего известного значения 1x1, показывающая телеметрию **подключенных камер**.

    :::image type="content" source="media/tutorial-video-analytics-create-app/gateway-dashboard.png" alt-text="Панель мониторинга":::

1. Щелкните **Сохранить**.

### <a name="publish-the-device-template"></a>Публикация шаблона устройства

Прежде чем можно будет добавить устройство в приложение, необходимо опубликовать шаблон устройства:

1. Выберите действие **Опубликовать** в шаблоне устройства **шлюза LVA Edge**.

1. На странице **Опубликовать этот шаблон устройства в приложении** щелкните **Опубликовать**.

**Шлюз LVA Edge** теперь доступен в качестве типа устройства для использования на странице **Устройства** приложения.

## <a name="add-a-gateway-device"></a>Добавление подсети шлюза

Чтобы добавить устройство **шлюза LVA Edge** в приложение, выполните следующие действия.

1. Перейдите на страницу **Устройства** и выберите шаблон устройства **шлюза LVA Edge**.

1. Выберите **+ Создать**.

1. В диалоговом окне **Создание устройства** измените имя устройства на *шлюз LVA 001*, а идентификатор устройства — на *lva-gateway-001*.

    > [!NOTE]
    > Идентификатор устройства должен быть уникальным в приложении.

1. Нажмите кнопку **создания**.

Состояние устройства должно измениться на **Зарегистрировано**.

### <a name="get-the-device-credentials"></a>Получение учетных данных устройства

Необходимо иметь учетные данные, которые позволят устройству подключаться к приложению IoT Central. Чтобы получить учетные данные устройства, выполните шаги ниже:

1. На странице **Устройства** выберите устройство **lva-gateway-001**, которое вы только что создали.

1. Выберите **Подключиться**.

1. На странице **Подключение к устройству** в файле *scratchpad.txt* запишите значения параметров **Область идентификатора**, **ИД устройства** и **Первичный ключ**. Эти значения понадобятся позже.

1. Убедитесь, что для метода подключения задано значение **Подписанный URL-адрес**.

1. Выберите **Закрыть**.

## <a name="next-steps"></a>Дальнейшие действия

Вы создали приложение IoT Central с помощью шаблона приложения **Видеоаналитика — распознавание объектов и движения**, создали шаблон устройства шлюза и добавили в приложение устройство шлюза.

Если вы хотите испытать приложение "Видеоаналитика — распознавание объектов и движения", используя модули IoT Edge в облачной виртуальной машине с имитированными потоками видео, ознакомьтесь со следующей статьей:

> [!div class="nextstepaction"]
> [Создание экземпляра IoT Edge для видеоаналитики (виртуальная машина Linux)](./tutorial-video-analytics-iot-edge-vm.md)

Если вы хотите испытать приложение "Видеоаналитика — распознавание объектов и движения", используя модули IoT Edge, работающие на реальном устройстве с реальной камерой **ONVIF**, ознакомьтесь со следующей статьей:

> [!div class="nextstepaction"]
> [Создание экземпляра IoT Edge для видеоаналитики (Intel NUC)](./tutorial-video-analytics-iot-edge-nuc.md)
