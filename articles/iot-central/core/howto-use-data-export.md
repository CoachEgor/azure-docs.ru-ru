---
title: Экспорт данных из IoT Central | Документация Майкрософт
description: Как использовать новый экспорт данных для экспорта данных IoT в Azure и назначения пользовательских облаков.
services: iot-central
author: viv-liu
ms.author: viviali
ms.date: 08/04/2020
ms.topic: how-to
ms.service: iot-central
manager: corywink
ms.openlocfilehash: f51630154b77233aeb2587ac3a2d603c1da6fa4f
ms.sourcegitcommit: bfeae16fa5db56c1ec1fe75e0597d8194522b396
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/10/2020
ms.locfileid: "88036561"
---
# <a name="export-iot-data-to-cloud-destinations-using-data-export-preview"></a>Экспорт данных IoT в облачные назначения с помощью экспорта данных (Предварительная версия)

> [!Note]
> Ищете экспорт устаревших данных? Документацию по экспорту данных можно найти [здесь](./howto-export-data.md). Дополнительные сведения о различиях между новым экспортом данных и экспортом устаревших данных см. в [таблице сравнения](#comparison-of-legacy-data-export-and-new-data-export).

В этой статье описывается, как использовать новые функции предварительной версии экспорта данных в Azure IoT Central. Эту функцию можно использовать для непрерывного экспорта отфильтрованных и обогащенных данных Интернета вещей в облачные службы. Вы можете использовать экспорт данных, чтобы отправлять изменения практически в реальном времени в другие части облачного решения для получения подробных сведений, аналитики и хранилища для теплого пути. 

 Например, с их помощью можно выполнять следующее.
-   Непрерывное экспорт данных телеметрии и изменение свойств в формате JSON практически в реальном времени
-   Фильтрация этих потоков данных для экспорта конкретных возможностей, соответствующих пользовательским условиям
-   Улучшение потоков данных с помощью пользовательских значений и значений свойств с устройства
-   Отправьте эти данные в назначения, такие как концентраторы событий Azure, служебная шина Azure, хранилище BLOB-объектов Azure и конечные точки веб-перехватчика.

> [!Note]
> При включении экспорта данных вы получаете только данные из этого момента. В настоящее время невозможно получить данные за время отключения экспорта данных. Чтобы хранить более исторические данные, включите экспорт данных на раннем этапе.

## <a name="prerequisites"></a>Предварительные требования

Чтобы использовать экспорт данных (Предварительная версия), необходимо иметь приложение v3, и у вас должны быть разрешения на экспорт данных.

## <a name="set-up-export-destination"></a>Настройка места назначения экспорта

Назначение экспорта должно существовать до настройки экспорта данных. Ниже приведены доступные типы назначений.
  - Центры событий Azure
  - Очередь служебной шины Azure
  - Раздел служебной шины Azure
  - Хранилище BLOB-объектов Azure
  - webhook

### <a name="create-an-event-hubs-destination"></a>Создание назначения концентраторов событий

Если у вас нет пространства имен концентраторов событий для экспорта, выполните следующие действия.

1. Создайте [пространство имен Центров событий на портале Azure](https://ms.portal.azure.com/#create/Microsoft.EventHub). Дополнительные сведения см. в [документации по Центрам событий Azure](../../event-hubs/event-hubs-create.md).

2. Создайте концентратор событий в пространстве имен в Центрах событий. Перейдите к пространству имен и выберите **+ Концентратор событий** в верхней части, чтобы создать экземпляр концентратора событий.

3. Создайте ключ, который будет использоваться в IoT Central для настройки экспорта данных. 
    - Щелкните созданный экземпляр концентратора событий. 
    - Щелкните **Параметры/политики общего доступа**. 
    - Создайте новый ключ или выберите существующий ключ с разрешениями на **отправку** . 
    - Скопируйте основную или дополнительную строку подключения. Он используется для настройки нового назначения в IoT Central.

### <a name="create-a-service-bus-queue-or-topic-destination"></a>Создание очереди или назначения раздела служебной шины

Если у вас нет пространства имен служебной шины для экспорта, выполните следующие действия.

1. Создайте [новое пространство имен служебной шины в портал Azure](https://ms.portal.azure.com/#create/Microsoft.ServiceBus.1.0.5). Дополнительные сведения см. в [документации по Служебной шине Azure](../../service-bus-messaging/service-bus-create-namespace-portal.md).

2. Чтобы создать очередь или раздел для экспорта, перейдите к пространству имен служебной шины и выберите **+ очередь** или **+ раздел**.

3. Создайте ключ, который будет использоваться в IoT Central для настройки экспорта данных. 
    - Щелкните созданную очередь или раздел. 
    - Щелкните **Параметры/политики общего доступа**. 
    - Создайте новый ключ или выберите существующий ключ с разрешениями на **отправку** . 
    - Скопируйте основную или дополнительную строку подключения. Он используется для настройки нового назначения в IoT Central.

### <a name="create-an-azure-blob-storage-destination"></a>Создание места назначения хранилища BLOB-объектов Azure

Если у вас нет существующей учетной записи хранения Azure для экспорта, выполните следующие действия.

1. Создайте [учетную запись хранения на портале Azure](https://ms.portal.azure.com/#create/Microsoft.StorageAccount-ARM). Вы можете узнать больше о создании новых [учетных записей хранения BLOB-объектов Azure](https://aka.ms/blobdocscreatestorageaccount) или [учетных записей хранения Azure Data Lake Storage v2](../../storage/blobs/data-lake-storage-quickstart-create-account.md). Экспорт данных может записывать данные только в учетные записи хранения, поддерживающие блочные BLOB-объекты. В следующем списке приведены известные совместимые типы учетных записей хранения.

    |Уровень производительности|Тип учетной записи|
    |-|-|
    |Standard|общего назначения v2|
    |Standard|общего назначения v1|
    |Standard|Хранилище BLOB-объектов|
    |Premium|Блочное хранилище BLOB-объектов|

2. Создайте контейнер в учетной записи хранения. Войдите в свою учетную запись хранения. Выберите **Обзор BLOB-объектов** в разделе **Служба BLOB-объектов**. Выберите **+ Контейнер** в верхней части экрана, чтобы создать контейнер.

3. Создайте строку подключения для учетной записи хранения, перейдя к **разделу Параметры и ключи доступа**. Скопируйте одну из двух строк подключения.

### <a name="create-a-webhook-endpoint"></a>Создание конечной точки веб-перехватчика
Вы можете предоставить общедоступную конечную точку HTTP для экспорта данных. Вы можете создать тестовую конечную точку веб-перехватчика с помощью RequestBin. Помните, что RequestBin имеет ограничение на набор запросов до регулирования запросов.

1. Откройте [RequestBin](https://requestbin.net/).
2. Создайте новый RequestBin и скопируйте Bin URL (URL-адрес Bin).

## <a name="set-up-data-export"></a>Настройка экспорта данных

Теперь, когда у вас есть место назначения для экспорта данных, выполните следующие действия, чтобы настроить экспорт данных.

1. Войдите в приложение IoT Central.

2. На левой панели выберите **Экспорт данных**.

    > [!Tip]
    > Если вы не видите элемент **Экспорт данных** в левой области, у вас нет разрешений на настройку экспорта данных в приложении. Обратитесь к администратору, чтобы настроить экспорт данных.

3. Нажмите кнопку **+ создать экспорт** . 

4. Введите отображаемое имя для нового экспорта и убедитесь, что **включен** переключатель для передачи данных.

## <a name="1-choose-the-type-of-data-to-export"></a>1. Выбор типа данных для экспорта
Можно выбрать между непрерывным экспортом различных типов данных. Ниже приведены поддерживаемые типы данных.

| Тип данных | Описание | Формат данных |
| :------------- | :---------- | :----------- |
|  Телеметрия | Экспорт сообщений телеметрии с устройств практически в реальном времени. Каждое экспортированное сообщение будет содержать полное содержимое исходного сообщения устройства, нормализованное.   |  [Формат сообщений телеметрии](#telemetry-format)   |
| Изменения свойств | Экспорт изменений в свойства устройства и облака в ближайшем режиме реального времени. Для свойств устройства только для чтения изменения сообщаемых значений будут экспортированы. Для свойств чтения и записи будут экспортированы как сообщаемые, так и требуемые значения. | [Формат сообщения об изменении свойства](#property-changes-format) |

## <a name="2-optional-add-filters"></a>2. Добавление фильтров (необязательно)
Добавьте фильтры, чтобы уменьшить объем экспортируемых данных на основе условий фильтра. Для каждого типа экспортируемых данных доступны различные типы фильтров.

### <a name="telemetry-filters"></a>Фильтры телеметрии
  - **Фильтр возможностей**. Если в раскрывающемся списке выбран элемент телеметрии, экспортированный поток будет содержать только данные телеметрии, соответствующие условию фильтра. При выборе элемента свойств устройства или облака в раскрывающемся списке экспортированный поток будет содержать данные телеметрии только с устройств, которые имеют свойства, соответствующие условию фильтра.
  - **Фильтр свойств сообщения**. устройствам, использующим пакеты SDK для устройств, разрешено отсылать *Свойства сообщений* или *свойства приложения* для каждого сообщения телеметрии, которое представляет собой набор пар "ключ-значение", которые обычно используются для пометки сообщения пользовательскими идентификаторами. Можно создать фильтр свойств сообщения, введя нужный ключ свойства сообщения и указав условие. Будут экспортированы только сообщения телеметрии, имеющие свойства сообщений, соответствующие заданному условию фильтра. Поддерживаются только операторы сравнения строк (равно, не равно, содержит, не содержит, существует, не существует). Дополнительные [сведения о свойствах приложений из документации центра Интернета вещей](../../iot-hub/iot-hub-devguide-messages-construct.md).

### <a name="property-changes-filters"></a>Фильтры изменения свойств
**Фильтр свойства**: выберите элемент свойства в раскрывающемся списке, и экспортированный поток будет содержать только изменения выбранного свойства, соответствующие условию фильтра.

## <a name="3-optional-add-enrichments"></a>3 (необязательно) Добавление дополнений
Добавьте дополнения к расширенным экспортированным сообщениям с дополнительными метаданными в парах "ключ-значение". Это доступные дополнения для типов данных телеметрии и свойств:
  - **Пользовательская строка**: добавляет пользовательскую статическую строку к каждому сообщению. Введите любой ключ и введите строковое значение.
  - **Свойство**: добавляет текущее свойство сообщаемого устройства или значение облачного свойства в каждое сообщение. Введите любой ключ и выберите свойство устройства или облака. Если экспортированное сообщение относится к устройству, которое не имеет указанного свойства устройства или облака, экспортируемое сообщение не будет иметь такого расширения.

## <a name="4-add-destinations"></a>4. Добавление назначений
Создайте новое место назначения или добавьте уже созданное назначение. 
  
1. Щелкните ссылку **создать новую папку назначения** . Заполните следующие сведения:
    - **Имя назначения**: отображаемое имя назначения в IOT Central
    - **Тип назначения**: выберите тип назначения. [Настройте назначение экспорта](#set-up-export-destination) , если оно еще не сделано.
    - Для концентраторов событий Azure, очереди или раздела служебной шины Azure вставьте строку подключения для ресурса. 
    - Для хранилища BLOB-объектов Azure вставьте строку подключения для ресурса и введите имя контейнера (с учетом регистра).
    - Для веб-перехватчика вставьте URL обратного вызова для конечной точки веб-перехватчика. 
    - Нажмите кнопку **Создать**.

2. Щелкните **+ назначение** и выберите назначение из раскрывающегося списка. Вы добавляете до 5 назначений в один экспорт.

3. Завершив настройку экспорта, нажмите кнопку **сохранить**. Через несколько минут данные будут отображаться в своих назначениях.

## <a name="export-contents-and-format"></a>Экспорт содержимого и формата

### <a name="azure-blob-storage-destination"></a>Назначение хранилища BLOB-объектов Azure

Данные экспортируются один раз в минуту, при этом каждый файл содержит пакет изменений с момента последнего экспортированного файла. Экспортированные данные помещаются в три папки в формате JSON. Пути по умолчанию в вашей учетной записи хранения:

- Данные телеметрии: _{Container}/{апп-ид}/{partition_id}/{ИИИИ}/{мм}/{дд}/{ХХ}/{мм}/{филенаме}_
- Изменения свойств: _{Container}/{апп-ид}/{partition_id}/{ИИИИ}/{мм}/{дд}/{ХХ}/{мм}/{филенаме}_

Чтобы просмотреть экспортированные файлы в портал Azure, перейдите к файлу и перейдите на вкладку **изменение большого двоичного объекта** .

### <a name="azure-event-hubs-and-azure-service-bus-destinations"></a>Концентраторы событий Azure и назначения служебной шины Azure

Данные экспортируются практически в реальном времени. Данные находятся в теле сообщения и имеют формат JSON, закодированный как UTF-8. 

В контейнере заметок или системных свойств сообщения можно найти `iotcentral-device-id` , `iotcentral-application-id` , `iotcentral-message-source` и, `iotcentral-message-type` которые имеют те же значения, что и соответствующие поля в тексте сообщения.

### <a name="webhook-destination"></a>Назначение веб-перехватчика
Для назначений веб-перехватчиков данные также экспортируются практически в режиме реального времени. Данные находятся в тексте сообщения в том же формате, что и для концентраторов событий и служебной шины.


## <a name="telemetry-format"></a>Формат телеметрии
Каждое экспортированное сообщение содержит нормализованную форму полного сообщения, отправленного устройством в теле сообщения в формате JSON, закодированном как UTF-8. В каждое сообщение входят следующие дополнительные сведения:

- `applicationId`приложения IoT Central
- `messageSource`что такое данные *телеметрии* для экспорта данных телеметрии
- `deviceId`устройства, отправившего сообщение телеметрии
- `schema`имя и версия схемы полезных данных
- `templateId`Идентификатор шаблона устройства, связанного с устройством.
- `enrichments`какие расширения были настроены при экспорте;
- `messageProperties`— Это дополнительные фрагменты данных, которые устройство отправляет вместе с сообщением. Это также называется *свойствами приложения*, [Дополнительные сведения см. в документах центра Интернета вещей](../../iot-hub/iot-hub-devguide-messages-construct.md).

Для концентраторов событий и служебной шины IoT Central быстро экспортирует новое сообщение после получения сообщения с устройства.

Для хранилища BLOB-объектов сообщения помещаются в пакет и экспортируются один раз в минуту.

В следующем примере показано экспортированное сообщение телеметрии.

```json

{
    "applicationId": "1dffa667-9bee-4f16-b243-25ad4151475e",
    "messageSource": "telemetry",
    "deviceId": "1vzb5ghlsg1",
    "schema": "default@preview",
    "templateId": "urn:qugj6vbw5:___qbj_27r",
    "enqueuedTime": "2020-08-05T22:26:55.455Z",
    "telemetry": {
        "Activity": "running",
        "BloodPressure": {
            "Diastolic": 7,
            "Systolic": 71
        },
        "BodyTemperature": 98.73447010562934,
        "HeartRate": 88,
        "HeartRateVariability": 17,
        "RespiratoryRate": 13
    },
    "enrichments": {
      "userSpecifiedKey": "sampleValue"
    },
    "messageProperties": {
      "messageProp": "value"
    }
}
```

## <a name="property-changes-format"></a>Формат изменения свойства

Каждое сообщение или запись представляет одно изменение в свойстве устройства или облака. Для свойств устройства только изменения в сообщаемом значении экспортируются как отдельное сообщение. Дополнительные сведения, включенные в экспортированное сообщение, включают:

- `applicationId`приложения IoT Central
- `messageSource`*Свойства* для экспорта данных об изменениях свойств
- `messageType`Это либо *клаудпропертичанже* , либо *девицепропертидесиредчанже*, *девицепропертирепортедчанже*
- `deviceId`устройства, свойства которого изменились
- `schema`имя и версия схемы полезных данных
- `templateId`Идентификатор шаблона устройства, связанного с устройством.
- `enrichments`какие расширения были настроены при экспорте;

Для концентраторов событий и служебной шины IoT Central экспортирует данные новых сообщений в концентратор событий или в очередь или раздел служебной шины практически в реальном времени.

Для хранилища BLOB-объектов сообщения помещаются в пакет и экспортируются один раз в минуту.

В следующем примере показано сообщение об изменении экспортированного свойства, полученное в хранилище BLOB-объектов Azure.

```json
{
    "applicationId": "1dffa667-9bee-4f16-b243-25ad4151475e",
    "messageSource": "properties",
    "messageType": "cloudPropertyChange",
    "deviceId": "18a985g1fta",
    "schema": "default@preview",
    "templateId": "urn:qugj6vbw5:___qbj_27r",
    "enqueuedTime": "2020-08-05T22:37:32.942Z",
    "properties": [{
        "fieldName": "MachineSerialNumber",
        "value": "abc"
    }],
    "enrichments": {
        "userSpecifiedKey" : "sampleValue"
    }
}
```

## <a name="comparison-of-legacy-data-export-and-new-data-export"></a>Сравнение экспорта устаревших данных и нового экспорта данных
Это таблица, в которой показаны различия между экспортом устаревших данных и новым экспортом данных. Сведения об экспорте устаревших данных можно получить [здесь](howto-export-data.md).

| Характеристики  | Экспорт устаревших данных | Новый экспорт данных |
| :------------- | :---------- | :----------- |
| Доступные типы данных | Данные телеметрии, устройства, шаблоны устройств | Данные телеметрии, изменения свойств |
| Фильтрация | None | Зависит от типа экспортируемых данных. Для телеметрии, фильтрации по телеметрии, свойствам сообщений, значениям свойств |
| Усовершенствования | None | Улучшение с помощью пользовательской строки или значения свойства на устройстве |
| Назначения | Концентраторы событий Azure, очереди и разделы служебной шины Azure, хранилище BLOB-объектов Azure | То же, что и для экспорта устаревших данных и веб-перехватчиков| 
| Поддерживаемые приложения | V2, V3 | Только версия 3 |
| Важные ограничения | 5 экспортов на приложение, 1 назначение на экспорт | 10 экспортов — подключений назначения на приложение | 

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали, как использовать новый экспорт данных, перейдите к следующему шагу:

> [!div class="nextstepaction"]
> [Использование аналитики в IoT Central](./howto-create-analytics.md)
