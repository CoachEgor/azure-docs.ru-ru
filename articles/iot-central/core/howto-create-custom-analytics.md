---
title: Расширьте Azure IoT Central с помощью пользовательской аналитики Документы Майкрософт
description: В качестве разработчика решений настроите приложение IoT Central для пользовательских аналитики и визуализации. Это решение использует Azure Databricks.
author: dominicbetts
ms.author: dobett
ms.date: 12/02/2019
ms.topic: how-to
ms.service: iot-central
services: iot-central
ms.custom: mvc
manager: philmea
ms.openlocfilehash: 7c2c14a937b4ef55d0e5f71e7b20214428ecd68c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80158203"
---
# <a name="extend-azure-iot-central-with-custom-analytics-using-azure-databricks"></a>Расширяйте Azure IoT Central с помощью пользовательской аналитики с помощью Azure Databricks

В этом руководстве, как разработчике решений, показано, как расширить приложение IoT Central с помощью пользовательской аналитики и визуализации. В этом примере используется рабочее пространство [Azure Databricks](https://docs.microsoft.com/azure/azure-databricks/) для анализа центрального телеметрического потока IoT и создания визуализаций, таких как [участки коробки.](https://wikipedia.org/wiki/Box_plot)

Это руководство показывает, как расширить IoT Central за то, что он уже может сделать со [встроенными инструментами аналитики.](./howto-create-custom-analytics.md)

В этом руководстве вы узнаете, как:

* Телеметрия потока из приложения IoT Central с использованием *непрерывного экспорта данных.*
* Создайте среду Azure Databricks для анализа и сюжетной телеметрии устройства.

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этом руководстве, вам потребуется активная подписка Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

### <a name="iot-central-application"></a>Приложение IoT Central

Создание центрального приложения IoT на веб-сайте [менеджера приложений Azure IoT](https://aka.ms/iotcentral) со следующими настройками:

| Параметр | Значение |
| ------- | ----- |
| Ценовой план | Standard |
| Шаблон приложения | Аналитика в магазине - мониторинг состояния |
| имя приложения; | Примите значение по умолчанию или выберите собственное имя |
| URL-адрес | Примите значение по умолчанию или выберите свой собственный уникальный префикс URL |
| Каталог | Ваш арендатор Active Directory Azure |
| Подписка Azure. | Ваша подписка Azure. |
| Регион | Ближайший регион |

Примеры и скриншоты в этой статье используют регион **Соединенных Штатов.** Выберите место рядом с вами и убедитесь, что вы создаете все свои ресурсы в одном регионе.

Этот шаблон приложения включает в себя два смоделированных термостата устройств, которые отправляют телеметрии.

### <a name="resource-group"></a>Группа ресурсов

Используйте [портал Azure для создания группы ресурсов](https://portal.azure.com/#create/Microsoft.ResourceGroup) под названием **IoTCentralAnalysis** для хранения других ресурсов, которые вы создаете. Создавайте ресурсы Azure в том же месте, что и приложение IoT Central.

### <a name="event-hubs-namespace"></a>пространство имен Центров событий;

Используйте [портал Azure для создания пространства имен событий концентраторов](https://portal.azure.com/#create/Microsoft.EventHub) со следующими настройками:

| Параметр | Значение |
| ------- | ----- |
| name    | Выберите имя в пространстве имен |
| Ценовая категория | Basic |
| Подписка | Ваша подписка |
| Группа ресурсов | IoTCentralAnalysis |
| Расположение | Восточная часть США |
| Единицы пропускной способности | 1 |

### <a name="azure-databricks-workspace"></a>Рабочее пространство Azure Databricks

Используйте [портал Azure для создания службы Данных Azure](https://portal.azure.com/#create/Microsoft.Databricks) со следующими настройками:

| Параметр | Значение |
| ------- | ----- |
| имя рабочей области.    | Выберите имя рабочего пространства |
| Подписка | Ваша подписка |
| Группа ресурсов | IoTCentralAnalysis |
| Расположение | Восточная часть США |
| Ценовая категория | Standard |

Когда вы создали необходимые ресурсы, ваша группа ресурсов **IoTCentralAnalysis** выглядит следующим скриншотом:

![Группа ресурсов Центрального анализа IoT](media/howto-create-custom-analytics/resource-group.png)

## <a name="create-an-event-hub"></a>Создание концентратора событий

Вы можете настроить приложение IoT Central для непрерывной экспорта телеметрии в концентратор событий. В этом разделе создается концентратор событий для получения телеметрии из приложения IoT Central. Концентратор событий обеспечивает телеметрию для обработки stream Analytics.

1. На портале Azure перейдите в пространство имен концентров событий и выберите **концентратор событий.**
1. Назовите свой центр событий **centralexport**и выберите **Создать**.
1. В списке концентраторов событий в вашем пространстве имен выберите **centralexport.** Затем выберите **политики общего доступа.**
1. Выберите **+ Добавить**. Создайте политику под названием **Слушайте** с утверждением **Listen.**
1. Когда политика будет готова, выберите его в списке, а затем скопируйте **основное значение строки соединения.**
1. Сделайте примечание этой строки соединения, вы используете ее позже, когда настраиваете свой блокнот Databricks для чтения из концентратора событий.

Пространство имен Event Hubs выглядит следующим скриншотом:

![пространство имен Центров событий;](media/howto-create-custom-analytics/event-hubs-namespace.png)

## <a name="configure-export-in-iot-central"></a>Настройка экспорта в IoT Central

На веб-сайте [менеджера приложений Azure IoT Central](https://aka.ms/iotcentral) перейдите к приложению IoT Central, созданному из шаблона Contoso. В этом разделе вы настраиваете приложение для потоковой передачи телеметрии с смоделированных устройств в концентратор событий. Для настройки экспорта:

1. Перейдите на страницу **экспорта данных,** выберите **новые,** а затем **концентраторы событий Azure.**
1. Используйте следующие настройки для настройки экспорта, а затем выберите **Сохранить:**

    | Параметр | Значение |
    | ------- | ----- |
    | Отображаемое имя | Экспорт в центры событий |
    | Активировано | С |
    | пространство имен Центров событий; | Имя пространства имен событий Концентраторы |
    | концентратор событий; | центральныйэкспорт |
    | Измерения | С |
    | Устройства | Выкл. |
    | Шаблоны устройств | Выкл. |

![Конфигурация экспорта данных](media/howto-create-custom-analytics/cde-configuration.png)

Подождите, пока статус экспорта **будет запущен,** прежде чем продолжить работу.

## <a name="configure-databricks-workspace"></a>Настройка рабочего пространства Databricks

На портале Azure перейдите на службу Azure Databricks и выберите **рабочее пространство запуска.** Новая вкладка открывается в вашем браузере и подписывает вас в ваше рабочее пространство.

### <a name="create-a-cluster"></a>Создание кластера

На странице **Azure Databricks** под списком общих задач выберите **новый кластер.**

Используйте информацию в следующей таблице для создания кластера:

| Параметр | Значение |
| ------- | ----- |
| Имя кластера, | центральный анализ |
| Режим кластера | Standard |
| Версия для выполнения Databricks | 5.5 LTS (Scala 2.11, Spark 2.4.3) |
| Версия Python | 3 |
| Включение автомасштабирования | нет |
| Прекратить после нескольких минут бездействия | 30 |
| Тип работника | Standard_DS3_v2 |
| Рабочие роли | 1 |
| Тип водителя | То же, что и работник |

Создание кластера может занять несколько минут, подождите, пока создание кластера завершится, прежде чем продолжить.

### <a name="install-libraries"></a>Установка библиотек

На странице **кластеров** подождите, пока будет **запущено**состояние кластера.

Следующие шаги показывают, как импортировать библиотеку, необходимую вашему образцу, в кластер:

1. На странице **Кластеров** подождите, пока не будет **запущено**состояние интерактивного кластера **centralanalysis.**

1. Выберите кластер, а затем выберите вкладку **Библиотеки.**

1. На вкладке **Библиотеки** выберите **Установить новый**.

1. На странице **«Установить библиотеку»** выберите **Maven** в качестве источника библиотеки.

1. В текстовом ящике **Координаты** введите следующее значение:`com.microsoft.azure:azure-eventhubs-spark_2.11:2.3.10`

1. Выберите **Установить** для установки библиотеки на кластере.

1. Статус библиотеки теперь **установлен:**

    ![Библиотека установлена](media/howto-create-custom-analytics/cluster-libraries.png)

### <a name="import-a-databricks-notebook"></a>Импорт ноутбука Databricks

Используйте следующие шаги для импорта ноутбука Databricks, содержащего код Python, для анализа и визуализации центральной телеметрии IoT:

1. Перейдите на страницу **Рабочего пространства** в среде Databricks. Выберите выпадение рядом с именем учетной записи, а затем выберите **Импорт.**

1. Выберите импорт из URL-адреса и введите следующий адрес:[https://github.com/Azure-Samples/iot-central-docs-samples/blob/master/databricks/IoT%20Central%20Analysis.dbc?raw=true](https://github.com/Azure-Samples/iot-central-docs-samples/blob/master/databricks/IoT%20Central%20Analysis.dbc?raw=true)

1. Чтобы импортировать блокнот, выберите **Импорт**.

1. Выберите **рабочее пространство** для просмотра импортируемого ноутбука:

    ![Импортный ноутбук](media/howto-create-custom-analytics/import-notebook.png)

1. Отспособите код в первой ячейке Python, чтобы добавить строку соединения Концентраторов событий, сохраненную ранее:

    ```python
    from pyspark.sql.functions import *
    from pyspark.sql.types import *

    ###### Event Hub Connection strings ######
    telementryEventHubConfig = {
      'eventhubs.connectionString' : '{your Event Hubs connection string}'
    }
    ```

## <a name="run-analysis"></a>Выполнить анализ

Для выполнения анализа необходимо прикрепить блокнот к кластеру:

1. Выберите **отдельный,** а затем выберите **кластер центрального анализа.**
1. Если кластер не работает, запустите его.
1. Чтобы запустить ноутбук, выберите кнопку запуска.

Вы можете увидеть ошибку в последней ячейке. Если это так, проверьте предыдущие ячейки работают, подождите минуту для некоторых данных, которые будут записаны на хранение, а затем запустить последнюю ячейку снова.

### <a name="view-smoothed-data"></a>Просмотр сглаженных данных

В блокноте прокрутите вниз до ячейки 14, чтобы увидеть участок скользящей средней влажности по типу устройства. Этот участок постоянно обновляется по мере поступления потоковой телеметрии:

![Гладкий участок телеметрии](media/howto-create-custom-analytics/telemetry-plot.png)

Вы можете изменить размер диаграммы в блокноте.

### <a name="view-box-plots"></a>Просмотр участков коробки

В блокноте, прокрутите вниз, чтобы ячейка 20, чтобы увидеть [участки коробки](https://en.wikipedia.org/wiki/Box_plot). Участки коробки основаны на статических данных, поэтому для их обновления необходимо повторно запустить ячейку:

![Участки коробки](media/howto-create-custom-analytics/box-plots.png)

Вы можете изменить размер участков в блокноте.

## <a name="tidy-up"></a>Удаление ненужных элементов

Чтобы увести порядок после этого способ и избежать ненужных расходов, удалите группу ресурсов **IoTCentralAnalysis** на портале Azure.

Вы можете удалить центральное приложение IoT со страницы **управления** в приложении.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали следующее:

* Телеметрия потока из приложения IoT Central с использованием *непрерывного экспорта данных.*
* Создайте среду Azure Databricks для анализа и прокладки телеметрических данных.

Теперь, когда вы знаете, как создать пользовательскую аналитику, следующий шаг должен узнать, как [управлять приложением.](howto-administer.md)
