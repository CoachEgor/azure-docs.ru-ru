---
title: Экспорт данных в Центры событий Azure и Служебную шину Azure | Документация Майкрософт
description: Как экспортировать данные из приложения Azure IoT Central в Центры событий Azure и Служебную шину Azure
services: iot-central
author: viv-liu
ms.author: viviali
ms.date: 03/20/2019
ms.topic: conceptual
ms.service: iot-central
manager: peterpr
ms.openlocfilehash: 78edeb0c418f5c426771d241464d389f8a632e96
ms.sourcegitcommit: e6d53649bfb37d01335b6bcfb9de88ac50af23bd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/09/2019
ms.locfileid: "65464012"
---
# <a name="export-your-data-in-azure-iot-central"></a>Экспорт данных в Azure IoT Central

*Эта статья предназначена для администраторов.*

В этой статье описывается, как использовать функцию экспорта непрерывных данных в Azure IoT Central для экспорта данных в собственном **концентраторов событий**, и **служебной шины Azure** экземпляров. Можно экспортировать данные **измерений**, **устройств** и **шаблонов устройств** в собственные места назначения для анализа и получения когнитивных аналитических сведений по теплому пути. В рамках этой функции также можно активировать настраиваемые правила в Azure Stream Analytics, настраиваемые рабочие процессы в Azure Logic Apps и преобразовывать данные и передавать их через Функции Azure. 

> [!Note]
> После включения непрерывного экспорта данных вы получаете только данные, поступающие с момента включения. Сейчас невозможно получить данные за то время, когда непрерывный экспорт данных был отключен. Чтобы сохранить больше исторических данных, включите экспорт непрерывных данных раньше.


## <a name="prerequisites"></a>Технические условия

- Вы должны быть администратором в своем приложении IoT Central.

## <a name="set-up-export-destination"></a>Настройка места назначения экспорта

Если у вас нет существующего шины/служба концентраторов событий для экспорта, выполните следующие действия:

## <a name="create-event-hubs-namespace"></a>Создание пространства имен Центров событий

1. Создайте [пространство имен Центров событий на портале Azure](https://ms.portal.azure.com/#create/Microsoft.EventHub). Дополнительные сведения см. в [документации по Центрам событий Azure](https://docs.microsoft.com/azure/event-hubs/event-hubs-create).
2. Выберите подписку. 

    > [!Note] 
    > Теперь вы можете экспортировать данные в другие подписки, которые **отличаются** от подписки приложения IoT Central с оплатой по мере использования. В этом случае вы подключаетесь с использованием строки подключения.
3. Создайте концентратор событий в пространстве имен в Центрах событий. Перейдите к пространству имен и выберите **+ Концентратор событий** в верхней части, чтобы создать экземпляр концентратора событий.

## <a name="create-service-bus-namespace"></a>Создание пространства имен Служебной шины

1. Создайте [пространство имен Служебной шины на портале Azure](https://ms.portal.azure.com/#create/Microsoft.ServiceBus.1.0.5). Дополнительные сведения см. в [документации по Служебной шине Azure](https://docs.microsoft.com/azure/service-bus-messaging/service-bus-create-namespace-portal).
2. Выберите подписку. 

    > [!Note] 
    > Теперь вы можете экспортировать данные в другие подписки, которые **отличаются** от подписки приложения IoT Central с оплатой по мере использования. В этом случае вы подключаетесь с использованием строки подключения.

3. Перейдите к пространству имен Служебной шины и выберите **+ Очередь** или **+ Раздел** в верхней части, чтобы создать очередь или раздел для экспорта.


## <a name="set-up-continuous-data-export"></a>Настройка экспорта непрерывных данных

Теперь, когда назначения шины/служба концентраторов событий для экспорта данных, выполните следующие действия, чтобы настроить непрерывный Экспорт данных. 

1. Войдите в приложение IoT Central.

2. В меню слева выберите **непрерывного экспорта данных**.

    > [!Note]
    > Если вы не видите этого пункта в меню слева, вы не являетесь администратором в приложении. Обратитесь к администратору, чтобы настроить экспорт данных.

    ![Создание нового концентратора событий для непрерывного экспорта данных](media/howto-export-data/export_menu1.png)

3. Выберите **+ создать** кнопки в правом верхнем углу. Выберите один из **концентраторов событий** или **служебной шины Azure** качестве пункта назначения для экспорта. 

    > [!NOTE] 
    > Максимальное число экспортов на каждое приложение равно пяти. 

    ![Создание непрерывного экспорта данных](media/howto-export-data/export_new1.png)

4. В раскрывающемся списке выберите ваш **пространства имен шины службы или пространство имен концентраторов событий**. Вы также можете выбрать последний вариант в списке — **Enter a connection string** (Ввести строку подключения). 

    > [!NOTE] 
    > Вы увидите учетные записи хранения, пространства имен Центров событий или пространства имен Служебной шины, которые доступны **в той же подписке, что и ваше приложение IoT Central**. Если вы хотите выполнить экспорт за пределы этой подписки, выберите **Enter a connection string** (Ввести строку подключения) и перейдите к шагу 5.

    > [!NOTE] 
    > Для приложений с 7-дневной бесплатной пробной версией единственным способом настроить непрерывный экспорт данных — использовать строку подключения. Это обусловлено тем, что приложения с 7-дневной бесплатной пробной версией не связаны с подпиской Azure.

    ![Создание нового концентратора событий для непрерывного экспорта данных](media/howto-export-data/export_create1.png)

5. (Необязательно.) Если вы выбрали **Enter a connection string** (Ввести строку подключения), открывается новое окно, в которое нужно вставить строку подключения. Чтобы получить строку подключения, сделайте следующее:
    - Концентраторы событий или служебной шины, перейдите к пространству имен на портале Azure.
        - В разделе **параметры**выберите **политики общего доступа**
        - Выберите значение по умолчанию **RootManageSharedAccessKey** или создайте политику.
        - Скопируйте основную или дополнительную строку подключения.
 
6. Выберите из раскрывающегося списка в очередь концентратора событий или раздел.

7. В разделе **Data to export** (Данные для экспорта) укажите каждый тип данных для экспорта, задав для типа значение **Включено**.

6. Чтобы включить непрерывный экспорт данных, убедитесь, что для параметра **Экспорт данных** установлено значение **Включено**. Щелкните **Сохранить**.

    ![Настройка экспорта непрерывных данных](media/howto-export-data/export_list1.png)

7. Через несколько минут ваши данные будут отображаться в выбранном назначении.


## <a name="export-to-azure-event-hubs-and-azure-service-bus"></a>Экспорт данных в Центры событий Azure и Служебную шину Azure

Данные измерений, устройств и шаблонов устройств экспортируются в концентратор событий либо в очередь или раздел Служебной шины почти в реальном времени. Экспортированные данные измерений содержат полные сообщения, которые ваши устройства отправили в IoT Central, а не только сами значения измерений. Экспортированные данные устройств содержат изменения свойств и параметров всех устройств, а экспортированные шаблоны устройств содержат изменения для всех шаблонов устройств. Экспортированные данные находятся в формате JSON в свойстве body.

> [!NOTE]
> При выборе Служебной шины Azure как назначения экспорта для очередей и разделов **не должна быть включена функция обнаружения повторяющихся данных или сеансов**. Если любая из этих функций включена, некоторые сообщения не будут поступать в очередь или раздел.

### <a name="measurements"></a>Измерения

Новое сообщение экспортируется сразу после того, как IoT Central получает сообщения с устройства. Каждое сообщение, экспортированное в Центры событий Azure и Служебную шину Azure, содержит полное сообщение, отправленное устройством, в свойстве body в формате JSON. 

> [!NOTE]
> Устройства, отправляющие измерения, представлены идентификаторами устройств (см. следующие разделы). Чтобы получить имена устройств, экспортируйте данные устройств и сопоставьте каждое сообщение на основе **connectionDeviceId**, соответствующего свойству **deviceId** в сообщении устройства.

В следующем примере показано сообщение с данными измерений, полученное в концентраторе событий либо в очереди или разделе служебной шины.

```json
{
  "body": {
    "humidity": 29.06963648666288,
    "temp": 8.4503795661685,
    "pressure": 1075.8334910110093,
    "magnetometerX": 408.6966458887116,
    "magnetometerY": -532.8809796603962,
    "magnetometerZ": 174.70653875528205,
    "accelerometerX": 1481.546749013788,
    "accelerometerY": -1139.4316656437406,
    "accelerometerZ": 811.6928695575307,
    "gyroscopeX": 442.19879163299856,
    "gyroscopeY": 123.23710975717177,
    "gyroscopeZ": 708.5397575786151,
    "deviceState": "DANGER"
  },
  "annotations": {
    "iothub-connection-device-id": "<connectionDeviceId>",
    "iothub-connection-auth-method": "{\"scope\":\"hub\",\"type\":\"sas\",\"issuer\":\"iothub\",\"acceptingIpFilterRule\":null}",
    "iothub-connection-auth-generation-id": "<generationId>",
    "iothub-enqueuedtime": 1539381029965,
    "iothub-message-source": "Telemetry",
    "x-opt-sequence-number": 25325,
    "x-opt-offset": "<offset>",
    "x-opt-enqueued-time": 1539381030200
  },
  "sequenceNumber": 25325,
  "enqueuedTimeUtc": "2018-10-12T21:50:30.200Z",
  "offset": "<offset>",
  "properties": {
    "content_type": "application/json",
    "content_encoding": "utf-8"
  }
}
```

### <a name="devices"></a>Устройства

Сообщения, содержащие данные устройств, отправляются в концентратор событий либо очередь или раздел служебной шины каждые несколько минут. Это означает, что каждые несколько минут поступают пакеты сообщений с данными о:
- новых устройствах, которые были добавлены;
- устройствах с измененными свойствами и параметрами.

Каждое сообщение уведомляет об одном или нескольких изменениях устройства с момента последнего экспортированного сообщения. Данные, которые будут переданы в каждом сообщении:
- идентификатор (`id`) устройства в IoT Central;
- имя (`name`) устройства;
- идентификатор устройства (`deviceId`) из [Службы подготовки устройств](https://aka.ms/iotcentraldocsdps);
- сведения о шаблоне устройства;
- Значения свойств
- значения параметров.

> [!NOTE]
> Устройства, удаленные с момента создания последнего пакета сообщений, не экспортируются. В настоящее время в сообщениях экспорта нет никаких индикаторов касательно удаленных устройств.
>
> Шаблон устройства, к которому принадлежит каждое устройство, представлен идентификатором шаблона устройства. Чтобы получить имя шаблона устройства, обязательно экспортируйте и данные шаблона устройства.

В следующем примере показано сообщение с данными устройства в концентраторе событий, очереди или разделе служебной шины:


```json
{
  "body": {
    "id": "<id>",
    "name": "<deviceName>",
    "simulated": true,
    "deviceId": "<deviceId>",
    "deviceTemplate": {
      "id": "<templateId>",
      "version": "1.0.0"
    },
    "properties": {
      "cloud": {
        "location": "Seattle"
      },
      "device": {
        "dieNumber": 5445.5862873026645
      }
    },
    "settings": {
      "device": {
        "fanSpeed": 0
      }
    }
  },
  "annotations": {
    "iotcentral-message-source": "devices",
    "x-opt-partition-key": "<partitionKey>",
    "x-opt-sequence-number": 39740,
    "x-opt-offset": "<offset>",
    "x-opt-enqueued-time": 1539274959654
  },
  "partitionKey": "<partitionKey>",
  "sequenceNumber": 39740,
  "enqueuedTimeUtc": "2018-10-11T16:22:39.654Z",
  "offset": "<offset>",
}
```

### <a name="device-templates"></a>Шаблоны устройств

Сообщения, содержащие данные шаблонов устройств, отправляются в концентратор событий, очередь или раздел служебной шины каждые несколько минут. Это означает, что каждые несколько минут поступают пакеты сообщений с данными о:
- новых шаблонах устройств, которые были добавлены;
- шаблонах устройств с измененными измерениями, свойствами и параметрами.

Каждое сообщение уведомляет об одном или нескольких изменениях шаблона устройства с момента последнего экспортированного сообщения. Данные, которые будут переданы в каждом сообщении:
- версию (`id`) шаблона устройства;
- имя (`name`) шаблона устройства;
- версию (`version`) шаблона устройства;
- типы данных измерения, минимальные и максимальные значения;
- типы данных свойств и значения по умолчанию;
- типы данных параметров и значения по умолчанию.

> [!NOTE]
> Шаблоны устройств, удаленные с момента создания последнего пакета сообщений, не экспортируются. В настоящее время в сообщениях экспорта нет никаких индикаторов касательно удаленных шаблонов устройств.

В следующем примере показано сообщение с данными шаблонов устройств в концентраторе событий, очереди или разделе служебной шины:

```json
{
  "body": {
    "id": "<id>",
    "version": "1.0.0",
    "name": "<templateName>",
    "measurements": {
      "telemetry": {
        "humidity": {
          "dataType": "double",
          "name": "humidity"
        },
        "pressure": {
          "dataType": "double",
          "name": "pressure"
        },
        "temp": {
          "dataType": "double",
          "name": "temperature"
        }
      }
    },
    "properties": {
      "cloud": {
        "location": {
          "dataType": "string",
          "name": "Location"
        }
      },
      "device": {
        "dieNumber": {
          "dataType": "double",
          "name": "Die Number"
        }
      }
    },
    "settings": {
      "device": {
        "fanSpeed": {
          "dataType": "double",
          "name": "Fan Speed",
          "initialValue": 0
        }
      }
    }
  },
  "annotations": {
    "iotcentral-message-source": "deviceTemplates",
    "x-opt-partition-key": "<partitionKey>",
    "x-opt-sequence-number": 25315,
    "x-opt-offset": "<offset>",
    "x-opt-enqueued-time": 1539274985085
  },
  "partitionKey": "<partitionKey>",
  "sequenceNumber": 25315,
  "enqueuedTimeUtc": "2018-10-11T16:23:05.085Z",
  "offset": "<offset>",
}
```

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы знаете, как экспортировать данные в Центры событий Azure и Служебную шину Azure, переходите к следующему шагу:

> [!div class="nextstepaction"]
> [Активация Функций Azure с помощью веб-перехватчиков в Azure IoT Central](howto-trigger-azure-functions.md)
