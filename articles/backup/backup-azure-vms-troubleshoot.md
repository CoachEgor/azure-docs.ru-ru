---
title: Устранение неполадок при резервном копировании виртуальных машин Azure
description: Устранение неполадок при резервном копировании и восстановлении виртуальных машин Azure
services: backup
author: srinathv
manager: vijayts
ms.service: backup
ms.topic: conceptual
ms.date: 04/08/2019
ms.author: srinathv
ms.openlocfilehash: 6f10d8bc7f813245a66296988e4bb3792d898e08
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60550028"
---
# <a name="troubleshoot-azure-virtual-machine-backup"></a>Устранение неполадок при архивации виртуальных машин Azure
Для устранения неполадок, обнаруженных в ходе использования Azure Backup, можно использовать информацию в таблице, приведенной ниже.

## <a name="backup"></a>Azure Backup

### <a name="copyingvhdsfrombackupvaulttakinglongtime--copying-backed-up-data-from-vault-timed-out"></a>CopyingVHDsFromBackUpVaultTakingLongTime-копирование данных из резервных копий из хранилища, истекло время ожидания

Код ошибки: CopyingVHDsFromBackUpVaultTakingLongTime <br/>
Сообщение об ошибке: Копирование данных из резервных копий из хранилища, истекло время ожидания

Это может произойти из-за ошибки временного хранилища или учетной записи хранения недостаточно операций ввода-ВЫВОДА для службы резервного копирования для передачи данных в хранилище в течение периода ожидания. Настройка резервного копирования виртуальной Машины, используя эти [рекомендации](backup-azure-vms-introduction.md#best-practices) и повторите операцию архивации.

### <a name="usererrorvmnotindesirablestate---vm-is-not-in-a-state-that-allows-backups"></a>UserErrorVmNotInDesirableState - виртуальная машина находится не в состоянии, допускающем резервных копий.

Код ошибки: UserErrorVmNotInDesirableState <br/>
Сообщение об ошибке: Виртуальная машина не находится в состоянии, которое позволяет выполнить ее архивацию.<br/>

Операции резервного копирования не удалось, так как виртуальная машина находится в состоянии сбоя. Для успешного создания резервной копии виртуальной Машины состояние должно быть запущена, остановлена или остановлено (освобождено).

* Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования.
*  Если это виртуальная машина Linux, которая использует модуль ядра Security Enhanced Linux, то необходимо исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности, чтобы обеспечить установку расширения резервного копирования.

### <a name="usererrorfsfreezefailed---failed-to-freeze-one-or-more-mount-points-of-the-vm-to-take-a-file-system-consistent-snapshot"></a>UserErrorFsFreezeFailed - не удалось заморозить одну или несколько точек подключения виртуальной машины, чтобы создать согласованный моментальный снимок файловой системы

Код ошибки: UserErrorFsFreezeFailed <br/>
Сообщение об ошибке: Не удалось заморозить одну или несколько точек подключения виртуальной машины для создания моментального снимка, согласованного с файловой системой.

* Проверьте состояние системы файл всех подключенных устройствах с помощью **tune2fs** команды, например **tune2fs -l/dev/sdb1 \\** .\| grep **состоянием файловой системы**.
* Отключите устройства, для которых не был очищен состояние файловой системы, с помощью **umount** команды.
* Запустите проверку согласованности файла системы на этих устройствах с помощью **fsck** команды.
* Повторно подключите эти устройства и повторите операцию резервного копирования.</ol>

### <a name="extensionsnapshotfailedcom--extensioninstallationfailedcom--extensioninstallationfailedmdtc---extension-installationoperation-failed-due-to-a-com-error"></a>ExtensionSnapshotFailedCOM / ExtensionInstallationFailedCOM / ExtensionInstallationFailedMDTC - расширение установки/не удалось выполнить операцию из-за ошибки COM +

Код ошибки: ExtensionSnapshotFailedCOM <br/>
Сообщение об ошибке: Сбой операции создания моментального снимка из-за ошибки COM+

Код ошибки: ExtensionInstallationFailedCOM  <br/>
Сообщение об ошибке: Сбой операции установки расширения из-за ошибки COM +

Код ошибки: Ошибка ExtensionInstallationFailedMDTC сообщение об ошибке: Во время установки расширения произошла ошибка «Отсутствует связь COM+ с координатором распределенных транзакций».

Сбой операции резервного копирования из-за проблемы со службой Windows **система COM +** приложения.  Проблему можно устранить следующим способом.

* Повторите запуск или перезапуск службы Windows **системное приложение COM +** (из командной строки с повышенными правами **-net start COMSysApp**).
* Убедитесь, **координатора распределенных транзакций** запущены как службы **сетевой службы** учетной записи. Если это не так, измените его для запуска в качестве **сетевой службы** учетной записи и перезапустите **системное приложение COM +**.
* Если не удается перезапустить службу, переустановите **координатора распределенных транзакций** службу, выполнив следующие действия:
    * Остановите работу службы MSDTC.
    * Откройте окно командной строки (cmd).
    * Выполните команду «msdtc-удалить»
    * Команда отмены «msdtc-Установка»
    * Запустите службу MSDTC.
* Запустите службу Windows **Системное приложение COM+**. После запуска службы **Системное приложение COM+** активируйте задание резервного копирования на портале Azure.</ol>

### <a name="extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state"></a>ExtensionFailedVssWriterInBadState - операции моментального снимка, не удалось, так как модули записи VSS в неисправном состоянии

Код ошибки: ExtensionFailedVssWriterInBadState <br/>
Сообщение об ошибке: Сбой операции моментального снимка, так как модули записи VSS в неисправном состоянии.

Перезапустите модули записи VSS, которые находятся в неисправном состоянии. В командной строке с повышенными привилегиями выполните команду ```vssadmin list writers```. В выходных данных содержатся все модули записи VSS и их состояние. Перезапустите каждый модуль записи VSS, состояние которого отличается от **[1] Стабильный**, выполнив следующие команды из командной строки с повышенными привилегиями.

  * ```net stop serviceName```
  * ```net start serviceName```

### <a name="extensionconfigparsingfailure--failure-in-parsing-the-config-for-the-backup-extension"></a>ExtensionConfigParsingFailure - Сбой анализа конфигурации для расширения резервного копирования

Код ошибки: ExtensionConfigParsingFailure<br/>
Сообщение об ошибке: Сбой анализа конфигурации для расширения резервного копирования.

Эта ошибка возникает из-за изменения разрешений в каталоге **MachineKeys**: **%systemdrive%\programdata\microsoft\crypto\rsa\machinekeys**.
Выполните следующую команду и убедитесь, что разрешения на **MachineKeys** каталог, из них по умолчанию:**icacls %systemdrive%\programdata\microsoft\crypto\rsa\machinekeys**.

Разрешения по умолчанию:
* все: (R,W)
* BUILTIN\Administrators: (F)

Если для каталога **MachineKeys** назначены другие разрешения, выполните следующие действия, чтобы изменить разрешения, удалить сертификат и активировать архивацию.

1. Исправьте разрешения для каталога **MachineKeys**. С помощью свойств безопасности обозревателя и дополнительных параметров безопасности в каталоге сбросьте разрешения к значениям по умолчанию. Удалите дополнительные пользовательские объекты, отличные от объектов по умолчанию, из каталога и убедитесь, что у **всех** есть доступ к таким операциям:

    * – вывод списка папок, чтение данных;
    * – чтение атрибутов;
    * – чтение дополнительных атрибутов;
    * – создание файлов, запись данных;
    * – создание папок, добавление данных;
    * – запись атрибутов;
    * – запись дополнительных атрибутов;
    * – разрешения на чтение.
2. Удалите все сертификаты с полем **Получатель сертификата**, имеющим значение классической модели развертывания или **Windows Azure CRP Certificate Generator**.
    * [Практическое руководство. Просмотр сертификатов с помощью оснастки консоли MMC](https://msdn.microsoft.com/library/ms788967(v=vs.110).aspx).
    * В разделе **Личное** > **Сертификаты** удалите все сертификаты с полем **Получатель сертификата**, имеющим значение **Windows Azure CRP Certificate Generator**.
3. Активируйте задание архивации виртуальной машины.

### <a name="extensionstuckindeletionstate---extension-state-is-not-supportive-to-backup-operation"></a>ExtensionStuckInDeletionState - состояние расширения не поддерживает архивацию

Код ошибки: ExtensionStuckInDeletionState <br/>
Сообщение об ошибке: Состояние расширения не поддерживает архивацию

Сбой операции резервного копирования из-за несогласованности состояния модуля резервного копирования. Проблему можно устранить следующим способом.

* Убедитесь, что гостевой агент установлен и отвечает на запросы.
* На портале Azure последовательно выберите **Виртуальная машина** > **Все параметры** > **Расширения**.
* Выберите расширение резервного копирования VmSnapshot или VmSnapshotLinux и щелкните **Удалить**.
* После удаления расширения попробуйте снова выполнить резервное копирование.
* При выполнении последующей операции резервного копирования будет установлено новое расширение в требуемом состоянии.

### <a name="extensionfailedsnapshotlimitreachederror---snapshot-operation-failed-as-snapshot-limit-is-exceeded-for-some-of-the-disks-attached"></a>Превышено ExtensionFailedSnapshotLimitReachedError - предельного числа снимков сбой операции моментального снимка для некоторых подключенных дисков

Код ошибки: ExtensionFailedSnapshotLimitReachedError  <br/>
Сообщение об ошибке: Для некоторых подключенных дисков превышения предельного числа снимков сбой операции моментального снимка

Превышен моментального снимка завершается сбоем предельного числа снимков для некоторых подключенных дисков. Завершить по устранению неполадок, действия и повторите операцию.

* Удалите диск больших двоичных объектов снимков, которые не требуются. Будьте внимательны, чтобы не удалить BLOB-объектов диска, должно быть удалено только моментальных снимков больших двоичных объектов.
* Если на диске виртуальной Машины учетные записи хранения включено обратимое удаление, Настройка обратимого удаления хранения, таким образом, что существующие моментальные снимки, меньше, чем максимально допустимую в любой момент времени.
* Если в резервной копии виртуальной Машины включена Azure Site Recovery, затем выполните ниже:

    * Убедитесь, значения **isanysnapshotfailed** имеет значение false в /etc/azure/vmbackup.conf
    * Запланируйте Azure Site Recovery в другое время, таким образом, чтобы оно не конфликтовало операции резервного копирования.

### <a name="extensionfailedtimeoutvmnetworkunresponsive---snapshot-operation-failed-due-to-inadequate-vm-resources"></a>ExtensionFailedTimeoutVMNetworkUnresponsive - моментальных снимков не удалось из-за недостатка ресурсов виртуальной Машины.

Код ошибки: ExtensionFailedTimeoutVMNetworkUnresponsive<br/>
Сообщение об ошибке: Сбой операции моментального снимка из-за недостатка ресурсов виртуальной Машины.

Операции резервного копирования на виртуальной Машине не удалось из-за задержка в сетевых вызовах при выполнении операции моментального снимка. Чтобы устранить эту проблему, выполните шаг 1. Если проблема повторится, попробуйте выполнить шаги 2 и 3.

**Шаг 1**. Создание моментального снимка через узел

В командной строке с повышенными правами (администратора) выполните следующую команду:

```
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v SnapshotMethod /t REG_SZ /d firstHostThenGuest /f
REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys" /v CalculateSnapshotTimeFromHost /t REG_SZ /d True /f
```

Это позволит обеспечить создание моментальных снимков через ОС узла, а не гостевую ОС. Повторите резервное копирование.

**Шаг 2**. Попробуйте изменить расписание резервного копирования во время, когда виртуальная машина находится в разделе меньшую нагрузку (ЦП и операций ввода-вывода меньше др.)

**Шаг 3**. Попробуйте [увеличение размера виртуальной Машины](https://azure.microsoft.com/blog/resize-virtual-machines/) и повторите операцию

### <a name="common-vm-backup-errors"></a>Распространенные ошибки резервного копирования виртуальной Машины

| Сведения об ошибке | Возможное решение |
| ------ | --- |
| Код ошибки: 320001<br/> Сообщение об ошибке: Не удалось выполнить операцию, так как виртуальная машина больше не существует. <br/> <br/> Код ошибки: 400094 <br/> Сообщение об ошибке: Виртуальная машина не существует <br/> <br/>  Виртуальная машина Azure не найдена.  |Эта ошибка возникает, когда основная виртуальная машина удалена, но политика резервного копирования продолжает ее поиск, чтобы выполнить резервное копирование. Чтобы исправить эту ошибку, выполните следующие действия. <ol><li> Повторно создайте виртуальную машину с тем же именем и тем же именем группы ресурсов **имя облачной службы**,<br>**or** (или).</li><li> Отключите защиту виртуальной машины, удаляя или не удаляя данные резервного копирования. Дополнительные сведения см. в разделе [Отключение защиты виртуальных машин](backup-azure-manage-vms.md#stop-protecting-a-vm).</li></ol>|
| Виртуальная машина находится в состоянии сбоя подготовки. <br>Перезапустите виртуальную машину и убедитесь, что она находится в запущенном или остановленном состоянии. | Эта ошибка возникает, когда неполадка расширения приводит к тому, что виртуальная машина переходит в состояние сбоя подготовки. Перейдите к списку расширений и проверьте, нет ли сбоев в работе расширений. Удалите соответствующее расширение и попробуйте перезапустить виртуальную машину. Если все расширения находятся в рабочем состоянии, проверьте, запущена ли служба агента виртуальной машины. Если нет, то перезапустите службу агента виртуальной машины. |
|Код ошибки: UserErrorBCMPremiumStorageQuotaError<br/> Сообщение об ошибке: Не удалось скопировать снимок виртуальной машины, из-за нехватки свободного места в учетной записи хранения | Для резервного копирования виртуальных машин уровня "Премиум" в стеке резервных копий виртуальных машин версии 1 мы копируем моментальный снимок в учетную запись хранения. Это гарантирует, что трафик управления резервным копированием, который возникает при работе с моментальным снимком, не ограничивает число операций ввода-вывода, доступных для приложения, использующего диски уровня "Премиум". <br><br>Корпорация Майкрософт рекомендует выделять только 50 %, 17,5 ТБ, от общего объема хранилища учетной записи хранения. Затем служба Azure Backup может скопировать моментальный снимок в учетную запись хранения и перенести данные из этого скопированного расположения в учетной записи хранения в хранилище. |
| Не удалось установить расширение служб восстановления Майкрософт, так как виртуальная машина не запущена <br>Необходимым условием для расширения служб восстановления Azure является наличие агента виртуальной машины. Установите агент виртуальной машины Azure и перезапустите операцию регистрации. |<ol> <li>Убедитесь, что агент виртуальной машины установлен правильно. <li>Убедитесь, что флажок в конфигурации виртуальной машины установлен на правильное значение.</ol> Ознакомьтесь со сведениями об установке агента виртуальной машины и проверке правильности ее выполнения. |
| Сбой операции создания снимка службы теневого копирования томов (VSS) **Этот диск заблокирован программой шифрования диска BitLocker. Вернитесь к панели управления, чтобы разблокировать диск.** |Отключите BitLocker для всех дисков на виртуальной машине и проверьте, устранена ли проблема с VSS. |
| Виртуальная машина не находится в состоянии, которое позволяет выполнить резервное копирование. |<ul><li>Если виртуальная машина находится в состоянии перехода из **рабочего** в состояние **завершения работы**, дождитесь изменения состояния. Затем запустите задание резервного копирования. <li> Если это виртуальная машина Linux, которая использует модуль ядра Security Enhanced Linux, то необходимо исключить путь агента Linux для Azure **/var/lib/waagent** из политики безопасности, чтобы обеспечить установку расширения резервного копирования.  |
| На виртуальной машине отсутствует агент виртуальной машины. <br>Установите необходимые компоненты и агент виртуальной машины. Затем перезапустите операцию. |Дополнительные сведения об [установке агента виртуальной машины и проверке установки агента виртуальной машины](#vm-agent). |
| При резервном копировании не удалось закрепить одну или несколько точек подключения виртуальной машины для создания моментального снимка, согласованного с файловой системой. | Выполните следующие действия. <ul><li>Проверьте состояние файловой системы на всех подключенных устройствах с помощью команды **tune2fs**. Например, **tune2fs -l/dev/sdb1 \\** .\| grep **состоянием файловой системы**. <li>Отключите устройства с некорректным состоянием файловой системы с помощью команды **umount**. <li> Проверьте целостность файловой системы на этих устройствах с помощью команды **fsck**. <li> Повторно подключите эти устройства и повторите попытку архивации.</ol> |
| Сбой операции создания моментального снимка из-за ошибки при создании защищенного канала связи. | <ol><li> Откройте редактор реестра, запустив файл **regedit.exe** в режиме с повышенными правами. <li> Определите все версии платформы .NET Framework, установленные в системе. Они находятся в иерархии раздела реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft**. <li> Для каждой платформы .NET Framework в этом разделе реестра добавьте следующий раздел: <br> **SchUseStrongCrypto"=dword:00000001**. </ol>|
| Сбой операции создания моментального снимка из-за ошибки при установке распространяемого компонента Visual C++ для Visual Studio 2012. | Перейдите в папку C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\agentVersion и установите компонент vcredist2012_x64.<br/>Убедитесь, что значение раздела реестра, который допускает установку службы задано правильное значение. Это значит, значение **запустить** значение в **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Msiserver** для **3** и не **4**. <br><br>Если проблемы с установкой не исчезли, перезапустите службу установки, последовательно выполнив команды **MSIEXEC /UNREGISTER** и **MSIEXEC /REGISTER** в командной строке с повышенными привилегиями.  |


## <a name="jobs"></a>Задания

| Сведения об ошибке | Возможное решение |
| --- | --- |
| Отмена не поддерживается в этом типе задания. <br>Дождитесь завершения задания. |Нет |
| Задание не находится в состоянии отмены. <br>Дождитесь завершения задания. <br>**or** (или).<br> Выбранное задание не находится в состоянии отмены. <br>Дождитесь остановки задания. |Скорее всего, задание почти выполнено. Дождитесь завершения задания.|
| Резервное копирование не может отменить задание, так как оно не выполняется. <br>Отмена поддерживается только для выполняющихся заданий. Попытайтесь отменить выполняющееся задание. |Эта ошибка возникает из-за переходного состояния. Подождите минуту и повторите отмену. |
| При резервном копировании не удалось отменить задание. <br>Дождитесь завершения задания. |Нет |

## <a name="restore"></a>восстановление;

| Сведения об ошибке | Возможное решение |
| --- | --- |
| Сбой восстановления из-за внутренней ошибки облака. |<ol><li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроены параметры DNS. Проверьте параметр <br>**$deployment = Get-AzureDeployment -ServiceName "ServiceName" -Slot "Production"     Get-AzureDns -DnsSettings $deployment.DnsSettings**.<br>Если настроен **адрес**, это означает, что настроены и параметры DNS.<br> <li>В облачной службе, в которую вы пытаетесь выполнить восстановление, настроен параметр **ReservedIP**, а существующие в ней виртуальные машины находятся в остановленном состоянии. Вы можете проверить, что облачная служба зарезервировала IP-адрес, используя следующие командлеты PowerShell: **$deploy = Get-AzureDeployment -ServiceName "servicename" -Slot "Production" $dep.ReservedIPName**. <br><li>Вы пытаетесь восстановить виртуальную машину в ту же облачную службу со следующими специальными конфигурациями сети: <ul><li>– виртуальные машины во внутренней и внешней конфигурации балансировщика нагрузки;<li>– виртуальные машины с несколькими зарезервированными IP-адресами; <li>– виртуальные машины с несколькими сетевыми адаптерами. </ul><li>Выберите новую облачную службу в пользовательском интерфейсе или просмотрите [рекомендации по восстановлению](backup-azure-arm-restore-vms.md#restore-vms-with-special-configurations) для виртуальных машин со специальными конфигурациями сети.</ol> |
| Выбранное DNS-имя уже занято. <br>Укажите другое DNS-имя и повторите попытку. |Указанное здесь DNS-имя ссылается на имя облачной службы обычно с расширением **.cloudapp.net**. Это имя должно быть уникальным. Если возникает эта ошибка, во время восстановления необходимо выбрать другое имя виртуальной машины. <br><br>  Эта ошибка отображается только для пользователей портала Azure. Восстановление с помощью PowerShell выполняется успешно, так как восстанавливаются только диски, а виртуальная машина не создается. Ошибка возникнет, если вы явно создадите виртуальную машину после восстановления дисков. |
| Указана неправильная конфигурация виртуальной сети. <br>Укажите другую конфигурацию виртуальной сети и повторите попытку. |Нет |
| Указанная облачная служба использует зарезервированный IP-адрес, который не соответствует конфигурации восстанавливаемой виртуальной машины. <br>Укажите другую облачную службу, которая не использует зарезервированный IP-адрес. Или выберите другую точку восстановления. |Нет |
| Облачная служба достигла ограничения на количество входных конечных точек. <br>Повторите операцию, указав другую облачную службу или используя существующую конечную точку. |Нет |
| Хранилище Служб восстановления и целевая учетная запись хранения находятся в двух разных регионах. <br>Убедитесь, что указанная в операции восстановления учетная запись хранения находится в том же регионе Azure, что и хранилище Служб восстановления. |Нет |
| Учетная запись хранения, указанная для операции восстановления, не поддерживается. <br>Поддерживаются только базовые или стандартные учетные записи хранения с локально избыточными или геоизбыточными параметрами репликации. Выберите поддерживаемую учетную запись хранения. |Нет |
| Тип учетной записи хранения, указанной для операции восстановления, не подключен к сети. <br>Убедитесь, что учетная записи хранения, указанная в операции восстановления, подключена к сети. |Эта ошибка может возникать из-за временной ошибки в службе хранилища Azure или из-за сбоя. Выберите другую учетную запись хранения. |
| Достигнут предел квоты группы ресурсов. <br>Удалите некоторые группы ресурсов с портала Azure или обратитесь в службу поддержки Azure, чтобы увеличить границы. |Нет |
| Выбранная подсеть не существует. <br>Выберите подсеть для проверки. |Нет |
| У службы Backup нет разрешения на доступ к ресурсам в вашей подписке. |Чтобы устранить эту ошибку, сначала восстановите диски, выполнив шаги, описанные в разделе [Восстановление резервных копий дисков](backup-azure-arm-restore-vms.md#restore-disks). Затем выполните команды PowerShell, описанные в разделе [Создание виртуальной машины с восстановленного диска](backup-azure-vms-automation.md#restore-an-azure-vm). |

## <a name="backup-or-restore-takes-time"></a>Резервное копирование или восстановление занимает время
Если резервное копирование у вас выполняется дольше 12 часов или на восстановление данных требуется больше 6 часов, ознакомьтесь с [лучшими методиками](backup-azure-vms-introduction.md#best-practices) и [рекомендациями по производительности](backup-azure-vms-introduction.md#backup-performance).

## <a name="vm-agent"></a>Агент виртуальной машины
### <a name="set-up-the-vm-agent"></a>Настройка агента виртуальной машины
Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Но на виртуальных машинах, которые переносятся из локальных центров обработки данных, агента виртуальной машины не будет. Для таких виртуальных машин агент ВМ необходимо установить явным образом.

#### <a name="windows-vms"></a>Виртуальные машины Windows

* Скачайте и установите [MSI-файл агента](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
* Для виртуальных машин, созданных с использованием классической модели развертывания, [обновите свойство классических виртуальных машин](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы указать, что агент установлен. Этот шаг является необязательным для виртуальных машин Azure Resource Manager.

#### <a name="linux-vms"></a>Виртуальные машины Linux

* Установите последнюю версию агента из репозитория дистрибутива. Сведения об имени пакета см. в [репозитории агента Linux](https://github.com/Azure/WALinuxAgent).
* Для виртуальных машин, созданных с использованием классической модели развертывания, [используйте этот блог](https://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx), чтобы обновить свойство виртуальных машин и указать, что агент установлен. Этот шаг не является обязательным для виртуальных машин Resource Manager.

### <a name="update-the-vm-agent"></a>Обновление агента виртуальной машины
#### <a name="windows-vms"></a>Виртуальные машины Windows

* Чтобы обновить агент виртуальной машины, переустановите [его двоичные файлы](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Прежде чем обновлять агент, убедитесь, что не выполняются никакие операции резервного копирования.

#### <a name="linux-vms"></a>Виртуальные машины Linux

* Чтобы обновить агент виртуальной машины Linux, следуйте инструкциям в статье [Как обновить агент Azure Linux на виртуальной машине](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

    > [!NOTE]
    > Рекомендуется обновлять агент только через репозиторий дистрибутива.

    Не рекомендуется скачивать код агента с портала GitHub. Если последняя версия агента не доступна для дистрибутива, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по получению последней версии агента. Последние сведения об [агенте Windows Azure Linux](https://github.com/Azure/WALinuxAgent/releases) см. в репозитории GitHub.

### <a name="validate-vm-agent-installation"></a>Проверка установки агента виртуальной машины

Для проверки версии агента виртуальной машины на виртуальных машинах Windows выполните следующие действия.

1. Войдите в систему виртуальной машины Azure и перейдите в папку **C:\WindowsAzure\Packages**. В ней должен находиться файл **WaAppAgent.exe**.
2. Щелкните правой кнопкой мыши файл и выберите **Свойства**. Затем выберите вкладку **Сведения**. В поле **Версия продукта** должно отображаться значение 2.6.1198.718 или выше.

## <a name="troubleshoot-vm-snapshot-issues"></a>Решение проблем со снимками виртуальных машин
Архивация виртуальных машин зависит от команды моментального снимка в базовом хранилище. Отсутствие доступа к хранилищу или задержка в выполнении задачи создания моментального снимка может привести к неудачному завершению задания резервного копирования. Сбой задачи создания снимка может быть вызван следующими условиями.

- **Сетевой доступ к хранилищу блокируется при помощи групп NSG**. Узнайте о том, как [включить сетевой доступ](backup-azure-arm-vms-prepare.md#establish-network-connectivity) к хранилищу с помощью списка разрешенных IP-адресов или прокси-сервера.
- **Виртуальные машины с настроенной архивацией SQL Server могут вызвать задержку задачи создания моментальных снимков**. По умолчанию при архивации виртуальной машины создается полная резервная копия VSS на виртуальных машинах Windows. На виртуальных машинах, где выполняется SQL Server и настроена архивация SQL Server, это может привести к задержке создания моментального снимка. Если эти задержки приводят к ошибкам резервного копирования, установите следующий ключ реестра.

   ```
   [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
   "USEVSSCOPYBACKUP"="TRUE"
   ```

- **Состояние виртуальной машины отображается неправильно из-за того, что работа виртуальной машины была завершена в сеансе удаленного рабочего стола**. При использовании удаленного рабочего стола для завершении работы виртуальной машины проверьте, правильно ли отображается на портале состояние виртуальной машины. Если это не так, завершите работу виртуальной машины на портале с помощью команды **Завершение работы** на панели мониторинга виртуальной машины.
- **Если больше четырех виртуальных машин используют одну облачную службу, настройте несколько политик резервного копирования**. Задайте время резервного копирования таким образом, чтобы оно выполнялось не более, чем на четырех виртуальных машинах одновременно. Задайте время начала архивации в разных политиках так, чтобы между ними был один час разницы.
- **Виртуальная машина использует большие ресурсы процессора или памяти**. Если виртуальная машина работает при большой загрузке памяти или процессора (более 90 %), задача создания моментального снимка помещается в очередь, задерживается. В конце концов, время ожидания истекает. В таких ситуациях попробуйте использовать архивацию по запросу.

## <a name="networking"></a>Сеть
Как и в случае со всеми другими расширениями, для нормальной работы расширению Backup требуется доступ к общедоступному Интернету. Отсутствие доступа к общедоступному Интернету может приводить к различным проблемам:

* Операция установки расширения может завершаться с ошибкой.
* Операции резервного копирования (например, создание моментального снимка диска) могут завершаться с ошибкой.
* Операция отображения состояния процесса резервного копирования может завершаться с ошибкой.

Необходимость разрешения общедоступных IP-адресов обсуждается в [этом блоге службы поддержки Azure](https://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx). Проверьте конфигурации DNS для виртуальной сети и убедитесь, что URI Azure можно разрешить.

После правильного разрешения имен также требуется предоставить доступ к IP-адресам Azure. Чтобы разблокировать доступ к инфраструктуре Azure, выполните одно из следующих действий.

- Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.
   1. Получите список [IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653) для добавления в разрешенный список.
   1. Разблокируйте IP-адреса с помощью командлета [New-NetRoute](https://docs.microsoft.com/powershell/module/nettcpip/new-netroute). Запустите этот командлет на виртуальной машине Azure в окне PowerShell с повышенными привилегиями. Запустите от имени администратора.
   1. Добавьте правила в группу безопасности сети, если она настроена, для доступа к IP-адресам.
- Создание пути для прохождения трафика HTTP
   1. При наличии каких-либо ограничений сети разверните прокси-сервер HTTP для перенаправления трафика. Например, группа безопасности сети. Инструкции по развертыванию прокси-сервера HTTP см. в разделе [Установка сетевого подключения](backup-azure-arm-vms-prepare.md#establish-network-connectivity).
   1. Добавьте правила в группу безопасности сети, если она настроена, чтобы разрешить доступ к Интернету из прокси-сервера HTTP.

> [!NOTE]
> Для работы резервного копирования службы архивации на виртуальной машине IaaS DHCP должна быть включена для учетной записи гостя. Если вам нужен статический частный IP-адрес, настройте его с помощью портала Azure или PowerShell. Убедитесь, что параметр DHCP для виртуальной машины включен.
> Дополнительные сведения о том, как настроить статический IP-адрес с помощью PowerShell см. раздели:
> - [Добавление статического внутреннего IP-адреса для существующей виртуальной машины](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm)
> - [Изменение метода распределения для частного IP-адреса, назначенного сетевому интерфейсу](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface)
>
>
