---
title: Сведения о резервном копировании виртуальных машин Azure
description: В этой статье узнайте, как служба резервного копирования Azure поддерживает виртуальные машины Azure и как следовать рекомендациям.
ms.topic: conceptual
ms.date: 09/13/2019
ms.openlocfilehash: f4b36f57362607a13c09896cd7109596aba0a852
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79415964"
---
# <a name="an-overview-of-azure-vm-backup"></a>Обзор резервного копирования Azure VM

В этой статье описывается, как [служба резервного копирования Azure](backup-introduction-to-azure-backup.md) поддерживает виртуальные машины Azure (VM).

Резервное копирование Azure предоставляет независимые и изолированные резервные копирования для защиты от непреднамеренного уничтожения данных на ваших ВМ. Резервные копии хранятся в хранилище Служб восстановления со встроенным управлением точками восстановления. Конфигурация и масштабирование просты, резервные копирования оптимизированы, и вы можете легко восстановить по мере необходимости.

В процессе резервного копирования [делается снимок,](#snapshot-creation)и данные передаются в хранилище служб восстановления без влияния на производственные нагрузки. Снимок обеспечивает различные уровни согласованности, как описано [здесь.](#snapshot-consistency)

Резервное копирование Azure также имеет специализированные предложения для рабочих нагрузок баз данных, таких как [S'L Server](backup-azure-sql-database.md) и [SAP HANA,](sap-hana-db-about.md) которые осведомлены о рабочей нагрузке, предлагают 15-минутную RPO (цель точки восстановления) и позволяют резервное копирование и восстановление отдельных баз данных.

## <a name="backup-process"></a>Процесс резервного копирования

Вот как резервное копирование Azure завершает резервное копирование для VMs Azure:

1. Для вывизвов Azure, выбранных для резервного копирования, резервное копирование Azure запускает работу резервного копирования в соответствии с графиком резервного копирования, указанным.
1. Во время первого резервного копирования на VM устанавливается расширение резервного копирования, если VM работает.
    - Для Windows VMs [установлено расширение VMSnapshot.](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-windows)
    - Для Linux VMs [установлено расширение VMSnapshotLinux.](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-linux)
1. Для запуска компьютеров Windows VMs- резервное копирование координирует работу службы копирования теней Windows (VSS) для выполнения согласованного в приложении снимка VM.
    - По умолчанию резервное копирование занимает полное резервное копирование VSS.
    - Если резервное копирование не может сделать снимок приложения, требуется файлопоследовательный снимок базового хранилища (потому что нет записей приложения, происходит в то время как VM остановлен).
1. Для Linux VMs резервное копирование занимает резервную резервную систему. Для согласованных моментальных снимков приложений необходимо вручную настроить сценарии pre/post.
1. После того, как резервное копирование делает снимок, оно передает данные в хранилище.
    - Резервное копирование оптимизировано путем параллельного резервного копирования каждого VM-диска.
    - Для каждого резервного копирования диска Резервное копирование Azure считывает блоки на диске и определяет и передает только измененные блоки данных (дельта) со времени предыдущего резервного копирования.
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. Это может занять несколько часов при высокой нагрузке. Общее время резервного копирования для VM будет меньше 24 часов для ежедневных политик резервного копирования.
1. Изменения, внесенные в Windows VM после включения резервного копирования Azure:
    - В VM установлен Microsoft Visual C'2013 Redistributable (x64) - 12.0.40660
    - Тип запуска службы копирования теней (VSS) изменен на автоматический из ручного
    - Добавлена услуга IaASVmProvider Windows

1. Когда передача данных завершена, моментальный снимок удаляется и создается точка восстановления.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Шифрование резервных отсутсвий Azure VM

При создании резервных копий виртуальных машин Azure с помощью Azure Backup виртуальные машины шифруются в неактивном состоянии с использованием Шифрования службы хранилища. Резервное копирование Azure также может резервное копирование VMs Azure, которые шифруются с помощью шифрования Azure Disk.

**Шифрование** | **Подробно** | **Поддержка**
--- | --- | ---
**Шифрование azure дисков** | Шифрование azure Disk шифрует как ОС, так и диски данных для VMs Azure.<br/><br/> Шифрование azure Disk интегрируется с ключами шифрования BitLocker (BEKs), которые охраняются в хранилище ключей как секреты. Шифрование azure Disk также интегрируется с ключами шифрования ключей Azure Key Vault (KEK). | Резервное копирование Azure поддерживает резервное копирование управляемых и неуправляемых VMs Azure, зашифрованных только с BEKs или с BEKs вместе с KEK.<br/><br/> Как BEKs, так и KEKs резервируются и шифруются.<br/><br/> Поскольку KEKs и BEKs резервируются, пользователи с необходимыми разрешениями могут при необходимости восстановить ключи и секреты обратно в хранилище ключей. Эти пользователи также могут восстановить зашифрованный VM.<br/><br/> Зашифрованные ключи и секреты не могут быть прочитаны неавторизованными пользователями или Azure.
**SSE** | С помощью SSE Azure Storage обеспечивает шифрование в состоянии покоя, автоматически шифруя данные перед их хранением. Azure Storage также расшифровывает данные перед их извлечением. | Azure Backup использует SSE для шифрования vMs Azure.

Для управляемых и неуправляемых VMs Azure Backup поддерживает как VMs, зашифрованные только с BEKs, так и VMs, зашифрованные с BEKs вместе с KEK.

Резервные BEKs (секреты) и KEKs (ключи) зашифрованы. Они могут быть прочитаны и использованы только тогда, когда они восстановлены обратно в хранилище ключей авторизованными пользователями. Ни неавторизованные пользователи, ни Azure не могут читать или использовать резервные ключи или секреты.

BEKs также резервное копирование. Таким образом, если BEKs потеряны, авторизованные пользователи могут восстановить BEKs в хранилище ключей и восстановить зашифрованные VMs. Только пользователи с необходимым уровнем разрешений могут резервное копирование и восстановление зашифрованных VMs или ключей и секретов.

## <a name="snapshot-creation"></a>Создание моментального снимка

Резервное копирование Azure делает снимки в соответствии с графиком резервного копирования.

- **Windows VMs:** Для Windows VMs служба резервного копирования координирует с VSS, чтобы сделать согласованный снимок VM-дисков.  По умолчанию резервное копирование Azure занимает полное резервное копирование VSS (оно усечено журналов приложений, таких как S'L Server на момент резервного копирования, чтобы получить согласованное резервное копирование уровня приложения).  Если вы используете базу данных сервера S'L в резервном копировании Azure VM, можно изменить настройку, чтобы взять резервную копию VSS Copy (для сохранения журналов). Дополнительные сведения см. в [этой статье](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues).

- **Linux VMs:** Чтобы сделать согласованные снимки Linux VMs, используйте платформу Linux pre-script и post-script для написания собственных пользовательских скриптов для обеспечения согласованности.

  - Резервное копирование Azure вызывает только сценарии pre/post, написанные вами.
  - Если предварительные сценарии и постскриптумы выполняются успешно, резервное копирование Azure означает точку восстановления как согласованную для приложений. Однако, когда вы используете пользовательские скрипты, вы в конечном счете несете ответственность за согласованность приложения.
  - [Подробнее](backup-azure-linux-app-consistent.md) о настройке скриптов.

## <a name="snapshot-consistency"></a>Согласованность моментального снимка

В следующей таблице разъясняется различные типы консистенции моментального снимка:

**Снимок** | **Подробно** | **Восстановления** | **Рассматриваемый вопрос**
--- | --- | --- | ---
**Согласованность с приложениями** | Согласованные с приложениями резервные копии включают содержимое памяти и ожидающие операции ввода-вывода. Приложения-последовательные снимки используют срабатывание VSS (или сценарии pre/post для Linux) для обеспечения согласованности данных приложения до создания резервного копирования. | Когда вы восстанавливаете VM с помощью согласованного с приложением снимка, VM загружается. В этом случае не происходит потери или повреждения данных. Приложение запускается в согласованном состоянии. | Windows: Все писатели VSS удалось<br/><br/> Linux: Сценарии pre/post настроены и успешно
**Файловая система последовательна** | Последовательная система файлов обеспечивает согласованность, снимая снимок всех файлов одновременно.<br/><br/> | При восстановлении VM с помощью последовательного снимка файловой системы VM загружается. В этом случае не происходит потери или повреждения данных. Чтобы гарантировать согласованность восстановленных данных, в приложениях необходимо реализовать собственный механизм исправления. | Windows: Некоторые писатели VSS потерпели неудачу <br/><br/> Linux: По умолчанию (если сценарии до/пост не настроены или не сработали)
**Отказоустойчивость** | Обычно моментальные снимки, согласованные с сбоем, возникают при выключении VM Azure во время резервного копирования. Во время архивации создается резервная копия только тех данных, которые уже существуют на диске. | Начинается с процесса загрузки VM с последующим проверкой диска для устранения ошибок коррупции. Любые данные в памяти или операции записи, которые не были переданы на диск до сбоя теряются. В приложениях должна быть реализована собственная проверка данных. Например, приложение базы данных может использовать свой журнал транзакций для проверки. Если в журнале транзакций есть записи, которых нет в базе данных, программное обеспечение базы данных откатывает транзакции до тех пор, пока данные не будут согласованы. | VM находится в состоянии выключения (остановлено/сделки) состояния.

## <a name="backup-and-restore-considerations"></a>Резервное копирование и восстановление соображений

**Рассматриваемый вопрос** | **Подробно**
--- | ---
**Диск** | Резервное копирование vM-дисков происходит параллельно. Например, если vM имеет четыре диска, служба резервного копирования пытается создать резервную резервную систему параллельно. Резервное копирование является добавочным (только измененные данные).
**Планирования** |  Чтобы уменьшить трафик резервного копирования, резервное копирование различных ВМ в разное время суток и убедитесь, что время не перекрывается. Резервное копирование виртуальных машин в одно и то же время создает перегрузку.
**Подготовка резервных копий** | Имейте в виду время, необходимое для подготовки резервного копирования. Время подготовки включает в себя установку или обновление расширения резервного копирования и запуск снимка в соответствии с графиком резервного копирования.
**Передача данных** | Рассмотрим время, необходимое для резервного копирования Azure для определения дополнительных изменений из предыдущей резервной копирования.<br/><br/> В дополнительном резервном копировании резервное копирование Azure определяет изменения, вычисляя чековую сум блока. Если блок изменен, он помечен для передачи в хранилище. Служба анализирует выявленные блоки, чтобы попытаться еще больше свести к минимуму объем данных для передачи. После оценки всех измененных блоков резервное копирование Azure передает изменения в хранилище.<br/><br/> Возможна небольшая задержка между созданием моментального снимка и его копированием в хранилище.<br/><br/> В часы пик обработка резервных данных может занять до восьми часов. Общее время резервного копирования виртуальной машины составляет менее 24 часов для ежедневного резервного копирования.
**Начальное резервное копирование** | Хотя общее время резервного копирования для дополнительных резервных копирования составляет менее 24 часов, это может быть не так для первого резервного копирования. Время, необходимое для первоначального резервного копирования, будет зависеть от размера данных и времени обработки резервного копирования.
**Очередь восстановления** | Процессы резервного копирования Azure восстанавливают задания из нескольких учетных записей одновременно и ставят запросы на восстановление в очередь.
**Копирование при восстановлении** | Во время восстановления данные копируются из хранилища в учетную запись хранения.<br/><br/> Общее время восстановления зависит от операций ввода/второго в секунду (IOPS) и пропускной записи учетной записи хранилища.<br/><br/> Чтобы сократить время копирования, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.

### <a name="backup-performance"></a>Производительность резервного копирования

Эти общие сценарии могут повлиять на общее время резервного копирования:

- **Добавление нового диска в защищенный Azure VM:** Если VM проходит дополнительное резервное копирование и добавляется новый диск, время резервного копирования увеличивается. Общее время резервного копирования может длиться более 24 часов из-за первоначальной репликации нового диска, а также репликации дельты существующих дисков.
- **Фрагментированные диски:** Операции резервного копирования быстрее, когда изменения диска являются смежными. Если изменения распределены по всему диску, резервное копирование будет выполняться медленнее.
- **Отток диска:** Если защищенные диски, которые подвергаются постепенному резервному копированию, имеют ежедневный отток более 200 ГБ, резервное копирование может занять много времени (более восьми часов).
- **Версии резервного копирования:** Последняя версия резервного копирования (известная как версия мгновенного восстановления) использует более оптимизированный процесс, чем сравнение checksum для идентификации изменений. Но если вы используете Мгновенное восстановление и удалили снимок резервного копирования, резервное копирование переключается на сравнение checksum. В этом случае операция резервного копирования превысит 24 часа (или сбой).

## <a name="best-practices"></a>Рекомендации

При настройке резервных ups VM мы предлагаем следующие методы:

- Измените время расписания по умолчанию, установленное в политике. Например, если время по умолчанию в политике составляет 12:00 утра, увеличение времени на несколько минут, так что ресурсы оптимально используются.
- Если вы восстанавливаете ВМ из одного хранилища, мы настоятельно рекомендуем использовать различные [учетные записи v2 общего назначения,](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade) чтобы гарантировать, что учетная запись целевого хранилища не будет задушена. Например, каждый VM должен иметь другую учетную запись хранения. Например, если 10 ВМ восстановлены, используйте 10 различных учетных записей хранения.
- Для резервного копирования вс-голов, использующих премиум-хранилище, с мгновенным восстановлением, мы рекомендуем выделить *50%* свободного пространства от общего выделенного пространства для хранения, которое требуется **только** для первого резервного копирования. 50% свободного пространства не является требованием для резервного копирования после первого резервного копирования завершена
- Ограничение на количество дисков на учетную запись хранилища относительно того, насколько сильно диски доступны приложениями, работающими на инфраструктуре как услуга (IaaS) VM. Как правило, если на одном счете хранения находятся от 5 до 10 дисков или более, сбалансируйте нагрузку, перемещая некоторые диски в отдельные учетные записи.

## <a name="backup-costs"></a>Оплата резервного копирования

В отношении виртуальных машин Azure, резервное копирование которых выполняется с помощью службы Azure Backup, действует [прейскурант на использование службы Azure Backup](https://azure.microsoft.com/pricing/details/backup/).

Выставление счетов не начинается до тех пор, пока не завершится первое успешное резервное копирование. На этом этапе начинается выставление счетов за службу хранилища и защищенные виртуальные машины. Выставление счетов продолжается до тех пор, пока любые резервные данные для VM хранятся в хранилище. Если вы остановите защиту виртуальной машины, но данные резервного копирования виртуальной машины остаются в хранилище, выставление счетов продолжится.

Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита и удаляются все данные резервных копий. Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.

Расчет размера защищенной инстанции основан на *фактическом* размере VM. Размер VM - это сумма всех данных в ВМ, за исключением временного хранилища. Ценообразование основано на фактических данных, хранящихся на дисках данных, а не на максимально поддерживаемом размере для каждого диска данных, прикрепленного к VM.

Аналогичным образом, счет резервного хранения основан на объеме данных, хранящихся в резервном копировании Azure, который является суммой фактических данных в каждой точке восстановления.

Например, возьмем VM размером с A2,Standard, который имеет два дополнительных диска данных с максимальным размером 32 ТБ каждый. В следующей таблице показаны фактические данные, хранящиеся на каждом из этих дисков:

**Диск** | **Максимальный размер** | **Присутствующие фактические данные**
--- | --- | ---
Диск ОС | 32 ТБ | 17 ГБ
Локальный или временный диск | 135 ГБ | 5 ГБ (не учитывается для архивации)
Диск данных 1 | 32 ТБ| 30 ГБ
Диск данных 2 | 32 ТБ | 0 ГБ

Фактический размер виртуальной машины в этом случае составляет 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ. Этот защищенный размер экземпляра (47 ГБ) становится основой для ежемесячного счета. По мере роста объема данных в VM размер защищенного экземпляра используется для изменения выставления счетов.

## <a name="next-steps"></a>Дальнейшие действия

Теперь [подготовьтесь к резервному копированию Azure VM.](backup-azure-arm-vms-prepare.md)
