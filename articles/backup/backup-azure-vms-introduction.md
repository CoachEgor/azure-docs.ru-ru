---
title: Резервное копирование виртуальных машин Azure
description: Сведения и некоторые рекомендации, посвященные резервному копированию виртуальных машин Azure.
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 03/04/2019
ms.author: dacurwin
ms.openlocfilehash: 7a470674fa9ccdde2b33bb33bfb52bead1822895
ms.sourcegitcommit: 3877b77e7daae26a5b367a5097b19934eb136350
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68639730"
---
# <a name="about-azure-vm-backup"></a>Сведения о резервном копировании виртуальных машин Azure

В этой статье описывается, как [служба Azure Backup](backup-introduction-to-azure-backup.md) создает резервные копии виртуальных машин Azure.

## <a name="backup-process"></a>Процесс резервного копирования

Вот как Azure Backup завершает резервное копирование для виртуальных машин Azure:

1. Для виртуальных машин Azure, выбранных для резервного копирования, Azure Backup запускает задание резервного копирования в соответствии с заданным расписанием архивации.
1. Во время первой архивации на виртуальной машине устанавливается расширение резервного копирования, если виртуальная машина запущена.
    - Для виртуальных машин Windows установлено расширение _VMSnapshot_ .
    - Для виртуальных машин Linux установлено расширение _VMSnapshotLinux_ .
1. Для виртуальных машин Windows, работающих под управлением, резервное копирование координат с помощью Windows служба теневого копирования томов (VSS) для получения моментального снимка виртуальной машины, совместимой с приложениями.
    - По умолчанию резервное копирование занимает все резервные копии VSS.
    - Если резервное копирование не может принять моментальный снимок, основанное на файлах, то он принимает моментальный снимок базового хранилища (так как при остановке виртуальной машины не происходит операций записи приложений).
1. Для виртуальных машин Linux резервное копирование выполняется в соответствии с файлами. Для моментальных снимков, совместимых с приложениями, необходимо вручную настроить скрипты до и после.
1. После создания резервной копии моментальный снимок передает данные в хранилище.
    - Резервная копия оптимизируется путем резервного копирования каждого диска виртуальной машины в параллельном режиме.
    - Для каждого диска, для которого создается резервная копия, Azure Backup считывает блоки на диске и определяет и передает только те блоки данных, которые были изменены (Дельта) с момента предыдущего резервного копирования.
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. Это может занять несколько часов при высокой нагрузке. Общее время архивации для виртуальной машины будет менее 24 часов для политик ежедневного резервного копирования.
 1. Изменения, внесенные в виртуальную машину Windows после включения Azure Backup, приведены ниже.
    -   Распространяемый C++ компонент Microsoft Visual 2013 (x64) — 12.0.40660 установлен на виртуальной машине.
    -   Тип запуска службы теневого копирования томов (VSS) изменен на автоматический с ручной
    -   Добавлена служба Windows IaaSVmProvider

1. После завершения перемещения данных моментальный снимок удаляется и создается точка восстановления.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Шифрование резервных копий виртуальных машин Azure

При создании резервных копий виртуальных машин Azure с помощью Azure Backup виртуальные машины шифруются в неактивном состоянии с использованием Шифрования службы хранилища. Azure Backup также могут выполнять резервное копирование виртуальных машин Azure, зашифрованных с помощью шифрования дисков Azure.

**Шифрование** | **Сведения** | **Поддержка**
--- | --- | ---
**Дисковое шифрование Azure** | Шифрование дисков Azure шифрует диски операционной системы и дисков данных для виртуальных машин Azure.<br/><br/> Шифрование дисков Azure интегрируется с ключами шифрования BitLocker (Бекс), которые защищается в хранилище ключей как секреты. Шифрование дисков Azure также интегрируется с ключами шифрования Azure Key Vault ключей (ключи обмена ключами). | Azure Backup поддерживает резервное копирование управляемых и неуправляемых виртуальных машин Azure, зашифрованных только с помощью Бекс, или с помощью Бекс вместе с ключи обмена ключами.<br/><br/> Бекс и ключи обмена ключами архивируются и шифруются.<br/><br/> Так как резервное копирование ключи обмена ключами и Бекс выполняется, пользователи с необходимыми разрешениями могут восстановить ключи и секреты в хранилище ключей, если это необходимо. Эти пользователи также могут восстановить зашифрованную виртуальную машину.<br/><br/> Зашифрованные ключи и секреты не могут быть прочитаны неавторизованными пользователями или Azure.
**SSE** | Благодаря SSE служба хранилища Azure обеспечивает шифрование неактивных данных, автоматически шифруя данные перед их сохранением. Служба хранилища Azure также расшифровывает данные перед их получением. | Azure Backup использует SSE для шифрования неактивных данных виртуальных машин Azure.

Для управляемых и неуправляемых виртуальных машин Azure служба архивации поддерживает как виртуальные машины, зашифрованные только с помощью Бекс, так и виртуальные машины, зашифрованные с помощью Бекс вместе с ключи обмена ключами.

Резервные Бекс (секреты) и ключи обмена ключами (ключи) шифруются. Они могут быть прочитаны и использованы только при восстановлении их в хранилище ключей полномочными пользователями. Ни неавторизованные пользователи, ни Azure не могут читать или использовать резервные ключи или секреты.

Также выполняется резервное копирование Бекс. Таким образом, если Бекс потеряны, полномочные пользователи могут восстановить Бекс в хранилище ключей и восстановить зашифрованные виртуальные машины. Только пользователи с достаточным уровнем разрешений могут выполнять резервное копирование и восстановление зашифрованных виртуальных машин или ключей и секретов.

## <a name="snapshot-creation"></a>Создание моментального снимка

Azure Backup создает моментальные снимки в соответствии с расписанием резервного копирования.

- **Виртуальные машины Windows:** Для виртуальных машин Windows служба резервного копирования координируется с VSS для создания моментального снимка дисков виртуальных машин, совместимых с приложениями.

  - По умолчанию служба Azure Backup создает полные резервные копии VSS. [Узнайте больше](https://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx).
  - Чтобы изменить параметр так, чтобы Azure Backup занимают резервные копии VSS, установите следующий раздел реестра из командной строки:

    **REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**

- **Виртуальные машины Linux:** Чтобы получить моментальные снимки виртуальных машин Linux с согласованием приложений, используйте платформу предварительных сценариев и пост-сценариев Linux для создания собственных пользовательских сценариев для обеспечения согласованности.

  - Azure Backup вызывает только скрипты, предшествующие или POST, которые вы написали.
  - Если скрипты предварительного и последующей выполнения выполняются успешно, Azure Backup помечает точку восстановления как совместимую с приложениями. Однако при использовании пользовательских сценариев вы в конечном итоге отвечаете за согласованность приложений.
  - Дополнительные [сведения](backup-azure-linux-app-consistent.md) о настройке скриптов.

### <a name="snapshot-consistency"></a>Согласованность моментального снимка

В следующей таблице описаны различные типы согласованности моментальных снимков.

**Моментальный снимок** | **Сведения** | **Восстановление** | **Рассмотрение**
--- | --- | --- | ---
**Согласованность с приложениями** | Согласованные с приложениями резервные копии включают содержимое памяти и ожидающие операции ввода-вывода. Моментальные снимки с согласованием приложений используют модуль записи VSS (или скрипты предварительной или публикации для Linux) для обеспечения согласованности данных приложения перед резервным копированием. | При восстановлении виртуальной машины с помощью моментального снимка, совместимого с приложениями, виртуальная машина загружается. В этом случае не происходит потери или повреждения данных. Приложение запускается в согласованном состоянии. | Windows: Все модули записи VSS выполнены успешно<br/><br/> Linux: Предварительные и последующие сценарии настроены и выполнены успешно
**Целостность файловой системы** | Согласованные с файловой системой резервные копии обеспечивают согласованность за счет моментального снимка всех файлов в одно и то же время.<br/><br/> | При восстановлении виртуальной машины с моментальным снимком, совместимым с файловой системой, виртуальная машина загружается. В этом случае не происходит потери или повреждения данных. Чтобы гарантировать согласованность восстановленных данных, в приложениях необходимо реализовать собственный механизм исправления. | Windows: Некоторые модули записи VSS завершились сбоем <br/><br/> Linux: По умолчанию (если скрипты pre и POST не настроены или не пройдены)
**Отказоустойчивость** | Моментальные снимки с постоянным аварийным завершением обычно возникают, если виртуальная машина Azure завершает работу во время резервного копирования. Во время архивации создается резервная копия только тех данных, которые уже существуют на диске.<br/><br/> Наличие отказоустойчивой точки восстановления не гарантирует согласованности данных для операционной системы или приложения. | Несмотря на отсутствие гарантий, виртуальная машина обычно загружается, а затем запускает проверку диска для устранения ошибок повреждения. Все данные в памяти или операции записи, которые не были переданы на диск перед сбоем, теряются. В приложениях должна быть реализована собственная проверка данных. Например, приложение базы данных может использовать свой журнал транзакций для проверки. Если журнал транзакций содержит записи, которых нет в базе данных, то программное обеспечение базы данных выполняет откат транзакций до тех пор, пока данные не будут согласовываться. | Виртуальная машина находится в состоянии завершения работы

## <a name="backup-and-restore-considerations"></a>Рекомендации по резервному копированию и восстановлению

**Рассмотрение** | **Сведения**
--- | ---
**Диск** | Резервное копирование дисков виртуальной машины параллельно. Например, если виртуальная машина содержит четыре диска, служба резервного копирования пытается выполнить резервное копирование всех четырех дисков параллельно. Резервное копирование является добавочным (только измененные данные).
**Планирование** |  Чтобы уменьшить трафик резервного копирования, выполните резервное копирование различных виртуальных машин в разное время суток и убедитесь, что время не перекрывается. Резервное копирование виртуальных машин в одно и то же время создает перегрузку.
**Подготовка резервных копий** | Учитывайте время, необходимое для подготовки резервной копии. Время подготовки включает установку или обновление расширения резервного копирования и запуск моментального снимка в соответствии с расписанием архивации.
**Передача данных в службы Azure и обратно** | Рассмотрите время, необходимое для Azure Backup, чтобы определить добавочные изменения из предыдущей резервной копии.<br/><br/> При добавочном резервном копировании Azure Backup определяет изменения, вычисляя контрольную сумму блока. Если блок изменен, он помечается для перемещения в хранилище. Служба анализирует идентифицированные блоки, чтобы попытаться еще больше сокращать объем передаваемых данных. После вычисления всех измененных блоков Azure Backup передает изменения в хранилище.<br/><br/> Возможна небольшая задержка между созданием моментального снимка и его копированием в хранилище.<br/><br/> В пиковое время для обработки резервных копий может потребоваться до восьми часов. Общее время резервного копирования виртуальной машины составляет менее 24 часов для ежедневного резервного копирования.
**Начальное резервное копирование** | Хотя общее время резервного копирования для добавочных резервных копий менее 24 часов, это может быть не так для первой резервной копии. Время, необходимое для начальной архивации, зависит от размера данных и времени обработки резервной копии.
**Очередь восстановления** | Azure Backup одновременно обрабатывает задания восстановления из нескольких учетных записей хранения и помещает запросы на восстановление в очередь.
**Копирование при восстановлении** | Во время восстановления данные копируются из хранилища в учетную запись хранения.<br/><br/> Общее время восстановления зависит от количества операций ввода-вывода в секунду и пропускной способности учетной записи хранения.<br/><br/> Чтобы сократить время копирования, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.

### <a name="backup-performance"></a>Производительность резервного копирования

Эти распространенные сценарии могут повлиять на общее время резервного копирования:

- **Добавление нового диска в защищенную виртуальную машину Azure:** Если виртуальная машина проходит добавочное резервное копирование и добавляется новый диск, то время архивации увеличится. Общее время архивации может соблюдаться в течение более 24 часов из-за начальной репликации нового диска, а также разностной репликации существующих дисков.
- **Фрагментированные диски:** Операции резервного копирования выполняются быстрее, если изменения диска являются смежными. Если изменения распределены по всему диску, резервное копирование будет выполняться медленнее.
- **Обработка диска:** Если защищенные диски, на которых выполняется добавочное резервное копирование, имеют ежедневное обновление более 200 ГБ, для завершения архивации может потребоваться длительное время (более восьми часов).
- **Версии резервных копий:** Последняя версия резервного копирования (известная как версия мгновенного восстановления) использует более оптимизированный процесс, чем сравнение контрольных сумм для выявления изменений. Но если вы используете мгновенное восстановление и удалили моментальный снимок резервной копии, резервное копирование переключается на сравнение контрольных сумм. В этом случае операция резервного копирования превысит 24 часа (или не будет работать).

## <a name="best-practices"></a>Рекомендации

При настройке резервного копирования виртуальных машин рекомендуется приступать к следующим рекомендациям.

- Изменение времени расписания по умолчанию, заданных в политике. Например, если по умолчанию в политике задано время 12:00 AM, увеличьте время на несколько минут, чтобы ресурсы были оптимально использованы.
- При восстановлении виртуальных машин из одного хранилища настоятельно рекомендуется использовать разные [учетные записи хранения общего назначения версии 2](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade) , чтобы гарантировать, что Целевая учетная запись хранения не будет отрегулирована. Например, каждая виртуальная машина должна иметь другую учетную запись хранения. Например, если восстановить 10 виртуальных машин, используйте 10 разных учетных записей хранения.
- Для резервного копирования виртуальных машин, использующих хранилище класса Premium, при мгновенном восстановлении рекомендуется выделить *50%* свободного пространства для общего выделенного пространства, которое требуется **только** для первой резервной копии. 50% свободного места не является обязательным для резервных копий после завершения первой архивации
- Восстановление с уровня хранилища общего назначения v1 (моментальный снимок) будет выполняться за считаные минуты, так как моментальный снимок находится в той же учетной записи хранения. Восстановление с уровня хранилища общего назначения (хранилища) версии 2 может занять несколько часов. В случаях, когда данные доступны в хранилище общего назначения версии 1, рекомендуется использовать функцию [мгновенного восстановления](backup-instant-restore-capability.md) для ускорения восстановления. (Если данные необходимо восстановить из хранилища, это займет больше времени.)
- Ограничение на количество дисков в каждой учетной записи хранения зависит от того, насколько интенсивен доступ к дискам в приложениях, работающих на виртуальной машине "инфраструктура как услуга" (IaaS). Как правило, если в одной учетной записи хранения имеется от 5 до 10 дисков или больше, Распределите нагрузку путем перемещения некоторых дисков в отдельные учетные записи хранения.

## <a name="backup-costs"></a>Оплата резервного копирования

В отношении виртуальных машин Azure, резервное копирование которых выполняется с помощью службы Azure Backup, действует [прейскурант на использование службы Azure Backup](https://azure.microsoft.com/pricing/details/backup/).

Выставление счетов не начинается до завершения первой успешной архивации. На этом этапе начинается выставление счетов за службу хранилища и защищенные виртуальные машины. Выставление счетов выполняется, пока все данные резервных копий для виртуальной машины хранятся в хранилище. Если вы остановите защиту виртуальной машины, но данные резервного копирования виртуальной машины остаются в хранилище, выставление счетов продолжится.

Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита и удаляются все данные резервных копий. Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.

Вычисление размера защищенного экземпляра зависит от фактического размера виртуальной машины. Размер виртуальной машины — это сумма всех данных в виртуальной машине, исключая временное хранилище. Цены основываются на фактических данных, которые хранятся на дисках данных, а не на максимальном поддерживаемом размере для каждого диска данных, подключенного к виртуальной машине.

Аналогично, счет за хранилище резервных копий основывается на объеме данных, хранящихся в Azure Backup, который является суммой фактических данных в каждой точке восстановления.

Например, возьмем виртуальную машину размера "a2 — Стандартный" с двумя дополнительными дисками данных с максимальным размером в 4 ТБ. В следующей таблице показаны фактические данные, хранящиеся на каждом из этих дисков.

**Диск** | **Максимальный размер** | **Присутствующие фактические данные**
--- | --- | ---
Диск ОС | 4095 ГБ | 17 ГБ
Локальный или временный диск | 135 ГБ | 5 ГБ (не учитывается для архивации)
Диск данных 1 | 4095 ГБ | 30 ГБ
Диск данных 2 | 4095 ГБ | 0 ГБ

Фактический размер виртуальной машины в этом случае составляет 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ. Этот размер защищенного экземпляра (47 ГБ) станет основанием для ежемесячного счета. По мере роста объема данных на виртуальной машине размер защищенного экземпляра, используемый для выставления счетов, изменяется на соответствие.

## <a name="next-steps"></a>Следующие шаги

Теперь Подготовьтесь [к резервному копированию виртуальных машин Azure](backup-azure-arm-vms-prepare.md).
