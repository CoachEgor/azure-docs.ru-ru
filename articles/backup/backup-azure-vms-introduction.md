---
title: Резервное копирование виртуальных машин Azure
description: Сведения и некоторые рекомендации, посвященные резервному копированию виртуальных машин Azure.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 03/04/2019
ms.author: raynew
ms.openlocfilehash: 93be913182db56941c346ef0cad47f70c0d614c9
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "64706830"
---
# <a name="about-azure-vm-backup"></a>Сведения о резервном копировании виртуальных машин Azure

В этой статье описывается как [службы архивации Azure](backup-introduction-to-azure-backup.md) создает резервные копии виртуальных машин (ВМ) Azure.

## <a name="backup-process"></a>Процесс резервного копирования

Вот, как служба архивации Azure осуществляется ее резервное копирование для виртуальных машин Azure:

1. Для виртуальных машин Azure, выбранных для резервного копирования архивации Azure запускает задание резервного копирования в соответствии с вами расписание резервного копирования.
1. Во время первой резервной копии расширение резервного копирования устанавливается на виртуальной Машине, если виртуальная машина запущена.
    - Для виртуальных машин Windows _VMSnapshot_ установлено расширение.
    - Для виртуальных машин Linux _VMSnapshotLinux_ установлено расширение.
1. Для виртуальных машин Windows, которые выполняются резервное копирование координирует с Windows тома службы теневого копирования (VSS) согласованные снимка виртуальной Машины.
    - По умолчанию резервное копирование принимает полные резервные копии VSS.
    - Если резервное копирование не может занять моментальные снимки с согласованием приложений, затем занимает согласованием файлов моментальный снимок базового хранилища (так как не приложение выполняет операции записи во время остановки виртуальной Машины).
1. Для виртуальных машин Linux резервное копирование занимает согласованием файлов резервной копии. Для моментальных снимков, приемлемых для приложений необходимо вручную настроить такие сценарии.
1. После создания моментального снимка резервной копии, происходит перенос данных в хранилище.
    - Резервное копирование оптимизировано путем резервного копирования каждый диск виртуальной Машины в параллельном режиме.
    - Для каждого диска, который выполняется резервное копирование служба архивации Azure считывает блоки на диске и определяет и передает только те блоки данных, измененных с момента предыдущего резервного копирования (разностного).
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. Это может занять несколько часов при высокой нагрузке. Общее время резервного копирования для виртуальной Машины будет менее 24 часов для политик ежедневной архивации.
 1. Изменения, внесенные в виртуальную Машину Windows, после включения службы архивации Azure на нем:
    -   Microsoft Visual C++ 2013 Redistributable(x64) - 12.0.40660 устанавливается на виртуальной машине
    -   Тип запуска службы теневого копирования томов (VSS), меняется на автоматический вручную
    -   Добавляется служба IaaSVmProvider Windows

1. После завершения передачи данных моментальный снимок удаляется и создается точка восстановления.

![Архитектура резервного копирования виртуальных машин Azure](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encryption-of-azure-vm-backups"></a>Шифрование резервных копий виртуальных Машин Azure

При создании резервных копий виртуальных машин Azure с помощью Azure Backup виртуальные машины шифруются в неактивном состоянии с использованием Шифрования службы хранилища. Служба архивации Azure также можно создавать резервные копии виртуальных машин Azure, шифруются с помощью шифрования дисков Azure.

**Шифрование** | **Сведения** | **Поддержка**
--- | --- | ---
**Дисковое шифрование Azure** | Шифрование дисков Azure шифрует диски ОС и диски данных для виртуальных машин Azure.<br/><br/> Шифрование дисков Azure интегрируется с ключами шифрования BitLocker (BEKs), которые хранятся в хранилище ключей в виде секретов. Шифрование дисков Azure также интегрируется с Azure Key Vault ключа шифрования ключей (ключи шифрования ключей). | Azure Backup поддерживает резервное копирование управляемых и неуправляемых виртуальных машин Azure, зашифрованные только BEKs или с BEKs вместе с ключи шифрования ключей.<br/><br/> BEKs и ключи шифрования ключей архивируются и зашифрованы.<br/><br/> Поскольку ключи обмена ключами и BEKs резервные копии создаются, пользователи с необходимыми разрешениями могут восстановить ключи и секретные данные обратно в хранилище ключей, при необходимости. Эти пользователи также смогут восстанавливать зашифрованной виртуальной Машины.<br/><br/> Не удается прочитать зашифрованные ключи и секреты, неавторизованные пользователи или в Azure.
**SSE** | С помощью SSE хранилище Azure предоставляет шифрование неактивных данных посредством автоматического шифрования данных перед их сохранением. Служба хранилища Azure также расшифровывает данные перед его возвращением. | Служба архивации Azure использует SSE для шифрования неактивных виртуальных машин Azure.

Для управляемых и неуправляемых виртуальных машин Azure служба архивации поддерживает виртуальных машин, зашифрованных только с BEKs или виртуальных машин, зашифрованных с помощью BEKs вместе с ключи шифрования ключей.

Резервные копии BEKs (секретов) и ключи шифрования ключей (ключи), шифруются. Их можно считывать и использовать только в том случае, если их время восстановить обратно в хранилище ключей, авторизованными пользователями. Неавторизованные пользователи, ни Azure может считывать или использовать резервные копии ключи или секреты.

Также BEKs архивируются. Таким образом Если BEKs будут потеряны, авторизованные пользователи смогут восстановить BEKs в хранилище ключей и восстановление зашифрованных виртуальных машин. Только пользователи с необходимый уровень разрешений можно резервного копирования и восстановления зашифрованных виртуальных машин или ключей и секретов.

## <a name="snapshot-creation"></a>Создание моментального снимка

Служба архивации Azure принимает моментальные снимки в соответствии с расписанием резервного копирования.

- **Виртуальные машины Windows:** Для виртуальных машин Windows служба архивации координируется с помощью службы VSS согласованные снимка дисков виртуальной Машины.

  - По умолчанию служба Azure Backup создает полные резервные копии VSS. [Узнайте больше](https://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx).
  - Чтобы изменить этот параметр, чтобы служба архивации Azure делает копирующую архивацию VSS, задайте следующий раздел реестра из командной строки:

    **REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**

- **Виртуальные машины Linux:** Создавать согласованные моментальные снимки виртуальных машин Linux, используйте скрипт предварительного выполнения для Linux и последующий сценарии платформу для создания собственных пользовательских сценариев для обеспечения согласованности.

  - Служба архивации Azure вызывает только написанные вами скрипты предварительного и последующего.
  - Если сценарии предварительной обработки и сценарии последующей обработки будут успешно выполнены, служба архивации Azure пометит точку восстановления в качестве согласованные с приложением. Тем не менее при использовании пользовательских скриптов, вы в конечном счете за согласованность приложений.
  - [Дополнительные сведения](backup-azure-linux-app-consistent.md) о том, как настроить сценарии.

### <a name="snapshot-consistency"></a>Согласованность моментального снимка

В следующей таблице описаны различные типы согласованность моментального снимка:

**Моментальный снимок** | **Сведения** | **Восстановление** | **Рассмотрение**
--- | --- | --- | ---
**Согласованность с приложениями** | Согласованные с приложениями резервные копии включают содержимое памяти и ожидающие операции ввода-вывода. Модуль записи VSS (или предварительного и последующего сценариев для Linux) для обеспечения согласованности данных приложения, прежде чем произойдет резервной копии, используйте моментальных снимков с согласованием приложений. | При восстановлении виртуальной Машины с согласованием приложений моментального снимка, виртуальная машина загружается. В этом случае не происходит потери или повреждения данных. Приложение запускается в согласованном состоянии. | Windows: Все модули записи VSS выполнены успешно<br/><br/> Linux: Предварительные и последующие сценарии настроены и выполнены успешно
**Файловой системе** | Согласованное резервное копирование файловой системы обеспечения согласованности с помощью снимка все файлы в то же время.<br/><br/> | При восстановлении виртуальной Машины с помощью моментального снимка файловой системы, виртуальная машина загружается. В этом случае не происходит потери или повреждения данных. Чтобы гарантировать согласованность восстановленных данных, в приложениях необходимо реализовать собственный механизм исправления. | Windows: Некоторые модули записи VSS завершились сбоем <br/><br/> Linux: По умолчанию (если такие сценарии не настроен или с ошибкой)
**Отказоустойчивость** | Отказоустойчивые моментальные снимки обычно возникают, если виртуальная машина Azure завершает работу во время резервного копирования. Во время архивации создается резервная копия только тех данных, которые уже существуют на диске.<br/><br/> Наличие отказоустойчивой точки восстановления не гарантирует согласованности данных для операционной системы или приложения. | Несмотря на то, что нет никаких гарантий, обычно загрузке виртуальной Машины, и начинает проверку диска, чтобы исправить ошибки повреждения. Данные в памяти или операций записи, которые не были перенесены на диск до сбоя, будут потеряны. В приложениях должна быть реализована собственная проверка данных. Например приложение базы данных можно использовать ее журнала транзакций для проверки подлинности. Если журнал транзакций содержит записи, которые отсутствуют в базе данных, программное обеспечение базы данных выполняет откат транзакции, до данных согласована. | Виртуальная машина находится в состоянии завершения работы

## <a name="backup-and-restore-considerations"></a>Вопросы резервного копирования и восстановления

**Рассмотрение** | **Сведения**
--- | ---
**Диск** | Резервное копирование дисков виртуальной Машины — параллельное выполнение. Например если на виртуальной Машине есть четыре диска, в службе резервного копирования пытается резервное копирование всех четырех дисков одновременно. Резервное копирование является добавочным (только измененные данные).
**Планирование** |  Чтобы уменьшить трафик резервного копирования, резервное копирование разных виртуальных машин в разное время дня и убедитесь, что время пространства не перекрываются. Резервное копирование виртуальных машин в одно и то же время создает перегрузку.
**Подготовка резервных копий** | Имейте в виду время, необходимое для подготовки резервного копирования. Время подготовки включает в себя установку или обновление расширения резервного копирования и активации моментального снимка, в соответствии с расписанием резервного копирования.
**Передача данных в службы Azure и обратно** | Учитывать время, необходимое для архивации Azure определить добавочные изменения из предыдущей резервной копии.<br/><br/> В добавочное резервное копирование резервного копирования Azure выявляет изменения путем вычисления контрольной суммы блока. Если блок изменился, она помечается для передачи в хранилище. Служба анализирует этих блоков попытаться Дополнительно сократить объем передаваемых данных. После оценки всех измененных блоков, Azure Backup передает изменения в хранилище.<br/><br/> Возможна небольшая задержка между созданием моментального снимка и его копированием в хранилище.<br/><br/> В часы пик может занять до восьми часов для резервных копий для обработки. Общее время резервного копирования виртуальной машины составляет менее 24 часов для ежедневного резервного копирования.
**Начальное резервное копирование** | Несмотря на то, что общее время резервного копирования для добавочных резервных копий составляет менее 24 часов, которые могут быть в случае с первой резервной копии. Время, необходимое для первоначальной резервной копии будет зависеть от размера данных и при обработке резервной копии.
**Очередь восстановления** | Azure Backup обрабатывает задания восстановления от нескольких учетных записей хранения в то же время, и помещает в очередь запросы на восстановление.
**Копирование при восстановлении** | Во время восстановления данные копируются из хранилища в учетную запись хранения.<br/><br/> Общее время восстановления зависит от операций ввода-вывода в секунду (IOPS) и пропускную способность для учетной записи хранения.<br/><br/> Чтобы сократить время копирования, выберите учетную запись хранения, которая не загружена другими операциями чтения и записи приложений.

### <a name="backup-performance"></a>Производительность резервного копирования

Следующие распространенные задачи могут повлиять на общее время резервного копирования:

- **Добавление нового диска в защищенной виртуальной Машине Azure.** Если виртуальная машина находится в режиме добавочное резервное копирование и добавляется новый диск, увеличит время резервного копирования. Общее время резервного копирования может длиться более 24 часов из-за начальной репликации нового диска, наряду с разностной репликации в существующих дисков.
- **Фрагментированные диски:** Операции резервного копирования выполняются быстрее, когда изменения на диске являются смежными. Если изменения распределены по всему диску, резервное копирование будет выполняться медленнее.
- **Скорость обработки диска:** Если защищенные диски, которые, выполняется добавочное резервное копирование ежедневного обновления более 200 ГБ, резервное копирование может занять длительное время (более чем восьми часов) для завершения.
- **Версии резервного копирования:** Последнюю версию резервной копии (известным как мгновенное восстановление) использует более оптимизированный процесс сравнение контрольной суммы для обнаружения изменений. Но если вы используете мгновенного восстановления и удаления моментального снимка резервной копии, резервной копии переключается на сравнение контрольных сумм. В этом случае операции резервного копирования будет превышать 24 часа (или сбой).

## <a name="best-practices"></a>Рекомендации

При настройке резервного копирования виртуальной Машины, мы рекомендуем после этих рекомендаций:

- Изменение расписания по умолчанию, заданные в политике. Например если по умолчанию в политике составляет 12:00 AM, увеличить время на несколько минут, чтобы ресурсы используются оптимально.
- Для резервного копирования виртуальных машин, которые используют хранилище класса premium, рекомендуется запускать последнюю версию Azure Backup ([мгновенное восстановление](backup-instant-restore-capability.md)). Если вы не используете последнюю версию, резервное копирование выделяет около 50 процентов общего дискового пространства. В службе резервного копирования требуется этот объем, чтобы скопировать моментальный снимок для учетной записи хранения и передачи его в хранилище.
- Если вы выполняете восстановление виртуальных машин — единый центр, мы настоятельно рекомендуем использовать разные [учетные записи хранения общего назначения версии 2](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade) чтобы убедиться, что целевой учетной записи хранения не нужно выполнять регулирование. Например каждой виртуальной Машины необходимо иметь учетную запись хранения. Например если восстанавливаются 10 виртуальных машин, используйте 10 разных учетных записей хранения.
- Восстановление на уровне хранилища общего назначения версии 1 (snapshot) будут выполняться за несколько минут, так как моментальный снимок в одну и ту же учетную запись хранения. Восстановление из уровня хранилища общего назначения версии 2 (хранилище) может потребоваться часов. В случаях, когда данные в хранилище общего назначения версии 1, мы рекомендуем использовать [мгновенное восстановление](backup-instant-restore-capability.md) функция восстановление выполнялось быстрее. (Если необходимо восстановить данные из хранилища, затем он займет больше времени.)
- Ограничение на количество дисков на учетную запись хранения является относительно насколько сильно диски, к которым обращаются приложений, выполняющихся на инфраструктуру как услугу (IaaS) виртуальной Машины. В общем случае рекомендуется Если диски 5 – 10 или более в одной учетной записью, балансировки сетевой нагрузки, переместив некоторые диски для разделения учетных записей хранения.

## <a name="backup-costs"></a>Оплата резервного копирования

В отношении виртуальных машин Azure, резервное копирование которых выполняется с помощью службы Azure Backup, действует [прейскурант на использование службы Azure Backup](https://azure.microsoft.com/pricing/details/backup/).

Выставление счетов не начинается до завершения первой успешной архивации. На этом этапе начинается выставление счетов за службу хранилища и защищенные виртуальные машины. Оплачиваемый период длится до тех пор, пока все данные архивации для виртуальной Машины хранятся в хранилище. Если вы остановите защиту виртуальной машины, но данные резервного копирования виртуальной машины остаются в хранилище, выставление счетов продолжится.

Выставление счетов для определенной виртуальной машины прекращается, только если останавливается защита и удаляются все данные резервных копий. Когда защита останавливается и нет активных заданий резервного копирования, размер виртуальной машины во время последнего успешного резервного копирования становится размером защищенного экземпляра, на основе которого выставляется ежемесячный счет.

Вычисление размера защищенных экземпляров основано на *фактическое* размер виртуальной машины. Размер виртуальной Машины является суммой всех данных на виртуальной машине, за исключением временного хранилища. Она основана на фактических данных, который имеет хранятся на дисках данных, не на максимальный поддерживаемый размер каждого диска, подключенного к виртуальной Машине.

Аналогичным образом счет за хранилище резервных копий основан на объем данных, хранящихся в службе архивации Azure, которая представляет собой сумму фактических данных в каждой точке восстановления.

В качестве примера рассмотрим Машину размера A2 — Standard, которая имеет два дополнительных дисков данных размером до 4 ТБ. В следующей таблице показаны фактические данные, хранящиеся на каждом из этих дисков:

**Диск** | **Максимальный размер** | **Присутствующие фактические данные**
--- | --- | ---
Диск ОС | 4095 ГБ | 17 ГБ
Локальный или временный диск | 135 ГБ | 5 ГБ (не учитывается для архивации)
Диск данных 1 | 4095 ГБ | 30 ГБ
Диск данных 2 | 4095 ГБ | 0 ГБ

Фактический размер виртуальной машины в этом случае составляет 17 ГБ + 30 ГБ + 0 ГБ = 47 ГБ. Этот размер защищенного экземпляра (47 ГБ) служит основой для ежемесячного счета. По мере роста объема данных на виртуальной машине, размер защищенного экземпляра используются для изменения выставления счетов для сопоставления.

## <a name="next-steps"></a>Дальнейшие действия

Теперь [подготовки к резервному копированию виртуальной Машины Azure](backup-azure-arm-vms-prepare.md).
