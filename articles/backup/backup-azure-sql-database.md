---
title: Резервное копирование баз данных SQL Server в Azure
description: Узнайте, как выполнить резервное копирование SQL Server в Azure. Здесь также описывается восстановление SQL Server.
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: tutorial
ms.date: 06/18/2019
ms.author: dacurwin
ms.openlocfilehash: 7312821320084c766f5b3357fe64c061df83673b
ms.sourcegitcommit: 3073581d81253558f89ef560ffdf71db7e0b592b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2019
ms.locfileid: "68827645"
---
# <a name="about-sql-server-backup-in-azure-vms"></a>Сведения о резервном копировании SQL Server на виртуальных машинах Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Вы можете создать резервную копию баз данных SQL Server в виртуальных машинах Azure с помощью [Azure Backup](backup-overview.md).

## <a name="backup-process"></a>Процесс резервного копирования

Это решение использует собственные API-интерфейсы SQL для создания резервных копий баз данных SQL.

* После того как вы укажете виртуальную машину SQL Server, которую нужно защитить, и выполните запрос баз данных на ней, служба Azure Backup установит на виртуальную машину расширение резервного копирования рабочих нагрузок с именем `AzureBackupWindowsWorkload` .
* Это расширение состоит из координатора и подключаемого модуля SQL. В то время как координатор отвечает за запуск рабочих процессов для различных операций, таких как настройка резервного копирования, резервное копирование и восстановление, подключаемый модуль отвечает за фактический поток данных.
* Чтобы иметь возможность обнаруживать базы данных на этой виртуальной машине, Azure Backup создает учетную запись `NT SERVICE\AzureWLBackupPluginSvc`. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL. Azure Backup будет использовать учетную запись `NT AUTHORITY\SYSTEM` для обнаружения и запроса баз данных, поэтому эта учетная запись должна соответствовать общедоступному имени входа в SQL. Если вы не создавали виртуальную машину SQL Server из Azure Marketplace, может появиться ошибка **UserErrorSQLNoSysadminMembership**. В этом случае [выполните эти инструкции](backup-azure-sql-database.md).
* Когда вы запустите настройку защиты для выбранных баз данных, служба резервного копирования установит координатор с расписаниями резервного копирования и другими сведениями о политике, которые расширение кэширует локально на виртуальной машине.
* В назначенное время координатор связывается с подключаемым модулем и начинает потоковую передачу данных резервного копирования с сервера SQL с помощью VDI.  
* Подключаемый модуль отправляет данные непосредственно в хранилище Служб восстановления, что устраняет необходимость в промежуточном хранении. Данные зашифрованы и хранятся службой Azure Backup в учетных записях хранения.
* Когда передача данных завершается, координатор подтверждает фиксацию с помощью службы резервного копирования.

  ![Архитектура службы резервного копирования SQL](./media/backup-azure-sql-database/backup-sql-overview.png)

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать, проверьте следующее:

1. Убедитесь, что у вас есть экземпляр SQL Server, работающий в Azure. Вы можете [быстро создать экземпляр SQL Server](../virtual-machines/windows/sql/quickstart-sql-vm-create-portal.md) в marketplace.
2. Просмотрите [рекомендации о функциях](#feature-consideration-and-limitations) и сведения о [поддержке сценариев](#scenario-support).
3. [Ознакомьтесь с часто задаваемыми вопросами об этом сценарии](faq-backup-sql-server.md).

## <a name="scenario-support"></a>Поддержка сценария

**Поддержка** | **Дополнительные сведения**
--- | ---
**Поддерживаемые развертывания** | Поддерживаются виртуальные машины Azure Marketplace SQL и не связанные с Marketplace виртуальные машины (установленный вручную SQL Server).
**Поддерживаемые географические регионы** | Юго-Восточная Австралия (ASE), Восточная Австралия (AE), <br> Южная Бразилия (BRS).<br> Центральная Канада (CNC), Восточная Канада (CE),<br> Юго-Восточная Азия (SEA), Восточная Азия (EA), <br> восточная часть США (EUS), восточная часть США 2 (EUS2), центрально-западная часть США (WCUS), западная часть США (WUS), западная часть США 2 (WUS 2), центрально-северная часть США (NCUS), центральная часть США (CUS), центрально-южная часть США (SCUS), <br> Центральная Индия (INC), Южная Индия (INS), <br> Восточная Япония (JPE), Западная Япония (JPW), <br> Республика Корея, центральный регион (KRC), Республика Корея, южный регион (KRS), <br> Северная Европа (NE), Западная Европа, <br> южная часть Соединенного Королевства (UKS), западная часть Соединенного Королевства (UKW). <br> US Gov (Аризона), US Gov (Вирджиния), US Gov (Техас), центральный регион US DoD, восточный регион US DoD
**Поддерживаемые операционные системы** | Windows Server 2016, Windows Server 2012 R2 и Windows Server 2012<br/><br/> Linux в настоящее время не поддерживается.
**Поддерживаемые версии SQL Server** | SQL Server 2017, как описано [здесь](https://support.microsoft.com/lifecycle/search?alpha=SQL%20server%202017), SQL Server 2016 с пакетами обновлений, как описано [здесь](https://support.microsoft.com/lifecycle/search?alpha=SQL%20server%202016%20service%20pack), SQL Server 2014, SQL Server 2012.<br/><br/> Enterprise, Standard, Web, Developer, Express.
**Поддерживаемые версии .NET** | На виртуальной машине установлен .NET Framework 4.5.2 или более поздняя версия.

### <a name="support-for-sql-server-2008-and-sql-server-2008-r2"></a>Поддержка SQL Server 2008 и SQL Server 2008 R2

Недавно Azure Backup анонсировала поддержку [EOS SQL Server](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-server-2008-eos-extend-support) — SQL Server 2008 и SQL Server 2008 R2. Сейчас это решение доступно в режиме предварительного доступа для EOS SQL Server и оно поддерживает следующую конфигурацию:

1. SQL Server 2008 и SQL Server 2008 R2 на базе Windows 2008 R2 SP1
2. На виртуальную машину следует установить .NET Framework 4.5.2 или более позднюю версию.
3. Резервное копирование для экземпляра отказоустойчивого кластера и зеркальных баз данных отсутствует.

До момента пока эта функция не станет общедоступной, с пользователей не будет взиматься плата за ее использование. Все другие [Рекомендации и ограничения касательно функций](#feature-consideration-and-limitations) также применяются к этим версиям. См. [предварительные требования](backup-sql-server-database-azure-vms.md#prerequisites) перед настройкой защиты на серверах SQL Server 2008 и 2008 R2, которые включают в себя параметр [раздел реестра](backup-sql-server-database-azure-vms.md#add-registry-key-to-enable-registration) (этот шаг необязателен при включенной функции общедоступности).


## <a name="feature-consideration-and-limitations"></a>Рекомендации и ограничения касательно функций

- Резервное копирование SQL Server можно настроить на портале Azure или в **PowerShell**. Интерфейс командной строки не поддерживается.
- Решение поддерживается на обоих типах [развертываний](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-deployment-model) — виртуальные машины Azure Resource Manager и классические виртуальные машины.
- Виртуальной машине, на которой выполняется SQL Server, необходимо подключение к Интернету для доступа к общедоступным IP-адресам Azure.
- **Экземпляр отказоустойчивого кластера (FCI)** SQL Server и экземпляр отказоустойчивого кластера Always On SQL Server не поддерживаются.
- Операции создания резервной копии и восстановления для зеркальных баз данных и моментальных снимков базы данных не поддерживаются.
- Не используйте несколько решений для резервного копирования автономного экземпляра SQL Server или группы доступности SQL Always On, так как это может привести к сбою резервного копирования.
- Резервное копирование двух узлов группы доступности по отдельности с использованием одинаковых или разных решений также может привести к сбою резервного копирования.
- Для **баз данных только для чтения** Azure Backup поддерживает только полные резервные копии и полные резервные копии только для копирования.
- Базу данных с большим числом файлов невозможно защитить. Максимальное число поддерживаемых файлов — **около 1000**.  
- Вы можете создать резервные копии **около 2000** баз данных SQL Server в хранилище. Если у вас больше баз данных, можно создать несколько хранилищ.
- Вы можете настроить резервное копирование до **50** баз данных за один раз. Это ограничение помогает оптимизировать нагрузку резервного копирования.
- Поддерживаются базы данных размером до **2 ТБ**. При работе с базами больших размеров могут возникнуть проблемы с производительностью.
- Чтобы понять, сколько баз данных можно защитить на одном сервере, необходимо учитывать такие факторы, как пропускная способность, размер виртуальной машины, частота резервного копирования, размер базы данных и т. д. [Скачайте](http://download.microsoft.com/download/A/B/5/AB5D86F0-DCB7-4DC3-9872-6155C96DE500/SQL%20Server%20in%20Azure%20VM%20Backup%20Scale%20Calculator.xlsx) планировщик ресурсов, предоставляющий сведения о приблизительном количестве баз данных, которое можно разместить на каждом сервере. Количество рассчитывается на основе ресурсов виртуальных машин и политики резервного копирования.
- В случае наличия групп доступности резервное копирование выполняется с разных узлов на основе нескольких факторов. Поведение резервного копирования для группы доступности представлено ниже.

### <a name="back-up-behavior-in-case-of-always-on-availability-groups"></a>Поведение создания резервной копии при наличии групп доступности Always On

Мы советуем, чтобы резервное копирование настраивалось только на одном узле группы доступности. Резервное копирование всегда должно быть настроено в одном регионе с основным узлом. Другими словами, необходимо, чтобы основной узел всегда присутствовал в регионе, в котором вы настраиваете резервное копирование. Если все узлы группы доступности находятся в одном регионе с настраиваемым резервным копированием, то об этом можно не беспокоиться.

**Группа доступности перехода в другой регион**
- Независимо от параметров резервного копирования резервные копии не создаются из узлов, которые не находятся в том же регионе, где настроена архивация. Так как резервное копирование между регионами не поддерживается. Если у вас есть только 2 узла и второстепенный узел в другом регионе; в этом случае резервные копии будут продолжать выполняться с основного узла (если только не установлен параметр резервного копирования — "только вторичный узел").
- В случае отработки отказа в регионе, отличном от того, в котором настроено резервное копирование, архивация на узлах в таком регионе завершится сбоем.

В зависимости от установленного параметра резервного копирования и типов резервных копий (полная, разностная, резервная копия журналов, полная резервная копия только для копирования) резервные копии создаются с определенного узла (первичного или вторичного).

- **Параметр резервного копирования: первичный узел**

**Тип резервного копирования** | **Node**
    --- | ---
    Полное | Первичная
    Разностная | Первичная
    Журнал |  Первичная
    Полная резервная копия (только копирование) |  Первичная

- **Параметр резервного копирования: только вторичный узел**

**Тип резервного копирования** | **Node**
--- | ---
Полное | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

- **Параметр резервного копирования: вторичный узел**

**Тип резервного копирования** | **Node**
--- | ---
Полное | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

- **Без параметров резервного копирования**

**Тип резервного копирования** | **Node**
--- | ---
Полное | Первичная
Разностная | Первичная
Журнал |  Вторичная
Полная резервная копия (только копирование) |  Вторичная

## <a name="set-vm-permissions"></a>Настройка разрешений виртуальной машины

  При запуске обнаружения в SQL Server Azure Backup выполнит следующие действия.

* Добавляет расширение AzureBackupWindowsWorkload.
* Чтобы обнаруживать базы данных на виртуальной машине, Azure Backup создает учетную запись NT SERVICE\AzureWLBackupPluginSvc. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL.
* Для предоставления баз данных, запущенных на виртуальной машине, Azure Backup использует учетную запись NT AUTHORITY\SYSTEM. Эта учетная запись должна быть общедоступной для входа в SQL.

Если вы не создавали виртуальную машину SQL Server в Azure Marketplace или если вы используете SQL 2008 и SQL 2008 R2, может появиться ошибка **UserErrorSQLNoSysadminMembership**.

Сведения о предоставленных разрешениях для **SQL 2008** и **SQL 2008 R2** используемых в Windows 2008 R2, см. в [статье](#give-sql-sysadmin-permissions-for-sql-2008-and-sql-2008-r2).

Для всех остальных версий следует исправить разрешения с помощью следующих шагов.

  1. Войдите в SQL Server Management Studio (SSMS) с помощью учетной записи, имеющей разрешение sysadmin SQL Server. Если вам не требуются специальные разрешения, можно использовать проверку подлинности Windows.
  2. На сервере SQL Server последовательно откройте папки **Security (Безопасность) и Logins (Имена входа)** .

      ![Открытие папки "Безопасность/Имена для входа" для просмотра учетных записей](./media/backup-azure-sql-database/security-login-list.png)

  3. Щелкните правой кнопкой мыши папку **Имена для входа** и выберите **Создать имя для входа**. В меню **Создание имени входа** выберите **Поиск**.

      ![Выбор "Найти" в диалоговом окне "Login - New" (Создание имени для входа)](./media/backup-azure-sql-database/new-login-search.png)

  4. Учетная запись виртуальной службы Windows **NT SERVICE\AzureWLBackupPluginSvc** была создана во время регистрации виртуальной машины и обнаружения баз данных SQL. Введите имя учетной записи, как показано в поле **Введите имя объекта**. Выберите **Проверить имена**, чтобы разрешить имя. Последовательно выберите **ОК**.

      ![Выбор "Проверить имена" для разрешения имени неизвестной службы](./media/backup-azure-sql-database/check-name.png)

  5. Убедитесь, что в качестве **роли сервера** выбрана роль **sysadmin**. Последовательно выберите **ОК**. Теперь должны существовать необходимые разрешения.

      ![Убедитесь, что для сервера выбрана роль sysadmin.](./media/backup-azure-sql-database/sysadmin-server-role.png)

  6. Теперь свяжите базу данных с хранилищем Служб восстановления. В списке **Защищенные серверы** на портале Azure щелкните правой кнопкой мыши сервер, на котором произошла ошибка, и выберите **Повторно обнаружить базы данных**.

      ![Проверка наличия у сервера соответствующих разрешений](./media/backup-azure-sql-database/check-erroneous-server.png)

  7. Проверьте ход выполнения в области **Уведомления**. Когда выбранные базы данных будут найдены, появится сообщение об успешном завершении.

      ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

> [!NOTE]
> Если в среде SQL Server установлено несколько экземпляров SQL Server, то необходимо добавить разрешение sysadmin для учетной записи **NT Service\AzureWLBackupPluginSvc** для всех этих экземпляров.

### <a name="give-sql-sysadmin-permissions-for-sql-2008-and-sql-2008-r2"></a>Присвоение разрешений администратора SQL в SQL 2008 и SQL 2008 R2

Добавьте в экземпляр SQL Server имена входа **NT AUTHORITY\SYSTEM** и **NT Service\AzureWLBackupPluginSvc**.

1. Перейдите к экземпляру SQL Server в обозревателе объектов.
2. Перейдите в раздел "Безопасность -> Имена входа"
3. Щелкните правой кнопкой мыши "Имена входа", и выберите *Создать имя входа...*

    ![Создание имени входа с помощью SSMS](media/backup-azure-sql-database/sql-2k8-new-login-ssms.png)

4. Перейдите на вкладку "Общие" и в качестве имени входа введите **NT AUTHORITY\SYSTEM**.

    ![Имя входа для SSMS](media/backup-azure-sql-database/sql-2k8-nt-authority-ssms.png)

5. Перейдите к *Роли сервера* и выберите такие роли, как *общедоступная* и *администратор*.

    ![Выбор ролей в SSMS](media/backup-azure-sql-database/sql-2k8-server-roles-ssms.png)

6. Перейдите в раздел *Состояние*. *Предоставить* разрешение на подключение к ядру СУБД и вход как *Включено*.

    ![Предоставление разрешений в SSMS](media/backup-azure-sql-database/sql-2k8-grant-permission-ssms.png)

7. Нажмите кнопку ОК.
8. Чтобы добавить имя для входа NT Service\AzureWLBackupPluginSvc в экземпляр SQL Server, повторите ту же последовательность шагов (1 - 7 приведенных выше). Если имя для входа уже существует, убедитесь, что ему присвоена роль администратора сервера и в разделе состояния этому имени предоставлено разрешение на подключение к ядру СУБД и вход в качестве включено.
9. После предоставления разрешений на портале следует выполните **Re-discover DBs** (Повторное обнаружение баз данных). Хранилище **->** резервного копирования инфраструктуры **->** рабочей нагрузки в VM Azure.

    ![Повторное обнаружение баз данных на портале Azure](media/backup-azure-sql-database/sql-rediscover-dbs.png)

Кроме этого, можно автоматизировать раздачу разрешений путем выполнения следующих команд PowerShell в режиме администратора. По умолчанию в качестве имени экземпляра устанавливается значение MSSQLSERVER. Если возникнет необходимость, то в скрипте можно изменить имя экземпляра если изменить его аргумент.

```powershell
param(
    [Parameter(Mandatory=$false)]
    [string] $InstanceName = "MSSQLSERVER"
)
if ($InstanceName -eq "MSSQLSERVER")
{
    $fullInstance = $env:COMPUTERNAME   # In case it is the default SQL Server Instance
}
else
{
    $fullInstance = $env:COMPUTERNAME + "\" + $InstanceName   # In case of named instance
}
try
{
    sqlcmd.exe -S $fullInstance -Q "sp_addsrvrolemember 'NT Service\AzureWLBackupPluginSvc', 'sysadmin'" # Adds login with sysadmin permission if already not available
}
catch
{
    Write-Host "An error occurred:"
    Write-Host $_.Exception|format-list -force
}
try
{
    sqlcmd.exe -S $fullInstance -Q "sp_addsrvrolemember 'NT AUTHORITY\SYSTEM', 'sysadmin'" # Adds login with sysadmin permission if already not available
}
catch
{
    Write-Host "An error occurred:"
    Write-Host $_.Exception|format-list -force
}
```


## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о резервном копировании баз данных SQL Server см. в [этой статье](backup-sql-server-database-azure-vms.md).
* Дополнительные сведения о восстановлении резервных копий баз данных SQL Server см. в [этой статье](restore-sql-database-azure-vm.md).
* Дополнительные сведения об управлении резервными копиями баз данных SQL Server см. в [этой статье](manage-monitor-sql-database-backup.md).
