---
title: Мониторинг Azure Backup с помощью Azure Monitor
description: Отслеживайте Azure Backup рабочие нагрузки и создавайте пользовательские предупреждения с помощью Azure Monitor.
ms.topic: conceptual
ms.date: 06/04/2019
ms.assetid: 01169af5-7eb0-4cb0-bbdb-c58ac71bf48b
ms.openlocfilehash: 66417071190fa45a746ce0b80a9de12968198bda
ms.sourcegitcommit: 653e9f61b24940561061bd65b2486e232e41ead4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2019
ms.locfileid: "74278268"
---
# <a name="monitor-at-scale-by-using-azure-monitor"></a>Мониторинг в масштабе с помощью Azure Monitor

Azure Backup предоставляет [встроенные возможности мониторинга и оповещения](backup-azure-monitoring-built-in-monitor.md) в хранилище служб восстановления. Эти возможности доступны без какой бы то ни было дополнительной инфраструктуры управления. Но эта встроенная служба ограничена в следующих сценариях:

- Мониторинг данных из нескольких хранилищ служб восстановления между подписками
- Если предпочтительный канал уведомления *не* является адресом электронной почты
- Если пользователям требуются оповещения для других сценариев
- Если вы хотите просмотреть сведения из локального компонента, например System Center Data Protection Manager в Azure, который не отображается в [**заданиях архивации**](backup-azure-monitoring-built-in-monitor.md#backup-jobs-in-recovery-services-vault) или [**оповещениях архивации**](backup-azure-monitoring-built-in-monitor.md#backup-alerts-in-recovery-services-vault) .

## <a name="using-log-analytics-workspace"></a>Использование рабочей области Log Analytics

> [!NOTE]
> Данные из резервных копий виртуальных машин Azure, агент Azure Backup, Data Protection Manager System Center, резервное копирование SQL в виртуальных машинах Azure и резервные копии файлов Azure создаются в рабочей области Log Analytics с помощью параметров диагностики. Поддержка Microsoft Azure Backup Server (MABS) будет добавлена в ближайшее время

Для мониторинга и отчета в масштабе требуются возможности двух служб Azure. *Параметры диагностики* отправляют данные из нескольких Azure Resource Manager ресурсов в другой ресурс. *Log Analytics* создает настраиваемые оповещения, в которых можно использовать группы действий для определения других каналов уведомлений.

В следующих разделах подробно описано, как использовать Log Analytics для мониторинга Azure Backup в масштабе.

### <a name="configure-diagnostic-settings"></a>Настройка параметров диагностики

Azure Resource Manager ресурсы, такие как хранилище служб восстановления, записывают сведения о запланированных операциях и активируемых пользователем операциях в виде диагностических данных.

В разделе Мониторинг выберите **параметры диагностики** и укажите целевой объект для диагностических данных хранилища служб восстановления.

![Параметр диагностики для хранилища служб восстановления, нацеливание на Log Analytics](media/backup-azure-monitoring-laworkspace/diagnostic-setting-new.png)

Вы можете выбрать рабочую область Log Analytics из другой подписки. Чтобы отслеживать хранилища в рамках одной подписки в одном месте, выберите одну и ту же рабочую область Log Analytics для нескольких хранилищ служб восстановления. Чтобы настроить канал для всех сведений, связанных с Azure Backup, в рабочую область Log Analytics, выберите пункт **конкретные ресурсы** в появившемся переключателе и выберите следующие события: **кореазуребаккуп**, **аддоназуребаккупжобс**, **аддоназуребаккупалертс**, **аддоназуребаккупполици**, **AddonAzureBackupStorage**, **AddonAzureBackupProtectedInstance**. Дополнительные сведения о настройке параметров необязательной диагностики см. в [этой статье](https://aka.ms/AA6jkus) .

> [!IMPORTANT]
> После завершения настройки необходимо подождать 24 часа, чтобы начальная отправка данных завершилась. После первоначальной отправки данных все события помещаются, как описано далее в этой статье, в [разделе Frequency](#diagnostic-data-update-frequency).

### <a name="deploy-a-solution-to-the-log-analytics-workspace"></a>Развертывание решения в рабочей области Log Analytics

> [!IMPORTANT]
> Мы выпустили обновленный [шаблон](https://azure.microsoft.com/resources/templates/101-backup-la-reporting/) с несколькими представлениями для мониторинга на основе La и создания отчетов в Azure Backup. Обратите внимание, что пользователи, которые использовали [предыдущее решение](https://azure.microsoft.com/resources/templates/101-backup-oms-monitoring/) , продолжают видеть их в рабочих областях даже после развертывания нового решения. Однако старое решение может предоставить неточные результаты из-за незначительных изменений схемы. Поэтому пользователям необходимо развернуть новый шаблон.

После того как данные находятся в Log Analytics рабочей области, [разверните шаблон GitHub](https://azure.microsoft.com/resources/templates/101-backup-la-reporting/) , чтобы log Analytics визуализировать данные. Чтобы правильно определить рабочую область, убедитесь, что ей назначена та же группа ресурсов, имя рабочей области и расположение рабочей области. Затем установите этот шаблон в рабочей области.

### <a name="view-azure-backup-data-by-using-log-analytics"></a>Просмотр Azure Backup данных с помощью Log Analytics

После развертывания шаблона решение для мониторинга и создания отчетов в Azure Backup будет отображаться в области сводки рабочей области. Чтобы перейти к сводке, выполните один из следующих вариантов.

- **Azure Monitor**. в разделе **Insights** выберите **Дополнительно** и выберите соответствующую рабочую область.
- **Log Analytics рабочие области**: выберите соответствующую рабочую область, а затем в разделе **Общие**выберите **Сводная сводка по рабочей области**.

![Плитки Log Analytics мониторинг и отчеты](media/backup-azure-monitoring-laworkspace/la-azurebackup-overview-dashboard.png)

При выборе любого из плиток обзора можно просмотреть дополнительные сведения. Вот некоторые из отчетов, которые вы увидите:

- Задания резервного копирования, не относящиеся к журналу

   ![Log Analytics графиков для заданий резервного копирования](media/backup-azure-monitoring-laworkspace/la-azurebackup-backupjobsnonlog.png)

- Оповещения из резервной копии ресурсов Azure

   ![Диаграмма Log Analytics для заданий восстановления](media/backup-azure-monitoring-laworkspace/la-azurebackup-alertsazure.png)

Аналогичным образом, щелкнув другие плитки, вы сможете просматривать отчеты о заданиях восстановления, облачном хранилище, элементах архивации, оповещениях из резервной копии локальных ресурсов и заданиях резервного копирования журналов.

Эти графы предоставляются с помощью шаблона. При необходимости можно изменить графы или добавить дополнительные диаграммы.

### <a name="create-alerts-by-using-log-analytics"></a>Создание предупреждений с помощью Log Analytics

В Azure Monitor можно создавать собственные оповещения в Log Analytics рабочей области. В рабочей области вы используете *группы действий Azure* , чтобы выбрать предпочтительный механизм уведомления.

> [!IMPORTANT]
> Сведения о затратах на создание этого запроса см. в разделе [цены на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/).

Выберите любой из диаграмм, чтобы открыть раздел **журналы** рабочей области log Analytics. В разделе **журналы** измените запросы и создайте оповещения для них.

![Создание оповещения в рабочей области Log Analytics](media/backup-azure-monitoring-laworkspace/la-azurebackup-customalerts.png)

При выборе **нового правила генерации оповещений**открывается страница Azure Monitor создание оповещений, как показано на следующем рисунке. Ресурс уже помечен как Рабочая область Log Analytics, и предоставляется интеграция группы действий.

![Страница создания оповещений Log Analytics](media/backup-azure-monitoring-laworkspace/inkedla-azurebackup-createalert.jpg)

#### <a name="alert-condition"></a>Условие предупреждения

Определяющая характеристика предупреждения является его условием активации. Выберите **условие** для автоматической загрузки запроса Kusto на странице **журналы** , как показано на следующем рисунке. Здесь можно изменить условие в соответствии со своими потребностями. Дополнительные сведения см. в разделе [примеры запросов Kusto](#sample-kusto-queries).

![Настройка условия оповещения](media/backup-azure-monitoring-laworkspace/la-azurebackup-alertlogic.png)

При необходимости можно изменить запрос Kusto. Выберите пороговое значение, точку и частоту. Пороговое значение определяет, когда будет вызвано предупреждение. Период — это окно времени, в котором выполняется запрос. Например, если пороговое значение больше 0, точка составляет 5 минут, а частота составляет 5 минут, то правило выполняет запрос каждые 5 минут, просматривая предыдущие 5 минут. Если число результатов больше 0, вы получаете уведомления по выбранной группе действий.

#### <a name="alert-action-groups"></a>Группы действий оповещений

Используйте группу действий для указания канала уведомления. Чтобы просмотреть доступные механизмы уведомления, в разделе **группы действий**выберите **создать**.

![Доступные механизмы уведомления в окне "Добавление группы действий"](media/backup-azure-monitoring-laworkspace/LA-AzureBackup-ActionGroup.png)

Вы можете удовлетворить все требования к предупреждениям и мониторингу только Log Analytics или использовать Log Analytics для дополнения встроенных уведомлений.

Дополнительные сведения см. в статьях [Создание, просмотр и Управление оповещениями журнала с помощью Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-log) и [Создание групп действий в портал Azure и управление ими](https://docs.microsoft.com/azure/azure-monitor/platform/action-groups).

### <a name="sample-kusto-queries"></a>Примеры запросов Kusto

Графы по умолчанию позволяют Kusto запросы для основных сценариев, на которых можно создавать предупреждения. Кроме того, можно изменить запросы, чтобы получить данные, на которые вы хотите получать оповещения. Вставьте приведенные ниже примеры запросов Kusto на странице **журналы** , а затем создайте оповещения для запросов.

- Все успешные задания резервного копирования

    ````Kusto
    AddonAzureBackupJobs
    | where JobOperation=="Backup"
    | where JobStatus=="Completed"
    ````

- Все задания резервного копирования, завершившиеся сбоем

    ````Kusto
    AddonAzureBackupJobs
    | where JobOperation=="Backup"
    | where JobStatus=="Failed"
    ````

- Все успешные задания резервного копирования виртуальных машин Azure

    ````Kusto
    AddonAzureBackupJobs
    | where JobOperation=="Backup"
    | where JobStatus=="Completed"
    | join kind=inner
    (
        CoreAzureBackup
        | where OperationName == "BackupItem"
        | where BackupItemType=="VM" and BackupManagementType=="IaaSVM"
        | distinct BackupItemUniqueId, BackupItemFriendlyName
    )
    on BackupItemUniqueId
    ````

- Все успешные задания резервного копирования журналов SQL

    ````Kusto
    AddonAzureBackupJobs
    | where JobOperation=="Backup" and JobOperationSubType=="Log"
    | where JobStatus=="Completed"
    | join kind=inner
    (
        CoreAzureBackup
        | where OperationName == "BackupItem"
        | where BackupItemType=="SQLDataBase" and BackupManagementType=="AzureWorkload"
        | distinct BackupItemUniqueId, BackupItemFriendlyName
    )
    on BackupItemUniqueId
    ````

- Все успешные задания агента Azure Backup

    ````Kusto
    AddonAzureBackupJobs
    | where JobOperation=="Backup"
    | where JobStatus=="Completed"
    | join kind=inner
    (
        CoreAzureBackup
        | where OperationName == "BackupItem"
        | where BackupItemType=="FileFolder" and BackupManagementType=="MAB"
        | distinct BackupItemUniqueId, BackupItemFriendlyName
    )
    on BackupItemUniqueId
    ````

### <a name="diagnostic-data-update-frequency"></a>Частота обновления диагностических данных

Диагностические данные из хранилища переводятся в рабочую область Log Analytics с некоторой задержкой. Каждое событие прибывает в Log Analytics рабочей области с *20 до 30 минут* после того, как она будет отправлена из хранилища служб восстановления. Ниже приведены дополнительные сведения о задержке.

- Во всех решениях встроенные предупреждения службы архивации помещаются сразу после их создания. Они обычно отображаются в рабочей области Log Analytics через 20 – 30 минут.
- Во всех решениях задания резервного копирования по запросу и задания восстановления помещаются сразу после *завершения*.
- Для всех решений, кроме резервного копирования SQL, запланированные задания резервного копирования помещаются сразу после *завершения*.
- Для резервного копирования SQL, поскольку резервное копирование журналов может происходить каждые 15 минут, сведения обо всех завершенных запланированных заданиях архивации, включая журналы, отправляются в пакет и отправляются каждые 6 часов.
- Во всех решениях другие сведения, такие как элемент резервного копирования, политика, точки восстановления, хранилище и т. д., помещаются по крайней мере *один раз в день.*
- Изменение конфигурации резервного копирования (например, изменение политики или политики изменения) активирует принудительную отправку всех связанных данных резервных копий.

## <a name="using-the-recovery-services-vaults-activity-logs"></a>Использование журналов действий хранилища служб восстановления

> [!CAUTION]
> Следующие действия применимы только к *резервным копиям виртуальных машин Azure.* Эти действия нельзя использовать для таких решений, как агент Azure Backup, резервное копирование SQL в Azure или служба файлов Azure.

Кроме того, журналы действий можно использовать для получения уведомлений о таких событиях, как успешная архивация. Для начала выполните следующие действия.

1. Войдите на портал Azure.
1. Откройте соответствующее хранилище служб восстановления.
1. В свойствах хранилища откройте раздел **Журнал действий** .

Чтобы найти соответствующий журнал и создать оповещение, выполните следующие действия.

1. Убедитесь, что вы получаете журналы действий для успешного резервного копирования, применив фильтры, показанные на следующем рисунке. При необходимости измените значение **TimeSpan** , чтобы просмотреть записи.

   ![Фильтрация для поиска журналов действий для резервных копий виртуальных машин Azure](media/backup-azure-monitoring-laworkspace/activitylogs-azurebackup-vmbackups.png)

1. Выберите имя операции, чтобы просмотреть соответствующие сведения.
1. Выберите **новое правило генерации оповещений** , чтобы открыть страницу **Создание правила** .
1. Создайте оповещение, выполнив действия, описанные в разделе [Создание, просмотр и Управление оповещениями журнала действий с помощью Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/platform/alerts-activity-log).

   ![Новое правило генерации оповещений](media/backup-azure-monitoring-laworkspace/new-alert-rule.png)

Здесь ресурс является хранилищем служб восстановления. Повторите те же действия для всех хранилищ, в которых необходимо получать уведомления с помощью журналов действий. Условие не будет иметь порог, точку или частоту, так как это оповещение основано на событиях. После создания соответствующего журнала действий создается предупреждение.

## <a name="using-log-analytics-to-monitor-at-scale"></a>Использование Log Analytics для мониторинга в масштабе

Вы можете просматривать все оповещения, созданные на основе журналов действий и Log Analytics рабочих областей в Azure Monitor. Просто откройте панель **оповещения** слева.

Хотя вы можете получать уведомления с помощью журналов действий, мы настоятельно рекомендуем использовать Log Analytics, а не журналы действий для мониторинга в масштабе. Вот почему:

- **Ограниченные сценарии**: уведомления с помощью журналов действий применяются только к резервным КОПИЯМ виртуальных машин Azure. Уведомления должны быть настроены для каждого хранилища служб восстановления.
- **Определение соответствия**: запланированное действие резервного копирования не соответствует последнему определению журналов действий. Вместо этого он выполняет согласование с [журналами ресурсов](https://docs.microsoft.com/azure/azure-monitor/platform/resource-logs-collect-workspace#what-you-can-do-with-resource-logs-in-a-workspace). Такое выравнивание приводит к непредвиденным последствиям при изменении данных, передаваемых по каналу журнала действий.
- **Проблемы с каналом журнала действий**: в хранилищах служб восстановления журналы действий, которые передаются из Azure Backup, следуют за новой моделью. К сожалению, это изменение влияет на создание журналов действий в Azure для государственных организаций, Azure для Германии и Azure для Китая. Если пользователи этих облачных служб создают или настраивают оповещения из журналов действий в Azure Monitor, предупреждения не запускаются. Кроме того, во всех общедоступных регионах Azure, если пользователь [собирает журналы действий служб восстановления в log Analytics рабочей области](https://docs.microsoft.com/azure/azure-monitor/platform/collect-activity-logs), эти журналы не отображаются.

Используйте рабочую область Log Analytics для мониторинга и оповещения в масштабе для всех рабочих нагрузок, защищенных Azure Backup.

## <a name="next-steps"></a>Дополнительная информация

Сведения о создании настраиваемых запросов см. в разделе [log Analytics Data Model](backup-azure-log-analytics-data-model.md).
