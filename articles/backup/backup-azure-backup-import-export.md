---
title: 'Azure Backup: автономное резервное копирование и начальное заполнение с помощью службы "Импорт и экспорт Azure"'
description: Узнайте, как служба архивации Azure позволяет отправлять данные с помощью службы импорта и экспорта Azure без использования сети. В этой статье описывается автономное заполнение начальных резервных копий данных с помощью службы импорта и экспорта Azure.
services: backup
author: saurabhsensharma
manager: shivamg
ms.service: backup
ms.topic: conceptual
ms.date: 05/17/2018
ms.author: saurse
ms.openlocfilehash: b6f0ce1939b2a78ca191d2feb0140506d130b9b0
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60648419"
---
# <a name="offline-backup-workflow-in-azure-backup"></a>Автономное резервное копирование в службе архивации Azure
В службу архивации Azure встроено несколько эффективных методов, которые позволяют экономить затраты на сеть и хранилище во время передачи начальных полных резервных копий данных в Azure. Обычно при этом выполняется передача больших объемов данных. Служба Azure Backup может использовать диски для передачи автономных резервных копий данных в Azure в рамках автономного заполнения.

Этот процесс службы Azure Backup тесно интегрирован со [службой импорта и экспорта Azure](../storage/common/storage-import-export-service.md), что позволяет передавать данные начальной резервной копии в Azure с помощью дисков. Если размер начальных резервных копий, которые нужно передать по сети с большой задержкой и низкой пропускной способностью, составляет несколько терабайт, автономное заполнение можно использовать для отправки начальной резервной копии на одном или нескольких жестких дисках в центр обработки данных Azure. На следующем рисунке показана схема рабочего процесса.

  ![Схема рабочего процесса автономного импорта](./media/backup-azure-backup-import-export/offlinebackupworkflowoverview.png)

Процесс автономного резервного копирования включает следующие шаги:

1. Вместо отправки по сети данные резервной копии записываются в промежуточное расположение.
2. С помощью служебной программы AzureOfflineBackupDiskPrep данные из промежуточного расположения записываются на один или несколько дисков SATA.
3. В рамках подготовительной работы программа AzureOfflineBackupDiskPrep создает задание импорта Azure. Отправьте диски SATA в ближайший центр обработки данных Azure и создайте ссылку на задание импорта для привязки к действиям.
4. В центре обработки данных Azure данные с дисков копируются в учетную запись хранилища Azure.
5. Служба Azure Backup копирует данные резервной копии из учетной записи хранилища в хранилище служб восстановления, при этом создается расписание для добавочных резервных копий.

## <a name="supported-configurations"></a>Поддерживаемые конфигурации 
Автономное резервное копирование поддерживается следующими функциями и рабочими нагрузками службы Azure Backup.

> [!div class="checklist"]
> * Резервное копирование файлов и папок с помощью агента служб восстановления Microsoft Azure (MARS), также называемого агентом Azure Backup. 
> * Резервное копирование всех рабочих нагрузок и файлов с помощью System Center Data Protection Manager (SC DPM). 
> * Резервное копирование всех рабочих нагрузок и файлов с помощью Microsoft Azure Backup Server. <br/>

   > [!NOTE]
   > Автономное резервное копирование не поддерживается для резервных копий состояния системы, создаваемых с помощью агента Azure Backup. 

[!INCLUDE [backup-upgrade-mars-agent.md](../../includes/backup-upgrade-mars-agent.md)]

## <a name="prerequisites"></a>Технические условия

  > [!NOTE]
  > Следующие предварительные требования и рабочий процесс применяются только к автономному резервному копированию файлов и папок с использованием [последней версии агента MARS](https://aka.ms/azurebackup_agent). См. дополнительные сведения о [выполнении автономного резервного копирования рабочих нагрузок с использованием System Center DPM или сервера Azure Backup Server](backup-azure-backup-server-import-export-.md). 

Перед запуском рабочего процесса автономного резервного копирования сделайте следующее: 
* Создайте [хранилище служб восстановления](backup-azure-recovery-services-vault-overview.md). См. дополнительные сведения о [создании хранилища](tutorial-backup-windows-server-to-azure.md#create-a-recovery-services-vault).
* Убедитесь, что на сервере Windows Server или клиенте Windows установлена только [последняя версия агента Azure Backup](https://aka.ms/azurebackup_agent) (если применимо) и что компьютер зарегистрирован в хранилище служб восстановления.
* На компьютере с агентом Azure Backup необходимо установить Azure PowerShell 3.7.0. Рекомендуем скачать и [установить Azure PowerShell версии 3.7.0](https://github.com/Azure/azure-powershell/releases/tag/v3.7.0-March2017).
* На компьютере, где выполняется агент Azure Backup, необходимо установить Microsoft Edge или Internet Explorer 11, а также включить JavaScript. 
* Создайте учетную запись хранилища Azure в той же подписке, что и хранилище служб восстановления. 
* Убедитесь, что у вас есть [необходимые разрешения](../active-directory/develop/howto-create-service-principal-portal.md) на создание приложения Azure Active Directory. Рабочий процесс автономного резервного копирования создает приложение Azure Active Directory в подписке, связанной с учетной записью хранилища Azure. Задача приложения — предоставить службе Azure Backup защищенный ограниченный доступ к службе импорта Azure, требуемый для выполнения рабочего процесса автономного резервного копирования. 
* Зарегистрируйте поставщик ресурсов Microsoft.ImportExport в подписке, содержащей учетную запись хранилища Azure. Чтобы зарегистрировать поставщик ресурсов, сделайте следующее:
    1. В главном меню выберите **Подписки**.
    2. Если у вас есть несколько подписок, выберите ту, которая используется для автономного резервного копирования. Если используется одна подписка, она будет отображена.
    3. В меню подписки выберите **Поставщики ресурсов**, чтобы просмотреть список поставщиков.
    4. Прокрутите список поставщиков вниз до Microsoft.ImportExport. Если параметр Status имеет значение NotRegistered, нажмите **Зарегистрировать**.
    ![Регистрация поставщика ресурсов](./media/backup-azure-backup-import-export/registerimportexport.png)
* Создано промежуточное расположение. Это может быть сетевая папка или дополнительный диск на сервере, внутренний или внешний, на котором доступно достаточно пространства для хранения начальной копии. Например, если нужно создать резервную копию файлового сервера размером 500 ГБ, убедитесь, что промежуточное расположение имеет не менее 500 ГБ свободного места. (Хотя фактически использованный объем будет меньшим.)
* При отправке дисков в Azure используйте только 2,5-дюймовые накопители SSD, а также 2,5-дюймовые или 3,5 дюймовые внутренние жесткие диски SATA II или III. Можно использовать жесткие диски емкостью до 10 ТБ. Список поддерживаемых дисков см. в [документации по службе импорта и экспорта Azure](../storage/common/storage-import-export-requirements.md#supported-hardware).
* Диски SATA должны быть подключены к компьютеру (*компьютер копирования*), на котором выполняется копирование данных резервной копии из *промежуточного расположения* на диски SATA. На *компьютере копирования* должно быть включено средство BitLocker.

## <a name="workflow"></a>Рабочий процесс
В этом разделе описан рабочий процесс автономного резервного копирования, выполняемый для отправки данных в центр обработки данных Azure и службу хранилища Azure. См. дополнительные сведения о [службе импорта и ее функциях](../storage/common/storage-import-export-service.md).

## <a name="initiate-offline-backup"></a>Запуск автономного резервного копирования
1. Когда вы создаете расписание для резервного копирования на агенте MARS, отображается следующий экран.

    ![Экран импорта](./media/backup-azure-backup-import-export/offlinebackup_inputs.png)

   Ниже приведено описание входных данных.

    * **Промежуточное расположение**— временное хранилище, куда записывается начальная резервная копия. Это может быть сетевая папка или локальный компьютер. Если целевой компьютер и исходный компьютер разные, мы советуем указывать полный сетевой путь к промежуточному расположению.
    * **Учетная запись хранения Azure Resource Manager** — имя учетной записи хранилища типа Resource Manager в любой подписке Azure.
    * **Контейнер службы хранилища Azure** — имя хранилища BLOB-объектов в учетной записи хранения Azure, в которое импортируются данные резервной копии перед копированием в хранилище служб восстановления.
    * **Идентификатор подписки Azure** — идентификатор подписки Azure, где создается учетная запись хранилища Azure.
    * **Имя задания импорта Azure**— уникальное имя, по которому служба импорта Azure и служба архивации Azure отслеживают процесс передачи данных в Azure с помощью дисков. 
  
   Укажите входные данные на экране и нажмите кнопку **Далее**. Сохраните указанное *промежуточное расположение* и *имя задания импорта Azure*, так как эти сведения требуются для подготовки дисков.

2. При появлении запроса войдите в подписку Azure. Это нужно сделать, чтобы служба Azure Backup могла создать приложение Azure Active Directory и предоставить необходимые разрешения на доступ к службе импорта Azure.

    ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/azurelogin.png)

3. Завершите рабочий процесс и в консоли агента Azure Backup нажмите **Создать резервную копию**.

    ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/backupnow.png)

4. На странице подтверждения в мастере нажмите кнопку **Создать резервную копию**. Начальная резервная копия записывается в промежуточное расположение в процессе установки.

   ![Подтверждение готовности к резервному копированию](./media/backup-azure-backup-import-export/backupnow-confirmation.png)

    После завершения операции промежуточное расположение можно использовать для подготовки дисков.

   ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/opbackupnow.png)

## <a name="prepare-sata-drives-and-ship-to-azure"></a>Подготовка дисков SATA и их отправка в Azure
Служебная программа *AzureOfflineBackupDiskPrep* выполняет подготовку дисков SATA, которые отправляются в ближайший центр обработки данных Azure. Эта программа находится в следующем каталоге установки агента Azure Backup:

   *\Microsoft Azure Recovery Services Agent\Utils\\* .

1. Перейдите в это расположение и скопируйте каталог **AzureOfflineBackupDiskPrep** на другой компьютер, к которому подключены диски SATA. На компьютере с подключенными дисками SATA сделайте следующее:

   * Промежуточное расположение, используемое для рабочего процесса автономного заполнения, доступно на целевом компьютере по тому же сетевому пути, который был задан во время **запуска автономного резервного копирования** .
   * На компьютере копирования включен инструмент BitLocker.
   * Установите Azure PowerShell 3.7.0.
   * Установите последние совместимые браузеры (Microsoft Edge или Internet Explorer 11) и включите JavaScript. 
   * Компьютер копирования имеет доступ к порталу Azure. При необходимости целевым компьютером может быть исходный компьютер.
    
     > [!IMPORTANT] 
     > Если исходный компьютер — это виртуальная машина, то в качестве компьютера копирования нужно использовать другой физический сервер или клиентский компьютер, т. е. не исходный.

2. На компьютере копирования выберите каталог служебной программы *AzureOfflineBackupDiskPrep*, откройте в нем командную строку с повышенными привилегиями и выполните следующую команду.

    ```.\AzureOfflineBackupDiskPrep.exe s:<Staging Location Path>```

    | Параметр | Описание |
    | --- | --- |
    | s:&lt;*путь_к_промежуточному_расположению*&gt; |Обязательный параметр. Используется для предоставления пути к промежуточному расположению, заданному при **запуске автономного резервного копирования**. |
    | p:&lt;*путь_к_файлу_параметров_публикации*&gt; |Необязательный параметр. Используется для предоставления пути к **файлу параметров публикации**, заданному в процессе **запуска автономной архивации**. |

    При выполнении команды эта служебная программа запрашивает выбор задания импорта Azure, связанного с подготавливаемыми дисками. Если с предоставленным промежуточным расположением связано только одно задание импорта, отобразится следующее окно.

    ![Входные данные средства подготовки дисков Azure](./media/backup-azure-backup-import-export/diskprepconsole0_1.png) <br/>

3. Введите букву подключенного диска (без двоеточия), который нужно подготовить для передачи в Azure. 
4. При появлении запроса подтвердите форматирование диска.
5. Появится запрос выполнить вход в подписку Azure. Укажите свои учетные данные.

    ![Входные данные средства подготовки дисков Azure](./media/backup-azure-backup-import-export/signindiskprep.png) <br/>

    После этого инструмент начнет подготовку диска и копирование данных резервных копий. Когда в средстве отобразится соответствующий запрос, может потребоваться подключить дополнительные диски. Это связано с тем, что на выбранном диске недостаточно памяти для хранения резервных копий данных. <br/>

    При успешном выполнении средства командная строка отображает следующие сведения:
   1. Один или несколько предоставленных вами дисков подготовлены для доставки в Azure. 
   2. Вы получите сообщение, подтверждающее создание задания импорта. В задании импорта используется предоставленное вами имя.
   3. Средство отобразит адрес доставки для центра обработки данных Azure.

      ![Завершение подготовки дисков Azure](./media/backup-azure-backup-import-export/console2.png)<br/>

6. Когда команда будет выполнена, можно обновить сведения о доставке.

7. Перешлите диски на адрес, указанный в средстве, и сохраните номер отслеживания для использования в будущем.

   > [!IMPORTANT] 
   > У двух заданий импорта Azure не может быть одинаковый номер для отслеживания. Убедитесь, что диски, подготовленные служебной программой для одного задания импорта Azure, отправляются вместе в одной посылке с отдельным уникальным идентификационным номером. Не отправляйте в одной посылке диски, подготовленные для разных заданий импорта Azure.



## <a name="update-shipping-details-on-the-azure-import-job"></a>Обновление сведений о доставке в задании импорта Azure

Следующая процедура используется для обновления сведений о доставке в задании импорта Azure. Эти данные включают следующие сведения:
* имя перевозчика, который доставляет диски в Azure;
* сведения об обратной доставке ваших дисков.

1. Войдите в свою подписку Azure.
2. В главном меню выберите **Все службы**, а затем в диалоговом окне "Все службы" введите "Импорт". При появлении элемента **Задания импорта и экспорта** щелкните его.
    ![Ввод сведений о доставке](./media/backup-azure-backup-import-export/search-import-job.png)<br/>

    Откроется список меню **Задания импорта и экспорта** и список всех заданий импорта и экспорта в выбранной подписке. 

3. Если у вас есть несколько подписок, выберите ту, которая используется для импорта данных резервной копии. Затем выберите только что созданное задание импорта, чтобы открыть сведения о нем.

    ![Просмотр сведений о доставке](./media/backup-azure-backup-import-export/import-job-found.png)<br/>

4. В меню "Параметры" для задания импорта нажмите **Управление информацией о доставке** и введите сведения об обратной доставке.

    ![Хранение сведений о доставке](./media/backup-azure-backup-import-export/shipping-info.png)<br/>

5. Когда вы получите номер для отслеживания посылки от перевозчика, щелкните баннер на странице с общими сведениями о задании импорта Azure и введите следующие сведения:

   > [!IMPORTANT] 
   > Сведения о перевозчике и номер для отслеживания должны быть обновлены в течение двух недель с момента создания задания импорта Azure. Если проверка этой информации в течение двух недель не будет выполнена, задание будет удалено, а диски не будут обработаны.

   ![Хранение сведений о доставке](./media/backup-azure-backup-import-export/joboverview.png)<br/>

   ![Хранение сведений о доставке](./media/backup-azure-backup-import-export/tracking-info.png)

### <a name="time-to-process-the-drives"></a>Время обработки дисков 
Время обработки задания импорта Azure зависит от различных факторов, таких как время отправки, тип задания, тип и размер копируемых данных и размер дисков. В службе "Импорт и экспорт Azure" не предусмотрено соглашение об уровне обслуживания, однако после получения дисков служба стремится выполнить копирование данных резервных копий в вашу учетную запись хранения Azure в течение 7–10 дней. 

### <a name="monitoring-azure-import-job-status"></a>Мониторинг состояния заданий импорта Azure
Можно отслеживать состояние задания импорта на портале Azure, перейдя на страницу **Задания импорта и экспорта** и выбрав нужное задание. Дополнительные сведения о состоянии заданий импорта см. в статье [Storage Import Export service](../storage/common/storage-import-export-service.md) (Служба импорта и экспорта хранилища).

### <a name="complete-the-workflow"></a>Завершение процесса
Когда задание импорта будет выполнено, данные начальной резервной копии появятся в вашей учетной записи хранения. Во время следующего запланированного резервного копирования служба Azure Backup скопирует данные из учетной записи хранения в хранилище служб восстановления, как показано ниже: 

   ![Копирование данных в хранилище служб восстановления](./media/backup-azure-backup-import-export/copyingfromstorageaccounttoazurebackup.png)<br/>

При следующем запланированном резервном копировании служба Azure Backup выполнит добавочное резервное копирование.

### <a name="cleaning-up-resources"></a>Очистка ресурсов
Выполнив начальное резервное копирование, можно безопасно удалить импортированные в контейнер хранилища Azure данные, а также данные резервной копии из промежуточного расположения.

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о рабочем процессе службы импорта и экспорта см. в статье [Использование службы импорта и экспорта Azure для передачи данных в хранилище BLOB-объектов](../storage/common/storage-import-export-service.md).
* Дополнительные сведения об автономной архивации см. в статье [Служба архивации Azure: часто задаваемые вопросы](backup-azure-backup-faq.md).
