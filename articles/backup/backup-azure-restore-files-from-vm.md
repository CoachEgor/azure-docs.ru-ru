---
title: Восстановление файлов и папок из резервного копирования Azure VM
description: В этой статье узнайте, как восстановить файлы и папки из точки восстановления виртуальной машины Azure.
ms.topic: conceptual
ms.date: 03/01/2019
ms.openlocfilehash: 0e3061ea8fc26adcf39fe415cd9a662de739543a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79273310"
---
# <a name="recover-files-from-azure-virtual-machine-backup"></a>Восстановление файлов из резервной копии виртуальной машины Azure

Azure Backup предоставляет возможность восстановления [виртуальных машин и дисков Azure](./backup-azure-arm-restore-vms.md) из резервных копий виртуальных машин Azure, также известных как точки восстановления. В этой статье описывается восстановление файлов и папок из резервной копии виртуальной машины Azure. Восстановление файлов и папок доступно для всех виртуальных машин Azure, развернутых по модели с помощью Resource Manager и защищенных в хранилище служб восстановления.

> [!NOTE]
> Эта функция доступна для всех виртуальных машин Azure, развернутых посредством модели с помощью Resource Manager и защищенных в хранилище служб восстановления.
> Восстановление файлов из зашифрованной резервной копии виртуальной машины не поддерживается.
>

## <a name="mount-the-volume-and-copy-files"></a>Подключение тома и копирование файлов

Чтобы восстановить файлы и папки из точки восстановления, перейдите на виртуальную машину и выберите нужную точку восстановления.

1. Войдите на [портал Azure](https://portal.Azure.com) и в области слева щелкните **Виртуальные машины**. В списке виртуальных машин выберите виртуальную машину, чтобы открыть ее панель мониторинга.

2. В меню виртуальной машины щелкните **Архивация**, чтобы открыть панель мониторинга архивации.

    ![Открытие архивируемого элемента в хранилище служб восстановления](./media/backup-azure-restore-files-from-vm/open-vault-for-vm.png)

3. В меню панели мониторинга резервной копии щелкните **Восстановление файлов**.

    ![Кнопка восстановления файлов](./media/backup-azure-restore-files-from-vm/vm-backup-menu-file-recovery-button.png)

    Открывается меню **Восстановление файла**.

    ![Меню восстановления файлов](./media/backup-azure-restore-files-from-vm/file-recovery-blade.png)

4. В раскрывающемся меню **Выберите точку восстановления** найдите и выберите точку восстановления, которая содержит требуемые файлы. По умолчанию здесь выбрана последняя из созданных точек восстановления.

5. Чтобы загрузить программное обеспечение, используемое для копирования файлов из точки восстановления, нажмите **Download Executable** (для Windows Azure VMs) или **Скачать сценарий** (для Linux Azure VMs, скрипт python генерируется).

    ![Созданный пароль](./media/backup-azure-restore-files-from-vm/download-executable.png)

    Azure скачает исполняемый файл или сценарий на локальный компьютер.

    ![сообщение о скачивании исполняемого файла или сценария](./media/backup-azure-restore-files-from-vm/run-the-script.png)

    Для выполнения исполняемого или скрипта в качестве администратора предлагается сохранить загруженный файл на компьютере.

6. Исполняемый файл или сценарий защищен, и для него требуется ввести пароль. В меню **Восстановление файла** нажмите кнопку "Копировать" для загрузки пароля в память.

    ![Созданный пароль](./media/backup-azure-restore-files-from-vm/generated-pswd.png)

7. Из расположения скачивания (обычно папка "Загрузки") щелкните исполняемый файл или сценарий правой кнопкой мыши и запустите его с учетными данными администратора. При запросе введите пароль или вставьте пароль из памяти, и нажмите **Enter**. После ввода пароля сценарии подключаются к точке восстановления.

    ![Меню восстановления файлов](./media/backup-azure-restore-files-from-vm/executable-output.png)

8. Для машин Linux генерируется скрипт python. Нужно загрузить скрипт и скопировать его на соответствующий/совместимый сервер Linux. Возможно, вам придется изменить разрешения ```chmod +x <python file name>```для выполнения его с помощью . Затем запустите файл ```./<python file name>```python с .

Обратитесь в раздел [требований к доступу,](#access-requirements) чтобы убедиться, что скрипт успешно запущен.

### <a name="identifying-volumes"></a>Определение объемов

#### <a name="for-windows"></a>Для Windows

При выполнении исполняемого файла операционная система подключает новые тома и назначает им буквы дисков. Для просмотра этих дисков вы можете использовать проводник Windows или проводник. Приводные буквы, присвоенные объемам, могут быть не такими же буквами, как оригинальная виртуальная машина. Тем не менее, имя громкости сохраняется. Например, если том на исходной виртуальной машине`\`был "Data Disk (E:) ", этот объем может быть`\`прикреплен на локальном компьютере как "Data Disk ("Любое письмо": ). Просматривайте все тома, упомянутые в выходе скрипта, пока не найдете файлы или папку.  

   ![Меню восстановления файлов](./media/backup-azure-restore-files-from-vm/volumes-attached.png)

#### <a name="for-linux"></a>Для Linux

В Linux тома точки восстановления подключаются к папке, в которой выполняет сценарий. Отображаются подключенные диски, тома и соответствующие пути подключения. Эти пути подключения видимы для пользователей с доступом на корневом уровне. Просмотрите тома, указанные в выходных данных сценария.

  ![Меню восстановления файлов Linux](./media/backup-azure-restore-files-from-vm/linux-mount-paths.png)

## <a name="closing-the-connection"></a>Закрытие подключения

Когда вы найдете все нужные файлы и скопируете их в локальное хранилище, удалите или отключите дополнительные диски. Чтобы отключить диски, щелкните **Unmount Disks** (Отключить диски) в меню **Восстановление файлов** на портале Azure.

![Отключение дисков](./media/backup-azure-restore-files-from-vm/unmount-disks3.png)

Когда диски будут отключены, появится сообщение об успешном завершении операции. На обновление состояния подключения может потребоваться несколько минут, после чего диски можно удалить.

В Linux после разрыва подключения к точке восстановления операционная система не удаляет соответствующие пути подключения автоматически. Пути крепления существуют как "сиротские" тома и видны, но бросают ошибку при доступе/записи файлов. Их можно удалить вручную. При запуске сценарий определяет такие тома, оставшиеся от любой предыдущей точки восстановления, и очищает их после согласия пользователя.

## <a name="special-configurations"></a>Специальные конфигурации

### <a name="dynamic-disks"></a>Динамические диски

Если на защищенной виртуальной машине Azure есть тома, обладающие одной или всеми следующими характеристиками, то запустить на ней исполняемый сценарий не удастся.

- Тома, охватывающие несколько дисков (составные и чередующиеся тома)
- Отказоустойчивые тома (зеркальные тома и тома RAID-5) на динамических дисках

Вместо этого запустите исполняемый сценарий на другом компьютере с совместимой операционной системой.

### <a name="windows-storage-spaces"></a>Дисковое пространство Windows

Дисковые пространства Windows — это технология Windows, которая позволяет виртуализировать хранилище. С помощью дисковых пространств Windows можно сгруппировать стандартные отраслевые диски в пулы носителей. Затем доступное пространство в этих пулах носителей можно использовать для создания виртуальных дисков, называемых дисковыми пространствами.

Если защищенная виртуальная машина Azure использует дисковые пространства Windows, то запустить на ней исполняемый сценарий не удастся. Вместо этого запустите его на другом компьютере с совместимой операционной системой.

### <a name="lvmraid-arrays"></a>Массивы LVM/RAID

В Linux для управления логическими томами на нескольких дисках используется диспетчер логических томов (LVM) и (или) программные RAID-массивы. Если защищенная виртуальная машина Linux использует LVM и/или RAID-массивы, на ней нельзя запустить сценарий. Вместо этого запустите сценарий на любом другом компьютере с совместимой операционной системы, поддерживающей файловую систему защищенной виртуальной машины.

В следующих выходных данных сценария отображаются диски и тома LVM или RAID-массивов с типом раздела.

   ![Меню выходных данных для LVM в Linux](./media/backup-azure-restore-files-from-vm/linux-LVMOutput.png)

Чтобы подключить эти разделы, выполните команды в следующих разделах.

#### <a name="for-lvm-partitions"></a>Для разделов LVM

Чтобы перечислить имена групп ы тома под физическим томом:

```bash
#!/bin/bash
pvs <volume name as shown above in the script output>
```

Чтобы перечислить все логические тома, имена и их пути в группе громкости:

```bash
#!/bin/bash
lvdisplay <volume-group-name from the pvs command's results>
```

Чтобы смонтировать логические тома на путь по вашему выбору:

```bash
#!/bin/bash
mount <LV path> </mountpath>
```

#### <a name="for-raid-arrays"></a>Для массивов RAID

Следующая команда отображает подробную информацию обо всех рейдовых дисках:

```bash
#!/bin/bash
mdadm –detail –scan
```

 Соответствующий диск RAID будет отображен как `/dev/mdm/<RAID array name in the protected VM>`.

Используйте команду крепления, если диск RAID имеет физические тома:

```bash
#!/bin/bash
mount [RAID Disk Path] [/mountpath]
```

Если в диске RAID есть другой LVM, настроенный в нем, используйте предыдущую процедуру для разделов LVM, но используйте имя громкости вместо имени диска RAID.

## <a name="system-requirements"></a>Требования к системе

### <a name="for-windows-os"></a>Windows 10

Следующая таблица содержит информацию о совместимости операционных систем сервера и компьютера. Нельзя восстановить файлы до предыдущей или будущей версии операционной системы. Например, нельзя восстановить файл с виртуальной машины Windows Server 2016 на компьютер Windows Server 2012 или Windows 8. Файлы можно восстановить с виртуальной машины в ту же серверную операционную систему или в совместимую клиентскую операционную систему.

|ОС сервера | Совместимые ОС клиента  |
| --------------- | ---- |
| Windows Server 2019    | Windows 10 |
| Windows Server 2016    | Windows 10 |
| Windows Server 2012 R2 | Windows 8.1 |
| Windows Server 2012    | Windows 8  |
| Windows Server 2008 R2 | Windows 7   |

### <a name="for-linux-os"></a>Для ОС Linux

В Linux операционная система компьютера, используемого для восстановления файлов, должна поддерживать файловую систему защищенной виртуальной машины. При выборе компьютера для выполнения сценария убедитесь, что он имеет совместимую ОС и использует одну из версий, приведенных в следующей таблице:

|ОС Linux | Версии  |
| --------------- | ---- |
| Ubuntu | 12.04 и выше |
| CentOS | 6.5 и выше  |
| RHEL | 6.7 и выше |
| Debian | 7 и выше |
| Oracle Linux | 6.4 и выше |
| SLES | 12 и выше |
| openSUSE | 42.2 и выше |

> [!NOTE]
> Мы нашли некоторые проблемы при запуске сценария восстановления файлов на машинах с SLES 12 SP4 OS и исследуем с командой SLES.
> В настоящее время работает сценарий восстановления файлов работает на машинах с версиями SLES 12 SP2 и SP3 OS.
>

Сценарию также требуется компоненты python и bash для выполнения операций и безопасного подключения к точке восстановления.

|Компонент | Версия  |
| --------------- | ---- |
| bash | 4 и выше |
| python | 2.6.6 и выше  |
| TLS | Должна поддерживаться версия 1.2  |

## <a name="access-requirements"></a>Требования для доступа

Если скрипт выполняется на компьютере с ограниченным доступом, убедитесь в наличии доступа к следующим ресурсам:

- `download.microsoft.com`
- URL-адреса служб восстановления (geo-name относится к региону, в котором расположено хранилище служб восстановления):
  - `https://pod01-rec2.geo-name.backup.windowsazure.com` (для общедоступных геообъектов Azure);
  - `https://pod01-rec2.geo-name.backup.windowsazure.cn`(Для Лазурного Китая 21Vianet)
  - `https://pod01-rec2.geo-name.backup.windowsazure.us` (Azure для государственных организаций США);
  - `https://pod01-rec2.geo-name.backup.windowsazure.de` (Azure для Германии).
- Исходящие порты 53 (DNS), 443, 3260

> [!NOTE]
>
> - Загружаемое имя файла скрипта будет иметь **гео-имя,** которое будет заполнено в URL. Для exampple: Загружаемое \'имя\'\_\'сценария\'начинается с vMname geoname и\'GUID\', как *ContosoVM_wcus_12345678*
> - URL будет <https://pod01-rec2.wcus.backup.windowsazure.com>"
>

Для Linux сценарию требуются компоненты open-iscsi и lshw для подключения к точке восстановления. Если компоненты не существуют на компьютере, где запущен скрипт, скрипт запрашивает разрешение на установку компонентов. Согласитесь на установку необходимых компонентов.

Доступ к `download.microsoft.com` ним необходим для загрузки компонентов, используемых для создания безопасного канала между машиной, где запущен скрипт, и данными в точке восстановления.

Сценарий можно запустить на любом компьютере, операционная система на котором совпадает или совместима с операционной системой архивной виртуальной машины. Условия совместимости можно проверить в [таблице совместимых ОС](backup-azure-restore-files-from-vm.md#system-requirements). Если на защищенной виртуальной машине Azure используются дисковые пространства Windows (для виртуальных машин Windows в Azure) либо LVM или RAID-массивы (для виртуальных машин Linux), то запустить на ней исполняемый файл или сценарий не удастся. Вместо этого запустите его на другом компьютере с совместимой операционной системой.

## <a name="file-recovery-from-virtual-machine-backups-having-large-disks"></a>Восстановление файлов из резервного копирования виртуальной машины с большими дисками

В этом разделе объясняется, как выполнять восстановление файлов из резервных копирования виртуальных машин Azure с более чем 16 дисками, и размер каждого диска превышает 32 ТБ.

Поскольку процесс восстановления файлов прикрепляет все диски из резервного копирования, когда используется большое количество дисков (>16) или больших дисков (> 32 ТБ каждый), рекомендуется:

- Храните отдельный сервер восстановления (Azure VM D2v3 VMs) для восстановления файлов. Вы можете использовать это только для восстановления файла, а затем выключить его, когда это не требуется. Восстановление на оригинальной машине не рекомендуется, так как это окажет значительное влияние на сам VM.
- Затем запустите скрипт один раз, чтобы проверить, если операция восстановления файла успешно.
- Если процесс восстановления файла зависает (диски никогда не монтируются или они установлены, но объемы не появляются), выполните следующие шаги.
  - Если сервер восстановления является Windows VM:
    - Убедитесь, что ОС WS 2012 или выше.
    - Убедитесь, что ключи реестра установлены, как показано ниже на сервере восстановления и убедитесь, что перезагрузка сервера. Номер рядом с GUID может варьироваться от 0001-0005. В следующем примере, это 0004. Перейдите по пути ключа реестра до раздела параметров.

    ![iscsi-reg-key-changes.png](media/backup-azure-restore-files-from-vm/iscsi-reg-key-changes.png)

```registry
- HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Disk\TimeOutValue – change this from 60 to 1200
- HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class\{4d36e97b-e325-11ce-bfc1-08002be10318}\0003\Parameters\SrbTimeoutDelta – change this from 15 to 1200
- HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class\{4d36e97b-e325-11ce-bfc1-08002be10318}\0003\Parameters\EnableNOPOut – change this from 0 to 1
- HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class\{4d36e97b-e325-11ce-bfc1-08002be10318}\0003\Parameters\MaxRequestHoldTime - change this from 60 to 1200
```

- Если сервер восстановления является Linux VM:
  - В файле /etc/iscsi/iscsid.conf изменяйте настройки с:
    - node.conn.0.timeo.noop_out_timeout No 5 до node.conn.0.timeo.noop_out_timeout No 30
- После внесения изменения выше, запустите сценарий снова. С этими изменениями, весьма вероятно, что восстановление файла будет успешным.
- Каждый раз, когда пользователь загружает скрипт, Azure Backup инициирует процесс подготовки точки восстановления для загрузки. С большими дисками этот процесс займет значительное время. При последовательных всплесках запросов целевая подготовка будет идти в спираль загрузки. Поэтому рекомендуется скачать скрипт с portal/Powershell/CLI, подождать 20-30 минут (эвристический) и запустить его. Ожидается, что к этому времени цель будет готова к подключению из сценария.
- После восстановления файла убедитесь, что вы вернетесь на портал и нажмите **Unmount диски** для восстановления точек восстановления, где вы не смогли смонтировать объемы. По сути, этот шаг очистит все существующие процессы/сессии и увеличит вероятность восстановления.

## <a name="troubleshooting"></a>Устранение неполадок

Если при восстановлении файлов из виртуальных машин у вас возникнут проблемы, проверьте сведения, приведенные в следующей таблице.

| Сообщение об ошибке или ситуация | Возможные причины | Рекомендуемое действие |
| ------------------------ | -------------- | ------------------ |
| Выход Exe: *Исключение поймано при подключении к цели* | Скрипт не может получить доступ к точке восстановления    | Проверьте, соответствует ли машина [предыдущим требованиям доступа.](#access-requirements) |  
| Исполняемый файл возвращает сообщение об ошибке *The target has already been logged in via an ISCSI session* (Вход на целевое устройство уже выполнен через сеанс iSCSI). | Этот скрипт уже запущен на этом компьютере и диски уже подключены | Тома точки восстановления уже подключены. Их НЕЛЬЗЯ подключить с теми же буквами дисков, что и на исходной виртуальной машине. Просмотрите все доступные тома в исследователе файлов для вашего файла. |
| Выход Exe: *Этот скрипт является недействительным, поскольку диски были демонтированы через портал/ превысил 12-часовой предел. Скачать новый скрипт с портала.* |    Диски были сняты с портала или 12-часовой лимит был превышен | Данный exe теперь недействителен и не может быть запущен. Если вы хотите получить доступ к файлам этого пункта восстановления в срок, посетите портал для нового exe.|
| На машине, где запущен exe: Новые тома не смонтированы после нажатия кнопки съезда | Инициатор iSCSI на машине не отвечает/обновляет свое подключение к цели и не поддерживает кэш. |  После нажатия кнопки **Отключить**, подождите несколько минут. Если новые тома не смонтированы, просмотрите все тома. Просмотр всех томов заставляет инициатора обновить соединение, и громкость снимается с сообщением об ошибке о том, что диск недоступен.|
| Выход Exe: сценарий запущен успешно, но "Новые тома прилагается" не отображается на выходе скрипта |    Это временная проблема    | Объемы уже будут приложены. Попробуйте открыть их через проводник. Если вы используете одну и ту же машину для выполнения скриптов каждый раз, рассмотрите возможность перезапуска машины и списка должны отображаться в последующих запусках exe. |
| В Linux: не удается просмотреть нужные тома. | Операционная система компьютера, на котором выполняется сценарий, не может распознать базовую файловую систему защищенной виртуальной машины. | Проверьте, является ли точка восстановления сбоем или файл-последовательной. Если файл согласован, запустите скрипт на другой машине, ОС которой распознает защищенную файловую систему VM. |
| В Windows: не удается просмотреть нужные тома | Диски, возможно, были прикреплены, но тома не были настроены | На экране управления дисками определите дополнительные диски, относящиеся к точке восстановления. Если какой-либо из этих дисков находятся в автономном состоянии, попробуйте привести их в Интернете, нажав на диск правой кнопкой мыши и нажмите **Онлайн**.|

## <a name="security"></a>Безопасность

В этом разделе рассматриваются различные меры безопасности, принятые для реализации восстановления файлов из резервных upups Azure VM.

### <a name="feature-flow"></a>Поток функций

Эта функция была построена для доступа к данным VM без необходимости восстановления всего VM или VM дисков и с минимальным количеством шагов. Доступ к данным VM обеспечивается скриптом (который устанавливает объем восстановления при запуске, как показано ниже) и является краеугольным камнем всех реализаций безопасности:

  ![Поток функций безопасности](./media/backup-azure-restore-files-from-vm/vm-security-feature-flow.png)

### <a name="security-implementations"></a>Реализации системы безопасности

#### <a name="select-recovery-point-who-can-generate-script"></a>Выберите точку восстановления (кто может создать сценарий)

Скрипт обеспечивает доступ к данным VM, поэтому важно регулировать, кто может генерировать их в первую очередь. Вам нужно войти в портал Azure и получить [разрешение RBAC](backup-rbac-rs-vault.md#mapping-backup-built-in-roles-to-backup-management-actions) на создание скрипта.

Восстановление файла требует того же уровня авторизации, что и для восстановления VM и восстановления дисков. Другими словами, только авторизованные пользователи могут просматривать данные VM, которые могут генерировать скрипт.

Сгенерированный скрипт подписан официальным сертификатом Майкрософт для службы резервного копирования Azure. Любое подделка скрипта означает, что подпись сломана, и любая попытка запуска скрипта выделяется как потенциальный риск со стороны ОС.

#### <a name="mount-recovery-volume-who-can-run-script"></a>Объем восстановления горы (кто может запустить сценарий)

Только админ может запустить сценарий, и он должен работать в повышенном режиме. Скрипт выполняет только заранее созданный набор шагов и не принимает входные данные из любого внешнего источника.

Для выполнения скрипта требуется пароль, который отображается только авторизованному пользователю во время генерации скрипта на портале Azure или PowerShell/CLI. Это необходимо для того, чтобы авторизованный пользователь, загрузивший скрипт, также отвечал за работу скрипта.

#### <a name="browse-files-and-folders"></a>Просмотр файлов и папок

Для просмотра файлов и папок скрипт использует инициатора iSCSI в машине и подключается к точке восстановления, настроенной как цель iSCSI. Здесь вы можете себе представить сценарии, где один пытается имитировать / пародии либо / все компоненты.

Мы используем взаимный механизм проверки подлинности CHAP, чтобы каждый компонент удостоверял подлинность другого. Это означает, что это чрезвычайно трудно для поддельного инициатора для подключения к цели iSCSI и для поддельной цели, чтобы быть подключены к машине, где сценарий запущен.

Поток данных между службой восстановления и машиной защищен путем создания безопасного туннеля TLS над TCP[(TLS 1.2 должен поддерживаться](#system-requirements) в машине, где запущен скрипт).

В установленной файловой системе также сохраняются все списки управления доступом к файлам (ACL), присутствующие в родительской/резервной системе VM.

Скрипт предоставляет только для чтения доступ к точке восстановления и действителен только в течение 12 часов. Если вы хотите удалить доступ раньше, то впишитесь в Azure Portal/PowerShell/CLI и выполните **несмонтированные диски** для этой конкретной точки восстановления. Скрипт будет немедленно признан недействительным.

## <a name="next-steps"></a>Дальнейшие действия

- Для любых проблем при восстановлении файлов, обратитесь к разделу [Устранение проблем](#troubleshooting)
- Узнайте, как [восстановить файлы через Powershell](https://docs.microsoft.com/azure/backup/backup-azure-vms-automation#restore-files-from-an-azure-vm-backup)
- Узнайте, как [восстановить файлы через Azure CLI](https://docs.microsoft.com/azure/backup/tutorial-restore-files)
- После восстановления VM научитесь [управлять резервными копированиями](https://docs.microsoft.com/azure/backup/backup-azure-manage-vms)
