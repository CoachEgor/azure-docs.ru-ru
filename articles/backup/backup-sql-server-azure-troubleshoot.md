---
title: Устранение неполадок резервного копирования базы данных SQL Server с помощью Azure Backup | Документация Майкрософт
description: Сведения об устранении неполадок резервного копирования баз данных SQL Server на виртуальных машинах Azure с помощью службы Azure Backup.
services: backup
author: anuragm
manager: sivan
ms.service: backup
ms.topic: article
ms.date: 06/18/2019
ms.author: anuragm
ms.openlocfilehash: b2822a3c7dfa23065f2cbd35ef4e506efae026f2
ms.sourcegitcommit: c105ccb7cfae6ee87f50f099a1c035623a2e239b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67704850"
---
# <a name="troubleshoot-sql-server-database-backup-by-using-azure-backup"></a>Устранение неполадок резервного копирования базы данных SQL Server с помощью Azure Backup

В этой статье содержатся сведения об устранении неполадок для баз данных SQL Server, выполняющихся на виртуальных машинах Azure.

Дополнительные сведения о процесс резервного копирования и ограничениях см. в разделе [резервного копирования о SQL Server на виртуальных машинах Azure](backup-azure-sql-database.md#feature-consideration-and-limitations).

## <a name="sql-server-permissions"></a>Разрешения SQL Server

Чтобы настроить защиту для базы данных SQL Server на виртуальной машине, необходимо установить **AzureBackupWindowsWorkload** расширения на этой виртуальной машине. Если возникает ошибка **UserErrorSQLNoSysadminMembership**, это означает, что экземпляр SQL Server не имеет необходимых разрешений резервного копирования. Чтобы устранить эту ошибку, выполните действия, описанные в [виртуальной Машины, задайте разрешения](backup-azure-sql-database.md#set-vm-permissions).

## <a name="error-messages"></a>Сообщения об ошибках

### <a name="backup-type-unsupported"></a>Неподдерживаемый тип резервного копирования

| severity | Описание | Возможные причины | Рекомендуемое действие |
|---|---|---|---|
| Предупреждение | Текущие параметры для этой базы данных не поддерживают определенные в соответствующей политике типы резервного копирования. | <li>Только операция резервного копирования всей базы данных может выполняться в базе данных master. Возможна ни разностной резервной копии, ни резервной копии журнала транзакций. </li> <li>Резервная копия журналов транзакций не поддерживает любой базы данных в простой модели восстановления.</li> | Поддерживается изменение параметров базы данных, например всех типов резервных копий в политике. Или измените текущую политику для включения только поддерживаемые типы резервных копий. В противном случае неподдерживаемые типы резервного копирования будут пропущены во время запланированного резервного копирования или задания резервного копирования завершаются сбоем для нерегламентированного резервного копирования.


### <a name="usererrorsqlpodoesnotsupportbackuptype"></a>UserErrorSQLPODoesNotSupportBackupType

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| This SQL database does not support the requested backup type. (Эта база данных SQL не поддерживает запрашиваемый тип резервного копирования.) | Возникает, когда модель восстановления базы данных не разрешает запрашиваемый тип резервного копирования. Ошибка может произойти в следующих ситуациях: <br/><ul><li>Базы данных, которая использует простую модель восстановления не поддерживает резервное копирование журнала.</li><li>Разностной резервной копии и резервные копии журналов не допускаются для базы данных master.</li></ul>Дополнительные сведения см. в разделе [модели восстановления SQL Server](https://docs.microsoft.com/sql/relational-databases/backup-restore/recovery-models-sql-server) документации. | Для базы данных в простой модели восстановления в случае сбоя резервная копия журнала, попробуйте один из следующих вариантов:<ul><li>Если база данных находится в режиме простого восстановления, отключите резервные копии журналов.</li><li>Используйте [документации по SQL Server](https://docs.microsoft.com/sql/relational-databases/backup-restore/view-or-change-the-recovery-model-of-a-database-sql-server) изменить модель восстановления базы данных на полную или с неполным протоколированием. </li><li> Если вы не хотите изменять модель восстановления, и у вас есть стандартная политика резервного копирования нескольких баз данных, которую нельзя изменить, игнорируйте ошибку. Полные и разностные резервные копии будут работать по расписанию. Резервные копии журналов будут пропущены, что ожидаемо в этом случае.</li></ul>Если она является базой данных master и настроили разностной резервной копии или резервной копии журнала, используйте одно из следующих действий:<ul><li>Используйте портал, чтобы изменить расписание политики резервного копирования для базы данных master на full.</li><li>Если у вас есть стандартная политика резервного копирования нескольких баз данных, которую нельзя изменить, игнорируйте ошибку. Ваше полное резервное копирование будет работать по расписанию. Разностное резервное копирование или резервное копирование журналов не произойдет, что ожидаемо в этом случае.</li></ul> |
| Operation canceled as a conflicting operation was already running on the same database. (Операция отменена, так как конфликтная операция уже выполняется в одной базе данных.) | См. в разделе [запись в блоге об ограничениях резервного копирования и восстановления](https://blogs.msdn.microsoft.com/arvindsh/2008/12/30/concurrency-of-full-differential-and-log-backups-on-the-same-database) , выполняемые параллельно.| [Используйте SQL Server Management Studio (SSMS) для мониторинга задания резервного копирования](manage-monitor-sql-database-backup.md). После сбоя конфликтующие операции, перезапустите операцию.|

### <a name="usererrorsqlpodoesnotexist"></a>UserErrorSQLPODoesNotExist

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| SQL database does not exist. (База данных SQL не существует.) | База данных была либо удалена, либо переименована. | Проверьте, не была ли база данных случайно удалена или переименована.<br/><br/> Если база данных была случайно удалена, чтобы продолжить резервное копирование, восстановите базу данных в ее исходном расположении.<br/><br/> Если вы удалили базу данных и не должны выбрать будущие резервные копии, затем в хранилище служб восстановления, **остановить архивацию** с **сохранить данные архивации** или **удалить данные архивации**. Дополнительные сведения см. в разделе [мониторинг и управление базами данных резервные копии SQL Server](manage-monitor-sql-database-backup.md).

### <a name="usererrorsqllsnvalidationfailure"></a>UserErrorSQLLSNValidationFailure

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Log chain is broken. (Цепочка журналов прерывается.) | База данных или виртуальной Машине резервного копирования через другой резервной копии решения, которое усекает цепочку журналов.|<ul><li>Проверьте, используется ли другое решение или скрипт резервного копирования. В этом случае остановите резервное копирование. </li><li>Если резервная копия была триггер нерегламентированных журнала резервного копирования, создание полных резервных копий начните новую цепочку журналов. Для резервных копий журнала запланированных никаких действий не требуется, так как служба архивации Azure автоматически активирует полной резервной копии, чтобы устранить эту проблему.</li>|

### <a name="usererroropeningsqlconnection"></a>UserErrorOpeningSQLConnection

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Azure Backup is not able to connect to the SQL instance. (Azure Backup не может подключиться к экземпляру SQL.) | Служба архивации Azure не удается подключиться к экземпляру SQL Server. | Дополнительные сведения можно используйте в меню ошибка портала Azure, чтобы сузить список основных причин. Дополнительные сведения см. в статье [Устранение неполадок при соединении с компонентом SQL Server Database Engine](https://docs.microsoft.com/sql/database-engine/configure-windows/troubleshoot-connecting-to-the-sql-server-database-engine).<br/><ul><li>Если параметры по умолчанию SQL не разрешает удаленные соединения, измените параметры. Ознакомьтесь со следующими статьями, сведения об изменении настроек:<ul><li>[MSSQLSERVER_-1](/previous-versions/sql/sql-server-2016/bb326495(v=sql.130))</li><li>[MSSQLSERVER_2](/sql/relational-databases/errors-events/mssqlserver-2-database-engine-error)</li><li>[MSSQLSERVER_53](/sql/relational-databases/errors-events/mssqlserver-53-database-engine-error)</li></ul></li></ul><ul><li>При возникновении проблем со входом, используйте следующие ссылки для их устранения:<ul><li>[MSSQLSERVER_18456](/sql/relational-databases/errors-events/mssqlserver-18456-database-engine-error)</li><li>[MSSQLSERVER_18452](/sql/relational-databases/errors-events/mssqlserver-18452-database-engine-error)</li></ul></li></ul> |

### <a name="usererrorparentfullbackupmissing"></a>UserErrorParentFullBackupMissing

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| First full backup is missing for this data source. (Полная резервная копия отсутствует для этого источника данных.) | Полная резервная копия для базы данных отсутствует. Резервное копирование журнала и разностной резервной копии являются родительскими для полной резервной копии, поэтому убедитесь, что будут создаваться полные резервные перед активацией разностные или резервные копии журналов. | Активируйте Нерегламентированное полное резервное копирование.   |

### <a name="usererrorbackupfailedastransactionlogisfull"></a>UserErrorBackupFailedAsTransactionLogIsFull

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Невозможно выполнить резервное копирование, так как журнал транзакций для источника данных заполнен. | Пространство журнала транзакций базы данных заполнено. | Чтобы устранить эту проблему, обратитесь к [документации по SQL Server](https://docs.microsoft.com/sql/relational-databases/errors-events/mssqlserver-9002-database-engine-error). |

### <a name="usererrorcannotrestoreexistingdbwithoutforceoverwrite"></a>UserErrorCannotRestoreExistingDBWithoutForceOverwrite

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Database with same name already exists at the target location (База данных с тем же именем уже существует в целевом расположении) | Назначение восстановления уже есть база данных с тем же именем.  | <ul><li>Измените имя целевой базы данных.</li><li>Или используйте параметр force переписать на странице "Восстановление".</li> |

### <a name="usererrorrestorefaileddatabasecannotbeofflined"></a>UserErrorRestoreFailedDatabaseCannotBeOfflined

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Restore failed as the database could not be brought offline. (Не удалось выполнить восстановление, так как база данных не может быть отключена.) | При выполнении восстановления, целевую базу данных необходимо перевести в автономный режим. Служба архивации Azure не удается подключить данных в автономном режиме. | Дополнительные сведения можно используйте в меню ошибка портала Azure, чтобы сузить список основных причин. Дополнительные сведения см. в разделе [документации по SQL Server](https://docs.microsoft.com/sql/relational-databases/backup-restore/restore-a-database-backup-using-ssms). |

###  <a name="usererrorcannotfindservercertificatewiththumbprint"></a>UserErrorCannotFindServerCertificateWithThumbprint

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Cannot find the server certificate with thumbprint on the target. (Не удается найти сертификат сервера с отпечатком на целевом сервере.) | Базе данных master на целевом экземпляре не имеют отпечаток шифрования. | Импортируйте действительный сертификат отпечаток, используемый на экземпляре источника с целевым экземпляром. |

### <a name="usererrorrestorenotpossiblebecauselogbackupcontainsbulkloggedchanges"></a>UserErrorRestoreNotPossibleBecauseLogBackupContainsBulkLoggedChanges

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Резервная копия журналов, используемая для восстановления, содержит сведения об изменениях, зафиксированные в режиме неполного протоколирования. Согласно рекомендациям по SQL ее нельзя использовать для остановки в произвольный момент времени. | Если база данных находится в режиме восстановления с неполным протоколированием, данные между транзакции с неполным протоколированием и следующей транзакции журнал невозможно восстановить. | Выберите другую точку во времени для восстановления. [Узнайте больше](https://docs.microsoft.com/previous-versions/sql/sql-server-2008-r2/ms186229(v=sql.105)).


### <a name="fabricsvcbackuppreferencecheckfailedusererror"></a>FabricSvcBackupPreferenceCheckFailedUserError

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Backup preference for SQL Always On Availability Group cannot be met as some nodes of the Availability Group are not registered. (Требование резервного копирования для группы доступности SQL Always On не может быть выполнено, поскольку некоторые узлы группы доступности не зарегистрированы.) | Узлы, необходимые для выполнения резервного копирования, не зарегистрированы или недоступны. | <ul><li>Убедитесь, что все узлы, необходимые для выполнения резервного копирования этой базы данных, зарегистрированы и работоспособны, а затем повторите операцию.</li><li>Измените приоритет резервного копирования для группы доступности SQL Server Always On.</li></ul> |

### <a name="vmnotinrunningstateusererror"></a>VMNotInRunningStateUserError

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| SQL server VM is either shutdown and not accessible to Azure Backup service. (Виртуальная машина SQL server либо отключена, либо недоступна службе Azure Backup.) | Виртуальная машина отключается. | Убедитесь, что запущен экземпляр SQL Server. |

### <a name="guestagentstatusunavailableusererror"></a>GuestAgentStatusUnavailableUserError

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Служба Azure Backup использует гостевой агент виртуальной машины Azure VM для выполнения резервного копирования, но агент недоступен на целевом сервере. | Гостевой агент отключен или находится в неработоспособном состоянии. | [Установите гостевой агент виртуальной машины](../virtual-machines/extensions/agent-windows.md) вручную. |

### <a name="autoprotectioncancelledornotvalid"></a>AutoProtectionCancelledOrNotValid

| Сообщение об ошибке | Возможные причины | Рекомендуемое действие |
|---|---|---|
| Намерение автоматической защиты было удалено или больше не действительно. | При включении автоматической защиты на экземпляре SQL Server, **Настройка резервного копирования** задания выполняются для всех баз данных в этом экземпляре. Если отключить автоматическую защиту при выполнении заданий, **текущие** задания будут отменены и отобразится этот код ошибки. | Включите автоматическую защиту еще раз, для защиты всех оставшихся баз данных. |

## <a name="re-registration-failures"></a>Повторная регистрация ошибки

Проверьте для одного или нескольких из следующих симптомов, прежде чем инициировать операцию повторной регистрации:

* Все операции (таких как резервное копирование, восстановление и настройка резервного копирования) не удается установить на виртуальной Машине с помощью одного из следующих кодов ошибки: **WorkloadExtensionNotReachable**, **UserErrorWorkloadExtensionNotInstalled**, **WorkloadExtensionNotPresent**, **WorkloadExtensionDidntDequeueMsg**.
* **Состояние резервного копирования** отображается область для архивного элемента **недоступен**. Исключить все причины, которые могут появиться в том же состоянии:

  * Отсутствие разрешений на выполнение операций, связанных с резервной копии на виртуальной Машине  
  * Завершение работы виртуальной машины, поэтому резервные копии не может иметь место
  * Проблемы с сетью  

  ![«Недоступен» состояние в повторной регистрации виртуальной Машины](./media/backup-azure-sql-database/re-register-vm.png)

* В случае группы доступности AlwaysOn резервные копии начать функционировать с ошибками после изменения приоритета резервного копирования или после отработки отказа.

Такие проблемы могут возникать для одного или нескольких из следующих причин:

* Расширение удалена или удален с портала. 
* Это расширение было удалено с **панели управления** на виртуальную Машину в **удаление или изменение программы**.
* Виртуальная машина была восстановлена назад во времени через восстановления диска на месте.
* Виртуальная машина была завершена в течение продолжительного периода, поэтому конфигурацию расширения в его срок действия истек.
* Виртуальная машина удаляется, а другая виртуальная машина была создана с тем же именем и в той же группе ресурсов, что удаленной виртуальной Машины.
* Один из узлов группы доступности не получили полная конфигурация резервного копирования. Это может произойти, когда группы доступности будет зарегистрирована в хранилище, или при добавлении нового узла.

В предыдущем сценарии мы рекомендуем запустить операцию повторно зарегистрировать на виртуальной Машине. Сейчас этот параметр доступен только через PowerShell.

## <a name="size-limit-for-files"></a>Ограничение размера для файлов

Строка общий размер файлов зависит не только на количество файлов, но также и на их имена и пути. Для каждого файла базы данных получите логическое имя файла и физический путь. Можно использовать этот запрос SQL:

```
SELECT mf.name AS LogicalName, Physical_Name AS Location FROM sys.master_files mf
               INNER JOIN sys.databases db ON db.database_id = mf.database_id
               WHERE db.name = N'<Database Name>'"
```

Теперь, расположите их в следующем формате:

```
[{"path":"<Location>","logicalName":"<LogicalName>","isDir":false},{"path":"<Location>","logicalName":"<LogicalName>","isDir":false}]}
```

Ниже приведен пример:

```
[{"path":"F:\\Data\\TestDB12.mdf","logicalName":"TestDB12","isDir":false},{"path":"F:\\Log\\TestDB12_log.ldf","logicalName":"TestDB12_log","isDir":false}]}
```

Если размер строки содержимого превышает 20 000 байт, по-разному хранятся файлы базы данных. Во время восстановления будет возможность задать путь к целевому файлу для восстановления. Файлы будут восстановлены на путь SQL по умолчанию, предоставляемым SQL Server.

### <a name="override-the-default-target-restore-file-path"></a>Переопределить путь к файлу по умолчанию целевой объект восстановления

Можно переопределить путь к целевому файлу восстановления во время операции восстановления, поместив JSON-файл, содержащий сопоставление файла базы данных в целевой каталог восстановления. Создание `database_name.json` файл и поместите его в расположение *C:\Program Files\Azure рабочей нагрузки Backup\bin\plugins\SQL*.

Содержимое файла должно быть в следующем формате:
```
[
  {
    "Path": "<Restore_Path>",
    "LogicalName": "<LogicalName>",
    "IsDir": "false"
  },
  {
    "Path": "<Restore_Path>",
    "LogicalName": "LogicalName",
    "IsDir": "false"
  },  
]
```

Ниже приведен пример:

```
[
  {
   "Path": "F:\\Data\\testdb2_1546408741449456.mdf",
   "LogicalName": "testdb7",
   "IsDir": "false"
  },
  {
    "Path": "F:\\Log\\testdb2_log_1546408741449456.ldf",
    "LogicalName": "testdb7_log",
    "IsDir": "false"
  },  
]
```

В предыдущем содержимом логическое имя файла базы данных можно получить с помощью следующий SQL-запрос:

```
SELECT mf.name AS LogicalName FROM sys.master_files mf
                INNER JOIN sys.databases db ON db.database_id = mf.database_id
                WHERE db.name = N'<Database Name>'"
  ```


Этот файл должен размещаться перед запуском операции восстановления.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о службе архивации Azure для виртуальных машин SQL Server (Предварительная версия), см. в разделе [Azure Backup для виртуальных машин SQL](../virtual-machines/windows/sql/virtual-machines-windows-sql-backup-recovery.md#azbackup).
