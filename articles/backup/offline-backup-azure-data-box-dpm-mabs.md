---
title: Автономная архивация с Azure Data Box для DPM и MABS
description: Вы можете использовать Azure Data Box для заполнения начальных резервных копий данных в автономном режиме из DPM и MABS.
ms.topic: conceptual
ms.date: 08/12/2020
ms.openlocfilehash: 8b585dc46eb2bdd54e48950ca861f0edc8f0a7ed
ms.sourcegitcommit: faeabfc2fffc33be7de6e1e93271ae214099517f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/13/2020
ms.locfileid: "88187149"
---
# <a name="offline-seeding-using-azure-data-box-for-dpm-and-mabs-preview"></a>Автономное заполнение с помощью Azure Data Box для DPM и MABS (Предварительная версия)

> [!NOTE]
> Эта функция применима для Data Protection Manager (DPM) 2019 UR2 и более поздних версий.<br><br>
> Сейчас эта функция доступна в предварительной версии для Microsoft Azure Backup Server (MABS). Если вы хотите использовать Azure Data Box для автономного заполнения с помощью MABS, обратитесь к нам по адресу [systemcenterfeedback@microsoft.com](mailto:systemcenterfeedback@microsoft.com) .

В этой статье объясняется, как можно использовать Azure Data Box для заполнения начальных резервных копий данных в автономном режиме из DPM и MABS в хранилище служб восстановления Azure.

Вы можете использовать [Azure Data Box](https://docs.microsoft.com/azure/databox/data-box-overview) для заполнения больших исходных резервных копий DPM и MABS в автономном режиме (без использования сети) в хранилище служб восстановления. Этот процесс экономит время и пропускную способность сети, которая в противном случае использовала бы перемещение больших объемов данных резервных копий через сеть с высокой задержкой. Эта функция в настоящее время находится на стадии предварительной версии.

Автономное резервное копирование на основе Azure Data Box предоставляет два разных преимущества по сравнению с [автономным резервным копированием, основанным на службе импорта и экспорта Azure](backup-azure-backup-server-import-export.md):

- Вам не нужно приобретать собственные диски и соединители, совместимые с Azure. Azure Data Box поставляет диски, связанные с выбранным [Data Box SKU](https://azure.microsoft.com/services/databox/data/).

- Azure Backup (агент MARS) может напрямую записывать данные резервных копий на поддерживаемые номера SKU Azure Data Box. Эта возможность устраняет необходимость в подготовке промежуточного расположения для исходных данных резервного копирования. Кроме того, для форматирования и копирования этих данных на диски не нужны служебные программы.

## <a name="supported-platforms"></a>Поддерживаемые платформы

Поддерживаются следующие платформы:

- Windows Server 2019 64 bit (Standard, Datacenter, Essentials)
- Windows Server 2016 64 bit (Standard, Datacenter, Essentials)

## <a name="backup-data-size-and-supported-data-box-skus"></a>Размер данных резервной копии и поддерживаемые номера SKU Data Box

Поддерживаются следующие номера SKU Data Box:

| Размер данных резервной копии (после сжатия в режиме MARS) \* для каждого сервера | Поддерживаемый номер SKU Azure Data Box |
| --- | --- |
| \<= 7,2 ТБ | [Диск Azure Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-overview) |
| > 7,2 ТБ и <= 80 ТБ\*\* | [Azure Data Box (100 ТБ)](https://docs.microsoft.com/azure/databox/data-box-overview) |

\*Стандартные скорости сжатия зависят от 10-20% <br>
\*\*[SystemCenterFeedback@microsoft.com](mailto:SystemCenterFeedback@microsoft.com)Если вы планируете использовать более 80 ТБ начальных резервных копий данных для одного источника данных, можно обратиться к.

> [!IMPORTANT]
> Начальные данные резервного копирования из одного источника данных должны содержаться в одном Azure Data Box или Azure Data Box диске и не могут совместно использоваться несколькими устройствами одного или разных номеров SKU. Однако Azure Data Box может содержать начальные резервные копии из нескольких источников данных.

## <a name="before-you-begin"></a>Перед началом работы

Агент MARS, выполняющийся на DPM/MABS, должен быть обновлен до [последней версии](https://aka.ms/azurebackup_agent) (2.0.9171.0 или более поздняя версия).

Убедитесь, что:

### <a name="azure-subscription-and-required-permissions"></a>Подписка Azure и необходимые разрешения

- Действующая подписка Azure.
- Пользователь, предназначенный для выполнения политики автономного резервного копирования, должен быть владельцем подписки Azure.
- В одних и тех же подписках должны быть доступны задания Data Box и хранилище служб восстановления, в которые необходимо заполнить данные.
    > [!NOTE]
    > Рекомендуется, чтобы Целевая учетная запись хранения и хранилище служб восстановления нав одном регионе. Однако это необязательно.

### <a name="order-and-receive-the-data-box-device"></a>Заказ и получение устройства Data Box

Перед активацией автономного резервного копирования убедитесь, что требуемые устройства Data Box находятся в состоянии *доставки* . Чтобы заказать наиболее подходящий SKU для вашего требования, см. раздел [Размер данных резервного копирования и поддерживаемые Data Box SKU](#backup-data-size-and-supported-data-box-skus) . Выполните действия, описанные в [этой статье](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-ordered) , чтобы заказать и получить устройства Data Box.

> [!IMPORTANT]
> Не выбирайте *блобстораже* для **типа учетной записи**. Для сервера DPM/MABS требуется учетная запись, которая поддерживает страничные BLOB-объекты, которые не поддерживаются при выборе *блобстораже* . Выберите **хранилище версии 2 (общего назначения версии 2)** в качестве **типа учетной записи** при создании целевой учетной записи хранения для задания Azure Data Box.

![Настройка Azure датабокс](./media/offline-backup-azure-data-box-dpm-mabs/setup-azure-databox.png)

## <a name="setup-azure-data-box-devices"></a>Установка Azure Data Box устройств

Получив Azure Data Box устройство, в зависимости от заказанного Azure Data Box номера SKU выполните действия, описанные в соответствующих разделах ниже, чтобы настроить и подготовить устройства Data Box для сервера DPM/MABS, чтобы определить и переместить исходные данные резервной копии.

### <a name="setup-azure-data-box-disk"></a>Установка Azure Data Box диска

Если вы заказали один или несколько Azure Data Box дисков (по 8 ТБ), выполните описанные [здесь](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-set-up) действия, чтобы распаковать, подключить и разблокировать диск Data Box.

> [!NOTE]
> Возможно, сервер DPM/MABS не имеет USB-порта. В таком случае можно подключить диск Azure Data Box к другому серверу или клиенту и предоставить корневой каталог устройства в качестве сетевой папки.

## <a name="setup-azure-data-box"></a>Azure Data Box установки

Если вы задали Azure Data Box (до 100 ТБ), выполните действия, описанные [здесь](https://docs.microsoft.com/azure/databox/data-box-deploy-set-up) , чтобы настроить Data Box.

### <a name="mount-your-azure-data-box-as-local-system"></a>Подключение Azure Data Box в качестве локальной системы

Сервер DPM/MABS работает в контексте системы, поэтому для пути подключения, в котором подключена Azure Data Box, необходимо предоставить тот же уровень привилегий. Выполните следующие действия, чтобы подключить устройство Data Box в качестве локальной системы с помощью протокола NFS.

1. Включите функцию клиент для NFS на сервере DPM/MABS.
Укажите альтернативный источник: *WIM: D: \саурцес\инсталл.Вим: 4*
2. Скачайте **PsExec** с [https://download.sysinternals.com/files/PSTools.zip](https://download.sysinternals.com/files/PSTools.zip) сервера DPM или MABS.
3. Откройте командную строку с повышенными привилегиями и выполните следующую команду с каталогом, содержащим *PSExec.exe* в качестве текущего каталога.

   ```cmd
   psexec.exe  -s  -i  cmd.exe
   ```

4. Командное окно, открывающееся в результате выполнения приведенной выше команды, находится в контексте локальной системы. Используйте это окно командной строки, чтобы выполнить шаги для подключения общего ресурса страничного BLOB-объекта Azure в качестве сетевого диска на сервере Windows Server.
5. Выполните [следующие действия,](https://docs.microsoft.com/azure/databox/data-box-deploy-copy-data-via-nfs#connect-to-data-box) чтобы ПОДКЛЮЧИТЬ сервер DPM/MABS к устройству Data Box с помощью NFS и выполнить следующую команду в командной строке локальной системы, чтобы подключить общую папку BLOB-объектов Azure:

    ```cmd
    mount -o nolock \\<DeviceIPAddres>\<StorageAccountName_PageBlob X:
    ```

6. После подключения проверьте, есть ли доступ к X: с сервера. Если вы можете, перейдите к следующему разделу этой статьи.

## <a name="transfer-initial-backup-data-to-azure-data-box-devices"></a>Перенос данных начального резервного копирования на устройства Azure Data Box

1. На сервере DPM/MABS выполните действия по [созданию новой группы защиты](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups?view=sc-dpm-2019). Если вы добавляете оперативную защиту в существующую группу защиты, щелкните правой кнопкой мыши существующую группу защиты и выберите команду **Добавить оперативную защиту** и начать с **шага 8**.
2. На странице **Выбор членов группы** укажите компьютеры и источники, для которых требуется создать резервную копию.
3. На странице **Выбор метода защиты данных** укажите способ управления краткосрочной и долгосрочной архивацией. Обязательно выберите вариант **оперативная защита.**

   ![Создать новую группу защиты](./media/offline-backup-azure-data-box-dpm-mabs/create-new-protection-group.png)

4. На странице **выбор краткосрочных целей** укажите способ резервного копирования для краткосрочного хранения на диске.
5. На странице **Проверка выделения места на диске** проверьте место на диске пула носителей, выделенное для группы защиты.
6. На странице **Выбор метода создания реплики** установите флажок **автоматически по сети.**
7. На странице **Выбор параметров проверки согласованности** выберите способ автоматизации проверок согласованности.
8. На странице **Указание данных для оперативной защиты** выберите участника, для которого требуется включить оперативную защиту.

    ![Выбор оперативной защиты данных](./media/offline-backup-azure-data-box-dpm-mabs/specify-online-protection-data.png)

9. На странице **укажите расписание оперативного резервного копирования** укажите, как часто должны выполняться добавочные резервные копии в Azure.
10. На странице **Указание политики хранения в сети** укажите, как точки восстановления, создаваемые из ежедневных, еженедельных, ежемесячных или ежегодных резервных копий, сохраняются в Azure.
11. На экране мастера **Выбор репликации в сети** выберите параметр **передать с помощью дисков, принадлежащих корпорации Майкрософт** , и нажмите кнопку **Далее**.

    ![Выберите начальную репликацию в сети](./media/offline-backup-azure-data-box-dpm-mabs/choose-initial-online-replication.png)

    >[!NOTE]
    > Возможность выбора параметра **передать с помощью дисков, принадлежащих корпорации Майкрософт** , недоступна для MABS v3, так как эта функция находится на этапе предварительной версии. Обратитесь к нам по адресу [systemcenterfeedback@microsoft.com](mailto:systemcenterfeedback@microsoft.com) , если вы хотите использовать эту функцию для MABS v3.

12. При появлении запроса войдите в Azure, используя учетные данные пользователя с правами владельца в подписке Azure. После успешного входа появится следующий экран:

    ![После успешного входа](./media/offline-backup-azure-data-box-dpm-mabs/after-successful-login.png)

     После этого сервер DPM/MABS выберет задания Data Box в подписке, которая находится в состоянии *доставлено* .

     > [!NOTE]
     > Первый раз вход в систему занимает больше времени, чем обычно. Модуль Azure PowerShell устанавливается в фоновом режиме, а также регистрируется приложение Azure AD.
     >
     >  - Установлены следующие модули PowerShell:<br>
          -AzureRM. Profile *5.8.3*<br>
          -AzureRM. Resources *6.7.3*<br>
          -AzureRM. хранилище *5.2.0*<br>
          — Azure. Storage *4.6.1*<br>
     >  - Приложение Azure AD регистрируется как *AzureOfflineBackup_ \<object GUID of the user> *.

13. Выберите правильный порядок полей данных, для которого был распакован, подключен и разблокирован диск Data Box. Выберите **Далее**.

    ![Выберите датабокс](./media/offline-backup-azure-data-box-dpm-mabs/select-databox.png)

14. На экране **Обнаружение датабокс** введите путь к устройству Data Box, а затем выберите пункт **обнаружить устройство**.

    ![Введите сетевой путь](./media/offline-backup-azure-data-box-dpm-mabs/enter-network-path.png)

    > [!IMPORTANT]
    > Укажите сетевой путь к корневому каталогу Azure Data Box диска. Этот каталог должен содержать каталог по имени *PageBlob* , как показано ниже:
    >
    > ![USB-накопитель](./media/offline-backup-azure-data-box-dpm-mabs/usb-drive.png)
    >
    > Например, если путь к диску — `\\mydomain\myserver\disk1\` и *disk1* содержит каталог с именем *PageBlob*, то путь, который должен быть указан в мастере сервера DPM/MABS, — это `\\mydomain\myserver\disk1\` .
    > При [установке устройства Azure Data Box 100 ТБ](https://docs.microsoft.com/azure/backup/offline-backup-azure-data-box#setup-azure-data-box)укажите в качестве сетевого пути к устройству следующий путь `\\<DeviceIPAddress>\<StorageAccountName>_PageBlob` .

15. Выберите **Далее**. На странице **Сводка** проверьте параметры и нажмите кнопку **создать группу**.

    ![Обнаружение датабокс](./media/offline-backup-azure-data-box-dpm-mabs/detect-databox.png)

    На следующем экране подтвердится, что Группа защиты создана успешно.

    ![Группа защиты создана](./media/offline-backup-azure-data-box-dpm-mabs/protection-group-created.png)

16. Нажмите кнопку **Закрыть** на экране выше.

    В этом случае начальная репликация данных происходит на диск DPM/MABS. Когда она завершит защиту, на странице **Защита** в поле Состояние группы отобразится состояние защита **ОК** .

17. Чтобы запустить автономную резервную копию на устройстве Azure Data Box, щелкните правой кнопкой мыши **группу защиты**и выберите пункт **создать точку восстановления** . Затем выберите параметр **Оперативная защита**.

    ![Создать точку восстановления](./media/offline-backup-azure-data-box-dpm-mabs/create-recovery-point.png)

    ![Точка восстановления](./media/offline-backup-azure-data-box-dpm-mabs/recovery-point.png)

   Сервер DPM/MABS запустит резервное копирование данных, выбранных на устройство Azure Data Box. Это может занять от нескольких часов до нескольких дней в зависимости от размера данных и скорости подключения между сервером DPM/MABS и Диск Azure Data Box.

   Состояние задания можно отслеживать на панели " **мониторинг** ". После завершения резервного копирования данных вы увидите экран, похожий на следующий:

   ![Консоль администратора](./media/offline-backup-azure-data-box-dpm-mabs/administrator-console.png)

## <a name="post-backup-steps"></a>Действия, выполняемые после резервного копирования

Выполните следующие действия после успешного резервного копирования данных на Диск Azure Data Box.

- Выполните действия, описанные в [этой статье](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-picked-up) , чтобы отправить Azure Data Box диск в Azure. Если вы использовали устройство Azure Data Box 100 ТБ, выполните следующие [действия](https://docs.microsoft.com/azure/databox/data-box-deploy-picked-up) , чтобы отправить Azure Data Box в Azure.
- [Отслеживайте задание Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-upload-verify) в портал Azure. После *завершения*задания Azure Data Box сервер DPM/MABS автоматически переместит данные из учетной записи хранения в хранилище служб восстановления во время следующего запланированного резервного копирования. После этого задание резервного копирования будет отмечено как *Задание завершено* , если точка восстановления создана успешно.

  > [!NOTE]
  > Сервер DPM/MABS запускает резервное копирование в запланированное время во время создания группы защиты. Однако эти задания будут помечаться *как ожидающие выполнения задания Azure Data Box* до момента завершения задания.

- После того как сервер DPM/MABS успешно создаст точку восстановления, соответствующую первоначальной резервной копии, вы можете удалить учетную запись хранения (или конкретное содержимое), связанную с заданием Azure Data Box.

## <a name="troubleshooting"></a>Устранение неполадок

Агент Microsoft Azure Backup (MAB) на сервере DPM создает приложение Azure AD для вас в клиенте. Для этого приложения требуется сертификат для проверки подлинности, который создается и передается при настройке политики заполнения в автономном режиме.

Для создания и отправки сертификата в приложение Azure AD используется Azure PowerShell.

### <a name="issue"></a>Проблема

Во время настройки автономного резервного копирования из-за известного дефекта кода в командлете Azure PowerShell вы не можете добавить несколько сертификатов в одно приложение Azure AD, созданное агентом MAB. Это повлияет на то, что вы настроили политику автономного заполнения для того же или другого сервера.

### <a name="verify-if-the-issue-is-caused-by-this-specific-root-cause"></a>Убедитесь, что проблема вызвана конкретной основной причиной

Чтобы убедиться, что ошибка вызвана описанной выше [проблемой](#issue) , выполните одно из следующих действий.

#### <a name="step-1"></a>Шаг 1

Проверьте, отображается ли следующее сообщение об ошибке в консоли DPM/MABS во время настройки автономного резервного копирования:

![Агент служб восстановления Azure](./media/offline-backup-azure-data-box-dpm-mabs/azure-recovery-services-agent.png)

#### <a name="step-2"></a>Шаг 2

1. Откройте папку **TEMP** в пути установки (путь к временной папке по умолчанию — *C:\Program Files\Microsoft Azure Recovery Services ажент\темп*. Найдите файл *кбуикурр* и откройте его.
2. В файле *кбуикурр* прокрутите до последней строки и проверьте, не удалось ли создать учетные данные приложения Azure AD в учетной записи клиента. Исключение: обновление существующих учетных данных с помощью KeyId \<some guid> не разрешено ".

### <a name="workaround"></a>Обходной путь

Чтобы устранить эту проблему, выполните следующие действия и повторите настройку политики.

1. Войдите на страницу входа Azure, которая отображается в пользовательском интерфейсе сервера DPM/MABS, используя другую учетную запись с правами администратора в подписке, в которой будет создано задание импорта экспорта.
2. Если на другом сервере не настроено автономное заполнение, а другие серверы не зависят от `AzureOfflineBackup_<Azure User Id>` приложения, удалите это приложение из **портал Azure > Azure Active Directory > регистрация приложений**.

   > [!NOTE]
   > Убедитесь, что в приложении `AzureOfflineBackup_<Azure User Id>` не настроено другое начальное заполнение, а другие серверы не зависят от этого приложения. Перейдите в раздел **параметры > ключи** в разделе открытые ключи, для которого не должны быть добавлены другие **открытые ключи** . Справочные сведения см. на следующем снимке экрана:
   >
   > ![Открытые ключи](./media/offline-backup-azure-data-box-dpm-mabs/public-keys.png)

#### <a name="step-3"></a>Шаг 3

На сервере DPM/MABS, для которого вы пытаетесь настроить автономную архивацию, выполните следующие действия.

1. Откройте вкладку **Управление сертификатом компьютера**  >  **личное** и найдите сертификат с именем `CB_AzureADCertforOfflineSeeding_<ResourceId>` .
2. Выберите указанный выше сертификат, щелкните правой кнопкой мыши **все задачи** и **экспортируйте** без закрытого ключа в формате CER.
3. Перейдите в приложение автономного резервного копирования Azure, упомянутое в **точке 2**. В разделе **Параметры**  >  **Keys**  >  **Отправка открытого ключа** отправьте сертификат, экспортированный на предыдущем шаге.

   ![Отправка открытых ключей](./media/offline-backup-azure-data-box-dpm-mabs/upload-public-keys.png)

4. На сервере откройте реестр, введя в окне **выполнения** команду **regedit** .
5. Перейдите в раздел реестра *Компутер\хкэй \_ Local \_ мачине\софтваре\микрософт\виндовс Azure баккуп\конфиг\клаудбаккуппровидер*. Щелкните правой кнопкой мыши **клаудбаккуппровидер** и добавьте новое строковое значение с именем `AzureADAppCertThumbprint_<Azure User Id>` .

    >[!NOTE]
    > Чтобы получить идентификатор пользователя Azure, выполните одно из следующих действий.
    >
    >- В PowerShell, подключенном к Azure, выполните `Get-AzureRmADUser -UserPrincipalName "Account Holder's email as defined in the portal"` команду.
    > - Перейдите к пути реестра `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DbgSettings\OnlineBackup` с именем *куррентусерид*.

6. Щелкните правой кнопкой мыши строку, добавленную на шаге выше, и выберите пункт **изменить**. В поле значение укажите отпечаток сертификата, экспортированного в **точке 2** , и нажмите кнопку **ОК**.
7. Чтобы получить значение отпечатка, дважды щелкните сертификат, а затем выберите **сведения** и прокрутите вниз, пока не появится поле отпечаток. Выберите **отпечаток** и скопируйте значение.

   ![Сертификат](./media/offline-backup-azure-data-box-dpm-mabs/certificate.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Автономное заполнение с помощью собственного диска (с помощью службы импорта и экспорта Azure)](backup-azure-backup-server-import-export.md)
