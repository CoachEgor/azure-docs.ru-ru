---
title: Создание резервных копий баз данных SQL Server на виртуальных машинах Azure
description: Из этой статьи вы узнаете, как выполнять резервное копирование SQL Server баз данных на виртуальных машинах Azure с Azure Backup.
ms.reviewer: vijayts
ms.topic: conceptual
ms.date: 09/11/2019
ms.openlocfilehash: 8125f6d98151f91faaccef512e4bcfd2946fcdd0
ms.sourcegitcommit: 984c5b53851be35c7c3148dcd4dfd2a93cebe49f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2020
ms.locfileid: "76773121"
---
# <a name="back-up-sql-server-databases-in-azure-vms"></a>Создание резервных копий баз данных SQL Server на виртуальных машинах Azure

SQL Server базы данных — это критически важные рабочие нагрузки, для которых требуется низкая Целевая точка восстановления (RPO) и долгосрочное хранение. Вы можете выполнять резервное копирование SQL Server баз данных, работающих на виртуальных машинах Azure, с помощью [Azure Backup](backup-overview.md).

В этой статье показано, как создать резервную копию базы данных SQL Server, которая работает на виртуальной машине Azure, в хранилище служб восстановления Azure Backup.

В этой статье вы узнаете, как выполнять следующие задачи.

> [!div class="checklist"]
>
> * создание и настройка хранилища;
> * Обнаружение баз данных и Настройка резервных копий.
> * настройка автоматической защиты для баз данных.

>[!NOTE]
>**Обратимое удаление для SQL Server в виртуальной машине Azure и обратимое удаление для SAP HANA в рабочих нагрузках виртуальных машин Azure** теперь доступно в предварительной версии.<br>
>Чтобы зарегистрироваться для просмотра, напишите нам по адресу AskAzureBackupTeam@microsoft.com

## <a name="prerequisites"></a>Технические условия

Перед созданием резервной копии SQL Server базы данных проверьте следующие критерии.

1. Выявление или создание [хранилища служб восстановления](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) в том же регионе и подписке, что и виртуальная машина, на которой размещен экземпляр SQL Server.
2. Убедитесь, что виртуальная машина подключена [к сети](backup-sql-server-database-azure-vms.md#establish-network-connectivity).
3. Убедитесь, что SQL Server базы данных соответствуют [рекомендациям по именованию баз данных для Azure Backup](#database-naming-guidelines-for-azure-backup).
4. Убедитесь, что для базы данных не включены другие решения резервного копирования. Отключите все остальные SQL Server резервные копии, прежде чем создавать резервную копию базы данных.

> [!NOTE]
> Вы можете включить Azure Backup для виртуальной машины Azure, а также для SQL Server базы данных, работающей на виртуальной машине, без конфликтов.

### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций SQL Server виртуальной машине требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам Azure.

Установите подключение, используя один из следующих вариантов.

#### <a name="allow-the-azure-datacenter-ip-ranges"></a>Разрешение диапазонов IP-адресов центра обработки данных Azure

Этот параметр разрешает [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в скачанном файле. Чтобы получить доступ к группе безопасности сети, используйте командлет "Set-AzureNetworkSecurityRule". Если список надежных получателей содержит только IP-адреса, относящиеся к региону, вам также нужно обновить список безопасных получателей тегом службы Azure Active Directory (Azure AD), чтобы включить проверку подлинности.

#### <a name="allow-access-using-nsg-tags"></a>Разрешение доступа с помощью тегов NSG

При использовании NSG для ограничения возможностей подключения следует использовать тег службы AzureBackup, чтобы разрешить исходящий доступ к Azure Backup. Кроме того, вы также можете разрешить подключение для проверки подлинности и передачу данных, используя [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и службы хранилища Azure. Это можно сделать на портале Azure или с помощью PowerShell.

Чтобы создать правило с помощью портала, выполните следующие действия.

  1. В разделе **Все службы** перейдите к **группам сетевой безопасности** и выберите группу сетевой безопасности.
  2. Выберите **Правила безопасности для исходящего трафика** в разделе **Параметры**.
  3. Выберите **Добавить**. Введите все необходимые сведения для создания нового правила, как описано в разделе [параметры правила безопасности](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group#security-rule-settings). Убедитесь, что параметр **Назначение** имеет значение **Тег службы**, а **Тег целевой службы** имеет значение **AzureBackup**.
  4. Щелкните **Добавить**, чтобы сохранить только что созданное исходящее правило безопасности.

Чтобы создать правило с помощью PowerShell, выполните следующие действия.

 1. Добавление учетных данных учетной записи Azure и обновление национальных облаков<br/>
      `Add-AzureRmAccount`<br/>

 2. Выберите подписку NSG<br/>
      `Select-AzureRmSubscription "<Subscription Id>"`

 3. Выберите NSG<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

 4. Добавление разрешающего правила исходящего трафика для тега службы Azure Backup<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 5. Добавление разрешающего правила исходящего трафика для тега Службы хранилища<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "StorageAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "Storage" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 6. Добавление разрешающего правила исходящего трафика для тега AzureActiveDirectory<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureActiveDirectoryAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureActiveDirectory" -DestinationPortRange 443 -Description "Allow outbound traffic to AzureActiveDirectory service"`

 7. Сохраните файл NSG<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`

**Разрешите доступ с помощью тегов брандмауэра Azure**. Если вы используете брандмауэр Azure, создайте правило приложения с помощью[тега AzureBackup FQDN](https://docs.microsoft.com/azure/firewall/fqdn-tags). Это разрешает исходящий доступ к службам Azure Backup.

**Развертывание прокси-сервера HTTP для маршрутизации трафика**. При создании резервной копии базы данных SQL Server на ВИРТУАЛЬНОЙ машине Azure расширение резервного копирования на виртуальной машине использует API-интерфейсы HTTPS для отправки команд управления Azure Backup и данных в службу хранилища Azure. Расширение резервного копирования также использует Azure AD для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Варианты подключения включают следующие преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure
Использование тегов службы NSG | Упрощенное управление благодаря автоматическому объединению изменений диапазона <br/><br/> Нет дополнительных затрат <br/><br/> | Может использоваться только с NSG <br/><br/> Предоставляет доступ ко всей службе
Использование тегов полного доменного имени службы "Брандмауэр Azure" | Проще управлять, так как требуемые управляются FQDN автоматически | Можно использовать только с брандмауэром Azure
Использование прокси-сервера HTTP | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере <br/><br/> Единая точка доступа к виртуальным машинам через Интернет <br/><br/> Не подвергается влиянию изменений IP-адресов Azure | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера

### <a name="database-naming-guidelines-for-azure-backup"></a>Рекомендации по именованию баз данных для Azure Backup

Не используйте следующие элементы в именах баз данных:

* Конечные и начальные пробелы
* Конечные восклицательные знаки (!)
* Закрывающие квадратные скобки (])
* Точка с запятой ";"
* Косая черта "/"

Псевдонимы доступны для неподдерживаемых символов, но рекомендуется избегать их использования. Дополнительные сведения см. в статье [Understanding the Table Service Data Model](https://docs.microsoft.com/rest/api/storageservices/Understanding-the-Table-Service-Data-Model?redirectedfrom=MSDN) (Общие сведения о модели данных службы таблиц).

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Обнаружение баз данных, работающих на виртуальной машине:

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. На панели мониторинга **хранилища служб восстановления** выберите **резервное копирование**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В поле **цель резервного копирования**укажите, **где выполняется рабочая нагрузка?** в **Azure**.

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В меню **Цель резервного копирования** > **Обнаружить базы данных в виртуальных машинах** выберите **Запустить обнаружения**, чтобы найти незащищенные виртуальные машины в подписке. Поиск может занять некоторое время в зависимости от числа незащищенных виртуальных машин в подписке.

   * После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   * Если виртуальная машина не указана как можно скорее, проверьте, не была ли она создана в хранилище.
   * Несколько виртуальных машин могут иметь одно и то же имя, но они будут принадлежать к разным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Следите за обнаружением базы данных в **уведомлениях**. Время, необходимое для выполнения этого действия, зависит от количества баз данных виртуальных машин. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения в фоновом режиме выполняются следующие элементы:

    * Azure Backup регистрирует виртуальную машину в хранилище для резервного копирования рабочей нагрузки. Все базы данных на зарегистрированной виртуальной машине можно архивировать только в этом хранилище.
    * Azure Backup устанавливает расширение Азуребаккупвиндовсворклоад на виртуальной машине. Агент не установлен в базе данных SQL.
    * Azure Backup создает учетную запись службы NT Сервице\азуревлбаккупплугинсвк на виртуальной машине.
      * Все операции резервного копирования и восстановления используют учетную запись службы.
      * Для NT Сервице\азуревлбаккупплугинсвк требуются разрешения системного администратора SQL. Все SQL Server виртуальные машины, созданные в Marketplace, входят в состав установленной SqlIaaSExtension. Расширение Азуребаккупвиндовсворклоад использует SQLIaaSExtension для автоматического получения необходимых разрешений.
    * Если вы не создали виртуальную машину из Marketplace или используете SQL 2008 и 2008 R2, на виртуальной машине может не быть установлен SqlIaaSExtension, а операция обнаружения завершится с сообщением об ошибке Усереррорсклносисадминмембершип. Чтобы устранить эту проблему, следуйте инструкциям в разделе [Set VM Permissions](backup-azure-sql-database.md#set-vm-permissions).

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

1. На странице **цель резервного копирования** > **Шаг 2. Настройка архивации**выберите **настроить резервное копирование**.

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. В поле **выберите элементы для резервного копирования**отображаются все зарегистрированные группы доступности и изолированные экземпляры SQL Server. Щелкните стрелку слева от строки, чтобы развернуть список всех незащищенных баз данных в этом экземпляре или Always On группы доступности.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выберите все базы данных, которые необходимо защитить, а затем нажмите кнопку **ОК**.

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Для защиты более 50 баз данных настройте несколько резервных копий.
     * Чтобы [включить](#enable-auto-protection) весь экземпляр или группу доступности Always on, в раскрывающемся списке **автозащита** выберите значение **вкл**., а затем нажмите кнопку **ОК**.

    > [!NOTE]
    > Функция [автоматической защиты](#enable-auto-protection) не только включает защиту для всех существующих баз данных одновременно, но и автоматически защищает любые новые базы данных, добавленные в этот экземпляр или группу доступности.  

4. Нажмите кнопку **ОК** , чтобы открыть **политику архивации**.

    ![Включить автоматическую защиту для Always On группы доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В списке **политика резервного копирования**выберите политику и нажмите кнопку **ОК**.

   * Выберите политику по умолчанию в качестве Хаурлилогбаккуп.
   * выбрать существующую политику резервного копирования, созданную ранее для SQL;
   * Определите новую политику на основе целевой точки восстановления (RPO) и периода хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. В разделе **Архивация** выберите **Включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. В области **Уведомления** портала можно отслеживать ход настройки.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
* При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
* Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
* Сведения о [различных типах политик архивации](backup-architecture.md#sql-server-backup-types).

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище выберите **политики архивации** > **Добавить**.
2. В окне **Добавить**выберите **SQL Server на виртуальной машине Azure** , чтобы определить тип политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В меню **Политика полного резервного копирования** выберите **Частота резервного копирования**. Выберите **ежедневно** или **еженедельно**.

   * Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   * Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.
   * Выполните полную архивацию, так как невозможно отключить параметр **полного резервного копирования** .
   * Выберите **полная архивация** , чтобы просмотреть политику.
   * При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. В **области хранения**по умолчанию выбраны все параметры. Удалите все ненужные пределы диапазона хранения, а затем задайте используемые интервалы.

    * Минимальный срок хранения для любого типа резервных копий (полная, разностная и журнал) составляет семь дней.
    * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    * Резервная копия за конкретный день помечается и сохраняется на основе еженедельного диапазона хранения и параметра еженедельного хранения.
    * Месячные и ежегодные диапазоны хранения ведут себя аналогичным образом.

       ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    * Вы можете активировать только одну разностную резервную копию в день.
    * Максимальный срок хранения разностных резервных копий составляет 180 дней. Для более длительного хранения используйте полные резервные копии.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование журналов может происходить каждые 15 минут и может храниться в течение 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **Политика архивации** выберите, следует ли включить **Сжатие резервной копии SQL** . По умолчанию этот параметр отключен. Если параметр включен, SQL Server будет передавать сжатый поток резервного копирования в VDI.  Обратите внимание, что Azure Backup переопределяет значения по умолчанию на уровне экземпляра с помощью предложения COMPRESSION/NO_COMPRESSION в зависимости от значений этого элемента управления.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.

> [!NOTE]
> Каждая резервная копия журнала связана с предыдущей полной резервной копией, образуя цепочку восстановления. Эта полная резервная копия будет храниться до истечения срока хранения последней резервной копии журнала. Это может означать, что полная резервная копия сохраняется в течение дополнительного периода, чтобы гарантировать возможность восстановления всех журналов. Предположим, что у пользователя есть еженедельное полное резервное копирование, ежедневное разностное и 2-часовой журналы. Все они хранятся в течение 30 дней. Однако еженедельное полное удаление может быть действительно очищено только после того, как будет доступна следующая полная резервная копия, т. е. через 30 + 7 дней. Скажем, еженедельное полное резервное копирование происходит в 16 ноября. Согласно политике хранения, ее следует хранить до декабря в 16 часов. Последняя резервная копия журнала для этого полного выполнения происходит до следующего запланированного заполнения в 22 ноября. До тех пор пока этот журнал не будет доступен до декабря 22, не удается удалить все 16 ноября. Таким образом, в 16 ноября будет храниться до декабря 22.

## <a name="enable-auto-protection"></a>Включение автоматической защиты  

Можно включить автоматическую защиту для автоматического резервного копирования всех существующих и будущих баз данных на автономный экземпляр SQL Server или в группу доступности Always On.

* Количество баз данных, которые можно выбрать для автоматической защиты, не ограничено.
* Нельзя выборочно защищать или исключать базы данных из защиты в экземпляре во время включения автоматической защиты.
* Если ваш экземпляр уже содержит некоторые защищенные базы данных, они останутся защищенными в соответствующих политиках даже после включения автоматической защиты. Все незащищенные базы данных, добавленные позже, будут иметь только одну политику, определяемую во время включения автоматической защиты, которая указана в разделе **Настройка резервного копирования**. Однако политику, связанную с автоматической защитой базы данных, можно изменить позже.  

Чтобы включить автоматическую защиту, выполните следующие действия.

  1. В меню **Архивируемые элементы** выберите экземпляр, для которого вы хотите включить автоматическую защиту.
  2. Выберите раскрывающийся список в разделе **автозащита**, выберите **вкл**., а затем нажмите кнопку **ОК**.

      ![Включение автоматической защиты в группе доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

  3. Настройка резервного копирования активируется для всех баз данных вместе, и ее можно отслеживать в разделе **заданий резервного копирования**.

Если необходимо отключить автоматическую защиту, выберите имя экземпляра в разделе **Настройка резервного копирования**, а затем выберите **Отключить автозащиту** для экземпляра. Резервное копирование всех баз данных будет продолжаться, но будущие базы данных не будут автоматически защищены.

![Отключить автоматическую защиту для этого экземпляра](./media/backup-azure-sql-database/disable-auto-protection.png)

## <a name="next-steps"></a>Дальнейшие действия

На вебинаре будут рассматриваться следующие темы:

* [Восстановление резервных копий баз данных SQL Server](restore-sql-database-azure-vm.md)
* [Управление резервными копиями баз данных SQL Server](manage-monitor-sql-database-backup.md)
