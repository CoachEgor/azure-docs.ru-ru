---
title: Резервное копирование баз данных SQL Server на виртуальных машинах Azure | Документация Майкрософт
description: Узнайте, как создавать резервные копии баз данных SQL Server на виртуальных машинах Azure
services: backup
author: sachdevaswati
manager: vijayts
ms.service: backup
ms.topic: conceptual
ms.date: 03/23/2019
ms.author: sachdevaswati
ms.openlocfilehash: 2fba8b0056c80a62837682a6820b68f71fba9ea8
ms.sourcegitcommit: 24fd3f9de6c73b01b0cee3bcd587c267898cbbee
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2019
ms.locfileid: "65952933"
---
# <a name="back-up-sql-server-databases-in-azure-vms"></a>Создание резервных копий баз данных SQL Server на виртуальных машинах Azure

Базы данных SQL Server являются критически важными рабочими нагрузками, которые требуют низкой точка восстановления (RPO) и долгосрочного хранения. Можно выполнить резервное копирование баз данных SQL Server на виртуальных машинах (ВМ) Azure с помощью [Azure Backup](backup-overview.md).

В этой статье показано, как резервное копирование базы данных SQL Server, на котором выполняется на виртуальной Машине Azure в хранилище служб восстановления Azure Backup.

В этой статье вы узнаете, как:

> [!div class="checklist"]
> * создание и настройка хранилища;
> * Обнаружение баз данных и настройка резервного копирования.
> * настройка автоматической защиты для баз данных.


## <a name="prerequisites"></a>Технические условия

Перед выполнением резервного копирования базы данных SQL Server, проверьте следующие условия:

1. Определите или создайте [хранилище служб восстановления](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) в том же регионе или языковой стандарт в качестве виртуальной Машины, где размещен экземпляр SQL Server.
2. Проверьте [виртуальной Машины разрешения, необходимые](backup-azure-sql-database.md#fix-sql-sysadmin-permissions) для резервного копирования баз данных SQL.
3. Убедитесь, что виртуальная машина имеет [сетевое подключение](backup-sql-server-database-azure-vms.md#establish-network-connectivity).
4. Убедитесь, что базы данных SQL Server выполните [базы данных рекомендации по именованию для резервного копирования Azure](#database-naming-guidelines-for-azure-backup).
5. Убедитесь, что у вас нет любые другие средства резервного копирования базы данных включено. Отключите все другие резервные копии SQL Server, прежде чем вы резервную копию базы данных.

> [!NOTE]
> Вы можете включить резервное копирование Azure для виртуальной Машины Azure, а также для базы данных SQL Server на виртуальной Машине без конфликтов.


### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций виртуальную Машину SQL Server требуется подключение к Azure общедоступных IP-адресов. Без подключения к Azure общедоступных IP-адресов сбой операций виртуальной Машины (обнаружение баз данных, настройка резервных копий, запланировать резервное копирование, восстановить точки восстановления и так далее).

Установите подключение с помощью одного из следующих вариантов:

- **Разрешить IP-адресов центра обработки данных Azure**. Этот параметр позволяет [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в загрузку. Чтобы получить доступ к группу безопасности сети (NSG), используйте командлет Set-AzureNetworkSecurityRule. Если вы утвержденный список только конкретного региона IP-адресов, вы будете также требуется Azure Active Directory (Azure AD) в список разрешений тег службы для включения проверки подлинности.

- **Разрешить доступ с помощью тегов NSG**. Если вы используете группы безопасности сети, чтобы ограничить возможности подключения, этот параметр добавляет правило в группу безопасности сети, которое разрешает исходящий доступ к службе архивации Azure с помощью тега AzureBackup. Помимо этого тега, вам также потребуется соответствующий [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и хранилища Azure, чтобы разрешить подключения для проверки подлинности и передачи данных. Тег AzureBackup только на PowerShell. Чтобы создать правило с помощью тега AzureBackup:

    - Добавьте учетные данные учетной записи Azure и обновите национальных облаках<br/>
    `Add-AzureRmAccount`

    - Выберите подписку, группу безопасности сети<br/>
    `Select-AzureRmSubscription "<Subscription Id>"`

     - Выберите группу безопасности сети<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

    - Добавить разрешающее правило исходящего трафика для тега службы архивации Azure<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

  - Сохранить группу безопасности сети<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`
- **Разрешить доступ с помощью тегов Azure брандмауэра**. Если вы используете брандмауэр Azure, создайте правила приложения с помощью AzureBackup [полное доменное имя тега](https://docs.microsoft.com/azure/firewall/fqdn-tags). Это разрешает исходящий доступ к службе архивации Azure.
- **Разверните сервер прокси-сервера HTTP для маршрутизации трафика**. При создании резервной копии базы данных SQL Server на виртуальной Машине Azure, расширение резервного копирования на виртуальной Машине использует API-интерфейсы HTTPS для отправки команды управления Azure Backup и хранилище Azure. Расширение резервного копирования также использует Azure AD для проверки подлинности. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Эти расширения являются единственным компонентом, который настроен для доступа к общедоступному Интернету.

Достоинства и недостатки параметры подключения:

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Без дополнительных затрат | Комплексное управление, поскольку со временем измениться диапазоны IP-адресов <br/><br/> Предоставляет доступ ко всей платформы Azure, а не только к хранилищу Azure
Используйте теги служб группы безопасности сети | Проще управлять как диапазон изменения будут автоматически объединены <br/><br/> Без дополнительных затрат <br/><br/> | Может использоваться только с группами безопасности сети <br/><br/> Предоставляет доступ ко всей службе
С помощью тегов Azure FQDN брандмауэра | Проще управлять как автоматически управляет требуется полных доменных имен | Может использоваться только с брандмауэром Azure
Использование прокси-сервера HTTP | Точный контроль в прокси-сервер хранилища разрешено URL-адреса <br/><br/> Точка Интернет-доступ к виртуальным машинам <br/><br/> Не распространяются изменения Azure IP-адреса | Дополнительные затраты на запуск виртуальной Машины с программным обеспечением прокси-сервера

### <a name="set-vm-permissions"></a>Настройка разрешений виртуальной машины

Когда вы настраиваете резервной копии для базы данных SQL Server, Azure Backup выполняет следующие функции:

- Добавляет расширение AzureBackupWindowsWorkload.
- Создает учетную запись NT SERVICE\AzureWLBackupPluginSvc обнаружить базы данных на виртуальной машине. Эта учетная запись используется для резервного копирования и восстановления и требуются разрешения администратора SQL.
- Находит базы данных, запущенных на виртуальной Машине, служба архивации Azure использует учетную запись NT AUTHORITY\SYSTEM. Это должна быть общедоступной входа на SQL Server.

Если вы не создавали виртуальной Машины SQL Server в Azure Marketplace, может появиться сообщение об ошибке UserErrorSQLNoSysadminMembership. Дополнительные сведения см. в разделе рекомендации и ограничения компонентов см. в [о резервное копирование SQL Server на виртуальных машинах Azure](backup-azure-sql-database.md#fix-sql-sysadmin-permissions).

### <a name="database-naming-guidelines-for-azure-backup"></a>Базы данных, рекомендации по именованию для резервного копирования Azure

Не используйте следующие элементы в имена баз данных:

  * Конечные и начальные пробелы
  * В конце восклицательных знака (!)
  * Закрывающие квадратные скобки (])
  * Начиная с F:\

Совмещение имен для неподдерживаемые символы, но мы рекомендуем избегать их. Дополнительные сведения см. в статье [Understanding the Table Service Data Model](https://docs.microsoft.com/rest/api/storageservices/Understanding-the-Table-Service-Data-Model?redirectedfrom=MSDN) (Общие сведения о модели данных службы таблиц).


[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Инструкции по обнаружению базы данных, запущенные на виртуальной Машине:

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. В **хранилище служб восстановления** панели мониторинга выберите **резервного копирования**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В **цель резервного копирования**, задайте **где выполняется рабочая нагрузка?** для **Azure**.

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В меню **Цель резервного копирования** > **Обнаружить базы данных в виртуальных машинах** выберите **Запустить обнаружения**, чтобы найти незащищенные виртуальные машины в подписке. Этот поиск может занять некоторое время, в зависимости от количества незащищенные виртуальные машины в подписке.

   - После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   - Если виртуальной Машине отсутствует, как надо, см. в разделе ли уже резервного копирования в хранилище.
   - Несколько виртуальных машин может иметь то же имя, но они будут принадлежат к разным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Обнаружение базы данных отслеживания в **уведомления**. Время, необходимое для этого действия зависит от числа баз данных виртуальных Машин. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения следующие элементы происходят в фоновом режиме:

    - Служба архивации Azure регистрирует виртуальную Машину с хранилищем для резервного копирования рабочих нагрузок. Можно архивировать все базы данных на виртуальной Машине, зарегистрированных в этом хранилище только.
    - Служба Azure Backup устанавливает расширение AzureBackupWindowsWorkload на виртуальной Машине. Агент не установлен на базу данных SQL.
    - Служба архивации Azure создает учетную запись службы NT Service\AzureWLBackupPluginSvc на виртуальной Машине.
      - Все операции резервного копирования и восстановления используют учетную запись службы.
      - NT Service\AzureWLBackupPluginSvc требуются разрешения администратора SQL. Все виртуальные машины SQL Server в Marketplace в состав SqlIaaSExtension установлен. Расширение AzureBackupWindowsWorkload использует SQLIaaSExtension, чтобы автоматически получить необходимые разрешения.
    - Если вы не создавали виртуальной Машины из Marketplace, виртуальная машина не будет иметь SqlIaaSExtension установлен и операция обнаружения завершается сбоем с сообщением об ошибке UserErrorSQLNoSysAdminMembership. Чтобы устранить эту проблему, выполните [инструкции](backup-azure-sql-database.md#fix-sql-sysadmin-permissions).

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

1. В **цель резервного копирования** > **шаг 2: Настройка резервного копирования**выберите **Настройка резервного копирования**.

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. В **Выбор элементов для архивации**, вы увидите все группы зарегистрированных доступности и автономных экземплярах SQL Server. Щелкните стрелку слева от строки, чтобы развернуть список всех незащищенных баз данных в этом экземпляре или группы доступности Always On.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выбрать все базы данных, которые вы хотите защитить, а затем выберите **ОК**.

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Для защиты более 50 баз данных настройте несколько резервных копий.
     * Чтобы включить [ ](#enable-auto-protection) всего экземпляра или группы доступности Always On. В **AUTOPROTECT** стрелку раскрывающегося списка выберите **ON**, а затем выберите **ОК**.
     
    > [!NOTE]
    > [Автоматической защиты](#enable-auto-protection) компонент не только включает защиту для всех существующих баз данных за один раз, но также автоматически защищает все новые базы данных добавлен в этот экземпляр или группа доступности.  

4. Выберите **ОК** открыть **политика архивации**.

    ![Включить автоматическую защиту для группы доступности AlwaysOn](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В **политика архивации**, выберите политику, а затем выберите **ОК**.

   - Выберите политику по умолчанию в качестве HourlyLogBackup.
   - выбрать существующую политику резервного копирования, созданную ранее для SQL;
   - Определите новую политику на основе диапазона к RPO и хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. В **резервного копирования**выберите **включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. Отслеживать ход выполнения настройки в **уведомления** области портала.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

- Политика создается на уровне хранилища.
- Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
- При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
- Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
- Дополнительные сведения о [различные типы политик резервного копирования](backup-architecture.md#sql-server-backup-types).

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище, выберите **политики архивации** > **добавить**.
2. В **добавить**выберите **SQL Server на виртуальной Машине Azure** для определения типа политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В **политики полной резервной копии**выберите **частоту резервного копирования**. Выберите либо **ежедневного** или **еженедельно**.

   - Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   - Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.
   - Выполнить полную архивацию, так как нельзя отключить **полной резервной копии** параметр.
   - Выберите **полной резервной копии** для просмотра политики.
   - При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. В **диапазон ХРАНЕНИЯ**, по умолчанию выбраны все параметры. Очистить любой диапазон хранения ограничивает не требуется, а также задайте интервалы для использования.

    - Минимальный срок хранения для любого типа резервной копии (полной, разностной и журнала) составляет семь дней.
    - Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    - Резервное копирование для определенного дня с тегами и сохраняются на основе еженедельно диапазон хранения и настройки еженедельного хранения.
    - Ежемесячного и ежегодного диапазонов хранения ведут себя точно так же.

       ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    - Вы можете активировать только один разностная резервная копия в день.
    - Максимальный срок хранения разностных резервных копий составляет 180 дней. Для длительного хранения используйте полные резервные копии.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервные копии журналов может возникнуть так часто, каждые 15 минут и хранятся до 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **Политика архивации** выберите, следует ли включить параметр **Сжатие резервной копии SQL**.
    - По умолчанию сжатие отключено.
    - В серверной части Azure Backup использует собственное сжатие резервных копий SQL.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.


### <a name="modify-policy"></a>Изменение политики
Измените политику, чтобы изменить диапазон хранения резервных копий частоты или хранения.

> [!NOTE]
> Любое изменение в срок хранения применяются задним всех старых точек восстановления помимо новые.

На панели мониторинга хранилища, перейдите к **управление** > **политики резервного копирования** и выберите политику, которую требуется изменить.

  ![Управление политикой резервного копирования](./media/backup-azure-sql-database/modify-backup-policy.png)


## <a name="enable-auto-protection"></a>Включение автоматической защиты  

Вы можете включить автоматической защиты автоматически создавать резервные копии всех существующих и будущих баз данных, автономный экземпляр SQL Server или в группу доступности Always On.

- Нет ограничений на количество баз данных, которые можно выбрать для автоматической защиты за один раз.
- Нельзя выборочно защиты или исключить из защиты в экземпляр во время включения автоматической защиты базы данных.
- Если ваш экземпляр уже включает некоторые защищенные базы данных, они будут оставаться защищенными под свои соответствующие политики даже после включения автоматической защиты. Все незащищенных баз данных, добавленные позже будет иметь только одну политику, которая определение во время включения автоматической защиты, перечисленных в разделе **Настройка резервного копирования**. Тем не менее можно изменить политику, связанную с автоматической защитой данных более поздней версии.  

Для включения автоматической защиты:

  1. В меню **Архивируемые элементы** выберите экземпляр, для которого вы хотите включить автоматическую защиту.
  2. Выберите стрелку раскрывающегося списка в разделе **AUTOPROTECT**, выберите **ON**, а затем выберите **ОК**.

      ![Включить автоматическую защиту для группы доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

  3. Настройка резервного копирования активируется для всех баз данных вместе, и ее можно отслеживать в разделе **заданий резервного копирования**.

Если вам нужно отключить автоматическую защиту, выберите имя экземпляра в разделе **Настройка резервного копирования**, а затем выберите **отключить Autoprotect** для экземпляра. Будет продолжать создавать резервные копии всех баз данных, но в будущих базах данных не будут защищены автоматически.

![Отключить автоматическую защиту на этом экземпляре](./media/backup-azure-sql-database/disable-auto-protection.png)

 
## <a name="next-steps"></a>Дальнейшие действия

Вы узнаете, как выполнять следующие задачи:

- [Восстановление резервных копий баз данных SQL Server](restore-sql-database-azure-vm.md)
- [Управление базами данных резервные копии SQL Server](manage-monitor-sql-database-backup.md)
