---
title: Создание резервных копий баз данных SQL Server на виртуальных машинах Azure
description: В этой статье узнайте, как создать резервную резервную связь с базами данных сервера S'L на виртуальных машинах Azure с помощью резервного копирования Azure.
ms.reviewer: vijayts
ms.topic: conceptual
ms.date: 09/11/2019
ms.openlocfilehash: 887f15deed74330cf132e0574d166c074d2c7cad
ms.sourcegitcommit: acb82fc770128234f2e9222939826e3ade3a2a28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81685711"
---
# <a name="back-up-sql-server-databases-in-azure-vms"></a>Создание резервных копий баз данных SQL Server на виртуальных машинах Azure

Базы данных сервера S'L являются критическими рабочими нагрузками, которые требуют низкой цели восстановления (RPO) и долгосрочного удержания. Резервное копирование баз данных сервера S'L Server, работающих на виртуальных машинах Azure (VM), можно с помощью [резервного копирования Azure.](backup-overview.md)

В этой статье показано, как создать резервную связь с базой данных сервера S'L Server, которая работает на VM Azure, в хранилище служб восстановления резервного копирования Azure.

В этой статье вы узнаете, как выполнять следующие задачи.

> [!div class="checklist"]
>
> * создание и настройка хранилища;
> * Откройте для себя базы данных и наведиваем резервные копирования.
> * настройка автоматической защиты для баз данных.

>[!NOTE]
>**Мягкое удаление для сервера S'L в Azure VM и мягкое удаление для SAP HANA в рабочих нагрузках Azure VM** теперь доступно в предварительном просмотре.<br>
>Чтобы подписаться на предварительный просмотр, напишите нам по адресуAskAzureBackupTeam@microsoft.com

## <a name="prerequisites"></a>Предварительные требования

Перед тем, как создать резервную передний стаж, проверьте следующие критерии:

1. Определите или создайте [хранилище служб восстановления](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) в том же регионе и подписку, что и VM, размещая экземпляр S'L Server.
2. Убедитесь, что VM имеет [подключение к сети.](backup-sql-server-database-azure-vms.md#establish-network-connectivity)
3. Убедитесь, что базы данных S'L Server следуют рекомендациям по [наименованию базы данных для резервного копирования Azure.](#database-naming-guidelines-for-azure-backup)
4. Убедитесь, что для базы данных нет других решений для резервного копирования. Отогивайте все остальные резервные отсылки сервера S'L Server перед созданием резервного копирования базы данных.

> [!NOTE]
> Можно включить резервное копирование Azure для VM Azure, а также для базы данных сервера S'L, работающей на VM без конфликтов.

### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций VM сервера S'L требует подключения к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам Azure.

Установите подключение, используя один из следующих вариантов.

#### <a name="allow-the-azure-datacenter-ip-ranges"></a>Разрешение диапазонов IP-адресов центра обработки данных Azure

Этот параметр разрешает [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в скачанном файле. Чтобы получить доступ к группе безопасности сети, используйте командлет "Set-AzureNetworkSecurityRule". Если список надежных получателей содержит только IP-адреса, относящиеся к региону, вам также нужно обновить список безопасных получателей тегом службы Azure Active Directory (Azure AD), чтобы включить проверку подлинности.

#### <a name="allow-access-using-nsg-tags"></a>Разрешение доступа с помощью тегов NSG

При использовании NSG для ограничения возможностей подключения следует использовать тег службы AzureBackup, чтобы разрешить исходящий доступ к Azure Backup. Кроме того, вы также можете разрешить подключение для проверки подлинности и передачу данных, используя [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и службы хранилища Azure. Это можно сделать на портале Azure или с помощью PowerShell.

Чтобы создать правило с помощью портала, выполните следующие действия.

  1. В разделе **Все службы** перейдите к **группам сетевой безопасности** и выберите группу сетевой безопасности.
  2. Выберите **Правила безопасности для исходящего трафика** в разделе **Параметры**.
  3. Выберите **Добавить**. Введите все необходимые сведения для создания нового правила, как описано в разделе [параметры правила безопасности](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group#security-rule-settings). Убедитесь, что параметр **Назначение** имеет значение **Тег службы**, а **Тег целевой службы** имеет значение **AzureBackup**.
  4. Щелкните **Добавить**, чтобы сохранить только что созданное исходящее правило безопасности.

Чтобы создать правило с помощью PowerShell, выполните следующие действия.

 1. Добавление учетных данных учетной записи Azure и обновление национальных облаков<br/>
      `Add-AzureRmAccount`<br/>

 2. Выберите подписку NSG<br/>
      `Select-AzureRmSubscription "<Subscription Id>"`

 3. Выберите NSG<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

 4. Добавление разрешающего правила исходящего трафика для тега службы Azure Backup<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 5. Добавление разрешающего правила исходящего трафика для тега Службы хранилища<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "StorageAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "Storage" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 6. Добавление разрешающего правила исходящего трафика для тега AzureActiveDirectory<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureActiveDirectoryAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureActiveDirectory" -DestinationPortRange 443 -Description "Allow outbound traffic to AzureActiveDirectory service"`

 7. Сохраните файл NSG<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`

**Разрешите доступ с помощью тегов брандмауэра Azure**. Если вы используете брандмауэр Azure, создайте правило приложения с помощью[тега AzureBackup FQDN](https://docs.microsoft.com/azure/firewall/fqdn-tags). Это разрешает исходящий доступ к службам Azure Backup.

**Развертывание прокси-сервера HTTP для маршрутизации трафика**. При резервном копировании базы данных сервера S'L На Базе Azure VM расширение резервного копирования на VM использует APIs HTTPS для отправки команд управления резервному копированию Azure и данных в Хранилище Azure. Расширение резервного копирования также использует Azure AD для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Нет доменов подстановочных знаков, которые используются с резервным копированием Azure, чтобы добавить в список разрешений для ваших правил прокси. Для этих служб, предоставляемых Azure, необходимо использовать общедоступные диапазоны IP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Варианты подключения включают следующие преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure
Использование тегов службы NSG | Упрощенное управление благодаря автоматическому объединению изменений диапазона <br/><br/> Нет дополнительных затрат <br/><br/> | Может использоваться только с NSG <br/><br/> Предоставляет доступ ко всей службе
Использование тегов полного доменного имени службы "Брандмауэр Azure" | Проще управлять, так как требуемые управляются FQDN автоматически | Можно использовать только с брандмауэром Azure
Использование прокси-сервера HTTP | Единая точка доступа к виртуальным машинам через Интернет <br/> | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера <br/> Нет опубликованных адресов ФЗДН, разрешите правила будут подлежать изменениям IP-адреса Azure

#### <a name="private-endpoints"></a>Частные конечные точки

[!INCLUDE [Private Endpoints](../../includes/backup-private-endpoints.md)]

### <a name="database-naming-guidelines-for-azure-backup"></a>Руководящие принципы именования баз данных для резервного копирования Azure

Избегайте использования следующих элементов в названиях баз данных:

* Трейлинг и ведущие пространства
* Трейлинг восклицательные знаки (!)
* Закрытие квадратных скобок (яп. )
* Семиколон ';'
* Передняя слэш '/'

Псевдоним доступен для неподдерживаемых символов, но мы рекомендуем избегать их. Дополнительные сведения см. в статье [Understanding the Table Service Data Model](https://docs.microsoft.com/rest/api/storageservices/Understanding-the-Table-Service-Data-Model) (Общие сведения о модели данных службы таблиц).

>[!NOTE]
>Операция **«Настройка защиты»** для баз данных со специальными символами, такими как «я» или «&» в их названии, не поддерживается. Вы можете либо изменить имя базы данных или включить **Автоматическая защита**, которая может успешно защитить эти базы данных.

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Как обнаружить базы данных, работающие на VM:

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. В панели мониторинга **хранилища восстановления** выберите **панель резервного копирования.**

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В **цели резервного копирования**, установить **Где ваша рабочая нагрузка работает?** к **Azure**.

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В **Backup Goal** > **Discover DBs в vMs**выберите **Start Discovery** для поиска незащищенных vMs в подписке. Этот поиск может занять некоторое время, в зависимости от количества незащищенных вс-бар в подписке.

   * После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   * Если VM не указан в списке, как вы ожидаете, посмотреть, является ли он уже резервное копирование в хранилище.
   * Несколько ВМ могут иметь одно и то же имя, но они будут принадлежать к различным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Отслеживайте обнаружение базы данных в **уведомлениях**. Время, необходимое для этого действия, зависит от количества баз данных VM. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения в фоновом режиме возникают следующие элементы:

    * Резервное копирование Azure регистрирует VM с хранилищем для резервного копирования рабочей нагрузки. Все базы данных на зарегистрированном VM могут быть резервными только в этом хранилище.
    * Azure Backup устанавливает на виртуальной машине расширение AzureBackupWindowsWorkload. Агент не устанавливается в базе данных S'L.
    * Azure Backup создает учетную запись службы NT Service\AzureWLBackupPluginSvc.
      * Все операции резервного копирования и восстановления используют учетную запись службы.
      * NT Service-AzureWLBackupPluginSvc требует разрешения S'L sysadmin. Все vMs-серверы S'L, созданные на Marketplace, поставляются с установленным SlIaASExtension. Расширение AzureBackupWindowsWorkload использует SQLIaaSExtension для автоматического получения необходимых разрешений.
    * Если вы не создали VM с рынка или если вы находитесь на S'L 2008 и 2008 R2, VM не может иметь SlIaaSExtension установлен, и операция обнаружения не справляется с сообщением об ошибке UserErrorSLSysAdminMembership. Чтобы исправить эту проблему, следуйте инструкциям в [соответствии с разрешениями Set VM.](backup-azure-sql-database.md#set-vm-permissions)

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

1. В шаге >  **цели резервного копирования****2: Настройка резервного копирования,** **выберите настройку резервного копирования.**

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. В **элементах Select для резервного копирования**вы видите все зарегистрированные группы доступности и отдельные экземпляры сервера S'L. Выберите стрелку влево строки, чтобы расширить список всех незащищенных баз данных в этом примере или всегда на группе доступности.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выберите все базы данных, которые вы хотите защитить, а затем выберите **OK.**

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Для защиты более 50 баз данных настройте несколько резервных копий.
     * Для [включения](#enable-auto-protection) всего экземпляра или группы всегда на доступность в списке выпадающих данных **AUTOPROTECT** выберите **ON,** а затем выберите **OK.**

    > [!NOTE]
    > Функция [автоматической защиты](#enable-auto-protection) не только обеспечивает защиту всех существующих баз данных одновременно, но и автоматически защищает любые новые базы данных, добавленные к этому экземпляру или группе доступности.  

4. Выберите **OK** для открытия **политики резервного копирования.**

    ![Включить автоматическую защиту для группы всегда на доступность](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В **политике резервного копирования**выберите политику, а затем выберите **OK.**

   * Выберите политику по умолчанию как HourlyLogBackup.
   * выбрать существующую политику резервного копирования, созданную ранее для SQL;
   * Определите новую политику на основе целевой точки восстановления (RPO) и периода хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. В разделе **Архивация** выберите **Включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. В области **Уведомления** портала можно отслеживать ход настройки.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
* При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
* Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
* Узнайте о [различных типах политик резервного копирования.](backup-architecture.md#sql-server-backup-types)

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище выберите **политики резервного копирования** > **Добавить.**
2. В **добавлении**выберите **сервер S'L в Azure VM** для определения типа политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В меню **Политика полного резервного копирования** выберите **Частота резервного копирования**. Выбирайте **ежедневно** или **еженедельно**.

   * Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   * Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.
   * Запустите полную резервную копию, потому что вы не можете отключить опцию **full Backup.**
   * Выберите **полное резервное копирование** для просмотра политики.
   * При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. В **RETENTION RANGE**все параметры выбираются по умолчанию. Очистите все ограничения диапазона удержания, которые вы не хотите, а затем установите интервалы для использования.

    * Минимальный период хранения для любого типа резервного копирования (полный, дифференциальный и журнал) составляет семь дней.
    * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    * Резервное копирование для определенного дня помечается и сохраняется на основе еженедельного диапазона удержания и недельного параметра удержания.
    * Ежемесячные и годовые диапазоны удержания ведут себя аналогичным образом.

       ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    * Вы можете вызвать только одно дифференциальное резервное копирование в день.
    * Максимальный срок хранения разностных резервных копий составляет 180 дней. Для более длительного хранения используйте полные резервные копирования.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование в журнале может происходить так часто, как каждые 15 минут и может быть сохранено на срок до 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **политики резервного копирования** выберите, включать сжатие **резервного копирования или** нет. По умолчанию этот параметр отключен. Если это включено, сервер S'L server отправит сжатый поток резервного копирования на VDI.  Обратите внимание, что резервное копирование Azure переопределяет значения уровня экземпляра с помощью пункта COMPRESSION/NO_COMPRESSION в зависимости от значения этого элемента управления.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.

> [!NOTE]
> Каждое резервное копирование журнала приковано к предыдущему полному резервному копированию для формирования цепочки восстановления. Эта полная резервная копию будет сохранена до истечения срока хранения последнего резервного копирования журнала. Это может означать, что полная резервная копия сохраняется в течение дополнительного периода, чтобы убедиться, что все журналы могут быть восстановлены. Допустим, пользователь имеет еженедельное полное резервное копирование, ежедневный дифференциал и 2-часовые журналы. Все они сохраняются в течение 30 дней. Но, еженедельно полный может быть действительно очищены / удалены только после следующего полного резервного копирования доступна, т.е., после 30 и 7 дней. Скажем, еженедельно еженедельная полная резервная часть происходит 16 ноября. В рамках политики удержания, она должна быть сохранена до 16 декабря. Последнее резервное копирование журнала для этого полного происходит до следующего запланированного полного, на 22 ноября. До тех пор, пока этот журнал не будет доступен до 22 декабря, полный 16 ноября не может быть удален. Таким образом, 16 ноября полный сохраняется до 22 декабря.

## <a name="enable-auto-protection"></a>Включение автоматической защиты  

Можно включить автоматическую защиту для автоматического резервного копирования всех существующих и будущих баз данных в автономный экземпляр сервера S-L или в группу всегда на доступность.

* Количество баз данных, которые можно выбрать для автоматической защиты, не ограничено.
* Вы не можете выборочно защищать или исключать базы данных из защиты в экземпляре в момент, когда вы включаете автоматическую защиту.
* Если ваш экземпляр уже содержит некоторые защищенные базы данных, они останутся защищенными в соответствии со своими соответствующими политиками даже после того, как вы включите автоматическую защиту. Все незащищенные базы данных, добавленные позже, будут иметь только одну политику, которую вы определяете на момент включения автоматической защиты, перечисленные в настройке **резервного копирования.** Однако позже можно изменить политику, связанную с автоматической базой данных.  

Для обеспечения автоматической защиты:

  1. В меню **Архивируемые элементы** выберите экземпляр, для которого вы хотите включить автоматическую защиту.
  2. Выберите список выпадающих вниз под **AUTOPROTECT,** выберите **ON,** а затем выберите **OK.**

      ![Включить автоматическую защиту в группе доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

  3. Настройка резервного копирования активируется для всех баз данных вместе, и ее можно отслеживать в разделе **заданий резервного копирования**.

Если вам необходимо отключить автоматическую защиту, выберите имя экземпляра под **настройкой резервного копирования,** а затем выберите **Отключить автозащиту** для экземпляра. Все базы данных будут по-прежнему резервироваться, но будущие базы данных не будут автоматически защищены.

![Отключить автоматическую защиту в этом случае](./media/backup-azure-sql-database/disable-auto-protection.png)

## <a name="next-steps"></a>Следующие шаги

Вы узнаете, как выполнять следующие задачи:

* [Восстановление резервных баз данных сервера S'L Server](restore-sql-database-azure-vm.md)
* [Управление резервными базами данных сервера S'L Server](manage-monitor-sql-database-backup.md)
