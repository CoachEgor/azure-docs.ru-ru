---
title: Создание резервных копий баз данных SQL Server на виртуальных машинах Azure
description: Из этой статьи вы узнаете, как создавать резервные копии баз данных SQL Server на виртуальных машинах Azure с помощью службы Azure Backup.
ms.topic: conceptual
ms.date: 09/11/2019
ms.openlocfilehash: 16e24ed94d8017d9fb922193bb16a33ec7a9cdfd
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84817536"
---
# <a name="back-up-sql-server-databases-in-azure-vms"></a>Создание резервных копий баз данных SQL Server на виртуальных машинах Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Вы можете выполнять резервное копирование баз данных SQL Server, работающих на виртуальных машинах Azure, с помощью [Azure Backup](backup-overview.md).

В этой статье показано, как создавать резервные копии базы данных SQL Server, запущенной на виртуальной машине Azure, в хранилище Служб восстановления для Azure Backup.

В этой статье вы узнаете, как выполнять следующие задачи.

> [!div class="checklist"]
>
> * создание и настройка хранилища;
> * обнаружение баз данных и настройка резервного копирования;
> * настройка автоматической защиты для баз данных.

>[!NOTE]
>**Обратимое удаление для SQL Server на виртуальной машине Azure и обратимое удаление для SAP HANA в рабочих нагрузках виртуальных машин Azure** теперь доступно в предварительной версии.<br>
>Чтобы зарегистрироваться для получения предварительной версии, напишите нам по адресу AskAzureBackupTeam@microsoft.com

## <a name="prerequisites"></a>Предварительные требования

Прежде чем создавать резервную копию базы данных SQL Server, проверьте следующие критерии.

1. Определите или создайте [хранилище Служб восстановления](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) в том же регионе или подписке, что и размещение виртуальной машины SQL Server.
1. Убедитесь, что виртуальная машина имеет [сетевое подключение](backup-sql-server-database-azure-vms.md#establish-network-connectivity).
1. Убедитесь, что базы данных SQL Server соответствуют [рекомендациями по именованию баз данных для Azure Backup](#database-naming-guidelines-for-azure-backup).
1. Убедитесь, что длина общей длины SQL Server имени виртуальной машины и имени группы ресурсов не превышает 84 символов для виртуальных машин Azure Resource Manager (ARM) (или 77 символов для классических виртуальных машин). Это ограничение обусловлено тем, что некоторые символы зарезервированы службой.
1. Проверьте, что у вас отсутствуют любые другие включенные средства резервного копирования базы данных. Перед выполнением резервного копирования базы данных отключите все другие службы резервного копирования SQL Server.

> [!NOTE]
> С помощью Azure Backup вы можете включить резервное копирование Azure для виртуальной машины Azure и для базы данных SQL Server, работающей на этой виртуальной машине, не вызывая конфликтов.

### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций виртуальной машине SQL Server требуется подключение к службе Azure Backup, службе хранилища Azure и Azure Active Directory. Для этого можно использовать частные конечные точки или разрешить доступ к необходимым общедоступным IP-адресам или полным доменным именам. Неправильное подключение к необходимым службам Azure может привести к сбою в таких операциях, как обнаружение базы данных, настройка резервного копирования, выполнение резервного копирования и восстановление данных.

В следующей таблице перечислены различные альтернативы, которые можно использовать для подключения:

| **Параметр**                        | **Преимущества**                                               | **Недостатки**                                            |
| --------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Частные конечные точки                 | Разрешение резервного копирования через частные IP-адреса в виртуальной сети  <br><br>   Обеспечение детального контроля над сетью и хранилищем | Стандартные [затраты](https://azure.microsoft.com/pricing/details/private-link/) на частную конечную точку |
| Теги службы NSG                  | Упрощенное управление благодаря автоматическому объединению изменений диапазона   <br><br>   Нет дополнительных затрат | Может использоваться только с NSG  <br><br>    Предоставляет доступ ко всей службе |
| Теги полного доменного имени службы "Брандмауэр Azure"          | Проще управлять, так как требуемые FQDN управляются автоматически | Можно использовать только с брандмауэром Azure                         |
| Разрешение доступа к FQDN/IP-адресам службы | Нет дополнительных затрат   <br><br>  Работает со всеми устройствами безопасности сети и брандмауэрами | Может потребоваться доступ к широкому набору IP-адресов или FQDN   |
| Использование прокси-сервера HTTP                 | Единая точка доступа к виртуальным машинам через Интернет                       | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера         |

Ниже приведены дополнительные сведения об использовании этих параметров:

#### <a name="private-endpoints"></a>Частные конечные точки

Частные конечные точки можно использовать для безопасного подключения с серверов внутри виртуальной сети к хранилищу Служб восстановления. Частная конечная точка использует IP-адрес из адресного пространства виртуальной сети для вашего хранилища. Сетевой трафик между ресурсами в виртуальной сети и хранилищем проходит по виртуальной сети и частный канал в магистральную сеть Майкрософт. Это устраняет уязвимость в общедоступном Интернете. Дополнительные сведения о частных конечных точках для Azure Backup можно узнать [здесь](https://docs.microsoft.com/azure/backup/private-endpoints).

#### <a name="nsg-tags"></a>Теги NSG

Если вы используете группы безопасности сети (NSG), используйте тег службы *AzureBackup*, чтобы разрешить исходящий доступ к Azure Backup. Кроме тегов Azure Backup вам нужно разрешить подключение для проверки подлинности и передачи данных, создав аналогичные [правила NSG](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для *Azure AD* и *службы хранилища Azure*.  Ниже описан процесс создания правила для тега Azure Backup:

1. В разделе **Все службы** перейдите к **группам сетевой безопасности** и выберите группу сетевой безопасности.

1. Выберите **Правила безопасности для исходящего трафика** в разделе **Параметры**.

1. Выберите **Добавить**. Введите все необходимые сведения для создания нового правила, как описано в разделе [параметры правила безопасности](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group#security-rule-settings). Убедитесь, что параметр **Назначение** имеет значение *Тег службы*, а **Тег целевой службы** имеет значение *AzureBackup*.

1. Щелкните **Добавить**, чтобы сохранить только что созданное исходящее правило безопасности.

Аналогичным образом можно создавать правила безопасности для исходящего трафика NSG для службы хранилища Azure и Azure AD.

#### <a name="azure-firewall-tags"></a>Теги Брандмауэра Azure

Если вы используете Брандмауэр Azure, создайте правило приложения с помощью[тега AzureBackup FQDN](https://docs.microsoft.com/azure/firewall/fqdn-tags) *AzureBackup*. Это разрешает весь исходящий трафик к службам Azure Backup.

#### <a name="allow-access-to-service-ip-ranges"></a>Разрешение доступа к диапазонам IP-адресов службы

Если вы решили разрешить доступ к IP-адресам службы, ознакомьтесь со сведениями о диапазонах IP-адресов в файле JSON [здесь](https://www.microsoft.com/download/confirmation.aspx?id=56519). Вам потребуется разрешить доступ к IP-адресам, соответствующим Azure Backup, службе хранилища Azure и Azure Active Directory.

#### <a name="allow-access-to-service-fqdns"></a>Разрешение доступа к FQDN службы

Чтобы разрешить доступ к необходимым службам с серверов, можно также использовать следующие FQDN:

| Служба    | Доменные имена для доступа                             |
| -------------- | ------------------------------------------------------------ |
| Azure Backup  | `*.backup.windowsazure.com`                             |
| Служба хранилища Azure | `*.blob.core.windows.net` <br><br> `*.queue.core.windows.net` |
| Azure AD      | Разрешение доступа к FQDN в разделах 56 и 59 в соответствии с [этой статьей](https://docs.microsoft.com/office365/enterprise/urls-and-ip-address-ranges#microsoft-365-common-and-office-online) |

#### <a name="use-an-http-proxy-server-to-route-traffic"></a>Использование прокси-сервера HTTP для маршрутизации трафика

Когда создается резервная копия базы данных SQL Server на виртуальной машине Azure, расширение резервного копирования на виртуальной машине использует API HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure AD для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Используйте список IP-адресов и FQDN, указанных выше, чтобы разрешить доступ к необходимым службам. Проверенные прокси-серверы не поддерживаются.

### <a name="database-naming-guidelines-for-azure-backup"></a>Правила именования баз данных для Azure Backup

Не используйте следующие элементы в именах баз данных:

* начальный и конечный пробелы;
* конечные восклицательные знаки (!);
* закрывающие квадратные скобки (]);
* точку с запятой (;);
* косую черту (/).

Присвоение псевдонимов с неподдерживаемыми знаками возможно, но мы рекомендуем избегать этого. Дополнительные сведения см. в статье [Understanding the Table Service Data Model](https://docs.microsoft.com/rest/api/storageservices/Understanding-the-Table-Service-Data-Model) (Общие сведения о модели данных службы таблиц).

>[!NOTE]
>**Настройка защиты** для баз данных с такими специальными символами, как "+" и "&", не поддерживается. Вы можете либо изменить имя базы данных, либо включить **автоматическую защиту**, которая может успешно защитить эти базы данных.

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Чтобы найти базы данных, выполняющиеся на виртуальной машине, выполните следующие действия.

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. На панели мониторинга **Хранилища служб восстановления** выберите **Архивация**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В разделе **Цель резервного копирования** для параметра **Where is your workload running** (Где выполняется рабочая нагрузка) задайте значение **Azure**.

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В меню **Цель резервного копирования** > **Обнаружить базы данных в виртуальных машинах** выберите **Запустить обнаружения**, чтобы найти незащищенные виртуальные машины в подписке. Поиск может занять некоторое время в зависимости от числа незащищенных виртуальных машин в подписке.

   * После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   * Если виртуальные машины перечислены не так, как вы ожидали, проверьте наличие их резервной копии в хранилище.
   * Несколько виртуальных машин могут иметь одно имя, но они будут принадлежать к разным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Отслеживайте обнаружение баз данных **уведомлениях**. Время, необходимое для выполнения этого действия, зависит от количества баз данных виртуальных машин. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения в фоновом режиме происходят следующие действия:

    * Azure Backup регистрирует виртуальную машину с помощью хранилища для резервного копирования рабочей нагрузки. Все базы данных зарегистрированной виртуальной машины могут быть сохранены только в этом хранилище.
    * Azure Backup устанавливает на виртуальной машине расширение AzureBackupWindowsWorkload. В базе данных SQL агент не устанавливается.
    * Azure Backup создает учетную запись службы NT Service\AzureWLBackupPluginSvc.
      * Все операции резервного копирования и восстановления используют учетную запись службы.
      * Учетной записи NT Service\AzureWLBackupPluginSvc необходимы разрешения sysadmin SQL. Все виртуальные машины SQL Server, созданные в Marketplace, поставляются с установленным SqlIaaSExtension. Расширение AzureBackupWindowsWorkload использует SQLIaaSExtension для автоматического получения необходимых разрешений.
    * Если виртуальная машина не создана в Marketplace или у вас SQL Server версии 2008 или 2008 R2, то в виртуальной машине может не быть расширения SqlIaaSExtension и операция обнаружения завершается со сбоем и сообщением об ошибке UserErrorSQLNoSysAdminMembership. Чтобы устранить эту проблему, следуйте инструкциям в разделе [Настройка разрешений виртуальной машины](backup-azure-sql-database.md#set-vm-permissions).

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

1. В разделе **Цель резервного копирования** > **Шаг 2. Настройка резервного копирования** выберите **Настройка резервного копирования**.

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. В разделе **Выберите элементы для резервного копирования**вы увидите все зарегистрированные группы доступности и изолированные экземпляры SQL Server. Щелкните стрелку слева от строки, чтобы развернуть список всех незащищенных баз данных в этом экземпляре или группе доступности Always On.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выберите все базы данных, которые нужно защитить, и нажмите кнопку **ОК**.

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Для защиты более 50 баз данных настройте несколько резервных копий.
     * Чтобы [включить](#enable-auto-protection) весь экземпляр или группу доступности Always On, в раскрывающемся списке **АВТОЗАЩИТА** выберите **ВКЛ**, а затем нажмите **ОК**.

    > [!NOTE]
    > Функция [автоматической защиты](#enable-auto-protection) не только включает защиту для всех существующих баз данных за один раз, но также распространяется на все новые базы данных, которые будут добавлены к этому экземпляру или группе доступности.  

4. Нажмите **ОК**, чтобы открыть **политику резервного копирования**.

    ![Включение автоматической защиты для группы доступности Always On](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В **политике резервного копирования** выберите политику и нажмите кнопку **ОК**.

   * Выберите политику по умолчанию: HourlyLogBackup.
   * выбрать существующую политику резервного копирования, созданную ранее для SQL;
   * Определите новую политику на основе целевой точки восстановления (RPO) и периода хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. В разделе **Архивация** выберите **Включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. В области **Уведомления** портала можно отслеживать ход настройки.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
* При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
* Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
* Сведения о [различных типах политик резервного копирования](backup-architecture.md#sql-server-backup-types).

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище выберите **Политики архивации** > **Добавить**.
2. В разделе **Добавить** щелкните **SQL Server в виртуальной машине Azure**, чтобы определить тип политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В меню **Политика полного резервного копирования** выберите **Частота резервного копирования**. Выберите **Ежедневно** или **Еженедельно**.

   * Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   * Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.
   * Выполните полное резервное копирование, поскольку параметр **Полная резервная копия** нельзя отключить.
   * Щелкните **Полная резервная копия**, чтобы просмотреть политику.
   * При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. В разделе **ДИАПАЗОН ХРАНЕНИЯ** все значения заданы по умолчанию. Очистите все ненужные вам ограничения диапазона хранения, и установите необходимые интервалы.

    * Минимальный период хранения для резервной копии любого типа (полная, разностная и журнал) составляет семь дней.
    * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    * Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром недельного хранения.
    * Месячный и годовой диапазоны хранения действуют аналогичным образом.

       ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    * В день можно активировать только одну разностную резервную копию.
    * Максимальный срок хранения разностных резервных копий составляет 180 дней. Для более длительного хранения используйте полные резервные копии.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование журналов может происходить не чаще одного раза в 15 минут и храниться до 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **Политика архивации** выберите, следует ли включить параметр **Сжатие резервной копии SQL** или нет. Этот параметр по умолчанию отключен. Если параметр включен, SQL Server будет передавать в VDI сжатый поток резервного копирования.  Обратите внимание, что Azure Backup переопределяет значения по умолчанию на уровне экземпляра с помощью предложения COMPRESSION / NO_COMPRESSION в зависимости от значений этого элемента управления.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.

> [!NOTE]
> Каждая резервная копия журнала связана с предыдущей полной резервной копией, образуя цепочку восстановления. Эта полная резервная копия будет храниться до истечения срока хранения последней резервной копии журнала. Это может означать, что полная резервная копия сохраняется в течение дополнительного периода, чтобы гарантировать возможность восстановления всех журналов. Предположим, что пользователь настроил еженедельное полное резервное копирование, ежедневное разностное копирование и 2-часовые журналы. Все они сохраняются в течение 30 дней. Однако еженедельную полную резервную копию можно удалить только после того, как будет доступна следующая полная резервная копия, т. е. через 30 + 7 дней. Скажем, еженедельное полное резервное копирование происходит 16 ноября. Согласно политике хранения, она должна храниться до Dec 16. Последняя резервная копия журнала для этой полной копии создается до следующего запланированного резервного копирования 22 ноября. Пока этот журнал доступен до 22 декабря, полная копия от 16 ноября не удаляется. Таким образом, полная копия от 16 ноября будет храниться до 22 декабря.

## <a name="enable-auto-protection"></a>Включение автоматической защиты  

Можно включить автоматическую защиту для автоматического резервного копирования всех существующих и будущих баз данных в изолированный экземпляр SQL Server или в группу доступности Always On.

* Количество баз данных, которые можно выбрать для автоматической защиты, не ограничено. Обнаружение обычно выполняется каждые восемь часов. Однако вы можете сразу обнаружить и защитить новые базы данных, если вручную запустить обнаружение, выбрав параметр повторное **Обнаружение баз данных** .
* При включенной автоматической защите нельзя в экземпляре защищать базы данных выборочно или исключать их из защиты.
* Если ваш экземпляр уже содержит некоторые защищенные базы данных, они останутся защищенными соответствующими политиками даже после включения автоматической защиты. Все незащищенные базы данных, добавленные позже, будут иметь только одну политику, определяемую во время включения автоматической защиты, которая указана в разделе **Настройка резервного копирования**. Однако политику, связанную с автоматической защитой базы данных, можно изменить позже.  

Чтобы включить автоматическую защиту, выполните следующие действия.

  1. В меню **Архивируемые элементы** выберите экземпляр, для которого вы хотите включить автоматическую защиту.
  2. Откройте раскрывающийся список в разделе **АВТОЗАЩИТА**, выберите **ВКЛ** и нажмите кнопку **ОК**.

      ![Включение автоматической защиты для группы доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

  3. Настройка резервного копирования активируется для всех баз данных вместе, и ее можно отслеживать в разделе **заданий резервного копирования**.

Если вам нужно отключить автоматическую защиту, выберите имя экземпляра в разделе **Настройка резервного копирования** и нажмите **Отключить автозащиту** для экземпляра. Резервное копирование всех баз данных будет продолжаться, но будущие базы данных не будут автоматически защищены.

![Отключение автоматической защиты этого экземпляра](./media/backup-azure-sql-database/disable-auto-protection.png)

## <a name="next-steps"></a>Дальнейшие действия

Вы узнаете, как выполнять следующие задачи:

* [Восстановление резервных копий баз данных SQL Server](restore-sql-database-azure-vm.md)
* [Управление резервными копиями баз данных SQL Server](manage-monitor-sql-database-backup.md)
