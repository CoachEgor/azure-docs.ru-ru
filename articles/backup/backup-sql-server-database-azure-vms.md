---
title: Резервное копирование SQL Server баз данных на виртуальных машинах Azure | Документация Майкрософт
description: Узнайте, как создавать резервные копии баз данных SQL Server на виртуальных машинах Azure
ms.reviewer: vijayts
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 06/18/2019
ms.author: dacurwin
ms.openlocfilehash: b7bf9943afa2a79f98fd28d15e5ea46fa63af732
ms.sourcegitcommit: d585cdda2afcf729ed943cfd170b0b361e615fae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/31/2019
ms.locfileid: "68688648"
---
# <a name="back-up-sql-server-databases-in-azure-vms"></a>Создание резервных копий баз данных SQL Server на виртуальных машинах Azure

SQL Server базы данных — это критически важные рабочие нагрузки, для которых требуется низкая Целевая точка восстановления (RPO) и долгосрочное хранение. Вы можете выполнять резервное копирование SQL Server баз данных, работающих на виртуальных машинах Azure, с помощью [Azure Backup](backup-overview.md).

В этой статье показано, как создать резервную копию базы данных SQL Server, которая работает на виртуальной машине Azure, в хранилище служб восстановления Azure Backup.

Из этой статьи вы узнаете о следующем:

> [!div class="checklist"]
> * создание и настройка хранилища;
> * Обнаружение баз данных и Настройка резервных копий.
> * настройка автоматической защиты для баз данных.


## <a name="prerequisites"></a>предварительные требования

Перед созданием резервной копии SQL Server базы данных проверьте следующие критерии.

1. Выявление или создание [хранилища служб восстановления](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) в том же регионе или в локальной службе, что и виртуальная машина, на которой размещен экземпляр SQL Server.
2. Убедитесь, что виртуальная машина подключена [к сети](backup-sql-server-database-azure-vms.md#establish-network-connectivity).
3. Убедитесь, что SQL Server базы данных соответствуют рекомендациям по [именованию баз данных для Azure Backup](#database-naming-guidelines-for-azure-backup).
4. В частности для SQL 2008 и 2008 R2, [добавьте раздел реестра](#add-registry-key-to-enable-registration) для включения регистрации сервера. Этот шаг не потребуется, если функция является общедоступной.
5. Убедитесь, что для базы данных не включены другие решения резервного копирования. Отключите все остальные SQL Server резервные копии, прежде чем создавать резервную копию базы данных.

> [!NOTE]
> Вы можете включить Azure Backup для виртуальной машины Azure, а также для SQL Server базы данных, работающей на виртуальной машине, без конфликтов.


### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций SQL Server виртуальной машине требуется подключение к общедоступным IP-адресам Azure. Операции ВМ (обнаружение базы данных, Настройка резервного копирования, планирование резервного копирования, восстановление точек восстановления и т. д.) завершаются сбоем без подключения к общедоступным IP-адресам Azure.

Установите подключение, используя один из следующих вариантов.

- **Разрешить диапазоны IP-адресов центра обработки данных Azure**. Этот параметр разрешает [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в загружаемом файле. Чтобы получить доступ к группе безопасности сети (NSG), используйте командлет Set-Азуренетворксекуритируле. Если список надежных получателей имеет только IP-адреса, относящиеся к региону, вам также потребуется обновить список надежных получателей, чтобы включить проверку подлинности, Azure Active Directory тег службы Azure AD.

- **Разрешить доступ с помощью тегов NSG**. Если вы используете группы безопасности сети для ограничения подключения, этот параметр добавляет правило в NSG, которое разрешает исходящий доступ к Azure Backup с помощью тега AzureBackup. Помимо этого тега, вам потребуются соответствующие [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и службы хранилища Azure, чтобы обеспечить возможность подключения для проверки подлинности и обмена данными. Тег AzureBackup в настоящее время доступен только в PowerShell. Чтобы создать правило с помощью тега AzureBackup, выполните следующие действия.

    - Добавление учетных данных учетной записи Azure и обновление национальных облаков<br/>
    `Add-AzureRmAccount`

    - Выберите подписку NSG<br/>
    `Select-AzureRmSubscription "<Subscription Id>"`

     - Выберите NSG<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

    - Добавление разрешающего правило исходящего трафика для тега службы Azure Backup<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

  - Сохранение NSG<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`
- **Разрешение доступа с помощью тегов брандмауэра Azure**. Если вы используете брандмауэр Azure, создайте правило приложения с помощью [тега полного доменного имени](https://docs.microsoft.com/azure/firewall/fqdn-tags)AzureBackup. Это разрешает исходящий доступ к Azure Backup.
- **Разверните прокси-сервер HTTP для маршрутизации трафика**. При создании резервной копии базы данных SQL Server на ВИРТУАЛЬНОЙ машине Azure расширение резервного копирования на виртуальной машине использует API-интерфейсы HTTPS для отправки команд управления Azure Backup и данных в службу хранилища Azure. Расширение резервного копирования также использует Azure AD для проверки подлинности. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Варианты подключения включают следующие преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат | Сложно управлять, так как диапазоны IP-адресов меняются со временем <br/><br/> Предоставляет доступ ко всему Azure, а не только к службе хранилища Azure.
Использование тегов службы NSG | Упрощение управления изменениями диапазона автоматически объединяется <br/><br/> Нет дополнительных затрат <br/><br/> | Может использоваться только с группы безопасности сети <br/><br/> Предоставляет доступ ко всей службе
Использование тегов полного доменного имени брандмауэра Azure | Проще управлять, так как требуемые FQDN автоматически управляются | Можно использовать только с брандмауэром Azure
Использование прокси-сервера HTTP | Допускается детальный контроль над URL-адресами хранилища <br/><br/> Единая точка доступа к виртуальным машинам в Интернете <br/><br/> Не подлежит изменениям IP-адреса Azure | Дополнительные затраты на запуск виртуальной машины с помощью программного обеспечения прокси-сервера

### <a name="database-naming-guidelines-for-azure-backup"></a>Рекомендации по именованию баз данных для Azure Backup

Не используйте следующие элементы в именах баз данных:

  * Конечные и начальные пробелы
  * Конечные восклицательные знаки (!)
  * Закрывающие квадратные скобки (])
  * Точка с запятой ";"
  * Косая черта "/"

Псевдонимы доступны для неподдерживаемых символов, но рекомендуется избегать их использования. Дополнительные сведения см. в статье [Understanding the Table Service Data Model](https://docs.microsoft.com/rest/api/storageservices/Understanding-the-Table-Service-Data-Model?redirectedfrom=MSDN) (Общие сведения о модели данных службы таблиц).

### <a name="add-registry-key-to-enable-registration"></a>Добавление раздела реестра для включения регистрации

1. Открыть программу regedit
2. Создайте путь к каталогу реестра: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WorkloadBackup\TestHook (необходимо создать ключ Тессук в разделе Ворклоадбаккуп, который, в свою очередь, должен быть создан в корпорации Майкрософт).
3. В разделе путь к каталогу реестра создайте новое строковое значение с именем строки **AzureBackupEnableWin2K8R2SP1** и значением: **Условия**

    ![Regedit для включения регистрации](media/backup-azure-sql-database/reg-edit-sqleos-bkp.png)

Кроме того, этот шаг можно автоматизировать, запустив reg file с помощью следующей команды:

```csharp
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WorkloadBackup\TestHook]
"AzureBackupEnableWin2K8R2SP1"="True"
```

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Обнаружение баз данных, работающих на виртуальной машине:

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. На панели мониторинга **хранилища служб восстановления** выберите **резервное копирование**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В поле **цель резервного копирования**укажите, **где выполняется рабочая нагрузка?** в **Azure**.

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В меню **Цель резервного копирования** > **Обнаружить базы данных в виртуальных машинах** выберите **Запустить обнаружения**, чтобы найти незащищенные виртуальные машины в подписке. Поиск может занять некоторое время в зависимости от числа незащищенных виртуальных машин в подписке.

   - После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   - Если виртуальная машина не указана как можно скорее, проверьте, не была ли она создана в хранилище.
   - Несколько виртуальных машин могут иметь одно и то же имя, но они будут принадлежать к разным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Следите за обнаружением базы данных в **уведомлениях**. Время, необходимое для выполнения этого действия, зависит от количества баз данных виртуальных машин. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения в фоновом режиме выполняются следующие элементы:

    - Azure Backup регистрирует виртуальную машину в хранилище для резервного копирования рабочей нагрузки. Все базы данных на зарегистрированной виртуальной машине можно архивировать только в этом хранилище.
    - Azure Backup устанавливает расширение Азуребаккупвиндовсворклоад на виртуальной машине. Агент не установлен в базе данных SQL.
    - Azure Backup создает учетную запись службы NT Сервице\азуревлбаккупплугинсвк на виртуальной машине.
      - Все операции резервного копирования и восстановления используют учетную запись службы.
      - Для NT Сервице\азуревлбаккупплугинсвк требуются разрешения системного администратора SQL. Все SQL Server виртуальные машины, созданные в Marketplace, входят в состав установленной SqlIaaSExtension. Расширение Азуребаккупвиндовсворклоад использует SQLIaaSExtension для автоматического получения необходимых разрешений.
    - Если вы не создали виртуальную машину из Marketplace или используете SQL 2008 и 2008 R2, на виртуальной машине может не быть установлен SqlIaaSExtension, а операция обнаружения завершится с сообщением об ошибке Усереррорсклносисадминмембершип. Чтобы устранить эту проблему, следуйте инструкциям в разделе [Set VM Permissions](backup-azure-sql-database.md#set-vm-permissions).

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

1. На**этапе **резервного копирования** > шаг 2. Настройте резервное копирование**и щелкните **настроить резервное копирование**.

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. В поле **выберите элементы для резервного копирования**отображаются все зарегистрированные группы доступности и изолированные экземпляры SQL Server. Щелкните стрелку слева от строки, чтобы развернуть список всех незащищенных баз данных в этом экземпляре или Always On группы доступности.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выберите все базы данных, которые необходимо защитить, а затем нажмите кнопку **ОК**.

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Для защиты более 50 баз данных настройте несколько резервных копий.
     * Для включения [](#enable-auto-protection) всего экземпляра или группы доступности Always on. В раскрывающемся списке **автозащита** выберите **вкл**., а затем нажмите кнопку **ОК**.

    > [!NOTE]
    > Функция [автоматической защиты](#enable-auto-protection) не только включает защиту для всех существующих баз данных одновременно, но и автоматически защищает любые новые базы данных, добавленные в этот экземпляр или группу доступности.  

4. Нажмите кнопку **ОК** , чтобы открыть **политику архивации**.

    ![Включить автоматическую защиту для Always On группы доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В списке **политика резервного копирования**выберите политику и нажмите кнопку **ОК**.

   - Выберите политику по умолчанию в качестве Хаурлилогбаккуп.
   - выбрать существующую политику резервного копирования, созданную ранее для SQL;
   - Определите новую политику на основе целевой точки восстановления (RPO) и периода хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. В окне **резервное копирование**выберите **включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. В области  **Уведомления**  портала можно отслеживать ход настройки.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

- Политика создается на уровне хранилища.
- Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
- При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
- Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
- Сведения о [различных типах политик архивации](backup-architecture.md#sql-server-backup-types).

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище выберите **политики** > архивации**Добавить**.
2. В окне **Добавить**выберите **SQL Server на виртуальной машине Azure** , чтобы определить тип политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В окне **Политика полного резервного копирования**выберите **Периодичность резервного копирования**. Выберите **ежедневно** или **еженедельно**.

   - Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   - Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.
   - Выполните полную архивацию, так как невозможно отключить параметр **полного резервного копирования** .
   - Выберите **полная архивация** , чтобы просмотреть политику.
   - При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. В **области хранения**по умолчанию выбраны все параметры. Удалите все ненужные пределы диапазона хранения, а затем задайте используемые интервалы.

    - Минимальный срок хранения для любого типа резервных копий (полная, разностная и журнал) составляет семь дней.
    - Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    - Резервная копия за конкретный день помечается и сохраняется на основе еженедельного диапазона хранения и параметра еженедельного хранения.
    - Месячные и ежегодные диапазоны хранения ведут себя аналогичным образом.

       ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    - Вы можете активировать только одну разностную резервную копию в день.
    - Максимальный срок хранения разностных резервных копий составляет 180 дней. Для более длительного хранения используйте полные резервные копии.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование журналов может происходить каждые 15 минут и может храниться в течение 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **Политика архивации** выберите, следует ли включить параметр **Сжатие резервной копии SQL**.
    - По умолчанию сжатие отключено.
    - В серверной части Azure Backup использует собственное сжатие резервных копий SQL.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.


### <a name="modify-policy"></a>Изменение политики
Измените политику, чтобы изменить периодичность резервного копирования или диапазон хранения.

> [!NOTE]
> Любые изменения в сроке хранения будут применены ретроспективели ко всем старым точкам восстановления, кроме новых.

На панели мониторинга хранилища перейдите к разделу **Управление** > **политиками архивации** и выберите политику, которую нужно изменить.

  ![Управление политикой архивации](./media/backup-azure-sql-database/modify-backup-policy.png)


## <a name="enable-auto-protection"></a>Включение автоматической защиты  

Можно включить автоматическую защиту для автоматического резервного копирования всех существующих и будущих баз данных на автономный экземпляр SQL Server или в группу доступности Always On.

- Количество баз данных, которые можно выбрать для автоматической защиты, не ограничено.
- Нельзя выборочно защищать или исключать базы данных из защиты в экземпляре во время включения автоматической защиты.
- Если ваш экземпляр уже содержит некоторые защищенные базы данных, они останутся защищенными в соответствующих политиках даже после включения автоматической защиты. Все незащищенные базы данных, добавленные позже, будут иметь только одну политику, определяемую во время включения автоматической защиты, которая указана в разделе **Настройка резервного копирования**. Однако политику, связанную с автоматической защитой базы данных, можно изменить позже.  

Чтобы включить автоматическую защиту, выполните следующие действия.

  1. В меню **Архивируемые элементы** выберите экземпляр, для которого вы хотите включить автоматическую защиту.
  2. Выберите раскрывающийся список в разделе **автозащита**, выберите **вкл**., а затем нажмите кнопку **ОК**.

      ![Включение автоматической защиты в группе доступности](./media/backup-azure-sql-database/enable-auto-protection.png)

  3. Настройка резервного копирования активируется для всех баз данных вместе, и ее можно отслеживать в разделе **заданий резервного копирования**.

Если необходимо отключить автоматическую защиту, выберите имя экземпляра в разделе **Настройка резервного копирования**, а затем выберите **Отключить автозащиту** для экземпляра. Резервное копирование всех баз данных будет продолжаться, но будущие базы данных не будут автоматически защищены.

![Отключить автоматическую защиту для этого экземпляра](./media/backup-azure-sql-database/disable-auto-protection.png)

 
## <a name="next-steps"></a>Следующие шаги

Вы узнаете, как выполнять следующие задачи:

- [Восстановление резервных копий баз данных SQL Server](restore-sql-database-azure-vm.md)
- [Управление резервными копиями баз данных SQL Server](manage-monitor-sql-database-backup.md)
