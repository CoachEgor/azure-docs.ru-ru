---
title: Резервное копирование баз данных SQL Server в Azure | Документация Майкрософт
description: Узнайте, как выполнить резервное копирование SQL Server в Azure.
services: backup
author: sachdevaswati
manager: vijayts
ms.service: backup
ms.topic: conceptual
ms.date: 03/23/2019
ms.author: sachdevaswati
ms.openlocfilehash: 08eff24dc42f594424d109b82933b01b5c1be454
ms.sourcegitcommit: a95dcd3363d451bfbfea7ec1de6813cad86a36bb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62733906"
---
# <a name="back-up-sql-server-databases-in-azure-vms"></a>Создание резервных копий баз данных SQL Server на виртуальных машинах Azure

Базы данных SQL Server являются критическими рабочими нагрузками, требующими низкой целевой точки восстановления (RPO) и долгосрочного хранения. Вы можете выполнить резервное копирование баз данных SQL Server в виртуальных машинах Azure с помощью [Azure Backup](backup-overview.md).

В этой статье показано, как создавать резервные копии базы данных SQL Server, запущенной на виртуальной машине Azure, в хранилище Служб восстановления для Azure Backup. В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * создание и настройка хранилища;
> * обнаружение баз данных и настройка резервного копирования;
> * настройка автоматической защиты для баз данных.


## <a name="prerequisites"></a>Технические условия

Прежде чем создавать резервную копию базы данных SQL Server, проверьте следующие условия.

1. Определение или [создание](backup-sql-server-database-azure-vms.md#create-a-recovery-services-vault) в хранилище служб восстановления, в том же регионе или языковой стандарт в качестве виртуальной Машины, где размещен экземпляр SQL Server.
2. [Проверьте разрешения виртуальной машины](backup-azure-sql-database.md#fix-sql-sysadmin-permissions), необходимые для резервного копирования баз данных SQL.
3. Убедитесь, что виртуальная машина имеет [сетевое подключение](backup-sql-server-database-azure-vms.md#establish-network-connectivity).
4. Убедитесь, что базы данных SQL Server именуются в соответствии с [рекомендациями по именованию](#verify-database-naming-guidelines-for-azure-backup) для Azure Backup.
5. Убедитесь, что у вас отсутствуют любые другие включенные средства резервного копирования базы данных. Отключите все другие резервные копии SQL Server перед настройкой этого сценария. Вы можете включить резервное копирование Azure для виртуальной машины Azure с помощью Azure Backup для базы данных SQL Server на виртуальной машине без конфликтов.


### <a name="establish-network-connectivity"></a>Установка сетевого подключения

Для всех операций виртуальной машине SQL Server требуется подключение к общедоступным IP-адресам Azure. Без подключения к на общедоступный IP-адреса сбой операций виртуальной Машины (обнаружение баз данных, настройка резервных копий, запланировать резервное копирование, восстановить точки восстановления и так далее). Установите соединение, используя один из следующих вариантов:

- **Разрешение диапазонов IP-адресов центра обработки данных Azure**. Разрешите [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) при скачивании. Чтобы получить доступ к группе безопасности сети (NSG), используйте **Set-AzureNetworkSecurityRule** командлета.
- **Развертывание прокси-сервера HTTP для маршрутизации трафика.** Когда создается резервная копия базы данных SQL Server на виртуальной машине Azure, расширение резервного копирования на виртуальной машине использует API HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure Active Directory (Azure AD) для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения являются единственным компонентом, который настроен для доступа к общедоступному Интернету.

Каждый вариант имеет свои преимущества и недостатки

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат. | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются. <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure.
Использование прокси-сервера HTTP   | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере. <br/><br/> Единая точка доступа к виртуальным машинам через Интернет. <br/><br/> Не подвергается влиянию изменений IP-адресов Azure. | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера.

### <a name="set-vm-permissions"></a>Настройка разрешений виртуальной машины

Azure Backup выполняет ряд операций при настройке резервного копирования для базы данных SQL Server:

- Добавляет расширение **AzureBackupWindowsWorkload**.
- Чтобы обнаруживать базы данных на виртуальной машине, Azure Backup создает учетную запись **NT SERVICE\AzureWLBackupPluginSvc**. Эта учетная запись используется для резервного копирования и восстановления и требует разрешений системного администратора SQL.
- Azure Backup будет использовать учетную запись **NT AUTHORITY\SYSTEM** для обнаружения и запроса баз данных, поэтому эта учетная запись должна соответствовать общедоступному имени входа в SQL.

Если вы не создавали виртуальную машину SQL Server из Azure Marketplace, может появиться ошибка **UserErrorSQLNoSysadminMembership**. В этом случае [инструкции](backup-azure-sql-database.md#fix-sql-sysadmin-permissions).

### <a name="verify-database-naming-guidelines-for-azure-backup"></a>Проверка правил именования базы данных Azure Backup

Избегайте ниже для имен базы данных:

  * начальный и конечный пробелы;
  * конечный знак "!".
  * закрывающая квадратная скобка "]".
  * Имена баз данных, начиная с «F:\»

Мы поддерживаем присвоение псевдонимов для неподдерживаемых знаков в таблицах Azure, но мы также рекомендуем избегать их. [Узнайте больше](https://docs.microsoft.com/rest/api/storageservices/Understanding-the-Table-Service-Data-Model?redirectedfrom=MSDN).


[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-sql-server-databases"></a>Обнаружение базы данных SQL Server

Найдите базы данных на виртуальной машине.

1. На [портале Azure](https://portal.azure.com) откройте хранилище Служб восстановления, которое используется для резервного копирования баз данных.

2. На панели мониторинга **Хранилища служб восстановления** выберите **Архивация**.

   ![Щелчок "Архивация" для открытия меню "Цель резервного копирования"](./media/backup-azure-sql-database/open-backup-menu.png)

3. В меню **Цель резервного копирования** для параметра **Where is your workload running** (Где выполняется рабочая нагрузка) задайте значение **Azure** (по умолчанию).

4. В раскрывающемся списке **What do you want to backup** (Что необходимо архивировать) выберите **SQL Server в виртуальной машине Azure**.

    ![Выбор SQL Server на виртуальной машине Azure для резервного копирования](./media/backup-azure-sql-database/choose-sql-database-backup-goal.png)

5. В меню **Цель резервного копирования** > **Обнаружить базы данных в виртуальных машинах** выберите **Запустить обнаружения**, чтобы найти незащищенные виртуальные машины в подписке. Время поиска зависит от числа незащищенных виртуальных машин в подписке.

   - После обнаружения в списке появятся незащищенные виртуальные машины, упорядоченные по имени и группе ресурсов.
   - Если виртуальные машины перечислены не так, как вы ожидали, проверьте наличие их резервной копии в хранилище.
   - Несколько виртуальных машин могут иметь одно имя, но они будут принадлежать к разным группам ресурсов.

     ![Резервное копирование в состоянии ожидания во время поиска баз данных SQL на виртуальных машинах](./media/backup-azure-sql-database/discovering-sql-databases.png)

6. В списке виртуальных машин выберите виртуальную машину под управлением базы данных SQL Server и щелкните **Обнаружить базы данных**.

7. Отслеживайте обнаружение баз данных в области **Уведомления**. В зависимости от количества баз данных на виртуальной машине выполнение задания может занять некоторое время. Когда выбранные базы данных будут обнаружены, появится сообщение об успешном завершении.

    ![Сообщение об успешном развертывании](./media/backup-azure-sql-database/notifications-db-discovered.png)

8. Azure Backup обнаруживает все базы данных SQL Server на виртуальной машине. Во время обнаружения ниже происходит в фоновом режиме:

    - Azure Backup регистрирует виртуальную машину с помощью хранилища для резервного копирования рабочей нагрузки. Все базы данных зарегистрированной виртуальной машины могут быть сохранены только в этом хранилище.
    - Azure Backup устанавливает на виртуальной машине расширение **AzureBackupWindowsWorkload**. В базе данных SQL агент не устанавливается.
    - Azure Backup создает учетную запись службы **NT Service\AzureWLBackupPluginSvc**.
      - Все операции резервного копирования и восстановления используют учетную запись службы.
      - Учетной записи **NT Service\AzureWLBackupPluginSvc** необходимы разрешения sysadmin SQL. Все виртуальные машины SQL Server, созданные в Azure Marketplace, поставляются с установленным **SqlIaaSExtension**. Расширение **AzureBackupWindowsWorkload** использует **SQLIaaSExtension** для автоматического получения необходимых разрешений.
    - Если виртуальная машина не создана в marketplace, в ней не установлено **SqlIaaSExtension** и операция обнаружения завершается со сбоем и сообщением об ошибке **UserErrorSQLNoSysAdminMembership**. Выполните [инструкции](backup-azure-sql-database.md#fix-sql-sysadmin-permissions) Чтобы устранить эту проблему.

        ![Выбор виртуальной машины и базы данных](./media/backup-azure-sql-database/registration-errors.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

Настройте резервное копирование следующим образом:

1. В меню **Цель резервного копирования** выберите **Настройка архивации**.

   ![Выбор "Настройка архивации"](./media/backup-azure-sql-database/backup-goal-configure-backup.png)

2. Нажмите кнопку **Настройка резервного копирования**, **Выбор элементов для архивации** появится колонка. Список всех групп зарегистрированных доступности и автономных серверов SQL Server. Разверните значок шеврона слева от строки, см. в разделе незащищенных баз данных в этом экземпляре или постоянного доступа к группе Доступности.  

    ![Отображение всех экземпляров SQL Server с автономными базами данных](./media/backup-azure-sql-database/list-of-sql-databases.png)

3. Выберите все базы данных, которые нужно защитить, и нажмите кнопку **ОК**.

   ![Защита базы данных](./media/backup-azure-sql-database/select-database-to-protect.png)

   Для оптимизации нагрузки резервного копирования Azure Backup задает максимальное количество баз данных в одной задаче резервной копии — 50.

     * Для защиты более 50 баз данных настройте несколько резервных копий.
     * Кроме того, вы можете включить [автоматическую защиту](#enable-auto-protection) всего экземпляра или группы доступности Always On, выбрав параметр **ВКЛ** из соответствующего раскрывающегося списка в столбце **АВТОЗАЩИТА**. Возможность [автоматической защиты](#enable-auto-protection) не только включает защиту для всех существующих баз данных за один раз, но также распространяется на все новые базы данных, которые будут добавлены к этому экземпляру или группе доступности в дальнейшем.  

4. Нажмите кнопку **ОК** открыть **политика архивации** колонке.

    ![Включить автоматическую защиту для группы доступности Always On](./media/backup-azure-sql-database/enable-auto-protection.png)

5. В **Выбор политики архивации**, выберите политику, а затем нажмите кнопку **ОК**.

   - Выбрать политику по умолчанию: HourlyLogBackup.
   - выбрать существующую политику резервного копирования, созданную ранее для SQL;
   - Определите новую политику на основе диапазона к RPO и хранения.

     ![Выбор политики резервного копирования](./media/backup-azure-sql-database/select-backup-policy.png)

6. На **резервного копирования** меню, выберите **включить резервное копирование**.

    ![Включение выбранной политики резервного копирования](./media/backup-azure-sql-database/enable-backup-button.png)

7. Отслеживать ход выполнения настройки в **уведомления** области портала.

    ![Область "Уведомления"](./media/backup-azure-sql-database/notifications-area.png)

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

- Политика создается на уровне хранилища.
- Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.
- При создании политики резервного копирования режимом по умолчанию является ежедневное полное резервное копирование.
- Можно добавить разностное резервное копирование, но только если настроено еженедельное полное резервное копирование.
- [Сведения](backup-architecture.md#sql-server-backup-types) о разных типах политик резервного копирования.

Чтобы создать политику резервного копирования, выполните следующее.

1. В хранилище выберите **Политики архивации** > **Добавить**.
2. В меню **Добавить** щелкните **SQL Server в виртуальной машине Azure**. Чтобы определяет тип политики.

   ![Выбор типа для новой политики резервного копирования](./media/backup-azure-sql-database/policy-type-details.png)

3. Введите имя новой политики в поле **Имя политики**.
4. В меню **Full Backup policy** (Политика полного резервного копирования) для параметра **Частота архивации** выберите **Ежедневно** или **Еженедельно**.

   - Для параметра **Ежедневно** выберите часовой пояс и час для запуска задания резервного копирования.
   - Необходимо выполнить полное резервное копирование как нельзя отключить **полной резервной копии** параметр.
   - Щелкните **Полная резервная копия**, чтобы просмотреть политику.
   - При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.
   - Для параметра **Еженедельно** выберите день недели, час и часовой пояс для запуска задания резервного копирования.

     ![Поля новой политики резервного копирования](./media/backup-azure-sql-database/full-backup-policy.png)  

5. По умолчанию для параметра **Диапазон хранения** выбраны все значения. Очистите любые нежелательные ограничения диапазона периода удержания, которые вы не хотите использовать, и установите соответствующие интервалы.

    - Минимальный срок хранения для любого типа резервной копии (полной или разностной резервной копии/log) составляет 7 дней.
    - Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    - Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром недельного хранения.
    - Месячный и годовой диапазоны хранения действуют аналогичным образом.

   ![Параметры интервала "Диапазон хранения"](./media/backup-azure-sql-database/retention-range-interval.png)

6. В меню **Full Backup policy** (Политика полного резервного копирования) щелкните **ОК**, чтобы подтвердить параметры.
7. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.

   ![Параметры интервала диапазона хранения](./media/backup-azure-sql-database/retention-range-interval.png)
   ![Открытие меню политики разностного резервного копирования](./media/backup-azure-sql-database/backup-policy-menu-choices.png)

8. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.

    - Максимально в день можно активировать одну разностную резервную копию.
    - Максимальный срок хранения разностных резервных копий составляет 180 дней. Если требуется более длительное хранение, необходимо использовать полные резервные копии.

9. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

10. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервное копирование журналов**.
11. В меню **Резервное копирование журналов** выберите **Включить** и настройте значения управления периодичностью и хранением. Резервное копирование журналов может происходить с частотой не чаще каждые 15 минут и храниться до 35 дней.
12. Для сохранения политики и возврата к главному меню **Политика архивации** нажмите кнопку **ОК**.

    ![Изменение политики резервного копирования журналов](./media/backup-azure-sql-database/log-backup-policy-editor.png)

13. В меню **Политика архивации** выберите, следует ли включить параметр **Сжатие резервной копии SQL**.
    - По умолчанию сжатие отключено.
    - В серверной части Azure Backup использует собственное сжатие резервных копий SQL.

14. После внесения изменений в политику резервного копирования нажмите кнопку **ОК**.


### <a name="modify-policy"></a>Изменение политики
Измените политику, чтобы изменить диапазон хранения резервных копий частоты или хранения.

> [!NOTE]
> Любое изменение в срок хранения применяются задним всех старых точек восстановления помимо новые.

На панели мониторинга хранилища, перейдите к **управление** > **политики резервного копирования** и выберите политику, которую требуется изменить.

  ![Управление политикой резервного копирования](./media/backup-azure-sql-database/modify-backup-policy.png)


## <a name="enable-auto-protection"></a>Включение автоматической защиты  

Включение автоматической защиты для автоматического резервного копирования все существующие базы данных и баз данных, которые будут добавлены в будущем для автономный экземпляр SQL Server или SQL Server AlwaysOn в группе доступности.

- Нет ограничений на количество баз данных, которые можно выбрать для автоматической защиты за одно действие.
- Нельзя выборочно защиты или исключить из защиты в экземпляр во время включения автоматической защиты базы данных.
- Если ваш экземпляр уже включает некоторые защищенные базы данных, они продолжают быть защищены в соответствии их соответствующих политик, даже в том случае, после включения автоматической защиты. Тем не менее, все незащищенные базы данных и баз данных, которые будут добавляться в будущем, будет иметь только одну политику, которая определение во время включения автоматической защиты, в разделе **Настройка резервного копирования**. Тем не менее можно изменить политику, связанную с автоматической защитой данных более поздней версии.  

Далее приведены действия, чтобы включить автоматическую защиту.

  1. В меню **Архивируемые элементы** выберите экземпляр, для которого вы хотите включить автоматическую защиту.
  2. Щелкните раскрывающийся список в разделе **Автозащита** и установите значение **Включен**. Нажмите кнопку **ОК**.

      ![Включить автоматическую защиту для группы доступности Always On](./media/backup-azure-sql-database/enable-auto-protection.png)

  3. Настройка резервного копирования активируется для всех баз данных вместе, и ее можно отслеживать в разделе **заданий резервного копирования**.

Если вам нужно отключить автоматическую защиту, щелкните имя экземпляра в разделе **Настройка резервного копирования**и выберите **отключить автоматическая защита** для экземпляра. Будет продолжать резервное копирование всех баз данных, но в будущих базах данных не будут защищены автоматически.

![Отключение автоматической защиты этого экземпляра](./media/backup-azure-sql-database/disable-auto-protection.png)

 
## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о восстановлении резервных копий баз данных SQL Server см. в [этой статье](restore-sql-database-azure-vm.md).
- Дополнительные сведения об управлении резервными копиями баз данных SQL Server см. в [этой статье](manage-monitor-sql-database-backup.md).
