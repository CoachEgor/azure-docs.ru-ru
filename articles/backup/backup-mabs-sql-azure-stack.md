---
title: Резервное копирование рабочих нагрузок SQL Server в Azure Stack
description: Использование сервера Azure Backup Server для защиты рабочей нагрузки SQL Server в Azure Stack.
ms.reviewer: adigan
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 6/8/2018
ms.author: dacurwin
ms.openlocfilehash: 3b116e25635873429dd164288c2764fd76c8f7a7
ms.sourcegitcommit: d585cdda2afcf729ed943cfd170b0b361e615fae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/31/2019
ms.locfileid: "68688999"
---
# <a name="back-up-sql-server-on-stack"></a>Резервное копирование SQL Server в Stack
Эта статья может помочь при настройке Microsoft Azure Backup Server (MABS) для защиты баз данных SQL Server в Azure Stack.

Процесс управления резервным копированием и восстановлением базы данных SQL Server в Azure состоит из трех этапов.

1. Создание политики резервного копирования для защиты баз данных SQL Server
2. Создание резервных копий по запросу
3. Восстановление базы данных с дисков и из Azure

## <a name="before-you-start"></a>Перед началом

[Установка и подготовка Azure Backup Server](backup-mabs-install-azure-stack.md).

## <a name="create-a-backup-policy-to-protect-sql-server-databases-to-azure"></a>Создание политики резервного копирования для защиты баз данных SQL Server в Azure
1. В пользовательском интерфейсе Azure Backup Server щелкните рабочую область **Защита**.

2. На ленте инструментов щелкните **Создать** , чтобы создать новую группу защиты.

    ![Создайте группу защиты](./media/backup-azure-backup-sql/protection-group.png)

    Azure Backup Server запускает мастер группы защиты, который позволяет создать **Группу защиты**. Нажмите кнопку **Далее**.

3. На экране **Выбор типа группы защиты** выберите **Серверы**.

    ![Выбор типа для группы защиты — «Серверы»](./media/backup-azure-backup-sql/pg-servers.png)

4. На экране **Выбор элементов группы** в списке "Доступные элементы" показаны различные источники данных. Щелкните элемент **+** , чтобы развернуть папку и отобразить подпапки. Установите флажок, чтобы выбрать нужный элемент.

    ![Выбор базы данных SQL](./media/backup-azure-backup-sql/pg-databases.png)

    Все выбранные элементы отображаются в списке "Выбранные элементы". После выбора серверов или баз данных, которые необходимо защитить, щелкните **Далее**.

5. На экране **Выбор метода защиты данных** укажите имя группы защиты и установите флажок **Мне нужна оперативная защита**.

    ![Метод защиты данных — краткосрочная на диске и оперативная в Azure](./media/backup-azure-backup-sql/pg-name.png)

6. На экране **Выбор краткосрочных целей** введите необходимые данные, чтобы создать точки резервного копирования на диске и нажмите **Далее**.

    В этом примере **Диапазон хранения** составляет **5 дней**, **Частота синхронизации** составляет один раз каждые **15 минут**, что является частотой резервного копирования. **Быстрая полная архивация** задано значение **20:00**.

    ![Краткосрочные цели](./media/backup-azure-backup-sql/pg-shortterm.png)

   > [!NOTE]
   > В приведенном примере в 20:00 ежедневно создаются точки резервного копирования путем передачи измененных данных из точки резервного копирования в 20:00 за предыдущий день. Этот процесс называется **быстрой полной архивацией**. Журналы транзакций синхронизируются каждые 15 минут. Если необходимо восстановить базу данных в 21:00, точка восстановления создается из журналов для последней точки быстрого полного резервного копирования (в этом случае в 20:00).
   >
   >

7. На экране **Проверка выделения места на диске** выполните проверку общего доступного объема памяти и сведения о потенциальном дисковом пространстве. Нажмите кнопку **Далее**.

8. В меню **Выбор метода создания реплики** выберите способ создания первой точки восстановления. Начальную резервную копию можно передать вручную (не по сети), чтобы не перегружать полосу пропускания, либо по сети. При выборе ожидания передачи первой резервной копии можно указать время для начальной передачи. Нажмите кнопку **Далее**.

    ![Метод первичной репликации](./media/backup-azure-backup-sql/pg-manual.png)

    Для создания начальной резервной копии необходимо полностью перенести источник данных (базу данных SQL Server) с производственного сервера (компьютера SQL Server) на Azure Backup Server. Объем этих данных может быть велик, и их передача по сети может превысить пропускную способность. Поэтому вы можете выбрать передачу начальной резервной копии **вручную** (с помощью съемного носителя), чтобы избежать перегрузки пропускной способности сети, или **автоматически по сети** (в указанное время).

    После создания начальной резервной копии на ее основе будет выполняться добавочная архивация. Обычно добавочные резервные копии имеют небольшой размер и могут быть легко переданы по сети.

9. Выберите время для выполнения проверки согласованности и нажмите кнопку **Далее**.

    ![Проверка согласованности](./media/backup-azure-backup-sql/pg-consistent.png)

    Azure Backup Server проверяет целостность точки резервного копирования. Azure Backup Server вычисляет контрольную сумму файла резервной копии на рабочем сервере (в этом сценарии используется SQL Server) и резервной копии данных для этого файла. Если возникает конфликт, предполагается, что резервная копия на Azure Backup Server повреждена. Azure Backup Server исправляет резервные копии данных, отправляя блоки, соответствующие расхождению в контрольной сумме. Поскольку проверки целостности являются ресурсоемкими, можно запланировать проверку целостности или выполнять ее автоматически.

10. Чтобы настроить оперативную защиту источников данных, выберите базы данных для копирования в Azure и нажмите кнопку **Далее**.

    ![Выбор источников данных](./media/backup-azure-backup-sql/pg-sqldatabases.png)

11. Выбирайте расписание резервного копирования и политики хранения в соответствии с политиками своей организации.

    ![Планирование и хранение](./media/backup-azure-backup-sql/pg-schedule.png)

    В этом примере резервные копии создаются дважды в день — в 12:00 и в 20:00 (в нижней части экрана).

    > [!NOTE]
    > Чтобы обеспечить быстрое восстановление, рекомендуется создать на диске несколько краткосрочных точек восстановления. Эти точки восстановления используются для оперативного восстановления. Azure — это удобное внешнее расположение с более высоким уровнем обслуживания и гарантированной доступностью.
    >
    >

    **Рекомендация**. Если запуск резервного копирования в Azure планируется после завершения резервного копирования локального диска, последние резервные копии диска всегда копируются в Azure.

12. Выберите расписание для политики хранения. Дополнительные сведения о том, как работает политика хранения, см. в статье [Использование службы архивации Azure для замены ленточной инфраструктуры](backup-azure-backup-cloud-as-tape.md).

    ![Политика хранения](./media/backup-azure-backup-sql/pg-retentionschedule.png)

    В данном примере:

    * Резервные копии создаются дважды в день, в 12:00 и в 20:00 (в нижней части экрана), и хранятся в течение 180 дней.
    * Резервная копия, создаваемая в субботу в 12:00, хранится 104 недели.
    * Резервная копия, создаваемая в последнюю субботу в 12:00, хранится 60 месяцев.
    * Резервная копия, создаваемая в последнюю субботу марта в 12:00, хранится 10 лет.
13. Щелкните **Далее** и выберите нужный параметр для передачи начальной резервной копии в Azure. Вы можете выбрать параметр **Автоматически по сети**.

14. Просмотрев сведения о политике в окне **Сводка**, нажмите кнопку **Создать группу**, чтобы завершить процесс. После нажатия кнопки **Закрыть** вы сможете отслеживать ход выполнения задания в рабочей области "Мониторинг".

    ![Создание группы защиты: ход выполнения](./media/backup-azure-backup-sql/pg-summary.png)

## <a name="on-demand-backup-of-a-sql-server-database"></a>Архивация базы данных SQL Server по запросу
С помощью описанных выше шагов мы создали политику резервного копирования, однако «точка восстановления» создается только при первом резервном копировании. Можно не ждать создания точки восстановления с помощью планировщика, а создать ее вручную, выполнив описанные ниже действия.

1. Прежде чем создавать точку восстановления, подождите, пока в группе защиты для базы данных отобразится состояние **ОК** .

    ![Члены группы защиты](./media/backup-azure-backup-sql/sqlbackup-recoverypoint.png)
2. Щелкните базу данных правой кнопкой мыши и выберите **Создать точку восстановления**.

    ![Создание точки оперативного восстановления](./media/backup-azure-backup-sql/sqlbackup-createrp.png)
3. Выберите **Оперативная защита** в раскрывающемся меню и нажмите кнопку **ОК** для запуска создания точки восстановления в Azure.

    ![Создать точку восстановления](./media/backup-azure-backup-sql/sqlbackup-azure.png)
4. Просмотреть ход выполнения задания в рабочей области **Мониторинг**.

    ![Консоль наблюдения](./media/backup-azure-backup-sql/sqlbackup-monitoring.png)

## <a name="recover-a-sql-server-database-from-azure"></a>Восстановление базы данных SQL Server из Azure
Чтобы восстановить защищенный объект (базу данных SQL Server) из Azure, необходимо выполнить следующие шаги.

1. Откройте консоль управления Azure Backup Server. Перейдите в рабочую область **Восстановление**, где вы увидите защищенные серверы. Найдите нужную базу данных (в данном случае ReportServer$MSDPM2012). Выберите время **Восстановить из**, которое задается как **Подключенная** точка.

    ![Выбор точки восстановления](./media/backup-azure-backup-sql/sqlbackup-restorepoint.png)
2. Щелкните имя базы данных правой кнопкой мыши и выберите **Восстановить**.

    ![Восстановление из Azure](./media/backup-azure-backup-sql/sqlbackup-recover.png)
3. MABS отображает сведения о точке восстановления. Нажмите кнопку **Далее**. Чтобы перезаписать базу данных, выберите тип восстановления **Восстановить в исходном экземпляре SQL Server**. Нажмите кнопку **Далее**.

    ![Восстановление в исходном расположении](./media/backup-azure-backup-sql/sqlbackup-recoveroriginal.png)

    В этом примере MABS восстанавливает базу данных в другом экземпляре SQL Server или в отдельной сетевой папке.

4. В окне **Указание параметров восстановления** можно выбрать параметр "Регулирование использования полосы пропускания сети", чтобы регулировать полосу пропускания, используемую при восстановлении. Нажмите кнопку **Далее**.

5. В окне **Сводка** вы увидите все конфигурации восстановления, доступные на данный момент. Щелкните **Восстановить**.

    В окне отобразится состояние восстановления, показывающее, что выполняется восстановление базы данных. Вы можете закрыть мастер кнопкой **Закрыть** и отслеживать ход выполнения в рабочей области **Мониторинг**.

    ![Запуск процесса восстановления](./media/backup-azure-backup-sql/sqlbackup-recoverying.png)

    По завершении процесса восстановленная база данных будет согласована с приложением.

## <a name="next-steps"></a>Следующие шаги

См. в статье [Файлы резервной копии и приложение](backup-mabs-files-applications-azure-stack.md).
См. в статье [SharePoint резервного копирования на Azure Stack](backup-mabs-sharepoint-azure-stack.md).
