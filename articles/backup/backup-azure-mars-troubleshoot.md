---
title: Устранение неполадок агента Azure Backup
description: Устранение неполадок при установке и регистрации агента Azure Backup
services: backup
author: saurabhsensharma
manager: shivamg
ms.service: backup
ms.topic: conceptual
ms.date: 05/21/2019
ms.author: saurse
ms.openlocfilehash: 122f0884469a4901b02a1c86dd5ec98ef4fb24b0
ms.sourcegitcommit: 13cba995d4538e099f7e670ddbe1d8b3a64a36fb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/22/2019
ms.locfileid: "66000253"
---
# <a name="troubleshoot-microsoft-azure-recovery-services-mars-agent"></a>Устранение неполадок с агентом Служб восстановления Microsoft Azure (MARS)

Ниже описаны способы устранения ошибок, которые могут возникнуть при настройке, регистрации, резервном копировании и восстановлении.

## <a name="basic-troubleshooting"></a>Базовое устранение неполадок

Рекомендуется выполнить ниже проверки, прежде чем начать устранение неполадок агента служб восстановления Microsoft Azure (MARS):

- [Убедитесь, что агент служб восстановления Microsoft Azure (MARS) в актуальном состоянии](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409)
- [Убедитесь, что между агентом служб восстановления Microsoft Azure и Azure установлено сетевое подключение](https://aka.ms/AB-A4dp50)
- Убедитесь, что службы восстановления Microsoft Azure запущены (на сервисной консоли). Если необходимо, выполните перезагрузку и повторите операцию.
- [Убедитесь, что в расположении временной папки доступно 5–10 % свободного места](https://aka.ms/AB-AA4dwtt).
- [Проверьте, не влияет ли на работу службы Azure Backup другой процесс или антивирусная программа](https://aka.ms/AB-AA4dwtk).
- [Запланированное резервное копирование завершается сбоем, но резервное копирование вручную работает](https://aka.ms/ScheduledBackupFailManualWorks).
- Убедитесь, что в вашей операционной системе установлены последние обновления.
- [Убедитесь, неподдерживаемые диски и файлы с неподдерживаемые атрибуты исключены из резервной копии](backup-support-matrix-mars-agent.md#supported-drives-or-volumes-for-backup)
- Убедитесь, что на **системных часах** в защищенной системе правильно настроен часовой пояс. <br>
- [Убедитесь, что на сервере используется версия .Net Framework не ниже 4.5.2.](https://www.microsoft.com/download/details.aspx?id=30653)<br>
- Если вы пытаетесь **повторно зарегистрировать сервер** в хранилище, <br>
  - убедитесь, что агент удален с сервера и с портала. <br>
  - Используйте ту же парольную фразу, которая изначально использовалась для регистрации сервера. <br>
- В случае автономного резервного копирования убедитесь, что Azure PowerShell версии 3.7.0 установлен на компьютере источника и копии, перед началом операции резервного копирования в автономном режиме
- [Следует учитывать, когда агент службы архивации запущен на виртуальной машине Azure](https://aka.ms/AB-AA4dwtr)

## <a name="invalid-vault-credentials-provided"></a>Указаны недопустимые учетные данные хранилища

| Информация об ошибке | Возможные причины | Рекомендуемые действия |
| ---     | ---     | ---    |
| **Ошибка** </br> *Указаны недопустимые учетные данные хранилища. Файл либо поврежден, либо не содержит последних учетных данных, связанных со службой восстановления. (ID: 34513)* | <ul><li> Учетные данные хранилища недействительны (то есть они были скачаны более чем за 48 часов до момента регистрации).<li>Агенту MARS не удалось загрузить файлы в папку Windows Temp. <li>Учетные данные хранилища находятся в сетевой папке. <li>Отключен протокол TLS 1.0.<li> Настроенный прокси-сервер блокирует подключения. <br> |  <ul><li>Скачайте файл с новыми учетными данными хранилища. (**Примечание.** Если вы скачали несколько файлов с учетными данными хранилища, то допустимым в течение 48 часов будет только последний скачанный файл.) <li>Последовательно выберите **IE** > **Состояние** > **Свойства обозревателя** > **Безопасность** > **Интернет**. Затем выберите **Custom Level** (Пользовательский уровень) и прокрутите список до тех пор, пока не увидите раздел скачивания файла. Нажмите кнопку **Включить**.<li>Возможно, придется добавить эти сайты в список [надежных сайтов](https://docs.microsoft.com/azure/backup/backup-configure-vault#verify-internet-access) в Internet Explorer.<li>Измените параметры для использования прокси-сервера. Затем введите сведения о прокси-сервере. <li> Синхронизируйте дату и время с датой и временем компьютера.<li>Если появляется сообщение о том, что скачивание файлов запрещено, вероятно, что в каталоге C:/Windows/Temp много файлов.<li>Перейдите к папке C:/Windows/Temp, и если там скопилось более 60 000 или 65 000 файлов (с расширением TMP), удалите эти файлы.<li>Убедитесь, что установлена платформа .NET Framework 4.6.2. <li>Если TLS 1.0 отключен для соблюдения стандартов PCI, используйте рекомендации по устранению неполадок, представленные по [этой ссылке](https://support.microsoft.com/help/4022913). <li>Если на сервере установлено антивирусное программное обеспечение, исключите из антивирусной проверки следующие файлы: <ul><li>CBengine.exe.<li>CSC.exe, связанный с .NET Framework. Для каждой версии .NET, установленной на сервере, есть файл CSC.exe. Нужно исключить файлы CSC.exe, которые привязаны к версиям платформы .NET, установленным на целевом сервере. <li>Временная папка или расположение кэша. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.<br><li>Папка корзины C:\Program Files\Microsoft Azure Recovery Services Agent\Bin.

## <a name="unable-to-download-vault-credential-file"></a>Не удалось скачать файл учетных данных хранилища

| Информация об ошибке | Рекомендуемые действия |
| ---     | ---    |
|Не удалось скачать файл учетных данных хранилища. (ID: 403) | <ul><li> Попробуйте скачать учетные данные хранилища с помощью различных браузеров или выполните следующие шаги. <ul><li> Запустите Internet Explorer и нажмите клавишу F12. </li><li> Чтобы очистить кэш и файлы cookie в Internet Explorer перейдите на вкладку **Сеть**. </li> <li> Обновите страницу.<br>(ИЛИ)</li></ul> <li> Проверьте, является ли подписка отключенной или ее срок действия истек.<br>(ИЛИ)</li> <li> Проверьте, не блокирует ли какое-либо правило брандмауэра скачивание файла учетных данных хранилища. <br>(ИЛИ)</li> <li> Убедитесь, что лимит хранилища не был превышен (50 компьютеров на одно хранилище)<br>(ИЛИ)</li>  <li> Убедитесь, пользователь запросил разрешение Azure Backup для загрузки учетных данных хранилища и зарегистрировать сервер с хранилищем, см. в разделе [статьи](backup-rbac-rs-vault.md)</li></ul> |

## <a name="the-microsoft-azure-recovery-service-agent-was-unable-to-connect-to-microsoft-azure-backup"></a>Агенту службы восстановления Microsoft Azure не удалось подключиться к службе Microsoft Azure Backup

| Информация об ошибке | Возможные причины | Рекомендуемые действия |
| ---     | ---     | ---    |
| **Ошибка** <br /><ol><li>*Агенту служб восстановления Microsoft Azure не удалось подключиться к службе архивации Microsoft Azure. (ID: 100050) Проверьте параметры сети и наличие подключения к Интернету*.<li>*(407) Требуется аутентификация прокси-сервера* |Прокси-сервер блокирует подключения. |  <ul><li>Последовательно выберите **IE** > **Состояние** > **Свойства обозревателя** > **Безопасность** > **Интернет**. Затем выберите **Custom Level** (Пользовательский уровень) и прокрутите список до тех пор, пока не увидите раздел скачивания файла. Нажмите кнопку **Включить**.<li>Возможно, придется добавить эти сайты в список [надежных сайтов](https://docs.microsoft.com/azure/backup/backup-try-azure-backup-in-10-mins) в Internet Explorer.<li>Измените параметры для использования прокси-сервера. Затем введите сведения о прокси-сервере. <li>Если на сервере установлено антивирусное программное обеспечение, исключите из антивирусной проверки следующие файлы. <ul><li>CBEngine.exe (вместо dpmra.exe).<li>CSC.exe (связан с .NET Framework). Для каждой версии .NET, установленной на сервере, есть файл CSC.exe. Нужно исключить файлы CSC.exe, которые привязаны к версиям платформы .NET, установленным на целевом сервере. <li>Временная папка или расположение кэша. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.<li>Папка корзины C:\Program Files\Microsoft Azure Recovery Services Agent\Bin.


## <a name="failed-to-set-the-encryption-key-for-secure-backups"></a>Не удалось настроить ключ шифрования для защиты резервных копий.

| Информация об ошибке | Возможные причины | Рекомендуемые действия |
| ---     | ---     | ---    |
| **Ошибка** <br />*Не удалось настроить ключ шифрования для защиты резервных копий. Активация выполнена не полностью, но парольная фраза для шифрования сохранена в указанный далее файл*. |<li>Сервер уже зарегистрирован в другом хранилище.<li>При настройке повреждена парольная фраза.| Отмените регистрацию сервера в хранилище и повторно зарегистрируйте его с использованием новой парольной фразы.

## <a name="the-activation-did-not-complete-successfully"></a>Активация не была успешно завершена

| Информация об ошибке | Возможные причины | Рекомендуемые действия |
|---------|---------|---------|
|**Ошибка** <br /><ol>*Активация не выполнена. Сбой текущей операции из-за внутренней ошибки в службе [0x1FC07]. Повторите операцию позднее. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт*.     | <li> Недостаточно свободного места на томе, где расположена временная папка. <li> Временная папка неправильно перемещена в другое место. <li> Отсутствует файл OnlineBackup.KEK.         | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent).<li>Переместите временную папку или расположение кэша в том, имеющий достаточно свободного пространства (не менее 5–10 % от общего размера данных резервных копий). Чтобы правильно переместить расположение кэша, см. раздел [Архивация](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#backup).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.        |

## <a name="encryption-passphrase-not-correctly-configured"></a>Парольная фраза для шифрования неправильно настроена

| Информация об ошибке | Возможные причины | Рекомендуемые действия |
|---------|---------|---------|
|**Ошибка** <br /><ol>*Ошибка 34506. Парольная фраза для шифрования, сохраненная для этого компьютера, настроена неправильно*.    | <li> Недостаточно свободного места на томе, где расположена временная папка. <li> Временная папка неправильно перемещена в другое место. <li> Отсутствует файл OnlineBackup.KEK.        | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent).<li>Переместите временную папку или расположение кэша в том, имеющий достаточно свободного пространства (не менее 5–10 % от общего размера данных резервных копий). Чтобы правильно переместить расположение кэша, см. раздел [Архивация](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#backup).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.         |


## <a name="backups-dont-run-according-to-the-schedule"></a>Резервное копирование не запускается по расписанию
Если запланированное резервное копирование не запускается автоматически, а вручную оно выполняется без проблем, выполните следующие действия:

- Убедитесь, что расписание резервного копирования Windows Server не конфликтует с файлами и папками расписание архивации Azure.
- Выберите **Панель управления** > **Администрирование** > **Планировщик задач**. Разверните раздел **Майкрософт** и выберите **Online Backup** (Архивация в сети). Дважды щелкните **Microsoft-OnlineBackup** и перейдите на вкладку **Триггеры**. Убедитесь, что состояние имеет значение **Включено**. Если это не так, выберите **Изменить**, а затем установите флажок **Включено** и щелкните **OK**. На вкладке **Общие** перейдите в раздел **Параметры безопасности** и убедитесь, что для выполнения задачи выбрана учетная запись пользователя **SYSTEM** или **группы локальных администраторов** на сервере.

- Убедитесь, что на сервере установлен PowerShell 3.0 или более поздней версии. Чтобы проверить версию PowerShell, выполните следующую команду и убедитесь, что *основной* номер версии равен или больше 3.

  `$PSVersionTable.PSVersion`

- Убедитесь, что следующий путь является частью переменной среды *PSMODULEPATH*.

  `<MARS agent installation path>\Microsoft Azure Recovery Services Agent\bin\Modules\MSOnlineBackup`

- Если для политики выполнения PowerShell для *LocalMachine* задано значение ограниченного доступа, командлет PowerShell, который запускает задачи резервного копирования, может завершиться с ошибкой. Выполните следующие команды в режиме с повышенными привилегиями, чтобы проверить и задать политику выполнения как *Unrestricted* или *RemoteSigned*.

  `PS C:\WINDOWS\system32> Get-ExecutionPolicy -List`

  `PS C:\WINDOWS\system32> Set-ExecutionPolicy Unrestricted`

> [!TIP]
> Чтобы убедиться, что изменения применяются последовательно, перезагрузите сервер после выполнения приведенных выше шагов.


## <a name="troubleshoot-restore-issues"></a>Устранение неполадок восстановления

Служба Azure Backup может не подключить том восстановления даже через несколько минут. Во время процесса вы также можете получить сообщения об ошибках. Чтобы приступить к восстановлению в обычном порядке, выполните следующие действия:

1.  Отмените текущий процесс подключения, если он уже выполняется в течение нескольких минут.

2.  Убедитесь, что вы используете последнюю версию агента Backup. Чтобы выяснить версию, в области **Действия** консоли MARS выберите **About Microsoft Azure Recovery Services Agent** (Сведения об агенте служб восстановления Microsoft Azure). Убедитесь, что номер **версии** равен или выше, чем у версии, упомянутой [в этой статье](https://go.microsoft.com/fwlink/?linkid=229525). Последнюю версию можно загрузить [здесь](https://go.microsoft.com/fwLink/?LinkID=288905).

3.  Последовательно выберите пункты **Диспетчер устройств** > **Контроллеры запоминающих устройств** и найдите **Инициатор iSCSI (Майкрософт)**. Если он имеется в списке устройств, переходите к шагу 7.

4.  Если не удается найти службу инициатора Майкрософт iSCSI, попробуйте обратиться к разделу **Диспетчер устройств** > **Контроллеры запоминающих устройств** и обратите внимание, имеется ли в этом разделе устройство с именем **Неизвестное устройство** и идентификатором оборудования **ROOT\ISCSIPRT**.

5.  Щелкните правой кнопкой мыши **Неизвестное устройство** и выберите команду **Обновить драйверы**.

6.  Обновите драйвер, выбрав параметр **Автоматический поиск обновленных драйверов**. После обновления драйверов пункт **Неизвестное устройство** должен измениться на **Инициатор iSCSI (Майкрософт)**, как показано ниже.

    ![Снимок экрана. Диспетчер устройств Azure Backup с выделенными контроллерами хранилища](./media/backup-azure-restore-windows-server/UnknowniSCSIDevice.png)

7.  Последовательно выберите пункты **Диспетчер задач** > **Службы (локальные)** > **Служба инициатора Майкрософт iSCSI**.

    ![Снимок экрана. Диспетчер задач Azure Backup с выделенными локальными службами](./media/backup-azure-restore-windows-server/MicrosoftInitiatorServiceRunning.png)

8.  Перезапустите службу инициатора iSCSI (Майкрософт). Чтобы сделать это, щелкните правой кнопкой мыши службу, выберите **Остановить**, снова щелкните правой кнопкой мыши и выберите **Запустить**.

9.  Повторите восстановление с помощью [**мгновенного восстановления**](backup-instant-restore-capability.md).

Если восстановление по-прежнему не удается запустить, перезагрузите сервер или клиент. Если вы не хотите выполнять перезагрузку или восстановление по-прежнему не запускается даже после перезагрузки сервера, попробуйте выполнить восстановление на другом компьютере. Выполните шаги, приведенные в [этой статье](backup-azure-restore-windows-server.md#use-instant-restore-to-restore-data-to-an-alternate-machine).

## <a name="need-help-contact-support"></a>Требуется помощь? Связаться со службой поддержки
Если вам все еще нужна помощь, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), которая поможет быстро устранить проблему.

## <a name="next-steps"></a>Дальнейшие действия
* Чтобы получить дополнительные сведения, см. статью [Архивация Windows Server в Azure](tutorial-backup-windows-server-to-azure.md).
* Если необходимо восстановить резервную копию, см. статью о [восстановлении файлов на компьютере Windows](backup-azure-restore-windows-server.md).
