---
title: Устранение неполадок агента Azure Backup
description: Устранение неполадок при установке и регистрации агента Azure Backup
services: backup
author: saurabhsensharma
manager: shivamg
ms.service: backup
ms.topic: conceptual
ms.date: 05/21/2019
ms.author: saurse
ms.openlocfilehash: 2c2ed46ed6e4a5d6663387777d3425d18b50500e
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67060218"
---
# <a name="troubleshoot-microsoft-azure-recovery-services-mars-agent"></a>Устранение неполадок с агентом Служб восстановления Microsoft Azure (MARS)

Ниже описаны способы устранения ошибок, которые могут возникнуть при настройке, регистрации, резервном копировании и восстановлении.

## <a name="basic-troubleshooting"></a>Базовое устранение неполадок

Рекомендуется выполнить ниже проверки, прежде чем начать устранение неполадок агента служб восстановления Microsoft Azure (MARS):

- [Убедитесь, что агент служб восстановления Microsoft Azure (MARS) в актуальном состоянии](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409)
- [Убедитесь, что между агентом служб восстановления Microsoft Azure и Azure установлено сетевое подключение](https://aka.ms/AB-A4dp50)
- Убедитесь, что службы восстановления Microsoft Azure запущены (на сервисной консоли). Если необходимо, выполните перезагрузку и повторите операцию.
- [Убедитесь, что в расположении временной папки доступно 5–10 % свободного места](https://aka.ms/AB-AA4dwtt).
- [Проверьте, не влияет ли на работу службы Azure Backup другой процесс или антивирусная программа](https://aka.ms/AB-AA4dwtk).
- [Запланированное резервное копирование завершается сбоем, но резервное копирование вручную работает](https://aka.ms/ScheduledBackupFailManualWorks).
- Убедитесь, что в вашей операционной системе установлены последние обновления.
- [Убедитесь, неподдерживаемые диски и файлы с неподдерживаемые атрибуты исключены из резервной копии](backup-support-matrix-mars-agent.md#supported-drives-or-volumes-for-backup)
- Убедитесь, что на **системных часах** в защищенной системе правильно настроен часовой пояс. <br>
- [Убедитесь, что на сервере используется версия .Net Framework не ниже 4.5.2.](https://www.microsoft.com/download/details.aspx?id=30653)<br>
- Если вы пытаетесь **повторно зарегистрировать сервер** в хранилище, <br>
  - убедитесь, что агент удален с сервера и с портала. <br>
  - Используйте ту же парольную фразу, которая изначально использовалась для регистрации сервера. <br>
- В случае автономного резервного копирования убедитесь, что Azure PowerShell версии 3.7.0 установлен на компьютере источника и копии, перед началом операции резервного копирования в автономном режиме
- [Следует учитывать, когда агент службы архивации запущен на виртуальной машине Azure](https://aka.ms/AB-AA4dwtr)

## <a name="invalid-vault-credentials-provided"></a>Указаны недопустимые учетные данные хранилища

**Сообщение об ошибке** Указаны недопустимые учетные данные хранилища. Файл либо поврежден, либо не содержит последних учетных данных, связанных со службой восстановления. (ID: 34513)

| Причина: | Рекомендуемое действие |
| ---     | ---    |
| **Недопустимые учетные данные хранилища** <br/> <br/> Файлы хранилища учетных данных может быть поврежден или истек срок (т. е. более чем за 48 часов до регистрации для загрузки)| Скачайте новые учетные данные из хранилища служб восстановления на портале Azure (см. в разделе *шаг 6* под [ **загрузить агент MARS** ](https://docs.microsoft.com/azure/backup/backup-configure-vault#download-the-mars-agent) раздел) и выполнять ниже: <ul><li> Если вы уже установили и зарегистрировали агенту службы архивации Microsoft Azure, а затем откройте консоль MMC агента Microsoft Azure Backup и выберите **Регистрация сервера** панели действий для завершения регистрации с только что Скачанный учетные данные <br/> <li> Если новый процесс установки не удалось затем попытайтесь повторно установить с помощью новых учетных данных</ul> **Примечание**. Если ранее загрузки нескольких файлов хранилища учетных данных, только последний загруженный файл действительна в течение 48 часов. Поэтому рекомендуется загрузить новую новый файл учетных данных хранилища.
| **Сервер прокси-сервер или брандмауэр блокирует <br/>или <br/>подключение к Интернету нет** <br/><br/> Если компьютер или прокси-сервер ограниченный доступ к Интернету то без необходимости URL-адреса прямого указания Регистрация завершится ошибкой.| Чтобы устранить эту проблему, выполните ниже:<br/> <ul><li> Связаться со службой поддержки ИТ, чтобы убедиться, что система подключена к Интернету<li> Если у вас прокси-сервер, убедитесь, параметр прокси-сервер не выбран, при регистрации агента, проверьте действия параметры прокси-сервера [здесь](#verifying-proxy-settings-for-windows)<li> При наличии брандмауэра или прокси-сервер то работы со службой поддержки сети, чтобы убедиться, что ниже URL-адреса и IP-адрес будет иметь доступ<br/> <br> **URL-адреса**<br> - *www.msftncsi.com* <br>-  *. Microsoft.com* <br> -  *.WindowsAzure.com* <br>-  *.microsoftonline.com* <br>-  *.windows.net* <br>**IP-адрес**<br> - *20.190.128.0/18* <br> - *40.126.0.0/18* <br/></ul></ul>Выполните повторную регистрацию после завершения выше действия по устранению неполадок
| **Антивирусная программа блокирует** | Если у вас есть на сервере установлено антивирусное программное обеспечение, добавьте необходимые исключения правил для следующих файлов из антивирусной проверки: <br/><ui> <li> *CBengine.exe* <li> *CSC.exe*<li> Временная папка по умолчанию располагается *C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch* <li> Папка Bin в *C:\Program Files\Microsoft Azure Recovery Services Agent\Bin*

### <a name="additional-recommendations"></a>Дополнительные рекомендации
- Перейдите к *C:/Windows/Temp* и там скопилось более 60 000 или 65 000 файлов с расширением TMP. Если есть, удалите эти файлы
- Убедитесь, дату и время компьютера совпадает с местным часовым поясом
- Убедитесь, [следующие](backup-configure-vault.md#verify-internet-access) узлы добавляются в IE в список надежных сайтов

### <a name="verifying-proxy-settings-for-windows"></a>Проверка параметров прокси-сервера для Windows

- Скачайте **psexec** из [здесь](https://docs.microsoft.com/sysinternals/downloads/psexec)
- Выполните это `psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"` из строки с повышенными правами:
- Это приведет к запуску *Internet Explorer* окно
- Перейдите к *средства* -> *обозревателя* -> *подключений* -> *параметры локальной сети*
- Проверьте параметры прокси-сервера для *системы* учетной записи
- Если прокси-сервера не настроена, и предоставляются сведения о прокси-сервера, то удалите сведения
-   Если прокси-сервер настроен и неправильные сведения о прокси-сервер, убедитесь, *IP-адрес прокси-сервера* и *порт* сведения точны.
- Закрыть *Internet Explorer*

## <a name="unable-to-download-vault-credential-file"></a>Не удалось скачать файл учетных данных хранилища

| Сведения об ошибке | Рекомендованные действия |
| ---     | ---    |
|Не удалось скачать файл учетных данных хранилища. (ID: 403) | <ul><li> Попробуйте скачать учетные данные хранилища с помощью различных браузеров или выполните следующие шаги. <ul><li> Запустите Internet Explorer и нажмите клавишу F12. </li><li> Чтобы очистить кэш и файлы cookie в Internet Explorer перейдите на вкладку **Сеть**. </li> <li> Обновите страницу.<br>(ИЛИ)</li></ul> <li> Проверьте, является ли подписка отключенной или ее срок действия истек.<br>(ИЛИ)</li> <li> Проверьте, не блокирует ли какое-либо правило брандмауэра скачивание файла учетных данных хранилища. <br>(ИЛИ)</li> <li> Убедитесь, что лимит хранилища не был превышен (50 компьютеров на одно хранилище)<br>(ИЛИ)</li>  <li> Убедитесь, пользователь запросил разрешение Azure Backup для загрузки учетных данных хранилища и зарегистрировать сервер с хранилищем, см. в разделе [статьи](backup-rbac-rs-vault.md)</li></ul> |

## <a name="the-microsoft-azure-recovery-service-agent-was-unable-to-connect-to-microsoft-azure-backup"></a>Агенту службы восстановления Microsoft Azure не удалось подключиться к службе Microsoft Azure Backup

| Сведения об ошибке | Возможные причины | Рекомендованные действия |
| ---     | ---     | ---    |
| **Ошибка** <br /><ol><li>*Агенту служб восстановления Microsoft Azure не удалось подключиться к службе архивации Microsoft Azure. (ID: 100050) Проверьте параметры сети и наличие подключения к Интернету*.<li>*(407) Требуется аутентификация прокси-сервера* |Прокси-сервер блокирует подключения. |  <ul><li>Последовательно выберите **IE** > **Состояние** > **Свойства обозревателя** > **Безопасность** > **Интернет**. Затем выберите **Custom Level** (Пользовательский уровень) и прокрутите список до тех пор, пока не увидите раздел скачивания файла. Нажмите кнопку **Включить**.<li>Возможно, придется добавить эти сайты в список [надежных сайтов](https://docs.microsoft.com/azure/backup/backup-try-azure-backup-in-10-mins) в Internet Explorer.<li>Измените параметры для использования прокси-сервера. Затем введите сведения о прокси-сервере.<li> Если компьютер имеет ограниченный доступ к Интернету, убедитесь, что параметры брандмауэра на компьютере или прокси разрешают эти [URL-адреса](backup-configure-vault.md#verify-internet-access) и [IP-адрес](backup-configure-vault.md#verify-internet-access). <li>Если на сервере установлено антивирусное программное обеспечение, исключите из антивирусной проверки следующие файлы. <ul><li>CBEngine.exe (вместо dpmra.exe).<li>CSC.exe (связан с .NET Framework). Для каждой версии .NET, установленной на сервере, есть файл CSC.exe. Нужно исключить файлы CSC.exe, которые привязаны к версиям платформы .NET, установленным на целевом сервере. <li>Временная папка или расположение кэша. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.<li>Папка корзины C:\Program Files\Microsoft Azure Recovery Services Agent\Bin.



## <a name="failed-to-set-the-encryption-key-for-secure-backups"></a>Не удалось настроить ключ шифрования для защиты резервных копий.

| Сведения об ошибке | Возможные причины | Рекомендованные действия |
| ---     | ---     | ---    |
| **Ошибка** <br />*Не удалось настроить ключ шифрования для защиты резервных копий. Активация выполнена не полностью, но парольная фраза для шифрования сохранена в указанный далее файл*. |<li>Сервер уже зарегистрирован в другом хранилище.<li>При настройке повреждена парольная фраза.| Отмените регистрацию сервера в хранилище и повторно зарегистрируйте его с использованием новой парольной фразы.

## <a name="the-activation-did-not-complete-successfully"></a>Активация не была успешно завершена

| Сведения об ошибке | Возможные причины | Рекомендованные действия |
|---------|---------|---------|
|**Ошибка** <br />*Активация не выполнена. Сбой текущей операции из-за внутренней ошибки в службе [0x1FC07]. Повторите операцию позднее. Если проблема будет повторяться, обратитесь в службу поддержки Майкрософт*.     | <li> Недостаточно свободного места на томе, где расположена временная папка. <li> Временная папка неправильно перемещена в другое место. <li> Отсутствует файл OnlineBackup.KEK.         | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent).<li>Переместите временную папку или расположение кэша в том, имеющий достаточно свободного пространства (не менее 5–10 % от общего размера данных резервных копий). Чтобы правильно переместить расположение кэша, см. раздел [Архивация](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#backup).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.        |

## <a name="encryption-passphrase-not-correctly-configured"></a>Парольная фраза для шифрования неправильно настроена

| Сведения об ошибке | Возможные причины | Рекомендованные действия |
|---------|---------|---------|
|**Ошибка** <br />*Ошибка 34506. Парольная фраза для шифрования, сохраненная для этого компьютера, настроена неправильно*.    | <li> Недостаточно свободного места на томе, где расположена временная папка. <li> Временная папка неправильно перемещена в другое место. <li> Отсутствует файл OnlineBackup.KEK.        | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent).<li>Переместите временную папку или расположение кэша в том, имеющий достаточно свободного пространства (не менее 5–10 % от общего размера данных резервных копий). Чтобы правильно переместить расположение кэша, см. раздел [Архивация](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#backup).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию временная папка или расположение кэша находятся по адресу C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch*.         |


## <a name="backups-dont-run-according-to-the-schedule"></a>Резервное копирование не запускается по расписанию
Если запланированное резервное копирование не запускается автоматически, а вручную оно выполняется без проблем, выполните следующие действия:

- Убедитесь, что расписание резервного копирования Windows Server не конфликтует с файлами и папками расписание архивации Azure.

- Убедитесь, присвоено состояние Online Backup **включить**. Чтобы проверить состояние выполнения ниже:

  - Откройте **планировщик** и разверните **Microsoft**и выберите **оперативной архивации**.
  - Дважды щелкните **Microsoft-OnlineBackup** и перейдите на вкладку **Триггеры**.
  - Убедитесь, если состояние **включено**. Если это не так, то выберите **изменить** > **включено** флажок и нажмите кнопку **ОК**.

- Убедитесь, учетной записи пользователя, выбранное для выполнения задачи — **системы** или **группы локальных администраторов** на сервере. Чтобы проверить учетную запись пользователя, перейдите к **Общие** вкладку и проверьте **безопасности** параметры.

- Убедитесь, что на сервере установлен PowerShell 3.0 или более поздней версии. Чтобы проверить версию PowerShell, выполните следующую команду и убедитесь, что *основной* номер версии равен или больше 3.

  `$PSVersionTable.PSVersion`

- Убедитесь, этот путь является частью *PSMODULEPATH* переменной среды

  `<MARS agent installation path>\Microsoft Azure Recovery Services Agent\bin\Modules\MSOnlineBackup`

- Если для политики выполнения PowerShell для *LocalMachine* задано значение ограниченного доступа, командлет PowerShell, который запускает задачи резервного копирования, может завершиться с ошибкой. Выполните следующие команды в режиме с повышенными правами, для проверки и задать политику выполнения либо *Unrestricted* или *RemoteSigned*

  `PS C:\WINDOWS\system32> Get-ExecutionPolicy -List`

  `PS C:\WINDOWS\system32> Set-ExecutionPolicy Unrestricted`

- Убедитесь, не отсутствует или поврежден **PowerShell** модуль **MSonlineBackup**. В случае любой файл отсутствует или поврежден, для устранения этой проблемы выполните ниже:

  - С любого компьютера с агента MARS, работает правильно, скопируйте папку MSOnlineBackup из *(C:\Program Files\Microsoft Azure Recovery Services Agent\bin\Modules)* путь.
  - Вставьте его в проблемных машины в тот же путь *(C:\Program Files\Microsoft Azure Recovery Services Agent\bin\Modules)* .
  - Если **MSOnlineBackup** папка уже существует на компьютере, вставить или заменить файлы содержимого внутри него.


> [!TIP]
> Чтобы убедиться, что изменения применяются последовательно, перезагрузите сервер после выполнения приведенных выше шагов.


## <a name="troubleshoot-restore-issues"></a>Устранение неполадок восстановления

Служба Azure Backup может не подключить том восстановления даже через несколько минут. Во время процесса вы также можете получить сообщения об ошибках. Чтобы приступить к восстановлению в обычном порядке, выполните следующие действия:

1.  Отмените текущий процесс подключения, если он уже выполняется в течение нескольких минут.

2.  Убедитесь, что вы используете последнюю версию агента Backup. Чтобы выяснить версию, в области **Действия** консоли MARS выберите **About Microsoft Azure Recovery Services Agent** (Сведения об агенте служб восстановления Microsoft Azure). Убедитесь, что номер **версии** равен или выше, чем у версии, упомянутой [в этой статье](https://go.microsoft.com/fwlink/?linkid=229525). Последнюю версию можно загрузить [здесь](https://go.microsoft.com/fwLink/?LinkID=288905).

3.  Последовательно выберите пункты **Диспетчер устройств** > **Контроллеры запоминающих устройств** и найдите **Инициатор iSCSI (Майкрософт)** . Если он имеется в списке устройств, переходите к шагу 7.

4.  Если не удается найти службу инициатора Майкрософт iSCSI, попробуйте обратиться к разделу **Диспетчер устройств** > **Контроллеры запоминающих устройств** и обратите внимание, имеется ли в этом разделе устройство с именем **Неизвестное устройство** и идентификатором оборудования **ROOT\ISCSIPRT**.

5.  Щелкните правой кнопкой мыши **Неизвестное устройство** и выберите команду **Обновить драйверы**.

6.  Обновите драйвер, выбрав параметр **Автоматический поиск обновленных драйверов**. После обновления драйверов пункт **Неизвестное устройство** должен измениться на **Инициатор iSCSI (Майкрософт)** , как показано ниже.

    ![Снимок экрана. Диспетчер устройств Azure Backup с выделенными контроллерами хранилища](./media/backup-azure-restore-windows-server/UnknowniSCSIDevice.png)

7.  Последовательно выберите пункты **Диспетчер задач** > **Службы (локальные)**  > **Служба инициатора Майкрософт iSCSI**.

    ![Снимок экрана. Диспетчер задач Azure Backup с выделенными локальными службами](./media/backup-azure-restore-windows-server/MicrosoftInitiatorServiceRunning.png)

8.  Перезапустите службу инициатора iSCSI (Майкрософт). Чтобы сделать это, щелкните правой кнопкой мыши службу, выберите **Остановить**, снова щелкните правой кнопкой мыши и выберите **Запустить**.

9.  Повторите восстановление с помощью [**мгновенного восстановления**](backup-instant-restore-capability.md).

Если восстановление по-прежнему не удается запустить, перезагрузите сервер или клиент. Если вы не хотите выполнять перезагрузку или восстановление по-прежнему не запускается даже после перезагрузки сервера, попробуйте выполнить восстановление на другом компьютере. Выполните шаги, приведенные в [этой статье](backup-azure-restore-windows-server.md#use-instant-restore-to-restore-data-to-an-alternate-machine).

## <a name="need-help-contact-support"></a>Требуется помощь? Обратитесь в службу поддержки.
Если вам все еще нужна помощь, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), которая поможет быстро устранить проблему.

## <a name="next-steps"></a>Дальнейшие действия
* Чтобы получить дополнительные сведения, см. статью [Архивация Windows Server в Azure](tutorial-backup-windows-server-to-azure.md).
* Если необходимо восстановить резервную копию, см. статью о [восстановлении файлов на компьютере Windows](backup-azure-restore-windows-server.md).
