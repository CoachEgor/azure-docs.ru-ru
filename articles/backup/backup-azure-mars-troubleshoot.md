---
title: Устранение неполадок агента Azure Backup
description: Устранение неполадок установки и регистрации агента Azure Backup
services: backup
author: saurabhsensharma
manager: shivamg
ms.service: backup
ms.topic: conceptual
ms.date: 05/21/2019
ms.author: saurse
ms.openlocfilehash: 1c4c2ed6265bdb3c29986fb0b90c3d85d32aadca
ms.sourcegitcommit: f56b267b11f23ac8f6284bb662b38c7a8336e99b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/28/2019
ms.locfileid: "67434014"
---
# <a name="troubleshoot-the-microsoft-azure-recovery-services-mars-agent"></a>Устранение неполадок с агентом служб восстановления Microsoft Azure (MARS)

В этой статье описывается, как устранить ошибки, может появиться во время настройки, регистрации, резервное копирование, копирование и восстановление.

## <a name="basic-troubleshooting"></a>Базовое устранение неполадок

Рекомендуется проверить следующее, прежде чем начать устранение неполадок в Microsoft агент служб восстановления Azure (MARS):

- [Убедитесь в актуальном состоянии агента MARS](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409).
- [Убедитесь в наличии сетевого подключения между агентом служб восстановления Microsoft AZURE и Azure](https://aka.ms/AB-A4dp50).
- Убедитесь, что режим MARS выполняется (в консоли службы). Если вам нужно перезагрузить и повторите операцию.
- [Убедитесь, доступен 5 – 10% объем свободного места в папке временных файлов](https://aka.ms/AB-AA4dwtt).
- [Проверка, доступен ли другой процесс или антивирусная программа мешает работе службы Azure Backup](https://aka.ms/AB-AA4dwtk).
- Если запланировано сбоя процесса резервного копирования, но работы вручную резервного копирования, см. в разделе [резервные копии не создаются в соответствии с расписанием](https://aka.ms/ScheduledBackupFailManualWorks).
- Убедитесь, что вашей операционной системе установлены самые последние обновления.
- [Убедитесь, неподдерживаемые диски и файлы с неподдерживаемые атрибуты исключены из резервной копии](backup-support-matrix-mars-agent.md#supported-drives-or-volumes-for-backup).
- Убедитесь, что часы на защищенные системные настроен на правильный часовой пояс.
- [Убедитесь, .NET Framework 4.5.2 или более поздней на сервере](https://www.microsoft.com/download/details.aspx?id=30653).
- Если вы пытаетесь зарегистрировать сервер в хранилище:
  - Убедитесь, агент удаляется на сервере и что он удаляется с портала.
  - Используйте ту же парольную фразу, которая изначально использовалась для регистрации сервера.
- Для автономного резервного копирования убедитесь, что Azure PowerShell 3.7.0 установлена на исходном, так и компьютер копирования, перед началом резервного копирования.
- Если агент службы архивации выполняется на виртуальной машине Azure, см. в разделе [в этой статье](https://aka.ms/AB-AA4dwtr).

## <a name="invalid-vault-credentials-provided"></a>Указаны недопустимые учетные данные хранилища

**Сообщение об ошибке** Указаны недопустимые учетные данные хранилища. Файл либо поврежден, либо не содержит последних учетных данных, связанных со службой восстановления. (ID: 34513)

| Причина: | Рекомендованные действия |
| ---     | ---    |
| **Учетные данные хранилища недействительны** <br/> <br/> Файлы хранилища учетных данных может быть поврежден или истек. (Например, они загружены более чем за 48 часов до регистрации.)| Скачайте новые учетные данные из хранилища служб восстановления на портале Azure. (См. шаг 6 в [загрузить агент MARS](https://docs.microsoft.com/azure/backup/backup-configure-vault#download-the-mars-agent) разделе.) Затем выполните следующие действия, соответствующим образом. <ul><li> Если вы уже установлен и зарегистрирован режима MARS, откройте консоль MMC агента Microsoft Azure Backup и выберите **зарегистрировать сервер** в **действия** области для завершения регистрации с новым учетные данные. <br/> <li> Если новый процесс установки не удается, попробуйте переустановить с новыми учетными данными.</ul> **Примечание**. Если несколько файлов хранилища учетных данных были загружены, только последний файл действительна в течение 48 часов. Мы рекомендуем загрузить новый файл учетных данных хранилища.
| **Сервер прокси-сервер или брандмауэр блокирует регистрации** <br/>или <br/>**Без подключения к Интернету** <br/><br/> Если ваш компьютер или прокси-сервер имеет ограниченный подключение к Интернету и не гарантируют доступ необходимые URL-адреса, произойдет сбой регистрации.| Выполните следующие действия:<br/> <ul><li> Работать со службой поддержки ИТ, чтобы убедиться, что система подключена к Интернету.<li> Если у вас нет прокси-сервер, убедитесь, что параметр прокси-сервер не выбран, при регистрации агента. [Проверьте параметры прокси-сервера](#verifying-proxy-settings-for-windows).<li> При наличии брандмауэра или прокси-сервер связаться со службой поддержки сети, чтобы эти URL-адреса и IP-адреса имеют доступ:<br/> <br> **URL-адреса**<br> www.msftncsi.com <br> . Microsoft.com <br> .WindowsAzure.com <br> .microsoftonline.com <br> .windows.net <br>**IP-адреса**<br>  20.190.128.0/18 <br>  40.126.0.0/18 <br/></ul></ul>Повторите попытку регистрации после завершения предыдущего действия по устранению неполадок.
| **Антивирусная программа блокирует регистрации** | Если у вас есть антивирусного программного обеспечения, установленного на сервере, добавьте необходимые исключения правил антивирусное сканирование для этих файлов и папок: <br/><ui> <li> CBengine.exe. <li> CSC.exe<li> Временная папка. Его по умолчанию agent\scratch C:\Program Files\Microsoft Azure Recovery Services. <li> В папку bin в C:\Program Files\Microsoft Azure Recovery Services Agent\Bin.

### <a name="additional-recommendations"></a>Дополнительные рекомендации
- Перейдите к папке C:/Windows/Temp, и если там скопилось более 60 000 или 65 000 файлов (с расширением TMP), удалите эти файлы.
- Обеспечить компьютера даты и времени совпадают местного часового пояса.
- Убедитесь, [эти сайты](backup-configure-vault.md#verify-internet-access) добавляются в список надежных сайтов в Internet Explorer.

### <a name="verifying-proxy-settings-for-windows"></a>Проверка параметров прокси-сервера для Windows

1. Скачайте программы PsExec от [Sysinternals](https://docs.microsoft.com/sysinternals/downloads/psexec) страницы.
1. Запустите `psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"` из командной строки с повышенными правами.

   Эта команда откроет Internet Explorer.
1. Перейдите к **средства** > **обозревателя** > **подключений** > **параметры локальной сети**.
1. Проверьте параметры прокси-сервера для системной учетной записи.
1. Если прокси-сервера не настроена, и предоставляются сведения о прокси-сервера, удалите сведения.
1. Если прокси-сервер настроен и неправильные сведения прокси-сервер, убедитесь, **IP-адрес прокси-сервера** и **порт** сведения верны.
1. Закройте Internet Explorer.

## <a name="unable-to-download-vault-credential-file"></a>Не удалось скачать файл учетных данных хранилища

| Ошибка   | Рекомендованные действия |
| ---     | ---    |
|Не удалось скачать файл учетных данных хранилища. (ID: 403) | <ul><li> Попробуйте скачать учетные данные хранилища с помощью другой браузер или выполните следующие действия: <ul><li> Start Internet Explorer. Выберите F12. </li><li> Перейдите к **сети** вкладку и очистка кэша и файлов cookie. </li> <li> Обновите страницу.<br></li></ul> <li> Проверьте, если подписка отключена или истек срок действия.<br></li> <li> Проверьте, блокирует ли любое правило брандмауэра загрузки. <br></li> <li> Убедитесь, что еще не будет исчерпан лимит на хранилище (50 компьютеров в каждом хранилище).<br></li>  <li> Убедитесь, что у пользователя есть разрешения Azure Backup, которые необходимо загрузить учетные данные хранилища и зарегистрировать сервер в хранилище. См. в разделе [раздел контроля доступа для управления точками восстановления службы архивации Azure](backup-rbac-rs-vault.md).</li></ul> |

## <a name="the-microsoft-azure-recovery-service-agent-was-unable-to-connect-to-microsoft-azure-backup"></a>Агенту службы восстановления Microsoft Azure не удалось подключиться к службе Microsoft Azure Backup

| Ошибка  | Возможная причина | Рекомендованные действия |
| ---     | ---     | ---    |
| <br /><ul><li>Агенту служб восстановления Microsoft Azure не удалось подключиться к Microsoft Azure Backup. (ID: 100050) Проверьте параметры сети и убедитесь, что имеется возможность подключиться к Интернету.<li>Требуется проверка подлинности прокси (407). |Прокси-сервер блокирует подключения. |  <ul><li>В Internet Explorer, перейдите в раздел **средства** > **обозревателя** > **безопасности** > **Internet**. Выберите **другой** и прокрутите вниз до **загрузки файла** раздел. Нажмите кнопку **Включить**.<p>Также может потребоваться добавить [URL-адреса и IP-адреса](backup-configure-vault.md#verify-internet-access) в список надежных сайтов в Internet Explorer.<li>Измените параметры для использования прокси-сервера. Затем введите сведения о прокси-сервере.<li> Если компьютер имеет ограниченный доступ к Интернету, убедитесь, что параметры брандмауэра на компьютере или прокси разрешают эти [URL-адреса и IP-адреса](backup-configure-vault.md#verify-internet-access). <li>Если на сервере установлено антивирусное программное обеспечение, исключите эти файлы из антивирусной проверки: <ul><li>CBEngine.exe (вместо dpmra.exe).<li>CSC.exe (связан с .NET Framework). Есть файл CSC.exe для каждой версии .NET Framework, установленных на сервере. Исключите файлы CSC.exe для всех версий платформы .NET Framework на затронутом сервере. <li>Временная папка или расположение кэша. <br>По умолчанию временная папка или путь к кэшу agent\scratch C:\Program Files\Microsoft Azure Recovery Services.<li>В папку bin в C:\Program Files\Microsoft Azure Recovery Services Agent\Bin.


## <a name="failed-to-set-the-encryption-key-for-secure-backups"></a>Не удалось настроить ключ шифрования для защиты резервных копий.

| Ошибка | Возможные причины | Рекомендованные действия |
| ---     | ---     | ---    |
| <br />Не удалось настроить ключ шифрования для безопасной архивации. Активация выполнена не полностью, но парольная фраза для шифрования сохранена в следующий файл. |<li>Сервер уже зарегистрирован в другом хранилище.<li>При настройке повреждена парольная фраза.| Отмена регистрации сервера из хранилища и зарегистрируйте его снова с помощью новой парольной фразы.

## <a name="the-activation-did-not-complete-successfully"></a>Активация не была успешно завершена

| Ошибка  | Возможные причины | Рекомендованные действия |
|---------|---------|---------|
|<br />Активация не выполнена. Сбой текущей операции из-за внутренней ошибки в службе [0x1FC07]. Повторите операцию позднее. Если проблему не удается устранить, обратитесь в службу поддержки Майкрософт.     | <li> Временная папка находится на томе, который не имеет достаточно места. <li> Временная папка неправильно перемещена. <li> Отсутствует файл OnlineBackup.KEK.         | <li>Обновление до [последней версии](https://aka.ms/azurebackup_agent) агента MARS.<li>Переместите вспомогательную папку или расположение кэша на том с объемом свободного пространства, в диапазоне от 5% до 10% от общего размера данных резервных копий. Чтобы правильно переместить расположение кэша, см. шаги в [часто задаваемые вопросы о резервном копировании файлов и папок](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#backup).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию временная папка или путь к кэшу agent\scratch C:\Program Files\Microsoft Azure Recovery Services*.        |

## <a name="encryption-passphrase-not-correctly-configured"></a>Парольная фраза для шифрования неправильно настроена

| Ошибка  | Возможные причины | Рекомендованные действия |
|---------|---------|---------|
| <br />Ошибка 34506. Парольная фраза для шифрования, хранящиеся на этом компьютере настроен неправильно.    | <li> Временная папка находится на томе, который не имеет достаточно места. <li> Временная папка неправильно перемещена. <li> Отсутствует файл OnlineBackup.KEK.        | <li>Обновите агент MARS до [последней версии](https://aka.ms/azurebackup_agent).<li>Переместите вспомогательную папку или расположение кэша на том с объемом свободного пространства, в диапазоне от 5% до 10% от общего размера данных резервных копий. Чтобы правильно переместить расположение кэша, см. шаги в [часто задаваемые вопросы о резервном копировании файлов и папок](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#backup).<li> Убедитесь, что присутствует файл OnlineBackup.KEK. <br>*По умолчанию временная папка или путь к кэшу agent\scratch C:\Program Files\Microsoft Azure Recovery Services*.         |


## <a name="backups-dont-run-according-to-schedule"></a>Резервные копии не создаются в соответствии с расписанием
Если запланированные резервные копии не происходит автоматически, но ручное резервное копирование будет выполняться правильно, попробуйте выполните следующее:

- Убедитесь, что расписание резервного копирования Windows Server, не конфликтуют с файлами и папками расписание архивации Azure.

- Настройте статуса оперативной архивации **включить**. Чтобы проверить состояние, выполните следующие действия:

  1. В планировщике заданий, разверните **Microsoft** и выберите **оперативной архивации**.
  1. Дважды щелкните **Microsoft OnlineBackup** и перейдите к **триггеры** вкладки.
  1. Проверьте, если состояние присваивается **включено**. Если это не так, выберите **изменить**выберите **включено**, а затем выберите **ОК**.

- Убедитесь, учетной записи пользователя, выбранное для выполнения задачи — **системы** или **группы локальных администраторов** на сервере. Чтобы проверить учетную запись пользователя, перейдите к **Общие** вкладку и проверьте **безопасности** параметры.

- Убедитесь, что на сервере установлен PowerShell 3.0 или более поздней версии. Чтобы проверить версию PowerShell, выполните следующую команду и убедитесь, что `Major` номер версии 3 или более поздней версии:

  `$PSVersionTable.PSVersion`

- Убедитесь, этот путь является частью `PSMODULEPATH` переменной среды:

  `<MARS agent installation path>\Microsoft Azure Recovery Services Agent\bin\Modules\MSOnlineBackup`

- Если политика выполнения PowerShell для `LocalMachine` — задать к ограниченным доступом, командлет PowerShell, который запускает задачи резервного копирования может завершиться ошибкой. Выполните следующие команды в режиме с повышенными правами для проверки и задать политику выполнения либо `Unrestricted` или `RemoteSigned`:

  `PS C:\WINDOWS\system32> Get-ExecutionPolicy -List`

  `PS C:\WINDOWS\system32> Set-ExecutionPolicy Unrestricted`

- Убедитесь, что нет отсутствующих или поврежденных файлов модуля MSOnlineBackup PowerShell. Если все отсутствующие или поврежденные файлы, выполните следующие действия:

  1. С любого компьютера, на котором размещен агент MARS, работает правильно скопируйте папку MSOnlineBackup с C:\Program Files\Microsoft Azure Recovery Services Agent\bin\Modules.
  1. На компьютере проблематичным вставьте скопированные файлы в ту же папку (C:\Program Files\Microsoft Azure Recovery Services Agent\bin\Modules).

     Если на компьютере уже существует в папке MSOnlineBackup, вставьте файлы в его или заменить существующие файлы.


> [!TIP]
> Чтобы убедиться, что изменения применяются последовательно, перезагрузите сервер после выполнения предыдущих шагов.


## <a name="troubleshoot-restore-problems"></a>Устранение неполадок при восстановлении

Служба Azure Backup может не подключить том восстановления даже через несколько минут. Поэтому может получить сообщения об ошибках во время процесса. Чтобы приступить к восстановлению в обычном порядке, выполните следующие действия:

1.  Отмените процесс подключения, если его выполнения в течение нескольких минут.

2.  Проверьте наличие последней версии агента службы архивации. Чтобы проверить версию, на **действия** области консоли режима MARS, выберите **о Azure агент служб восстановления Microsoft**. Убедитесь, что номер **версии** равен или выше, чем у версии, упомянутой [в этой статье](https://go.microsoft.com/fwlink/?linkid=229525). Выберите эту ссылку, чтобы [загрузить последнюю версию](https://go.microsoft.com/fwLink/?LinkID=288905).

3.  Перейдите к **устройства** > **контроллеров запоминающих устройств** и найдите **инициатор Microsoft iSCSI**. Если его найти, перейдите к шагу 7.

4.  Если вы не можете найти службу инициатора iSCSI (Майкрософт), попробуйте найти запись в разделе **устройства** > **контроллеров запоминающих устройств** с именем **неизвестное устройство** и Идентификатором оборудования **ROOT\ISCSIPRT**.

5.  Щелкните правой кнопкой мыши **неизвестное устройство** и выберите **обновить драйверы**.

6.  Обновите драйвер, выбрав параметр **Автоматический поиск обновленных драйверов**. Это обновление следует изменить **неизвестное устройство** для **инициатор Microsoft iSCSI**:

    ![Снимок экрана. Диспетчер устройств Azure Backup с выделенными контроллерами хранилища](./media/backup-azure-restore-windows-server/UnknowniSCSIDevice.png)

7.  Перейдите к **диспетчер задач** > **службы (локальные)**  > **службу инициатора Майкрософт iSCSI**:

    ![Снимок экрана. Диспетчер задач Azure Backup с выделенными локальными службами](./media/backup-azure-restore-windows-server/MicrosoftInitiatorServiceRunning.png)

8.  Перезапустите службу инициатора iSCSI (Майкрософт). Чтобы сделать это, щелкните службу правой кнопкой мыши и выберите **остановить**. Затем щелкните правой кнопкой мыши его еще раз и выберите **запустить**.

9.  Повторите восстановление с помощью [мгновенного восстановления](backup-instant-restore-capability.md).

Если восстановление по-прежнему не удается, перезапустите сервер или клиент. Если вы не хотите перезапустить, или если по-прежнему происходит сбой восстановления даже в том случае, после перезагрузки сервера, попробуйте [восстановления с другого компьютера](backup-azure-restore-windows-server.md#use-instant-restore-to-restore-data-to-an-alternate-machine).

## <a name="need-help-contact-support"></a>Требуется помощь? Обращение в службу поддержки
Если вам все еще нужна помощь, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), которая поможет быстро устранить проблему.

## <a name="next-steps"></a>Дальнейшие действия
* Получить дополнительные сведения о [как для резервного копирования Windows Server с помощью агента Azure Backup](tutorial-backup-windows-server-to-azure.md).
* Если необходимо восстановить резервную копию, см. в разделе [восстановление файлов на компьютере Windows](backup-azure-restore-windows-server.md).
