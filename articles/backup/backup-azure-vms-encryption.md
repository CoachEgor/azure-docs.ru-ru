---
title: Резервное копирование и восстановление зашифрованных виртуальных машин Azure
description: В этой статье описывается, как выполнять резервное копирование и восстановление зашифрованных виртуальных машин Azure с помощью службы Azure Backup.
ms.topic: conceptual
ms.date: 04/03/2019
ms.openlocfilehash: 1689ff89f15248f6771ccdce525cc136221e5577
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2020
ms.locfileid: "86538910"
---
# <a name="back-up-and-restore-encrypted-azure-vm"></a>Резервное копирование и восстановление зашифрованной виртуальной машины Azure

В этой статье описывается, как выполнять резервное копирование и восстановление виртуальных машин Azure Windows или Linux с помощью зашифрованных дисков, используя службу [Azure Backup](backup-overview.md) .

Если вы хотите узнать больше о том, как Azure Backup взаимодействует с виртуальными машинами Azure перед началом работы, ознакомьтесь с этими ресурсами:

- [Ознакомьтесь](backup-architecture.md#architecture-built-in-azure-vm-backup) с архитектурой резервного копирования виртуальной машины Azure.
- [Дополнительные сведения](backup-azure-vms-introduction.md) Резервное копирование виртуальных машин Azure и расширение Azure Backup.

## <a name="encryption-support"></a>Поддержка шифрования

Azure Backup поддерживает резервное копирование виртуальных машин Azure с дисками ОС и данных, зашифрованными с помощью шифрования дисков Azure (ADE). ADE использует BitLocker для шифрования виртуальных машин Windows и функцию DM-Encryption для виртуальных машин Linux. ADE интегрируется с Azure Key Vault для управления ключами и секретами шифрования дисков. Ключи шифрования ключа Key Vault (ключи обмена ключами) можно использовать для добавления дополнительного уровня безопасности, шифрования секретов шифрования перед их записью в Key Vault.

Azure Backup можете выполнять резервное копирование и восстановление виртуальных машин Azure с помощью ADE с приложением Azure AD и без него, как показано в следующей таблице.

**Тип диска виртуальной машины** | **ADE (BEK/DM-шифрования)** | **ADE и KEK**
--- | --- | ---
**Неуправляемые** | Да | Да
**Управляемые**  | Да | Да

- Дополнительные сведения о [ADE](../security/fundamentals/azure-disk-encryption-vms-vmss.md), [Key Vault](../key-vault/general/overview.md)и [ключи обмена ключами](../virtual-machine-scale-sets/disk-encryption-key-vault.md#set-up-a-key-encryption-key-kek).
- Ознакомьтесь с [вопросами и](../security/fundamentals/azure-disk-encryption-vms-vmss.md) ответами по шифрованию дисков виртуальной машины Azure.

### <a name="limitations"></a>Ограничения

- Вы можете выполнять резервное копирование и восстановление зашифрованных виртуальных машин в рамках одной и той же подписки и региона.
- Azure Backup поддерживает виртуальные машины, зашифрованные с помощью автономных ключей. Любой ключ, который является частью сертификата, используемого для шифрования виртуальной машины, сейчас не поддерживается.
- Вы можете выполнять резервное копирование и восстановление зашифрованных виртуальных машин в той же подписке и регионе, что и резервное хранилище служб восстановления.
- Зашифрованные виртуальные машины нельзя восстановить на уровне файла или папки. Чтобы восстановить файлы и папки, необходимо восстановить всю виртуальную машину.
- При восстановлении виртуальной машины нельзя использовать параметр [заменить существующую виртуальную машину](backup-azure-arm-restore-vms.md#restore-options) для зашифрованных виртуальных машин. Этот параметр поддерживается только для незашифрованных управляемых дисков.

## <a name="before-you-start"></a>Перед началом работы

Прежде чем начать, сделайте следующее:

1. Убедитесь, что у вас есть одна или несколько виртуальных машин [Windows](../virtual-machines/linux/disk-encryption-overview.md) или [Linux](../virtual-machines/linux/disk-encryption-overview.md) с включенными файлами ADE.
2. [Обзор матрицы поддержки](backup-support-matrix-iaas.md) для резервного копирования виртуальных машин Azure
3. [Создайте](backup-azure-arm-vms-prepare.md#create-a-vault) резервное хранилище служб восстановления, если оно отсутствует.
4. Если включить шифрование для виртуальных машин, для которых уже включено резервное копирование, необходимо просто предоставить резервную копию с разрешениями на доступ к Key Vault, чтобы резервные копии могли продолжать работу без перерывов. Дополнительные [сведения](#provide-permissions) о назначении этих разрешений.

Кроме того, в некоторых случаях может потребоваться несколько действий:

- **Установить агент виртуальной машины**. Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина создана из образа Azure Marketplace, агент установлен и запущен. Если вы создаете пользовательскую виртуальную машину или выполняете миграцию локального компьютера, может потребоваться [установить агент вручную](backup-azure-arm-vms-prepare.md#install-the-vm-agent).

## <a name="configure-a-backup-policy"></a>Настройка политики резервного копирования

1. Если вы еще не создали резервное хранилище служб восстановления, следуйте [этим инструкциям](backup-azure-arm-vms-prepare.md#create-a-vault) .
2. Откройте хранилище на портале и выберите **резервное копирование** в разделе **Начало работы** .

    ![Колонка резервного копирования](./media/backup-azure-vms-encryption/select-backup.png)

3. В качестве **цели резервного копирования**  >  **, где выполняется рабочая нагрузка?** выберите **Azure**.
4. В раскрывающемся списке **Что необходимо архивировать?** выберите **Виртуальная машина** > **ОК**.

      ![Колонка сценариев](./media/backup-azure-vms-encryption/select-backup-goal-one.png)

5. В поле **Политика архивации**  >  **выберите Политика архивации**выберите политику, которую нужно связать с хранилищем. Затем нажмите кнопку **ОК**.
    - Политика архивации определяет время создания резервных копий и время их хранения.
    - Подробные сведения о политике по умолчанию указаны в раскрывающемся меню.

    ![Открытие колонки сценария](./media/backup-azure-vms-encryption/select-backup-goal-two.png)

6. Если вы не хотите использовать политику по умолчанию, выберите **создать**и [Создайте настраиваемую политику](backup-azure-arm-vms-prepare.md#create-a-custom-policy).

7. Выберите зашифрованные виртуальные машины, для которых требуется создать резервную копию, с помощью политики SELECT и нажмите кнопку **ОК**.

      ![Выбор зашифрованных виртуальных машин](./media/backup-azure-vms-encryption/selected-encrypted-vms.png)

8. Если вы используете Azure Key Vault, на странице хранилища появится сообщение о том, что Azure Backup требуется доступ только для чтения к ключам и секретам в Key Vault.

    - Если вы получили это сообщение, никаких действий не требуется.

        ![Доступ — ОК](./media/backup-azure-vms-encryption/access-ok.png)

    - При появлении этого сообщения необходимо задать разрешения, как описано в [следующей процедуре](#provide-permissions).

        ![Предупреждение о доступе](./media/backup-azure-vms-encryption/access-warning.png)

9. Щелкните **включить резервное копирование** , чтобы развернуть политику архивации в хранилище, и включите архивацию для выбранных виртуальных машин.

## <a name="trigger-a-backup-job"></a>активация задания архивации;

Начальное резервное копирование будет выполняться в соответствии с расписанием, но его можно запустить немедленно, как показано ниже.

1. В меню хранилища щелкните **Элементы архивации**.
2. На плитке **Элементы архивации** щелкните **Виртуальная машина Azure**.
3. В списке **Элементы архивации** щелкните многоточие (...)
4. Щелкните **Создать резервную копию**.
5. В окне **Создать резервную копию** используйте элементы управления "Календарь", чтобы выбрать последний день, до которого должна храниться точка восстановления. Нажмите кнопку **ОК**.
6. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.

## <a name="provide-permissions"></a>Предоставление разрешений

Azure Backup требуется доступ только для чтения для резервного копирования ключей и секретов вместе со связанными виртуальными машинами.

- Ваша Key Vault связана с клиентом Azure AD подписки Azure. Если вы являетесь **пользователем-членом**, Azure Backup получит доступ к Key Vault без дальнейших действий.
- Если вы являетесь **гостевым пользователем**, необходимо предоставить разрешения для Azure Backup доступа к хранилищу ключей.

Чтобы задать разрешения, сделайте следующее:

1. В портал Azure выберите **все службы**и выполните поиск **хранилищ ключей**.
2. Выберите хранилище ключей, связанное с зашифрованной виртуальной машиной, для которой выполняется резервное копирование.
3. Выберите **политики доступа**  >  **Добавить новые**.
4. Выберите **выбрать субъект**и введите **Управление архивацией**.
5. Выберите **Служба управления архивацией**  >  **выберите**.

    ![Выбор службы резервного копирования](./media/backup-azure-vms-encryption/select-backup-service.png)

6. В окне **Добавление политики доступа**  >  **Настройка из шаблона (необязательно)** выберите **Azure Backup**.
    - Необходимые разрешения автоматически заполняются в раскрывающихся списках **Разрешения ключей** и **Разрешения секретов**.
    - Если виртуальная машина шифруется **только**с помощью BEK, отмените выбор **разрешений для ключевых** , так как вам нужны только разрешения для секретов.

    ![Выбор службы Azure Backup](./media/backup-azure-vms-encryption/select-backup-template.png)

7. Нажмите кнопку **ОК**. **Служба управления архивацией** добавляется в **политики доступа**.

    ![Политики доступа](./media/backup-azure-vms-encryption/backup-service-access-policy.png)

8. Нажмите кнопку **сохранить** , чтобы указать Azure Backup с разрешениями.

## <a name="restore-an-encrypted-vm"></a>Восстановление зашифрованной виртуальной машины

Зашифрованные виртуальные машины можно восстановить только путем восстановления диска виртуальной машины, как описано ниже. **Замена существующей** и **восстановленной виртуальной машины** не поддерживается.

Восстановите зашифрованные виртуальные машины следующим образом:

1. [Восстановите диск виртуальной машины](backup-azure-arm-restore-vms.md#restore-disks).
2. Повторно создайте экземпляр виртуальной машины, выполнив одно из следующих действий.
    1. Используйте шаблон, созданный во время операции восстановления, чтобы настроить параметры виртуальной машины и активировать развертывание виртуальной машины. [Подробнее](backup-azure-arm-restore-vms.md#use-templates-to-customize-a-restored-vm).
    2. Создайте новую виртуальную машину на основе восстановленных дисков с помощью PowerShell. [Подробнее](backup-azure-vms-automation.md#create-a-vm-from-restored-disks).
3. Для виртуальных машин Linux переустановите расширение ADE, чтобы диски данных были открыты и подключены.

## <a name="next-steps"></a>Дальнейшие действия

При возникновении проблем ознакомьтесь со следующими статьями:

- [Распространенные ошибки](backup-azure-vms-troubleshoot.md) при резервном копировании и восстановлении зашифрованных виртуальных машин Azure.
- Проблемы с [агентом виртуальной машины Azure или расширением резервного копирования](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) .
