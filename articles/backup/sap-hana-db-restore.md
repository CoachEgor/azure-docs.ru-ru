---
title: Восстановление баз данных SAP HANA на виртуальных машинах Azure
description: Из этой статьи вы узнаете, как восстановить SAP HANA базы данных, работающие на виртуальных машинах Azure.
ms.topic: conceptual
ms.date: 11/7/2019
ms.openlocfilehash: a3db88ca3c995c3c190da051dbf9df6ae5e29530
ms.sourcegitcommit: cec9676ec235ff798d2a5cad6ee45f98a421837b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85851409"
---
# <a name="restore-sap-hana-databases-on-azure-vms"></a>Восстановление баз данных SAP HANA на виртуальных машинах Azure

В этой статье описывается, как восстановить SAP HANA базы данных, работающие на виртуальной машине Azure, в которой служба Azure Backup выполнила резервное копирование в хранилище служб восстановления. Восстановление можно использовать для создания копий данных для сценариев разработки и тестирования или для возврата к предыдущему состоянию.

Дополнительные сведения о резервном копировании баз данных SAP HANA см. в статье [резервное копирование SAP HANA баз данных на виртуальных машинах Azure](https://docs.microsoft.com/azure/backup/backup-azure-sap-hana-database).

## <a name="restore-to-a-point-in-time-or-to-a-recovery-point"></a>Восстановление до точки во времени или до точки восстановления

В Azure Backup можно выполнить восстановление баз данных SAP HANA, запущенных на виртуальных машинах Azure, следующим образом.

* Восстановление до состояния на определенную дату или время (с точностью до секунд) с помощью резервных копий журналов. На основе выбранного времени Azure Backup автоматически определяет соответствующие полные или разностные резервные копии и цепочку резервных копий журналов, необходимых для восстановления.

* Восстановление конкретной полной или разностной резервной копии по определенной точке восстановления.

## <a name="prerequisites"></a>Предварительные условия

Перед восстановлением базы данных обратите внимание на следующее:

* Можно восстановить базу данных только на экземпляре SAP HANA, расположенном в том же регионе.

* Целевой экземпляр должен быть зарегистрирован в том же хранилище, что и исходный сервер.

* Azure Backup не может обнаруживать два разных экземпляра SAP HANA на одной виртуальной машине. Поэтому восстановление данных из одного экземпляра в другой на одной виртуальной машине невозможно.

* Чтобы убедиться, что целевой экземпляр SAP HANA готов к восстановлению, проверьте состояние **готовности к резервному копированию** :

  1. Откройте хранилище, в котором зарегистрирован целевой экземпляр SAP HANA

  1. На панели мониторинга хранилища в разделе **Приступая к работе**выберите **резервное копирование** .

      ![Резервное копирование на панели мониторинга хранилища](media/sap-hana-db-restore/getting-started-backup.png)

  1. В поле " **резервное копирование**" в разделе **что вы хотите создать резервную копию?** выберите **SAP HANA на виртуальной машине Azure** .

      ![Выбор пункта "SAP HANA в виртуальной машине Azure"](media/sap-hana-db-restore/sap-hana-backup.png)

  1. В разделе **Обнаружение баз данных в виртуальных машинах**щелкните **Просмотр сведений** .

      ![Подробнее](media/sap-hana-db-restore/view-details.png)

  1. Проверка **готовности резервного копирования** целевой виртуальной машины

      ![Защищенные серверы](media/sap-hana-db-restore/protected-servers.png)

* Дополнительные сведения о типах восстановления, поддерживаемых SAP HANA, см. в SAP HANA Примечание [1642148](https://launchpad.support.sap.com/#/notes/1642148)

## <a name="restore-a-database"></a>Восстановление базы данных

Для восстановления необходимы следующие разрешения.

* Разрешения **оператора Backup** в хранилище, в котором выполняется восстановление.
* Доступ **участника (с правами на запись)** к исходной виртуальной машине, резервное копирование которой выполняется.
* Доступ **участника (записи**) к целевой виртуальной машине:
  * Если выполняется восстановление на ту же виртуальную машину, это исходная виртуальная машина.
  * Если выполняется восстановление в альтернативное расположение, это новая целевая виртуальная машина.

1. Откройте хранилище, в котором зарегистрирована SAP HANA база данных, подлежащей восстановлению.

1. На панели мониторинга хранилища в разделе **защищенные элементы**выберите **элементы архивации** .

    ![Архивные элементы](media/sap-hana-db-restore/backup-items.png)

1. В разделе **элементы архивации**в поле **тип управления архивацией** выберите **SAP HANA на виртуальной машине Azure** .

    ![Тип управления резервным копированием](media/sap-hana-db-restore/backup-management-type.png)

1. Выберите базу данных для восстановления

    ![База данных для восстановления](media/sap-hana-db-restore/database-to-restore.png)

1. Просмотрите меню базы данных. Он предоставляет сведения о резервной копии базы данных, включая:

    * Самые старые и последние точки восстановления

    * Состояние резервного копирования журнала за последние 24 и 72 часов для базы данных

    ![Меню базы данных](media/sap-hana-db-restore/database-menu.png)

1. Выбор **восстановления базы данных**

1. В разделе **Конфигурация восстановления**укажите, где (или как) следует восстанавливать данные:

    * **Альтернативное расположение**. Восстановите базу данных в альтернативное расположение и сохранив исходную базу данных.

    * **Перезаписать базу**данных. Восстановите данные в том же экземпляре SAP Hana, что и исходный источник. В этом варианте перезаписывается исходная база данных.

      ![Восстановить конфигурацию](media/sap-hana-db-restore/restore-configuration.png)

### <a name="restore-to-alternate-location"></a>Восстановление в альтернативном расположении

1. В меню **восстановить конфигурацию** в разделе **место для восстановления**выберите **альтернативное расположение**.

    ![Восстановление в альтернативном расположении](media/sap-hana-db-restore/restore-alternate-location.png)

1. Выберите SAP HANA имя узла и имя экземпляра, для которого требуется восстановить базу данных.
1. Убедитесь, что целевой экземпляр SAP HANA готов к восстановлению, убедившись в **готовности к резервному копированию.** Дополнительные сведения см. в [разделе Предварительные требования](#prerequisites) .
1. В поле **Имя восстановленной базы данных** введите имя целевой базы данных.

    > [!NOTE]
    > Восстановление отдельная база данных контейнера (SDC) должно удовлетворять этим [проверкам](backup-azure-sap-hana-database-troubleshoot.md#single-container-database-sdc-restore).

1. Если применимо, выберите **Перезаписать, если база данных с таким именем уже существует в выбранном экземпляре Hana**.
1. Нажмите кнопку **ОК**.

    ![Конфигурация восстановления — последний экран](media/sap-hana-db-restore/restore-configuration-last.png)

1. В окне **Выбор точки восстановления**выберите **журналы (на момент времени)** для [восстановления до определенной точки во времени](#restore-to-a-specific-point-in-time). Или выберите **полную & разностную резервную копию** для [восстановления до определенной точки восстановления](#restore-to-a-specific-recovery-point).

### <a name="restore-and-overwrite"></a>Восстановление и перезапись

1. В меню **восстановить конфигурацию** в разделе **место для восстановления**выберите **перезаписать базу данных**  >  **ОК**.

    ![Перезапись базы данных](media/sap-hana-db-restore/overwrite-db.png)

1. В окне **Выбор точки восстановления**выберите **журналы (на момент времени)** для [восстановления до определенной точки во времени](#restore-to-a-specific-point-in-time). Или выберите **полную & разностную резервную копию** для [восстановления до определенной точки восстановления](#restore-to-a-specific-recovery-point).

### <a name="restore-as-files"></a>Восстановить как файлы

Чтобы восстановить данные резервной копии в виде файлов вместо базы данных, выберите **восстановить как файлы**. После того как файлы будут скопированы по указанному пути, эти файлы можно будет использовать на любой SAP HANA машине, где их нужно восстановить в качестве базы данных. Так как эти файлы можно переместить на любой компьютер, теперь можно восстановить данные в подписках и регионах.

1. В меню **восстановить конфигурацию** в разделе **где и как выполнить восстановление**выберите **восстановить как файлы**.
1. Выберите имя сервера **узла** или Hana, для которого необходимо восстановить файлы резервной копии.
1. В **целевом пути на сервере**введите путь к папке на сервере, выбранном на шаге 2. Это расположение, в котором служба будет выводить дамп всех необходимых файлов резервных копий.

    Файлы, которые выводятся в дампе:

    * Файлы резервной копии базы данных
    * Файлы каталога
    * Файлы метаданных JSON (для каждого задействованного файла резервной копии)

    Как правило, путь к общей сетевой папке или путь к подключенной общей папке Azure, если он указан в качестве пути назначения, позволяет упростить доступ к этим файлам с других компьютеров в той же сети или с установленной на них общей папкой Azure.

    >[!NOTE]
    >Чтобы восстановить файлы резервной копии базы данных в общей папке Azure, подключенной к целевой зарегистрированной виртуальной машине, убедитесь, что у учетной записи root есть разрешения на чтение и запись в общем файловом ресурсе Azure.

    ![Выбор пути назначения](media/sap-hana-db-restore/restore-as-files.png)

1. Выберите **точку восстановления** , в соответствии с которой будут восстановлены все файлы и папки резервных копий.

    ![Выбор точки восстановления](media/sap-hana-db-restore/select-restore-point.png)

1. Все файлы резервных копий, связанные с выбранной точкой восстановления, записываются в целевой путь.
1. В зависимости от типа выбранной точки восстановления (на**момент времени** или в **полной & разностной резервной копии**) вы увидите одну или несколько папок, созданных в целевом пути. Одна из папок `Data_<date and time of restore>` содержит полные и разностные резервные копии, а другая папка `Log` содержит резервные копии журналов.
1. Переместите эти восстановленные файлы на сервер SAP HANA, где необходимо восстановить их в качестве базы данных.
1. Затем выполните следующие действия.
    1. Задайте разрешения для папки или каталога, в которых хранятся файлы резервных копий, с помощью следующей команды:

        ```bash
        chown -R <SID>adm:sapsys <directory>
        ```

    1. Выполнить следующий набор команд как`<SID>adm`

        ```bash
        su - <sid>adm
        ```

    1. Создайте файл каталога для восстановления. Извлеките **BackupId** из файла метаданных JSON для полной резервной копии, которая будет использоваться позже в операции восстановления. Убедитесь, что полные и резервные копии журналов находятся в разных папках и удалите файлы каталогов и файлы метаданных JSON в этих папках.

        ```bash
        hdbbackupdiag --generate --dataDir <DataFileDir> --logDirs <LogFilesDir> -d <PathToPlaceCatalogFile>
        ```

        В приведенной выше команде:

        * `<DataFileDir>`— папка, содержащая полные резервные копии;
        * `<LogFilesDir>`— папка, содержащая резервные копии журналов;
        * `<PathToPlaceCatalogFile>`— папка, в которой должен быть размещен созданный файл каталога

    1. Восстановите с помощью созданного файла каталога с помощью HANA Studio или выполните запрос восстановления HDBSQL с созданным каталогом. HDBSQL запросы перечислены ниже:

    * Восстановление до точки во времени:

        Если вы создаете новую восстановленную базу данных, выполните команду HDBSQL, чтобы создать новую базу данных, `<DatabaseName>` а затем закройте базу данных для восстановления. Однако если восстанавливается только существующая база данных, выполните команду HDBSQL, чтобы прерывать работу базы данных.

        Затем выполните следующую команду, чтобы восстановить базу данных:

        ```hdbsql
        RECOVER DATABASE FOR <DatabaseName> UNTIL TIMESTAMP '<TimeStamp>' CLEAR LOG USING SOURCE '<DatabaseName@HostName>'  USING CATALOG PATH ('<PathToGeneratedCatalogInStep3>') USING LOG PATH (' <LogFileDir>') USING DATA PATH ('<DataFileDir>') USING BACKUP_ID <BackupIdFromJsonFile> CHECK ACCESS USING FILE
        ```

        * `<DatabaseName>`— Имя новой базы данных или существующей базы данных, которую необходимо восстановить.
        * `<Timestamp>`— Точная метка времени восстановления на момент времени
        * `<DatabaseName@HostName>`— Имя базы данных, резервная копия которой используется для восстановления, и имя **узла** или SAP HANA сервера, на котором находится эта база данных. `USING SOURCE <DatabaseName@HostName>`Параметр указывает, что резервная копия данных (используемая для восстановления) имеет базу данных с другим идентификатором безопасности или именем, отличным от целевого SAP HANA машины. Поэтому для восстановления на том же сервере HANA, с которого выполняется резервное копирование, не требуется указывать.
        * `<PathToGeneratedCatalogInStep3>`— Путь к файлу каталога, созданному на **шаге C**
        * `<DataFileDir>`— папка, содержащая полные резервные копии;
        * `<LogFilesDir>`— папка, содержащая резервные копии журналов;
        * `<BackupIdFromJsonFile>`— **BackupId** , извлеченный на **шаге C** .

    * Восстановление до определенной полной или разностной резервной копии.

        Если вы создаете новую восстановленную базу данных, выполните команду HDBSQL, чтобы создать новую базу данных, `<DatabaseName>` а затем закройте базу данных для восстановления. Однако если восстанавливается только существующая база данных, выполните команду HDBSQL, чтобы прерывать работу базы данных:

        ```hdbsql
        RECOVER DATA FOR <DatabaseName> USING BACKUP_ID <BackupIdFromJsonFile> USING SOURCE '<DatabaseName@HostName>'  USING CATALOG PATH ('<PathToGeneratedCatalogInStep3>') USING DATA PATH ('<DataFileDir>')  CLEAR LOG
        ```

        * `<DatabaseName>`— имя новой базы данных или существующей базы данных, которую необходимо восстановить.
        * `<Timestamp>`— Точная метка времени восстановления на момент времени
        * `<DatabaseName@HostName>`— имя базы данных, резервная копия которой используется для восстановления, и имя **узла** или SAP HANA сервера, на котором находится эта база данных. `USING SOURCE <DatabaseName@HostName>`Параметр указывает, что резервная копия данных (используемая для восстановления) имеет базу данных с другим идентификатором безопасности или именем, отличным от целевого SAP HANA машины. Поэтому его не нужно указывать для восстановления на том же сервере HANA, с которого выполняется резервное копирование.
        * `<PathToGeneratedCatalogInStep3>`— путь к файлу каталога, созданному на **шаге C** .
        * `<DataFileDir>`— папка, содержащая полные резервные копии;
        * `<LogFilesDir>`— папка, содержащая резервные копии журналов;
        * `<BackupIdFromJsonFile>`— **BackupId** , извлеченный на **шаге C** .

### <a name="restore-to-a-specific-point-in-time"></a>Восстановление данных до определенной точки во времени

Если вы выбрали **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) как тип восстановления, выполните следующие действия:

1. Выберите точку восстановления в графе журнала и нажмите кнопку **ОК** , чтобы выбрать точку восстановления.

    ![Точка восстановления](media/sap-hana-db-restore/restore-point.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.

    ![Выбор восстановления](media/sap-hana-db-restore/restore-restore.png)

1. Отслеживать ход восстановления в области **уведомления** или отслеживать его, выбрав пункт **восстановить задания** в меню База данных.

    ![Восстановление успешно запущено](media/sap-hana-db-restore/restore-triggered.png)

### <a name="restore-to-a-specific-recovery-point"></a>Восстановление до определенной точки восстановления

Если вы выбрали **Full & Differential** (Полная и разностная) как тип восстановления, выполните следующие действия:

1. Выберите точку восстановления из списка и нажмите кнопку **ОК** , чтобы выбрать точку восстановления.

    ![Восстановление определенной точки восстановления](media/sap-hana-db-restore/specific-recovery-point.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.

    ![Запустить задание восстановления](media/sap-hana-db-restore/restore-specific.png)

1. Отслеживать ход восстановления в области **уведомления** или отслеживать его, выбрав пункт **восстановить задания** в меню База данных.

    ![Ход восстановления](media/sap-hana-db-restore/restore-progress.png)

    > [!NOTE]
    > В случае восстановления в контейнере нескольких баз данных (MDC) после того, как системная база данных будет восстановлена на целевом экземпляре, необходимо снова запустить сценарий предварительной регистрации. Только после этого будут выполнены восстановления баз данных клиентов. Дополнительные сведения см. в разделе [Устранение неполадок — MDC Restore](backup-azure-sap-hana-database-troubleshoot.md#multiple-container-database-mdc-restore).

## <a name="next-steps"></a>Дальнейшие шаги

* [Узнайте, как](sap-hana-db-manage.md) управлять SAP HANA базами данных, резервное копирование которых осуществляется с помощью Azure Backup
