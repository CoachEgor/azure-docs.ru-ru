---
title: Резервное копирование виртуальных машин Azure в хранилище Служб восстановления
description: В этой статье описывается, как выполнять резервное копирование виртуальных машин Azure в хранилище служб восстановления с помощью Azure Backup
ms.topic: conceptual
ms.date: 04/03/2019
ms.openlocfilehash: aeadd7bc798f690c67eef38c6dc645204ff39115
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79273518"
---
# <a name="back-up-azure-vms-in-a-recovery-services-vault"></a>Резервное копирование виртуальных машин Azure в хранилище Служб восстановления

В этой статье описывается, как выполнять резервное копирование виртуальных машин Azure в хранилище служб восстановления с помощью службы [Azure Backup](backup-overview.md) .

Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
>
> * Подготовка виртуальных машин Azure.
> * создание хранилища;
> * Обнаружение виртуальных машин и Настройка политики архивации.
> * Включите резервное копирование для виртуальных машин Azure.
> * Выполнение начального резервного копирования.

> [!NOTE]
> В этой статье описывается, как настроить хранилище и выбрать виртуальные машины для резервного копирования. Этот способ удобен, если вы хотите создать резервные копии нескольких виртуальных машин. Кроме того, можно [создать резервную копию отдельной виртуальной машины Azure](backup-azure-vms-first-look-arm.md) непосредственно из параметров виртуальной машины.

## <a name="before-you-start"></a>Перед началом работы

* [Ознакомьтесь](backup-architecture.md#architecture-built-in-azure-vm-backup) с архитектурой резервного копирования виртуальных машин Azure.
* [Узнайте о](backup-azure-vms-introduction.md) резервном копировании виртуальных машин Azure и расширении резервного копирования.
* Перед настройкой резервной копии [Ознакомьтесь с матрицей поддержки](backup-support-matrix-iaas.md) .

Кроме того, в некоторых случаях может потребоваться несколько действий:

* **Установите агент виртуальной машины на виртуальную машину**. Azure Backup создает резервную копию виртуальных машин Azure, установив расширение на агент виртуальной машины Azure, выполняющийся на компьютере. Если виртуальная машина была создана из образа Azure Marketplace, агент будет установлен и запущен. Если вы создаете пользовательскую виртуальную машину или выполняете миграцию локального компьютера, может потребоваться [установить агент вручную](#install-the-vm-agent).

## <a name="create-a-vault"></a>Создание хранилища

 В хранилище хранятся резервные копии и точки восстановления, созданные со временем, а также политики резервного копирования, связанные с резервными копиями виртуальных машин. Создайте хранилище следующим образом.

1. Войдите на [портал Azure](https://portal.azure.com/).
2. В окне поиска введите **службы восстановления**. В разделе **службы**выберите **хранилища служб восстановления**.

     ![Поиск хранилищ служб восстановления](./media/backup-azure-arm-vms-prepare/browse-to-rs-vaults-updated.png)

3. В меню **хранилища служб восстановления** щелкните **+ Добавить**.

     ![Создание хранилища служб восстановления — шаг 2](./media/backup-azure-arm-vms-prepare/rs-vault-menu.png)

4. В **хранилище служб восстановления**введите понятное имя, чтобы обозначить хранилище.
    * Имя должно быть уникальным в пределах подписки Azure.
    * Оно может содержать от 2 до 50 символов.
    * Имя должно начинаться с буквы, оно может содержать только буквы, цифры и дефисы.
5. Выберите подписку Azure, группу ресурсов и географический регион, в которых должно быть создано хранилище. Затем нажмите кнопку **Создать**.
    * Для создания хранилища может потребоваться некоторое время.
    * Следите за уведомлениями о состоянии на портале в верхней правой области.

После создания хранилище появится в списке хранилищ служб восстановления. Если вы не видите хранилища, выберите **Обновить**.

![Список хранилищ службы архивации](./media/backup-azure-arm-vms-prepare/rs-list-of-vaults.png)

>[!NOTE]
> Azure Backup теперь позволяет настраивать имя группы ресурсов, созданной службой Azure Backup. Дополнительные сведения см. в разделе [Azure Backup группа ресурсов для виртуальных машин](backup-during-vm-creation.md#azure-backup-resource-group-for-virtual-machines).

### <a name="modify-storage-replication"></a>Изменение репликации хранилища

По умолчанию в хранилищах используется [геоизбыточное хранилище (GRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs).

* Если хранилище является основным механизмом резервного копирования, рекомендуется использовать GRS.
* Для более дешевого варианта можно использовать [локально избыточное хранилище (LRS)](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) .

Измените тип репликации хранилища следующим образом.

1. В новом хранилище щелкните **Свойства** в разделе **Параметры** .
2. В окне **Свойства**в разделе **Конфигурация архивации**щелкните **Обновить**.
3. Выберите тип репликации хранилища и нажмите кнопку **сохранить**.

      ![Настройка конфигурации для нового хранилища](./media/backup-try-azure-backup-in-10-mins/full-blade.png)

> [!NOTE]
   > Вы не можете изменить тип репликации хранилища после того, как хранилище настроено и содержит элементы резервного копирования. Если вы хотите это сделать, необходимо повторно создать хранилище.

## <a name="apply-a-backup-policy"></a>Применение политики архивации

Настройте политику архивации для хранилища.

1. В хранилище щелкните **+ Backup (+ резервная копия** ) в разделе **Обзор** .

   ![Кнопка "Архивация"](./media/backup-azure-arm-vms-prepare/backup-button.png)

2. В качестве >  **цели резервного копирования****, где выполняется рабочая нагрузка?** выберите **Azure**. В **поле что вы хотите создать резервную копию?** выберите **Виртуальная машина** >  **ОК**. При этом расширение виртуальной машины зарегистрируется в хранилище.

   ![Области "Архивация" и "Цель резервного копирования"](./media/backup-azure-arm-vms-prepare/select-backup-goal-1.png)

3. В области **Политика архивации** выберите политику, которую вы хотите связать с хранилищем.
    * Политика по умолчанию создает резервную копию виртуальной машины раз в день. Ежедневные резервные копии хранятся в течение 30 дней. Моментальные снимки мгновенного восстановления хранятся в течение двух дней.
    * Если вы не хотите использовать политику по умолчанию, выберите **создать**и создайте настраиваемую политику, как описано в следующей процедуре.

      ![Политика резервного копирования по умолчанию](./media/backup-azure-arm-vms-prepare/default-policy.png)

4. В окне **Выбор виртуальных машин**выберите виртуальные машины, для которых необходимо создать резервную копию с помощью политики. После этого щелкните **OK**.

   * Выбранные виртуальные машины проверены.
   * Виртуальные машины можно выбрать только в том же регионе, что и хранилище.
   * Архивация виртуальных машин может выполняться только в одном хранилище.

     ![Область "Выбор виртуальных машин"](./media/backup-azure-arm-vms-prepare/select-vms-to-backup.png)

5. В меню **резервное копирование**щелкните **включить резервное копирование**. При этом в хранилище и на виртуальных машинах развертывается политика и устанавливается расширение архивации на агенте ВМ на виртуальной машине Azure.

     ![Кнопка "Включить резервное копирование"](./media/backup-azure-arm-vms-prepare/vm-validated-click-enable.png)

После включения резервного копирования

* Расширение резервного копирования устанавливается службой Azure Backup независимо от того, запущена ли виртуальная машина.
* Начальная Архивация будет выполняться в соответствии с расписанием архивации.
* При выполнении резервного копирования Обратите внимание на следующее.
  * Виртуальная машина, которая работает, имеет наибольшую шансы на запись точки восстановления, соответствующей приложению.
  * Однако, даже если виртуальная машина отключена, она архивируется. Такая виртуальная машина называется автономной виртуальной машиной. В этом случае точка восстановления будет считаться отказоустойчивой.
* Явное исходящее подключение не требуется, чтобы разрешить резервное копирование виртуальных машин Azure.

### <a name="create-a-custom-policy"></a>Создание настраиваемой политики

Если вы выбрали создание новой политики архивации, заполните параметры политики.

1. В списке **имя политики**укажите понятное имя.
2. В **расписанию архивации**укажите время создания резервных копий. Для виртуальных машин Azure можно создавать ежедневное или еженедельное резервное копирование.
3. В окне **мгновенное восстановление**укажите, как долго следует хранить моментальные снимки локально для мгновенного восстановления.
    * При восстановлении резервные копии дисков виртуальных машин копируются из хранилища по сети в место хранения для восстановления. С помощью мгновенного восстановления можно использовать локально сохраненные моментальные снимки, созданные во время задания резервного копирования, не дожидаясь передачи данных резервного копирования в хранилище.
    * Можно хранить моментальные снимки для мгновенного восстановления в интервале от 1 до пяти дней. Значение по умолчанию — два дня.
4. В списке **диапазон хранения**укажите, как долго следует хранить ежедневные или еженедельные точки резервного копирования.
5. При **хранении месячной точки резервного копирования**укажите, следует ли хранить ежемесячные резервные копии ежедневных или еженедельных резервных копий.
6. Чтобы сохранить политику, нажмите кнопку **ОК**.

    ![Новая политика архивации](./media/backup-azure-arm-vms-prepare/new-policy.png)

> [!NOTE]
   > Azure Backup не поддерживает настройку автоматического перехода на летнее время для резервных копий виртуальных машин Azure. При возникновении изменений времени необходимо вручную изменить политики резервного копирования.

## <a name="trigger-the-initial-backup"></a>Активировать начальное резервное копирование

Начальное резервное копирование будет выполняться в соответствии с расписанием, но его можно запустить немедленно, как показано ниже.

1. В меню хранилища щелкните **Элементы архивации**.
2. В списке **элементы архивации**щелкните **Виртуальная машина Azure**.
3. В списке **архивные элементы** нажмите кнопку с многоточием (...).
4. Щелкните **Создать резервную копию**.
5. В поле **создать резервную копию**используйте элемент управления Calendar, чтобы выбрать последний день, в который должна храниться точка восстановления. После этого щелкните **OK**.
6. Отслеживайте уведомления на портале. Ход > **выполнения задания**можно отслеживать на панели мониторинга хранилища > **задания резервного копирования**. В зависимости от размера виртуальной машины создание начального архива может занять некоторое время.

## <a name="verify-backup-job-status"></a>Проверка состояния задания резервного копирования

Сведения о задании резервного копирования для каждой резервной копии виртуальной машины состоят из двух этапов: этап **создания моментального снимка** , за которым следует стадия " **Перенос данных в хранилище** ".<br/>
Этап создания моментального снимка гарантирует доступность точки восстановления, хранящейся вместе с дисками, для **мгновенного восстановления** и доступна не более пяти дней в зависимости от срока хранения моментальных снимков, настроенного пользователем. При переносе данных в хранилище в хранилище создается точка восстановления для долгосрочного хранения. Перенос данных в хранилище начинается только после завершения фазы создания моментального снимка.

  ![Состояние задания резервного копирования](./media/backup-azure-arm-vms-prepare/backup-job-status.png)

В серверной части выполняются две **подзадачи** : одна для задания фонового копирования, которую можно проверить в колонке сведения о **задании резервного копирования** , как указано ниже.

  ![Состояние задания резервного копирования](./media/backup-azure-arm-vms-prepare/backup-job-phase.png)

На этап " **передавать данные в хранилище** " может потребоваться несколько дней для выполнения в зависимости от размера дисков, количества обновлений на диск и ряда других факторов.

Состояние задания может различаться в зависимости от следующих сценариев.

**Моментальный снимок** | **передача данных в хранилище.** | **Состояние задания**
--- | --- | ---
Завершено | Выполняется | Выполняется
Завершено | Пропущено | Завершено
Завершено | Завершено | Завершено
Завершено | Failed | Завершено с предупреждением
Failed | Failed | Failed

Теперь, используя эту возможность, для одной и той же виртуальной машины две резервные копии могут выполняться параллельно, но на одном этапе (моментальный снимок, передавать данные в хранилище) может выполняться только одна подзадача. Итак, в сценариях было задано задание резервного копирования, поэтому в следующий день резервное копирование не удастся выполнить с этой функцией разделения. Резервное копирование следующего дня может привести к завершению создания моментального снимка при **переносе данных в хранилище,** если задание резервного копирования на более ранний день находится в состоянии выполняется.
Добавочная точка восстановления, созданная в хранилище, будет записывать все изменения из последней точки восстановления, созданной в хранилище. На пользователя не влияет никаких затрат.

## <a name="optional-steps"></a>Дополнительные шаги

### <a name="install-the-vm-agent"></a>Установка агента виртуальной машины

Для создания резервных копий виртуальных машин Azure служба Azure Backup устанавливает на них расширение агента виртуальной машины Azure. Если виртуальная машина была создана из образа Azure Marketplace, агент будет установлен и запущен. При создании пользовательской виртуальной машины или переносе локального компьютера может потребоваться установить агент вручную, как показано в таблице.

**Виртуальная машина** | **Сведения**
--- | ---
**Windows** | 1. [скачайте и установите](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) файл MSI агента.<br/><br/> 2. Установите с разрешениями администратора на компьютере.<br/><br/> 3. Проверьте установку. В *C:\WindowsAzure\Packages* на виртуальной машине щелкните правой кнопкой мыши**Свойства** **вааппажент. exe** > . На вкладке **сведения** **версия продукта** должна быть отображаться 2.6.1198.718 или выше.<br/><br/> Если вы обновляете агент, убедитесь, что операции резервного копирования не выполняются, и [переустановите агент](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).
**Linux** | Установите с помощью пакета RPM или DEB из репозитория пакетов дистрибутива. Это предпочтительный способ установки и обновления агента Linux для Azure. Все [поставщики поддерживаемых дистрибутивов](https://docs.microsoft.com/azure/virtual-machines/linux/endorsed-distros) встраивают пакет агента Linux для Azure в свои образы и репозитории. Агент можно найти в [GitHub](https://github.com/Azure/WALinuxAgent), но мы не рекомендуем устанавливать его оттуда.<br/><br/> При обновлении агента убедитесь, что операции резервного копирования не выполняются, и обновите двоичные файлы.

>[!NOTE]
> **Azure Backup теперь поддерживает выборочную архивацию и восстановление диска с помощью решения для резервного копирования виртуальных машин Azure.**
>
>Сейчас Azure Backup поддерживает резервное копирование всех дисков (операционной системы и данных) на ВИРТУАЛЬНОЙ машине вместе с помощью решения для резервного копирования виртуальных машин. С помощью функции исключения-диска вы получаете возможность резервного копирования одного или нескольких дисков данных на виртуальной машине. Это обеспечивает эффективное и экономичное решение для резервного копирования и восстановления. Каждая точка восстановления содержит данные дисков, входящих в операцию резервного копирования, что дополнительно позволяет получить подмножество дисков, восстановленных из заданной точки восстановления во время операции восстановления. Это применимо к восстановлению как из моментального снимка, так и из хранилища.
>
>**Чтобы зарегистрироваться для просмотра, напишите нам по адресуAskAzureBackupTeam@microsoft.com**

## <a name="next-steps"></a>Дальнейшие шаги

* Устранение проблем с [агентами виртуальных машин Azure](backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout.md) или [резервным копированием виртуальных машин Azure](backup-azure-vms-troubleshoot.md).
* [Восстановить](backup-azure-arm-restore-vms.md) Виртуальные машины Azure.
