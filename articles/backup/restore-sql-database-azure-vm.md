---
title: Использование службы архивации Azure для восстановления резервных копий баз данных SQL Server на виртуальной Машине Azure | Документация Майкрософт
description: В этой статье описывается восстановление базы данных SQL Server, выполняющиеся на виртуальной Машине Azure и, архивируются с помощью службы архивации Azure.
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 05/22/2019
ms.author: raynew
ms.openlocfilehash: d8ade598e4f1b6331367e8bd04ad59951ef5de8f
ms.sourcegitcommit: 509e1583c3a3dde34c8090d2149d255cb92fe991
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2019
ms.locfileid: "66242373"
---
# <a name="restore-sql-server-databases-on-azure-vms"></a>Восстановление баз данных SQL Server на виртуальных машинах Azure

В этой статье описывается, как восстановить базу данных SQL Server, на котором выполняется на виртуальной машине Azure (ВМ), [Azure Backup](backup-overview.md) служба вернулась назад в хранилище служб восстановления Azure Backup.

В этой статье описывается восстановление баз данных SQL Server. Дополнительные сведения см. в разделе [резервное копирование баз данных SQL Server на виртуальных машинах Azure](backup-azure-sql-database.md).

## <a name="restore-to-a-time-or-a-recovery-point"></a>Восстановление на момент времени или точку восстановления

Служба архивации Azure можно восстановить базы данных SQL Server, работающие на виртуальных машинах Azure, следующим образом:

- Восстановите определенную дату или время (в секунду) с помощью резервных копий журналов транзакций. Azure Backup автоматически определяет соответствующие полное разностное резервное копирование и цепочку резервных копий журнала, которые необходимы для восстановления на основе выбранного времени.
- Восстановите определенную полную или разностную резервную копию восстановить до определенной точки восстановления.


## <a name="prerequisites"></a>Технические условия

Перед восстановлением базы данных, обратите внимание на следующее:

- Можно восстановить базу данных на экземпляре SQL Server, расположенном в том же регионе Azure.
- Целевой сервер должен быть зарегистрирован в том же хранилище, что и исходный сервер.
- Восстановление базы данных зашифрованы прозрачное шифрование данных на другой сервер SQL, сначала необходимо [восстановите сертификат на сервере назначения](https://docs.microsoft.com/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server?view=sql-server-2017).
- Перед восстановлением базы данных «master», запустить экземпляр SQL Server в однопользовательском режиме с помощью параметра запуска **-m AzureWorkloadBackup**.
    - Значение для **-m** имя клиента.
    - Только имя указанного клиента можно открыть соединение.
- Для всех системных баз данных (модели, master, msdb) остановите службу агента SQL Server, прежде чем активировать восстановление.
- Закройте все приложения, которые может попытаться выполнить подключение к любому из этих баз данных.
- При наличии нескольких экземпляров на сервере, все экземпляры должен работать и в противном случае запуск сервера не будет отображаться в списке конечных серверов для восстановления базы данных.

## <a name="restore-a-database"></a>Восстановление базы данных

Для восстановления, вам потребуются следующие разрешения:

* **Оператор архивации** разрешений в хранилище, где вы выполняете восстановление.
* Доступ **участника (с правами на запись)** к исходной виртуальной машине, резервное копирование которой выполняется.
* Доступ **участника (с правами на запись)** к целевой виртуальной машине:
    - Если вы восстанавливаете на одну виртуальную машину, это исходной виртуальной Машины.
    - Если вы выполняете восстановление в альтернативное расположение, это новый целевой виртуальной Машине.

Восстановление состоит из следующих шагов.
1. Откройте хранилище, в котором зарегистрирована виртуальная машина SQL Server.
2. На панели мониторинга хранилища в разделе **Использование** выберите **Элементы архивации**.
3. В меню **Элементы архивации** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure).

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

4. Выберите базу данных для восстановления.

    ![Выбор базы данных для восстановления](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

5. Просмотрите меню базы данных. Оно предоставляет сведения о резервном копировании базы данных, включая:

    * самые старые и самые новые точки восстановления;
    * Состояние резервного копирования журнала в течение последних 24 часов для баз данных в режим восстановления full и bulk-logged, которые настроены для резервных копий журналов транзакций.

6. Выберите **Restore DB**.

    ![Выбор "Восстановить базу данных"](./media/backup-azure-sql-database/restore-db-button.png)

7. В **восстановления конфигурации**, указать место восстановления данные:
   - **Альтернативное расположение**. Восстановление в альтернативное расположение базы данных и сохранить исходные базы данных-источника.
   - **Перезаписать базу данных**. Восстановление данных в том же экземпляре SQL Server, где находится исходный источник. Этот параметр перезаписывает исходную базу данных.

     > [!Important]
     > Если выбранная база данных принадлежит к группе доступности Always On, SQL Server не позволит перезаписать базу данных. Доступно только значение **Альтернативное расположение**.
     >

     ![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-restore-configuration-menu.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

1. В **восстановления конфигурации** меню в разделе **где провести восстановление**выберите **альтернативное расположение**.
2. Выберите имя сервера SQL Server и экземпляр, в котором нужно восстановить базу данных.
3. В поле **Имя восстановленной базы данных** введите имя целевой базы данных.
4. Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
5. Нажмите кнопку **ОК**.

    ![Указание значений в меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration-menu.png)

2. В **выберите точку восстановления**выберите необходимость [восстановление на определенный момент времени](#restore-to-a-specific-point-in-time) или [восстановить до определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление на определенный момент доступна только для резервных копий журналов для баз данных в режим восстановления full и bulk-logged.

### <a name="restore-and-overwrite"></a>Восстановление и перезапись

1. В **восстановления конфигурации** меню в разделе **где провести восстановление**выберите **перезаписать DB** > **ОК**.

    ![Выбор "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

2. В **выберите точку восстановления**выберите **журналы (на момент времени)** для [восстановление на определенный момент времени](#restore-to-a-specific-point-in-time). Или выберите **полная и разностная** для восстановления [определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление на определенный момент доступна только для резервных копий журналов для баз данных в режим восстановления full и bulk-logged.

### <a name="restore-to-a-specific-point-in-time"></a>Восстановление данных до определенной точки во времени

Если вы выбрали **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) как тип восстановления, выполните следующие действия:

1.  В разделе **даты и времени на восстановление**, открыть календарь. В календаре дат, которые имеют точки восстановления отображаются полужирным шрифтом, и текущая дата выделяется.
1. Выберите дату, которая содержит точки восстановления. Нельзя выбрать даты нет точек восстановления.

    ![Открыть календарь](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

1. После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.
1. Укажите время для восстановления на временной шкале, или выберите время. Нажмите кнопку **ОК**.

    ![Выберите время восстановления](./media/backup-azure-sql-database/recovery-point-logs-graph.png)


1. На **Расширенная конфигурация** меню, если вы хотите сохранить базу данных в нерабочем состоянии после восстановления, включите **Restore with NORECOVERY**.
1. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
1. Нажмите кнопку **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
1. Отслеживать ход выполнения восстановления в **уведомления** области или отслеживать их, выбрав **задания восстановления** меню базы данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-to-a-specific-restore-point"></a>Восстановление данных до определенной точки восстановления

Если вы выбрали **Full & Differential** (Полная и разностная) как тип восстановления, выполните следующие действия:

1. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и нажмите кнопку **ОК**.

    ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

1. На **Расширенная конфигурация** меню, если вы хотите сохранить базу данных в нерабочем состоянии после восстановления, включите **Restore with NORECOVERY**.
1. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
1. Нажмите кнопку **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
1. Отслеживать ход выполнения восстановления в **уведомления** области или отслеживать их, выбрав **задания восстановления** меню базы данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-databases-with-large-number-of-files"></a>Восстановление баз данных с большим числом файлов

Если общая строка размера файлов в базе данных больше, чем [определенного предела](backup-sql-server-azure-troubleshoot.md#files-size-limit-beyond-which-restore-happens-to-default-path), службы архивации Azure хранит список файлов базы данных в компоненте разных pit таким образом, что вы не сможете задать путь к целевой объект восстановления во время восстановления операция. Файлы будут восстановлены на путь по умолчанию SQL.

  ![Восстановление базы данных с большими файлами](./media/backup-azure-sql-database/restore-large-files.jpg)


## <a name="next-steps"></a>Дальнейшие действия

[Управление и наблюдение за](manage-monitor-sql-database-backup.md) баз данных SQL Server, резервное копирование службой Azure Backup.
