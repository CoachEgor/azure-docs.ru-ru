---
title: Восстановление баз данных сервера S'L на VM Azure
description: В этой статье описывается, как восстановить базы данных сервера S'L, которые работают на Azure VM и которые поддерживаются резервным копированием Azure.
ms.topic: conceptual
ms.date: 05/22/2019
ms.openlocfilehash: 642476c98ca223da01bda5c6eb79ee9b53732468
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79252458"
---
# <a name="restore-sql-server-databases-on-azure-vms"></a>Восстановление баз данных SQL Server на виртуальных машинах Azure

В этой статье описывается, как восстановить базу данных сервера S'L, которая работает на виртуальном компьютере Azure (VM), которую служба [резервного копирования Azure](backup-overview.md) резервного копирования резервирует в хранилище служб восстановления резервного копирования Azure.

В этой статье описывается восстановление баз данных SQL Server. Для получения дополнительной информации см. [Резервное копирование баз данных сервера S'L на MMs Azure.](backup-azure-sql-database.md)

## <a name="restore-to-a-time-or-a-recovery-point"></a>Восстановление времени или точки восстановления

Резервное копирование Azure может восстановить базы данных сервера S'L Server, которые работают на ВМ Azure следующим образом:

- Восстановление определенной даты или времени (на второй) с помощью резервных копий журнала транзакций. Резервное копирование Azure автоматически определяет соответствующее полное резервное копирование дифференциала и цепочку резервных копий журнала, которые необходимы для восстановления на основе выбранного времени.
- Восстановление определенного полного или дифференциального резервного копирования для восстановления в определенной точке восстановления.

## <a name="prerequisites"></a>Предварительные требования

Перед восстановлением базы данных обратите внимание на следующее:

- Можно восстановить базу данных на экземпляре SQL Server, расположенном в том же регионе Azure.
- Целевой сервер должен быть зарегистрирован в том же хранилище, что и исходный сервер.
- Для восстановления базы данных, зашифрованной TDE на другой сервер S'L, необходимо сначала [восстановить сертификат на сервер назначения.](https://docs.microsoft.com/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server?view=sql-server-2017)
- Перед восстановлением базы данных "master" запустите экземпляр S'L Server в однопользовательском режиме, используя опцию запуска **-m AzureWorkloadBack.**
  - Значение для **-m** - это имя клиента.
  - Только указанное имя клиента может открыть соединение.
- Для всех системных баз данных (модель, мастер, msdb) остановите службу серверного агента S'L, прежде чем вы запустите восстановление.
- Закройте любые приложения, которые могут попытаться установить подключение к любой из этих баз данных.
- Если на сервере работает несколько экземпляров, все экземпляры должны быть запущены и запущены, в противном случае сервер не будет отображаться в списке серверов назначения для восстановления базы данных.

## <a name="restore-a-database"></a>Восстановление базы данных

Для восстановления необходимо получить следующие разрешения:

- Разрешения **оператора резервного копирования** в хранилище, где вы делаете восстановление.
- Доступ **участника (с правами на запись)** к исходной виртуальной машине, резервное копирование которой выполняется.
- Доступ **участника (с правами на запись)** к целевой виртуальной машине:
  - Если вы восстанавливаете тот же VM, это источник VM.
  - Если вы восстанавливаете в альтернативное место, это новая цель VM.

Восстановление состоит из следующих шагов.

1. Откройте хранилище, в котором зарегистрирована виртуальная машина SQL Server.
2. На панели мониторинга хранилища в разделе **Использование** выберите **Элементы архивации**.
3. В меню **Элементы архивации** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure).

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

4. Выберите базу данных для восстановления.

    ![Выбор базы данных для восстановления](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

5. Просмотрите меню базы данных. Оно предоставляет сведения о резервном копировании базы данных, включая:

    - самые старые и самые новые точки восстановления;
    - Состояние резервного копирования журнала за последние 24 часа для баз данных, которые находятся в режиме полного и объемного восстановления и настроены для резервных копий транзакционного журнала.

6. Выберите **Восстановить**.

    ![Выбор "Восстановить"](./media/backup-azure-sql-database/restore-db.png)

7. В **конфигурации восстановления**укажите, где (или как) восстановить данные:
   - **Альтернативное местоположение**: Восстановление базы данных в альтернативное место и сохранение исходной базы данных.
   - **Перезаписать базу данных**: восстановление данных в том же экземпляре SQL Server, где находится исходный источник. В этом варианте перезаписывается исходная база данных.

    > [!IMPORTANT]
    > Если выбранная база данных принадлежит к группе доступности Always On, SQL Server не позволит перезаписать базу данных. Доступно только значение **Альтернативное расположение**.
    >
   - **Восстановление как файлы**: Вместо восстановления в качестве базы данных, восстановить резервные файлы, которые могут быть восстановлены в качестве базы данных позже на любой машине, где файлы присутствуют с помощью S'L Server Management Studio.
     ![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

1. В меню **Конфигурация восстановления,** под **Где восстановить**, выберите **Альтернативное местоположение.**
2. Выберите имя сервера SQL Server и экземпляр, в котором нужно восстановить базу данных.
3. В поле **Имя восстановленной базы данных** введите имя целевой базы данных.
4. Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
5. Нажмите кнопку **ОК**.

    ![Указание значений в меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration.png)

6. В **select recovery point**выберите, следует ли восстановить к [определенной точке времени](#restore-to-a-specific-point-in-time) или восстановить к [определенной точке восстановления.](#restore-to-a-specific-restore-point)

    > [!NOTE]
    > Восстановление point-in-time доступно только для резервных копий журналов для баз данных, которые находятся в режиме полного и сыпучих записок восстановления.

### <a name="restore-and-overwrite"></a>Восстановление и перезапись

1. В меню **«Восстановить конфигурацию»** под **«Где восстановить»** выберите **Overwrite DB** > **OK.**

    ![Выбор "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

2. В **Select restore point**выберите **журналы (Точка во времени),** чтобы [восстановить к определенному моменту времени.](#restore-to-a-specific-point-in-time) Или выберите **Дифференциал Full &** для восстановления [в определенной точке восстановления.](#restore-to-a-specific-restore-point)

    > [!NOTE]
    > Восстановление point-in-time доступно только для резервных копий журналов для баз данных, которые находятся в режиме полного и сыпучих записок восстановления.

### <a name="restore-as-files"></a>Восстановление как файлы

Для восстановления данных резервного копирования в виде файлов .bak вместо базы данных выберите **Восстановление в качестве файлов.** После того, как файлы сбрасываются в определенный путь, вы можете взять эти файлы в любую машину, где вы хотите восстановить их в качестве базы данных. Благодаря возможности перемещения этих файлов в любую машину, теперь можно восстановить данные по подписке и регионам.

1. В меню **«Восстановить конфигурацию»** под **«Где восстановить»** выберите **«Восстановление» в качестве файлов.**
2. Выберите имя сервера S'L, к которому требуется восстановить файлы резервного копирования.
3. В **пути назначения на входе сервера** путь папки на сервере, выбранный в шаге 2. Это место, где служба будет сбрасывать все необходимые файлы резервного копирования. Как правило, путь совместного доступа сети или путь смонтированного файла Azure при определении пути назначения облегчает доступ к этим файлам другими машинами в той же сети или с той же долей файла Azure, установленной на них.<BR>

    >Для восстановления файлов резервного копирования базы данных на элементе обмена файлами Azure, установленном на целевом зарегистрированном VM, убедитесь, что NT AUTHORITY-SYSTEM имеет доступ к доле файла. Вы можете выполнить шаги, приведенные ниже, чтобы предоставить разрешение на чтение/запись AFS, установленное на VM:
    >
    >- Запуск, `PsExec -s cmd` чтобы войти в оболочку NT AUTHORITY-SYSTEM
    >   - Выполните команду `cmdkey /add:<storageacct>.file.core.windows.net /user:AZURE\<storageacct> /pass:<storagekey>`.
    >   - Проверить доступ с помощью`dir \\<storageacct>.file.core.windows.net\<filesharename>`
    >- Начало восстановления в виде файлов из `\\<storageacct>.file.core.windows.net\<filesharename>` Убежища резервного копирования в качестве пути<BR>
    Вы можете скачать Psexec через<https://docs.microsoft.com/sysinternals/downloads/psexec>

4. Нажмите кнопку **ОК**.

    ![Выберите Восстановление как файлы](./media/backup-azure-sql-database/restore-as-files.png)

5. Выберите **точку восстановления,** соответствующую которой будут восстановлены все доступные файлы .bak.

    ![Выберите точку восстановления](./media/backup-azure-sql-database/restore-point.png)

6. Все файлы резервного копирования, связанные с выбранной точкой восстановления, сбрасываются в путь назначения. Вы можете восстановить файлы в качестве базы данных на любой машине, на которой они присутствуют, на с помощью s'L Server Management Studio.

    ![Восстановленные файлы резервного копирования в пути назначения](./media/backup-azure-sql-database/sql-backup-files.png)

### <a name="restore-to-a-specific-point-in-time"></a>Восстановление данных до определенной точки во времени

Если вы выбрали **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) как тип восстановления, выполните следующие действия:

1. Под **дата восстановления /Время**- откройте календарь. В календаре даты, на которых есть точки восстановления, отображаются жирным шрифтом, а текущая дата выделена.
1. Выберите дату, на которую есть точки восстановления. Нельзя выбирать даты, на которых нет точек восстановления.

    ![Открыть календарь](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

1. После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.
1. Укажите время восстановления на графике временной шкалы или выберите время. Затем выберите **OK**.

    ![Выберите время восстановления](./media/backup-azure-sql-database/recovery-point-logs-graph.png)

1. В меню **Advanced Configuration,** если вы хотите сохранить базу данных неработоспособной после восстановления, включите **Restore с NORECOVERY.**
1. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
1. Нажмите кнопку **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
1. Отслеживайте ход восстановления в области **уведомлений** или отслеживайте его, выбирая **задания «Восстановление»** в меню базы данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-to-a-specific-restore-point"></a>Восстановление данных до определенной точки восстановления

Если вы выбрали **Full & Differential** (Полная и разностная) как тип восстановления, выполните следующие действия:

1. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и нажмите кнопку **ОК**.

    ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

    >[!NOTE]
    > По умолчанию отображаются точки восстановления за последние 30 дней. Вы можете отображать точки восстановления старше 30 дней, нажав **фильтр** и выбрав пользовательский диапазон.

1. В меню **Advanced Configuration,** если вы хотите сохранить базу данных неработоспособной после восстановления, включите **Restore с NORECOVERY.**
1. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
1. Нажмите кнопку **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
1. Отслеживайте ход восстановления в области **уведомлений** или отслеживайте его, выбирая **задания «Восстановление»** в меню базы данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-databases-with-large-number-of-files"></a>Восстановление баз данных с большим количеством файлов

Если общий размер строки файлов в базе данных больше [определенного предела,](backup-sql-server-azure-troubleshoot.md#size-limit-for-files)Резервное копирование Azure хранит список файлов базы данных в другом компоненте ямы, так что вы не сможете установить траекторию восстановления цели во время операции восстановления. Файлы будут восстановлены в пути по умолчанию по умолчанию.

  ![Восстановление базы данных с большим файлом](./media/backup-azure-sql-database/restore-large-files.jpg)

## <a name="next-steps"></a>Дальнейшие действия

[Управление и мониторинг](manage-monitor-sql-database-backup.md) Базы данных сервера S'L, которые поддерживаются резервным копированием Azure.
