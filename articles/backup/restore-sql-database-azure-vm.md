---
title: Использование Azure Backup для восстановления резервных копий баз данных SQL Server на виртуальной машине Azure | Документация Майкрософт
description: В этой статье описывается, как восстановить SQL Server базы данных, работающие на виртуальной машине Azure и резервные копии которых Azure Backup.
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 05/22/2019
ms.author: dacurwin
ms.openlocfilehash: 71867e520d9c98b4af4d4f18f3d08c9e8cc4a8c4
ms.sourcegitcommit: 3877b77e7daae26a5b367a5097b19934eb136350
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68639544"
---
# <a name="restore-sql-server-databases-on-azure-vms"></a>Восстановление баз данных SQL Server на виртуальных машинах Azure

В этой статье описывается, как восстановить базу данных SQL Server, которая работает на виртуальной машине Azure, которая была создана [Azure Backupной](backup-overview.md) службой, в хранилище служб восстановления Azure Backup.

В этой статье описывается восстановление баз данных SQL Server. Дополнительные сведения см. [в статье резервное копирование SQL Server баз данных на виртуальных машинах Azure](backup-azure-sql-database.md).

## <a name="restore-to-a-time-or-a-recovery-point"></a>Восстановление на время или точку восстановления

Azure Backup можете восстановить базы данных SQL Server, работающие на виртуальных машинах Azure, следующим образом:

- Восстановление до определенной даты или времени (во второй) с помощью резервных копий журнала транзакций. Azure Backup автоматически определяет соответствующую полную разностную резервную копию и цепочку резервных копий журналов, которые требуются для восстановления в зависимости от выбранного времени.
- Восстановление определенной полной или разностной резервной копии для восстановления до определенной точки восстановления.


## <a name="prerequisites"></a>предварительные требования

Перед восстановлением базы данных обратите внимание на следующее.

- Можно восстановить базу данных на экземпляре SQL Server, расположенном в том же регионе Azure.
- Целевой сервер должен быть зарегистрирован в том же хранилище, что и исходный сервер.
- Чтобы восстановить базу данных, зашифрованную с помощью TDE, на другой SQL Server, необходимо сначала [восстановить сертификат на целевом сервере](https://docs.microsoft.com/sql/relational-databases/security/encryption/move-a-tde-protected-database-to-another-sql-server?view=sql-server-2017).
- Перед восстановлением базы данных "Master" запустите экземпляр SQL Server в однопользовательском режиме с помощью параметра запуска **-m азуреворклоадбаккуп**.
    - Значение параметра **-m** — это имя клиента.
    - Только указанное имя клиента может открыть соединение.
- Для всех системных баз данных (Model, Master, msdb) перед запуском восстановления завершите работу службы агент SQL Server.
- Закройте все приложения, которые могут попытаться подключиться к любой из этих баз данных.
- Если на сервере работает несколько экземпляров, все они должны работать, в противном случае сервер не будет отображаться в списке целевых серверов для восстановления базы данных.

## <a name="restore-a-database"></a>Восстановление базы данных

Для восстановления необходимы следующие разрешения.

* Разрешения **оператора Backup** в хранилище, в котором выполняется восстановление.
* Доступ **участника (с правами на запись)** к исходной виртуальной машине, резервное копирование которой выполняется.
* Доступ **участника (с правами на запись)** к целевой виртуальной машине:
    - Если выполняется восстановление на ту же виртуальную машину, это исходная виртуальная машина.
    - Если выполняется восстановление в альтернативное расположение, это новая целевая виртуальная машина.

Восстановление состоит из следующих шагов.
1. Откройте хранилище, в котором зарегистрирована виртуальная машина SQL Server.
2. На панели мониторинга хранилища в разделе **Использование** выберите **Элементы архивации**.
3. В меню **Элементы архивации** в разделе **Тип управления резервным копированием** выберите **SQL in Azure VM** (SQL на виртуальной машине Azure).

    ![Выбор "SQL in Azure VM" (SQL на виртуальной машине Azure)](./media/backup-azure-sql-database/sql-restore-backup-items.png)

4. Выберите базу данных для восстановления.

    ![Выбор базы данных для восстановления](./media/backup-azure-sql-database/sql-restore-sql-in-vm.png)

5. Просмотрите меню базы данных. Оно предоставляет сведения о резервном копировании базы данных, включая:

    * самые старые и самые новые точки восстановления;
    * Состояние резервного копирования журнала за последние 24 часа для баз данных, находясь в режиме полного восстановления и с неполным протоколированием и настроенных для резервных копий журналов транзакций.

6. Выберите **RESTORE DB (восстановить базу данных**).

    ![Выбор "Восстановить базу данных"](./media/backup-azure-sql-database/restore-db-button.png)

7. В поле **Конфигурация восстановления**укажите место для восстановления данных.
   - **Альтернативное расположение**. Восстановите базу данных в альтернативное расположение и продолжите работу с исходной базой данных.
   - **Перезаписать базу данных**. Восстановление данных в том же экземпляре SQL Server, где находится исходный источник. Этот параметр перезаписывает исходную базу данных.

     > [!Important]
     > Если выбранная база данных принадлежит к группе доступности Always On, SQL Server не позволит перезаписать базу данных. Доступно только значение **Альтернативное расположение**.
     >

     ![Меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-restore-configuration-menu.png)

### <a name="restore-to-an-alternate-location"></a>Восстановление в альтернативном расположении

1. В меню **восстановить конфигурацию** в разделе **место для восстановления**выберите альтернативное **Расположение**.
2. Выберите имя сервера SQL Server и экземпляр, в котором нужно восстановить базу данных.
3. В поле **Имя восстановленной базы данных** введите имя целевой базы данных.
4. Если это применимо, выберите параметр **Overwrite if the DB with the same name already exists on selected SQL instance** (Перезаписать, если база данных с тем же именем уже существует в выбранном экземпляре SQL).
5. Нажмите кнопку **ОК**.

    ![Указание значений в меню "Конфигурация восстановления"](./media/backup-azure-sql-database/restore-configuration-menu.png)

2. В окне **Выбор точки восстановления**укажите, следует ли выполнить [Восстановление до определенной точки во времени](#restore-to-a-specific-point-in-time) или выполнить [Восстановление до определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление до точки во времени доступно только для резервных копий журналов баз данных, находясь в режиме полного восстановления и с неполным протоколированием.

### <a name="restore-and-overwrite"></a>Восстановление и перезапись

1. В меню **восстановить конфигурацию** в разделе **место для восстановления**выберите Перезаписать **базу данных** > **ОК**.

    ![Выбор "Перезаписать базу данных"](./media/backup-azure-sql-database/restore-configuration-overwrite-db.png)

2. В окне **Выбор точки восстановления**выберите **журналы (на момент времени)** для [восстановления до определенной точки во времени](#restore-to-a-specific-point-in-time). Или выберите **полную & разностную резервную копию** для восстановления до [определенной точки восстановления](#restore-to-a-specific-restore-point).

    > [!NOTE]
    > Восстановление до точки во времени доступно только для резервных копий журналов баз данных, находясь в режиме полного восстановления и с неполным протоколированием.

### <a name="restore-to-a-specific-point-in-time"></a>Восстановление данных до определенной точки во времени

Если вы выбрали **Logs (Point in Time)** (Журналы (восстановление до точки во времени)) как тип восстановления, выполните следующие действия:

1.  В разделе **Дата и время восстановления**Откройте календарь. В календаре даты с точками восстановления отображаются жирным шрифтом, а текущая дата выделяется.
1. Выберите дату, которая содержит точки восстановления. Нельзя выбрать даты, не имеющие точек восстановления.

    ![Открытие календаря](./media/backup-azure-sql-database/recovery-point-logs-calendar.png)

1. После выбора даты временная шкала отображает доступные точки восстановления в непрерывном диапазоне.
1. Укажите время восстановления на графе временной шкалы или выберите время. Нажмите кнопку **ОК**.

    ![Выберите время восстановления](./media/backup-azure-sql-database/recovery-point-logs-graph.png)


1. Если вы хотите, чтобы база данных оставалась неработоспособной после восстановления, в меню **расширенной конфигурации** включите **RESTORE WITH NORECOVERY**.
1. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
1. Нажмите кнопку **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
1. Отслеживать ход восстановления в области **уведомлений** или отслеживать его, выбрав пункт **восстановить задания** в меню База данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-to-a-specific-restore-point"></a>Восстановление данных до определенной точки восстановления

Если вы выбрали **Full & Differential** (Полная и разностная) как тип восстановления, выполните следующие действия:

1. Чтобы завершить процедуру, из списка точек восстановления выберите точку восстановления и нажмите кнопку **ОК**.

    ![Выбор полной точки восстановления](./media/backup-azure-sql-database/choose-fd-recovery-point.png)

1. Если вы хотите, чтобы база данных оставалась неработоспособной после восстановления, в меню **расширенной конфигурации** включите **RESTORE WITH NORECOVERY**.
1. Если необходимо изменить расположение восстановления на целевом сервере, укажите новый конечный путь.
1. Нажмите кнопку **ОК**.

    ![Меню "Расширенная конфигурация"](./media/backup-azure-sql-database/restore-point-advanced-configuration.png)

1. Чтобы запустить задание восстановления, в меню **Восстановление** щелкните **Восстановить**.
1. Отслеживать ход восстановления в области **уведомлений** или отслеживать его, выбрав пункт **восстановить задания** в меню База данных.

    ![Ход выполнения задания восстановления](./media/backup-azure-sql-database/restore-job-notification.png)

### <a name="restore-databases-with-large-number-of-files"></a>Восстановление баз данных с большим количеством файлов

Если общий размер строки файлов в базе данных превышает [определенный предел](backup-sql-server-azure-troubleshoot.md#size-limit-for-files), Azure Backup сохраняет список файлов базы данных в другом компоненте смоле, так что вы не сможете задать целевой путь восстановления во время операции восстановления. Файлы будут восстановлены по пути SQL по умолчанию.

  ![Восстановление базы данных с большим размером файла](./media/backup-azure-sql-database/restore-large-files.jpg)


## <a name="next-steps"></a>Следующие шаги

[Управление и мониторинг](manage-monitor-sql-database-backup.md) SQL Server базы данных, для которых выполняется резервное копирование Azure Backup.
