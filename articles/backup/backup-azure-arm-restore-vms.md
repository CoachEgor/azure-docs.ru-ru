---
title: 'Azure Backup: восстановление виртуальных машин с помощью портала Azure'
description: Восстановление виртуальной машины Azure из точки восстановления с помощью портала Azure
ms.reviewer: geg
author: dcurwin
manager: carmonm
keywords: восстановление резервной копии; восстановление; точка восстановления;
ms.service: backup
ms.topic: conceptual
ms.date: 09/17/2019
ms.author: dacurwin
ms.openlocfilehash: c479249a3a09b625e37fb80e7b73dcc8a1268622
ms.sourcegitcommit: cd70273f0845cd39b435bd5978ca0df4ac4d7b2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2019
ms.locfileid: "71098367"
---
# <a name="how-to-restore-azure-vm-data-in-azure-portal"></a>Как восстановить данные виртуальной машины Azure в портал Azure

В этой статье описывается восстановление данных виртуальной машины Azure из точек восстановления, хранящихся в хранилищах Служб восстановления [Azure Backup](backup-overview.md).



## <a name="restore-options"></a>Параметры восстановления

Azure Backup предоставляет несколько способов восстановления виртуальной машины.

**Вариант восстановления** | **Сведения**
--- | ---
**Создание виртуальной машины** | Быстрое создание и запуск базовой виртуальной машины из точки восстановления.<br/><br/> Можно указать имя виртуальной машины, выбрать группу ресурсов и виртуальную сеть (VNet), в которых она будет размещена, и указать учетную запись хранения для восстановленной виртуальной машины. Новая виртуальная машина должна быть создана в том же регионе, что и исходная виртуальная машина.
**Восстановление диска** | Восстанавливает диск виртуальной машины, который затем можно использовать для создания новой виртуальной машины.<br/><br/> Azure Backup предоставляет шаблон для настройки и создания виртуальной машины. <br/><br> Задание восстановления генерирует шаблон, который можно скачать и использовать, чтобы указать пользовательские параметры и создать виртуальную машину.<br/><br/> Диски копируются в указанную учетную запись хранения.<br/><br/> Кроме того, можно подключить диск к существующей виртуальной машине или создать новую виртуальную машину с помощью PowerShell.<br/><br/> Этот вариант полезен, если требуется настроить виртуальную машину, добавить параметры конфигурации, которых не было во время резервного копирования, или добавить параметры, которые необходимо настроить с помощью шаблона или PowerShell.
**Замена существующей** | Можно восстановить диск и заменить им диск на существующей виртуальной машине.<br/><br/> Текущая виртуальная машина должна существовать. Если он был удален, этот параметр использовать нельзя.<br/><br/> Azure Backup создает моментальный снимок существующей виртуальной машины перед заменой диска и сохраняет его в указанном промежуточном расположении. Существующие диски, подключенные к виртуальной машине, заменяются выбранной точкой восстановления.<br/><br/> Моментальный снимок копируется в хранилище и сохраняется в соответствии с политикой хранения. <br/><br/> Замена существующей виртуальной машины поддерживается для незашифрованных управляемых виртуальных машин. Она не поддерживается для неуправляемых дисков, [общих виртуальных машин](https://docs.microsoft.com/azure/virtual-machines/windows/capture-image-resource) или для виртуальных машин, [созданных с помощью пользовательских образов](https://azure.microsoft.com/resources/videos/create-a-custom-virtual-machine-image-in-azure-resource-manager-with-powershell/).<br/><br/> Если точка восстановления содержит больше или меньше дисков, чем текущая виртуальная машина, то в конфигурации виртуальной машины будет отражено только количество дисков в точке восстановления.<br/><br/>


> [!NOTE]
> Вы также можете восстановить определенные файлы и папки на виртуальной машине Azure. [Узнайте больше](backup-azure-restore-files-from-vm.md).
>
> Если вы используете [последнюю версию](backup-instant-restore-capability.md) Azure Backup для виртуальных машин Azure (называемую мгновенным восстановлением), моментальные снимки хранятся до семи дней. Вы можете восстановить виртуальную машину из моментальных снимков, прежде чем отправлять данные резервного копирования в хранилище. Если вы хотите восстановить виртуальную машину из резервной копии за последние семь дней, быстрее можно восстановить ее из моментального снимка, а не из хранилища.

## <a name="storage-accounts"></a>Учетные записи хранения

Некоторые сведения об учетных записях хранения:

- **Создать виртуальную машину**. При создании новой виртуальной машины виртуальная машина будет помещена в указанную учетную запись хранения.
- **Восстановить диск**: При восстановлении диска диск копируется в указанную учетную запись хранения. Задание восстановления создает шаблон, который можно скачать и использовать для указания пользовательских параметров виртуальной машины. Этот шаблон помещается в указанную учетную запись хранения.
- **Замена диска**: При замене диска на существующей виртуальной машине Azure Backup создает моментальный снимок существующей виртуальной машины перед заменой диска. Моментальный снимок хранится в указанном промежуточном расположении (учетной записи хранения). Эта учетная запись хранения используется для временного хранения моментального снимка в процессе восстановления. для этого мы рекомендуем создать новую учетную запись, которая впоследствии может быть легко удалена.
- **Расположение учетной записи хранения**: Учетная запись хранения должна находиться в том же регионе, что и хранилище. Отображаются только эти учетные записи. Если в этом расположении нет учетных записей хранения, необходимо создать ее.
- **Тип хранилища**. Хранилище BLOB-объектов не поддерживается.
- **Избыточность хранилища**: Хранилище, избыточное между зонами (ZRS), не поддерживается. Сведения о репликации и избыточности учетной записи отображаются в круглых скобках после имени учетной записи. 
- **Хранилище класса Premium**:
    - При восстановлении виртуальных машин, не использующих Premium, учетные записи хранения класса Premium не поддерживаются.
    - При восстановлении управляемых виртуальных машин учетные записи хранения класса Premium, настроенные с помощью сетевых правил, не поддерживаются.


## <a name="before-you-start"></a>Перед началом

Чтобы восстановить ВИРТУАЛЬную машину (создать новую виртуальную машину), убедитесь, что у вас есть правильные [разрешения](backup-rbac-rs-vault.md#mapping-backup-built-in-roles-to-backup-management-actions) управления доступом на основе РОЛЕЙ (RBAC) для операции восстановления виртуальной машины.

Если у вас нет разрешений, можно [восстановить диск](#restore-disks), а затем после восстановления диска [использовать шаблон](#use-templates-to-customize-a-restored-vm) , созданный в ходе операции восстановления, для создания новой виртуальной машины.



## <a name="select-a-restore-point"></a>Выбор точки восстановления

1. В хранилище, связанном с виртуальной машиной, которую вы хотите восстановить, щелкните **Элементы архивации** > **Виртуальная машина Azure**.
2. Щелкните виртуальную машину. По умолчанию на панели мониторинга виртуальной машины отображаются точки восстановления за последние 30 дней. Можно отобразить точки восстановления за более чем 30 дней или выполнить фильтрацию, чтобы найти точки восстановления по датам, временным диапазонам и различным типам согласованности моментальных снимков.
3. Чтобы восстановить виртуальную машину, щелкните **Восстановить виртуальную машину**.

    ![Точка восстановления](./media/backup-azure-arm-restore-vms/restore-point.png)

4. Выберите нужную точку восстановления.

## <a name="choose-a-vm-restore-configuration"></a>Выбор конфигурации восстановления для виртуальной машины

1. В разделе **Конфигурация восстановления** выберите вариант восстановления:
    - **Create new** (Создать). Этот параметр следует использовать, если вы хотите создать новую виртуальную машину. Вы можете создать виртуальную машину с простыми параметрами или восстановить диск и создать настроенную виртуальную машину.
    - **Replace existing** (Заменить существующую). Используйте этот параметр, если требуется заменить диски на существующей виртуальной машине.

        ![Мастер настройки восстановления](./media/backup-azure-arm-restore-vms/restore-configuration.png)

2. Укажите параметры для выбранного варианта восстановления.

## <a name="create-a-vm"></a>Создание виртуальной машины

В качестве одного из [вариантов восстановления](#restore-options) можно быстро создать виртуальную машину с основными параметрами из точки восстановления.

1. В разделе **Конфигурация восстановления** > **Создать** > **Тип восстановления** выберите **Создать виртуальную машину**.
2. В поле **имя виртуальной машины**укажите виртуальную машину, которая не существует в подписке.
3. В разделе **Группа ресурсов** выберите имеющуюся группу ресурсов для новой виртуальной машины или создайте новую с глобальным уникальным именем. При указании уже существующего имени Azure назначает группе имя, совпадающее с именем виртуальной машины.
4. В разделе **Виртуальная сеть** выберите виртуальную сеть, в которой будет размещена виртуальная машина. Здесь указаны все виртуальные сети, связанные с подпиской. Выберите подсеть. По умолчанию будет выбрана первая подсеть.
5. В поле **место хранения**укажите учетную запись хранения для виртуальной машины. [Узнайте больше](#storage-accounts).

    ![Мастер настройки восстановления](./media/backup-azure-arm-restore-vms/recovery-configuration-wizard1.png)

6. В разделе **Конфигурация восстановления** нажмите **OK**. В разделе **Восстановление** щелкните **Восстановить**, чтобы активировать восстановление.


## <a name="restore-disks"></a>Восстановление дисков

В качестве одного из [вариантов восстановления](#restore-options) можно создать диск из точки восстановления. Затем с использованием диска выполните одно из следующих действий:

- Используйте шаблон, который был создан как часть операции восстановления, чтобы настроить параметры и активировать развертывание виртуальной машины. Измените параметры шаблона по умолчанию и отправьте шаблон для развертывания виртуальной машины.
- [Подключите восстановленные диски](https://docs.microsoft.com/azure/virtual-machines/windows/attach-managed-disk-portal) к имеющейся виртуальной машине.
- [Создайте новую виртуальную машину](https://docs.microsoft.com/azure/backup/backup-azure-vms-automation#create-a-vm-from-restored-disks) на основе восстановленных дисков с помощью PowerShell.

1. В разделе **Конфигурация восстановления** > **Создать** > **Тип восстановления** выберите **Восстановить диски**.
2. В разделе **Группа ресурсов** выберите имеющуюся группу ресурсов для восстановленных дисков или создайте новую с глобальным уникальным именем.
3. В разделе **Учетная запись хранения** укажите учетную запись, в которую необходимо скопировать виртуальные жесткие диски. [Узнайте больше](#storage-accounts).

    ![Завершенная настройка восстановления](./media/backup-azure-arm-restore-vms/trigger-restore-operation1.png)

4. В разделе **Конфигурация восстановления** нажмите **OK**. В разделе **Восстановление** щелкните **Восстановить**, чтобы активировать восстановление.

Если виртуальная машина использует управляемые диски и выбран параметр **создать виртуальную машину** , Azure Backup не использует указанную учетную запись хранения. В случае **восстановления дисков** и **мгновенного восстановления**учетная запись хранения используется только для хранения шаблона. Управляемые диски создаются в указанной группе ресурсов.
Если виртуальная машина использует неуправляемые диски, они восстанавливаются как большие двоичные объекты в учетной записи хранения.

### <a name="use-templates-to-customize-a-restored-vm"></a>Использование шаблонов для настройки восстановленной виртуальной машины

После восстановления диска используйте шаблон, созданный в ходе операции восстановления, чтобы настроить и создать новую виртуальную машину.

1. Откройте окно **сведений о нужном задании восстановления**.

2. В окне **сведений о задании восстановления** нажмите кнопку **Развернуть шаблон**, чтобы запустить развертывание шаблона.

    ![Детализация задания восстановления](./media/backup-azure-arm-restore-vms/restore-job-drill-down1.png)

3. Чтобы настроить параметр виртуальной машины, указанный в шаблоне, щелкните **Изменить шаблон**. Чтобы добавить дополнительные настройки, щелкните **Изменить параметры**.
    - [Подробнее](../azure-resource-manager/resource-group-template-deploy-portal.md#deploy-resources-from-custom-template) о развертывании ресурсов из пользовательского шаблона.
    - [Дополнительные сведения](../azure-resource-manager/resource-group-authoring-templates.md) о создании шаблонов.

   ![Загрузка развертывания шаблона](./media/backup-azure-arm-restore-vms/edit-template1.png)

4. Введите пользовательские значения для виртуальной машины, **примите условия** и нажмите кнопку **Купить**.

   ![Отправка развертывания шаблона](./media/backup-azure-arm-restore-vms/submitting-template1.png)


## <a name="replace-existing-disks"></a>Замена существующих дисков

В качестве одного из [вариантов восстановления](#restore-options) можно заменить существующий диск виртуальной машины на выбранную точку восстановления. [Просмотрите](#restore-options) все параметры восстановления.

1. В разделе **Конфигурация восстановления** нажмите **Заменить существующую**.
2. На вкладке **Тип восстановления** щелкните **Replace disk/s** (Замена дисков). Это точка восстановления, которая будет использоваться для замены имеющихся дисков виртуальной машины.
3. В поле **промежуточное расположение**укажите, где должны сохраняться моментальные снимки текущих управляемых дисков в процессе восстановления. [Узнайте больше](#storage-accounts).

   ![Мастер настройки восстановления: замена существующей виртуальной машины](./media/backup-azure-arm-restore-vms/restore-configuration-replace-existing.png)


## <a name="restore-vms-with-special-configurations"></a>Восстановление виртуальных машин со специальными конфигурациями

Существует ряд распространенных ситуаций, в которых может потребоваться восстановление виртуальных машин.

**Сценарий** | **Руководство**
--- | ---
**Восстановление виртуальных машин при участии в программе преимуществ гибридного использования** | Если на виртуальной машине Windows применяется [лицензия преимущества гибридного использования (HUB)](../virtual-machines/windows/hybrid-use-benefit-licensing.md), восстановите диски и создайте новую виртуальную машину на основе предоставленного шаблона (для параметра **Тип лицензии** установите значение **Windows_Server**) или PowerShell.  Этот параметр также может применяться после создания виртуальной машины.
**Восстановление виртуальных машин в случае отказа центра обработки данных Azure** | Если хранилище использует геоизбыточное хранилище, а основной центр обработки данных виртуальной машины выходит из строя, Azure Backup поддерживает восстановление резервных копий виртуальных машин в сопряженном центре обработки данных. Выберите учетную запись хранения в сопряженном центре обработки данных и восстановите ее как обычно. В службе Azure Backup для создания восстановленной виртуальной машины используется служба вычислений, расположенная в сопряженном расположении. [Узнайте больше](../resiliency/resiliency-technical-guidance-recovery-loss-azure-region.md) об отказоустойчивости центра обработки данных.
**Восстановление одной виртуальной машины контроллера домена в одном домене** | Восстановите эту виртуальную машину обычным образом. Обратите внимание на следующее.<br/><br/> С точки зрения Active Directory виртуальная машина Azure аналогична любой другой виртуальной машине.<br/><br/> Кроме того, доступен режим восстановления служб каталогов, следовательно, все сценарии восстановления Active Directory также являются приемлемыми. [Дополнительные сведения](https://docs.microsoft.com/windows-server/identity/ad-ds/get-started/virtual-dc/virtualized-domain-controllers-hyper-v) о резервном копировании и восстановлении виртуальных контроллеров домена.
**Восстановление нескольких виртуальных машин контроллера домена в одном домене** | Если другие контроллеры домена в том же домене могут быть доступны по сети, контроллер домена можно восстановить как любую виртуальную машину. Если это последний контроллер домена в домене или выполняется восстановление в изолированной сети, используйте [восстановление леса](https://docs.microsoft.com/windows-server/identity/ad-ds/manage/ad-forest-recovery-single-domain-in-multidomain-recovery).
**Восстановление нескольких доменов в одном лесу** | Мы рекомендуем [восстановить лес](https://docs.microsoft.com/windows-server/identity/ad-ds/manage/ad-forest-recovery-single-domain-in-multidomain-recovery).
**Восстановление исходного состояния системы** | Основным различием между виртуальными машинами Azure и локальными гипервизорами является отсутствие доступной консоли виртуальной машины в Azure. Консоль требуется в некоторых сценариях, например при восстановлении файла резервной копии с помощью восстановления исходного состояния системы. Хотя есть и полная замена такому типу восстановления. Это — восстановление виртуальной машины из хранилища.
**Восстановление виртуальных машин с использованием специальных конфигураций сети** | К специальным сетевым конфигурациям относятся виртуальные машины, использующие внутреннюю или внешнюю балансировку нагрузки, несколько сетевых интерфейсов или несколько зарезервированных IP-адресов. Эти виртуальные машины восстанавливаются с помощью варианта [восстановления диска](#restore-disks). Этот параметр создает копию виртуальных жестких дисков в указанной учетной записи хранения, после чего вы можете создать виртуальную машину с [внутренней](https://azure.microsoft.com/documentation/articles/load-balancer-internal-getstarted/) или [внешней](https://azure.microsoft.com/documentation/articles/load-balancer-internet-getstarted/) подсистемой балансировки нагрузки, несколькими сетевыми [картами](../virtual-machines/windows/multiple-nics.md)или [несколькими зарезервированными IP-адресами](../virtual-network/virtual-network-multiple-ip-addresses-powershell.md)в соответствии с вашими Настройка.
**Группа безопасности сети (NSG) на сетевом адаптере или подсети** | Резервное копирование виртуальных машин Azure поддерживает резервное копирование и восстановление данных NSG на уровне виртуальной сети, подсети и сетевого адаптера.
**Закрепленные виртуальные машины зоны** | Azure Backup поддерживает резервное копирование и восстановление закрепленных виртуальных машин с зоной. [Подробнее](https://azure.microsoft.com/global-infrastructure/availability-zones/)

## <a name="track-the-restore-operation"></a>Отслеживание восстановления
Когда вы запускаете операцию восстановления, служба Backup создает задание для отслеживания операции. Azure Backup отображает уведомления о задании на портале. Если они не отображаются, выберите символ **уведомления** , а затем щелкните **Просмотреть все задания** , чтобы просмотреть состояние процесса восстановления.

![Запущенное восстановление](./media/backup-azure-arm-restore-vms/restore-notification1.png)

 Отслеживание восстановления производится следующим образом:

1. Чтобы просмотреть операции для задания, щелкните гиперссылку уведомлений. Кроме того, в хранилище щелкните **Задания резервного копирования**, а затем выберите соответствующую виртуальную машину.

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/restore-job-in-progress1.png)

2. Чтобы отслеживать ход восстановления, щелкните любое задание восстановления с состоянием **Выполняется**. Отобразится индикатор выполнения, в котором отображаются сведения о ходе восстановления.

    - **Estimated time of restore** (Предполагаемое время восстановления): изначально показывает время, необходимое для завершения операции восстановления. В ходе выполнения операции время уменьшается и достигает 0, когда операция завершается.
    - **Percentage of restore** (Процент восстановления): показывает, какая часть операции восстановления выполнена.
    - **Number of bytes transferred** (Общее число переданных байтов): при восстановлении путем создания новой виртуальной машины в этом параметре отображается, сколько байтов передано по сравнению с общим количеством байтов для передачи.

## <a name="post-restore-steps"></a>Действия после восстановления

После восстановления виртуальной машины необходимо отметить ряд моментов:

- Расширения, имеющиеся при настройке резервного копирования, установлены, но не включены. Обнаружив проблему, переустановите расширения.
- Если виртуальная машина, для которой выполнено резервное копирование, имеет статический IP-адрес, восстановленная виртуальная машина будет иметь динамический IP-адрес, чтобы избежать конфликтов. Для [восстановленной виртуальной машины можно добавить статический IP-адрес](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm).
- У восстановленной виртуальной машины нет группы доступности. При использовании параметра восстановить диск можно [указать группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) при создании виртуальной машины с диска с помощью указанного шаблона или PowerShell.
- Если вы используете дистрибутив Linux на основе cloud-init (например, Ubuntu), то в целях безопасности пароль будет заблокирован после восстановления. Чтобы [сбросить пароль](../virtual-machines/linux/reset-password.md), на восстановленной виртуальной машине рекомендуется использовать расширение VMAccess. Мы советуем использовать ключи SSH в этих дистрибутивах, чтобы не сбрасывать пароль после восстановления.
- Если вы не можете получить доступ к виртуальной машине после восстановления из-за неработающего отношения виртуальной машины с контроллером домена, выполните следующие действия, чтобы открыть виртуальную машину.
    - Подключите диск ОС в качестве диска данных к восстановленной виртуальной машине.
    - Установите агент ВМ вручную, если агент Azure не отвечает, по следующей [ссылке](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/install-vm-agent-offline).
    - Включите доступ к последовательной консоли на виртуальной машине, чтобы разрешить доступ из командной строки к виртуальной машине.
    
  ```
    bcdedit /store <drive letter>:\boot\bcd /enum
    bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /set {bootmgr} displaybootmenu yes
    bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /set {bootmgr} timeout 5
    bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /set {bootmgr} bootems yes
    bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /ems {<<BOOT LOADER IDENTIFIER>>} ON
    bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /emssettings EMSPORT:1 EMSBAUDRATE:115200
    ```
    - При перестроении виртуальной машины используйте портал Azure для сброса учетной записи локального администратора и пароля
    - Использование Серийная консоль Access и CMD для отсоединений виртуальной машины из домена

    ```
    cmd /c "netdom remove <<MachineName>> /domain:<<DomainName>> /userD:<<DomainAdminhere>> /passwordD:<<PasswordHere>> /reboot:10 /Force" 
    ```

- После того как виртуальная машина будет отключена и перезапущена, вы сможете успешно выполнить RDP-подключение к виртуальной машине с учетными данными локального администратора и повторно присоединить виртуальную машину к домену.

## <a name="backing-up-restored-vms"></a>Резервное копирование восстановленных виртуальных машин

- Если виртуальная машина восстановлена в той же группе ресурсов и с тем же именем, что и первоначально заархивированная виртуальная машина, то резервное копирование будет продолжено и после восстановления виртуальной машины.
- Если восстановить виртуальную машину в другой группе ресурсов или задать для нее другое имя, необходимо настроить резервную копию для восстановленной виртуальной машины.

## <a name="next-steps"></a>Следующие шаги

- Если у вас возникли трудности во время процесса восстановления, [просмотрите](backup-azure-vms-troubleshoot.md#restore) распространенные проблемы и ошибки.
- После восстановления виртуальной машины ознакомьтесь со сведениями об [управлении виртуальными машинами](backup-azure-manage-vms.md).
