---
title: Устранение неполадок службы Azure Backup. Состояние гостевого агента недоступно
description: Симптомы, причины и способы устранения проблем в работе службы Azure Backup, связанных с агентом, расширением и дисками.
author: saurabhsensharma
manager: saurabhsensharma
keywords: Azure backup; VM agent; Network connectivity;
ms.service: backup
ms.topic: troubleshooting
ms.date: 07/05/2019
ms.author: saurse
ms.openlocfilehash: e4337c9c89ca239bb664cbb7fb953ab9eedd3ac5
ms.sourcegitcommit: c72ddb56b5657b2adeb3c4608c3d4c56e3421f2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2019
ms.locfileid: "68465317"
---
# <a name="troubleshoot-azure-backup-failure-issues-with-the-agent-or-extension"></a>Устранение неполадок службы Azure Backup. Проблемы с агентом или расширением

В этой статье описано, как устранять ошибки службы Azure Backup, связанные с установлением связи с агентом виртуальной машины и расширением.

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]



## <a name="UserErrorGuestAgentStatusUnavailable-vm-agent-unable-to-communicate-with-azure-backup"></a>UserErrorGuestAgentStatusUnavailable — агенту виртуальной машины не удается установить связь со службой Azure Backup

**Код ошибки** UserErrorGuestAgentStatusUnavailable <br>
**Сообщение об ошибке** Агенту виртуальной машины не удается установить связь со службой Azure Backup<br>

После регистрации виртуальной машины в службе Backup и добавления ее в расписание служба Backup инициирует задание, взаимодействуя с агентом виртуальной машины, чтобы создать моментальный снимок. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:<br>
**Причина 1. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**     
**Причина 2. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**  
**Причина 3. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**     
**Причина 4. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)**  
**Причина 5. [Виртуальная машина не подключена к Интернету](#the-vm-has-no-internet-access)**

## <a name="guestagentsnapshottaskstatuserror---could-not-communicate-with-the-vm-agent-for-snapshot-status"></a>GuestAgentSnapshotTaskStatusError — не удалось запросить состояние моментального снимка в агенте виртуальной машины

**Код ошибки** GuestAgentSnapshotTaskStatusError<br>
**Сообщение об ошибке** Не удалось запросить состояние моментального снимка в агенте виртуальной машины <br>

После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:  
**Причина 1. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**  
**Причина 2. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**  
**Причина 3. [Виртуальная машина не подключена к Интернету](#the-vm-has-no-internet-access)**

## <a name="usererrorrpcollectionlimitreached---the-restore-point-collection-max-limit-has-reached"></a>UserErrorRpCollectionLimitReached — достигнуто максимальное количество точек восстановления в коллекции

**Код ошибки** UserErrorRpCollectionLimitReached <br>
**Сообщение об ошибке** Достигнуто максимальное количество точек восстановления в коллекции. <br>
* Эта ошибка может произойти, если в группе ресурсов точек восстановления есть блокировка, предотвращающая автоматическую очистку точки восстановления.
* Эта ошибка также может произойти при активации нескольких операций резервного копирования в день. В настоящее время мы советуем использовать только одну резервную копию в день, так как точки мгновенного восстановления сохраняются в течение 1-5 дней в соответствии с настроенным сроком хранения моментальных снимков, и только 18 мгновенных RP могут быть связаны с виртуальной машиной в любой конкретный момент времени. <br>

Рекомендуемое действие:<br>
Чтобы устранить эту проблему, удалите блокировку группы ресурсов виртуальной машины и повторите операцию активации очистки.
> [!NOTE]
> Служба Backup создает группу ресурсов, отличную от группы ресурсов виртуальной машины, для сохранения коллекции точек восстановления. Пользователям рекомендуется не блокировать группу ресурсов, созданную для использования службой Backup. Формат именования группы ресурсов, созданной службой Backup: AzureBackupRG_`<Geo>`_`<number>`. Например, AzureBackupRG_northeurope_1

**Шаг 1. [Удаление блокировки с группы ресурсов точки восстановления](#remove_lock_from_the_recovery_point_resource_group)** <br>
**Шаг 2. [ Очистка коллекции точек восстановления](#clean_up_restore_point_collection)**<br>

## <a name="usererrorkeyvaultpermissionsnotconfigured---backup-doesnt-have-sufficient-permissions-to-the-key-vault-for-backup-of-encrypted-vms"></a>UserErrorKeyvaultPermissionsNotConfigured — служба Backup не имеет достаточных разрешений на доступ к хранилищу ключей для резервного копирования зашифрованных виртуальных машин.

**Код ошибки** UserErrorKeyvaultPermissionsNotConfigured <br>
**Сообщение об ошибке** Служба резервного копирования не имеет достаточных разрешений к хранилищу ключей для резервного копирования зашифрованных виртуальных машин. <br>

Для выполнения операции резервного копирования зашифрованных виртуальных машин необходимы разрешения на доступ к хранилищу ключей. Это можно сделать с помощью [портал Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-encryption) или [PowerShell](https://docs.microsoft.com/azure/backup/backup-azure-vms-automation#enable-protection).

## <a name="ExtensionSnapshotFailedNoNetwork-snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine"></a>ExtensionSnapshotFailedNoNetwork — сбой операции моментального снимка, отсутствует сетевое подключение у виртуальной машины

**Код ошибки** ExtensionSnapshotFailedNoNetwork<br>
**Сообщение об ошибке** Сбой операции моментального снимка, отсутствует сетевое подключение у виртуальной машины<br>

После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:    
**Причина 1. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**  
**Причина 2. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)**  
**Причина 3. [Виртуальная машина не подключена к Интернету](#the-vm-has-no-internet-access)**

## <a name="ExtentionOperationFailed-vmsnapshot-extension-operation-failed"></a>ExtentionOperationFailedForManagedDisks — операция расширения VMSnapshot завершилась сбоем.

**Код ошибки** ExtentionOperationFailedForManagedDisks <br>
**Сообщение об ошибке** Не удалось выполнить операцию с расширением моментального снимка виртуальной машины<br>

После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:  
**Причина 1. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**  
**Причина 2. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)**  
**Причина 3. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**  
**Причина 4. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**

## <a name="backupoperationfailed--backupoperationfailedv2---backup-fails-with-an-internal-error"></a>BackUpOperationFailed или BackUpOperationFailedV2 — сбой резервного копирования с внутренней ошибкой

**Код ошибки** BackUpOperationFailed или BackUpOperationFailedV2 <br>
**Сообщение об ошибке** Произошла внутренняя ошибка службы Backup. Повторите операцию через несколько минут <br>

После регистрации виртуальной машины в службе архивации Azure и добавления ее в расписание служба архивации инициирует задание, взаимодействуя с расширением виртуальной машины, чтобы создать моментальный снимок. Любое из указанных ниже условий может помешать активации создания моментального снимка, что может привести к сбою службы Backup. Выполните следующие шаги про устранению неполадок в указанном порядке, а затем повторите операцию:  
**Причина 1. [Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)**  
**Причина 2. [Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)**  
**Причина 3. [Не удалось получить состояние моментального снимка или создать моментальный снимок](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)**  
**Причина 4. [Не удалось обновить или загрузить расширение резервного копирования](#the-backup-extension-fails-to-update-or-load)**  
**Причина 5. У службы Backup нет разрешения на удаление старых точек восстановления из-за блокировки группы ресурсов** <br>
**Причина 6. [Виртуальная машина не подключена к Интернету](#the-vm-has-no-internet-access)**

## <a name="usererrorunsupporteddisksize---currently-azure-backup-does-not-support-disk-sizes-greater-than-4095gb"></a>Усереррорунсуппортеддисксизе — в настоящее время Azure Backup не поддерживает размеры дисков больше 4095 ГБ

**Код ошибки** UserErrorUnsupportedDiskSize <br>
**Сообщение об ошибке** В настоящее время Azure Backup не поддерживает размеры дисков больше 4095 ГБ <br>

Операция резервного копирования может завершиться ошибкой при резервном копировании виртуальной машины с размером диска больше 4095 ГБ. Поддержка больших дисков ожидается в ближайшее время.  

## <a name="usererrorbackupoperationinprogress---unable-to-initiate-backup-as-another-backup-operation-is-currently-in-progress"></a>UserErrorBackupOperationInProgress. Не удалось запустить резервное копирование, так как в настоящий момент выполняется другая операция резервного копирования.

**Код ошибки** UserErrorBackupOperationInProgress <br>
**Сообщение об ошибке** Не удалось запустить резервное копирование, так как в настоящий момент выполняется другая операция резервного копирования<br>

Произошел сбой последнего задания резервного копирования в связи с тем, что в настоящий момент уже выполняется такое задание. Новое задание резервного копирования невозможно начать, пока не завершится текущее. Убедитесь в завершении текущей операции резервного копирования, прежде чем активировать или планировать другие операции резервного копирования. Чтобы проверить состояние заданий резервного копирования, выполните следующие шаги.

1. Войдите на портал Azure и щелкните **Все службы**. Введите "Службы восстановления" и щелкните **Хранилища служб восстановления**. После этого отобразится список хранилищ служб восстановления,
2. В списке хранилищ служб восстановления выберите хранилище, в котором настроено резервное копирование.
3. В меню панели мониторинга хранилища щелкните **Задания резервного копирования**, чтобы отобразить все задания.

    * Если задание резервного копирования выполняется, дождитесь его завершения или отмените его.
        * Чтобы отменить задание резервного копирования, щелкните его правой кнопкой мыши, а затем щелкните **Отмена** или используйте [PowerShell](https://docs.microsoft.com/powershell/module/az.recoveryservices/stop-azrecoveryservicesbackupjob?view=azps-1.4.0).
    * Если вы перенастроили резервное копирование в другом хранилище, убедитесь, что в старом хранилище не выполняются задания резервного копирования. Если задание резервного копирования существует, отмените его.
        * Чтобы отменить задание резервного копирования, щелкните его правой кнопкой мыши, а затем щелкните **Отмена** или используйте [PowerShell](https://docs.microsoft.com/powershell/module/az.recoveryservices/stop-azrecoveryservicesbackupjob?view=azps-1.4.0).
4. Повторите операцию резервного копирования.

Если запланированная операция резервного копирования занимает больше времени, что вызывает конфликт со следующей конфигурацией резервного копирования, просмотрите разделы [Рекомендации](backup-azure-vms-introduction.md#best-practices), [Производительность резервного копирования](backup-azure-vms-introduction.md#backup-performance) и [Рекомендации относительно восстановления](backup-azure-vms-introduction.md#backup-and-restore-considerations).


## <a name="causes-and-solutions"></a>Причины и решения

### <a name="the-vm-has-no-internet-access"></a>Виртуальная машина не подключена к Интернету
Согласно требованиям к развертыванию виртуальная машина не имеет доступа к Интернету. Или могут быть ограничения на доступ к инфраструктуре Azure.

Чтобы расширение службы Backup работало правильно, требуется подключение к общедоступным IP-адресам Azure. Для управления моментальными снимками виртуальной машины это расширение отправляет команды к конечной точке службы хранилища Azure (URL-адрес HTTP). Если расширение не имеет доступа к общедоступному Интернету, резервное копирование завершится сбоем.

####  <a name="solution"></a>Решение
Решение проблемы с сетью см. в разделе [Установка сетевого подключения](backup-azure-arm-vms-prepare.md#establish-network-connectivity).

### <a name="the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a>Агент установлен на виртуальной машине, но не отвечает (для виртуальных машин Windows)

#### <a name="solution"></a>Решение
Возможно, агент виртуальной машины может быть поврежден или служба остановлена. Повторная установка агента виртуальной машины поможет получить последнюю версию и возобновить обмен данными со службой.

1. Определите, запущена ли служба гостевого агента Microsoft Azure в службах виртуальной машины (services.msc). Попробуйте перезапустить службу гостевого агента Microsoft Azure и запустите резервное копирование.    
2. Если она не отображается в списке служб, на панели управления выберите **Программы и компоненты**, чтобы определить, установлена ли служба гостевого агента Microsoft Azure.
4. Если гостевой агент Microsoft Azure отображается в разделе **Программы и компоненты**, удалите его.
5. Скачайте и установите [последнюю версию файла MSI агента](https://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.
6. Убедитесь, что службы гостевого агента Microsoft Azure отображаются в списке служб.
7. Выполните резервное копирование по запросу:
    * На портале выберите **Моментальная архивация**.

Кроме того, убедитесь, что [Microsoft .NET 4.5 установлен](https://docs.microsoft.com/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed) на виртуальной машине. Компонент .NET 4.5 необходим для взаимодействия агента виртуальной машины со службой.

### <a name="the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a>Устарел агент, установленный на виртуальной машине (для виртуальных машин Linux)

#### <a name="solution"></a>Решение
Большая часть неполадок, связанных с агентом или расширением на виртуальных машинах Linux, вызваны проблемами с устаревшим агентом виртуальной машины. Чтобы устранить эту проблему, следуйте приведенным ниже общим рекомендациям.

1. Выполните указания по [обновлению агента виртуальной машины Linux ](../virtual-machines/linux/update-agent.md).

   > [!NOTE]
   > Мы *настоятельно рекомендуем* обновлять агент только посредством репозитория дистрибутивов. Мы не рекомендуем скачивать код агента непосредственно с портала GitHub и обновлять его. Если последняя версия агента для вашего дистрибутива недоступна, обратитесь в службу поддержки дистрибутива, чтобы получить инструкции по установке последней версии агента. Чтобы проверить наличие последней версии агента, перейдите на страницу [агента Linux для Microsoft Azure](https://github.com/Azure/WALinuxAgent/releases) в репозитории GitHub.

2. Убедитесь, что на виртуальной машине запущен агент Azure, выполнив команду `ps -e`.

   Если нужный процесс не запущен, выполните следующие команды для его перезапуска:

   * Для Ubuntu: `service walinuxagent start`.
   * Для других дистрибутивов: `service waagent start`.

3. [Настройте автоматический перезапуск агента](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).
4. Снова запустите резервное копирование для проверки. Если ошибка не исчезла, извлеките следующие журналы из виртуальной машины:

   * /var/lib/waagent/*.xml
   * /var/log/waagent.log
   * /var/log/azure/*

Если нам потребуется подробное ведение журнала для waagent, выполните следующие действия.

1. В файле /etc/waagent.conf найдите следующую строку: **Enable verbose logging (y|n)** .
2. Для параметра **Logs.Verbose** измените значение с *n* на *y*.
3. Сохраните изменения и перезапустите waagent, выполнив шаги, описанные выше в этом разделе.

###  <a name="the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a>Не удалось получить состояние моментального снимка или создать моментальный снимок
Архивация виртуальных машин зависит от команды создания моментального снимка в базовой учетной записи хранения. Сбой службы Backup может произойти, если она не имеет доступа к учетной записи хранения или выполнение задачи создания моментального снимка задерживается.

#### <a name="solution"></a>Решение
Сбой задачи создания снимка может быть вызван следующими условиями.

| Причина: | Решение |
| --- | --- |
| Состояние виртуальной машины отображается неправильно из-за того, что ее работа была завершена в протоколе удаленного рабочего стола (RDP). | Когда вы завершаете работу виртуальной машины в RDP, проверьте, правильно ли отображается состояние виртуальной машины на портале. Если это не так, завершите работу виртуальной машины на портале с помощью операции **Завершение работы** на панели мониторинга виртуальной машины. |
| Виртуальная машина не может получить адрес узла или структуры по протоколу DHCP. | Чтобы архивация виртуальной машины IaaS работала, в гостевой учетной записи нужно включить протокол DHCP. Если виртуальная машина не может получить адрес узла или структуры в виде ответа DHCP 245, то она не сможет скачать или запустить какие-либо расширения. Если вам нужен статический частный IP-адрес, настройте его с помощью **портал Azure** или **PowerShell** и убедитесь, что в ВИРТУАЛЬНОЙ машине включен параметр DHCP. Дополнительные сведения о настройке статического IP-адреса с помощью PowerShell см. [здесь](../virtual-network/virtual-networks-static-private-ip-arm-ps.md#change-the-allocation-method-for-a-private-ip-address-assigned-to-a-network-interface) .

### <a name="the-backup-extension-fails-to-update-or-load"></a>Не удалось обновить или загрузить расширение резервного копирования
Если не удается загрузить расширения, получить моментальный снимок состояния невозможно, и архивация завершится сбоем.

#### <a name="solution"></a>Решение

Удалите расширение, чтобы принудительно перезагрузить расширение VMSnapshot. Расширение перезагрузится при следующей попытке резервного копирования.

Чтобы удалить расширение, сделайте следующее:

1. На [портале Azure](https://portal.azure.com/) перейдите к виртуальной машине, с архивацией которой возникли проблемы.
2. Выберите элемент **Параметры**.
3. Выберите **Расширения**.
4. Выберите **Vmsnapshot Extension** (Расширение Vmsnapshot).
5. Выберите **Удалить**.

Если расширение VMSnapshot для виртуальной машины Linux не отображается на портале Azure, [обновите агент Azure для Linux](../virtual-machines/linux/update-agent.md), а затем выполните резервное копирование.

После этого расширение будет повторно установлено при следующей архивации.

### <a name="remove_lock_from_the_recovery_point_resource_group"></a>Удаление блокировки с группы ресурсов точки восстановления
1. Войдите на [портале Azure](https://portal.azure.com/).
2. Перейдите к параметру **Все ресурсы**, выберите группу ресурсов коллекции точек восстановления в следующем формате: AzureBackupRG_`<Geo>`_`<number>`.
3. В разделе **Параметры** выберите **Блокировки**, чтобы отобразить блокировки.
4. Чтобы удалить блокировку, щелкните многоточие и нажмите кнопку **Удалить**.

    ![Удаление блокировки](./media/backup-azure-arm-vms-prepare/delete-lock.png)

### <a name="clean_up_restore_point_collection"></a> Очистка коллекции точек восстановления
После удаления блокировки точки восстановления нужно очистить. Чтобы очистить точки восстановления, воспользуйтесь любым из этих методов:<br>
* [Очистка коллекции точек восстановления путем запуска нерегламентированного резервного копирования](#clean-up-restore-point-collection-by-running-ad-hoc-backup)<br>
* [Очистка коллекции точек восстановления на портале Azure](#clean-up-restore-point-collection-from-azure-portal)<br>

#### <a name="clean-up-restore-point-collection-by-running-ad-hoc-backup"></a>Очистка коллекции точек восстановления путем запуска нерегламентированного резервного копирования
После удаления блокировки активируйте нерегламентированную или ручную архивацию. Это обеспечит автоматическую очистку точек восстановления. Ожидание нерегламентированного или ручного выполнения при первом сбое; Однако это обеспечит автоматическую очистку вместо удаления точек восстановления вручную. После очистки следующее запланированное резервное копирование должно быть выполнено успешно.

> [!NOTE]
> Автоматическая очистка произойдет через несколько часов после запуска нерегламентированного или ручного резервного копирования. Если запланированное резервное копирование по-прежнему дает сбой, попробуйте вручную удалить коллекцию точек восстановления, выполнив действия, перечисленные [здесь](#clean-up-restore-point-collection-from-azure-portal).

#### <a name="clean-up-restore-point-collection-from-azure-portal"></a> Очистка коллекции точек восстановления на портале Azure <br>

Чтобы вручную очистить коллекцию точек восстановления, которая не очищается из-за блокировки группы ресурсов, попробуйте сделать следующее.
1. Войдите на [портале Azure](https://portal.azure.com/).
2. В меню **Концентратор** щелкните **Все ресурсы**, выберите группу ресурсов в формате AzureBackupRG_`<Geo>`_`<number>`, в которой находится ваша виртуальная машина.

    ![Удаление блокировки](./media/backup-azure-arm-vms-prepare/resource-group.png)

3. Щелкните группу ресурсов, после чего отобразится колонка **Обзор**.
4. Выберите параметр **Показать скрытые типы**, чтобы отобразить все скрытые ресурсы. Выберите коллекции точек восстановления в следующем формате: AzureBackupRG_`<VMName>`_`<number>`.

    ![Удаление блокировки](./media/backup-azure-arm-vms-prepare/restore-point-collection.png)

5. Щелкните **Удалить**, чтобы очистить коллекцию точек восстановления.
6. Повторите операцию резервного копирования.

> [!NOTE]
 >Если ресурс (коллекция для защиты репликации) обладает большим количеством точек восстановления, то его удаление с портала может завершиться временем ожидания и ошибкой. Данная ошибка, более известная как CRP, когда все точки восстановления не удаляются в оговоренное время, а время ожидания для операции истекает. Тем не менее операция удаления обычно завершается успешно после 2 или 3 повторных попыток.
