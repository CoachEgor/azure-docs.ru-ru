---
title: Учебник по резервному копированию баз данных SAP HANA на виртуальных машинах Azure
description: Из этого учебника вы узнаете, как выполнять резервное копирование баз данных SAP HANA, запущенных на виртуальной машине Azure, в хранилище Служб восстановления для Azure Backup.
ms.topic: tutorial
ms.date: 11/12/2019
ms.openlocfilehash: a622370fca3144aeb6a5d7c071c227b3c21cf135
ms.sourcegitcommit: e50a39eb97a0b52ce35fd7b1cf16c7a9091d5a2a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2019
ms.locfileid: "74287191"
---
# <a name="tutorial-back-up-sap-hana-databases-in-an-azure-vm"></a>Руководство по резервному копированию баз данных SAP HANA на виртуальной машине Azure

В этом учебнике показано, как выполнять резервное копирование баз данных SAP HANA, запущенных на виртуальных машинах Azure, в хранилище Служб восстановления для Azure Backup. Из этой статьи вы узнаете о следующем.

> [!div class="checklist"]
>
> * Создание и настройка хранилища.
> * Обнаружение баз данных.
> * Настройка резервного копирования.

[Здесь](sap-hana-backup-support-matrix.md#scenario-support) все поддерживаемые сейчас сценарии.

## <a name="onboard-to-the-public-preview"></a>Подключение общедоступной предварительной версии

Подключите общедоступную предварительную версию следующим образом:

* На портале зарегистрируйте идентификатор подписки в поставщике Служб восстановления, [выполнив инструкции из этой статьи](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-register-provider-errors#solution-3---azure-portal).

* В PowerShell выполните этот командлет. Он должен завершиться с результатом Registered (Зарегистрировано).

    ```powershell
    Register-AzProviderFeature -FeatureName "HanaBackup" –ProviderNamespace Microsoft.RecoveryServices
    ```

## <a name="prerequisites"></a>Предварительные требования

Перед настройкой резервных копий убедитесь обязательно сделайте следующее:

1. На виртуальной машине, на которой запущена база данных SAP HANA, установите и включите пакеты драйверов ODBC из официального пакета или носителя SLES с помощью zypper, как показано ниже.

```bash
sudo zypper update
sudo zypper install unixODBC
```

>[!NOTE]
> Если вы не обновляете репозитории, убедитесь, что версия unixODBC не ниже 2.3.4. Чтобы получить сведения о версии uniXODBC, запустите `odbcinst -j` с правами привилегированного пользователя.
>

2. Разрешите подключение с виртуальной машины к Интернету, чтобы она могла получить доступ к Azure, как описано в [процедуре ниже](#set-up-network-connectivity).

3. Запустите сценарий предварительной регистрации на виртуальной машине, где установлена HANA, с правами привилегированного пользователя. [Этот скрипт](https://aka.ms/scriptforpermsonhana) задаст [необходимые разрешения](#setting-up-permissions).

## <a name="set-up-network-connectivity"></a>Настройка сетевого подключения

Для всех операций виртуальной машине SAP HANA требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения. Установите подключение, предоставив доступ к диапазонам IP-адресов центра обработки данных Azure:

* Вы можете скачать [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) для центров обработки данных Azure, а затем разрешить доступ к этим IP-адресам.
* Если вы используете группы безопасности сети (NSG), для разрешения всех общедоступных IP-адресов Azure можно использовать [тег службы](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) AzureCloud. Изменить правила NSG можно с помощью командлета [Set-AzureNetworkSecurityRule](https://docs.microsoft.com/powershell/module/servicemanagement/azure/set-azurenetworksecurityrule?view=azuresmps-4.0.0).
* Порт 443 должен быть добавлен в список разрешений, так как транспортировка осуществляется по протоколу HTTPS.

## <a name="setting-up-permissions"></a>Настройка разрешений

Этот скрипт предварительной регистрации выполняет следующие действия:

1. Создает AZUREWLBACKUPHANAUSER в системе HANA и добавляет следующие необходимые роли и разрешения:
   * DATABASE ADMIN: для создания баз данных во время восстановления;
   * CATALOG READ: для чтения каталога резервных копий;
   * SAP_INTERNAL_HANA_SUPPORT: для доступа к некоторым частным таблицам.
2. Добавляет ключ в Hdbuserstore, чтобы подключаемый модуль HANA выполнял все операции (запросы к базе данных, операции восстановления, настройка и выполнение резервного копирования).

Чтобы подтвердить создание ключа, выполните команду HDBSQL на компьютере HANA с учетными данными SIDADM:

```hdbsql
hdbuserstore list
```

В выходных данных команды должен отобразиться ключ {ИД_безопасности}{имя_БД}, а пользователь должен отображаться как AZUREWLBACKUPHANAUSER.

>[!NOTE]
> Убедитесь, что в папке /usr/sap/{ИД_безопасности}/home/.hdb/ есть уникальный набор файлов SSFS. По этому пути должна быть только одна папка.
>

## <a name="create-a-recovery-service-vault"></a>Создание хранилища Служб восстановления

Хранилище Служб восстановления — это объект, который хранит резервные копии и точки восстановления, созданные с течением времени. В нем также содержатся политики архивации, связанные с защищенными виртуальными машинами.

Чтобы создать хранилище служб восстановления, сделайте следующее:

1. Войдите в подписку на [портале Azure](https://portal.azure.com/).

2. В меню слева выберите **Все службы**.

![Выбор "Все службы"](./media/tutorial-backup-sap-hana-db/all-services.png)

3. В диалоговом окне **Все службы** введите **Службы восстановления**. Список ресурсов отфильтруется на основе введенных данных. В списке ресурсов выберите **Хранилища служб восстановления**.

![Выбор "Хранилища служб восстановления"](./media/tutorial-backup-sap-hana-db/recovery-services-vaults.png)

4. На панели мониторинга **Хранилища служб восстановления** выберите **Добавить**.

![Добавление хранилища Служб восстановления](./media/tutorial-backup-sap-hana-db/add-vault.png)

Откроется диалоговое окно **Хранилища служб восстановления**. Укажите значения **имени, подписки, группы ресурсов** и **расположения**.

![Создание хранилища Служб восстановления](./media/tutorial-backup-sap-hana-db/create-vault.png)

* **Имя.** Имя используется для обнаружения хранилища служб восстановления. Оно должно быть уникальным для подписки Azure. Введите имя, которое содержит от 2 до 50 знаков. Оно должно начинаться с буквы и может содержать только буквы, цифры и дефисы. При работе с этим учебником мы использовали имя **SAPHanaVault**.
* **Подписка**: Выберите подписку, которую нужно использовать. Если вы являетесь участником только одной подписки, будет отображено ее имя. Если неизвестно, какую подписку нужно использовать, оставьте подписку по умолчанию (или предлагаемую подписку). Вариантов будет несколько только в том случае, если рабочая или учебная учетная запись связана с несколькими подписками Azure. Здесь мы использовали подписку на **решение SAP HANA**.
* **Группа ресурсов.** Используйте имеющуюся группу ресурсов или создайте новую. Здесь мы использовали **SAPHANADemo**.<br>
Выберите **Использовать существующий**, чтобы просмотреть список доступных групп ресурсов в вашей подписке, а затем выберите ресурс из раскрывающегося списка. Чтобы создать группу ресурсов, щелкните **Создать** и укажите ее имя. Дополнительные сведения о группах ресурсов см. в [обзоре Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview).
* **Расположение.** Выберите географический регион для хранилища. Хранилище должно располагаться в том же регионе, что и виртуальные машины, на которых запущена SAP HANA. Мы использовали **восточную часть США 2**.

5. Выберите **Review + Create** (Просмотреть и создать).

   ![Выбор Review + Create (Просмотр и создание)](./media/tutorial-backup-sap-hana-db/review-create.png)

Теперь хранилище Служб восстановления создано.

## <a name="discover-the-databases"></a>Обнаружение баз данных

1. В разделе хранилища **Начало работы** щелкните **Резервное копирование**. В разделе **Где выполняется рабочая нагрузка?** выберите **SAP HANA в виртуальной машине Azure**.
2. Щелкните **Начать обнаружение**. Это инициирует обнаружение незащищенных виртуальных машин Linux в регионе хранилища. Вы увидите виртуальную машину Azure, которую необходимо защитить.
3. В разделе **Выбор виртуальных машин** щелкните ссылку, чтобы скачать скрипт, предоставляющий службе Azure Backup разрешения на доступ к виртуальным машинам SAP HANA для обнаружения баз данных.
4. Запустите скрипт на виртуальной машине, где размещены базы данных SAP HANA, для которых требуется создать резервную копию.
5. После выполнения скрипта на виртуальной машине в разделе **Выбор виртуальных машин** выберите виртуальную машину. Далее нажмите на кнопку **Обнаружить базы данных**.
6. Azure Backup обнаруживает все базы данных SAP HANA на виртуальной машине. Во время обнаружения Azure Backup регистрирует виртуальную машину в хранилище и устанавливает расширение на виртуальной машине. В базе данных агент не устанавливается.

   ![Обнаружение баз данных](./media/tutorial-backup-sap-hana-db/database-discovery.png)

## <a name="configure-backup"></a>Настройка резервного копирования

После обнаружения баз данных, для которых требуется выполнить резервное копирование, можно включить резервное копирование.

1. Щелкните **Настройка архивации**.

![Настройка резервного копирования](./media/tutorial-backup-sap-hana-db/configure-backup.png)

2. В разделе **Выбор элементов для архивации** выберите одну или несколько баз данных, которые необходимо защитить, а затем нажмите кнопку **ОК**.

![Выбор элементов для резервного копирования](./media/tutorial-backup-sap-hana-db/select-items-to-backup.png)

3. В разделе **Политика архивации > Выбрать политику архивации** создайте политику резервного копирования для баз данных в соответствии с инструкциями в следующем разделе.

![Выбор политики резервного копирования](./media/tutorial-backup-sap-hana-db/backup-policy.png)

4. После создания политики в меню **Резервное копирование** выберите **Включить резервное копирование**.

   ![Кнопка "Включить резервное копирование"](./media/tutorial-backup-sap-hana-db/enable-backup.png)

5. В области **Уведомления** портала можно отслеживать ход настройки резервного копирования.

## <a name="creating-a-backup-policy"></a>Создание политики резервного копирования

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.

Укажите параметры политики следующим образом:

1. Введите имя новой политики в поле **Имя политики**. В данном случае введите **SAPHANA**.

![Введение имени для новой политики](./media/tutorial-backup-sap-hana-db/new-policy.png)

2. В меню **Политика полного резервного копирования** выберите **Частота резервного копирования**. Вы можете выбрать **Ежедневно** или **Еженедельно**. Для этого учебника для резервного копирования мы выбрали **Ежедневно**.

![Выбор частоты резервного копирования](./media/tutorial-backup-sap-hana-db/backup-frequency.png)

3. В разделе **Диапазон хранения** настройте параметры периода удержания для полной резервной копии.
   * По умолчанию выбраны все варианты. Очистите любые ограничения диапазона периода удержания, которые вы не хотите использовать, и установите соответствующие ограничения.
   * Минимальный период хранения для резервной копии любого типа (полная/разностная/журнал) составляет семь дней.
   * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
   * Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром.
   * Месячный и годовой диапазоны хранения действуют аналогичным образом.
4. В меню **Политика полного резервного копирования** нажмите кнопку **ОК** для подтверждения параметров.
5. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.
6. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением. Мы активировали создание каждое **воскресенье** в **2:00** разностной резервной копии, которая хранится **30 дней**.

   ![Политика разностного резервного копирования](./media/tutorial-backup-sap-hana-db/differential-backup-policy.png)

>[!NOTE]
>Добавочные резервные копии сейчас не поддерживаются.
>

7. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
8. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервная копия журналов**.
   * Для параметра **Резервная копия журналов** по умолчанию установлено значение **Включено**. Это невозможно отключить, так как SAP HANA управляет всеми резервными копиями журналов.
   * Для расписания резервного копирования настроено **2 часа**, а для периода хранения — **15 дней**.

    ![Политика резервного копирования журналов](./media/tutorial-backup-sap-hana-db/log-backup-policy.png)

>[!NOTE]
> Резервные копии журналов начнут создаваться только после завершения одного успешного полного резервного копирования.
>

9. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
10. После завершения определения политики резервного копирования нажмите кнопку **ОК**.

Теперь вы успешно настроили резервные копии для баз данных SAP HANA.

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте, как [выполнять резервное копирование по запросу в базах данных SAP HANA, запущенных на виртуальных машинах Azure](backup-azure-sap-hana-database.md#run-an-on-demand-backup).
* Узнайте, как [восстановить базы данных SAP HANA, запущенные на виртуальных машинах Azure](sap-hana-db-restore.md).
* Узнайте, как [управлять базами данных SAP HANA, резервное копирование которых выполняется с помощью Azure Backup](sap-hana-db-manage.md).
* Узнайте, как [устранять распространенные проблемы при резервном копировании баз данных SAP HANA](backup-azure-sap-hana-database-troubleshoot.md).
