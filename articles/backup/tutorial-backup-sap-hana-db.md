---
title: Учебник по резервному копированию баз данных SAP HANA на виртуальных машинах Azure
description: Из этого учебника вы узнаете, как выполнять резервное копирование баз данных SAP HANA, запущенных на виртуальной машине Azure, в хранилище Служб восстановления для Azure Backup.
ms.topic: tutorial
ms.date: 02/24/2020
ms.openlocfilehash: 31958a4d4e3af4f747ab2f9de7b1bc67560e87d7
ms.sourcegitcommit: 8017209cc9d8a825cc404df852c8dc02f74d584b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2020
ms.locfileid: "84248249"
---
# <a name="tutorial-back-up-sap-hana-databases-in-an-azure-vm"></a>Руководство по резервному копированию баз данных SAP HANA на виртуальной машине Azure

В этом учебнике показано, как выполнять резервное копирование баз данных SAP HANA, запущенных на виртуальных машинах Azure, в хранилище Служб восстановления для Azure Backup. Из этой статьи вы узнаете о следующем.

> [!div class="checklist"]
>
> * Создание и настройка хранилища.
> * Обнаружение баз данных.
> * Настройка резервного копирования.

[Здесь](sap-hana-backup-support-matrix.md#scenario-support) все поддерживаемые сейчас сценарии.

>[!NOTE]
>[Попробуйте](https://docs.microsoft.com/azure/backup/tutorial-backup-sap-hana-db) предварительную версию Azure Backup для SAP HANA в RHEL (7.4, 7.6, 7.7 и 8.1). С вопросами пишите на адрес [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com).

## <a name="prerequisites"></a>Предварительные требования

Перед настройкой резервных копий убедитесь обязательно сделайте следующее:

* Разрешите подключение из виртуальной машины к Интернету, чтобы она могла получить доступ к Azure, как описано в процедуре [настройки сетевого подключения](#set-up-network-connectivity) ниже.
* Ключ должен существовать в **hdbuserstore**, соответствующем следующим критериям:
  * Он должен присутствовать в **hdbuserstore** по умолчанию.
  * Для MDC ключ должен указывать на порт SQL **NAMESERVER**. Для SDC он должен указывать на порт SQL **INDEXSERVER**.
  * Должны быть учетные данные для добавления и удаления пользователей.
* С правами привилегированного пользователя запустите скрипт настройки резервного копирования SAP HANA (скрипт предварительной регистрации) на виртуальной машине, где установлена HANA. [Этот скрипт](https://aka.ms/scriptforpermsonhana) получает систему HANA, готовую для резервного копирования. Дополнительные сведения о скрипте предварительной регистрации см. в разделе [Функции скрипта предварительной регистрации](#what-the-pre-registration-script-does).

>[!NOTE]
>Скрипт предварительной регистрации устанавливает **compat-unixODBC234** для рабочих нагрузок SAP HANA, выполняемых в RHEL (7.4, 7.6 и 7.7) и **unixODBC** для RHEL 8.1. [Этот пакет находится в репозитории RHEL for SAP HANA (for RHEL 7 Server) Update Services for SAP Solutions (RPMs)](https://access.redhat.com/solutions/5094721).  Репозиторий для образа RHEL в Azure Marketplace: **rhui-rhel-sap-hana-for-rhel-7-server-rhui-e4s-rpms**.

## <a name="set-up-network-connectivity"></a>Настройка сетевого подключения

Для всех операций виртуальной машине SAP HANA требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам Azure.

Установите подключение, используя один из следующих вариантов.

### <a name="allow-the-azure-datacenter-ip-ranges"></a>Разрешение диапазонов IP-адресов центра обработки данных Azure

Этот параметр разрешает [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в скачанном файле. Чтобы получить доступ к группе безопасности сети, используйте командлет "Set-AzureNetworkSecurityRule". Если список надежных получателей содержит только IP-адреса, относящиеся к региону, вам также нужно обновить список безопасных получателей тегом службы Azure Active Directory (Azure AD), чтобы включить проверку подлинности.

### <a name="allow-access-using-nsg-tags"></a>Разрешение доступа с помощью тегов NSG

При использовании NSG для ограничения возможностей подключения следует использовать тег службы AzureBackup, чтобы разрешить исходящий доступ к Azure Backup. Кроме того, вы также можете разрешить подключение для проверки подлинности и передачу данных, используя [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и службы хранилища Azure. Это можно сделать на портале Azure или с помощью PowerShell.

Чтобы создать правило с помощью портала, выполните следующие действия.

  1. В разделе **Все службы** перейдите к **группам сетевой безопасности** и выберите группу сетевой безопасности.
  2. Выберите **Правила безопасности для исходящего трафика** в разделе **Параметры**.
  3. Выберите **Добавить**. Введите все необходимые сведения для создания нового правила, как описано в разделе [параметры правила безопасности](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group#security-rule-settings). Убедитесь, что параметр **Назначение** имеет значение **Тег службы**, а **Тег целевой службы** имеет значение **AzureBackup**.
  4. Щелкните **Добавить**, чтобы сохранить только что созданное исходящее правило безопасности.

Чтобы создать правило с помощью PowerShell, выполните следующие действия.

 1. Добавление учетных данных учетной записи Azure и обновление национальных облаков<br/>
      `Add-AzureRmAccount`<br/>

 2. Выберите подписку NSG<br/>
      `Select-AzureRmSubscription "<Subscription Id>"`

 3. Выберите NSG<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

 4. Добавление разрешающего правила исходящего трафика для тега службы Azure Backup<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 5. Добавление разрешающего правила исходящего трафика для тега Службы хранилища<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "StorageAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "Storage" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 6. Добавление разрешающего правила исходящего трафика для тега AzureActiveDirectory<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureActiveDirectoryAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureActiveDirectory" -DestinationPortRange 443 -Description "Allow outbound traffic to AzureActiveDirectory service"`

 7. Сохраните файл NSG<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`

**Разрешите доступ с помощью тегов брандмауэра Azure**. Если вы используете брандмауэр Azure, создайте правило приложения с помощью[тега AzureBackup FQDN](https://docs.microsoft.com/azure/firewall/fqdn-tags). Это разрешает исходящий доступ к службам Azure Backup.

**Развертывание прокси-сервера HTTP для маршрутизации трафика**. Когда создается резервная копия базы данных SAP HANA на виртуальной машине Azure, расширение резервного копирования на виртуальной машине использует API HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure AD для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Варианты подключения включают следующие преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure
Использование тегов службы NSG | Упрощенное управление благодаря автоматическому объединению изменений диапазона <br/><br/> Нет дополнительных затрат <br/><br/> | Может использоваться только с NSG <br/><br/> Предоставляет доступ ко всей службе
Использование тегов полного доменного имени службы "Брандмауэр Azure" | Проще управлять, так как требуемые управляются FQDN автоматически | Можно использовать только с брандмауэром Azure
Использование прокси-сервера HTTP | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере <br/><br/> Единая точка доступа к виртуальным машинам через Интернет <br/><br/> Не подвергается влиянию изменений IP-адресов Azure | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера

## <a name="what-the-pre-registration-script-does"></a>Функции скрипта предварительной регистрации

Скрипт предварительной регистрации позволяет выполнять следующие функции:

* Он устанавливает или обновляет пакеты, необходимые агенту Azure Backup в распределении.
* Он выполняет проверку исходящего сетевого подключения к серверам Azure Backup и зависимым службам, таким как Azure Active Directory и служба хранилища Azure.
* Он входит в систему HANA, используя ключ пользователя, указанный в составе [предварительных требований](#prerequisites). Ключ пользователя используется для создания пользователя резервного копирования (AZUREWLBACKUPHANAUSER) в системе HANA. Его можно удалить после успешного выполнения скрипта предварительной регистрации.
* AZUREWLBACKUPHANAUSER назначены приведенные ниже необходимые роли и разрешения.
  * DATABASE ADMIN (в случае MDC) и BACKUP ADMIN (в случае SDC): для создания баз данных во время восстановления.
  * CATALOG READ: для чтения каталога резервных копий;
  * SAP_INTERNAL_HANA_SUPPORT: для доступа к некоторым частным таблицам.
* Скрипт добавляет ключ в **hdbuserstore** для AZUREWLBACKUPHANAUSER, чтобы подключаемый модуль резервного копирования HANA выполнял все операции (запросы к базе данных, операции восстановления, настройку и выполнение резервного копирования).

>[!NOTE]
> Вы можете явным образом передать ключ пользователя, указанный как часть [предварительных условий](#prerequisites), в качестве параметра скрипту предварительной регистрации: `-sk SYSTEM_KEY_NAME, --system-key SYSTEM_KEY_NAME` <br><br>
>Чтобы узнать, какие другие параметры принимает скрипт, выполните команду `bash msawb-plugin-config-com-sap-hana.sh --help`

Чтобы подтвердить создание ключа, выполните команду HDBSQL на компьютере HANA с учетными данными SIDADM:

```hdbsql
hdbuserstore list
```

В выходных данных команды должен отобразиться ключ {ИД_безопасности}{имя_БД}, а пользователь должен отображаться как AZUREWLBACKUPHANAUSER.

>[!NOTE]
> Убедитесь, что в папке `/usr/sap/{SID}/home/.hdb/` есть уникальный набор файлов SSFS. По этому пути должна быть только одна папка.

## <a name="create-a-recovery-service-vault"></a>Создание хранилища Служб восстановления

Хранилище Служб восстановления — это объект, который хранит резервные копии и точки восстановления, созданные с течением времени. В нем также содержатся политики архивации, связанные с защищенными виртуальными машинами.

Чтобы создать хранилище служб восстановления, сделайте следующее:

1. Войдите в подписку на [портале Azure](https://portal.azure.com/).

2. В меню слева выберите **Все службы**.

   ![Выбор "Все службы"](./media/tutorial-backup-sap-hana-db/all-services.png)

3. В диалоговом окне **Все службы** введите **Службы восстановления**. Список ресурсов отфильтруется на основе введенных данных. В списке ресурсов выберите **Хранилища служб восстановления**.

   ![Выбор "Хранилища служб восстановления"](./media/tutorial-backup-sap-hana-db/recovery-services-vaults.png)

4. На панели мониторинга **Хранилища служб восстановления** выберите **Добавить**.

   ![Добавление хранилища Служб восстановления](./media/tutorial-backup-sap-hana-db/add-vault.png)

   Откроется диалоговое окно **Хранилища служб восстановления**. Укажите значения **имени, подписки, группы ресурсов** и **расположения**.

   ![Создание хранилища Служб восстановления](./media/tutorial-backup-sap-hana-db/create-vault.png)

   * **Name** (Имя). Имя используется для обнаружения хранилища служб восстановления. Оно должно быть уникальным для подписки Azure. Введите имя, которое содержит от 2 до 50 знаков. Оно должно начинаться с буквы и может содержать только буквы, цифры и дефисы. При работе с этим учебником мы использовали имя **SAPHanaVault**.
   * **Подписка**: Выберите подписку, которую нужно использовать. Если вы являетесь участником только одной подписки, будет отображено ее имя. Если неизвестно, какую подписку нужно использовать, оставьте подписку по умолчанию (или предлагаемую подписку). Вариантов будет несколько только в том случае, если рабочая или учебная учетная запись связана с несколькими подписками Azure. Здесь мы использовали подписку на **решение SAP HANA**.
   * **Группа ресурсов.** Используйте имеющуюся группу ресурсов или создайте новую. Здесь мы использовали **SAPHANADemo**.<br>
   Выберите **Использовать существующий**, чтобы просмотреть список доступных групп ресурсов в вашей подписке, а затем выберите ресурс из раскрывающегося списка. Чтобы создать группу ресурсов, щелкните **Создать** и укажите ее имя. Дополнительные сведения о группах ресурсов см. в [обзоре Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview).
   * **Расположение.** Выберите географический регион для хранилища. Хранилище должно располагаться в том же регионе, что и виртуальные машины, на которых запущена SAP HANA. Мы использовали **восточную часть США 2**.

5. Выберите **Review + Create** (Просмотреть и создать).

   ![Выбор Review + Create (Просмотр и создание)](./media/tutorial-backup-sap-hana-db/review-create.png)

Теперь хранилище Служб восстановления создано.

## <a name="discover-the-databases"></a>Обнаружение баз данных

1. В разделе хранилища **Начало работы** щелкните **Резервное копирование**. В разделе **Где выполняется рабочая нагрузка?** выберите **SAP HANA в виртуальной машине Azure**.
2. Щелкните **Начать обнаружение**. Это инициирует обнаружение незащищенных виртуальных машин Linux в регионе хранилища. Вы увидите виртуальную машину Azure, которую необходимо защитить.
3. В разделе **Выбор виртуальных машин** щелкните ссылку, чтобы скачать скрипт, предоставляющий службе Azure Backup разрешения на доступ к виртуальным машинам SAP HANA для обнаружения баз данных.
4. Запустите скрипт на виртуальной машине, где размещены базы данных SAP HANA, для которых требуется создать резервную копию.
5. После выполнения скрипта на виртуальной машине в разделе **Выбор виртуальных машин** выберите виртуальную машину. Далее нажмите на кнопку **Обнаружить базы данных**.
6. Azure Backup обнаруживает все базы данных SAP HANA на виртуальной машине. Во время обнаружения Azure Backup регистрирует виртуальную машину в хранилище и устанавливает расширение на виртуальной машине. В базе данных агент не устанавливается.

   ![Обнаружение баз данных](./media/tutorial-backup-sap-hana-db/database-discovery.png)

## <a name="configure-backup"></a>Настройка резервного копирования

После обнаружения баз данных, для которых требуется выполнить резервное копирование, можно включить резервное копирование.

1. Щелкните **Настройка архивации**.

   ![Настройка резервного копирования](./media/tutorial-backup-sap-hana-db/configure-backup.png)

2. В разделе **Выбор элементов для архивации** выберите одну или несколько баз данных, которые необходимо защитить, а затем нажмите кнопку **ОК**.

   ![Выбор элементов для резервного копирования](./media/tutorial-backup-sap-hana-db/select-items-to-backup.png)

3. В разделе **Политика архивации > Выбрать политику архивации** создайте политику резервного копирования для баз данных в соответствии с инструкциями в следующем разделе.

   ![Выбор политики резервного копирования](./media/tutorial-backup-sap-hana-db/backup-policy.png)

4. После создания политики в меню **Резервное копирование** выберите **Включить резервное копирование**.

   ![Кнопка "Включить резервное копирование"](./media/tutorial-backup-sap-hana-db/enable-backup.png)

5. В области **Уведомления** портала можно отслеживать ход настройки резервного копирования.

## <a name="creating-a-backup-policy"></a>Создание политики резервного копирования

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.

Укажите параметры политики следующим образом:

1. Введите имя новой политики в поле **Имя политики**. В данном случае введите **SAPHANA**.

   ![Введение имени для новой политики](./media/tutorial-backup-sap-hana-db/new-policy.png)

2. В меню **Политика полного резервного копирования** выберите **Частота резервного копирования**. Вы можете выбрать **Ежедневно** или **Еженедельно**. Для этого учебника для резервного копирования мы выбрали **Ежедневно**.

   ![Выбор частоты резервного копирования](./media/tutorial-backup-sap-hana-db/backup-frequency.png)

3. В разделе **Диапазон хранения** настройте параметры периода удержания для полной резервной копии.
   * По умолчанию выбраны все варианты. Очистите любые ограничения диапазона периода удержания, которые вы не хотите использовать, и установите соответствующие ограничения.
   * Минимальный период хранения для резервной копии любого типа (полная/разностная/журнал) составляет семь дней.
   * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
   * Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром.
   * Месячный и годовой диапазоны хранения действуют аналогичным образом.
4. В меню **Политика полного резервного копирования** нажмите кнопку **ОК** для подтверждения параметров.
5. Чтобы добавить политику разностного резервного копирования, щелкните **Разностная резервная копия**.
6. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением. Мы активировали создание каждое **воскресенье** в **2:00** разностной резервной копии, которая хранится **30 дней**.

   ![Политика разностного резервного копирования](./media/tutorial-backup-sap-hana-db/differential-backup-policy.png)

   >[!NOTE]
   >Добавочные резервные копии сейчас не поддерживаются.
   >

7. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
8. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервная копия журналов**.
   * Для параметра **Резервная копия журналов** по умолчанию установлено значение **Включено**. Это невозможно отключить, так как SAP HANA управляет всеми резервными копиями журналов.
   * Для расписания резервного копирования настроено **2 часа**, а для периода хранения — **15 дней**.

    ![Политика резервного копирования журналов](./media/tutorial-backup-sap-hana-db/log-backup-policy.png)

   >[!NOTE]
   > Резервные копии журналов начнут создаваться только после завершения одного успешного полного резервного копирования.
   >

9. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
10. После завершения определения политики резервного копирования нажмите кнопку **ОК**.

Теперь вы успешно настроили резервные копии для баз данных SAP HANA.

## <a name="next-steps"></a>Next Steps

* Узнайте, как [выполнять резервное копирование по запросу в базах данных SAP HANA, запущенных на виртуальных машинах Azure](backup-azure-sap-hana-database.md#run-an-on-demand-backup).
* Узнайте, как [восстановить базы данных SAP HANA, запущенные на виртуальных машинах Azure](sap-hana-db-restore.md).
* Узнайте, как [управлять базами данных SAP HANA, резервное копирование которых выполняется с помощью Azure Backup](sap-hana-db-manage.md).
* Узнайте, как [устранять распространенные проблемы при резервном копировании баз данных SAP HANA](backup-azure-sap-hana-database-troubleshoot.md).
