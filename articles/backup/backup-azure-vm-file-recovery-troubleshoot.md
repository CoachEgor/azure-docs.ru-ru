---
title: Устранение неполадок при восстановлении файлов виртуальной машины Azure
description: Устранение неполадок при восстановлении файлов и папок из резервной копии виртуальной машины Azure.
ms.topic: troubleshooting
ms.date: 07/12/2020
ms.openlocfilehash: bd369577e320cf6dca510183948f41e6cf91779b
ms.sourcegitcommit: e15c0bc8c63ab3b696e9e32999ef0abc694c7c41
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2020
ms.locfileid: "97605298"
---
# <a name="troubleshooting-issues-in-file-recovery-of-azure-vm-backup"></a>Устранение неполадок при восстановлении файлов резервной копии виртуальных машин Azure

В этой статье содержатся инструкции по устранению неполадок, связанных с Azure Backup ошибок при восстановлении файлов и папок из резервной копии виртуальной машины Azure.

## <a name="common-error-messages"></a>Распространенные сообщения об ошибках

### <a name="exception-caught-while-connecting-to-target"></a>Перехвачено исключение при подключении к целевому объекту

**Возможная причина**: скрипт не может получить доступ к точке восстановления.

**Рекомендуемое действие**: Проверьте, удовлетворяет ли компьютер всем [требованиям доступа](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-4-access-requirements-to-successfully-run-the-script).

### <a name="the-target-has-already-been-logged-in-via-an-iscsi-session"></a>Целевой объект уже вошел в систему через сеанс iSCSI

**Возможная причина**: сценарий уже был выполнен на том же компьютере, а диски подключены.

**Рекомендуемое действие**: тома точки восстановления уже подключены. Они могут быть не подключены к одной и той же букве диска исходной виртуальной машины. Просмотрите все доступные тома в проводнике.

### <a name="this-script-is-invalid-because-the-disks-have-been-dismounted-via-portalexceeded-the-12-hr-limit-download-a-new-script-from-the-portal"></a>This script is invalid because the disks have been dismounted via portal/exceeded the 12-hr limit. Скачать новый скрипт с портала

**Возможная причина**: диски были отключены от портала или превышено 12-часовое ограничение.

**Рекомендуемое действие**: Скрипт недействителен через 12 часов с момента его скачивания и не может быть выполнен. Посетите портал и Скачайте новый скрипт, чтобы продолжить восстановление файлов.

## <a name="troubleshooting-common-scenarios"></a>Распространенные сценарии устранения неполадок

В этом разделе приводятся инструкции по устранению неполадок, которые могут возникнуть при скачивании и выполнении скрипта для восстановления файлов.

### <a name="cant-download-the-script"></a>Не удается скачать скрипт

Рекомендуемое действие:

1. Убедитесь, что у вас есть все [необходимые разрешения для скачивания скрипта](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#select-recovery-point-who-can-generate-script).
1. Убедитесь в наличии подключения к целевым IP-адресам Azure.

Чтобы проверить подключение, выполните одну из следующих команд из командной строки с повышенными привилегиями.

`nslookup download.microsoft.com`

или диспетчер конфигурации служб

`ping download.microsoft.com`

### <a name="the-script-downloads-successfully-but-fails-to-run"></a>Сценарий успешно скачивается, но не запускается

#### <a name="for-sles-12-sp4-os-linux"></a>Для ОС SLES 12 SP4 (Linux)

**Ошибка**: iscsi_tcp_module не найден

**Возможная причина**: при выполнении скрипта Python для восстановления на уровне элементов (ILR) в SuSE Linux OS Version 12sp4 происходит сбой с ошибкой **_iscsi_tcp не удается загрузить модуль_* _.

Модуль ILR использует _ *iscsi_tcp** для установления TCP-подключения к службе резервного копирования. В рамках 12SP4 выпуска SUSE удалил **iscsi_tcp** из пакета Open-iSCSI, поэтому операция ILR завершается сбоем.

**Рекомендуемое действие**: выполнение скрипта восстановления файлов не поддерживается на виртуальных МАШИНАХ SUSE 12SP4. Попробуйте выполнить операцию восстановления в более старой версии SUSE 12SP4.

### <a name="the-script-runs-but-connection-to-iscsi-target-failed"></a>Скрипт выполняется, но подключение к целевому объекту iSCSI завершилось сбоем

**Ошибка**: при подключении к целевому объекту перехвачено исключение

1. Убедитесь, что компьютер, на котором выполняется сценарий, соответствует всем [требованиям доступа](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-4-access-requirements-to-successfully-run-the-script).
1. Проверьте подключение к целевым IP-адресам Azure.
Чтобы проверить подключение, выполните одну из следующих команд из командной строки с повышенными привилегиями.

   `nslookup download.microsoft.com`

   или диспетчер конфигурации служб

   `ping download.microsoft.com`
1. Убедитесь в наличии доступа к исходящему порту iSCSI 3260.
1. Убедитесь, что отсутствует брандмауэр или NSG, блокирующий трафик на целевые IP-адреса Azure или URL службы восстановления.
1. Убедитесь, что антивирусная программа блокирует выполнение скрипта.

### <a name="connected-to-recovery-point-but-disks-didnt-get-attached"></a>Подключено к точке восстановления, но диски не подключены

Убедитесь, что у вас есть [правильный компьютер для выполнения сценария](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script) .

#### <a name="on-a-windows-vm"></a>На виртуальной машине Windows

**Пул носителей на виртуальной машине подключен в режиме только для чтения**: в Windows 2012 R2 и Windows 2016 (с пулами носителей) при первом запуске сценария пул носителей, подключенный к виртуальной машине, может переключиться в состояние "только для чтения".

Чтобы устранить эту проблему, необходимо вручную задать Read-Write доступ к пулу носителей в первый раз и подключить виртуальные диски. Выполните инструкции, описанные ниже.

1. Задайте Read-Write доступа.

   Перейдите в раздел **Диспетчер сервера**  >  **файл и службы хранилища**  >  **тома**  >  **Пулы носителей**.

   ![Хранилище Windows](./media/backup-azure-restore-files-from-vm/windows-storage-1.png)

1. В окне **пул носителей** щелкните правой кнопкой мыши доступный пул носителей и выберите пункт **задать Read-Write доступа** .

   ![Чтение и запись в хранилище Windows](./media/backup-azure-restore-files-from-vm/windows-storage-read-write-2.png)

1. После назначения пула носителей с доступом на чтение и запись Подключите виртуальный диск.

   Перейдите к **Диспетчер сервера пользовательскому интерфейсу**. В разделе **Виртуальные диски** > щелкните правой кнопкой мыши, чтобы выбрать параметр **присоединить виртуальный диск** .

   ![Виртуальный диск диспетчера сервера](./media/backup-azure-restore-files-from-vm/server-manager-virtual-disk-3.png)

#### <a name="on-a-linux-vm"></a>На виртуальной машине Linux

##### <a name="file-recovery-fails-to-auto-mount-because-disk-doesnt-contain-volumes"></a>Восстановлению файла не удается выполнить автоматическое подключение, так как диск не содержит томов

При восстановлении файлов служба резервного копирования обнаруживает тома и выполняет Автоподключение. Однако если резервные диски имеют необработанные разделы, то эти диски не будут выключаться с помощью автоподключения, и диск данных не будет отображаться для восстановления.

Чтобы решить эту проблему, выполните действия, описанные в этой [статье](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#lvmraid-arrays-for-linux-vms).

##### <a name="the-os-couldnt-identify-the-filesystem-causing-linux-file-recovery-to-fail-while-mountings-disks"></a>Операционной системе не удалось опознать файловую систему, вызывающую сбой восстановления файлов Linux при подключении дисков

При выполнении скрипта восстановления файла не удалось подключиться к диску данных со следующей ошибкой:

"Не удалось подключить следующие секции, так как ОС не удалось опознать файловую систему"

Чтобы устранить эту проблему, проверьте, зашифрован ли том с помощью приложения стороннего производителя. Если он зашифрован, то диск или виртуальная машина не будут отображаться на портале как зашифрованные.

1. Войдите на виртуальную машину с резервным копированием и выполните команду:

   `*lsblk -f*`

   ![Диск без тома](./media/backup-azure-restore-files-from-vm/disk-without-volume-5.png)

2. Проверьте файловую систему и шифрование.
3. Если том зашифрован, восстановление файлов не поддерживается. [Дополнительные сведения](https://docs.microsoft.com/azure/backup/backup-support-matrix-iaas#support-for-file-level-restore).

### <a name="disks-are-attached-but-unable-to-mount-volumes"></a>Диски подключены, но не удается подключить тома

- Убедитесь, что у вас есть [правильный компьютер для выполнения скрипта](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script).

#### <a name="on-windows-vms"></a>На виртуальных машинах Windows

При выполнении скрипта восстановления файлов для Windows появляется сообщение о том, что **подключено * 0 томов** _. Однако диски обнаруживаются в консоли управления дисками. При подключении томов через iSCSI некоторые обнаруженные тома переходят в состояние вне сети. Когда канал iSCSI обменивается данными между виртуальной машиной и службой, он обнаруживает эти тома и переводит их в режим «в сети», но не монтирует их.

   ![Диск не подключен](./media/backup-azure-restore-files-from-vm/disk-not-attached-6.png)

Чтобы определить и устранить эту проблему, выполните следующие действия.

1. Перейдите в раздел _ *Disk Management**, выполнив команду **diskmgmt** в окне cmd.
1. Проверьте, отображаются ли дополнительные диски. В следующем примере диск 2 является дополнительным диском.

   ![Диск management0](./media/backup-azure-restore-files-from-vm/disk-management-7.png)

1. Щелкните правой кнопкой мыши **новый том** и выберите команду **изменить букву диска и пути**.

   ![Диск management1](./media/backup-azure-restore-files-from-vm/disk-management-8.png)

1. В окне **добавить букву диска или путь** выберите **назначить следующую букву диска** и назначить доступный диск и нажмите кнопку **ОК**.

   ![Диск management2](./media/backup-azure-restore-files-from-vm/disk-management-9.png)

1. В проводнике Просмотрите выбранную букву диска и изучите файлы.

#### <a name="on-linux-vms"></a>На виртуальных машинах Linux

- Убедитесь, что у вас есть [правильный компьютер для выполнения скрипта](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#step-2-ensure-the-machine-meets-the-requirements-before-executing-the-script).
- Если защищенная виртуальная машина Linux использует массивы LVM или RAID, выполните действия, описанные в этой [статье](https://docs.microsoft.com/azure/backup/backup-azure-restore-files-from-vm#lvmraid-arrays-for-linux-vms).

### <a name="cant-copy-the-files-from-mounted-volumes"></a>Не удается скопировать файлы из подключенных томов

Копирование может завершиться ошибкой с ошибкой **0x80070780: файл недоступен системе.** В этом случае проверьте, включена ли Дедупликация дисков на исходном сервере. Затем убедитесь, что на дисках также включено Дедупликация на сервере восстановления. Вы можете оставить роль дедупликации ненастроенной, чтобы не дублировать диски на сервере восстановления.

## <a name="next-steps"></a>Дальнейшие действия

- [Восстановление файлов и папок из резервной копии виртуальной машины Azure](backup-azure-restore-files-from-vm.md)
