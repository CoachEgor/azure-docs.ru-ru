---
title: Автономная архивация с помощью Azure Data Box
description: Узнайте, как использовать Azure Data Box для заполнения данных большого объема начальной архивации в автономном режиме от агента MARS до хранилища служб восстановления Azure.
ms.topic: conceptual
ms.date: 1/27/2020
ms.openlocfilehash: 553939df8aa7a1b097b2cd6c7f29365302101324
ms.sourcegitcommit: 21e33a0f3fda25c91e7670666c601ae3d422fb9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2020
ms.locfileid: "77027034"
---
# <a name="azure-backup-offline-backup-using-azure-data-box"></a>Azure Backup автономного резервного копирования с помощью Azure Data Box

Вы можете использовать службу [Azure Data Box](https://docs.microsoft.com/azure/databox/data-box-overview) для заполнения больших первоначальных резервных копий MARS в автономном режиме (без использования сети) в хранилище служб восстановления Azure.  Это экономит время и пропускную способность сети, которые в противном случае использовались для перемещения больших объемов данных резервных копий через сеть с высокой задержкой. Это усовершенствование сейчас находится на этапе предварительной версии. Автономная резервная копия на основе Azure Data Box предоставляет два разных преимущества по сравнению с [автономным резервным копированием на основе службы импорта и экспорта Azure](https://docs.microsoft.com/azure/backup/backup-azure-backup-import-export).

1. Нет необходимости в приобретении собственных дисков и соединителей, совместимых с Azure. Azure Data Box служба поставляет диски, связанные с выбранным [номером SKU Data Box](https://azure.microsoft.com/services/databox/data/)

2. Azure Backup (агент MARS) может напрямую записывать данные резервных копий на поддерживаемые номера SKU Azure Data Box. Это устраняет необходимость в подготовке промежуточного расположения для исходных данных резервного копирования и необходимости для служебных программ форматировать и копировать эти данные на диски.

## <a name="azure-data-box-with-mars-agent"></a>Azure Data Box с агентом MARS

В этой статье объясняется, как можно использовать Azure Data Box для заполнения данных большого объема начальной архивации в автономном режиме от агента MARS до хранилища служб восстановления Azure. Статья состоит из следующих частей:

* Поддерживаемые платформы
* Поддерживаемые номера SKU Data Box
* Технические условия
* Настройка агента MARS
* Azure Data Box установки
* Перенос данных резервной копии в Azure Data Box
* Действия, выполняемые после резервного копирования

## <a name="supported-platforms"></a>Поддерживаемые платформы

Процесс заполнения данных от агента MARS с помощью Azure Data Box поддерживается в следующих SKU Windows:

| **ОС**                                 | **SKU**                                                      |
| -------------------------------------- | ------------------------------------------------------------ |
| **Рабочая**                        |                                                              |
| Windows 10 64, бит                     | Enterprise, Pro, Главная                                       |
| Windows 8.1 64 бит                    | Enterprise, Pro                                             |
| Windows 8 64, бит                      | Enterprise, Pro                                             |
| Windows 7 64, бит                      | Максимальная, Корпоративная, профессиональная, Домашняя расширенная, Домашняя базовая, начальная |
| **Server**                             |                                                              |
| Windows Server 2019 64, бит            | Standard, Datacenter, Essentials                            |
| Windows Server 2016 64, бит            | Standard, Datacenter, Essentials                            |
| Windows Server 2012 R2 64 bit         | Standard, Datacenter, Foundation                            |
| Windows Server 2012 64, бит            | Datacenter, Foundation, Standard                            |
| Windows Storage Server 2016 64, бит    | Standard, Workgroup                                         |
| Windows Storage Server 2012 R2 64, бит | Standard, Workgroup, важнейшее                              |
| Windows Storage Server 2012 64, бит    | Standard, Workgroup                                         |
| Windows Server 2008 R2 SP1 64 bit     | Standard, Enterprise, Datacenter, Foundation                |
| Windows Server 2008 с пакетом обновления 2 (SP2) 64        | Standard, Enterprise, Datacenter                            |

## <a name="backup-data-size-and-supported-data-box-skus"></a>Размер данных резервной копии и поддерживаемые номера SKU Data Box

| Размер данных резервной копии (после сжатия в режиме MARS) * на сервер | Поддерживаемый номер SKU Azure Data Box                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| < = 7,2 ТБ                                                    | [Диск Azure Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-overview) |
| > 7,2 ТБ и < = 80 ТБ * *                                      | [Azure Data Box (100 ТБ)](https://docs.microsoft.com/azure/databox/data-box-overview) |

\* Стандартные скорости сжатия зависят от 10-20% <br>
\* * Вы можете связаться с [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com) , если вы планируете использовать более 80 ТБ начальных резервных копий данных для одного сервера MARS.

>[!IMPORTANT]
>Начальные данные резервного копирования с одного сервера должны содержаться в одном Azure Data Box или Диск Azure Data Box и не могут совместно использоваться несколькими устройствами одного или разных номеров SKU. Однако Azure Data Box устройство может содержать начальные резервные копии с нескольких серверов.

## <a name="pre-requisites"></a>Технические условия

### <a name="azure-subscription-and-required-permissions"></a>Подписка Azure и необходимые разрешения

* Для процесса требуется подписка Azure
* Для этого процесса требуется, чтобы пользователь, предназначенный для выполнения политики автономного резервного копирования, был владельцем подписки Azure.
* Задание Data Box и хранилище служб восстановления (в которых данные должны быть заполнены) должны находиться в одной и той же подписке.
* Рекомендуется, чтобы Целевая учетная запись хранения, связанная с заданием Azure Data Box и хранилищем служб восстановления, была в одном регионе. Однако это необязательно.

### <a name="get-azure-powershell-370"></a>Получение Azure PowerShell 3.7.0

**Это наиболее важный компонент, необходимый для процесса**. Перед установкой Azure PowerShell (ver. 3.7.0), выполните следующие проверки * *

#### <a name="step-1-check-powershell-version"></a>Шаг 1. Проверка версии PowerShell

* Откройте Windows PowerShell и выполните следующую команду:

    ```powershell
    Get-Module -ListAvailable AzureRM*
    ```

* Если выходные данные отображают версию, превышающую **3.7.0**, выполните шаг 2 ниже. В противном случае перейдите к шагу 3.

#### <a name="step-2-uninstall-the-powershell-version"></a>Шаг 2. Удаление версии PowerShell

Удалите текущую версию PowerShell, выполнив следующие действия.

* Удалите зависимые модули, выполнив следующую команду в PowerShell:

    ```powershell
    foreach ($module in (Get-Module -ListAvailable AzureRM*).Name |Get-Unique)  { write-host "Removing Module $module" Uninstall-module $module }
    ```

* Выполните следующую команду, чтобы убедиться в успешном удалении всех зависимых модулей:

    ```powershell
    Get-Module -ListAvailable AzureRM*
    ```

#### <a name="step-3-install-powershell-version-370"></a>Шаг 3. Установка PowerShell версии 3.7.0

Убедившись, что модули AzureRM отсутствуют, установите версию 3.7.0 одним из следующих способов.

* С сайта GitHub [свяжите](https://github.com/Azure/azure-powershell/releases/tag/v3.7.0-March2017)

ИЛИ

* В окне PowerShell выполните следующую команду:

    ```powershell
    Install-Module -Name AzureRM -RequiredVersion 3.7.0
    ```

Azure PowerShell могли быть также установлены с помощью файла MSI. Чтобы удалить его, удалите его с помощью параметра удаление программ на панели управления.

### <a name="order-and-receive-the-data-box-device"></a>Заказ и получение устройства Data Box

Для процесса автономного резервного копирования с использованием режима MARS и Azure Data Box требуется, чтобы требуемые Data Box устройства направляются в состояние "доставлено" перед активацией автономного резервного копирования с помощью агента MARS. Чтобы заказать наиболее подходящий SKU для вашего требования, см. [сведения о размере данных резервного копирования и поддерживаемых Data Box SKU](#backup-data-size-and-supported-data-box-skus) . Выполните действия, описанные в [этой статье](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-ordered) , чтобы заказать и получить устройства Data Box.

>[!IMPORTANT]
>Не выбирайте Блобстораже для типа учетной записи. Агенту MARS требуется учетная запись, которая поддерживает страничные BLOB-объекты, которые не поддерживаются при выборе Блобстораже. Мы настоятельно рекомендуем выбрать *хранилище версии 2* (*общего назначения версии 2*) в качестве вида учетной записи при создании целевой учетной записи хранения для задания Azure Data Box.

![Выбор типа учетной записи в сведениях об экземпляре](./media/offline-backup-azure-data-box/instance-details.png)

## <a name="install-and-setup-the-mars-agent"></a>Установка и настройка агента MARS

* Убедитесь, что удалены все предыдущие установки агента MARS.

* Скачайте последнюю версию агента MARS отсюда [.](https://aka.ms/azurebackup_agent)

* Запустите *файл marsagentinstaller. exe* и выполните ***только** шаги для [установки и регистрации агента](https://docs.microsoft.com/azure/backup/backup-configure-vault#install-and-register-the-agent) в хранилище служб восстановления, в котором необходимо хранить резервные копии.

  >[!NOTE]
  > Хранилище служб восстановления должно находиться в той же подписке, что и задание Azure Data Box.

* После регистрации агента в хранилище служб восстановления выполните действия, описанные в следующих разделах.

## <a name="setup-azure-data-box-devices"></a>Установка Azure Data Box устройств

В зависимости от того, какой номер SKU Azure Data Box заказан, выполните действия, описанные в соответствующих разделах ниже, чтобы настроить и подготовить Data Box устройства для агента MARS, чтобы определить и переместить исходные данные резервной копии.

### <a name="setup-azure-data-box-disk"></a>Диск Azure Data Box установки

Если вы заказали один или несколько Azure Data Box дисков (по 8 ТБ), выполните описанные здесь действия, чтобы [распаковать, подключить и разблокировать диск Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-set-up).

>[!NOTE]
>Возможно, сервер с агентом MARS не имеет USB-порта. В этом случае можно подключить Диск Azure Data Box к другому серверу или клиенту и предоставить корневой каталог устройства в качестве общей сетевой папки.

### <a name="setup-azure-data-box"></a>Azure Data Box установки

Если вы заказали Azure Data Box (до 100 ТБ), выполните действия, описанные здесь, [чтобы настроить Data Box](https://docs.microsoft.com/azure/databox/data-box-deploy-set-up).

#### <a name="mount-your-azure-data-box-as-local-system"></a>Подключение Azure Data Box в качестве локальной системы

Агент MARS работает в контексте локальной системы, поэтому для пути подключения, в котором подключена Azure Data Box, требуется такой же уровень привилегий. Выполните следующие действия, чтобы подключить устройство Data Box в качестве локальной системы с помощью протокола NFS.

* Включите функцию клиент для NFS на Windows Server (с установленным агентом MARS).<br>
  Укажите альтернативный источник: *WIM: D: \саурцес\инсталл.Вим: 4*

* Скачайте программу PSExec с <https://download.sysinternals.com/files/PSTools.zip> на сервер с установленным агентом MARS.

* Откройте командную строку с повышенными привилегиями и выполните следующую команду с каталогом, содержащим PSExec. exe в качестве текущего каталога:

    ```cmd
    psexec.exe  -s  -i  cmd.exe
    ```

* Командное окно, открывающееся в результате выполнения приведенной выше команды, находится в контексте локальной системы. Используйте это командное окно, чтобы выполнить действия по подключению общего ресурса страничного BLOB-объекта Azure в качестве сетевого диска на сервере Windows.

* Выполните описанные [здесь](https://docs.microsoft.com/azure/databox/data-box-deploy-copy-data-via-nfs#connect-to-data-box) действия, чтобы подключить сервер с агентом MARS к Data Box устройству через NFS и выполнить следующую команду в командной строке локальной системы, чтобы подключить общую папку BLOB-объектов Azure.

    ```cmd
    mount -o nolock \\<DeviceIPAddress>\<StorageAccountName_PageBlob X:  
    ```

* После подключения проверьте, есть ли доступ к X: с сервера. Если да, перейдите к следующему разделу этой статьи.

## <a name="transfer-initial-backup-data-to-azure-data-box-devices"></a>Перенос данных начального резервного копирования на устройства Azure Data Box

* Откройте приложение **Microsoft Azure Backup** на сервере.

* Щелкните **Расписание архивации** на панели **действия** .

    ![Щелкните расписание архивации](./media/offline-backup-azure-data-box/schedule-backup.png)

* Выполните действия, описанные в **мастере архивации по расписанию** .

* **Добавьте элементы** , чтобы общий размер элементов был в пределах размера, [ПОДДЕРЖИВАЕМОГО Azure Data Box номером SKU](#backup-data-size-and-supported-data-box-skus) , который вы заказали и получили.

    ![Добавление элементов в резервную копию](./media/offline-backup-azure-data-box/add-items.png)

* Выберите подходящее расписание архивации и политику хранения для файлов и папок и состояние системы (состояние системы применимо только для серверов Windows, а не для клиентов Windows).

* На экране **Выбор типа начальной архивации (файлы и папки)** мастера выберите параметр **перемещение с помощью Microsoft Azure Data Box диски** и нажмите кнопку **Далее** .

    ![Выберите тип начальной архивации](./media/offline-backup-azure-data-box/initial-backup-type.png)

* Войдите в Azure при появлении запроса с использованием учетных данных пользователя, имеющих доступ владельца в подписке Azure. После выполнения этой операции вы увидите экран, похожий на следующий:

    ![Создание ресурсов и применение необходимых разрешений](./media/offline-backup-azure-data-box/creating-resources.png)

* Затем агент MARS извлекает задания Data Box в подписке, которая находится в состоянии "доставлено".

    ![Получение заданий датабокс для идентификатора подписки](./media/offline-backup-azure-data-box/fetching-databox-jobs.png)

* Выберите правильный порядок полей данных, для которого был распакован, подключен и разблокирован диск Data Box. Щелкните **Далее**.

    ![Выбор Data Box заказов](./media/offline-backup-azure-data-box/select-databox-order.png)

* Щелкните **обнаружение устройства** на экране **обнаружения устройств Data Box** . Это позволяет агенту MARS проверять локально подключенные Azure Data Box диски и обнаруживать их, как показано ниже:

    ![Обнаружение устройств Data Box](./media/offline-backup-azure-data-box/databox-device-detection.png)

    Если вы подключили Azure Data Box в качестве сетевой папки (из-за недоступности портов USB или если вы заказали и подключили и подключились к 100 ТБ Data Box), обнаружение завершится сбоем, но вы получите возможность ввести сетевой путь к Data Box устройству как ховн ниже:

    ![Введите сетевой путь](./media/offline-backup-azure-data-box/enter-network-path.png)

    >[!IMPORTANT]
    > Укажите сетевой путь к корневому каталогу Azure Data Box диска. Этот каталог должен содержать каталог по имени *PageBlob* , как показано ниже:
    >
    >![Корневой каталог диска Azure Data Box](./media/offline-backup-azure-data-box/root-directory.png)
    >
    >Например, если путь к диску — `\\mydomain\myserver\disk1\` и *disk1* содержит каталог с именем *PageBlob*, то путь, который должен быть указан в мастере агента Mars, будет `\\mydomain\myserver\disk1\`
    >
    >При [установке устройства Azure Data Box 100 ТБ](#setup-azure-data-box)укажите в качестве сетевого пути к устройству следующий сетевой путь `\\<DeviceIPAddress>\<StorageAccountName>_PageBlob`

* Нажмите кнопку **Далее** и кнопку **Готово** на следующем экране, чтобы сохранить резервную копию и политику хранения с конфигурацией автономной резервной копии с помощью Azure Data Box.

* На следующем экране подтвердится, что политика успешно сохранена:

    ![Политика успешно сохранена](./media/offline-backup-azure-data-box/policy-saved.png)

* Нажмите кнопку **Закрыть** на экране выше.

* Щелкните "**создать резервную копию** " на панели " **действия** " консоли агента MARS и щелкните " **создать резервную копию** " на экране мастера, как показано ниже.

    ![Мастер создания моментальных копий](./media/offline-backup-azure-data-box/backup-now.png)

* Агент MARS начнет выполнять резервное копирование данных, выбранных на устройство Azure Data Box. Это может занять от нескольких часов до нескольких дней в зависимости от количества файлов и скорости подключения между сервером с помощью агента MARS и Диск Azure Data Box.

* После завершения резервного копирования данных в агенте MARS появится экран следующего вида:

    ![Ход архивации показан](./media/offline-backup-azure-data-box/backup-progress.png)

## <a name="post-backup-steps"></a>Действия, выполняемые после резервного копирования

В этом разделе описаны шаги, которые необходимо выполнить после успешного резервного копирования данных в Диск Azure Data Box.

* Выполните действия, описанные в этой статье, чтобы [отправить Azure Data Box диск в Azure](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-picked-up). Если вы использовали устройство Azure Data Box 100 ТБ, выполните следующие действия, чтобы [отправить Azure Data Box в Azure](https://docs.microsoft.com/azure/databox/data-box-deploy-picked-up).

* [Отслеживайте задание Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-upload-verify) в портал Azure. После завершения задания Azure Data Box агент MARS автоматически переместит данные из учетной записи хранения в хранилище служб восстановления во время следующего запланированного резервного копирования. После этого задание резервного копирования будет отмечено как "Задание завершено", если точка восстановления создана успешно.

    >[!NOTE]
    >Агент MARS запустит резервное копирование в запланированное время создания политики. Однако эти задания помечают "ожидание завершения задания Azure Data Box" до момента завершения задания.

* После того как агент MARS успешно создаст точку восстановления, соответствующую первоначальной резервной копии, вы можете удалить учетную запись хранения (или конкретное содержимое), связанную с заданием Azure Data Box.

## <a name="troubleshooting"></a>Устранение неисправностей

Агент Microsoft Azure Backup (MAB) создает в клиенте приложение Azure AD. Для этого приложения требуется сертификат для проверки подлинности, который создается и передается при настройке политики заполнения в автономном режиме. Для создания и отправки сертификата в приложение Azure AD используется Azure PowerShell.

### <a name="issue"></a>Проблема

Во время настройки автономной резервной копии вы можете столкнуться с проблемой, когда из-за ошибки в командлете Azure PowerShell вы не можете добавить несколько сертификатов в одно приложение Azure AD, созданное агентом MAB. Это повлияет на то, что вы настроили политику автономного заполнения для того же или другого сервера.

### <a name="how-to-verify-if-the-issue-is-caused-by-this-specific-root-cause"></a>Как проверить, вызвана ли проблема указанной основной причиной

Чтобы убедиться, что ошибка вызвана описанной выше проблемой, выполните одно из следующих действий.

#### <a name="step-1"></a>Шаг 1

Проверьте, отображается ли следующее сообщение об ошибке в консоли MAB во время настройки автономной архивации:

![Не удалось создать политику автономного резервного копирования для текущей учетной записи Azure](./media/offline-backup-azure-data-box/unable-to-create-policy.png)

#### <a name="step-2"></a>Шаг 2

* Откройте папку **TEMP** в пути установки (путь к временной папке по умолчанию — *C:\Program Files\Microsoft Azure Recovery Services ажент\темп*). Найдите файл **кбуикурр** и откройте его.

* В файле **кбуикурр** прокрутите до последней строки и проверьте, не является ли причиной сбоя `Unable to create an Azure AD application credential in customer's account. Exception: Update to existing credential with KeyId <some guid> is not allowed`.

### <a name="workaround"></a>Обходной путь

Чтобы решить эту проблему, выполните следующие действия и повторите настройку политики.

#### <a name="first-step"></a>Первый шаг

Войдите в PowerShell, который появится в пользовательском интерфейсе MAB, используя другую учетную запись с правами администратора для подписки, которая будет создавать задание импорта экспорта.

#### <a name="second-step"></a>Второй шаг

Если на другом сервере не настроено автономное заполнение, а другие серверы не зависят от `AzureOfflineBackup_<Azure User Id>` приложения, удалите это приложение из **портал Azure** > **Azure Active Directory** > регистрация приложений **.**

>[!NOTE]
> Проверьте, не настроено ли в `AzureOfflineBackup_<Azure User Id>` приложений другое начальное заполнение, а также не зависит никакой другой сервер от этого приложения. Перейдите в раздел **параметры** > **ключи** в разделе **открытые ключи** , для которого не должны быть добавлены другие открытые ключи. Справочные сведения см. на следующем снимке экрана:
>
>![Открытые ключи](./media/offline-backup-azure-data-box/public-keys.png)

#### <a name="third-step"></a>Третий шаг

На сервере, на котором вы пытаетесь настроить автономную архивацию, выполните следующие действия.

1. Откройте **приложение "Управление сертификатом компьютера** > **личное** " и найдите сертификат с именем `CB_AzureADCertforOfflineSeeding_<ResourceId>`

2. Выберите указанный выше сертификат, щелкните правой кнопкой мыши **все задачи** и **экспортируйте** без закрытого ключа в формате CER.

3. Перейдите в приложение автономного резервного копирования Azure, упомянутое в **точке 2**. В разделе **параметры** > **ключи** > **отправить открытый ключ,** Передайте сертификат, экспортированный на предыдущем шаге.

    ![Отправить открытый ключ](./media/offline-backup-azure-data-box/upload-public-key.png)

4. На сервере откройте реестр, введя в окне выполнения команду **regedit** .

5. Перейдите к разделу реестра *Computer \ HKEY_LOCAL_MACHINE \Софтваре\микрософт\виндовс Azure баккуп\конфиг\клаудбаккуппровидер.* Щелкните правой кнопкой мыши **клаудбаккуппровидер** и добавьте новое строковое значение с именем `AzureADAppCertThumbprint_<Azure User Id>`

    >[!NOTE]
    > Чтобы получить идентификатор пользователя Azure, выполните одно из следующих действий.
    >
    >1. В PowerShell, подключенном к Azure, выполните команду `Get-AzureRmADUser -UserPrincipalName “Account Holder’s email as defined in the portal”`.
    > 2. Перейдите к пути реестра: *Computer \ HKEY_LOCAL_MACHINE \Софтваре\микрософт\виндовс Azure баккуп\дбгсеттингс\онлинебаккуп*; Имя: *куррентусерид*

6. Щелкните строку, добавленную на шаге выше, правой кнопкой мыши и выберите пункт **изменить**. В поле значение укажите отпечаток сертификата, экспортированного в **точке 2** , и нажмите кнопку **ОК**.

7. Чтобы получить значение отпечатка, дважды щелкните сертификат, а затем выберите вкладку **сведения** и прокрутите вниз, пока не отобразится поле отпечаток. Щелкните **отпечаток** и скопируйте значение.

    ![Поле отпечатка сертификата](./media/offline-backup-azure-data-box/thumbprint-field.png)

## <a name="questions"></a>Вопросы

Для получения любых вопросов и уточнений в отношении любых проблем, с которыми столкнулось, можно обратиться к [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com)
