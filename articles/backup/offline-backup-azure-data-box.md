---
title: Резервное копирование в автономном режиме с помощью ящика данных Azure
description: Узнайте, как можно использовать пазданный Data Box для создания больших исходных данных резервного копирования в автономном режиме от агента MARS до хранилища служб восстановления.
ms.topic: conceptual
ms.date: 1/27/2020
ms.openlocfilehash: a031a8cac357e7d212f8f6a3a5dbec749fbccc21
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78672965"
---
# <a name="azure-backup-offline-backup-by-using-azure-data-box"></a>Резервное копирование в автономном режиме Azure с помощью ящика данных Azure

Вы можете использовать [паз данных Azure Box](https://docs.microsoft.com/azure/databox/data-box-overview) для создания больших первоначальных резервных отставок Microsoft Azure Recovery Services (MARS) в автономном режиме (без использования сети) в хранилище служб восстановления. Этот процесс экономит время и пропускную способность сети, которые в противном случае были бы использованы перемещения больших объемов данных резервного копирования в Интернете по сети с высокой задержкой. Это усовершенствование в настоящее время в предварительном просмотре. Резервное копирование в автономном режиме на основе Azure Data Box обеспечивает два явных преимущества по сравнению с [автономным резервным копированием на основе службы импорта/экспорта Azure:](https://docs.microsoft.com/azure/backup/backup-azure-backup-import-export)

* Нет необходимости закупать собственные диски и разъемы, совместимые с Azure. Azure Data Box отправляет диски, связанные с выбранным [SKU Box Data.](https://azure.microsoft.com/services/databox/data/)
* Резервное копирование Azure (агент MARS) может напрямую записывать данные резервного копирования на поддерживаемые SRU Box данных Azure. Эта возможность устраняет необходимость предоставления местоположения для исходных данных резервного копирования. Вам также не нужны утилиты для формата и копирования этих данных на диски.

## <a name="azure-data-box-with-the-mars-agent"></a>Лазурный ящик данных с агентом MARS

В этой статье объясняется, как можно использовать пазданный данных Azure Box для создания больших исходных данных резервного копирования в автономном режиме от агента MARS до хранилища служб восстановления.

## <a name="supported-platforms"></a>Поддерживаемые платформы

Процесс сбора данных от агента MARS с помощью Azure Data Box поддерживается на следующих SKUS Windows.

| **Os**                                 | **номер SKU**                                                      |
| -------------------------------------- | ------------------------------------------------------------ |
| **Рабочей станции**                        |                                                              |
| Windows 10, 64-разрядная версия                     | Корпоративная, Профессиональная, Домашняя                                       |
| Windows 8.1, 64-разрядная версия                    | Корпоративная, Профессиональная                                             |
| Windows 8, 64-разрядная версия                      | Корпоративная, Профессиональная                                             |
| Windows 7, 64-разрядная версия                      | Максимальная, Корпоративная, Профессиональная, Домашняя расширенная, Домашняя базовая, Начальная |
| **Сервер**                             |                                                              |
| Windows Server 2019, 64-разрядная версия            | Standard, Datacenter, Essentials                            |
| Windows Server 2016, 64-разрядная версия            | Standard, Datacenter, Essentials                            |
| Windows Server 2012 R2, 64-разрядная версия         | Standard, Datacenter, Foundation                            |
| Windows Server 2012, 64-разрядная версия            | Datacenter, Foundation, Standard                            |
| Windows Storage Server 2016, 64-разрядная версия    | Standard, Workgroup                                         |
| Windows Storage Server 2012 R2, 64-разрядная версия | Standard, Workgroup, Essential                              |
| Windows Storage Server 2012, 64-разрядная версия    | Standard, Workgroup                                         |
| Windows Server 2008 R2 с пакетом обновления 1, 64-разрядная версия     | Standard, Enterprise, Datacenter, Foundation                |
| Windows Server 2008 SP2 64 бит        | Standard, Enterprise, Datacenter                            |

## <a name="backup-data-size-and-supported-data-box-skus"></a>Размер резервного копирования данных и поддерживаемые SKUS Box

| Размер данных резервного копирования (после сжатия MARS) на сервере | Поддерживаемый SKU Box данных Azure                                      |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <7,2 ТБ                                                    | [Диск Azure Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-overview) |
| >7,2 ТБ и <                                      | [Коробка данных Azure (100 ТБ)](https://docs.microsoft.com/azure/databox/data-box-overview) |

«Типичные показатели сжатия варьируются от 10% до 20%. <br>
Если вы ожидаете иметь более 80 ТБ исходных данных резервного копирования для одного сервера MARS, свяжитесь с нами. [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com)

>[!IMPORTANT]
>Первоначальные данные резервного копирования с одного сервера должны содержаться в одном экземпляре Azure Data Box или диске Azure Data Box и не могут быть общими между несколькими устройствами одного или одного или разного SKUs. Но устройство Azure Data Box может содержать исходные резервные отсутсвия с нескольких серверов.

## <a name="prerequisites"></a>Предварительные требования

### <a name="azure-subscription-and-required-permissions"></a>Подписка Azure и необходимые разрешения

* Для этого процесса требуется подписка Azure.
* Процесс требует, чтобы пользователь, назначенный для выполнения политики резервного копирования в автономном режиме, был владельцем подписки Azure.
* Задание Box data и хранилище служб восстановления (к которому необходимо засеять данные) должны быть в одних и тех же подписках.
* Мы рекомендуем, чтобы учетная запись целевого хранилища, связанная с заданием Коробки данных Azure и хранилищем служб восстановления, была в одном регионе. Однако в этом нет необходимости.

### <a name="get-azure-powershell-370"></a>Получить Azure PowerShell 3.7.0

*Это самое важное условие для процесса.* Перед установкой Azure PowerShell, версия 3.7.0, выполнить следующие проверки.

#### <a name="step-1-check-the-powershell-version"></a>Шаг 1: Проверьте версию PowerShell

1. Откройте Windows PowerShell и запустите следующую команду:

    ```powershell
    Get-Module -ListAvailable AzureRM*
    ```

1.  Если на выходе отображается версия выше 3.7.0, сделайте "Шаг 2". В противном случае перейдите к "Шаг у".

#### <a name="step-2-uninstall-the-powershell-version"></a>Шаг 2: Удалите версию PowerShell

Удалите текущую версию PowerShell.

1. Удалите зависимые модули, запустив следующую команду в PowerShell:

    ```powershell
    foreach ($module in (Get-Module -ListAvailable AzureRM*).Name |Get-Unique)  { write-host "Removing Module $module" Uninstall-module $module }
    ```

2. Для обеспечения успешного удаления всех зависимых модулей запустите следующую команду:

    ```powershell
    Get-Module -ListAvailable AzureRM*
    ```

#### <a name="step-3-install-powershell-version-370"></a>Шаг 3: Установить PowerShell версия 3.7.0

После проверки отсутствия модулей AzureRM установите версию 3.7.0 с помощью одного из следующих методов:

* От GitHub, используйте [эту ссылку](https://github.com/Azure/azure-powershell/releases/tag/v3.7.0-March2017).

Также вы можете:

* Выполнить следующую команду в окне PowerShell:

    ```powershell
    Install-Module -Name AzureRM -RequiredVersion 3.7.0
    ```

Azure PowerShell также могла быть установлена с помощью файла msi. Чтобы удалить его, удалите его с помощью опции **программы Uninstall** в панели управления.

### <a name="order-and-receive-the-data-box-device"></a>Заказать и получить устройство Box данных

Процесс резервного копирования в автономном режиме с использованием MARS и Azure Data Box требует, чтобы устройства Data Box были в состоянии доставлены, прежде чем вызвать резервное копирование в автономном режиме с помощью агента MARS. Чтобы заказать наиболее подходящий [Backup data size and supported Data Box SKUs](#backup-data-size-and-supported-data-box-skus)SKU для вашего требования, см. Выполните последующие действия в [учебном центре: Закажите диск Azure Data Box](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-ordered) для заказа и получения устройств Data Box.

> [!IMPORTANT]
> Не выбирайте *BlobStorage* для **вида учетной записи.** Агенту MARS требуется учетная запись, поддерживающая капли страницы, которая не поддерживается при выборе *BlobStorage.* Выберите **Хранилище V2 (общее назначение v2)** в качестве **вида учетной записи** при создании учетной записи целевого хранилища для задания Azure Data Box.

![Выберите вид учетной записи в деталях экземпляра](./media/offline-backup-azure-data-box/instance-details.png)

## <a name="install-and-set-up-the-mars-agent"></a>Установка и настройка агента MARS

1. Убедитесь, что вы удалите любые предыдущие установки агента MARS.
1. Скачать последние АГЕНТ MARS с [этого сайта](https://aka.ms/azurebackup_agent).
1. Выполнить *MARSAgentInstaller.exe*и сделать *только* шаги, чтобы [установить и зарегистрировать агента в](https://docs.microsoft.com/azure/backup/install-mars-agent#install-and-register-the-agent) хранилище служб восстановления, где вы хотите, чтобы ваши резервные записи для хранения.

   > [!NOTE]
   > Хранилище служб восстановления должно быть в той же подписке, что и задание коробки данных Azure.

   После регистрации агента в хранилище служб восстановления выполните следующие действия в следующих разделах.

## <a name="set-up-azure-data-box-devices"></a>Настройка устройств Ящик данных Azure

В зависимости от заказанного SKU Box Azure, выполняемого в соответствующих разделах, выполняйте следующие шаги. На этих шагах будет уотествовать, как настроить и подготовить устройства Box данных для агента MARS для идентификации и передачи исходных данных резервного копирования.

### <a name="set-up-azure-data-box-disks"></a>Настройка дисков Ящика данных Azure

Если вы заказали один или несколько дисков Azure Data Box (до 8 ТБ каждый), выполните упомянутые здесь шаги, чтобы [распаковать, подключить и разблокировать диск Box данных.](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-set-up)

>[!NOTE]
>Возможно, что сервер с агентом MARS не имеет порта USB. В этой ситуации можно подключить диск Azure Data Box к другому серверу или клиенту и предоставить корень устройства в виде сетевой доли.

### <a name="set-up-azure-data-box"></a>Настройка ящика данных Azure

Если вы заказали экземпляр Azure Data Box (до 100 ТБ), выполните последующие действия, [чтобы настроить экземпляр Box данных.](https://docs.microsoft.com/azure/databox/data-box-deploy-set-up)

#### <a name="mount-your-azure-data-box-instance-as-a-local-system"></a>Установите экземпляр ящика данных Azure в качестве локальной системы

Агент MARS работает в контексте локальной системы, поэтому он требует того же уровня привилегий, который должен быть предоставлен траектории крепления, где связан экземпляр Azure Data Box. 

Чтобы убедиться, что устройство Box с вашей даты в качестве локальной системы с помощью протокола NFS:

1. Включите клиент для функции NFS на сервере Windows, который установлен агент MARS. Укажите альтернативный источник *WIM:D:'Источники.Install.wim:4*.
1. Скачать PSExec с <https://download.sysinternals.com/files/PSTools.zip> сервера с mars Agent установлен.
1. Откройте поднятую команду и запустите следующую команду с каталогом, содержащим *PSExec.exe* в качестве текущего каталога.

    ```cmd
    psexec.exe  -s  -i  cmd.exe
    ```

   Окно команды, открываемые в результате предыдущей команды, находится в контексте локальной системы. Используйте это окно команды для выполнения шагов для установки общего использования кабы страницaz Azure в качестве сетевого диска на сервере Windows.
1. Выполните последующие действия в [Connect to Data Box,](https://docs.microsoft.com/azure/databox/data-box-deploy-copy-data-via-nfs#connect-to-data-box) чтобы подключить сервер с агентом MARS к устройству Data Box через NFS. Выполнить следующую команду в команде локальной системы, чтобы смонтировать общую часть страницы Azure.

    ```cmd
    mount -o nolock \\<DeviceIPAddress>\<StorageAccountName_PageBlob X:  
    ```

   После того, как доля установлена, проверьте, можете ли вы получить доступ к X: с вашего сервера. Если вы можете, продолжить следующий раздел этой статьи.

## <a name="transfer-initial-backup-data-to-azure-data-box-devices"></a>Передача исходных данных резервного копирования на устройства Azure Data Box

1. Откройте приложение **резервного копирования Microsoft Azure** на сервере.
1. На панели **действий** выберите **Резервное копирование расписания.**

    ![Выберите Резервное копирование расписания](./media/offline-backup-azure-data-box/schedule-backup.png)

1. Выполните действия в **Мастере резервного копирования расписания.**

1. Добавьте элементы, выбрав кнопку **Добавить элементы.** Сохраняйте общий размер элементов в [пределах пределов размера, поддерживаемых SKU SKU Data Box,](#backup-data-size-and-supported-data-box-skus) который вы заказали и получили.

    ![Добавление элементов в резервную](./media/offline-backup-azure-data-box/add-items.png)

1. Выберите соответствующий график резервного копирования и политику удержания **файлов и фолдеторов** и **системного состояния.** Состояние системы применимо только к серверам Windows, а не к клиентам Windows.
1. На странице мастера **«Выбрать начальный тип резервного копирования( файлов и фолдеторов)** выберите вариант **«Передача» с помощью дисков Microsoft Azure Data Box** и выберите **следующий.**

    ![Выберите начальный тип резервного копирования](./media/offline-backup-azure-data-box/initial-backup-type.png)

1. Воспринимай сявок в Azure, когда ему будет предложено использовать учетные данные пользователей, которые имеют доступ к подписке «Владелец» в подписке Azure. После того как вам удастся сделать это, вы должны увидеть страницу, которая напоминает эту.

    ![Создание ресурсов и применение необходимых разрешений](./media/offline-backup-azure-data-box/creating-resources.png)

   Затем агент MARS получает задания Box data Box в подписке, находиваемых в состоянии доставки.

    ![Получение заданий Box для идентификатора подписки](./media/offline-backup-azure-data-box/fetching-databox-jobs.png)

1. Выберите правильный заказ Box, для которого вы распаковали, подключили и разблокировали диск Box. Нажмите кнопку **Далее**.

    ![Выберите заказы Box данных](./media/offline-backup-azure-data-box/select-databox-order.png)

1. Выберите **устройство обнаружения** на странице **обнаружения устройств коробки данных.** Это действие делает сканирование агента MARS для локально прикрепленных дисков Коробки данных Azure и обнаруживает их.

    ![Обнаружение устройства коробки данных](./media/offline-backup-azure-data-box/databox-device-detection.png)

    Если вы подключили экземпляр Azure Data Box в качестве доли сети (из-за отсутствия портов USB или из-за того, что вы заказали и установили устройство 100-ТБ, обнаружение сначала не удается. Вам предоставляется возможность войти в сетевой путь к устройству Data Box.

    ![Введите сетевой путь](./media/offline-backup-azure-data-box/enter-network-path.png)

    >[!IMPORTANT]
    > Предоставьте сетевой путь к корневому каталогу диска Azure Data Box. Этот каталог должен содержать каталог под названием *PageBlob.*
    >
    >![Корневой каталог диска Ящик данных Azure](./media/offline-backup-azure-data-box/root-directory.png)
    >
    >Например, если путь диска `\\mydomain\myserver\disk1\` есть и *диск1* содержит каталог под названием *PageBlob,* путь, который вы вводите на странице мастера агента MARS, — это `\\mydomain\myserver\disk1\`путь:
    >
    >При [настройке устройства Azure Data Box 100-TB](#set-up-azure-data-box-devices)введите `\\<DeviceIPAddress>\<StorageAccountName>_PageBlob` сетевой путь к устройству.

1. Выберите **следующий**— и выберите **«Завершение»** на следующей странице, чтобы сохранить политику резервного копирования и удержания с конфигурацией автономного резервного копирования с помощью Azure Data Box.

   Следующая страница подтверждает, что политика успешно сохраняется.

    ![Политика успешно сохраняется](./media/offline-backup-azure-data-box/policy-saved.png)

1. Выберите **Закрытие** на предыдущей странице.

1. Выберите **Back Up Now** в панели **действий** консоли агента MARS. Выберите **резервное копирование** на странице мастера.

    ![Резервное копирование Теперь мастер](./media/offline-backup-azure-data-box/backup-now.png)

Агент MARS начинает резервное копирование выбранных данных на устройстве Azure Data Box. Этот процесс может занять от нескольких часов до нескольких дней. Время зависит от количества файлов и скорости соединения между сервером с агентом MARS и диском Azure Data Box.

После завершения резервного копирования данных вы увидите страницу на агенте MARS, напоминающую эту.

![Отображается прогресс резервного копирования](./media/offline-backup-azure-data-box/backup-progress.png)

## <a name="post-backup-steps"></a>Послерезервные шаги

В этом разделе объясняется шаги, которые необходимо предпринять после успешного резервного копирования данных на диск еде лазурных данных.

* Выполните последующие действия в этой статье, чтобы [отправить диск Azure Data Box в Azure.](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-picked-up) Если вы использовали устройство Azure Data Box 100-TB, выполните следующие действия для [отправки устройства Azure Data Box в Azure.](https://docs.microsoft.com/azure/databox/data-box-deploy-picked-up)

* [Мониторинг задания Box данных](https://docs.microsoft.com/azure/databox/data-box-disk-deploy-upload-verify) на портале Azure. После завершения работы в поле данных Azure агент MARS автоматически перемещает данные из учетной записи хранилища в хранилище служб восстановления во время следующего запланированного резервного копирования. Затем он помечает задание резервного копирования как *завершенное задание,* если точка восстановления успешно создана.

    >[!NOTE]
    >Агент MARS запускает резервные отпор в время, запланированное во время создания политики. Эти задания помечали «Ожидание завершения задания ящика данных Azure» до окончания выполнения задания.

* После успешного создания агента MARS точки восстановления, соответствующей первоначальной резервной копии, можно удалить учетную запись хранения или определенное содержимое, связанное с заданием Azure Data Box.

## <a name="troubleshooting"></a>Устранение неполадок

Агент резервного копирования Microsoft Azure (MAB) создает приложение Azure Active Directory (Azure AD) для вашего клиента. Это приложение требует сертификата для проверки подлинности, который создан и загружен при настройке политики посева в автономном режиме. Мы используем Azure PowerShell для создания и загрузки сертификата в приложение Azure AD.

### <a name="problem"></a>Проблема

При настройке резервного копирования в автономном режиме может возникнуть проблема из-за ошибки в cmdlet Azure PowerShell. Возможно, вы не сможете добавить несколько сертификатов в то же приложение Azure AD, созданное агентом MAB. Эта проблема повлияет на вас, если вы настроили политику автономного посева для того же или другого сервера.

### <a name="verify-if-the-problem-is-caused-by-this-specific-root-cause"></a>Проверить, вызвана ли проблема этой конкретной первопричиной

Чтобы увидеть, если ваша проблема такая же, как ранее описанная, сделайте один из следующих шагов.

#### <a name="step-1"></a>Шаг 1

Проверьте, отображается ли следующее сообщение об ошибке в консоли MAB при настройке резервного копирования в автономном режиме.

![Невозможно создать политику резервного копирования в автономном режиме для текущей учетной записи Azure](./media/offline-backup-azure-data-box/unable-to-create-policy.png)

#### <a name="step-2"></a>Шаг 2

1. Откройте папку **Temp** в пути установки. Путь папки временного по умолчанию — *C:«Файлы программы »Агент служб восстановления Azure Microsoft* Ищите файл *CBUICurr* и откройте файл.

1. В файле *CBUICurr* прокрутите до последней строки и проверьте, не `Unable to create an Azure AD application credential in customer's account. Exception: Update to existing credential with KeyId <some guid> is not allowed`является ли проблема такой же, как в этом сообщении об ошибке: .

### <a name="workaround"></a>Обходной путь

В качестве обходного решения этой проблемы сделайте следующие шаги и повторно остарайте конфигурацию политики.

#### <a name="step-1"></a>Шаг 1

Восвай в PowerShell, который появляется на UI MAB, используя другую учетную запись с доступом к аминру по подписке, которая будет создавать работу по импорту или экспорту.

#### <a name="step-2"></a>Шаг 2

Если ни один другой сервер не настроен в автономном `AzureOfflineBackup_<Azure User Id>` режиме и ни один другой сервер не зависит от приложения, удалите это приложение. Выберите **портал** > **Azure Active Directory** > **App.**

>[!NOTE]
> Проверьте, если `AzureOfflineBackup_<Azure User Id>` приложение не имеет каких-либо других автономной посевной настроен, а также, если никакой другой сервер зависит от этого приложения. Перейдите в разделе **«Настройки»** > **Keys** в разделе **«Открытые ключи».** Он не должен иметь какие-либо другие открытые ключи добавлены. Смотрите следующий скриншот для справки.
>
>![Открытые ключи](./media/offline-backup-azure-data-box/public-keys.png)

#### <a name="step-3"></a>Шаг 3.

С сервера, который вы пытаетесь настроить для автономного резервного копирования, выполните следующие действия.

1. Перейдите в >  **приложение сертификата Управления компьютером****Personal** tab `CB_AzureADCertforOfflineSeeding_<ResourceId>`и ищите сертификат с именем.

2. Выберите сертификат, нажмите правой кнопкой **мыши Все задачи**и выберите **Экспорт** без закрытого ключа в формате .cer.

3. Перейдите в автономное приложение резервного копирования Azure, упомянутое в шаге 2. Выберите > **Параметры** >  **Ключей****Загрузка Общедоступного ключа.** Загрузите сертификат, экспортированный на предыдущем этапе.

    ![Загрузить открытый ключ](./media/offline-backup-azure-data-box/upload-public-key.png)

4. На сервере откройте реестр, введя **regedit** в окне выполнения.

5. Перейдите в реестр *Компьютерная HKEY_LOCAL_MACHINE-SOFTWARE-Microsoft-Windows Azure Backup-Config-CloudBackupProvider.* Право нажмите **CloudBackupProvider**, и добавить `AzureADAppCertThumbprint_<Azure User Id>`новое значение строки с именем .

    >[!NOTE]
    > Чтобы получить идентификатор пользователя Azure, выполните одно из следующих действий:
    >
    >* Из подключенной к Azure PowerShell запустите `Get-AzureRmADUser -UserPrincipalName "Account Holder's email as defined in the portal"` команду.
    > * Перейдите на путь реестра *Компьютерная HKEY_LOCAL_MACHINE-SOFTWARE-Microsoft-Windows Azure Backup,DbgSettings-OnlineBackup* с именем *CurrentUserId*.

6. Нажмите правой кнопкой мыши строки, добавленной на предыдущем этапе, и выберите **Modify**. В значении укажите отпечаток пальца сертификата, который вы экспортировали в шаге 2. Нажмите кнопку **ОК**.

7. Чтобы получить значение отпечатка пальца, дважды щелкните сертификат. Выберите вкладку **«Детали»** и прокрутите вниз, пока не увидите поле отпечатков пальцев. Выберите **Thumbprint**и скопируйте значение.

    ![Поле сертификата отпечатков пальцев](./media/offline-backup-azure-data-box/thumbprint-field.png)

## <a name="questions"></a>Вопросы

Для любых вопросов или разъяснений о любых проблемах, с которыми вы столкнулись, свяжитесь с [AskAzureBackupTeam@microsoft.com](mailto:AskAzureBackupTeam@microsoft.com)нами .
