---
title: Используйте настройки диагностики для хранилищ служб восстановления
description: В этой статье описывается, как использовать старые и новые диагностические события для резервного копирования Azure.
ms.topic: conceptual
ms.date: 10/30/2019
ms.openlocfilehash: f11c9d2a5b48b9cd27ac6e6f8a00eb5ac0ac7a9d
ms.sourcegitcommit: eefb0f30426a138366a9d405dacdb61330df65e7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81617297"
---
# <a name="use-diagnostics-settings-for-recovery-services-vaults"></a>Используйте настройки диагностики для хранилищ служб восстановления

Резервное копирование Azure отправляет диагностические события, которые могут быть собраны и использованы для целей анализа, оповещения и отчетности.

Настройку параметров диагностики для хранилища служб восстановления можно с помощью портала Azure, перейдя в хранилище и выбрав **настройки диагностики.** Выбор **диагностического настройки позволяет** отправлять одно или несколько диагностических событий в учетную запись хранения, концентратор событий или рабочее пространство Log Analytics.

![Панель параметров диагностики](./media/backup-azure-diagnostics-events/diagnostics-settings-blade.png)

## <a name="diagnostics-events-available-for-azure-backup-users"></a>Диагностические события, доступные для пользователей резервного копирования Azure

Резервное копирование Azure предоставляет следующие диагностические события. Каждое событие предоставляет подробные данные о определенном наборе артефактов, связанных с резервной копированием:

* CoreAzureBackup
* АддоназуреРепаупОконс
* АддоназурЕБэкапЗащищенныйInstance
* АддоназурЕБэкапДжобс
* АддоназурЕБэкПолитики
* АддоназуреРеАусХранение

Для получения дополнительной [информации см. модель данных для диагностических событий Azure Backup.](https://docs.microsoft.com/azure/backup/backup-azure-reports-data-model)

Данные для этих событий могут быть отправлены либо в учетную запись хранилища, рабочую область analytics журнала, либо в концентратор событий. Если вы отправляете эти данные в рабочее пространство Log Analytics, выберите **переключатель ресурса** на экране **настроек Диагностики.** Дополнительные сведения приведены в следующем разделе.

## <a name="use-diagnostics-settings-with-log-analytics"></a>Используйте настройки диагностики с помощью log Analytics

Теперь можно использовать резервное копирование Azure для отправки данных диагностики хранилища в специальные таблицы анализа журналов для резервного копирования. Эти таблицы называются [таблицами, специфичными для ресурсов.](https://docs.microsoft.com/azure/azure-monitor/platform/resource-logs-collect-workspace#resource-specific)

Чтобы отправить данные о диагностике хранилища в журнал Analytics:

1. Перейдите в хранилище и выберите **диагностические настройки.** Выберите **и добавьте диагностическую настройку**.
1. Назовите настройки диагностики.
1. Выберите флажок **«Отправить в журнал Analytics»** и — рабочее пространство для анализа журналов.
1. Выберите **ресурс, специфичный** в переключении, и выберите следующие шесть событий: **CoreAzureBackup**, **AddonAzureBackupJobs**, **AddonAzureBackupAlerts**, **AddonAzureBackupPolicy,** **AddonAzureBackupStorage**, и **AddonAzureBackupProtectedInstance**.
1. Щелкните **Сохранить**.

   ![Режим, специфичный для ресурсов](./media/backup-azure-diagnostics-events/resource-specific-blade.png)

После того, как данные поступают в рабочее пространство Log Analytics, в рабочей области создаются специальные таблицы для каждого из этих событий. Вы можете заразить любую из этих таблиц напрямую. Вы также можете выполнять соединения или союзы между этими таблицами, если это необходимо.

> [!IMPORTANT]
> Шесть событий, а именно: CoreAzureBackup, AddonAzureBackupJobs, AddonAzureBackupAlerts, AddonAzureBackupPolicy, AddonAzureBackupStorage и AddonAzureBackupProtectedInstance, поддерживаются *только* в ресурсном режиме в [отчетах резервного копирования.](https://docs.microsoft.com/azure/backup/configure-reports) *Если вы попытаетесь отправить данные для этих шести событий в режиме диагностики Azure, в отчетах о резервном копировании данных не будет видно.*

## <a name="legacy-event"></a>Наследие событие

Традиционно все данные диагностики, связанные с резервным копированием для хранилища, содержались в одном событии под названием AzureBackupReport. Шесть описанных здесь событий, по сути, являются разложением всех данных, содержащихся в AzureBackupReport. 

В настоящее время мы продолжаем поддерживать событие AzureBackupReport для обратной совместимости в тех случаях, когда пользователи имеют существующие пользовательские запросы на этом событии. Примерами являются пользовательские оповещения о журнале и пользовательские визуализации. *Мы рекомендуем вам перейти к [новым событиям](https://docs.microsoft.com/azure/backup/backup-azure-diagnostic-events#diagnostics-events-available-for-azure-backup-users) как можно раньше.* Новые события:

- Значительно упростите работу с данными в запросах журнала.
- Обеспечить лучшую возможность обнаружения схем и их структуры.
- Улучшение производительности как во время задержки приема, так и во время запроса. 

*Устаревательное событие в режиме диагностики Azure в конечном итоге будет обесточено. Выбор новых событий может помочь вам избежать сложных миграций на более поздний срок.* Наше [решение для отчетности,](https://docs.microsoft.com/azure/backup/configure-reports) использующей Log Analytics, также перестанет поддерживать данные из устаревшего события.

### <a name="steps-to-move-to-new-diagnostics-settings-for-a-log-analytics-workspace"></a>Шаги для перехода к новым настройкам диагностики для рабочего пространства Log Analytics

1. Определите, какие хранилища отправляют данные в рабочие области Log Analytics, используя устаревшее событие и подписки, к которым они принадлежат. Выполнить следующие рабочие области, чтобы определить эти хранилища и подписки.

    ````Kusto
    let RangeStart = startofday(ago(3d));
    let VaultUnderAzureDiagnostics = (){
        AzureDiagnostics
        | where TimeGenerated >= RangeStart | where Category == "AzureBackupReport" and OperationName == "Vault" and SchemaVersion_s == "V2"
        | summarize arg_max(TimeGenerated, *) by ResourceId    
        | project ResourceId, Category};
    let VaultUnderResourceSpecific = (){
        CoreAzureBackup
        | where TimeGenerated >= RangeStart | where OperationName == "Vault" 
        | summarize arg_max(TimeGenerated, *) by ResourceId
        | project ResourceId, Category};
        // Some Workspaces will not have AzureDiagnostics Table, hence you need to use isFuzzy
    let CombinedVaultTable = (){
        CombinedTable | union isfuzzy = true 
        (VaultUnderAzureDiagnostics() ),
        (VaultUnderResourceSpecific() )
        | distinct ResourceId, Category};
    CombinedVaultTable | where Category == "AzureBackupReport"
    | join kind = leftanti ( 
    CombinedVaultTable | where Category == "CoreAzureBackup"
    ) on ResourceId
    | parse ResourceId with * "SUBSCRIPTIONS/" SubscriptionId:string "/RESOURCEGROUPS" * "MICROSOFT.RECOVERYSERVICES/VAULTS/" VaultName:string
    | project ResourceId, SubscriptionId, VaultName
    ````

1. Используйте [встроенную политику Azure](https://docs.microsoft.com/azure/backup/azure-policy-configure-diagnostics) в резервном копировании Azure, чтобы добавить новую настройку диагностики для всех хранилищ в заданной области. Эта политика добавляет новую настройку диагностики в хранилища, которые либо не имеют настройки диагностики, либо имеют только устаревшие настройки диагностики. Эта политика может быть назначена всей группе подписки или ресурсов одновременно. У вас должен быть доступ к каждой подписке, для которой назначена политика.

Можно выбрать отдельные настройки диагностики для AzureBackupReport и шесть новых событий до тех пор, пока не переоднешь все пользовательские запросы для использования данных из новых таблиц. На следующем изображении показан пример хранилища с двумя диагностическими настройками. Первая настройка под названием **Setting1**отправляет данные события AzureBackupReport в рабочее пространство log Analytics в режиме диагностики Azure. Второй параметр, названный **Setting2,** отправляет данные о шести новых событиях резервного копирования Azure в рабочее пространство Log Analytics в режиме, специфичном для ресурсов.

![Две настройки](./media/backup-azure-diagnostics-events/two-settings-example.png)

> [!IMPORTANT]
> Событие AzureBackupReport поддерживается *только* в режиме диагностики Azure. *Если вы попытаетесь отправить данные для этого события в режиме, специфичном для ресурсов, никакие данные не будут поступать в рабочее пространство Log Analytics.*

> [!NOTE]
> Переключение для **диагностики Azure** или **конкретного ресурса** появляется только в том случае, если пользователь выбирает **Send to Log Analytics.** Для отправки данных на учетную запись хранения или концентратор событий пользователь выбирает требуемый пункт назначения и выбирает флажки для любого из желаемых событий без каких-либо дополнительных входов. Опять же, мы рекомендуем вам не выбирать устаревшное событие AzureBackupReport в будущем.

## <a name="send-azure-site-recovery-events-to-log-analytics"></a>Отправка событий восстановления сайта Azure в журнал Analytics

События резервного копирования Azure и восстановления сайтов Azure отправляются из одного и того же хранилища служб восстановления. Восстановление сайта Azure в настоящее время недоступно для таблиц, связанных с конкретными ресурсами. Пользователям, желающим отправить события восстановления сайта Azure в журнал Analytics, поручено использовать *только*режим диагностики Azure, как показано на изображении. *Выбор ресурсо-специфического режима для событий восстановления сайта Azure предотвратит отправку необходимых данных в рабочее пространство Log Analytics.*

![События восстановления сайта](./media/backup-azure-diagnostics-events/site-recovery-settings.png)

Итог:

* Если у вас уже есть диагностика Log Analytics, настроенная с помощью Azure Diagnostics, и в нем есть письменные запросы, держите эту *настройку нетронутой* до тех пор, пока вы не перейдь запросов для использования данных из новых событий.
* Если вы также хотите, чтобы на борту новых таблиц, как мы рекомендуем, создать **новую** настройку диагностики, выберите **ресурс конкретных**, и выбрать шесть новых событий.
* Если в настоящее время вы отправляете события восстановления сайта Azure в журнал Analytics, *не* выбирайте для этих событий режим, специфичный для ресурсов. В противном случае данные для этих событий не будут поступать в рабочее пространство analytics log. Вместо этого создайте дополнительную диагностическую настройку, выберите **диагностику Azure**и выберите соответствующие события восстановления сайта Azure.

На следующем изображении показан пример пользователя, который имеет три настройки диагностики для хранилища. Первая настройка под названием **Setting1**отправляет данные из события AzureBackupReport в рабочее пространство log Analytics в режиме диагностики Azure. Второй параметр, названный **Setting2,** отправляет данные из шести новых событий резервного копирования Azure в рабочее пространство Log Analytics в режиме, специфичном для ресурсов. Третья настройка под названием **Setting3**отправляет данные из событий восстановления сайта Azure в рабочее пространство log Analytics в режиме диагностики Azure.

![Три настройки](./media/backup-azure-diagnostics-events/three-settings-example.png)

## <a name="next-steps"></a>Дальнейшие действия

[Изучите модель данных журнала Analytics для событий диагностики](https://docs.microsoft.com/azure/backup/backup-azure-reports-data-model)
