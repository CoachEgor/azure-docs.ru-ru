---
title: Резервное копирование базы данных SAP HANA в Azure с помощью Azure Backup
description: Из этой статьи вы узнаете, как создать резервную копию базы данных SAP HANA на виртуальных машинах Azure со службой Azure Backup.
ms.topic: conceptual
ms.date: 11/12/2019
ms.openlocfilehash: a5fd09e0e487d103e8bd78964c11b572a62e28fa
ms.sourcegitcommit: 1f738a94b16f61e5dad0b29c98a6d355f724a2c7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2020
ms.locfileid: "78164616"
---
# <a name="back-up-sap-hana-databases-in-azure-vms"></a>Резервное копирование баз данных SAP HANA на виртуальных машинах Azure

SAP HANA базы данных — это критически важные рабочие нагрузки, для которых требуется низкая Целевая точка восстановления (RPO) и долгосрочное хранение. Вы можете выполнять резервное копирование SAP HANA баз данных, работающих на виртуальных машинах Azure, с помощью [Azure Backup](backup-overview.md).

В этой статье показано, как выполнить резервное копирование SAP HANA баз данных, работающих на виртуальных машинах Azure, в хранилище служб восстановления Azure Backup.

В этой статье раскрываются следующие темы:
> [!div class="checklist"]
>
> * Создание и настройка хранилища
> * Обнаружение баз данных.
> * Настройка резервных копий
> * Выполнение задания архивации по запросу

>[!NOTE]
>**Обратимое удаление для SQL Server в виртуальной машине Azure и обратимое удаление для SAP HANA в рабочих нагрузках виртуальных машин Azure** теперь доступно в предварительной версии.<br>
>Чтобы зарегистрироваться для просмотра, напишите нам по адресу AskAzureBackupTeam@microsoft.com

## <a name="prerequisites"></a>Предварительные требования

Чтобы настроить базу данных для резервного копирования, см. [Предварительные требования](tutorial-backup-sap-hana-db.md#prerequisites) и действия, выполняемые [сценарием предварительной регистрации](tutorial-backup-sap-hana-db.md#what-the-pre-registration-script-does) .

### <a name="set-up-network-connectivity"></a>Настройка сетевого подключения

Для всех операций виртуальной машине SAP HANA требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам Azure.

Установите подключение, используя один из следующих вариантов.

#### <a name="allow-the-azure-datacenter-ip-ranges"></a>Разрешение диапазонов IP-адресов центра обработки данных Azure

Этот параметр разрешает [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в скачанном файле. Чтобы получить доступ к группе безопасности сети, используйте командлет "Set-AzureNetworkSecurityRule". Если список надежных получателей содержит только IP-адреса, относящиеся к региону, вам также нужно обновить список безопасных получателей тегом службы Azure Active Directory (Azure AD), чтобы включить проверку подлинности.

#### <a name="allow-access-using-nsg-tags"></a>Разрешение доступа с помощью тегов NSG

При использовании NSG для ограничения возможностей подключения следует использовать тег службы AzureBackup, чтобы разрешить исходящий доступ к Azure Backup. Кроме того, вы также можете разрешить подключение для проверки подлинности и передачу данных, используя [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и службы хранилища Azure. Это можно сделать на портале Azure или с помощью PowerShell.

Чтобы создать правило с помощью портала, выполните следующие действия.

  1. В разделе **Все службы** перейдите к **группам сетевой безопасности** и выберите группу сетевой безопасности.
  2. Выберите **Правила безопасности для исходящего трафика** в разделе **Параметры**.
  3. Выберите **Добавить**. Введите все необходимые сведения для создания нового правила, как описано в разделе [параметры правила безопасности](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group#security-rule-settings). Убедитесь, что параметр **Назначение** имеет значение **Тег службы**, а **Тег целевой службы** имеет значение **AzureBackup**.
  4. Щелкните **Добавить**, чтобы сохранить только что созданное исходящее правило безопасности.

Чтобы создать правило с помощью PowerShell, выполните следующие действия.

 1. Добавление учетных данных учетной записи Azure и обновление национальных облаков<br/>
      `Add-AzureRmAccount`<br/>

 2. Выберите подписку NSG<br/>
      `Select-AzureRmSubscription "<Subscription Id>"`

 3. Выберите NSG<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

 4. Добавление разрешающего правила исходящего трафика для тега службы Azure Backup<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 5. Добавление разрешающего правила исходящего трафика для тега Службы хранилища<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "StorageAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "Storage" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 6. Добавление разрешающего правила исходящего трафика для тега AzureActiveDirectory<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureActiveDirectoryAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureActiveDirectory" -DestinationPortRange 443 -Description "Allow outbound traffic to AzureActiveDirectory service"`

 7. Сохраните файл NSG<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`

**Разрешите доступ с помощью тегов брандмауэра Azure**. Если вы используете брандмауэр Azure, создайте правило приложения с помощью[тега AzureBackup FQDN](https://docs.microsoft.com/azure/firewall/fqdn-tags). Это разрешает исходящий доступ к службам Azure Backup.

**Развертывание прокси-сервера HTTP для маршрутизации трафика**. Когда создается резервная копия базы данных SAP HANA на виртуальной машине Azure, расширение резервного копирования на виртуальной машине использует API HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure AD для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Варианты подключения включают следующие преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure
Использование тегов службы NSG | Упрощенное управление благодаря автоматическому объединению изменений диапазона <br/><br/> Нет дополнительных затрат <br/><br/> | Может использоваться только с NSG <br/><br/> Предоставляет доступ ко всей службе
Использование тегов полного доменного имени службы "Брандмауэр Azure" | Проще управлять, так как требуемые управляются FQDN автоматически | Можно использовать только с брандмауэром Azure
Использование прокси-сервера HTTP | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере <br/><br/> Единая точка доступа к виртуальным машинам через Интернет <br/><br/> Не подвергается влиянию изменений IP-адресов Azure | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-the-databases"></a>Обнаружение баз данных

1. В разделе хранилища **Начало работы** щелкните **Резервное копирование**. В разделе **Где выполняется рабочая нагрузка?** выберите **SAP HANA в виртуальной машине Azure**.
2. Щелкните **Начать обнаружение**. Это инициирует обнаружение незащищенных виртуальных машин Linux в регионе хранилища.

   * После обнаружения на портале отображаются незащищенные виртуальные машины, перечисленные по имени и группе ресурсов.
   * Если виртуальная машина не указана ожидаемым образом, проверьте, не была ли она создана в хранилище.
   * Несколько виртуальных машин могут иметь одно и то же имя, но они принадлежат разным группам ресурсов.

3. В разделе **Выбор виртуальных машин** щелкните ссылку, чтобы скачать скрипт, предоставляющий службе Azure Backup разрешения на доступ к виртуальным машинам SAP HANA для обнаружения баз данных.
4. Запустите сценарий на каждой виртуальной машине, где размещаются SAP HANA базы данных, для которых требуется создать резервную копию.
5. После выполнения скрипта на виртуальных машинах в области **Выбор виртуальных машин**выберите виртуальные машины. Далее нажмите на кнопку **Обнаружить базы данных**.
6. Azure Backup обнаруживает все базы данных SAP HANA на виртуальной машине. Во время обнаружения Azure Backup регистрирует виртуальную машину в хранилище и устанавливает расширение на виртуальной машине. В базе данных агент не устанавливается.

    ![Обнаружение баз данных SAP HANA](./media/backup-azure-sap-hana-database/hana-discover.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

Теперь включите резервное копирование.

1. На шаге 2 Нажмите кнопку **Настройка резервного копирования**.

    ![Настройка резервного копирования](./media/backup-azure-sap-hana-database/configure-backup.png)
2. В поле **выберите элементы для резервного копирования**выберите все базы данных, которые необходимо защитить > **ОК**.

    ![Выбор элементов для резервного копирования](./media/backup-azure-sap-hana-database/select-items.png)
3. В разделе **политика резервного копирования** > **выберите Политика архивации**, создайте новую политику резервного копирования для баз данных в соответствии с приведенными ниже инструкциями.

    ![Выбор политики резервного копирования](./media/backup-azure-sap-hana-database/backup-policy.png)
4. После создания политики в меню **резервного копирования** выберите **включить резервное копирование**.

    ![Включение резервного копирования](./media/backup-azure-sap-hana-database/enable-backup.png)
5. В области **Уведомления** портала можно отслеживать ход настройки резервного копирования.

### <a name="create-a-backup-policy"></a>Создание политики резервного копирования

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.

Укажите параметры политики следующим образом:

1. Введите имя новой политики в поле **Имя политики**.

   ![Введите имя политики](./media/backup-azure-sap-hana-database/policy-name.png)
2. В меню **Full Backup policy** (Политика полного резервного копирования) для параметра **Частота архивации** выберите **Ежедневно** или **Еженедельно**.
   * **Ежедневно**. Выберите час и часовой пояс, в котором начинается задание резервного копирования.
       * Необходимо запустить полную резервную копию. Этот параметр нельзя отключить.
       * Щелкните **Полная резервная копия**, чтобы просмотреть политику.
       * При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.
   * **Еженедельно**. Выберите день недели, часа и часовой пояс, в котором будет выполняться задание резервного копирования.

   ![Выберите периодичность резервного копирования](./media/backup-azure-sap-hana-database/backup-frequency.png)

3. В разделе **Диапазон хранения** настройте параметры периода удержания для полной резервной копии.
    * По умолчанию выбраны все параметры. Удалите все ограничения диапазона хранения, которые вы не хотите использовать, и настройте их.
    * Минимальный период хранения для резервной копии любого типа (полная/разностная/журнал) составляет семь дней.
    * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    * Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром.
    * Месячный и годовой диапазоны хранения действуют аналогичным образом.

4. В меню **Политика полного резервного копирования** нажмите кнопку **ОК** для подтверждения параметров.
5. Выберите **разностное резервное копирование** , чтобы добавить политику разностного копирования.
6. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.
    * Максимально в день можно активировать одну разностную резервную копию.
    * Максимальный срок хранения разностных резервных копий составляет 180 дней. Если требуется более длительное хранение, необходимо использовать полные резервные копии.

    ![Политика разностного резервного копирования](./media/backup-azure-sap-hana-database/differential-backup-policy.png)

    > [!NOTE]
    > Добавочные резервные копии сейчас не поддерживаются.

7. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
8. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервная копия журналов**.
    * В **резервной копии журнала**выберите **включить**.  Это невозможно отключить, так как SAP HANA управляет всеми резервными копиями журналов.
    * Задайте частоту и элементы управления удержания.

    > [!NOTE]
    > Резервные копии журналов начинают работать только после успешного завершения полного резервного копирования.

9. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
10. После завершения определения политики резервного копирования нажмите кнопку **ОК**.

> [!NOTE]
> Каждая резервная копия журнала связана с предыдущей полной резервной копией, образуя цепочку восстановления. Эта полная резервная копия будет храниться до истечения срока хранения последней резервной копии журнала. Это может означать, что полная резервная копия сохраняется в течение дополнительного периода, чтобы гарантировать возможность восстановления всех журналов. Предположим, что у пользователя есть еженедельное полное резервное копирование, ежедневное разностное и 2-часовой журналы. Все они хранятся в течение 30 дней. Однако еженедельное полное удаление может быть действительно очищено только после того, как будет доступна следующая полная резервная копия, т. е. через 30 + 7 дней. Скажем, еженедельное полное резервное копирование происходит в 16 ноября. Согласно политике хранения, ее следует хранить до декабря в 16 часов. Последняя резервная копия журнала для этого полного выполнения происходит до следующего запланированного заполнения в 22 ноября. До тех пор пока этот журнал не будет доступен до декабря 22, не удается удалить все 16 ноября. Таким образом, в 16 ноября будет храниться до декабря 22.

## <a name="run-an-on-demand-backup"></a>Выполнение резервного копирования по запросу

Резервные копии выполняются в соответствии с расписанием политики. Резервное копирование по запросу можно выполнить следующим образом:

1. В меню хранилища щелкните **Элементы архивации**.
2. В поле **архивные элементы**выберите виртуальную машину, на которой выполняется SAP HANAная база данных, а затем щелкните **Архивация сейчас**.
3. В поле **создать резервную копию**используйте элемент управления Calendar, чтобы выбрать последний день, в который должна храниться точка восстановления. Затем нажмите кнопку **ОК**.
4. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения задания на панели мониторинга хранилища в разделе **Задания резервного копирования** > **Выполняется**. В зависимости от размера базы данных создание начальной резервной копии может занять некоторое время.

## <a name="run-sap-hana-studio-backup-on-a-database-with-azure-backup-enabled"></a>Выполнение резервного копирования SAP HANA Studio в базе данных с включенным Azure Backup

Если вы хотите создать локальную резервную копию (с помощью HANA Studio) базы данных, для которой выполняется резервное копирование Azure Backup, выполните следующие действия.

1. Дождитесь завершения всех полных или резервных копий журналов для базы данных. Проверьте состояние в SAP HANA Studio или панели.
2. Отключите резервное копирование журналов и задайте в качестве каталога резервного копирования файловую систему для соответствующей базы данных.
3. Для этого дважды щелкните **системдб** > **Configuration** > **выберите База данных** > **фильтр (журнал)** .
4. Задайте для параметра **enable_auto_log_backup** значение **нет**.
5. Задайте для Log_backup_using_backint **значение false**.
6. Создайте полную резервную копию базы данных по требованию.
7. Дождитесь завершения полного резервного копирования и резервного копирования каталога.
8. Верните предыдущие параметры в Azure.
    * Задайте для параметра **enable_auto_log_backup** значение **Да**.
    * Задайте для Log_backup_using_backint **значение true**.

## <a name="next-steps"></a>Следующие шаги

* Узнайте, как [восстановить базы данных SAP HANA, запущенные на виртуальных машинах Azure](https://docs.microsoft.com/azure/backup/sap-hana-db-restore).
* Узнайте, как [управлять базами данных SAP Hana, для которых выполняется резервное копирование с помощью Azure Backup](https://docs.microsoft.com/azure/backup/sap-hana-db-manage)
