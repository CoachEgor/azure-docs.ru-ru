---
title: Резервное копирование базы данных SAP HANA в Azure с помощью резервного копирования Azure
description: В этой статье узнайте, как создать резервную связь с базой данных SAP HANA в виртуальных машинах Azure с помощью службы резервного копирования Azure.
ms.topic: conceptual
ms.date: 11/12/2019
ms.openlocfilehash: deedd4d2553b3b06f76f698fdb2425a8d3878d23
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79248064"
---
# <a name="back-up-sap-hana-databases-in-azure-vms"></a>Резервное копирование баз данных SAP HANA на виртуальных машинах Azure

Базы данных SAP HANA являются критически важными рабочими нагрузками, которые требуют низкой цели восстановления (RPO) и долгосрочного удержания. Вы можете создать резервную связь с базами данных SAP HANA, работающими на виртуальных машинах Azure (VM) с помощью [резервного копирования Azure.](backup-overview.md)

В этой статье показано, как создать резервное копирование баз данных SAP HANA, работающих на MMs-мизанах Azure, в хранилище служб восстановления резервного копирования Azure.

В этой статье раскрываются следующие темы:
> [!div class="checklist"]
>
> * Создание и настройка хранилища.
> * Обнаружение баз данных.
> * Настройка резервного копирования.
> * Выполнить задание резервного копирования по требованию

>[!NOTE]
>**Мягкое удаление для сервера S'L в Azure VM и мягкое удаление для SAP HANA в рабочих нагрузках Azure VM** теперь доступно в предварительном просмотре.<br>
>Чтобы подписаться на предварительный просмотр, напишите нам по адресуAskAzureBackupTeam@microsoft.com

## <a name="prerequisites"></a>Предварительные требования

Ссылайтесь на [предпосылки](tutorial-backup-sap-hana-db.md#prerequisites) и на то, что [скрипт предварительной регистрации делает](tutorial-backup-sap-hana-db.md#what-the-pre-registration-script-does) разделы для настройки базы данных для резервного копирования.

### <a name="set-up-network-connectivity"></a>Настройка сетевого подключения

Для всех операций виртуальной машине SAP HANA требуется подключение к общедоступным IP-адресам Azure. Операции виртуальной машины (обнаружение базы данных, настройка резервного копирования, запланированное создание резервных копий, восстановление точек восстановления и т. д.) не выполняются без подключения к общедоступным IP-адресам Azure.

Установите подключение, используя один из следующих вариантов.

#### <a name="allow-the-azure-datacenter-ip-ranges"></a>Разрешение диапазонов IP-адресов центра обработки данных Azure

Этот параметр разрешает [диапазоны IP-адресов](https://www.microsoft.com/download/details.aspx?id=41653) в скачанном файле. Чтобы получить доступ к группе безопасности сети, используйте командлет "Set-AzureNetworkSecurityRule". Если список надежных получателей содержит только IP-адреса, относящиеся к региону, вам также нужно обновить список безопасных получателей тегом службы Azure Active Directory (Azure AD), чтобы включить проверку подлинности.

#### <a name="allow-access-using-nsg-tags"></a>Разрешение доступа с помощью тегов NSG

При использовании NSG для ограничения возможностей подключения следует использовать тег службы AzureBackup, чтобы разрешить исходящий доступ к Azure Backup. Кроме того, вы также можете разрешить подключение для проверки подлинности и передачу данных, используя [правила](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) для Azure AD и службы хранилища Azure. Это можно сделать на портале Azure или с помощью PowerShell.

Чтобы создать правило с помощью портала, выполните следующие действия.

  1. В разделе **Все службы** перейдите к **группам сетевой безопасности** и выберите группу сетевой безопасности.
  2. Выберите **Правила безопасности для исходящего трафика** в разделе **Параметры**.
  3. Нажмите кнопку **Добавить**. Введите все необходимые сведения для создания нового правила, как описано в разделе [параметры правила безопасности](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group#security-rule-settings). Убедитесь, что параметр **Назначение** имеет значение **Тег службы**, а **Тег целевой службы** имеет значение **AzureBackup**.
  4. Щелкните **Добавить**, чтобы сохранить только что созданное исходящее правило безопасности.

Чтобы создать правило с помощью PowerShell, выполните следующие действия.

 1. Добавление учетных данных учетной записи Azure и обновление национальных облаков<br/>
      `Add-AzureRmAccount`<br/>

 2. Выберите подписку NSG<br/>
      `Select-AzureRmSubscription "<Subscription Id>"`

 3. Выберите NSG<br/>
    `$nsg = Get-AzureRmNetworkSecurityGroup -Name "<NSG name>" -ResourceGroupName "<NSG resource group name>"`

 4. Добавление разрешающего правила исходящего трафика для тега службы Azure Backup<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureBackupAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureBackup" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 5. Добавление разрешающего правила исходящего трафика для тега Службы хранилища<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "StorageAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "Storage" -DestinationPortRange 443 -Description "Allow outbound traffic to Azure Backup service"`

 6. Добавление разрешающего правила исходящего трафика для тега AzureActiveDirectory<br/>
    `Add-AzureRmNetworkSecurityRuleConfig -NetworkSecurityGroup $nsg -Name "AzureActiveDirectoryAllowOutbound" -Access Allow -Protocol * -Direction Outbound -Priority <priority> -SourceAddressPrefix * -SourcePortRange * -DestinationAddressPrefix "AzureActiveDirectory" -DestinationPortRange 443 -Description "Allow outbound traffic to AzureActiveDirectory service"`

 7. Сохраните файл NSG<br/>
    `Set-AzureRmNetworkSecurityGroup -NetworkSecurityGroup $nsg`

**Разрешите доступ с помощью тегов брандмауэра Azure**. Если вы используете брандмауэр Azure, создайте правило приложения с помощью[тега AzureBackup FQDN](https://docs.microsoft.com/azure/firewall/fqdn-tags). Это разрешает исходящий доступ к службам Azure Backup.

**Развертывание прокси-сервера HTTP для маршрутизации трафика**. Когда создается резервная копия базы данных SAP HANA на виртуальной машине Azure, расширение резервного копирования на виртуальной машине использует API HTTPS для отправки команд управления к Azure Backup, а данных — в службу хранилища Azure. Расширение резервного копирования также использует Azure AD для аутентификации. Направьте трафик расширения резервного копирования для этих трех служб через прокси-сервер HTTP. Расширения — единственный компонент, который настроен для обмена данными с общедоступным Интернетом.

Варианты подключения включают следующие преимущества и недостатки.

**Параметр** | **Преимущества** | **Недостатки**
--- | --- | ---
Разрешить диапазоны IP-адресов | Нет дополнительных затрат | Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются <br/><br/> Доступ ко всей службе Azure, а не только к службе хранилища Azure
Использование тегов службы NSG | Упрощенное управление благодаря автоматическому объединению изменений диапазона <br/><br/> Нет дополнительных затрат <br/><br/> | Может использоваться только с NSG <br/><br/> Предоставляет доступ ко всей службе
Использование тегов полного доменного имени службы "Брандмауэр Azure" | Проще управлять, так как требуемые управляются FQDN автоматически | Можно использовать только с брандмауэром Azure
Использование прокси-сервера HTTP | Разрешено точное управление разрешенными URL-адресами хранилища в прокси-сервере <br/><br/> Единая точка доступа к виртуальным машинам через Интернет <br/><br/> Не подвергается влиянию изменений IP-адресов Azure | Дополнительные затраты для запуска виртуальной машины с программным обеспечением прокси-сервера

#### <a name="private-endpoints"></a>Частные конечные точки

[!INCLUDE [Private Endpoints](../../includes/backup-private-endpoints.md)]

[!INCLUDE [How to create a Recovery Services vault](../../includes/backup-create-rs-vault.md)]

## <a name="discover-the-databases"></a>Обнаружение баз данных

1. В разделе хранилища **Начало работы** щелкните **Резервное копирование**. В разделе **Где выполняется рабочая нагрузка?** выберите **SAP HANA в виртуальной машине Azure**.
2. Щелкните **Начать обнаружение**. Это инициирует обнаружение незащищенных виртуальных машин Linux в регионе хранилища.

   * После обнаружения на портале появляются незащищенные вм- свисты, перечисленные по имени и группе ресурсов.
   * Если VM не указан как ожидалось, проверьте, есть ли он уже резервное копирование в хранилище.
   * Несколько ВМ могут иметь одно и то же имя, но они принадлежат к различным группам ресурсов.

3. В разделе **Выбор виртуальных машин** щелкните ссылку, чтобы скачать скрипт, предоставляющий службе Azure Backup разрешения на доступ к виртуальным машинам SAP HANA для обнаружения баз данных.
4. Запустите скрипт на каждой базе данных VM, размещающие базы данных SAP HANA, которые требуется для резервного копирования.
5. После запуска скрипта на виртуальных сетях, в **Select Virtual Machines**, выберите виртуальные. Далее нажмите на кнопку **Обнаружить базы данных**.
6. Azure Backup обнаруживает все базы данных SAP HANA на виртуальной машине. Во время обнаружения Azure Backup регистрирует виртуальную машину в хранилище и устанавливает расширение на виртуальной машине. В базе данных агент не устанавливается.

    ![Откройте для себя базы данных SAP HANA](./media/backup-azure-sap-hana-database/hana-discover.png)

## <a name="configure-backup"></a>Настройка резервного копирования  

Теперь включите резервную перепорку.

1. В шаге 2 нажмите **Наконкаждляе резервное копирование.**

    ![Настройка резервного копирования](./media/backup-azure-sap-hana-database/configure-backup.png)
2. В **Select элементы для резервного копирования,** выберите все базы данных, которые вы хотите защитить > **OK.**

    ![Выбор элементов для резервного копирования](./media/backup-azure-sap-hana-database/select-items.png)
3. В политике **резервного копирования** > **Выберите политику резервного копирования**, создайте новую политику резервного копирования для баз данных, в соответствии с инструкциями ниже.

    ![Выбор политики резервного копирования](./media/backup-azure-sap-hana-database/backup-policy.png)
4. После создания политики в меню **резервного копирования** нажмите **кнопку «Включить резервное копирование».**

    ![Включение резервного копирования](./media/backup-azure-sap-hana-database/enable-backup.png)
5. В области **Уведомления** портала можно отслеживать ход настройки резервного копирования.

### <a name="create-a-backup-policy"></a>создание политики архивации;

Политика резервного копирования определяет, когда выполняется резервное копирование и длительность хранения резервных копий.

* Политика создается на уровне хранилища.
* Несколько хранилищ могут использовать одну и ту же политику резервного копирования, но тогда необходимо применить эту политику резервного копирования к каждому хранилищу.

Укажите параметры политики следующим образом:

1. Введите имя новой политики в поле **Имя политики**.

   ![Введите имя политики](./media/backup-azure-sap-hana-database/policy-name.png)
2. В меню **Full Backup policy** (Политика полного резервного копирования) для параметра **Частота архивации** выберите **Ежедневно** или **Еженедельно**.
   * **Ежедневно**: Выберите час и часовой пояс, в котором начинается задание резервного копирования.
       * Вы должны запустить полную резервную перестановку. Вы не можете отключить эту опцию.
       * Щелкните **Полная резервная копия**, чтобы просмотреть политику.
       * При ежедневном создании полных резервных копий невозможно создавать разностные резервные копии.
   * **Еженедельно**: Выберите день недели, час и часовой пояс, в котором выполняется работа резервного копирования.

   ![Выберите частоту резервного копирования](./media/backup-azure-sap-hana-database/backup-frequency.png)

3. В разделе **Диапазон хранения** настройте параметры периода удержания для полной резервной копии.
    * По умолчанию все параметры выбраны. Очистите все ограничения диапазона удержания, которые вы не хотите использовать, и установите те, которые вы делаете.
    * Минимальный период хранения для резервной копии любого типа (полная/разностная/журнал) составляет семь дней.
    * Точки восстановления отмечены для хранения исходя из их диапазона хранения. Например, если выбран параметр "Ежедневно", то каждый день активируется создание только одной полной резервной копии.
    * Резервная копия за определенный день помечается и хранится в соответствии с недельным диапазоном хранения и параметром.
    * Месячный и годовой диапазоны хранения действуют аналогичным образом.

4. В меню **Политика полного резервного копирования** нажмите кнопку **ОК** для подтверждения параметров.
5. Выберите **дифференциальную резервную кавер-из-за** добавления дифференциальной политики.
6. В меню **Differential Backup policy** (Политика разностной резервной копии) выберите **Включить** для открытия элементов управления периодичностью и хранением.
    * Максимально в день можно активировать одну разностную резервную копию.
    * Максимальный срок хранения разностных резервных копий составляет 180 дней. Если требуется более длительное хранение, необходимо использовать полные резервные копии.

    ![Политика разностного резервного копирования](./media/backup-azure-sap-hana-database/differential-backup-policy.png)

    > [!NOTE]
    > Добавочные резервные копии сейчас не поддерживаются.

7. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
8. Чтобы добавить политику резервного копирования журналов транзакций, выберите **Резервная копия журналов**.
    * В **резервном копировании журнала**выберите **Включить**.  Это невозможно отключить, так как SAP HANA управляет всеми резервными копиями журналов.
    * Установите элементы управления частотой и удержанием.

    > [!NOTE]
    > Резервное копирование журнала начинает течь только после завершения успешного полного резервного копирования.

9. Для сохранения политики и возврата к главному меню **Политика резервного копирования** нажмите кнопку **ОК**.
10. После завершения определения политики резервного копирования нажмите кнопку **ОК**.

> [!NOTE]
> Каждое резервное копирование журнала приковано к предыдущему полному резервному копированию для формирования цепочки восстановления. Эта полная резервная копию будет сохранена до истечения срока хранения последнего резервного копирования журнала. Это может означать, что полная резервная копия сохраняется в течение дополнительного периода, чтобы убедиться, что все журналы могут быть восстановлены. Допустим, пользователь имеет еженедельное полное резервное копирование, ежедневный дифференциал и 2-часовые журналы. Все они сохраняются в течение 30 дней. Но, еженедельно полный может быть действительно очищены / удалены только после следующего полного резервного копирования доступна, т.е., после 30 и 7 дней. Скажем, еженедельно еженедельная полная резервная часть происходит 16 ноября. В рамках политики удержания, она должна быть сохранена до 16 декабря. Последнее резервное копирование журнала для этого полного происходит до следующего запланированного полного, на 22 ноября. До тех пор, пока этот журнал не будет доступен до 22 декабря, полный 16 ноября не может быть удален. Таким образом, 16 ноября полный сохраняется до 22 декабря.

## <a name="run-an-on-demand-backup"></a>Выполнение резервного копирования по запросу

Резервное копирование работает в соответствии с графиком политики. Вы можете запустить резервную по требованию следующим образом:

1. В меню хранилища щелкните **Элементы архивации**.
2. В **элементах резервного копирования**выберите VM, подпустив базу данных SAP HANA, а затем нажмите **кнопку «Теперь— резервная кнопка».**
3. В **Backup Now**используйте элемент управления календаря, чтобы выбрать последний день сохранения точки восстановления. После этого щелкните **OK**.
4. Отслеживайте уведомления на портале. Вы можете отслеживать ход выполнения заданий на панели мониторинга хранилища >**в процессе выполнения**заданий **резервного** > копирования. В зависимости от размера базы данных создание первоначальной резервной системы может занять некоторое время.

## <a name="run-sap-hana-studio-backup-on-a-database-with-azure-backup-enabled"></a>Запуск резервного копирования SAP HANA Studio в базе данных с включенным резервным копированием Azure

Если требуется резервная копия локальной (с помощью HANA Studio) базы данных, которая резервируется в резервном копировании Azure, сделайте следующее:

1. Подождите, пока будет завершена резервная копии полного или регистра для завершения базы данных. Проверьте состояние в SAP HANA Studio / Cockpit.
2. Отменяем резервные копии журналов и установите каталог резервного копирования в файловую систему для соответствующей базы данных.
3. Для этого дважды щелкните **systemdb** > **Configuration Select** > **Database** > **Filter (Log)**.
4. Установить **enable_auto_log_backup** **нет**.
5. Установить **log_backup_using_backint** **ложным**.
6. Возьмите полную резервную резервную часть базы данных по требованию.
7. Подождите, пока будет завершена полная резервная и каталогная резервная часть.
8. Верните предыдущие настройки обратно в настройки Для Azure:
    * Установите **enable_auto_log_backup** **Да**.
    * Установить **log_backup_using_backint** **True**.

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте, как [восстановить базы данных SAP HANA, запущенные на виртуальных машинах Azure](https://docs.microsoft.com/azure/backup/sap-hana-db-restore).
* Узнайте, как [управлять базами данных SAP HANA, которые резервируются с помощью резервного копирования Azure](https://docs.microsoft.com/azure/backup/sap-hana-db-manage)
