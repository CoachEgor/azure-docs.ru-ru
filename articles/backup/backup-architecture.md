---
title: Общие сведения об архитектуре
description: Обзор архитектуры, компонентов и процессов, используемых службой Azure Backup.
ms.topic: conceptual
ms.date: 02/19/2019
ms.openlocfilehash: b093c6702bb26fe537622727fe1b623141bf4160
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79273622"
---
# <a name="azure-backup-architecture-and-components"></a>Архитектура и компоненты резервного копирования Azure

Для резервного копирования данных на облачной платформе Microsoft Azure можно использовать [службу резервного копирования Azure.](backup-overview.md) В этой статье описаны архитектура, компоненты и процессы Azure Backup.

## <a name="what-does-azure-backup-do"></a>Что такое Azure Backup

Резервное копирование Azure резервное копирование данных, состояния машины и рабочих нагрузок, работающих на непредловых машинах и экземплярах виртуальной машины Azure (VM). Есть несколько сценариев Azure Backup:

## <a name="how-does-azure-backup-work"></a>Как работает Azure Backup

Вы можете создать резервную связь с машинами и данными с помощью ряда методов:

- **Резервное копирование локальных компьютеров**:
  - Резервное копирование нахотных компьютеров Windows можно непосредственно в Azure с помощью агента Службы восстановления Резервного копирования Azure (MARS). Компьютеры Linux не поддерживаются.
  - Вы можете создать резервную связь с использованием находного сервера резервного копирования - либо менеджер системы безопасности данных (DPM), либо сервер резервного копирования Microsoft Azure (MABS). Затем можно создать резервную перепорку на сервере резервного копирования в хранилище служб восстановления в Azure.

- **Резервное копирование Azure VMs**:
  - Вы можете напрямую создавать резервные копии виртуальных машин Azure. Резервное копирование Azure устанавливает резервное расширение для агента Azure VM, работая на VM. Это расширение создает резервную копию всей виртуальной машины.
  - Вы можете создавать резервные копии отдельных файлов и папок с виртуальной машины Azure с помощью агента MARS.
  - Можно создать резервную передовую службу azure VMs на MABS, которая работает в Azure, а затем создать резервную передвозку MABS в хранилище служб восстановления.

Узнайте больше о [том, что можно создать резервную поддержку,](backup-overview.md) и о [сценариях резервного копирования.](backup-support-matrix.md)

## <a name="where-is-data-backed-up"></a>Куда выполняется резервное копирование данных

Резервное копирование Azure хранит резервные данные в хранилище служб восстановления. Хранилище — это объект онлайн-хранилища в Azure, используемый для хранения данных, таких как копии резервного копирования, точки восстановления и политики резервного копирования.

Хранилища служб восстановления имеют следующие функции:

- Эти хранилища упрощают организацию данных резервного копирования и одновременно снижают затраты на управление.
- В рамках одной подписки Azure можно создать до 500 хранилищ.
- Вы можете отслеживать резервные элементы в хранилище, включая VMs-технологии Azure и автоматы.
- Можно управлять доступом к хранилищу с помощью [управления доступом на основе ролей Azure (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal).
- Нужно указать способ репликации данных в хранилище для обеспечения избыточности:
  - **Локально избыточное хранилище (LRS):** Для защиты от сбоя в центре обработки данных можно использовать LRS. LRS реплицирует данные в единицу масштабирования хранилища. Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs).
  - **Геоизуаемый объем хранилища (GRS):** Для защиты от перебоев в работе по всему региону можно использовать GRS. GRS реплицирует ваши данные в второстепенный регион. Ознакомьтесь с [дополнительными сведениями](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs).
  - По умолчанию хранилища служб восстановления используют GRS.

## <a name="backup-agents"></a>Агенты Backup

Резервное копирование Azure предоставляет различные резервные агенты, в зависимости от того, какой тип машины в настоящее время резервное копирование:

**Агент** | **Подробно**
--- | ---
**АГЕНТ МАРС** | <ul><li>Работает на отдельных наемных компьютерах Windows Server для резервного копирования файлов, папок и состояния системы.</li> <li>Выполняется на MMs Azure для резервного копирования файлов, папок и состояния системы.</li> <li>Выполняется на серверах DPM/MABS для резервного копирования локального диска хранения данных DPM/MABS в Azure.</li></ul>
**Расширение виртуальной машины Azure** | Выполняется на виртуальных машинах Azure для создания их резервных копий в хранилище.

## <a name="backup-types"></a>Типы резервного копирования

В следующей таблице объясняется различные типы резервных копирований и время их использования:

**Тип резервного копирования** | **Подробно** | **Использования**
--- | --- | ---
**Полный** | Полная резервная система содержит весь источник данных. Требуется больше пропускной способности сети, чем дифференциальные или дополнительные резервные копирования. | Используется для начального резервного копирования.
**Разностное** |  Дифференциал резервного копирования хранит блоки, которые изменились с момента первоначального полного резервного копирования. Использует меньшее количество сети и хранилища и не хранит избыточные копии неизменных данных.<br/><br/> Неэффективно, поскольку блоки данных, которые остаются неизменными между более поздними резервными копированиями, передаются и сохраняются. | Не используется службой Azure Backup.
**Добавочного** | Постепенное резервное копирование хранит только блоки данных, которые изменились со времени предыдущего резервного копирования. Высокая эффективность хранилища и сети. <br/><br/> При дополнительном резервном копировании нет необходимости дополнять полные резервные копирования. | Используется для резервного копирования на диск DPM или MABS и во всех резервных копиях в Azure. Не используется для резервного копирования сервера S'L.

## <a name="sql-server-backup-types"></a>Типы резервного копирования SQL Server

В следующей таблице объясняется различные типы резервных отсталых, используемых для баз данных сервера S'L Server, и часто они используются:

**Тип резервного копирования** | **Подробно** | **Использования**
--- | --- | ---
**Полное резервное копирование** | При этом типе резервного копирования создается резервная копия всей базы данных. Он содержит все данные в определенной базе данных или в наборе файлов или файлов. Полная резервная копию также содержит достаточно журналов для восстановления этих данных. | Максимально в день можно активировать одну полную резервную копию.<br/><br/> Вы можете сделать полную резервную перепорку с ежедневным или еженедельным интервалом.
**Дифференциальная резервная капотом** | Дифференциальная резервная капотом основана на последнем, предыдущем резервном копировании полных данных.<br/><br/> Она содержит только данные, которые были изменены с момента создания полной резервной копии. |  Максимально в день можно активировать одну разностную резервную копию.<br/><br/> Невозможно настроить создание полной и разностной резервных копий в один день.
**Резервное копирование журнала транзакций** | Резервная копия журналов транзакций дает возможность восстановления на определенный момент времени с точностью до секунды. | Максимально каждые 15 минут можно настраивать резервные копии журналов транзакций.

### <a name="comparison-of-backup-types"></a>Сравнение типов резервного копирования

Использование хранилища, целевое время восстановления (RTO) и использование ресурсов сети различаются для каждого типа резервного копирования. Следующее изображение показывает сравнение типов резервного копирования:

- Источник данных А состоит из 10 блоков хранения, A1-A10, которые резервируются ежемесячно.
- Блоки A2, A3, A4 и A9 были изменены в первом месяце, а блок A5 — следующем месяце.
- Если применяется разностное резервное копирование, во втором месяце создаются резервные копии измененных блоков A2, A3, A4 и A9. В третьем месяце эти блоки архивируются повторно, как и измененный блок A5. Измененные блоки будут архивироваться, пока не будет создана следующая полная резервная копия.
- Для дополнительных резервных копирований во второй месяц блоки A2, A3, A4 и A9 помечаются как измененные и переданные. В третьем месяце помечается и передается только измененный блок A5.

![Изображение, показывающее сравнение методов резервного копирования](./media/backup-architecture/backup-method-comparison.png)

## <a name="backup-features"></a>Функции службы Backup

В следующей таблице кратко излагаются поддерживаемые функции для различных типов резервного копирования:

**Функция** | **Прямое резервное копирование файлов и складок (с помощью агента MARS)** | **Резервное копирование Azure VM** | **Машины или приложения с DPM/MABS**
--- | --- | --- | ---
Резервное копирование в хранилище | ![Да][green] | ![Да][green] | ![Да][green]
Резервное копирование на диск DPM/MABS, затем в Azure | | | ![Да][green]
Сжатие данных, отправляемых для резервного копирования | ![Да][green] | При передаче данных сжатие не происходит. Хранилище немного увеличивается, но восстановление выполняется быстрее.  | ![Да][green]
Добавочное резервное копирование |![Да][green] |![Да][green] |![Да][green]
Резервное копирование дедуплицированных дисков | | | ![Частично][yellow]<br/><br/> Только для серверов DPM или MABS, развернутых локально.

![Ключ таблицы](./media/backup-architecture/table-key.png)

## <a name="backup-policy-essentials"></a>Основные компоненты политики резервного копирования

- Политика резервного копирования создается в каждом хранилище.
- Политику резервного копирования можно создать для резервного копирования следующих рабочих нагрузок
  - Azure
  - SQL на виртуальной машине Azure
  - Общая папка Azure
- Политики могут назначаться нескольким ресурсам. Политику резервного копирования виртуальной машины Azure можно использовать для защиты нескольких виртуальных машин Azure.
- Политика состоит из двух компонентов
  - Расписание. Когда следует создать резервную копию
  - Хранение. Как долго следует хранить каждую резервную копию.
- Расписание может определяться как ежедневное или еженедельное с настройкой определенного момента времени.
- Период хранения можно определить для ежедневных, еженедельных, ежемесячных и ежегодных точек резервного копирования.
- "Еженедельно" относиться к резервному копированию в определенный день недели, "Ежемесячно" — к резервному копированию в определенный день месяца, а "Ежегодно" — к резервному копированию в определенный день года.
- Период хранения для ежемесячных и ежегодных точек резервного копирования называется LongTermRetention.
- При создании хранилища также создается политика для резервных отсутсвий Azure VM под названием "DefaultPolicy", которая может использоваться для резервного копирования MMs Azure.

## <a name="architecture-built-in-azure-vm-backup"></a>Архитектура: Встроенное резервное копирование Azure VM

1. При запуске резервного копирования для Azure VM резервное копирование выполняется в соответствии с графиком, указанным.
1. Во время первого резервного копирования на VM устанавливается расширение резервного копирования, если VM работает.
    - Для Windows VMs установлено расширение VMSnapshot.
    - Для Linux VMs установлено расширение VMSnapshot Linux.
1. Расширение делает снимок уровня хранилища.
    - Для запуска компьютеров Windows VMs- резервное копирование координирует работу службы копирования теней Windows (VSS) для выполнения согласованного в приложении снимка VM. По умолчанию резервное копирование занимает полное резервное копирование VSS. Если не удалось сделать моментальный снимок с согласованием приложений, служба делает моментальный снимок с согласованием файлов.
    - Для Linux VMs резервное копирование делает снимок файла. Для согласованных моментальных снимков приложений необходимо вручную настроить сценарии pre/post.
    - Служба Backup оптимизируется за счет резервного копирования каждого диска виртуальной машины в параллельном режиме. Для каждого диска, для которого создается резервная копия, служба Azure Backup считывает блоки на диске и сохраняет только измененные данные.
1. После создания моментального снимка данные передаются в хранилище.
    - Скопируются только блоки данных, которые изменились после последнего резервного копирования.
    - Данные не шифруются. Резервное копирование Azure может резервное копирование VMs Azure, которые были зашифрованы с помощью шифрования Azure Disk.
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. В часы пик резервное копирование может занять несколько часов. Общее время резервного копирования для VM будет меньше 24 часов для ежедневных политик резервного копирования.
1. После отправки данных в хранилище создается точка восстановления. По умолчанию снимки сохраняются в течение двух дней до их удаления. Эта функция позволяет восстановить работу с этих снимков, тем самым сокращая время восстановления. Это сокращает время, необходимое для преобразования и копирования данных из хранилища. Смотрите [возможность мгновенной восстановления резервного копирования Azure.](https://docs.microsoft.com/azure/backup/backup-instant-restore-capability)

Вам не нужно явно разрешать подключение к Интернету для резервного копирования вашего ИТ-ми Azure.

![Резервное копирование виртуальных машин Azure](./media/backup-architecture/architecture-azure-vm.png)

## <a name="architecture-direct-backup-of-on-premises-windows-server-machines-or-azure-vm-files-or-folders"></a>Архитектура: Прямое резервное копирование напредх компьютеров Windows Server или файлов Azure VM или папок

1. Чтобы настроить сценарий, вы загружаете и устанавливаете агент MARS на машину. Затем выберите, что следует для резервного копирования, когда будут запущены резервные ожидания и как долго они будут храниться в Azure.
1. Начальная резервная часть выполняется в соответствии с настройками резервного копирования.
1. Агент MARS использует VSS для получения моментального снимка томов, выбранных для резервного копирования.
    - Агент MARS использует только операцию записи системы Windows для захвата снимка.
    - Поскольку агент не использует никаких авторов VSS-приложений, он не захватывает согласованные снимки приложения.
1. После снимка с VSS агент MARS создает виртуальный жесткий диск (VHD) в папке кэша, указанной при настройке резервного копирования. Агент также хранит чеки для каждого блока данных.
1. Дополнительные резервные копирования запускаются в соответствии с графиком, указанным вами, если вы не запустите резервное копирование по требованию.
1. При добавочном резервном копировании идентифицируются измененные файлы и создается новый виртуальный жесткий диск, VHD сжимается и шифруется, а затем отправляется в хранилище.
1. После завершения постепенного резервного копирования новый VHD сливается с VHD, созданным после первоначальной репликации. Это объединенное VHD обеспечивает последнее состояние, используемое для сравнения для текущего резервного копирования.

![Резервное копирование наемных компьютеров Windows Server с агентом MARS](./media/backup-architecture/architecture-on-premises-mars.png)

## <a name="architecture-back-up-to-dpmmabs"></a>Архитектура: Резервное копирование в DPM/MABS

1. Вы устанавливаете агент защиты DPM или MABS на машины, которые вы хотите защитить. Затем машины добавляется в группу защиты DPM.
    - Чтобы защитить локальные компьютеры, сервер DPM или MABS должен располагаться локально.
    - Для защиты виртуальных машин Azure сервер MABS должен находиться в Azure и быть запущен в качестве виртуальной машины Azure.
    - С помощью DPM/MABS можно защитить объемы резервного копирования, акции, файлы и папки. Вы также можете защитить состояние системы машины (голый металл), а также защитить определенные приложения с настройками резервного копирования с информацией о приложениях.
1. При настройке защиты для машины или приложения в DPM/MABS вы выбираете резервное копирование локального диска MABS/DPM для краткосрочного хранения и Azure для защиты в Интернете. Вы также указываете, когда должна работать резервная часть локального хранилища DPM/MABS и когда должна быть запущена резервная часть в сети Azure.
1. Диск защищенной рабочей нагрузки резервное копирование на локальные диски MABS/DPM в соответствии с указанным графиком.
1. Диски DPM/MABS резервное копирование в хранилище агентом MARS, работающим на сервере DPM/MABS.

![Резервное копирование машин и рабочих нагрузок, защищенных DPM или MABS](./media/backup-architecture/architecture-dpm-mabs.png)

## <a name="azure-vm-storage"></a>Хранилище виртуальной машины Azure

Виртуальные машины Azure используют диски для хранения операционной системы, приложений и данных. Каждый VM Azure имеет по крайней мере два диска: диск для операционной системы и временный диск. ВМ Azure также могут иметь диски данных для данных приложений. Диски хранятся как виртуальные жесткие диски.

- VHD хранятся в виде капли страниц в стандартных или премиум-аккаунтах хранения в Azure:
  - **Стандартное хранилище:** Надежная, недорогая дисковая поддержка для стыковых нагрузок с ввоками, которые не чувствительны к задержкам. Стандартное хранилище может использовать стандартные твердотельные диски (SSD) или стандартные диски жесткого диска (HDD).
  - **Премиум-хранилище:** Высокопроизводительная поддержка диска. Используются диски SSD ценовой категории "Премиум".
- Есть разные уровни производительности дисков:
  - **Стандартный HDD диск:** При поддержке HDD и используется для экономичного хранения данных.
  - **Стандартный диск SSD:** Объединяет элементы премиальных SSD-дисков и стандартных ДИСКов HDD. Предлагает более последовательную производительность и надежность, чем HDD, но все еще рентабельный.
  - **Премиум SSD диск:** Опираясь на SSD-накопились и обеспечивают высокую производительность и низкую задержку для vMs, которые работают с ввоза / O-интенсивных рабочих нагрузок.
- Диски могут быть управляемыми или неуправляемыми:
  - **Неуправляемые диски:** Традиционный тип дисков, используемых VMs. Вы можете создать собственную учетную запись хранения и указать ее во время создания такого диска. Затем необходимо выяснить, как максимизировать ресурсы хранения для ваших VMs.
  - **Управляемые диски:** Azure создает и управляет учетными записями хранилища для вас. Вы указываете размер диска и уровень производительности, а Azure создает управляемые диски для вас. При добавлении дисков и масштабирования ВМ Azure обрабатывает учетные записи хранилища.

Для получения дополнительной информации о хранении дисков и доступных типах дисков для vMs см.

- [Управляемые диски Azure для Вымотделам Windows](../virtual-machines/windows/managed-disks-overview.md)
- [Управляемые дисками Azure для Linux VMs](../virtual-machines/linux/managed-disks-overview.md)
- [Доступные типы дисков для VMs](../virtual-machines/windows/disks-types.md)

### <a name="back-up-and-restore-azure-vms-with-premium-storage"></a>Резервное копирование и восстановление VMs Azure с помощью премиум-хранилища

Вы можете создать резервную копию VMs Azure с помощью премиум-хранилища с помощью резервного копирования Azure:

- В процессе резервного копирования ВМ с помощью премиум-хранилища служба резервного копирования создает временное место для настройки, называемое *AzureBackup-* в учетной записи хранилища. Размер промежуточного местоположения равен размеру моментального моментана точки восстановления.
- Убедитесь, что в учетной записи хранения класса Premium достаточно свободного места для расположения временного промежуточного хранения. Для получения дополнительной информации смотрите [целевые показатели масштабируемости для учетных записей хранения капля премиум-страницы.](../storage/blobs/scalability-targets-premium-page-blobs.md) Не следует изменять расположение временного промежуточного хранения.
- По завершении задания резервного копирования расположение промежуточного хранения удаляется.
- Плата за использование расположения промежуточного хранения взимается в соответствии с [тарифами на использование хранилища класса Premium](../virtual-machines/windows/disks-types.md#billing).

При восстановлении VMs Azure с помощью премиум-хранилища можно восстановить их в премиум или стандартное хранилище. Как правило, вы бы восстановить их в премиум-хранилища. Но если вам нужно только подмножество файлов из VM, это может быть экономически эффективным, чтобы восстановить их в стандартном хранилище.

### <a name="back-up-and-restore-managed-disks"></a>Резервное копирование и восстановление управляемых дисков

Вы можете создать резервную связь с помощью управляемых дисков:

- Резервное копирование виртуальных машин с управляемыми дисками выполняется так же, как и любых других виртуальных машин Azure. Резервное копирование виртуальной машины можно выполнить непосредственно в настройках виртуальной машины. Кроме того, вы можете включить резервное копирование виртуальных машин в хранилище Служб восстановления.
- Виртуальные машины, использующие управляемые диски, можно архивировать с помощью наборов точек восстановления, созданных на основе управляемых дисков.
- Резервное копирование Azure также поддерживает резервное копирование VMs с управляемыми дисками, которые были зашифрованы с помощью azure Disk Encryption.

При восстановлении VMs с управляемыми дисками можно восстановить полный VM с управляемыми дисками или учетную запись хранения:

- В процессе восстановления Azure обрабатывает управляемые диски. Если вы используете опцию учетной записи хранилища, вы управляете учетной записью хранилища, созданной в процессе восстановления.
- Если вы восстановите зашифрованный управляемый VM, убедитесь, что ключи и секреты VM существуют в хранилище ключей перед началом процесса восстановления.

## <a name="next-steps"></a>Дальнейшие действия

- Просмотрите матрицу поддержки, чтобы [узнать об поддерживаемых функциях и ограничениях для сценариев резервного копирования.](backup-support-matrix.md)
- Настройка резервного копирования для одного из этих сценариев:
  - [Резервное копирование Azure VMs](backup-azure-arm-vms-prepare.md).
  - [Прямое резервное копирование компьютеров Windows](tutorial-backup-windows-server-to-azure.md) без сервера резервного копирования.
  - [Настройка MABS](backup-azure-microsoft-azure-backup.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в MABS.
  - [Настройка DPM](backup-azure-dpm-introduction.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в DPM.

[green]: ./media/backup-architecture/green.png
[yellow]: ./media/backup-architecture/yellow.png
[red]: ./media/backup-architecture/red.png
