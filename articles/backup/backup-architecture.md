---
title: Архитектура службы Azure Backup
description: Обзор архитектуры, компонентов и процессов, используемых службой Azure Backup.
services: backup
author: dcurwin
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/19/2019
ms.author: dacurwin
ms.openlocfilehash: 7c0a1650490a863f5b3a3cf09a5500d72359e7f1
ms.sourcegitcommit: a52d48238d00161be5d1ed5d04132db4de43e076
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/20/2019
ms.locfileid: "67272003"
---
# <a name="azure-backup-architecture"></a>Архитектура службы Azure Backup

Можно использовать [службы архивации Azure](backup-overview.md) для резервного копирования данных на облачной платформе Microsoft Azure. В этой статье описаны архитектура, компоненты и процессы Azure Backup. 

## <a name="what-does-azure-backup-do"></a>Что такое Azure Backup

Служба архивации Azure создает резервные копии данных, состояние компьютера и рабочих нагрузок, выполняющихся на локальных компьютерах и экземплярах виртуальных машин (ВМ) Azure. Есть несколько сценариев Azure Backup:

## <a name="how-does-azure-backup-work"></a>Как работает Azure Backup

Можно выполнять архивацию компьютеров и данные, используя несколько методов:

- **Резервное копирование локальных компьютеров**:
    - Можно выполнять архивацию виртуальных машин Windows из локальной напрямую в Azure с помощью агента служб восстановления Azure резервного копирования Microsoft Azure (MARS). Компьютеры Linux не поддерживаются.
    - Можно выполнять архивацию локальных компьютеров на сервер службы архивации (System Center Data Protection Manager (DPM) или резервного копирования сервера Microsoft Azure (MABS)). Затем можно выполнять архивацию сервер резервного копирования в хранилище служб восстановления в Azure.

- **Резервное копирование виртуальных машин Azure**:
    - Вы можете напрямую создавать резервные копии виртуальных машин Azure. Служба Azure Backup устанавливает расширение резервного копирования агент виртуальной Машины Azure, на котором выполняется на виртуальной Машине. Это расширение создает резервную копию всей виртуальной машины.
    - Вы можете создавать резервные копии отдельных файлов и папок с виртуальной машины Azure с помощью агента MARS.
    - Можно выполнять архивацию виртуальных машин Azure на сервер MABS, которая работает в Azure, и можно затем резервных копий MABS в хранилище служб восстановления.

Дополнительные сведения о [резервного копирования](backup-overview.md) и около [Поддерживаемые сценарии резервного копирования](backup-support-matrix.md).

## <a name="where-is-data-backed-up"></a>Куда выполняется резервное копирование данных

Служба архивации Azure хранит резервные копии данных в хранилище служб восстановления. Хранилище — это сущность сети хранения данных в Azure, которая используется для хранения данных, таких как резервные копии, точки восстановления и политики резервного копирования.

Хранилища служб восстановления предоставляют следующие возможности:

- Эти хранилища упрощают организацию данных резервного копирования и одновременно снижают затраты на управление.
- В рамках одной подписки Azure можно создать до 500 хранилищ.
- Вы можете отслеживать элементы резервных копий в хранилище, включая виртуальные машины Azure и локальной машины.
- Можно управлять доступом к хранилищу с помощью [управления доступом на основе ролей Azure (RBAC)](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal).
- Нужно указать способ репликации данных в хранилище для обеспечения избыточности:
    - **Локально избыточное хранилище (LRS)** . Для защиты от сбоев в центре обработки данных, можно использовать LRS. LRS реплицирует данные в единицу масштабирования хранилища. [Узнайте больше](https://docs.microsoft.com/azure/storage/common/storage-redundancy-lrs).
    - **Геоизбыточное хранилище (GRS).** Чтобы защититься от сбоев оборудования в регионе, можно использовать GRS. GRS реплицирует данные в дополнительный регион. [Узнайте больше](https://docs.microsoft.com/azure/storage/common/storage-redundancy-grs). 
    - По умолчанию хранилищ служб восстановления используйте GRS. 

## <a name="backup-agents"></a>Агенты Backup

Служба архивации Azure предоставляет различные агенты резервного копирования, в зависимости от типа компьютера выполняется резервное копирование:

**Агент** | **Сведения** 
--- | --- 
**Агент служб восстановления Microsoft AZURE** | <ul><li>Выполняется на отдельных локальных компьютеров Windows Server для резервного копирования файлов, папок и состояния системы.</li> <li>Выполняется на виртуальных машинах Azure для резервного копирования файлов, папок и состояния системы.</li> <li>Работает на серверах DPM или MABS для резервного копирования диск DPM или MABS локального хранилища в Azure.</li></ul> 
**Расширение виртуальной машины Azure** | Выполняется на виртуальных машинах Azure для создания их резервных копий в хранилище.

## <a name="backup-types"></a>Типы резервных копий

В следующей таблице описаны различные типы резервных копий, а также когда они используются:

**Тип резервного копирования** | **Сведения** | **Использование**
--- | --- | ---
**Полное** | Полная резервная копия содержит всего источника данных. Принимает больше пропускной способности, чем добавочных или разностных резервных копий. | Используется для начального резервного копирования.
**Разностное** |  Разностная резервная копия сохраняет блоков, измененных с момента первоначальной полной резервной копии. Использует меньший объем сети и хранилища, а не защиту резервных копий данных без изменений.<br/><br/> Неэффективным, так как блоки данных, которые остались неизменными на пути между последующие резервные копии передачи и сохранения. | Не используется службой Azure Backup.
**Добавочное** | Добавочное резервное копирование сохраняет только те блоки, которые изменены с момента предыдущего резервного копирования данных. Высокая эффективность хранилища и сети. <br/><br/> При использовании добавочной архивации нет необходимости в дополнение к с полными резервными копиями. | Используется для резервного копирования на диск DPM или MABS и во всех резервных копиях в Azure.

## <a name="sql-server-backup-types"></a>Типы резервного копирования SQL Server

В следующей таблице описаны различные типы резервных копий для базы данных SQL Server и как часто они используются:

**Тип резервного копирования** | **Сведения** | **Использование**
--- | --- | ---
**Полная резервная копия** | При этом типе резервного копирования создается резервная копия всей базы данных. Он содержит все данные в определенной базе данных или набор файлов или файловых групп. Полное резервное копирование также содержит достаточное количество журналов для восстановления этих данных. | Максимально в день можно активировать одну полную резервную копию.<br/><br/> Можно выбрать для выполнения полного резервного копирования с периодичностью, ежедневно или еженедельно.
**Разностная резервная копия** | Разностное резервное копирование основано на наиболее последней предыдущей полной данных резервной копии.<br/><br/> Она содержит только данные, которые были изменены с момента создания полной резервной копии. |  Максимально в день можно активировать одну разностную резервную копию.<br/><br/> Невозможно настроить создание полной и разностной резервных копий в один день.
**Резервная копия журналов транзакций** | Резервная копия журналов транзакций дает возможность восстановления на определенный момент времени с точностью до секунды. | Максимально каждые 15 минут можно настраивать резервные копии журналов транзакций.

### <a name="comparison-of-backup-types"></a>Сравнение типов резервных копий

Использование хранилища, целевое время восстановления (RTO) и использование ресурсов сети различаются для каждого типа резервного копирования. Сравнение типов резервных копий на следующем рисунке:

- Источник данных A состоит из 10 хранилища блоков, A1 – A10, которые архивируются ежемесячно.
- Блоки A2, A3, A4 и A9 были изменены в первом месяце, а блок A5 — следующем месяце.
- Если применяется разностное резервное копирование, во втором месяце создаются резервные копии измененных блоков A2, A3, A4 и A9. В третьем месяце эти блоки архивируются повторно, как и измененный блок A5. Измененные блоки будут архивироваться, пока не будет создана следующая полная резервная копия.
- Для добавочных резервных копий, во втором месяце блоки A2, A3, A4 и A9 помечаются как изменен и передать. В третьем месяце помечается и передается только измененный блок A5. 

![Рисунок, демонстрирующий Сравнение методов архивации](./media/backup-architecture/backup-method-comparison.png)

## <a name="backup-features"></a>Функции службы Backup

В следующей таблице перечислены поддерживаемые функции для различных типов резервного копирования:

**Возможность** | **Локальные компьютеры Windows Server (программа direct)** | **Виртуальные машины Azure** | **Компьютеров или приложений с помощью DPM или MABS**
--- | --- | --- | ---
Резервное копирование в хранилище | ![Да][green] | ![Да][green] | ![Да][green] 
Резервное копирование на диск DPM или MABS, затем в Azure | | | ![Да][green] 
Сжатие данных, отправляемых для резервного копирования | ![Да][green] | При передаче данных сжатие не происходит. Хранилище немного увеличивается, но восстановление выполняется быстрее.  | ![Да][green] 
Добавочное резервное копирование |![Да][green] |![Да][green] |![Да][green] 
Резервное копирование дедуплицированных дисков | | | ![Частично][yellow]<br/><br/> Только для серверов DPM или MABS, развернутых локально. 

![Ключ таблицы](./media/backup-architecture/table-key.png)

## <a name="architecture-direct-backup-of-azure-vms"></a>Архитектура. Прямое резервное копирование виртуальных машин Azure

1. При включении резервного копирования для виртуальной Машины Azure в соответствии с расписанием, указанную вами выполняется резервной копии.
1. Во время первой резервной копии расширение резервного копирования устанавливается на виртуальной Машине, если виртуальная машина запущена.
    - Для виртуальных машин Windows устанавливается расширение VMSnapshot.
    - Для виртуальных машин Linux устанавливается расширение VMSnapshot Linux.
1. Модуль создает моментальный снимок уровня хранилища. 
    - Для виртуальных машин Windows, которые выполняются резервное копирование координирует с Windows тома службы теневого копирования (VSS) согласованные снимка виртуальной Машины. По умолчанию резервное копирование принимает полные резервные копии VSS. Если не удалось сделать моментальный снимок с согласованием приложений, служба делает моментальный снимок с согласованием файлов.
    - Для виртуальных машин Linux резервного копирования создает моментальный согласованием файлов. Для моментальных снимков, приемлемых для приложений необходимо вручную настроить такие сценарии.
    - Служба Backup оптимизируется за счет резервного копирования каждого диска виртуальной машины в параллельном режиме. Для каждого диска, для которого создается резервная копия, служба Azure Backup считывает блоки на диске и сохраняет только измененные данные. 
1. После создания моментального снимка данные передаются в хранилище. 
    - Только блоки данных, которые изменены с момента последнего резервного копирования, копируются.
    - Данные не шифруются. Служба архивации Azure резервного копирования виртуальных машин Azure, которые были зашифрованы с помощью шифрования дисков Azure.
    - Данные моментального снимка нельзя сразу же скопировать в хранилище. В часы пик резервное копирование может занять несколько часов. Общее время резервного копирования для виртуальной Машины будет менее 24 часов для политик ежедневной архивации.
1. После отправки данных в хранилище, моментальный снимок удаляется и создается точка восстановления.

Виртуальные машины Azure нужен доступ к Интернету для команды управления. Если выполняется резервное копирование рабочих нагрузок на виртуальной Машине (например, SQL Server резервные копии баз данных), внутренних данных также требуется доступ к Интернету. 

![Резервное копирование виртуальных машин Azure](./media/backup-architecture/architecture-azure-vm.png)

## <a name="architecture-direct-backup-of-on-premises-windows-server-machines-or-azure-vm-files-or-folders"></a>Архитектура. Прямое резервное копирование виртуальных машин Windows Server из локальной или виртуальной Машины Azure файлов или папок

1. Чтобы настроить сценарий, скачайте и установите агент служб восстановления Microsoft AZURE на компьютере. Затем выбирается объектов для архивации, когда будет выполняться резервное копирование и как долго они будут храниться в Azure.
1. Начальное резервное копирование выполняется в соответствии с настройками резервного копирования.
1. Агент MARS использует VSS, чтобы создать моментальный снимок тома, выбранные для резервного копирования на определенный момент.
    - Агент служб восстановления Microsoft AZURE использует только операции записи системы Windows для записи моментальный снимок.
    - Так как агент не использует все модули записи VSS приложение, он не фиксирует моментальных снимков с согласованием приложений.
1. После создания моментального снимка с помощью службы VSS, агент MARS создает виртуального жесткого диска (VHD) в папке кэша, указанный при настройке резервного копирования. Он также сохраняет контрольные суммы для каждого блока данных.
1. Запускать добавочное резервное копирование в соответствии с расписанием, указанную вами, если необходимо выполнять резервное копирование ad-hoc.
1. При добавочном резервном копировании идентифицируются измененные файлы и создается новый виртуальный жесткий диск, Виртуальный жесткий ДИСК сжимаются и шифруются и отправляются в хранилище.
1. По окончании работы добавочное резервное копирование нового виртуального жесткого диска объединяется с VHD, созданный после начальной репликации. Этот объединенный виртуальный жесткий ДИСК содержит последние состояние, которое должно использоваться для сравнения для текущего резервного копирования.

![Резервное копирование локальных компьютеров Windows Server с агентом служб восстановления Microsoft AZURE](./media/backup-architecture/architecture-on-premises-mars.png)

## <a name="architecture-back-up-to-dpmmabs"></a>Архитектура. Резервное копирование в DPM и MABS

1. Установите агент защиты DPM или MABS на компьютерах, которые необходимо защитить. Затем добавьте компьютеры в группу защиты DPM.
    - Чтобы защитить локальные компьютеры, сервер DPM или MABS должен располагаться локально.
    - Для защиты виртуальных машин Azure сервер MABS должен находиться в Azure и быть запущен в качестве виртуальной машины Azure.
    - С помощью DPM или MABS можно защитить резервного копирования тома, общие папки, файлы и папки. Можно также обеспечить защиту состояния системы на компьютере (без операционной системы), и конкретные приложения можно защитить с помощью параметров приложения с поддержкой резервного копирования.
1. При настройке защиты для виртуальной машины или приложения в DPM или MABS, выберите для резервного копирования на сервере MABS/DPM локальный диск для кратковременного хранения, а также в Azure для оперативной защиты. Можно также указать, когда должно выполняться резервное копирование в локальное хранилище DPM или MABS, и время запуска резервного копирования Azure.
1. Резервного копирования на диск защищаемых рабочих нагрузок на локальных дисках MABS/DPM, в соответствии с расписанием, которое вы указали.
4. Диски DPM или MABS резервное копирование в хранилище по агента MARS, на котором выполняется на сервере DPM или MABS.

![Резервное копирование компьютеров и рабочих нагрузок, защищенных DPM или MABS](./media/backup-architecture/architecture-dpm-mabs.png)

## <a name="azure-vm-storage"></a>Хранилище виртуальной машины Azure

Виртуальные машины Azure используют диски для хранения операционной системы, приложений и данных. Каждая виртуальная машина Azure имеет по крайней мере два диска: на диск для операционной системы и временный диск. Виртуальные машины Azure также может иметь диски данных для данных приложения. Диски хранятся как виртуальные жесткие диски.

- Виртуальные жесткие диски хранятся в виде страничных BLOB-объектов в учетных записях хранения класса standard или premium в Azure:
    - **Стандартное хранилище:** Надежная и недорогая поддержка дисков для рабочих нагрузок виртуальных машин, которые нечувствительны к задержке. Хранилище класса Standard можно использовать стандартный твердотельного накопителя (SSD) диски или диски стандартного жесткого диска (HDD).
    - **Хранилище уровня "премиум":** Поддержка высокопроизводительных дисков. Используются диски SSD ценовой категории "Премиум".
- Есть разные уровни производительности дисков:
    - **Стандартный диск HDD:** Копирование на жесткие диски, используются для экономичного хранилища.
    - **Стандартный диск SSD:** Объединяет элементы диски SSD класса premium и standard диски HDD. Предлагает более согласованную производительность и надежность, чем жесткого диска, но по-прежнему экономичное.
    - **Диск SSD "премиум":** Диски SSD и обеспечивает высокую производительность и низкой задержкой для виртуальных машин, выполняющих рабочие нагрузки ввода-вывода.
- Диски могут быть управляемыми или неуправляемыми:
    - **Неуправляемые диски:** Традиционный тип дисков, используемых виртуальными машинами. Вы можете создать собственную учетную запись хранения и указать ее во время создания такого диска. Затем необходимо выяснить, как максимально эффективно использовать ресурсы хранилища для виртуальных машин.
    - **Управляемые диски**. Azure создает и управляет учетными записями хранения. Указать уровень диска размером и производительностью, а Azure создаст управляемые диски для вас. При добавлении дисков и масштабирование виртуальных машин, Azure обрабатывает учетные записи хранения.

Дополнительные сведения о диске и типы доступных дисков для виртуальных машин см. в статьях:

- [Управляемые диски для виртуальных машин Windows Azure](../virtual-machines/windows/managed-disks-overview.md)
- [Управляемые диски Azure для виртуальных машин Linux](../virtual-machines/linux/managed-disks-overview.md)
- [Типы доступных дисков для виртуальных машин](../virtual-machines/windows/disks-types.md)

### <a name="back-up-and-restore-azure-vms-with-premium-storage"></a>Резервное копирование и восстановление виртуальных машин Azure с помощью хранилища уровня "премиум" 

Можно выполнять архивацию виртуальных машин Azure с помощью хранилища уровня "премиум" с помощью службы архивации Azure:

- В процессе резервного копирования виртуальных машин с хранилищем класса premium в службе резервного копирования создает временного промежуточного расположения с именем *AzureBackup -* , в учетной записи хранения. Размер промежуточной папки равен размеру моментального снимка точки восстановления.
- Убедитесь, что в учетной записи хранения класса Premium достаточно свободного места для расположения временного промежуточного хранения. [Узнайте больше](../storage/common/storage-scalability-targets.md#premium-performance-storage-account-scale-limits). Не следует изменять расположение временного промежуточного хранения.
- По завершении задания резервного копирования расположение промежуточного хранения удаляется.
- Плата за использование расположения промежуточного хранения взимается в соответствии с [тарифами на использование хранилища класса Premium](../virtual-machines/windows/disks-types.md#billing).

При восстановлении виртуальных машин Azure с помощью хранилища уровня "премиум", их можно восстановить для уровня "премиум" или хранилища класса standard. Как правило вы бы восстановить их в хранилище класса premium. Но если вам требуется только подмножество файлов из виртуальной Машины, может быть экономии можно восстановить их в стандартное хранилище.

### <a name="back-up-and-restore-managed-disks"></a>Резервное копирование и восстановление управляемых дисков

Можно выполнить резервное копирование виртуальных машин Azure с управляемыми дисками:

- Резервное копирование виртуальных машин с управляемыми дисками выполняется так же, как и любых других виртуальных машин Azure. Резервное копирование виртуальной машины можно выполнить непосредственно в настройках виртуальной машины. Кроме того, вы можете включить резервное копирование виртуальных машин в хранилище Служб восстановления.
- Виртуальные машины, использующие управляемые диски, можно архивировать с помощью наборов точек восстановления, созданных на основе управляемых дисков.
- Служба архивации Azure также поддерживает резервное копирование виртуальных машин с управляемыми дисками, которые были зашифрованы с помощью шифрования дисков Azure.

При восстановлении виртуальных машин с управляемыми дисками, можно восстановить готовой виртуальной Машины с управляемыми дисками или учетной записи хранения:

- В процессе восстановления Azure обрабатывает управляемые диски. Если вы используете параметр учетной записи хранения, вы управлять учетной записи хранения, которая создается во время процесса восстановления.
- При восстановлении управляемой виртуальной Машины, шифруются, убедитесь, что виртуальной Машины ключи и секреты существует в хранилище ключей, прежде чем начать процесс восстановления.

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь с таблицей поддержки для [сведения о поддерживаемых возможностях и ограничениях для сценарии резервного копирования](backup-support-matrix.md).
- Настройка резервного копирования для одного из этих сценариев:
    - [Архивация виртуальных машин Azure](backup-azure-arm-vms-prepare.md).
    - [Прямое резервное копирование компьютеров Windows](tutorial-backup-windows-server-to-azure.md) без сервера резервного копирования.
    - [Настройка MABS](backup-azure-microsoft-azure-backup.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в MABS.
    - [Настройка DPM](backup-azure-dpm-introduction.md) для резервного копирования в Azure и последующее резервное копирование рабочих нагрузок в DPM.


[green]: ./media/backup-architecture/green.png
[yellow]: ./media/backup-architecture/yellow.png
[red]: ./media/backup-architecture/red.png

