---
title: Автономное резервное копирование с помощью DPM и Azure Backup Server
description: С помощью резервного копирования Azure можно отправлять данные из сети с помощью службы импорта/экспорта Azure. В этой статье объясняется рабочий процесс резервного копирования в автономном режиме для DPM и Azure Backup Server.
ms.reviewer: saurse
ms.topic: conceptual
ms.date: 1/28/2020
ms.openlocfilehash: 080b0bc53b2058bd186e90f354b8f5bcda510414
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78197090"
---
# <a name="offline-backup-workflow-for-dpm-and-azure-backup-server"></a>Рабочий процесс резервного копирования в автономном режиме для DPM и сервера резервного копирования Azure

В службу архивации Azure встроено несколько эффективных методов, которые позволяют экономить затраты на сеть и хранилище во время передачи начальных полных резервных копий данных в Azure. Обычно при этом выполняется передача больших объемов данных. Следовательно, для первой архивации требуется более высокая пропускная способность по сравнению с последующими операциями архивации, в ходе которых передаются только изменения или добавочные резервные копии. Служба архивации Azure сжимает начальные резервные копии, а также предоставляет механизм передачи сжатых копий данных в Azure с помощью дисков за счет процесса автономного заполнения.

Процесс автономного посева резервного копирования Azure тесно интегрирован с [сервисом Azure Import/Export.](../storage/common/storage-import-export-service.md) Эту службу можно использовать для передачи данных в Azure с помощью дисков. Если у вас есть терабайты (TBs) исходных данных резервного копирования, которые должны быть переданы через сеть с высокой задержкой и низкой пропускной способностью, вы можете использовать рабочий процесс автономного посева для отправки исходной копии резервного копирования на одном или нескольких жестких дисках в центр обработки данных Azure. В этой статье представлен обзор и дальнейшие шаги, которые завершают работу для менеджера по защите данных System Center (DPM) и сервера резервного копирования Microsoft Azure (MABS).

> [!NOTE]
> Процесс автономного резервного копирования для агента Microsoft Azure Recovery Services (MARS) отличается от DPM и MABS. Для получения информации об использовании автономного [Offline backup workflow in Azure Backup](backup-azure-backup-import-export.md)резервного копирования с агентом MARS см. Резервное копирование в автономном режиме не поддерживается для резервного копирования состояния системы, выполненного с помощью резервного агента Azure.
>

## <a name="overview"></a>Обзор

Благодаря возможности резервного копирования ВСУ в автономном режиме и службы импорта/экспорта Azure просто загрузить данные в автономный режим в Azure с помощью дисков. Процесс автономного резервного копирования включает следующие шаги:

> [!div class="checklist"]
>
> * Данные резервного копирования записываются в место постановки вместо отправки по сети.
> * Данные о месте постановки затем записываются на один или несколько дисков SATA с помощью утилиты *AzureOfflineBackupDiskPrep.*
> * Задания импорта Azure автоматически создаются утилитой.
> * Затем диски SATA отправляются в ближайший центр обработки данных Azure.
> * После передачи резервной копии данных в Azure служба архивации Azure копирует эти данные в хранилище службы архивации, после чего планируется добавочное резервное копирование.

## <a name="supported-configurations"></a>Поддерживаемые конфигурации

Резервное копирование в автономном режиме поддерживается для всех моделей развертывания резервного копирования Azure, которые резервного копирования данных из наисходных в облако Майкрософт. Эти модели включают в себя:

> [!div class="checklist"]
>
> * Резервное копирование файлов и папок с помощью агента MARS или резервного агента Azure.
> * Резервное копирование всех рабочих нагрузок и файлов с Помощью DPM.
> * Резервное копирование всех рабочих нагрузок и файлов с MABS.

## <a name="prerequisites"></a>Предварительные требования

Убедитесь, что перед запуском рабочего процесса резервного копирования в автономном режиме будут выполнены следующие предпосылки:

* Создано [хранилище служб восстановления](backup-azure-recovery-services-vault-overview.md). Чтобы создать его, выполните последующие шаги в [хранилище служб восстановления](tutorial-backup-windows-server-to-azure.md#create-a-recovery-services-vault)
* Агент резервного копирования Azure или MABS или DPM установлен либо на Windows Server, либо на клиенте Windows, если это применимо, и компьютер зарегистрирован в хранилище служб восстановления. Убедитесь, что вы используете [самую последнюю версию агента Azure Backup](https://go.microsoft.com/fwlink/?linkid=229525).
* [Загрузите файл настроек Azure](https://portal.azure.com/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) на компьютере, с которого планируется резервное копирование данных. Подписка, с которой вы загружаете файл настроек публикации, может отличаться от подписки, содержащей хранилище служб восстановления. Если ваша подписка находится в суверенных облаках Azure, используйте следующие ссылки по мере необходимости для загрузки файла настроек Azure.

    | Регион национального облака | Azure публикует ссылку на настройки файла |
    | --- | --- |
    | США | [Ссылку](https://portal.azure.us#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) |
    | Китай | [Ссылку](https://portal.azure.cn/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) |

* Учетная запись хранения Azure с моделью развертывания ресурсного менеджера была создана в подписке, из которой вы загрузили файл параметров публикации.

  ![Создание учетной записи хранилища с развитием менеджера ресурсов](./media/backup-azure-backup-import-export/storage-account-resource-manager.png)

* Создано промежуточное расположение. Это может быть сетевая папка или дополнительный диск на сервере, внутренний или внешний, на котором доступно достаточно пространства для хранения начальной копии. Например, если требуется резервное копирование файлового сервера на 500 ГБ, убедитесь, что промежуточная область составляет не менее 500 ГБ. (Хотя фактически использованный объем будет меньшим.)
* Для дисков, отправленных в Azure, убедитесь, что используются только 2,5-дюймовый SSD или 2,5-дюймовый или 3,5-дюймовый SATA II/III внутренние жесткие диски SATA II/III. Можно использовать жесткие диски емкостью до 10 ТБ. Список поддерживаемых дисков см. в [документации по службе импорта и экспорта Azure](../storage/common/storage-import-export-requirements.md#supported-hardware).
* Диски SATA должны быть подключены к компьютеру (*компьютер копирования*), на котором выполняется копирование данных резервной копии из промежуточного расположения на диски SATA. Убедитесь, что BitLocker включен на копировальной компьютере.

## <a name="prepare-the-server-for-the-offline-backup-process"></a>Подготовка сервера к процессу резервного копирования в автономном режиме

>[!NOTE]
> Если вы не можете найти перечисленные утилиты, такие как *AzureOfflineBackupCertGen.exe*, AskAzureBackupTeam@microsoft.com в вашей установке агента MARS, напишите, чтобы получить к ним доступ.

* Откройте запрос повышенной команды на сервере и запустите следующую команду:

    ```cmd
    AzureOfflineBackupCertGen.exe CreateNewApplication SubscriptionId:<Subs ID>
    ```

    Инструмент создает приложение active Directory Backup Backline Azure, если его не существует.

    Если приложение уже существует, это исполняемое просит вас вручную загрузить сертификат в приложение в арендаторе. Выполните действия в [этом разделе,](#manually-upload-an-offline-backup-certificate) чтобы загрузить сертификат вручную в приложение.

* Инструмент *AzureOfflineBackup.exe* генерирует файл *OfflineApplicationParams.xml.* Копируйте этот файл на сервер с помощью MABS или DPM.
* Установите [новейший агент MARS](https://aka.ms/azurebackup_agent) на экземпляре DPM или на сервере резервного копирования Azure.
* Зарегистрируйте сервер в Azure.
* Выполните следующую команду:

    ```cmd
    AzureOfflineBackupCertGen.exe AddRegistryEntries SubscriptionId:<subscriptionid> xmlfilepath:<path of the OfflineApplicationParams.xml file>  storageaccountname:<storageaccountname configured with Azure Data Box>
    ```

* Предыдущая команда создает `C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch\MicrosoftBackupProvider\OfflineApplicationParams_<Storageaccountname>.xml`файл.

## <a name="manually-upload-an-offline-backup-certificate"></a>Ручная загрузка резервного сертификата в автономном режиме

Выполните эти действия, чтобы вручную загрузить автономный сертификат резервного копирования в ранее созданное приложение Azure Active Directory, предназначенное для резервного копирования в автономном режиме.

1. Войдите на портал Azure.
1. Перейдите к > **регистрации приложений**Active **Directory Azure**.
1. На вкладке **Принадлежащих приложений** найдите `AzureOfflineBackup _<Azure User Id`приложение с форматом имени дисплея.

    ![Найдите приложение на вкладке «Принадлежащие приложения»](./media/backup-azure-backup-import-export/owned-applications.png)

1. Выберите приложение. Под **Управление** на левом стеле, перейдите **на сертификаты & секреты**.
1. Проверьте наличие уже существующих сертификатов или открытых ключей. Если их нет, можно безопасно удалить приложение, выбрав кнопку **«Удалить»** на странице **«Обзор»** приложения. Затем можно повторить шаги, чтобы [подготовить сервер к процессу резервного копирования](#prepare-the-server-for-the-offline-backup-process) в автономном режиме, и пропустить следующие шаги. В противном случае продолжайте выполнять эти действия с экземпляра DPM или сервера резервного копирования Azure, где требуется настроить резервное копирование в автономном режиме.
1. Выберите **приложение сертификата** > Управления компьютером**Personal** tab. Ищите сертификат с именем. `CB_AzureADCertforOfflineSeeding_<ResourceId>`
1. Выберите сертификат, нажмите **правой**кнопкой все задачи , а затем выберите **Экспорт**, без частного ключа, в формате .cer.
1. Перейдите в автономное приложение резервного копирования Azure на портале Azure.
1. Выберите **Сертификаты управления** > **& сертификатом загрузки секретов.** > **Upload certificate** Загрузите сертификат, экспортированный на предыдущем этапе.

    ![Загрузка сертификата](./media/backup-azure-backup-import-export/upload-certificate.png)

1. На сервере откройте реестр, введя **regedit** в окне выполнения.
1. Перейдите к *записи в реестрЕ КомпьютерHKEY_LOCAL_MACHINE-SOFTWARE-Microsoft-Windows Azure Резервное копирование (Config-CloudBackupProvider Provider.*
1. Право нажмите **CloudBackupProvider**, и добавить `AzureADAppCertThumbprint_<Azure User Id>`новое значение строки с именем .

    >[!NOTE]
    > Чтобы найти идентификатор пользователя Azure, сделайте один из следующих шагов:
    >
    >* Из подключенной к Azure PowerShell запустите `Get-AzureRmADUser -UserPrincipalName “Account Holder’s email as appears in the portal”` команду.
    >* Перейти на `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DbgSettings\OnlineBackup; Name: CurrentUserId;`путь реестра .

1. Нажмите правой кнопкой мыши строки, добавленной на предыдущем этапе, и выберите **Modify**. В значении укажите отпечаток пальца сертификата, который вы экспортировали в шаге 7. Затем выберите **OK**.
1. Чтобы получить значение отпечатка пальца, дважды щелкните сертификат. Выберите вкладку **«Детали»** и прокрутите вниз, пока не увидите поле отпечатков пальцев. Выберите **Thumbprint**и скопируйте значение.

    ![Копирование значения из поля отпечатков пальцев](./media/backup-azure-backup-import-export/thumbprint-field.png)

1. Продолжить раздел [Рабочего процесса,](#workflow) чтобы продолжить процесс резервного копирования в автономном режиме.

## <a name="workflow"></a>Рабочий процесс

Информация в этом разделе помогает закончить рабочий процесс резервного копирования в автономном режиме, чтобы ваши данные могли быть доставлены в центр обработки данных Azure и загружены в хранилище Azure. Если у вас есть вопросы об услуге импорта [Import service overview documentation](../storage/common/storage-import-export-service.md) или любом аспекте процесса, см.

### <a name="initiate-offline-backup"></a>Запуск автономного резервного копирования

1. При составлении резервного копирования вы видите следующую страницу в Windows Server, клиенте Windows или DPM.

    ![Страница импорта](./media/backup-azure-backup-import-export/offlineBackupscreenInputs.png)

    Вот соответствующая страница в DPM. <br/>
    
    ![Страница импорта DPM и Azure Backup Server](./media/backup-azure-backup-import-export/dpmoffline.png)

    Коробки, которые вы заполняете:

   * **Промежуточное расположение**— временное хранилище, куда записывается начальная резервная копия. Место для постановки может находиться на сетевой акции или локальном компьютере. Если компьютер копии и исходный компьютер отличаются, укажите полный сетевой путь промежуточного местоположения.
   * **Настройки публикации Azure**: Локальный путь к файлу настроек публикации.
   * **Название работы Azure Import:** Уникальное название, под которым служба Azure Import/Export и резервное копирование Azure отслеживают передачу данных, отправляемых на дисках, в Azure.
   * **Идентификатор подписки Azure:** Идентификатор подписки Azure для подписки, из которой вы скачали файл настроек Azure.
   * **Учетная запись хранения Azure**: Имя учетной записи хранилища в подписке Azure, связанной с файлом настроек Azure.
   * **Контейнер службы хранилища Azure** — имя хранилища BLOB-объектов в учетной записи хранения Azure, куда импортируются данные резервных копий.

   Сохранить **информацию** о местоположении и предоставленной вами информации об **именем импортного названия Azure.** Это необходимо для подготовки дисков.

1. Завершите рабочий процесс. Чтобы инициировать копию резервного копирования в автономном режиме, выберите **Back Up Now** на консоли управления резервным копированием Azure. На этом этапе начальная резервная копия записывается в промежуточное расположение.

    ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/backupnow.png)

    Чтобы закончить соответствующий рабочий процесс в DPM или Azure Backup Server, нажмите правой кнопкой мыши **группы защиты.** Выберите опцию **точки восстановления Создать.** Затем выберите опцию **«Онлайн-защита».**

    ![DPM и MABS Резервное копирование сейчас](./media/backup-azure-backup-import-export/dpmbackupnow.png)

    После завершения операции промежуточное расположение можно использовать для подготовки дисков.

    ![Ход выполнения резервного копирования](./media/backup-azure-backup-import-export/opbackupnow.png)

### <a name="prepare-sata-drives-and-ship-to-azure"></a>Подготовка дисков SATA и их отправка в Azure

Утилита *AzureOfflineBackupDiskPrep* используется для подготовки дисков SATA, отправляемых в ближайший центр обработки данных Azure. Эта утилита доступна в каталоге установки агента служб восстановления в следующем пути:

`*\\Microsoft Azure Recovery Services Agent\Utils\*`

1. Перейдите по этому пути и скопируйте каталог *AzureOfflineBackupDiskPrep* на компьютер копирования, к которому присоединены подготавливаемые диски SATA. Убедитесь в следующем:

   * Копировальная компьютер может получить доступ к местоположению постановки для автономного посева рабочего процесса, используя тот же сетевой путь, который был предоставлен в рабочем процессе в разделе "Инициировать автономное резервное копирование".
   * На компьютере копирования включен инструмент BitLocker.
   * Компьютер копирования имеет доступ к порталу Azure. При необходимости целевым компьютером может быть исходный компьютер.

     > [!IMPORTANT]
     > Если исходный компьютер является виртуальной машиной, то обязательно использовать другой физический сервер или клиентскую машину в качестве копировального компьютера.

1. Откройте запрос повышенной команды на копировальном компьютере с каталогом утилиты *AzureOfflineBackupDiskPrep* в качестве текущего каталога. Выполните следующую команду:

    `*.\AzureOfflineBackupDiskPrep.exe*   s:<*Staging Location Path*>   [p:<*Path to AzurePublishSettingsFile*>]`

    | Параметр | Описание |
    | --- | --- |
    | s:&lt;*Путь расположения постановки*&gt; |Этот обязательный вход используется для обеспечения пути к местоположению постановки, всводноваемым в рабочий процесс в разделе "Инициировать автономное резервное копирование". |
    | p:&lt;*Путь к публикациямНастройкиФайл*&gt; |Этот дополнительный вхотворный данный используется для обеспечения пути к файлу параметров публикации Azure, который вы ввели в рабочий процесс в разделе "Инициировать автономное резервное копирование". |

    > [!NOTE]
    > Если компьютер копирования и исходный компьютер разные, то нужно обязательно указать значение &lt;Path to PublishSettingFile&gt; (Путь к файлу параметров публикации).
    >
    >

    При запуске команды утилита запрашивает выбор задания импорта Azure, которое соответствует дискам, которые должны быть подготовлены. Если только одно задание импорта связано с предоставленным местом постановки, вы видите страницу, подобную этой.

    ![Ввод инструмента подготовки дисков Azure](./media/backup-azure-backup-import-export/azureDiskPreparationToolDriveInput.png) <br/>

1. Введите букву подключенного диска (без двоеточия), который нужно подготовить для передачи в Azure. При запросе предоставьте подтверждение форматированию диска.

    Затем инструмент начинает готовить диск и копировать данные резервного копирования. Возможно, потребуется прикрепить дополнительные диски по запросу инструмента в случае, если предоставленный диск не имеет достаточного места для данных резервного копирования. <br/>

    После успешной завершения инструмента один или несколько предоставленных вами дисков будут подготовлены к отправке в Azure. Задание импорта с именем, которое вы предоставили во время рабочего процесса в разделе «Инициировать автономное резервное копирование», также создается в Azure. Наконец, в инструменте отображается адрес центра обработки данных Azure, в который необходимо передать диски.

    ![Подготовка лазурного диска завершена](./media/backup-azure-backup-import-export/azureDiskPreparationToolSuccess.png)<br/>

1. В конце выполнения команды также можно увидеть возможность обновления информации о доставке.

    ![Обновление возможности получения информации о доставке](./media/backup-azure-backup-import-export/updateshippingutility.png)<br/>

1. Можно сразу же ввести необходимые сведения. Инструмент проведет вас через процесс, который включает в себя ряд входов. Если у вас нет такой информации, как номер отслеживания или другие сведения, связанные с доставкой, вы можете закончить сеанс. Инструкции по изменению сведений для доставки приведены позже в этой статье.

1. Отправь диски по адресу, предоставленному инструментом. Храните номер отслеживания для будущей ссылки.

   > [!IMPORTANT]
   > Нет двух заданий импорта Azure может иметь один и тот же номер отслеживания. Убедитесь, что диски, подготовленные утилитой под единым заданиям по импорту Azure, отправляются вместе в один пакет и что для пакета есть единый уникальный номер отслеживания. Не комбинируйте диски, подготовленные в рамках различных заданий импорта Azure, в один пакет.

1. Если у вас есть информация о номере отслеживания, перейдите на исходный компьютер, который ожидает завершения работы импорта. Запустите следующую команду в повышенном запросе команды с каталогом утилиты *AzureOfflineBackupDiskPrep* в качестве текущего каталога.

   `*.\AzureOfflineBackupDiskPrep.exe*  u:`

   Можно дополнительно запустить следующую команду с другого компьютера, например копируем, с каталогом утилиты *AzureOffLineBackupDiskPrep* в качестве текущего каталога.

   `*.\AzureOfflineBackupDiskPrep.exe*  u:  s:<*Staging Location Path*>   p:<*Path to AzurePublishSettingsFile*>`

    | Параметр | Описание |
    | --- | --- |
    | u: | Этот обязательный вход используется для обновления деталей доставки для выполнения задания по импорту Azure. |
    | s:&lt;*Путь расположения постановки*&gt; | Этот обязательный вход используется, когда команда не запущена на исходном компьютере. Он используется для обеспечения пути к местоположению постановки, всводноваемым в рабочий процесс в разделе "Инициировать автономное резервное копирование". |
    | p:&lt;*Путь к публикациямНастройкиФайл*&gt; | Этот обязательный вход используется, когда команда не запущена на исходном компьютере. Он используется для предоставления пути к файлу параметров публикации Azure, который вы ввели в рабочий процесс в разделе "Инициировать автономное резервное копирование". |

    Утилита автоматически обнаруживает задания импорта, на исходное местоположение— или задания импорта, связанные с местом постановки, когда команда запущена на другом компьютере. Затем он предоставляет возможность обновления информации о доставке с помощью ряда входов.

    ![Введите информацию о доставке](./media/backup-azure-backup-import-export/shippinginputs.png)<br/>

1. После того, как все входы предоставляются, внимательно просмотрите детали и совершить доставку информации, которую вы предоставили, введя **да**.

    ![Просмотр информации о доставке](./media/backup-azure-backup-import-export/reviewshippinginformation.png)<br/>

1. После успешного обновления информации о доставке утилита предоставляет локальное место, где хранятся введенные данные о доставке.

    ![Информация о доставке в магазин](./media/backup-azure-backup-import-export/storingshippinginformation.png)<br/>

   > [!IMPORTANT]
   > Убедитесь, что диски подостигаются в центр еданных Azure в течение двух недель после предоставления информации о доставке с помощью утилиты *AzureOfflineBackupDiskPrep.* Невыполнение этого требования может привести к тому, что диски не будут обработаны. 

После завершения предыдущих этапов центр обработки данных Azure готов получать диски и далее обрабатывать их для передачи данных резервного копирования с дисков в созданную учетную запись хранения Azure классического типа.

### <a name="time-to-process-the-drives"></a>Время обработки дисков

Время, необходимое для обработки задания импорта Azure, варьируется. Время процесса зависит от таких факторов, как время доставки, тип задания, тип и размер копируется данных, а также размер предоставленных дисков. Служба импорта/экспорта Azure не имеет SLA. После получения дисков служба стремится закончить копию данных резервного копирования в учетную запись хранения Azure за 7-10 дней. В следующем разделе описывается, как можно контролировать состояние задания импорта Azure.

### <a name="monitor-azure-import-job-status"></a>Мониторинг состояния задания на импорт Azure

В то время как диски находятся в пути или в центре обработки данных Azure для копирования учетной записи хранения, агент резервного копирования Azure или DPM или консоль MABS на исходном компьютере показывает следующее состояние работы для запланированных резервных копий:

  `Waiting for Azure Import Job to complete. Please check on Azure Management portal for more information on job status`

Чтобы проверить состояние задания импорта:

1. Откройте поднятую команду на исходном компьютере и запустите следующую команду:

     `AzureOfflineBackupDiskPrep.exe u:`

1. Выход показывает текущее состояние задания импорта.

    ![Проверка статуса задания импорта](./media/backup-azure-backup-import-export/importjobstatusreporting.png)<br/>

Более подробную информацию о различных состояниях задания импорта Azure можно [найти на примере состояния заданий Azure Import/Export.](../storage/common/storage-import-export-view-drive-status.md)

### <a name="finish-the-workflow"></a>Завершить рабочий процесс

После завершения задания импорта начальные резервные копии данных появятся в вашей учетной записи хранения. Во время следующего запланированного резервного копирования резервное копирование Azure копирует содержимое данных из учетной записи хранилища в хранилище служб восстановления.

   ![Копирование данных в хранилище служб восстановления](./media/backup-azure-backup-import-export/copyingfromstorageaccounttoazurebackup.png)<br/>

При следующем запланированном резервном копировании Azure Backup выполнит добавочное резервное копирование поверх начальной резервной копии.

## <a name="next-steps"></a>Дальнейшие действия

* Для любых вопросов о рабочем процессе службы Azure Import/Export [см.](../storage/common/storage-import-export-service.md)
