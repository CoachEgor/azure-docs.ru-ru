---
title: Автономное резервное копирование с помощью DPM и Azure Backup Server
description: Azure Backup позволяет отправить данные из сети с помощью службы импорта и экспорта Azure. В этой статье описывается рабочий процесс автономного резервного копирования для DPM и Azure Backup Server (MABS).
ms.reviewer: saurse
ms.topic: conceptual
ms.date: 1/28/2020
ms.openlocfilehash: 6be75062ab0ce06784d8cd7c833e0070476acf60
ms.sourcegitcommit: 21e33a0f3fda25c91e7670666c601ae3d422fb9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2020
ms.locfileid: "77022585"
---
# <a name="offline-backup-workflow-for-dpm-and-azure-backup-server"></a>Автономное резервное копирование для DPM и Azure Backup Server

В службу архивации Azure встроено несколько эффективных методов, которые позволяют экономить затраты на сеть и хранилище во время передачи начальных полных резервных копий данных в Azure. Обычно при этом выполняется передача больших объемов данных. Следовательно, для первой архивации требуется более высокая пропускная способность по сравнению с последующими операциями архивации, в ходе которых передаются только изменения или добавочные резервные копии. Служба архивации Azure сжимает начальные резервные копии, а также предоставляет механизм передачи сжатых копий данных в Azure с помощью дисков за счет процесса автономного заполнения.

Этот предоставленный службой архивации Azure процесс тесно интегрирован со [службой импорта и экспорта Azure](../storage/common/storage-import-export-service.md) , что позволяет передавать данные в Azure, используя диски. Процесс автономного заполнения можно использовать для отправки начальных резервных копий на одном или нескольких жестких дисках в центр обработки данных Azure, когда размер начальных резервных копий, которые нужно передать по сети с большой задержкой и низкой пропускной способностью, составляет несколько терабайт. В этой статье представлен обзор и подробная информация о шагах выполнения этого рабочего процесса для System Center DPM и Azure Backup Server.

> [!NOTE]
> Процесс автономного резервного копирования для агента служб восстановления Microsoft Azure (MARS) отличается от System Center DPM и Azure Backup Server. Сведения об использовании автономного резервного копирования с агентом MARS см. в [этой статье](backup-azure-backup-import-export.md). Автономное резервное копирование не поддерживается для резервных копий состояния системы, создаваемых с помощью агента Azure Backup.
>

## <a name="overview"></a>Обзор

Благодаря процессу автономного заполнения, предоставленному службой архивации Azure, и службе импорта и экспорта Azure автономная передача данных в хранилище Azure с помощью дисков не вызывает проблем. Процесс автономного резервного копирования включает в себя следующие шаги.

> [!div class="checklist"]
>
> * Данные резервных копий не передаются по сети, а записываются в *промежуточное расположение*.
> * Данные из *промежуточного расположения* записываются на один или несколько дисков SATA с помощью служебной программы *AzureOfflineBackupDiskPrep*.
> * Эта служебная программа автоматически создает задание импорта Azure.
> * Затем жесткие диски SATA отправляются в ближайший центр обработки данных Azure.
> * После передачи резервной копии данных в Azure служба архивации Azure копирует эти данные в хранилище службы архивации, после чего планируется добавочное резервное копирование.

## <a name="supported-configurations"></a>Поддерживаемые конфигурации

Автономное резервное копирование поддерживается для всех моделей развертывания Azure Backup, поддерживающих передачу автономных данных резервных копий из локальной среды в Microsoft Cloud. А именно:

> [!div class="checklist"]
>
> * Резервное копирование файлов и папок с помощью агента служб восстановления Microsoft Azure (MARS) или агента Azure Backup.
> * Резервное копирование всех рабочих нагрузок и файлов с помощью System Center Data Protection Manager (SC DPM).
> * Резервное копирование всех рабочих нагрузок и файлов с помощью Microsoft Azure Backup Server.

## <a name="prerequisites"></a>Технические условия

Перед запуском рабочего процесса автономного резервного копирования убедитесь, что выполнены следующие предварительные требования.

* Создано [хранилище служб восстановления](backup-azure-recovery-services-vault-overview.md). Инструкции по его созданию приведены в [данной статье](tutorial-backup-windows-server-to-azure.md#create-a-recovery-services-vault).
* На сервер Windows Server или клиент Windows установлен агент Azure Backup, Azure Backup Server или System Center Data Protection Manager (SC DPM), и этот компьютер зарегистрирован в хранилище служб восстановления. Убедитесь, что вы используете [самую последнюю версию агента Azure Backup](https://go.microsoft.com/fwlink/?linkid=229525).
* [Скачайте файл параметров публикации Azure](https://portal.azure.com/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) на компьютер, предназначенный для резервного копирования данных. Подписка, из которой скачивается файл параметров публикации, может отличаться от подписки, которая содержит хранилище служб восстановления. Если подписка размещена в национальных облаках Azure, то используйте соответствующую ссылку из приведенных ниже, чтобы скачать файл параметров публикации Azure.

    | Регион национального облака | Ссылка на файл параметров публикации Azure |
    | --- | --- |
    | США | [Ссылка](https://portal.azure.us#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) |
    | Китай | [Ссылка](https://portal.azure.cn/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) |

* Учетная запись хранения Azure с моделью развертывания *Диспетчер ресурсов* была создана в подписке, из которой был скачан файл параметров публикации, как показано ниже.

  ![Создание учетной записи хранения с диспетчер ресурсовной разработкой](./media/backup-azure-backup-import-export/storage-account-resource-manager.png)

* Создано промежуточное расположение. Это может быть сетевая папка или дополнительный диск на сервере, внутренний или внешний, на котором доступно достаточно пространства для хранения начальной копии. Например, если нужно создать резервную копию файлового сервера размером 500 ГБ, убедитесь, что промежуточное расположение имеет не менее 500 ГБ свободного места. (Хотя фактически использованный объем будет меньшим.)
* Что касается дисков, которые будут отправляться в Azure: требуется использовать только внутренние 2,5-дюймовые диски SSD, 2,5- либо 3,5-дюймовые диски SATA II или III. Можно использовать жесткие диски емкостью до 10 ТБ. Список поддерживаемых дисков см. в [документации по службе импорта и экспорта Azure](../storage/common/storage-import-export-requirements.md#supported-hardware).
* Жесткие диски SATA должны быть подключены к компьютеру (который называется *компьютером копирования*), на котором выполняется копирование данных резервных копий из *промежуточного расположения* на диски SATA. На *компьютере копирования* должен быть включено средство BitLocker.

## <a name="prepare-the-server-for-the-offline-backup-process"></a>Подготовка сервера к процессу автономного резервного копирования

>[!NOTE]
> Если в установке агента MARS не удается найти перечисленные служебные программы, такие как *азуреоффлинебаккупцертжен. exe* , то для получения доступа к ним необходимо выполнить запись в AskAzureBackupTeam@microsoft.com.

* Откройте командную строку с повышенными привилегиями на сервере и выполните следующую команду:

    ```cmd
    AzureOfflineBackupCertGen.exe CreateNewApplication SubscriptionId:<Subs ID>
    ```

    Средство создаст приложение автономного резервного копирования Azure AD, если оно не существует.

    Если приложение уже существует, этот исполняемый файл предложит вам вручную отправить сертификат в приложение в клиенте. Выполните следующие действия в [этом разделе](#manually-upload-offline-backup-certificate) , чтобы отправить сертификат в приложение вручную.

* Средство Азуреоффлинебаккуп. exe создаст файл Оффлинеаппликатионпарамс. XML.  Скопируйте этот файл на сервер с помощью MABS или DPM.
* Установите [последнюю версию агента Mars](https://aka.ms/azurebackup_agent) на сервере DPM/Azure Backup (MABS).
* Зарегистрируйте сервер в Azure.
* Выполните следующую команду:

    ```cmd
    AzureOfflineBackupCertGen.exe AddRegistryEntries SubscriptionId:<subscriptionid> xmlfilepath:<path of the OfflineApplicationParams.xml file>  storageaccountname:<storageaccountname configured with Azure Data Box>
    ```

* Приведенная выше команда создаст файл `C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch\MicrosoftBackupProvider\OfflineApplicationParams_<Storageaccountname>.xml`

## <a name="manually-upload-offline-backup-certificate"></a>Вручную отправьте сертификат автономного резервного копирования

Выполните следующие действия, чтобы вручную отправить сертификат автономного резервного копирования в ранее созданное Azure Active Directory приложение, предназначенное для автономной архивации.

1. Войдите на портал Azure.
2. Последовательно выберите **Azure Active Directory** > **Регистрация приложений**
3. Перейдите на вкладку " **принадлежащие приложения** " и найдите приложение с форматом отображаемого имени `AzureOfflineBackup _<Azure User Id`, как показано ниже:

    ![Размещение приложения на вкладке "принадлежащие приложения"](./media/backup-azure-backup-import-export/owned-applications.png)

4. Щелкните приложение. На вкладке **Управление** в левой области выберите **Сертификаты & секреты**.
5. Проверьте наличие уже существующих сертификатов или открытых ключей. Если их нет, можно безопасно удалить приложение, нажав кнопку **Удалить** на странице **обзора** приложения. После этого можно повторить шаги для [подготовки сервера к автономному резервному копированию](#prepare-the-server-for-the-offline-backup-process) и пропустить приведенные ниже шаги. В противном случае выполните следующие действия на сервере DPM/Azure Backup Server (MABS), где требуется настроить автономное резервное копирование.
6. Откройте **приложение "Управление сертификатом компьютера** > **личное** " и найдите сертификат с именем `CB_AzureADCertforOfflineSeeding_<ResourceId>`
7. Выберите приведенный выше сертификат, щелкните правой кнопкой мыши **все задачи** , а затем в формате CER выполните **Экспорт**без закрытого ключа.
8. Перейдите к приложению автономной резервной копии Azure в портал Azure.
9. Щелкните **Управление** **сертификатами > & секреты** > **отправить сертификат**и отправьте сертификат, экспортированный на предыдущем шаге.

    ![Загрузка сертификата](./media/backup-azure-backup-import-export/upload-certificate.png)
10. На сервере откройте реестр, введя в окне выполнения команду **regedit** .
11. Перейдите к записи реестра *Computer \ HKEY_LOCAL_MACHINE \Софтваре\микрософт\виндовс Azure баккуп\конфиг\клаудбаккуппровидер*.
12. Щелкните правой кнопкой мыши **клаудбаккуппровидер** и добавьте новое строковое значение с именем `AzureADAppCertThumbprint_<Azure User Id>`

    >[!NOTE]
    > Примечание. чтобы найти идентификатор пользователя Azure, выполните одно из следующих действий.
    >
    >1. В PowerShell, подключенном к Azure, выполните команду `Get-AzureRmADUser -UserPrincipalName “Account Holder’s email as appears in the portal”`.
    >2. Перейдите к пути реестра: `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DbgSettings\OnlineBackup; Name: CurrentUserId;`

13. Щелкните строку, добавленную на предыдущем шаге, правой кнопкой мыши и выберите пункт **изменить**. В поле значение укажите отпечаток сертификата, экспортированного на шаге 7, и нажмите кнопку **ОК**.
14. Чтобы получить значение отпечатка, дважды щелкните сертификат, а затем выберите вкладку **сведения** и прокрутите вниз, пока не отобразится поле отпечаток. Щелкните **отпечаток** и скопируйте значение.

    ![Копировать значение из поля отпечаток](./media/backup-azure-backup-import-export/thumbprint-field.png)

15. Перейдите к разделу [рабочего процесса](#workflow) , чтобы продолжить процесс автономного резервного копирования.

## <a name="workflow"></a>Рабочий процесс

Сведения в этом разделе помогут выполнить автономное резервное копирование с целью отправки данных в центр обработки данных Azure и передачи в службу хранилища Azure. Ответы на вопросы о службе импорта или о любом аспекте этого процесса см. в статье [Использование службы импорта и экспорта Azure для передачи данных в хранилище BLOB-объектов](../storage/common/storage-import-export-service.md).

### <a name="initiate-offline-backup"></a>Запуск автономного резервного копирования

1. В процессе планирования резервного копирования отобразится следующая страница (на сервере Windows Server, в клиенте Windows или System Center Data Protection Manager).

    ![Экран импорта](./media/backup-azure-backup-import-export/offlineBackupscreenInputs.png)

    Соответствующая страница на сервере System Center Data Protection Manager выглядит так: <br/>
    ![Экран импорта Azure Backup Server и SC DPM](./media/backup-azure-backup-import-export/dpmoffline.png)

    Ниже приведено описание входных данных.

   * **Промежуточное расположение**— временное хранилище, куда записывается начальная резервная копия. Это может быть сетевая папка или локальный компьютер. Если целевой компьютер и исходный компьютер разные, мы советуем указывать полный сетевой путь к промежуточному расположению.
   * **Имя задания импорта Azure**— уникальное имя, по которому служба импорта Azure и служба архивации Azure отслеживают процесс передачи данных в Azure с помощью дисков.
   * **Параметры публикации Azure** — укажите локальный путь к файлу параметров публикации.
   * **Идентификатор подписки Azure** — идентификатор подписки Azure, из которой вы скачали файл параметров публикации Azure.
   * **Учетная запись хранения Azure** — имя учетной записи хранения в подписке Azure, связанной с файлом параметров публикации Azure.
   * **Контейнер службы хранилища Azure** — имя хранилища BLOB-объектов в учетной записи хранения Azure, куда импортируются данные резервных копий.

     Запишите указанные *промежуточное расположение* и *имя задания импорта Azure*, так как они необходимы для подготовки дисков.  

2. Завершите рабочий процесс и, чтобы инициировать автономное резервное копирование, в консоли управления агента Azure Backup щелкните **Выполнить моментальную архивацию**. На этом этапе начальная резервная копия записывается в промежуточное расположение.

    ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/backupnow.png)

    Чтобы выполнить соответствующий рабочий процесс в System Center Data Protection Manager или на сервере Azure Backup Server, щелкните правой кнопкой мыши **Группа защиты** и выберите **Создать точку восстановления**. После этого выберите параметр **Защита в сети** .

    ![Моментальное резервное копирование с помощью Azure Backup Server и SC DPM](./media/backup-azure-backup-import-export/dpmbackupnow.png)

    После завершения операции промежуточное расположение можно использовать для подготовки дисков.

    ![Ход выполнения резервного копирования](./media/backup-azure-backup-import-export/opbackupnow.png)

### <a name="prepare-sata-drives-and-ship-to-azure"></a>Подготовка дисков SATA и их отправка в Azure

Служебная программа *AzureOfflineBackupDiskPrep* используется для подготовки дисков SATA, которые отправляются в ближайший центр обработки данных Azure. Эта служебная программа находится в каталоге установки агента служб восстановления по следующему пути:

`*\\Microsoft Azure Recovery Services Agent\Utils\*`

1. Перейдите по этому пути и скопируйте каталог **AzureOfflineBackupDiskPrep** на компьютер копирования, к которому присоединены подготавливаемые диски SATA. Убедитесь, что компьютер копирования соответствует следующим требованиям.

   * Промежуточное расположение, используемое для рабочего процесса автономного заполнения, доступно на целевом компьютере по тому же сетевому пути, который был задан во время **запуска автономного резервного копирования** .
   * На компьютере копирования включен инструмент BitLocker.
   * Компьютер копирования имеет доступ к порталу Azure.

     При необходимости целевым компьютером может быть исходный компьютер.

     > [!IMPORTANT]
     > Если исходный компьютер — это виртуальная машина, то в качестве компьютера копирования обязательно использовать другой физический сервер или клиентский компьютер.

2. На компьютере копирования выберите каталог служебной программы *AzureOfflineBackupDiskPrep*, откройте в нем командную строку с повышенными привилегиями и выполните следующую команду.

    `*.\AzureOfflineBackupDiskPrep.exe*   s:<*Staging Location Path*>   [p:<*Path to AzurePublishSettingsFile*>]`

    | Параметр | Description |
    | --- | --- |
    | s:&lt;*путь_к_промежуточному_расположению*&gt; |Обязательный параметр. Используется для предоставления пути к промежуточному расположению, заданному в процессе **запуска автономной архивации**. |
    | p:&lt;*путь_к_файлу_параметров_публикации*&gt; |Необязательный параметр. Используется для предоставления пути к **файлу параметров публикации**, заданному в процессе **запуска автономной архивации**. |

    > [!NOTE]
    > Если компьютер копирования и исходный компьютер разные, то нужно обязательно указать значение &lt;Path to PublishSettingFile&gt; (Путь к файлу параметров публикации).
    >
    >

    При выполнении команды эта служебная программа запрашивает выбор задания импорта Azure, связанного с подготавливаемыми дисками. Если с предоставленным промежуточным расположением связано только одно задание импорта, отобразится следующее окно.

    ![Входные данные средства подготовки дисков Azure](./media/backup-azure-backup-import-export/azureDiskPreparationToolDriveInput.png) <br/>

3. Введите букву подключенного диска (без двоеточия), который нужно подготовить для передачи в Azure. При появлении запроса подтвердите форматирование диска.

    После этого инструмент начнет подготовку диска и копирование данных резервных копий. Когда в средстве отобразится соответствующий запрос, может потребоваться подключить дополнительные диски. Это связано с тем, что на выбранном диске недостаточно памяти для хранения резервных копий данных. <br/>

    После завершения процесса диски, подготовленные с помощью средства, можно использовать для передачи в Azure. Кроме того, в Azure будет создано задание импорта с именем, заданным во время **запуска автономного резервного копирования**. Наконец, в инструменте отображается адрес центра обработки данных Azure, в который необходимо передать диски.

    ![Завершение подготовки дисков Azure](./media/backup-azure-backup-import-export/azureDiskPreparationToolSuccess.png)<br/>

4. В конце выполнения команды также отображается параметр для обновления сведений о доставке, как показано ниже.

    ![Параметр для обновления сведений о доставке](./media/backup-azure-backup-import-export/updateshippingutility.png)<br/>

5. Можно сразу же ввести необходимые сведения. Инструмент помогает выполнить процедуру, включающую в себя ряд вводов данных. Однако если вам неизвестны такие сведения, как номер для отслеживания и пр., относящиеся к доставке, то сеанс можно завершить. Инструкции по изменению сведений для доставки приведены позже в этой статье.

6. Перешлите диски на адрес, указанный в средстве, и сохраните номер отслеживания для использования в будущем.

   > [!IMPORTANT]
   > У двух заданий импорта Azure не может быть одинаковый номер для отслеживания. Убедитесь, что диски, подготовленные служебной программой для одного задания импорта Azure, отправляются вместе в одной посылке с отдельным уникальным идентификационным номером. Не смешивайте диски, подготовленные для **разных** заданий импорта Azure, в одной посылке.

7. Если вам известен номер для отслеживания, перейдите на исходный компьютер, который ожидает завершения задания импорта, и выполните в командной строке приведенную ниже команду в каталоге служебной программы *AzureOfflineBackupDiskPrep*.

   `*.\AzureOfflineBackupDiskPrep.exe*  u:`

   На другом компьютере, например на *компьютере копирования*, можно также выполнить приведенную ниже команду в каталоге служебной программы *AzureOfflineBackupDiskPrep*.

   `*.\AzureOfflineBackupDiskPrep.exe*  u:  s:<*Staging Location Path*>   p:<*Path to AzurePublishSettingsFile*>`

    | Параметр | Description |
    | --- | --- |
    | u: | Обязательный параметр для обновления сведений о доставке для задания импорта Azure. |
    | s:&lt;*путь_к_промежуточному_расположению*&gt; | Обязательный параметр, если команда выполняется не на исходном компьютере. Используется для предоставления пути к промежуточному расположению, заданному в рабочем процессе **запуска автономной архивации**. |
    | p:&lt;*путь_к_файлу_параметров_публикации*&gt; | Обязательный параметр, если команда выполняется не на исходном компьютере. Используется для предоставления пути к **файлу параметров публикации**, заданному в рабочем процессе **запуска автономной архивации**. |

    Служебная программа автоматически обнаруживает задание импорта, которое ждет исходный компьютер, или задания импорта, связанные с промежуточным расположением, если команда выполняется на другом компьютере. Затем она предоставляет возможность обновить сведения о доставке с помощью ряда входных параметров, как показано ниже.

    ![Ввод сведений о доставке](./media/backup-azure-backup-import-export/shippinginputs.png)<br/>

8. Указав все входные параметры, внимательно просмотрите сведения и сохраните указанную информацию о доставке, введя *yes* (Да).

    ![Просмотр сведений о доставке](./media/backup-azure-backup-import-export/reviewshippinginformation.png)<br/>

9. После успешного обновления сведений о доставке служебная программа предоставляет локальное расположение, в котором хранятся введенные сведения о доставке, как показано ниже.

    ![Хранение сведений о доставке](./media/backup-azure-backup-import-export/storingshippinginformation.png)<br/>

   > [!IMPORTANT]
   > Убедитесь, что диски будут доставлены в центр обработки данных Azure в течение двух недель с момента ввода сведений о доставке с помощью служебной программы *AzureOfflineBackupDiskPrep*. Невыполнение этого требования может привести к тому, что диски не будут обработаны.  

После выполнения приведенных выше действий центр обработки данных Azure будет готов к получению дисков и их обработке для переноса данных резервных копий с дисков в созданную учетную запись хранения Azure классического типа.

### <a name="time-to-process-the-drives"></a>Время обработки дисков

Время обработки задания импорта Azure зависит от различных факторов, таких как время отправки, тип задания, тип и размер копируемых данных и размер дисков. В службе "Импорт и экспорт Azure" не предусмотрено соглашение об уровне обслуживания, однако после получения дисков служба стремится выполнить копирование данных резервных копий в вашу учетную запись хранения Azure в течение 7–10 дней. В следующем разделе описывается, как можно отслеживать состояние задания импорта Azure.

### <a name="monitoring-azure-import-job-status"></a>Мониторинг состояния заданий импорта Azure

Пока ваши диски транспортируются или ожидают копирования в учетную запись хранения в центре обработки данных Azure, агент Azure Backup, SC DPM или консоль Azure Backup Server на исходном компьютере отображает следующее состояние задания для запланированного резервного копирования.

  `Waiting for Azure Import Job to complete. Please check on Azure Management portal for more information on job status`

Выполните следующие действия, чтобы проверить состояние задания импорта.

1. На исходной компьютере откройте командную строку с повышенными привилегиями и выполните следующую команду.

     `AzureOfflineBackupDiskPrep.exe u:`

2. Выходные данные содержат текущее состояние задания импорта, как показано ниже.

    ![Проверка состояния задания импорта](./media/backup-azure-backup-import-export/importjobstatusreporting.png)<br/>

Дополнительные сведения о различных состояниях задания импорта Azure см. в [данной статье](../storage/common/storage-import-export-view-drive-status.md).

### <a name="complete-the-workflow"></a>Завершение процесса

После завершения задания импорта начальные резервные копии данных появятся в вашей учетной записи хранения. Во время следующего запланированного резервного копирования Azure Backup скопирует содержимое данных из учетной записи хранения в хранилище служб восстановления, как показано ниже.

   ![Копирование данных в хранилище служб восстановления](./media/backup-azure-backup-import-export/copyingfromstorageaccounttoazurebackup.png)<br/>

При следующем запланированном резервном копировании Azure Backup выполнит добавочное резервное копирование поверх начальной резервной копии.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о рабочем процессе службы импорта и экспорта см. в статье [Использование службы импорта и экспорта Azure для передачи данных в хранилище BLOB-объектов](../storage/common/storage-import-export-service.md).
