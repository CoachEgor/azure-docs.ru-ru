---
title: Автономное резервное копирование с помощью DPM и Azure Backup Server
description: С Azure Backup можно отправить данные из сети с помощью службы импорта и экспорта Azure. В этой статье описывается рабочий процесс автономного резервного копирования для DPM и Azure Backup Server.
ms.reviewer: saurse
ms.topic: conceptual
ms.date: 1/28/2020
ms.openlocfilehash: 080b0bc53b2058bd186e90f354b8f5bcda510414
ms.sourcegitcommit: 225a0b8a186687154c238305607192b75f1a8163
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/29/2020
ms.locfileid: "78197090"
---
# <a name="offline-backup-workflow-for-dpm-and-azure-backup-server"></a>Рабочий процесс автономного резервного копирования для DPM и Azure Backup Server

В службу архивации Azure встроено несколько эффективных методов, которые позволяют экономить затраты на сеть и хранилище во время передачи начальных полных резервных копий данных в Azure. Обычно при этом выполняется передача больших объемов данных. Следовательно, для первой архивации требуется более высокая пропускная способность по сравнению с последующими операциями архивации, в ходе которых передаются только изменения или добавочные резервные копии. Служба архивации Azure сжимает начальные резервные копии, а также предоставляет механизм передачи сжатых копий данных в Azure с помощью дисков за счет процесса автономного заполнения.

Процесс автономного заполнения Azure Backup тесно интегрирован со [службой импорта и экспорта Azure](../storage/common/storage-import-export-service.md). Эту службу можно использовать для перемещения данных в Azure с помощью дисков. Если у вас есть терабайты (TBs) исходных данных резервного копирования, которые должны передаваться по сети с высокой задержкой и низкой пропускной способностью, можно использовать рабочий процесс автономного заполнения для доставки начальной резервной копии на один или несколько жестких дисков в центр обработки данных Azure. В этой статье приводится обзор и дальнейшие действия по завершению рабочего процесса для System Center Data Protection Manager (DPM) и сервера Microsoft Azure Backup (MABS).

> [!NOTE]
> Процесс автономного резервного копирования для агента Службы восстановления Microsoft Azure (MARS) отличается от DPM и MABS. Сведения об использовании автономного резервного копирования с агентом MARS см. [в разделе Рабочий процесс автономного резервного копирования в Azure Backup](backup-azure-backup-import-export.md). Автономное резервное копирование не поддерживается для резервных копий состояния системы, выполненных с помощью агента Azure Backup.
>

## <a name="overview"></a>Обзор

Благодаря возможности автономного заполнения Azure Backup и службы импорта и экспорта Azure можно легко передать данные в автономном режиме в Azure с помощью дисков. Процесс автономного резервного копирования включает следующие шаги:

> [!div class="checklist"]
>
> * Данные резервной копии записываются в промежуточное расположение, а не передаются по сети.
> * Затем данные в промежуточном расположении записываются на один или несколько дисков SATA с помощью служебной программы *AzureOfflineBackupDiskPrep* .
> * Задание импорта Azure автоматически создается программой.
> * Затем диски SATA отправляются в ближайший центр обработки данных Azure.
> * После передачи резервной копии данных в Azure служба архивации Azure копирует эти данные в хранилище службы архивации, после чего планируется добавочное резервное копирование.

## <a name="supported-configurations"></a>Поддерживаемые конфигурации

Автономная архивация поддерживается для всех моделей развертывания Azure Backup, которые позволяют выполнять резервное копирование данных из локальной среды в облако Майкрософт. К этим моделям относятся:

> [!div class="checklist"]
>
> * Резервное копирование файлов и папок с помощью агента MARS или агента Azure Backup.
> * Резервное копирование всех рабочих нагрузок и файлов с помощью DPM.
> * Резервное копирование всех рабочих нагрузок и файлов с помощью MABS.

## <a name="prerequisites"></a>предварительные требования

Перед запуском рабочего процесса автономного резервного копирования убедитесь, что выполнены следующие предварительные требования:

* Создано [хранилище служб восстановления](backup-azure-recovery-services-vault-overview.md). Чтобы создать его, выполните действия, описанные в разделе [Создание хранилища служб восстановления](tutorial-backup-windows-server-to-azure.md#create-a-recovery-services-vault) .
* Агент Azure Backup или DPM был установлен либо на Windows Server, либо в клиенте Windows, как применимо, и компьютер зарегистрирован в хранилище служб восстановления. Убедитесь, что вы используете [самую последнюю версию агента Azure Backup](https://go.microsoft.com/fwlink/?linkid=229525).
* [Скачайте файл параметров публикации Azure](https://portal.azure.com/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) на компьютер, с которого планируется выполнять резервное копирование данных. Подписка, из которой загружается файл параметров публикации, может отличаться от подписки, содержащей хранилище служб восстановления. Если ваша подписка находится в независимых облаках Azure, воспользуйтесь следующими ссылками, чтобы скачать файл параметров публикации Azure.

    | Регион национального облака | Ссылка на файл параметров публикации Azure |
    | --- | --- |
    | США | [Ссылка](https://portal.azure.us#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) |
    | Китай | [Ссылка](https://portal.azure.cn/#blade/Microsoft_Azure_ClassicResources/PublishingProfileBlade) |

* Учетная запись хранения Azure с моделью развертывания диспетчер ресурсов была создана в подписке, из которой был скачан файл параметров публикации.

  ![Создание учетной записи хранения с диспетчер ресурсовной разработкой](./media/backup-azure-backup-import-export/storage-account-resource-manager.png)

* Создано промежуточное расположение. Это может быть сетевая папка или дополнительный диск на сервере, внутренний или внешний, на котором доступно достаточно пространства для хранения начальной копии. Например, если требуется создать резервную копию файлового сервера размером 500 ГБ, убедитесь, что промежуточная область составляет не менее 500 ГБ. (Хотя фактически использованный объем будет меньшим.)
* Для дисков, отправляемых в Azure, необходимо использовать только 2,5-дюймовый SSD или 2,5-дюймовый или 3,5-дюймовый внутренний жесткий диск SATA II/III. Можно использовать жесткие диски емкостью до 10 ТБ. Список поддерживаемых дисков см. в [документации по службе импорта и экспорта Azure](../storage/common/storage-import-export-requirements.md#supported-hardware).
* Диски SATA должны быть подключены к компьютеру (который называется *компьютером копирования*), с которого выполняется копирование резервных копий данных из промежуточного расположения на диски SATA. Убедитесь, что BitLocker включен на компьютере копирования.

## <a name="prepare-the-server-for-the-offline-backup-process"></a>Подготовка сервера к процессу автономного резервного копирования

>[!NOTE]
> Если вы не можете найти перечисленные программы, такие как *азуреоффлинебаккупцертжен. exe*, в установке агента Mars, запишите в AskAzureBackupTeam@microsoft.com, чтобы получить доступ к ним.

* Откройте командную строку с повышенными привилегиями на сервере и выполните следующую команду:

    ```cmd
    AzureOfflineBackupCertGen.exe CreateNewApplication SubscriptionId:<Subs ID>
    ```

    Средство создает автономную резервную копию Azure Active Directory приложение, если оно не существует.

    Если приложение уже существует, этот исполняемый файл предложит вручную отправить сертификат в приложение в клиенте. Выполните действия, описанные в [этом разделе](#manually-upload-an-offline-backup-certificate) , чтобы отправить сертификат в приложение вручную.

* Средство *азуреоффлинебаккуп. exe* создает файл *оффлинеаппликатионпарамс. XML* . Скопируйте этот файл на сервер с помощью MABS или DPM.
* Установите [последнюю версию агента Mars](https://aka.ms/azurebackup_agent) на экземпляре DPM или на сервере Azure Backup.
* Зарегистрируйте сервер в Azure.
* Выполните следующую команду:

    ```cmd
    AzureOfflineBackupCertGen.exe AddRegistryEntries SubscriptionId:<subscriptionid> xmlfilepath:<path of the OfflineApplicationParams.xml file>  storageaccountname:<storageaccountname configured with Azure Data Box>
    ```

* Предыдущая команда создает файл `C:\Program Files\Microsoft Azure Recovery Services Agent\Scratch\MicrosoftBackupProvider\OfflineApplicationParams_<Storageaccountname>.xml`.

## <a name="manually-upload-an-offline-backup-certificate"></a>Отправка автономного сертификата резервной копии вручную

Выполните следующие действия, чтобы вручную отправить сертификат автономного резервного копирования в ранее созданное Azure Active Directory приложение, предназначенное для автономной архивации.

1. Войдите на портал Azure.
1. Перейдите в **Azure Active Directory** > **Регистрация приложений**.
1. На вкладке " **принадлежащие приложения** " выберите приложение с форматом отображаемого имени `AzureOfflineBackup _<Azure User Id`.

    ![Размещение приложения на вкладке "принадлежащие приложения"](./media/backup-azure-backup-import-export/owned-applications.png)

1. Выберите приложение. В разделе **Управление** на левой панели выберите **Сертификаты & секреты**.
1. Проверьте наличие уже существующих сертификатов или открытых ключей. Если их нет, можно безопасно удалить приложение, нажав кнопку **Удалить** на странице **обзора** приложения. Затем можно повторить шаги для [подготовки сервера к автономному резервному копированию](#prepare-the-server-for-the-offline-backup-process) и пропустить следующие шаги. В противном случае продолжайте выполнять эти действия с экземпляра DPM или сервера Azure Backup, где требуется настроить автономное резервное копирование.
1. Выберите вкладку **Управление сертификатом компьютера приложение** > **личное** . найдите сертификат с именем `CB_AzureADCertforOfflineSeeding_<ResourceId>`.
1. Выберите сертификат, щелкните правой кнопкой мыши **все задачи**, а затем выберите **Экспорт**без закрытого ключа в формате CER.
1. Перейдите к приложению автономной резервной копии Azure в портал Azure.
1. Выберите **Управление** **Сертификаты > & секреты** > **отправить сертификат**. Отправьте сертификат, экспортированный на предыдущем шаге.

    ![Загрузка сертификата](./media/backup-azure-backup-import-export/upload-certificate.png)

1. На сервере откройте реестр, введя в окне выполнения команду " **regedit** ".
1. Перейдите к записи реестра *Computer \ HKEY_LOCAL_MACHINE \Софтваре\микрософт\виндовс Azure баккуп\конфиг\клаудбаккуппровидер*.
1. Щелкните правой кнопкой мыши **клаудбаккуппровидер**и добавьте новое строковое значение с именем `AzureADAppCertThumbprint_<Azure User Id>`.

    >[!NOTE]
    > Чтобы найти идентификатор пользователя Azure, выполните одно из следующих действий.
    >
    >* В PowerShell, подключенном к Azure, выполните команду `Get-AzureRmADUser -UserPrincipalName “Account Holder’s email as appears in the portal”`.
    >* Перейдите к пути реестра `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DbgSettings\OnlineBackup; Name: CurrentUserId;`.

1. Щелкните правой кнопкой мыши строку, добавленную на предыдущем шаге, и выберите пункт **изменить**. В поле значение укажите отпечаток сертификата, экспортированного на шаге 7. Нажмите кнопку **ОК**.
1. Чтобы получить значение отпечатка, дважды щелкните сертификат. Перейдите на вкладку **сведения** и прокрутите вниз, пока не увидите поле отпечаток. Выберите **отпечаток**и скопируйте значение.

    ![Копировать значение из поля отпечаток](./media/backup-azure-backup-import-export/thumbprint-field.png)

1. Перейдите к разделу [рабочего процесса](#workflow) , чтобы продолжить процесс автономного резервного копирования.

## <a name="workflow"></a>Рабочий процесс

Сведения в этом разделе помогут завершить рабочий процесс автономного резервного копирования, чтобы данные можно было доставить в центр обработки данных Azure и передать в службу хранилища Azure. Если у вас возникли вопросы о службе импорта или о любом аспекте процесса, см. [сведения в документации по импорту службы импорта](../storage/common/storage-import-export-service.md) , указанной выше.

### <a name="initiate-offline-backup"></a>Запуск автономного резервного копирования

1. При планировании резервного копирования отображается следующая страница в Windows Server, клиенте Windows или DPM.

    ![Страница «Импорт»](./media/backup-azure-backup-import-export/offlineBackupscreenInputs.png)

    Ниже приведена соответствующая страница в DPM. <br/>
    
    ![Страница импорта DPM и Azure Backup Server](./media/backup-azure-backup-import-export/dpmoffline.png)

    Поля, которые вы заполните,:

   * **Промежуточное расположение**— временное хранилище, куда записывается начальная резервная копия. Промежуточное расположение может находиться в общей сетевой папке или на локальном компьютере. Если компьютер копирования и исходный компьютер отличаются, укажите полный сетевой путь к промежуточному расположению.
   * **Параметры публикации Azure**: локальный путь к файлу параметров публикации.
   * **Имя задания импорта Azure**: уникальное имя, по которому служба импорта и экспорта Azure Azure Backup отслеживание передачи данных, отправляемых на диски в Azure.
   * **Идентификатор подписки Azure**. идентификатор подписки Azure для подписки, из которой вы скачали файл параметров публикации Azure.
   * **Учетная запись хранения Azure**. имя учетной записи хранения в подписке Azure, связанной с файлом параметров публикации Azure.
   * **Контейнер службы хранилища Azure** — имя хранилища BLOB-объектов в учетной записи хранения Azure, куда импортируются данные резервных копий.

   Сохраните **промежуточное расположение** и сведения о **имени задания импорта Azure** , которые вы указали. Она необходима для подготовки дисков.

1. Завершите рабочий процесс. Чтобы запустить автономную резервную копию, в консоли управления агентом Azure Backup выберите пункт **резервное копирование** . На этом этапе начальная резервная копия записывается в промежуточное расположение.

    ![Команда «Выполнить моментальную архивацию»](./media/backup-azure-backup-import-export/backupnow.png)

    Чтобы завершить соответствующий рабочий процесс в DPM или Azure Backup Server, щелкните правой кнопкой мыши **группу защиты**. Выберите параметр **создать точку восстановления** . Затем выберите вариант **оперативная защита** .

    ![DPM и MABS создать резервную копию сейчас](./media/backup-azure-backup-import-export/dpmbackupnow.png)

    После завершения операции промежуточное расположение можно использовать для подготовки дисков.

    ![Ход выполнения резервного копирования](./media/backup-azure-backup-import-export/opbackupnow.png)

### <a name="prepare-sata-drives-and-ship-to-azure"></a>Подготовка дисков SATA и их отправка в Azure

Служебная программа *AzureOfflineBackupDiskPrep* используется для подготовки дисков SATA, которые отправляются в ближайший центр обработки данных Azure. Эта служебная программа доступна в каталоге установки агента служб восстановления по следующему пути:

`*\\Microsoft Azure Recovery Services Agent\Utils\*`

1. Перейдите по этому пути и скопируйте каталог *AzureOfflineBackupDiskPrep* на компьютер копирования, к которому присоединены подготавливаемые диски SATA. Убедитесь в следующем:

   * Компьютер копирования может получить доступ к промежуточному расположению для рабочего процесса автономного заполнения, используя тот же сетевой путь, который был указан в рабочем процессе в разделе "Запуск автономной архивации".
   * На компьютере копирования включен инструмент BitLocker.
   * Компьютер копирования имеет доступ к порталу Azure. При необходимости целевым компьютером может быть исходный компьютер.

     > [!IMPORTANT]
     > Если исходный компьютер является виртуальной машиной, обязательно используйте другой физический сервер или клиентский компьютер в качестве компьютера копирования.

1. Откройте командную строку с повышенными привилегиями на компьютере копирования с каталогом служебной программы *AzureOfflineBackupDiskPrep* в качестве текущего каталога. Выполните следующую команду:

    `*.\AzureOfflineBackupDiskPrep.exe*   s:<*Staging Location Path*>   [p:<*Path to AzurePublishSettingsFile*>]`

    | Параметр | Description |
    | --- | --- |
    | s:&lt;*путь_к_промежуточному_расположению*&gt; |Этот обязательный ввод используется для указания пути к промежуточному расположению, введенному в рабочем процессе в разделе "Запуск автономной архивации". |
    | p:&lt;*путь_к_файлу_параметров_публикации*&gt; |Этот необязательный ввод используется для указания пути к файлу параметров публикации Azure, введенному в рабочем процессе в разделе "Запуск автономной архивации". |

    > [!NOTE]
    > Если компьютер копирования и исходный компьютер разные, то нужно обязательно указать значение &lt;Path to PublishSettingFile&gt; (Путь к файлу параметров публикации).
    >
    >

    При выполнении команды программа запрашивает выбор задания импорта Azure, которое соответствует дискам, которые необходимо подготовить. Если с указанным промежуточным расположением связано только одно задание импорта, отобразится страница, подобная этой.

    ![Входные данные средства подготовки диска Azure](./media/backup-azure-backup-import-export/azureDiskPreparationToolDriveInput.png) <br/>

1. Введите букву подключенного диска (без двоеточия), который нужно подготовить для передачи в Azure. При появлении запроса введите подтверждение форматирования диска.

    Затем средство начнет подготовку диска и скопировать данные резервной копии. Если на указанном диске недостаточно места для резервных данных, может потребоваться подключить дополнительные диски. <br/>

    После успешного завершения работы средства один или несколько указанных дисков подготавливаются к отправке в Azure. Задание импорта с именем, которое вы указали во время рабочего процесса в разделе "Запуск автономной резервной копии", также создается в Azure. Наконец, в инструменте отображается адрес центра обработки данных Azure, в который необходимо передать диски.

    ![Подготовка диска Azure завершена](./media/backup-azure-backup-import-export/azureDiskPreparationToolSuccess.png)<br/>

1. В конце выполнения команды также появится возможность обновления сведений о доставке.

    ![Параметр обновления сведений о доставке](./media/backup-azure-backup-import-export/updateshippingutility.png)<br/>

1. Можно сразу же ввести необходимые сведения. Это средство помогает выполнить процесс, включающий ряд входных данных. Если у вас нет информации, например номера отслеживания или других сведений, относящихся к отгрузке, вы можете завершить сеанс. Инструкции по изменению сведений для доставки приведены позже в этой статье.

1. Отправьте диски по адресу, указанному средством. Сохраним контрольный номер для дальнейшего использования.

   > [!IMPORTANT]
   > Ни один из двух заданий импорта Azure не может иметь один и тот же номер для отслеживания. Убедитесь, что диски, подготовленные программой в рамках одного задания импорта Azure, поставляются вместе в одном пакете, а для пакета существует один уникальный номер для отслеживания. Не следует объединять диски, подготовленные в рамках различных заданий импорта Azure, в одном пакете.

1. При наличии сведений о номере для отслеживания перейдите на исходный компьютер, ожидающий завершения задания импорта. Выполните следующую команду в командной строке с повышенными привилегиями с каталогом служебной программы *AzureOfflineBackupDiskPrep* в качестве текущего каталога.

   `*.\AzureOfflineBackupDiskPrep.exe*  u:`

   При необходимости можно выполнить следующую команду с другого компьютера, например с компьютера копирования, с каталогом служебной программы *AzureOfflineBackupDiskPrep* в качестве текущего каталога.

   `*.\AzureOfflineBackupDiskPrep.exe*  u:  s:<*Staging Location Path*>   p:<*Path to AzurePublishSettingsFile*>`

    | Параметр | Description |
    | --- | --- |
    | u: | Этот обязательный ввод используется для обновления сведений о доставке для задания импорта Azure. |
    | s:&lt;*путь_к_промежуточному_расположению*&gt; | Этот обязательный ввод используется, если команда не выполняется на исходном компьютере. Он используется для указания пути к промежуточному расположению, введенному в рабочем процессе в разделе "Запуск автономной архивации". |
    | p:&lt;*путь_к_файлу_параметров_публикации*&gt; | Этот обязательный ввод используется, если команда не выполняется на исходном компьютере. Он используется для указания пути к файлу параметров публикации Azure, введенному в рабочем процессе в разделе "Запуск автономной архивации". |

    Программа автоматически обнаруживает задание импорта, которое ожидает исходный компьютер, или задания импорта, связанные с промежуточным расположением, когда команда выполняется на другом компьютере. Затем он предоставляет возможность обновления сведений о доставке с помощью ряда входных данных.

    ![Введите сведения о доставке](./media/backup-azure-backup-import-export/shippinginputs.png)<br/>

1. После ввода всех входных данных внимательно проверьте сведения и зафиксируйте предоставленные сведения о доставке, введя **Да**.

    ![Проверка сведений о доставке](./media/backup-azure-backup-import-export/reviewshippinginformation.png)<br/>

1. После успешного обновления сведений о доставке программа предоставляет локальное расположение, в котором хранятся введенные сведения о доставке.

    ![Хранение сведений о доставке](./media/backup-azure-backup-import-export/storingshippinginformation.png)<br/>

   > [!IMPORTANT]
   > Убедитесь, что диски достигают центра обработки данных Azure за две недели, предоставив сведения о доставке с помощью служебной программы *AzureOfflineBackupDiskPrep* . Невыполнение этого требования может привести к тому, что диски не будут обработаны. 

После выполнения описанных выше действий центр обработки данных Azure готов к приему дисков и дальнейшей обработке их для перемещения данных резервных копий с дисков в созданную учетную запись хранения Azure классического типа.

### <a name="time-to-process-the-drives"></a>Время обработки дисков

Количество времени, затрачиваемое на обработку задания импорта Azure, может меняться. Время процесса зависит от таких факторов, как время доставки, тип задания, тип и размер копируемых данных, а также размер предоставленных дисков. Служба импорта и экспорта Azure не имеет соглашения об уровне обслуживания. После получения дисков служба стремится завершить копирование данных резервного копирования в учетную запись хранения Azure в течение 7 – 10 дней. В следующем разделе описывается, как можно отслеживать состояние задания импорта Azure.

### <a name="monitor-azure-import-job-status"></a>Мониторинг состояния задания импорта Azure

Пока диски находятся в транзитном расположении или в центре обработки данных Azure для копирования в учетную запись хранения, агент Azure Backup или DPM или консоль MABS на исходном компьютере отображает следующее состояние задания для запланированных резервных копий:

  `Waiting for Azure Import Job to complete. Please check on Azure Management portal for more information on job status`

Чтобы проверить состояние задания импорта, выполните следующие действия.

1. Откройте командную строку с повышенными привилегиями на исходном компьютере и выполните следующую команду:

     `AzureOfflineBackupDiskPrep.exe u:`

1. Выходные данные показывают текущее состояние задания импорта.

    ![Проверка состояния задания импорта](./media/backup-azure-backup-import-export/importjobstatusreporting.png)<br/>

Дополнительные сведения о различных состояниях задания импорта Azure см. в статье [Просмотр состояния заданий импорта и экспорта Azure](../storage/common/storage-import-export-view-drive-status.md).

### <a name="finish-the-workflow"></a>Завершение рабочего процесса

После завершения задания импорта начальные резервные копии данных появятся в вашей учетной записи хранения. Во время следующего запланированного резервного копирования Azure Backup копирует содержимое данных из учетной записи хранения в хранилище служб восстановления.

   ![Копирование данных в хранилище служб восстановления](./media/backup-azure-backup-import-export/copyingfromstorageaccounttoazurebackup.png)<br/>

При следующем запланированном резервном копировании Azure Backup выполнит добавочное резервное копирование поверх начальной резервной копии.

## <a name="next-steps"></a>Дальнейшие действия

* Вопросы о рабочем процессе службы импорта и экспорта Azure см. в статье [Использование службы импорт и экспорт Microsoft Azure для перемещения данных в хранилище BLOB-объектов](../storage/common/storage-import-export-service.md).
