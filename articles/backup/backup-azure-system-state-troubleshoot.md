---
title: Резервное копирование состояния системы устранения неполадок
description: В этой статье узнайте, как устранить проблемы в резервном копировании System State для предприимчивых серверов Windows.
ms.reviewer: srinathv
ms.topic: troubleshooting
ms.date: 07/22/2019
ms.openlocfilehash: 28647b72334d592692c5fe1b031735330d1a0509
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78969576"
---
# <a name="troubleshoot-system-state-backup"></a>Резервное копирование состояния системы устранения неполадок

В этой статье описаны решения проблем, с которыми можно встретить при использовании резервного копирования состояния системы.

## <a name="basic-troubleshooting"></a>Базовое устранение неполадок

Мы рекомендуем вам выполнить ниже проверки, прежде чем начать устранение неполадок системы резервного копирования состояния:

- [Убедитесь, что служба восстановления Microsoft Azure (MARS) Агент обновлен](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409)
- [Убедитесь, что между агентом служб восстановления Microsoft Azure и Azure установлено сетевое подключение](https://docs.microsoft.com/azure/backup/backup-azure-mars-troubleshoot#the-microsoft-azure-recovery-service-agent-was-unable-to-connect-to-microsoft-azure-backup)
- Убедитесь, что службы восстановления Microsoft Azure запущены (на сервисной консоли). При необходимости перезапустите и повторите операцию
- [Убедитесь, что в расположении временной папки доступно 5–10 % свободного места](https://docs.microsoft.com/azure/backup/backup-azure-file-folder-backup-faq#whats-the-minimum-size-requirement-for-the-cache-folder).
- [Проверьте, не влияет ли на работу службы Azure Backup другой процесс или антивирусная программа](https://docs.microsoft.com/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup).
- [Запланированное резервное копирование завершается сбоем, но резервное копирование вручную работает](https://docs.microsoft.com/azure/backup/backup-azure-mars-troubleshoot#backups-dont-run-according-to-schedule).
- Убедитесь, что в вашей операционной системе установлены последние обновления.
- [Обеспечение исключения неподдерживаемых дисков и файлов с неподдерживаемыми атрибутами из резервного копирования](backup-support-matrix-mars-agent.md#supported-drives-or-volumes-for-backup)
- Убедитесь, что на **системных часах** в защищенной системе правильно настроен часовой пояс. <br>
- [Убедитесь, что на сервере используется версия .Net Framework не ниже 4.5.2.](https://www.microsoft.com/download/details.aspx?id=30653)<br>
- Если вы пытаетесь **перерегистрировать сервер** в хранилище, то: <br>
  - Убедитесь, что агент не установлен на сервере и удален с портала <br>
  - Используйте ту же парольную фразу, которая изначально использовалась для регистрации сервера. <br>
- Если это резервное копирование в автономном режиме, убедитесь, что версия Azure PowerShell 3.7.0 установлена как на исходном, так и на компьютере копирования, прежде чем начать работу резервного копирования в автономном режиме, прежде чем вы начнете автономное резервное копирование
- [Рассмотрение того, когда агент резервного копирования работает на виртуальной машине Azure](https://docs.microsoft.com/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-backup-agent-running-on-an-azure-virtual-machine)

### <a name="limitation"></a>Ограничение

- Корпорация Майкрософт не рекомендует выполнять восстановление на другое оборудование с помощью функции восстановления состояния системы.
- Резервное копирование Системного состояния в настоящее время поддерживает "местные" серверы Windows. Эта функция недоступна для M-м и ми-ми за вывМ Azure.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем устранить неполадки системного резервного копирования с помощью резервного копирования Azure, выполните проверку ниже предпосылок.  

### <a name="verify-windows-server-backup-is-installed"></a>Установка резервного копирования сервера Windows Server

Убедитесь, что резервное копирование сервера Windows Server установлено и включено на сервере. Чтобы проверить состояние установки, запустите эту команду PowerShell:

 ```powershell
Get-WindowsFeature Windows-Server-Backup
 ```

Если выход отображает **состояние установки** как **доступное,** то это означает, что функция резервного копирования Сервера Windows доступен для установки, но не установлена на сервере. Однако, если резервное копирование Windows Server не установлено, используйте один из методов ниже, чтобы установить его.

#### <a name="method-1-install-windows-server-backup-using-powershell"></a>Метод 1: Установка резервного копирования сервера Windows с помощью PowerShell

Чтобы установить резервное копирование Windows Server с помощью PowerShell, запустите ниже приведенную команду:

  ```powershell
  Install-WindowsFeature -Name Windows-Server-Backup
  ```

#### <a name="method-2-install-windows-server-backup-using-server-manager"></a>Метод 2: Установка резервного копирования сервера Windows с помощью диспетчера серверов

Для установки резервного копирования Сервера Windows с помощью серверного менеджера выполните приведенные ниже действия:

1. В **Server Manger**щелкните **Добавить роли и функции.** Отосевано **роли и функции мастера** добавления.

    ![Панель мониторинга](./media/backup-azure-system-state-troubleshoot/server_management.jpg)

2. Выберите **тип установки** и нажмите **далее**.

    ![Тип установки](./media/backup-azure-system-state-troubleshoot/install_type.jpg)

3. Выберите сервер из пула серверов и нажмите **далее.** В роли сервера оставьте выделение по умолчанию и нажмите **далее.**
4. Выберите **резервное копирование Windows Server** во вкладке **«Функции»** и нажмите **далее.**

    ![features](./media/backup-azure-system-state-troubleshoot/features.png)

5. Во вкладке **«Подтверждение»** нажмите **«Установка»,** чтобы начать процесс установки.
6. Во вкладке **«Результаты»** будет отображаться функция резервного копирования Сервера Windows, которая успешно установлена на вашем Сервере Windows.

    ![набор по](./media/backup-azure-system-state-troubleshoot/results.jpg)

### <a name="system-volume-information-permission"></a>Разрешение на объем системы

Убедитесь, что локальный SYSTEM имеет полный контроль над папкой **Информации о томах системы,** расположенной в томе, где установлена Windows. Обычно это **C: «Система Объем информации**. Резервное копирование Windows Server может вывести из строя, если вышеуказанные разрешения не настроены правильно

### <a name="dependent-services"></a>Зависимые услуги

Убедитесь, что ниже службы находятся в запущенном состоянии:

**имя службы**; | **Тип запуска**
--- | ---
Удаленный вызов процедуры (RPC) | Автоматически
Система событий КОМЗ (EventSystem) | Автоматически
Служба уведомления событий системы (SENS) | Автоматически
Копия тени тома (VSS) | Вручную
Поставщик копирования теней microsoft (SWPRV) | Вручную

### <a name="validate-windows-server-backup-status"></a>Проверка состояния резервного копирования Сервера Windows

Для проверки состояния резервного копирования Windows Server выполните следующие действия:

- Убедитесь, что WSB PowerShell работает

  - Выполнить `Get-WBJob` от повышенной PowerShell и убедитесь, что он не возвращает следующую ошибку:

    > [!WARNING]
    > Get-WBJob: Термин "Get-WBJob" не признается в качестве названия cmdlet, функции, файла скрипта или оперативной программы. Проверьте правильность написания имени, а если включен путь, то проверьте правильность пути и повторите попытку.

    - Если это не удается с этой ошибкой, а затем переустановить функцию резервного копирования Windows Server на серверной машине, как указано в шаге 1 предпосылок.

  - Убедитесь, что резервное копирование WSB работает должным образом, запустив ниже приведенную команду из повышенной команды:

      `wbadmin start systemstatebackup -backuptarget:X: -quiet`

      > [!NOTE]
      >Замените X дисковой буквой тома, в котором требуется хранить резервное изображение состояния системы.

    - Периодически проверяйте состояние задания, `Get-WBJob` запуская команду от повышенной PowerShell
    - После выполнения задания резервного копирования проверить `Get-WBJob -Previous 1` окончательный статус задания, запустив команду

Если задание выполняется неудачно, это указывает на проблему WSB, которая приведет к сбою в сбое в состоянии системы агента MARS.

## <a name="common-errors"></a>Распространенные ошибки

### <a name="vss-writer-timeout-error"></a>Ошибка тайм-аута VSS Writer

| Симптом | Причина | Решение
| -- | -- | --
| - Агент MARS не справляется с сообщением об ошибке: "Работа WSB не сработала с ошибками VSS. Проверьте журналы событий VSS для устранения сбоя"<br/><br/> - Следующие журналы ошибок присутствует в журналах событий VSS Application: "Писатель VSS отклонил событие с ошибкой 0x800423f2, тайм-аут писателя истек между событиями замораживания и оттепели".| VSS писатель не может завершить в срок из-за отсутствия процессора и ресурсов памяти на машине <br/><br/> Другое программное обеспечение резервного копирования уже использует автором VSS, в результате операция моментального снимка не может быть завершена для этого резервного копирования | Подождите, пока процессор/ память будут освобождены в системе или прервать процессы, слишком много памяти / процессора и попробуйте операцию еще раз. <br/><br/>  Подождите, пока текущая резервная работа будет завершена, и попробуйте операцию на более позднем этапе, когда на машине не будет работать резервное копирование.

### <a name="insufficient-disk-space-to-grow-shadow-copies"></a>Недостаточное пространство диска для выращивания теневых копий

| Симптом | Решение
| -- | --
| - Агент MARS выходит из строя с сообщением об ошибке: резервное копирование не удалось, так как объем теневой копии не мог вырасти из-за недостаточного дискового пространства на объемах, содержащих системные файлы <br/><br/> - Следующие ошибки / предупреждения журнал присутствует в журналах событий volsnap системы: "Было недостаточно диска пространство на томе C: для роста теневой копии хранения для теневых копий C: из-за этого отказа все теневые копии тома C: находятся под угрозой удаления" | - Освободите пространство в выделенном томе в журнале событий, чтобы было достаточно места для увеличения теневых копий во время резервного копирования <br/><br/> - При настройке пространства теневой копии мы можем ограничить количество пространства, используемого для теневой копии. Для получения дополнительной информации смотрите эту [статью](https://docs.microsoft.com/windows-server/administration/windows-commands/vssadmin-resize-shadowstorage)

### <a name="efi-partition-locked"></a>Раздел EFI заблокирован

| Симптом | Решение
| -- | --
| Агент MARS выходит из строя с сообщением об ошибке: "Резервное копирование состояния системы не сработало, так как раздел системы EFI заблокирован. Это может быть связано с доступом к системе разделения сторонними безопасности или резервного копирования программного обеспечения " | - Если проблема связана с сторонним программным обеспечением безопасности, то вам нужно связаться с поставщиком Anti Virus, чтобы они могли позволить агенту MARS <br/><br/> - Если работает стороннее резервное программное обеспечение, то ждите, пока оно закончится, а затем повторно попробуйте резервное копирование

## <a name="next-steps"></a>Дальнейшие действия

- Для получения дополнительной информации о состоянии [Back up Windows Server System State](backup-azure-system-state.md) системы Windows в развертывании диспетчера ресурсов см.
