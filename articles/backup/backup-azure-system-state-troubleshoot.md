---
title: Устранение неполадок резервного копирования состояния системы с Azure Backup
description: Из этой статьи вы узнаете, как устранять неполадки в резервном копировании состояния системы для локальных серверов Windows.
ms.reviewer: srinathv
author: dcurwin
manager: carmonm
keywords: Резервное копирование; Резервное копирование состояния системы
ms.service: backup
ms.topic: conceptual
ms.date: 07/22/2019
ms.author: dacurwin
ms.openlocfilehash: eb8bf1891f5ce96507c20e196d20ae499f30fe34
ms.sourcegitcommit: ae8b23ab3488a2bbbf4c7ad49e285352f2d67a68
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/13/2019
ms.locfileid: "74012133"
---
# <a name="troubleshoot-system-state-backup"></a>Устранение неполадок резервного копирования состояния системы

В этой статье описываются решения проблем, которые могут возникнуть при использовании резервного копирования состояния системы.

## <a name="basic-troubleshooting"></a>Базовое устранение неполадок

Прежде чем начать устранение неполадок с резервным копированием состояния системы, рекомендуется выполнить приведенную ниже проверку.

- [Убедитесь, что агент Службы восстановления Microsoft Azure (MARS) не устарел](https://go.microsoft.com/fwlink/?linkid=229525&clcid=0x409)
- [Убедитесь, что между агентом служб восстановления Microsoft Azure и Azure установлено сетевое подключение](https://aka.ms/AB-A4dp50)
- Убедитесь, что службы восстановления Microsoft Azure запущены (на сервисной консоли). При необходимости перезапустите и повторите операцию.
- [Убедитесь, что в расположении временной папки доступно 5–10 % свободного места](https://aka.ms/AB-AA4dwtt).
- [Проверьте, не влияет ли на работу службы Azure Backup другой процесс или антивирусная программа](https://aka.ms/AB-AA4dwtk).
- [Запланированное резервное копирование завершается сбоем, но резервное копирование вручную работает](https://aka.ms/ScheduledBackupFailManualWorks).
- Убедитесь, что в вашей операционной системе установлены последние обновления.
- [Убедитесь, что из резервной копии исключены неподдерживаемые диски и файлы с неподдерживаемыми атрибутами](backup-support-matrix-mars-agent.md#supported-drives-or-volumes-for-backup)
- Убедитесь, что на **системных часах** в защищенной системе правильно настроен часовой пояс. <br>
- [Убедитесь, что на сервере используется версия .Net Framework не ниже 4.5.2.](https://www.microsoft.com/download/details.aspx?id=30653)<br>
- Если вы пытаетесь **повторно зарегистрировать сервер** в хранилище, <br>
  - убедитесь, что агент удален с сервера и с портала. <br>
  - Используйте ту же парольную фразу, которая изначально использовалась для регистрации сервера. <br>
- В случае автономного резервного копирования убедитесь, что Azure PowerShell версии 3.7.0 установлены на исходном и резервном компьютерах перед началом автономной архивации.
- [Вопросы, когда агент резервного копирования работает на виртуальной машине Azure](https://aka.ms/AB-AA4dwtr)

### <a name="limitation"></a>Ограничения

- Корпорация Майкрософт не рекомендует выполнять восстановление на другое оборудование с помощью функции восстановления состояния системы.
- Резервное копирование состояния системы в настоящее время поддерживает "Локальные" серверы Windows. Эта функция недоступна для виртуальных машин Azure.

## <a name="prerequisites"></a>предварительным требованиям

Перед устранением неполадок с резервным копированием состояния системы с Azure Backup выполните следующие проверки готовности к установке.  

### <a name="verify-windows-server-backup-is-installed"></a>Проверка установки cистема архивации данных Windows Server

Убедитесь, что cистема архивации данных Windows Server установлен и включен на сервере. Чтобы проверить состояние установки, выполните следующую команду PowerShell:

 ```powershell
Get-WindowsFeature Windows-Server-Backup
 ```

Если выходные данные отображают **состояние установки** как **доступное**, это означает, что компонент Windows Server Backup доступен для установки, но не установлен на сервере. Однако если cистема архивации данных Windows Server не установлен, используйте один из следующих методов для его установки.

#### <a name="method-1-install-windows-server-backup-using-powershell"></a>Метод 1. Установка cистема архивации данных Windows Server с помощью PowerShell

Чтобы установить cистема архивации данных Windows Server с помощью PowerShell, выполните следующую команду:

  ```powershell
  Install-WindowsFeature -Name Windows-Server-Backup
  ```

#### <a name="method-2-install-windows-server-backup-using-server-manager"></a>Метод 2. Установка cистема архивации данных Windows Server с помощью диспетчер сервера

Чтобы установить cистема архивации данных Windows Server с помощью диспетчер сервера, выполните следующие действия.

1. В **диспетчере сервера**щелкните **Добавить роли и компоненты**. Откроется **Мастер добавления ролей и компонентов** .

    ![Панель мониторинга](./media/backup-azure-system-state-troubleshoot/server_management.jpg)

2. Выберите **тип установки** и нажмите кнопку **Далее**.

    ![Тип установки](./media/backup-azure-system-state-troubleshoot/install_type.jpg)

3. Выберите сервер из пула серверов и нажмите кнопку **Далее**. В роли сервера Оставьте выбор по умолчанию и нажмите кнопку **Далее**.
4. Выберите **Cистема архивации данных Windows Server** на вкладке " **компоненты** " и нажмите кнопку **Далее**.

    ![features](./media/backup-azure-system-state-troubleshoot/features.png)

5. На вкладке **Подтверждение** нажмите кнопку **установить** , чтобы начать процесс установки.
6. На вкладке **результаты** отобразится компонент Cистема архивации данных Windows Server успешно установлен на сервере Windows Server.

    ![result](./media/backup-azure-system-state-troubleshoot/results.jpg)

### <a name="system-volume-information-permission"></a>Разрешение "сведения о системном томе"

Убедитесь, что локальная система имеет полный контроль над папкой **сведений о системном томе** , расположенной в томе, где установлена ОС Windows. Обычно это **К:\систем сведения о томе**. Система архивации данных Windows Server может завершиться ошибкой, если указанные выше разрешения заданы неправильно

### <a name="dependent-services"></a>Зависимые службы

Убедитесь, что следующие службы находятся в состоянии выполняется:

**Имя службы** | **Тип запуска**
--- | ---
Удаленный вызов процедур (RPC) | Автоматический
Система событий COM+ (EventSystem) | Автоматический
Служба уведомлений о системных событиях (Сенс) | Автоматический
Теневое копирование томов (VSS) | Руководство
Поставщик теневого копирования программного обеспечения Майкрософт (СВПРВ) | Руководство

### <a name="validate-windows-server-backup-status"></a>Проверка состояния cистема архивации данных Windows Server

Чтобы проверить состояние cистема архивации данных Windows Server, выполните следующие действия:

- Убедитесь, что служба WSB PowerShell запущена

  - Запустите `Get-WBJob` из PowerShell с повышенными привилегиями и убедитесь, что он не возвращает следующую ошибку:

    > [!WARNING]
    > Get-Вбжоб: термин "Get-Вбжоб" не распознан как имя командлета, функции, файла скрипта или исполняемой программы. Проверьте правильность написания имени, а также наличие и правильность пути, после чего повторите попытку.

    - Если эта ошибка завершилась сбоем, переустановите компонент cистема архивации данных Windows Server на компьютере сервера, как упоминалось в предварительных требованиях к шагу 1.

  - Убедитесь, что резервное копирование WSB работает правильно, выполнив следующую команду из командной строки с повышенными привилегиями:

      `wbadmin start systemstatebackup -backuptarget:X: -quiet`

      > [!NOTE]
      >Замените X буквой диска тома, на котором нужно сохранить образ резервной копии состояния системы.

    - Периодически проверяйте состояние задания, выполнив команду `Get-WBJob` из PowerShell с повышенными правами.
    - После завершения задания резервного копирования проверьте окончательное состояние задания, выполнив команду `Get-WBJob -Previous 1`

Если задание завершается ошибкой, это указывает на проблему WSB, которая приведет к сбою резервного копирования состояния системы агента MARS.

## <a name="common-errors"></a>Распространенные ошибки

### <a name="vss-writer-timeout-error"></a>Ошибка времени ожидания модуля записи VSS

| Симптом | Причина: | Способы устранения:
| -- | -- | --
| -Агент MARS завершается с сообщением об ошибке: "сбой задания WSB с ошибками VSS. Проверьте журналы событий VSS для устранения ошибки "<br/><br/> — В журналах событий приложений VSS содержится следующий журнал ошибок: "модуль записи VSS отклонил событие с ошибкой 0x800423f2, время ожидания модуля записи истекло между событиями замораживания и разморозкой".| Не удается завершить модуль записи VSS по истечении времени из-за нехватки ресурсов ЦП и памяти на компьютере <br/><br/> Другое программное обеспечение для резервного копирования уже использует модуль записи VSS, так как операция моментального снимка не может завершиться для этой резервной копии | Подождите, пока процессор или память будут освобождены в системе или прервать процессы, которые занимают слишком много памяти или ЦП, и повторите операцию. <br/><br/>  Дождитесь завершения текущей резервной копии и повторите операцию позже, когда на компьютере не выполняются резервные копии.

### <a name="insufficient-disk-space-to-grow-shadow-copies"></a>Недостаточно места на диске для расширения теневых копий

| Симптом | Способы устранения:
| -- | --
| -Агент MARS завершается сбоем с сообщением об ошибке: не удалось выполнить резервное копирование, так как не удалось увеличить том теневой копии из-за недостатка места на томах, содержащих системные файлы <br/><br/> -В журналах системных событий Volsnap присутствует следующий журнал ошибок и предупреждений: "недостаточно места на диске в томе C: для увеличения размера хранилища теневых копий на диск c: из-за этого сбоя все теневые копии тома C: подвергаются риску удаления" | — Освободите место в выделенном томе в журнале событий, чтобы в процессе резервного копирования было достаточно места для увеличения размера теневых копий. <br/><br/> — При настройке пространства теневого копирования можно ограничить объем пространства, используемого для теневого копирования. Дополнительные сведения см. в этой [статье](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc788050(v=ws.11)#syntax) .

### <a name="efi-partition-locked"></a>Раздел EFI заблокирован

| Симптом | Способы устранения:
| -- | --
| Сбой агента MARS с сообщением об ошибке: "не удалось выполнить резервное копирование состояния системы, так как системный раздел EFI заблокирован. Это может быть вызвано доступом к системным разделам по безопасности или резервному копированию сторонних разработчиков. | Если причиной проблемы является стороннее программное обеспечение безопасности, необходимо обратиться к поставщику антивирусной программы, чтобы он мог разрешить использование агента MARS. <br/><br/> — Если выполняется стороннее программное обеспечение резервного копирования, дождитесь его завершения и повторите архивацию.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о состоянии системы Windows в диспетчер ресурсов развертывании см. в разделе [резервное копирование состояния системы Windows Server](backup-azure-system-state.md) .
