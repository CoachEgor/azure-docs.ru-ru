---
title: Интеграция с партнером датчика
description: Описывает интеграцию с партнером датчика
author: uhabiba04
ms.topic: article
ms.date: 11/04/2019
ms.author: v-umha
ms.openlocfilehash: 7a85ed93d9ee01255d809cce84ebe24e6c3f71d1
ms.sourcegitcommit: 16c5374d7bcb086e417802b72d9383f8e65b24a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73847394"
---
# <a name="sensor-partner-integration"></a>Интеграция с партнером датчика

В этой статье содержатся сведения о компоненте Azure Фармбеатс **Translator** , который обеспечивает интеграцию с партнером датчика.

С помощью этого компонента партнеры могут разрабатывать датчики, которые интегрируются с Фармбеатс, используя наш API и отправляя данные и телеметрию устройства клиента в центр данных Фармбеатс. Визуализация данных осуществляется с помощью ускорителя Фармбеатс. Данные можно использовать для создания данных, а также для разработки моделей машинного или искусственного интеллекта.

## <a name="link-farmbeats-account"></a>Связать учетную запись Фармбеатс

Когда клиенты приобрели и развернули устройства и датчики, они могут получить доступ к данным и телеметрии устройства на портале SaaS (программное обеспечение как услуга). Партнеры устройств должны позволить клиентам связать свою учетную запись с экземпляром Фармбеатс в Azure. Для заполнения клиентом или системным интегратором требуются следующие учетные данные:

   - Отображаемое имя (необязательное поле для пользователя, определяющее имя для этой интеграции)
   - Конечная точка API
   - Tenant ID
   - Идентификатор клиента
   - Секрет клиента
   - Строка подключения EventHub
   - Дата начала

   > [!NOTE]
   > Дата начала включает поток данных журнала, т. е. данные за дату, указанную пользователем.

## <a name="unlink-farmbeats"></a>Удалить связь Фармбеатс

У клиентов есть возможность удалить связь с существующей интеграцией Фармбеатс. При удалении связи Фармбеатс не следует удалять метаданные устройства или датчика, созданные в концентраторе данных клиента. Отмена связи выполняет следующие действия.

   - Останавливает поток телеметрии.
   - Удаление и удаление учетных данных интеграции в партнере устройства.

## <a name="edit-farmbeats-integration"></a>Изменить интеграцию Фармбеатс

Клиент может изменить параметры интеграции Фармбеатс при изменении секрета клиента или строки подключения. В этом случае клиент может изменять только следующие поля:

   - Отображаемое имя (если применимо)
   - Секрет клиента (должен отображаться в формате «2x8 * * * *» или «Показать/скрыть», а не в виде открытого текста)
   - Строка подключения (должна отображаться в формате «2x8 * * * * * * * * *» или «Показать/скрыть», а не в виде открытого текста)

## <a name="view-last-telemetry-sent"></a>Просмотреть последние отправленные данные телеметрии

Можно просмотреть отметку времени последней **отправленной телеметрии**. Это время, когда последние данные телеметрии успешно отправлены в Фармбеатс.

## <a name="translator-development"></a>Разработка переводчиков

**Интеграция на основе API-интерфейса RESTful**

Возможности интеграции данных датчика Фармбеатс предоставляются через REST API. К возможностям относятся определение метаданных, подготовка устройств и датчиков, устройство и управление датчиками.

**Прием телеметрии**

Данные телеметрии сопоставляются с каноническим сообщением, которое публикуется в концентраторе событий Azure для обработки. Azure EventHub — это служба, которая обеспечивает прием данных (телеметрии) в режиме реального времени от подключенных устройств и приложений.

**Разработка API**

API-интерфейсы содержат техническую документацию по Swagger. Дополнительные сведения об API и соответствующих запросах и ответах см. в разделе [Swagger](https://aka.ms/FarmBeatsDatahubSwagger) .

**Проверка подлинности**

Фармбеатс использует проверку подлинности Active Directory Microsoft Azure. Служба приложений Azure предоставляет встроенную поддержку проверки подлинности и авторизации.

Дополнительные сведения см. в разделе [Azure Active Directory](https://docs.microsoft.com/azure/app-service/overview-authentication-authorization).

Фармбеатс Data Hub использует проверку подлинности носителя, для которой требуются следующие учетные данные:
   - Идентификатор клиента
   - Секрет клиента
   - Tenant ID

Используя указанные выше учетные данные, вызывающий объект может запросить маркер доступа, который необходимо отправить в последующих запросах API в разделе заголовка следующим образом:

```
headers = {"Authorization": "Bearer " + access_token, …} 
```

Ниже приведен пример кода Python, который предоставляет маркер доступа, который можно использовать для последующих вызовов API к Фармбеатс: 

```python
import azure 

from azure.common.credentials import ServicePrincipalCredentials 
import adal 
#FarmBeats API Endpoint 
ENDPOINT = "https://<yourdatahub>.azurewebsites.net" [Azure website](https://<yourdatahub>.azurewebsites.net)
CLIENT_ID = "<Your Client ID>"   
CLIENT_SECRET = "<Your Client Secret>"   
TENANT_ID = "<Your Tenant ID>" 
AUTHORITY_HOST = 'https://login.microsoftonline.com' 
AUTHORITY = AUTHORITY_HOST + '/' + TENANT_ID 
#Authenticating with the credentials 
context = adal.AuthenticationContext(AUTHORITY) 
token_response = context.acquire_token_with_client_credentials(ENDPOINT, CLIENT_ID, CLIENT_SECRET) 
#Should get an access token here 
access_token = token_response.get('accessToken') 
```


**Заголовки HTTP-запросов**

Ниже приведены наиболее распространенные заголовки запросов, которые необходимо указать при вызове API в Фармбеатс Data Hub:


**Верхняя часть** | **Описание и пример**
--- | ---
Content-Type | Формат запроса (Content-Type: Application/<format>) для интерфейса API концентратора данных Фармбеатс имеет формат JSON. Тип содержимого: Application/JSON
Авторизация | Указывает маркер доступа, необходимый для выполнения авторизации вызова API: Bearer < доступ — токен >
Принять | Формат ответа. Для интерфейсов API концентратора данных Фармбеатс используется формат JSON Accept: Application/JSON.

**Запросы API**

Чтобы выполнить запрос API для ОСТАВШЕЙся презентации (передача состояния), вы объединяете метод HTTP (GET, POST, или размещение), URL-адрес службы API, URI (универсальный идентификатор ресурса) для запроса, отправки данных в, обновления или удаления, а также один или несколько HTTP-запросов. Верхний. URL-адрес службы API — это конечная точка API, предоставляемая клиентом. Пример: https://\<йоурдатахуб-website-name >. azurewebsites. NET

При необходимости можно включить параметры запроса на вызов GET для фильтрации, ограничить размер и отсортировать данные в ответах.

Ниже приведен пример запроса для получения списка устройств:

```
curl -X GET "https://microsoft-farmbeats.azurewebsites.net/Device" -H "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>”
```
Для большинства вызовов GET, POST и постановки требуется текст запроса JSON.

Приведенный ниже пример запроса заключается в создании устройства (этот пример содержит входной JSON с текстом запроса).

```
curl -X POST "https://microsoft-farmbeats.azurewebsites.net/Device" -H  "accept: application/json" -H  "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>" -d "{  \"deviceModelId\": \"ID123\",  \"hardwareId\": \"MHDN123\",  \"reportingInterval\": 900,  \"name\": \"Device123\",  \"description\": \"Test Device 123\",}"
```

## <a name="data-format"></a>Формат данных

JSON (нотация объектов JavaScript) — это распространенный, не зависящий от языка формат данных, предоставляющий простое текстовое представление произвольных структур данных. Дополнительные сведения см. в разделе [JSON.org](http://json.org).

## <a name="metadata-specifications"></a>Спецификации метаданных

В центре данных Фармбеатс есть следующие API, которые позволяют партнерам устройств создавать метаданные устройства или датчика и управлять ими.  

- /модель устройства **DeviceModel** соответствует метаданным устройства, например изготовителю, тип устройства — шлюз или узел.  
- /**устройство** — устройство соответствует физическому устройству, присутствующему в ферме.
- /модель датчика **сенсормодел** соответствует метаданным датчика, таким как производитель, тип датчика: аналоговая или цифровая, мера датчика, например внешняя температура, давление и т. д.
- Датчик **датчика** /соответствует физическому датчику, записывающему значения. Датчик обычно подключается к устройству с ИДЕНТИФИКАТОРом устройства.

  Модель устройства| DeviceModel соответствует метаданным устройства, например изготовителю, тип устройства: шлюз или узел.
  --- | ---
  Тип (узел, шлюз)  | 1 звезда |
  Производитель  | 2 звезды |
  ProductCode  | Код продукта устройства или имя или номер модели. Например, Енвиромонитор # 6800 |
  порты;  | Имя и тип порта (цифровой/аналоговый)  |
  Имя  | Имя, идентифицирующее ресурс. Например, имя модели или название продукта |
  Description (Описание)  | Укажите понятное описание модели |
  Свойства  | Дополнительные свойства от изготовителя |
  **Устройство** | **Устройство соответствует физическому устройству, присутствующему в ферме. Каждое устройство имеет уникальный идентификатор устройства** |
девицемоделид  |ИДЕНТИФИКАТОР связанной модели устройства. |
хардвареид   |Уникальный идентификатор устройства, например MAC-адрес и т. д.  |
репортингинтервал |Интервал составления отчета в секундах |
Расположение    |Широта устройства (от-90 до + 90)/лонгитуде (от-180 до 180)/елеватион (в метрах) |
парентдевицеид | Идентификатор родительского устройства, к которому подключено это устройство. Предположим, Узел, подключенный к шлюзу; узел будет иметь Парентдевицеид в качестве шлюза |
  Имя  | Имя, идентифицирующее ресурс.  Партнерам устройств потребуется отправить имя, которое соответствует имени устройства на стороне партнера устройства. Если имя устройства определяется пользователем на стороне партнера по устройству, то то же самое определенное пользователем имя должно распространяться на Фармбеатс  |
  Description (Описание)  | Введите понятное описание  |
  Свойства  |Дополнительные свойства от изготовителя  |
  **Модель датчика** | Сенсормодел соответствует метаданным датчика, таким как производитель, тип датчика: аналоговый или цифровой, датчик датчика, например окружающая температура, давление и т. д. |
  Тип (аналоговый, цифровой)  |Упоминание аналогового или цифрового датчика|
  manufacturer  | имя производителя |
  ProductCode  | Код продукта или имя или номер модели. Например, RS-CO2-N01  |
  Имя > Сенсормеасурес  | Имя меры датчика. Поддерживается только нижний регистр. Для показателя с различной глубиной укажите глубину. Например, soil_moisture_15cm это имя должно быть совместимо с данными телеметрии. |
  Тип данных Сенсормеасурес >  | Тип данных телеметрии. В настоящее время поддерживается Double  |
  Тип > Сенсормеасурес  | Тип измерения данных телеметрии датчика. Ниже приведены определяемые системой типы: Амбиенттемпературе, CO2, Depth, Електрикалкондуктивити, Леафветнесс, Length, Ликуидлевел, нитрате, O2, PH, фосфате, PointInTime, potassium, давление, RainGauge, RelativeHumidity, Salinity, SoilMoisture, Соилтемпературе, Соларрадиатион, State, Тимедуратион, Уврадиатион, Увиндекс, том, Винддиректион, Виндрун, WindSpeed, Evapotranspiration, номинал. Чтобы добавить дополнительные сведения, обратитесь к API/Екстендедтипе.
  Единица > Сенсормеасурес | Единица данных телеметрии датчика. Ниже перечислены определяемые системой единицы: подразделение, градусы Цельсия, Фаренгейта, Кельвина, Ранкине, Pascal, Меркурий, PSI, миллиметры, сантиметры, метры, дюймы, футы, мили, километры, Милесперхаур, Милесперсеконд, Кмперхаур, Кмперсеконд, Метерсперхаур, Метерсперсеконд, degree, Ваттсперскуареметер, Киловаттсперскуареметер, Милливаттсперскуарецентиметер, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, процент, PartsPerMillion, MicroMol, MicroMolesPerLiter, Сиеменсперскуареметерпермоле, Миллисиеменсперцентиметер, Центибар, ДеЦисиеменсперметер, KiloPascal, VolumetricIonContent, Liter, MilliLiter, seconds, UnixTimestamp, MicroMolPerMeterSquaredPerSecond, InchesPerHour для добавления дополнительных, см./ API ExtendedType
  Сенсормеасурес > aggregationType  | Ни None, СРЗНАЧ, максимум, минимум, стандартное отклонение
  Глубина > Сенсормеасурес  | Глубина датчика в сантиметрах (например, мера влажность 10 cm под заземлением)
  Описание > Сенсормеасурес  | Введите понятное описание меры
  name  | Имя, идентифицирующее ресурс. Например, имя модели или название продукта
  description  | Укажите понятное описание модели
  properties  | Дополнительные свойства от изготовителя
  **Датчика**  |
  хардвареид  | Уникальный идентификатор для датчика, установленного производителем
  сенсормоделид  | ИДЕНТИФИКАТОР связанной модели датчика.
  location  | Датчик широты (от-90 до + 90)/лонгитуде (от-180 до 180)/елеватион (в метрах)
  имя > порта  |Имя и тип порта, к которому подключен датчик на устройстве. Это имя должно совпадать с именем, определенным в модели устройства
  deviceId  | ИДЕНТИФИКАТОР устройства, к которому подключен датчик
  name  | Имя, идентифицирующее ресурс. Например, имя датчика/название продукта и номер модели/код продукта.
  description  | Введите понятное описание
  properties  | Дополнительные свойства от изготовителя

 Сведения о каждом из объектов и их свойствах см. в разделе [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

 > [!NOTE]
 > API-интерфейсы возвращают уникальные идентификаторы для каждого созданного экземпляра. Этот идентификатор должен храниться в трансляторе для управления устройствами и синхронизации метаданных.


**Синхронизация метаданных**

Переводчик должен отправить обновления метаданных. Например, для сценариев обновления — изменение имени устройства или датчика, изменение расположения устройства или датчика.

Переводчик должен иметь возможность добавлять новые устройства и (или) датчики, которые были установлены пользователем после связывания Фармбеатс. Аналогично, если устройство или датчик было обновлено пользователем, то то же самое необходимо обновить в Фармбеатс для соответствующего устройства или датчика. Типичными сценариями для обновления устройства или датчика могут быть: изменение расположения устройства, добавление датчиков на узле и т. д.


> [!NOTE]
> Удаление не поддерживается для метаданных устройства или датчика.
>
> Чтобы обновить метаданные, необходимо вызвать/жет/{ИД} на устройстве или датчике, обновить измененные свойства, а затем выполнить/пут/{ИД}, чтобы все установленные пользователем свойства не были потеряны.

### <a name="adding-new-typesunit"></a>Добавление новых типов или единиц

Фармбеатс поддерживает добавление новых типов мер датчика и единиц. Дополнительные сведения об API/Екстендедтипе см. в статье [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

## <a name="telemetry-specifications"></a>Спецификации телеметрии

Данные телеметрии сопоставляются с каноническим сообщением, которое публикуется в концентраторе событий Azure для обработки. Azure EventHub — это служба, которая обеспечивает прием данных (телеметрии) в режиме реального времени от подключенных устройств и приложений.

## <a name="send-telemetry-data-to-farmbeats"></a>Отправка данных телеметрии в Фармбеатс

Чтобы отправить данные телеметрии в Фармбеатс, необходимо создать клиент, отправляющий сообщения в концентратор событий в Фармбеатс. Дополнительные сведения о данных телеметрии см. [в разделе Отправка телеметрии в концентратор событий](https://docs.microsoft.com/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send).

Ниже приведен пример кода Python, который отправляет данные телеметрии в качестве клиента в указанный концентратор событий:

```python
import azure
from azure.eventhub import EventHubClient, Sender, EventData, Receiver, Offset
EVENTHUBCONNECTIONSTRING = "<EventHub Connection String provided by customer>"
EVENTHUBNAME = "<EventHub Name provided by customer>"

write_client = EventHubClient.from_connection_string(EVENTHUBCONNECTIONSTRING, eventhub=EVENTHUBNAME, debug=False)
sender = write_client.add_sender(partition="0")
write_client.run()
for i in range(5):
    telemetry = "<Canonical Telemetry message>"
    print("Sending telemetry: " + telemetry)
    sender.send(EventData(telemetry))
write_client.stop()

```

Канонический формат сообщений:

```
{
“deviceid”: “<id of the Device created>”,
 "timestamp": "<timestamp in ISO 8601 format>",
"version" : "1",
"sensors": [
    {
      "id": "<id of the sensor created>”
      "sensordata": [
        {
          "timestamp": "< timestamp in ISO 8601 format >",
          "<sensor measure name (as defined in the Sensor Model)>": value
        },
        {
          "timestamp": "<timestamp in ISO 8601 format>",
          "<sensor measure name (as defined in the Sensor Model)>": value
        }
      ]
    }
}

```

Все имена ключей в JSON телеметрии должны быть в нижнем регистре, например DeviceID, sensordata и т. д.

Например, сообщение телеметрии:


```
{
  "deviceid": "7f9b4b92-ba45-4a1d-a6ae-c6eda3a5bd12",
  "timestamp": "2019-06-22T06:55:02.7279559Z",
  "version" : "1",
  "sensors": [
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 15
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 42
        }
      ]
    },
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 20
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 89
        }
      ]
    }
  ]
}

```

## <a name="troubleshooterror-management"></a>Устранение неполадок и управление ошибками

**Устранение неполадок и поддержка**

Если клиент не может получать данные устройства и (или) телеметрии в указанном экземпляре Фармбеатс, то партнеру устройства следует предоставить поддержку и механизм для устранения неполадок.

**Хранение данных телеметрии**

Данные телеметрии также должны храниться для заранее определенного периода времени, чтобы они могли быть полезны при отладке или повторной отправке телеметрии в случае ошибки или потери данных.

**Управление ошибками/уведомление об ошибке**

В случае ошибки, которая влияет на передачу метаданных устройства/датчика, а также на поток данных телеметрии в системе партнера по устройствам, то то же самое должно быть уведомлено клиенту. Механизм для разрешения ошибок также должен быть спроектирован и реализован.

**Контрольный список подключения**

Производители устройств и партнеры могут использовать следующий работоспособностиный тест или контрольный список, чтобы обеспечить точность учетных данных, предоставленных клиентом.

   - Проверка получения маркера доступа с предоставленными учетными данными
   - Проверка успешности вызова API с полученным маркером доступа
   - Проверьте, установлено ли клиентское подключение EventHub

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о REST API см. в разделе [REST API](references-for-farmbeats.md#rest-api).
