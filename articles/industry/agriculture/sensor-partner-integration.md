---
title: Интеграция с партнерскими датчиками
description: В этой статье описывается интеграция с партнером датчика.
author: uhabiba04
ms.topic: article
ms.date: 11/04/2019
ms.author: v-umha
ms.openlocfilehash: 1570e85d93e7d82b5a842697a7755603247375b0
ms.sourcegitcommit: 8bd85510aee664d40614655d0ff714f61e6cd328
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/06/2019
ms.locfileid: "74896530"
---
# <a name="sensor-partner-integration"></a>Интеграция с партнерскими датчиками

В этой статье содержатся сведения о компоненте Azure Фармбеатс Translator, который обеспечивает интеграцию с партнером датчика.

С помощью этого компонента партнеры могут разрабатывать датчики, которые интегрируются с Фармбеатс, для использования API и отправки данных и телеметрии устройства клиента в Фармбеатс Датахуб. Визуализация данных осуществляется с помощью ускорителя Фармбеатс. Данные можно использовать для слияния данных, а также для создания моделей машинного обучения и искусственного интеллекта.

## <a name="link-a-farmbeats-account"></a>Связывание учетной записи Фармбеатс

После приобретения и развертывания устройств или датчиков вы можете получить доступ к данным и телеметрии устройств на портале программного обеспечения (Software as Service – услуга) для партнеров на устройствах. Партнеры устройств позволяют связать учетную запись с экземпляром Фармбеатс в Azure. Следующие учетные данные должны быть заполнены вами или системным интегратором:

   - Отображаемое имя (необязательное поле для пользователей, определяющее имя для этой интеграции)
   - Конечная точка API
   - Tenant ID
   - Идентификатор клиента
   - Секрет клиента
   - Строка подключения EventHub
   - Дата начала

   > [!NOTE]
   > Начальная дата включает поток данных журнала, то есть данные за дату, указанную пользователем.

## <a name="unlink-farmbeats"></a>Удалить связь Фармбеатс

У вас есть возможность удалить связь с существующей интеграцией Фармбеатс. Удаление связи Фармбеатс не должно удалять метаданные устройства или датчика, созданные в концентраторе данных. Отмена связи выполняет следующие действия.

   - Останавливает поток телеметрии.
   - Удаляет и стирает учетные данные интеграции на партнере устройства.

## <a name="edit-farmbeats-integration"></a>Изменить интеграцию Фармбеатс

Вы можете изменить параметры интеграции Фармбеатс при изменении секрета клиента или строки подключения. В этом случае можно изменять только следующие поля:

   - Отображаемое имя (если применимо)
   - Секрет клиента (должен отображаться в формате «2x8 * * * *» или «Показать/скрыть», а не в виде открытого текста)
   - Строка подключения (должна отображаться в формате «2x8 * * * * * * * * *» или «Показать/скрыть», а не в виде открытого текста)

## <a name="view-the-last-telemetry-sent"></a>Просмотр последней отправленной телеметрии

Вы можете просмотреть метку времени последней отправленной телеметрии, которая находится в разделе **Отправка данных телеметрии**. Это время, когда последние данные телеметрии успешно отправлены в Фармбеатс.

## <a name="translator-development"></a>Разработка переводчиков

**Интеграция на основе REST API**

Возможности интеграции данных датчика Фармбеатс предоставляются через REST API. К возможностям относятся определение метаданных, подготовка устройств и датчиков, а затем Управление устройствами и датчиками.

**Прием телеметрии**

Данные телеметрии сопоставляются с каноническим сообщением, опубликованным в концентраторах событий Azure для обработки. Концентраторы событий Azure — это служба, которая обеспечивает прием данных (телеметрии) в режиме реального времени от подключенных устройств и приложений.

**Разработка API**

API-интерфейсы содержат техническую документацию по Swagger. Дополнительные сведения об API и соответствующих запросах или ответах см. в разделе [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

**Authentication** (Аутентификация)

Фармбеатс использует проверку подлинности Microsoft Azure Active Directory. Служба приложений Azure предоставляет встроенную поддержку проверки подлинности и авторизации.

Дополнительные сведения см. в разделе [Azure Active Directory](https://docs.microsoft.com/azure/app-service/overview-authentication-authorization).

Фармбеатс Датахуб использует проверку подлинности носителя, для которой требуются следующие учетные данные:
   - Идентификатор клиента
   - Секрет клиента
   - Tenant ID

Используя эти учетные данные, вызывающий объект может запросить маркер доступа. Маркер должен быть отправлен в последующих запросах API в разделе заголовка следующим образом:

```
headers = {"Authorization": "Bearer " + access_token, …} 
```

В следующем примере кода Python предоставляется маркер доступа, который можно использовать для последующих вызовов API к Фармбеатс.

```python
import azure 

from azure.common.credentials import ServicePrincipalCredentials 
import adal 
#FarmBeats API Endpoint 
ENDPOINT = "https://<yourdatahub>.azurewebsites.net" [Azure website](https://<yourdatahub>.azurewebsites.net)
CLIENT_ID = "<Your Client ID>"   
CLIENT_SECRET = "<Your Client Secret>"   
TENANT_ID = "<Your Tenant ID>" 
AUTHORITY_HOST = 'https://login.microsoftonline.com' 
AUTHORITY = AUTHORITY_HOST + '/' + TENANT_ID 
#Authenticating with the credentials 
context = adal.AuthenticationContext(AUTHORITY) 
token_response = context.acquire_token_with_client_credentials(ENDPOINT, CLIENT_ID, CLIENT_SECRET) 
#Should get an access token here 
access_token = token_response.get('accessToken') 
```


**Заголовки HTTP-запросов**

Ниже приведены наиболее распространенные заголовки запросов, которые необходимо указать при вызове API в Фармбеатс Датахуб.


**Верхняя часть** | **Описание и пример**
--- | ---
Content-Type | Формат запроса (Content-Type: Application/<format>). Для API-интерфейсов Фармбеатс Датахуб используется формат JSON. Content-Type: application/json
Авторизация | Указывает маркер доступа, необходимый для выполнения вызова API. Авторизация: носитель < доступ — токен >
Принять | Формат ответа. Для API-интерфейсов Фармбеатс Датахуб используется формат JSON. Принять: приложение/JSON

**Запросы API**

Чтобы выполнить запрос REST API, вы объединяете метод HTTP (GET, POST или WHERE), URL-адрес службы API, универсальный код ресурса (URI) для запроса, отправки данных, обновления или удаления, а также один или несколько заголовков HTTP-запроса. URL-адрес службы API — это конечная точка API, которую вы предоставляете. Вот пример: https://\<йоурдатахуб-website-name >. azurewebsites. NET

При необходимости можно включить параметры запроса на вызов GET для фильтрации, ограничить размер и отсортировать данные в ответах.

Следующий пример запроса — получение списка устройств.

```bash
curl -X GET "https://microsoft-farmbeats.azurewebsites.net/Device" -H "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>"
```
Для большинства вызовов GET, POST и постановки требуется текст запроса JSON.

Следующий пример запроса — создание устройства. (Этот пример содержит входной JSON с текстом запроса.)

```bash
curl -X POST "https://microsoft-farmbeats.azurewebsites.net/Device" -H  "accept: application/json" -H  "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>" -d "{  \"deviceModelId\": \"ID123\",  \"hardwareId\": \"MHDN123\",  \"reportingInterval\": 900,  \"name\": \"Device123\",  \"description\": \"Test Device 123\",}"
```

## <a name="data-format"></a>Формат данных

JSON является стандартным форматом данных, не зависящим от языка, предоставляющим простое текстовое представление произвольных структур данных. Дополнительные сведения см. в разделе [JSON.org](http://json.org).

## <a name="metadata-specifications"></a>Спецификации метаданных

Фармбеатс Датахуб имеет следующие API, которые позволяют партнерам устройств создавать метаданные устройства или датчика и управлять ими. 

- /**DeviceModel**: DeviceModel соответствует метаданным устройства, например изготовителю, и типу устройства, которое является либо шлюзом, либо узлом. 
- **устройство**/: устройство соответствует физическому устройству, присутствующему в ферме.
- /**сенсормодел**: сенсормодел соответствует метаданным датчика, например изготовителю, типу датчика, который является либо аналоговым, либо цифровым, а также мерой датчика, например окружающей температуры и нажимом.
- **датчик**/: Датчик соответствует физическому датчику, записывающему значения. Датчик обычно подключается к устройству с ИДЕНТИФИКАТОРом устройства.
  
  **DeviceModel** |  |
  --- | ---
  Тип (узел, шлюз)  | 1 звезда |
  Производитель  | 2 звезды |
  ProductCode  | Код продукта устройства или имя или номер модели. Например, Енвиромонитор # 6800. |
  порты;  | Имя и тип порта, которые являются цифровыми или аналоговыми.  |
  Name  | Имя, идентифицирующее ресурс. Например, имя модели или название продукта. |
  Описание  | Введите понятное описание модели. |
  properties  | Дополнительные свойства от производителя. |
  **Устройство** |  |
  девицемоделид  |ИДЕНТИФИКАТОР связанной модели устройства. |
  хардвареид   |Уникальный идентификатор устройства, например MAC-адрес.  |
  ReportingInterval |Интервал составления отчета в секундах. |
  Location    |Широта устройства (от-90 до + 90), Долгота (от-180 до 180) и повышение уровня (в метрах). |
  парентдевицеид | Идентификатор родительского устройства, к которому подключено это устройство. Например, если узел подключен к шлюзу, узел имеет Парентдевицеид в качестве шлюза. |
  Name  | Имя, идентифицирующее ресурс. Партнерам по устройствам необходимо отправить имя, которое соответствует имени устройства на стороне партнера устройства. Если имя устройства задано пользователем на стороне партнера устройства, то то же самое определенное пользователем имя должно распространяться на Фармбеатс.  |
  Описание  | Введите осмысленное описание.  |
  properties  |Дополнительные свойства от производителя.  |
  **сенсормодел** |  |
  Тип (аналоговый, цифровой)  |Упоминание аналогового или цифрового датчика.|
  Производитель  | Имя производителя. |
  ProductCode  | Код продукта или имя или номер модели. Например, RS-CO2-N01.  |
  Имя > Сенсормеасурес  | Имя меры датчика. Поддерживается только строчные буквы. Для измерений с различной глубиной укажите глубину. Например, soil_moisture_15cm. Это имя должно быть совместимо с данными телеметрии. |
  Тип данных Сенсормеасурес >  | Тип данных телеметрии. В настоящее время поддерживается Double. |
  Тип > Сенсормеасурес  | Тип измерения данных телеметрии датчика. Ниже приведены определяемые системой типы: Амбиенттемпературе, CO2, Depth, Електрикалкондуктивити, Леафветнесс, Length, Ликуидлевел, нитрате, O2, PH, фосфате, PointInTime, potassium, давление, RainGauge, RelativeHumidity, Salinity, SoilMoisture, Соилтемпературе, Соларрадиатион, State, Тимедуратион, Уврадиатион, Увиндекс, том, Винддиректион, Виндрун, WindSpeed, Evapotranspiration, номинал. Чтобы добавить дополнительные сведения, обратитесь к API/Екстендедтипе.
  Единица > Сенсормеасурес | Единица данных телеметрии датчика. Ниже перечислены определяемые системой единицы: подразделение, градусы Цельсия, Фаренгейта, Кельвина, Ранкине, Pascal, Меркурий, PSI, миллиметры, сантиметры, метры, дюймы, футы, мили, километры, Милесперхаур, Милесперсеконд, Кмперхаур, Кмперсеконд, Метерсперхаур, Метерсперсеконд, degree, Ваттсперскуареметер, Киловаттсперскуареметер, Милливаттсперскуарецентиметер, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, процент, PartsPerMillion, MicroMol, MicroMolesPerLiter, Сиеменсперскуареметерпермоле, Миллисиеменсперцентиметер, Центибар, ДеЦисиеменсперметер, KiloPascal, VolumetricIonContent, Liter, MilliLiter, seconds, UnixTimestamp, MicroMolPerMeterSquaredPerSecond и InchesPerHour. Чтобы добавить дополнительные сведения, обратитесь к API/Екстендедтипе.
  Сенсормеасурес > AggregationType  | Нет, СРЗНАЧ, максимум, минимум или стандартное отклонение.
  Глубина > Сенсормеасурес  | Глубина датчика в сантиметрах. Например, измерение влажность 10 cm под заземлением.
  Описание > Сенсормеасурес  | Введите понятное описание измерения.
  Name  | Имя, идентифицирующее ресурс. Например, имя модели или название продукта.
  Описание  | Введите понятное описание модели.
  properties  | Дополнительные свойства от производителя.
  **Датчика**  |  |
  хардвареид  | Уникальный идентификатор для датчика, установленного производителем.
  сенсормоделид  | ИДЕНТИФИКАТОР связанной модели датчика.
  Location  | Датчик широты (от-90 до + 90), Долгота (от-180 до 180) и повышение уровня (в метрах).
  Имя > порта  |Имя и тип порта, к которому подключен датчик на устройстве. Это имя должно совпадать с именем, определенным в модели устройства.
  deviceId  | ИДЕНТИФИКАТОР устройства, к которому подключен датчик.
  Name  | Имя, идентифицирующее ресурс. Например, имя датчика или название продукта, номер модели или код продукта.
  Описание  | Введите осмысленное описание.
  properties  | Дополнительные свойства от производителя.

 Сведения о каждом из объектов и их свойствах см. в разделе [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

 > [!NOTE]
 > API-интерфейсы возвращают уникальные идентификаторы для каждого созданного экземпляра. Этот идентификатор должен храниться в трансляторе для управления устройствами и синхронизации метаданных.


**Синхронизация метаданных**

Переводчик должен отправить обновления метаданных. Например, сценарии обновления — это изменение имени устройства или датчика, а также изменение расположения устройства или датчика.

Переводчик должен иметь возможность добавлять новые устройства или датчики, которые были установлены пользователем при компоновке Фармбеатс. Аналогично, если устройство или датчик обновлялось пользователем, то то же самое необходимо обновить в Фармбеатс для соответствующего устройства или датчика. Типичные сценарии, требующие обновления устройства или датчика, — это изменение в расположении устройства или добавление датчиков в узле.


> [!NOTE]
> Удаление не поддерживается для метаданных устройства или датчика.
>
> Чтобы обновить метаданные, необходимо вызвать/жет/{ИД} на устройстве или датчике, обновить измененные свойства, а затем выполнить/пут/{ИД}, чтобы все свойства, заданные пользователем, не были потеряны.

### <a name="add-new-types-and-units"></a>Добавление новых типов и единиц

Фармбеатс поддерживает добавление новых типов мер датчика и единиц. Дополнительные сведения об API/Екстендедтипе см. в разделе [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

## <a name="telemetry-specifications"></a>Спецификации телеметрии

Данные телеметрии сопоставляются с каноническим сообщением, опубликованным в концентраторах событий Azure для обработки. Концентраторы событий Azure — это служба, которая обеспечивает прием данных (телеметрии) в режиме реального времени от подключенных устройств и приложений.

## <a name="send-telemetry-data-to-farmbeats"></a>Отправка данных телеметрии в Фармбеатс

Чтобы отправить данные телеметрии в Фармбеатс, создайте клиент, отправляющий сообщения в концентратор событий в Фармбеатс. Дополнительные сведения о данных телеметрии см. [в статье отправка телеметрии в концентратор событий](https://docs.microsoft.com/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send).

Ниже приведен пример кода Python, который отправляет данные телеметрии в качестве клиента в указанный концентратор событий.

```python
import azure
from azure.eventhub import EventHubClient, Sender, EventData, Receiver, Offset
EVENTHUBCONNECTIONSTRING = "<EventHub Connection String provided by customer>"
EVENTHUBNAME = "<EventHub Name provided by customer>"

write_client = EventHubClient.from_connection_string(EVENTHUBCONNECTIONSTRING, eventhub=EVENTHUBNAME, debug=False)
sender = write_client.add_sender(partition="0")
write_client.run()
for i in range(5):
    telemetry = "<Canonical Telemetry message>"
    print("Sending telemetry: " + telemetry)
    sender.send(EventData(telemetry))
write_client.stop()

```

Канонический формат сообщений выглядит следующим образом:

```json
{
"deviceid": "<id of the Device created>",
"timestamp": "<timestamp in ISO 8601 format>",
"version" : "1",
"sensors": [
    {
      "id": "<id of the sensor created>",
      "sensordata": [
        {
          "timestamp": "< timestamp in ISO 8601 format >",
          "<sensor measure name (as defined in the Sensor Model)>": "<value>"
        },
        {
          "timestamp": "<timestamp in ISO 8601 format>",
          "<sensor measure name (as defined in the Sensor Model)>": "<value>"
        }
      ]
    }
 ]
}
```
Все имена ключей в JSON телеметрии должны быть строчными. Примерами являются DeviceID и sensordata.

Например, Вот сообщение телеметрии:


```json
{
  "deviceid": "7f9b4b92-ba45-4a1d-a6ae-c6eda3a5bd12",
  "timestamp": "2019-06-22T06:55:02.7279559Z",
  "version" : "1",
  "sensors": [
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 15
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 42
        }
      ]
    },
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 20
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 89
        }
      ]
    }
  ]
}

```

## <a name="troubleshooting-and-error-management"></a>Устранение неполадок и управление ошибками

**Возможность устранения неполадок или поддержка**

Если вы не можете получить данные или телеметрию устройства в указанном экземпляре Фармбеатс, партнеру по устройствам следует предоставить поддержку и механизм для устранения неполадок.

**Хранение данных телеметрии**

Данные телеметрии также должны храниться для предопределенного периода времени, чтобы его можно было использовать при отладке или повторной отправке телеметрии при возникновении ошибки или потери данных.

**Управление ошибками или уведомление об ошибке**

Если ошибка влияет на метаданные устройства или датчика или на поток данных для интеграции данных или телеметрии в системе партнера по устройствам, вы должны получить уведомление. Механизм разрешения любых ошибок также должен быть разработан и реализован.

**Контрольный список подключения**

Производители устройств или партнеры могут использовать следующий контрольный список для обеспечения точности учетных данных, предоставленных клиентом:

   - Проверьте, получен ли маркер доступа с учетными данными, которые были предоставлены.
   - Проверьте, успешно ли вызван вызов API с полученным маркером доступа.
   - Проверьте, установлено ли клиентское подключение EventHub.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о REST API см. в разделе [REST API](references-for-farmbeats.md#rest-api).
