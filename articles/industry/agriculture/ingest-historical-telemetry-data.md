---
title: Прием исторических данных телеметрии
description: Описывает, как получить исторические данные телеметрии
author: uhabiba04
ms.topic: article
ms.date: 11/04/2019
ms.author: v-umha
ms.openlocfilehash: e6bd9b5c09e1af5ec587e1f0e52ab25d21d2293b
ms.sourcegitcommit: cf36df8406d94c7b7b78a3aabc8c0b163226e1bc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2019
ms.locfileid: "73889611"
---
# <a name="ingest-historical-telemetry-data"></a>Прием архивных данных телеметрии

В этой статье описывается прием исторических данных датчика в Azure Фармбеатс.

Получение исторических данных из "Интернет вещей" (IoT) для таких ресурсов, как устройства и датчики, является распространенным сценарием в Фармбеатс. Вы создаете метаданные для устройств и датчиков, а затем принимаете исторические данные в Фармбеатс в каноническом формате.

## <a name="before-you-begin"></a>Перед началом работы

Прежде чем продолжить работу с этой статьей, убедитесь, что вы установили Фармбеатс и собрали исторические данные из Интернета вещей.

## <a name="enable-partner-access"></a>Включить доступ партнеров

Необходимо включить интеграцию партнера с экземпляром Azure Фармбеатс. На этом шаге создается клиент, который будет иметь доступ к Фармбеатс Azure в качестве партнера по устройствам, и предоставляет следующие значения, необходимые для последующих шагов.

- Конечная точка API — это URL-адрес концентратора данных, например https://<datahub>. azurewebsites.net
- Tenant ID
- идентификатор клиента
- Секрет клиента
- Строка подключения EventHub

Чтобы создать эти данные, выполните следующие действия.

>[!NOTE]
> Чтобы выполнить следующие действия, необходимо быть администратором.

1. Скачайте этот [сценарий](https://aka.ms/farmbeatspartnerscript) и извлеките его на локальный диск. В ZIP-файле будут найдены два файла.
2. Войдите в [портал Azure](https://portal.azure.com/) и откройте Cloud Shell (этот параметр доступен на верхней правой панели портала).  

    ![Перебивает ферму проекта](./media/for-tutorials/navigation-bar-1.png)

3. Убедитесь, что для среды задано значение **PowerShell**.

    ![Перебивает ферму проекта](./media/for-tutorials/power-shell-new-1.png)

4. Загрузите два скачанных файла (из шага 1 выше) в Cloud Shell.  

    ![Перебивает ферму проекта](./media/for-tutorials/power-shell-two-1.png)

5. Перейдите в каталог, куда были отправлены файлы.

   >[!NOTE]
   > По умолчанию файл отправляется в корневой каталог/Хоме/усернаме/.
6. Запустите скрипт с помощью команды:  

    ```azurepowershell-interactive
    ./generateCredentials.ps1
    ```

7. Следуйте инструкциям на экране, чтобы выполнить процедуру.

## <a name="create-devicesensor-metadata"></a>Создание метаданных устройства или датчика

 Теперь, когда у вас есть необходимые учетные данные, можно определить устройство и датчики, создав метаданные с помощью API-интерфейсов Фармбеатс.

 Концентратор данных Фармбеатс содержит следующие API, позволяющие создавать метаданные устройства или датчика и управлять ими.   

- /модель устройства **DeviceModel** соответствует метаданным устройства, например изготовителю, тип устройства — шлюз или узел.  
- /**устройство** — устройство соответствует физическому устройству, присутствующему в ферме.  
- /модель датчика **сенсормодел** соответствует метаданным датчика, таким как производитель, тип датчика: аналоговая или цифровая, мера датчика, например температура окружающей среды, или давление.
- Датчик **датчика** /соответствует физическому датчику, записывающему значения. Датчик обычно подключается к устройству с ИДЕНТИФИКАТОРом устройства.  


|        Режим устройства   |  Предложения   |
| ------- | -------             |
|     Тип (узел, шлюз)        |          1 звезда      |
|          Производитель            |         2 звезды     |
|  ProductCode                    |  Код продукта устройства или имя или номер модели. Например, Енвиромонитор # 6800.  |
|            порты;          |     Имя и тип порта (цифровой/аналоговый)
|     имя                 |  Имя, идентифицирующее ресурс. Например, имя модели или название продукта.
      ОПИСАНИЕ     | Укажите понятное описание модели
|    свойства          |    Дополнительные свойства от изготовителя   |
|    **Устройство**             |                      |
|   девицемоделид     |     ИДЕНТИФИКАТОР связанной модели устройства  |
|  хардвареид          | Уникальный идентификатор устройства, например MAC-адрес и т. д.
|  репортингинтервал        |   Интервал составления отчета в секундах
|  Место проведения            |  Широта устройства (от-90 до + 90)/Лонгитуде (от-180 до 180)/Елеватион (в метрах)   
|парентдевицеид       |    Идентификатор родительского устройства, к которому подключено это устройство. Например, узел, подключенный к шлюзу. Узел будет иметь Парентдевицеид в качестве шлюза.  |
|    имя            | Имя, идентифицирующее ресурс. Партнеры устройств должны отправить имя, которое согласуется с именем устройства на стороне партнера. Если имя устройства партнера определено пользователем, то такое же определяемое пользователем имя должно распространяться на Фармбеатс.|
|     ОПИСАНИЕ       |      Введите понятное описание  |
|     свойства    |  Дополнительные свойства от изготовителя
|     **Модель датчика**        |          |
|       Тип (аналоговый, цифровой)          |      Тип датчика (аналоговый или цифровой)       |
|          Производитель            |       Производитель датчика     |
|     ProductCode| Код продукта или имя или номер модели. Например, RS-CO2-N01. |
|       Имя > Сенсормеасурес       | Имя меры датчика. Поддерживается только нижний регистр. Для показателя с различной глубиной укажите глубину. Например, soil_moisture_15cm. Это имя должно быть совместимо с данными телеметрии  |
|          Тип данных Сенсормеасурес >       |Тип данных телеметрии. В настоящее время поддерживается Double|
|    Тип > Сенсормеасурес    |Тип измерения данных телеметрии датчика. Ниже приведены определяемые системой типы: Амбиенттемпературе, CO2, Depth, Електрикалкондуктивити, Леафветнесс, Length, Ликуидлевел, нитрате, O2, PH, фосфате, PointInTime, potassium, давление, RainGauge, RelativeHumidity, Salinity, SoilMoisture, Соилтемпературе, Соларрадиатион, State, Тимедуратион, Уврадиатион, Увиндекс, том, Винддиректион, Виндрун, WindSpeed, Evapotranspiration, номинал. Чтобы добавить дополнительные сведения, обратитесь к API/Екстендедтипе.|
|        Единица > Сенсормеасурес              | Единица данных телеметрии датчика. Ниже перечислены определяемые системой единицы: подразделение, градусы Цельсия, Фаренгейта, Кельвина, Ранкине, Pascal, Меркурий, PSI, миллиметры, сантиметры, метры, дюймы, футы, мили, километры, Милесперхаур, Милесперсеконд, Кмперхаур, Кмперсеконд, Метерсперхаур, Метерсперсеконд, degree, Ваттсперскуареметер, Киловаттсперскуареметер, Милливаттсперскуарецентиметер, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, процент, PartsPerMillion, MicroMol, MicroMolesPerLiter, Сиеменсперскуареметерпермоле, Миллисиеменсперцентиметер, Центибар, ДеЦисиеменсперметер, KiloPascal, VolumetricIonContent, Liter, MilliLiter, seconds, UnixTimestamp, MicroMolPerMeterSquaredPerSecond, InchesPerHour для добавления дополнительных, см./ API ExtendedType.|
|    Сенсормеасурес > aggregationType    |  Значения могут быть "None", "Average", "Maximum", "минимум" или "стандартное отклонение"  |
|          имя            | Имя, идентифицирующее ресурс. Например, имя модели или название продукта.  |
|    ОПИСАНИЕ        | Укажите понятное описание модели  |
|   свойства       |  Дополнительные свойства от изготовителя  |
|    **Датчика**      |          |
| хардвареид          |   Уникальный идентификатор для датчика, установленного производителем |
|  сенсормоделид     |    ИДЕНТИФИКАТОР связанной модели датчика   |
| location          |  Датчик широты (от-90 до + 90)/Лонгитуде (от-180 до 180)/Елеватион (в метрах)|
|   имя > порта        |  Имя и тип порта, к которому подключен датчик на устройстве. Это имя должно совпадать с именем, определенным в модели устройства. |
|    DeviceID  |    ИДЕНТИФИКАТОР устройства, к которому подключен датчик     |
| имя            |   Имя, идентифицирующее ресурс. Например, имя датчика/название продукта и номер модели/код продукта.|
|    ОПИСАНИЕ      | Введите понятное описание |
|    свойства        |Дополнительные свойства от изготовителя |

Дополнительные сведения об объектах см. в разделе [Swagger](https://aka.ms/FarmBeatsDatahubSwagger).

**Запрос API для создания метаданных**

Для выполнения запроса API вы объединяете метод HTTP (POST), URL-адрес службы API, URI ресурса для запроса, отправляете данные для создания или удаления запроса и добавляете один или несколько заголовков HTTP-запроса. URL-адрес службы API — это конечная точка API, т. е. URL-адрес концентратора данных (https://<yourdatahub>. azurewebsites.net).  

**Аутентификация:**

Фармбеатс Data Hub использует проверку подлинности носителя, для которой требуются следующие учетные данные, созданные в приведенном выше разделе.

- идентификатор клиента
- Секрет клиента
- Tenant ID  

Используя указанные выше учетные данные, вызывающий объект может запросить маркер доступа, который необходимо отправить в последующих запросах API в разделе заголовка следующим образом:

```
headers = *{"Authorization": "Bearer " + access_token, …}*
```

**Заголовки HTTP-запросов**:

Ниже приведены наиболее распространенные заголовки запросов, которые необходимо указать при вызове API в Фармбеатс Data Hub:

- Тип содержимого: Application/JSON
- Авторизация: носитель < доступ — токен >
- Принять: приложение/JSON

**Входные полезные данные для создания метаданных**:

**DeviceModel**


```json
{
  "type": "Node",
  "manufacturer": "string",
  "productCode": "string",
  "ports": [
    {
      "name": "string",
      "type": "Analog"
    }
  ],
  "name": "string",
  "description": "string",
  "properties": {
    "additionalProp1": {},
    "additionalProp2": {},
    "additionalProp3": {}
  }
}
```

Устройство

```json
{
  "deviceModelId": "string",
  "hardwareId": "string",
  "farmId": "string",
  "reportingInterval": 0,
  "location": {
    "latitude": 0,
    "longitude": 0,
    "elevation": 0
  },
  "parentDeviceId": "string",
  "name": "string",
  "description": "string",
  "properties": {
    "additionalProp1": {},
    "additionalProp2": {},
    "additionalProp3": {}
  }
}
```

сенсормодел

```json
{
  "type": "Analog",
  "manufacturer": "string",
  "productCode": "string",
  "sensorMeasures": [
    {
      "name": "string",
      "dataType": "Double",
      "type": "string",
      "unit": "string",
      "aggregationType": "None",
      "depth": 0,
      "description": "string"
    }
  ],
  "name": "string",
  "description": "string",
  "properties": {
    "additionalProp1": {},
    "additionalProp2": {},
    "additionalProp3": {}
  }
}

```
Датчик

```json
{
  "hardwareId": "string",
  "sensorModelId": "string",
  "location": {
    "latitude": 0,
    "longitude": 0,
    "elevation": 0
  },
  "depth": 0,
  "port": {
    "name": "string",
    "type": "Analog"
  },
  "deviceId": "string",
  "name": "string",
  "description": "string",
  "properties": {
    "additionalProp1": {},
    "additionalProp2": {},
    "additionalProp3": {}
  }
}

```
Приведенный ниже пример запроса заключается в создании устройства (у него есть входные данные JSON в качестве полезных данных с текстом запроса).  

```azurepowershell-interactive
curl -X POST "https://<datahub>.azurewebsites.net/Device" -H  
"accept: application/json" -H  "Content-Type: application/json" -H
"Authorization: Bearer <Access-Token>" -d "
{  \"deviceModelId\": \"ID123\",  \"hardwareId\": \"MHDN123\",  
\"reportingInterval\": 900,  \"name\": \"Device123\",  
\"description\": \"Test Device 123\",}"*
```

> [!NOTE]
> API-интерфейсы возвращают уникальные идентификаторы для каждого созданного экземпляра. Необходимо хранить идентификаторы для отправки соответствующих сообщений телеметрии.

**Отправить телеметрию**

После создания устройств и датчиков в Фармбеатс можно отправить связанные сообщения телеметрии.  

**Создание клиента телеметрии**

Необходимо отправить данные телеметрии в концентратор событий Azure для обработки. Azure EventHub — это служба, которая обеспечивает прием данных (телеметрии) в режиме реального времени от подключенных устройств и приложений. Чтобы отправить данные телеметрии в Фармбеатс, необходимо создать клиент, отправляющий сообщения в концентратор событий в Фармбеатс. Дополнительные сведения об отправке телеметрии см. в статье [концентраторы событий Azure](https://docs.microsoft.com/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send).

**Отправка сообщения телеметрии в качестве клиента**

После установки соединения в качестве клиента EventHub можно отправить сообщения в EventHub в виде JSON.  
Преобразуйте формат исторических данных датчика в канонический формат, распознаваемый Azure Фармбеатс. Канонический формат сообщений:  



 ```
  {   
      “deviceid”: “<id of the Device created>”,   
      "timestamp": "<timestamp in ISO 8601 format>",     
      "version" : "1",   
      "sensors":
      [     
      {        
          "id": "<id of the sensor created>”       
          "sensordata": [         
          {            
              "timestamp": "< timestamp in ISO 8601 format >",           
              "<sensor measure name (as defined in the Sensor Model)>": value          
    },          
    {            
    "timestamp": "<timestamp in ISO 8601 format>",           
     "<sensor measure name (as defined in the Sensor Model)>": value          
    }        
    ]      
    }  
    }
```


После добавления соответствующих устройств и датчиков получите DeviceID и сенсорид в сообщении телеметрии, как описано в предыдущем разделе.

Пример сообщения телеметрии:


 ```json
{
  "deviceid": "7f9b4b92-ba45-4a1d-a6ae-c6eda3a5bd12",
  "timestamp": "2019-06-22T06:55:02.7279559Z",
  "version": "1",
  "sensors": [
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 15
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 42
        }
      ]
    },
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 20
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 89
        }
      ]
    }
  ]
}
```


## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об интеграции на основе API-интерфейса для других интерфейсов см. в разделе [REST API](references-for-farmbeats.md#rest-api).
