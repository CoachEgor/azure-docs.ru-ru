---
title: Интеграция с партнерами, предоставляющими данные о погоде
description: В этой статье описывается, как поставщик данных Weather может интегрироваться с Фармбеатс.
author: sunasing
ms.topic: article
ms.date: 07/09/2020
ms.author: sunasing
ms.openlocfilehash: 661147769d8ae845066e912a84118c9fd3f93486
ms.sourcegitcommit: 4cb89d880be26a2a4531fedcc59317471fe729cd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92674918"
---
# <a name="weather-partner-integration"></a>Интеграция с партнерами, предоставляющими данные о погоде

В этой статье содержатся сведения о компоненте DOCKER **соединителя** Azure фармбеатс, который поставщики данных Weather могут разрабатывать для интеграции с фармбеатс, используя API-интерфейсы и отправляйте данные о погоде в фармбеатс. После того как данные доступны в Фармбеатс, их можно использовать для слияния данных, а также для создания моделей машинного обучения и искусственного интеллекта.

 > [!NOTE]
 > В этой документации мы будем использовать эталонную реализацию, созданную с помощью NOAA, из открытых наборов данных Azure и доступные по адресу [https://github.com/azurefarmbeats/noaa_docker](https://github.com/azurefarmbeats/noaa_docker) .
 > Соответствующий образ DOCKER доступен по адресу [https://hub.docker.com/r/azurefarmbeats/farmbeats-noaa](https://hub.docker.com/r/azurefarmbeats/farmbeats-noaa)

Партнеру по погоду потребуется предоставить образ или программу DOCKER (с указанными ниже спецификациями) и разместить образ DOCKER в реестре контейнеров, доступном клиентам. Партнеру по погоду потребуется предоставить следующие сведения своим клиентам:

- URL-адрес образа DOCKER
- Тег образа DOCKER
- Ключи и учетные данные для доступа к образу DOCKER
- Ключи API и учетные данные для конкретного клиента для доступа к данным из системы партнера по погоде
- Сведения о номере SKU виртуальной машины (партнеры могут предоставить это в том случае, если у DOCKER есть особые требования к виртуальной машине, в противном случае клиенты смогут выбрать поддерживаемые номера SKU виртуальных машин в Azure).

Используя приведенные выше сведения DOCKER, клиент регистрирует партнера по погоде в своем экземпляре Фармбеатс. Дополнительные сведения о том, как клиенты могут использовать DOCKER для получения данных о погоде в Фармбеатс, см. в статье Руководство по [получению данных о погоде](./get-weather-data-from-weather-partner.md) .

## <a name="connector-docker-development"></a>Разработка DOCKER Connector

**Интеграция на основе REST API**

API-интерфейсы Фармбеатс содержат техническую документацию по Swagger. Сведения обо всех API-интерфейсах и соответствующих запросах или ответах см. в разделе [Фармбеатс Swagger](https://aka.ms/farmbeatsswagger). 

Если вы установили Фармбеатс, вы можете получить доступ к Фармбеатс Swagger по адресу `https://yourfarmbeatswebsitename-api.azurewebsites.net/swagger`

Обратите внимание, что "-API" добавляется в имя веб-сайта Фармбеатс.
Конечная точка API будет: `https://yourfarmbeatswebsitename-api.azurewebsites.net`

### <a name="datahub-lib"></a>Датахуб lib

Фармбеатс предоставит программу LIB, которая может использоваться партнером по погоде. В настоящее время библиотека доступна как часть эталонной реализации [здесь](https://github.com/azurefarmbeats/noaa_docker/tree/master/datahub_lib). В будущем он будет доступен в виде пакета SDK для нескольких языков.

### <a name="authentication"></a>Аутентификация

**Проверка подлинности с помощью API Фармбеатс**

Фармбеатс использует проверку подлинности носителя, и интерфейсы API можно получить, предоставив маркер доступа в разделе заголовка запроса, как показано ниже:

```
headers = *{"Authorization": "Bearer " + access_token, …}*
```

Маркер доступа можно запросить из функции Azure, которая работает на экземпляре клиента Фармбеатс. URL-адрес функции Azure будет предоставлен в программу DOCKER в качестве аргумента, и маркер доступа можно получить, выполнив запрос GET по URL-адресу. Ответ от URL-адреса будет содержать маркер доступа. Датахуб lib предоставляет вспомогательные функции, позволяющие партнерам получить маркер доступа. Дополнительные сведения см. [здесь](https://github.com/azurefarmbeats/noaa_docker/blob/master/datahub_lib/auth/partner_auth_helper.py).

Маркер доступа действителен только в течение нескольких часов и должен быть повторно запрошен по истечении срока действия.

**Проверка подлинности с помощью API на стороне партнера**

Чтобы клиенты могли проходить проверку подлинности с помощью API на стороне партнера во время выполнения DOCKER, клиенты должны предоставить учетные данные во время регистрации партнера следующим образом:

```json
{
 "partnerCredentials": {
   "key1": "value1",
   "key2": "value2"
   }
}
```
Служба API сериализует этот словарь и сохраняет его в [KeyVault](../../key-vault/general/basic-concepts.md).

[Фабрика данных Azure](../../data-factory/introduction.md) используется для управления заданиями погоды и позволяет прокрутить ресурсы для выполнения кода docker. Он также предоставляет механизм безопасной отправки данных на виртуальную машину, в которой выполняется задание DOCKER. Учетные данные API, которые безопасно хранятся в KeyVault, считываются как защищенные строки из KeyVault и становятся доступными в качестве расширенных свойств в рабочем каталоге контейнера DOCKER, как activity.jsв (путь к файлу — "/МНТ/working_dir/activity.json"). код DOCKER может считывать учетные данные из этого файла во время выполнения, чтобы получить доступ к API на стороне партнера от имени клиента. Учетные данные будут доступны в файле следующим образом:

```json
{ 
   "typeProperties" : {
      "extendedProperties" : { 
         "partnerCredentials": "" } 
   } 
}
```
Обратите внимание, что "Партнеркредентиалс" будет доступен по точному пути, предоставленному клиентом во время регистрации партнера.

Фармбеатс lib предоставляет вспомогательные функции, позволяющие партнерам считывать учетные данные из свойств действия. Дополнительные сведения см. [здесь](https://github.com/azurefarmbeats/noaa_docker/blob/master/datahub_lib/auth/partner_adf_helper.py).

Время существования файла задается только во время выполнения кода docker и будет удалено после завершения выполнения DOCKER.

Дополнительные сведения о работе конвейеров и действий ADF см. в разделе [https://docs.microsoft.com/azure/data-factory/copy-activity-schema-and-type-mapping](../../data-factory/copy-activity-schema-and-type-mapping.md) .

**Заголовки запросов HTTP**

Ниже приведены наиболее распространенные заголовки запросов, которые необходимо указать при выполнении вызова API в Фармбеатс.

**Верхняя часть** | **Описание и пример**
--- | ---
Content-Type | Формат запроса (Content-Type: application/<format>). Для API-интерфейсов FarmBeats Datahub используется формат JSON. Content-Type: application/json
Авторизация | Указывает маркер доступа, необходимый для выполнения вызова API. Авторизация: Bearer <маркер доступа>
Принять | Формат ответа. Для API-интерфейсов FarmBeats Datahub используется формат JSON. Accept: application/json

## <a name="data-format"></a>Формат данных

JSON является стандартным не зависящим от языка форматом данных, предоставляющим простое текстовое представление произвольных структур данных. Дополнительные сведения см. на сайте [json.org](http://json.org).

## <a name="docker-specifications"></a>Спецификации DOCKER

Программа DOCKER должна иметь два компонента: **Начальная** Загрузка и **задания** . Может существовать более одного задания.

### <a name="bootstrap"></a>Бутстрэп

Этот компонент должен выполняться, когда клиент инициирует регистрацию DOCKER в Фармбеатс. Аргументы (arg1, arg2), которые будут переданы в эту программу:

- Конечная точка API Фармбеатс: конечная точка API Фармбеатс для запросов API: это конечная точка для вызовов API к развертыванию Фармбеатс.
- URL-адрес функции Azure. это собственная личная конечная точка, которая предоставит вам маркер доступа для интерфейсов API Фармбеатс. При простом вызове GET по этому URL-адресу в ответе будет получен маркер доступа.

Ответственность за начальную загрузку заключается в создании метаданных реквизитов, чтобы пользователи могли выполнять задания для получения данных о погоде. Ознакомьтесь с эталонной реализацией [здесь](https://github.com/azurefarmbeats/noaa_docker). Вы можете обновить bootstrap_manifest.jsв файле в соответствии с вашими потребностями, и программа начальной загрузки создаст необходимые метаданные.

В рамках этого процесса создаются следующие метаданные. 

 > [!NOTE]
 > **Обратите внимание** , что при обновлении bootstrap_manifest.jsв файле, как упоминалось в [эталонной реализации](https://github.com/azurefarmbeats/noaa_docker), не нужно создавать следующие метаданные, так как начальная загрузка будет создаваться на основе файла манифеста.

- /**Веасердатамодел** : веасердатамодел — это модель для представления данных о погоде, которая соответствует различным наборам данных, предоставленным источником. Например, Даилифорекастсимплемодел может предоставлять среднюю информацию о температуре, влажности и осадков раз в день, в то время как Даилифорекастадванцедмодел может предоставить гораздо больше информации по почасовой детализации. Можно создать любое количество Веасердатамоделс.
- /**JobType** : фармбеатс имеет расширенную систему управления заданиями. Как поставщик данных Weather, вы будете иметь различные наборы данных и интерфейсы API (например, Жетдаилифорекастс). их можно включить в Фармбеатс как JobType. После создания JobType клиент может активировать задания этого типа, чтобы получить данные о погоде для их расположения или фермы (см. раздел API-интерфейсы JobType и заданий в [Фармбеатс Swagger](https://aka.ms/farmbeatsswagger)).

### <a name="jobs"></a>Задания

Этот компонент будет вызываться каждый раз, когда пользователь Фармбеатс запустит задание/Жобтипе, созданное в рамках процесса начальной загрузки. Команда DOCKER Run для задания определяется как часть созданного **/жобтипе** .
- Ответственность за задание — получить данные из источника и отправить их в Фармбеатс. Параметры, необходимые для получения данных, должны быть определены как часть/Жобтипе в процессе начальной загрузки.
- В рамках задания необходимо создать **/веасердаталокатион** на основе/веасердатамодел, созданного в рамках процесса начальной загрузки. **/Веасердаталокатион** соответствует расположению (lat/Long), которое предоставляется пользователем в качестве параметра для задания.

### <a name="details-of-the-objects"></a>Сведения об объектах

  веасердатамодел | Описание |
  --- | ---
  Имя  | Имя модели данных Weather |
  Описание  | Информативное описание модели. |
  Свойства  | Дополнительные свойства, определяемые поставщиком данных. |
  Имя > Веасермеасурес  | Имя меры погоды. Например humidity_max |
  Тип данных Веасермеасурес >  | значение типа Double или enum. Если ENUM, Меасуринумдефинитион является обязательным |
  Веасермеасурес > Меасуринумдефинитион  | Требуется только в том случае, если DataType имеет тип enum. Например, {"Нораин": 0, "снег": 1, "Дриззле": 2, "дождя": 3} |
  Тип > Веасермеасурес  | тип данных телеметрии погоды. Например, "RelativeHumidity". Ниже перечислены типы, определяемые системой: Амбиенттемпературе, Леафветнесс, Length, Електрикалкондуктивити, нитрате, O2, PH, фосфате, PointInTime, potassium, давление, RainGauge, RelativeHumidity, Salinity, SoilMoisture, SoilTemperature, SolarRadiation, State, TimeDuration, UVRadiation, UVIndex, том, WindDirection, WindRun, WindSpeed, Evapotranspiration, номинал. Чтобы добавить дополнительные сведения, обратитесь к API/Екстендедтипе или в [разделе Добавление типов и единиц](weather-partner-integration-in-azure-farmbeats.md#add-extendedtype) ниже.
  Единица > Веасермеасурес | Единица данных телеметрии погоды. Ниже перечислены единицы, определяемые системой. NoUnit, Celsius, Fahrenheit, Kelvin, Rankine, Pascal, Mercury, PSI, MilliMeter, CentiMeter, Meter, Inch, Feet, Mile, KiloMeter, MilesPerHour, MilesPerSecond, KMPerHour, KMPerSecond, MetersPerHour, MetersPerSecond, Degree, WattsPerSquareMeter, KiloWattsPerSquareMeter, MilliWattsPerSquareCentiMeter, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, Percentage, PartsPerMillion, MicroMol, MicroMolesPerLiter, SiemensPerSquareMeterPerMole, MilliSiemensPerCentiMeter, Centibar, DeciSiemensPerMeter, KiloPascal, VolumetricIonContent, Liter, MilliLiter, Seconds, UnixTimestamp, MicroMolPerMeterSquaredPerSecond и InchesPerHour. Чтобы добавить дополнительные сведения, обратитесь к API/Екстендедтипе или в [разделе Добавление типов и модулей](weather-partner-integration-in-azure-farmbeats.md#add-extendedtype) ниже.
  Веасермеасурес > AggregationType  | Ни одно из значений: None, СРЗНАЧ, максимум, минимум, стандартное отклонение, сумма, итог
  Глубина > Веасермеасурес  | Глубина области действия датчика в сантиметрах. Например, измерение влажности на глубине 10 см.
  Описание > Веасермеасурес  | Информативное описание измерения. |
  **JobType** | **Описание** |
  Имя  | Имя задания, например Get_Daily_Forecast; задание, которое клиент будет запускать для получения данных о погоде|
  имя > Пипелинедетаилс > параметров  | имя параметра |
  Тип > параметров > Пипелинедетаилс | любой из строк, int, float, bool, Array |
  Параметры > Пипелинедетаилс > обязательные | логическая значение true, если обязательный параметр имеет значение false; значение по умолчанию — true |
  Параметры > Пипелинедетаилс > defaultValue | Значение параметра по умолчанию |
  > описание параметров > Пипелинедетаилс | Описание параметра |
  Свойства  | Дополнительные свойства от производителя.
  Свойства > **програмрункомманд** | Команда DOCKER Run — эта команда выполняется, когда клиент запускает задание weather. |
  **веасердаталокатион** | **Описание** |
  веасердатамоделид  | Идентификатор соответствующего Веасердатамодел, который был создан во время начальной загрузки|
  location  | представляет широту, долготу и повышение прав |
  Имя | Имя объекта |
  Description | Описание |
  фармид | **необязательно** ИДЕНТИФИКАТОР фермы, предоставляемой клиентом как часть параметра задания. |
  Свойства  | Дополнительные свойства от производителя.

 Сведения обо всех объектах и их свойствах см. в [Swagger](https://aka.ms/FarmBeatsSwagger).

 > [!NOTE]
 > API-интерфейсы возвращают уникальные идентификаторы для каждого созданного экземпляра. Компонент Translator должен хранить этот идентификатор для управления устройствами и синхронизации метаданных.

**Синхронизация метаданных**

DOCKER соединителя должен иметь возможность отправки обновлений в метаданные. Примеры сценариев обновления — Добавление новых параметров погоды в набор данных поставщика погоды, добавление функций (например, Добавление 30-дневного прогноза)

> [!NOTE]
> Удаление не поддерживается для метаданных, например. модель данных о погоде.
>
> Чтобы обновить метаданные, необходимо вызвать/жет/{ИД} в модели данных Weather, обновить измененные свойства, а затем выполнить/пут/{ИД}, чтобы все свойства, заданные пользователем, не были потеряны.

## <a name="weather-data-telemetry-specifications"></a>Спецификации данных о погоде (телеметрии)

Данные о погоде сопоставлены каноническому сообщению, отправленному в концентратор событий Azure для обработки. Azure EventHub — это служба, которая обеспечивает прием данных (телеметрии) в режиме реального времени от подключенных устройств и приложений. Чтобы отправить данные о погоде в Фармбеатс, необходимо создать клиент, отправляющий сообщения в концентратор событий в Фармбеатс. Дополнительные сведения об отправке телеметрии см. в статье [Отправка телеметрии в концентратор событий](../../event-hubs/event-hubs-dotnet-standard-getstarted-send.md) .

Ниже приведен пример кода Python, который отправляет телеметрию в качестве клиента в указанный концентратор событий.

```python
import azure
from azure.eventhub import EventHubClient, Sender, EventData, Receiver, Offset
EVENTHUBCONNECTIONSTRING = "<EventHub Connection String provided by customer>"
EVENTHUBNAME = "<EventHub Name provided by customer>"

write_client = EventHubClient.from_connection_string(EVENTHUBCONNECTIONSTRING, eventhub=EVENTHUBNAME, debug=False)
sender = write_client.add_sender(partition="0")
write_client.run()
for i in range(5):
    telemetry = "<Canonical Telemetry message>"
    print("Sending telemetry: " + telemetry)
    sender.send(EventData(telemetry))
write_client.stop()

```

Каноническое сообщение имеет следующий формат:

```json
{
   "weatherstations": [
   {
   "id": "id of the WeatherDataLocation",
   "weatherdata": [
   {
     "timestamp": "timestamp of the data. For historical, this is the time for which the observations are sent. For forecast this is the time for which data is forecasted. Format is ISO 8601. Default time-zone is UTC",
     "predictiontimestamp": "timestamp on which the forecast data is predicted i.e time of prediction. Required only for forecast data. Format is ISO 8601. Default timezone is UTC ",
     "weathermeasurename1": <value>,
     "weathermeasurename2": <value>
     }
     ]
    }
   ]
}
```

Например, вот как выглядит сообщение телеметрии:

```json
{
   "weatherstations": [
   {
     "id": "5e4b34e7-bf9e-4f39-xxxx-f3c06d0366ea",
     "weatherdata": [
     {
      "timestamp": "2019-07-10T00:00:00Z",
      "predictiontimestamp": "2019-07-05T00:00:00Z",
      "PrecipitationTotalLiquidEquivalent": 0,
      "AvgPressure": 0,
      "AvgRelativeHumidity": 72
     }
    ] 
  }
 ]
}

```

## <a name="troubleshooting-and-error-management"></a>Устранение неполадок и управление обработкой ошибок

**Ведение журнала ошибок**

Так как в существующей платформе заданий будет выполняться партнерское задание, ошибки будут регистрироваться так же, как и ошибки для других уже существующих заданий в Фармбеатс (например, Жетфармдата, Сенсорплацемент и т. д.). Действие ADF, выполняемое в конвейере ADF, регистрирует как STDERR, так и STDOUT. Оба файла доступны в учетной записи хранения "датахублогс-XXX" в группе ресурсов Фармбеатс.

Датахуб lib предоставляет вспомогательные функции для включения ведения журнала в рамках общих журналов Датахуб. Дополнительные сведения см. [здесь](https://github.com/azurefarmbeats/noaa_docker/blob/master/datahub_lib/framework/logger.py).

**Механизм устранения неполадок или поддержка**

Если клиент не может получать данные о погоде в указанном экземпляре Фармбеатс, то партнер по погоду должен предоставить поддержку и механизм для устранения неполадок.

## <a name="add-extendedtype"></a>Добавить ExtendedType

FarmBeats поддерживает добавление новых типов и единиц измерений датчика. Обратите внимание, что партнер по погоду может добавить новые единицы или типы, обновив bootstrap_manifest.jsв файле в эталонной реализации [здесь](https://github.com/azurefarmbeats/noaa_docker) .

Чтобы добавить новый тип Веасермеасуре, например "ПреЦипитатиондепс", выполните следующие действия.

1. Выполните запрос GET к/Екстендедтипе с помощью фильтра запроса-key = Веасермеасуретипе.
2. Запишите идентификатор возвращенного объекта.
3. Добавьте новый тип в список возвращаемого объекта и выполните запрос на размещение в/Екстендедтипе{ИД} со следующим новым списком. Входные полезные данные должны быть такими же, как и полученный выше ответ, и Новая единица, добавленная в конце списка значений.

Дополнительные сведения об API /ExtendedType см. в [Swagger](https://aka.ms/FarmBeatsSwagger).

## <a name="next-steps"></a>Дальнейшие действия

Теперь у вас есть соединитель DOCKER, который интегрируется с Фармбеатс. Далее вы можете узнать, как получать данные о погоде с помощью DOCKER в Фармбеатс. См. статью [Получение данных о погоде](get-weather-data-from-weather-partner.md).