---
title: Интеграция с партнерскими датчиками
description: В этой статье описывается интеграция партнера датчика.
author: uhabiba04
ms.topic: article
ms.date: 11/04/2019
ms.author: v-umha
ms.openlocfilehash: 48a2ed5e4774ac07b4b8fa72a5ee0be86811cfb2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79298739"
---
# <a name="sensor-partner-integration"></a>Интеграция с партнерскими датчиками

В этой статье содержится информация о компоненте Azure FarmBeats **Translator,** который обеспечивает интеграцию партнеров датчиков.

Используя этот компонент, партнеры могут интегрироваться с FarmBeats с помощью APИ FarmBeats Datahub и отправлять данные устройств и телеметрию на FarmBeats Datahub. После того, как данные доступны в FarmBeats, они визуализуются с помощью ускорителя FarmBeats и могут быть использованы для синтеза данных и для построения машинного обучения/моделей искусственного интеллекта.

## <a name="before-you-start"></a>Перед началом работы

Для разработки компонента Translator вам потребуются следующие учетные данные, которые позволят получить доступ к AA-иносов FarmBeats.

- Конечная точка API
- Tenant ID
- Идентификатор клиента
- Секрет клиента
- Строка подключения EventHub

Смотрите в этом разделе для получения вышеуказанных учетных данных: [Включить интеграцию устройств](get-sensor-data-from-sensor-partner.md#enable-device-integration-with-farmbeats)

## <a name="translator-development"></a>Разработка переводчиков

**Интеграция на основе REST API**

Возможности интеграции сенсорных данных FarmBeats подвергаются воздействию через REST API. Возможности включают определение метаданных, подготовку устройств и датчиков, а также управление устройствами и датчиками.

**Телеметрия приема**

Данные телеметрии отображаются в каноническое сообщение, опубликованное на концентрах событий Azure для обработки. Azure Event Hubs — это служба, которая позволяет в режиме реального времени получать данные (телеметрию) с подключенных устройств и приложений.

**Разработка API**

AIS содержат техническую документацию Swagger. Для получения дополнительной информации об AA и их соответствующих запросах или ответах [см.](https://aka.ms/FarmBeatsDatahubSwagger)

**Проверка подлинности**

FarmBeats использует активную проверку подлинности Microsoft Azure.Служба приложений Azure предоставляет встроенную поддержку аутентификации и авторизации.

Для получения дополнительной информации смотрите [active Directory Azure](https://docs.microsoft.com/azure/app-service/overview-authentication-authorization).

FarmBeats Datahub использует проверку подлинности носителя, которая требует следующих учетных данных:
   - Идентификатор клиента
   - Секрет клиента
   - Tenant ID

Используя эти учетные данные, абонент может запросить токен доступа. Токен должен быть отправлен в последующих запросах API в разделе заголовок следующим образом:

```
headers = {"Authorization": "Bearer " + access_token, …} 
```

Следующий пример кода Python дает токен доступа, который может быть использован для последующих вызовов API в FarmBeats.

```python
import azure 

from azure.common.credentials import ServicePrincipalCredentials 
import adal 
#FarmBeats API Endpoint 
ENDPOINT = "https://<yourdatahub>.azurewebsites.net" [Azure website](https://<yourdatahub>.azurewebsites.net)
CLIENT_ID = "<Your Client ID>"   
CLIENT_SECRET = "<Your Client Secret>"   
TENANT_ID = "<Your Tenant ID>" 
AUTHORITY_HOST = 'https://login.microsoftonline.com' 
AUTHORITY = AUTHORITY_HOST + '/' + TENANT_ID 
#Authenticating with the credentials 
context = adal.AuthenticationContext(AUTHORITY) 
token_response = context.acquire_token_with_client_credentials(ENDPOINT, CLIENT_ID, CLIENT_SECRET) 
#Should get an access token here 
access_token = token_response.get('accessToken') 
```


**Заголовки запросов HTTP**

Вот наиболее распространенные заголовки запросов, которые должны быть указаны при вызове API в FarmBeats Datahub.


**Заголовка** | **Описание и пример**
--- | ---
Content-Type | Формат запроса (Content-Type:<format>application/ ). Для ApIs FarmBeats Datahub формат JSON. Content-Type: application/json
Авторизация | Опознавательный маркер доступа, необходимый для вызова API. Авторизация:> <доступа
Принять | Формат ответа. Для ApIs FarmBeats Datahub формат JSON. Принять: приложение/json

**Запросы API**

Чтобы сделать запрос REST API, вы объедините метод HTTP (GET, POST или PUT), URL-адрес службы API, Единый идентификатор ресурсов (URI) с ресурсом для запроса, отправки данных, обновления или удаления и одного или нескольких заголовков запросов HTTP. URL-адрес службы API — это конечная точка API, которая предоставляется. Вот пример: https://\<yourdatahub-сайт-имя>.azurewebsites.net

Дополнительно можно включить параметры запроса в вызовы GET для фильтрации, ограничения размера и сортировки данных в ответах.

Следующий запрос образца, чтобы получить список устройств.

```bash
curl -X GET "https://microsoft-farmbeats.azurewebsites.net/Device" -H "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>"
```
Большинство вызовов GET, POST и PUT требуют органа запроса JSON.

Следующий запрос образца заключается в создании устройства. (Этот образец имеет входный JSON с телом запроса.)

```bash
curl -X POST "https://microsoft-farmbeats.azurewebsites.net/Device" -H  "accept: application/json" -H  "Content-Type: application/json" -H "Authorization: Bearer <Access-Token>" -d "{  \"deviceModelId\": \"ID123\",  \"hardwareId\": \"MHDN123\",  \"reportingInterval\": 900,  \"name\": \"Device123\",  \"description\": \"Test Device 123\",}"
```

## <a name="data-format"></a>Формат данных

JSON является общим форматом данных, независимым от языка, который обеспечивает простое текстовое представление произвольных структур данных. Для получения дополнительной информации см [json.org.](http://json.org)

## <a name="metadata-specifications"></a>Спецификации метаданных

FarmBeats Datahub имеет следующие AI, которые позволяют партнерам по устройству создавать и управлять метаданными устройства или датчика.

- /**DeviceModel**: DeviceModel соответствует метаданным устройства, таким как производитель и тип устройства, которое является либо шлюзом, либо узла.
- /**Устройство**: Устройство соответствует физическому устройству, присутствуютму на ферме.
- /**SensorModel**: SensorModel соответствует метаданным датчика, таким как производитель, тип датчика, который является либо аналоговым, либо цифровым, и измерению датчика, таким как температура окружающей среды и давление.
- /**Датчик**: Датчик соответствует физическому датчику, который записывает значения. Датчик обычно подключается к устройству с идентификатором устройства.

  **DeviceModel** |  |
  --- | ---
  Тип (узла, шлюза)  | Тип устройства - Узла или шлюза |
  Производитель  | Наименование производителя |
  Код продукта  | Код продукта устройства или название модели или номер. Например, EnviroMonitor-6800. |
  порты;  | Название порта и тип, который является цифровым или аналоговым.  |
  name  | Имя для идентификации ресурса. Например, название модели или название продукта. |
  Описание  | Предоставьте осмысленное описание модели. |
  Свойства  | Дополнительные свойства от производителя. |
  **Устройство** |  |
  DeviceModelId  |Идентификатор модели связанного устройства. |
  ОборудованиеId   |Уникальный идентификатор для устройства, например MAC-адрес.  |
  ReportingInterval |Интервал отчетности в секундах. |
  Расположение    |Широта устройства (от 90 до 90 евро), долгота (-180 до 180) и высота (в метрах). |
  ParentDeviceId | Идентификатор родительского устройства, к которому подключено это устройство. Например, если узла соединено с шлюзом, узла имеет сятвик DeviceID в качестве шлюза. |
  name  | Имя для идентификации ресурса. Партнеры устройства должны отправить имя, которое соответствует названию устройства на стороне партнера устройства. Если имя устройства определяется пользователем на стороне партнера устройства, то одно и то же имя, определенное пользователем, следует распространять на FarmBeats.  |
  Описание  | Предоставьте содержательное описание.  |
  Свойства  |Дополнительные свойства от производителя.  |
  **SensorModel** |  |
  Тип (аналоговый, цифровой)  |Упоминание аналогового или цифрового датчика.|
  Производитель  | Наименование производителя. |
  Код продукта  | Код продукта или название модели или номер. Например, RS-CO2-N01.  |
  SensorMeasures > имя  | Название датчика измерения. Поддерживается только нижний регистр. Для измерений из разных глубин укажите глубину. Например, soil_moisture_15cm. Это имя должно соответствовать данным телеметрии. |
  SensorMeasures > DataType  | Тип данных телеметрии. В настоящее время двойника поддерживается. |
  ДатчикМеры > типа  | Измерение типа данных телеметрии датчика. Ниже приведены системно-определяемые типы: AmbientTemperature, CO2, Глубина, Электрическая проводность, LeafWetness, Длина, LiquidLevel, Нитрат, O2, PH, Фосфат, PointInTime, Калий, Давление, RainGauge, Относительная влажность, Полиноity, SoilMoisture, SoilTemperature, SolarRadiation, Государство, TimeDuration, UVRadiation, UVIndex, Объем, WindDirection, WindRun, WindSpeed, Evapotranspiration, PAR. Чтобы добавить больше, обратитесь к /ExtendedType API.
  SensorMeasures > Unit | Единица данных сенсорной телеметрии. Ниже приведены системно-определенные единицы: NoUnit, Celsius, Фаренгейт, Кельвин, Ранкин, Паскаль, Меркурий, PSI, MilliMeter, CentiMeter, Метр, Инч, Ноги, Миля, Километр, MilesPerHour, MilesPerSecond, KMPerHour, KMPerSecond, MetersPerHour, MetersPerSecond, Степень, WattsPerSquareMeter, KiloWattsPerSquareMeter, MilliWattsPerSquareCentiMeter, MilliJoulesPerSquareCentiMeter, VolumetricWaterContent, Процент, PartsPerMillion, MicroMol, MicroMolesPerLiter, SiemensPerSquareMeterPerMole, MilliSiemensPerCentiMeter, Centibar, DeciSiemensPerMeter, KiloPascal, VolumetricIonContent, Liter, MilliLiter, Seconds, UnixTimestamp, MicroMolPerMeterSquaredPerSecond и InchesPerHour. Чтобы добавить больше, обратитесь к /ExtendedType API.
  SensorMeasures > агрегацииТип  | Либо нет, средний, максимум, минимум, или StandardDeviation.
  Датчикмеры > глубины  | Глубина датчика в сантиметрах. Например, измерение влажности 10 см под землей.
  Датчикмеры > Описание  | Предоставьте содержательное описание измерения.
  name  | Имя для идентификации ресурса. Например, название модели или название продукта.
  Описание  | Предоставьте осмысленное описание модели.
  Свойства  | Дополнительные свойства от производителя.
  **Датчик**  |  |
  ОборудованиеId  | Уникальный идентификатор для датчика, установленного производителем.
  SensorModelId  | Идентификатор модели связанного датчика.
  Расположение  | Датчик широты (от 90 до 90 евро), долгота (-180 до 180), и высота (в метрах).
  Название порт >  |Наименование и тип порта, к которому подключен датчик на устройстве. Это должно быть то же имя, что и в модели устройства.
  deviceId  | Идентификатор устройства, к которому подключен датчик.
  name  | Имя для идентификации ресурса. Например, имя датчика, название продукта, номер модели или код продукта.
  Описание  | Предоставьте содержательное описание.
  Свойства  | Дополнительные свойства от производителя.

 Для получения информации о каждом из объектов и их свойства, [см.](https://aka.ms/FarmBeatsDatahubSwagger)

 > [!NOTE]
 > AA возвращают уникальные иди для каждого созданного экземпляра. Этот идентификатор должен быть сохранен переводчиком для управления устройствами и синхронизации метаданных.


**Метаданные синхронизации**

Переводчик должен отправлять обновления на метаданные. Например, сценарии обновления — это изменение имени устройства или датчика и изменение местоположения устройства или датчика.

Переводчик должен иметь возможность добавлять новые устройства или датчики, которые были установлены на пользовательской должности ссылок FarmBeats. Аналогичным образом, если устройство или датчик был обновлен пользователем, то же самое должно быть обновлено в FarmBeats для соответствующего устройства или датчика. Типичными сценариями, требующими обновления устройства или датчика, являются изменение местоположения устройства или добавление датчиков в узла.


> [!NOTE]
> Удаление не поддерживается для метаданных устройства или датчика.
>
> Для обновления метаданных необходимо вызвать /Get/'id» на устройстве или датчике, обновить измененные свойства, а затем сделать /Put/id, чтобы все свойства, установленные пользователем, не были потеряны.

### <a name="add-new-types-and-units"></a>Добавление новых типов и единиц

FarmBeats поддерживает добавление новых типов и единиц измерения датчиков. Для получения дополнительной информации о /ExtendedType API, [см.](https://aka.ms/FarmBeatsDatahubSwagger)

## <a name="telemetry-specifications"></a>Тектотрия спецификации

Данные телеметрии отображаются в каноническое сообщение, опубликованное на концентрах событий Azure для обработки. Azure Event Hubs — это служба, которая позволяет в режиме реального времени получать данные (телеметрию) с подключенных устройств и приложений.

## <a name="send-telemetry-data-to-farmbeats"></a>Отправка телеметрических данных в FarmBeats

Чтобы отправить данные телеметрии в FarmBeats, создайте клиента, который отправляет сообщения в концентратор событий в FarmBeats. Для получения дополнительной информации о телеметрических данных [см.](https://docs.microsoft.com/azure/event-hubs/event-hubs-dotnet-standard-getstarted-send)

Вот пример кода Python, который отправляет телеметрию в качестве клиента в определенный концентратор событий.

```python
import azure
from azure.eventhub import EventHubClient, Sender, EventData, Receiver, Offset
EVENTHUBCONNECTIONSTRING = "<EventHub Connection String provided by customer>"
EVENTHUBNAME = "<EventHub Name provided by customer>"

write_client = EventHubClient.from_connection_string(EVENTHUBCONNECTIONSTRING, eventhub=EVENTHUBNAME, debug=False)
sender = write_client.add_sender(partition="0")
write_client.run()
for i in range(5):
    telemetry = "<Canonical Telemetry message>"
    print("Sending telemetry: " + telemetry)
    sender.send(EventData(telemetry))
write_client.stop()

```

Формат канонического сообщения:

```json
{
"deviceid": "<id of the Device created>",
"timestamp": "<timestamp in ISO 8601 format>",
"version" : "1",
"sensors": [
    {
      "id": "<id of the sensor created>",
      "sensordata": [
        {
          "timestamp": "< timestamp in ISO 8601 format >",
          "<sensor measure name (as defined in the Sensor Model)>": "<value>"
        },
        {
          "timestamp": "<timestamp in ISO 8601 format>",
          "<sensor measure name (as defined in the Sensor Model)>": "<value>"
        }
      ]
    }
 ]
}
```
Все ключевые имена в телеметрии JSON должны быть в нижнем регистре. Примерами являются устройства и сенсорные данные.

Например, вот телеметрическое сообщение:


```json
{
  "deviceid": "7f9b4b92-ba45-4a1d-a6ae-c6eda3a5bd12",
  "timestamp": "2019-06-22T06:55:02.7279559Z",
  "version" : "1",
  "sensors": [
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 15
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 42
        }
      ]
    },
    {
      "id": "d8e7beb4-72de-4eed-9e00-45e09043a0b3",
      "sensordata": [
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_max": 20
        },
        {
          "timestamp": "2019-06-22T06:55:02.7279559Z",
          "hum_min": 89
        }
      ]
    }
  ]
}

```

> [!NOTE]
> Следующие разделы связаны с другими изменениями (например. UI, управление ошибками и т.д.) о том, на что может ссылаться партнер датчика при разработке компонента Translator.


## <a name="link-a-farmbeats-account"></a>Ссылка FarmBeats счета

После того, как клиенты приобрели и развернули устройства или датчики, они могут получить доступ к данным устройства и телеметрии на программном обеспечении партнеров устройства в качестве сервиса (SaaS) портала. Партнеры по устройству могут позволить клиентам связать свою учетную запись с экземпляром FarmBeats в Azure, предоставив способ ввода следующих учетных данных:

   - Отобразить имя (дополнительное поле для пользователей для определения имени для этой интеграции)
   - Конечная точка API
   - Tenant ID
   - Идентификатор клиента
   - Секрет клиента
   - Строка соединения EventHub
   - Дата начала

   > [!NOTE]
   > Дата начала позволяет использовать канал исторических данных, т.е. данные с даты, указанной пользователем.

## <a name="unlink-farmbeats"></a>Unlink FarmBeats

Партнеры по устройству могут позволить клиентам отвязать существующую интеграцию FarmBeats. Unlinking FarmBeats не должен удалять никакие метаданные устройства или датчика, созданные в FarmBeats Datahub. Unlinking делает следующее:

   - Остановка телеметрического потока.
   - Удаляет и удаляет учетные данные интеграции на партнере устройства.

## <a name="edit-farmbeats-integration"></a>Интеграция Edit FarmBeats

Партнеры по устройству могут позволить клиентам отсеивать настройки интеграции FarmBeats, если изменяется секрет клиента или строка соединения. В этом случае только следующие поля можно отделать:

   - Отображение имени (если это применимо)
   - Секрет клиента (должен отображаться в формате «2x8» или функция «Шоу/Скрыть» вместо четкого текста)
   - Строка подключения (должна отображаться в формате «2x8» или функция «Показать/Скрыть», а не в четком тексте)

## <a name="view-the-last-telemetry-sent"></a>Просмотр последней отправленной телеметрии

Партнеры устройства могут позволить клиентам просматривать отметку времени последней отправленной телеметрии, которая находится под **телеметрией Sent**. Это время, когда последняя телеметрия была успешно отправлена в FarmBeats.

## <a name="troubleshooting-and-error-management"></a>Устранение неполадок и управление ошибками

**Опция или поддержка устранения неполадок**

Если клиент не может получить данные устройства или телеметрию в указанном экземпляре FarmBeats, партнер устройства должен обеспечить поддержку и механизм устранения неполадок.

**Телеметрия хранения данных**

Данные телеметрии также должны быть сохранены в течение заданного периода времени, чтобы они могли быть полезны при отладке или повторной отправке телеметрии в случае ошибки или потери данных.

**Управление ошибками или уведомление об ошибке**

Если ошибка влияет на метаданные устройства или датчика или на интеграцию данных или телеметрический поток данных в системе партнеров устройства, клиент должен получить уведомление. Механизм для устранения любых ошибок также должен быть разработан и реализован.

**Контрольный список подключения**

Производители или партнеры устройств могут использовать следующий контрольный список, чтобы убедиться, что учетные данные, предоставляемые клиентом, являются точными:

   - Проверьте, получен ли токен доступа с предоставленными учетными данными.
   - Проверьте, удается ли вызов API с помощью полученного токета доступа.
   - Проверьте, установлено ли подключение клиента EventHub.

## <a name="next-steps"></a>Дальнейшие действия

Для получения дополнительной информации о [REST API](rest-api-in-azure-farmbeats.md)REST API см.
