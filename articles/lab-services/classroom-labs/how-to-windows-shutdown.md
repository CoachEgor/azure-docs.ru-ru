---
title: Руководство по управлению поведением отключения Windows в лабораторных службах Azure (ru) Документы Майкрософт
description: Шаги по автоматическому отключению простаиваемых виртуальных машин Windows и удалению команды отключения Windows.
services: lab-services
documentationcenter: na
author: spelluru
manager: ''
editor: ''
ms.service: lab-services
ms.topic: article
ms.date: 3/30/2020
ms.author: spelluru
ms.openlocfilehash: 39ff4f42457451dfa4aae90b281d6b163c56b4cd
ms.sourcegitcommit: b0ff9c9d760a0426fd1226b909ab943e13ade330
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2020
ms.locfileid: "80522242"
---
# <a name="guide-to-controlling-windows-shutdown-behavior"></a>Руководство по управлению поведением отключения Windows

Службы Azure Lab предоставляют несколько элементов управления затратами, чтобы гарантировать, что виртуальные компьютеры Windows (VM) не работают неожиданно:
 - [Установить расписание](https://docs.microsoft.com/azure/lab-services/classroom-labs/tutorial-setup-classroom-lab#set-a-schedule-for-the-lab)
 - [Настройка квот для пользователей](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-configure-student-usage#set-quotas-for-users)
 - [Включение автоматического завершения работы при отключении](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-enable-shutdown-disconnect)

Даже при таких элементах управления затратами возникают ситуации, когда Windows VM может неожиданно продолжать работать; и, как следствие, вычесть из студенческой квоты:

- **Окно RDP остается открытым**
  
    Когда студент подключается к своему VM с помощью RDP, он может непреднамеренно оставить окно RDP открытым.  До тех пор, пока окно RDP остается открытым, **автоматическое отключение настройки отключения** никогда не вступит в силу, так как оно срабатывает только после отключения сеанса RDP.

- **Команда отключения Windows используется для выключения VM**
  
    Студент может использовать команду отключения Windows или другие механизмы выключения, предусмотренные в Windows, чтобы отключить VM вместо того, чтобы использовать [кнопку остановки Azure Lab Services.](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-use-classroom-lab#start-or-stop-the-vm)  Когда это происходит, с точки зрения служб ы Azure Lab, VM все еще используется.
    
Чтобы предотвратить возникновение этих ситуаций, это руководство предоставляет шаги для автоматического отключения простаивающего ВМ Windows VM и удаления команды отключения Windows из меню **«Пуск».**  

> [!NOTE]
> VM также может неожиданно вычесть из квоты, когда студент начинает свой VM, но никогда на самом деле не подключается к нему с помощью RDP.  Это руководство в настоящее время *не* рассматривает этот сценарий.  Вместо этого, студенты должны быть напомнели, чтобы немедленно подключиться к их VM с помощью RDP после того, как они начинают его; или, они должны остановить VM.

## <a name="automatic-rdp-disconnect-and-shutdown-for-idle-vm"></a>Автоматическое отключение RDP и отключение для простоя VM

Windows предоставляет локальные параметры **политики групп,** которые можно использовать для установления ограничения по времени для автоматического отключения сеанса RDP при его простое.  Сеанс определяется как простой, когда *нет* ввода мыши и клавиатуры.  Любые длительные действия, не связанные с ввозами клавиатуры мыши, приводят к тому, что VM простаивает.  Это включает в себя выполнение длинного запроса, потоковое видео, компиляцию и т.д.  В зависимости от потребностей вашего класса можно установить ограничение по времени простоя, чтобы он был достаточно длинным для обработки этих видов деятельности.  Например, при необходимости можно установить ограничение времени простоя до 1 или более часов.

Вот опыт студента, когда вы настраиваете **лимит сеанса простоя** в сочетании с [**автоматическим выключением**](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-enable-shutdown-disconnect) параметра отключения:
 1. Студент подключается к Windows VM с помощью RDP.
 2. Когда студент оставляет окно RDP открытым, а VM простаивает для **указанного вами лимита сеанса простоя** (например, 5 минут), студент увидит следующий диалог:

    ![Срок простоя истек диалог](../media/how-to-windows-shutdown/idle-time-expired.png)

1. Если студент *не* нажимает **OK,** их сеанс RDP автоматически отключается через 2 минуты.
2. После отключения сеанса RDP после достижения указанного срока **автоматического выключения** параметра отключения VM автоматически отключается службой Azure Lab Services.

### <a name="set-rdp-idle-session-time-limit-on-the-template-vm"></a>Установите лимит времени простоя RDP на шаблоне VM

Чтобы установить ограничение времени простоя сеанса RDP, можно подключиться к шаблону VM и выполнить ниже приведенный в действие сценарий PowerShell.

```powershell
# The MaxIdleTime is in milliseconds; by default, this script sets MaxIdleTime to 15 minutes.
$maxIdleTime = 15 * 60 * 90

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "MaxIdleTime" -Value $maxIdleTime -Force
```
Или вы можете следовать этим инструкциям с помощью шаблона VM:

1. Нажмите на ключ Windows, введите **gpedit,** затем выберите **политику группы edit (панель управления).**

1. Перейти к **компьютерной конфигурации > административных шаблонов > windows компоненты > удаленных настольных служб > удаленного рабочего стола сессии хост > время сессии ограничения.**  

    ![Редактор локальной групповой политики](../media/how-to-windows-shutdown/group-policy-idle.png)
   
1. Право нажмите **Установить ограничение времени для активных, но простой удаленных настольных служб сессий**, и нажмите **Edit**.

1. Введите указанные ниже параметры и нажмите кнопку **ОК**.
   1. Выберите **Включено**.
   1. В соответствии с **опционами**укажите **лимит сеанса простоя.**

    ![Лимит сеанса простоя](../media/how-to-windows-shutdown/edit-idle-time-limit.png)

1. Наконец, чтобы объединить это поведение с **автоматическим выключением параметра отключения,** следует следовать шагам в статье «как-к»: [Включить автоматическое выключение ВМ при отключении.](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-enable-shutdown-disconnect)

## <a name="remove-windows-shutdown-command-from-start-menu"></a>Удалить команду отключения Windows из меню «Пуск»

Настройки **локальной группы** Windows также позволяют удалить команду выключения из меню **«Пуск».**

Чтобы удалить команду выключения, можно подключиться к шаблону VM и выполнить ниже powerShell скрипт.

```powershell
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name "HidePowerOptions" -Value 1 -Force
```

Или вы можете следовать этим инструкциям с помощью шаблона VM:

1. Нажмите на ключ Windows, введите **gpedit,** затем выберите **политику группы edit (панель управления).**

1. Перейти к **компьютерной конфигурации > административных шаблонов > меню пуска и панели задач.**  

    ![Редактор локальной групповой политики](../media/how-to-windows-shutdown/group-policy-shutdown.png)

1. Нажмите кнопку **Удалить и предотвратить доступ к выключить, перезагрузки, сна и Hibernate команды**, и нажмите **Edit**.

1. Выберите настройку **Enabled,** а затем нажмите **OK:**
 
   ![Настройка выключения](../media/how-to-windows-shutdown/edit-shutdown.png)

1. Обратите внимание, что команда выключения больше не отображается в меню Windows **Start;** появляется только команда **Disconnect.**

    ![Команда выключения](../media/how-to-windows-shutdown/start-menu.png)

## <a name="next-steps"></a>Дальнейшие действия
О том, как подготовить шаблон Windows VM: [Руководство по настройке шаблона Windows в лабораторных службах Azure](how-to-prepare-windows-template.md)