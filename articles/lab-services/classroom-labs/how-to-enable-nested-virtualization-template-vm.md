---
title: Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure | Документация Майкрософт
description: Узнайте, как создать шаблон виртуальной машины с несколькими виртуальными машинами в.  Иными словами, включите вложенную виртуализацию на виртуальной машине шаблона в службах лаборатории Azure.
services: lab-services
documentationcenter: na
author: spelluru
manager: ''
editor: ''
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/04/2019
ms.author: spelluru
ms.openlocfilehash: 64097a5b3b62bcd5a84f4472a844bb95cf24cd6f
ms.sourcegitcommit: 428fded8754fa58f20908487a81e2f278f75b5d0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/27/2019
ms.locfileid: "74555085"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services"></a>Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure

Сейчас службы лаборатории Azure позволяют настроить одну виртуальную машину шаблона в лаборатории и сделать одну копию доступной для каждого пользователя. Если вы являетесь профессор обучением сети, безопасностью или ИТ-классами, вам может потребоваться предоставить каждому из учащихся среду, в которой несколько виртуальных машин могут взаимодействовать друг с другом по сети.

Вложенная виртуализация позволяет создать среду с несколькими виртуальными машинами в виртуальной машине шаблона лаборатории. Публикация шаблона предоставит каждому пользователю в лаборатории виртуальную машину, настроенную с несколькими виртуальными машинами в ней.  В этой статье описывается настройка вложенной виртуализации на компьютере шаблона в службах лаборатории Azure.

## <a name="what-is-nested-virtualization"></a>Что такое вложенная виртуализация?

Вложенная виртуализация позволяет создавать виртуальные машины на виртуальной машине. Вложенная виртуализация выполняется через Hyper-V и доступна только на виртуальных машинах Windows.

Дополнительные сведения о вложенной виртуализации см. в следующих статьях:

- [Вложенная виртуализация в Azure](https://azure.microsoft.com/blog/nested-virtualization-in-azure/)
- [Включение вложенной виртуализации на виртуальной машине Azure](../../virtual-machines/windows/nested-virtualization.md)

## <a name="considerations"></a>Рекомендации

Перед настройкой лаборатории с вложенной виртуализацией необходимо принять во внимание некоторые моменты.

- При создании лаборатории выберите значение **средняя (вложенная виртуализация)** или **крупные (вложенная** виртуализация) для размера виртуальной машины. Размеры виртуальных машин поддерживают вложенную виртуализацию.
- Выберите размер, который обеспечит хорошую производительность как для узлов, так и для клиентских виртуальных машин.  Помните, что при использовании виртуализации выбранный размер должен быть достаточным для не только для одного компьютера, но и для всех клиентских компьютеров, которые должны выполняться параллельно.
- Клиентские виртуальные машины не будут иметь доступа к ресурсам Azure, таким как DNS-серверы в виртуальной сети Azure.
- Для виртуальной машины узла требуется программа установки, разрешающая подключение клиентского компьютера к Интернету.
- Клиентские виртуальные машины лицензируются как независимые компьютеры. Сведения о лицензировании операционных систем и продуктов Майкрософт см. в разделе [Лицензирование корпорации Майкрософт](https://www.microsoft.com/licensing/default) . Проверьте лицензионное соглашение для любого другого программного обеспечения, используемого перед настройкой компьютера шаблона.

## <a name="enable-nested-virtualization-on-a-template-vm"></a>Включение вложенной виртуализации в шаблоне виртуальной машины

В этой статье предполагается, что вы создали лабораторную учетную запись и лабораторию.  Дополнительные сведения о создании учетной записи лаборатории см. [в руководстве по настройке учетной записи лаборатории](tutorial-setup-lab-account.md). Дополнительные сведения о создании лаборатории см. в разделе [Настройка лаборатории для занятий](tutorial-setup-classroom-lab.md).

>[!IMPORTANT]
>Выберите **крупный (вложенная виртуализация)** или **средняя (вложенная виртуализация)** для размера виртуальной машины при создании лаборатории.  В противном случае вложенная виртуализация не будет работать.  

Чтобы подключиться к компьютеру шаблона, см. раздел [Создание шаблона аудитории и управление им](how-to-create-manage-template.md). 

Действия, описанные в этом разделе, касаются настройки вложенной виртуализации для Windows Server 2016 или Windows Server 2019. Для настройки компьютера шаблона с помощью Hyper-V будет использоваться сценарий.  Ниже приведены инструкции по использованию [сценариев Hyper-V в службах лаборатории](https://github.com/Azure/azure-devtestlab/tree/master/samples/ClassroomLabs/Scripts/HyperV).

1. Если вы используете Internet Explorer, может потребоваться добавить `https://github.com` в список надежных сайтов.
    1. Откройте браузер Internet Explorer.
    1. Щелкните значок шестеренки и выберите **Свойства браузера**.  
    1. Когда откроется диалоговое окно **Свойства обозревателя** , выберите **Безопасность**, выберите **Надежные сайты**, нажмите кнопку **сайты** .
    1. Когда появится диалоговое окно **Надежные сайты** , добавьте `https://github.com` в список Доверенные веб-сайты и нажмите кнопку **Закрыть**.

        ![Надежные сайты](../media/how-to-enable-nested-virtualization-template-vm/trusted-sites-dialog.png)
1. Скачайте файлы репозитория Git, как описано в следующих шагах.
    1. Перейдите на сайт [https://github.com/Azure/azure-devtestlab/](https://github.com/Azure/azure-devtestlab/).
    1. Нажмите кнопку **клонировать или скачать** .
    1. Щелкните **скачать ZIP-файл**.
    1. Извлечение ZIP-файла

    >[!TIP]
    >Репозиторий Git также можно клонировать на [https://github.com/Azure/azure-devtestlab.git](https://github.com/Azure/azure-devtestlab.git).

1. Запустите **PowerShell** в режиме **администратора** .
1. В окне PowerShell перейдите к папке с скачанным скриптом. Если вы выполняете переход из верхней папки файлов репозитория, сценарий находится по адресу `azure-devtestlab\samples\ClassroomLabs\Scripts\HyperV\`.
1. Для успешного выполнения скрипта может потребоваться изменить политику выполнения. Выполните следующую команду:

    ```powershell
    Set-ExecutionPolicy bypass -force
    ```

1. Выполните сценарий:

    ```powershell
    .\SetupForNestedVirtualization.ps1
    ```

    > [!NOTE]
    > Для выполнения сценария может потребоваться перезапустить компьютер. Следуйте инструкциям скрипта и повторно запустите скрипт, пока в выходных данных не появится элемент **script завершен** .
1. Не забудьте сбросить политику выполнения. Выполните следующую команду:

    ```powershell
    Set-ExecutionPolicy default -force
    ```

## <a name="conclusion"></a>Заключение

Теперь ваш компьютер шаблона готов к созданию виртуальных машин Hyper-V. Инструкции по созданию виртуальных машин Hyper-V см. [в статье Создание виртуальной машины в Hyper-v](/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v) . См. также раздел [Центр оценки Майкрософт](https://www.microsoft.com/evalcenter/) для извлечения доступных операционных систем и программного обеспечения.  
