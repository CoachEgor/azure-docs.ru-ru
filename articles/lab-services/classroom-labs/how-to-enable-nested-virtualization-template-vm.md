---
title: Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure | Документация Майкрософт
description: Узнайте, как создать шаблон виртуальной машины с несколькими виртуальными машинами в.  Иными словами, включите вложенную виртуализацию на виртуальной машине шаблона в службах лаборатории Azure.
services: lab-services
documentationcenter: na
author: spelluru
manager: ''
editor: ''
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/04/2019
ms.author: spelluru
ms.openlocfilehash: 3c954c4689281838ea8c61c932cdcc3b74bac442
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82184679"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services"></a>Включение вложенной виртуализации на виртуальной машине шаблона в службах лаборатории Azure

Сейчас службы лаборатории Azure позволяют настроить одну виртуальную машину шаблона в лаборатории и сделать одну копию доступной для каждого пользователя. Если вы профессор обучающие сети, безопасность или ИТ-классы, вам может потребоваться предоставить каждому из учащихся среду, в которой несколько виртуальных машин могут взаимодействовать друг с другом по сети.

Вложенная виртуализация позволяет создать среду с несколькими виртуальными машинами в виртуальной машине шаблона лаборатории. Публикация шаблона предоставит каждому пользователю в лаборатории виртуальную машину, настроенную с несколькими виртуальными машинами в ней.  В этой статье описывается настройка вложенной виртуализации на компьютере шаблона в службах лаборатории Azure.

## <a name="what-is-nested-virtualization"></a>Что такое вложенная виртуализация?

Вложенная виртуализация позволяет создавать виртуальные машины на виртуальной машине. Вложенная виртуализация выполняется через Hyper-V и доступна только на виртуальных машинах Windows.

Дополнительные сведения о вложенной виртуализации см. в следующих статьях:

- [Вложенная виртуализация в Azure](https://azure.microsoft.com/blog/nested-virtualization-in-azure/)
- [Как включить вложенную виртуализацию в виртуальных машинах Azure](../../virtual-machines/windows/nested-virtualization.md)

## <a name="considerations"></a>Рекомендации

Перед настройкой лаборатории с вложенной виртуализацией необходимо принять во внимание некоторые моменты.

- При создании лаборатории выберите значение **средняя (вложенная виртуализация)** или **крупные (вложенная** виртуализация) для размера виртуальной машины. Размеры виртуальных машин поддерживают вложенную виртуализацию.
- Выберите размер, который обеспечит хорошую производительность как для узлов, так и для клиентских виртуальных машин.  Помните, что при использовании виртуализации выбранный размер должен быть достаточным для не только для одного компьютера, но и для всех компьютеров Hyper-V, работающих одновременно.
- Клиентские виртуальные машины не смогут получить доступ к ресурсам Azure, таким как DNS-серверы, в виртуальной сети Azure.
- Для виртуальной машины узла требуется программа установки, разрешающая подключение клиентского компьютера к Интернету.
- Клиентские виртуальные машины лицензируются как независимые компьютеры. Сведения о лицензировании операционных систем и продуктов Майкрософт см. в разделе [Лицензирование корпорации Майкрософт](https://www.microsoft.com/licensing/default) . Проверьте лицензионное соглашение для любого другого программного обеспечения, используемого перед настройкой компьютера шаблона.

## <a name="enable-nested-virtualization-on-a-template-vm"></a>Включение вложенной виртуализации в шаблоне виртуальной машины

В этой статье предполагается, что вы создали лабораторную учетную запись и лабораторию.  Дополнительные сведения о создании учетной записи лаборатории см. [в руководстве по настройке учетной записи лаборатории](tutorial-setup-lab-account.md). Дополнительные сведения о создании лаборатории см. в разделе [Настройка лаборатории для занятий](tutorial-setup-classroom-lab.md).

>[!IMPORTANT]
>Выберите **крупный (вложенная виртуализация)** или **средняя (вложенная виртуализация)** для размера виртуальной машины при создании лаборатории.  В противном случае вложенная виртуализация не будет работать.  

Чтобы подключиться к компьютеру шаблона, см. раздел [Создание шаблона аудитории и управление им](how-to-create-manage-template.md).

Чтобы включить вложенную виртуализацию, необходимо выполнить несколько задач.  

- **Включите роль Hyper-V**. Для создания и запуска виртуальных машин Hyper-V на виртуальной машине служб лаборатории необходимо включить роль Hyper-V.
- **Включите DHCP**.  Если для виртуальной машины служб лаборатории включена роль DHCP, виртуальным машинам Hyper-V можно автоматически назначить IP-адрес.
- **Создайте сеть NAT для виртуальных машин Hyper-V**.  Сеть NAT настроена, чтобы разрешить виртуальным машинам Hyper-V доступ к Интернету.  Виртуальные машины Hyper-V могут взаимодействовать друг с другом.

>[!NOTE]
>Сеть NAT, созданная на виртуальной машине служб лаборатории, позволит виртуальной машине Hyper-V получить доступ к Интернету и другим виртуальным машинам Hyper-V на той же виртуальной машине служб лаборатории.  Виртуальная машина Hyper-V не сможет получить доступ к ресурсам Azure, таким как DNS-серверы, в виртуальной сети Azure.

Выполнение перечисленных выше задач можно выполнить с помощью сценария или с помощью средств Windows.  Дополнительные сведения см. в следующих разделах.

### <a name="using-script-to-enable-nested-virtualization"></a>Использование скрипта для включения вложенной виртуализации

Сведения об использовании автоматической установки для вложенной виртуализации с Windows Server 2016 или Windows Server 2019 см. в статье [Включение вложенной виртуализации на шаблонной виртуальной машине в службах лаборатории Azure с помощью скрипта](how-to-enable-nested-virtualization-template-vm-using-script.md). Для установки роли Hyper-V будут использоваться скрипты из [сценариев Hyper-v служб лаборатории](https://github.com/Azure/azure-devtestlab/tree/master/samples/ClassroomLabs/Scripts/HyperV) .  Эти сценарии также настроили сетевые подключения, чтобы виртуальные машины Hyper-V могли иметь доступ к Интернету.

### <a name="using-windows-tools-to-enable-nested-virtualization"></a>Использование средств Windows для включения вложенной виртуализации

Настройка вложенной виртуализации для Windows Server 2016 или Windows Server 2019 с помощью ролей Windows и средств администрирования см. [в статье Включение вложенной виртуализации в шаблонной виртуальной машине в службах лаборатории Azure вручную](how-to-enable-nested-virtualization-template-vm-ui.md).  В инструкциях также рассматривается настройка сети, чтобы виртуальные машины Hyper-V могли иметь доступ к Интернету.
