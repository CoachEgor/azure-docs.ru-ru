---
title: Включить вложенную виртуализацию на шаблоне VM в Лаборантных Службах Лабы (UI) Документы Майкрософт
description: Узнайте, как создать шаблон VM с несколькими vMs внутри.  Другими словами, включите вложенную виртуализацию на шаблоне VM в Службах лаборатории Azure.
services: lab-services
author: emaher
ms.service: lab-services
ms.topic: article
ms.date: 1/23/2020
ms.author: enewman
ms.openlocfilehash: 10f8d2760474631fbcabac4d66139aedf4c7560c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79503079"
---
# <a name="enable-nested-virtualization-on-a-template-virtual-machine-in-azure-lab-services-manually"></a>Включить вложенную виртуализацию на виртуальной машине шаблона в службах Azure Lab

Вложенная виртуализация позволяет создать мульти-VM-среду внутри виртуальной машины шаблона лаборатории. Публикация шаблона обеспечит каждого пользователя в лаборатории с виртуальной машиной, настроенной с несколькими VMs внутри него.  Для получения дополнительной информации о вложенной виртуализации и лабораторных службах Azure [см.](how-to-enable-nested-virtualization-template-vm.md)

В этой статье рассказывается о том, как настроить вложенную виртуализацию на шаблонной машине в лабораторных службах Azure, используя непосредственно роли и инструменты Windows.  Есть несколько вещей, необходимых для того, чтобы класс мог использовать вложенную виртуализацию.  На приведенных ниже шагах будет описано, как вручную настроить шаблон машины Lab Services с Hyper-V.  Шаги предназначены для Windows Server 2016 или Windows Server 2019.  

>[!IMPORTANT]
>Выберите **Большой (вложенная виртуализация)** или **Medium (вложенная виртуализация)** для размера виртуальной машины при создании лаборатории.  Вложенная виртуализация не будет работать иначе.  

## <a name="enable-hyper-v-role"></a>Включить роль Hyper-V

Следующие шаги описывают действия, необходимые для включения Hyper-V на Windows Server с помощью любого серверного менеджера.  Как только установка будет успешной, менеджер Hyper-V будет доступен для добавления, изменения и удаления виртуальных компьютеров клиента.

1. В **серверном менеджере**, на странице панели мониторинга, нажмите **Добавить роли и функции**.
2. На странице **Перед работой** нажмите кнопку **Далее**.
3. На странице **типа «Выберите»** сохраните выбор по умолчанию установки на основе ролей или функций, а затем нажмите **далее.**
4. На странице **сервера «Выберите место назначения»** выберите сервер из пула серверов.   Текущий сервер уже выбран.  Нажмите кнопку Далее.
5. На странице **Выбор ролей сервера** выберите **Hyper-V**.  
6. Появится всплывающее окно **Мастера добавления и функций.**  Выберите **Включить инструменты управления (если это применимо)**.  Нажмите кнопку **Добавить кнопку.**
7. На странице **Выбор ролей сервера** нажмите кнопку **Далее**.
8. На **странице Выберите объекты**нажмите **далее**.
9. На странице **Hyper-V** нажмите кнопку **Далее**.
10. На странице **Create Virtual Switches** примите по умолчанию и **нажмите далее.**
11. На странице **Virtual Machine Migration** примите по умолчанию и **нажмите далее.**
12. На странице **Магазинов по умолчанию** примите по умолчанию и нажмите **далее.**
13. На странице **выбора установки Confirm** выберите **автоматические перезапуска сервера назначения, если это необходимо.**
14. Когда появляется всплывающее окно **Мастера функций Добавления и функций,** нажмите **«Да».**
15. Нажмите кнопку **Установить**.
16. Подождите, пока страница **выполнения установки** покажет, что роль Hyper-V завершена.  Машина может перезапуститься в середине установки.
17. Нажмите кнопку **Закрыть**.

## <a name="enable-dhcp-role"></a>Включить роль DHCP

Любой клиент Hyper-V виртуальные машины, созданные, нуждается в IP-адресе в сети NAT.  Мы создадим сеть NAT позже.  Одним из способов присвоения IP-адресов является настройка узла, в данном случае шаблона виртуальной машины лаборатории, в качестве сервера DHCP.  Ниже приведены шаги, необходимые для включения роли DHCP.

1. В **серверном менеджере**, на странице **панели мониторинга,** нажмите **Добавить роли и функции**.
2. На странице **Перед работой** нажмите кнопку **Далее**.
3. На странице **Выбор типа установки** выберите **Установка ролей или компонентов** и нажмите кнопку **Далее**.
4. На странице **сервера Назначения Выберите** текущий сервер из пула серверов, а затем нажмите **далее.**
5. На странице **ролей «Выберите сервер»** выберите **DHCP Server.**  
6. Появится всплывающее окно **Мастера добавления и функций.**  Выберите **Включить инструменты управления (если это применимо)**.  Нажмите кнопку **Добавить компоненты**.

    >[!NOTE]
    >Вы можете увидеть ошибку проверки о том, что не было найдено статических IP-адресов.  Это предупреждение может быть проигнорировано для нашего сценария.

7. На странице **Выбор ролей сервера** нажмите кнопку **Далее**.
8. На странице **Выбор компонентов** нажмите кнопку **Далее**.
9. На странице **СЕРВЕРа DHCP** нажмите **далее**.
10. На странице **Подтверждение выбранных элементов для установки** нажмите кнопку **Установить**.
11. Подождите **страницу выполнения установки,** чтобы указать, что роль DHCP завершена.
12. Нажмите кнопку Закрыть.

## <a name="enable-routing-and-remote-access-role"></a>Включить роль в реутирование и удаленном доступе

1. В **серверном менеджере**, на странице **панели мониторинга,** нажмите **Добавить роли и функции**.
2. На странице **Перед работой** нажмите кнопку **Далее**.
3. На странице **Выбор типа установки** выберите **Установка ролей или компонентов** и нажмите кнопку **Далее**.
4. На странице **сервера Назначения Выберите** текущий сервер из пула серверов, а затем нажмите **далее.**
5. На странице **ролей «Выберите сервер»** выберите **удаленный доступ.** Нажмите кнопку **ОК**.
6. На странице **Выбор компонентов** нажмите кнопку **Далее**.
7. На странице **удаленного доступа** нажмите **далее**.
8. На странице **Ролевые службы** выберите **Routing**.
9. Появится всплывающее окно **Мастера добавления и функций.**  Выберите **Включить инструменты управления (если это применимо)**.  Нажмите кнопку **Добавить компоненты**.
10. Нажмите кнопку **Далее**.
11. На странице **Роль веб-сервера (IIS)** нажмите кнопку **Далее**.
12. На странице **Выберите службы роли** нажмите кнопку **Далее**.
13. На странице **Подтверждение выбранных элементов для установки** нажмите кнопку **Установить**.
14. Подождите, пока страница **выполнения установки** покажет, что роль удаленного доступа завершена.  
15. Нажмите кнопку **Закрыть**.

## <a name="create-virtual-nat-network"></a>Создание виртуальной сети NAT

Теперь, когда все необходимые роли были установлены, пришло время создать сеть NAT.  Процесс создания будет включать в себя создание коммутатора и самой сети NAT.  Сеть NAT (перевод сетевого адреса) присваивает публичному IP-адресу группу вс-мисов в частной сети, чтобы обеспечить подключение к Интернету.  В нашем случае, группа частных VMs будет вложенных VMs.  Сеть NAT позволит вложенным ВМ общаться друг с другом. Коммутатор — это сетевое устройство, которое обрабатывает прием и трафик в сети.

### <a name="create-a-new-virtual-switch"></a>Создание нового виртуального коммутатора

1. Открытый **менеджер Hyper-V** от Windows Administrative Tools.
2. Выберите текущий сервер в меню левой навигации.
3. Нажмите **Виртуальный коммутатор менеджер...** из меню **Действий** на правой стороне **Hyper-V Manager.**
4. На **всплывающем** центре Virtual Switch Manager выберите **внутренний** для типа коммутатора для создания.  Щелкните **Создать виртуальный коммутатор**.
5. Для недавно созданного виртуального переключателя, установите имя на что-то запоминающееся.  В этом примере мы будем использовать 'LabServicesSwitch'.  Нажмите кнопку **ОК**.
6. Будет создан новый сетевой адаптер.  Название будет похоже на 'vEthernet (LabServicesSwitch)'.  Чтобы проверить открытие **панели управления,** нажмите **Сеть и Интернет,** нажмите **Просмотр статуса сети и задач.**  Слева щелкните **настройки адаптера изменений.**

### <a name="create-a-nat-network"></a>Создание сети NAT

1. Откройте инструмент **«Размывание и удаленный доступ»** из административных инструментов Windows.
2. Выберите локальный сервер на левой странице навигации.
3. Выберите **настройку действия** -> **и включить routing и удаленный доступ.**
4. При **пояснении мастера настройки сервера с дистанционным доступом и удаленного доступа** нажмите **кнопку «Следующий».**
5. На странице **Configuration** выберите конфигурацию **перевода адресов сети (NAT).**  Нажмите кнопку **Далее**.

    >[!WARNING]
    >Не выбирайте опцию «Виртуальная частная сеть (VPN) и NAT.

6. На странице **NAT Internet Connection** выберите 'Ethernet'.  Не выбирайте соединение 'vEthernet (LabServicesSwitch),' мы создали в Hyper-V Manager. Нажмите кнопку **Далее**.
7. Нажмите **Закончить** на последней странице мастера.
8. При поясне нисовку **службы** нажмите **кнопку «Пуск сервис».**
9. Подождите, пока служба не будет запущена.

## <a name="update-network-adapter-settings"></a>Обновление настроек сетевого адаптера

Адаптер сети будет связан с IP, используемым для IP-адреса шлюза по умолчанию для сети NAT, созданной ранее.  В этом примере мы создаем IP-адрес 192.168.0.1 с подсетевой маской 255.255.0.  Мы будем использовать виртуальный коммутатор, созданный ранее.

1. Откройте **панель управления,** нажмите **Сеть и Интернет,** нажмите **Просмотр статуса сети и задач.**
2. Слева щелкните **настройки адаптера изменений.**  
3. В окне **сетевых** подключений, дважды нажмите на 'vEthernet (LabServicesSwitch)', чтобы показать **vEthernet (LabServicesSwitch) Статус** детали диалога.
4. Нажмите кнопку **Свойства.**
5. Выберите элемент **Internet Protocol Version 4 (TCP/IPv4)** и нажмите кнопку **«Свойства».**
6. В **диалоге свойств Интернет-протокола 4 (TCP/IPv4)** выберите **Используйте следующий IP-адрес.**  Для IP-адреса введите 192.168.0.1. Для подсетевой маски введите 255.255.255.0.  Оставьте шлюз по умолчанию пустым.  Оставьте DNS-серверы пустыми.

    >[!NOTE]
    > Наш ассортимент для нашей сети NAT будет, в обозначении CIDR, 192.168.0.0/24.  Это создает диапазон годных к удобываемому писанию IP-адресов с 192.168.0.1 до 192.168.0.254.  По соглашению, шлюзы имеют первый IP-адрес в диапазоне поднетов.

7. Щелкните ОК.

## <a name="create-dhcp-scope"></a>Создать область DHCP

Следующие шаги инструкции по добавлению области DHCP.  В этой статье, наша сеть NAT 192.168.0.0/24 в обозначении CIDR.  Это создает диапазон годных к удобываемому писанию IP-адресов с 192.168.0.1 до 192.168.0.254.  Область, созданная, должна находиться в диапазоне пригодных для упомянуемых адресов, за исключением УЖЕ созданного ранее IP-адреса.

1. Откройте **административные инструменты** и откройте административный инструмент **DHCP.**
2. В инструменте **DHCP** расширьте узла для текущего сервера и выберите **IPv4.**
3. Из меню Action выберите **New Scope...**
4. При попаве **нового мастера сферы** нажмите **кнопку «Следующий»** на странице **Welcome.**
5. На странице **Название области** введите 'LabServicesDhcpScope' или что-то еще запоминающееся для названия.  Нажмите кнопку **Далее**.
6. На странице **диапазона IP-адресов** введите следующие значения.

    - 192.168.0.100 для IP-адреса Start
    - 192.168.0.200 для IP-адреса End
    - 24 для длины
    - 255.255.255.0 для маски Subnet

7. Нажмите кнопку **Далее**.
8. На странице **Добавления исключений и задержки** нажмите **далее**.
9. На странице **Лизинг Продолжительность,** нажмите **Далее**.
10. На странице **Настройка DHCP Параметры,** выберите **Да, я хочу настроить эти параметры сейчас**. Нажмите кнопку **Далее**.
11. На **маршрутизаторе (шлюз по умолчанию)**
12. Добавьте 192.168.0.1, если не сделано уже. Нажмите кнопку **Далее**.
13. На странице **доменного имени и DNS Servers** добавьте 168.63.129.16 в качестве IP-адреса сервера DNS, если это еще не сделано.  168.63.129.16 — это IP-адрес статического DNS-сервера Azure. Нажмите кнопку **Далее**.
14. На странице **wins Servers** нажмите **далее**.
15. Одна страница **активировать область,** выберите **Да, я хочу, чтобы активировать эту область сейчас**.  Нажмите кнопку **Далее**.
16. На странице **Завершения новой страницы Мастера сферы** нажмите **«Завершение».**

## <a name="conclusion"></a>Заключение

Теперь ваш шаблон машина готова к созданию Hyper-V виртуальных машин.   Смотрите [Создать виртуальную машину в Hyper-V](https://docs.microsoft.com/windows-server/virtualization/hyper-v/get-started/create-a-virtual-machine-in-hyper-v) для инструкций о том, как создать Hyper-V виртуальных машин.  Также смотрите [Центр оценки Майкрософт,](https://www.microsoft.com/evalcenter/) чтобы проверить доступные операционные системы и программное обеспечение.

## <a name="next-steps"></a>Дальнейшие действия

Следующие шаги являются общими для создания любой лаборатории.

- [Добавление пользователей](tutorial-setup-classroom-lab.md#add-users-to-the-lab)
- [Установленная квота](how-to-configure-student-usage.md#set-quotas-for-users)
- [Установить расписание](tutorial-setup-classroom-lab.md#set-a-schedule-for-the-lab)
- [Ссылки на регистрацию по электронной почте студентам](how-to-configure-student-usage.md#send-invitations-to-users)