---
title: Руководства по управлению поведением при завершении работы Windows в службах лаборатории Azure | Документация Майкрософт
description: Действия для автоматического завершения бездействующей виртуальной машины Windows и удаления команды завершения работы Windows.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: e17f6e79c3d18d82dd206954dcfb0e06b02b4d53
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85445174"
---
# <a name="guide-to-controlling-windows-shutdown-behavior"></a>Инструкции по управлению поведением при завершении работы Windows

Службы лаборатории Azure предоставляют несколько средств управления затратами, чтобы убедиться, что виртуальные машины Windows не выполняются неожиданно.
 - [Настройка расписания](https://docs.microsoft.com/azure/lab-services/classroom-labs/tutorial-setup-classroom-lab#set-a-schedule-for-the-lab)
 - [Настройка квот для пользователей](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-configure-student-usage#set-quotas-for-users)
 - [Активация автоматического отключения при потере связи](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-enable-shutdown-disconnect)

Даже с этими элементами управления затратами возникают ситуации, когда виртуальная машина Windows может неожиданно продолжить работу. и, как следствие, вычесть из квоты учащегося:

- **Окно RDP оставлено открытым**
  
    Когда учащийся подключается к своей виртуальной машине с помощью протокола удаленного рабочего стола, он может случайно оставить окно RDP открытым.  Пока окно RDP остается открытым, параметр **Автоматическое завершение работы при отключении** не вступит в силу, так как он срабатывает только после отключения сеанса RDP.

- **Команда завершения работы Windows используется для выключения виртуальной машины**
  
    Студент может использовать команду завершения работы Windows или другие механизмы завершения работы в Windows, чтобы отключить виртуальную машину вместо [кнопки остановки служб лабораторий Azure](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-use-classroom-lab#start-or-stop-the-vm).  В этом случае, с точки зрения служб лаборатории Azure, виртуальная машина по-прежнему используется.
    
Чтобы предотвратить возникновение этих ситуаций, в этом руководстве содержатся инструкции по автоматическому завершению бездействующей виртуальной машины Windows и удалению команды завершения работы Windows из меню " **Пуск** ".  

> [!NOTE]
> Виртуальная машина также может неожиданно вычесться из квоты, когда учащийся запустит свою виртуальную машину, но никогда не подключится к ней с помощью протокола удаленного рабочего стола.  В настоящее время это *не* рассматривается в этом сценарии.  Вместо этого студенты должны иметь напоминание о том, что нужно немедленно подключиться к своей виртуальной машине по протоколу RDP после запуска. или же они должны прекращать работу виртуальной машины.

## <a name="automatic-rdp-disconnect-and-shutdown-for-idle-vm"></a>Автоматическое отключение RDP и завершение работы для бездействующей виртуальной машины

Windows предоставляет **локальные параметры групповая политика** , которые можно использовать для установки предельного времени для автоматического отключения сеанса RDP, когда он переходит в режим простоя.  Сеанс определяется как бездействующий *при отсутствии* входных данных маусе\кэйбоард.  Все длительные действия, не затрагивающие вход маусе\кэйбоард, приводят к тому, что виртуальная машина находится в состоянии простоя.  Сюда входит выполнение длинных запросов, потоковая передача видео, компиляция и т. д.  В зависимости от потребностей вашего класса можно установить ограничение времени простоя, чтобы оно было достаточно большим для обработки этих типов действий.  Например, при необходимости можно установить ограничение времени простоя в 1 или более часов.

Ниже приведена работа учащегося при настройке **ограничения бездействующего сеанса** в сочетании с параметром [**автоматического завершения работы при отключении**](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-enable-shutdown-disconnect) .
 1. Учащийся подключается к виртуальной машине Windows по протоколу RDP.
 2. Когда студент оставляет свое окно RDP открытым и виртуальная машина бездействует в течение заданного **предела бездействующего сеанса** (например, 5 минут), учащийся увидит следующее диалоговое окно:

    ![Диалоговое окно с истекшим сроком ожидания](./media/how-to-windows-shutdown/idle-time-expired.png)

1. Если учащийся *не* найдет кнопку **ОК**, сеанс RDP автоматически отключится через 2 минуты.
2. После отключения сеанса RDP, когда будет достигнут указанный промежуток времени для **автоматического завершения работы при отключении** , виртуальная машина автоматически завершает работу служб лаборатории Azure.

### <a name="set-rdp-idle-session-time-limit-on-the-template-vm"></a>Установка ограничения времени бездействующего сеанса RDP на виртуальной машине шаблона

Чтобы задать предельное время простоя сеанса RDP, можно подключиться к виртуальной машине шаблона и выполнить приведенный ниже сценарий PowerShell.

```powershell
# The MaxIdleTime is in milliseconds; by default, this script sets MaxIdleTime to 15 minutes.
$maxIdleTime = 15 * 60 * 1000

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "MaxIdleTime" -Value $maxIdleTime -Force
```
Вы также можете выполнить эти действия вручную, используя шаблон виртуальной машины:

1. Нажмите клавишу Windows, введите **gpedit**, а затем выберите **изменить групповую политику (панель управления)**.

1. Последовательно выберите **Конфигурация компьютера > административные шаблоны > компоненты Windows > службы удаленных рабочих столов > удаленный рабочий стол узел сеансов > ограничения времени сеанса**.  

    ![Редактор локальной групповой политики](./media/how-to-windows-shutdown/group-policy-idle.png)
   
1. Щелкните правой кнопкой мыши **параметр ограничить время для активных, но бездействующих службы удаленных рабочих столов сеансов**и нажмите кнопку **изменить**.

1. Введите указанные ниже параметры и нажмите кнопку **ОК**.
   1. Выберите значение **Включено**.
   1. В разделе **Параметры**укажите **Ограничение бездействующего сеанса**.

    ![Ограничение бездействующего сеанса](./media/how-to-windows-shutdown/edit-idle-time-limit.png)

1. Наконец, чтобы объединить это поведение с параметром **автоматического завершения работы при отключении** , необходимо выполнить действия, описанные в статье как [включить автоматическое завершение работы виртуальных машин при отключении](https://docs.microsoft.com/azure/lab-services/classroom-labs/how-to-enable-shutdown-disconnect).

> [!WARNING]
> После настройки этого параметра с помощью PowerShell для изменения параметра реестра напрямую или вручную с помощью редактора групповая политика необходимо сначала перезапустить виртуальную машину, чтобы параметры вступили в силу.  Кроме того, если настроить параметр с помощью реестра, редактор групповая политика не всегда обновляется в соответствии с изменениями параметра реестра. Однако параметр реестра по-прежнему вступает в силу, как и ожидалось, и при простое в течение указанного времени сеанс RDP будет отключен.

## <a name="remove-windows-shutdown-command-from-start-menu"></a>Команда "удалить Windows Shutdown" из меню "Пуск"

Параметры **локального групповая политика** Windows также позволяют удалить команду завершить работу из меню " **Пуск** ".

Чтобы удалить команду завершения работы, подключитесь к виртуальной машине шаблона и выполните приведенный ниже сценарий PowerShell.

```powershell
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer" -Name "HidePowerOptions" -Value 1 -Force
```

Вы также можете выполнить эти действия вручную, используя шаблон виртуальной машины:

1. Нажмите клавишу Windows, введите **gpedit**, а затем выберите **изменить групповую политику (панель управления)**.

1. Последовательно выберите **Конфигурация компьютера > административные шаблоны > меню Пуск и панель задач**.  

    ![Редактор локальной групповой политики](./media/how-to-windows-shutdown/group-policy-shutdown.png)

1. Щелкните правой кнопкой мыши **Удалить и запретить доступ к командам завершение работы, перезапуск, спящий режим и режим гибернации**, а затем нажмите кнопку **изменить**.

1. Выберите параметр **включено** и нажмите кнопку **ОК**.
 
   ![Параметр завершения работы](./media/how-to-windows-shutdown/edit-shutdown.png)

1. Обратите внимание, что команда shutdown больше не отображается в меню " **Пуск** " Windows; отображается только команда **Disconnect** .

    ![Команда завершения работы](./media/how-to-windows-shutdown/start-menu.png)

## <a name="next-steps"></a>Дальнейшие шаги
См. статью о подготовке виртуальной машины шаблона Windows: руководство по [настройке компьютера шаблона Windows в службах лаборатории Azure](how-to-prepare-windows-template.md) .