---
title: Запустите фабрику образов из Azure DevOps в Azure DevTest Labs | Документация Майкрософт
description: Узнайте, как создать фабрику пользовательского образа в Azure DevTest Labs.
services: devtest-lab, lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/25/2019
ms.author: spelluru
ms.openlocfilehash: abb85d568e26e4b6f85b960a2560aae570daf201
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61320830"
---
# <a name="run-an-image-factory-from-azure-devops"></a>Запуск фабрики образов из Azure DevOps
В этой статье рассматриваются все подготовительные действия, необходимые для запуска фабрика образов из DevOps в Azure (прежнее название — Visual Studio Team Services).

> [!NOTE]
> Любой механизма оркестрации будет работать! Azure DevOps, не является обязательным. Фабрика образов выполняется с помощью скриптов Azure PowerShell, поэтому он может запускать вручную, с помощью планировщика заданий Windows, другими системами непрерывной Интеграции и Развертывания и т. д.

## <a name="create-a-lab-for-the-image-factory"></a>Создание лаборатории для фабрики образов
Первым шагом в настройке фабрики образа является создание лаборатории в Azure DevTest Labs. Этой лаборатории составляет лаборатории фабрики образа, здесь мы Создание виртуальных машин и сохранить пользовательские образы. Это лабораторное занятие считается как часть общего процесса фабрики образа. После создания лаборатории, не забудьте сохранить имя, так как он понадобится позже.

## <a name="scripts-and-templates"></a>Скрипты и шаблоны
Следующий шаг по внедрению фабрики образа для вашей команды — понять, что доступно. Изображение фабрики скрипты и шаблоны доступны публично в [репозиторий GitHub DevTest Labs](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Scripts/ImageFactory). Ниже приводится объяснение из частей:

- Фабрика образов. Это корневой папке.
    - Настройка. Входные данные для фабрики образов
        - GoldenImages. Эта папка содержит файлы JSON, представляющие определения пользовательских образов.
        - Labs.JSON. Файл, где Зарегистрируйтесь команды для получения определенных пользовательских образов.
- Сценарии. Подсистема для фабрики образов.

Статьи в этом разделе содержат дополнительные сведения об этих сценариев и шаблонов.

## <a name="create-an-azure-devops-team-project"></a>Создать командный проект Azure DevOps
Azure DevOps позволяют хранить исходный код, запустите Azure PowerShell в одном месте. Вы можете запланировать повторяющиеся запуски для обновления образов. Существует хороший средства ведения журнала результатов для диагностики проблем.  С помощью DevOps в Azure не является обязательным требованием тем не менее, можно использовать программу/ядра, которое можно подключить к Azure и Azure PowerShell можно запустить.

При наличии существующей учетной записи DevOps или проект, который вы хотите использовать вместо этого, пропустите этот шаг.

Чтобы приступить к работе, создайте бесплатную учетную запись в DevOps в Azure. Посетите https://www.visualstudio.com/ и выберите **начните работу бесплатно** прямо под **Azure DevOps** (прежнее название — VSTS). Необходимо выбрать уникальное имя и убедитесь, что вы решили управлять кодом, с помощью Git. После создания, сохраните URL-адрес командного проекта. Ниже приведен пример URL-адреса: `https://<accountname>.visualstudio.com/MyFirstProject`.

## <a name="check-in-the-image-factory-to-git"></a>Проверьте в фабрике образа на Git
Все PowerShell, шаблоны и конфигурация фабрики изображения находятся в [общедоступном репозитории DevTest Labs на сайте GitHub](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Scripts/ImageFactory). Самый быстрый способ получить код в новый командный проект является импортировать репозиторий. Это извлекает всего репозитория DevTest Labs (индекс, чтобы получать дополнительные документы и примеры).

1. Посетите проект Azure DevOps, созданный на предыдущем шаге (URL-адрес выглядит **https:\//\<accountname >.visualstudio.com/MyFirstProject**).
2. Выберите **импортировать репозиторий**.
3. Введите **URL-адрес клона** для репозитория DevTest Labs: `https://github.com/Azure/azure-devtestlab`.
4. Выберите **Импортировать**.

    ![Импорт репозитория Git](./media/set-up-devops-lab/import-git-repo.png)

Если вы решили только проверить в точности то, что требовалось (фабрики файлов изображений), выполните действия, [здесь](https://www.visualstudio.com/en-us/docs/git/share-your-code-in-git-vs) клонировать репозиторий Git и отправить только файлы, расположенные в **сценарии/ImageFactory** каталога.

## <a name="create-a-build-and-connect-to-azure"></a>Создание сборки и подключитесь к Azure
На этом этапе у вас есть исходные файлы, хранящиеся в репозитории Git в Azure DevOps. Теперь необходимо настроить конвейер, чтобы запустить Azure PowerShell. Существует множество вариантов на выполнение этих действий. В этой статье используется определение сборки для простоты, но она работает с DevOps сборки, выпуска DevOps (одним или несколькими средами), другие подсистемы выполнения, например планировщика задач Windows или другие программы, могут выполнять Azure PowerShell.

> [!NOTE]
> Важно помнить, что некоторые файлы PowerShell занять много времени для запуска при наличии гораздо (10 +) пользовательских образов для создания. Бесплатный размещенных агентов DevOps сборки или выпуска установлено время ожидания 30 минутам, поэтому ее невозможно использовать бесплатные размещенного агента, как только вы начнете создавать большое количество образов. Этот запрос времени ожидания применяется независимо от программы, вы решили использовать, полезно заранее убедитесь, что вы можете расширить типичный времени ожидания для долго выполняющихся скриптов Azure PowerShell. В случае с DevOps в Azure можно использовать платную размещенных агентов или использовать собственного агента сборки.

1. Чтобы начать, выберите **настроить сборку** на домашней странице проекта DevOps:

    ![Кнопка настройки сборки](./media/set-up-devops-lab/setup-build-button.png)
2. Укажите **имя** для сборки (например: Создавайте и отправки образов в DevTest Labs).
3. Выберите **пустой** определение сборки и выберите **применить** для создания сборки.
4. На этом этапе можно выбрать **размещенная** для агента построения.
5. **Сохранить** определения сборки.

    ![Определение сборки](./media/set-up-devops-lab/build-definition.png)

## <a name="configure-the-build-variables"></a>Настройка переменных сборки.
Чтобы упростить параметры командной строки, инкапсулируют значения ключей, которые управляют фабрики образа для набора переменных сборки. Выберите **переменных** вкладки и вы увидите список нескольких переменных по умолчанию. Ниже приведен список переменных для ввода в DevOps в Azure:


| Имя переменной | Value | Примечания |
| ------------- | ----- | ----- |
| ConfigurationLocation | /Scripts/ImageFactory/Configuration | Это полный путь в репозитории, чтобы **конфигурации** папки. При импорте всего репозитория выше, значение слева является правильным. В противном случае обновите для указания расположения конфигурации. |
| DevTestLabName | MyImageFactory | Имя лаборатории в Azure DevTest Labs, используется в качестве фабрики для создания образов. Если у вас ее нет, создайте ее. Убедитесь, что лаборатории находится в той же подписке, с доступом к конечной точке службы. |
| ImageRetention | 1 | Число образов, которые вы хотите сохранить каждого типа. Значение по умолчанию равно 1. |
| MachinePassword | ******* | Пароль учетной записи встроенных администратора для виртуальных машин. Это временная учетная запись, поэтому убедитесь, что это безопасно. Выберите маленький значок замка справа, чтобы убедиться, что он является защищенной строки. |
| MachineUserName | ImageFactoryUser | Встроенная учетная запись администратора для виртуальных машин. Это временная учетная запись. |
| StandardTimeoutMinutes | 30 | Время ожидания которого должен ждать выполнения обычных операций Azure. |
| SubscriptionId |  0000000000-0000-0000-0000-0000000000000 | Идентификатор подписки, где лаборатория и с доступом к конечной точке службы. |
| VMSize | Standard_A3 | Размер виртуальной машины для **создать** шаг. Виртуальные машины, созданные являются временными. Размер должен быть тем что [включена для лаборатории](devtest-lab-set-lab-policy.md). Убедитесь, что имеется достаточно [Квота ядер подписки](../azure-subscription-service-limits.md).

![Создание переменных](./media/set-up-devops-lab/configure-build-variables.png)

## <a name="connect-to-azure"></a>Подключение к Azure
Следующим шагом является настройка субъекта-службы. Это удостоверение в Azure Active Directory, который позволяет агенту построения DevOps для работы в Azure от имени пользователя. Настроить проверку подлинности, начните с добавления вы Azure PowerShell создавать сначала.

1. Выберите **добавьте задачу**.
2. Поиск **Azure PowerShell**.
3. Найдя имя, выберите **добавить** для добавления задачи к сборке. После этого, вы увидите, что задачи отображаются в левой части по мере добавления.

![Настройка этапа PowerShell](./media/set-up-devops-lab/set-up-powershell-step.png)

Самый быстрый способ настроить субъект-служба — позволяют сделать это для нас DevOps в Azure.

1. Выберите **задачи** вы только что добавили.
2. Для **тип подключения Azure**, выберите **Azure Resource Manager**.
3. Выберите **управление** ссылку для настройки субъекта-службы.

Дополнительные сведения см. в этом [блога](https://devblogs.microsoft.com/devops/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management/). При выборе **управление** ссылку, вы будете перенаправлены в нужном месте в DevOps (второй снимок экрана в записи блога) для настройки подключения к Azure. Не забывайте выбирать нужную **конечной точки службы Azure Resource Manager** при настройке.

## <a name="complete-the-build-task"></a>Завершите задачу построения
Если выбрать задачу сборки, вы увидите все необходимые сведения в правой области, которое должно быть заполнено.

1. Во-первых имя задачи сборки: **Создание виртуальных машин**.
2. Выберите **субъекта-службы** вы создали, выбрав **Azure Resource Manager**
3. Выберите **конечная точка службы**.
4. Для **путь к скрипту**выберите **... (многоточие)**  справа.
5. Перейдите к **MakeGoldenImageVMs.ps1** скрипта.
6. Параметры сценария должен выглядеть следующим образом: `-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -DevTestLabName $(DevTestLabName) -vmSize $(VMSize) -machineUserName $(MachineUserName) -machinePassword (ConvertTo-SecureString -string '$(MachinePassword)' -AsPlainText -Force) -StandardTimeoutMinutes $(StandardTimeoutMinutes)`

    ![Завершите определение сборки](./media/set-up-devops-lab/complete-build-definition.png)


## <a name="queue-the-build"></a>Поместите сборку в очередь
Давайте проверим, что у вас есть все настроено правильно, постановка в очередь новую сборку. Во время построения, переключитесь в [портала Azure](https://portal.azure.com) и select на **все виртуальные машины** в лабораторию фабрики изображение, чтобы убедиться, что все работает правильно. Вы увидите, что создаются три виртуальные машины в лаборатории.

![Виртуальные машины в лаборатории](./media/set-up-devops-lab/vms-in-lab.png)

## <a name="next-steps"></a>Дальнейшие действия
Первым шагом в настройке фабрики образов, в зависимости от Azure DevTest Labs завершена. В следующей статье из серии вы получаете те виртуальные машины универсальных и сохранен в пользовательские образы. После этого нужно установить их на все другие лабораториях. См. в следующей статье из серии: [Сохранение пользовательских образов и распространять в несколько лабораторий](image-factory-save-distribute-custom-images.md).
