---
title: Запустите фабрику изображений от Azure DevOps в Лабораториях Azure DevTest
description: Эта статья охватывает все приготовления, необходимые для запуска имидж-фабрики от Azure DevOps (ранее Visual Studio Team Services).
services: devtest-lab, lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/24/2020
ms.author: spelluru
ms.openlocfilehash: bb67f765684c77ed5f8527226bef578e450579e0
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76758688"
---
# <a name="run-an-image-factory-from-azure-devops"></a>Запуск фабрики образов из Azure DevOps
Эта статья охватывает все приготовления, необходимые для запуска имидж-фабрики от Azure DevOps (ранее Visual Studio Team Services).

> [!NOTE]
> Любой двигатель оркестровки будет работать! Azure DevOps не является обязательным. Фабрика изображений работает с использованием скриптов Azure PowerShell, поэтому ее можно запустить вручную, используя Windows Task Scheduler, другие системы CI/CD и так далее.

## <a name="create-a-lab-for-the-image-factory"></a>Создание лаборатории для фабрики изображений
Первым шагом в создании фабрики изображений является создание лаборатории в Azure DevTest Labs. Эта лаборатория представляет собой лабораторию фабрики изображений, где мы создаем виртуальные машины и сохраняем пользовательские изображения. Эта лаборатория рассматривается как часть общего процесса фабрики изображений. Как только вы создадите лабораторию, убедитесь, что сохранить имя, так как вы будете нуждаться в нем позже.

## <a name="scripts-and-templates"></a>Сценарии и шаблоны
Следующим шагом в принятии фабрики изображений для вашей команды является понимание того, что доступно. Скрипты и шаблоны фабрики изображений доступны в Открытом доступе в [DevTest Labs GitHub Repo.](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Scripts/ImageFactory) Вот набросок частей:

- Фабрика изображений. Это корневая папка.
    - Настройка. Входы на фабрику изображений
        - GoldenImages. Эта папка содержит файлы JSON, которые представляют определения пользовательских изображений.
        - Labs.json. Файл, где команды зарегистрироваться для получения конкретных пользовательских изображений.
- Сценарии. Двигатель для имидж-фабрики.

В статьях этого раздела содержится более подробная информация об этих сценариях и шаблонах.

## <a name="create-an-azure-devops-team-project"></a>Создание командного проекта Azure DevOps
Azure DevOps позволяет хранить исходный код, запускать Azure PowerShell в одном месте. Вы можете запланировать повторяющиеся запуски, чтобы держать изображения в актуальном состоянии. Есть хорошие возможности для регистрации результатов для диагностики любых проблем.  Однако использование Azure DevOps не является обязательным требованием, вы можете использовать любой ремень/движок, который может подключаться к Azure и запустить Azure PowerShell.

Если у вас есть существующая учетная запись Или проект DevOps, который вы хотели бы использовать вместо этого, пропустите этот шаг.

Чтобы начать работу, создайте бесплатную учетную запись в Azure DevOps. Посетите https://www.visualstudio.com/ и выберите **Получить начало бесплатно** прямо под **Azure DevOps** (ранее VSTS). Вам нужно будет выбрать уникальное имя учетной записи и убедитесь, что управлять кодом с помощью Git. Как только это создается, сохраните URL-адрес в проекте группы. Вот пример URL: `https://<accountname>.visualstudio.com/MyFirstProject`.

## <a name="check-in-the-image-factory-to-git"></a>Зарегистриация на фабрике изображений на Git
Все PowerShell, шаблоны и конфигурация для фабрики изображений расположены в [общедоступном репо DevTest Labs GitHub.](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Scripts/ImageFactory) Самый быстрый способ внести код в новый проект команды — импортировать репозиторий. Это тянет в целом DevTest Labs репозиторий (так что вы получите дополнительные документы, и образцы).

1. Посетите проект Azure DevOps, созданный на предыдущем этапе (URL выглядит как **https:\//\<имя аккаунта>.visualstudio.com/MyFirstProject).**
2. Выберите **Импорт репозиторий**.
3. Введите **URL-адрес клона** для Repo DevTest Labs: `https://github.com/Azure/azure-devtestlab`.
4. Выберите **Импортировать**.

    ![Импорт Git репо](./media/set-up-devops-lab/import-git-repo.png)

Если вы решите проверить только то, что необходимо (файлы фабрики изображений), выполните [здесь](https://www.visualstudio.com/en-us/docs/git/share-your-code-in-git-vs) шаги, чтобы клонировать репо Git и нажать только файлы, расположенные в **каталоге скриптов/ImageFactory.**

## <a name="create-a-build-and-connect-to-azure"></a>Создание сборки и подключение к Azure
На этом этапе исходные файлы хранятся в репо Git в Azure DevOps. Теперь необходимо настроить конвейер для запуска Azure PowerShell. Есть много вариантов, чтобы сделать эти шаги. В этой статье вы используете определение сборки для простоты, но оно работает с DevOps Build, DevOps Release (одиночные или несколько сред), другими движками исполнения, такими как Windows Task Scheduler или любым другим упряжью, который может выполнять Azure PowerShell.

> [!NOTE]
> Один важный момент, чтобы иметь в виду, что некоторые из файлов PowerShell занять много времени, чтобы запустить, когда Есть много (10 ") пользовательских изображений для создания. Бесплатный хостинг DevOps Build / Релиз агентов имеют тайм-аут 30 минут, так что вы не можете использовать бесплатный агент хостинг, как только вы начинаете строить много изображений. Эта задача тайм-аута применима к тому, что вы решили использовать, это хорошо, чтобы проверить заранее, что вы можете продлить типичные тайм-ауты для длительных скриптов Azure PowerShell. В случае Azure DevOps вы можете использовать платных агентов или использовать свой собственный агент сборки.

1. Для начала выберите **Настройка Сборка** на главной странице вашего проекта DevOps:

    ![Кнопка настройки сборки](./media/set-up-devops-lab/setup-build-button.png)
2. Укажите **название** сборки (например: сборка и доставка изображений в DevTest Labs).
3. Выберите **определение пустой** сборки и выберите **Apply** для создания сборки.
4. На этом этапе вы можете выбрать **хостинг** для агента сборки.
5. **Сохранить** определение сборки.

    ![Определение сборки](./media/set-up-devops-lab/build-definition.png)

## <a name="configure-the-build-variables"></a>Настройка переменных сборки
Чтобы упростить параметры командной строки, инкапсулировать ключевые значения, которые приводят фабрику изображений к набору переменных сборки. Выберите вкладку **Переменные,** и вы увидите список нескольких переменных по умолчанию. Вот список переменных, которые можно ввести в Azure DevOps:


| Имя переменной | Значение | Примечания |
| ------------- | ----- | ----- |
| КонфигурацияЛокация | /Скрипты/ImageFactory/Конфигурация | Это полный путь в репозитории к папке **конфигурации.** Если вы импортировали все репо выше, значение слева является правильным. В противном случае обновление, чтобы указать на местоположение конфигурации. |
| DevTestLabName | MyImageFactory | Название лаборатории в Azure DevTest Labs используется в качестве фабрики для создания изображений. Если у вас его нет, создайте его. Убедитесь, что Лаборатория находится в той же подписке, к какой имеет доступ конечная точка службы. |
| ImageRetention | 1 | Количество изображений, которые вы хотите сохранить для каждого типа. Установите значение по умолчанию до 1. |
| MachinePassword | ******* | Встроенный пароль учетной записи для виртуальных машин. Это переходный счет, поэтому убедитесь, что она безопасна. Выберите значок блокировки справа, чтобы убедиться, что это безопасная строка. |
| MachineUserName | ImageFactoryUser | Встроенное имя пользователя учетной записи админ для виртуальных машин. Это переходный счет. |
| СтандартноеTimeoutMinutes | 30 | Тайм-аут мы должны ждать регулярных операций Azure. |
| SubscriptionId |  0000000000-0000-0000-0000-0000000000000 | Идентификатор подписки, в которой существует лаборатория, и конечная точка службы имеет доступ к ней. |
| VMSize | Standard_A3 | Размер виртуальной машины для использования для шага **Create.** Созданные ВМ являются переходными. Размер должен быть [включенным для лаборатории.](devtest-lab-set-lab-policy.md) Подтвердите, что [квоты ядер подписки](../azure-resource-manager/management/azure-subscription-service-limits.md)достаточно.

![Создание переменных](./media/set-up-devops-lab/configure-build-variables.png)

## <a name="connect-to-azure"></a>Подключение к Azure
Следующим шагом является настройка основного обслуживания. Это идентификация в active-каталоге Azure Active, которая позволяет агенту сборки DevOps работать в Azure от имени пользователя. Чтобы настроить его, начните с добавления первого шага Azure PowerShell Build Step.

1. Выберите **Задачу добавления**.
2. Поиск **Azure PowerShell**.
3. Как только вы найдете его, **выберите Добавить,** чтобы добавить задачу в сборку. Когда вы сделаете это, вы увидите, что задача отображается на левой стороне в добавленной стороне.

![Настройка шага PowerShell](./media/set-up-devops-lab/set-up-powershell-step.png)

Самый быстрый способ создать принцип службы — позволить Azure DevOps сделать это за нас.

1. Выберите только что добавленную **задачу.**
2. Для **типа подключения Azure**выберите **менеджер ресурсов Azure.**
3. Выберите ссылку **«Управление»,** чтобы настроить принцип службы.

Для получения дополнительной информации, смотрите этот [блог](https://devblogs.microsoft.com/devops/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management/). При выборе ссылки **«Управление»** вы приземлитесь в нужном месте в DevOps (второй скриншот в сообщении в блоге), чтобы настроить подключение к Azure. При настройке этого момента убедитесь в том, что при настройке нет цели **управления ресурсами Azure.**

## <a name="complete-the-build-task"></a>Выполнить задачу сборки
Если вы выберете задачу сборки, вы увидите все детали на правом стене, которые должны быть заполнены.

1. Во-первых, назовите задачу сборки: **Создайте виртуальные машины.**
2. Выберите **основной службы,** созданный вами, выбрав **менеджер ресурсов Azure**
3. Выберите **конечную точку службы.**
4. Для **сценария Путь**, выберите **... (эллипсис)** справа.
5. Перейдите по сценарию **MakeGoldenImageVMs.ps1.**
6. Параметры сценария должны выглядеть следующим образом:`-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -DevTestLabName $(DevTestLabName) -vmSize $(VMSize) -machineUserName $(MachineUserName) -machinePassword (ConvertTo-SecureString -string '$(MachinePassword)' -AsPlainText -Force) -StandardTimeoutMinutes $(StandardTimeoutMinutes)`

    ![Завершить определение сборки](./media/set-up-devops-lab/complete-build-definition.png)


## <a name="queue-the-build"></a>Очередь сборки
Давайте проверим, что у вас есть все настроены правильно, в очереди до новой сборки. Во время сборки переключитесь на [портал Azure](https://portal.azure.com) и выберите все **виртуальные машины** в лаборатории фабрики изображений, чтобы подтвердить, что все работает правильно. Вы должны увидеть три виртуальные машины создаются в лаборатории.

![ВМ в лаборатории](./media/set-up-devops-lab/vms-in-lab.png)

## <a name="next-steps"></a>Дальнейшие действия
Первый шаг в создании фабрики изображений на базе Azure DevTest Labs завершен. В следующей статье в серии, вы получите эти VMs обобщены и сохранены на пользовательские изображения. Затем, вы их распространение во всех других лабораториях. Смотрите следующую статью в серии: [Сохранить пользовательские изображения и распространять в нескольких лабораториях](image-factory-save-distribute-custom-images.md).
