---
title: Создание фабрики образа в Azure DevTest Labs | Документация Майкрософт
description: Узнайте, как создать фабрику пользовательского образа в Azure DevTest Labs.
services: devtest-lab, lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/25/2019
ms.author: spelluru
ms.openlocfilehash: 48412b3006a462fcc9c77219f42fb41d08f2df61
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60622581"
---
# <a name="create-a-custom-image-factory-in-azure-devtest-labs"></a>Создание фабрики пользовательского образа в Azure DevTest Labs
В этой статье рассматриваются устанавливать политику хранения, очистка фабрики и снятия с учета старые образы из всех других DevTest Labs в организации. 

## <a name="prerequisites"></a>Технические условия
Убедитесь, что вы выполнили эти статьи прежде чем продолжить.

- [Создайте фабрику образов](image-factory-create.md)
- [Запустите фабрику образов из Azure DevOps](image-factory-set-up-devops-lab.md)
- [Сохранение пользовательских образов и распространять в несколько лабораторий](image-factory-save-distribute-custom-images.md)

Следующие элементы уже должны быть выполнены:

- Лаборатории для фабрики образа в Azure DevTest Labs
- Один или несколько целевых Azure DevTest Labs, где фабрика будет распространять эталонные образы
- Проект DevOps Azure, можно автоматизировать фабрики образов.
- Расположение исходного кода, содержащий сценарии и конфигурации (в нашем примере, в том же проекте DevOps, выше)
- Определение сборки для организации задач Azure Powershell
 
## <a name="setting-the-retention-policy"></a>Задание политики хранения
Перед настройкой очистки действия следует определите сколько исторических образы, которые необходимо сохранить в DevTest Labs. Если вы следовали [запустите фабрику образов из Azure DevOps](image-factory-set-up-devops-lab.md) статьи, вы настроили различных переменных сборки. Один из них был **ImageRetention**. Присвойте этой переменной значение `1`, означающее, что DevTest Labs не будет вести журнал пользовательских образов. Только последняя распределенных образы будут доступны. Если изменить эту переменную для `2`, последнюю версию распределенных образа, а также будет поддерживать предыдущие. Можно задать это значение, чтобы определить количество исторических образов, которые нужно сохранить в DevTest Labs.

## <a name="cleaning-up-the-factory"></a>Очистка фабрики
Очистка фабрика первым делом для удаления "Золотая" образов виртуальных машин из образа фабрики. Предлагается сценарий для выполнения этой задачи, как и в предыдущих сценариях. Первым шагом является добавление дополнительного **Azure Powershell** задач в определение сборки, как показано на следующем рисунке:

![Шаг PowerShell](./media/set-retention-policy-cleanup/powershell-step.png)

Получив новую задачу в списке, выберите элемент и заполните все необходимые сведения, как показано на следующем рисунке:

![Старые образы PowerShell задачи очистки](./media/set-retention-policy-cleanup/configure-powershell-task.png)

Параметры сценария: `-DevTestLabName $(devTestLabName)`.

## <a name="retire-old-images"></a>Снятие с учета старые образы 
Эта задача удаляет все старые образы, сохранение только журнал соответствующий **ImageRetention** создания переменной. Добавить дополнительный **Azure Powershell** задачу к нашему определению построения сборки. После его добавления, выберите задачу и заполнять сведения, как показано на следующем рисунке: 

![Прекращение использования старого задачи PowerShell образов](./media/set-retention-policy-cleanup/retire-old-image-task.png)

Используются следующие параметры скрипта. `-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -SubscriptionId $(SubscriptionId) -DevTestLabName $(devTestLabName) -ImagesToSave $(ImageRetention)`

## <a name="queue-the-build"></a>Поместите сборку в очередь
Теперь, когда вы выполнили определение сборки, поставить новую сборку, чтобы убедиться в том, что все работает. После успешного завершения сборки новых пользовательских образов, отображаемые в целевой лабораторной среде и при проверке лаборатории фабрики образ, можно увидеть нет подготовленных виртуальных машин. Кроме того, если поставить в очередь дальнейших построений, вы увидите задачи очистки, прекращение использования старого пользовательских образов из DevTest Labs в соответствии для хранения значения, заданного в переменных сборки.

> [!NOTE]
> Если вы выполнили конвейер сборки, в конце последней статьи в серии, необходимо вручную удалите виртуальные машины, которые были созданы в лаборатории фабрики образ перед постановки новой сборки.  Ручная очистка шаг требуется только в том случае, пока мы все настройки и убедитесь, что он работает.



## <a name="summary"></a>Сводка
Теперь у вас есть работающей образа фабрику, можно создавать и доставлять пользовательских образов для своей лаборатории по запросу. На этом этапе, он просто получения изображений настроен правильно и определение целевой labs. Как упоминалось в предыдущей статье **Labs.json** файла, расположенного в вашей **конфигурации** папку указывает, какие образы должны быть доступны в каждом из целевых labs. При добавлении других DevTest Labs для вашей организации, нужно просто добавить запись в Labs.json для новой лабораторной среде.

Добавление нового образа с фабрикой также выполняется очень просто. Если вы хотите включить новый образ в фабрике открытии [портала Azure](https://portal.azure.com), перейдите к своей фабрике DevTest Labs, нажмите кнопку, чтобы добавить виртуальную Машину и выберите нужный marketplace изображение и артефакты. Вместо выбора **создать** кнопку, чтобы создать новую виртуальную Машину, выберите **шаблон View Azure Resource Manager**"и сохраните шаблон в виде JSON-файлу, где-нибудь в **GoldenImages** папки в репозитории. Далее при запуске фабрикой образ будет создан пользовательский образ.


## <a name="next-steps"></a>Дальнейшие действия
1. [Планировать сборки или выпуска](/azure/devops/pipelines/build/triggers?view=azure-devops&tabs=designer) периодический запуск фабрики образов. Он обновляет ваш образов, созданных с помощью фабрики на регулярной основе.
2. Сделать дополнительные эталонные образы для фабрики. Также можно рассмотреть [создании артефактов](devtest-lab-artifact-author.md) сценариев дополнительных элемента задачи настройки виртуальной Машины и включить в него артефакты в изображениях фабрики.
4. Создание [отдельные сборки или выпуска](/azure/devops/pipelines/overview?view=azure-devops-2019) для запуска **DistributeImages** скрипт отдельно. Этот сценарий можно запустить, если вы вносите изменения для Labs.json и получить образы, скопировать labs целевой без повторного создания всех образов, еще раз.

