---
title: Настройка политики удержания в Лабораториях Azure DevTest (ru) Документы Майкрософт
description: Узнайте, как настроить политику удержания, очистить фабрику и удалить старые изображения из DevTest Labs.
services: devtest-lab, lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/24/2020
ms.author: spelluru
ms.openlocfilehash: a472c500ee6b968b1459e65e49a352b81e5ea6ec
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76759420"
---
# <a name="set-up-retention-policy-in-azure-devtest-labs"></a>Настройка политики удержания в Лабораториях Azure DevTest
В этой статье описывается настройка политики удержания, очистка фабрики и выбывание старых изображений из всех других лабораторий DevTest в организации. 

## <a name="prerequisites"></a>Предварительные требования
Убедитесь, что вы следовали этим статьям, прежде чем продолжить:

- [Создание фабрики образов](image-factory-create.md)
- [Запуск фабрики образов из Azure DevOps](image-factory-set-up-devops-lab.md)
- [Сохранение пользовательских изображений и распространение в нескольких лабораториях](image-factory-save-distribute-custom-images.md)

Следующие элементы уже должны быть на месте:

- Лаборатория для фабрики изображений в Azure DevTest Labs
- Одна или несколько целевых Azure DevTest Labs, где завод будет распространять золотые изображения
- Проект Azure DevOps, используемый для автоматизации фабрики изображений.
- Местоположение исходного кода, содержащее скрипты и конфигурацию (в нашем примере, в том же проекте DevOps, используемом выше)
- Определение сборки для организации задач Azure Powershell
 
## <a name="setting-the-retention-policy"></a>Настройка политики удержания
Прежде чем настроить шаги очистки, определите, сколько исторических изображений вы хотите сохранить в DevTest Labs. Когда вы следили за [фабрикой изображений Run из статьи Azure DevOps,](image-factory-set-up-devops-lab.md) вы настраивали различные переменные сборки. Одним из них было **ImageRetention**. Вы устанавливаете `1`эту переменную на , что означает, что DevTest Labs не будет поддерживать историю пользовательских изображений. Будут доступны только самые последние распределенные изображения. Если вы измените `2`эту переменную на, последнее распределенное изображение плюс предыдущие будут сохранены. Вы можете установить это значение, чтобы определить количество исторических изображений, которые вы хотите сохранить в your DevTest Labs.

## <a name="cleaning-up-the-factory"></a>Очистка завода
Первым шагом в очистке завода является удаление золотых изображений VMs с изображения завода. Существует сценарий, чтобы сделать эту задачу так же, как наши предыдущие сценарии. Первым шагом является добавление еще одной задачи **Azure Powershell** в определение сборки, как показано на следующем изображении:

![Шаг PowerShell](./media/set-retention-policy-cleanup/powershell-step.png)

Если у вас есть новая задача в списке, выберите элемент, и заполнить все детали, как показано на следующем изображении:

![Очистка старых изображений PowerShell задача](./media/set-retention-policy-cleanup/configure-powershell-task.png)

Параметры сценария: `-DevTestLabName $(devTestLabName)`.

## <a name="retire-old-images"></a>Удалить старые изображения 
Эта задача удаляет все старые изображения, сохраняя только историю, соответствующую переменной сборки **ImageRetention.** Добавьте дополнительную задачу сборки **Azure Powershell** в наше определение сборки. После добавления выберите задачу и заполните детали, указанные на следующем изображении: 

![Удалить старые изображения PowerShell задача](./media/set-retention-policy-cleanup/retire-old-image-task.png)

Параметры сценария:`-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -SubscriptionId $(SubscriptionId) -DevTestLabName $(devTestLabName) -ImagesToSave $(ImageRetention)`

## <a name="queue-the-build"></a>Очередь сборки
Теперь, когда вы завершили определение сборки, выстраивайте в очередь новую сборку, чтобы убедиться, что все работает. После успешного завершения сборки новые пользовательские изображения отображаются в лаборатории назначения, и если вы проверите лабораторию фабрики изображений, вы не увидите никаких подготовленных VMs. Кроме того, если вы выстраиваете в очередь дополнительные сборки, вы увидите задачи очистки, выходящие из старых пользовательских изображений из DevTest Labs в соответствии с значением удержания, установленным в переменных сборки.

> [!NOTE]
> Если вы выполнили конвейер сборки в конце последней статьи серии, вручную удалите виртуальные машины, которые были созданы в лаборатории фабрики изображений, прежде чем стоять в очереди за новой сборкой.  Шаг ручной очистки необходим только в то время как мы устанавливаем все и проверяем, что он работает.



## <a name="summary"></a>Сводка
Теперь у вас есть работаная фабрика изображений, которая может создавать и распространять пользовательские изображения в ваших лабораториях по требованию. На данный момент, это просто вопрос получения изображения настроены должным образом и выявления целевых лабораторий. Как упоминалось в предыдущей статье, файл **Labs.json,** расположенный в папке **Конфигурации,** определяет, какие изображения должны быть доступны в каждой из целевых лабораторий. При добавлении других лабораторий DevTest в вашу организацию, вам просто нужно добавить запись в Labs.json для новой лаборатории.

Добавление нового изображения на фабрику также просто. Если вы хотите включить новое изображение в фабрике, вы открываете [портал Azure,](https://portal.azure.com)перейдите на ваш завод DevTest Labs, выберите кнопку, чтобы добавить VM, и выберите желаемое изображение и артефакты рынка. Вместо того, чтобы выбрать кнопку **«Создание»** для создания нового VM, выберите **шаблон управления ресурсами Azure**Испуноватой и сохраните шаблон в виде файла .json где-то в папке **GoldenImages** в репозитории. В следующий раз, когда вы запустите свою фабрику изображений, он создаст ваш пользовательский образ.


## <a name="next-steps"></a>Дальнейшие действия
1. [Запланируйте сборку/выпуск](/azure/devops/pipelines/build/triggers?view=azure-devops&tabs=designer) для периодическиго запуска фабрики изображений. Он обновляет ваши заводские изображения на регулярной основе.
2. Сделайте больше золотых изображений для вашей фабрики. Вы также можете рассмотреть возможность [создания артефактов](devtest-lab-artifact-author.md) для создания дополнительных частей ваших задач установки VM и включения артефактов в изображения фабрики.
4. Создайте [отдельную сборку/релиз](/azure/devops/pipelines/overview?view=azure-devops-2019) для отдельного выполнения сценария **DistributeImages.** Вы можете запустить этот скрипт, когда вносишь изменения в Labs.json, и получать изображения, скопированные в целевые лаборатории без необходимости повторно госсоздавать все изображения.

