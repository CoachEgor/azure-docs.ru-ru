---
title: Налаживание лаборатории для использования удаленного шлюза для рабочего стола в Лабораториях Azure DevTest
description: Узнайте, как настроить лабораторию в Azure DevTest Labs с удаленным шлюзом рабочего стола, чтобы обеспечить безопасный доступ к лабораторным вмм при удалении порта RDP.
services: devtest-lab,virtual-machines,lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/16/2020
ms.author: spelluru
ms.openlocfilehash: 88daecdf4490ffd4eef45e6cd664a16f86bad113
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76170289"
---
# <a name="configure-your-lab-in-azure-devtest-labs-to-use-a-remote-desktop-gateway"></a>Налажить свою лабораторию в Azure DevTest Labs, чтобы использовать удаленный шлюз рабочего стола
В Azure DevTest Labs можно настроить удаленный шлюз рабочего стола для вашей лаборатории, чтобы обеспечить безопасный доступ к лабораторным виртуальным машинам (VMs) без необходимости подвергать воздействию порта RDP. Лаборатория предоставляет центральное место для просмотра и подключения пользователей лаборатории ко всем виртуальным машинам, к которые они имеют доступ. Кнопка **подключения** на странице **Виртуальной машины** создает специальный файл RDP, который можно открыть для подключения к машине. Вы можете дополнительно настроить и обезопасить rdP соединение, подключив лабораторию к удаленному шлюзу рабочего стола. 

Этот подход является более безопасным, поскольку пользователь лаборатории проверяет подлинность непосредственно на шлюзе или может использовать учетные данные компании на кондитивизм, подключенный к устройству, подключенной к их машинам. Лаборатория также поддерживает использование маркера аутентификации к шлюзу машины, которая позволяет пользователям подключиться к их лаборатории виртуальных машин без порта RDP подвергаются интернет. В этой статье приводится пример того, как создать лабораторию, используюую аутентификацию маркеров для подключения к лабораторным машинам.

## <a name="architecture-of-the-solution"></a>Архитектура решения

![Архитектура решения](./media/configure-lab-remote-desktop-gateway/architecture.png)

1. Действие [содержимого файла Get RDP](/rest/api/dtl/virtualmachines/getrdpfilecontents) вызывается при выборе кнопки **Connect.1.** 
1. Действие по содержимому файла `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` Get RDP вызывает запрос токен проверки подлинности.
    1. `{gateway-hostname}`— это имя хоста шлюза, указанное на странице **«Настройки лаборатории»** для вашей лаборатории на портале Azure. 
    1. `{lab-machine-name}`это имя машины, которую вы пытаетесь подключить.
    1. `{port-number}`это порт, на котором соединение должно быть сделано. Обычно этот порт 3389. Если лаборатория VM использует [общую](devtest-lab-shared-ip.md) функцию IP в DevTest Labs, порт будет другим.
1. Удаленный шлюз рабочего `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` стола откладывает вызов от функции Azure для создания маркера проверки подлинности. Служба DevTest Labs автоматически включает ключ функции в заголовок запроса. Ключ функции должен быть сохранен в хранилище ключей лаборатории. Название этого секрета будет отображаться в качестве **токена Gateway** на странице **"Настройки лаборатории"** для лаборатории.
1. Ожидается, что функция Azure вернет маркер для проверки токенов на основе сертификатов против машины шлюза.  
1. Затем действие по содержимому файла Get RDP возвращает полный файл RDP, включая информацию о проверке подлинности.
1. Вы открываете файл RDP, используя предпочтительную программу подключения RDP. Помните, что не все программы подключения RDP поддерживают аутентификацию маркеров. У маркера проверки подлинности есть срок действия, установленный приложением функции. Сделайте подключение к лаборатории VM до истечения срока действия токена.
1. После того, как пульт дистанционного управления шлюзом проверяет подлинность маркера в файле RDP, соединение пересылается на лабораторную машину.

### <a name="solution-requirements"></a>Требования к решению
Для работы с функцией проверки подлинности маркеров DevTest Labs существует несколько требований конфигурации для шлюзов, служб доменных имен (DNS) и функций.

### <a name="requirements-for-remote-desktop-gateway-machines"></a>Требования к удаленным настольным шлюзам
- Сертификат SSL должен быть установлен на шлюзе для обработки трафика HTTPS. Сертификат должен соответствовать полностью квалифицированного доменного имени (ФЗДН) балансопарка нагрузки для фермы шлюзов или ФЗН самой машины, если есть только одна машина. Сертификаты SSL wild-card не работают.  
- Сертификат подписи, установленный на шлюзе машины (ы). Создайте сертификат подписи с помощью сценария [Create-SigningCertificate.ps1.](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Create-SigningCertificate.ps1)
- Установите модуль [Pluggable Authentication,](https://code.msdn.microsoft.com/windowsdesktop/Remote-Desktop-Gateway-517d6273) поддерживающий аутентификацию маркеров для удаленного шлюза рабочего стола. Одним из примеров `RDGatewayFedAuth.msi` такого модуля является то, что поставляется с [Системным центром Виртуальный менеджер машины (VMM) изображения.](/system-center/vmm/install-console?view=sc-vmm-1807) Для получения дополнительной информации о "Системный [центр"](https://docs.microsoft.com/system-center/) см. [pricing details](https://www.microsoft.com/cloud-platform/system-center-pricing)  
- Сервер шлюза может `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}`обрабатывать запросы, сделанные на .

    Шлюз-хост является F-DN балансиста нагрузки шлюза фермы или F-DN самой машины, если есть только одна машина. Это `{lab-machine-name}` название лабораторной машины, которую вы пытаетесь подключить, и `{port-number}` порт, на котором будет сделано соединение.  По умолчанию этот порт раподративного значения 3389.  Однако, если виртуальная машина использует [общую](devtest-lab-shared-ip.md) функцию IP в DevTest Labs, порт будет другим.
- Модуль [запроса на обработку приложений](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) для Интернет-информационного сервера (IIS) может быть использован для перенаправления `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` запросов на функцию azure, которая обрабатывает запрос на получение маркера для проверки подлинности.


## <a name="requirements-for-azure-function"></a>Требования к функции Azure
Функция Azure обрабатывает запрос `https://{function-app-uri}/app/host/{lab-machine-name}/port/{port-number}` с форматом и возвращает токен аутентификации на основе того же сертификата подписи, установленного на шлюзовых машинах. Является `{function-app-uri}` uri используется для доступа к функции. Ключ функции автоматически передается в заголовке запроса. Для функции образца см. [https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/src/RDGatewayAPI/Functions/CreateToken.cs](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/src/RDGatewayAPI/Functions/CreateToken.cs) 


## <a name="requirements-for-network"></a>Требования к сети

- DNS для F-DN, связанный с сертификатом SSL, установленным на шлюзовом, должен направлять трафик на шлюз-машину или балансоровую нагрузку на ферму шлюзов.
- Если лабораторная машина использует частные IPs, должен быть сетевой путь от шлюза машины к лабораторной машине, либо путем совместного использования той же виртуальной сети или с помощью заглянул виртуальных сетей.

## <a name="configure-the-lab-to-use-token-authentication"></a>Настройка лаборатории для использования аутентификации маркеров 
В этом разделе показано, как настроить лабораторию для использования удаленного настольного шлюза, поддерживающего аутентификацию маркеров. В этом разделе не говорится о том, как настроить саму ферму шлюзов удаленного рабочего стола. Для получения этой информации, [См. Образец для создания удаленного раздела шлюза рабочего стола](#sample-to-create-a-remote-desktop-gateway) в конце этой статьи. 

Перед обновлением параметров лаборатории храните ключ, необходимый для успешного выполнения функции, чтобы вернуть маркер аутентификации в хранилище ключей лаборатории. Значение ключа функции можно получить на странице **Управления** для функции на портале Azure. Для получения дополнительной информации о том, как сохранить секрет в хранилище ключей, [см.](../key-vault/quick-create-portal.md#add-a-secret-to-key-vault) Сохранить название секрета для последующего использования.

Чтобы найти идентификатор хранилища ключей лаборатории, запустите следующую команду Azure CLI: 

```azurecli
az resource show --name {lab-name} --resource-type 'Microsoft.DevTestLab/labs' --resource-group {lab-resource-group-name} --query properties.vaultName
```

Нанастройка лаборатории с помощью аутентификации маркеров с помощью следующих шагов:

1. Войдите на [портал Azure](https://portal.azure.com).
1. Щелкните **Все службы** и выберите в списке **DevTest Labs**.
1. Из списка лабораторий выберите **лабораторию.**
1. На странице лаборатории выберите **Конфигурацию и политики.**
1. В левом меню, в разделе **Настройки,** выберите **настройки лаборатории.**
1. В разделе **Удаленного рабочего стола** введите полностью квалифицированное доменное имя (ФЗДН) или IP-адрес шлюза удаленного рабочего стола или фермы для поля **хоста Gateway.** Это значение должно соответствовать сертификату SSL, используемому на шлюзах.

    ![Удаленные параметры рабочего стола в лабораторных настройках](./media/configure-lab-remote-desktop-gateway/remote-desktop-options-in-lab-settings.png)
1. В разделе **Удаленного рабочего стола,** для **секрета маркера Gateway,** введите название секрета, созданного ранее. Это значение не является самим функциональным ключом, а названием секрета в хранилищеключа ключа лаборатории, в мещавем ключе функции.

    ![Секрет токена шлюза в лабораторных условиях](./media/configure-lab-remote-desktop-gateway/gateway-token-secret.png)
1. **Сохранить** Изменения.

    > [!NOTE] 
    > Нажав **сохранить**, вы соглашаетесь на [условия лицензии удаленного рабочего стола шлюза](https://www.microsoft.com/licensing/product-licensing/products). Для получения дополнительной информации об удаленном шлюзе [см. Добро пожаловать в службы удаленного рабочего стола](https://aka.ms/rds) и развертывание [удаленной среды рабочего стола.](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure)


Если настройка лаборатории с помощью автоматизации предпочтительнее, см. [Set-DevTestLabGateway.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Set-DevTestLabGateway.ps1) для образца сценария PowerShell для установки секретных настроек **хоста шлюза** и **токенов шлюза.** [Репозиторий Azure DevTest Labs GitHub](https://github.com/Azure/azure-devtestlab) также предоставляет шаблон Менеджера ресурсов Azure, который создает или обновляет лабораторию с секретными настройками **хоста шлюза** и **маркером шлюза.**

## <a name="configure-network-security-group"></a>Настройка группы сетевой безопасности
Для дальнейшей защиты лаборатории в виртуальную сеть, используемую лабораторными виртуальными машинами, может быть добавлена группа сетевой безопасности (NSG). Для инструкций по настройке NSG [см. Создать, изменить или удалить группу сетевой безопасности.](../virtual-network/manage-network-security-group.md)

Вот пример NSG, который позволяет трафик, который сначала проходит через шлюз для достижения лабораторных машин. Источником этого правила является IP-адрес одной машины шлюза или IP-адрес балансирутеля нагрузки перед шлюзом.

![Группа сетевой безопасности - правила](./media/configure-lab-remote-desktop-gateway/network-security-group-rules.png)

## <a name="sample-to-create-a-remote-desktop-gateway"></a>Пример для создания удаленного шлюза рабочего стола

> [!NOTE] 
> Используя шаблоны образца, вы соглашаетесь на [условия лицензии Remote Desktop Gateway.](https://www.microsoft.com/licensing/product-licensing/products) Для получения дополнительной информации об удаленном шлюзе [см. Добро пожаловать в службы удаленного рабочего стола](https://aka.ms/rds) и развертывание [удаленной среды рабочего стола.](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure)

[В репозитории Azure DevTest Labs GitHub](https://github.com/Azure/azure-devtestlab) представлено несколько образцов, которые помогут настроить ресурсы, необходимые для использования аутентификации токенов и удаленного шлюза рабочего стола с DevTest Labs. Эти примеры включают шаблоны Azure Resource Manager для машин шлюза, лабораторных настроек и функциональных приложений.

Выполните следующие действия, чтобы настроить выборочное решение для удаленной фермы шлюзов для настольных компьютеров.

1. Создайте сертификат подписи.  Выполнить [Создать-SigningCertificate.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Create-SigningCertificate.ps1). Сохраните отпечаток пальца, пароль и кодирование созданного сертификата Base64.
2. Получите SSL-сертификат. ФЗДН, связанный с сертификатом SSL, должен быть для домена, который вы контролируете. Сохраните отпечаток пальца, пароль и кодирование Base64 для этого сертификата. Чтобы получить отпечаток пальца с помощью PowerShell, используйте следующие команды.

    ```powershell
    $cer = New-Object System.Security.Cryptography.X509Certificates.X509Certificate;
    $cer.Import(‘path-to-certificate’);
    $hash = $cer.GetCertHashString()
    ```

    Чтобы получить кодирование Base64 с помощью PowerShell, используйте следующую команду.

    ```powershell
    [System.Convert]::ToBase64String([System.IO.File]::ReadAllBytes(‘path-to-certificate’))
    ```
3. Скачать [https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway)файлы из .

    Шаблон требует доступа к нескольким другим шаблонам менеджера ресурсов и связанным с ними ресурсам в той же базе URI. Копируйте все [https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/arm/gateway](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/arm/gateway) файлы из и RDGatewayFedAuth.msi в контейнер капли в учетной записи хранения.  
4. Развертывание **azuredeploy.json** от [https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway). Шаблон принимает следующие параметры:
    - adminUsername - Требуется.  Имя пользователя администратора для шлюзов.
    - adminPassword - Требуется. Пароль для учетной записи администратора для шлюзов.
    - instanceCount - Количество шлюзов для создания.  
    - alwaysOn - указывает, следует ли поддерживать созданное приложение Azure Functions в теплом состоянии или нет. Сохранение приложения Azure Functions позволит избежать задержек при первой попытке пользователей подключиться к своей лаборатории VM, но это имеет последствия с точки зрения затрат.  
    - tokenLifetime - Продолжительность времени, созданного маркера, будет действительным. Формат HH:MM:SS.
    - sslCertificate - Кодирование сертификата SSL Base64 для шлюза.
    - sslCertificatePassword - Пароль SSL-сертификата для шлюза.
    - sslCertificateThumbprint - Отпечаток пальца сертификата для идентификации в местном магазине сертификатов SSL.
    - signCertificate - Кодирование Base64 для подписания сертификата для шлюза машины.
    - signCertificatePassword - Пароль для подписания сертификата для шлюза.
    - signCertificateThumbprint - Отпечаток пальца сертификата для идентификации в местном магазине сертификатов сертификата.
    - _artifactsLocation - URI место, где все вспомогательные ресурсы могут быть найдены. Это значение должно быть полностью квалифицированным UIR, а не относительным путем.
    - _artifactsLocationSasToken — токен общей подписи доступа (SAS), используемый для доступа к ресурсам поддержки, если это местоположение является учетной записью хранения Azure.

    Шаблон можно развертывать с помощью Azure CLI с помощью следующей команды:

    ```azurecli
    az group deployment create --resource-group {resource-group} --template-file azuredeploy.json --parameters @azuredeploy.parameters.json -–parameters _artifactsLocation="{storage-account-endpoint}/{container-name}" -–parameters _artifactsLocationSasToken = "?{sas-token}"
    ```

    Вот описания параметров:

    - «Конечная точка хранения-счета» может быть `az storage account show --name {storage-acct-name} --query primaryEndpoints.blob`получена путем выполнения .  «Хранение-акт-имя» — это имя учетной записи хранилища, в мещавх которого хранятся загружаемые вами файлы.  
    - «Контейнерное имя» — это имя контейнера в «хранилище-акт-имя», в которое содержится загружаемые файлы.  
    - «sas-токен» можно получить, запустив. `az storage container generate-sas --name {container-name} --account-name {storage-acct-name} --https-only –permissions drlw –expiry {utc-expiration-date}` 
        - «Хранение-акт-имя» — это имя учетной записи хранилища, в мещавх которого хранятся загружаемые вами файлы.  
        - «Контейнерное имя» — это имя контейнера в «хранилище-акт-имя», в которое содержится загружаемые файлы.  
        - Дата окончания срока действия «utc» — это дата, в UTC, на которой истечет срок действия токена SAS, и токен SAS больше не может использоваться для доступа к учетной записи хранилища.

    Запись значений для gatewayF-DN и gatewayIP из вывода развертывания шаблонов. Вам также необходимо сохранить значение ключа функции для вновь созданной функции, которое можно найти во вкладке [настройки приложения Функции.](../azure-functions/functions-how-to-use-azure-function-app-settings.md)
5. Назначьте DNS таким образом, чтобы F-DN sSL cert направлялся на IP-адрес gatewayIP с предыдущего шага.

    После создания фермы Remote Desktop Gateway и создания соответствующих обновлений DNS, она готова к использованию в лаборатории DevTest Labs. **Разъем хоста шлюза** и секретные настройки **маркера шлюза** должны быть настроены для использования развернутой вами машины шлюза. 

    > [!NOTE]
    > Если лабораторная машина использует частные IPs, должен быть сетевой путь от шлюза машины к лабораторной машине, либо путем совместного использования той же виртуальной сети или с помощью заглянул виртуальной сети.

    После настройки шлюза и лаборатории файл соединения, созданный при нажатии на **Connect,** автоматически включает информацию, необходимую для подключения с помощью аутентификации маркеров.     

## <a name="next-steps"></a>Дальнейшие действия
Подробнее о службах удаленного рабочего стола: [документация удаленных настольных служб: документация удаленного рабочего стола:](/windows-server/remote/remote-desktop-services/Welcome-to-rds)


