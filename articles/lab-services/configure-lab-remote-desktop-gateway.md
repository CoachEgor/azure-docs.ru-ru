---
title: Настройка лаборатории для использования шлюза удаленных рабочих столов в Azure DevTest Labs | Документация Майкрософт
description: Узнайте, как настроить лабораторию в Azure DevTest Labs с помощью шлюза удаленных рабочих столов для обеспечения безопасного доступа к виртуальным машинам лаборатории без предоставления порт протокола удаленного рабочего СТОЛА.
services: devtest-lab,virtual-machines,lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/25/2019
ms.author: spelluru
ms.openlocfilehash: 430734878c01d10a4e7dd385dc75d8d502a2d82c
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67079006"
---
# <a name="configure-your-lab-in-azure-devtest-labs-to-use-a-remote-desktop-gateway"></a>Настройка лаборатории в Azure DevTest Labs для использования шлюза удаленных рабочих столов
В Azure DevTest Labs можно настроить шлюз удаленных рабочих столов для лаборатории для обеспечения безопасного доступа к лаборатории виртуальных машин (ВМ) без предоставления порт протокола удаленного рабочего СТОЛА. Лаборатории предоставляет центральное расположение для пользователей для просмотра и подключения ко всем виртуальным машинам, которые у них есть доступ к лаборатории. **Connect** кнопку **виртуальной машины** страница создает файл протокола удаленного рабочего СТОЛА конкретного компьютера, который можно открыть, чтобы подключиться к компьютеру. Дополнительно можно настроить и защитить подключение удаленного рабочего СТОЛА, подключение лаборатории к шлюза удаленных рабочих столов. 

Этот подход является более безопасным, так как пользователь лаборатории выполняет проверку подлинности непосредственно к компьютеру шлюза можно использовать корпоративные учетные данные на компьютере, присоединенном к домену шлюза для подключения к виртуальные машины. Лаборатории также поддерживает использование аутентификации на основе маркеров для компьютера шлюза, который позволяет пользователям подключаться к их виртуальных машин лаборатории, без необходимости порт RDP доступен из Интернета. В этой статье рассматривается пример о том, как настроить лабораторию с помощью токена проверки подлинности для подключения к машинам лаборатории.

## <a name="architecture-of-the-solution"></a>Архитектура решения

![Архитектура решения](./media/configure-lab-remote-desktop-gateway/architecture.png)

1. [Оглавление получить RDP-файла](/rest/api/dtl/virtualmachines/getrdpfilecontents) действие вызывается, когда вы выбираете **Connect** button.1. 
1. Вызывает действие содержимое файла RDP, получить `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` для запроса маркера проверки подлинности.
    1. `{gateway-hostname}` — Имя узла шлюза, указанные на **параметры лаборатории** страницы для лаборатории на портале Azure. 
    1. `{lab-machine-name}` — Имя компьютера, на котором вы пытаетесь подключиться.
    1. `{port-number}` — порт, на котором должен выполняться подключение. Обычно этой цели используется порт 3389. Если виртуальная машина лаборатории использует [общих IP-адрес](devtest-lab-shared-ip.md) функция в DevTest Labs, порт будет отличаться.
1. Шлюз удаленных рабочих столов задерживает вызов из `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` для функции Azure для создания токена проверки подлинности. Служба DevTest Labs автоматически включает ключ функции в заголовке запроса. Ключ функции — должен быть сохранен в хранилище ключей в лаборатории. Имя для этого секрета, отображаются как **секрет маркера шлюза** на **параметры лаборатории** страницы для лаборатории.
1. Функции Azure должен вернуть маркер для на основе сертификатов проверки подлинности маркера с компьютера шлюза.  
1. Получение RDP-файл, содержимое действия, а затем возвращает полный файл протокола удаленного рабочего СТОЛА, включая сведения о проверке подлинности.
1. Можно открыть RDP-файл, используя предпочитаемый программы подключения удаленного рабочего СТОЛА. Помните, что не все программы подключения удаленного рабочего СТОЛА поддерживает аутентификацию на основе маркеров. Маркер проверки подлинности иметь ограниченный срок, задано с помощью приложения-функции. Установите подключение к лабораторной виртуальной Машины до истечения срока действия маркера.
1. Компьютер шлюза удаленных рабочих столов проверяет токен в RDP-файл, соединение будет передаваться на тестовый компьютер.

### <a name="solution-requirements"></a>Требования к решению
Для работы с функцией проверки подлинности маркера DevTest Labs, существует несколько требований к конфигурации для машины шлюза, службы доменных имен (DNS) и функций.

### <a name="requirements-for-remote-desktop-gateway-machines"></a>Требования для шлюза удаленных рабочих столов машин
- SSL-сертификат должен быть установлен на компьютере шлюза для обработки трафика HTTPS. Сертификат должен соответствовать полное доменное имя (FQDN) подсистемы балансировки нагрузки для фермы шлюза или полное ДОМЕННОЕ имя и самой виртуальной машине, если имеется только один компьютер. Групповые сертификаты SSL не работают.  
- Сертификат подписи, установить на компьютеры шлюза. Создайте сертификат для подписи с помощью [SigningCertificate.ps1 создать](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Create-SigningCertificate.ps1) скрипта.
- Установка [подключаемые проверки подлинности](https://code.msdn.microsoft.com/windowsdesktop/Remote-Desktop-Gateway-517d6273) модуль, который поддерживает аутентификацию на основе маркеров для шлюза удаленных рабочих столов. Одним из примеров такого модуля является `RDGatewayFedAuth.msi` , который поставляется вместе с [образы System Center Virtual Machine Manager (VMM)](/system-center/vmm/install-console?view=sc-vmm-1807). Дополнительные сведения о System Center, см. в разделе [документация по System Center](https://docs.microsoft.com/system-center/) и [сведения о ценах на](https://www.microsoft.com/cloud-platform/system-center-pricing).  
- Сервер шлюза может обрабатывать запросы к `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}`.

    Имя узла шлюза является полное ДОМЕННОЕ имя подсистемы балансировки нагрузки фермы шлюза или полное ДОМЕННОЕ имя компьютера, если имеется только одна машина. `{lab-machine-name}` Имя лабораторного компьютера, на котором вы пытаетесь подключиться, и `{port-number}` — это порт, на котором выполняется подключение.  По умолчанию используется этот порт 3389.  Тем не менее если виртуальная машина использует [общих IP-адрес](devtest-lab-shared-ip.md) функция в DevTest Labs, порт будет отличаться.
- [Маршрутизации запросов приложений](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) модуль Internet Information Server (IIS) можно использовать для перенаправления `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` запросы на функции azure, который обрабатывает запрос на получение маркера для проверки подлинности.


## <a name="requirements-for-azure-function"></a>Требования для функции Azure
Функции Azure обрабатывает запрос с форматом `https://{function-app-uri}/app/host/{lab-machine-name}/port/{port-number}` и возвращает маркер проверки подлинности, основанный на том же подписи сертификата, установленного на машинах шлюза. `{function-app-uri}` Является uri, используемый для доступа к функции. Ключ функции передается автоматически в заголовке запроса. Пример функции, см. в разделе [ https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/src/RDGatewayAPI/Functions/CreateToken.cs ](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/src/RDGatewayAPI/Functions/CreateToken.cs). 


## <a name="requirements-for-network"></a>Требования к сети

- DNS для полного доменного ИМЕНИ, связанных с SSL-сертификат установлен на компьютерах шлюз должен направлять трафик на компьютере шлюза или подсистемы балансировки нагрузки фермы компьютера шлюза.
- Если на машине лаборатории используются частные IP-адреса, должен являться путем сети с компьютера шлюза к машине лаборатории, через общий доступ к той же виртуальной сети или с помощью таких виртуальных сетях.

## <a name="configure-the-lab-to-use-token-authentication"></a>Настройка лаборатории для использования аутентификации на основе маркеров 
В этом разделе показано, как настроить лабораторию для использования шлюза удаленных рабочих столов компьютере, который поддерживает аутентификацию на основе маркеров. В этом разделе не рассматривается настройка самой фермы шлюза удаленных рабочих столов. Дополнительные сведения см. в разделе [образец для создания шлюза удаленных рабочих столов](#sample-to-create-a-remote-desktop-gateway) в конце этой статьи. 

Перед обновлением параметры лаборатории, сохраните ключ, необходимые для успешного выполнения функция возвращает маркер проверки подлинности в хранилище ключей в лаборатории. Значение ключа функции можно получить **управление** страницы для функции на портале Azure. Дополнительные сведения о том, как сохранить секрет в хранилище ключей см. в разделе [Добавление секрета в Key Vault](../key-vault/quick-create-portal.md#add-a-secret-to-key-vault). Сохраните имя секрета для последующего использования.

Чтобы найти идентификатор хранилища ключей лаборатории, выполните следующую команду Azure CLI: 

```azurecli
az resource show --name {lab-name} --resource-type 'Microsoft.DevTestLab/labs' --resource-group {lab-resource-group-name} --query properties.vaultName
```

Настройка лаборатории для использования проверки подлинности маркера, выполнив следующие действия:

1. Войдите на [портале Azure](https://portal.azure.com).
1. Щелкните **Все службы** и выберите в списке **DevTest Labs**.
1. Из списка лабораторий выберите ваш **лаборатории**.
1. На странице лаборатории выберите **конфигурация и политики**.
1. В меню слева в **параметры** выберите **параметры лаборатории**.
1. В **удаленного рабочего стола** раздел, введите полное доменное имя (FQDN) или IP-адрес компьютера шлюза удаленных рабочих столов или фермы для **имя узла шлюза** поля. Это значение должно соответствовать полное ДОМЕННОЕ имя SSL-сертификат, используемый на машинах шлюза.

    ![Параметры удаленного рабочего стола в параметры лаборатории](./media/configure-lab-remote-desktop-gateway/remote-desktop-options-in-lab-settings.png)
1. В **удаленного рабочего стола** разделе для **токен шлюза** секрет, введите имя секрета, созданного ранее. Это значение не сам ключ функции, а имя секрета в хранилище ключей лаборатории, которая содержит ключ функции.

    ![Секрет маркера шлюза в параметрах лаборатории](./media/configure-lab-remote-desktop-gateway/gateway-token-secret.png)
1. **Сохранить** изменения.

    > [!NOTE] 
    > Щелкнув **Сохранить**, вы соглашаетесь с [условия лицензионного соглашения на шлюз удаленных рабочих столов в](https://www.microsoft.com/licensing/product-licensing/products). Дополнительные сведения о удаленного шлюза, см. в разделе [Добро пожаловать в службы удаленных рабочих столов](https://aka.ms/rds) и [развертывание среды удаленного рабочего стола](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).


Если настройка лаборатории с помощью службы автоматизации, см. в разделе [набора DevTestLabGateway.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Set-DevTestLabGateway.ps1) пример сценария PowerShell для задания **имя узла шлюза** и **секрет маркера шлюза**параметры. [Репозитория Azure DevTest Labs на сайте GitHub](https://github.com/Azure/azure-devtestlab) также предоставляет шаблон Azure Resource Manager, который создает или обновляет лаборатории с **имя узла шлюза** и **секрет маркера шлюза**параметры.

## <a name="configure-network-security-group"></a>Настроить группу безопасности сети
Для обеспечения дополнительной защиты лаборатории, можно добавить группу безопасности сети (NSG) для виртуальной сети, используемой для виртуальных машин лаборатории. Сведения том, как настроить группу безопасности сети, см. в разделе [создание, изменение или удаление группы безопасности сети](../virtual-network/manage-network-security-group.md).

Вот пример группы безопасности сети, которая пропускает только трафик, который сначала проходит через шлюз к компьютеры лаборатории. Источник в это правило относится к IP-адрес компьютера шлюза одной или IP-адрес балансировщика нагрузки перед машины шлюза.

![Группа безопасности сети — правила](./media/configure-lab-remote-desktop-gateway/network-security-group-rules.png)

## <a name="sample-to-create-a-remote-desktop-gateway"></a>Образец для создания шлюза удаленных рабочих столов

> [!NOTE] 
> Используя примеры шаблонов, вы соглашаетесь с [условия лицензионного соглашения на шлюз удаленных рабочих столов в](https://www.microsoft.com/licensing/product-licensing/products). Дополнительные сведения о удаленного шлюза, см. в разделе [Добро пожаловать в службы удаленных рабочих столов](https://aka.ms/rds) и [развертывание среды удаленного рабочего стола](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).

[Репозитория Azure DevTest Labs на сайте GitHub](https://github.com/Azure/azure-devtestlab) предоставляет небольшое число выборок для установки ресурсов, необходимых для использования проверки подлинности маркера и шлюза удаленных рабочих столов с DevTest Labs. Эти примеры шаблонов Azure Resource Manager для машины шлюза, параметры лаборатории и приложения-функции.

Выполните следующие действия для настройки примера решения для фермы шлюза удаленных рабочих столов.

1. Создайте сертификат для подписи.  Запустите [создать SigningCertificate.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Create-SigningCertificate.ps1). Сохраните отпечаток, пароль и созданного сертификата в кодировке Base64.
2. Получите SSL-сертификат. Полное доменное имя, связанные с SSL-сертификат должен быть домена, которым вы управляете. Сохраните отпечаток, пароль и кодировку Base64 для этого сертификата. Чтобы получить отпечаток, с помощью PowerShell, используйте следующие команды.

    ```powershell
    $cer = New-Object System.Security.Cryptography.X509Certificates.X509Certificate;
    $cer.Import(‘path-to-certificate’);
    $hash = $cer.GetCertHashString()
    ```

    Чтобы получить кодировку Base64, с помощью PowerShell, используйте следующую команду.

    ```powershell
    [System.Convert]::ToBase64String([System.IO.File]::ReadAllBytes(‘path-to-certificate’))
    ```
3. Загрузите файлы с [ https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway ](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway).

    Для шаблона требуется доступ к несколько других шаблонов Resource Manager и связанные ресурсы в один и тот же базовый URI. Скопируйте все файлы из [ https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/arm/gateway ](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/arm/gateway) и RDGatewayFedAuth.msi контейнер больших двоичных объектов в учетной записи хранения.  
4. Развертывание **azuredeploy.json** из [ https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway ](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway). Шаблон принимает следующие параметры:
    - adminUsername — требуется.  Имя пользователя администратора для машин шлюза.
    - adminPassword — требуется. Пароль для учетной записи администратора для машин шлюза.
    - instanceCount — количество компьютеров, чтобы создать шлюз.  
    - alwaysOn — указывает, следует ли сохранять к созданному приложению функций Azure в режиме «горячего» резервирования или нет. Сохранение приложения функций Azure позволит избежать задержек при пользователей сначала пытаются подключиться к своей виртуальной Машины лаборатории, но у нее затраты.  
    - tokenLifetime — продолжительность времени, созданный токен будет допустимым. Формат — чч: мм:.
    - sslCertificate — Base64 кодировку сертификата SSL для компьютера шлюза.
    - sslCertificatePassword — пароль SSL-сертификата для компьютера шлюза.
    - sslCertificateThumbprint - отпечаток для идентификации в локальном хранилище сертификатов SSL-сертификата.
    - signCertificate — Base64 кодирование по подписанию сертификата для компьютера шлюза.
    - signCertificatePassword — пароль для подписывания сертификата для компьютера шлюза.
    - signCertificateThumbprint - отпечаток для идентификации в локальном хранилище сертификатов сертификата для подписи.
    - _artifactsLocation — URI-адрес, где можно найти все вспомогательные ресурсы. Это значение должно быть полное UIR, а не относительный путь.
    - _artifactsLocationSasToken-маркер (Подписанный), используемый для доступа к вспомогательные ресурсы, если расположение — учетная запись хранилища Azure.

    Шаблон можно развернуть с помощью Azure CLI с помощью следующей команды:

    ```azurecli
    az group deployment create --resource-group {resource-group} --template-file azuredeploy.json --parameters @azuredeploy.parameters.json -–parameters _artifactsLocation=”{storage-account-endpoint}/{container-name}” -–parameters _artifactsLocationSasToken = “?{sas-token}”
    ```

    Ниже приведены описания параметров.

    - {Storage-учетной записи endpoint} можно получить, выполнив `az storage account show --name {storage-acct-name} --query primaryEndpoints.blob`.  {Storage-acct-name} — имя учетной записи хранения, которая содержит файлы, загруженные.  
    - {Контейнер name} — это имя контейнера в {storage-acct-name}, который содержит файлы, загруженные.  
    - {Sas-token} можно получить, выполнив `az storage container generate-sas --name {container-name} --account-name {storage-acct-name} --https-only –permissions drlw –expiry {utc-expiration-date}`. 
        - {Storage-acct-name} — имя учетной записи хранения, которая содержит файлы, загруженные.  
        - {Контейнер name} — это имя контейнера в {storage-acct-name}, который содержит файлы, загруженные.  
        - {Utc--срок} — Дата, в формате UTC, по которому маркера SAS истекает и маркер SAS, больше не может использоваться для доступа к учетной записи хранения.

    Запишите значения gatewayFQDN и gatewayIP из выходных данных развертывания шаблона. Также необходимо сохранить значение ключа функции для только что созданный функции, которые можно найти в [параметры приложения-функции](../azure-functions/functions-how-to-use-azure-function-app-settings.md) вкладки.
5. Настройка DNS, так что полное доменное имя из SSL-сертификата направляет gatewayIP IP-адрес из предыдущего шага.

    После создания фермы шлюза удаленных рабочих столов и внесены соответствующие обновления DNS, он готов для использования в лабораторию в DevTest Labs. **Имя узла шлюза** и **секрет маркера шлюза** параметров должен быть настроен на использование шлюза компьютеры, вы развернули. 

    > [!NOTE]
    > Если на машине лаборатории используются частные IP-адреса, должен быть сетевой путь с компьютера шлюза к машине лаборатории, через общий доступ к той же виртуальной сети или с помощью пиринговой виртуальной сети.

    После настройки шлюза и лаборатории подключения файл создан при нажатии пользователем лаборатории **Connect** автоматически будет включать сведения, необходимые для подключения с использованием аутентификации на основе маркеров.     

## <a name="next-steps"></a>Дальнейшие действия
Обратитесь к следующей статье, чтобы узнать больше о службах удаленных рабочих столов: [Удаленный рабочий стол служб документации](/windows-server/remote/remote-desktop-services/Welcome-to-rds)


