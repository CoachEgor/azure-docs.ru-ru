---
title: Интеграция лабораторий Azure DevTest в ваши трубопроводы Azure
description: Сведения об интеграции Azure DevTest Labs с конвейером непрерывной интеграции и поставки Azure Pipelines.
services: devtest-lab,virtual-machines,lab-services
documentationcenter: na
author: spelluru
manager: femila
editor: ''
ms.assetid: a26df85e-2a00-462b-aac1-dd3539532569
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/16/2020
ms.author: spelluru
ms.openlocfilehash: 9604da5252254120ac7bd3fca3f0cc97324aef92
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76293221"
---
# <a name="integrate-azure-devtest-labs-into-your-azure-pipelines-cicd-pipeline"></a>Интеграция лабораторий Azure DevTest в конвейер Azure Pipelines CI/CD

Вы можете использовать расширение *Azure DevTest Labs Tasks* для интеграции непрерывной интеграции и непрерывной доставки (CI/CD) в сборку и выпуск конвейеров с Azure DevTest Labs. Расширение устанавливает несколько задач, в том числе: 

- Создание виртуальной машины
- Создание пользовательского образа из виртуальной машины
- Удаление виртуальной машины 

Эти задачи упрощают, например, быстрое развертывание *золотого изображения* VM для конкретной тестовой задачи, а затем удалять VM по завершении теста.

В этой статье показано, как использовать задачи Azure DevTest Labs для создания и развертывания VM, создания пользовательского изображения, а затем удаления VM, все как один конвейер релиза. Обычно задачи выполняются индивидуально в пользовательских сборках, тестировании и развертывании конвейеров.

[!INCLUDE [devtest-lab-try-it-out](../../includes/devtest-lab-try-it-out.md)]

## <a name="prerequisites"></a>Предварительные требования

- Зарегистрируйтесь или войдите в организацию [Azure DevOps](https://dev.azure.com) и [создайте проект](/vsts/organizations/projects/create-project) в организации. 
  
- Установите расширение задач Azure DevTest Labs из Visual Studio Marketplace.
  
  1. Перейдите на страницу расширения [Задачи Azure DevTest Labs](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).
  1. Выберите **Получить его бесплатно**.
  1. Выберите организацию Azure DevOps из системы отсеивания и выберите **Install.** 
  
## <a name="create-the-template-to-build-an-azure-vm"></a>Создайте шаблон для создания VM Azure 

В этом разделе описывается, как создать шаблон управления ресурсами Azure, который используется для создания VM Azure по требованию.

1. Чтобы создать шаблон менеджера ресурсов в подписке, следуйте процедуре в [шаблоне «Используйте менеджер ресурсов».](devtest-lab-use-resource-manager-template.md)
   
1. Перед созданием шаблона Resource Manager добавьте [артефакт WinRM](https://github.com/Azure/azure-devtestlab/tree/master/Artifacts/windows-winrm) как часть создания виртуальной машины. Задачи развертывания, такие как *Azure File Copy* и *PowerShell на целевых машинах,* нуждаются в доступе WinRM. Артефакт WinRM требует хоста в качестве параметра, который должен быть полностью квалифицированным доменным именем (ФЗДН) VM. 
   
   > [!NOTE]
   > При использовании WinRM с общим IP-адресом необходимо добавить правило NAT для сопоставления внешнего порта с портом WinRM. Правило NAT не нужно, если вы создаете VM с общедоступным IP-адресом.
   
   
1. Сохранить шаблон на компьютере в виде файла под названием *CreateVMTemplate.json*.
   
1. Зарегистрируйте шаблон в системе управления исходным источником.

## <a name="create-a-script-to-get-vm-properties"></a>Создание скрипта для получения свойств VM

При выполнении задач, таких как *Azure File Copy* или *PowerShell на целевых машинах* в конвейере выпуска, следующий скрипт собирает значения, необходимые для развертывания приложения в VM. Обычно эти задачи используются для развертывания приложения в VM Azure. Для выполнения задач требуются такие значения, как имя группы ресурсов VM, IP-адрес и F-DN.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Для создания файла скрипта:

1. Откройте текстовый редактор и вставьте в него следующий скрипт.
   
   ```powershell
   Param( [string] $labVmId)

   $labVmComputeId = (Get-AzResource -Id $labVmId).Properties.ComputeId

   # Get lab VM resource group name
   $labVmRgName = (Get-AzResource -Id $labVmComputeId).ResourceGroupName

   # Get the lab VM Name
   $labVmName = (Get-AzResource -Id $labVmId).Name

   # Get lab VM public IP address
   $labVMIpAddress = (Get-AzPublicIpAddress -ResourceGroupName $labVmRgName
                   -Name $labVmName).IpAddress

   # Get lab VM FQDN
   $labVMFqdn = (Get-AzPublicIpAddress -ResourceGroupName $labVmRgName
              -Name $labVmName).DnsSettings.Fqdn

   # Set a variable labVmRgName to store the lab VM resource group name
   Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName"

   # Set a variable labVMIpAddress to store the lab VM Ip address
   Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress"

   # Set a variable labVMFqdn to store the lab VM FQDN name
   Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn"
   ```

1. Сохраните файл с именем, как *GetLabVMParams.ps1*, и проверить его в вашей системе управления исходным источником. 

## <a name="create-a-release-pipeline-in-azure-pipelines"></a>Создание конвейера выпуска в Azure Pipelines

Для создания нового конвейера выпуска:

1. На странице проекта Azure DevOps выберите**выпуски** **трубопроводов** > из левой навигации.
1. Выберите **новый трубопровод**.
1. Под **выберите шаблон,** прокрутите вниз и выберите **Пустое задание,** а затем выберите **Apply.**

### <a name="add-and-set-variables"></a>Добавление и настройка переменных

Задачи конвейера используют значения, присвоенные VM при создании шаблона управления ресурсами на портале Azure. 

Чтобы добавить переменные для значений: 

1. На странице конвейера выберите вкладку **Переменные.**
   
1. Для каждой переменной выберите **Добавить** и ввести имя и значение:
   
   |name|Значение|
   |---|---|
   |*vmName*|Имя VM, назначенное шаблоном «Менеджер ресурсов»|
   |*Пользователя*|Имя пользователя для доступа к VM|
   |*пароль*|Пароль для имени пользователя. Выберите значок блокировки, чтобы скрыть и защитить пароль.

### <a name="create-a-devtest-labs-vm"></a>Создание DevTest Labs VM

Следующим шагом является создание золотого изображения VM для использования в будущих развертываниях. Вы создаете VM в экземпляре Azure DevTest Labs, используя *лаборатории Azure DevTest, создавая* задачу VM.

1. На **вкладке** конвейера выпуска выберите гиперсвязанный текст на **этапе 1** для просмотра задач **стадии,** а затем выберите знак **+** плюс рядом с **заданием Agent.** 
   
1. При **выполнении задач**выберите **Лаборатории Azure DevTest Создать VM**и **выберите Добавить.** 
   
1. Выберите **Создать Azure DevTest Labs VM** в левом стекле. 

1. В области справа заполните форму следующим образом:
   
   |Поле|Значение|
   |---|---|
   |**Подписка Azure RM**|Выберите подключение к службе или подписку из доступных подключений к **службам Azure** или **доступных подписок Azure** в отбрасывании и при необходимости выберите **авторизацию.**<br /><br />**Примечание:** Для получения информации о создании более ограниченного подключения к подписке Azure можно получить в [конце вечера службы Azure Resource Manager.](/azure/devops/pipelines/library/service-endpoints#sep-azure-resource-manager)|
   |**Название лаборатории**|Выберите название существующей лаборатории, в которой будет создана лаборатория VM.|
   |**Название шаблона**|Введите полный путь и имя сохраненного файла шаблона в репозиторий исходного кода. Для упрощения пути можно использовать встроенные свойства, например:<br /><br />`$(System.DefaultWorkingDirectory)/Templates/CreateVMTemplate.json`|
   |**Параметры шаблона**|Введите параметры для переменных, которые вы определили ранее:<br /><br />`-newVMName '$(vmName)' -userName '$(userName)' -password (ConvertTo-SecureString -String '$(password)' -AsPlainText -Force)`|
   |**Выход Переменные** > **Лаборатория VM ID**|Введите переменную для созданного vM ID лаборатории. Если вы используете **labVMId**по умолчанию, вы можете сослаться на переменную в последующих задачах как *$(labVMId).*<br /><br />Вы можете создать имя, кроме по умолчанию, но не забудьте использовать правильное имя в последующих задачах. Вы можете написать Идентификатор Lab VM в следующей форме:<br /><br />`/subscriptions/{subscription Id}/resourceGroups/{resource group Name}/providers/Microsoft.DevTestLab/labs/{lab name}/virtualMachines/{vmName}`|

### <a name="collect-the-details-of-the-devtest-labs-vm"></a>Соберите подробную информацию о DevTest Labs VM

Выполните скрипт, созданный ранее, чтобы собрать подробные сведения о виртуальной машине DevTest Labs. 

1. На **вкладке** конвейера выпуска выберите гиперсвязанный текст на **этапе 1** для просмотра задач **стадии,** а затем выберите знак **+** плюс рядом с **заданием Agent.** 
   
1. При **добавлении задач**выберите **Azure PowerShell**и **выберите Добавить.** 
   
1. Выберите **скрипт Azure PowerShell: FilePath** в левом стеле. 
   
1. В области справа заполните форму следующим образом:
   
   |Поле|Значение|
   |---|---|
   |**Тип подключения Azure**|Выберите **менеджер ресурсов Azure**.|
   |**Подписка на Azure**|Выберите подключение к сервису или подписку.| 
   |**Тип сценария**|Выберите **путь файла сценария**.|
   |**Путь сценария**|Введите полный путь и имя скрипта PowerShell, сохраненного в репозитории исходного кода. Для упрощения пути можно использовать встроенные свойства, например:<br /><br />`$(System.DefaultWorkingDirectory/Scripts/GetLabVMParams.ps1`|
   |**Аргументы по сценарию**|Введите имя переменной *labVmId,* которая была заселена предыдущей задачей, например:<br /><br />`-labVmId '$(labVMId)'`|

Скрипт собирает требуемые значения и хранит их в переменных среды в конвейере выпуска, так что вы можете легко ссылаться на них в последующих шагах.

### <a name="create-a-vm-image-from-the-devtest-labs-vm"></a>Создание VM-изображения из DevTest Labs VM

Следующая задача — создать изображение недавно развернутого VM в экземпляре Azure DevTest Labs. Впоследствии образ можно использовать для создания копий виртуальной машины по запросу, когда потребуется выполнить задачу разработки или выполнить некоторые тесты. 

1. На **вкладке** конвейера выпуска выберите гиперсвязанный текст на **этапе 1** для просмотра задач **стадии,** а затем выберите знак **+** плюс рядом с **заданием Agent.** 
   
1. При **выполнении задач**выберите **Лаборатории Azure DevTest Создать пользовательское изображение**и выберите **Добавить.** 
   
1. Настройте задачу следующим образом.
   
   |Поле|Значение|
   |---|---|
   |**Подписка Azure RM**|Выберите подключение к сервису или подписку.|
   |**Название лаборатории**|Выберите название существующей лаборатории, в которой будет создано изображение.|
   |**Пользовательское имя изображения**|Введите имя для пользовательского изображения.|
   |**Описание** (необязательно)|Введите описание, чтобы было легко выбрать правильное изображение позже.|
   |**Источник Лаборатория VM** > **Источник Лаборатория VM ID**|Если вы изменили имя переменной LabVMId по умолчанию, введите его здесь. По умолчанию установлено значение **$(labVMId)**.|
   |**Выход Переменные** > **Пользовательские идентификатор изображения**|При необходимости можно отсеять имя переменной по умолчанию.|
   
### <a name="deploy-your-app-to-the-devtest-labs-vm-optional"></a>Развертывание приложения в DevTest Labs VM (по желанию)

Вы можете добавить задачи для развертывания приложения в новый DevTest Labs VM. Задачи, которые обычно используются для развертывания приложения: *Azure File Copy* и *PowerShell на целевых машинах.*

Информация VM, необходимая для параметров этих задач, хранится в трех переменных конфигурации, названных **labVmRgName,** **labVMIpAddress**и **labVMFqdn** в конвейере выпуска. Если вы только хотите поэкспериментировать с созданием виртуальной машины DevTest Labs и пользовательского образа без развертывания приложения на ней, то этот шаг можно пропустить.

### <a name="delete-the-vm"></a>Удаление виртуальной машины

Окончательная задача состоит в том, чтобы удалить VM, развернутый в экземпляре Azure DevTest Labs. Обычно после выполнения задач разработки или выполнения тестов на развернутой виртуальной машины ее удаляют. 

1. На **вкладке** конвейера выпуска выберите гиперсвязанный текст на **этапе 1** для просмотра задач **стадии,** а затем выберите знак **+** плюс рядом с **заданием Agent.** 
   
1. При **выполнении задач**выберите **Лаборатории Azure DevTest Delete VM**и **выберите Добавить.** 
   
1. Настройте задачу следующим образом.
   
   - В **подписке Azure RM**выберите подключение к сервису или подписку. 
   - Для **Идентификатора VM Lab,** если вы изменили имя переменной LabVMId по умолчанию, введите его здесь. По умолчанию установлено значение **$(labVMId)**.
   
### <a name="save-the-release-pipeline"></a>Сохранить конвейер выпуска

Для сохранения нового конвейера выпуска:

1. Выберите имя **Новый конвейер релиза** на странице конвейера выпуска и введите новое имя для конвейера. 
   
1. Выберите значок **Сохранить** в правом верхнем углу. 

## <a name="create-and-run-a-release"></a>Создание и запуск релиза

Для создания и запуска выпуска с помощью нового конвейера:

1. Выберите **Создать релиз** в верхнем правом углу на странице конвейера выпуска. 
   
1. Под **артефактами**выберите последнюю сборку, а затем выберите **Создать.**
   
1. На каждом этапе выпуска обновляйте представление экземпляра DevTest Labs на портале Azure, чтобы просмотреть создание VM, создание изображений и удаление VM.

Вы можете использовать пользовательское изображение для создания vMs, когда они вам нужны.

## <a name="next-steps"></a>Дальнейшие действия
- Дополнительные сведения см. в статье [Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager](devtest-lab-create-environment-from-arm.md).
- Исследуйте более быстрые шаблоны менеджера ресурсов для автоматизации DevTest Labs от [публичного репо DevTest Labs GitHub.](https://github.com/Azure/azure-quickstart-templates)
- При необходимости смотрите страницу [устранения неполадок ВАЗа.](https://docs.microsoft.com/azure/devops/pipelines/troubleshooting)
 
