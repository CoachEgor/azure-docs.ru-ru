---
title: Управление политиками автоматизации в Лабораториях Azure DevTest (ru) Документы Майкрософт
description: Узнайте, как настроить политику автоматической остановки для лаборатории, чтобы виртуальные машины автоматически выключались, когда они не используются.
services: devtest-lab,virtual-machines,lab-services
documentationcenter: na
author: spelluru
manager: femila
editor: ''
ms.assetid: ''
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/17/2020
ms.author: spelluru
ms.openlocfilehash: a2d0b9bdfba1b96ad42e45d54faf106b2361e29d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76264799"
---
# <a name="configure-autoshutdown-for-lab-and-compute-virtual-machines-in-azure-devtest-labs"></a>Настройка автоматической остановки для лабораторных и вычислить виртуальные машины в Azure DevTest Labs

В этой статье объясняется, как настроить настройки автоматизации для лабораторных вмвм в DevTest Labs и вычислить VMs. 

## <a name="configure-autoshutdown-for-lab-vms-devtest-labs"></a>Настройка автовыключения для лабораторных VMs (DevTest Labs)
Azure DevTest Labs позволяет контролировать расходы и свести к минимуму излишние траты в лабораториях с помощью управления политиками (параметрами) для каждой лаборатории. В этой статье показано, как настроить политику автоматизации для лабораторной учетной записи и настроить настройки автоматизации для лаборатории в учетной записи лаборатории. Сведения о настройке всех политик лаборатории см. в статье [Управление всеми политиками лаборатории в Azure DevTest Labs](devtest-lab-set-lab-policy.md).  

### <a name="set-auto-shut-down-policy-for-a-lab"></a>Установка политики автоматического выключения для лаборатории
Владелец лаборатории может настроить расписание завершения работы всех виртуальных машин в лаборатории. Таким образом, вы сможете сэкономить на работе компьютеров, которые не используются (в режиме простоя). Вы можете применять политику завершения работы ко всем виртуальным машинам в лаборатории централизованно, а также сократить трудозатраты ваших пользователей лаборатории, настроив расписания их индивидуальных компьютеров. Эта функция позволяет задать политику при запуске расписания лаборатории для ваших пользователей: от предложения без управления до предложения с полным управлением. В качестве владельца лаборатории, вы можете настроить эту политику, выполнив следующие действия:

1. На домашней странице лаборатории выберите функцию **Конфигурация и политики**.
2. Выберите **Политика автоматического завершения работы** в разделе **Расписания** меню слева.
3. Выберите один из способов. Следующие разделы содержат дополнительные сведения об этих вариантах. Задание политики применяется только к новым виртуальным машинам, созданным в лаборатории, но не к уже созданным виртуальным машинам. 

    ![Автоматическое отключение вариантов политики](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-options.png)

### <a name="configure-auto-shutdown-settings"></a>Настройка параметров автоматического выключения
Политика автоавтоматизации позволяет свести к минимуму лабораторные отходы, позволяя указать время, в течение которого выключаются в этой лаборатории.

Чтобы просмотреть (и изменить) политики для лаборатории, выполните следующее.

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **все службы,** а затем выберите **DevTest Labs** из списка.
3. Из списка лабораторий выберите нужную лабораторию.   
4. Выберите **Configuration and policies** (Конфигурация и политики).

    ![Область параметров политики](./media/devtest-lab-set-lab-policy/policies-menu.png)
5. На **панели конфигурации и политик лаборатории** выберите **автоматическое выключение** в соответствии с **расписанием.**
   
    ![Автозакрытие](./media/devtest-lab-set-lab-policy/auto-shutdown.png)
6. Щелкните **On** (Вкл.), чтобы включить эту политику, или **Off** (Выкл.), чтобы отключить ее.
7. Если эта политика включена, то укажите время (и часовой пояс) завершения работы всех виртуальных машин в текущей лаборатории.
8. Укажите **"да"** или **"нет"** для опции отправки уведомления за 30 минут до указанного времени автоматического отключения. Выбрав **Да**, укажите конечную точку в виде URL-адреса веб-перехватчика, где будут публиковаться уведомления, или адрес электронной почты, на который будут отправляться такие уведомления. При получении уведомления пользователь получает возможность отложить завершение работы. Для получения дополнительной [информации](#notifications) смотрите раздел Уведомления. 
9. Нажмите кнопку **Сохранить**.

    По умолчанию после включения эта политика применяется ко всем виртуальным машинам в текущей лаборатории. Чтобы удалить эту настройку из определенного VM, откройте панель управления VM и измените настройки **автоотключения.**
    
> [!NOTE]
> Если вы обновите график автоматического выключения для вашей лаборатории или конкретной виртуальной лаборатории в течение 30 минут от текущего запланированного времени, обновленное время отключения будет применяться к расписанию на следующий день. 

### <a name="user-sets-a-schedule-and-can-opt-out"></a>Пользователь задает расписание и может отказаться от него
Если задать лаборатории эту политику, пользователи лаборатории могут переопределить или отказаться от расписания лаборатории. Этот параметр предоставляет пользователям лаборатории полный контроль над расписанием автоматического завершения работы своих виртуальных машин. Пользователи лаборатории не увидят изменений на своей странице расписания автоматического завершения работы виртуальной машины.

![Опция автоматического выключения политики - 1](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-1.png)

### <a name="user-sets-a-schedule-and-cannot-opt-out"></a>Пользователь задает расписание и не может отказаться от него
Если задать лаборатории эту политику, пользователи лаборатории могут переопределить расписание лаборатории. Однако они не могут отказаться от политики автоматического завершения работы. Этот параметр гарантирует, что все компьютеры в лаборатории следуют расписанию автоматического завершения работы. Пользователи лаборатории могут обновить расписание автоматического завершения работы своих виртуальных машин и настроить уведомления об отключении.

![Опция автоматического выключения полиса - 2](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-2.png)

### <a name="user-has-no-control-over-the-schedule-set-by-lab-admin"></a>Пользователь не может изменять расписание, заданное администратором лаборатории
Если задать лаборатории эту политику, пользователи лаборатории не смогут переопределить или отказаться от расписания лаборатории. Этот параметр дает администратору лаборатории полный контроль над расписанием каждой машины в лаборатории. Пользователи лаборатории могут задать только уведомления об автоматическом завершении работы своих виртуальных машин.

![Опция автоматического выключения полиса - 3](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-3.png)

### <a name="notifications"></a>Уведомления
После автоматического отключения, созданного владельцем лаборатории, уведомления будут отправлены пользователям лаборатории за 30 минут до срабатывания автоотключения, если какой-либо из их VMs будет затронут. Эта опция дает пользователям лаборатории возможность сохранить свою работу до завершения работы. Уведомление также предоставляет ссылки для каждого VM для следующих действий:

- Пропустить автозакрытие для этого времени
- Отложить автозакрытие в течение часа или 2 часов, так что они могут продолжать работать на VM.

Уведомление отправляется через настроенную конечную точку веб-крючка или адрес электронной почты, указанный владельцами лабораторий в настройках автоостановки. Webhooks позволяют создавать или настраивать интеграции, которые подписываются на определенные события. Когда одно из этих событий срабатывает, DevTest Labs отправит полезную нагрузку HTTP POST на настроенный URL-адрес webhook. Дополнительные сведения об объектах webhook см. в статье [Создание функции Azure объекта webhook или API](../azure-functions/functions-create-a-web-hook-or-api-function.md). 

Мы рекомендуем использовать веб-крючки, поскольку они широко поддерживаются различными приложениями (например, Slack, Azure Logic Apps и так далее.) и позволяют реализовать свой собственный способ отправки уведомлений. В качестве примера, эта статья рассказывает о том, как получить уведомление об автоматической остановке от электронных писем с помощью приложений Azure Logic Apps. Во-первых, давайте быстро пройдем основные шаги, чтобы включить уведомление о автоматической остановке в вашей лаборатории.   

### <a name="create-a-logic-app-that-receives-email-notifications"></a>Создание приложения логики, которое получает уведомления по электронной почте
[Azure Logic Apps](../logic-apps/logic-apps-overview.md) предоставляет множество готовых разъемов, что позволяет легко интегрировать сервис с другими клиентами, такими как Office 365 и Twitter. На высоком уровне шаги по настройке Logic App для уведомления по электронной почте можно разделить на четыре этапа: 

- Создайте приложение логики. 
- Настроили встроенный шаблон.
- Интегрируйтесь с вашим почтовым клиентом
- Получить URL Webhook.

### <a name="create-a-logic-app"></a>Создайте приложение логики
Чтобы начать работу, создайте логическое приложение в подписке Azure, используя следующие действия:

1. Выберите **: Создайте ресурс** в левом меню, выберите **Интеграцию**и выберите **Logic App.** 

    ![Новое меню приложения логики](./media/devtest-lab-auto-shutdown/new-logic-app.png)
2. На **логике App - Создать** страницу, следуйте следующим шагам: 
    1. Введите **имя** для приложения логики.
    2. Выберите **подписку**На Azure.
    3. Создайте новую **группу ресурсов** или выберите имеющуюся. 
    4. Выберите **место** для приложения логики. 

        ![Новое приложение логики - настройки](./media/devtest-lab-auto-shutdown/new-logic-app-page.png)
3. В **уведомлениях**выберите **Перейти на ресурс** в уведомлении. 

    ![Переход к ресурсу](./media/devtest-lab-auto-shutdown/go-to-resource.png)
4. Выберите **дизайнера приложений Logic** в категории **«Инструменты развертывания».**

    ![Выберите http Запрос/Ответ](./media/devtest-lab-auto-shutdown/select-http-request-response-option.png)
5. На странице **ЗАПРОС-ответ HTTP** выберите **Используйте этот шаблон.** 

    ![Выберите Используйте эту опцию шаблона](./media/devtest-lab-auto-shutdown/select-use-this-template.png)
6. Копируйте следующий JSON в разделе **Запрос органа JSON Schema:** 

    ```json
    {
        "$schema": "http://json-schema.org/draft-04/schema#",
        "properties": {
            "delayUrl120": {
                "type": "string"
            },
            "delayUrl60": {
                "type": "string"
            },
            "eventType": {
                "type": "string"
            },
            "guid": {
                "type": "string"
            },
            "labName": {
                "type": "string"
            },
            "owner": {
                "type": "string"
            },
            "resourceGroupName": {
                "type": "string"
            },
            "skipUrl": {
                "type": "string"
            },
            "subscriptionId": {
                "type": "string"
            },
            "text": {
                "type": "string"
            },
            "vmName": {
                "type": "string"
            }
        },
        "required": [
            "skipUrl",
            "delayUrl60",
            "delayUrl120",
            "vmName",
            "guid",
            "owner",
            "eventType",
            "text",
            "subscriptionId",
            "resourceGroupName",
            "labName"
        ],
        "type": "object"
    }
    ```
    
    ![Запрос органа JSON Схема](./media/devtest-lab-auto-shutdown/request-json.png)
7. Выберите **новый шаг** в дизайнере и выполните следующие действия:
    1. Поиск **Office 365 Outlook - Отправить по электронной почте**. 
    2. Выберите **Отправить письмо** из **Действий**. 
    
        ![Отправить опцию электронной почты](./media/devtest-lab-auto-shutdown/select-send-email.png)
    3. Выберите **войти,** чтобы войти в учетную запись электронной почты. 
    4. Выберите **поле** и выберите владельца.
    5. Выберите **SUBJECT**и ввведай тему уведомления по электронной почте. Например: "Выключение машины vmName для лаборатории: labName".
    6. Выберите **BODY**и определите содержимое тела для уведомления по электронной почте. Например: "vmName планируется закрыть через 15 минут. Пропустите это отключение, нажав: URL. Задержка выключения на час: delayUrl60. Задержка остановки на 2 часа: delayUrl120."

        ![Запрос органа JSON Схема](./media/devtest-lab-auto-shutdown/email-options.png)
1. На панели инструментов щелкните **Сохранить**. Теперь вы можете скопировать **URL HTTP POST**. Выберите кнопку копирования, чтобы скопировать URL-адрес в буфер обмена. 

    ![WebHook URL](./media/devtest-lab-auto-shutdown/webhook-url.png)

## <a name="configure-autoshutdown-for-compute-vms"></a>Настройка автоматической остановки для вычислений VMs

1. На странице **Виртуальной машины** выберите **автоматическое выключение** в левом меню. 
2. На странице **автоматического выключения** выберите **On,** чтобы включить эту политику, и **Off,** чтобы отключить его.
3. Если вы включите эту политику, укажите **время** (и **часовой пояс),** в котором VM должен быть выключен.
4. Укажите **"да"** или **"нет"** для опции отправки уведомления за 30 минут до указанного времени автоматического отключения. Выбрав **Да**, укажите конечную точку в виде URL-адреса веб-перехватчика, где будут публиковаться уведомления, или адрес электронной почты, на который будут отправляться такие уведомления. При получении уведомления пользователь получает возможность отложить завершение работы. Для получения дополнительной [информации](#notifications) смотрите раздел Уведомления. 
9. Нажмите кнопку **Сохранить**.

    ![Настройка автовыключения для вычисления VM](./media/devtest-lab-auto-shutdown/comnpute-auto-shutdown.png)

## <a name="next-steps"></a>Дальнейшие действия
Чтобы узнать, как настроить все политики, [см.](devtest-lab-set-lab-policy.md)

