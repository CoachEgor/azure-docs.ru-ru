---
title: Управление политиками автоматического завершения работы в Azure DevTest Labs | Документация Майкрософт
description: Узнайте, как настроить политику автоматического завершения работы для лаборатории, чтобы автоматически завершать работу виртуальных машин, если они не используются.
services: devtest-lab,virtual-machines,lab-services
documentationcenter: na
author: spelluru
manager: femila
editor: ''
ms.assetid: ''
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/17/2020
ms.author: spelluru
ms.openlocfilehash: a2d0b9bdfba1b96ad42e45d54faf106b2361e29d
ms.sourcegitcommit: 2a2af81e79a47510e7dea2efb9a8efb616da41f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2020
ms.locfileid: "76264799"
---
# <a name="configure-autoshutdown-for-lab-and-compute-virtual-machines-in-azure-devtest-labs"></a>Настройка автоматического завершения работы для лабораторий и вычисление виртуальных машин в Azure DevTest Labs

В этой статье объясняется, как настроить параметры автоматического завершения работы для виртуальных машин лаборатории в DevTest Labs и COMPUTE VM. 

## <a name="configure-autoshutdown-for-lab-vms-devtest-labs"></a>Настройка автоматического завершения работы для виртуальных машин лаборатории (DevTest Labs)
Azure DevTest Labs позволяет контролировать расходы и свести к минимуму излишние траты в лабораториях с помощью управления политиками (параметрами) для каждой лаборатории. В этой статье показано, как настроить политику автоматического завершения работы для учетной записи лаборатории и настроить параметры автоматического завершения работы лаборатории в учетной записи лаборатории. Сведения о настройке всех политик лаборатории см. в статье [Управление всеми политиками лаборатории в Azure DevTest Labs](devtest-lab-set-lab-policy.md).  

### <a name="set-auto-shut-down-policy-for-a-lab"></a>Настройка политики автоматического выключения для лаборатории
Владелец лаборатории может настроить расписание завершения работы всех виртуальных машин в лаборатории. Таким образом, вы сможете сэкономить на работе компьютеров, которые не используются (в режиме простоя). Вы можете применять политику завершения работы ко всем виртуальным машинам в лаборатории централизованно, а также сократить трудозатраты ваших пользователей лаборатории, настроив расписания их индивидуальных компьютеров. Эта функция позволяет задать политику при запуске расписания лаборатории для ваших пользователей: от предложения без управления до предложения с полным управлением. В качестве владельца лаборатории, вы можете настроить эту политику, выполнив следующие действия:

1. На домашней странице лаборатории выберите функцию **Конфигурация и политики**.
2. Выберите **Политика автоматического завершения работы** в разделе **Расписания** меню слева.
3. Выберите один из способов. Следующие разделы содержат дополнительные сведения об этих вариантах. Задание политики применяется только к новым виртуальным машинам, созданным в лаборатории, но не к уже созданным виртуальным машинам. 

    ![Параметры политики автоматического выключения](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-options.png)

### <a name="configure-auto-shutdown-settings"></a>Настройка параметров автоматического завершения работы
Политика автоматического завершения работы помогает снизить объем отходов лаборатории, позволяя указать время завершения работы виртуальных машин лаборатории.

Чтобы просмотреть (и изменить) политики для лаборатории, выполните следующее.

1. Войдите на [портал Azure](https://portal.azure.com).
2. Щелкните **Все службы** и выберите в списке **DevTest Labs**.
3. Из списка лабораторий выберите нужную лабораторию.   
4. Выберите **Configuration and policies** (Конфигурация и политики).

    ![Область параметров политики](./media/devtest-lab-set-lab-policy/policies-menu.png)
5. В области **Конфигурация и политики** лаборатории выберите **Автоматическое завершение работы** в разделе **расписания**.
   
    ![Автоматическое завершение работы](./media/devtest-lab-set-lab-policy/auto-shutdown.png)
6. Щелкните **On** (Вкл.), чтобы включить эту политику, или **Off** (Выкл.), чтобы отключить ее.
7. Если эта политика включена, то укажите время (и часовой пояс) завершения работы всех виртуальных машин в текущей лаборатории.
8. Укажите **Yes** или **No** (да или нет), чтобы отправить уведомление через 30 минут до указанного времени автоматического завершения работы. Выбрав **Да**, укажите конечную точку в виде URL-адреса веб-перехватчика, где будут публиковаться уведомления, или адрес электронной почты, на который будут отправляться такие уведомления. При получении уведомления пользователь получает возможность отложить завершение работы. Дополнительные сведения см. в разделе " [уведомления](#notifications) ". 
9. Щелкните **Сохранить**.

    По умолчанию после включения эта политика применяется ко всем виртуальным машинам в текущей лаборатории. Чтобы удалить этот параметр из определенной виртуальной машины, откройте панель управления виртуальной машины и измените параметры автоматического **завершения работы** .
    
> [!NOTE]
> Если вы обновите расписание автозавершения работы для лаборатории или конкретную виртуальную машину лаборатории в течение 30 минут после текущего запланированного времени, то обновленное время завершения работы будет применено к следующему расписанию. 

### <a name="user-sets-a-schedule-and-can-opt-out"></a>Пользователь задает расписание и может отказаться от него
Если задать лаборатории эту политику, пользователи лаборатории могут переопределить или отказаться от расписания лаборатории. Этот параметр предоставляет пользователям лаборатории полный контроль над расписанием автоматического завершения работы своих виртуальных машин. Пользователи лаборатории не увидят изменений на своей странице расписания автоматического завершения работы виртуальной машины.

![Параметр политики автоматического выключения — 1](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-1.png)

### <a name="user-sets-a-schedule-and-cannot-opt-out"></a>Пользователь задает расписание и не может отказаться от него
Если задать лаборатории эту политику, пользователи лаборатории могут переопределить расписание лаборатории. Однако они не могут отказаться от политики автоматического завершения работы. Этот параметр гарантирует, что все компьютеры в лаборатории следуют расписанию автоматического завершения работы. Пользователи лаборатории могут обновить расписание автоматического завершения работы своих виртуальных машин и настроить уведомления об отключении.

![Параметр политики автоматического выключения — 2](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-2.png)

### <a name="user-has-no-control-over-the-schedule-set-by-lab-admin"></a>Пользователь не может изменять расписание, заданное администратором лаборатории
Если задать лаборатории эту политику, пользователи лаборатории не смогут переопределить или отказаться от расписания лаборатории. Этот параметр дает администратору лаборатории полный контроль над расписанием каждой машины в лаборатории. Пользователи лаборатории могут задать только уведомления об автоматическом завершении работы своих виртуальных машин.

![Параметр политики автоматического выключения — 3](./media/devtest-lab-set-lab-policy/auto-shutdown-policy-option-3.png)

### <a name="notifications"></a>Уведомления
После того как автоматическое завершение работы настроено владельцем лаборатории, уведомления будут отправляться пользователям лаборатории за 30 минут до запуска автоматического завершения работы, если будут затронуты какие бы то ни было виртуальные машины. Этот параметр дает пользователям лаборатории возможность сохранить свою работу перед завершением работы. Кроме того, в уведомлении содержатся ссылки на каждую виртуальную машину для следующих действий.

- Пропустить автозавершение в течение этого времени
- Отложить автоматическое завершение работы на час или 2 часа, чтобы они могли работать на виртуальной машине.

Уведомление отправляется через настроенную конечную точку веб-перехватчика или адрес электронной почты, указанный владельцами лаборатории в параметрах автоматического завершения работы. Веб-Перехватчики позволяют создавать или настраивать интеграции, которые подписываются на определенные события. Когда запускается одно из этих событий, DevTest Labs отправляет полезные данные HTTP POST в настроенный URL-адрес. Дополнительные сведения об объектах webhook см. в статье [Создание функции Azure объекта webhook или API](../azure-functions/functions-create-a-web-hook-or-api-function.md). 

Мы рекомендуем использовать веб-перехватчики, так как они широко поддерживаются различными приложениями (например, временной резерв, Azure Logic Apps и т. д.) и позволяют реализовать собственный способ отправки уведомлений. Например, в этой статье описывается, как получать уведомления об автозавершении работы от электронных писем с помощью Azure Logic Apps. Во-первых, давайте быстро рассмотрим основные шаги для включения уведомлений об автозавершении работы в лаборатории.   

### <a name="create-a-logic-app-that-receives-email-notifications"></a>Создание приложения логики, которое получает уведомления по электронной почте
[Azure Logic Apps](../logic-apps/logic-apps-overview.md) предоставляет множество готовых соединителей, которые упрощают интеграцию службы с другими клиентами, например Office 365 и Twitter. На высоком уровне шаги настройки приложения логики для уведомления по электронной почте можно разделить на четыре фазы: 

- Создайте приложение логики. 
- Настройте встроенный шаблон.
- Интеграция с почтовым клиентом
- Получите URL-адрес веб-перехватчика.

### <a name="create-a-logic-app"></a>Создайте приложение логики
Чтобы приступить к работе, создайте приложение логики в подписке Azure, выполнив следующие действия.

1. Выберите **+ создать ресурс** в меню слева, выберите **Интеграция**и выберите **приложение логики**. 

    ![Новое меню приложения логики](./media/devtest-lab-auto-shutdown/new-logic-app.png)
2. На странице **Logic App-Create (создание приложения логики** ) выполните следующие действия. 
    1. Введите **имя** приложения логики.
    2. Выберите свою **подписку Azure**.
    3. Создайте новую **группу ресурсов** или выберите имеющуюся. 
    4. Выберите **Расположение** для приложения логики. 

        ![Новое приложение логики — параметры](./media/devtest-lab-auto-shutdown/new-logic-app-page.png)
3. В **уведомлениях**выберите **Переход к ресурсу** в уведомлении. 

    ![Переход к ресурсу](./media/devtest-lab-auto-shutdown/go-to-resource.png)
4. Выберите **Конструктор приложений логики** в разделе Категория **средств развертывания** .

    ![Выберите HTTP-запрос/ответ](./media/devtest-lab-auto-shutdown/select-http-request-response-option.png)
5. На странице **http-запрос — ответ** выберите **использовать этот шаблон**. 

    ![Выберите параметр использовать этот шаблон](./media/devtest-lab-auto-shutdown/select-use-this-template.png)
6. Скопируйте следующий код JSON в раздел **схемы JSON текста запроса** : 

    ```json
    {
        "$schema": "http://json-schema.org/draft-04/schema#",
        "properties": {
            "delayUrl120": {
                "type": "string"
            },
            "delayUrl60": {
                "type": "string"
            },
            "eventType": {
                "type": "string"
            },
            "guid": {
                "type": "string"
            },
            "labName": {
                "type": "string"
            },
            "owner": {
                "type": "string"
            },
            "resourceGroupName": {
                "type": "string"
            },
            "skipUrl": {
                "type": "string"
            },
            "subscriptionId": {
                "type": "string"
            },
            "text": {
                "type": "string"
            },
            "vmName": {
                "type": "string"
            }
        },
        "required": [
            "skipUrl",
            "delayUrl60",
            "delayUrl120",
            "vmName",
            "guid",
            "owner",
            "eventType",
            "text",
            "subscriptionId",
            "resourceGroupName",
            "labName"
        ],
        "type": "object"
    }
    ```
    
    ![Схема JSON текста запроса](./media/devtest-lab-auto-shutdown/request-json.png)
7. Выберите **+ новый шаг** в конструкторе и выполните следующие действия.
    1. Поиск **Office 365 Outlook — Отправка сообщения электронной почты**. 
    2. Выберите **Отправить сообщение электронной почты** по **действиям**. 
    
        ![Параметр отправки электронной почты](./media/devtest-lab-auto-shutdown/select-send-email.png)
    3. Выберите **войти** , чтобы войти в учетную запись электронной почты. 
    4. Выберите **поле и щелкните владелец** .
    5. Выберите **Тема**и введите тему уведомления по электронной почте. Например: "завершение работы Machine vmName для Lab: Лабнаме".
    6. Выберите **текст**и укажите содержимое текста для уведомления по электронной почте. Например: "vmName завершает работу через 15 минут. Пропустите это завершение, щелкнув: URL-адрес. Задержка завершения работы в течение часа: delayUrl60. Задержка завершения работы в течение 2 часов: delayUrl120.

        ![Схема JSON текста запроса](./media/devtest-lab-auto-shutdown/email-options.png)
1. На панели инструментов щелкните **Сохранить**. Теперь можно скопировать **URL-адрес HTTP POST**. Нажмите кнопку Копировать, чтобы скопировать URL-адрес в буфер обмена. 

    ![URL веб-перехватчика](./media/devtest-lab-auto-shutdown/webhook-url.png)

## <a name="configure-autoshutdown-for-compute-vms"></a>Настройка автоматического завершения работы для виртуальных машин вычислений

1. На странице **Виртуальная машина** в меню слева выберите **Автоматическое завершение работы** . 
2. На странице **Автоматическое завершение работы** выберите **вкл** ., чтобы включить эту политику **, и отключите** ее.
3. Если эта политика включена, укажите **время** (и часовой **пояс**), в течение которого должна быть завершена работа виртуальной машины.
4. Укажите **Yes** или **No** (да или нет), чтобы отправить уведомление через 30 минут до указанного времени автоматического завершения работы. Выбрав **Да**, укажите конечную точку в виде URL-адреса веб-перехватчика, где будут публиковаться уведомления, или адрес электронной почты, на который будут отправляться такие уведомления. При получении уведомления пользователь получает возможность отложить завершение работы. Дополнительные сведения см. в разделе " [уведомления](#notifications) ". 
9. Щелкните **Сохранить**.

    ![Настройка автоматического завершения работы для вычислений виртуальной машины](./media/devtest-lab-auto-shutdown/comnpute-auto-shutdown.png)

## <a name="next-steps"></a>Дальнейшие действия
Сведения о настройке всех политик см. в разделе [Определение политик лаборатории в Azure DevTest Labs](devtest-lab-set-lab-policy.md).

