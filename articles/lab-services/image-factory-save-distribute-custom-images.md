---
title: Сохранить и распространять изображения в Лабораториях Azure DevTest (ru) Документы Майкрософт
description: В этой статье приводятся шаги по сохранению пользовательских изображений из уже созданных виртуальных машин (VM) в Лабораториях Azure DevTest Labs.
services: devtest-lab, lab-services
documentationcenter: na
author: spelluru
manager: femila
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/24/2020
ms.author: spelluru
ms.openlocfilehash: e5bc8e5041bfe6d95e3ff1a93bb3338ccead5bb4
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76759437"
---
# <a name="save-custom-images-and-distribute-to-multiple-labs"></a>Сохранение пользовательских образов и их распространение в несколько лабораторий
Эта статья дает вам шаги, чтобы сохранить пользовательские изображения из уже созданных виртуальных машин (VMs). В нем также рассказывается о том, как распространять эти пользовательские изображения в других Лабораториях DevTest в организации.

## <a name="prerequisites"></a>Предварительные требования
Следующие элементы уже должны быть на месте:

- Лаборатория для фабрики изображений в Лабораториях Azure DevTest Labs.
- Проект Azure DevOps, используемый для автоматизации фабрики изображений.
- Местоположение исходного кода, содержащее скрипты и конфигурацию (в нашем примере, в том же проекте DevOps, упомянутом на предыдущем этапе).
- Создайте определение для организации задач Azure Powershell.

При необходимости выполните шаги в [запуске фабрики изображений из Azure DevOps](image-factory-set-up-devops-lab.md) для создания или настройки этих элементов. 

## <a name="save-vms-as-generalized-vhds"></a>Сохранить VMs как обобщенные VHDs
Сохранить существующие VMs в качестве обобщенных VHDs.  Есть пример скрипта PowerShell для сохранения существующих VM в виде обобщенных VHD. Во-первых, добавьте еще одну задачу **Azure Powershell** в определение сборки, как показано на следующем изображении:

![Добавить шаг Azure PowerShell](./media/save-distribute-custom-images/powershell-step.png)

Если у вас есть новая задача в списке, выберите элемент, чтобы мы могли заполнить все детали, как показано на следующем изображении: 

![Настройки PowerShell](./media/save-distribute-custom-images/powershell-settings.png)


## <a name="generalized-vs-specialized-custom-images"></a>Обобщенные и специализированные пользовательские изображения
На [портале Azure](https://portal.azure.com)при создании пользовательского изображения из виртуальной машины можно выбрать обобщенное или специализированное пользовательское изображение.

- **Специализированное пользовательское изображение:** Sysprep/Deprovision не был запущен на машине. Это означает, что изображение является точной копией диска ОС на существующей виртуальной машине (снимок).  Те же файлы, приложения, учетные записи пользователей, имя компьютера и так далее, все присутствуют, когда мы создаем новую машину из этого пользовательского изображения.
- **Обобщенные пользовательские изображения:** Sysprep/Deprovision был запущен на машине.  Когда этот процесс выполняется, он удаляет учетные записи пользователей, удаляет имя компьютера, лишает пользовательский реестр ульев и т.д., с целью обобщения изображения, чтобы он мог быть настроен при создании другой виртуальной машины.  При обобщении виртуальной машины (при запуске sysprep), процесс разрушает текущую виртуальную машину - она больше не будет функциональной.

Скрипт для привязки пользовательских изображений на фабрике изображений позволит сохранить VHD для любых виртуальных машин, созданных на предыдущем этапе (идентифицированных на основе тега на ресурсе в Azure).

## <a name="update-configuration-for-distributing-images"></a>Конфигурация обновления для распространения изображений
Следующим шагом в этом процессе является нажатие пользовательских изображений из лаборатории завода изображений в любые другие лаборатории, которые в них нуждаются. Основной частью этого процесса является файл конфигурации **labs.json.** Этот файл можно найти в папке **Конфигурация,** включенной в фабрику изображений.

В файле конфигурации labs.json перечислены две ключевые вещи:

- Уникальное определение конкретной лаборатории назначения с использованием идентификатора подписки и названия лаборатории.
- Конкретный набор изображений, которые должны быть перемещены в лабораторию в качестве относительных путей к корню конфигурации. Вы можете указать всю папку (чтобы получить все изображения в этой папке) тоже.

Вот пример файла labs.json с двумя перечисленными лабораториями. В этом случае вы распространяете изображения в двух разных лабораториях.

```json
{
   "Labs": [
      {
         "SubscriptionId": "<subscription ID that contains the lab>",
         "LabName": "<Name of the DevTest Lab>",
         "ImagePaths": [
               "Win2012R2",
               "Win2016/Datacenter.json"
         ]
      },
      {
         "SubscriptionId": "<subscription ID that contains the lab>",
         "LabName": "<Name of the DevTest Lab>",
         "ImagePaths": [
               "Win2016/Datacenter.json"
         ]
      }
   ]
}
```

## <a name="create-a-build-task"></a>Создание задачи сборки
Используя те же шаги, которые вы видели ранее в этой статье, добавьте дополнительную задачу сборки **Azure Powershell** для определения сборки. Заполните детали, как показано на следующем изображении: 

![Создание задачи для распространения изображений](./media/save-distribute-custom-images/second-build-task-powershell.png)

Параметры:`-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -SubscriptionId $(SubscriptionId) -DevTestLabName $(DevTestLabName) -maxConcurrentJobs 20`

Эта задача принимает любые пользовательские изображения, присутствующие на фабрике изображений, и выталкивает их в любые лаборатории, определенные в файле Labs.json.

## <a name="queue-the-build"></a>Очередь сборки
После завершения задачи сборки распределения выстраивайте новую сборку в очередь, чтобы убедиться, что все работает. После успешного завершения сборки новые пользовательские изображения будут отображаться в лаборатории назначения, которая была введена в файл конфигурации Labs.json.

## <a name="next-steps"></a>Дальнейшие действия
В следующей статье в серии вы обновляете фабрику изображений с помощью политики удержания и шагов по очистке: [установите политику удержания и запустите скрипты очистки.](image-factory-set-retention-policy-cleanup.md)
