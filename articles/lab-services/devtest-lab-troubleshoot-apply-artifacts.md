---
title: Проблемы с устранением проблем с артефактами в Лабораториях Azure DevTest (ru) Документы Майкрософт
description: Узнайте, как устранить проблемы, возникающие при применении артефактов в виртуальной машине Azure DevTest Labs.
services: devtest-lab
documentationcenter: na
author: spelluru
editor: ''
ms.service: devtest-lab
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/03/2019
ms.author: spelluru
ms.openlocfilehash: fc5051667100a2ebaa01b7815f825fadd766b08f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75456988"
---
# <a name="troubleshoot-issues-when-applying-artifacts-in-an-azure-devtest-labs-virtual-machine"></a>Проблемы устранения неполадок при применении артефактов в виртуальной машине Azure DevTest Labs
Применение артефактов на виртуальной машине может потерпеть неудачу по разным причинам. Эта статья поможет вам найти некоторые из методов, чтобы помочь определить возможные причины.

Если вам нужна дополнительная помощь в какой-либо момент в этой статье, вы можете связаться с экспертами Azure DevTest Labs (DTL) на [форумах MSDN Azure и Stack Overflow.](https://azure.microsoft.com/support/forums/) Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите «Получите поддержку».   

> [!NOTE]
> Эта статья относится как к Windows, так и к виртуальным компьютерам, не входящих в Windows. Хотя есть некоторые различия, они будут четко названы в этой статье.

## <a name="quick-troubleshooting-steps"></a>Действия по устранению неполадок
Убедитесь, что VM работает. DevTest Labs требует, чтобы VM работал и чтобы был установлен и готов [виртуальный машинный агент Microsoft Azure (VM Agent).](../virtual-machines/extensions/agent-windows.md)

> [!TIP]
> На **портале Azure**перейдите на страницу **артефактов Управления** для VM, чтобы узнать, готов ли VM к применению артефактов. Вы видите сообщение в самом верху этой страницы. 
> 
> Используя **Azure PowerShell,** проинспектировать флаг **canApplyArtifacts,** который возвращается только при расширении операции GET. Смотрите следующий пример команды:

```powershell
Select-AzSubscription -SubscriptionId $SubscriptionId | Out-Null
$vm = Get-AzResource `
        -Name "$LabName/$VmName" `
        -ResourceGroupName $LabRgName `
        -ResourceType 'microsoft.devtestlab/labs/virtualmachines' `
        -ApiVersion '2018-10-15-preview' `
        -ODataQuery '$expand=Properties($expand=ComputeVm)'
$vm.Properties.canApplyArtifacts
```

## <a name="ways-to-troubleshoot"></a>Способы устранения неполадок 
Вы можете устранить проблемы, созданные с помощью DevTest Labs и модели развертывания ресурсного менеджера, используя один из следующих методов:

- **Портал Azure** - отлично, если вам нужно быстро получить визуальный намек на то, что может быть причиной проблемы.
- **Azure PowerShell** - если вам удобно использовать запрос PowerShell, быстро задавайте запрос ресурсов DevTest Labs с помощью cmdlets Azure PowerShell.

> [!TIP]
> Для получения дополнительной информации о том, как просмотреть выполнение артефактов в VM, [см.](devtest-lab-troubleshoot-artifact-failure.md)

## <a name="symptoms-causes-and-potential-resolutions"></a>Симптомы, причины и потенциальные разрешения 

### <a name="artifact-appears-to-hang"></a>Артефакт, кажется, завис   
Артефакт, кажется, висит до истечения заранее определенного периода тайм-аута, и артефакт помечен как **неудавшийся**.

Когда артефакт, кажется, завис, сначала определите, где он застрял. Артефакт может быть заблокирован на любом из следующих шагов во время выполнения:

- **Во время первоначального запроса**. DevTest Labs создает шаблон менеджера ресурсов Azure для запроса на использование расширения пользовательских скриптов (CSE). Таким образом, за кулисами срабатывает развертывание группы ресурсов. При ошибке на этом уровне вы получаете подробную информацию в **журналах активности группы** ресурсов для вм.  
    - Вы можете получить доступ к журналу активности из панели навигации страницы vM. При выборе вы видите запись для **нанесения артефактов на виртуальную машину** (если операция приприменимых артефактов была срабатывана напрямую) или **добавить или изменить виртуальные машины** (если операция прикладных артефактов была частью процесса создания VM).
    - Ищите ошибки под этими записями. Иногда ошибка не будет помечена соответствующим образом, и вам придется исследовать каждую запись.
    - При изучении деталей каждой записи, убедитесь, что просмотрите содержимое полезной нагрузки JSON. Вы можете увидеть ошибку в нижней части этого документа.
- **При попытке выполнить артефакт**. Это может быть из-за сетей или проблем хранения. Подробности смотрите в соответствующем разделе позже в этой статье. Это также может произойти из-за способа авторизации сценария. Пример:
    - Скрипт PowerShell имеет **обязательные параметры,** но один не может передать значение ему, либо потому, что вы позволяете пользователю оставить его пустым, или потому, что у вас нет значения по умолчанию для свойства в файле определения artifactfile.json. Скрипт будет висеть, потому что он ожидает пользовательского ввода.
    - Скрипт PowerShell **требует ввода пользователем** как часть выполнения. Скрипты должны быть написаны для бесшумной работы, не требуя вмешательства пользователя.
- **VM Agent занимает много времени, чтобы быть готовым.** Когда VM только запускается, или когда пользовательское расширение скрипта впервые установлено для обслуживания запроса на применение артефактов, VM может потребовать либо модернизации VM Agent, либо ждать, пока Агент VM инициализируется. Там могут быть услуги, от которых VM Агент зависит, которые принимают долгое время, чтобы инициализировать. В таких случаях смотрите [обзор агента виртуальной машины Azure](../virtual-machines/extensions/agent-windows.md) для дальнейшего устранения неполадок.

### <a name="to-verify-if-the-artifact-appears-to-hang-because-of-the-script"></a>Проверить, висит ли артефакт из-за сценария

1. Войти в виртуальную машину в вопросе.
2. Копировать сценарий локально в виртуальной машине или `C:\Packages\Plugins\Microsoft.Compute.CustomScriptExtension\<version>`найти его на виртуальной машине под . Это место, где загружаются скрипты артефактов.
3. Используя запрос повышенной команды, выполните сценарий локально, предоставляя те же значения параметров, которые используются для причины проблемы.
4. Определите, страдает ли скрипт каким-либо нежелательным поведением. Если это так, либо запросить обновление артефакта (если это от публичного репо); или, внести коррективы самостоятельно (если это от вашего частного репо).

> [!TIP]
> Вы можете исправить проблемы с артефактами, размещенными в нашем [публичном репо,](https://github.com/Azure/azure-devtestlab) и отправить изменения для нашего обзора и утверждения. Смотрите раздел **Вклады** в [README.md](https://github.com/Azure/azure-devtestlab/blob/master/Artifacts/README.md) документе.
> 
> Для получения информации о написании собственных артефактов [AUTHORING.md](https://github.com/Azure/azure-devtestlab/blob/master/Artifacts/AUTHORING.md) см.

### <a name="to-verify-if-the-artifact-appears-to-hang-because-of-the-vm-agent"></a>Чтобы проверить, висит ли артефакт из-за агента VM:
1. Войти в виртуальную машину в вопросе.
2. Использование файлового проводника навигации по **C: »WindowsAzure » журналы**.
3. Найдите и откройте файл **WaAppAgent.log**.
4. Ищите записи, которые показывают, когда VM Agent начинается и когда он заканчивает инициализацию (то есть, первое сердцебиение отправляется). Предпочтение новые записи или конкретно те, вокруг периода времени, для которого вы испытываете проблемы.

    ```
    [00000006] [11/14/2019 05:52:13.44] [INFO]  WindowsAzureGuestAgent starting. Version 2.7.41491.949
    ...
    [00000006] [11/14/2019 05:52:31.77] [WARN]  Waiting for OOBE to Complete ...
    ...
    [00000006] [11/14/2019 06:02:30.43] [WARN]  Waiting for OOBE to Complete ...
    [00000006] [11/14/2019 06:02:33.43] [INFO]  StateExecutor initialization completed.
    [00000020] [11/14/2019 06:02:33.43] [HEART] WindowsAzureGuestAgent Heartbeat.
    ```
    В этом примере вы можете видеть, что время запуска VM Agent заняло 10 минут и 20 секунд, потому что было отправлено сердцебиение. Причиной в этом случае была услуга OOBE занимает много времени, чтобы начать.

> [!TIP]
> Для получения общей информации о [Azure virtual machine extensions and features](../virtual-machines/extensions/overview.md)расширениях Azure см.

## <a name="storage-errors"></a>Ошибки хранения
DevTest Labs требует доступа к учетной записи хранилища лаборатории, которая создается для кэша артефактов. Когда DevTest Labs применяет артефакт, он будет читать конфигурацию артефакта и его файлы из настроенных репозиториев. По умолчанию DevTest Labs настраивает доступ к **публичному репо артефактов.**

В зависимости от того, как настроен VM, он может не иметь прямого доступа к этому репо. Таким образом, по замыслу DevTest Labs кэширует артефакты в учетной записи хранения, созданной при первой инициализации лаборатории.

Если доступ к этой учетной записи хранилища заблокирован каким-либо образом, как это происходит при блокировке трафика из VM в службу хранения Azure, может возникнуть ошибка, аналогичная следующей:

```shell
CSE Error: Failed to download all specified files. Exiting. Exception: Microsoft.WindowsAzure.Storage.StorageException: The remote server returned an error: (403) Forbidden. ---> System.Net.WebException: The remote server returned an error: (403) Forbidden.
```

Вышеупомянутая ошибка будет отображаться в разделе **Сообщение развертывания** на странице **результатов Артефакта** под **артефактами управления.** Он также появится в **журналах активности** под группой ресурсов виртуальной машины, о котором идет речь.

### <a name="to-ensure-communication-to-the-azure-storage-service-isnt-being-blocked"></a>Чтобы связь с службой хранения Azure не была заблокирована:

- **Проверьте наличие дополнительных групп сетевой безопасности (NSG).** Возможно, была добавлена политика подписки, когда НСГ автоматически настраиваются во все виртуальные сети. Это также повлияет на виртуальную сеть лаборатории по умолчанию, если она используется, или другой виртуальной сети, настроенной в вашей лаборатории, используемой для создания виртуальных технологий.
- **Проверьте учетную запись хранилища лаборатории по умолчанию** (т.е. первая учетная запись хранилища, созданная при создании лаборатории,\<имя\>которой обычно начинается с буквы "а" и заканчивается многозначным номером, то есть лабораторным именем).
    1. Перейдите к группе ресурсов лаборатории.
    2. Найдите ресурс **учетной записи хранения**типов, название которого совпадает с конвенцией.
    3. Перейдите на страницу учетной записи хранилища под названием **Firewalls и виртуальные сети.**
    4. Убедитесь, что он установлен для **всех сетей.** Если выбран **вариант «Выбранные сети»,** убедитесь, что виртуальные сети лаборатории, используемые для создания виртуальных технологий, будут добавлены в список.

Для более глубокого устранения неполадок [см.](../storage/common/storage-network-security.md)

> [!TIP]
> **Проверить правила группы сетевой безопасности**. Используйте [проверку потока IP,](../network-watcher/diagnose-vm-network-traffic-filtering-problem.md#use-ip-flow-verify) чтобы подтвердить, что правило в группе сетевой безопасности блокирует трафик на или из виртуальной машины. Вы также можете просмотреть эффективные правила группы безопасности, чтобы убедиться, что существует входящие правила **Разрешить** NSG. Дополнительные сведения см. в разделе [Использование действующих правил безопасности для устранения проблем с потоком трафика в виртуальной машине](../virtual-network/diagnose-network-traffic-filter-problem.md).

## <a name="other-sources-of-error"></a>Другие источники ошибки
Существуют и другие менее частые возможные источники ошибок. Убедитесь в том, чтобы оценить каждый, чтобы увидеть, если это относится к вашему делу. Вот один из них: 

- **Срок действия токена для личного репо.** По истечении срока действия артефакт не будет включен в список, и все сценарии, относяющиеся к артефактам из репозитория с истекшим частным токеном доступа, сбой соответственно.

## <a name="next-steps"></a>Дальнейшие действия
Если ни одна из этих ошибок не произошла и вы все еще не можете применить артефакты, можно подать инцидент поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите **«Получите поддержку».**

