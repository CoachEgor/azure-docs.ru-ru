---
title: Мониторинг операций, событий и счетчиков для общедоступной службы Load Balancer ценовой категории "Базовый"
titleSuffix: Azure Load Balancer
description: Узнайте, как включить ведение журналов событий оповещений и проверки работоспособности для общедоступного Load Balancer ценовой категории "Базовый"
services: load-balancer
documentationcenter: na
author: asudbring
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.custom: seodec18
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2020
ms.author: allensu
ms.openlocfilehash: 7563eb4d22048021886925f6864e3616bed83a75
ms.sourcegitcommit: c535228f0b77eb7592697556b23c4e436ec29f96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82858762"
---
# <a name="azure-monitor-logs-for-public-basic-load-balancer"></a>Журналы Azure Monitor для общедоступной службы Load Balancer (цен. категория "Базовый")

В Azure можно использовать различные виды журналов для управления Load Balancer ценовой категории "Базовый" и устранения возникающих в них неполадок. Доступ к некоторым из этих журналов можно получить через портал. Журналы можно передавать в концентратор событий или в рабочую область Log Analytics. Все журналы можно извлечь из хранилища BLOB-объектов Azure и просматривать в различных средствах, таких как Excel и Power BI.  В списке ниже приведены дополнительные сведения о различных типах журналов.

* **Журналы действий:** С помощью команды [Просмотр журналов действий можно отслеживать действия с ресурсами](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-audit) , чтобы просмотреть все действия, отправляемые в ваши подписки Azure, и их состояние. Журналы действий включены по умолчанию и могут быть просмотрены в портал Azure.
* **Журналы событий оповещений.** Эти журналы можно использовать для просмотра оповещений, создаваемых для подсистемы балансировки нагрузки. Данные о состоянии балансировщика нагрузки собираются каждые пять минут. В этом журнале делается запись, только если возникает событие оповещения балансировщика нагрузки.
* **Журналы проверки работоспособности**. Эти журналы можно использовать для просмотра проблем, обнаруженных при проверке работоспособности, включая сведения о числе экземпляров во внутреннем пуле, которые не получают запросы от подсистемы балансировки нагрузки из-за ошибок проверки работоспособности. Эти журналы записываются при изменении состояния в ходе проверки работоспособности.

> [!IMPORTANT]
> Журналы Azure Monitor в настоящее время работают только для общедоступных подсистем балансировки нагрузки. Журналы доступны только для ресурсов, развернутых в модели развертывания диспетчера ресурсов. Журналы нельзя использовать для ресурсов в классической модели развертывания. Дополнительные сведения о моделях развертывания см. в статье, посвященной [развертыванию с помощью Resource Manager и классическому развертыванию](../azure-resource-manager/management/deployment-models.md).

## <a name="enable-logging"></a>Включение ведения журналов

Ведение журнала действий автоматически включается для каждого ресурса Resource Manager. Включите ведение журнала событий и проверки работоспособности, чтобы начать сбор данных, доступных в этих журналах. Вот как можно включить ведение журнала:

Войдите на [портал Azure](https://portal.azure.com). Если у вас еще нет балансировщика нагрузки, [создайте балансировщик нагрузки](https://docs.microsoft.com/azure/load-balancer/quickstart-create-basic-load-balancer-portal) перед продолжением.

1. На портале щелкните **группы ресурсов**.
2. Выберите ** \<Resource-Group-Name>** , где находится подсистема балансировки нагрузки.
3. Выберите подсистему балансировки нагрузки.
4. Выберите **мониторинг** > **параметры диагностики**.
5. В области **параметры диагностики** в разделе **параметры диагностики**выберите **+ Добавить параметр диагностики**.
6. В области создание **параметров диагностики** введите **Милбдиагностикс** в поле **имя** .
7. У вас есть три варианта **параметров диагностики**.  Вы можете выбрать один, два или все три и настроить каждый из них в соответствие с вашими требованиями:
   * **Архивация в учетную запись хранения**
   * **Поток в концентратор событий**
   * **Отправка в Log Analytics**

    ### <a name="archive-to-a-storage-account"></a>"Архивировать в учетной записи хранения";
    Для этого процесса потребуется учетная запись хранения, созданная ранее.  Сведения о создании учетной записи хранения см. в статье [Создание учетной записи хранения](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account?tabs=azure-portal) .

    1. Установите флажок **архивировать в учетную запись хранения**.
    2. Щелкните **настроить** , чтобы открыть панель **Выбор учетной записи хранения** .
    3. В раскрывающемся списке выберите **подписку** , в которой была создана учетная запись хранения.
    4. В раскрывающемся списке выберите имя учетной записи хранения в разделе **учетная запись хранения** .
    5. Нажмите кнопку "ОК".

    ### <a name="stream-to-an-event-hub"></a>"Передать в концентратор событий";
    Вам потребуется концентратор событий, уже созданный для этого процесса.  Сведения о создании концентратора событий см [. в разделе Краткое руководство. Создание концентратора событий с помощью портал Azure](https://docs.microsoft.com/azure/event-hubs/event-hubs-create)

    1. Установите флажок рядом с пунктом **потоковая передача в концентратор событий** .
    2. Щелкните **настроить** , чтобы открыть панель **Выбор концентратора событий** .
    3. В раскрывающемся списке выберите **подписку** , в которой был создан концентратор событий.
    4. В раскрывающемся списке **выберите пространство имен концентратора событий** .
    5. В раскрывающемся списке **выберите имя политики концентратора событий** .
    6. Нажмите кнопку "ОК".

    ### <a name="send-to-log-analytics"></a>Отправка в Log Analytics
    Для этого процесса необходимо, чтобы Рабочая область log Analytics была создана и настроена.  Сведения о создании рабочей области Log Analytics см. в разделе [создание log Analytics рабочей области на портал Azure](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace)

    1. Установите флажок рядом с пунктом **отправить на log Analytics**.
    2. В раскрывающемся списке выберите **подписку** , в которой находится рабочая область log Analytics.
    3. Выберите **рабочую область log Analytics** в раскрывающемся списке.


8. Под разделом **Журнал** в области **параметры диагностики** установите флажки рядом с ними.
   * **LoadBalancerAlertEvent**
   * **LoadBalancerProbeHealthStatus**

9.  Под разделом **Метрика** в области " **параметры диагностики** " установите флажок рядом с:
   * **аллметрикс**

11. Убедитесь, что все выглядит правильно, и нажмите кнопку **сохранить** в верхней части панели Создание **параметров диагностики** .

## <a name="activity-log"></a>Журнал действий

Журнал действий создается по умолчанию. Журналы хранятся в течение 90 дней в хранилище журналов событий Azure. Дополнительные сведения об этих журналах см. в статье [Просмотр журналов действий для отслеживания действий с ресурсами](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-audit) .

## <a name="archive-to-storage-account-logs"></a>Архивировать в журналы учетной записи хранения

### <a name="alert-event-log"></a>Журнал событий оповещений

Этот журнал создается только в том случае, если он включен для конкретной подсистемы балансировки нагрузки. События регистрируются в формате JSON и хранятся в учетной записи хранения, указанной при включении ведения журнала. Следующий пример относится к событию.

```json
{
    "time": "2016-01-26T10:37:46.6024215Z",
    "systemId": "32077926-b9c4-42fb-94c1-762e528b5b27",
    "category": "LoadBalancerAlertEvent",
    "resourceId": "/SUBSCRIPTIONS/XXXXXXXXXXXXXXXXX-XXXX-XXXX-XXXXXXXXX/RESOURCEGROUPS/RG7/PROVIDERS/MICROSOFT.NETWORK/LOADBALANCERS/WWEBLB",
    "operationName": "LoadBalancerProbeHealthStatus",
    "properties": {
        "eventName": "Resource Limits Hit",
        "eventDescription": "Ports exhausted",
        "eventProperties": {
            "public ip address": "40.117.227.32"
        }
    }
}
```

В выходных данных JSON показано свойство *EventName* , описывающее причину создания предупреждения подсистемой балансировки нагрузки. В этом случае оповещение создано из-за нехватки портов TCP, вызванных ограничениями NAT источника (SNAT).

### <a name="health-probe-log"></a>Журнал проверки работоспособности

Этот журнал создается только в том случае, если он включен для конкретного балансировщика нагрузки, как описано выше. Данные хранятся в учетной записи хранения, указанной при включении ведения журнала. Создается контейнер с именем insights-logs-loadbalancerprobehealthstatus, и в журнал записываются следующие данные.

```json
{
    "records":[
    {
        "time": "2016-01-26T10:37:46.6024215Z",
        "systemId": "32077926-b9c4-42fb-94c1-762e528b5b27",
        "category": "LoadBalancerProbeHealthStatus",
        "resourceId": "/SUBSCRIPTIONS/XXXXXXXXXXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXX/RESOURCEGROUPS/RG7/PROVIDERS/MICROSOFT.NETWORK/LOADBALANCERS/WWEBLB",
        "operationName": "LoadBalancerProbeHealthStatus",
        "properties": {
            "publicIpAddress": "40.83.190.158",
            "port": "81",
            "totalDipCount": 2,
            "dipDownCount": 1,
            "healthPercentage": 50.000000
        }
    },
    {
        "time": "2016-01-26T10:37:46.6024215Z",
        "systemId": "32077926-b9c4-42fb-94c1-762e528b5b27",
        "category": "LoadBalancerProbeHealthStatus",
        "resourceId": "/SUBSCRIPTIONS/XXXXXXXXXXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXX/RESOURCEGROUPS/RG7/PROVIDERS/MICROSOFT.NETWORK/LOADBALANCERS/WWEBLB",
        "operationName": "LoadBalancerProbeHealthStatus",
        "properties": {
            "publicIpAddress": "40.83.190.158",
            "port": "81",
            "totalDipCount": 2,
            "dipDownCount": 0,
            "healthPercentage": 100.000000
        }
    }]
}
```

В выходных данных JSON в поле свойств отображаются основные сведения о состоянии проверки работоспособности. Свойство *дипдовнкаунт* показывает общее количество экземпляров на серверной части, которые не получают сетевой трафик из-за неудачных ответов проверки.

### <a name="view-and-analyze-the-activity-log"></a>Просмотр и анализ журнала действий

Данные журнала действий можно просматривать и анализировать с помощью любого из следующих методов:

* **Средства Azure:** Получите сведения из журнала действий с помощью Azure PowerShell, интерфейса командной строки Azure (CLI), REST API Azure или портал Azure. Пошаговые инструкции для каждого метода подробно описаны в статье [Операции аудита с помощью диспетчера ресурсов](../azure-resource-manager/management/view-activity-logs.md) .
* **Power BI.** Если у вас еще нет учетной записи [Power BI](https:// .microsoft.com/pricing) , ее можно опробовать бесплатно. Используя [пакет содержимого "Журналы аудита Azure" для Power BI](https:// .microsoft.com/documentation/ -content-pack-azure-audit-logs), можно анализировать данные с помощью предварительно настроенных панелей мониторинга или дополнительно настроить представление данных в зависимости от своих потребностей.

### <a name="view-and-analyze-the-health-probe-and-event-log"></a>Просмотр и анализ журналов событий и проверки работоспособности

Подключитесь к учетной записи хранения и получите записи журнала JSON для журналов событий и проверки работоспособности. После загрузки JSON-файлов их можно преобразовать в формат CSV и просматривать в Excel, Power BI или любом другом средстве визуализации данных.

> [!TIP]
> Если вы знакомы с Visual Studio и основными понятиями изменения значений констант и переменных в C#, можно использовать [инструменты преобразования журналов](https://github.com/Azure-Samples/networking-dotnet-log-converter), доступные на сайте GitHub.

## <a name="stream-to-an-event-hub"></a>"Передать в концентратор событий";
Когда диагностические данные передаются в концентратор событий, их можно использовать для централизованного анализа журналов в средстве SIEM стороннего производителя с интеграцией Azure Monitor. Дополнительные сведения см. [в статье потоковая передача данных мониторинга Azure в концентратор событий](../azure-monitor/platform/stream-monitoring-data-event-hubs.md#partner-tools-with-azure-monitor-integration) .

## <a name="send-to-log-analytics"></a>Отправка в Log Analytics
Ресурсы в Azure могут отправлять диагностические сведения непосредственно в Log Analytics рабочую область, где можно выполнять сложные запросы к информации для устранения неполадок и анализа.  Дополнительные сведения см. в статье [Получение журналов ресурсов Azure в log Analytics рабочей области в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/platform/resource-logs-collect-workspace)

## <a name="next-steps"></a>Дальнейшие шаги

[Основные сведения о пробах подсистемы балансировки нагрузки](load-balancer-custom-probe-overview.md)
