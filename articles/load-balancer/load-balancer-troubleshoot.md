---
title: Устранение неполадок Azure Load Balancer
description: Узнайте, как устранять известные неполадки Azure Load Balancer.
services: load-balancer
documentationcenter: na
author: asudbring
manager: dcscontentpm
ms.custom: seodoc18
ms.service: load-balancer
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/28/2020
ms.author: allensu
ms.openlocfilehash: 1cfe27fd5c63bc4c1436982212b91e07f54aedb5
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85801926"
---
# <a name="troubleshoot-azure-load-balancer"></a>Устранение неполадок Azure Load Balancer

На этой странице представлены сведения об устранении распространенных неполадок Azure Load Balancer уровня "Стандартный" и "Базовый". См. дополнительные сведения в статье [Обзор Azure Load Balancer уровня "Стандартный" (предварительная версия)](load-balancer-standard-diagnostics.md).

Когда подключение к подсистеме балансировки нагрузки недоступно, наиболее распространенными симптомами являются следующие: 

- Виртуальные машины, находящиеся за подсистемой балансировки нагрузки, не отвечают на пробы работоспособности. 
- Виртуальные машины, находящиеся за подсистемой балансировки нагрузки, не отвечают на трафик на настроенном порте.

Когда внешние клиенты на внутренних виртуальных машинах проходят через подсистему балансировки нагрузки, для связи будут использоваться IP-адреса клиентов. Убедитесь, что IP-адреса клиентов добавлены в список разрешений NSG. 

## <a name="symptom-vms-behind-the-load-balancer-are-not-responding-to-health-probes"></a>Симптом. Виртуальные машины, находящиеся за подсистемой балансировки нагрузки, не отвечают на пробы работоспособности.
Чтобы внутренние серверы могли входить в набор подсистемы балансировки нагрузки, они должны пройти проверку работоспособности. Дополнительные сведения о пробах работоспособности см. в статье [Проверки балансировщика нагрузки](load-balancer-custom-probe-overview.md). 

Виртуальные машины внутреннего пула подсистемы балансировки нагрузки могут не отвечать на пробы по одной из следующих причин: 
- Виртуальная машина внутреннего пула подсистемы балансировки нагрузки неработоспособна. 
- Виртуальная машина внутреннего пула подсистемы балансировки нагрузки не ожидает передачи данных через порт пробы. 
- Брандмауэр или группа безопасности сети блокирует порт на виртуальных машинах внутреннего пула подсистемы балансировки нагрузки. 
- Другие неправильные настройки в подсистеме балансировки нагрузки.

### <a name="cause-1-load-balancer-backend-pool-vm-is-unhealthy"></a>Причина 1. Виртуальная машина внутреннего пула подсистемы балансировки нагрузки неработоспособна. 

**Проверка и способы устранения**

Чтобы устранить эту проблему, войдите в виртуальную машину, входящую в пул, и проверьте, находится ли она в работоспособном состоянии и может ли отвечать на запросы **PsPing** или **TCPing** от другой виртуальной машины в пуле. Если виртуальная машина неработоспособна или не отвечает на пробу, то необходимо устранить эту проблему и вернуть виртуальную машину в работоспособное состояние, прежде чем она сможет участвовать в балансировке нагрузки.

### <a name="cause-2-load-balancer-backend-pool-vm-is-not-listening-on-the-probe-port"></a>Причина 2. Виртуальная машина внутреннего пула подсистемы балансировки нагрузки не ожидает передачи данных через порт пробы.
Если виртуальная машина работоспособна, но не отвечает на пробу, то одной из возможных причин может быть то, что порт пробы не открыт на виртуальной машине, входящей в пул, или виртуальная машина не ожидает передачи данных через этот порт.

**Проверка и способы устранения**

1. Войдите в виртуальную машину внутреннего пула. 
2. Откройте командную строку и выполните следующую команду, чтобы убедиться, что приложение ожидает передачи данных через порт пробы:   
            netstat -an
3. Если для состояния порта не указано значение **Ожидает вызова**, то настройте соответствующий порт. 
4. Можно также выбрать другой порт, который находится в состоянии **Ожидает вызова**, и соответствующим образом обновить конфигурацию подсистемы балансировки нагрузки.              

### <a name="cause-3-firewall-or-a-network-security-group-is-blocking-the-port-on-the-load-balancer-backend-pool-vms"></a>Причина 3. Брандмауэр или группа безопасности сети блокирует порт на виртуальных машинах внутреннего пула подсистемы балансировки нагрузки.  
Если брандмауэр на виртуальной машине блокирует порт пробы, либо одна или несколько групп безопасности сети, настроенных в подсети или на виртуальной машине, не позволяют пробе достигнуть порта, то виртуальная машина не может ответить на пробу работоспособности.          

**Проверка и способы устранения**

* Если брандмауэр включен, то проверьте, разрешен ли в его настройках порт пробы. В противном случае настройте брандмауэр таким образом, чтобы он разрешал трафик через порт пробы, и повторите проверку. 
* В списке групп безопасности сети проверьте входящий и исходящий трафик через порт пробы на наличие помех. 
* Проверьте также наличие правила групп безопасности сети **Запретить все** в сетевой карте виртуальной машины или подсети, которое имеет более высокий приоритет, чем правило по умолчанию, позволяющее выполнение проб и трафик подсистемы балансировки нагрузки (в группах безопасности сети необходимо разрешить IP-адрес подсистемы балансировки нагрузки 168.63.129.16). 
* Если любое из этих правил блокирует трафик проб, то удалите и перенастройте правила, чтобы они разрешали такой трафик.  
* Проверьте, начала ли виртуальная машина отвечать на пробы работоспособности. 

### <a name="cause-4-other-misconfigurations-in-load-balancer"></a>Причина 4. Другие неправильные настройки в подсистеме балансировки нагрузки.
Если все выше перечисленные причины уже проверены, а способы устранения проблем опробованы, но виртуальная машины внутреннего пула по-прежнему не отвечает на пробу работоспособности, то необходимо вручную проверить подключение и собрать данные трассировок, чтобы понять ситуацию с подключением.

**Проверка и способы устранения**

* Воспользуйтесь командой **Psping** с любой другой виртуальной машины в виртуальной сети, чтобы проверить ответ порта пробы (пример: \psping.exe -t 10.0.0.4:3389), и запишите результаты. 
* Воспользуйтесь командой **TCPing** с любой другой виртуальной машины в виртуальной сети, чтобы проверить ответ порта пробы (пример: \tcping.exe 10.0.0.4 3389), и запишите результаты. 
* Если в результате этих проверок связи ответ не получен, то выполните следующие действия:
    - Выполните команду netsh trace одновременно на целевой виртуальной машине внутреннего пула и на другой тестовой виртуальной машине из той же виртуальной сети. Теперь запустите на некоторое время проверку PsPing, соберите данные трассировки сети, а затем остановите проверку. 
    - Проанализируйте запись сетевых данных и проверьте наличие входящих и исходящих пакетов, связанных с запросом проверки связи. 
        - Если на виртуальной машине внутреннего пула не обнаруживаются входящие пакеты, то, возможно, были неправильно настроены группы безопасности сети или определяемые пользователем маршруты, из-за чего блокируется трафик. 
        - Если на виртуальной машине внутреннего пула не обнаруживаются исходящие пакеты, то эту виртуальную машину необходимо проверить на наличие любых несвязанных проблем (например, порт пробы блокируется приложением). 
    - Проверьте, не передаются ли пакеты пробы принудительно в другое назначение (возможно, с помощью параметров определяемых пользователем маршрутов), прежде чем они достигают подсистемы балансировки нагрузки. Из-за этого трафик может не достигать виртуальной машины внутреннего пула. 
* Измените тип пробы (например, с HTTP на TCP) и настройте соответствующий порт в списках ACL групп безопасности сети и брандмауэре, чтобы выполнялась проверка наличия проблем с настройкой ответа пробы. Дополнительные сведения о настройке проб работоспособности см. в записи блога [Endpoint Load Balancing Heath Probe Configuration Details](https://blogs.msdn.microsoft.com/mast/2016/01/26/endpoint-load-balancing-heath-probe-configuration-details/) (Сведения о настройке проб работоспособности балансировки нагрузки для конечных точек).

## <a name="symptom-vms-behind-load-balancer-are-not-responding-to-traffic-on-the-configured-data-port"></a>Симптом. Виртуальные машины, находящиеся за подсистемой балансировки нагрузки, не отвечают на трафик на настроенном порте данных

Если виртуальная машина внутреннего пула указана в списке как работоспособная и отвечает на пробы работоспособности, но по-прежнему не участвует в балансировке нагрузки или не отвечает на трафик данных, то это может быть вызвано следующими причинами: 
* Виртуальная машина внутреннего пула подсистемы балансировки нагрузки не ожидает передачи данных через порт данных. 
* Группа безопасности сети блокирует порт на виртуальной машине внутреннего пула подсистемы балансировки нагрузки.  
* Доступ к подсистеме балансировки нагрузки осуществляется с одной виртуальной машины и сетевой карты. 
* Доступ к интерфейсу Интернета Load Balancer осуществляется из виртуальной машины серверного пула подсистемы Load Balancer. 

### <a name="cause-1-load-balancer-backend-pool-vm-is-not-listening-on-the-data-port"></a>Причина 1. Виртуальная машина внутреннего пула подсистемы балансировки нагрузки не ожидает передачи данных через порт данных. 
Если виртуальная машина не отвечает на трафик данных, то это может быть вызвано тем, что целевой порт не открыт на виртуальной машине, входящей в пул, или виртуальная машина не ожидает передачи данных через этот порт. 

**Проверка и способы устранения**

1. Войдите в виртуальную машину внутреннего пула. 
2. Откройте командную строку и выполните следующую команду, чтобы убедиться, что приложение ожидает передачи данных через порт данных:  netstat -an 
3. Если для состояния порта не указано значение "Ожидает вызова", настройте соответствующий порт прослушивателя. 
4. Если порт отмечен как "Ожидает вызова", то проверьте наличие неполадок в целевом приложении на этом порте.

### <a name="cause-2-network-security-group-is-blocking-the-port-on-the-load-balancer-backend-pool-vm"></a>Причина 2. Группа безопасности сети блокирует порт на виртуальной машине внутреннего пула подсистемы балансировки нагрузки.  

Если одна или несколько групп безопасности сети, настроенных в подсети или на виртуальной машине, блокируют исходный IP-адрес или порт, то виртуальная машина не может ответить.

В общедоступной подсистеме балансировки нагрузки для обмена данными между клиентами и серверными виртуальными машинами подсистемы балансировки нагрузки будут использоваться IP-адреса клиентов Интернета. Убедитесь, что IP-адреса клиентов разрешены в группе безопасности сети серверной виртуальной машины.

1. Откройте список групп безопасности сети, настроенных на виртуальной машине внутреннего пула. Дополнительные сведения см. в статье об [управлении группами безопасности сети](../virtual-network/manage-network-security-group.md)
1. В списке групп безопасности сети проверьте:
    - наличие помех для входящего или исходящего трафика через порт данных; 
    - наличие правила групп безопасности сети **Запретить все** в сетевой карте виртуальной машины или подсети, которое имеет более высокий приоритет, чем правило по умолчанию, позволяющее выполнение проб и трафик подсистемы балансировки нагрузки (в группах безопасности сети необходимо разрешить IP-адрес подсистемы балансировки нагрузки 168.63.129.16, который является портом пробы).
1. Если любое из правил блокирует трафик, то удалите и перенастройте правила, чтобы они разрешали трафик данных.  
1. Проверьте, начала ли виртуальная машина отвечать на пробы работоспособности.

### <a name="cause-3-accessing-the-load-balancer-from-the-same-vm-and-network-interface"></a>Причина 3. Доступ к подсистеме балансировки нагрузки осуществляется с одной виртуальной машины и сетевого интерфейса 

Если приложение, размещенное в виртуальной машине внутреннего пула подсистемы балансировки нагрузки, попытается получить доступ к другому приложению, размещенному в той же виртуальной машине внутреннего пула, через тот же сетевой интерфейс, то такой сценарий не поддерживается, и операция завершится ошибкой. 

**Способы устранения**. Чтобы устранить эту проблему, используйте один из указанных ниже способов.
* Настройте для каждого приложения отдельные виртуальные машины внутреннего пула. 
* Настройте приложение в виртуальных машинах с двумя сетевыми картами, чтобы каждое приложение использовало свои собственные сетевой интерфейс и IP-адрес. 

### <a name="cause-4-accessing-the-internal-load-balancer-frontend-from-the-participating-load-balancer-backend-pool-vm"></a>Причина 4. Доступ к интерфейсу внутреннего Load Balancer осуществляется из виртуальной машины серверного пула Load Balancer

Если внутренний Load Balancer настроен в виртуальной сети, а одна из участвующих серверных виртуальных машин пытается получить доступ к интерфейсу внутреннего Load Balancer, то когда поток сопоставляется с исходной виртуальной машиной, могут произойти сбои. Такой сценарий не поддерживается.

**Разрешение** Существует несколько способов разблокировать этот сценарий, включая использование прокси-сервера. Оцените шлюз приложений или другие сторонние прокси-серверы (например, nginx или haproxy). Дополнительные сведения о шлюзе приложений см. в статье [Обзор шлюза приложений](../application-gateway/application-gateway-introduction.md).

**Сведения.** Внутренние подсистемы балансировки нагрузки не преобразуют исходящие подключения к внешнему интерфейсу внутренней подсистемы балансировки нагрузки, так как оба они находятся в диапазоне частных IP-адресов. Общедоступные подсистемы балансировки нагрузки предоставляют [исходящие подключения](load-balancer-outbound-connections.md) от частных IP-адресов внутри виртуальной сети к общедоступным IP-адресам. Для внутренних подсистем балансировки нагрузки этот подход исключает вероятность возникновения нехватки портов SNAT в рамках уникального диапазона внутренних IP-адресов, в котором не требуется проводить преобразование.

Побочным эффектом является то, что если исходящий поток из виртуальной машины в серверном пуле направляется к внешнему интерфейсу внутреннего балансировщика нагрузки, в пуле которого она находится, _и_ сопоставляется с собой, и два элемента потока не совпадают. Так как они не совпадают, происходит сбой потока. Поток передается успешно, если в серверном пуле он не сопоставляется с той же виртуальной машиной, которая создала поток к внешнему интерфейсу.

Когда поток сопоставляется с собой, получается, что исходящий поток передается из виртуальной машины на внешний интерфейс, а соответствующий входящий поток поступает от виртуальной машины к себе. С точки зрения гостевой операционной системы входящие и исходящие части того же потока не совпадают в виртуальной машине. Стек TCP не будет распознавать эти половины одного потока как часть того же потока. Источник и назначение не совпадают. При сопоставлении потока с любой другой виртуальной машиной в серверном пуле половины потока будут соответствовать друг другу, и виртуальная машина сможет реагировать на поток.

Симптомом этого сценария является периодическое истечение времени ожидания подключения, когда поток возвращается к той же серверной части, из которой он возник. К общим обходным решениям относятся вставка уровня прокси-сервера за внутренней подсистемой балансировки нагрузки и использование правил прямого ответа от сервера (DSR). Дополнительные сведения см. в статье [Несколько внешних интерфейсов для Azure Load Balancer](load-balancer-multivip-overview.md).

Вы можете объединить внутреннюю систему балансировки нагрузки со сторонним прокси-сервером или использовать внутренний [шлюз приложений](../application-gateway/application-gateway-introduction.md) для сценариев прокси-сервера с протоколами HTTP и HTTPS. Хотя вы можете использовать общедоступный Load Balancer в качестве обходного решения, полученный сценарий подвержен [исчерпанию SNAT](load-balancer-outbound-connections.md). Избегайте этого второго подхода, если не сможете осуществить его тщательно.

## <a name="symptom-cannot-change-backend-port-for-existing-lb-rule-of-a-load-balancer-which-has-vm-scale-set-deployed-in-the-backend-pool"></a>Симптом. В подсистеме балансировки нагрузки, в которой развернут набор масштабирования виртуальных машин во внутреннем пуле, невозможно изменить внутренний порт для существующего правила LB. 
### <a name="cause--the-backend-port-cannot-be-modified-for-a-load-balancing-rule-thats-used-by-a-health-probe-for-load-balancer-referenced-by-vm-scale-set"></a>Причина. Внутренний порт невозможно изменить для правила балансировки нагрузки, используемого зондом работоспособности для балансировщика нагрузки, на который ссылается масштабируемый набор виртуальных машин.
**Решение**. Чтобы изменить порт, можно удалить проверку работоспособности, обновив масштабируемый набор виртуальных машин, обновив порт, а затем снова настроив проверку работоспособности.

## <a name="symptom-small-traffic-is-still-going-through-load-balancer-after-removing-vms-from-backend-pool-of-the-load-balancer"></a>Симптом. После удаления виртуальных машин из серверного пула подсистемы балансировки нагрузки проходящий трафик по-прежнему проходит через балансировщик нагрузки. 
### <a name="cause--vms-removed-from-backend-pool-should-no-longer-receive-traffic-the-small-amount-of-network-traffic-could-be-related-to-storage-dns-and-other-functions-within-azure"></a>Причина. Виртуальные машины, удаленные из серверного пула, не должны получать трафик. Передача небольшого объема сетевого трафика может осуществляться из-за хранилища, DNS и других функций в Azure. 
Для проверки можно выполнить трассировку сети. Полное доменное имя, используемое для учетных записей хранения BLOB-объектов, указано в свойствах каждой учетной записи хранения.  Чтобы определить IP-адрес Azure, назначенный этой учетной записи хранения, можно выполнить команду nslookup с виртуальной машины в подписке Azure.

## <a name="additional-network-captures"></a>Запись дополнительных сетевых данных
Если вы решили обратиться в службу поддержки, то соберите следующие сведения, чтобы ускорить устранение проблемы. Выберите одну виртуальную машину внутреннего пула, чтобы выполнить следующие проверки:
- Воспользуйтесь командой Psping с одной из виртуальных машин внутреннего пула в виртуальной сети, чтобы проверить ответ порта пробы (пример: psping 10.0.0.4:3389), и запишите результаты. 
- Если в результате этих проверок связи ответ не получен, то одновременно с выполнением команды PsPing запустите команду netsh trace на виртуальной машине внутреннего пула и тестовой виртуальной машине в виртуальной сети, а затем остановите команду netsh trace. 
 
## <a name="next-steps"></a>Дальнейшие действия

Если описанные выше шаги не устранят проблему, отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).

