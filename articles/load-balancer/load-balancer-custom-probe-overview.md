---
title: Зонды здоровья для масштабирования и предоставления HA для вашего обслуживания
titleSuffix: Azure Load Balancer
description: В этой статье узнайте, как использовать зонды работоспособности для мониторинга экземпляров, лежащих в основе Azure Load Balancer
services: load-balancer
documentationcenter: na
author: asudbring
manager: kumudD
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.custom: seodec18
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/17/2019
ms.author: allensu
ms.openlocfilehash: ec1507e09a183f8d466a456b70151861f5f0e82c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80159444"
---
# <a name="load-balancer-health-probes"></a>Пробы работоспособности Load Balancer

При использовании правил балансировки нагрузки с Azure Load Balancer необходимо указать зонды работоспособности, чтобы позволить Load Balancer обнаружить состояние конечных точек бэкэнда.  Конфигурация зонда работоспособности и реакции зонда определяют, какие экземпляры бэкэндпула получат новые потоки. Можно использовать зонды работоспособности для обнаружения сбоя приложения на конечной точке бэкэнда. Вы также можете создать пользовательский ответ на пробу работоспособности и использовать ее для управления потоком, чтобы управлять нагрузкой или запланированным временем простоя. При сходе зонда работоспособности из строя, Load Balancer перестанет посылать новые потоки в соответствующий неработоспособный экземпляр. Исходящие подключения не влияет, только входявные подключения влияет.

Пробы работоспособности поддерживают множественные протоколы. Наличие определенного протокола зонда работоспособности зависит от SKU Load Balancer.  Кроме того, поведение службы зависит от Загружения Балансер SKU, как показано в этой таблице:

| | SKU "Стандартный" | SKU "Базовый" |
| --- | --- | --- |
| [Типы зондов](#types) | TCP, HTTP, HTTPS | TCP, HTTP |
| [Реакция на сбой пробы работоспособности](#probedown) | При сбое всех проб работоспособности потоки TCP продолжаются. | Все зонды вниз, все потоки TCP истекают. | 


>[!IMPORTANT]
>Просмотрите этот документ в полном объеме, включая важные [рекомендации по проектированию](#design) ниже, чтобы создать надежную службу.

>[!IMPORTANT]
>Пробы работоспособности Load Balancer поступают с IP-адреса 168.63.129.16 и не должны блокироваться, чтобы они отметили экземпляр как работоспособный.  Дополнительные сведения см. в разделе [IP-адрес источника пробы](#probesource).

>[!IMPORTANT]
>Независимо от накфигурированного порога тайм-аута, зонды работоспособности «Балансора загрузки» могут автоматически исследовать экземпляр, если сервер возвращает код состояния, который не является OK HTTP 200, или если соединение прекращается с помощью сбросить TCP.

## <a name="probe-configuration"></a><a name="probes"></a>Конфигурация зонда

Конфигурация зонда работоспособности состоит из следующих элементов:

- Продолжительность интервала между отдельными зондами
- Количество ответов зонда, которые должны быть соблюдены до перехода зонда в другое состояние
- Протокол зонда
- Порт зонда
- HTTP путь для использования для HTTP GET при использовании зондов HTTP(S)

>[!NOTE]
>Определение зонда не является обязательным или проверено при использовании Azure PowerShell, Azure CLI, шаблонов или API. Тесты проверки зонда проводятся только при использовании портала Azure.

## <a name="understanding-application-signal-detection-of-the-signal-and-reaction-of-the-platform"></a>Понимание сигнала приложения, обнаружение сигнала и реакция платформы

Количество ответов зонда относится к обоим

- количество успешных зондов, которые позволяют экземпляр быть помечены как вверх, и
- количество таймдан-аут зондов, которые вызывают экземпляр быть помечены как вниз.

Указанные значения тайм-аута и интервала определяют, будет ли экземпляр помечен как вверх или вниз.  Продолжительность интервала, умноженная на количество ответов зонда, определяет продолжительность, в течение которой должны быть обнаружены ответы зонда.  И служба будет реагировать после того, как необходимые зонды были достигнуты.

Мы можем проиллюстрировать поведение далее с примером. Если вы установили количество ответов зонда до 2, а интервал до 5 секунд, это означает, что 2 сбоя тайм-аута зонда должны наблюдаться в течение 10 секунд.  Поскольку время отправки зонда не синхронизируется при изменении состояния приложения, мы можем свести время для обнаружения двумя сценариями:

1. Если приложение начинает производить тайм-аут ответа зонда непосредственно перед первым зондом прибывает, обнаружение этих событий займет 10 секунд (2 х 5 секунд интервалы) плюс продолжительность приложения начинает сигнализировать тайм-аут, когда первый зонд прибывает.  Можно предположить, что это обнаружение займет чуть более 10 секунд.
2. Если приложение начнет производить тайм-аут ответа зонда сразу после прибытия первого зонда, обнаружение этих событий не начнется до тех пор, пока следующий зонд не прибудет (и время выхода) плюс еще 10 секунд (2 х 5 секунд интервалов).  Вы можете предположить, что это обнаружение займет чуть менее 15 секунд.

В этом примере, как только обнаружение произошло, платформа будет занять небольшое количество времени, чтобы реагировать на это изменение.  Это означает, что в зависимости от 

1. когда приложение начинает изменять состояние и
2. когда это изменение обнаружено и соответствует требуемым критериям (количество зондов, отправленных с указанным интервалом) и
3. когда обнаружение было передано по всей платформе 

Можно предположить, что реакция на тайм-аут ответа зонда займет от минимум более 10 секунд и максимум чуть более 15 секунд, чтобы отреагировать на изменение сигнала от приложения.  Этот пример приводится для иллюстрации того, что происходит, однако невозможно прогнозировать точную продолжительность, превышающую приведенное выше приведенное в этом примере грубое руководство.
 
## <a name="probe-types"></a><a name="types"></a>

Протокол, используемый зондом работоспособности, может быть настроен на один из следующих:

- [прослушиватели TCP](#tcpprobe);
- [конечные точки HTTP](#httpprobe);
- [конечные точки HTTPS](#httpsprobe);

Доступные протоколы зависят от используемого SKU СКУ «Баланс- груз»:

|| TCP | HTTP | HTTPS |
| --- | --- | --- | --- |
| SKU "Стандартный" |    &#9989; |   &#9989; |   &#9989; |
| SKU "Базовый" |   &#9989; |   &#9989; | &#10060; |

### <a name="tcp-probe"></a><a name="tcpprobe"></a>Проба TCP

Проверки TCP инициализируют подключение, выполняя трехстороннее подтверждение по открытому TCP-протоколу на определенном порту.  Пробы протокола TCP завершают подключение с помощью закрытого четырехстороннего подтверждения протокола TCP.

Минимальный интервал проверки составляет 5 секунд, а минимальное количество ответов о неработоспособности — 2.  Общая продолжительность всех интервалов не может превышать 120 секунд.

Проба TCP завершается сбоем в следующих случаях:
* Прослушиватель TCP в экземпляре не отвечает в течение периода времени ожидания.  Зонд помечается вниз на основе количества приурочен из зонда запросов, которые были настроены, чтобы остаться без ответа до маркировки вниз зонда.
* Проба получает сброс TCP-соединения от экземпляра.

Ниже показано, как вы могли бы выразить такого рода конфигурации зонда в шаблоне менеджер ресурсов:

```json
    {
      "name": "tcp",
      "properties": {
        "protocol": "Tcp",
        "port": 1234,
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

### <a name="http--https-probe"></a><a name="httpprobe"></a> <a name="httpsprobe"></a>Проба HTTP/HTTPS

>[!NOTE]
>Проба HTTPS доступна только для [Load Balancer (цен. категория "Стандартный")](load-balancer-standard-overview.md).

Пробы HTTP и HTTPS основываются на пробе протокола TCP и выдают запрос HTTP GET с указанным расположением. Обе пробы поддерживают относительные пути для HTTP GET. Пробы HTTPS аналогичны пробам HTTP, но к ним добавлены оболочки TLS (это протокол ранее назывался SSL). Проба работоспособности отмечается как работоспособная, когда экземпляр отвечает с HTTP-состоянием 200 в течение периода ожидания.  По умолчанию эта проба работоспособности пытается проверить настроенный порт каждые 15 секунд. Минимальный интервал проверки составляет 5 секунд. Общая продолжительность всех интервалов не может превышать 120 секунд.

Зонды HTTP / HTTPS также могут быть полезны для реализации собственной логики для удаления экземпляров из вращения балансоровнагрузки нагрузки, если порт зонда также является слушателем самой службы. Например, можно удалить экземпляр, если он использует более 90 % ресурсов ЦП и возвращает состояние HTTP, отличное от кода 200. 

> [!NOTE] 
> Зонд HTTPS требует использования сертификатов на основе, которые имеют минимальный хэш подписи SHA256 во всей цепочке.

Если вы используете облачные службы и у вас есть веб-роли, использующие w3wp.exe, вам доступен также автоматический мониторинг веб-сайта. Ошибки в коде веб-сайта возвращают проверке подсистемы балансировки нагрузки состояние с кодом, отличным от 200.

Проба HTTP/HTTPS завершается сбоем в следующих случаях:
* Конечная точка пробы возвращает код ответа HTTP, отличный от 200 (например, 403, 404 или 500). В этом случае проба будет сразу же отмечена как неработоспособная. 
* Конечная точка зонда не отвечает вообще в течение минимального интервала зонда и 30-секундного периода тайм-аута. Множество запросов на пробу могут оставаться без ответа до того, как проба будет отмечена как неработоспособная, и пока не будет достигнуто суммы всех интервалов времени ожидания.
* Конечная точка пробы закрывает подключение путем сброса TCP-соединения.

Ниже показано, как вы могли бы выразить такого рода конфигурации зонда в шаблоне менеджер ресурсов:

```json
    {
      "name": "http",
      "properties": {
        "protocol": "Http",
        "port": 80,
        "requestPath": "/",
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

```json
    {
      "name": "https",
      "properties": {
        "protocol": "Https",
        "port": 443,
        "requestPath": "/",
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

### <a name="guest-agent-probe-classic-only"></a><a name="guestagent"></a>Проба гостевого агента (только для классической версии)

Роли облачной службы (рабочие роли и веб-роли) используют гостевой агент для мониторинга проб по умолчанию.  Проба гостевого агента является последней инстанцией.  Всегда явно используйте пробу работоспособности как пробу TCP или HTTP. Проба гостевого агента не так эффективна, как явно определенные пробы для большинства сценариев приложений.

Проба гостевого агента представляет собой проверку гостевого агента внутри виртуальной машины. Затем она ожидает передачу данных и передает ответ HTTP с кодом 200 (ОК) только в том случае, если экземпляр находится в состоянии готовности. (Другие возможные состояния: занято, перезапуск или остановлено.)

Дополнительные сведения см. в статьях [Azure Service Configuration Schema (.cscfg File)](https://msdn.microsoft.com/library/azure/ee758710.aspx) (Схема конфигурации службы Azure (CSCFG-файл)) и [Приступая к работе по созданию общедоступного балансировщика нагрузки для облачных служб](https://docs.microsoft.com/azure/load-balancer/load-balancer-get-started-internet-classic-cloud#check-load-balancer-health-status-for-cloud-services).

Если гостевой агент не отправляет ответ HTTP с кодом 200 (ОК), подсистема балансировки нагрузки отмечает экземпляр как неработоспособный. Затем он прекращает отправлять потоки к этому экземпляру. Подсистема балансировки нагрузки продолжит проверять связь с этим экземпляром. 

Если гостевой агент отправляет ответ HTTP с кодом 200, подсистема балансировки нагрузки снова начинает отправлять потоки к этому экземпляру.

При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не отслеживается структурой Azure или гостевым агентом. Ошибки в w3wp.exe (например, ответы HTTP с кодом 500) не передаются в гостевой агент. Следовательно, подсистема балансировки нагрузки не убирает этот экземпляр из ротации.

<a name="health"></a>
## <a name="probe-up-behavior"></a><a name="probehealth"></a>Проверка поведения

Зонды работоспособности TCP, HTTP и HTTPS считаются здоровыми и отмечают конечную точку бэкэнда как здоровую, когда:

* Проба работоспособности выполнена успешно уже после загрузки виртуальной машины.
* Определенное количество зондов, необходимых для обозначения конечной точки бэкэнда как здоровой, было достигнуто.

Любая конечная точка бэкэнда, достигшая здорового состояния, имеет право на получение новых потоков.  

> [!NOTE]
> Если зонд работоспособности колеблется, балансомер нагрузки ждет дольше, прежде чем он помещает конечную точку бэкэнда в здоровое состояние. Это дополнительное время ожидания защищает пользователя и инфраструктуру и преднамеренно заложено в политику.

## <a name="probe-down-behavior"></a><a name="probedown"></a>Реакция на сбой пробы работоспособности

### <a name="tcp-connections"></a>TCP-подключения

Новые соединения TCP сумеют остаться здоровыми конечными точками бэкэнда.

Если зонд работоспособности бэкэнда выходит из строя, установленные соединения TCP с этой конечней точкой бэкэнда продолжаются.

При сбое в серверном пуле всех проб для всех экземпляров новые потоки в этот пул передаваться не будут. Load Balancer (цен. категория "Стандартный") позволит поддерживать установленные потоки TCP.  Load Balancer (цен. категория "Базовый") завершит передачу всех имеющихся потоков TCP в серверный пул.
 
Load Balancer – это сквозная служба (не прерывает соединения протокола TCP), и поток всегда находится между клиентом, гостевой ОС виртуальной машины и приложением. Бассейн со всеми зондами вниз вызовет фронтэнд не реагировать на tCP соединение открытых попыток (SYN), как нет здорового бэкэнда конечная точка для получения потока и ответить с SYN-ACK.

### <a name="udp-datagrams"></a>Датаграммы UDP

Данные UDP будут доставлены в здоровые конечные точки бэкэнда.

UDP не требует соединения, поэтому состояние этого потока не отслеживается. Если зонд работы бэкэнда завершается неудачей, существующие потоки UDP перейдут в другой здоровый экземпляр в пуле бэкэнда.

Если в серверном пуле все пробы всех экземпляров завершатся сбоем, будут прекращены все имеющиеся потоки UDP для служб Load Balancer (цен. категория "Базовый" и "Стандартный").

<a name="source"></a>
## <a name="probe-source-ip-address"></a><a name="probesource"></a>IP-адрес источника пробы

Балансировщик нагрузки использует распределенную службу проверки работоспособности для внутренней модели работоспособности. Служба проб находится на каждом узле, на котором размещаются виртуальные машины, и по требованию может быть запрограммирована для создания проверок работоспособности для каждой конфигурации клиента. Трафик проверок работоспособности находится непосредственно между службой проб, которая создает проверку, и виртуальной машиной клиента. Все пробы работоспособности Load Balancer поступают с IP-адреса 168.63.129.16. Он является их источником.  Вы можете использовать в виртуальной сети диапазон IP-адресов, который не является пространством RFC1918.  Использование глобально зарезервированного IP-адреса, принадлежащего Майкрософт, снижает вероятность конфликта IP-адресов с диапазоном IP-адресов, который вы используете в виртуальной сети.  Этот IP-адрес одинаков во всех регионах, он не меняется и не являет собой угрозу безопасности, поскольку с этого IP-адреса отправлять пакеты может только внутренний компонент платформы Azure. 

Тег службы AzureLoadBalancer определяет этот исходный IP-адрес в ваших [группах безопасности сети](../virtual-network/security-overview.md) и разрешает трафик проверки работоспособности по умолчанию.

В дополнение к зондам здоровья грузоподъемности, [следующие операции используют этот IP-адрес:](../virtual-network/what-is-ip-address-168-63-129-16.md)

- Позволяет агенту виртуальной машины взаимодействовать с платформой, чтобы сигнализировать, что он находится в состоянии "Готов".
- Включает связь с виртуальным сервером DNS для предоставления разрешения отфильтрованных имен для клиентов, которые не указывают настраиваемые DNS-серверы.  Эта фильтрация гарантирует, что клиенты могут разрешать имена узлов для их развертывания.
- Позволяет виртуальной машине получить динамический IP-адрес от службы DHCP в Azure.

## <a name="design-guidance"></a><a name="design"></a>Руководство по дизайну

Пробы работоспособности используются для повышения устойчивости вашей службы и ее масштабирования. Неправильная конфигурация или неправильный конструктивный шаблон могут повлиять на доступность и масштабируемость вашей службы. Просмотрите весь этот документ и подумайте, как повлияет на ваш сценарий то, что эта проба отмечена как "отключен" или "подключен" и как это влияет на доступность сценария вашего приложения.

При разработке модели работоспособности для приложения следует исследовать порт на конечной точке бэкэнда, которая отражает работоспособность этого экземпляра __и__ предоставляемую службу приложений.  Порт приложения и порт пробы не должны обязательно совпадать.  В некоторых случаях желательно, чтобы порт пробы отличался от функционального порта вашего приложения.  

Иногда для вашего приложения может быть полезно сгенерировать ответ пробы работоспособности, чтобы не только определить его работоспособность, но и напрямую подать сигнал Load Balancer о том, должен ли ваш экземпляр получать или не получать новые потоки.  Вы можете использовать ответ пробы, чтобы позволить своему приложению создавать противодавление и регулировать поставку новых потоков в экземпляр путем проведения неудачной пробы работоспособности или подготовки к обслуживанию вашего приложения и инициирования опустошения вашего сценария.  При использовании Load Balancer (цен. категория "Стандартный") сигнал [пробы "отключен"](#probedown) будет всегда разрешать потокам протокола TCP продолжаться, пока не начнется время ожидания или не прервется подключение. 

Для балансировки нагрузки UDP следует создать пользовательский сигнал зонда работоспособности с конечной точки бэкэнда и использовать либо зонд работы TCP, HTTP, или HTTPS, ориентированный на соответствующего слушателя, чтобы отразить работоспособность вашего приложения UDP.

При использовании [правил балансировки нагрузки портов HA](load-balancer-ha-ports-overview.md) с [Load Balancer (цен. категория "Стандартный")](load-balancer-standard-overview.md) на всех портах выполняется балансировка нагрузки, а в одном ответе пробы работоспособности должно отражаться состояние всего экземпляра.

Не преобразовывайте или не используйте прокси-сервер через экземпляр, который получает пробу работоспособности к другому экземпляру в виртуальной сети, так как эта конфигурация может привести к каскадным сбоям в сценарии.  Рассмотрим следующий сценарий. Набор сторонних устройств развернут в серверном пуле ресурса Load Balancer, чтобы обеспечить масштабирование и избыточность для устройств, а датчик работоспособности настроен на проверку порта, который стороннее устройство передает через прокси-сервер или преобразовывает на другие виртуальные машины вне устройства.  Если вы проверяете тот же порт, который используете для преобразования или прокси-запросов к другим виртуальным машинам вне устройства, любой результат пробы от одной виртуальной машины вне устройства отметит само устройство как неработоспособное. Эта конфигурация может привести к каскадному сбою всего сценария приложения в результате одной конечной точки бэкэнда за прибором.  Триггером может быть прерывистый сбой пробы, который приведет к тому, что Load Balancer будет отмечать исходное место назначения (экземпляр устройства) и, в свою очередь, может отключить весь сценарий приложения. Вместо этого проверьте работоспособность самого устройства. Выбор пробы для определения сигнала работоспособности является важным фактором для сценариев сетевых виртуальных устройств (NVA), и вы должны проконсультироваться с поставщиком приложения о том, какой сигнал работоспособности подходит для таких сценариев.

Если вы не разрешите [исходный IP-адрес](#probesource) пробы в политиках брандмауэра, то проба работоспособности завершится сбоем, поскольку она не может достичь вашего экземпляра.  В свою очередь, из-за сбоя пробы Load Balancer пометит экземпляр как неработоспособный.  Эта неверная конфигурация может привести к сбою сценария приложения с балансировкой нагрузки.

Чтобы проба Load Balancer отметила ваш экземпляр как работоспособный, **необходимо** разрешить этот IP-адрес во всех [группах безопасности сетей](../virtual-network/security-overview.md) Azure и политиках локального брандмауэра.  По умолчанию каждая группа безопасности сети включает [служебный тег](../virtual-network/security-overview.md#service-tags) AzureLoadBalancer для разрешения трафика пробы работоспособности.

Если вы хотите проверить сбой проверки работоспособности или выделить отдельный экземпляр, вы можете использовать [группы безопасности сети](../virtual-network/security-overview.md), чтобы явно заблокировать проверку работоспособности (порт назначения или [исходный IP-адрес](#probesource)) и моделировать сбой пробы.

Не настраивайте свою виртуальную сеть с диапазоном IP-адресов, принадлежащим корпорации Майкрософт, который содержит 168.63.129.16.  Такие конфигурации будут конфликтовать с IP-адресом пробы работоспособности и могут вызвать сбой вашего сценария.

Если на вашей виртуальной машине имеется несколько интерфейсов, нужно ответить на пробу в интерфейсе, куда поступил запрос.  Вам может потребоваться, чтобы исходный сетевой адрес преобразовал этот адрес в виртуальную машину для каждого интерфейса.

Не включайте [метки времени протокола TCP](https://tools.ietf.org/html/rfc1323).  Включение меток времени TCP может привести к сбою зондов работы из-за того, что пакеты TCP сбрасываются стеком гостевой ОС TCP VM, что приводит к разметке баланса нагрузки.  Метки времени протокола TCP обычно включены по умолчанию на защищенных образах виртуальных машин и должны быть отключены.

## <a name="monitoring"></a>Наблюдение

Как общедоступный, так и внутренний [балансер стандартной нагрузки](load-balancer-standard-overview.md) разоблачает статус зонда для конечных и бэкэндовых конечных точек как многомерные метрики через Azure Monitor. Эти показатели могут быть использованы другими службами Azure или партнерскими приложениями. 

Базовый общественный балансостом нагрузки предоставляет состояние зонда работы, обобщенное в пул бэкэнда через журналы Azure Monitor.  Журналы Azure Monitor недоступны для внутренних балансов базовой нагрузки.  Вы можете использовать [журналы Azure Monitor](load-balancer-monitor-log.md) для проверки состояния состояния здоровья зонда общественного баланса нагрузки и подсчета зондов. Функция ведения журналов в Power BI или Azure Operational Insights позволяет получать статистические данные о работоспособности подсистемы балансировки нагрузки.

## <a name="limitations"></a>Ограничения

- Пробы HTTPS не поддерживают взаимную проверку подлинности с помощью сертификата клиента.
- Следует предположить, что зонды работоспособности сбой при включении меток времени TCP.

## <a name="next-steps"></a>Дальнейшие действия

- Подробнее о [балансеstandardе стандартной нагрузки](load-balancer-standard-overview.md)
- [Краткое руководство. Создание общедоступной подсистемы балансировки нагрузки с помощью Azure PowerShell](quickstart-create-standard-load-balancer-powershell.md)
- [Load Balancer Probes - Get](https://docs.microsoft.com/rest/api/load-balancer/loadbalancerprobes/) (Получение проб работоспособности Load Balancer)
- Запросите новые возможности пробы работоспособности на [платформе Uservoice для Load Balancer](https://aka.ms/lbuservoice).
