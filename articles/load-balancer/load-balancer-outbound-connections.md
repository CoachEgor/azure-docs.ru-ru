---
title: Исходящие подключения
titleSuffix: Azure Load Balancer
description: В этой статье рассказывается о том, как Azure обеспечивает взаимодействие виртуальных машин с общедоступными службами Интернета.
services: load-balancer
documentationcenter: na
author: asudbring
ms.service: load-balancer
ms.custom: contperfq1
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/30/2020
ms.author: allensu
ms.openlocfilehash: 6b9f454c75a10644e86931dc86ebd9514e5431d3
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91649802"
---
# <a name="outbound-connections"></a>Исходящие подключения

Azure Load Balancer предоставляет исходящие подключения с помощью различных механизмов. В этой статье описываются сценарии и способы управления ими. 


## <a name="scenarios"></a>Сценарии

* Виртуальная машина с общедоступным IP-адресом.
* Виртуальная машина без общедоступного IP-адреса.
* Виртуальная машина без общедоступного IP-адреса и без стандартной подсистемы балансировки нагрузки.

### <a name="virtual-machine-with-public-ip"></a><a name="scenario1"></a>Виртуальная машина с общедоступным IP-адресом

| Сопоставления | Метод | Протоколы IP |
| ---------- | ------ | ------------ |
| Общедоступная подсистема балансировки нагрузки или изолированная | [SNAT (преобразование адресов исходной сети)](#snat) </br> [PAT (маскировка портов)](#pat) не используется. | TCP (протокол управления передачей) </br> UDP (протокол датаграммы пользователя) </br> ICMP (Протокол управляющих сообщений Интернета) </br> ESP (Инкапсуляция полезных данных безопасности) |

#### <a name="description"></a>Описание

Azure использует общедоступный IP-адрес, назначенный IP-конфигурации сетевого адаптера экземпляра для всех исходящих потоков. Доступны все временные порты экземпляра. Не имеет значения, сбалансирована ли виртуальная машина. Этот сценарий приоритетнее остальных. 

Общедоступный IP-адрес назначается виртуальной машине в соотношении "один к одному" (а не "один ко многим") через NAT типа "один к одному" без отслеживания состояния.

### <a name="virtual-machine-without-public-ip"></a><a name="scenario2"></a>Виртуальная машина без общедоступного IP-адреса

| Сопоставления | Метод | Протоколы IP |
| ------------ | ------ | ------------ |
| Общедоступная подсистема балансировки нагрузки | Использование внешнего интерфейса балансировщика нагрузки для [SNAT](#snat) с помощью [PAT (маскировка портов)](#pat).| TCP </br> UDP |

#### <a name="description"></a>Описание

Для ресурса балансировщика нагрузки настроено правило подсистемы балансировки нагрузки. Это правило используется для создания связи между общедоступным IP-интерфейсом и внутренним пулом. 

Если вы не завершите эту конфигурацию правила, поведение будет описано в сценарии 3. 

Для завершения проверки работоспособности не требуется правило с прослушивателем.

Когда виртуальная машина создает исходящий поток, Azure преобразует исходный IP-адрес в общедоступный IP-адрес внешнего интерфейса подсистемы балансировки нагрузки. Это преобразование выполняется с помощью [SNAT](#snat). 

Временные порты внешнего общедоступного IP-адреса балансировщика нагрузки используются для различения отдельных потоков, исходящих от виртуальной машины. При создании исходящих потоков в ходе SNAT динамически используются [предварительно выделенные временные порты](#preallocatedports). 

В этом контексте временные порты, используемые для SNAT, называются портами SNAT. Порты SNAT предварительно выделяются, как описано в [таблице распределения портов SNAT по умолчанию](#snatporttable).

### <a name="virtual-machine-without-public-ip-and-without-standard-load-balancer"></a><a name="scenario3"></a>Виртуальная машина без общедоступного IP-адреса и без стандартной подсистемы балансировки нагрузки

| Сопоставления | Метод | Протоколы IP |
| ------------ | ------ | ------------ |
|Нет </br> Базовая подсистема балансировки нагрузки | [SNAT](#snat) с [маскировкой портов (PAT)](#pat)| TCP </br> UDP | 

#### <a name="description"></a>Описание

Когда виртуальная машина создает исходящий поток, Azure преобразует исходный IP-адрес в общедоступный исходный IP-адрес. Этот общедоступный IP-адрес **не настраивается** и не может быть зарезервирован. Этот адрес не учитывается в ограничении ресурсов общедоступного IP-адреса подписки. 

Общедоступный IP-адрес будет освобожден, а при повторном развертывании — запрос нового общедоступного IP-адреса. 

* Виртуальная машина
* Группа доступности
* Набор масштабирования виртуальных машин  

Не используйте этот сценарий для добавления IP-адресов в список разрешений. Используйте сценарий 1 или 2, где явно объявляется исходящее поведение. Порты [SNAT](#snat) предварительно выделяются, как описано в [таблице распределения портов SNAT по умолчанию](#snatporttable).



## <a name="port-allocation-algorithm"></a><a name="preallocatedports"></a>Алгоритм выделения портов

Azure использует алгоритм для определения количества доступных предварительно выделенных портов [SNAT](#snat) . Алгоритм использует количество портов, размер внутреннего пула. 

Для каждого общедоступного IP-адреса, связанного с подсистемой балансировки нагрузки, порты 64 000 доступны в виде портов [SNAT](#snat) . Для UDP и TCP выделяется одинаковое количество портов [SNAT](#snat) . Порты потребляются независимо на каждый IP-протокол. 

Использование портов [SNAT](#snat) отличается в зависимости от того, является ли поток UDP или TCP. 

Порты используются динамически вплоть до предельного предела.  Порты освобождаются, когда поток закрывается или происходит тайм-аут простоя.

Дополнительные сведения об истечении времени ожидания простоя см. [в разделе Устранение неполадок исходящих подключений в Azure Load Balancer](../load-balancer/troubleshoot-outbound-connection.md#idletimeout) 

Порты используются, только если это необходимо, чтобы сделать поток уникальным.

### <a name="dynamic-snat-ports-preallocation"></a><a name="snatporttable"></a> Динамическое выделение портов SNAT

В следующей таблице показано предварительное выделение портов [SNAT](#snat) для уровней размеров серверного пула.

| Размер пула (экземпляры виртуальных машин) | Предварительно выделяемые порты SNAT на каждую конфигурацию IP-адресов |
| --- | --- |
| 1–50 | 1024 |
| 51–100 | 512 |
| 101–200 | 256 |
| 201–400 | 128 |
| 401–800 | 64 |
| 801–1000 | 32 |

Изменение размера серверного пула может повлиять на некоторые из установленных потоков:

- Размер внутреннего пула увеличивает переключение триггеров на следующий уровень. Половина предварительно выделенных портов [SNAT](#snat) освобождается во время перехода на следующий уровень. 

- Потоки, связанные с освобожденным портом [SNAT](#snat) и закрываемым временем ожидания. Эти потоки должны быть повторно установлены. Если предварительно выделенные порты доступны, новые потоки сразу успешно передаются.

- Если размер серверного пула уменьшается и переходит на более низкий уровень, количество доступных портов [SNAT](#snat) увеличивается. Существующие порты [SNAT](#snat) и соответствующие им потоки не затрагиваются.

## <a name="outbound-rules"></a><a name="outboundrules"></a>Правила исходящего трафика

 Правила исходящего трафика позволяют настроить преобразование исходящего сетевого адреса для исходящей сетевой [подсистемы балансировки нагрузки](load-balancer-standard-overview.md).  

> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин в виртуальной сети.  Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

Вы имеете полное декларативное управление исходящими подключениями для масштабирования и настройки этой возможности в своих целях.

![Исходящие правила балансировщика нагрузки](media/load-balancer-outbound-rules-overview/load-balancer-outbound-rules.png)

С помощью правил исходящего трафика можно использовать подсистему балансировки нагрузки для определения исходящего NAT с нуля. Можно также масштабировать и настраивать поведение существующего исходящего NAT.

Правила для исходящего трафика позволяют управлять следующим:

- Какие виртуальные машины следует преобразовать в общедоступные IP-адреса.
- Как должны быть заданы исходящие порты [SNAT](#snat) .
- Протоколы для предоставления исходящего преобразования.
- Какая продолжительность истечения времени ожидания бездействия исходящего подключения (4-120 минут).
- Следует ли отправить сброс TCP при превышении времени ожидания простоя
- Протоколы транспорта TCP и UDP с одним правилом

### <a name="outbound-rule-definition"></a>Определение правила для исходящего трафика

Правила исходящего трафика следуют тому же привычному синтаксису, что и правила балансировки нагрузки и входящего трафика NAT: **интерфейсный**  +  **parameters**  +  **Пул внутренних**параметров. Правило для исходящего трафика настраивает NAT для исходящего трафика, предусматривающее преобразование _всех виртуальных машин, определенных с помощью серверного пула_, во _внешний интерфейс_.  _Параметры_ обеспечивают дополнительный детализированный контроль над алгоритмом исходящего трафика NAT.

### <a name="scale-outbound-nat-with-multiple-ip-addresses"></a><a name="scale"></a> Масштабирование NAT для исходящего трафика при использовании нескольких IP-адресов

Каждый дополнительный IP-адрес, предоставляемый интерфейсом, предоставляет дополнительные 64 000 временных портов для подсистемы балансировки нагрузки для использования в качестве портов SNAT. 

Используйте несколько IP-адресов для планирования крупномасштабных сценариев. Используйте правила исходящего трафика для устранения [нехватки SNAT](troubleshoot-outbound-connection.md#snatexhaust). 

[Префикс общедоступного IP-адреса](https://aka.ms/lbpublicipprefix) можно также использовать непосредственно с исходящим правилом. 

Префикс общедоступного IP-адреса увеличивает масштаб развертывания. Префикс можно добавить в список разрешенных потоков, исходящих из ресурсов Azure. Можно настроить интерфейсную IP-конфигурацию в подсистеме балансировки нагрузки для ссылки на префикс общедоступного IP-адреса.  

Подсистема балансировки нагрузки управляет префиксом общедоступного IP-адреса. Правило исходящего трафика будет автоматически использовать все общедоступные IP-адреса, содержащиеся в префиксе общедоступного IP-адрес для исходящих соединений. 

Каждый IP-адрес в пределах префикса общедоступного IP-адреса предоставляет дополнительные 64 000 временных портов для каждого IP-адреса балансировщика нагрузки для использования в качестве портов SNAT.

### <a name="outbound-flow-idle-timeout-and-tcp-reset"></a><a name="idletimeout"></a> Тайм-аут простоя исходящего потока и сброс TCP

Правила для исходящего трафика обеспечивают параметр конфигурации для управления временем ожидания перед переходом исходящего потока в режим простоя и сопоставляют его с потребностями приложения. По умолчанию время ожидания перед переходом исходящего потока в режим простоя составляет 4 минуты. Дополнительные сведения см. в разделе [Настройка времени ожидания простоя](load-balancer-tcp-idle-timeout.md). 

Поведение подсистемы балансировки нагрузки по умолчанию заключается в автоматическом удалении потока при достижении времени ожидания истечения исходящего трафика. `enableTCPReset`Параметр обеспечивает предсказуемое поведение приложения и управление им. Параметр определяет, следует ли отсылать двунаправленный сброс TCP (TCP RST) по истечении времени ожидания истечения срока действия исходящего трафика. 

Чтобы получить сведения о доступности региона, проверьте [Сброс TCP на время ожидания простоя](https://aka.ms/lbtcpreset) .

### <a name="preventing-outbound-connectivity"></a><a name="preventoutbound"></a>Запрет исходящих подключений

Правила балансировки нагрузки обеспечивают автоматическое программирование исходящего NAT. В некоторых сценариях используется преимущество или требуется отключить автоматическое программирование исходящего NAT в рамках правила балансировки нагрузки. Отключение с помощью правила позволяет управлять поведением или уточнять его.  

Этот параметр можно использовать двумя способами:

1. Предотвращение входящего IP-адреса для исходящей SNAT. Отключите исходящее значение SNAT в правиле балансировки нагрузки.
  
2. Настройте параметры исходящего трафика [SNAT](#snat) для IP-адреса, используемого для входящих и исходящих подключений одновременно. Для получения управления исходящим правилом необходимо отключить автоматический исходящий NAT. Чтобы изменить распределение портов SNAT для адреса, которое также используется для входящего трафика, `disableOutboundSnat` параметр должен иметь значение true. 

При попытке переопределить IP-адрес, используемый для входящего трафика, операция настройки правила для исходящего трафика завершится ошибкой.  Сначала отключите исходящий NAT правила балансировки нагрузки.

>[!IMPORTANT]
> Виртуальная машина не будет иметь исходящего подключения, если для этого параметра задано значение true и отсутствует правило исходящего трафика для определения исходящих подключений.  Некоторые операции на виртуальной машине или в приложении могут зависеть от доступности исходящего подключения. Ознакомьтесь с зависимостями сценария и проанализируйте влияние этого изменения.

Иногда нежелательно, чтобы виртуальная машина была создана в качестве исходящего потока. Может существовать требование для управления тем, какие назначения получают исходящие потоки, или назначения, которые начинают входящие потоки. Используйте [группы безопасности сети](../virtual-network/security-overview.md) для управления назначениями, которые достигает виртуальная машина. Используйте группы безопасности сети для управления тем, какие общедоступные назначения начинают входящие потоки.

При использовании NSG для виртуальной машины с балансировкой нагрузки обратите внимание на [теги службы](../virtual-network/security-overview.md#service-tags) и [правила безопасности по умолчанию](../virtual-network/security-overview.md#default-security-rules). Убедитесь, что виртуальная машина может принимать запросы проверки работоспособности от Azure Load Balancer.

Если NSG блокирует запросы проверки работоспособности от тега AZURE_LOADBALANCER по умолчанию, проверка работоспособности виртуальной машины завершается сбоем, а виртуальная машина помечается как недоступная. Подсистема балансировки нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="scenarios-with-outbound-rules"></a>Сценарии с правилами исходящего трафика

### <a name="outbound-rules-scenarios"></a>Сценарии исходящих правил

* Настройте исходящие подключения к определенному набору общедоступных IP-адресов или префикса.
* Измените выделение портов [SNAT](#snat) .
* Включить только исходящие.
* Исходящий трафик NAT только для виртуальных машин (без входящего трафика).
* Исходящий NAT для внутренней подсистемы балансировки нагрузки уровня "Стандартный".
* Включите протокол TCP & UDP для исходящего NAT с помощью общедоступной подсистемы балансировки нагрузки уровня "Стандартный".

### <a name="configure-outbound-connections-to-a-specific-set-of-public-ips-or-prefix"></a><a name="scenario1out"></a>Настройка исходящих подключений к определенному набору общедоступных IP-адресов или префикса

#### <a name="details"></a>Подробнее

Используйте этот сценарий, чтобы настроить исходящие подключения от набора общедоступных IP-адресов. Добавьте общедоступные IP-адреса или префиксы в список разрешений или запретов на основе происхождения.

Этот общедоступный IP-адрес или префикс может совпадать с именем, используемым правилом балансировки нагрузки. 

Чтобы использовать другой общедоступный IP-адрес или префикс, отличный от используемого правилом балансировки нагрузки, выполните следующие действия.  

1. Создайте префикс общедоступного IP-адреса или общедоступный IP-адрес.
2. Создание общедоступной подсистемы балансировки нагрузки уровня "Стандартный" 
3. Создайте интерфейс, ссылающийся на префикс общедоступного IP-адреса или общедоступный IP-адрес, который вы хотите использовать. 
4. Повторное использование серверного пула или создание внутреннего пула и размещение виртуальных машин в серверном пуле общедоступной подсистемы балансировки нагрузки
5. Настройте правило исходящего трафика в общедоступной подсистеме балансировки нагрузки, чтобы включить исходящий трафик NAT для виртуальных машин с помощью внешнего интерфейса. Если вы не хотите использовать правило балансировки нагрузки для исходящего трафика, отключите исходящий трафик SNAT в правиле балансировки нагрузки.

### <a name="modify-snat-port-allocation"></a><a name="scenario2out"></a>Изменение распределения портов [SNAT](#snat)

#### <a name="details"></a>Подробнее

Вы можете использовать правила для исходящего трафика, чтобы настроить [автоматическое распределение SNAT-портов на основе размера серверного пула](load-balancer-outbound-connections.md#preallocatedports). 

При возникновении нехватки SNAT увеличьте число портов [SNAT](#snat) , заданное по умолчанию (1024). 

Каждый общедоступный IP-адрес участвует в 64 000 временных портов. Число виртуальных машин в серверном пуле определяет количество портов, передаваемых на каждую виртуальную машину. Одна виртуальная машина во внутреннем пуле имеет доступ к максимуму 64 000 портов. Для двух виртуальных машин максимальное число портов [SNAT](#snat) (32 000) может быть задано с помощью исходящего правила (2x 32 000 = 64 000). 

Для настройки портов SNAT, заданных по умолчанию, можно использовать правила для исходящего трафика. Вы предоставляете больше или меньше, чем выделение портов [SNAT](#snat) по умолчанию. Каждый общедоступный IP-адрес из внешнего интерфейса правила для исходящего трафика составляет до 64 000 временных портов для использования в качестве портов [SNAT](#snat) .  

Балансировщик нагрузки предоставляет порты [SNAT](#snat) , кратные 8. Если вы предоставляете значение, которое не делится на 8, операция конфигурации будет отклонена. 

Если вы попытаетесь предоставить больше портов [SNAT](#snat) , чем доступно в зависимости от числа общедоступных IP-адресов, операция настройки отклоняется.

Если вы выдаете 10 000 портов на виртуальную машину и семь виртуальных машин в серверном пуле совместно используют один общедоступный IP-адрес, конфигурация отклоняется. Семь, умноженное на 10 000, превышает предельное число портов 64 000. Добавьте дополнительные общедоступные IP-адреса на интерфейсное правило исходящего трафика, чтобы включить этот сценарий. 

Вернитесь к [выделению порта по умолчанию](load-balancer-outbound-connections.md#preallocatedports) , указав 0 в качестве числа портов. Первые 50 экземпляров виртуальных машин получают порты 1024, 51-100 512 экземпляров виртуальных машин — до максимума.  Дополнительные сведения о выделении портов SNAT по умолчанию см. в разделе [Таблица распределения портов SNAT](#snatporttable).

### <a name="enable-outbound-only"></a><a name="scenario3out"></a>Включить только исходящие

#### <a name="details"></a>Подробнее

Используйте общедоступную подсистему балансировки нагрузки уровня "Стандартный", чтобы предоставить исходящий трафик NAT для группы виртуальных машин. В этом случае используйте правило исходящего трафика отдельно, не требуя дополнительных правил.

> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин без подсистемы балансировки нагрузки.  Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

### <a name="outbound-nat-for-vms-only-no-inbound"></a><a name="scenario4out"></a>NAT для исходящего трафика только для виртуальных машин (без входящего трафика)

> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин без подсистемы балансировки нагрузки.  Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

#### <a name="details"></a>Подробнее

Для этого сценария:

1. Создайте общедоступный IP-адрес или префикс.
2. Создайте общедоступную подсистему балансировки нагрузки уровня "Стандартный". 
3. Создайте интерфейс, связанный с общедоступным IP-адресом или префиксом, выделенным для исходящего трафика.
4. Создайте серверный пул для виртуальных машин.
5. Разместите виртуальные машины в серверном пуле.
6. Настройте правило исходящего трафика, чтобы включить исходящий трафик NAT.

Используйте префикс или общедоступный IP-адрес для масштабирования портов [SNAT](#snat) . Добавьте источник исходящих соединений в список разрешений или запретов.

### <a name="outbound-nat-for-internal-standard-load-balancer"></a><a name="scenario5out"></a>Исходящий трафик NAT для внутренней подсистемы балансировки нагрузки уровня "Стандартный"

> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин, использующих внутренний балансировщик нагрузки уровня "Стандартный".  Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

#### <a name="details"></a>Подробнее

Исходящее подключение недоступно для внутренней подсистемы балансировки нагрузки уровня "Стандартный", пока не была явно объявлена. 

Дополнительные сведения см. в разделе [Конфигурация подсистемы балансировки нагрузки только для исходящих подключений](https://docs.microsoft.com/azure/load-balancer/egress-only).


### <a name="enable-both-tcp--udp-protocols-for-outbound-nat-with-a-public-standard-load-balancer"></a><a name="scenario6out"></a>Включение протоколов TCP & UDP для исходящего NAT с помощью общедоступной подсистемы балансировки нагрузки уровня "Стандартный"

#### <a name="details"></a>Подробнее

При использовании общедоступного стандартного балансировщика нагрузки автоматически предоставляемый исходящий трафик NAT соответствует транспортному протоколу правила балансировки нагрузки. 

1. Отключите исходящий [SNAT](#snat) в правиле балансировки нагрузки. 
2. Настройте правило исходящего трафика для той же подсистемы балансировки нагрузки.
3. Повторно используйте серверный пул, который уже использовался для виртуальных машин. 
4. Укажите для протокола значение "Все" как часть правила для исходящего трафика. 

Если используются только правила NAT для входящего трафика, NAT для исходящего трафика обеспечиваться не будет. 

1. Поместите виртуальные машины в серверный пул.
2. Определить одну или несколько IP-конфигураций интерфейсов с общедоступными IP-адресами или префиксом общедоступного IP-адреса 
3. Настройте правило исходящего трафика для той же подсистемы балансировки нагрузки. 
4. Укажите для протокола значение "Все" как часть правила для исходящего трафика.

## <a name="terminology"></a><a name="terms"></a> Терминология

### <a name="source-network-address-translation"></a><a name="snat"></a>Преобразование адреса исходной сети

| Применимые протоколы |
|------------------------|
| TCP </br> UDP          |

#### <a name="details"></a>Подробнее

Развертывания в Azure могут взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов.

Когда экземпляр запускает исходящий трафик в место назначения с общедоступным IP-адресом, Azure динамически сопоставляет частный IP-адрес ресурса с общедоступным IP-адресом. 

После создания этого сопоставления трафик, возвращаемый для этого исходящего потока, достигает частного IP-адреса, в котором была создана последовательность. 

Для этой функции Azure использует **преобразование адресов исходной сети (SNAT)** .

### <a name="port-masquerading-snat-pat"></a><a name="pat"></a>SNAT с маскировкой портов (PAT)

| Применимые протоколы |
|------------------------|
| TCP </br> UDP          |

#### <a name="details"></a>Подробнее

Если частные IP-адреса находятся за одним общедоступным, Azure использует **преобразование адресов портов (PAT)** для скрытия частных. 

Для PAT используются временные порты, которые [предварительно выделяются](#preallocatedports) в зависимости от размера пула. 

Если общедоступная подсистема балансировки нагрузки связана с виртуальными машинами без общедоступных IP-адресов, каждый источник исходящего подключения перезаписывается. 

Источник переписывается из частного IP-адреса виртуальной сети в общедоступный IP-адрес подсистемы балансировки нагрузки. 

В пространстве общедоступного IP-адреса пять кортежей последовательности должны быть уникальными:

* Исходный IP-адрес
* Исходный порт
* Транспортный протокол IP
* Конечный IP-адрес
* Конечный порт 

Маскировка портов SNAT может использоваться с протоколами TCP или UDP. Порты SNAT используются после перезаписи частного исходного IP-адреса, так как несколько потоков исходят от одного общедоступного IP-адреса. Алгоритм маскировки портов SNAT предоставляет порты SNAT по-разному для UDP и TCP.

### <a name="snat-ports-tcp"></a>Порты SNAT (TCP)

| Применимые протоколы |
|------------------------|
| TCP |

#### <a name="details"></a>Подробнее

Порты SNAT являются временными портами для общедоступного IP-адреса источника. Для одного потока к конечным IP-адресу и порту используется один порт SNAT. 

При наличии нескольких потоков TCP к одним и тем же конечным IP-адресу, порту и протоколу каждый поток TCP использует отдельный порт SNAT. 

Это позволяет гарантировать, что потоки являются уникальными, если они берутся из одного общедоступного IP-адреса и передаются в:

* Тот же конечный IP-адрес
* Порт
* Протокол 

Несколько потоков совместно используют один порт SNAT. 

Конечный IP-адрес, порт и протокол делают потоки уникальными, устраняя необходимость в дополнительных портах источника, чтобы различать потоки в пространстве общедоступных IP-адресов.


### <a name="snat-ports-udp"></a>Порты SNAT (UDP)

| Применимые протоколы |
|------------------------|
| Протокол UDP |

#### <a name="details"></a>Подробнее

Для управления портами SNAT UDP и SNAT TCP используются разные алгоритмы.  Балансировщик нагрузки использует алгоритм с именем коническая NAT для UDP с ограниченным портом.

Один порт SNAT потребляется для любого целевого IP-адреса и порта для каждого потока.


### <a name="exhaustion"></a><a name="exhaustion"></a>Исчерпание

| Применимые протоколы |
|------------------------|
| Недоступно |

#### <a name="details"></a>Подробнее

Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока имеющиеся потоки не освободят порты SNAT. Подсистема балансировки нагрузки освобождает порты SNAT, когда поток закрывается.

Для освобождения портов SNAT подсистемой балансировки нагрузки используется [время ожидания простоя](../load-balancer/troubleshoot-outbound-connection.md#idletimeout) , равное четырем минутам.

Обычно порты UDP SNAT работают гораздо быстрее, чем порты TCP SNAT, из-за разницы в используемом алгоритме. Создание и масштабирование тестов из-за этой разницы.

### <a name="snat-port-release-behavior-tcp"></a>Поведение при выпуске порта SNAT (TCP)

| Применимые протоколы |
|------------------------|
| TCP |

#### <a name="details"></a>Подробнее

Когда сервер или клиент отправляет ФИНАКК, порт SNAT будет выпущен через 240 секунд. В случае появления RST-порта порт SNAT будет выпущен через 15 секунд. При достижении времени ожидания простоя порт освобождается.

### <a name="snat-port-release-behavior-udp"></a>Поведение при выпуске порта SNAT (UDP)

| Применимые протоколы |
|------------------------|
| TCP |

#### <a name="details"></a>Подробнее

При достижении времени ожидания простоя порт освобождается.

### <a name="snat-port-reuse"></a>Повторное использование порта SNAT

| Применимые протоколы |
|------------------------|
| TCP </br> UDP |

#### <a name="details"></a>Подробнее

После освобождения порта он становится доступным для повторного использования. Порты SNAT — это последовательность от наименьшего до наибольшего доступного для данного сценария, и для новых подключений используется первый доступный порт SNAT.

## <a name="limitations"></a>Ограничения

- Максимальное количество используемых эфемерных портов на один интерфейсный IP-адрес составляет 64 000.
- Диапазон настраиваемого времени ожидания перед переходом исходящих подключений в режим простоя составляет 4–120 минут (240–7200 секунд).
- Балансировщик нагрузки не поддерживает ICMP для исходящего NAT.
- Правила исходящего трафика могут применяться только к основной IP-конфигурации сетевого адаптера.  Невозможно создать правило исходящего трафика для вторичного IP-адреса виртуальной машины или NVA. Поддерживается несколько сетевых карт.
- Рабочие роли рабочих веб-процессов без виртуальной сети и других служб платформы Майкрософт могут быть доступны при использовании внутренней подсистемы балансировки нагрузки уровня "Стандартный". Эта доступность связана с побочным результатом работы служб предварительной виртуальной сети и других служб платформы. Не полагайтесь на этот побочный результат, так как сама служба или базовая платформа могут измениться без предварительного уведомления. Всегда Предположим, что вам нужно явно создавать исходящие подключения, если это необходимо при использовании только внутренней подсистемы балансировки нагрузки уровня "Стандартный". Сценарий 3, описанный в этой статье, недоступен.

## <a name="next-steps"></a>Дальнейшие шаги

Если возникают проблемы с исходящим подключением через Azure Load Balancer, см. [руководство по устранению неполадок для исходящих подключений](../load-balancer/troubleshoot-outbound-connection.md).

- Дополнительные сведения о [подсистеме балансировки нагрузки "Стандартный](load-balancer-standard-overview.md)".
- См. Ответы на [часто задаваемые вопросы о Azure Load Balancer](load-balancer-faqs.md).
- Дополнительные сведения о [правилах исходящего трафика](load-balancer-outbound-rules-overview.md) для стандартной общедоступной подсистемы балансировки нагрузки.

