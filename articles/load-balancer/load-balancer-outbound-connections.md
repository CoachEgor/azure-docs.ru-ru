---
title: Azure Load Balancer исходящего прокси-сервера
description: Описание использования Azure Load Balancer в качестве прокси-сервера для исходящего подключения к Интернету
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperfq1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: 185bb47677e978a3098f39024995da6399f90658
ms.sourcegitcommit: 80034a1819072f45c1772940953fef06d92fefc8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2020
ms.locfileid: "93241775"
---
# <a name="outbound-proxy-azure-load-balancer"></a>Azure Load Balancer исходящего прокси-сервера

Балансировщик нагрузки Azure можно использовать в качестве прокси для исходящего подключения к Интернету. Балансировщик нагрузки предоставляет исходящие подключения для внутренних экземпляров. 

Эта конфигурация использует **преобразование адресов исходной сети (SNAT)** . SNAT переписывает IP-адрес серверной части в общедоступный IP-адрес балансировщика нагрузки. 

SNAT включает **IP-маскировку** экземпляра серверной части. Это маскировка не позволяет внешним источникам напрямую обращаться к экземплярам серверной части. 

Совместное использование IP-адреса между экземплярами серверной части сокращает затраты на статические общедоступные IP-адреса и поддерживает такие сценарии, как упрощение списков разрешений IP с трафиком с известных общедоступных IP-адресов 

## <a name="sharing-ports-across-resources"></a><a name ="snat"></a> Совместное использование портов в ресурсах

Если серверные ресурсы балансировщика нагрузки не имеют общедоступных IP-адресов уровня экземпляра (ILPIP), они устанавливают исходящие подключения через интерфейсный IP-адрес общедоступной подсистемы балансировки нагрузки.

Порты используются для создания уникальных идентификаторов, используемых для поддержки различных потоков. Для предоставления такого отличия в Интернете используется пять кортежей.

Пять кортежей состоит из следующих компонентов:

* Конечный IP-адрес
* Конечный порт
* Исходный IP-адрес
* Исходный порт и протокол для обеспечения этого различия.

Если порт используется для входящих подключений, он будет иметь **прослушиватель** для входящих запросов на подключение к этому порту и не может использоваться для исходящих соединений. 

Чтобы установить исходящее подключение, необходимо использовать **временный порт** , чтобы предоставить назначение порту, на котором будет осуществляться обмен и обслуживание отдельного потока трафика. 

Каждый IP-адрес имеет 65 535 портов. Первые 1024 портов зарезервированы как **Системные порты** . Каждый порт можно использовать для входящих или исходящих соединений по протоколам TCP и UDP. 

Из оставшихся портов Azure предоставляет 64 000 для использования в качестве **временных портов** . При добавлении IP-адреса в качестве внешней IP-конфигурации эти временные порты можно использовать для SNAT.

С помощью правил исходящего трафика эти порты SNAT можно распространить на внутренние экземпляры, чтобы они могли совместно использовать общедоступные IP-адреса подсистемы балансировки нагрузки для исходящих соединений.

Сетевые подключения на узле для каждого экземпляра сервера будут выполнять SNAT для пакетов, входящих в исходящее подключение. Узел переписывает исходный IP-адрес на один из общедоступных IP. Узел переписывает исходный порт каждого исходящего пакета на один из портов SNAT.

## <a name="exhausting-ports"></a><a name="scenarios"></a> Исчерпание портов

Каждое подключение к одному и тому же IP-адресу назначения и порту назначения будет использовать порт SNAT. Это подключение поддерживает отдельный **поток трафика** от экземпляра серверной части или **клиента** до **сервера** . Этот процесс дает серверу отдельный порт для адресации трафика. Без этого процесса клиентский компьютер не знает, в какой поток входит пакет.

Представьте, что у вас есть несколько браузеров https://www.microsoft.com :

* IP-адрес назначения = 23.53.254.142
* Порт назначения = 443
* Протокол = TCP

Без различных портов назначения для возвращаемого трафика (порт SNAT, используемый для установления соединения) клиент не сможет разделить один результат запроса от другого.

Исходящие подключения могут быть пакетными. Экземпляру серверной части можно выделить недостаточные порты. Если не включить **повторное использование подключения** , то риск **нехватки портов** SNAT увеличится.

При нехватке портов новые исходящие подключения к целевому IP-адресу будут завершаться ошибкой. Подключения будут выполнены, если порт станет доступным. Это нехватка возникает, когда порты 64 000 с IP-адреса распределяются тонким по нескольким экземплярам серверной части. Инструкции по устранению нехватки портов SNAT см. в руководстве по [устранению неполадок](https://docs.microsoft.com/azure/load-balancer/troubleshoot-outbound-connection).  

Для подключений TCP подсистема балансировки нагрузки будет использовать один порт SNAT для каждого целевого IP-адреса и порта. Эта многократное включает несколько подключений к одному и тому же IP-адресу назначения с одним и тем же портом SNAT. Это многократное ограничено, если подключение не относится к разным портам назначения.

Для подключений UDP балансировщик нагрузки использует алгоритм **NAT с ограниченным портом** , который потребляет один порт SNAT на конечный IP-адрес, что и порт назначения. 

Порт используется повторно для неограниченного числа подключений. Порт используется повторно только в том случае, если указан другой IP-адрес или порт.

## <a name="port-allocation"></a><a name="preallocatedports"></a> Выделение портов

Каждому общедоступному IP-адресу, назначенному в качестве внешнего IP-адреса балансировщика нагрузки, назначаются порты SNAT 64 000 для членов серверного пула. Порты нельзя совместно использовать с элементами внутреннего пула. Диапазон портов SNAT может использоваться только одним внутренним экземпляром для обеспечения правильной маршрутизации возвращаемых пакетов. 

Для настройки выделения портов SNAT рекомендуется использовать явное правило исходящего трафика. Это правило позволит максимально увеличить число портов SNAT, доступных для исходящих подключений на каждом экземпляре сервера. 

Если вы используете автоматическое выделение исходящей SNAT с помощью правила балансировки нагрузки, то в таблице распределения будет определено распределение портов.

В следующей <a name="snatporttable"></a> таблице показано предварительное выделение портов SNAT для уровней размеров серверного пула.

| Размер пула (экземпляры виртуальных машин) | Предварительно выделяемые порты SNAT на каждую конфигурацию IP-адресов |
| --- | --- |
| 1–50 | 1024 |
| 51–100 | 512 |
| 101–200 | 256 |
| 201–400 | 128 |
| 401–800 | 64 |
| 801–1000 | 32 | 

>[!NOTE]
> Если имеется внутренний пул с максимальным размером 10, то каждый экземпляр может иметь 64000/10 = 6 400 портов, если определено явное правило исходящего трафика. В соответствии с приведенной выше таблицей в каждой из них будет 1 024, если выбрано автоматическое выделение.

## <a name="outbound-rules-and-virtual-network-nat"></a><a name="outboundrules"></a> Исходящие правила и NAT виртуальной сети

Azure Load Balancer правила исходящих подключений и NAT виртуальной сети — это параметры, которые можно использовать для выхода из виртуальной сети.

Дополнительные сведения о правилах исходящих подключений см. в разделе [правила исходящих подключений](outbound-rules.md).

Дополнительные сведения об NAT виртуальной сети Azure см. в статье [что такое NAT в виртуальной сети Azure](../virtual-network/nat-overview.md).

## <a name="constraints"></a>Ограничения

*   Порты будут выпущены через 15 секунд при получении или отправке **TCP RST**
*   Порты будут выпущены через 240 секунд при получении или отправке **финакк**
*   Когда подключение бездействует, а новые пакеты не отправляются, порты будут освобождены после 4 – 120 минут.
  * Это пороговое значение можно настроить с помощью правил исходящего трафика.
*   Каждый IP-адрес предоставляет порты 64 000, которые можно использовать для SNAT.
*   Каждый порт можно использовать для подключений TCP и UDP к конечному IP-адресу.
  * Порт SNAT UDP необходим независимо от того, является ли порт назначения уникальным. Для каждого подключения UDP к IP-адресу назначения используется один порт UDP SNAT.
  * Порт TCP SNAT можно использовать для нескольких подключений к одному и тому же IP-адресу назначения, если указаны другие порты назначения.
*   Нехватка SNAT возникает, когда на внутреннем экземпляре не хватает портов SNAT. Подсистема балансировки нагрузки может по-прежнему иметь неиспользуемые порты SNAT. Если порт SNAT, используемый экземпляром сервера, превышает заданные порты SNAT, он не сможет установить новые исходящие подключения.

## <a name="next-steps"></a>Дальнейшие действия

*   [Устранение сбоев исходящих подключений из-за нехватки SNAT](https://docs.microsoft.com/azure/load-balancer/troubleshoot-outbound-connection)
*   [Просмотрите метрики SNAT](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-diagnostics#how-do-i-check-my-snat-port-usage-and-allocation) и ознакомьтесь с правильным способом фильтрации, разбиения и просмотра.

