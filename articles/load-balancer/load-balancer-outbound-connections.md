---
title: Исходящие подключения в Azure
titleSuffix: Azure Load Balancer
description: В этой статье рассказывается о том, как Azure обеспечивает взаимодействие виртуальных машин с общедоступными службами Интернета.
services: load-balancer
documentationcenter: na
author: asudbring
ms.service: load-balancer
ms.custom: seodec18
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/07/2019
ms.author: allensu
ms.openlocfilehash: a6b0ebf811d662046d1a9a89fb75a0ab137569c3
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79284100"
---
# <a name="outbound-connections-in-azure"></a>Исходящие подключения в Azure

Azure предусматривает несколько различных механизмов установки исходящих подключений для клиентских развертываний. В этой статье описаны соответствующие сценарии, а также то, когда их применять, как они работают и как ими управлять.

>[!NOTE] 
>Эта статья относится только к модели развертывания с помощью Resource Manager. Рекомендации по использованию классической модели развертывания в Azure можно найти в [этой статье](load-balancer-outbound-connections-classic.md).

Развертывания в Azure могут взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов. Когда экземпляр инициирует исходящий поток к месту назначения в пространстве общедоступных IP-адресов, Azure динамически сопоставляет частный IP-адрес виртуальной машины с общедоступным IP-адресом. После создания этого сопоставления обратный трафик исходящего потока можно также направлять по частному IP-адресу, с которого изначально отправлен поток.

Для этого Azure использует преобразование адресов исходной сети (SNAT). Если несколько частных IP-адресов маскируются под одним общедоступным IP-адресом, Azure использует [преобразование адресов портов (PAT)](#pat), чтобы замаскировать частные IP-адреса. Для PAT используются временные порты, которые [предварительно выделяются](#preallocatedports) в зависимости от размера пула.

Есть несколько [сценариев для исходящих подключений](#scenarios). При необходимости их можно объединять. Тщательно ознакомьтесь с этими сценариями, чтобы узнать о возможностях, ограничениях и шаблонах, применимых к вашей модели развертывания и сценарию приложения. Просмотрите руководство по [управлению этими сценариями](#snatexhaust).

>[!IMPORTANT] 
>Load Balancer (цен. категория "Стандартный") и общедоступный IP-адрес категории "Стандартный" вводят новые возможности и различные расширения функциональности для исходящего подключения.  Это не то же самое, что и номера SKU категории "Базовый".  Если вам требуется исходящее подключение при работе с номерами SKU категории "Стандартный", вы должны явно определить это подключение с использованием общедоступных IP-адресов категории "Стандартный" или общедоступного Load Balancer категории "Стандартный".  Это включает в себя создание исходящих подключений при использовании внутренней Load Balancer (цен. категория "Стандартный").  Мы советуем всегда использовать правила для исходящего трафика в общедоступном Load Balancer категории "Стандартный".  [Сценарий 3](#defaultsnat) недоступен для номеров SKU категории "Стандартный".  Это значит, что при использовании внутреннего Load Balancer (цен. категории "Стандартный") необходимо выполнить действия, чтобы создать исходящее подключение (если оно требуется) для виртуальных машин в серверном пуле.  В контексте исходящего подключения одна изолированная виртуальная машина, все виртуальные машины в группе доступности и все экземпляры в масштабируемом наборе виртуальных машин ведут себя как группа. Это означает, что если одна виртуальная машина в группе доступности связана с номером SKU категории "Стандартный", то все остальные экземпляры в этой группе доступности теперь функционируют по тем же правилам, даже если отдельный экземпляр не связан с номером SKU категории "Стандартный" напрямую. Это поведение также наблюдается в случае автономной виртуальной машины с несколькими сетевыми картами, подключенными к подсистеме балансировки нагрузки. Если одна сетевая карта добавлена в автономный режим, она будет иметь такое же поведение. Внимательно просмотрите весь этот документ, чтобы понять общие принципы. Ознакомьтесь с [Load Balancer (цен. категории "Стандартный")](load-balancer-standard-overview.md), чтобы понять различия между номерами SKU, и с [правилами для исходящего трафика](load-balancer-outbound-rules-overview.md).  Правила для исходящего трафика позволяют проводить точный контроль над всеми аспектами установленных исходящих подключений.

## <a name="scenarios"></a>Обзор сценариев

При использовании [Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview) Azure Load Balancer и связанные ресурсы определяются явно.  Сейчас в Azure доступны три разных способа реализации исходящих подключений для ресурсов Azure Resource Manager. 

| Номера SKU | Сценарий | Метод | Протоколы IP | Description |
| --- | --- | --- | --- | --- |
| Ценовые категории "Стандартный" и "Базовый" | [1. Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с Load Balancer или без него)](#ilpip) | SNAT, маскировка портов не используется | TCP, UDP, ICMP, ESP | Azure использует общедоступный IP-адрес, назначенный IP-конфигурации сетевой карты в экземпляре. Доступны все временные порты экземпляра. При использовании Load Balancer (цен. категория "Стандартный") [правила исходящего трафика](load-balancer-outbound-rules-overview.md) не поддерживаются, если виртуальной машине назначен общедоступный IP-адрес. |
| Ценовые категории "Стандартный" и "Базовый" | [2. общедоступные Load Balancer, связанные с виртуальной машиной (без общедоступного IP-адреса в экземпляре)](#lb) | SNAT с маскировкой портов (PAT) с использованием подсистем балансировки нагрузки | TCP, UDP |Azure предоставляет общедоступные IP-адреса общедоступных подсистем балансировки нагрузки нескольким частным IP-адресам. Кроме того, Azure использует временные порты этих подсистем для PAT. Для явного определения исходящих подключений следует использовать [правила исходящего трафика](load-balancer-outbound-rules-overview.md) . |
| Ценовая категория "Базовый" или отсутствие номера SKU | [3. Автономная виртуальная машина (без Load Balancer, без общедоступного IP-адреса)](#defaultsnat) | SNAT с маскировкой портов (PAT) | TCP, UDP | Azure автоматически назначает общедоступный IP-адрес для SNAT, предоставляет его нескольким частным IP-адресам в группе доступности и использует временные порты общедоступного адреса. Это резервный сценарий для первых двух. Мы не рекомендуем его использовать, если необходимо контролировать использование адресов и управлять им. |

Если виртуальная машина не должна взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, можно использовать группы безопасности сети (NSG), чтобы блокировать доступ. Дополнительные сведения об использовании NSG см. в разделе [Запрет исходящих подключений](#preventoutbound). Эта статья не охватывает рекомендации по проектированию или практические сведения о том, как создать виртуальную сеть и управлять ею без доступа ко внешней сети.

### <a name="ilpip"></a>Сценарий 1. Виртуальная машина с общедоступным IP-адресом

В этом сценарии виртуальной машине назначен общедоступный IP-адрес. Так как здесь рассматриваются исходящие подключения, балансировка нагрузки виртуальной машины не имеет значения. Этот сценарий приоритетнее остальных. При использовании общедоступного IP-адреса виртуальная машина использует общедоступный IP-адрес для всех исходящих потоков.  

Общедоступный IP-адрес назначается виртуальной машине в соотношении "один к одному" (а не "один ко многим") через NAT типа "один к одному" без отслеживания состояния.  Маскировка портов (PAT) не используется, и виртуальная машина может использовать все временные порты.

Если приложение инициирует много исходящих потоков и возникает нехватка портов SNAT, рассмотрите возможность назначения [общедоступного IP-адреса для устранения ограничений SNAT](#assignilpip). Сведения о проблеме см. в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

### <a name="lb"></a>Сценарий 2. Виртуальная машина с балансировкой нагрузки без общедоступного IP-адреса

В этом сценарии виртуальная машина — часть внутреннего пула Load Balancer. Виртуальной машине не назначен общедоступный IP-адрес. Для ресурса Load Balancer необходимо настроить правило балансировки нагрузки для связывания общедоступного IP-адреса внешнего интерфейса с внутренним пулом.

Если вы не завершите эту конфигурацию правила, поведение будет описано в сценарии для [автономной виртуальной машины без общедоступного IP-адреса](#defaultsnat). Для правильной работы правила не обязательно, чтобы был прослушиватель во внутреннем пуле для успешной проверки работоспособности.

Когда виртуальная машина с балансировкой нагрузки создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный IP-адрес интерфейса общедоступной подсистемы балансировки нагрузки. Azure использует SNAT, чтобы выполнять эту функцию, а [PAT](#pat) — чтобы выдать несколько частных IP-адресов за один общедоступный. 

Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты интерфейсного общедоступного IP-адреса подсистемы балансировки нагрузки. При создании исходящих потоков в ходе SNAT динамически используются [предварительно выделенные временные порты](#preallocatedports). В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT выделяются предварительно, как описано в разделе [Основные сведения о SNAT и PAT](#snat). Они представляют собой ограниченный ресурс, который можно исчерпать. Важно понимать, как они [используются](#pat). Чтобы понять, как спроектировать архитектуру и избежать этой проблемы, см. сведения в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

Если [несколько общедоступных IP-адресов связаны с Load Balancer категории "Базовый"](load-balancer-multivip-overview.md), то любой из них, но только один случайно выбранный, можно использовать для исходящих потоков.  

Чтобы отслеживать работоспособность исходящих подключений с Load Balancer Basic, можно использовать [журналы Azure Monitor для Load Balancer](load-balancer-monitor-log.md) и [оповещения журналы событий](load-balancer-monitor-log.md#alert-event-log) для отслеживания сообщений о нехватке портов SNAT.

### <a name="defaultsnat"></a>Сценарий 3. Автономная виртуальная машина без общедоступного IP-адреса

В этом сценарии виртуальная машина не является частью общедоступного пула Load Balancer (но не является частью внутреннего пула Load Balancer (цен. категория "Стандартный")) и не имеет назначенного ему общедоступного IP-адреса. Когда виртуальная машина создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный исходный IP-адрес. Общедоступный IP-адрес, используемый для этого исходящего потока, настроить нельзя, и он не учитывается в ограничениях подписки на ресурсы общедоступного IP-адреса. Этот общедоступный IP-адрес не принадлежит вам и его не можно зарезервировать. При повторном развертывании виртуальной машины или набора доступности, либо масштабируемого набора виртуальных машин этот публичный IP-адрес будет выпущен и появится запрос на новый публичный IP-адрес. Не используйте этот сценарий для списка разрешенных IP-адресов. Вместо этого используйте один из двух других сценариев, в которых вы явно объявляете исходящий сценарий и общедоступный IP-адрес, который будет использоваться для исходящей связи.

>[!IMPORTANT] 
>Этот сценарий также применяется, когда подключен __только__ внутренний Load Balancer категории "Базовый". Сценарий 3 __недоступен__, если к виртуальной машине подключен внутренний Load Balancer категории "Стандартный".  Нужно явно создать [сценарий 1](#ilpip) или [сценарий 2](#lb) в дополнение к использованию внутреннего Load Balancer категории "Стандартный".

Для выполнения этой функции Azure использует SNAT с маскировкой портов ([PAT](#pat)). Эта ситуация аналогична [сценарию 2](#lb), кроме того, что нельзя управлять использованием IP-адреса. Это резервный сценарий, на случай если не исполняются сценарии 1 и 2. Мы не рекомендуем использовать этот сценарий, если необходим контроль над исходящими адресами. Если исходящие подключения являются важной частью приложения, необходимо выбрать другой сценарий.

Порты SNAT выделяются предварительно, как описано в разделе [Основные сведения о SNAT и PAT](#snat).  Количество виртуальных машин, совместно использующих группу доступности, определяет применяемый уровень предварительного выделения.  Изолированная виртуальная машина без группы доступности фактически представляет собой пул с 1 экземпляром для целей определения предварительного выделения (1024 порта SNAT). Порты SNAT представляют собой ограниченный ресурс, который может быть исчерпан. Важно понимать, как они [используются](#pat). Чтобы понять, как спроектировать архитектуру и избежать этой проблемы, см. сведения в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

### <a name="combinations"></a>Несколько объединенных сценариев

Сценарии, описанные в разделах выше, можно объединять для достижения определенного результата. При наличии нескольких сценариев применяется такая очередность: [сценарий 1](#ilpip) имеет приоритет над [сценарием 2](#lb) и [3](#defaultsnat). [Сценарий 2](#lb) имеет приоритет над [сценарием 3](#defaultsnat).

Например, в развертывании Azure Resource Manager приложение в большей степени использует исходящие подключения к ограниченному числу мест назначения, но также принимает входящие потоки через интерфейс подсистемы балансировки нагрузки. В этом случае можно объединить сценарии 1 и 2, чтобы оптимизировать нагрузку. Дополнительные шаблоны см. в разделе об [управлении при нехватке в ходе SNAT](#snatexhaust).

### <a name="multife"></a>Несколько интерфейсов для исходящих потоков

#### <a name="standard-load-balancer"></a>Load Balancer (цен. категория "Стандартный")

Load Balancer (цен. категория "Стандартный") использует всех кандидатов на исходящие потоки одновременно, когда присутствует [множество (общедоступных) IP-интерфейсов](load-balancer-multivip-overview.md). Каждый внешний интерфейс увеличивает количество доступных выделенных портов SNAT, если для исходящих соединений включено правило балансировки нагрузки.

Можно заблокировать использование внешнего IP-адреса для исходящих подключений с помощью нового параметра правила балансировки нагрузки.

```json    
      "loadBalancingRules": [
        {
          "disableOutboundSnat": false
        }
      ]
```

Обычно параметр `disableOutboundSnat` по умолчанию имеет значение _false_. Это означает, что это правило программирует исходящий SNAT для связанных виртуальных машин в серверном пуле правила балансировки нагрузки. `disableOutboundSnat` можно изменить на _true_, чтобы предотвратить использование в Load Balancer связанного с ним внешнего IP-адреса для исходящих соединений виртуальных машин в серверном пуле этого правила балансировки нагрузки.  Также можно назначить определенный IP-адрес для исходящего потока, как описано в подразделе об [объединении сценариев](#combinations).

#### <a name="load-balancer-basic"></a>Load Balancer категории "Базовый"

Если есть [несколько интерфейсов (общедоступных) IP-адресов](load-balancer-multivip-overview.md), которые можно использовать для исходящих потоков, Load Balancer категории "Базовый" выберет один интерфейс. Выбор нельзя настроить, а его алгоритм следует рассматривать как случайный. Вы можете указать определенный IP-адрес для исходящего потока, как описано в подразделе об [объединении сценариев](#combinations).

### <a name="az"></a> Зоны доступности

При использовании [Load Balancer категории "Стандартный" с зонами доступности](load-balancer-standard-availability-zones.md) избыточные между зонами интерфейсы могут обеспечивать избыточные между зонами исходящие SNAT-соединения, а SNAT-программирование сохраняется при сбое зоны.  Когда используются зональные интерфейсы, исходящие SNAT-соединения подвергаются тем же действиям, что и зона, к которой они принадлежат.

## <a name="snat"></a>Основные сведения о SNAT и PAT

### <a name="pat"></a>SNAT с маскировкой портов (PAT)

Когда общедоступный ресурс Load Balancer связан с экземплярами виртуальной машины, источник каждого исходящего подключения перезаписывается. Источник перезаписывается из частного IP-адреса виртуальной сети в общедоступный IP-адрес внешнего интерфейса Load Balancer. В пространстве общедоступных IP-адресов поток из 5 кортежей (исходного IP-адреса, исходного порта, транспортного IP-протокола, конечного IP-адреса, конечного порта) должен быть уникальным.  SNAT, маскирующий порты, может использоваться с протоколами TCP или UDP IP.

Для обеспечения этого используются временные порты (порты SNAT) после перезаписи частного исходного IP-адреса, так как из одного общедоступного IP-адреса исходят несколько потоков. Алгоритм SNAT, маскирующий порт, распределяет SNAT-порты по-разному для UDP и TCP.

#### <a name="tcp"></a>Порты SNAT TCP

Для одного потока к конечному IP-адресу используется один порт SNAT. При наличии нескольких потоков TCP к одним и тем же конечным IP-адресу, порту и протоколу каждый поток TCP использует отдельный порт SNAT. Это гарантирует уникальность потоков, отправляемых с одного и того же общедоступного IP-адреса к одним и тем же конечным IP-адресу, порту и протоколу. 

Несколько потоков, каждый из которых направляется к разным конечным IP-адресу, порту и протоколу, используют отдельный порт SNAT. Конечный IP-адрес, порт и протокол делают потоки уникальными, устраняя необходимость в дополнительных портах источника, чтобы различать потоки в пространстве общедоступных IP-адресов.

#### <a name="udp"></a>Порты SNAT UDP

Для управления портами SNAT UDP и SNAT TCP используются разные алгоритмы.  Load Balancer использует алгоритм, известный как "конусный NAT с ограниченным числом портов" для UDP.  Один порт SNAT используется для каждого потока независимо от порта IP-адреса назначения.

#### <a name="snat-port-reuse"></a>Повторное использование порта SNAT

После освобождения порта порт будет доступен для повторного использования по мере необходимости.  Порты SNAT можно рассматривать как последовательность от минимального к максимальному, доступному для данного сценария, и для новых подключений используется первый доступный порт SNAT. 
 
#### <a name="exhaustion"></a>Исчерпание

Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока имеющиеся потоки не освободят порты SNAT. Когда поток закрывается, подсистема балансировки нагрузки освобождает порты SNAT. Для их освобождения от простаивающих потоков используется [4-минутный период ожидания простоя](#idletimeout).

Порты SNAT для UDP исчерпываются обычно гораздо быстрее, чем порты SNAT для TCP из-за разницы в алгоритме использования. Вы должны проектировать и масштабировать тест с учетом этой разницы.

Шаблоны, позволяющие уменьшить риски возникновения условий, которые обычно приводят к нехватке портов, см. в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

### <a name="preallocatedports"></a>Предварительное выделение временных портов для SNAT с маскировкой портов (PAT)

При SNAT с маскировкой портов ([PAT](#pat)) Azure использует алгоритм, определяющий количество предварительно выделяемых доступных портов SNAT в зависимости от размера внутреннего пула. Порты SNAT — это временные порты, доступные для конкретного общедоступного исходного IP-адреса.

Для UDP и TCP заранее выделяется одинаковое число портов SNAT. Они потребляются независимо для каждого транспортного протокола IP.  Однако использование порта SNAT различается в зависимости от того, передается ли поток по протоколу UDP или TCP.

>[!IMPORTANT]
>SNAT категории SKU "Стандартный" программируются отдельно для разных транспортных протоколов IP с применением правил балансировки нагрузки.  Если правило балансировки нагрузки определено только для TCP, порты SNAT предоставляются только для TCP. Если правило балансировки нагрузки определено только для TCP, но вы хотите использовать исходящие порты SNAT для UDP, создайте правило балансировки нагрузки для UDP в том же интерфейсе и для того же пула серверной части.  Это позволит начать программирование SNAT для протокола UDP.  Применять рабочие правила и проверки работоспособности не нужно.  Порты SNAT категории SKU "Базовый" всегда программируются для обоих транспортных протоколов IP независимо от того, какие из них указаны в правиле балансировки нагрузки.

Azure предварительно выделяет эти порты для конфигурации IP-адресов сетевой карты в каждой виртуальной машине. При добавлении конфигурации IP-адресов в пул порты SNAT уже выделены для нее, исходя из размера внутреннего пула. Когда создаются исходящие потоки, эти порты динамически используются в [PAT](#pat) вплоть до предела выделения, а освобождаются они, когда поток закрывается или [истекает время ожидания простоя](#idletimeout).

В таблице ниже указаны предварительно выделяемые порты SNAT для уровней размера внутреннего пула.

| Размер пула (экземпляры виртуальных машин) | Предварительно выделяемые порты SNAT на каждую конфигурацию IP-адресов|
| --- | --- |
| 1–50 | 1024 |
| 51–100 | 512 |
| 101–200 | 256 |
| 201–400 | 128 |
| 401–800 | 64 |
| 801–1000 | 32 |

>[!NOTE]
> При использовании Load Balancer (цен. категории "Стандартный") с [множеством интерфейсов](load-balancer-multivip-overview.md) каждый внешний IP-адрес увеличивает количество доступных портов SNAT в предыдущей таблице. Например, серверный пул из 50 виртуальных машин с 2 правилами балансировки нагрузки, каждый с отдельными внешними IP-адресами, будет использовать 2048 (2 x 1024) SNAT-портов для каждой конфигурации IP. См. подробности в разделе [Несколько интерфейсов для исходящих потоков](#multife).

Помните, что количество доступных портов SNAT не преобразуется автоматически в количество потоков. Один порт SNAT можно использовать повторно для нескольких уникальных назначений. Порты используются, только если это необходимо, чтобы сделать поток уникальным. Советы по проектированию и уменьшению рисков см. [в разделе об управлении этим исчерпаемым ресурсом](#snatexhaust), а описание PAT — в разделе [SNAT с маскировкой портов (PAT)](#pat).

Изменение размера пула может повлиять на передачу некоторых имеющихся потоков. Если размер внутреннего пула увеличивается и он переходит на следующий уровень. Половина предварительно выделенных портов освобождается при переходе. Время ожидания потоков, связанных с освобожденным портом SNAT, истечет, и их нужно будет отправить повторно. Если предварительно выделенные порты доступны, новые потоки сразу успешно передаются.

Если размер серверного пула уменьшается с размера одного уровня до следующего размера, количество доступных портов SNAT растет. В этом случае имеющиеся выделенные порты SNAT и их потоки не будут затронуты.

Порты SNAT выделяются для конкретного транспортного протокола IP (то есть отдельно для TCP и UDP) и освобождаются при следующих условиях:

### <a name="tcp-snat-port-release"></a>Освобождение TCP-порта SNAT

- Если сервер или клиент отправляет ФИНАКК, порт SNAT будет выпущен через 240 с.
- Если получен сегмент с флагом RST, порт SNAT освобождается через 15 секунд.
- При достижении времени ожидания простоя порт освобождается.

### <a name="udp-snat-port-release"></a>Освобождение UDP-порта SNAT

- При достижении времени ожидания простоя порт освобождается.

## <a name="problemsolving"></a> Решение проблем 

В этом разделе описано, как устранить нехватку портов SNAT, которая может возникнуть у исходящих подключений в Azure.

### <a name="snatexhaust"></a>Управление нехваткой портов SNAT (PAT)
[Временные порты](#preallocatedports) , используемые для [Pat](#pat) , — это ограниченным ресурсом ресурс, как описано в разделе [Автономная виртуальная машина без общедоступного IP-адреса](#defaultsnat) и [виртуальной машины с БАЛАНСИРОВКОЙ нагрузки без общедоступного IP-адреса](#lb).

При инициировании множества исходящих TCP- или UDP-подключений к одним и тем же конечным IP-адресу и порту подключения будут завершаться сбоем или же вы будете получать уведомления от службы поддержки о нехватке SNAT (выделенных [временных портов](#preallocatedports), используемых для [PAT](#pat)). У вас есть несколько вариантов устранения этой проблемы. Ознакомьтесь с ними, чтобы выбрать доступный и подходящий вариант для своего сценария. Возможно, один или несколько вариантов помогут вам решить проблему.

Если вам непонятно поведение исходящих подключений, можно использовать статистику распределения IP-адресов (netstat) или записывать пакеты. Такую запись можно выполнять в гостевой ОС экземпляра или с помощью [Наблюдателя за сетями](../network-watcher/network-watcher-packet-capture-manage-portal.md).

#### <a name="connectionreuse"></a>Изменение приложения для повторного использования подключений 
Вы можете снизить потребность во временных портах, используемых для SNAT, повторно используя подключения в приложении. Это особенно касается таких протоколов, как HTTP/1.1, в которых подключения используются повторно по умолчанию. В свою очередь, это может положительно повлиять на другие протоколы, использующие HTTP в качестве транспортировки (например, REST). 

Повторное использование всегда лучше, чем отдельные, атомарные TCP-подключения для каждого запроса. Оно позволяет повысить производительность и эффективность транзакций TCP.

#### <a name="connection pooling"></a>Изменение приложения для использования пулов подключений
Можно использовать в приложении схему пула подключений, при которой внутренний механизм распределяет запросы по фиксированному набору подключений (каждое из которых повторно используется, если это возможно). Эта схема ограничивает количество используемых временных портов и делает среду более предсказуемой. Кроме того, она может повысить пропускную способность запросов, позволяя одновременно выполнять несколько операций, когда отдельное подключение блокируется, ожидая результата операции.  

Возможно, пулы подключений уже существуют в платформе, которая используется вами для разработки приложения или параметров конфигурации приложения. Их можно объединить с повторным использованием подключений. В этом случае для обработки нескольких запросов можно будет использовать фиксированное, прогнозируемое число портов для одних и тех же конечных IP-адреса и порта. Кроме того, вы можете воспользоваться преимуществами повышенной эффективности транзакций TCP, сокращающей задержки и использование ресурсов. Транзакции UDP также могут предоставлять преимущества, так как возможность изменить число потоков UDP позволяет избежать нехватки и управлять использованием портов SNAT.

#### <a name="retry logic"></a>Изменение приложения для использования менее "жесткой" логики повторных попыток
При нехватке [предварительно выделенных временных портов](#preallocatedports) для [PAT](#pat) или сбоях приложения строгая логика повтора или логика повтора методом подбора без логики отхода и времени сохранения не позволяет устранить проблему. Вы можете снизить потребность во временных портах, используя менее "жесткую" логику повторных попыток. 

Для временных портов установлено время ожидания простоя 4 минуты (не регулируется). Если повторные попытки слишком частые, нехватка будет наблюдаться в любом случае. Поэтому знать, как и как часто приложение повторяет транзакции, очень важно для проектирования.

#### <a name="assignilpip"></a>Назначение общедоступного IP-адреса каждой виртуальной машине
Назначение общедоступного IP-адреса изменяет ваш сценарий на [общедоступный IP-адрес виртуальной машины](#ilpip). Все временные порты общедоступного IP-адреса, используемые для каждой виртуальной машины, доступны для каждой из них. (В отличие от сценариев, в которых временные порты общедоступного IP-адреса используются совместно со всеми виртуальными машинами, связанными с соответствующим внутренним пулом.) Существуют компромиссы, которые следует учитывать, например дополнительные расходы на общедоступные IP-адреса и потенциальное воздействие список разрешений на большое количество отдельных IP-адресов.

>[!NOTE] 
>Такая возможность недоступна для рабочих ролей.

#### <a name="multifesnat"></a>Использование нескольких внешних интерфейсов

При использовании общедоступного Load Balancer категории "Стандартный" назначаются [несколько внешних IP-адресов для исходящих подключений](#multife) и [количество доступных портов SNAT увеличивается](#preallocatedports).  Создайте внешнюю IP-конфигурацию, правило и внутренний пул для активации программирования SNAT для общедоступного IP-адреса интерфейса.  Правило не должно функционировать, и проверка работоспособности не должна завершиться успешно.  Если используются несколько внешних интерфейсов для входящих подключений (а не только для исходящих), нужно использовать специальные проверки работоспособности, чтобы обеспечить надежность.

>[!NOTE]
>В большинстве случаев нехватка портов SNAT является признаком плохой конфигурации.  Прежде чем использовать больше интерфейсов для добавления портов SNAT, убедитесь, что вы понимаете, почему не хватает портов.  Возможно, где-то прячется проблема, которая может привести к сбою позже.

#### <a name="scaleout"></a>Горизонтальное масштабирование

[Предварительно выделенные порты](#preallocatedports) назначаются в соответствии с размером внутреннего пула и группируются по уровням. Это позволяет минимизировать нарушения работы, когда нужно перераспределить несколько портов для размещения следующего более крупного уровня пула серверной части.  Вы можете увеличить интенсивность использования портов SNAT для определенного интерфейса, масштабируя пул серверной части до максимального размера для заданного уровня.  Это важное условие для эффективного масштабирования приложения.

Например, для двух виртуальных машин в пуле серверной части выделяется 1024 порта SNAT на каждую конфигурацию IP, что позволяет использовать в общей сложности 2048 портов SNAT в этом развертывании.  Если вы увеличите это развертывание до 50 виртуальных машин, сохраняя прежнее число выделяемых портов на виртуальную машину, развертывание сможет использовать в общей сложности 51 200 портов SNAT (50 x 1024).  Если вы хотите масштабировать развертывание, проверьте число [предварительно выделяемых портов](#preallocatedports) для соответствующего уровня, чтобы правильно настроить масштабирование в соответствии с максимальными возможностями уровня.  Если в описанном выше развертывании вы увеличите число экземпляров до 51 (вместо 50), вы перейдете на следующий уровень, и число портов SNAT окажется меньшим как для каждой виртуальной машины, так и суммарно.

При масштабировании до следующего более крупного уровня размеров пула серверной части существует вероятность того, что некоторые из ваших исходящих подключений будут отключены, если выделенные порты не будут перераспределены.  Если используются только некоторые из портов SNAT, масштабирование в следующем большем размере северного пула не имеет значения.  Половина существующих портов будет перераспределяться каждый раз, когда вы переходите на следующий уровень северного пула.  Если же перераспределение нежелательно, выбирайте параметры развертывания в соответствии с текущим уровнем.  В качестве альтернативного решения можно реализовать в приложении логику отслеживания и повторных попыток.  Проверка активности TCP поможет определять, когда порты SNAT теряют работоспособность из-за перераспределения.

### <a name="idletimeout"></a>Использование проверки активности для сброса времени ожидания простоя исходящих подключений

Для исходящих подключений задано время ожидания простоя 4 минуты. Это время ожидания регулируется с помощью [правил исходящего трафика](../load-balancer/load-balancer-outbound-rules-overview.md#idletimeout). Можно также использовать транспорт (например, TCP проверку активности) или проверку активности уровня приложения для обновления потока простоя и сброса этого времени ожидания простоя при необходимости.  

Если вы решите использовать проверку активности TCP, ее достаточно организовать на одной стороне соединения. Например, проверка активности со стороны сервера будет успешно сбрасывать таймер ожидания для последовательности, избавляя от необходимости поддерживать активность TCP-соединения с обеих сторон.  Этот же подход применим и для уровня приложений, в том числе в системах баз данных "клиент — сервер".  Выясните, какие средства на стороне сервера позволяют поддерживать активность для конкретного приложения.

## <a name="discoveroutbound"></a>Обнаружение общедоступного IP-адреса, используемого виртуальной машиной
Существует много способов определить общедоступный исходный IP-адрес исходящего подключения. OpenDNS — это служба, которая может показать общедоступный IP-адрес виртуальной машины. 

С помощью команды nslookup можно отправить к сопоставителю OpenDNS запрос DNS для имени myip.opendns.com. Служба возвращает исходный IP-адрес, который был использован для отправки запроса. При выполнении следующего запроса, поступившего с виртуальной машины, ответ будет содержать общедоступный IP-адрес, используемый для этой виртуальной машины.

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a>Запрет исходящих подключений
Иногда создание виртуальной машиной исходящих потоков может быть нежелательным. Кроме того, вам может понадобиться ограничить пункты назначения, доступные для исходящих потоков или назначений, инициирующих входящие потоки. В таком случае можно использовать [группы безопасности сети](../virtual-network/security-overview.md), чтобы управлять пунктами назначений, доступными для виртуальной машины. Кроме того, с их помощью можно выбирать общедоступные назначения, способные инициировать входящие потоки.

При использовании NSG для виртуальной машины с балансировкой нагрузки обратите внимание на [теги службы](../virtual-network/security-overview.md#service-tags) и [правила безопасности по умолчанию](../virtual-network/security-overview.md#default-security-rules). Следует убедиться, что виртуальная машина может получать запросы проверки состояния работоспособности из Azure Load Balancer. 

Если NSG блокирует такие запросы от тега по умолчанию AZURE_LOADBALANCER, запрос завершается сбоем, а виртуальная машина помечается как отключенная. Подсистема балансировки нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="limitations"></a>Ограничения
- DisableOutboundSnat недоступен в качестве параметра при настройке правила балансировки нагрузки на портале.  Вместо этого используйте REST, шаблон или средства клиента.
- Рабочие веб-роли без виртуальной сети и другие службы платформы Майкрософт могут быть доступны при использовании только внутренней подсистемы Load Balancer уровня "Стандартный" из-за побочного эффекта от того, как работают службы, созданные до использования виртуальной сети, и другие функции служб платформы. Не рассчитывайте на этот побочный эффект, так как соответствующая служба или базовая платформа могут измениться без уведомления. Вы всегда должны предполагать, что вам при необходимости нужно явно создать исходящее подключение при использовании только Load Balancer уровня "Стандартный". Сценарий 3 [SNAT](#defaultsnat) по умолчанию, описанный в этой статье, недоступен.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше об [Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).
- Дополнительные сведения о [правилах для исходящего трафика](load-balancer-outbound-rules-overview.md) для общедоступного Load Balancer категории "Стандартный".
- [Обзор Azure Load Balancer](load-balancer-overview.md)
- Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).
- Дополнительные сведения о некоторых других ключевых [сетевых возможностях](../networking/networking-overview.md) Azure.
