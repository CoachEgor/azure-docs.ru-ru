---
title: Правила исходящего трафика Azure Load Balancer
description: В этой статье объясняется, как настроить правила исходящего трафика для управления исходящим трафиком Интернета с Azure Load Balancer.
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperfq1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: 51810876e3636b7023ce9c9318a071636bb00c4c
ms.sourcegitcommit: 090ea6e8811663941827d1104b4593e29774fa19
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2020
ms.locfileid: "92002657"
---
# <a name="outbound-rules-azure-load-balancer"></a><a name="outboundrules"></a>Правила исходящего трафика Azure Load Balancer

Правила исходящего трафика позволяют настроить общедоступную службу "Исходящие" стандартные подсистемы балансировки нагрузки (преобразование адресов исходной сети). Эта конфигурация позволяет использовать общедоступные IP-адреса подсистемы балансировки нагрузки в качестве прокси-сервера.

Эта конфигурация включает:

* Маскировка IP-адресов
* Упрощение списков разрешений.
* Сокращает число общедоступных IP-ресурсов для развертывания.

Правила исходящего трафика позволяют полностью декларативно управлять исходящим подключением к Интернету. Правила исходящего трафика позволяют масштабировать и настраивать эту возможность для конкретных нужд. 

Исходящие правила будут выполнены только в том случае, если на внутренней виртуальной машине не установлен общедоступный IP-адрес уровня экземпляра (ILPIP).

![Правила для исходящего трафика Load Balancer](media/load-balancer-outbound-rules-overview/load-balancer-outbound-rules.png)

С помощью правил исходящего трафика можно явно определить поведение исходящего подключения **SNAT** .

Правила для исходящего трафика позволяют управлять следующим:

* **На каких виртуальных машинах выполняется преобразование общедоступных IP-адресов.**
     * Два правила — серверный пул A, использующий IP-адрес A и B, серверный пул B использует IP-адрес C и D.
* **Как выдаются исходящие порты SNAT.**
     * Внутренний пул B — это единственный пул, исходящий исходящие подключения. все порты SNAT следует передавать в серверный пул B и None в серверный пул A.
* **Протоколы для предоставления исходящего преобразования.**
     * Для исходящего трафика серверному пулу B требуются UDP-порты. Серверному пулу A требуется TCP. Назначьте порты TCP портам UDP и B.
* **Какая продолжительность истечения времени ожидания бездействия исходящего подключения (4-120 минут).**
     * Если имеются длительные подключения к проверку активности, резервируете неактивные порты для длительных подключений до 120 минут. Предполагается, что устаревшие подключения отброшены и порты выпускаются в течение 4 минут для новых подключений. 
* **Указывает, следует ли отправить сброс TCP при превышении времени ожидания простоя.**
     * Если время ожидания простаивающих подключений истекло, мы отправляем TCP RST клиенту и серверу, чтобы они обзнали, что поток отброшен?

## <a name="outbound-rule-definition"></a>Определение правила для исходящего трафика

Правила исходящего трафика следуют тому же привычному синтаксису, что и правила балансировки нагрузки и входящего трафика NAT: **интерфейсный**  +  **parameters**  +  **Пул внутренних**параметров. 

Правило для исходящего трафика настраивает NAT для исходящего трафика, предусматривающее преобразование _всех виртуальных машин, определенных с помощью серверного пула_, во _внешний интерфейс_.  

_Параметры_ обеспечивают дополнительный детализированный контроль над алгоритмом исходящего трафика NAT.

## <a name="scale-outbound-nat-with-multiple-ip-addresses"></a><a name="scale"></a> Масштабирование NAT для исходящего трафика при использовании нескольких IP-адресов

Каждый дополнительный IP-адрес, предоставляемый интерфейсом, предоставляет дополнительные 64 000 временных портов для подсистемы балансировки нагрузки для использования в качестве портов SNAT. 

Используйте несколько IP-адресов для планирования крупномасштабных сценариев. Используйте правила исходящего трафика для устранения [нехватки SNAT](troubleshoot-outbound-connection.md#snatexhaust). 

[Префикс общедоступного IP-адреса](https://aka.ms/lbpublicipprefix) можно также использовать непосредственно с исходящим правилом. 

Префикс общедоступного IP-адреса увеличивает масштаб развертывания. Префикс можно добавить в список разрешенных потоков, исходящих из ресурсов Azure. Можно настроить интерфейсную IP-конфигурацию в подсистеме балансировки нагрузки для ссылки на префикс общедоступного IP-адреса.  

Подсистема балансировки нагрузки управляет префиксом общедоступного IP-адреса. Правило исходящего трафика будет автоматически использовать все общедоступные IP-адреса, содержащиеся в префиксе общедоступного IP-адрес для исходящих соединений. 

Каждый IP-адрес в пределах префикса общедоступного IP-адреса предоставляет дополнительные 64 000 временных портов для каждого IP-адреса балансировщика нагрузки для использования в качестве портов SNAT.

## <a name="outbound-flow-idle-timeout-and-tcp-reset"></a><a name="idletimeout"></a> Тайм-аут простоя исходящего потока и сброс TCP

Правила для исходящего трафика обеспечивают параметр конфигурации для управления временем ожидания перед переходом исходящего потока в режим простоя и сопоставляют его с потребностями приложения. По умолчанию время ожидания перед переходом исходящего потока в режим простоя составляет 4 минуты. Дополнительные сведения см. в разделе [Настройка времени ожидания простоя](load-balancer-tcp-idle-timeout.md). 

Поведение подсистемы балансировки нагрузки по умолчанию заключается в автоматическом удалении потока при достижении времени ожидания истечения исходящего трафика. `enableTCPReset`Параметр обеспечивает предсказуемое поведение приложения и управление им. Параметр определяет, следует ли отсылать двунаправленный сброс TCP (TCP RST) по истечении времени ожидания истечения срока действия исходящего трафика. 

Чтобы получить сведения о доступности региона, проверьте [Сброс TCP на время ожидания простоя](https://aka.ms/lbtcpreset) .

## <a name="securing-and-controlling-outbound-connectivity-explicitly"></a><a name="preventoutbound"></a>Явная защита исходящих подключений и управление ими

Правила балансировки нагрузки обеспечивают автоматическое программирование исходящего NAT. В некоторых сценариях используется преимущество или требуется отключить автоматическое программирование исходящего NAT в рамках правила балансировки нагрузки. Отключение с помощью правила позволяет управлять поведением или уточнять его.  

Этот параметр можно использовать двумя способами:

1. Предотвращение входящего IP-адреса для исходящей SNAT. Отключите исходящее значение SNAT в правиле балансировки нагрузки.
  
2. Настройте параметры исходящего трафика **SNAT** для IP-адреса, используемого для входящих и исходящих подключений одновременно. Для получения управления исходящим правилом необходимо отключить автоматический исходящий NAT. Чтобы изменить распределение портов SNAT для адреса, которое также используется для входящего трафика, `disableOutboundSnat` параметр должен иметь значение true. 

При попытке переопределить IP-адрес, используемый для входящего трафика, операция настройки правила для исходящего трафика завершится ошибкой.  Сначала отключите исходящий NAT правила балансировки нагрузки.

>[!IMPORTANT]
> Виртуальная машина не будет иметь исходящего подключения, если для этого параметра задано значение true и отсутствует правило исходящего трафика для определения исходящих подключений.  Некоторые операции на виртуальной машине или в приложении могут зависеть от доступности исходящего подключения. Ознакомьтесь с зависимостями сценария и проанализируйте влияние этого изменения.

Иногда нежелательно, чтобы виртуальная машина была создана в качестве исходящего потока. Может существовать требование для управления тем, какие назначения получают исходящие потоки, или назначения, которые начинают входящие потоки. Используйте [группы безопасности сети](../virtual-network/security-overview.md) для управления назначениями, которые достигает виртуальная машина. Используйте группы безопасности сети для управления тем, какие общедоступные назначения начинают входящие потоки.

При использовании NSG для виртуальной машины с балансировкой нагрузки обратите внимание на [теги службы](../virtual-network/security-overview.md#service-tags) и [правила безопасности по умолчанию](../virtual-network/security-overview.md#default-security-rules). 

Убедитесь, что виртуальная машина может принимать запросы проверки работоспособности от Azure Load Balancer.

Если NSG блокирует запросы проверки работоспособности от тега AZURE_LOADBALANCER по умолчанию, проверка работоспособности виртуальной машины завершается сбоем, а виртуальная машина помечается как недоступная. Балансировщик нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="limitations"></a>Ограничения

- Максимальное количество используемых эфемерных портов на один интерфейсный IP-адрес составляет 64 000.
- Диапазон настраиваемого времени ожидания перед переходом исходящих подключений в режим простоя составляет 4–120 минут (240–7200 секунд).
- Балансировщик нагрузки не поддерживает ICMP для исходящего NAT.
- Правила исходящего трафика могут применяться только к основной IP-конфигурации сетевого адаптера.  Невозможно создать правило исходящего трафика для вторичного IP-адреса виртуальной машины или NVA. Поддерживается несколько сетевых карт.
- Все виртуальные машины в группе **доступности** должны быть добавлены во внутренний пул для исходящих подключений. 
- Все виртуальные машины в **масштабируемом наборе виртуальных машин** должны быть добавлены во внутренний пул для исходящих подключений.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения об [Azure Load Balancer (цен. Категория "Стандартный")](load-balancer-overview.md)
- Ознакомьтесь с [ответами на часто задаваемые вопросы о Azure Load Balancer](load-balancer-faqs.md)

