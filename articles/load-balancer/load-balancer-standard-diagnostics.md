---
title: Диагностика с метриками, оповещениями и работоспособностью ресурсов - Балансер стандартной нагрузки Azure
description: Используйте доступные метрики, оповещения и информацию о работоспособности ресурсов для диагностики баланса стандартной нагрузки Azure.
services: load-balancer
documentationcenter: na
author: asudbring
ms.custom: seodec18
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/14/2019
ms.author: allensu
ms.openlocfilehash: 861961bb66adc7ed9509eab973516a964cb67492
ms.sourcegitcommit: b0ff9c9d760a0426fd1226b909ab943e13ade330
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2020
ms.locfileid: "80521068"
---
# <a name="standard-load-balancer-diagnostics-with-metrics-alerts-and-resource-health"></a>Диагностика Load Balancer (цен. категория "Стандартный") с помощью метрик, оповещений и сведений о работоспособности ресурсов

Балансизатор стандартной нагрузки Azure предоставляет следующие диагностические возможности:

* **Многомерные метрики и оповещения**: Обеспечивает многомерные диагностические возможности через [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) для стандартных конфигураций балансироворовки нагрузки. Вы можете контролировать, управлять и устранить стандартные ресурсы балансоровой нагрузки.

* **Здоровье ресурсов**: Страница балансосатора нагрузки на портале Azure и страница «Здоровье ресурсов» (под монитором) разоблачают раздел «Здоровье ресурсов» для балансировора стандартной нагрузки. 

Эта статья содержит краткий обзор этих возможностей и способов их использования для Load Balancer уровня "Стандартный". 

## <a name="multi-dimensional-metrics"></a><a name = "MultiDimensionalMetrics"></a>Многомерные метрики

Azure Load Balancer предоставляет многомерные метрики через azure Metrics на портале Azure и помогает получать диагностические сведения о ресурсах балансоровых нагрузок в режиме реального времени. 

Различные конфигурации Load Balancer уровня "Стандартный" предоставляют следующие метрики:

| Метрика | Тип ресурса | Описание | Рекомендуемая статистическая обработка |
| --- | --- | --- | --- |
| Доступность пути данных (доступность VIP)| Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" непрерывно использует путь к данным из региона к внешнему интерфейсу подсистемы балансировки нагрузки, а затем в стек SDN, поддерживающий виртуальную машину. Пока остаются работоспособные экземпляры, измерение выполняется по тому же пути, что и трафик приложения с балансировкой нагрузки. Проверяется также путь к данным, который используют ваши клиенты. Измерение является невидимым для приложения и не влияет на работоспособность других операций.| Среднее |
| Состояние зонда здоровья (доступность DIP) | Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" использует распределенную службу проверки работоспособности, которая контролирует состояние конечной точки приложения в соответствии с параметрами конфигурации. Эта метрика обеспечивает агрегированное или отфильтрованное представление для каждой конечной точки экземпляра в пуле подсистемы балансировки нагрузки. Вы можете посмотреть, как в службе Load Balancer исследуется работоспособность вашего приложения в соответствии с заданными настройками проверки. |  Среднее |
| Пакеты SYN (синхронизация) | Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" не прерывает TCP-подключения и не взаимодействует с потоками пакетов TCP и UDP. Потоки и их подтверждения всегда происходят между источником и экземпляром виртуальной машины. Чтобы оптимизировать устранение неполадок для всех сценариев протокола TCP, вы можете использовать счетчики пакетов SYN. С их помощью можно определить число попыток подключения TCP. Эта метрика указывает количество принятых пакетов TCP SYN.| Среднее |
| Подключения SNAT | Общедоступная подсистема балансировки нагрузки |Load Balancer уровня "Стандартный" передает число замаскированных исходящих потоков на общедоступный интерфейсный IP-адрес. Количество портов преобразования исходных сетевых адресов (SNAT) ограничено. Эта метрика может дать представление о том, насколько сильно ваше приложение зависит от SNAT для исходящих потоков. Выводятся данные счетчиков для успешного и неудачного выполнения исходящих потоков SNAT. Эти данные помогают устранять неполадки и определять работоспособность исходящих потоков.| Среднее |
| Выделенные порты SNAT | Общедоступная подсистема балансировки нагрузки | Standard Load Balancer сообщает о количестве портов SNAT, выделенных на экземпляр бэкэнда | Средняя. |
| Подержанные порты SNAT | Общедоступная подсистема балансировки нагрузки | Standard Load Balancer сообщает о количестве портов SNAT, которые используются в экземпляре бэкэнда. | Среднее | 
| Счетчики байтов |  Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" передает количество данных, обработанных каждым внешним интерфейсом. Вы можете заметить, что байты не распределяются поровну по бэкэнд-министам. Это ожидается, так как алгоритм баланса нагрузки Azure основан на потоках | Среднее |
| Счетчики пакетов |  Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" передает количество пакетов, обработанных каждым внешним интерфейсом.| Среднее |

### <a name="view-your-load-balancer-metrics-in-the-azure-portal"></a>Просмотр метрик подсистемы балансировки нагрузки на портале Azure

Портал Azure предоставляет метрики баланса нагрузки через страницу Метрики, которая доступна как на странице ресурса баланса нагрузки для определенного ресурса, так и на странице Azure Monitor. 

Чтобы просмотреть метрики для ресурсов Load Balancer уровня "Стандартный", сделайте следующее:
1. Перейдите на страницу Метрики и сделайте любой из следующих вопросов:
   * На странице ресурсов подсистемы балансировки нагрузки выберите тип метрики в раскрывающемся списке.
   * На странице Azure Monitor выберите ресурс подсистемы балансировки нагрузки.
2. Установите соответствующий тип агрегации метрики.
3. При необходимости настройте требуемые фильтрацию и группирование.
4. Дополнительно настроить временной диапазон и агрегацию. По умолчанию время отображается в UTC.

  >[!NOTE] 
  >Агрегация времени важна при интерпретации определенных метрик, поскольку данные отбирают один раз в минуту. Если агрегация времени установлена до пяти минут, а тип метрики агрегации Sum используется для таких показателей, как SNAT Allocation, ваш график будет отображать в пять раз больше общего выделенного SNAT портов. 

![Метрики для балансировора стандартной нагрузки](./media/load-balancer-standard-diagnostics/lbmetrics1anew.png)

*Рисунок: Метрика доступности пути данных для балансировора стандартной нагрузки*

### <a name="retrieve-multi-dimensional-metrics-programmatically-via-apis"></a>Получение многомерных метрик через API-интерфейсы программным образом

Инструкции по получению определений и значений многомерных метрик с помощью API см. в статье [Azure Monitoring REST API walkthrough](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-rest-api-walkthrough#retrieve-metric-definitions-multi-dimensional-api) (Пошаговое руководство по REST API Azure Monitor). Эти метрики могут быть записаны на учетную запись хранилища только через опцию "Все метрики". 

### <a name="common-diagnostic-scenarios-and-recommended-views"></a><a name = "DiagnosticScenarios"></a>Распространенные сценарии диагностики и рекомендуемые представления

### <a name="configure-alerts-for-multi-dimensional-metrics"></a>Настройка оповещений для многомерных метрик ###

Балансизатор стандартной загрузки Azure поддерживает легко настраиваемые оповещения для многомерных метрик. Нанастройка пользовательских пороговых значений для конкретных метрик для запуска оповещений с различными уровнями серьезности, чтобы расширить возможности бесконтактного опыта мониторинга ресурсов.

Чтобы настроить оповещения, сделайте следующее:
1. Перейти к оповещению подлезвить для балансиватора нагрузки
1. Создание правила генерации оповещений
    1.  Настройка состояния оповещения
    1.  (Необязательно) Добавление группы действий для автоматического ремонта
    1.  Назначить серьезность оповещения, имя и описание, которое позволяет интуитивно реагировать


  >[!NOTE]
  >Окно конфигурации состояния оповещения покажет временные ряды для истории сигналов. Существует возможность фильтрации этой временной серии по таким измерениям, как Backend IP. Это позволит фильтровать график временных рядов, но **не** сам оповещение. Невозможно настроить оповещения для конкретных IP-адресов Backend.
  
#### <a name="is-the-data-path-up-and-available-for-my-load-balancer-vip"></a>Доступен ли путь к данным для виртуального IP-адреса подсистемы балансировки нагрузки?

Метрика доступности виртуального IP-адреса предоставляет сведения о работоспособности пути к данным из региона к вычислительному узлу, где размещены виртуальные машины. Эта метрика отражает работоспособность инфраструктуры Azure. Используя эту метрику, можно:
- отслеживать внешнюю доступность вашей службы;
- получить более подробную информацию о том, нормально ли функционирует платформа, на которой развернута служба, и узнать состояние работоспособности гостевой ОС или экземпляра приложения;
- определить, к чему относится событие: к службе или к базовой плоскости данных. Не путайте эту метрику с состоянием пробы работоспособности (метрика доступности выделенного IP-адреса).

Чтобы получить доступность пути данных для ресурсов балансировки стандартной нагрузки:
1. Убедитесь, что выбран правильный ресурс подсистемы балансировки нагрузки. 
2. В **списке метрических** выпадающих данных выберите **доступность пути данных.** 
3. В раскрывающемся списке **Агрегирование** выберите **Среднее**. 
4. Кроме того, добавьте фильтр на IP-адрес Frontend или порт Frontend в качестве измерения с требуемым фронтовым IP-адресом или передним портом, а затем сгруппируйте их по выбранному измерению.

![Проверка виртуального IP-адреса](./media/load-balancer-standard-diagnostics/LBMetrics-VIPProbing.png)

*Рисунок: Load Balancer Frontend зондирования детали*

Метрика создается с помощью активного внутриполосного измерения. Служба проверки формирует трафик для измерения в пределах региона. Служба активируется сразу после создания развертывания с общедоступным интерфейсом и продолжает работу, пока этот интерфейс не будет удален. 

Периодически создается пакет, соответствующий внешнему интерфейсу и правилу развертывания. Он направляет трафик в регионе от источника к узлу, где расположена виртуальная машина в серверном пуле. Инфраструктура подсистемы балансировки нагрузки выполняет те же операции балансировки нагрузки и преобразования, что и для остального трафика. Эта проба находится в сети внутри конечной точки с балансировкой нагрузки. После того как проба поступит на узел вычислений, где находится работоспособная виртуальная машина в серверном пуле, узел вычислений генерирует ответ для службы проверки работоспособности. Ваша виртуальная машина не видит этот трафик.

Сбой доступности виртуального IP-адреса возникает по следующим причинам:
- в серверном пуле вашего развертывания не осталось исправных виртуальных машин; 
- произошел сбой инфраструктуры.

Для диагностических целей можно использовать [метрику доступности пути данных вместе со состоянием зонда работоспособности.](#vipavailabilityandhealthprobes)

Для большинства сценариев используйте тип статистического вычисления **Среднее**.

#### <a name="are-the-back-end-instances-for-my-vip-responding-to-probes"></a>Отвечают ли на пробы серверные экземпляры для виртуального IP-адреса?

Метрика состояния для пробы работоспособности предоставляет сведения о работоспособности развертывания приложения. Параметры задаются при настройке проверки работоспособности для подсистемы балансировки нагрузки. Подсистема балансировки нагрузки использует состояние пробы работоспособности, чтобы определить, куда отправлять новые потоки. Пробы работоспособности исходят из адреса инфраструктуры Azure и видны в гостевой ОС виртуальной машины.

Чтобы получить статус зонда работоспособности для ресурсов standard Load Balancer:
1. Выберите метрику **состояния зонда работы** с типом агрегации **Avg.** 
2. Примените фильтр на требуемый IP-адрес Frontend или порт (или оба).

Пробы работоспособности завершаются ошибками по следующим причинам:
- Вы настроили проверку работоспособности для порта, который не ожидает передачи данных, не отвечает или же использует неправильный протокол. Если ваша служба использует правила прямого ответа от сервера (DSR или плавающий IP-адрес), убедитесь в том, что она ожидает передачи данных по IP-адресу IP-конфигурации сети сетевого интерфейса, а не только через интерфейс замыкания на себя, который настроен с внешним IP-адресом.
- Ваша проверка не разрешена группой безопасности сети, брандмауэром гостевой ОС виртуальной машины или фильтрами прикладного уровня.

Для большинства сценариев используйте тип статистического вычисления **Среднее**.

#### <a name="how-do-i-check-my-outbound-connection-statistics"></a>Как проверить статистику исходящего подключения? 

Метрика подключений SNAT предоставляет сведения о числе успешных и неудачных подключений для [исходящих потоков](https://aka.ms/lboutbound).

Число подключений со сбоями, превышающее нуль, указывает на нехватку портов SNAT. Нужно продолжить исследование, чтобы определить, что может вызвать эти сбои. При нехватке портов SNAT нельзя установить [исходящие потоки](https://aka.ms/lboutbound). Просмотрите статью об исходящих подключениях, чтобы составить представление о сценариях и механизмах работы, а также узнать, как уменьшить риск и избежать нехватки портов SNAT. 

Чтобы получить статистику по подключениям SNAT, сделайте следующее:
1. Выберите тип метрики **SNAT Connections** (Подключения SNAT) и тип агрегирования **Сумма**. 
2. Сгруппируйте подключения SNAT по **состоянию** (успешные и неудачные). Подключения в каждом состоянии будут представлены разными линиями. 

![Подключение SNAT](./media/load-balancer-standard-diagnostics/LBMetrics-SNATConnection.png)

*Рисунок. Количество подключений SNAT для Load Balancer*


#### <a name="how-do-i-check-my-snat-port-usage-and-allocation"></a>Как проверить использование и распределение порта SNAT?

Метрика SNAT Usage показывает, сколько уникальных потоков устанавливается между интернет-источником и бэкэндом VM или виртуальным набором масштабов машин, который находится за балансером нагрузки и не имеет общедоступного IP-адреса. Сравнивая это с метрикой распределения SNAT, можно определить, испытывает ли ваша служба или рискует стьювсего в истощении SNAT и в результате сбоя исходящего потока. 

Если показатели указывают на риск сбоя [исходящего потока,](https://aka.ms/lboutbound) обратитесь в статью и предпримите меры по смягчению этой проблемы для обеспечения работоспособности службы.

Для просмотра использования и распределения портов SNAT:
1. Установите агрегацию времени графика до 1 минуты, чтобы обеспечить отображение желаемых данных.
1. Выберите **sNAT Использование** и/или **распределение SNAT** как тип метрики и **средний** как агрегация
    * По умолчанию это среднее количество портов SNAT, выделенных или используемых каждым бэкэндом VMs или VMSS, соответствующим всем публичным множеству фронтов, отображено к балансу нагрузки, агрегированным по TCP и UDP.
    * Для просмотра общего числа портов SNAT, используемых или выделенных для балансоровыки нагрузки, использовать метрическую агрегацию **Sum**
1. Фильтр для определенного **типа протокола,** набор **ит-провайдеров Backend**и/или **ИП Frontend.**
1. Для мониторинга работоспособности на бэкэнд или переднюю инстанцию, примените расщепление. 
    * Разделение заметок позволяет отображать только одну метрику одновременно. 
1. Например, для мониторинга использования SNAT для потоков TCP на одну машину, агрегирования по **средним,** разделенных **на ипы пк бэкэнда** и фильтра по **типу протокола.** 

![Распределение и использование SNAT](./media/load-balancer-standard-diagnostics/snat-usage-and-allocation.png)

*Рисунок: Среднее распределение порта TCP SNAT и использование для набора бэкэнд-вм:*

![Использование SNAT по бэкэнд-экземпляру](./media/load-balancer-standard-diagnostics/snat-usage-split.png)

*Рисунок: использование порта TCP SNAT на экземпляр бэкэнда*

#### <a name="how-do-i-check-inboundoutbound-connection-attempts-for-my-service"></a>Как проверить попытки входящих и исходящих подключений для службы?

Метрика пакетов SYN предоставляет сведения о числе принятых или отправленных пакетов TCP SYN (для [исходящих потоков](https://aka.ms/lboutbound)), связанных с определенным внешним интерфейсом. Эта метрика позволяет проанализировать попытки подключения TCP к вашей службе.

Для большинства сценариев используйте тип статистической обработки **Всего**.

![Подключение SYN](./media/load-balancer-standard-diagnostics/LBMetrics-SYNCount.png)

*Рисунок. Количество подключений SYN для Load Balancer*


#### <a name="how-do-i-check-my-network-bandwidth-consumption"></a>Как проверить потребление пропускной способности сети? 

Метрика счетчиков байтов и пакетов предоставляет сведения о числе байтов и пакетов, отправленных или полученных вашей службой для каждого внешнего интерфейса.

Для большинства сценариев используйте тип статистической обработки **Всего**.

Чтобы получить статистику количества байтов или пакетов, сделайте следующее:
1. Выберите тип метрики **Bytes Count** (Количество байтов) и (или) **Packet Count** (Количество пакетов), а также тип агрегирования **Среднее**. 
2. Выполните одно из приведенных ниже действий.
   * Примените фильтр к определенному интерфейсному IP-адресу, интерфейсному порту, IP-адресу серверной части или порту серверной части.
   * Получите общую статистику для ресурсов подсистемы балансировки нагрузки без какой-либо фильтрации.

![Количество байтов](./media/load-balancer-standard-diagnostics/LBMetrics-ByteCount.png)

*Рисунок. Количество байтов Load Balancer*

#### <a name="how-do-i-diagnose-my-load-balancer-deployment"></a><a name = "vipavailabilityandhealthprobes"></a>Как выполнить диагностику развертывания подсистемы балансировки нагрузки?

Сочетание метрик доступности виртуального IP-адреса и пробы работоспособности на одной диаграмме позволяет определить причину и решение проблемы. Благодаря этой информации вы можете удостовериться в том, что Azure работает правильно. Кроме того, с помощью этих сведений можно достоверно определить, что является первопричиной проблемы: конфигурация или приложение.

Вы можете использовать метрики пробы работоспособности, чтобы понять, как Azure рассматривает работоспособность вашего развертывания в соответствии с предоставленной вами конфигурацией. Просмотр проб работоспособности — отличный первый шаг при мониторинге или определении причины.

Вы можете перейти к следующему этапу и использовать метрики доступности виртуального IP-адреса, чтобы получить представление о том, как в Azure исследуется работоспособность базовой плоскости данных, отвечающей за конкретное развертывание. Если вы объедините обе метрики, можно будет определить, где возникла ошибка, как показано в этом примере:

![Объединение показателей доступности пути данных и состояния зонда работы](./media/load-balancer-standard-diagnostics/lbmetrics-dipnvipavailability-2bnew.png)

*Рисунок: Объединение показателей доступности пути данных и состояния зонда здоровья*

На диаграмме представлена следующая информация:
- Инфраструктура, в которой размещалось ваши ВМ, была недоступна и составляла 0 процентов в начале графика. Позже инфраструктура была здоровой, и ВМ были доступны, и более одного VM был помещен в задней части. На эту информацию указывает синий след доступности пути данных (доступность VIP), который позже был на 100 процентов. 
- Состояние зонда работоспособности (доступность DIP), указанное фиолетовым следом, находится на уровне 0 процентов в начале графика. Обведенный области в зеленых подчеркивается, где состояние зонда здоровья (доступность DIP) стало здоровым, и в этот момент развертывание клиента было в состоянии принять новые потоки.

Благодаря диаграмме клиенты могут самостоятельно устранять проблемы с развертыванием без необходимости обращаться в службу поддержки или угадывать, были ли другие проблемы. При проверках работоспособности служба была недоступна по причине сбоев из-за неправильной конфигурации или неисправности приложения.

## <a name="resource-health-status"></a><a name = "ResourceHealth"></a>Состояние работоспособности ресурсов

Состояние работоспособности ресурсов Load Balancer уровня "Стандартный" можно узнать на странице **Работоспособность ресурсов** в разделе **Мониторинг > Работоспособность служб**.

Чтобы просмотреть работоспособность ресурсов общедоступной службы Load Balancer уровня "Стандартный", сделайте следующее:
1. Выберите**здоровье службы** **мониторинга** > .

   ![Страница мониторинга](./media/load-balancer-standard-diagnostics/LBHealth1.png)

   *Рисунок. Ссылка "Работоспособность службы" в Azure Monitor*

2. Выберите **Работоспособность ресурсов** и убедитесь, что выбран **идентификатор подписки**, а **для типа ресурса установлено значение Load Balancer**.

   ![Состояние работоспособности ресурсов](./media/load-balancer-standard-diagnostics/LBHealth3.png)

   *Рисунок. Выбор ресурса для представления работоспособности*

3. В списке щелкните ресурс Load Balancer, чтобы просмотреть историю его состояния работоспособности.

    ![Состояние работоспособности Load Balancer](./media/load-balancer-standard-diagnostics/LBHealth4.png)

   *Рисунок. Представление работоспособности ресурса Load Balancer*
 
В следующей таблице перечислены различные состояния работоспособности ресурсов и их описания: 

| Состояние работоспособности ресурсов | Описание |
| --- | --- |
| Доступно | Стандартный ресурс балансировоза нагрузки работоспособный и доступен. |
| Рекомендации недоступны | Стандартный ресурс балансировоза нагрузки не является работоспособным. Диагностировать работоспособность, выбрав**метеометры** **Azure Monitor.** > <br>*(Недоступный* статус может также означать, что ресурс не связан со стандартным балансером нагрузки.) |
| Неизвестно | Состояние работоспособности ресурсов для стандартного ресурса балансироворовывая нагрузки еще не обновлено.<br>*(Неизвестный* статус может также означать, что ресурс не связан со стандартным балансером нагрузки.)  |

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте больше об [Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).
- Узнайте больше об [исходящих подключениях подсистемы балансировки нагрузки](https://aka.ms/lboutbound).
- Дополнительные сведения об [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview).
- Дополнительные сведения об [Azure Monitor REST API](https://docs.microsoft.com/rest/api/monitor/) и о [способе получения метрик через REST API](/rest/api/monitor/metrics/list).
