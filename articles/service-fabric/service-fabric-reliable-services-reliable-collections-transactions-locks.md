---
title: Транзакции и режимы блокировки в надежных коллекциях
description: Транзакции и блокировка диспетчера надежных состояний и надежных коллекций Azure Service Fabric.
ms.topic: conceptual
ms.date: 5/1/2017
ms.custom: sfrev
ms.openlocfilehash: 5f7b3a4d43d35f0d2965dd33c8f69143f4b3a8f7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76938913"
---
# <a name="transactions-and-lock-modes-in-azure-service-fabric-reliable-collections"></a>Транзакции и режимы блокировки в надежных коллекциях Azure Service Fabric

## <a name="transaction"></a>Транзакция

Транзакция является последовательностью операций, выполненных как одна логическая единица работы. Он демонстрирует общие [ACID](https://en.wikipedia.org/wiki/ACID) *(атомарность,* *последовательность,* *изоляция,* *долговечность)* свойства транзакций баз данных:

* **Атомарность**. Транзакция должна быть атомарной единицей работы. Другими словами, должны выполняться либо все ее изменения данных, либо ни одно из них.
* **Согласованность**. По завершении транзакция должна оставить все данные в согласованном состоянии. Все внутренние структуры данных должны быть правильными на момент завершения транзакции.
* **Изоляция**. Изменения, выполняемые одной параллельной транзакцией, должны быть изолированы от изменений, выполняемых прочими параллельными транзакциями. Уровень изоляции, используемый для операции в [ITransaction,](https://docs.microsoft.com/dotnet/api/microsoft.servicefabric.data.itransaction?view=azure-dotnet) определяется [IReliableState,](https://docs.microsoft.com/dotnet/api/microsoft.servicefabric.data.ireliablestate?view=azure-dotnet) выполняющим операцию.
* **Устойчивость**. После завершения транзакции ее результаты постоянно сохраняются в системе. Изменения сохраняются даже в случае системного сбоя.

### <a name="isolation-levels"></a>Уровни изоляции

Уровень изоляции определяет степень, до которой транзакция должна быть изолирована от изменений, вносимых другими транзакциями.
Надежные коллекции поддерживают два уровня изоляции:

* **Повторяющееся чтение**. Указывает, какие операторы не могут считывать данные, которые были изменены, но еще не зафиксированы другими транзакциями, и что другие транзакции не могут изменять данные, считанные текущей транзакцией, до ее завершения.
* **Моментальный снимок**. Указывает, что данные, считанные любым оператором в транзакции, согласованы с версией данных, которые существовали в начале транзакции.
  Транзакция может распознать только те изменения данных, которые были зафиксированы до ее начала.
  Инструкции, выполняемые текущей транзакцией, не видят изменений данных, произведенных другими транзакциями после запуска текущей транзакции.
  Это похоже на то, как если бы инструкции в транзакции получили снимок данных, зафиксированных на момент начала транзакции.
  Моментальные снимки согласованы между надежными коллекциями.

Для операций чтения надежные коллекции автоматически выбирают уровень изоляции в зависимости от самой операции и роли реплики в момент создания транзакции.
Ниже приведена таблица уровней изоляции по умолчанию для операций надежного словаря и очереди.

| Операция \ Роль | Первичный | Вторичная |
| --- |:--- |:--- |
| Операция чтения одной сущности |Повторяющаяся операция чтения |Моментальный снимок |
| Перечисление, подсчет |Моментальный снимок |Моментальный снимок |

> [!NOTE]
> Распространенные примеры операций с одной сущностью: `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.
> 

Как надежный словарь, так и поддержка надежной очереди *Читайте ваши записи*.
Другими словами, каждая операция записи в рамках одной транзакции будет видна для последующей операции чтения, которая выполняется в рамках той же транзакции.

## <a name="locks"></a>Блокировки

В надежных коллекциях все транзакции реализуют строгую двухэтапную блокировку: транзакция не снимает свои установленные блокировки, пока она не завершится прерыванием или фиксацией.

Надежный словарь использует блокировку уровня строки для всех операций одного объекта.
Надежная очередь поступается параллелизмом ради строгого соблюдения транзакционного свойства FIFO.
Надежная очередь использует замки уровня `TryPeekAsync` операции, `TryDequeueAsync` позволяющие одну `EnqueueAsync` транзакцию с и/или одной транзакцией одновременно.
Обратите внимание, что если `TryPeekAsync` или `TryDequeueAsync` когда-либо обнаружит, что надежная очередь пуста, то для сохранения логики FIFO также заблокирует `EnqueueAsync`.

Операции записи всегда используют монопольные блокировки.
Для прочитанные операции блокировка зависит от нескольких факторов:

- Любая операция чтения, выполненная с помощью изоляции Snapshot, не блокируется.
- В повторяющихся операциях чтения используются совмещаемые блокировки (по умолчанию).
- Тем не менее, для любой операции чтения, поддерживающей повторяющееся чтение, вместо совмещаемой блокировки пользователь может запросить блокировку изменений.
Блокировка изменений является асимметричной блокировкой, которая используется для предотвращения распространенной формы взаимоблокировки. Взаимоблокировка возникает, когда несколько транзакций блокируют ресурсы для возможного обновления в будущем.

Ниже приведена таблица совместимости блокировок.

| Запрос \ Предоставлено | None | Shared | Update | Монопольная блокировка |
| --- |:--- |:--- |:--- |:--- |
| Shared |Нет конфликтов |Нет конфликтов |Конфликт |Конфликт |
| Update |Нет конфликтов |Нет конфликтов |Конфликт |Конфликт |
| Монопольная блокировка |Нет конфликтов |Конфликт |Конфликт |Конфликт |

Аргумент тайм-аута в AIS надежных коллекций используется для обнаружения тупика.
Например, две транзакции (Т1 и Т2) пытаются считать и изменить К1.
Существует вероятность возникновения взаимоблокировки, поскольку в обеих транзакциях используется совмещаемая блокировка.
В этом случае одна или обе операции будут тайм-аут. Я в этом сценарии, блокировка обновления может предотвратить такой тупик.

## <a name="next-steps"></a>Дальнейшие действия

* [Работа с надежными коллекциями](service-fabric-work-with-reliable-collections.md)
* [Уведомления Reliable Services](service-fabric-reliable-services-notifications.md)
* [Архивация и восстановление (аварийное восстановление) надежных служб](service-fabric-reliable-services-backup-restore.md)
* [Конфигурация диспетчера надежных состояний](service-fabric-reliable-services-configuration.md)
* [Справочник разработчика по надежным коллекциям](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)
