---
title: Балансировка подкластерных метрик
description: Влияние ограничений размещения на балансировку и способы его работы
author: nipavlo
ms.topic: conceptual
ms.date: 03/15/2020
ms.author: nipavlo
ms.openlocfilehash: 23782a86d31251cb1a3474e0395df716a2e832df
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81430647"
---
# <a name="balancing-of-subclustered-metrics"></a>Балансировка подкластерных метрик

## <a name="what-is-subclustering"></a>Что такое подкластеризация

Подкластерирование происходит, когда службы с различными ограничениями размещения имеют общую метрику, и они оба сообщают о нагрузке для него. Если нагрузка, о которых сообщают службы, значительно отличается, общая нагрузка на узлы будет иметь большое стандартное отклонение, и это будет выглядеть как кластер несбалансированный, даже если он имеет наилучший возможный баланс.

## <a name="how-subclustering-affects-load-balancing"></a>Как подкластеры влияют на балансировку нагрузки

Если нагрузка, о которой сообщают службы на разных узлах, значительно отличается, может показаться, что существует большой дисбаланс там, где его нет. Кроме того, если ложный дисбаланс, вызванный подкластеризированием, больше фактического дисбаланса, он может запутать алгоритм балансировки менеджера ресурсов и произвести неоптимальный баланс в кластере.

Например, предположим, что у нас есть четыре службы, и все они сообщают о нагрузке на метрику Metric1:

* Служба A - имеет ограничение размещения "NodeType"Type1, сообщает о нагрузке 10
* Служба B - имеет ограничение размещения "NodeType"Type1," сообщает о нагрузке 10
* Служба C - имеет ограничение размещения "NodeType"Type2, сообщает о нагрузке 100
* Служба D - имеет ограничение размещения "NodeType"Type2, сообщает о нагрузке 100
* И у нас есть четыре узла. Два из них имеют Набор NodeType как "Type1", а два других - "Type2"

И у нас есть следующее размещение:

<center>

![Пример размещения подкластеров][Image1]
</center>

Кластер может выглядеть несбалансированным, у нас большая нагрузка на узлы 3 и 4, но это размещение создает наилучший баланс в этой ситуации.

Менеджер ресурсов может распознавать ситуации подкластеризации и почти во всех случаях он может создать оптимальный баланс для данной ситуации.

В некоторых исключительных ситуациях, когда менеджер ресурсов не в состоянии оптимально сбалансировать подкластерную метрику, он по-прежнему обнаруживает подкластеры и генерирует отчет о работоспособности, чтобы посоветовать вам устранить проблему.

## <a name="types-of-subclustering-and-how-they-are-handled"></a>Типы подкластеров и способы их обработки

Ситуации подкластеризации можно разделить на три категории. Категория конкретной ситуации подкластеризации определяет, как она будет обрабатываться менеджером ресурсов.

### <a name="first-category--flat-subclustering-with-disjoint-node-groups"></a>Первая категория – плоский подкластер с разрозненными группами узлов

Эта категория имеет простейшие формы подкластеризации, где узлы могут быть разделены на различные группы, и каждая служба может быть помещена только на узлы в одной из этих групп. Каждый уденный узла принадлежит одной группе и только одной группе. Ситуация, описанная выше, относится к этой категории, как и большинство ситуаций подкластеризации. 

Для ситуаций в этой категории, менеджер ресурсов может произвести оптимальный баланс и никакого дальнейшего вмешательства не требуется.

### <a name="second-category--subclustering-with-hierarchical-node-groups"></a>Вторая категория – подкластерсирование с иерархическими группами узлов

Эта ситуация возникает, когда группа узлов, разрешенных для одной службы, представляет собой подмножество группы узлов, разрешенных для другой службы. Наиболее распространенным примером этой ситуации является, когда определено ограничение размещения, а другая служба не имеет ограничений на размещение и может быть помещена на любой узла.

Пример

* Служба A: отсутствие ограничений на размещение
* Служба B: ограничение размещения "NodeType" Type1
* Служба C: ограничение размещения "NodeType" Type2

Эта конфигурация создает отношение подмноженого супернабора между группами узлов для различных служб.

<center>

![Подкластеры подмножество суперсетей][Image2]
</center>

В этой ситуации есть шанс, что будет достигнут неоптимальный баланс.

Менеджер ресурсов распознает эту ситуацию и подготовит отчет о работоспособности, в котором рекомендуется разделить службу А на две службы — службу A1, которая может быть размещена на узлах Type1 и службе A2, которые могут быть размещены на узлах Type2. Это вернет нас к ситуации первой категории, которая может быть сбалансирована оптимально.

### <a name="third-category--subclustering-with-partial-overlap-between-node-sets"></a>Третья категория - подкластерсирование с частичным перекрытием между наборами узлов

Эта ситуация возникает, когда происходит частичное перекрытие между наборами узлов, на которые могут быть размещены некоторые службы.

Например, если у нас есть свойство узла под названием NodeColor и у нас есть три узла:

* Узла 1: NodeColor-Красный
* Узла 2: NodeColor-Синий
* Узел 2: УзелЦвет-Зеленый

И у нас есть две услуги:

* Служба A: с ограничением размещения "Цвет" Цветной »Синий»
* Служба B: с ограничением размещения "Цвет" Цвет "Зеленый"

Из-за этого Служба А может быть размещена на узлах 1 и 2, а служба B — на узлах 2 и 3.

В этой ситуации есть шанс, что будет достигнут неоптимальный баланс.

Менеджер ресурсов распознает эту ситуацию и подготовит отчет о состоянии здоровья, в котором рекомендуется разделить некоторые услуги.

В этой ситуации менеджер ресурсов не может дать предложение о разделении служб, так как можно сделать несколько сплитов, и нет никакого способа оценить, каким способом будет оптимальный для разделения служб.

## <a name="configuring-subclustering"></a>Настройка подкластеризации

Поведение менеджера ресурсов в отношении подкластеризации может быть изменено путем изменения следующих параметров конфигурации:
* SubclusteringEnabled - параметр определяет, будет ли диспетчер ресурсов учитывать подкластерирование при балансировке нагрузки. Если этот параметр будет выключен, менеджер ресурсов проигнорирует подкластерирование и попытается достичь оптимального баланса на глобальном уровне. Значение этого параметра по умолчанию является ложным.
* SubclusteringReportingPolicy - определяет, как менеджер ресурсов будет излучать отчеты о работоспособности для иерархического и частичного перекрытия подкластеров. Значение нуля означает отключение отчетов о состоянии о подкластеризации, "1" означает, что для неоптимальных ситуаций субкластеризации будут подготовлены предупреждающие отчеты о работоспособности, а значение "2" будет производить "OK" отчеты о состоянии здоровья. Значение по умолчанию для этого параметра составляет "1".

ClusterManifest.xml:

``` xml
        <Section Name="PlacementAndLoadBalancing">
            <Parameter Name="SubclusteringEnabled" Value="true" />
            <Parameter Name="SubclusteringReportingPolicy" Value="1" />
        </Section>
```

Для автономных развертываний используется ClusterConfig.json, а для размещенных в Azure кластеров — Template.json.

```json
"fabricSettings": [
  {
    "name": "PlacementAndLoadBalancing",
    "parameters": [
      {
          "name": "SubclusteringEnabled",
          "value": "true"
      },
      {
          "name": "SubclusteringReportingPolicy",
          "value": "1"
      },
    ]
  }
]
```

## <a name="next-steps"></a>Дальнейшие действия
* Чтобы узнать, как диспетчер кластерных ресурсов управляет нагрузкой кластера и балансирует ее, ознакомьтесь со статьей о [балансировке нагрузки](service-fabric-cluster-resource-manager-balancing.md)
* Чтобы узнать о том, как ваши службы могут быть ограничены, чтобы быть размещены только на определенных узлах видеть [свойства узлов и ограничения размещения](service-fabric-cluster-resource-manager-cluster-description.md#node-properties-and-placement-constraints)

[Image1]:./media/cluster-resource-manager-subclustering/subclustered-placement.png
[Image2]:./media/cluster-resource-manager-subclustering/subset-superset-nodes.png
