---
title: Установка исправлений операционной системы Windows в кластере Service Fabric
description: В этой статье обсуждается, как автоматизировать исправление операционной системы в кластере Service Fabric с помощью приложения Patch Orchestration.
services: service-fabric
documentationcenter: .net
author: athinanthny
manager: chackdan
editor: ''
ms.assetid: de7dacf5-4038-434a-a265-5d0de80a9b1d
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 2/01/2019
ms.author: atsenthi
ms.openlocfilehash: 857a4da0b24d600ecc572933af578e2e8faf501a
ms.sourcegitcommit: 07d62796de0d1f9c0fa14bfcc425f852fdb08fb1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "80366313"
---
# <a name="patch-the-windows-operating-system-in-your-service-fabric-cluster"></a>Установка исправлений операционной системы Windows в кластере Service Fabric

> 
> [!IMPORTANT]
> По состоянию на 30 апреля 2019 года версия приложения Patch Orchestration Application 1.2. Не забудьте обновить до последней версии.

> [!NOTE]
> Автоматическое [обновление изображений ОС в наборе виртуальной шкалы машин](https://docs.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade) является наилучшей практикой для сохранения вашей операционной системы в Azure. Виртуальная шкала машины Набор на основе автоматического обновления изображения ОС потребует серебра или большей долговечности на шкале набора.
>

 Patch Orchestration Application (POA) — это обертка вокруг службы управления ремонтом тканей службы Azure Service, которая позволяет планировать настройки на основе оС для размещенных кластеров, не связанных с Azure. POA не требуется для размещенных кластеров, не связанных с Azure, но для исправления узлов кластера Service Fabric требуется планирование установки патча с помощью домена обновления без простоя.

POA — это приложение Service Fabric, которое автоматизирует исправление операционной системы в кластере Service Fabric без простоя.

POA предоставляет следующие функции:

- **Автоматическая установка обновлений операционной системы**. Обновления операционной системы автоматически загружаются и устанавливаются. Кластерные узлы перезагружаются по мере необходимости без простоя кластера.

- **Исправление с учетом состояния кластера и интеграция функций работоспособности**. В то время как POA применяет обновления, он отслеживает работоспособность кластерных узлов. Кластерные узлы обновляются по одному узлам за раз или одному домену обновления за раз. Если работоспособность кластера снижается из-за процесса исправления, исправление прекращается, чтобы предотвратить обострение проблемы.

## <a name="internal-details-of-poa"></a>Внутренние детали POA

POA состоит из следующих подкомпонентов:

- **Служба координатора** — эта служба с отслеживанием состояния отвечает за следующие задачи:
    - координация задания обновления Windows во всем кластере;
    - хранение результатов завершенных операций обновления Windows.

- **Служба агента узла** — это служба без отслеживания состояния, которая выполняется на всех узлах кластера Service Fabric. Она отвечает за следующие задачи:
    - начальная загрузка NTService агента узла;
    - мониторинг службы NTService агента узла.

- **Служба NTService агента узла** — служба Windows NT, которая выполняется с разрешением высокого уровня (СИСТЕМА). Для сравнения служба агента узла и служба координатора выполняются с разрешением более низкого уровня (СЕТЕВАЯ СЛУЖБА). Служба отвечает за выполнение следующих заданий обновления Windows на всех узлах кластера:
    - Отключение автоматических обновлений Windows на уде.
    - Загрузка и установка обновлений Windows в соответствии с политикой, предоставляемой пользователем.
    - Перезапуск установки обновлений машины после Windows.
    - передача результатов обновления Windows в службу координатора;
    - Отчетность о состоянии здоровья, если операция не удалась после того, как она исчерпает все повторы.

> [!NOTE]
> POA использует службу Service Fabric Repair Manager для отключания или включения узла и выполнения проверки работоспособности. Задача ремонта, созданная POA, отслеживает ход обновления Windows для каждого узла.

## <a name="prerequisites"></a>Предварительные требования

> [!NOTE]
> Требуемая минимальная версия .NET Framework составляет 4,6.

### <a name="enable-the-repair-manager-service-if-its-not-running-already"></a>Включить службу менеджера по ремонту (если она уже не запущена)

POA требует включения службы менеджера по ремонту в кластере.

#### <a name="azure-clusters"></a>Кластеры Azure

Кластеры Azure в серебряном уровне прочности имеют службу Repair Manager, включенную по умолчанию. Кластеры Azure в ярусе прочности золота могут или не могут быть включены службы менеджера ремонта, в зависимости от того, когда эти кластеры были созданы. Кластеры Azure в бронзовом уровне прочности по умолчанию не имеют включена служба менеджера ремонта. Если служба уже включена, можно увидеть, как она работает в разделе системных служб в Service Fabric Explorer.

##### <a name="the-azure-portal"></a>Портал Azure
При настройке кластера можно включить диспетчера ремонта с портала Azure. При настройке кластера выберите опцию **«Функции менеджера по ремонту»** под **функции «Дополнительные функции».**

![Изображение управляющего ремонтом с портала Azure](media/service-fabric-patch-orchestration-application/EnableRepairManager.png)

##### <a name="the-azure-resource-manager-deployment-model"></a>Модель развертывания ресурсов Azure
Кроме того, можно использовать [модель развертывания диспетчеров ресурсов Azure](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm) для включения службы управления ремонтом в новые и существующие кластеры service Fabric. Получите шаблон для кластера, который требуется развернуть. Можно использовать примеры шаблонов или создать пользовательский шаблон модели развертывания Azure Resource Manager. 

Для включения службы управления ремонтом с помощью [шаблона развертывания шаблона развертывания ресурсов Azure Manager](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm)сделайте следующее:

1. Проверьте, `apiVersion` что установлен на *2017-07-01-предварительный просмотр* для *ресурса Microsoft.ServiceFabric/кластеров.* Если все по-другому, `apiVersion` необходимо обновить его до *2017-07-01-предварительный просмотр* или позже:

    ```json
    {
        "apiVersion": "2017-07-01-preview",
        "type": "Microsoft.ServiceFabric/clusters",
        "name": "[parameters('clusterName')]",
        "location": "[parameters('clusterLocation')]",
        ...
    }
    ```

1. Включите службу менеджера `addonFeatures` по ремонту, добавив следующий раздел после раздела: `fabricSettings`

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

3. После обновления шаблона кластера с этими изменениями, примените их и позвольте обновлению закончить. Теперь вы можете видеть службу управления ремонтом, работая в кластере. Это называется *ткань: /Система/ RepairManagerService* в разделе системных услуг в Service Fabric Explorer. 

### <a name="standalone-on-premises-clusters"></a>Автономные локальные кластеры

Для включения службы управления ремонтом в новый или существующий кластер Service Fabric можно использовать [настройки конфигурации для автономного кластера Windows.](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-manifest)

Для обеспечения обслуживания диспетчера по ремонту:

1. Убедитесь, `apiVersion` что в [общих конфигурациях кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-manifest#general-cluster-configurations) установлен на *04-2017* или позже, как показано здесь:

    ```json
    {
        "name": "SampleCluster",
        "clusterConfigurationVersion": "1.0.0",
        "apiVersion": "04-2017",
        ...
    }
    ```

1. Включите службу менеджера `addonFeatures` по ремонту, добавив следующий раздел после раздела, `fabricSettings` как показано здесь:

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

1. Обновление кластерного манифеста с помощью обновленного кластерного манифеста [создайте новый кластер](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-for-windows-server) или [обновите конфигурацию кластера.](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-upgrade-windows-server) 

   После запуска кластера с обновленным кластерным манифестом можно увидеть службу управления ремонтом, работающая в кластере. Это называется *ткань: / Система / RepairManagerService*, и это в разделе системных услуг в Service Fabric Explorer.

### <a name="configure-windows-updates-for-all-nodes"></a>Настройка обновлений Windows для всех узлов

Автоматическое обновление Windows может привести к потере доступности, так как несколько кластерных узлов могут перезапуститься одновременно. POA, по умолчанию, пытается отключить автоматические обновления Windows на каждом кластерном узла. Однако, если настройки управляются администратором или групповой политикой, мы рекомендуем установить политику обновления Windows для явного уведомления перед загрузкой.

## <a name="download-the-application-package"></a>Скачать пакет приложений

Чтобы загрузить пакет приложений, перейдите на [страницу выпуска приложения Patch Orchestration](https://github.com/microsoft/Service-Fabric-POA/releases/latest/) на GitHub.

## <a name="configure-poa-behavior"></a>Настройка поведения POA

Вы можете настроить поведение POA для удовлетворения ваших потребностей. Переопределить значения по умолчанию, передавая параметр приложения при создании или обновлении приложения. Параметры приложения можно предоставить, `ApplicationParameter` `Start-ServiceFabricApplicationUpgrade` указав `New-ServiceFabricApplication` или cmdlets.

| Параметр        | Тип                          | Сведения |
|:-|-|-|
|MaxResultsToCache    |Long                              | Максимальное количество результатов обновления Windows, которые должны быть кэшированы. <br><br>Значение по умолчанию составляет 3000, если предположить, что: <br> &nbsp;&nbsp;- Количество узлов 20. <br> &nbsp;&nbsp;- Количество обновлений в узла в месяц составляет 5. <br> &nbsp;&nbsp;- Количество результатов за операцию может быть 10. <br> &nbsp;&nbsp;- Результаты за последние три месяца должны быть сохранены. |
|TaskApprovalPolicy   |Перечисление. <br> { NodeWise, UpgradeDomainWise }                          |TaskApprovalPolicy указывает политику, которая будет использоваться службой координатора для установки обновлений Windows на узлы кластера Service Fabric.<br><br>Допустимые значения: <br>*nodeWise*: Обновления Windows устанавливаются по одному узлам за раз. <br> *UpgradeDomainWise*: Обновления Windows устанавливаются по одному домену обновления за раз. (В лучшем случае все узлы, принадлежащие к домену обновления, могут быть обновлены Windows.)<br><br> Чтобы помочь решить, какая политика лучше всего подходит для кластера, смотрите раздел [часто задаваемых вопросов.](#frequently-asked-questions)
|LogsDiskQuotaInMB   |Long  <br> (По умолчанию: *1024*)               | Максимальный размер журналов приложения для оркестровки патчей в Mb, который может сохраняться локально на узлах.
| WUQuery               | строка<br>(По умолчанию: *Устанавливается No0*)                | Запрос на получение обновлений Windows. Дополнительные сведения см. в разделе [WuQuery](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx).
| InstallWindowsOSOnlyUpdates | *Логических* <br> (значение по умолчанию — false)                 | Используйте этот флаг, чтобы контролировать, какие обновления следует скачать и установить. Допустимы следующие значения: <br>true — устанавливает только обновления операционной системы Windows;<br>false — устанавливает все доступные обновления на компьютере.          |
| WUOperationTimeOutInMinutes | Int <br>(По умолчанию: *90*)                   | Указывает время ожидания для любой операции обновления Windows (поиск, скачивание или установка). Если операция не завершена по истечении заданного времени ожидания, она будет прервана.       |
| WURescheduleCount     | Int <br> (По умолчанию: *5*)                  | Максимальное количество раз, когда служба переносит обновление Windows, если операция завершается настойчиво.          |
| WURescheduleTimeInMinutes | Int <br>(По умолчанию: *30*) | Интервал, с которым служба переносит обновления Windows при сбое сохраняется. |
| WUFrequency           | Запятая-отделенная строка (По умолчанию: *Еженедельно, Среда, 7:00:00*)     | Частота для установки обновлений Windows. Формат и возможные значения: <br>&nbsp;&nbsp;- Ежемесячно: DD, HH:MM:SS (например, *ежемесячно, 5,12:22:32*)<br>Разрешенные значения для поля DD (день) являются числами от 1 до 28 и "последними". <br> &nbsp;&nbsp;- Еженедельно, день, HH:MM:SS (например, *еженедельно, вторник, 12:22:32*)  <br> &nbsp;&nbsp;- Ежедневно, HH:MM:SS (например, *ежедневно, 12:22:32*)  <br> &nbsp;&nbsp;-  *Нет* указывает на то, что обновления Windows не должны быть сделаны.  <br><br> Времена в UTC.|
| AcceptWindowsUpdateEula | Логическое <br>(По умолчанию: *правда)* | Если этот флажок установлен, приложение принимает условия лицензионного соглашения Центра обновления Windows от имени владельца компьютера.              |

> [!TIP]
> Если вы хотите, чтобы обновления `WUFrequency` Windows происходили немедленно, установите относительно времени развертывания приложения. Например, у вас тестовый кластер с пятью узлами и вы планируете развернуть приложение около 17:00 UTC. Если вы предполагаете, что обновление или развертывание приложения занимает не более 30 минут, установите WUFrequency как *Daily, 17:30:00*.

## <a name="deploy-poa"></a>Развертывание POA

1. Завершите все предварительные шаги, чтобы подготовить кластер.
1. Развертывание POA, как и любое другое приложение Service Fabric. Чтобы развернуть его с помощью PowerShell, см [Развертывание и удалить приложения с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).
1. Чтобы настроить приложение во время развертывания, передайте `ApplicationParameter` для командлета `New-ServiceFabricApplication`. Для вашего удобства мы сопроводили приложение сценарием Deploy.ps1. Использование сценария

    - Подключитесь к кластеру Service Fabric при помощи `Connect-ServiceFabricCluster`.
    - Выполните сценарий PowerShell Deploy.ps1 с соответствующим значением `ApplicationParameter`.

> [!NOTE]
> Храните скрипт и папку приложения *PatchOrchestrationApplication* в том же каталоге.

## <a name="upgrade-poa"></a>Обновление POA

Чтобы обновить версию POA с помощью PowerShell, следуйте инструкциям в [обновлении приложения Service Fabric с помощью PowerShell.](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-upgrade-tutorial-powershell)

## <a name="remove-poa"></a>Удалить POA

Чтобы удалить приложение, следуйте инструкциям в [развертывании и удаляйте приложения с помощью PowerShell.](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications)

Для вашего удобства мы предоставили скрипт Undeploy.ps1 вместе с приложением. Использование сценария

  - Подключитесь к кластеру Service Fabric при помощи ```Connect-ServiceFabricCluster```.
  - Выполните сценарий PowerShell Undeploy.ps1.

> [!NOTE]
> Храните скрипт и папку приложения *PatchOrchestrationApplication* в том же каталоге.

## <a name="view-the-windows-update-results"></a>Просмотр результатов обновления Windows

POA предоставляет REST AIS для отображения исторических результатов пользователям. Вот пример результата JSON:

```json
[
  {
    "NodeName": "_stg1vm_1",
    "WindowsUpdateOperationResults": [
      {
        "OperationResult": 0,
        "NodeName": "_stg1vm_1",
        "OperationTime": "2019-05-13T08:44:56.4836889Z",
        "OperationStartTime": "2019-05-13T08:44:33.5285601Z",
        "UpdateDetails": [
          {
            "UpdateId": "7392acaf-6a85-427c-8a8d-058c25beb0d6",
            "Title": "Cumulative Security Update for Internet Explorer 11 for Windows Server 2012 R2 (KB3185319)",
            "Description": "A security issue has been identified in a Microsoft software product that could affect your system. You can help protect your system by installing this update from Microsoft. For a complete listing of the issues that are included in this update, see the associated Microsoft Knowledge Base article. After you install this update, you may have to restart your system.",
            "ResultCode": 0,
            "HResult": 0
          }
        ],
        "OperationType": 1,
        "WindowsUpdateQuery": "IsInstalled=0",
        "WindowsUpdateFrequency": "Daily,10:00:00",
        "RebootRequired": false
      }
    ]
  },
  ...
]
```

Поля JSON описаны в следующей таблице:

Поле | Значения | Сведения
-- | -- | --
OperationResult | 0 — успешно<br> 1 — выполнено с ошибками<br> 2 — сбой<br> 3 — прервано<br> 4 — прервано с временем ожидания | Указывает результат общей операции, которая обычно включает в себя установку одного или нескольких обновлений.
ResultCode | Как и для OperationResult | Это поле указывает результат операции установки для отдельного обновления.
OperationType | 1 — установка<br> 0 - Поиск и загрузка| По умолчанию Установка является единственной операциейType, показанной в результатах.
WindowsUpdateQuery | Значение по умолчанию: IsInstalled=0 | Запрос обновления Windows, который использовался для поиска обновлений. Для получения дополнительной информации, [см.](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx)
RebootRequired | true — требовалась перезагрузка<br> false — перезагрузка не требовалась | Указывает, требовалась ли перезагрузка для завершения установки обновлений.
ОперацияStartTime | Дата и время | Указывает время начала операции (загрузка/установка).
ОперацияВремя | Дата и время | Указывает время, в которое была завершена операция (загрузка/установка).
HResult | 0 - Успешно<br> другие - неудачи| Указывается причина сбоя обновления Windows с обновлением "7392acaf-6a85-427c-8a8d-058c25beb0d6".

Если обновление еще не запланировано, поле результата JSON будет пустым.

Вопийте в кластере для запроса результатов обновления Windows. Узнайте IP-адрес реплики для основного адреса Службы координатора и&lt;откройте&gt;следующий URL-адрес из браузера: http:// REPLICA-IP :&lt;ApplicationPort&gt;/PatchOrchestrationApplication/v1/GetWindowsUpdateResults.

Конечная точка REST для службы координатора имеет динамический порт. Чтобы проверить точный URL, обратитесь к Service Fabric Explorer. Например, результаты доступны *http://10.0.0.7:20000/PatchOrchestrationApplication/v1/GetWindowsUpdateResults*по адресу .

![Изображение конечной точки REST](media/service-fabric-patch-orchestration-application/Rest_Endpoint.png)

Если обратный прокси включен в кластере, можно также получить доступ к URL-адресу из-за пределов кластера.

Конечная точка, которую вам нужно *ударить, http://&lt;SERVERURL&gt;:&lt;REVERSEPROXYPORT&gt;/PatchOrchestrationApplication/CoordinatorService/v1/GetWindowsUpdateResults*.

Чтобы включить обратный прокси в кластере, следуйте инструкциям в [обратном прокси в Azure Service Fabric.](https://docs.microsoft.com/azure/service-fabric/service-fabric-reverseproxy) 

> 
> [!WARNING]
> После настройки обратного прокси все микрослужбы в кластере, которые разоблачают конечную точку HTTP, могут быть адресоспособны мизантами из-за пределов кластера.

## <a name="diagnostics-and-health-events"></a>Диагностика и оздоровите

В этом разделе обсуждается, как отладить или диагностировать проблемы с обновлениями патчей через POA на кластерах Service Fabric.

> [!NOTE]
> Чтобы получить многие из следующих вызванных, самодиагностических улучшений, вы должны иметь POA версию 1.4.0 или позже установлен.

Агент узлов NTService создает [задачи по ремонту](https://docs.microsoft.com/dotnet/api/system.fabric.repair.repairtask?view=azure-dotnet) для установки обновлений на узлах. Затем каждая задача готовится Службой координаторов в соответствии с политикой утверждения задач. Наконец, подготовленные задачи утверждаются диспетчером ремонта, который не утверждает ни одной задачи, если кластер находится в неработоспособном состоянии. 

Чтобы помочь вам понять, как обновления проходят на уделе, давайте шаг за шагом:

1. NodeAgentNTService, работающий на каждом узлах, ищет доступные обновления Windows в запланированное время. Если обновления доступны, он загружает их на узла.

1. После загрузки обновлений агент узлов NTService создает соответствующую задачу по ремонту узла с именем *POS___\<unique_id>. * Вы можете просмотреть эти задачи ремонта с помощью cmdlet [Get-ServiceFabricRepairTask](https://docs.microsoft.com/powershell/module/servicefabric/get-servicefabricrepairtask?view=azureservicefabricps) или с помощью SFX в разделе деталей узлов. После того, как задача по ремонту создана, она быстро переходит в [ *заявленное* состояние.](https://docs.microsoft.com/dotnet/api/system.fabric.repair.repairtaskstate?view=azure-dotnet)

1. Служба координаторов периодически ищет задачи по ремонту в *заявленном* состоянии, а затем обновляет их до состояния *подготовки* на основе TaskApprovalPolicy. Если TaskApprovalPolicy настроен как NodeWise, задача по ремонту, которая соответствует узлам, готовится только в том случае, если в настоящее время нет другой задачи ремонта в *стадии подготовки,* *одобрения,* *выполнения*или *восстановления* состояния. 

   Аналогичным образом, в случае UpgradeWise TaskApprovalPolicy, есть задачи в предыдущих состояниях только для узлов, которые принадлежат к тому же домену обновления. После того, как задача ремонта перенесена в состояние *подготовки,* соответствующий узла Service Fabric [отключен](https://docs.microsoft.com/powershell/module/servicefabric/disable-servicefabricnode?view=azureservicefabricps) с намерением *перезагрузки.*

   POA версии 1.4.0 и более поздние события с свойством ClusterPatchingStatus на CoordinatorService для отображения узлов, которые исправляются. Обновления устанавливаются на _poanode_0, как показано на следующем изображении:

    [![Изображение статуса кластерного исправления](media/service-fabric-patch-orchestration-application/clusterpatchingstatus.png)](media/service-fabric-patch-orchestration-application/clusterpatchingstatus.png#lightbox)

1. После того, как узла отключена, задача ремонта перемещается в состояние *выполнения.* 
   
   > [!NOTE]
   > Узло, застрявшее в состоянии *с инвалидностью,* может заблокировать новую задачу ремонта, которая останавливает работу исправления кластера.

1. Когда задача ремонта находится в *состоянии выполнения,* начинается установка патча на этом узло. После установки патча узел может быть перезапущен, а может и не перезапущен, в зависимости от патча. Затем задача ремонта перемещается в состояние *восстановления,* которое перевыполняет узел. Задание по ремонту помечается как завершенное.

   В версиях POA 1.4.0 и позже, вы можете найти состояние обновления, просмотрев события\<работы на NodeAgentService с собственностью WUOperationStatus- NodeName>. Выделенные разделы на следующих изображениях показывают состояние обновлений Windows на узлах *poanode_0* и *poanode_2:*

   [![Изображение состояния операции Обновления Windows](media/service-fabric-patch-orchestration-application/wuoperationstatusa.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusa.png#lightbox)

   [![Изображение состояния операции Обновления Windows](media/service-fabric-patch-orchestration-application/wuoperationstatusb.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusb.png#lightbox)

   Вы также можете получить подробную информацию с помощью PowerShell. Для этого вы подключитесь к кластеру и получите состояние задачи ремонта с помощью [Get-ServiceFabricRepairTask.](https://docs.microsoft.com/powershell/module/servicefabric/get-servicefabricrepairtask?view=azureservicefabricps) 
   
   В следующем примере задача "POS__poanode_2_125f2969-933c-4774-85d1-ebdf85e79f15" находится в состоянии *загрузки.* Это означает, что обновления были загружены на *poanode_2* узла, и установка будет предпринята при переходе задачи в состояние *выполнения.*

   ``` powershell
    D:\service-fabric-poa-bin\service-fabric-poa-bin\Release> $k = Get-ServiceFabricRepairTask -TaskId "POS__poanode_2_125f2969-933c-4774-85d1-ebdf85e79f15"

    D:\service-fabric-poa-bin\service-fabric-poa-bin\Release> $k.ExecutorData
    {"ExecutorSubState":2,"ExecutorTimeoutInMinutes":90,"RestartRequestedTime":"0001-01-01T00:00:00"}
    ```

   Если еще предстоит найти дополнительные проблемы, войдите в виртуальную машину (VM) или VM и узнайте о них с помощью журналов событий Windows. Ранее упомянутая задача ремонта может существовать только в следующих подгосударствах исполнителя:

      ИсполнительСоум | Описание
    -- | -- 
      No1 |  Подразумевается, что не было текущей операции на уде. Состояние может находиться в переходном периоде.
      СкачатьЗавершено 2 | Подразумевается, что операция загрузки была завершена с успехом, частичным сбоем или сбоем.
      УстановкаУтверждена No3 | Подразумевает, что операция загрузки была завершена раньше, и менеджер по ремонту одобрил установку.
      УстановкаИнпрогрессNo4 | Соответствует состоянию выполнения задачи по ремонту.
      УстановкаЗавершена No5 | Подразумевает, что установка была завершена с успехом, частичным успехом или неудачей.
      ПерезагрузкаЗапросNo 6 | Подразумевается, что установка патча была завершена и на узлах есть отложенное действие перезагрузки.
      ПерезагрузкаНоneededая No7 |  Подразумевается, что перезагрузка не была необходима после установки патча.
      ПерезагрузкаЗавершена No8 | Подразумевает, что перезагрузка была успешно завершена.
      ОперацияЗавершена No9 | Операция обновления Windows была успешно завершена.
      ОперацияАбортед No10 | Подразумевает, что операция обновления Windows была прервана.

1. В версиях POA 1.4.0 и позже, когда завершается попытка обновления узлов, событие с свойством «WUOperationStatus-NodeName» размещено на NodeAgentService, чтобы уведомить вас о том, что следующая попытка загрузки и установки обновлений Windows начнется. Это отображается на следующем изображении:

     [![Изображение состояния операции Обновления Windows](media/service-fabric-patch-orchestration-application/wuoperationstatusc.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusc.png#lightbox)

### <a name="diagnostics-logs"></a>Раздел "Журналы диагностики"

Журналы приложений для обработки патчей собираются в рамках журналов времени выполнения Service Fabric.

Вы можете захватить журналы с помощью диагностического инструмента или конвейера по вашему выбору. POA использует следующие фиксированные иносы поставщика для регистрации событий через [источник событий:](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource?view=netframework-4.5.1)

- e39b723c-590c-4090-abb0-11e3e6616346
- fc0028ff-bfdc-499f-80dc-ed922c52c5e9
- 24afa313-0d3b-4c7c-b485-1047fd964b60
- 05dc046c-60e9-4ef7-965e-91660adffa68

### <a name="health-reports"></a>Отчеты о работоспособности

POA также публикует отчеты о работоспособности в отношении Службы узла-агента или Службы координаторов в следующих сценариях:

* Служба NTService агента узла не работает

   Если на узле не работает служба NTService агента узла, генерируется отчет о работоспособности уровня предупреждения для службы агента узла.

* Служба менеджера по ремонту не включена

   Если служба диспетчера ремонта не найдена в кластере, для Службы координатора создается отчет о работе уровня предупреждения.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

**В: Почему я вижу свой кластер в состоянии ошибки при запуске POA?**

О: В процессе установки POA отключает или перезапускает узлы, что может временно привести к неработоспособной группе.

В зависимости от политики приложения, либо один узла может выйти из строя во время операции исправления, *либо* весь домен обновления может выйти из строя одновременно.

К концу установки обновления Windows узлы будут восстановлены после перезагрузки.

В примере ниже кластер временно перешел в состояние ошибки, так как два узла вышли из строя и политика MaxPercentageUnhealthNodes была нарушена. Ошибка носит временный характер до начала операции исправления.

![Представление неработоспособного кластера](media/service-fabric-patch-orchestration-application/MaxPercentage_causing_unhealthy_cluster.png)

Если проблема не будет устранена, см. сведения в разделе об устранении неполадок.

**В: Что делать, если POA находится в состоянии предупреждения?**

О: Проверьте, указывает ли отчет о работоспособности, размещенный в отношении приложения, основную причину. Обычно в описании предупреждения содержатся сведения о проблеме. Если проблема преходящая, ожидается, что приложение будет восстановлено автоматически.

**В: Что делать, если мой кластер неработоспособен и мне нужно срочно обновить операционную систему?**

О: POA не устанавливает обновления, пока кластер неработоспособен. Попробуйте привести кластер в состояние работоспособного, чтобы разблокировать рабочий процесс POA.

**В: Должен ли я установить TaskApprovalPolicy как "NodeWise" или "UpgradeDomainWise" для моего кластера?**

О: Установка "UpgradeDomainWise" ускоряет общий ремонт кластера путем параллельного исправления всех узлов, которые принадлежат к домену обновления. Во время процесса узлы, принадлежащие ко всему домену обновления, недоступны (в [ *состоянии инвалидов).* ](https://docs.microsoft.com/dotnet/api/system.fabric.query.nodestatus?view=azure-dotnet#System_Fabric_Query_NodeStatus_Disabled)

В отличие от этого, настройка "NodeWise" патчи только один узло в то время, что будет означать, что общее исправление кластера может занять больше времени. Однако, только один узлы в лучшем случае будет недоступен (в *отключенном* состоянии) во время процесса исправления.

Если кластер может терпеть запуск на N-1 число доменов обновления во время цикла исправления (где N является общее количество доменов обновления в кластере), вы можете установить политику как "UpgradeDomainWise". В противном случае установите его на "NodeWise".

**В: Сколько времени требуется на исправление узла?**

О: Патчирование узла может занять от минут (например, [обновления определения Windows Defender)](https://www.microsoft.com/en-us/wdsi/definitions)до часов (например, [кумулятивные обновления Windows).](https://www.catalog.update.microsoft.com/Search.aspx?q=windows%20server%20cumulative%20update) Время, необходимое для исправления узла, зависит в основном от: 
 - Размер обновлений.
 - Количество обновлений, которые должны быть применены в окне исправления.
 - Время, необходимое для установки обновлений, перезагрузки узла (при необходимости) и завершения шагов установки после перезагрузки.
 - Производительность VM или машины, и сетевые условия.

**В: Сколько времени занимает исправление всего кластера?**

О: Время, необходимое для исправления всего кластера, зависит от:

- Время, необходимое для исправления узла.

- Политика службы координатора. Политика по умолчанию, "NodeWise", приводит к исправлению только одного узла за один раз, подход, который медленнее, чем с помощью "UpgradeDomainWise". 

   Например: Если исправление узла занимает 1 час, исправление кластера 20-узлов (то же самого типа узлов) с 5 доменами обновления, каждый из которых содержит 4 узла, требует:
    - Для "NodeWise": 20 часов.
    - Для "UpgradeDomainWise": 5 часов.

- Кластерная нагрузка. Каждая операция исправления требует перемещения рабочей нагрузки клиента в другие доступные узлы кластера. Узла, который патч будет в [ *состоянии отключения* ](https://docs.microsoft.com/dotnet/api/system.fabric.query.nodestatus?view=azure-dotnet#System_Fabric_Query_NodeStatus_Disabling) в течение этого времени. Если кластер работает вблизи пиковой нагрузки, процесс отключения займет больше времени. Таким образом, общий процесс исправления может показаться медленным в таких напряженных условиях.

- Кластерные сбои в работоспособности во время исправления. Любая [деградация](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthstate?view=azure-dotnet#System_Fabric_Health_HealthState_Error) [работоспособности кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction) перенесет процесс исправления. Эта проблема позволит добавить к общему времени, необходимому для исправления всего кластера.

**В: Почему я вижу некоторые обновления в результатах обновления Windows, которые получены через REST API, но не в соответствии с историей обновления Windows на машине?**

О: Некоторые обновления продукта отображаются только в их собственной истории обновления или патча. Например, обновления Windows Defender могут отображаться или не отображаться в истории обновления Windows на Windows Server 2016.

**В: Может ли POA использоваться для исправления кластера разработчиков (одноузлового кластера)?**

О: Нет, POA не может быть использован для исправления кластера одного узла. Это ограничение является дизайном, потому что [службы сервисных услуг Fabric](https://docs.microsoft.com/azure/service-fabric/service-fabric-technical-overview#system-services) или других приложений для клиентов понесут простои. Таким образом, исправление ремонтных работ никогда не будет одобрен ремонт менеджера.

**В: Как зафиксать кластерные узлы на Linux?**

О: Чтобы узнать о оркестровке обновлений на Linux, [см.](https://docs.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade)

**В: Почему цикл обновления занимает так много времени?**

О: Запрос на результат JSON введите цикл обновления для всех узлов, а затем вы можете попытаться узнать время, заработаввремя на установку обновления на каждом узлах с помощью OperationStartTime и OperationTime (OperationCompletionTime). 

При наличии большого временного окна, в котором не происходит обновления, кластер может находиться в состоянии ошибки и, следовательно, диспетчер по ремонту не может утвердить задачи по ремонту POA. Если установка обновления занимает длительное время на любом узеле, этот узел, возможно, не был обновлен через некоторое время. Много обновлений может быть отложено до установки, что может привести к задержкам. 

Возможно также, что исправление узлов блокируется, поскольку оно застряло в *состоянии отключения.* Обычно это происходит потому, что отключение узла может привести к кворуму или ситуации потери данных.

**В: Почему узла следует отключить, когда POA исправляет его?**

О: POA отключает узла с намерением *перезагрузки,* который останавливает или перераспределяет все службы Service Fabric, работающие на уделе. POA делает это для того, чтобы приложения не в конечном итоге с помощью сочетания новых и старых DLLs, поэтому мы рекомендуем не исправлять узел без отключения.

**В: Каково максимальное количество узлов, которые могут быть обновлены с помощью POA?**

О: POA использует сервисный менеджер по ремонту тканей для создания задач по ремонту узлов для обновлений. Однако одновременно может присутствовать не более 250 ремонтных работ. В настоящее время POA создает задачи по ремонту каждого узла одновременно, поэтому POA может обновлять не более 250 узлов в кластере. 

## <a name="disclaimers"></a>Заявления об отказе от ответственности

- POA принимает соглашение о лицензии для конечных пользователей для обновления Windows от имени пользователя. При необходимости этот параметр можно отключить в конфигурации приложения.

- POA собирает телеметрию для отслеживания использования и производительности. Телеметрия приложения выполняется в соответствии с настройкой телеметрии в среде выполнения Service Fabric (которая включена по умолчанию).

## <a name="troubleshooting"></a>Устранение неполадок

Этот раздел предоставляет возможные решения для устранения неполадок при устранении проблем с исправлением узлов.

### <a name="a-node-is-not-coming-back-to-up-state"></a>Узел не возвращается в рабочее состояние

* Узла может застрять в *состоянии отключения,* так как:

  - Проверка безопасности находится в состоянии ожидания. В этом случае необходимо убедиться, что достаточное количество узлов находятся в работоспособном состоянии.

* Узла может застрять в *состоянии инвалидов,* так как:

  - Он был отключен вручную.
  - Он был отключен из-за текущей работы по инфраструктуре Azure.
  - Он был временно отключен POA для исправления узла.

* Возможная причина, по которой узел остался в отключенном состоянии

  - Он был помещен в вниз состояние вручную.
  - Он проходит перезагрузку (которая может быть вызвана POA).
  - Он имеет неисправный VM или машину, или у него проблемы с подключением к сети.

### <a name="updates-were-skipped-on-some-nodes"></a>Обновления на некоторых узлах пропущены

POA пытается установить обновление Windows в соответствии с политикой переноса. Служба пытается восстановить узел и пропустить обновление в соответствии с политикой приложения.

В этом случае для службы агента узла будет создан отчет о работоспособности уровня предупреждения. Результат обновления Windows также содержит возможную причину сбоя.

### <a name="the-health-of-the-cluster-goes-to-error-while-the-update-is-being-installed"></a>Работоспособность кластера идет к ошибке во время установки обновления

Неисправное обновление Windows может снизить работоспособность приложения или кластера на определенном домене узлов или обновить его. POA прекращает любую последующую работу обновления Windows до тех пор, пока кластер снова не будет работать.

Администратор должен вмешаться и определить, почему приложение или кластер стали неработоспособными из-за обновления Windows.

## <a name="poa-release-notes"></a>Заметки о выпуске POA

>[!NOTE]
> Для версий POA 1.4.0 и более поздних, вы можете найти заметки и релизы на [странице выпуска приложения Patch Orchestra](https://github.com/microsoft/Service-Fabric-POA/releases/) на GitHub.

### <a name="version-110"></a>Версия 1.1.0
- Общедоступный выпуск

### <a name="version-111"></a>Версии 1.1.1
- Исправлена ошибка в SetupEntryPoint службы агента узла, которая препятствовала установке службы NTService агента узла.

### <a name="version-120"></a>Версии 1.2.0

- Исправлены ошибки, связанные с рабочим процессом перезапуска системы.
- Исправлена ошибка при создании задач службы управления правами, из-за которой проверка работоспособности не выполнялась должным образом во время подготовки задач восстановления.
- Изменен режим запуска для службы Windows POANodeSvc с автоматического на отсроченный-авто.

### <a name="version-121"></a>Версия 1.2.1

- Исправлены ошибки в рабочем процессе уменьшения масштаба кластера. Добавлена логика сборки мусора для задач восстановления POA, относящихся к несуществующим узлам.

### <a name="version-122"></a>Версия 1.2.2

- Прочие исправления ошибок.
- Теперь двоичные файлы подписаны.
- Добавлена ссылка на sfpkg для приложения.

### <a name="version-130"></a>Версия 1.3.0

- Заданное параметру InstallWindowsOSOnlyUpdates значение false теперь устанавливает все доступные обновления.
- Изменена логика отключения автоматических обновлений. Благодаря этому ошибка, когда автоматические обновления не были отключены на Server 2016 и более поздних версий, была исправлена.
- Параметризованное ограничение размещения для обеих микрослужб POA для случаев расширенного использования.

### <a name="version-131"></a>Версия 1.3.1
- Фиксация регрессии, когда POA 1.3.0 не будет работать на Windows Server 2012 R2 или раньше из-за сбоя в отключении автоматических обновлений. 
- Исправлена ошибка, при которой для конфигурации InstallWindowsOSOnlyUpdates всегда выбирается значение True.
- Значения по умолчанию InstallWindowsOSOnlyUpdates изменилось на False.

### <a name="version-132"></a>Версия 1.3.2
- Исправление проблемы, которая влияет на жизненный цикл исправления на уде, если есть узлы с именем, которое является подмножеством текущего имени узла. Для таких узлов возможно, что исправление было пропущено или перезагрузка находится на рассмотрении.
