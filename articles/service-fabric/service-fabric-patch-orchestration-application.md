---
title: Приложение для управления исправлениями Azure Service Fabric | Документация Майкрософт
description: Приложение для автоматизации установки исправлений операционной системы в кластере Service Fabric.
services: service-fabric
documentationcenter: .net
author: khandelwalbrijeshiitr
manager: chackdan
editor: ''
ms.assetid: de7dacf5-4038-434a-a265-5d0de80a9b1d
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 2/01/2019
ms.author: brkhande
ms.openlocfilehash: 2aa2dd8373a9568478a02691ca5e6a43e80cd408
ms.sourcegitcommit: 29880cf2e4ba9e441f7334c67c7e6a994df21cfe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/26/2019
ms.locfileid: "71289426"
---
# <a name="patch-the-windows-operating-system-in-your-service-fabric-cluster"></a>Установка исправлений операционной системы Windows в кластере Service Fabric

> 
> [!IMPORTANT]
> Версия приложения 1,2. * выходит за пределы поддержки 30 апреля 2019. Обновите до последней версии.


[Автоматические обновления образа ОС масштабируемого набора виртуальных машин Azure](https://docs.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade) — это лучший метод установки исправлений операционной системы в Azure, а приложение для управления исправлениями (POA) — это оболочка вокруг службы систем RepairManager в Service Fabric, которая обеспечивает планирование установки исправлений ОС на основе конфигурации для кластеров, размещенных не в Azure. POA не является обязательным для кластеров, размещенных не в Azure, но планирование установки исправлений доменами обновления обязательно для установки исправлений узлов кластеров Service Fabric без простоев.

POA — это приложение Azure Service Fabric, которое позволяет автоматизировать установку исправлений операционной системы в кластере Service Fabric и избежать простоев.

Приложение для оркестрации исправлений предоставляет следующие возможности:

- **Автоматическая установка обновлений операционной системы**. Обновления операционной системы автоматически загружаются и устанавливаются. При необходимости узлы кластера перезагружаются без остановки его работы.

- **Исправление с учетом состояния кластера и интеграция функций работоспособности**. При применении обновлений приложение для управления исправлениями отслеживает работоспособность узлов кластера. Узлы кластера обновляются поочередно или по одному домену обновления за раз. Если из-за установки исправлений работоспособность кластера понижается, процесс останавливается, чтобы проблема не усугублялась.

## <a name="internal-details-of-the-app"></a>Внутренние сведения приложения

Приложение для управления исправлениями состоит из описанных ниже компонентов.

- **Служба координатора** — это служба с отслеживанием состояния, отвечающая за следующие задачи:
    - координация задания обновления Windows во всем кластере;
    - хранение результатов завершенных операций обновления Windows.
- **Служба агента узла** — это служба без отслеживания состояния, которая выполняется на всех узлах кластера Service Fabric. Она отвечает за следующие задачи:
    - начальная загрузка NTService агента узла;
    - мониторинг службы NTService агента узла.
- **Служба NTService агента узла** — служба Windows NT, которая выполняется с разрешением высокого уровня (СИСТЕМА). Для сравнения служба агента узла и служба координатора выполняются с разрешением более низкого уровня (СЕТЕВАЯ СЛУЖБА). Служба отвечает за выполнение следующих заданий обновления Windows на всех узлах кластера:
    - выключение автоматического обновления Windows на узле;
    - загрузка и установка обновления Windows в соответствии с политикой, назначенной пользователем;
    - перезапуск машины после установки обновлений Windows;
    - передача результатов обновления Windows в службу координатора;
    - сообщение сведений о работоспособности, если операцию не удалось выполнить, исчерпав все повторные попытки.

> [!NOTE]
> Приложение для управления исправлениями использует для включения и выключения узла, а также проверки работоспособности системную службу Service Fabric, которая называется Repair Manager. Задание восстановления, созданное приложением для управления исправлениями, отслеживает ход обновления Windows для каждого узла.

## <a name="prerequisites"></a>Предварительные требования

> [!NOTE]
> Минимальная требуемая версия .NET Framework — 4,6.

### <a name="enable-the-repair-manager-service-if-its-not-running-already"></a>Включение службы Repair Manager (если она еще не запущена)

Приложению для управления исправлениями необходимо, чтобы системная служба Repair Manager была включена в кластере.

#### <a name="azure-clusters"></a>Кластеры Azure

В кластерах Azure на уровне надежности Silver служба Repair Manager включена по умолчанию. В кластерах Azure на уровне надежности Gold служба Repair Manager может быть не включена в зависимости от того, когда были созданы кластеры. В кластерах Azure на уровне надежности Bronze служба Repair Manager по умолчанию не включена. Если служба уже включена, сведения о ее выполнении отображаются в разделе системных служб в Service Fabric Explorer.

##### <a name="azure-portal"></a>портала Azure
Диспетчер восстановления можно включить на портале Azure при настройке кластера. Выберите параметр **Включить диспетчер восстановления** в разделе **Дополнительные функции** во время настройки кластера.
![Снимок экрана с подключением диспетчера восстановления на портале Azure](media/service-fabric-patch-orchestration-application/EnableRepairManager.png)

##### <a name="azure-resource-manager-deployment-model"></a>Модель развертывания диспетчера ресурсов Azure
Службу диспетчера восстановления также можно включить для новых и существующих кластеров Service Fabric с помощью [модели развертывания Azure Resource Manager](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm). Получите шаблон для кластера, который требуется развернуть. Можно использовать примеры шаблонов или создать пользовательский шаблон модели развертывания Azure Resource Manager. 

Чтобы включить службу диспетчера восстановления с помощью [шаблона модели развертывания Azure Resource Manager](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-via-arm), сделайте следующее:

1. Сначала убедитесь, что для `apiversion` задано значение `2017-07-01-preview` для ресурса `Microsoft.ServiceFabric/clusters`. Если оно другое, необходимо задать для `apiVersion` значение `2017-07-01-preview` или выше:

    ```json
    {
        "apiVersion": "2017-07-01-preview",
        "type": "Microsoft.ServiceFabric/clusters",
        "name": "[parameters('clusterName')]",
        "location": "[parameters('clusterLocation')]",
        ...
    }
    ```

2. Включите службу Repair Manager, добавив следующий раздел `addonFeatures` после раздела `fabricSettings`:

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

3. После обновления шаблона кластера примените изменения и дождитесь завершения обновления. Теперь отображаются сведения о выполнении службы Repair Manager в кластере. Он указан в разделе системных служб в Service Fabric Explorer под названием `fabric:/System/RepairManagerService`. 

### <a name="standalone-on-premises-clusters"></a>Автономные локальные кластеры

Чтобы включить службу Repair Manager в новых и существующих кластерах Service Fabric, можно использовать [Параметры конфигурации для автономного кластера Windows](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-manifest).

Включение службы Repair Manager

1. Сначала убедитесь, что для параметра `apiversion` в разделе [Общие параметры кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-manifest#general-cluster-configurations) установлено значение `04-2017` или выше:

    ```json
    {
        "name": "SampleCluster",
        "clusterConfigurationVersion": "1.0.0",
        "apiVersion": "04-2017",
        ...
    }
    ```

2. Включите службу Repair Manager, добавив раздел `addonFeatures` после раздела `fabricSettings`, как показано ниже.

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

3. Обновите манифест кластера, добавив эти изменения с помощью манифеста обновления кластера [Создание кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-creation-for-windows-server) или [Обновление конфигурации кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-upgrade-windows-server). Как только кластер запустится с обновленным манифестом, вы увидите, что системная служба Repair Manager выполняется в кластере, который называется `fabric:/System/RepairManagerService`, в разделе системных служб в Service Fabric Explorer.

### <a name="configure-windows-updates-for-all-nodes"></a>Настройка обновлений Windows для всех узлов

Автоматическое обновление Windows может привести к потере доступности из-за одновременного перезапуска нескольких узлов кластера. Приложение для управления исправлениями по умолчанию попытается выключить автоматическое обновление Windows на каждом узле кластера. Но если параметры задаются администратором или групповой политикой, советуем явно настроить для политики обновления Windows параметр уведомления о скачивании.

## <a name="download-the-app-package"></a>Загрузка пакета установки

Чтобы скачать пакет приложения, посетите [страницу](https://github.com/microsoft/Service-Fabric-POA/releases/latest/) выпуска GitHub приложения для управления исправлениями.

## <a name="configure-the-app"></a>Настройка приложения

Поведение приложения для управления исправлениями можно настроить в соответствии с вашими требованиями. Значения по умолчанию можно переопределить, передав параметр приложения во время создания или обновления приложения. Параметры приложения можно задать, указав параметр `ApplicationParameter` командлету `Start-ServiceFabricApplicationUpgrade` или `New-ServiceFabricApplication`.

|**Параметр**        |**Тип**                          | **Сведения**|
|:-|-|-|
|MaxResultsToCache    |длинное целое                              | Максимальное количество результатов обновления Windows, которые необходимо кэшировать. <br>Значение по умолчанию — 3000 при условии, что: <br> - количество узлов —20; <br> - количество обновлений на узле в месяц — 5; <br> - количество результатов на операцию может быть 10; <br> - сохраняются результаты за последние три месяца. |
|TaskApprovalPolicy   |Enum <br> { NodeWise, UpgradeDomainWise }                          |TaskApprovalPolicy указывает политику, которая будет использоваться службой координатора для установки обновлений Windows на узлы кластера Service Fabric.<br>                         Допустимые значения: <br>                                                           <b>NodeWise</b>. Обновление Windows устанавливается на один узел за раз. <br>                                                           <b>UpgradeDomainWise</b>. Обновление Windows устанавливается на один домен обновления за раз (как максимум на всех узлах, принадлежащих домену обновления).<br> Сведения о выборе подходящей политики для кластера см. в разделе [часто задаваемых вопросов](#frequently-asked-questions).
|LogsDiskQuotaInMB   |Длинный  <br> (Значение по умолчанию: 1024)               |Максимальный размер журналов приложения для управления исправлениями, которые могут быть сохранены локально на узле (в мегабайтах).
| WUQuery               | строка<br>(Значение по умолчанию: IsInstalled=0)                | Запрос на получение обновлений Windows. Дополнительные сведения см. в разделе [WuQuery](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx).
| InstallWindowsOSOnlyUpdates | логический <br> (значение по умолчанию — false)                 | Используйте этот флаг, чтобы контролировать, какие обновления следует скачать и установить. Допустимы следующие значения: <br>true — устанавливает только обновления операционной системы Windows;<br>false — устанавливает все доступные обновления на компьютере.          |
| WUOperationTimeOutInMinutes | int <br>(Значение по умолчанию: 90)                   | Указывает время ожидания для любой операции обновления Windows (поиск, скачивание или установка). Если операция не завершена по истечении заданного времени ожидания, она будет прервана.       |
| WURescheduleCount     | int <br> (Значение по умолчанию: 5)                  | Максимальное количество операций изменения службой расписания обновления Windows в случае постоянных сбоев операции.          |
| WURescheduleTimeInMinutes | int <br>(Значение по умолчанию: 30) | Интервал, согласно которому служба будет изменять расписание обновления Windows, если сбой продолжает происходить. |
| WUFrequency           | Строка с разделителями-запятыми (по умолчанию: Weekly, Wednesday, 7:00:00 [еженедельно, среда, 07:00:00])     | Частота установки обновлений Windows. Формат и возможные значения: <br>- Monthly, ДД, ЧЧ:ММ:СС (ежемесячно, например: Monthly, 5, 12:22:32);<br>Допустимые значения для поля ДД (день) являются числами в диапазоне 1–28 и "последние". <br> — Еженедельно, ДЕНЬ, ЧЧ:ММ:СС (например: Weekly, Tuesday, 12:22:32);  <br> - Ежедневно, ЧЧ:ММ:СС (например: Daily, 12:22:32);  <br> - Никогда — указывает, что обновление Windows не должно выполняться.  <br><br> Обратите внимание, что значения времени указаны в формате UTC.|
| AcceptWindowsUpdateEula | логический <br>(значение по умолчанию: True) | Если этот флажок установлен, приложение принимает условия лицензионного соглашения Центра обновления Windows от имени владельца компьютера.              |

> [!TIP]
> Чтобы обновление Windows началось немедленно, установите `WUFrequency` в соответствии с временем развертывания приложения. Например, у вас тестовый кластер с пятью узлами и вы планируете развернуть приложение около 17:00 UTC. Если предположить, что обновление или развертывание приложения занимает не более 30 минут, задайте для WUFrequency значение Daily, 17:30:00 (ежедневно, 17:30:00).

## <a name="deploy-the-app"></a>Развертывание приложения

1. Завершите все предварительные шаги, чтобы подготовить кластер.
2. Разверните приложение для управления исправлениями, как любое другое приложение Service Fabric. Развернуть приложение можно с помощью PowerShell. Выполните инструкции из статьи [Развертывание и удаление приложений с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).
3. Чтобы настроить приложение во время развертывания, передайте `ApplicationParameter` для командлета `New-ServiceFabricApplication`. Для вашего удобства мы сопроводили приложение сценарием Deploy.ps1. Использование сценария

    - Подключитесь к кластеру Service Fabric при помощи `Connect-ServiceFabricCluster`.
    - Выполните сценарий PowerShell Deploy.ps1 с соответствующим значением `ApplicationParameter`.

> [!NOTE]
> Сохраните сценарий и папку приложения PatchOrchestrationApplication в одном каталоге.

## <a name="upgrade-the-app"></a>Обновление приложения

Чтобы обновить установленное приложение для управления исправлениями при помощи PowerShell, выполните инструкции из статьи [Обновление приложения Service Fabric с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-application-upgrade-tutorial-powershell).

## <a name="remove-the-app"></a>Удаление приложения

Чтобы удалить приложение, выполните инструкции из статьи [Развертывание и удаление приложений с помощью PowerShell](https://docs.microsoft.com/azure/service-fabric/service-fabric-deploy-remove-applications).

Для вашего удобства мы сопроводили приложение сценарием Undeploy.ps1. Использование сценария

  - Подключитесь к кластеру Service Fabric при помощи ```Connect-ServiceFabricCluster```.

  - Выполните сценарий PowerShell Undeploy.ps1.

> [!NOTE]
> Сохраните сценарий и папку приложения PatchOrchestrationApplication в одном каталоге.

## <a name="view-the-windows-update-results"></a>Просмотр результатов обновления Windows

Приложение для управления исправлениями предоставляет REST API для отображения исторических результатов. Пример результата JSON:
```json
[
  {
    "NodeName": "_stg1vm_1",
    "WindowsUpdateOperationResults": [
      {
        "OperationResult": 0,
        "NodeName": "_stg1vm_1",
        "OperationTime": "2019-05-13T08:44:56.4836889Z",
        "OperationStartTime": "2019-05-13T08:44:33.5285601Z",
        "UpdateDetails": [
          {
            "UpdateId": "7392acaf-6a85-427c-8a8d-058c25beb0d6",
            "Title": "Cumulative Security Update for Internet Explorer 11 for Windows Server 2012 R2 (KB3185319)",
            "Description": "A security issue has been identified in a Microsoft software product that could affect your system. You can help protect your system by installing this update from Microsoft. For a complete listing of the issues that are included in this update, see the associated Microsoft Knowledge Base article. After you install this update, you may have to restart your system.",
            "ResultCode": 0,
            "HResult": 0
          }
        ],
        "OperationType": 1,
        "WindowsUpdateQuery": "IsInstalled=0",
        "WindowsUpdateFrequency": "Daily,10:00:00",
        "RebootRequired": false
      }
    ]
  },
  ...
]
```

Ниже приводится описание полей JSON.

Поле | Значения | Подробнее
-- | -- | --
OperationResult | 0 — успешно<br> 1 — выполнено с ошибками<br> 2 — сбой<br> 3 — прервано<br> 4 — прервано с временем ожидания | Указывает результат общей операции (обычно с установкой одного или нескольких обновлений).
ResultCode | Как и для OperationResult | Это поле указывает результат операции установки для отдельного обновления.
OperationType | 1 — установка<br> 0 — поиск и скачивание| По умолчанию в результатах отображается только тип операции "Установка".
WindowsUpdateQuery | Значение по умолчанию: IsInstalled=0 |Запрос на обновление Windows, использованный для поиска обновлений. Дополнительные сведения см. в разделе [WuQuery](https://msdn.microsoft.com/library/windows/desktop/aa386526(v=vs.85).aspx).
RebootRequired | true — требовалась перезагрузка<br> false — перезагрузка не требовалась | Указывает, требовалась ли перезагрузка для завершения установки обновлений.
оператионстарттиме | DateTime | Указывает время запуска операции (загрузки или установки).
оператионтиме | DateTime | Указывает время завершения операции (загрузки или установки).
Состав | 0 — успешное завершение<br> другие — сбой| Указывает причину сбоя обновления Windows с помощью updateID "7392acaf-6a85-427c-8a8d-058c25beb0d6".

Если обновление еще не запланировано, поле результата JSON будет пустым.

Войдите в кластер, чтобы запросить Центр обновления Windows результаты. Найдите адрес реплики для первичной службы координатора и перейдите по этому URL-адресу в браузере: http://&lt;REPLICA-IP&gt;:&lt;ApplicationPort&gt;/PatchOrchestrationApplication/v1/GetWindowsUpdateResults.

Конечная точка REST для службы координатора имеет динамический порт. Точный URL-адрес можно узнать в Service Fabric Explorer. Например, результаты доступны в `http://10.0.0.7:20000/PatchOrchestrationApplication/v1/GetWindowsUpdateResults`.

![Представление конечной точки REST](media/service-fabric-patch-orchestration-application/Rest_Endpoint.png)


Если в кластере включен обратный прокси-сервер, пользователь также может получить доступ к URL-адресу за пределами кластера.
Конечная точка, к которой нужно перейти: http://&lt;SERVERURL&gt;:&lt;REVERSEPROXYPORT&gt;/PatchOrchestrationApplication/CoordinatorService/v1/GetWindowsUpdateResults.

Чтобы включить в кластере обратный прокиз статьи [Обратный прокси-сервер Service Fabric](https://docs.microsoft.com/azure/service-fabric/service-fabric-reverseproxy). 

> 
> [!WARNING]
> Настройка обратного прокси-сервера обеспечит адресацию извне кластера всех микрослужб в этом кластере, которые предоставляют конечную точку HTTP.

## <a name="diagnosticshealth-events"></a>События диагностики и работоспособности

В следующем разделе рассказывается, как выполнять отладку и диагностику проблем с обновлениями исправлений через приложение для управления исправлениями на кластерах Service Fabric.

> [!NOTE]
> У вас должна быть установлена версия ВЕХ версии 1.4.0, чтобы получить многие из перечисленных ниже вызываемых усовершенствований для самостоятельной диагностики.

Нодеажентнтсервице создает [задачи восстановления](https://docs.microsoft.com/dotnet/api/system.fabric.repair.repairtask?view=azure-dotnet) для установки обновлений на узлах. Затем каждая задача подготавливается с помощью службы координатора в соответствии с политикой утверждения задач. Подготовленные задачи, наконец, утверждаются Диспетчер восстановления, который не будет утверждать какие-либо задачи, если кластер находится в неработоспособном состоянии. Позволяет пошагово пройти шаг, чтобы понять, как обновления продолжают работать на узле.

1. Нодеажентнтсервице, выполняющиеся на каждом узле, ищет доступные Центр обновления Windows в запланированное время. Если обновления доступны, они загружаются на узел.
2. После загрузки обновлений Нодеажентнтсервице создает соответствующую задачу восстановления для узла с именем POS___ < unique_id >. Эти задачи восстановления можно просмотреть с помощью командлета [Get-сервицефабрикрепаиртаск](https://docs.microsoft.com/powershell/module/servicefabric/get-servicefabricrepairtask?view=azureservicefabricps) или в списке SFX в разделе сведения об узле. Когда задача восстановления будет создана, она быстро переходит в [затребованное состояние](https://docs.microsoft.com/dotnet/api/system.fabric.repair.repairtaskstate?view=azure-dotnet).
3. Служба координатора периодически ищет задачи восстановления в запрошенном состоянии и обновляет их для подготовки состояния на основе TaskApprovalPolicy. Если TaskApprovalPolicy настроен на Нодевисе, то задача восстановления, соответствующая узлу, будет готова только в том случае, если в настоящее время нет других задач по восстановлению, выполняемых в процессе подготовки, утверждения, запуска или восстановления состояния. Аналогично, в случае с Упградевисе TaskApprovalPolicy, в любой момент в указанных состояниях есть задачи, относящиеся только к тем узлам, которые принадлежат одному домену обновления. После перемещения задачи восстановления в состояние подготовки соответствующий узел Service Fabric [отключается](https://docs.microsoft.com/powershell/module/servicefabric/disable-servicefabricnode?view=azureservicefabricps) с намерением перезапуска.

   ВЕХ (v 1.4.0 и выше) отправляет события с свойством "Клустерпатчингстатус" в Курдинатерсервице для просмотра обновляемых узлов. На рисунке ниже показано, что обновления устанавливаются в _poanode_0:

    [![Изображение состояния исправления кластера](media/service-fabric-patch-orchestration-application/clusterpatchingstatus.png)](media/service-fabric-patch-orchestration-application/clusterpatchingstatus.png#lightbox)

4. После отключения узла задача восстановления перемещается в состояние выполнения.
   
   >[!NOTE]
   > Узел, работающий в отключенном состоянии, может блокировать новую задачу восстановления, что приведет к остановке операции исправления в кластере.

5. После того как задача восстановления находится в состоянии выполняется, начинается установка исправления на этом узле. Здесь, после установки исправления, узел может перезапуститься или не может быть перезапущен в зависимости от исправления. Сообщение о том, что задача восстановления перемещена в состояние восстановления, что позволяет снова вернуть узел и пометить его как завершенный.

   В v 1.4.0 и более поздних версиях приложения состояние обновления можно найти, просмотрев события работоспособности в службы агента узла со свойством "Вуоператионстатус-[NodeName]". В выделенных разделах на рисунках ниже показано состояние центра обновления Windows на узлах "poanode_0" и "poanode_2":

   [![Изображение состояния операции обновления Windows](media/service-fabric-patch-orchestration-application/wuoperationstatusa.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusa.png#lightbox)

   [![Изображение состояния операции обновления Windows](media/service-fabric-patch-orchestration-application/wuoperationstatusb.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusb.png#lightbox)

   Можно также получить подробные сведения с помощью PowerShell, подключившись к кластеру и изменив состояние задачи восстановления с помощью команды [Get-сервицефабрикрепаиртаск](https://docs.microsoft.com/powershell/module/servicefabric/get-servicefabricrepairtask?view=azureservicefabricps). Как показано ниже, пример задачи «POS__poanode_2_125f2969-933c-4774-85d1-ebdf85e79f15» находится в состоянии DownloadComplete. Это означает, что обновления были скачаны на узле "poanode_2", и при переходе задачи в состояние выполнения будет предпринята попытка установки.

   ``` powershell
    D:\service-fabric-poa-bin\service-fabric-poa-bin\Release> $k = Get-ServiceFabricRepairTask -TaskId "POS__poanode_2_125f2969-933c-4774-85d1-ebdf85e79f15"

    D:\service-fabric-poa-bin\service-fabric-poa-bin\Release> $k.ExecutorData
    {"ExecutorSubState":2,"ExecutorTimeoutInMinutes":90,"RestartRequestedTime":"0001-01-01T00:00:00"}
    ```

   Если вы еще не нашли это, войдите на определенную виртуальную машину или виртуальные машины, чтобы узнать больше о данной ошибке с помощью журналов событий Windows. Описанная выше задача восстановления может иметь только следующие подсостояния исполнителя:

      ексекуторсубстате | Подробности
    -- | -- 
      Нет = 1 |  Подразумевает, что на узле не выполнялась текущая операция. Возможные переходы состояния.
      Довнлоадкомплетед = 2 | Подразумевает, что операция скачивания завершилась успешно, частично или неудачно.
      Инсталлатионаппровед = 3 | Подразумевает, что операция скачивания была выполнена ранее и Диспетчер восстановления утвердила установку.
      Инсталлатионинпрогресс = 4 | Соответствует состоянию выполнения задачи восстановления.
      Инсталлатионкомплетед = 5 | Означает, что установка завершена успешно, частично или неудачно.
      Рестартрекуестед = 6 | Подразумевает, что установка исправления завершена и на узле имеется ожидающее действие перезагрузки.
      Рестартнотнидед = 7 |  Предполагается, что перезапуск не требовался после завершения установки исправления.
      Рестарткомплетед = 8 | Подразумевает, что перезапуск успешно завершен.
      Оператионкомплетед = 9 | Операция обновления Windows успешно завершена.
      Оператионабортед = 10 | Подразумевает, что операция обновления Windows прервана.

6. В v 1.4.0 и более поздних версиях приложения, когда попытка обновления на узле завершается, событие со свойством "Вуоператионстатус-[NodeName]" отправляется в службы агента узла, чтобы уведомлять, когда будет выполнена следующая попытка, чтобы скачать и установить обновление, запустить. См. рисунок ниже.

     [![Изображение состояния операции обновления Windows](media/service-fabric-patch-orchestration-application/wuoperationstatusc.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusc.png#lightbox)

### <a name="diagnostic-logs"></a>Журналы диагностики

Журналы приложения для оркестрации исправлений собираются как часть журналов среды выполнения Service Fabric.

При необходимости можно собирать журналы, используя любой конвейер или средство диагностики. Приложение для управления исправлениями использует указанные ниже идентификаторы поставщиков для регистрации событий через [источник событий](https://docs.microsoft.com/dotnet/api/system.diagnostics.tracing.eventsource?view=netframework-4.5.1) .

- e39b723c-590c-4090-abb0-11e3e6616346
- fc0028ff-bfdc-499f-80dc-ed922c52c5e9
- 24afa313-0d3b-4c7c-b485-1047fd964b60
- 05dc046c-60e9-4ef7-965e-91660adffa68

### <a name="health-reports"></a>Отчеты о работоспособности

Приложение для управления исправлениями также публикует отчеты о работоспособности для службы координатора или службы агента узла в указанных ниже случаях.

#### <a name="the-node-agent-ntservice-is-down"></a>Служба NTService агента узла не работает

Если на узле не работает служба NTService агента узла, генерируется отчет о работоспособности уровня предупреждения для службы агента узла.

#### <a name="the-repair-manager-service-is-not-enabled"></a>Служба Repair Manager не включена

Если служба Repair Manager не найдена в кластере, для службы координатора создается отчет о работоспособности уровня предупреждения.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

В. **Почему мой кластер находится в состоянии ошибки, когда работает приложение для управления исправлениями?**

A. Приложение для управления исправлениями может отключать и перезапускать узлы во время установки, что может временно привести к ухудшению работоспособности кластера.

Основываясь на политике приложения, во время установки исправления любой узел может выйти из строя *или же* сбой может произойти во всем домене обновления.

К завершению установки обновлений Windows узлы будут повторно включены после перезагрузки.

В примере ниже кластер временно перешел в состояние ошибки, так как два узла вышли из строя и политика MaxPercentageUnhealthNodes была нарушена. Это временная ошибка. Она исчезнет, как только установка исправлений будет завершена.

![Представление неработоспособного кластера](media/service-fabric-patch-orchestration-application/MaxPercentage_causing_unhealthy_cluster.png)

Если проблема не будет устранена, см. сведения в разделе об устранении неполадок.

В. **Приложение для управления исправлениями находится в состоянии предупреждения**

A. Проверьте, является ли отчет о работоспособности, опубликованный для приложения, основной причиной. Обычно в описании предупреждения содержатся сведения о проблеме. Если проблема временная, приложение автоматически восстановится из этого состояния.

В. **Что делать, если нужно срочно обновить операционную систему, а кластер неработоспособен?**

A. Приложение для управления исправлениями не устанавливает обновления, пока кластер находится в неработоспособном состоянии. Попробуйте восстановить работоспособность кластера, чтобы разблокировать рабочий процесс приложения для управления исправлениями.

В. **Следует ли для кластера задать для TaskApprovalPolicy значение "Нодевисе" или "Упградедомаинвисе"?**

A. UpgradeDomainWise ускоряет применение исправлений ко всему кластеру благодаря параллельному исправлению всех узлов, принадлежащих к домену обновления. Это означает, что узлы, принадлежащие всему домену обновления, будут недоступны (в [отключенном](https://docs.microsoft.com/dotnet/api/system.fabric.query.nodestatus?view=azure-dotnet#System_Fabric_Query_NodeStatus_Disabled) состоянии) в течение процесса исправления.

Политика NodeWise, напротив, подразумевает исправление только одного узла за раз, что увеличивает время установки исправлений для всего кластера. При этом максимум один узел будет недоступен (в [отключенном](https://docs.microsoft.com/dotnet/api/system.fabric.query.nodestatus?view=azure-dotnet#System_Fabric_Query_NodeStatus_Disabled) состоянии) в течение процесса исправления.

Если ваш кластер допускает выполнение на N-1 доменах обновления в ходе применения исправлений (где N — общее число доменов обновления в кластере), то можно задать политику как UpgradeDomainWise, в противном случае выберите значение NodeWise.

В. **Сколько времени уходит на исправление узла?**

A. Установка исправлений на узел может занять от нескольких минут (например, [обновления определений для Защитника Windows](https://www.microsoft.com/en-us/wdsi/definitions)) до нескольких часов (например, [накопительные обновления Windows](https://www.catalog.update.microsoft.com/Search.aspx?q=windows%20server%20cumulative%20update)). Время, необходимое для исправления узла, главным образом, зависит от 
 - размера обновлений;
 - числа обновлений, которые должны быть применены за данный период;
 - времени, необходимого для установки обновлений, перезагрузки узла (при необходимости) и завершения действий по установке после перезагрузки;
 - производительности виртуальной машины или компьютера и условий сети.

В. **Сколько времени уходит на исправление всего кластера?**

A. Время, необходимое для исправления всего кластера, зависит от перечисленных ниже факторов.

- Время, необходимое для исправления узла.
- Политика службы координатора. — Политика по умолчанию (`NodeWise`) ограничивает исправление только одним узлом за раз — это медленнее, чем `UpgradeDomainWise`. Пример: если исправление узла занимает примерно 1 час, для применения исправлений к кластеру из 20 узлов (одного типа) с 5 доменами обновления, каждый из которых содержит 4 узла,
    - может потребоваться около 20 часов на исправление всего кластера, если для политики задано значение `NodeWise`;
    - может потребоваться около 5 часов, если для политики задано значение `UpgradeDomainWise`.
- Загрузка кластера — для каждой операции установки исправлений требуется перенос рабочей нагрузки клиентов на другие доступные узлы в кластере. Во время исправления узел будет находиться в [отключенном](https://docs.microsoft.com/dotnet/api/system.fabric.query.nodestatus?view=azure-dotnet#System_Fabric_Query_NodeStatus_Disabling) состоянии. Если кластер работает на пределе пиковой нагрузки, процесс отключения займет больше времени. Поэтому в таких неблагоприятных условиях общий процесс исправления может происходить медленно.
- Сбои работоспособности кластера во время исправления —любое [снижение](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthstate?view=azure-dotnet#System_Fabric_Health_HealthState_Error) [работоспособности кластера](https://docs.microsoft.com/azure/service-fabric/service-fabric-health-introduction) будет мешать выполнению процесса. Соответственно, увеличится общее время, необходимое для исправления всего кластера.

В. **Почему некоторые обновления отображаются в результатах Центра обновления Windows, полученных через REST API, а не в журнале Центра обновлений Windows на компьютере?**

A. Сведения об обновлении некоторых продуктов отображаются только в соответствующем журнале обновлений или исправлений. Например, сведения об обновлении Защитника Windows могут не отображаться в журнале Центра обновлений Windows в Windows Server 2016.

В. **Можно ли с помощью приложения для управления исправлениями решать проблемы в кластере для разработки (кластер с одним узлом)?**

A. Нет. С помощью приложения для управления исправлениями проблемы в кластере с одним узлом решить нельзя. Это ограничение сделано намеренно, так как [системные службы Service Fabric](https://docs.microsoft.com/azure/service-fabric/service-fabric-technical-overview#system-services) или приложения клиента будут простаивать, поэтому диспетчер никогда не утвердит любое задание восстановления и последующее внесение исправлений.

В. **Разделы справки обновления узлов кластера в Linux?**

A. См. статью [Автоматическое обновление образа ОС в масштабируемом наборе виртуальных машин Azure](https://docs.microsoft.com/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade) для оркестрации обновлений в Linux.

Вопрос.**почему цикл обновления занимает настолько много времени?**

A. Запросите результат JSON, затем выполните запись цикла обновления для всех узлов, а затем попытайтесь узнать время, затрачиваемое на установку обновлений на каждом узле с помощью Оператионстарттиме и Оператионтиме (Оператионкомплетионтиме). Если было открыто большое окно времени, в котором не было обновлений, это может быть вызвано тем, что кластер находился в состоянии ошибки, и из-за того, что Диспетчер восстановления не утвердил какие-либо другие задачи восстановления ВЕХ. Если установка обновления на любом узле заняла много времени, возможно, этот узел не обновлялся долго, а некоторые обновления ожидают установки, что заняло времени. Также может быть случай, когда установка исправлений на узле блокируется из-за того, что узел зависает в состоянии отключения, что обычно происходит потому, что отключение узла может привести к возникновению проблем с кворумом или потерей данных.

В. **Зачем нужно отключать узел при установке исправления ВЕХ?**

A. Приложение для управления исправлениями отключает узел с намерением "перезапуска", который останавливает или перераспределяет все службы Service Fabric, запущенные на узле. Это делается для того, чтобы приложения не могли использовать сочетание новых и старых библиотек DLL, поэтому не рекомендуется вносить исправления в узел, не отключая его.

## <a name="disclaimers"></a>Заявления об отказе от ответственности

- Приложение для управления исправлениями принимает условия лицензионного соглашения Центра обновления Windows от имени пользователя. При необходимости этот параметр можно отключить в конфигурации приложения.

- Приложение для управления исправлениями собирает данные телеметрии для отслеживания использования и производительности. Телеметрия приложения выполняется в соответствии с настройкой телеметрии в среде выполнения Service Fabric (которая включена по умолчанию).

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="a-node-is-not-coming-back-to-up-state"></a>Узел не возвращается в рабочее состояние

**Возможная причина, по которой узел остался в отключенном состоянии**

Проверка безопасности находится в состоянии ожидания. В этом случае необходимо убедиться, что достаточное количество узлов находятся в работоспособном состоянии.

**Возможная причина, по которой узел остался в отключенном состоянии**

- Узел был отключен вручную.
- Узел был отключен из-за текущего задания инфраструктуры Azure.
- Узел был временно отключен приложением для управления исправлениями для исправления узла.

**Возможная причина, по которой узел остался в отключенном состоянии**

- Узел был переведен в неработоспособное состояние вручную.
- Узел находится в режиме перезапуска (который может быть инициирован приложением для управления исправлениями).
- Узел не работает из-за неисправности виртуальной машины, компьютера или проблем с подключением.

### <a name="updates-were-skipped-on-some-nodes"></a>Обновления на некоторых узлах пропущены

Приложение управления исправлениями пытается установить обновление Windows согласно политике перепланирования. Служба пытается восстановить узел и пропустить обновление в соответствии с политикой приложения.

В этом случае для службы агента узла будет создан отчет о работоспособности уровня предупреждения. Результат обновления Windows также содержит возможные причины сбоя.

### <a name="the-health-of-the-cluster-goes-to-error-while-the-update-installs"></a>При установке обновления кластер перешел в неработоспособное состояние

Некорректное обновление Windows может привести к потере работоспособности приложения или кластера в определенном узле или домене обновления. Приложение для управления исправлениями останавливает любые последующие операции обновления Windows, пока работоспособность кластера не восстановится.

Администратор должен определить, почему обновление Windows приводит к ухудшению работоспособности приложения или кластера.

## <a name="release-notes"></a>Заметки о выпуске

>[!NOTE]
> Начиная с версии 1.4.0, заметки о выпуске и выпуски можно найти на [странице](https://github.com/microsoft/Service-Fabric-POA/releases/)выпуска GitHub.

### <a name="version-110"></a>Версия 1.1.0
- Общедоступный выпуск

### <a name="version-111"></a>Версии 1.1.1
- Исправлена ошибка в SetupEntryPoint службы агента узла, которая препятствовала установке службы NTService агента узла.

### <a name="version-120"></a>Версии 1.2.0

- Исправлены ошибки, связанные с рабочим процессом перезапуска системы.
- Исправлена ошибка при создании задач службы управления правами, из-за которой проверка работоспособности не выполнялась должным образом во время подготовки задач восстановления.
- Режим автоматического запуска службы POANodeSvc для Windows изменен на отложенный автоматический запуск.

### <a name="version-121"></a>Версия 1.2.1

- Исправлены ошибки в рабочем процессе уменьшения масштаба кластера. Добавлена логика сборки мусора для задач восстановления POA, относящихся к несуществующим узлам.

### <a name="version-122"></a>Версия 1.2.2

- Прочие исправления ошибок.
- Теперь двоичные файлы подписаны.
- Добавлена ссылка на sfpkg для приложения.

### <a name="version-130"></a>Версия 1.3.0

- Заданное параметру InstallWindowsOSOnlyUpdates значение false теперь устанавливает все доступные обновления.
- Изменена логика отключения автоматических обновлений. Благодаря этому ошибка, когда автоматические обновления не были отключены на Server 2016 и более поздних версий, была исправлена.
- Параметризованное ограничение размещения как для микрослужб ВЕХ, так и для расширенных вариантов использования.

### <a name="version-131"></a>Версия 1.3.1
- Исправление регрессии: POA 1.3.0 не работал в пакете Windows Server 2012 R2 или более низкой версии из-за сбоя при отключении автоматических обновлений. 
- Исправлена ошибка, при которой для конфигурации InstallWindowsOSOnlyUpdates всегда выбирается значение True.
- Значения по умолчанию InstallWindowsOSOnlyUpdates изменилось на False.

### <a name="version-132"></a>Версия 1.3.2
- Устранение проблемы, которая повлияла на жизненный цикл исправления на узле, в случае наличия узлов с именем, которое является подмножеством имени текущего узла. Для таких узлов, возможно, пропущено исправление или ожидается перезагрузка. 
