---
title: Удаление типа узла в Azure Service Fabric | Документация Майкрософт
description: Узнайте, как удалить тип узла из кластера Service Fabric, работающего в Azure.
author: inputoutputcode
manager: sridmad
ms.topic: conceptual
ms.date: 02/21/2020
ms.author: chrpap
ms.openlocfilehash: 330b455a61c45ccdb59e5aef8162fd1b04859a00
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78969402"
---
# <a name="how-to-remove-a-service-fabric-node-type"></a>Как удалить тип узла узлов Service Fabric
В этой статье описывается, как масштабировать кластер Azure Service Fabric путем удаления существующего типа узла из кластера. Кластер Service Fabric — это подключенный к сети набор виртуальных машин или физических компьютеров, в котором вы развертываете микрослужбы и управляете ими. Компьютер или виртуальная машина, которая входит в состав кластера. Масштабируемые наборы виртуальных машин относятся к вычислительным ресурсам Azure. Их можно использовать для развертывания коллекции виртуальных машин и управления ею как набором. Каждый тип узла, определенный в кластере Azure, [настроен как отдельный масштабируемый набор](service-fabric-cluster-nodetypes.md). Затем каждым типом узла можно управлять отдельно. После создания кластера Service Fabric вы можете масштабировать кластер по горизонтали, удалив тип узла (масштабируемый набор виртуальных машин) и все его узлы.  Кластер можно масштабировать в любое время, даже когда в нем выполняются рабочие нагрузки.  Вместе с кластером автоматически масштабируются ваши приложения.

> [!WARNING]
> Использование этого подхода для удаления типа узла из производственного кластера не рекомендуется часто использовать. Это опасная команда, так как она удаляет ресурс масштабируемого набора виртуальных машин, связанный с типом узла. 

## <a name="durability-characteristics"></a>Характеристики устойчивости
Безопасность приоритеты над скоростью при использовании Удалить-AzServiceFabricNodeType. Тип узла должен иметь [уровень устойчивости](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster) Silver или Gold по следующим причинам:
- Уровень Bronze не дает никаких гарантий в отношении сохранении сведений о состоянии.
- В рамках устойчивости уровня Silver и Gold перехватываются любые изменения в масштабируемом наборе.
- Уровень Gold также позволяет контролировать обновления Azure для нижестоящего масштабируемого набора.

Service Fabric "координирует" базовые изменения и обновления, поэтому данные не теряются. Однако при удалении типа узлов с бронзовой прочностью вы можете потерять информацию о состоянии. Если вы удаляете основной тип узла и приложение является апоссом, бронза является приемлемой. При выполнении рабочих нагрузок с отслеживанием состояния в рабочей среде минимальной конфигурацией должен быть уровень Silver. Аналогичным образом для рабочих сценариев тип первичного узла всегда должен быть уровня Silver или Gold.

### <a name="more-about-bronze-durability"></a>Сведения об устойчивости Bronze

При удалении типа узла Bronze все узлы этого типа сразу же выходят из строя. Service Fabric не перехватывает обновления масштабируемого набора для узлов Bronze, поэтому все виртуальные машины сразу же выходят из строя. Если у вас есть какой-либо объект с отслеживанием состояния на этих узлах, данные будут потеряны. Теперь, даже если вы использовали объекты без отслеживания состояния, все узлы в Service Fabric входят в кольцевую топологию, поэтому все окружение может быть потеряно, что может нарушить работу самого кластера.

## <a name="remove-a-node-type"></a>Удаление типа узла

1. Пожалуйста, позаботьтесь об этом предварительных требованиях, прежде чем начать процесс.

    - Кластер здоров.
    - После удаления типа узла, например, будет по-прежнему достаточная емкость. количество узлов для размещения необходимого количества реплик.

2. Переместите все службы, которые имеют ограничения на размещение, чтобы использовать тип узла от типа узла.

    - Изменение приложения / Service Manifest, чтобы больше не ссылаться на тип узла.
    - Развертывание изменений.

    Затем проверьте, что:
    - Все службы, измененные выше, больше не работают на уде, принадлежащем типу узла.
    - Все услуги здоровы.

3. Отметьте тип узла как неосновной (Skip для непервичных типов узлов)

    - Найдите шаблон управления ресурсами Azure, используемый для развертывания.
    - Найдите раздел, относящихся к типу узла, в разделе Service Fabric.
    - Изменение являетсяпервичным свойством для ложного. Не удаляйте раздел, относящихся к типу узла в этой задаче.
    - Развертывание модифицированного шаблона управления ресурсами Azure. В зависимости от конфигурации кластера этот шаг может занять некоторое время.
    
    Затем проверьте, что:
    - Раздел Сервисной ткани в Портале указывает на готовность кластера.
    - Кластер здоров.
    - Ни один из узлов, относящихся к типу узла, не помечен как Семенный узлы.

4. Отсутчиваемые данные для типа узла.

    Подключитесь к кластеру с помощью PowerShell, а затем запустите следующий шаг.
    
    ```powershell
    $nodeType = "" # specify the name of node type
    $nodes = Get-ServiceFabricNode
    
    foreach($node in $nodes)
    {
      if ($node.NodeType -eq $nodeType)
      {
        $node.NodeName
     
        Disable-ServiceFabricNode -Intent RemoveNode -NodeName $node.NodeName -Force
      }
    }
    ```

    - Для бронзовой прочности, ждать все узлы, чтобы добраться до состояния инвалидов
    - Для серебра и золота прочность, некоторые узлы будут идти в инвалидов, а остальные будут в отключении состоянии. Проверьте детали вкладки узлов в состоянии отключения, если все они застряли на обеспечении кворума для разделов служб инфраструктуры, то можно безопасно продолжать.

5. Остановка данных для типа узла.

    Подключитесь к кластеру с помощью PowerShell, а затем запустите следующий шаг.
    
    ```powershell
    foreach($node in $nodes)
    {
      if ($node.NodeType -eq $nodeType)
      {
        $node.NodeName
     
        Start-ServiceFabricNodeTransition -Stop -OperationId (New-Guid) -NodeInstanceId $node.NodeInstanceId -NodeName $node.NodeName -StopDurationInSeconds 10000
      }
    }
    ```
    
    Подождите, пока все узлы типа узлов будут помечены вниз.
    
6. Удалите данные для типа узла.

    Подключитесь к кластеру с помощью PowerShell, а затем запустите следующий шаг.
    
    ```powershell
    foreach($node in $nodes)
    {
      if ($node.NodeType -eq $nodeType)
      {
        $node.NodeName
     
        Remove-ServiceFabricNodeState -NodeName $node.NodeName -Force
      }
    }
    ```

    Подождите, пока все узлы будут удалены из кластера. Узлы не должны отображаться в SFX.

7. Удалите тип узла из раздела Service Fabric.

    - Найдите шаблон управления ресурсами Azure, используемый для развертывания.
    - Найдите раздел, относящихся к типу узла, в разделе Service Fabric.
    - Удалите раздел, соответствующий типу узла.
    - Только для кластеров Silver и более высокой прочности обновите кластерный ресурс в шаблоне `applicationDeltaHealthPolicies` и `properties` назначайте политики работоспособности, чтобы игнорировать ткань:/System-системное состояние приложений, добавляя в кластерный ресурс, приведенный ниже. Ниже приведенная ниже политика должна игнорировать существующие ошибки, но не допускать новых ошибок работоспособности. 
 
 
     ```json
    "upgradeDescription":  
    { 
      "forceRestart": false, 
      "upgradeReplicaSetCheckTimeout": "10675199.02:48:05.4775807", 
      "healthCheckWaitDuration": "00:05:00", 
      "healthCheckStableDuration": "00:05:00", 
      "healthCheckRetryTimeout": "00:45:00", 
      "upgradeTimeout": "12:00:00", 
      "upgradeDomainTimeout": "02:00:00", 
      "healthPolicy": { 
        "maxPercentUnhealthyNodes": 100, 
        "maxPercentUnhealthyApplications": 100 
      }, 
      "deltaHealthPolicy":  
      { 
        "maxPercentDeltaUnhealthyNodes": 0, 
        "maxPercentUpgradeDomainDeltaUnhealthyNodes": 0, 
        "maxPercentDeltaUnhealthyApplications": 0, 
        "applicationDeltaHealthPolicies":  
        { 
            "fabric:/System":  
            { 
                "defaultServiceTypeDeltaHealthPolicy":  
                { 
                        "maxPercentDeltaUnhealthyServices": 0 
                } 
            } 
        } 
      } 
    },
    ```

    - Развертывание модифицированного шаблона управления ресурсами Azure. Этот шаг займет некоторое время, обычно до двух часов. Это обновление изменит настройки инфраструктуры, поэтому требуется перезагрузка узлов. В этом `forceRestart` случае игнорируется. 
    Параметр `upgradeReplicaSetCheckTimeout` определяет максимальное время ожидания раздела, если не уже в безопасном состоянии. Как только проверки безопасности проходят для всех разделов на узлах, Service Fabric продолжает обновление на этом уде.
    Значение для параметра `upgradeTimeout` может быть уменьшено до 6 часов, но для максимальной безопасности должны быть использованы 12 часов.

    Затем проверьте, что:
    - Сервис Fabric Resource на портале показывает готовность.

8. Удалите все ссылки на ресурсы, относящиеся к типу узла.

    - Найдите шаблон управления ресурсами Azure, используемый для развертывания.
    - Удалите из шаблона набор виртуальной шкалы машин и другие ресурсы, связанные с типом узла.
    - Разверните изменения.

    Затем сделайте следующее:
    - Подождите завершения развертывания.

## <a name="next-steps"></a>Дальнейшие действия
- Дополнительные сведения о [характеристиках устойчивости](https://docs.microsoft.com/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster) кластера.
- Дополнительные сведения о [типах узлов и масштабируемых наборах виртуальных машин](service-fabric-cluster-nodetypes.md).
- Дополнительные сведения о [масштабировании кластеров Service Fabric](service-fabric-cluster-scaling.md).
