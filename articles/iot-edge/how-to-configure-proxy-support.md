---
title: Настройка устройства для прокси-серверов сети — Azure IoT Edge | Документация Майкрософт
description: Сведения о настройке среды выполнения Azure IoT Edge и модулей IoT Edge с подключением к Интернету для обмена данными через прокси-сервер.
author: kgremban
ms.author: kgremban
ms.date: 3/10/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: amqp
ms.openlocfilehash: 270e6a0173ed0088ff5d37c989947f5272634200
ms.sourcegitcommit: acb82fc770128234f2e9222939826e3ade3a2a28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81687198"
---
# <a name="configure-an-iot-edge-device-to-communicate-through-a-proxy-server"></a>Настройка устройства IoT Edge для обмена данными через прокси-сервер

Устройства IoT Edge отправляют HTTPS-запросы для обмена данными с центром IoT. Если устройство подключено к сети, которая использует прокси-сервер, необходимо настроить среду выполнения IoT Edge для обмена данными через сервер. Прокси-серверы могут также влиять на отдельные модули IoT Edge, если они отправляют HTTP- или HTTPS-запросы, которые невозможно направить через центр IoT Edge.

В этой статье будут приведены следующие четыре шага для настройки, а затем управления устройством IoT Edge за прокси-сервером:

1. **Установка среды выполнения IoT Edge на устройстве.**

   Скрипты установки IoT Edge вытягивали пакеты и файлы из Интернета, поэтому для этого устройства необходимо общаться через прокси-сервер. Для получения подробных шагов смотрите [установку времени выполнения через раздел прокси](#install-the-runtime-through-a-proxy) этой статьи. Для устройств Windows скрипт установки также предоставляет опцию установки в [автономном режиме.](how-to-install-iot-edge-windows.md#offline-or-specific-version-installation)

   Этот шаг представляет собой одноразовый процесс, выполняемый на устройстве IoT Edge при его первом настройке. Те же соединения также требуются при обновлении времени выполнения IoT Edge.

2. **Навлажив адемон Docker daemon и Daemon IoT Edge на вашем устройстве.**

   IoT Edge использует два daemons на устройстве, оба из которых необходимо сделать веб-запросы через прокси-сервер. Daemon IoT Edge отвечает за связь с IoT Hub. Moby daemon отвечает за управление контейнерами, поэтому общается с контейнерными реестрами. Для получения подробных шагов [см.](#configure-the-daemons)

   Этот шаг представляет собой одноразовый процесс, выполняемый на устройстве IoT Edge при его первом настройке.

3. **Наверстируйте свойства агента IoT Edge в файле config.yaml на устройстве.**

   На начальном этапе IoT Edge daemon запускает модуль edgeAgent, но затем модуль edgeAgent отвечает за извлечение манифеста развертывания из Концентратора IoT и запуск всех других модулей. Для того, чтобы агент IoT Edge получил начальное подключение к концентратору IoT, назначайте переменные среды модуля edgeAgent вручную на самом устройстве. После первоначального подключения можно настроить модуль edgeAgent удаленно. Подробные шаги можно найти в разделе [«Настройка агента IoT Edge»](#configure-the-iot-edge-agent) в этой статье.

   Этот шаг представляет собой одноразовый процесс, выполняемый на устройстве IoT Edge при его первом настройке.

4. **Для всех будущих развертываний модулей установите переменные среды для любого модуля, взаимодействующем через прокси-**

   После настройки устройства IoT Edge и подключения к IoT Hub через прокси-сервер необходимо поддерживать подключение во всех будущих развертываниях модулей. Для подробных шагов смотрите раздел [развертывания настройки](#configure-deployment-manifests) в этой статье.

   Этот шаг является непрерывным процессом, выполняемым удаленно, так что каждый новый модуль или обновление развертывания поддерживает способность устройства общаться через прокси-сервер.

## <a name="know-your-proxy-url"></a>Узнайте URL-адрес своего прокси-сервера

Прежде чем приступить к любому из шагов в этой статье, необходимо знать ваш прокси URL.

URL-адрес прокси-сервера имеет такой формат: **протокол**://**узел прокси-сервера**:**порт прокси-сервера**.

* Используется **протокол** HTTP или HTTPS. Докер daemon может использовать любой протокол, в зависимости от настроек реестра контейнеров, но IoT Edge daemon и контейнеры времени выполнения всегда должны использовать HTTP для подключения к прокси.

* **Узел прокси-сервера** — это адрес прокси-сервера. Если ваш прокси-сервер требует проверки подлинности, вы можете предоставить свои учетные данные в составе прокси-хостинга со следующим форматом: **пользователь:****пароль**\@**proxy_host**.

* **Порт прокси-сервера** — это сетевой порт, по которому прокси-сервер отвечает на сетевой трафик.

## <a name="install-the-runtime-through-a-proxy"></a>Установка времени выполнения через прокси

Независимо от того, работает ли устройство IoT Edge на Windows или Linux, необходимо получить доступ к пакетам установки через прокси-сервер. В зависимости от операционной системы выполните шаги по установке времени выполнения IoT Edge через прокси-сервер.

### <a name="linux-devices"></a>Устройства Linux

При установке среды выполнения IoT Edge на устройстве Linux настройте в диспетчере пакетов прохождение через прокси-сервер для доступа к пакету установки. Например, [настройте apt-get для использования прокси-сервера HTTP](https://help.ubuntu.com/community/AptGet/Howto/#Setting_up_apt-get_to_use_a_http-proxy). После настройки менеджера пакетов следуйте инструкциям по [установке Azure IoT Edge на Linux,](how-to-install-iot-edge-linux.md) как обычно.

### <a name="windows-devices"></a>Устройства Windows

Если вы устанавливаете время выполнения IoT Edge на устройстве Windows, вам нужно пройти через прокси-сервер дважды. Первое соединение загружает файл скрипта установки, а второе соединение во время установки загружает необходимые компоненты. Вы можете настроить информацию о прокси-серверах в настройках Windows или включить информацию о прокси-серверах непосредственно в команды PowerShell.

Следующие шаги демонстрируют пример установки `-proxy` окон с использованием аргумента:

1. Команде Invoke-WebRequest нужна прокси-информация для доступа к скрипту установки. Затем команде Deploy-IoTEdge нужна информация о прокси-серверах для загрузки файлов установки.

   ```powershell
   . {Invoke-WebRequest -proxy <proxy URL> -useb aka.ms/iotedge-win} | Invoke-Expression; Deploy-IoTEdge -proxy <proxy URL>
   ```

2. Команде Initialize-IoTEdge не нужно проходить через прокси-сервер, поэтому для второго шага требуется только информация о прокси-сервере для Invoke-WebRequest.

   ```powershell
   . {Invoke-WebRequest -proxy <proxy URL> -useb aka.ms/iotedge-win} | Invoke-Expression; Initialize-IoTEdge
   ```

Если для прокси-сервера применяются сложные учетные данные, которые невозможно добавить в URL-адрес, используйте параметр `-ProxyCredential` в `-InvokeWebRequestParameters`. Например,

```powershell
$proxyCredential = (Get-Credential).GetNetworkCredential()
. {Invoke-WebRequest -proxy <proxy URL> -ProxyCredential $proxyCredential -useb aka.ms/iotedge-win} | Invoke-Expression; `
Deploy-IoTEdge -InvokeWebRequestParameters @{ '-Proxy' = '<proxy URL>'; '-ProxyCredential' = $proxyCredential }
```

Дополнительные сведения о параметрах прокси-сервера см. в статье [Invoke-WebRequest](https://docs.microsoft.com/powershell/module/microsoft.powershell.utility/invoke-webrequest). Для получения дополнительной информации о вариантах установки Windows, включая установку в автономном режиме, [см.](how-to-install-iot-edge-windows.md)

## <a name="configure-the-daemons"></a>Настройка управляющих программ

IoT Edge опирается на два демона, работающих на устройстве IoT Edge. Moby daemon делает веб-запросы, чтобы вытащить контейнерные изображения из контейнерных реестров. Управляющая программа IoT Edge отправляет HTTPS-запросы для обмена данными с центром IoT.

Для использования прокси-сервера для текущей функциональности устройства необходимо настроить moby и IoT Edge daemons. Этот шаг происходит на устройстве IoT Edge во время первоначальной настройки устройства.

### <a name="moby-daemon"></a>Моби Демон

Так как Moby построен на Docker, обратитесь к документации Docker для настройки Moby daemon с переменными среды. Большинство реестров контейнеров (включая DockerHub и реестры контейнеров Azure) поддерживают HTTPS-запросы, поэтому необходимо задать параметр **HTTPS_PROXY**. Если вы извлекаете образы из реестра, который не поддерживает протокол TLS, необходимо задать параметр **HTTP_PROXY**.

Выберите статью, которая применяется к вашей операционной системе устройства IoT Edge:

* [Настройка Докер-демон на Linux](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy) Moby daemon на устройствах Linux сохраняет название Docker.
* [Настройка Докер-демон на Windows](https://docs.microsoft.com/virtualization/windowscontainers/manage-docker/configure-docker-daemon#proxy-configuration) Moby daemon на устройствах Windows называется iotedge-moby. Имена разные, потому что можно запустить как Docker Desktop и Moby параллельно на устройстве Windows.

### <a name="iot-edge-daemon"></a>Управляющая программа IoT Edge

Daemon IoT Edge настроен по аналогии с Moby daemon. Создайте переменную среды для службы, выполнив указанные ниже действия с учетом своей операционной системы.

Daemon IoT Edge всегда использует HTTPS для отправки запросов в Концентратор IoT.

#### <a name="linux"></a>Linux

Откройте редактор в терминале, чтобы настроить управляющую программу IoT Edge.

```bash
sudo systemctl edit iotedge
```

Введите следующий текст, заменив ** \<URL-адрес прокси->** с вашим адресом прокси-сервера и портом. Сохранитесь и закройте редактор.

```ini
[Service]
Environment="https_proxy=<proxy URL>"
```

Обновите диспетчер служб, чтобы получить новую конфигурацию для IoT Edge.

```bash
sudo systemctl daemon-reload
```

Перезапустите IoT Edge, чтобы изменения вступили в силу.

```bash
sudo systemctl restart iotedge
```

Убедитесь, что переменная среды была создана, а новая конфигурация загружена.

```bash
systemctl show --property=Environment iotedge
```

#### <a name="windows"></a>Windows

Откройте окно PowerShell от имени администратора и выполните следующую команду, чтобы внести изменения в реестр с помощью новой переменной среды. Замените>** \<прокси-сервера** адресом и портовым прокси-сервера.

```powershell
reg add HKLM\SYSTEM\CurrentControlSet\Services\iotedge /v Environment /t REG_MULTI_SZ /d https_proxy=<proxy URL>
```

Перезапустите IoT Edge, чтобы изменения вступили в силу.

```powershell
Restart-Service iotedge
```

## <a name="configure-the-iot-edge-agent"></a>Настройка агента IoT Edge

Агент IoT Edge — это первый модуль, который нужно запустить на любом устройстве IoT Edge. Впервые он запускается с учетом данных, указанных в файле IoT Edge config.yaml. Затем агент Edge подключается к Центру Интернета вещей для получения манифестов развертывания и таким образом сообщает, что на устройстве можно развертывать и другие модули.

Этот шаг происходит один раз на устройстве IoT Edge во время первоначальной настройки устройства.

1. Откройте файл config.yaml на устройстве IoT Edge. В системах Linux он находится в папке **/etc/iotedge/config.yaml**. В системах Windows он находится в папке **C:\ProgramData\iotedge\config.yaml**. Файл конфигурации защищен, поэтому для доступа к этому файлу требуются права администратора. В системах Linux `sudo` используйте команду перед открытием файла в предпочитаемом текстовом редакторе. В Windows откройте текстовый редактор, такой как Блокнот в качестве администратора, а затем откройте файл.

2. В файле config.yaml найдите раздел **Edge Agent module spec**. Определение агента IoT Edge включает параметр **env**, в который можно добавить переменные среды.

3. Удалите фигурные скобки, которые служат заменителями для параметра env, и добавьте новую переменную в новой строке. Помните, что отступы в YAML составляют два пробела.

   ```yaml
   https_proxy: "<proxy URL>"
   ```

4. По умолчанию среда выполнения IoT Edge использует AMQP для обмена данными с центром IoT. Некоторые прокси-серверы блокируют порты AMQP. Если это так, настройте edgeAgent на использование протокола AMQP через WebSocket. Добавьте вторую переменную среды.

   ```yaml
   UpstreamProtocol: "AmqpWs"
   ```

   ![Определение edgeAgent с переменными среды](./media/how-to-configure-proxy-support/edgeagent-edited.png)

5. Сохраните изменения в файле config.yaml и закройте редактор. Перезапустите IoT Edge, чтобы изменения вступили в силу.

   * Linux:

      ```bash
      sudo systemctl restart iotedge
      ```

   * Windows:

      ```powershell
      Restart-Service iotedge
      ```

## <a name="configure-deployment-manifests"></a>Настройка манифестов развертывания  

После настройки устройства IoT Edge для работы с прокси-сервером необходимо продолжать декларировать HTTPS_PROXY переменную среды в будущих манифестах развертывания. Отредактировать манифесты развертывания можно либо с помощью мастера портала Azure, либо путем редактирования файла JSON.

Всегда настраивайте два модуля среды выполнения, edgeAgent и edgeHub, для связи через прокси-сервер, чтобы они могли поддерживать соединение с Центром Интернета вещей. Если вы удалите информацию о прокси-сервере из модуля edgeAgent, единственным способом восстановить соединение является редактирование файла config.yaml на устройстве, как описано в предыдущем разделе.

В дополнение к модулям edgeAgent и edgeHub, другим модулям может понадобиться конфигурация прокси. Это модули, которые помимо концентратора IoT должны иметь доступ к ресурсам Azure, например, к хранилищу капли, и должны иметь HTTPS_PROXY переменную, указанную для этого модуля в файле манифеста развертывания.

Следующая процедура применяется в течение всего срока службы устройства IoT Edge.

### <a name="azure-portal"></a>Портал Azure

Когда вы создаете развертывания для устройств IoT Edge с помощью мастера **Настройка модулей**, каждый модуль включает раздел **Переменные среды**, который можно использовать для настройки подключений прокси-сервера.

Для настройки агента IoT Edge и концентраторных модулей IoT Edge выберите **настройки Runtime** на первом этапе мастера.

![Настройка дополнительных параметров среды выполнения Edge](./media/how-to-configure-proxy-support/configure-runtime.png)

Добавьте переменную среды **https_proxy** и в агент IoT Edge, и в определения модуля центра IoT Edge. Если вы добавили переменную среды **UpstreamProtocol** в файл config.yaml на устройстве IoT Edge, добавьте ее также в определение модуля агента IoT Edge.

![Задание переменной среды https_proxy](./media/how-to-configure-proxy-support/edgehub-environmentvar.png)

Все остальные модули, добавляемые в манифест развертывания, должны соответствовать той же схеме. Раздел переменных среды находится на странице настройки имени и изображения модуля.

### <a name="json-deployment-manifest-files"></a>Файлы манифеста развертывания JSON

Если вы создаете развертывания для устройств IoT Edge с помощью шаблонов в Visual Studio Code или путем создания JSON-файлов вручную, вы можете добавить переменные среды в определение каждого модуля напрямую.

Используйте следующий формат JSON:

```json
"env": {
    "https_proxy": {
        "value": "<proxy URL>"
    }
}
```

С переменными среды определение модуля должно выглядеть как в следующем примере центра Edge:

```json
"edgeHub": {
    "type": "docker",
    "settings": {
        "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
        "createOptions": ""
    },
    "env": {
        "https_proxy": {
            "value": "http://proxy.example.com:3128"
        }
    },
    "status": "running",
    "restartPolicy": "always"
}
```

Если вы добавили переменную среды **UpstreamProtocol** в файл config.yaml на устройстве IoT Edge, добавьте ее также в определение модуля агента IoT Edge.

```json
"env": {
    "https_proxy": {
        "value": "<proxy URL>"
    },
    "UpstreamProtocol": {
        "value": "AmqpWs"
    }
}
```

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о ролях см. в статье о [среде выполнения IoT Edge](iot-edge-runtime.md).

Информацию об устранении ошибок при установке и настройке см. в статье [Распространенные проблемы и их решения для Azure IoT Edge](troubleshoot.md).
