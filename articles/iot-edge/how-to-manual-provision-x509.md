---
title: Подготавливается с помощью сертификатов X. 509 — Azure IoT Edge | Документация Майкрософт
description: После установки подготавливает устройство IoT Edge с сертификатами удостоверений устройств и проверяйте подлинность в центре Интернета вещей.
author: kgremban
manager: philmea
ms.reviewer: veyalla
ms.service: iot-edge
services: iot-edge
ms.topic: conceptual
ms.date: 10/06/2020
ms.author: kgremban
ms.openlocfilehash: b1aa12bd73772b5d6332a36d749ec4d7d10d4026
ms.sourcegitcommit: 2e72661f4853cd42bb4f0b2ded4271b22dc10a52
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92048191"
---
# <a name="set-up-an-azure-iot-edge-device-with-x509-certificate-authentication"></a>Настройка Azure IoT Edge устройства с проверкой подлинности на сертификате X. 509

В этой статье описаны действия по регистрации нового устройства IoT Edge в центре Интернета вещей и настройке устройства для проверки подлинности с помощью сертификатов X. 509.

Действия, описанные в этой статье, описывают процесс, называемый ручной подготовкой, где каждое устройство подключается к центру Интернета вещей вручную. Альтернативой является автоматическая подготовка с помощью службы подготовки устройств для центра Интернета вещей, которая полезна при наличии множества устройств для подготовки.

<!--TODO: Add auto-provision info/links-->

Для подготовки вручную можно использовать два варианта проверки подлинности IoT Edge устройств:

* **Симметричный ключ**. при создании нового удостоверения устройства в центре Интернета вещей служба создает два ключа. Вы помещаете один ключ на устройство и предоставляете ключ в центре Интернета вещей при проверке подлинности.

  Этот метод проверки подлинности быстрее приступит к работе, но не защищен.

* **Самозаверяющий сертификат x. 509**. вы создаете два сертификата удостоверения x. 509 и размещайте их на устройстве. При создании нового удостоверения устройства в центре Интернета вещей вы предоставляете отпечатки обоих сертификатов. Когда устройство проходит проверку подлинности в центре Интернета вещей, оно представляет сертификаты, а центр Интернета вещей может проверить, соответствуют ли они отпечатки.

  Этот метод проверки подлинности более безопасен и рекомендуется для рабочих сценариев.

В этой статье рассматривается процесс регистрации и подготовки с использованием проверки подлинности на основе сертификата X. 509. Если вы хотите узнать, как настроить устройство с симметричными ключами, см. статью [настройка Azure IOT Edge устройства с проверкой подлинности с помощью симметричного ключа](how-to-manual-provision-symmetric-key.md).

## <a name="prerequisites"></a>Предварительные требования

Перед выполнением действий, описанных в этой статье, необходимо установить устройство с установленной средой выполнения IoT Edge. В противном случае выполните действия, описанные в разделе [Установка или удаление среды выполнения Azure IOT Edge](how-to-install-iot-edge.md).

Подготовка вручную с сертификатами X. 509 требует IoT Edge версии 1.0.10 или более поздней.

## <a name="create-certificates-and-thumbprints"></a>Создание сертификатов и отпечатков



<!-- TODO -->

## <a name="register-a-new-device"></a>Регистрация нового устройства

Каждое устройство, которое подключается к центру Интернета вещей, имеет идентификатор устройства, который используется для мониторинга обмена данными между облако-устройством или устройством и облаком. Вы настраиваете устройство, используя сведения о его подключении, включая имя узла центра Интернета вещей, идентификатор устройства и сведения, используемые устройством для проверки подлинности в центре Интернета вещей.

Для проверки подлинности сертификата X. 509 эти сведения предоставляются в виде *отпечатков* , полученных из сертификатов удостоверений устройств. Эти отпечатки передаются в центр Интернета вещей во время регистрации устройства, чтобы служба могла распознать устройство при подключении.

Вы можете использовать несколько средств для регистрации нового устройства IoT Edge в центре Интернета вещей и отправки его отпечатков сертификатов. 

# <a name="portal"></a>[Портал](#tab/azure-portal)

### <a name="prerequisites-for-the-azure-portal"></a>Необходимые условия для использования портала Azure

[Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) (бесплатно или уровня "Стандартный") в подписке Azure.

### <a name="create-an-iot-edge-device-in-the-azure-portal"></a>Создание устройства IoT Edge на портале Azure

В центре Интернета вещей на портале Azure устройства IoT Edge создаются и администрируются независимо от других устройств Интернета вещей, не поддерживающих IoT Edge.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.

1. В левой области выберите **IOT Edge** в меню, а затем выберите **Добавить устройство IOT Edge**.

   ![Добавление устройства IoT Edge из портал Azure](./media/how-to-manual-provision-symmetric-key/portal-add-iot-edge-device.png)

1. На странице **Создание устройства** укажите следующие сведения.

   * Создайте описательный идентификатор устройства. Запишите этот идентификатор устройства, так как он будет использоваться в следующем разделе.
   * В качестве типа проверки подлинности выберите **самозаверяющий сертификат X.509**.
   * Укажите отпечатки первичного и вторичного сертификата удостоверения. Значения отпечатков — это 40-шестнадцатеричные символы для хэшей SHA-1 или 64-шестнадцатеричных символов для хэшей SHA-256.

1. Щелкните **Сохранить**.

### <a name="view-iot-edge-devices-in-the-azure-portal"></a>Просмотр устройств IoT Edge на портале Azure

Все устройства IoT Edge, подключенные к Центру Интернета вещей, перечислены на странице **IoT Edge**.

![Просмотр списка всех устройств IoT Edge в центре Интернета вещей](./media/how-to-manual-provision-symmetric-key/portal-view-devices.png)

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

### <a name="prerequisites-for-the-azure-cli"></a>Необходимые условия для использования Azure CLI

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure.
* [Интерфейс командной строки Azure](/cli/azure/install-azure-cli) в вашей среде. Вам понадобится как минимум Azure CLI версии 2.0.70 или более поздней. Для проверки используйте `az --version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack.
* [Расширение Интернета вещей для Azure CLI](https://github.com/Azure/azure-iot-cli-extension).

### <a name="create-an-iot-edge-device-with-the-azure-cli"></a>Создание устройства IoT Edge с помощью Azure CLI

Для создания нового удостоверения устройства в центре Интернета вещей используйте команду [az iot hub device-identity create](/cli/azure/ext/azure-iot/iot/hub/device-identity#ext-azure-iot-az-iot-hub-device-identity-create). Пример:

   ```azurecli
   az iot hub device-identity create --device-id [device id] --hub-name [hub name] --edge-enabled --auth-method x509_thumbprint --primary-thumbprint [SHA thumbprint] --secondary-thumbprint [SHA thumbprint]
   ```

Эта команда включает несколько параметров:

* `--device-id` или `-d` укажите описательное имя, уникальное для центра Интернета вещей. Запишите этот идентификатор устройства, так как он будет использоваться в следующем разделе.
* `hub-name` или `-n` Укажите имя центра Интернета вещей.
* `--edge-enabled` или `--ee` . Объявите, что устройство является устройством IOT Edge.
* `--auth-method` или `--am` . Объявите тип авторизации, который будет использоваться устройством. В этом случае мы используем отпечатки сертификата X. 509.
* `--primary-thumbprint` или `--ptp` : укажите отпечаток сертификата X. 509 для использования в качестве первичного ключа.
* `--secondary-thumbprint` или `--stp` : укажите отпечаток сертификата X. 509 для использования в качестве вторичного ключа.

### <a name="view-iot-edge-devices-with-the-azure-cli"></a>Просмотр устройств IoT Edge в Azure CLI

Для просмотра всех устройств в центре Интернета вещей используйте команду [az iot hub device-identity list](/cli/azure/ext/azure-iot/iot/hub/device-identity#ext-azure-iot-az-iot-hub-device-identity-list). Пример:

   ```azurecli
   az iot hub device-identity list --hub-name [hub name]
   ```

Добавьте флаг `--edge-enabled` или `--ee` , чтобы вывести список только IOT Edge устройств в центре Интернета вещей.

Для всех устройств, зарегистрированных в качестве устройства IoT Edge, свойство **capabilities.iotEdge** будет иметь значение **true**.

--- 

## <a name="configure-an-iot-edge-device"></a>Настройка устройства IoT Edge

После того как устройство IoT Edge будет иметь удостоверение в центре Интернета вещей, необходимо настроить устройство, используя его удостоверение облака, а также сертификаты удостоверений.

На устройстве Linux эти сведения предоставляются путем редактирования файла config. YAML. На устройстве Windows вы предоставляете эти сведения, выполняя сценарий PowerShell.

# <a name="linux"></a>[Linux](#tab/linux)

1. На IoT Edge устройстве откройте файл конфигурации.

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

1. Найдите раздел конфигурации подготовки файла. 

1. Закомментируйте **конфигурацию подготовки вручную с помощью раздела строки подключения** .

1. Раскомментируйте **конфигурацию подготовки вручную с помощью раздела сертификат удостоверения X. 509** . Убедитесь, что **Подготовка:** строка не имеет предшествующих пробелов, а вложенные элементы имеют отступ в два пробела.

   ```yml
   # Manual provisioning configuration using a connection string
   provisioning:
     source: "manual"
     authentication:
       method: "x509"
       iothub_hostname: "<REQUIRED IOTHUB HOSTNAME>"
       device_id: "<REQUIRED DEVICE ID PROVISIONED IN IOTHUB>"
       identity_cert: "<REQUIRED URI TO DEVICE IDENTITY CERTIFICATE>"
       identity_pk: "<REQUIRED URI TO DEVICE IDENTITY PRIVATE KEY>"
     dynamic_reprovisioning: false
   ```

1. Обновите следующие поля:

   * **iothub_hostname**: имя узла центра Интернета вещей, к которому будет подключено устройство. Например, `{IoT hub name}.azure-devices.net`.
   * **DEVICE_ID**— идентификатор, указанный при регистрации устройства.
   * **identity_cert**: универсальный код ресурса (URI) для сертификата удостоверения на устройстве. Например, `file:///path/identity_certificate.pem`.
   * **identity_pk**: URI файла закрытого ключа для предоставленного сертификата удостоверения. Например, `file:///path/identity_key.pem`.

1. Сохраните файл и закройте его.

   `CTRL + X`, `Y`, `Enter`

1. Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

   ```bash
   sudo systemctl restart iotedge
   ```

# <a name="windows"></a>[Windows](#tab/windows)

1. На IoT Edge устройстве запустите PowerShell от имени администратора.

2. Используйте команду [Initialize-IoTEdge](reference-windows-scripts.md#initialize-iotedge) , чтобы настроить среду выполнения IOT EDGE на компьютере.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Initialize-IoTEdge -ManualX509
   ```

   * Если вы используете контейнеры Linux, добавьте `-ContainerOs` параметр к флагу. Следует согласовать с выбранным параметром контейнера с `Deploy-IoTEdge` командой, которая была выполнена ранее.

      ```powershell
      . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
      Initialize-IoTEdge -ManualX509 -ContainerOs Linux
      ```

   * Если вы загрузили сценарий IoTEdgeSecurityDaemon.ps1 на устройство для автономной или определенной установки версии, обязательно сослаться на локальную копию скрипта.

      ```powershell
      . <path>/IoTEdgeSecurityDaemon.ps1
      Initialize-IoTEdge -ManualX509
      ```

3. При появлении запроса введите следующие сведения:

   * **IotHubHostName**: имя узла центра Интернета вещей, к которому будет подключено устройство. Например, `{IoT hub name}.azure-devices.net`.
   * **DeviceID**— идентификатор, указанный при регистрации устройства.
   * **X509IdentityCertificate**: абсолютный путь к сертификату удостоверения на устройстве. Например, `C:\path\identity_certificate.pem`.
   * **X509IdentityPrivateKey**: абсолютный путь к файлу закрытого ключа для предоставленного сертификата удостоверения. Например, `C:\path\identity_key.pem`.

При подготовке устройства вручную можно использовать дополнительные параметры для изменения процесса, включая:

* Направить трафик через прокси-сервер.
* Объявите конкретный образ контейнера edgeAgent и укажите учетные данные, если они находятся в частном реестре

Дополнительные сведения об этих дополнительных параметрах см. [в статье сценарии PowerShell для IOT EDGE в Windows](reference-windows-scripts.md).

---

[!INCLUDE [Verify and troubleshoot installation](../../includes/iot-edge-verify-troubleshoot-install.md)]

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте [развертывать модули IOT Edge](how-to-deploy-modules-portal.md) , чтобы узнать, как развернуть модули на устройстве.