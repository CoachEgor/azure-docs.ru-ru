---
title: Аутентифицировать устройства вниз по течению - Azure IoT Edge Документы Майкрософт
description: Как проверить подлинность устройств или листовых устройств в концентратор IoT и направила их соединение через шлюзы Azure IoT Edge.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/13/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: b8db3fedc5886e86d5f49739b87b26535665bdbc
ms.sourcegitcommit: 0553a8b2f255184d544ab231b231f45caf7bbbb0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2020
ms.locfileid: "80389330"
---
# <a name="authenticate-a-downstream-device-to-azure-iot-hub"></a>Аутентификация подчиненного устройства в Центре Интернета вещей

В прозрачном сценарии шлюза устройствам вниз по течению (иногда называемым устройствам листа или детским устройствам) нужны идентификаторы в IoT Hub, как и любое другое устройство. В этой статье рассматриваются варианты проверки подлинности устройства ниже по течению к концентратору IoT, а затем демонстрируется, как объявить соединение шлюза.

Существует три общих шага для создания успешного прозрачного подключения шлюза. Эта статья охватывает второй шаг:

1. Устройство шлюза должно быть в состоянии безопасно подключаться к устройствам, расположенным ниже по течению, получать сообщения с устройств вниз по течению и направлять сообщения в нужное место назначения. Для получения дополнительной информации [см.](how-to-create-transparent-gateway.md)
2. **Устройство ниже по течению должно иметь идентификатор устройства, чтобы иметь возможность аутентифицировать с Помощью IoT Hub, и знать, общаться через его устройство шлюза.**
3. Устройство ниже по течению должно безопасно подключиться к устройству шлюза. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).

Устройства вниз по течению могут аутентифицироваться с помощью IoT Hub с помощью одного из трех методов: симметричные клавиши (иногда называемые общими ключами доступа), сертификаты X.509, самоподписанные сертификаты, или X.509 сертификат аттестата (CA) подписали сертификаты. Шаги проверки подлинности аналогичны шагам, используемым для настройки любого устройства, не относядав IoT-Edge, с небольшими различиями для объявления связи шлюза.

На шагах в этой статье показана ручная подготовка устройств, а не автоматическая подготовка с помощью Службы обеспечения устройств Azure IoT (DPS). Подготовка устройств вниз по течению с помощью DPS не поддерживается.

## <a name="prerequisites"></a>Предварительные требования

Завершите этапы настройки [устройства IoT Edge, чтобы действовать как прозрачный шлюз.](how-to-create-transparent-gateway.md) Если вы используете x.509 проверки подлинности для устройства ниже по течению, вам нужно использовать тот же скрипт создания сертификата, который вы создали в прозрачной статье шлюза.

Эта статья относится к *названию шлюза* в нескольких точках. Имя шлюза объявлено в параметре **хоста** в файле config.yaml на устройстве шлюза IoT Edge. Это упоминается в строке соединения устройства вниз по течению. Имя хоста шлюза должно быть разрешимо для IP-адреса, либо с помощью DNS, либо с помощью ввода файла хоста.

## <a name="register-device-symmetric-key"></a>Регистрационное устройство (симметричный ключ)

Симметричная проверка подлинности ключей, или общая аутентификация ключа доступа, является самым простым способом проверки подлинности с помощью IoT Hub. При симметричной аутентификации ключей ключ 64-й ключ связан с идентификатором устройства IoT в IoT Hub. Этот ключ включите в свои приложения IoT, чтобы устройство мог представить его при подключении к Концентратору IoT.

### <a name="create-the-device-identity"></a>Создание итогового устройства

Добавьте новое устройство IoT в концентратор IoT, используя либо портал Azure, CLI Azure, либо расширение IoT для Visual Studio Code. Помните, что устройства, расположенные ниже по течению, должны быть идентифицированы в Концентраторе IoT как обычные устройства IoT, а не устройства IoT Edge.

При создании нового удостоверения устройства предоставьте следующую информацию:

* Создайте идентификатор для вашего устройства.

* Выберите **симметричный ключ** в качестве типа проверки подлинности.

* Дополнительно выберите **установку родительского устройства** и выберите устройство шлюза IoT Edge, через которое будет подключено это устройство ниже по течению. Этот шаг не является обязательным для симметричной проверки подлинности ключей, но рекомендуется, потому что установка родительского устройства позволяет [автономные возможности](offline-capabilities.md) для вашего устройства ниже по течению. Вы всегда можете обновить детали устройства, чтобы добавить или изменить родителей позже.

   ![Создание идентификатора устройства с симметричным ключом auth на портале](./media/how-to-authenticate-downstream-device/symmetric-key-portal.png)

Для выполнения той же операции можно использовать [расширение IoT для Azure CLI.](https://github.com/Azure/azure-iot-cli-extension) Следующий пример создает новое ioT-устройство с симметричной аутентификацией ключа и назначает родительское устройство:

```cli
az iot hub device-identity create -n {iothub name} -d {new device ID} --pd {existing gateway device ID}
```

Для получения дополнительной информации о командах Azure CLI для создания [az iot hub device-identity](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) устройств и управления родительскими/детскими ресурсами см.


Затем [извилите и измените строку соединения](#retrieve-and-modify-connection-string) так, чтобы устройство знало, что подключиться через шлюз.

## <a name="register-device-x509-self-signed"></a>Регистрационное устройство (X.509 самоподписанный)

Для самоподписной аутентификации X.509, которую иногда называют аутентификацией отпечатков пальцев, необходимо создать новые сертификаты для размещения на устройстве IoT. Эти сертификаты имеют отпечаток пальца в них, что вы разделяете с IoT концентратор для проверки подлинности.

Если у вас нет сертификата для создания сертификатов X.509, можно [создать демо-сертификаты для тестирования функций устройства IoT Edge.](how-to-create-test-certificates.md) При создании тестовых сертификатов для устройства ниже по течению используйте тот же корневой сертификат CA, который генерировал сертификаты для вашего устройства шлюза.

1. Используя сертификат CA, создайте два сертификата устройства (первичные и вторичные) для устройства ниже по течению.

   Сертификат устройства должен иметь набор "Имя объекта" в идентификатор устройства, который вы будете использовать при регистрации устройства IoT в концентраторе Azure IoT. Эта настройка необходима для проверки подлинности.

2. Извилисайте отпечаток SHA1 (называемый отпечаток пальца в интерфейсе IoT Hub) из каждого сертификата, который представляет собой строку 40 гексадецимальных символов. Используйте следующую команду openssl для просмотра сертификата и поиска отпечатков пальцев:

   ```PowerShell/bash
   openssl x509 -in <primary device certificate>.cert.pem -text -fingerprint | sed 's/[:]//g'
   ```

   Запустите эту команду дважды, один раз для основного сертификата и один раз для вторичного сертификата. Вы предоставляете отпечатки пальцев для обоих сертификатов при регистрации нового устройства IoT с помощью самоподписанных сертификатов X.509.

3. Перейдите к концентратору IoT на портале Azure и создайте новую идентификацию устройства IoT со следующими значениями:

   * Предоставьте **идентификатор устройства,** который соответствует названию сертификатов устройства.
   * Выберите **X.509 Self-Signed** в качестве типа проверки подлинности.
   * Вставьте гексадецичные строки, которые вы скопировали из первичных и вторичных сертификатов вашего устройства.
   * Выберите **«Установить родительское устройство»** и выбрать устройство шлюза IoT Edge, через которое будет подключено это устройство ниже по течению. Для проверки подлинности устройства X.509 требуется родительское устройство.

   ![Создание идентификатора устройства с самим самоподписанным Auth X.509 на портале](./media/how-to-authenticate-downstream-device/x509-self-signed-portal.png)

4. Копируйте сертификат устройства и ключи к любому местоположению на устройстве ниже по течению. Также переместите копию общего сертификата CA корневого, который генерировал как сертификат шлюза, так и сертификаты устройства ниже по течению.

   Вы будете ссылаться на эти файлы в приложениях устройств листа, которые подключаются к Концентратору IoT. Для перемещения файлов сертификатов можно использовать службу, например [Azure Key Vault,](https://docs.microsoft.com/azure/key-vault) или функцию, например [протокол «Безопасный копий».](https://www.ssh.com/ssh/scp/)

5. В зависимости от предпочтительного языка просмотрите примеры того, как сертификаты X.509 могут быть отожут в приложениях IoT:

   * С: [Настройка безопасности X.509 в концентраторе Azure IoT](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates)
   * C: [iotedge_downstream_device_sample](https://github.com/Azure/azure-iot-sdk-c/tree/x509_edge_bugbash/iothub_client/samples/iotedge_downstream_device_sample)
   * Node.js: [simple_sample_device_x509.js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509.java](https://github.com/Azure/azure-iot-sdk-python/blob/master/device/samples/iothub_client_sample_x509.py)
   * Python: [send_message_x509.py](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/advanced-hub-scenarios/send_message_x509.py)

Для выполнения той же операции создания устройства можно использовать [расширение IoT для Azure CLI.](https://github.com/Azure/azure-iot-cli-extension) Следующий пример создает новое ioT-устройство с самоподписной аутентификацией X.509 и назначает родительское устройство:

```cli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_thumbprint --ptp {primary thumbprint} --stp {secondary thumbprint}
```

Для получения дополнительной информации о командах Azure CLI для создания устройств, создания [az iot hub device-identity](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) сертификатов, а также управления родительскими и детскими ресурсами см.

Затем [извилите и измените строку соединения](#retrieve-and-modify-connection-string) так, чтобы устройство знало, что подключиться через шлюз.

## <a name="register-device-x509-ca-signed"></a>Регистрационное устройство (подписано X.509 CA)

Для получения сертификата X.509 (CA), подписанного в области проверки подлинности, нужен сертификат корневого CA, зарегистрированный в Концентраторе IoT, который используется для подписания сертификатов для вашего устройства IoT. Любому устройству, используюму сертификат, который был выдавлен сертификатом root CA или любым из его промежуточных сертификатов, будет разрешено проверить подлинность.

Этот раздел основан на инструкциях, подробно описанных в статье IoT Hub [Set up X.509 security в вашем концентраторе Azure IoT.](../iot-hub/iot-hub-security-x509-get-started.md) Выполните действия в этом разделе, чтобы узнать, какие значения использовать для настройки устройства ниже по течению, которое подключается через шлюз.

Если у вас нет сертификата для создания сертификатов X.509, можно [создать демо-сертификаты для тестирования функций устройства IoT Edge.](how-to-create-test-certificates.md) При создании тестовых сертификатов для устройства ниже по течению используйте тот же корневой сертификат CA, который генерировал сертификаты для вашего устройства шлюза.

1. Следуйте инструкциям в [сертификатах Register X.509 CA в разделе концентратора IoT,](../iot-hub/iot-hub-security-x509-get-started.md#register-x509-ca-certificates-to-your-iot-hub) настроенный на безопасность *X.509 в концентраторе Azure IoT.* В этом разделе вы выполняете следующие действия:

   1. Загрузите сертификат root CA. Если вы используете демо-сертификаты, корень CA является ** \<путь> / сертификаты / azure-iot-тест-только.root.cert.pem**.

   2. Убедитесь, что у вас есть сертификат root CA.

2. Следуйте инструкциям в [устройстве X.509 для концентратора IoT,](../iot-hub/iot-hub-security-x509-get-started.md#create-an-x509-device-for-your-iot-hub) настроенной на *безопасность X.509 в концентраторе Azure IoT.* В этом разделе вы выполняете следующие действия:

   1. Добавьте новое устройство. Укажите имя нижнего регистра для **идентификатора устройства**и выберите тип проверки подлинности **X.509 CA Signed.**
   2. Установите родительское устройство. Для устройств ниже по течению выберите **родительское устройство** и выберите устройство шлюза IoT Edge, которое обеспечит подключение к IoT Hub.

3. Создайте цепочку сертификатов для устройства ниже по течению. Используйте тот же корневой сертификат CA, который вы загрузили в IoT Hub, чтобы сделать эту цепочку. Используйте тот же идентификатор устройства нижнего регистра, который вы дали идентификации устройства на портале.

4. Копируйте сертификат устройства и ключи к любому местоположению на устройстве ниже по течению. Также переместите копию общего сертификата CA корневого, который генерировал как сертификат шлюза, так и сертификаты устройства ниже по течению.

   Вы будете ссылаться на эти файлы в приложениях устройств листа, которые подключаются к Концентратору IoT. Для перемещения файлов сертификатов можно использовать службу, например [Azure Key Vault,](https://docs.microsoft.com/azure/key-vault) или функцию, например [протокол «Безопасный копий».](https://www.ssh.com/ssh/scp/)

5. В зависимости от предпочтительного языка просмотрите примеры того, как сертификаты X.509 могут быть отожут в приложениях IoT:

   * С: [Настройка безопасности X.509 в концентраторе Azure IoT](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates)
   * C: [iotedge_downstream_device_sample.c](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples/iotedge_downstream_device_sample)
   * Node.js: [simple_sample_device_x509.js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509.java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples/send-event-x509)
   * Python: [send_message_x509.py](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/async-hub-scenarios/send_message_x509.py)

Для выполнения той же операции создания устройства можно использовать [расширение IoT для Azure CLI.](https://github.com/Azure/azure-iot-cli-extension) Следующий пример создает новое ioT-устройство с подписью X.509 CA и назначает родительское устройство:

```cli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_ca
```

Для получения дополнительной информации смотрите справочное содержимое Azure CLI для команд идентификации [устройства-идентификации концентратора az iot.](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest)

Затем [извилите и измените строку соединения](#retrieve-and-modify-connection-string) так, чтобы устройство знало, что подключиться через шлюз.

## <a name="retrieve-and-modify-connection-string"></a>Извлечение и изменение строки соединения

После создания идентификационного устройства IoT на портале можно получить его основные или вторичные ключи. Один из этих ключей должен быть включен в строку соединения, которую приложения используют для связи с IoT Hub. Для симметричной проверки подлинности ключей, IoT Концентратор обеспечивает полностью сформированную строку соединения в деталях устройства для вашего удобства. Необходимо добавить дополнительную информацию об устройстве шлюза в строку подключения.

Строки подключения для устройств ниже по течению нуждаются в следующих компонентах:

* Концентратор IoT, к которому подключено устройство:`Hostname={iothub name}.azure-devices.net`
* Идентификатор устройства, зарегистрированный в концентраторе:`DeviceID={device ID}`
* Либо первичный, либо вторичный ключ:`SharedAccessKey={key}`
* Устройство шлюза, через которое подключается устройство. Укажите значение **хостатизного имени** из файла конфигурации устройства IoT Edge:`GatewayHostName={gateway hostname}`

Все вместе, полная строка соединения выглядит следующим образом:

```
HostName=myiothub.azure-devices.net;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz;GatewayHostName=myGatewayDevice
```

Если вы установили отношения между родителями и детьми для этого устройства ниже по течению, то вы можете упростить строку соединения, позвонив шлюзу непосредственно в качестве ведущего соединения. Отношения между родителями и детьми необходимы для проверки подлинности X.509, но необязательны для симметричной проверки подлинности ключа. Пример:

```
HostName=myGatewayDevice;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz
```

На этом этапе необходимо зарегистрировать и настроить устройство IoT Edge в качестве шлюза. У вас также есть ниже по течению IoT устройство зарегистрировано и указывая на его шлюз устройства. Последним шагом является раздеветь сертификаты на устройстве ниже по течению, чтобы оно могли безопасно подключиться к шлюзу.

Продолжить следующую статью в серии шлюзов, [Подключите устройство вниз по течению к шлюзу Azure IoT Edge.](how-to-connect-downstream-device.md)

## <a name="next-steps"></a>Дальнейшие действия

Заполнив эту статью, вы должны иметь устройство IoT Edge, работающее как прозрачный шлюз, и устройство вниз по течению, зарегистрированное в концентраторе IoT. Далее необходимо настроить устройства ниже по течению, чтобы доверять устройству шлюза и безопасно подключиться к нему. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).
