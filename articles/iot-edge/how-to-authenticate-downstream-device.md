---
title: Проверка подлинности для подчиненных устройств — Azure IoT Edge | Документация Майкрософт
description: Проверка подлинности подчиненных устройств или конечных устройств в центре Интернета вещей и маршрутизация их подключения с помощью шлюзов Azure IoT Edge.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/13/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 3edd29703f74c7671537fbcf08159dd830e5453c
ms.sourcegitcommit: 6fd8dbeee587fd7633571dfea46424f3c7e65169
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2020
ms.locfileid: "83726232"
---
# <a name="authenticate-a-downstream-device-to-azure-iot-hub"></a>Аутентификация подчиненного устройства в Центре Интернета вещей

В сценарии с прозрачным шлюзом подчиненные устройства (иногда называемые конечными или дочерними устройствами) должны иметь удостоверения в центре Интернета вещей, как и все остальные устройства. В этой статье рассматриваются варианты проверки подлинности подчиненного устройства в центре Интернета вещей, а также показано, как объявляется подключение к шлюзу.

Для настройки успешного подключения к прозрачному шлюзу необходимо выполнить три шага. Эта статья посвящена второму шагу.

1. Шлюз должен иметь возможность безопасно подключаться к подчиненным устройствам, обмениваться данными с подчиненными устройствами и маршрутизировать сообщения в соответствующее назначение. Дополнительные сведения см. в разделе [Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md).
2. **Подчиненное устройство должно иметь удостоверение устройства, чтобы иметь возможность проходить проверку подлинности в центре Интернета вещей и обмениваться данными через его шлюз.**
3. Подчиненное устройство должно безопасно подключаться к шлюзу. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).

Подчиненные устройства могут проходить проверку подлинности в центре Интернета вещей одним из трех способов: ключи содержимого (иногда называемые общими ключами доступа), самозаверяющие сертификаты X.509 или сертификаты X.509 (CA), подписанные центром сертификации. Шаги проверки подлинности аналогичны шагам, используемым для настройки любого устройства не из IoT Edge с помощью центра Интернета вещей, с единственным исключением: требуется объявление отношения шлюза.

Действия, описанные в этой статье, предполагают подготовку устройств вручную, а не автоматическую подготовку с помощью службы подготовки устройств к добавлению в центр Интернета вещей Azure (DPS). Подготовка подчиненных устройств с помощью DPS не поддерживается.

## <a name="prerequisites"></a>Предварительные требования

Выполните шаги, описанные в разделе [Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md). Если вы используете проверку подлинности X.509 для подчиненного устройства, необходимо использовать тот же сценарий создания сертификата, который описывается в статье о прозрачных шлюзах.

В этой статье *имя узла шлюза* упоминается в нескольких контекстах. Имя узла шлюза объявляется в параметре **hostname** файла config.yaml на устройстве шлюза IoT Edge. Он также упоминается в строке подключения подчиненного устройства. Имя узла шлюза должно разрешаться в IP-адрес с использованием DNS или записи файла узла.

## <a name="register-device-symmetric-key"></a>Регистрация устройства (ключ содержимого)

Проверка подлинности с использованием ключа содержимого или ключа общего доступа является самым простым способом проверки подлинности в центре Интернета вещей. Если используется проверка подлинности с использованием ключа содержимого, ключ Base64 связывается с идентификатором устройства IoT в центре Интернета вещей. Этот ключ необходимо добавить в приложения IoT, чтобы устройство указывало его при подключении к центру Интернета вещей.

### <a name="create-the-device-identity"></a>Создание удостоверения устройства

Добавьте новое устройство IoT в центр Интернета вещей, используя портал Azure, Azure CLI или расширение IoT для Visual Studio Code. Помните, что подчиненные устройства должны идентифицироваться в центре Интернета вещей как обычные устройства IoT, а не устройства IoT Edge.

При создании нового удостоверения устройства укажите следующие сведения.

* Создайте идентификатор для устройства.

* В качестве типа проверки подлинности выберите **Ключ содержимого**.

* При необходимости выберите **Задать родительское устройство** и выберите шлюз IoT Edge, посредством которого будет подключаться это подчиненное устройство. Этот шаг является необязательным для проверки подлинности с ключом содержимого, однако его рекомендуется выполнить, поскольку настройка родительского устройства включает [возможности автономной работы](offline-capabilities.md) для подчиненного устройства. Вы можете в любой момент обновить сведения об устройстве, чтобы добавить или изменить родительское устройство позднее.

   ![Создание идентификатора устройства с проверкой подлинности на основе ключа содержимого на портале](./media/how-to-authenticate-downstream-device/symmetric-key-portal.png)

Для выполнения той же операции можно использовать [расширение IoT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension). В следующем примере показано создание нового устройства IoT с проверкой подлинности на основе ключа содержимого и назначение родительского устройства:

```cli
az iot hub device-identity create -n {iothub name} -d {new device ID} --pd {existing gateway device ID}
```

Дополнительные сведения о командах Azure CLI для создания устройств и управления родительскими и дочерними устройствами см. в справке по командам [az iot hub device-identity](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/hub/device-identity?view=azure-cli-latest).


Затем [получите и измените строку подключения](#retrieve-and-modify-connection-string), чтобы сообщить устройству о необходимости подключаться через этот шлюз.

## <a name="register-device-x509-self-signed"></a>Регистрация устройства (самозаверяющий сертификат X.509)

Для проверки подлинности на основе самозаверяющего сертификата X.509 (иногда называется проверкой подлинности на основе отпечатков) необходимо создать новые сертификаты, которые размещаются на устройстве IoT. Эти сертификаты имеют отпечаток, который указывается в центре Интернета вещей для проверки подлинности.

Если у вас нет центра сертификации для создания сертификатов X.509, вы можете [создать демонстрационные сертификаты для тестирования функций устройств IoT Edge](how-to-create-test-certificates.md). При создании тестовых сертификатов для подчиненного устройства используется сертификат того же корневого ЦС, который создал сертификаты для шлюза.

1. Используя сертификат ЦС, создайте два сертификата устройства (основной и дополнительный) для подчиненного устройства.

   В сертификате устройства должно быть задано имя субъекта, которое будет использоваться при регистрации устройства IoT в центре Интернета вещей Azure. Этот параметр требуется для проверки подлинности.

2. Получите отпечаток SHA1 (т. н. отпечаток в интерфейсе центра Интернета вещей) из каждого сертификата, который является строкой шестнадцатеричного символа 40. Используйте следующую команду OpenSSL для просмотра сертификата и поиска отпечатка:

   ```PowerShell/bash
   openssl x509 -in <primary device certificate>.cert.pem -text -fingerprint | sed 's/[:]//g'
   ```

   Выполните эту команду дважды, один раз для основного и один раз для дополнительного сертификата. Отпечатки для обоих сертификатов предоставляются при регистрации нового устройства IoT с помощью самозаверяющих сертификатов X.509.

3. Перейдите в центр Интернета вещей на портале Azure и создайте новое удостоверение устройства IoT со следующими значениями:

   * Укажите **идентификатор устройства**, соответствующий имени субъекта для сертификатов устройств.
   * В качестве типа проверки подлинности выберите **самозаверяющий сертификат X.509**.
   * Вставьте шестнадцатеричные строки, скопированные из основного и дополнительного сертификатов устройства.
   * Выберите **Задать родительское устройство** и выберите шлюз IoT Edge, посредством которого будет подключаться это подчиненное устройство. Родительское устройство необходимо для проверки подлинности подчиненного устройства на основе сертификата X.509.

   ![Создание идентификатора устройства с проверкой подлинности на основе самозаверяющего сертификата X.509 на портале](./media/how-to-authenticate-downstream-device/x509-self-signed-portal.png)

4. Скопируйте сертификат и ключи устройства в любое расположение на подчиненном устройстве. Переместите копию общего сертификата корневого ЦС, который создал сертификат устройства шлюза и подчиненные сертификаты устройства.

   Вы будете ссылаться на эти файлы в приложениях конечного устройства, которые подключаются к центру Интернета вещей. Для перемещения файлов сертификатов можно использовать службу, например [хранилище ключей Azure](https://docs.microsoft.com/azure/key-vault), или функцию, такую как [протокол защищенного копирования](https://www.ssh.com/ssh/scp/).

5. Ознакомьтесь с примерами ссылок на сертификаты X.509 в приложениях IoT в различных языках программирования.

   * C#: [Set up X.509 security in your Azure IoT hub](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates) (Настройка сертификата безопасности X.509 в Центре Интернета вещей Azure)
   * C: [iotedge_downstream_device_sample.c](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples/iotedge_downstream_device_sample)
   * Node.js: [simple_sample_device_x509.js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509.java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples/send-event-x509)
   * Python: [send_message_x509.py](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/async-hub-scenarios/send_message_x509.py)

Для выполнения той же операции по созданию устройства можно использовать [расширение IoT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension). В следующем примере показано создание нового устройства IoT с проверкой подлинности на основе самозаверяющего сертификата X.509 и назначение родительского устройства:

```cli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_thumbprint --ptp {primary thumbprint} --stp {secondary thumbprint}
```

Дополнительные сведения о командах Azure CLI для создания устройств, создания сертификатов и управления родительскими и дочерними устройствами см. в справке по командам [az iot hub device-identity](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/hub/device-identity?view=azure-cli-latest).

Затем [получите и измените строку подключения](#retrieve-and-modify-connection-string), чтобы сообщить устройству о необходимости подключаться через этот шлюз.

## <a name="register-device-x509-ca-signed"></a>Регистрация устройства (сертификат X.509, подписанный ЦС)

Для проверки подлинности на основе сертификата X.509, подписанного ЦС, требуется сертификат корневого ЦС, зарегистрированный в центре Интернета вещей, который используется для подписи сертификатов для устройства IoT. Проверка подлинности разрешена для любого устройства, использующего сертификат, который был выдан сертификатом корневого ЦС или любым из его промежуточных сертификатов.

В этом разделе приведены инструкции, описанные в статье о центре Интернета вещей [Настройка безопасности с использованием сертификата X.509 в центре Интернета вещей Azure](../iot-hub/iot-hub-security-x509-get-started.md). Выполните действия, описанные в этом разделе, чтобы определить, какие значения следует использовать для настройки подчиненного устройства, которое подключается через шлюз.

Если у вас нет центра сертификации для создания сертификатов X.509, вы можете [создать демонстрационные сертификаты для тестирования функций устройств IoT Edge](how-to-create-test-certificates.md). При создании тестовых сертификатов для подчиненного устройства используется сертификат того же корневого ЦС, который создал сертификаты для шлюза.

1. Следуйте инструкциям в разделе [Регистрация сертификатов ЦС X.509 в центре Интернета вещей](../iot-hub/iot-hub-security-x509-get-started.md#register-x509-ca-certificates-to-your-iot-hub) в статье *Настройка безопасности с использованием сертификата X.509 в центре Интернета вещей Azure*. В этом разделе описывается выполнение следующих шагов.

   1. Передача сертификата корневого ЦС. Если используются демонстрационные сертификаты, корневой ЦС имеет адрес **\<path>/certs/azure-iot-test-only.root.ca.cert.pem**.

   2. Убедитесь, что вы владеете сертификатом корневого ЦС.

2. Следуйте инструкциям в разделе [Создание устройства X.509 в центре Интернета вещей](../iot-hub/iot-hub-security-x509-get-started.md#create-an-x509-device-for-your-iot-hub) в статье *Настройка безопасности с использованием сертификата X.509 в центре Интернета вещей Azure*. В этом разделе описывается выполнение следующих шагов.

   1. Добавление нового устройства. Введите имя **идентификатора устройства** в нижнем регистре и выберите тип проверки подлинности **сертификат X.509, подписанный ЦС**.
   2. Указание родительского устройства. Выберите **Задать родительское устройство** и выберите шлюз IoT Edge, посредством которого будет выполняться подключение к центру Интернета вещей.

3. Создайте цепочку сертификатов для подчиненного устройства. Используйте тот же сертификат корневого ЦС, который вы передали в центр Интернета вещей для создания этой цепочки. Используйте тот идентификатор устройства в нижнем регистре, который вы присвоили удостоверению устройства на портале.

4. Скопируйте сертификат и ключи устройства в любое расположение на подчиненном устройстве. Переместите копию общего сертификата корневого ЦС, который создал сертификат устройства шлюза и подчиненные сертификаты устройства.

   Вы будете ссылаться на эти файлы в приложениях конечного устройства, которые подключаются к центру Интернета вещей. Для перемещения файлов сертификатов можно использовать службу, например [хранилище ключей Azure](https://docs.microsoft.com/azure/key-vault), или функцию, такую как [протокол защищенного копирования](https://www.ssh.com/ssh/scp/).

5. Ознакомьтесь с примерами ссылок на сертификаты X.509 в приложениях IoT в различных языках программирования.

   * C#: [Set up X.509 security in your Azure IoT hub](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates) (Настройка сертификата безопасности X.509 в Центре Интернета вещей Azure)
   * C: [iotedge_downstream_device_sample.c](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples/iotedge_downstream_device_sample)
   * Node.js: [simple_sample_device_x509.js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509.java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples/send-event-x509)
   * Python: [send_message_x509.py](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/async-hub-scenarios/send_message_x509.py)

Для выполнения той же операции по созданию устройства можно использовать [расширение IoT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension). В следующем примере показано создание нового устройства IoT с проверкой подлинности на основе сертификата X.509, подписанного ЦС, и назначение родительского устройства:

```cli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_ca
```

Дополнительные сведения см. в справке по Azure CLI для команд [az iot hub device-identity](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/hub/device-identity?view=azure-cli-latest).

Затем [получите и измените строку подключения](#retrieve-and-modify-connection-string), чтобы сообщить устройству о необходимости подключаться через этот шлюз.

## <a name="retrieve-and-modify-connection-string"></a>Получение и изменение строки подключения

После создания удостоверения устройства IoT на портале можно получить основные или дополнительные ключи. Один из этих ключей необходимо добавить в строку подключения, которую приложения используют для взаимодействия с центром Интернета вещей. Для проверки подлинности на основе ключа содержимого центр Интернета вещей предоставляет полностью сформированную строку подключения в разделе сведений об устройстве. Необходимо добавить в строку подключения дополнительные сведения о шлюзе.

Для строк подключения для подчиненных устройств требуются следующие компоненты:

* Центр Интернета вещей, к которому подключается устройство: `Hostname={iothub name}.azure-devices.net`
* Идентификатор устройства, зарегистрированный в Центре Интернета вещей: `DeviceID={device ID}`
* Основной или дополнительный ключ: `SharedAccessKey={key}`
* Шлюз, через который подключается устройство. Укажите значение параметра **hostname** из файла config.yaml для шлюза IoT Edge: `GatewayHostName={gateway hostname}`

Таким образом, полная строка подключения выглядит следующим образом:

```
HostName=myiothub.azure-devices.net;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz;GatewayHostName=myGatewayDevice
```

Если для этого подчиненного устройства установлена связь "родитель-потомок", можно упростить строку подключения, вызвав шлюз непосредственно как узел подключения. Отношение "родитель-потомок" необходимо для проверки подлинности на основе сертификата X.509, но не является обязательным для проверки подлинности с использованием ключа содержимого. Пример:

```
HostName=myGatewayDevice;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz
```

На этом этапе необходимо зарегистрировать устройство IoT Edge и настроить его в качестве шлюза. Кроме того, зарегистрировано подчиненное устройство IoT, которое указывает на шлюз. На последнем этапе выполняется размещение сертификатов на подчиненном устройстве для его безопасного подключения к шлюзу.

Перейдите к следующей статье в серии статей, посвященных шлюзам, — [Подключение подчиненного устройства к шлюзу Azure IoT Edge](how-to-connect-downstream-device.md).

## <a name="next-steps"></a>Дальнейшие действия

Инструкции, приведенные в этой статье, помогут настроить устройство IoT Edge как прозрачный шлюз и зарегистрировать подчиненное устройство в центре Интернета вещей. Далее необходимо настроить подчиненные устройства таким образом, чтобы они доверяли устройству шлюза и безопасно подключались к нему. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).
