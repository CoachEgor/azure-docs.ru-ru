---
title: Проверка подлинности подчиненных устройств — Azure IoT Edge | Документация Майкрософт
description: Проверка подлинности подчиненных устройств или конечных устройств в центре Интернета вещей и маршрутизация их подключений с помощью Azure IoT Edge устройств шлюза.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/13/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 74ef00a1b7310284c5f8c51e3c2c6685ffcd5071
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75434491"
---
# <a name="authenticate-a-downstream-device-to-azure-iot-hub"></a>Аутентификация подчиненного устройства в Центре Интернета вещей

В сценарии с прозрачным шлюзом подчиненные устройства (иногда называемые конечными устройствами или дочерними устройствами) должны иметь удостоверения в центре Интернета вещей, как и любые другие устройства. В этой статье рассматриваются варианты проверки подлинности подчиненного устройства в центре Интернета вещей, а также показано, как объявить подключение к шлюзу.

Существует три основных шага для настройки успешного подключения к прозрачному шлюзу. В этой статье рассматривается второй шаг.

1. Устройство шлюза должно иметь возможность безопасного подключения к подчиненным устройствам, получать подключения от подчиненных устройств и маршрутизировать сообщения в соответствующее место назначения. Дополнительные сведения см. [в разделе Настройка устройства IOT Edge для работы в качестве прозрачного шлюза](how-to-create-transparent-gateway.md).
2. **Подчиненное устройство должно иметь удостоверение устройства, чтобы иметь возможность проходить проверку подлинности в центре Интернета вещей и взаимодействовать через его устройство шлюза.**
3. Подчиненное устройство должно безопасно подключаться к устройству шлюза. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).

Подчиненные устройства могут проходить проверку подлинности в центре Интернета вещей одним из трех способов: симметричные ключи (иногда называемые общими ключами доступа), самозаверяющие сертификаты X. 509 или сертификаты X. 509 (CA), подписанные центром сертификации. Шаги проверки подлинности аналогичны шагам, используемым для настройки любого устройства, отличного от IoT-погранично с центром Интернета вещей, с небольшими отличиями для объявления связи шлюза.

Действия, описанные в этой статье, показывают подготовку устройств вручную, а не автоматическую подготовку с помощью службы подготовки устройств для центра Интернета вещей Azure (DPS). Подготовка подчиненных устройств с помощью DPS не поддерживается. 

## <a name="prerequisites"></a>Технические условия

Выполните действия, описанные в разделе [Настройка устройства IOT Edge для работы в качестве прозрачного шлюза](how-to-create-transparent-gateway.md). Если вы используете проверку подлинности X. 509 для подчиненного устройства, необходимо использовать тот же сценарий создания сертификата, который вы настроили в статье о прозрачном шлюзе. 

В этой статье *имя узла шлюза* содержится в нескольких точках. Имя узла шлюза объявляется в параметре **HostName** файла config. YAML на устройстве шлюза IOT Edge. Он упоминается в строке подключения подчиненного устройства. Имя узла шлюза необходимо разрешить в IP-адрес, используя DNS или запись файла узла.

## <a name="register-device-symmetric-key"></a>Регистрация устройства (симметричный ключ)

Проверка подлинности с симметричным ключом или проверка подлинности с помощью ключа общего доступа является самым простым способом проверки подлинности в центре Интернета вещей. При использовании проверки подлинности с симметричным ключом ключ Base64 связывается с ИДЕНТИФИКАТОРом устройства IoT в центре Интернета вещей. Вы включаете этот ключ в свои приложения IoT, чтобы устройство может его отображать при подключении к центру Интернета вещей. 

### <a name="create-the-device-identity"></a>Создание удостоверения устройства 

Добавьте новое устройство IoT в центр Интернета вещей, используя портал Azure, Azure CLI или расширение IoT для Visual Studio Code. Помните, что подчиненные устройства должны быть идентифицированы в центре Интернета вещей как обычные устройства IoT, а не IoT Edge устройства. 

При создании нового удостоверения устройства укажите следующие сведения. 

* Создайте идентификатор для устройства.

* Выберите **симметричный ключ** в качестве типа проверки подлинности. 

* При необходимости выберите, чтобы **задать родительское устройство** , и выберите устройство шлюза IOT EDGE, через которое будет подключаться это подчиненное устройство. Этот шаг является необязательным для проверки подлинности с симметричным ключом, но рекомендуется, потому что настройка родительского устройства включает [возможности автономного режима](offline-capabilities.md) для подчиненного устройства. Вы всегда можете обновить сведения об устройстве, чтобы добавить или изменить родительский объект позже. 

   ![Создание идентификатора устройства с проверкой подлинности симметричным ключом на портале](./media/how-to-authenticate-downstream-device/symmetric-key-portal.png)

Для выполнения той же операции можно использовать [расширение IOT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) . В следующем примере создается новое устройство IoT с проверкой подлинности симметричного ключа и назначается родительское устройство. 

```cli
az iot hub device-identity create -n {iothub name} -d {new device ID} --pd {existing gateway device ID}
```

Дополнительные сведения о Azure CLI командах для создания устройств и управления родительскими и дочерними устройствами см. в справочном материале о командах [AZ IOT для Device-Identity](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) .


Затем [Извлеките и измените строку подключения](#retrieve-and-modify-connection-string) , чтобы устройство знало подключиться через его шлюз. 

## <a name="register-device-x509-self-signed"></a>Регистрация устройства (X. 509 с собственной подписью) 

Для самостоятельно подписанной аутентификации X. 509, которая иногда называется проверкой подлинности отпечатков, необходимо создать новые сертификаты для размещения на устройстве IoT. Эти сертификаты имеют отпечаток, которые совместно используются с центром Интернета вещей для проверки подлинности. 

Если у вас нет центра сертификации для создания сертификатов X. 509, можно [создать демонстрационные сертификаты для тестирования функций устройств IOT Edge](how-to-create-test-certificates.md). При создании тестовых сертификатов для подчиненного устройства используйте тот же корневой сертификат ЦС, который создал сертификаты для устройства шлюза. 

1. Используя сертификат ЦС, создайте два сертификата устройства (первичный и вторичный) для подчиненного устройства. 

   В сертификате устройства должно быть задано имя субъекта, которое будет использоваться при регистрации устройства IoT в центре Интернета вещей Azure. Этот параметр необходим для проверки подлинности.

2. Получите отпечаток SHA1 (называемый отпечатком в интерфейсе центра Интернета вещей) из каждого сертификата, который является строкой шестнадцатеричного символа 40. Используйте следующую команду OpenSSL для просмотра сертификата и поиска отпечатка:

   ```PowerShell/bash
   openssl x509 -in <primary device certificate>.cert.pem -text -fingerprint | sed 's/[:]//g'
   ```

   Выполните эту команду дважды, один раз для основного сертификата и один раз для дополнительного сертификата. Вы предоставляете отпечатки для обоих сертификатов при регистрации нового устройства IoT с помощью самозаверяющих сертификатов X. 509. 

3. Перейдите в центр Интернета вещей на портал Azure и создайте новое удостоверение устройства IoT со следующими значениями: 

   * Укажите **идентификатор устройства** , соответствующий имени субъекта сертификатов устройств. 
   * Выберите в качестве типа проверки подлинности значение **X. 509** .
   * Вставьте шестнадцатеричные строки, скопированные из основного и дополнительного сертификатов устройства.
   * Выберите **задать родительское устройство** и выберите устройство шлюза IOT EDGE, с помощью которого будет подключаться это подчиненное устройство. Родительское устройство требуется для проверки подлинности X. 509 подчиненного устройства. 

   ![Создание идентификатора устройства с помощью самоподписанной проверки подлинности X. 509 на портале](./media/how-to-authenticate-downstream-device/x509-self-signed-portal.png)

4. Скопируйте сертификат и ключи устройства в любое расположение на подчиненном устройстве. Также переместите копию общего корневого сертификата ЦС, который создал сертификат устройства шлюза и подчиненные сертификаты устройства. 

   Вы будете ссылаться на эти файлы в приложениях конечного устройства, которые подключаются к центру Интернета вещей. Для перемещения файлов сертификатов можно использовать службу, такую как [Azure Key Vault](https://docs.microsoft.com/azure/key-vault) , или функцию, например [протокол безопасного копирования](https://www.ssh.com/ssh/scp/) .

5. В зависимости от предпочитаемого языка ознакомьтесь с примерами того, как можно ссылаться на сертификаты X. 509 в приложениях IoT: 

   * C#: [Настройка безопасности X. 509 в центре Интернета вещей Azure](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates)
   * C: [iotedge_downstream_device_sample](https://github.com/Azure/azure-iot-sdk-c/tree/x509_edge_bugbash/iothub_client/samples/iotedge_downstream_device_sample)
   * Node. js: [simple_sample_device_x509. js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509. Java](https://github.com/Azure/azure-iot-sdk-python/blob/master/device/samples/iothub_client_sample_x509.py)
   * Python: [send_message_x509. Корректировка](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/advanced-hub-scenarios/send_message_x509.py)

Вы можете использовать [расширение IOT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) для выполнения той же операции создания устройства. В следующем примере создается новое устройство Интернета вещей с собственной проверкой подлинности X. 509 и назначается родительское устройство. 

```cli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_thumbprint --ptp {primary thumbprint} --stp {secondary thumbprint}
```

Дополнительные сведения о Azure CLI командах для создания устройств, создания сертификатов, а также управления родительскими и дочерними устройствами см. в справочном материале о командах AZ IOT, посвященных [удостоверениям для центра Интернета вещей](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) .


Затем [Извлеките и измените строку подключения](#retrieve-and-modify-connection-string) , чтобы устройство знало подключиться через его шлюз. 


## <a name="register-device-x509-ca-signed"></a>Зарегистрировать устройство (сертификат X. 509)

Для проверки подлинности, подписанной центром сертификации X. 509, необходим сертификат корневого ЦС, зарегистрированный в центре Интернета вещей, который используется для подписи сертификатов для устройства IoT. Для любого устройства, использующего сертификат, который был вызван сертификатом корневого ЦС или любым из его промежуточных сертификатов, будет разрешена проверка подлинности. 

Этот раздел основан на инструкциях, описанных в статье центр Интернета вещей: [Настройка безопасности X. 509 в центре Интернета вещей Azure](../iot-hub/iot-hub-security-x509-get-started.md). Выполните действия, описанные в этом разделе, чтобы определить, какие значения следует использовать для настройки подчиненного устройства, которое подключается через шлюз. 

Если у вас нет центра сертификации для создания сертификатов X. 509, можно [создать демонстрационные сертификаты для тестирования функций устройств IOT Edge](how-to-create-test-certificates.md). При создании тестовых сертификатов для подчиненного устройства используйте тот же корневой сертификат ЦС, который создал сертификаты для устройства шлюза. 

1. Следуйте инструкциям в разделе [Регистрация сертификатов ЦС X. 509 в центре Интернета вещей](../iot-hub/iot-hub-security-x509-get-started.md#register-x509-ca-certificates-to-your-iot-hub) статьи *Настройка безопасности x. 509 в центре Интернета вещей Azure*. В этом разделе вы выполните следующие действия: 

   1. Отправьте сертификат корневого ЦС. Если вы используете демонстрационные сертификаты, корневой ЦС **\<путь >/цертс/Азуре-ИОТ-тест-Онли.Рут.ка.церт.пем**. 

   2. Убедитесь, что вы владеете сертификатом корневого ЦС.

2. Следуйте инструкциям в разделе [Создание устройства x. 509 для центра Интернета вещей](../iot-hub/iot-hub-security-x509-get-started.md#create-an-x509-device-for-your-iot-hub) статьи *Настройка безопасности x. 509 в центре Интернета вещей Azure*. В этом разделе вы выполните следующие действия: 

   1. Добавьте новое устройство. Укажите имя в нижнем регистре для **идентификатора устройства**и выберите тип проверки подлинности **X. 509, подписанный центром сертификации**. 
   2. Задайте родительское устройство. Для подчиненных устройств выберите **задать родительское устройство** и выберите устройство шлюза IOT EDGE, которое будет предоставлять подключение к центру Интернета вещей. 

3. Создайте цепочку сертификатов для подчиненного устройства. Используйте тот же корневой сертификат ЦС, который вы перегрузили в центр Интернета вещей для создания этой цепочки. Используйте тот же идентификатор устройства в нижнем регистре, который вы присвоили удостоверению устройства на портале.

4. Скопируйте сертификат и ключи устройства в любое расположение на подчиненном устройстве. Также переместите копию общего корневого сертификата ЦС, который создал сертификат устройства шлюза и подчиненные сертификаты устройства. 

   Вы будете ссылаться на эти файлы в приложениях конечного устройства, которые подключаются к центру Интернета вещей. Для перемещения файлов сертификатов можно использовать службу, такую как [Azure Key Vault](https://docs.microsoft.com/azure/key-vault) , или функцию, например [протокол безопасного копирования](https://www.ssh.com/ssh/scp/) .

5. В зависимости от предпочитаемого языка ознакомьтесь с примерами того, как можно ссылаться на сертификаты X. 509 в приложениях IoT: 

   * C#: [Настройка безопасности X. 509 в центре Интернета вещей Azure](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates)
   * C: [iotedge_downstream_device_sample](https://github.com/Azure/azure-iot-sdk-c/tree/x509_edge_bugbash/iothub_client/samples/iotedge_downstream_device_sample)
   * Node. js: [simple_sample_device_x509. js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509. Java](https://github.com/Azure/azure-iot-sdk-python/blob/master/device/samples/iothub_client_sample_x509.py)
   * Python: [send_message_x509. Корректировка](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/advanced-hub-scenarios/send_message_x509.py)

Вы можете использовать [расширение IOT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) для выполнения той же операции создания устройства. В следующем примере создается новое устройство IoT с подписанным центром сертификации X. 509 и назначается родительское устройство: 

```cli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_ca
```

Дополнительные сведения о Azure CLI командах для создания устройств и управления родительскими и дочерними устройствами см. в справочном материале о командах [AZ IOT для Device-Identity](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) .


Затем [Извлеките и измените строку подключения](#retrieve-and-modify-connection-string) , чтобы устройство знало подключиться через его шлюз. 


## <a name="retrieve-and-modify-connection-string"></a>Получение и изменение строки подключения

После создания удостоверения устройства IoT на портале можно получить первичные или вторичные ключи. Один из этих ключей должен быть включен в строку подключения, включаемую в любое приложение, которое взаимодействует с центром Интернета вещей. Для проверки подлинности с симметричным ключом центр Интернета вещей предоставляет полностью сформированную строку подключения в сведениях об устройстве для вашего удобства. Необходимо добавить дополнительные сведения об устройстве шлюза в строку подключения. 

Для строк подключения для подчиненных устройств требуются следующие компоненты: 

* Центр Интернета вещей, к которому подключается устройство: `Hostname={iothub name}.azure-devices.net`
* ИДЕНТИФИКАТОР устройства, зарегистрированный в концентраторе: `DeviceID={device ID}`
* Первичный или вторичный ключ: `SharedAccessKey={key}`
* Устройство шлюза, к которому подключается устройство. Укажите значение **имени узла** из файла config. YAML IOT Edge устройства шлюза: `GatewayHostName={gateway hostname}`

Все вместе, полная строка подключения выглядит следующим образом:

``` 
HostName=myiothub.azure-devices.net;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz;GatewayHostName=myGatewayDevice
```

Если вы установили связь "родители-потомки" для этого подчиненного устройства (требуется для проверки подлинности X. 509, но необязательно для проверки подлинности с симметричным ключом), можно упростить строку подключения, вызвав шлюз непосредственно в качестве узла подключения. Пример. 

```
HostName=myGatewayDevice;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz
```

На этом этапе необходимо зарегистрировать устройство IoT Edge и настроить его в качестве шлюза. Кроме того, зарегистрировано подчиненное устройство IoT, которое указывает на его устройство шлюза. Последним шагом является размещение сертификатов на подчиненном устройстве для безопасного подключения к шлюзу. 

Перейдите к следующей статье в серии шлюзов, [Подключите подчиненное устройство к шлюзу Azure IOT Edge](how-to-connect-downstream-device.md).


## <a name="next-steps"></a>Дальнейшие действия

Выполнив эту статью, вы должны иметь устройство IoT Edge, работающее в качестве прозрачного шлюза и подчиненного устройства, зарегистрированного в центре Интернета вещей. Далее необходимо настроить подчиненные устройства, чтобы доверять устройству шлюза и безопасно подключаться к нему. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).
