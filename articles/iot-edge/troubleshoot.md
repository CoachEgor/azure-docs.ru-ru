---
title: Устранение неполадок в Azure IoT Edge | Документация Майкрософт
description: В этой статье описаны стандартные навыки диагностики для Azure IoT Edge, такие как получение состояния компонента и журналов, а также решение распространенных проблем
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 04/21/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
ms.openlocfilehash: 2e15dffac73b4a50b1ef9288feaeb6073dea91e0
ms.sourcegitcommit: 09a124d851fbbab7bc0b14efd6ef4e0275c7ee88
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2020
ms.locfileid: "82086527"
---
# <a name="common-issues-and-resolutions-for-azure-iot-edge"></a>Распространенные проблемы и их решения для Azure IoT Edge

Если при запуске Azure IoT Edge в вашей среде возникают проблемы, используйте эту статью как руководство для устранения неполадок.

## <a name="run-the-iotedge-check-command"></a>Выполнить iotedge 'проверить' команды

Первым шагом при устранении неполадок `check` IoT Edge должно быть использование команды, которая выполняет набор тестов конфигурации и подключения для общих проблем. Команда `check` доступна в [выпуске 1.0.7](https://github.com/Azure/azure-iotedge/releases/tag/1.0.7) и позже.

Вы можете `check` запустить команду следующим образом, или включить `--help` флаг, чтобы увидеть полный список опций:

* В Linux

  ```bash
  sudo iotedge check
  ```

* В Windows:

  ```powershell
  iotedge check
  ```

Инструмент устранения неполадок выполняет множество проверок, которые сортируются по этим трем категориям:

* Проверки конфигурации: изучается детали, которые могут предотвратить подключение устройств Edge к облаку, включая проблемы с *конфигурацией* и контейнерным двигателем.
* Проверки подключения: Проверяетвремя время выполнения IoT Edge, можно получить доступ к портам на устройстве-хоста, а все компоненты IoT Edge могут подключиться к концентратору IoT.
* Проверки производственной готовности: ищет рекомендуемые рекомендации по производству, такие как состояние сертификатов устройства (CA) сертификатов (CA) сертификатов и конфигурация файла журнала модуля.

Для получения информации о каждой диагностической проверке, которую выполняет этот инструмент, включая, что делать, если вы получаете ошибку или предупреждение, смотрите [проверки устранения неполадок IoT Edge.](https://github.com/Azure/iotedge/blob/master/doc/troubleshoot-checks.md)

## <a name="gather-debug-information-with-iotedge-support-bundle-command"></a>Сбор информации об отладке с iotedge 'поддержка-связывая' команда

Когда вам нужно собрать журналы с устройства IoT Edge, наиболее `support-bundle` удобным способом является использование команды. По умолчанию эта команда собирает модуль, IoT Edge Security Manager и журналы контейнерных двигателей, выход JSON и другую полезную информацию об отладке. Он сжимает их в один файл для легкого обмена. Команда `support-bundle` доступна в [выпуске 1.0.9](https://github.com/Azure/azure-iotedge/releases/tag/1.0.9) и позже.

Запустите `support-bundle` команду `--since` с флагом, чтобы указать, как долго из прошлого вы хотите получить журналы. Например, `6h` будут получать журналы с `6d` последних 6 `6m` часов, с последних 6 дней, с последних 6 минут и так далее. Включите флаг, `--help` чтобы увидеть полный список опций.

* В Linux

  ```bash
  sudo iotedge support-bundle --since 6h
  ```

* В Windows:

  ```powershell
  iotedge support-bundle --since 6h
  ```

> [!WARNING]
> Выход из `support-bundle` команды может содержать имена хоста, устройства и модуля, информацию, зарегистрированную вашими модулями и т.д. Пожалуйста, имейте в виду это, если совместное производство в общественном форуме.

## <a name="standard-diagnostic-steps"></a>Стандартные действия диагностики

Если вы столкнулись с проблемой, вы можете узнать больше о состоянии вашего устройства IoT Edge, просмотрев журналы контейнеров и сообщения, которые передаются на устройство и из него. Для сбора сведений используйте команды и инструменты, приведенные в этом разделе.

### <a name="check-the-status-of-the-iot-edge-security-manager-and-its-logs"></a>Проверьте состояние менеджера безопасности IoT Edge и его журналы

В Linux

* Чтобы просмотреть состояние диспетчера безопасности IoT Edge, используйте следующую команду:

   ```bash
   sudo systemctl status iotedge
   ```

* Чтобы просмотреть журналы диспетчера безопасности IoT Edge, используйте следующую команду:

    ```bash
    sudo journalctl -u iotedge -f
    ```

* Чтобы просмотреть более подробные сведения журналов диспетчера безопасности IoT Edge, сделайте следующее.

  * Измените параметры управляющей программы IoT Edge:

      ```bash
      sudo systemctl edit iotedge.service
      ```

  * Обновите следующие строки:

      ```bash
      [Service]
      Environment=IOTEDGE_LOG=edgelet=debug
      ```

  * Перезапустите управляющую программу безопасности IoT Edge:

      ```bash
      sudo systemctl cat iotedge.service
      sudo systemctl daemon-reload
      sudo systemctl restart iotedge
      ```

В Windows:

* Чтобы просмотреть состояние диспетчера безопасности IoT Edge, используйте следующую команду:

   ```powershell
   Get-Service iotedge
   ```

* Чтобы просмотреть журналы диспетчера безопасности IoT Edge, используйте следующую команду:

   ```powershell
   . {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
   ```

### <a name="if-the-iot-edge-security-manager-is-not-running-verify-your-yaml-configuration-file"></a>Если диспетчер безопасности IoT Edge не запущен, проверьте YAML-файл конфигурации.

> [!WARNING]
> Файлы YAML не могут содержать вкладки в качестве отступов. Вместо этого используйте двойные пробелы. Элементы верхнего уровня не должны иметь ведущих пространств.

В Linux

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

В Windows:

   ```cmd
   notepad C:\ProgramData\iotedge\config.yaml
   ```

### <a name="check-container-logs-for-issues"></a>Проверка журналов контейнеров на наличие ошибок

После запуска управляющей программы безопасности IoT Edge проверьте журналы контейнеров на наличие ошибок. Начните с развернутых контейнеров, а затем посмотрите на контейнеры, которые составляют время выполнения IoT Edge: edgeAgent и edgeHub. В журналах агентов IoT Edge обычно предоставляется информация о жизненном цикле каждого контейнера. Концентраторные журналы IoT Edge предоставляют информацию о обмене сообщениями и реукторе.

   ```cmd
   iotedge logs <container name>
   ```

### <a name="view-the-messages-going-through-the-iot-edge-hub"></a>Просмотр сообщений, проходящих через концентратор IoT Edge

Вы можете просматривать сообщения, проходящие через концентратор IoT Edge, и собирать сведения из многословных журналов из контейнеров времени выполнения. Чтобы включить ведение подробных журналов в этих контейнерах, задайте значение `RuntimeLogLevel` в файле конфигурации YAML. Чтобы открыть этот файл, выполните следующее.

В Linux

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

В Windows:

   ```cmd
   notepad C:\ProgramData\iotedge\config.yaml
   ```

По умолчанию элемент `agent` будет выглядеть, как показано в примере ниже:

   ```yaml
   agent:
     name: edgeAgent
     type: docker
     env: {}
     config:
       image: mcr.microsoft.com/azureiotedge-agent:1.0
       auth: {}
   ```

Вместо `env: {}` вставьте следующий фрагмент:

   ```yaml
   env:
     RuntimeLogLevel: debug
   ```

   > [!WARNING]
   > YAML-файлы не могут содержать отступы в виде табуляции. Вместо этого используйте двойные пробелы. Элементы верхнего уровня не могут иметь ведущее пробел.

Сохраните файл и перезапустите диспетчер безопасности IoT Edge.

Можно также проверить сообщения, отправленные между Центром Интернета вещей и устройствами IoT Edge. Просмотр этих сообщений с помощью [расширения Azure IoT Hub для Visual Studio Code.](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit) Дополнительные сведения см. в записи блога об [удобном средстве при разработке с помощью Центра Интернета вещей Azure](https://blogs.msdn.microsoft.com/iotdev/2017/09/01/handy-tool-when-you-develop-with-azure-iot/).

### <a name="restart-containers"></a>Перезапуск контейнеров

После изучения журналов и сообщений можно попытаться перезапустить контейнеры:

```cmd
iotedge restart <container name>
```

Перезапустите контейнеры среды выполнения IoT Edge:

```cmd
iotedge restart edgeAgent && iotedge restart edgeHub
```

### <a name="restart-the-iot-edge-security-manager"></a>Перезапустите диспетчер безопасности IoT Edge:

Если проблема не исчезла, попытайтесь перезапустить диспетчер безопасности IoT Edge.

В Linux

   ```cmd
   sudo systemctl restart iotedge
   ```

В Windows:

   ```powershell
   Stop-Service iotedge -NoWait
   sleep 5
   Start-Service iotedge
   ```

## <a name="iot-edge-agent-stops-after-about-a-minute"></a>Агент IoT Edge останавливается примерно через минуту

Модуль edgeAgent запускается и успешно работает около минуты, а затем останавливается. В журналах указывается, что агент IoT Edge пытается подключиться к IoT Hub через АМЗП, а затем пытается подключиться с помощью АМЗП через WebSocket. При сбой агент IoT Edge выходит из него.

Пример журналов edgeAgent:

```output
2017-11-28 18:46:19 [INF] - Starting module management agent.
2017-11-28 18:46:19 [INF] - Version - 1.0.7516610 (03c94f85d0833a861a43c669842f0817924911d5)
2017-11-28 18:46:19 [INF] - Edge agent attempting to connect to IoT Hub via AMQP...
2017-11-28 18:46:49 [INF] - Edge agent attempting to connect to IoT Hub via AMQP over WebSocket...
```

**Причину**

Конфигурация сети в сети-хоста не позволяет агенту IoT Edge попаданию в сеть. Сначала агент пытается подключиться через AMQP (порт 5671). Если это не удается, он пытается подключиться через WebSocket (порт 443).

Среда выполнения IoT Edge настраивает сеть для всех модулей, с которыми нужно взаимодействовать. В Linux этой сетью является мостовая сеть. В Windows используется NAT. Эта проблема чаще всего встречается на устройствах с Windows, использующих контейнеры Windows с сетью NAT.

**Разрешение**

Должен быть маршрут к Интернету для IP-адресов, назначенных этой мостовой сети или сети NAT. Иногда конфигурация VPN на узле переопределяет сеть IoT Edge.

## <a name="iot-edge-hub-fails-to-start"></a>Концентратор IoT Edge не может быть запугнут

Модуль edgeHub не может начаться и печатает следующее сообщение в журналах:

```output
One or more errors occurred. 
(Docker API responded with status code=InternalServerError, response=
{\"message\":\"driver failed programming external connectivity on endpoint edgeHub (6a82e5e994bab5187939049684fb64efe07606d2bb8a4cc5655b2a9bad5f8c80): 
Error starting userland proxy: Bind for 0.0.0.0:443 failed: port is already allocated\"}\n)
```

**Причину**

На сервере связанный порт 443 используется для другого процесса. Карты концентратора IoT Edge порты 5671 и 443 для использования в сценариях шлюзов. Если с этим портом связан другой процесс, такое сопоставление портов завершается сбоем.

**Разрешение**

Найдите и остановите процесс, который использует порт 443. Таким процессом обычно является веб-сервер.

## <a name="iot-edge-agent-cant-access-a-modules-image-403"></a>Агент IoT Edge не может получить доступ к изображению модуля (403)

Контейнер не работает, а журналы edgeAgent показывают ошибку 403.

**Причину**

Агент IoT Edge не имеет разрешений на доступ к изображению модуля.

**Разрешение**

Убедитесь, что в манифесте развертывания правильно указаны учетные данные реестра.

## <a name="iot-edge-security-daemon-fails-with-an-invalid-hostname"></a>Сбой управляющей программы безопасности IoT Edge с недопустимым именем узла

Команда `sudo journalctl -u iotedge` завершается ошибкой и выводит следующее сообщение:

```output
Error parsing user input data: invalid hostname. Hostname cannot be empty or greater than 64 characters
```

**Причину**

Среда выполнения IoT Edge поддерживает только имена узлов, которые короче 64 символов. Физические компьютеры обычно не имеют длинных имен узлов. Эта ошибка более типична для виртуальных машин. Автоматически создаваемые имена узлов для виртуальных машин Windows, размещенных в Azure, часто бывают длинными.

**Разрешение**

Эту ошибку можно устранить, настроив DNS-имя виртуальной машины, а затем задав DNS-имя в качестве имени узла в команде установки.

1. На портале Azure перейдите к странице обзора виртуальной машины.
2. Выберите **Настроить** под DNS-именем. Если для виртуальной машины уже настроено DNS-имя, настраивать новое не нужно.

   ![Настройка DNS-имени виртуальной машины](./media/troubleshoot/configure-dns.png)

3. Укажите значение в поле **Метка DNS-имени** и выберите **Сохранить**.
4. Копируйте новое имя DNS, которое должно быть в формате ** \<\>DNSnamelabel\< . vmlocation\>.cloudapp.azure.com**.
5. В виртуальной машине используйте следующую команду для настройки среды выполнения IoT Edge с DNS-именем:

   * В Linux

      ```bash
      sudo nano /etc/iotedge/config.yaml
      ```

   * В Windows:

      ```cmd
      notepad C:\ProgramData\iotedge\config.yaml
      ```

## <a name="stability-issues-on-resource-constrained-devices"></a>Проблемы с надежностью на устройствах с ограниченными ресурсами

Вы можете столкнуться с нестабильной работой некоторых устройств с ограниченными ресурсами, таких как Raspberry Pi, особенно если они используются в качестве шлюза. Для такой ситуации характерны исключения с сообщением о нехватке памяти на модуле центра IoT Edge, проблемы с подключением подчиненных устройств и (или) прекращение потока телеметрии после нескольких часов работы устройства.

**Причину**

Концентратор IoT Edge, который является частью времени выполнения IoT Edge, оптимизирован для производительности по умолчанию и пытается выделить большие куски памяти. Это не идеальный вариант для устройств IoT Edge с ограниченными ресурсами, где он может привести к нестабильной работе.

**Разрешение**

Для концентратора IoT Edge установите переменную среды **OptimizeForPerformance** на **ложную.** Существует два способа настройки переменных среды:

На портале Azure выполните следующие действия.

В концентраторе IoT выберите устройство IoT Edge и страницу данных устройства и выберите **настройки Времени выполнения set Modules.** > **Runtime Settings** Создайте переменную среды для модуля Edge Hub под названием *OptimizeForPerformance,* который установлен *на ложное.*

![Задание значения false для имени OptimizeForPerformance](./media/troubleshoot/optimizeforperformance-false.png)

**Или**

Через манифест развертывания.

```json
  "edgeHub": {
    "type": "docker",
    "settings": {
      "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
      "createOptions": <snipped>
    },
    "env": {
      "OptimizeForPerformance": {
          "value": "false"
      }
    },
```

## <a name="cant-get-the-iot-edge-daemon-logs-on-windows"></a>Не удается получить журналы управляющей программы IoT Edge в Windows

Если при использовании команды `Get-WinEvent` в Windows возвращается исключение EventLogException, проверьте записи реестра.

**Причину**

Используя запись реестра, команда PowerShell `Get-WinEvent` ищет журналы по определенному имени поставщика (`ProviderName`).

**Разрешение**

Задайте запись реестра управляющей программы IoT Edge. Создайте файл **iotedge.reg** с указанным ниже содержимым и импортируйте его в реестр Windows. Для этого дважды щелкните этот файл или используйте команду `reg import iotedge.reg`.

```reg
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\EventLog\Application\iotedged]
"CustomSource"=dword:00000001
"EventMessageFile"="C:\\ProgramData\\iotedge\\iotedged.exe"
"TypesSupported"=dword:00000007
```

## <a name="iot-edge-module-fails-to-send-a-message-to-the-edgehub-with-404-error"></a>Модулю IoT Edge не удается отправить сообщение edgeHub, и возникает ошибка 404

Настраиваемому модулю IoT Edge не удается отправить сообщение в edgeHub, и возникает ошибка 404 `Module not found`. Управляющая программа IoT Edge выводит в журналы следующее сообщение:

```output
Error: Time:Thu Jun  4 19:44:58 2018 File:/usr/sdk/src/c/provisioning_client/adapters/hsm_client_http_edge.c Func:on_edge_hsm_http_recv Line:364 executing HTTP request fails, status=404, response_buffer={"message":"Module not found"}u, 04 )
```

**Причину**

Управляющая программа IoT Edge по соображениям безопасности принудительно применяет идентификацию процесса для всех модулей, подключающихся к edgeHub. Таким образом проверяется, что все сообщения, которые отправляются модулем, поступают с идентификатора основного процесса модуля. Если сообщение отправляется модулем с идентификатора процесса, отличного от первоначально установленного, такие сообщения будут отклоняться управляющей программой с ошибкой 404.

**Разрешение**

По версии 1.0.7 все процессы модуля имеют право на подключение. Если обновление до 1.0.7 невозможно, выполните следующие шаги. Для получения дополнительной информации [см.](https://github.com/Azure/iotedge/blob/master/CHANGELOG.md#iotedged-1)

Убедитесь, что для отправки сообщений в edgeHub пользовательский модуль IoT Edge всегда использует один и тот же идентификатор процесса. Например, `ENTRYPOINT` убедитесь, `CMD` что вместо команды в `CMD` файле Docker, так как приведет к одному идентификатору `ENTRYPOINT` процесса для модуля и другому идентификатору процесса для команды Bash, запускаемым основной программой, в то время как это приведет к единому идентификатору процесса.

## <a name="firewall-and-port-configuration-rules-for-iot-edge-deployment"></a>Правила конфигурации брандмауэра и порта для развертывания IoT Edge

Azure IoT Edge позволяет общаться с бортового сервера с облаком Azure с помощью поддерживаемых протоколов IoT Концентратора, [см.](../iot-hub/iot-hub-devguide-protocols.md) В целях дополнительной безопасности коммуникационные каналы между Azure IoT Edge и Центром Интернета вещей всегда настроены как исходящие. Эта конфигурация основана на [модели связи с поддержкой служб](https://blogs.msdn.microsoft.com/clemensv/2014/02/09/service-assisted-communication-for-connected-devices/), которая позволяет снизить контактную зону, изучаемую вредоносным объектом. Входящий трафик требуется только для конкретных сценариев, в которых Центр Интернета вещей отправляет сообщения на устройство Azure IoT Edge. Сообщения из облака на устройство защищаются с помощью безопасных каналов TLS и могут иметь дополнительную защиту при использовании сертификатов X.509 и модулей устройства TPM. Сведения об установке этой связи с помощью диспетчера безопасности Azure IoT Edge см. в [этой статье](../iot-edge/iot-edge-security-manager.md).

Хотя IoT Edge предоставляет улучшенную конфигурацию для обеспечения безопасности среды выполнения IoT Edge и развернутых модулей, при этом многое по-прежнему зависит от базовой конфигурации компьютера и сети. Поэтому крайне важно обеспечить надлежащие правила сети и брандмауэра для безопасного края облачной связи. Следующая таблица может быть использована в качестве ориентира при правилах настройки брандмауэра для базовых серверов, на которых размещается время выполнения Azure IoT Edge:

|Протокол|Порт|Входящие|Исходящие|Руководство|
|--|--|--|--|--|
|MQTT|8883|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|<ul> <li>Исходящие подключения должны быть открыты при использовании MQTT в качестве протокола связи.<li>IoT Edge не поддерживает порт 1883 для MQTT. <li>Входящие подключения должны быть заблокированы.</ul>|
|AMQP|5671|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|ОТКРЫТЫЕ (по умолчанию)|<ul> <li>Протокол связи по умолчанию для IoT Edge. <li> Должен быть открыт, если Azure IoT Edge не настроен для других поддерживаемых протоколов или если AMQP является требуемым протоколом связи.<li>IoT Edge не поддерживает порт 5672 для AMQP.<li>Заблокируйте этот порт, если Azure IoT Edge использует другой протокол, поддерживаемый Центром Интернета вещей.<li>Входящие подключения должны быть заблокированы.</ul></ul>|
|HTTPS|443|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|ОТКРЫТЫЕ (по умолчанию)|<ul> <li>Исходящие подключения должны быть открыты на порту 443 для подготовки IoT Edge. Эта конфигурация необходима при использовании созданных вручную сценариев или Службы подготовки устройств к добавлению в Центр Интернета вещей Azure. <li>Входящие подключения должны быть открытыми только для указанных сценариев: <ul> <li>  Если у вас есть прозрачный шлюз с конечными устройствами, которые могут отправлять запросы метода. В этом случае порт 443 не должен быть открыт во внешних сетях для подключения к Центру Интернета вещей или предоставления служб Центра Интернета вещей через Azure IoT Edge. Таким образом, правило для входящего трафика может разрешать открытие только входящего подключения из внутренней сети. <li> Для сценариев передачи данных из облака на устройство (C2D).</ul><li>IoT Edge не поддерживает порт 80 для HTTP.<li>Если на предприятии невозможно настроить протоколы, отличные от HTTP (например, AMQP или MQTT), сообщения могут отправляться через протоколы WebSocket. В этом случае для подключения по WebSocket будет использоваться порт 443.</ul>|

## <a name="edge-agent-module-continually-reports-empty-config-file-and-no-modules-start-on-the-device"></a>Модуль Edge Agent постоянно сообщает о «пустом файле конфигурации» и не запускается на устройстве

Устройство имеет проблемы с стартовыми модулями, определенными в развертывании. Только edgeAgent работает, но постоянно отчетности "пустой файл конфигурации ...".

**Причину**

По умолчанию IoT Edge запускает модули в собственной изолированной контейнерной сети. Возможно, у устройства могут возникнуть проблемы с разрешением dNS-имен в этой частной сети.

**Разрешение**

**Вариант 1: Установите DNS-сервер в настройках контейнерного двигателя**

Укажите DNS-сервер для среды в настройках контейнерного двигателя, который будет применяться ко всем контейнерным модулям, запущенным двигателем. Создайте файл `daemon.json` с указанием DNS-сервера для использования. Пример:

```json
{
    "dns": ["1.1.1.1"]
}
```

Вышеприведенный пример устанавливает DNS-сервер в общедоступную службу DNS. Если устройство края не может получить доступ к этому IP из своей среды, замените его доступным dNS-серверным адресом.

Место `daemon.json` в нужном месте для вашей платформы:

| Платформа | Расположение |
| --------- | -------- |
| Linux | `/etc/docker` |
| Хост Windows с контейнерами Windows | `C:\ProgramData\iotedge-moby\config` |

Если местоположение уже `daemon.json` содержит файл, добавьте ключ **dns** к нему и сохраните файл.

Перезапустите контейнерный движок для вхастываемого обновления.

| Платформа | Get-Help |
| --------- | -------- |
| Linux | `sudo systemctl restart docker` |
| Окна (Админ Powershell) | `Restart-Service iotedge-moby -Force` |

**Вариант 2: Установите DNS-сервер в развертывании IoT Edge на модуль**

Вы можете настроить DNS-сервер для создания каждого *модуляОпции* в развертывании IoT Edge. Пример:

```json
"createOptions": {
  "HostConfig": {
    "Dns": [
      "x.x.x.x"
    ]
  }
}
```

Не забудьте установить эту конфигурацию для *edgeAgent* и *edgeHub* модулей, а также.

## <a name="next-steps"></a>Дальнейшие действия

Считаете, что обнаружили ошибку в платформе IoT Edge? [Отправьте запрос](https://github.com/Azure/iotedge/issues), чтобы мы как можно скорее устранили неисправность.

Если у вас есть другие вопросы, создайте [запрос в службу поддержки](https://portal.azure.com/#create/Microsoft.Support) для получения справки.
