---
title: Подготовка устройств и их развертывания в рабочей среде — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как внедрить разрабатываемое решение Azure IoT Edge в рабочей среде, в том числе настроить на устройствах подходящие сертификаты и составить план развертывания будущих обновлений кода.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/28/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: c64db6b35aa2f1daa4484f137c8505b1415c5a0b
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60998461"
---
# <a name="prepare-to-deploy-your-iot-edge-solution-in-production"></a>Подготовка к развертыванию решения IoT Edge в рабочей среде

Когда вы будете готовы перейти от разработки решения IoT Edge к его развертыванию в рабочей среде, убедитесь, что оно настроено для непрерывной работы.

Не все сведения, представленные в этой статье, равноценны. Чтобы помочь вам расставить приоритеты, каждый раздел начинается со списков, разделяющих работу на две части: **важные** задачи, которые следует выполнить перед переходом в рабочую среду, и **полезные** для вас сведения.

## <a name="device-configuration"></a>Конфигурация устройств

Устройством IoT Edge может быть что угодно — от Raspberry Pi до ноутбука или виртуальной машины, работающей на сервере. У вас может быть доступ к устройству (физически или через виртуальное подключение), либо оно может быть изолировано в течение продолжительного времени. В любом случае вам нужно убедиться, что оно настроено для надлежащей работы. 

* **Важно!**
    * Установка рабочих сертификатов
    * Составление плана управления устройствами
    * Использование Moby в качестве модуля контейнеров

* **Полезное**
    * Выбор вышестоящего протокола

### <a name="install-production-certificates"></a>Установка рабочих сертификатов

На каждом устройстве IoT Edge в рабочей среде необходимо установить сертификат от центра сертификации (ЦС). Затем этот сертификат ЦС объявляется в файле config.yaml для среды выполнения IoT Edge. Чтобы упростить разработку и тестирование, среда выполнения IoT Edge создает временные сертификаты, если они не объявлены в файле config.yaml. Однако срок действия этих сертификатов истекает спустя три месяца, и они недостаточно безопасны для рабочих сценариев. 

Сведения о роли сертификатов ЦС для устройств см. в статье [Сведения об использовании сертификатов Azure IoT Edge](iot-edge-certs.md).

Дополнительные сведения о том, как устанавливать сертификаты на устройстве IoT Edge и ссылаться на них из файла config.yaml, см. в статье [Настройка устройства IoT Edge в качестве прозрачного шлюза](how-to-create-transparent-gateway.md). Инструкции по настройке сертификатов не зависят от того, будет ли устройство использоваться в качестве шлюза. В этой статье представлены скрипты для создания образцов сертификатов исключительно в целях тестирования. Не используйте эти сертификаты в рабочей среде. 

### <a name="have-a-device-management-plan"></a>Составление плана управления устройствами

Прежде чем внедрять устройство в рабочую среду, следует определить, как вы будете управлять будущими обновлениями. В случае устройства IoT Edge могут обновляться перечисленные ниже компоненты.

* Встроенное ПО устройства
* Библиотеки операционной системы
* Модуль контейнеров (например, Moby)
* Управляющая программа IoT Edge
* Сертификаты ЦС

Инструкции по обновлению управляющей программы IoT Edge см. в статье [Обновление среды выполнения IoT Edge](how-to-update-iot-edge.md). Для применения современных методик обновления управляющей программы IoT Edge требуется доступ к устройству IoT Edge (физически или по протоколу SSH). Если требуется обновить множество устройств, рекомендуем добавить в скрипт действия для обновления или использовать средство автоматизации (например, Ansible) для масштабного обновления.

### <a name="use-moby-as-the-container-engine"></a>Использование Moby в качестве модуля контейнеров

Наличие модуля контейнеров на устройстве — обязательное условие для любого устройства IoT Edge. В рабочей среде поддерживается только moby-engine. Другие модули контейнеров, например Docker, совместимы с IoT Edge, и их можно использовать при разработке. Модуль moby-engine можно распространять при использовании с Azure IoT Edge, а корпорация Майкрософт выполняет обслуживание этого модуля. Использование других модулей контейнеров на устройстве IoT Edge не поддерживается.

### <a name="choose-upstream-protocol"></a>Выбор вышестоящего протокола

Протокол (а значит, и используемый порт) для связи с вышестоящим Центром Интернета вещей можно настраивать при помощи агента или центра Edge. По умолчанию используется протокол AMQP, но его можно изменить в зависимости от конфигурации сети. 

У двух модулей среды выполнения есть переменная среды **UpstreamProtocol**. Допустимые значения переменной: 

* MQTT
* AMQP
* MQTTWS
* AMQPWS

Настройте переменную UpstreamProtocol для агента Edge в файле config.yaml на самом устройстве. Например, если устройство IoT Edge защищено прокси-сервером, блокирующим порты AMQP, то вам может потребоваться настроить агент Edge на использование AMQP через WebSocket (AMQPWS) для установки первоначального подключения к Центру Интернета вещей. 

После подключения устройства IoT Edge обязательно настраивайте переменную UpstreamProtocol для обоих модулей среды выполнения в будущих развертываниях. Пример этого процесса представлен в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

## <a name="deployment"></a>Развертывание

* **Полезное**
    * Согласование с вышестоящим протоколом
    * Сокращение объема памяти, используемого центром Edge
    * Не используйте отладочные версии образов модулей

### <a name="be-consistent-with-upstream-protocol"></a>Согласование с вышестоящим протоколом

Если вы настроили агент Edge на устройстве IoT Edge на использование протокола, отличного от стандартного AMQP, то следует объявлять тот же протокол во всех последующих развертываниях. Например, если устройство IoT Edge защищено прокси-сервером, блокирующим порты AMQP, то оно наверняка настроено на подключение по протоколу AMQP через WebSocket (AMQPWS). Если при развертывании модулей на устройстве для агента и центра Edge не задан один и тот же протокол (APQPWS), то стандартный протокол AMQP переопределит параметры и не позволит снова подключиться. 

Переменную среды UpstreamProtocol достаточно настроить для модулей агента и центра Edge. Все остальные модули используют протокол, заданный в модулях среды выполнения. 

Пример этого процесса представлен в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

### <a name="reduce-memory-space-used-by-edge-hub"></a>Сокращение объема памяти, используемого центром Edge

Если развертываются устройства с ограниченным объемом памяти, можно настроить центр Edge на работу в упрощенном режиме с использованием меньшего дискового пространства. Однако эти настройки не ограничивают производительность центра Edge, поэтому следует найти баланс, подходящий для вашего решения. 

#### <a name="dont-optimize-for-performance-on-constrained-devices"></a>Не оптимизируйте устройства с ограниченными ресурсами для высокой производительности

Центр IoT Edge по умолчанию оптимизирован для высокой производительности, поэтому всегда пытается выделить большие блоки памяти. Такая конфигурация может привести к проблемам со стабильностью на небольших устройствах, таких как Raspberry Pi. При развертывании устройств с ограниченными ресурсами рекомендуем задавать для переменной среды **OptimizeForPerformance** значение **false** в центре Edge. 

Дополнительные сведения см. в разделе [Проблемы с надежностью на устройствах с ограниченными ресурсами](troubleshoot.md#stability-issues-on-resource-constrained-devices).

#### <a name="disable-unused-protocols"></a>Отключение неиспользуемых протоколов

Еще один способ оптимизировать производительность центра Edge и снизить использование памяти — отключить заголовки тех протоколов, которые не используются в вашем решении. 

Заголовки протоколов настраиваются с помощью логических переменных среды для модуля центра Edge в манифестах развертывания. Вот эти переменные:

* **amqpSettings__enabled**
* **mqttSettings__enabled**
* **httpSettings__enabled**

Имена всех трех переменных содержат *два подчеркивания*, и для них можно задавать значение true или false. 

#### <a name="reduce-storage-time-for-messages"></a>Сокращение времени хранения сообщений

Модуль центра Edge временно сохраняет сообщения, если по той или иной причине их не удается доставить в Центр Интернета вещей. Вы можете настраивать продолжительность хранения недоставленных сообщений в центре Edge. Если вас беспокоит использование памяти на устройстве, вы можете снизить значение **timeToLiveSecs** в копии модуля центра Edge. 

Для параметра timeToLiveSecs по умолчанию задано значение 7200 секунд, то есть два часа. 

### <a name="do-not-use-debug-versions-of-module-images"></a>Не используйте отладочные версии образов модулей

Переходя от разработки к рабочей среде, обязательно удалите конфигурации отладки из манифестов развертывания. Убедитесь, что имена образов модулей в манифестах развертывания не содержат суффикс **\.debug**. Если вы добавили параметры создания, чтобы открыть порты в модулях для отладки, удалите и эти параметры. 

## <a name="container-management"></a>Управление контейнерами

* **Важно!**
    * Управление доступом к реестру контейнеров
    * Использование тегов для управления версиями

### <a name="manage-access-to-your-container-registry"></a>Управление доступом к реестру контейнеров

Прежде чем развертывать модули на рабочих устройствах IoT Edge, убедитесь, что вы контролируете доступ к реестру контейнеров, чтобы посторонние не могли получать доступ к образам контейнеров и вносить в них изменения. Используйте частный, а не общедоступный, реестр контейнеров для управления их образами. 

В руководствах и другой документации говорится, что следует использовать на устройстве IoT Edge те же учетные данные реестра контейнеров, что и на компьютере для разработки. Эти инструкции призваны лишь помочь вам настраивать среды тестирования и разработки. Их не следует соблюдать в рабочей среде. Реестр контейнеров Azure рекомендует выполнять [проверку подлинности при помощи субъектов-служб](../container-registry/container-registry-auth-service-principal.md), если приложения или службы извлекают образы контейнеров автоматически или без участия пользователя, как устройства IoT Edge. Создайте субъект-службу с доступом только для чтения к реестру контейнеров и укажите эти имя пользователя и пароль в манифесте развертывания.

### <a name="use-tags-to-manage-versions"></a>Использование тегов для управления версиями

Тег — это концепция docker, который можно использовать для различения версий контейнеров docker. Теги — это суффиксы (например, **1.0**), указываемые в конце имени репозитория контейнеров. Пример: **mcr.microsoft.com/azureiotedge-agent:1.0**. Теги можно в любой момент менять, чтобы указывать на другой контейнер, поэтому вашей команде следует договориться о правилах обновления образов модулей в будущем. 

Теги также помогают принудительно устанавливать обновления на устройствах IoT Edge. Отправляя обновленную версию модуля в реестр контейнеров, увеличивайте тег. Затем отправьте новое развертывание на устройства с увеличенным тегом. Модуль контейнеров распознает увеличенный тег как новую версию и извлечет последнюю версию модуля на устройство. 

Пример соглашения о тегах представлен в разделе [Сведения о тегах IoT Edge](how-to-update-iot-edge.md#understand-iot-edge-tags). Он поможет вам понять, как IoT Edge использует последовательные и конкретные теги для отслеживания версий. 

## <a name="networking"></a>Сеть

* **Полезное**
    * Просмотр конфигурации исходящих и входящих подключений
    * Добавление подключений в список разрешений
    * Настройка связи через прокси-сервер

### <a name="review-outboundinbound-configuration"></a>Просмотр конфигурации исходящих и входящих подключений

Каналы связи между Центром Интернета вещей Azure и IoT Edge всегда настраиваются как исходящие. Для большинства сценариев IoT Edge достаточно трех подключений. Модуль контейнеров должен соединяться с реестрами контейнеров, в которых хранятся образы модулей. Среда выполнения IoT Edge должна подключиться к Центру Интернета вещей, чтобы получить сведения о конфигурации устройств, а также отправить сообщение и данные телеметрии. А если вы используете автоматическую подготовку, управляющая программа IoT Edge должна подключиться к службе подготовки устройств. Дополнительные сведения см. в разделе [Правила конфигурации брандмауэра и порта для развертывания IoT Edge](troubleshoot.md#firewall-and-port-configuration-rules-for-iot-edge-deployment).

### <a name="whitelist-connections"></a>Добавление подключений в список разрешений

Если ваша сетевая конфигурация требует явно добавлять в список разрешений подключения, установленные с устройств IoT Edge, просмотрите приведенный ниже список компонентов IoT Edge.

* **Агент IoT Edge** открывает постоянное подключение AMQP/MQTT к Центру Интернета вещей (возможно, через объекты WebSocket). 
* **Центр IoT Edge** открывает одно постоянное подключение AMQP или несколько подключений MQTT к Центру Интернета вещей (возможно, через объекты WebSocket). 
* **Управляющая программа IoT Edge** совершает прерывистые HTTPS-вызовы к Центру Интернета вещей. 

Во всех трех случаях имя DNS соответствует шаблону \*.azure-devices.net. 

Кроме того, **модуль контейнеров** совершает вызовы реестров контейнеров по протоколу HTTPS. Чтобы получить образы контейнеров для среды выполнения IoT Edge, используйте имя DNS mcr.microsoft.com. Модуль контейнеров подключается к другим реестрам в соответствии с настройками развертывания. 

Этот контрольный список является отправной точкой для настройки правил брандмауэра:

   | URL-адрес (\* = подстановочный знак) | Исходящие порты TCP | Использование |
   | ----- | ----- | ----- |
   | mcr.microsoft.com  | 443 | Реестр контейнеров Майкрософт |
   | global.azure-devices-provisioning.net  | 443 | Доступ к DPS (необязательно) |
   | \*.azurecr.io | 443 | Реестры личных и сторонних контейнеров |
   | \*.blob.core.windows.net | 443 | Скачивание изменений образа | 
   | \*.azure-devices.net | 5671, 8883, 443 | Доступ к Центру Интернета вещей |
   | \*.docker.io  | 443 | Доступ центра docker (необязательно) |

### <a name="configure-communication-through-a-proxy"></a>Настройка связи через прокси-сервер

Если устройства будут развернуты в сети, использующей прокси-сервер, они должны иметь возможность взаимодействовать через прокси-сервер, чтобы получать доступ к Центру Интернета вещей и реестрам контейнеров. Дополнительные сведения см. в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

## <a name="solution-management"></a>Управление решениями

* **Полезное**
    * Настройка журналов и диагностики
    * Тесты и конвейеры CI/CD

### <a name="set-up-logs-and-diagnostics"></a>Настройка журналов и диагностики

В Linux управляющая программа Edge Интернета вещей использует журналов по умолчанию ведение журнала драйвера. Чтобы запрашивать журналы управляющей программы, можно использовать программу командной строки `journalctl`. В Windows управляющая программа IoT Edge использует диагностику PowerShell. Чтобы запрашивать журналы из управляющей программы, используйте команду `Get-WinEvent`. Модули IoT Edge используйте драйвер JSON для ведения журнала, который используется по умолчанию.  

При тестировании развертывания IoT Edge обычно можно получать доступ к своим устройствам для извлечения журналов и устранения неполадок. В случае развертывания эта возможность может отсутствовать. Подумайте, как вы будете собирать сведения об устройствах в рабочей среде. Один вариант — использовать модуль ведения журнала, который собирает сведения от других модулей и отправляет их в облако. К примерам модулей ведения журнала относится [logspout-loganalytics](https://github.com/veyalla/logspout-loganalytics). Вы также можете создать собственный модуль. 

### <a name="place-limits-on-log-size"></a>Накладывает ограничения на размер журнала

По умолчанию обработчик Кита контейнеров не устанавливает ограничения на размер журнала контейнера. Со временем это может привести к устройству переполнения с помощью журналов и заканчивается свободное место. Рассмотрите следующие варианты во избежание этого:

**Вариант. Установить глобальные ограничения, которые применяются ко всем модулям контейнера**

Можно ограничить размер всех файлов журнала контейнера в параметрах журнала ядра контейнера. В следующем примере задается драйвер ведения журналов `json-file` (рекомендуется), с учетом ограничений на размер и число файлов:

    {
        "log-driver": "json-file",
        "log-opts": {
            "max-size": "10m",
            "max-file": "3"
        }
    }

Добавить (или в конце) эту информацию в файл с именем `daemon.json` и поместите его в надлежащем расположении для вашей платформы устройств.

| платформа | Location |
| -------- | -------- |
| Linux | `/etc/docker/` |
|  Windows | `C:\ProgramData\iotedge-moby-data\config\` |

Чтобы изменения вступили в силу необходимо перезапустить ядро контейнера.

**Вариант. Настройка параметров журнала для каждого контейнера модуля**

Можно сделать в **createOptions** каждого модуля. Пример.

    "createOptions": {
        "HostConfig": {
            "LogConfig": {
                "Type": "json-file",
                "Config": {
                    "max-size": "10m",
                    "max-file": "3"
                }
            }
        }
    }


**Дополнительные параметры в системах Linux**

* Настройте механизм контейнера, чтобы отправить журналы в `systemd` [журнала](https://docs.docker.com/config/containers/logging/journald/) , задав `journald` как драйвер ведения журнала по умолчанию. 

* Периодически Удалите старые журналы с устройства, установив средство logrotate. Используйте следующую спецификацию файла: 

   ```
   /var/lib/docker/containers/*/*-json.log{
       copytruncate
       daily
       rotate7
       delaycompress
       compress
       notifempty
       missingok
   }
   ```

### <a name="consider-tests-and-cicd-pipelines"></a>Тесты и конвейеры CI/CD

Для максимально эффективного развертывания IoT Edge рекомендуем интегрировать рабочую среду с конвейерами CI/CD и тестирования. Azure IoT Edge поддерживает множество платформ CI/CD, включая Azure DevOps. Дополнительные сведения см. в статье [Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge](how-to-ci-cd.md).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения см. в статье об [автоматическом развертывании IoT Edge](module-deployment-monitoring.md).
* Узнайте о поддержке [непрерывных интеграции и развертывания](how-to-ci-cd.md) в IoT Edge.
