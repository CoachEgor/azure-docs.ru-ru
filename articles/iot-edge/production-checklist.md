---
title: Подготовка к развертыванию решения в производственной области - Azure IoT Edge
description: Узнайте, как перейти к решению Azure IoT Edge от разработки к производству, включая настройку устройств с соответствующими сертификатами и составление плана развертывания для будущих обновлений кода.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 4/02/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 6bc74e82dd04e5845e95bdec5c841d0264dd1d3e
ms.sourcegitcommit: fb23286d4769442631079c7ed5da1ed14afdd5fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/10/2020
ms.locfileid: "81115088"
---
# <a name="prepare-to-deploy-your-iot-edge-solution-in-production"></a>Подготовка к развертыванию решения IoT Edge в рабочей среде

Когда вы будете готовы перейти от разработки решения IoT Edge к его развертыванию в рабочей среде, убедитесь, что оно настроено для непрерывной работы.

Информация, представленная в этой статье, не все равны. Чтобы помочь вам расставить приоритеты, каждый раздел начинается со списков, разделяющих работу на две части: **важные** задачи, которые следует выполнить перед переходом в рабочую среду, и **полезные** для вас сведения.

## <a name="device-configuration"></a>Конфигурация устройств

Устройством IoT Edge может быть что угодно — от Raspberry Pi до ноутбука или виртуальной машины, работающей на сервере. У вас может быть доступ к устройству (физически или через виртуальное подключение), либо оно может быть изолировано в течение продолжительного времени. В любом случае, вы хотите убедиться, что он настроен на работу надлежащим образом.

* **Важно.**
  * Установка рабочих сертификатов
  * Составление плана управления устройствами
  * Использование Moby в качестве модуля контейнеров

* **Полезное**
  * Выбор вышестоящего протокола

### <a name="install-production-certificates"></a>Установка рабочих сертификатов

На каждом устройстве IoT Edge в рабочей среде необходимо установить сертификат от центра сертификации (ЦС). Затем этот сертификат ЦС объявляется в файле config.yaml для среды выполнения IoT Edge. Для сценариев разработки и тестирования время выполнения IoT Edge создает временные сертификаты, если в файле config.yaml не декларируются сертификаты. Однако срок действия этих сертификатов истекает спустя три месяца, и они недостаточно безопасны для рабочих сценариев.

Сведения о роли сертификатов ЦС для устройств см. в статье [Сведения об использовании сертификатов Azure IoT Edge](iot-edge-certs.md).

Для получения дополнительной информации о том, как установить сертификаты на устройстве IoT Edge и ссылки на них из файла config.yaml, [см.](how-to-manage-device-certificates.md)

### <a name="have-a-device-management-plan"></a>Составление плана управления устройствами

Прежде чем внедрять устройство в рабочую среду, следует определить, как вы будете управлять будущими обновлениями. В случае устройства IoT Edge могут обновляться перечисленные ниже компоненты.

* Встроенное ПО устройства
* Библиотеки операционной системы
* Модуль контейнеров (например, Moby)
* Управляющая программа IoT Edge
* Сертификаты ЦС

Для получения дополнительной информации [см.](how-to-update-iot-edge.md) Для применения современных методик обновления управляющей программы IoT Edge требуется доступ к устройству IoT Edge (физически или по протоколу SSH). Если у вас есть много устройств для обновления, подумайте о добавлении шагов обновления к скрипту или используйте инструмент автоматизации, такой как Ansible.

### <a name="use-moby-as-the-container-engine"></a>Использование Moby в качестве модуля контейнеров

Контейнерный двигатель является обязательным условием для любого устройства IoT Edge. В рабочей среде поддерживается только moby-engine. Другие модули контейнеров, например Docker, совместимы с IoT Edge, и их можно использовать при разработке. Модуль moby-engine можно распространять при использовании с Azure IoT Edge, а корпорация Майкрософт выполняет обслуживание этого модуля.

### <a name="choose-upstream-protocol"></a>Выбор вышестоящего протокола

Можно настроить протокол (который определяет используемый порт) для связи с IoT Hub как для агента IoT Edge, так и для концентратора IoT Edge. По умолчанию используется протокол AMQP, но его можно изменить в зависимости от конфигурации сети.

У двух модулей среды выполнения есть переменная среды **UpstreamProtocol**. Допустимые значения переменной:

* MQTT
* AMQP
* MQTTWS
* AMQPWS

Навлаживайте переменную UpstreamProtocol для агента IoT Edge в файле config.yaml на самом устройстве. Например, если устройство IoT Edge находится за прокси-сервером, который блокирует порты АМЗП, возможно, потребуется настроить агент IoT Edge для использования АМЗП по WebSocket (AM-PWS) для установления начального соединения с IoT Hub.

После подключения устройства IoT Edge обязательно настраивайте переменную UpstreamProtocol для обоих модулей среды выполнения в будущих развертываниях. Пример этого процесса представлен в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

## <a name="deployment"></a>Развертывание

* **Полезное**
  * Согласование с вышестоящим протоколом
  * Настройка хранилища хоста для системных модулей
  * Сокращение пространства памяти, используемого концентратором IoT Edge
  * Не используйте отладочные версии образов модулей

### <a name="be-consistent-with-upstream-protocol"></a>Согласование с вышестоящим протоколом

Если вы настроили агент IoT Edge на устройстве IoT Edge для использования другого протокола, чем Am-P по умолчанию, то следует объявить тот же протокол во всех будущих развертываниях. Например, если устройство IoT Edge защищено прокси-сервером, блокирующим порты AMQP, то оно наверняка настроено на подключение по протоколу AMQP через WebSocket (AMQPWS). При развертывании модулей на устройство настроите тот же протокол AM-PWS для агента IoT Edge и концентратора IoT Edge, иначе амЗП по умолчанию перекроет настройки и не позволит вам снова подключиться.

Для модулей ioT Edge и концентратора IoT Edge достаточно настроить переменную UpstreamProtocol. Все остальные модули используют протокол, заданный в модулях среды выполнения.

Пример этого процесса представлен в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

### <a name="set-up-host-storage-for-system-modules"></a>Настройка хранилища хоста для системных модулей

Модули концентратора и агента IoT Edge используют локальное хранилище для поддержания состояния и включения обмена сообщениями между модулями, устройствами и облаком. Для повышения надежности и производительности назначаем системные модули для использования хранилища в файловой системе хоста.

Для получения дополнительной [Host storage for system modules](how-to-access-host-storage-from-module.md)информации см.

### <a name="reduce-memory-space-used-by-iot-edge-hub"></a>Сокращение пространства памяти, используемого концентратором IoT Edge

Если развертываемые ограниченные устройства с ограниченной памятью, можно настроить концентратор IoT Edge для запуска в более упорядоченной емкости и использовать меньше дискового пространства. Однако эти конфигурации ограничивают производительность концентратора IoT Edge, поэтому найдите правильный баланс, который работает для вашего решения.

#### <a name="dont-optimize-for-performance-on-constrained-devices"></a>Не оптимизируйте устройства с ограниченными ресурсами для высокой производительности

Концентратор IoT Edge оптимизирован для производительности по умолчанию, поэтому он пытается выделить большие куски памяти. Такая конфигурация может привести к проблемам со стабильностью на небольших устройствах, таких как Raspberry Pi. При развертывании устройств с ограниченными ресурсами можно настроить переменную среды **OptimizeForPerformance** на **ложную** на концентраторе IoT Edge.

Когда **OptimizeForPerformance** настроен на **истину,** глава протокола МЗТТ использует PooledByteBufferAllator, который имеет лучшую производительность, но выделяет больше памяти. Разлесть не работает хорошо на 32-битных операционных системах или на устройствах с низкой памятью. Кроме того, при оптимизации для производительности, RocksDb выделяет больше памяти для своей роли в качестве локального поставщика хранилища.

Дополнительные сведения см. в разделе [Проблемы с надежностью на устройствах с ограниченными ресурсами](troubleshoot.md#stability-issues-on-resource-constrained-devices).

#### <a name="disable-unused-protocols"></a>Отключение неиспользуемых протоколов

Еще один способ оптимизировать производительность концентратора IoT Edge и сократить его использование памяти — отключить головки протоколов для любых протоколов, которые вы не используете в своем решении.

Главы протокола настраиваются путем настройки переменных среды boolean для концентрата IoT Edge в манифестах развертывания. Вот эти переменные:

* **amqpSettings__enabled**
* **mqttSettings__enabled**
* **httpSettings__enabled**

Имена всех трех переменных содержат *два подчеркивания*, и для них можно задавать значение true или false.

#### <a name="reduce-storage-time-for-messages"></a>Сокращение времени хранения сообщений

Модуль концентратора IoT Edge временно хранит сообщения, если они не могут быть доставлены в Концентратор IoT по какой-либо причине. Можно настроить, как долго концентратор IoT Edge удерживает недоставленные сообщения, прежде чем позволить им истечь. Если у вас есть проблемы с памятью на устройстве, вы можете снизить значение **timeToLiveSecs** в двойном модуле концентратора IoT Edge.

Для параметра timeToLiveSecs по умолчанию задано значение 7200 секунд, то есть два часа.

### <a name="do-not-use-debug-versions-of-module-images"></a>Не используйте отладочные версии образов модулей

Переходя от разработки к рабочей среде, обязательно удалите конфигурации отладки из манифестов развертывания. Убедитесь, что ни одно из изображений модуля в манифестах развертывания не имеет суффикса ** \.отладки.** Если вы добавили параметры создания, чтобы открыть порты в модулях для отладки, удалите и эти параметры.

## <a name="container-management"></a>Управление контейнерами

* **Важно.**
  * Управление доступом к реестру контейнеров
  * Использование тегов для управления версиями

### <a name="manage-access-to-your-container-registry"></a>Управление доступом к реестру контейнеров

Прежде чем развертывать модули на рабочих устройствах IoT Edge, убедитесь, что вы контролируете доступ к реестру контейнеров, чтобы посторонние не могли получать доступ к образам контейнеров и вносить в них изменения. Используйте частный, а не общедоступный, реестр контейнеров для управления их образами.

В руководствах и другой документации говорится, что следует использовать на устройстве IoT Edge те же учетные данные реестра контейнеров, что и на компьютере для разработки. Эти инструкции призваны лишь помочь вам настраивать среды тестирования и разработки. Их не следует соблюдать в рабочей среде.

Для более защищенного доступа к вашему реестру у вас есть выбор [вариантов аутентификации.](../container-registry/container-registry-authentication.md) Популярной и рекомендуемой проверкой подлинности является использование принципа службы Active Directory, которая хорошо подходит для приложений или служб для вытягивания изображений контейнеров в автоматизированной или иной безприсмотрне (безголовых) манере, как это делают устройства IoT Edge.

Чтобы создать основной сервис, запустите два сценария, описанных в [создании основного сервиса.](../container-registry/container-registry-auth-service-principal.md#create-a-service-principal) Эти скрипты выполняют следующие задачи:

* Первый скрипт создает основной сервис. Он выводит идентификатор службы и главный пароль Службы. Надежно храните эти значения в записях.

* Второй скрипт создает ролевые назначения для предоставления главному обслуживанию, которые могут быть запущены впоследствии в случае необходимости. Мы рекомендуем применять роль пользователя **acrPull** для `role` параметра. Список ролей [см.](../container-registry/container-registry-roles.md)

Чтобы проверить подлинность с помощью основного сервиса, предоставьте основной идентификатор службы и пароль, полученный с первого скрипта. Укажите эти учетные данные в манифесте развертывания.

* Для имени пользователя или идентификатора клиента укажите идентификатор основного имени службы.

* Для получения пароля или секрета клиента укажите главный пароль службы.

> [!NOTE]
> После реализации расширенной проверки подлинности безопасности отпустите настройку **пользователя Admin,** чтобы доступ к имени пользователя/паролю по умолчанию перестал быть доступным. В реестре контейнеров на портале Azure из меню левой панели под **настройками**выберите **ключи доступа.**

### <a name="use-tags-to-manage-versions"></a>Использование тегов для управления версиями

Тег — это концепция докера, которую можно использовать для различения версий докерных контейнеров. Теги — это суффиксы (например, **1.0**), указываемые в конце имени репозитория контейнеров. Пример: **mcr.microsoft.com/azureiotedge-agent:1.0**. Теги можно в любой момент менять, чтобы указывать на другой контейнер, поэтому вашей команде следует договориться о правилах обновления образов модулей в будущем.

Теги также помогают принудительно устанавливать обновления на устройствах IoT Edge. Отправляя обновленную версию модуля в реестр контейнеров, увеличивайте тег. Затем отправьте новое развертывание на устройства с увеличенным тегом. Модуль контейнеров распознает увеличенный тег как новую версию и извлечет последнюю версию модуля на устройство.

Пример соглашения о тегах представлен в разделе [Сведения о тегах IoT Edge](how-to-update-iot-edge.md#understand-iot-edge-tags). Он поможет вам понять, как IoT Edge использует последовательные и конкретные теги для отслеживания версий.

## <a name="networking"></a>Сеть

* **Полезное**
  * Просмотр конфигурации исходящих и входящих подключений
  * Разрешить соединения с устройств IoT Edge
  * Настройка связи через прокси-сервер

### <a name="review-outboundinbound-configuration"></a>Просмотр конфигурации исходящих и входящих подключений

Каналы связи между Центром Интернета вещей Azure и IoT Edge всегда настраиваются как исходящие. Для большинства сценариев IoT Edge достаточно трех подключений. Модуль контейнеров должен соединяться с реестрами контейнеров, в которых хранятся образы модулей. Среда выполнения IoT Edge должна подключиться к Центру Интернета вещей, чтобы получить сведения о конфигурации устройств, а также отправить сообщение и данные телеметрии. А если вы используете автоматическую подготовку, управляющая программа IoT Edge должна подключиться к службе подготовки устройств. Дополнительные сведения см. в разделе [Правила конфигурации брандмауэра и порта для развертывания IoT Edge](troubleshoot.md#firewall-and-port-configuration-rules-for-iot-edge-deployment).

### <a name="allow-connections-from-iot-edge-devices"></a>Разрешить соединения с устройств IoT Edge

Если настройка сети требует, чтобы вы явно разрешили соединения, сделанные с устройств IoT Edge, просмотрите следующий список компонентов IoT Edge:

* **Агент IoT Edge** открывает постоянное подключение AMQP/MQTT к Центру Интернета вещей (возможно, через объекты WebSocket).
* **Центр IoT Edge** открывает одно постоянное подключение AMQP или несколько подключений MQTT к Центру Интернета вещей (возможно, через объекты WebSocket).
* **Управляющая программа IoT Edge** совершает прерывистые HTTPS-вызовы к Центру Интернета вещей.

Во всех трех случаях имя DNS соответствует шаблону \*.azure-devices.net.

Кроме того, **модуль контейнеров** совершает вызовы реестров контейнеров по протоколу HTTPS. Чтобы получить образы контейнеров для среды выполнения IoT Edge, используйте имя DNS mcr.microsoft.com. Модуль контейнеров подключается к другим реестрам в соответствии с настройками развертывания.

Этот контрольный список является отправной точкой для настройки правил брандмауэра:

   | URL-адрес (\* = подстановочный знак) | Исходящие порты TCP | Использование |
   | ----- | ----- | ----- |
   | mcr.microsoft.com  | 443 | Реестр контейнеров Майкрософт |
   | global.azure-devices-provisioning.net  | 443 | Доступ к DPS (необязательно) |
   | \*.azurecr.io | 443 | Личные и сторонние контейнерные реестры |
   | \*.blob.core.windows.net | 443 | Скачать данные реестра контейнеров Azure из хранилища каблов |
   | \*.azure-devices.net | 5671, 8883, 443 | Доступ к Центру Интернета вещей |
   | \*.docker.io  | 443 | Докер концентратор доступа (необязательно) |

Некоторые из этих правил брандмауэра унаследованы из реестра контейнеров Azure. Для получения дополнительной информации см. [Правила настройки для доступа к реестру контейнеров Azure за брандмауэром.](../container-registry/container-registry-firewall-access-rules.md)

### <a name="configure-communication-through-a-proxy"></a>Настройка связи через прокси-сервер

Если устройства будут развернуты в сети, использующей прокси-сервер, они должны иметь возможность взаимодействовать через прокси-сервер, чтобы получать доступ к Центру Интернета вещей и реестрам контейнеров. Дополнительные сведения см. в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

## <a name="solution-management"></a>Управление решениями

* **Полезное**
  * Настройка журналов и диагностики
  * Тесты и конвейеры CI/CD

### <a name="set-up-logs-and-diagnostics"></a>Настройка журналов и диагностики

На Linux daemon IoT Edge использует журналы в качестве драйвера входа по умолчанию. Чтобы запрашивать журналы управляющей программы, можно использовать программу командной строки `journalctl`. В Windows управляющая программа IoT Edge использует диагностику PowerShell. Чтобы запрашивать журналы из управляющей программы, используйте команду `Get-IoTEdgeLog`. Модули IoT Edge используют драйвер JSON для ведения журнала, что является по умолчанию.  

```powershell
. {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
```

При тестировании развертывания IoT Edge обычно можно получать доступ к своим устройствам для извлечения журналов и устранения неполадок. В случае развертывания эта возможность может отсутствовать. Подумайте, как вы будете собирать сведения об устройствах в рабочей среде. Один вариант — использовать модуль ведения журнала, который собирает сведения от других модулей и отправляет их в облако. К примерам модулей ведения журнала относится [logspout-loganalytics](https://github.com/veyalla/logspout-loganalytics). Вы также можете создать собственный модуль.

### <a name="place-limits-on-log-size"></a>Ограничение на размер журнала

По умолчанию контейнерный движок Moby не устанавливает предельные значения размера контейнера. Со временем это может привести к тому, что устройство заполнит журналы и закончится дисковое пространство. Рассмотрим следующие варианты, чтобы предотвратить это:

#### <a name="option-set-global-limits-that-apply-to-all-container-modules"></a>Вариант: Установите глобальные ограничения, которые применяются ко всем контейнерным модулям

Можно ограничить размер всех журналов контейнеров в вариантах журнала контейнерного двигателя. Следующий пример устанавливает драйвер `json-file` журнала (рекомендуется) с ограничениями по размеру и количеству файлов:

```JSON
{
    "log-driver": "json-file",
    "log-opts": {
        "max-size": "10m",
        "max-file": "3"
    }
}
```

Добавьте (или прикажите) эту `daemon.json` информацию в названный файл и поместите ее в нужное место для платформы устройства.

| Платформа | Расположение |
| -------- | -------- |
| Linux | `/etc/docker/` |
| Windows | `C:\ProgramData\iotedge-moby\config\` |

Контейнерный двигатель должен быть перезапущен для вхучить изменения.

#### <a name="option-adjust-log-settings-for-each-container-module"></a>Вариант: Отрегулируйте настройки журнала для каждого контейнерного модуля

Вы можете сделать это в **созданииOptions** каждого модуля. Пример:

```yml
"createOptions": {
    "HostConfig": {
        "LogConfig": {
            "Type": "json-file",
            "Config": {
                "max-size": "10m",
                "max-file": "3"
            }
        }
    }
}
```

#### <a name="additional-options-on-linux-systems"></a>Дополнительные опции в системах Linux

* Настроили контейнерный движок `systemd` для отправки журналов в [журнал,](https://docs.docker.com/config/containers/logging/journald/) установив `journald` его в качестве драйвера регистрации по умолчанию.

* Периодически удаляйте старые журналы с устройства, устанавливая инструмент logrotate. Используйте следующую спецификацию файла:

   ```txt
   /var/lib/docker/containers/*/*-json.log{
       copytruncate
       daily
       rotate7
       delaycompress
       compress
       notifempty
       missingok
   }
   ```

### <a name="consider-tests-and-cicd-pipelines"></a>Тесты и конвейеры CI/CD

Для максимально эффективного развертывания IoT Edge рекомендуем интегрировать рабочую среду с конвейерами CI/CD и тестирования. Azure IoT Edge поддерживает множество платформ CI/CD, включая Azure DevOps. Дополнительные сведения см. в статье [Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge](how-to-ci-cd.md).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения см. в статье об [автоматическом развертывании IoT Edge](module-deployment-monitoring.md).
* Узнайте о поддержке [непрерывных интеграции и развертывания](how-to-ci-cd.md) в IoT Edge.
