---
title: Инициализация с симметричными ключами — Azure IoT Edge | Документация Майкрософт
description: После установки подготавливает устройство IoT Edge с симметричными ключами, используя строку подключения и прошедшие проверку подлинности в центре Интернета вещей.
author: kgremban
manager: philmea
ms.reviewer: veyalla
ms.service: iot-edge
services: iot-edge
ms.topic: conceptual
ms.date: 10/06/2020
ms.author: kgremban
ms.openlocfilehash: f5371539c1b45c14b519729c7c07003bf74847a0
ms.sourcegitcommit: 2e72661f4853cd42bb4f0b2ded4271b22dc10a52
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92043873"
---
# <a name="set-up-an-azure-iot-edge-device-with-symmetric-key-authentication"></a>Настройка Azure IoT Edge устройства с проверкой подлинности с помощью симметричного ключа

В этой статье описаны действия по регистрации нового устройства IoT Edge в центре Интернета вещей и настройке устройства для проверки подлинности с помощью симметричных ключей.

Действия, описанные в этой статье, описывают процесс, называемый ручной подготовкой, где каждое устройство подключается к центру Интернета вещей вручную. Альтернативой является автоматическая подготовка с помощью службы подготовки устройств для центра Интернета вещей, которая полезна при наличии множества устройств для подготовки.

<!--TODO: Add auto-provision info/links-->

Для подготовки вручную можно использовать два варианта проверки подлинности IoT Edge устройств:

* **Симметричный ключ**. при создании нового удостоверения устройства в центре Интернета вещей служба создает два ключа. Вы помещаете один ключ на устройство и предоставляете ключ в центре Интернета вещей при проверке подлинности.

  Этот метод проверки подлинности быстрее приступит к работе, но не защищен.

* **Самозаверяющий сертификат x. 509**. вы создаете два сертификата удостоверения x. 509 и размещайте их на устройстве. При создании нового удостоверения устройства в центре Интернета вещей вы предоставляете отпечатки обоих сертификатов. Когда устройство проходит проверку подлинности в центре Интернета вещей, оно представляет сертификаты, а центр Интернета вещей может проверить, соответствуют ли они отпечатки.

  Этот метод проверки подлинности более безопасен и рекомендуется для рабочих сценариев.

В этой статье рассматривается процесс регистрации и подготовки с проверкой подлинности с помощью симметричного ключа. Если вы хотите узнать, как настроить устройство с помощью сертификатов X. 509, см. статью [настройка Azure IOT Edge устройства с помощью проверки подлинности сертификата x. 509](how-to-manual-provision-x509.md).

## <a name="prerequisites"></a>Предварительные требования

Перед выполнением действий, описанных в этой статье, необходимо установить устройство с установленной средой выполнения IoT Edge. В противном случае выполните действия, описанные в разделе [Установка или удаление среды выполнения Azure IOT Edge](how-to-install-iot-edge.md).

## <a name="register-a-new-device"></a>Регистрация нового устройства

Каждое устройство, которое подключается к центру Интернета вещей, имеет идентификатор устройства, который используется для мониторинга обмена данными между облако-устройством или устройством и облаком. Вы настраиваете устройство, используя сведения о его подключении, включая имя узла центра Интернета вещей, идентификатор устройства и сведения, используемые устройством для проверки подлинности в центре Интернета вещей.

Для проверки подлинности с симметричным ключом эта информация собирается в *строке подключения* , которую можно получить из центра Интернета вещей, а затем на устройстве IOT Edge.

Вы можете использовать несколько средств для регистрации нового устройства IoT Edge в центре Интернета вещей и получения его строки подключения в зависимости от предпочтений.

# <a name="portal"></a>[Портал](#tab/azure-portal)

### <a name="prerequisites-for-the-azure-portal"></a>Необходимые условия для использования портала Azure

[Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) (бесплатно или уровня "Стандартный") в подписке Azure.

### <a name="create-an-iot-edge-device-in-the-azure-portal"></a>Создание устройства IoT Edge на портале Azure

В центре Интернета вещей на портале Azure устройства IoT Edge создаются и администрируются независимо от других устройств Интернета вещей, не поддерживающих IoT Edge.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.

1. В левой области выберите **IOT Edge** в меню, а затем выберите **Добавить устройство IOT Edge**.

   ![Добавление устройства IoT Edge из портал Azure](./media/how-to-manual-provision-symmetric-key/portal-add-iot-edge-device.png)

1. На странице **Создание устройства** укажите следующие сведения.

   * Создайте описательный идентификатор устройства.
   * В качестве типа проверки подлинности выберите **Ключ содержимого**.
   * Для автоматического создания ключей проверки подлинности и подключения нового устройства к центру используйте параметры по умолчанию.

1. Щелкните **Сохранить**.

### <a name="view-iot-edge-devices-in-the-azure-portal"></a>Просмотр устройств IoT Edge на портале Azure

Все устройства IoT Edge, подключенные к Центру Интернета вещей, перечислены на странице **IoT Edge**.

![Использование портал Azure для просмотра всех устройств IoT Edge в центре Интернета вещей](./media/how-to-manual-provision-symmetric-key/portal-view-devices.png)

### <a name="retrieve-the-connection-string-in-the-azure-portal"></a>Получение строки подключения на портале Azure

Когда все будет готово к настройке устройства, вам понадобится строка подключения, которая связывает физическое устройство с его идентификатором в Центре Интернета вещей.

1. На странице **IoT Edge** на портале выберите идентификатор устройства в списке устройств IoT Edge.
2. Скопируйте значение в поле **Основная строка подключения** или **Дополнительная строка подключения**.

# <a name="visual-studio-code"></a>[Visual Studio Code](#tab/visual-studio-code)

### <a name="prerequisites-for-visual-studio-code"></a>Необходимые условия для использования Visual Studio Code

* Бесплатный или стандартный [центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) в подписке Azure
* [Visual Studio Code](https://code.visualstudio.com/)
* [Средства Azure IoT](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-tools) для Visual Studio Code.

### <a name="sign-in-to-access-your-iot-hub"></a>Вход в систему для получения доступа к Центру Интернета вещей

Для выполнения действий с Центром Интернета вещей можно использовать расширения Интернета вещей Azure для Visual Studio Code. Для этого войдите в учетную запись Azure и выберите свой Центр Интернета вещей.

1. Откройте в Visual Studio Code представление **Explorer**.
1. В нижней части Explorer разверните раздел **Центр Интернета вещей**.

   ![Развернутый раздел "Azure IoT Hub Devices" (Устройства Центра Интернета вещей Azure)](./media/how-to-manual-provision-symmetric-key/azure-iot-hub-devices.png)

1. Щелкните значок **...** в заголовке раздела **Центр Интернета вещей**. Если значок многоточия не отображается, щелкните заголовок или наведите на него курсор.
1. Щелкните **Выбрать Центр Интернета вещей**.
1. Если вы еще не вошли в учетную запись Azure, сделайте это сейчас, следуя инструкциям.
1. Выберите подписку Azure.
1. Выберите нужный Центр Интернета вещей.

### <a name="create-an-iot-edge-device-with-visual-studio-code"></a>Создание устройства IoT Edge с помощью Visual Studio Code

1. В обозревателе VS Code разверните раздел **Устройства Центра Интернета вещей Azure**.
1. Щелкните значок **...** в заголовке раздела **Устройства Центра Интернета вещей Azure**. Если значок многоточия не отображается, щелкните заголовок или наведите на него курсор.
1. Выберите **Создать устройство IoT Edge**.
1. В открывшемся текстовом поле введите идентификатор для нового устройства.

На экране выходных данных отобразится результат выполнения команды. Здесь содержатся сведения об устройстве, в том числе введенный вами идентификатор **deviceId** и строка подключения **connectionString**, которая понадобится для подключения физического устройства к Центру Интернета вещей.

На экране выходных данных отобразится результат выполнения команды. Здесь содержатся сведения об устройстве, в том числе введенный вами идентификатор **deviceId** и строка подключения **connectionString**, которая понадобится для подключения физического устройства к Центру Интернета вещей.

### <a name="view-iot-edge-devices-with-visual-studio-code"></a>Просмотр устройств IoT Edge с помощью Visual Studio Code

Все устройства, подключенные к Центру Интернета вещей, перечислены в разделе **Центр Интернета вещей** в обозревателе Visual Studio Code. Устройства IoT Edge легко отличить от остальных, так как они обозначаются другим значком и их можно открыть для отображения модулей **$edgeAgent** и **$edgeHub**, развернутых на каждом из устройств IoT Edge.

![Использование VS Code для просмотра всех устройств IoT Edge в центре Интернета вещей](./media/how-to-manual-provision-symmetric-key/view-devices.png)

### <a name="retrieve-the-connection-string-with-visual-studio-code"></a>Получение строки подключения с помощью Visual Studio Code

Когда все будет готово к настройке устройства, вам понадобится строка подключения, которая связывает физическое устройство с его идентификатором в Центре Интернета вещей.

1. Щелкните правой кнопкой мыши идентификатор устройства в разделе **Центр Интернета вещей**.
1. Выберите действие **Копировать строку подключения для устройства**.

   Строка подключения будет помещена в буфер обмена.

Также вы можете выбрать пункт **Получить информацию об устройства** в контекстном меню, чтобы просмотреть в окне выходных данных сведения об этом устройстве, в том числе строку подключения.

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

### <a name="prerequisites-for-the-azure-cli"></a>Необходимые условия для использования Azure CLI

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure.
* [Интерфейс командной строки Azure](/cli/azure/install-azure-cli) в вашей среде. Версия Azure CLI должна быть как минимум 2.0.70 или более поздней. Для проверки используйте `az --version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack.
* [Расширение Интернета вещей для Azure CLI](https://github.com/Azure/azure-iot-cli-extension).

### <a name="create-an-iot-edge-device-with-the-azure-cli"></a>Создание устройства IoT Edge с помощью Azure CLI

Для создания нового удостоверения устройства в центре Интернета вещей используйте команду [az iot hub device-identity create](/cli/azure/ext/azure-iot/iot/hub/device-identity#ext-azure-iot-az-iot-hub-device-identity-create). Пример:

   ```azurecli
   az iot hub device-identity create --device-id [device id] --hub-name [hub name] --edge-enabled
   ```

Эта команда принимает три параметра:

* `--device-id` или `-d` укажите описательное имя, уникальное для центра Интернета вещей.
* `hub-name` или `-n` Укажите имя центра Интернета вещей.
* `--edge-enabled` или `--ee` . Объявите, что устройство является устройством IOT Edge.

   ![Выходные данные команды az iot hub device-identity](./media/how-to-manual-provision-symmetric-key/create-edge-device-cli.png)

### <a name="view-iot-edge-devices-with-the-azure-cli"></a>Просмотр устройств IoT Edge в Azure CLI

Для просмотра всех устройств в центре Интернета вещей используйте команду [az iot hub device-identity list](/cli/azure/ext/azure-iot/iot/hub/device-identity#ext-azure-iot-az-iot-hub-device-identity-list). Пример:

   ```azurecli
   az iot hub device-identity list --hub-name [hub name]
   ```

Для всех устройств, зарегистрированных в качестве устройства IoT Edge, свойство **capabilities.iotEdge** будет иметь значение **true**.

### <a name="retrieve-the-connection-string-with-the-azure-cli"></a>Получение строки подключения с помощью Azure CLI

Когда все будет готово к настройке устройства, вам понадобится строка подключения, которая связывает физическое устройство с его идентификатором в Центре Интернета вещей. Чтобы вернуть строку подключения для одного устройства, используйте команду [az iot hub device-identity show-connection-string](/cli/azure/ext/azure-iot/iot/hub/device-identity#ext-azure-iot-az-iot-hub-device-identity-show-connection-string).

   ```azurecli
   az iot hub device-identity show-connection-string --device-id [device id] --hub-name [hub name]
   ```

В параметре `device-id` учитывается регистр. Копируйте строку подключения без кавычек.

---

## <a name="provision-an-iot-edge-device"></a>Подготовка устройства IoT Edge

После того как устройство IoT Edge будет иметь удостоверение в центре Интернета вещей и строку подключения, которую можно использовать для проверки подлинности, необходимо самостоятельно настроить устройство с помощью этих сведений.

На устройстве Linux вы предоставляете строку подключения, редактируя файл config. YAML. На устройстве Windows вы предоставляете строку подключения, запустив сценарий PowerShell.

# <a name="linux"></a>[Linux](#tab/linux)

На IoT Edge устройстве откройте файл конфигурации.

```bash
sudo nano /etc/iotedge/config.yaml
```

Найдите конфигурации подготовки файла и раскомментируйте **конфигурацию ручной подготовки с помощью раздела строки подключения** . 

Замените значение **device_connection_string** строкой подключения для устройства IoT Edge. Убедитесь, что все остальные разделы подготовки включены в комментарий. Убедитесь, что **Подготовка:** строка не имеет предшествующих пробелов, а вложенные элементы имеют отступ в два пробела.

```yml
# Manual provisioning configuration using a connection string
provisioning:
  source: "manual"
  device_connection_string: "<ADD DEVICE CONNECTION STRING HERE>"
  dynamic_reprovisioning: false
```

Для вставки содержимого буфера обмена в Nano `Shift+Right Click` или нажмите клавишу `Shift+Insert` .

Сохраните файл и закройте его.

   `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

```bash
sudo systemctl restart iotedge
```

# <a name="windows"></a>[Windows](#tab/windows)

1. На IoT Edge устройстве запустите PowerShell от имени администратора.

2. Используйте команду [Initialize-IoTEdge](reference-windows-scripts.md#initialize-iotedge) , чтобы настроить среду выполнения IOT EDGE на компьютере. По умолчанию при выполнении команды применяется подготовка вручную с помощью контейнеров Windows.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Initialize-IoTEdge -ManualConnectionString -ContainerOs Windows
   ```

   * Если вы используете контейнеры Linux, добавьте `-ContainerOs` параметр к флагу. Следует согласовать с выбранным параметром контейнера с `Deploy-IoTEdge` командой, которая была выполнена ранее.

      ```powershell
      . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
      Initialize-IoTEdge -ContainerOs Linux
      ```

   * Если вы загрузили сценарий IoTEdgeSecurityDaemon.ps1 на устройство для автономной или определенной установки версии, обязательно сослаться на локальную копию скрипта.

      ```powershell
      . <path>/IoTEdgeSecurityDaemon.ps1
      Initialize-IoTEdge -ManualX509
      ```

3. При появлении запроса введите строку подключения устройства, полученную в предыдущем разделе. Строка подключения устройства связывает физическое устройство с ИДЕНТИФИКАТОРом устройства в центре Интернета вещей и предоставляет сведения о проверке подлинности.

   Строка подключения устройства имеет следующий формат и не должна содержать кавычки: `HostName={IoT hub name}.azure-devices.net;DeviceId={device name};SharedAccessKey={key}`

При подготовке устройства вручную можно использовать дополнительные параметры для изменения процесса, включая:

* Направить трафик через прокси-сервер.
* Объявите конкретный образ контейнера edgeAgent и укажите учетные данные, если они находятся в частном реестре

Дополнительные сведения об этих дополнительных параметрах см. [в статье сценарии PowerShell для IOT EDGE в Windows](reference-windows-scripts.md).

---

[!INCLUDE [Verify and troubleshoot installation](../../includes/iot-edge-verify-troubleshoot-install.md)]

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте [развертывать модули IOT Edge](how-to-deploy-modules-portal.md) , чтобы узнать, как развернуть модули на устройстве.