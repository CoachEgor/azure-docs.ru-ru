---
title: Непрерывная интеграция & непрерывное развертывание — Azure IoT Edge
description: Настройка непрерывной интеграции и непрерывного развертывания в Azure IoT Edge с использованием Azure DevOps, Azure Pipelines
author: shizn
manager: philmea
ms.author: xshi
ms.date: 08/20/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 463de1f49ad8fd21c355395bec3a55d9d40474e6
ms.sourcegitcommit: 57eb9acf6507d746289efa317a1a5210bd32ca2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/01/2019
ms.locfileid: "74666364"
---
# <a name="continuous-integration-and-continuous-deployment-to-azure-iot-edge"></a>Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge

Вы можете легко внедрить DevOps для приложений Azure IoT Edge, используя встроенные задания Azure IoT Edge в Azure Pipelines. В этой статье показано, как с помощью функций непрерывной интеграции и непрерывного развертывания, предоставляемых Azure Pipelines, быстро и эффективно выполнять сборку, тестирование и развертывание приложений в Azure IoT Edge. 

![Схема ветвей CI и CD для разработки и эксплуатации](./media/how-to-ci-cd/cd.png)

Из этой статьи вы узнаете, как с помощью встроенных задач Azure IoT Edge в Azure Pipelines создать два конвейера для вашего решения IoT Edge. В задачах Azure IoT Edge можно использовать четыре действия.
   - **Образы модулей Azure IOT Edge сборки** занимают код IOT Edgeного решения и создает образы контейнеров.
   - **Azure IOT Edge образы модулей push-уведомлений** отправляют образы модулей в указанный реестр контейнеров.
   - **Azure IOT Edge — создание манифеста развертывания** принимает файл Deployment. Template. JSON и переменные, а затем создает окончательный файл манифеста развертывания IOT Edge.
   - **Azure IOT Edge-Deploy to IOT Edge Devices** помогает создавать IOT Edge развертывания на одном или нескольких IOT Edge устройствах.

## <a name="prerequisites"></a>Технические условия

* Репозиторий Azure Repos. Если у вас его нет, вы можете [создать репозиторий Git в проекте](https://docs.microsoft.com/azure/devops/repos/git/create-new-repo?view=vsts&tabs=new-nav).
* Решение IoT Edge, зафиксированное и отправленное в репозиторий. Если вы хотите создать пример решения для тестирования инструкций в этой статье, следуйте шагам, изложенным в статье [Использование Visual Studio Code для разработки и отладки модулей для Azure IoT Edge](how-to-vs-code-develop-module.md) или [Сведения об использовании Visual Studio 2017 для разработки и отладки модулей C# для Azure IoT Edge (предварительная версия)](how-to-visual-studio-develop-csharp-module.md).
   * Все, что требуется в этой статье, — это папка решения, созданная по шаблону IoT Edge в Visual Studio Code или Visual Studio. Вам не требуется создавать, отправлять, развертывать или отлаживать этот код, чтобы продолжить. Необходимо настроить эти процессы в Azure Pipelines. 
   * Если вы создаете решение, сначала клонируйте репозиторий локально. Затем вы сможете создать решение непосредственно в папке репозитория. Кроме того, вы можете легко фиксировать и отправлять файлы из нее. 
* Реестр контейнеров, в который можно отправлять образы модулей. Вы можете использовать [Реестр контейнеров Azure](https://docs.microsoft.com/azure/container-registry/) или сторонний реестр. 
* Активный [Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) по крайней мере с одним устройством IoT Edge для тестирования отдельных этапов тестового и рабочего развертывания. Следуйте кратким руководствам, чтобы создать устройство IoT Edge в [Linux](quickstart-linux.md) или [Windows](quickstart.md).


Дополнительные сведения об использовании Azure Repos см. в статье [Share your code with Visual Studio 2015 and Azure Repos](https://docs.microsoft.com/azure/devops/repos/git/share-your-code-in-git-vs?view=vsts) (Предоставление общего доступа к коду с помощью Visual Studio и Azure Repos).

## <a name="configure-continuous-integration"></a>Настройка непрерывной интеграции
В этом разделе показано, как создать конвейер сборки. Настройте конвейер на автоматический запуск при регистрации любых изменений в примере решения IoT Edge и публикации журналов сборки.

>[!NOTE]
>В этой статье используется визуальный конструктор Azure DevOps. Прежде чем выполнять действия, описанные в этом разделе, отключите эту предварительную версию функции для нового интерфейса создания конвейера YAML. 
>1. В Azure DevOps щелкните значок своего профиля, а затем выберите **Функции предварительной версии**.
>2. Отключите **новый интерфейс для создания конвейеров YAML**. 
>
>Дополнительные сведения см. в разделе о [создании конвейера сборки](https://docs.microsoft.com/azure/devops/pipelines/create-first-pipeline).

1. Войдите в свою организацию Azure DevOps (**https:\//дев.Азуре.ком/{йоур Organization}/** ) и откройте проект, содержащий репозиторий IOT Edge решений.

   В этой статье мы создали репозиторий, который называется **IoTEdgeRepo**. Этот репозиторий содержит **IoTEdgeSolution** с кодом для модуля под названием **filtermodule**. 

   ![Открытие своего проекта DevOps](./media/how-to-ci-cd/init-project.png)

2. Перейдите к Azure Pipelines в проекте. Откройте вкладку **Сборки** и выберите **Новый конвейер**. Если же конвейеры сборки уже есть, нажмите кнопку **Создать**. Затем выберите **Новый конвейер сборки**.

    ![Создание конвейера сборки](./media/how-to-ci-cd/add-new-build.png)

3. Следуйте инструкциям на экране для создания конвейера. 

   1. Укажите сведения об источнике для нового конвейера сборки. Выберите **Azure Repos Git** в качестве источника, а затем выберите проект, репозиторий и ветвь, в которой расположен код решения IoT Edge. Затем выберите **Продолжить**. 

      ![Выбор источника конвейера](./media/how-to-ci-cd/pipeline-source.png)

   2. Выберите **Пустое задание** вместо шаблона. 

      ![Начало работы с пустым проектом](./media/how-to-ci-cd/start-with-empty.png)

4. После создания конвейера вы перейдете в редактор конвейера. В описании конвейера выберите правильный пул агентов, в зависимости от целевой платформы: 
    
   * Если вы хотите компилировать модули на платформе amd64 для контейнеров Linux, выберите **Hosted Ubuntu 1604** (Размещение в Ubuntu 1604).

   * Если вы хотите создавать модули на платформе amd64 для контейнеров Windows 1809, вам необходимо [настроить агента в Windows в локальной среде](https://docs.microsoft.com/azure/devops/pipelines/agents/v2-windows?view=vsts).

   * Если вы хотите создать модули на платформе platform arm32v7 или arm64 для контейнеров Linux, необходимо [настроить самостоятельный агент в Linux](https://blogs.msdn.microsoft.com/iotdev/2018/11/13/setup-azure-iot-edge-ci-cd-pipeline-with-arm-agent/).
    
     ![Настройка пула агентов сборки](./media/how-to-ci-cd/configure-env.png)

5. Конвейер предварительно настроен с заданием **Agent job 1** (Задание агента 1). Щелкните знак "плюс" ( **+** ), чтобы добавить в задание три задачи: **Azure IOT Edge** дважды, **скопируйте файлы** один раз и **опубликуйте артефакты сборки** один раз. (Наведите указатель мыши на имя каждой задачи, чтобы увидеть кнопку **Добавить**.)

   ![Добавление задачи Azure IoT Edge](./media/how-to-ci-cd/add-iot-edge-task.png)

   Когда все четыре задачи будут добавлены, задание агента будет выглядеть, как в следующем примере:
    
   ![Три задачи в конвейер сборки](./media/how-to-ci-cd/add-tasks.png)

6. Выберите первую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача создает все модули в решении с указанной целевой платформой.

   * **Отображаемое имя**: примите используемые по умолчанию **образы модулей Azure IOT Edge-Build**.
   * **Действие**: Примите **образы модуля сборки**по умолчанию. 
   * **файл Template. JSON**: нажмите кнопку с многоточием ( **...** ) и перейдите к файлу **Deployment. Template. JSON** в репозитории, содержащем решение IOT Edge. 
   * **Платформа по умолчанию**: выберите подходящую платформу для модулей на основе целевого устройства IOT Edge. 
   * **Выходные переменные**. выходные переменные включают ссылочное имя, которое можно использовать для настройки пути к файлу, в котором будет создан файл Deployment. JSON. Укажите какое-нибудь запоминающееся справочное имя, например **edge**. 

7. Выберите вторую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача передает все образы модулей в выбранный реестр контейнеров.

   * **Отображаемое имя**: отображаемое имя автоматически обновляется при изменении поля действия. 
   * **Действие**: Используйте раскрывающийся список, чтобы выбрать **образы модуля push-уведомлений**. 
   * **Тип реестра контейнеров**: выберите тип реестра контейнеров, который будет использоваться для хранения образов модулей. Форма меняется в зависимости от выбранного типа реестра. Если вы выберете **Реестр контейнеров Azure**, используйте раскрывающиеся списки, чтобы выбрать подписку Azure и имя реестра контейнеров. При выборе **универсального реестра контейнеров** щелкните **Создать**, чтобы создать подключение к службе реестра. 
   * **файл Template. JSON**: нажмите кнопку с многоточием ( **...** ) и перейдите к файлу **Deployment. Template. JSON** в репозитории, содержащем решение IOT Edge. 
   * **Платформа по умолчанию**: выберите ту же платформу, что и образы созданного модуля.

   Если для размещения образов модулей вы используете несколько реестров контейнеров, создайте дубликат этой задачи и выберите в нем другой реестр контейнеров, затем разместите действие **Bypass module(s)** (Обойти модуль/модули) в разделе дополнительных параметров, чтобы пропускать образы, не имеющие отношение к конкретному реестру.

8. Выберите задачу **копирование файлов** , чтобы изменить ее. Эта задача предназначена для копирования файлов в промежуточный каталог артефактов.

   * **Отображаемое имя**: копирование файлов в: папка сброса.
   * **Содержимое**: Разместите две строки в этом разделе, `deployment.template.json` и `**/module.json`. Эти два типа файлов являются входными данными для создания манифеста IoT Edge развертывания. Необходимо скопировать в промежуточную папку артефактов и опубликовать для конвейера выпуска.
   * **Целевая папка**: вставьте переменную `$(Build.ArtifactStagingDirectory)`. Дополнительные сведения о описании см. в разделе [переменные сборки](https://docs.microsoft.com/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#build-variables) .

9. Выберите задачу **Publish Build Artifacts** (Публикация артефактов сборки), чтобы изменить его. Укажите путь к промежуточному каталогу артефакта для задачи, чтобы путь можно было опубликовать в конвейере выпуска.
   
   * **Отображаемое имя**: публикация артефакта: Drop.
   * **Путь для публикации**: вставьте переменную `$(Build.ArtifactStagingDirectory)`. Дополнительные сведения о описании см. в разделе [переменные сборки](https://docs.microsoft.com/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#build-variables) .
   * **Имя артефакта**: Drop.
   * **Расположение публикации артефакта**: Azure pipelines.


10. Откройте вкладку **Триггеры** и установите флажок **Enable continuous integration** (Включить непрерывную интеграцию). Убедитесь, что включена ветвь, содержащая ваш код.

    ![Включение триггера непрерывной интеграции](./media/how-to-ci-cd/configure-trigger.png)

11. Сохраните новый конвейер сборки кнопкой **Сохранить**.

Этот конвейер настроен на автоматический запуск при отправке нового кода в репозиторий. Последняя задача, публикация артефактов конвейера, активирует конвейер выпуска. Перейдите к следующему разделу для создания конвейера выпуска. 

## <a name="configure-continuous-deployment"></a>настройка непрерывного развертывания;
В этом разделе описано, как создать конвейер выпуска, настроенный для автоматического запуска при получении артефакта от конвейера сборки и отображения журналов сборки в Azure Pipelines.

Создать новый конвейер и добавить новый этап 

1. На вкладке **Releases** (Выпуски) выберите **+ New pipeline** (Создать конвейер). Если у вас уже есть конвейеры выпуска, нажмите кнопку **+ Создать** и щелкните **+ Создать конвейер выпуска**.  

    ![Добавление конвейера выпуска](./media/how-to-ci-cd/add-release-pipeline.png)

2. Когда будет предложено выбрать шаблон, выберите с **пустым заданием**.

    ![Начало работы с пустым заданием](./media/how-to-ci-cd/start-with-empty-job.png)

3. Ваш новый конвейер выпуска инициализируется с одним этапом, который называется **Этап 1**. Переименование этапа 1 в среду **разработки** и его обработка в качестве тестовой среды. Обычно конвейеры непрерывного развертывания имеют несколько **этапов, включая** **разработку**, **промежуточную** среду и рабочую среду. Вы можете создать больше, основываясь на DevOps практике. Закройте окно сведений об этапе после его переименования. 

4. Свяжите выпуск с артефактами сборки, опубликованными конвейером сборки. Щелкните **Add** (Добавить) в области артефактов.

   ![Добавление артефактов](./media/how-to-ci-cd/add-artifacts.png)  
    
5. На **странице добавления артефакта** выберите тип источника **Сборка**. Затем выберите созданный проект и конвейер сборки. а затем щелкните **Добавить**.

   ![Добавление артефакта сборки](./media/how-to-ci-cd/add-an-artifact.png)

6. Откройте триггеры артефакта и выберите переключатель для включения триггера непрерывного развертывания. Теперь новый выпуск будет создаваться каждый раз, когда новая сборка становится доступной.

   ![Настройка триггера непрерывного развертывания](./media/how-to-ci-cd/add-a-trigger.png)

7. Этап **разработки** предварительно настроен с одним заданием и нулевыми задачами. В меню конвейера выберите **задачи** , а затем выберите этап **разработки** .  Выберите число заданий и задач, чтобы настроить задачи на этом этапе.

    ![Настройка задач разработки](./media/how-to-ci-cd/view-stage-tasks.png)

8. На этапе **разработки** вы должны увидеть **Задание агента**по умолчанию. Вы можете настроить сведения о задании агента, но задача развертывания не зависит от платформы, поэтому вы можете использовать **Hosted VS2017** или **Hosted Ubuntu 1604** в **пуле агентов** (или любой другой агент, управляемый вами). 

9. Щелкните знак «плюс» ( **+** ), чтобы добавить две задачи. Выполните поиск и добавьте **Azure IOT Edge** дважды.

    ![Добавление задач для разработки](./media/how-to-ci-cd/add-task-qa.png)

10. Выберите первую задачу **Azure IOT Edge** и настройте ее со следующими значениями:

    * **Отображаемое имя**: отображаемое имя автоматически обновляется при изменении поля действия. 
    * **Действие**: Используйте раскрывающийся список, чтобы выбрать **создать манифест развертывания**. В случае изменения значения действия для соответствия также обновляется отображаемое имя задачи.
    * **. Template. JSON файл**: вставьте путь `$(System.DefaultWorkingDirectory)/Drop/drop/deployment.template.json`. Путь публикуется из конвейера сборки.
    * **Платформа по умолчанию**: выберите то же значение при создании образов модулей.
    * **Путь вывода**: вставьте `$(System.DefaultWorkingDirectory)/Drop/drop/configs/deployment.json`пути. Этот путь является окончательным файлом манифеста развертывания IoT Edge.

    Эти конфигурации помогают заменить URL-адреса образа модуля в файле `deployment.template.json`. **Манифест создания развертывания** также помогает заменить переменные на точные значения, определенные в файле `deployment.template.json`. В VS/VS Code Вы указываете фактическое значение в `.env`ном файле. В Azure Pipelines значение задается на вкладке Переменные конвейера выпуска. Перейдите на вкладку Переменные и настройте имя и значение следующим образом.

    * **ACR_ADDRESS**. ваш адрес реестра контейнеров Azure. 
    * **ACR_PASSWORD**: пароль реестра контейнеров Azure.
    * **ACR_USER**: имя пользователя реестра контейнеров Azure.

    Если в проекте имеются другие переменные, можно указать имя и значение на этой вкладке. Файл **создания манифеста развертывания** может распознать только те переменные, которые находятся в `${VARIABLE}` версии. Убедитесь, что вы используете его в файлах `*.template.json`.

    ![Настройка переменных для конвейера выпуска](./media/how-to-ci-cd/configure-variables.png)

10. Выберите вторую задачу **Azure IOT Edge** и настройте ее со следующими значениями:

    * **Отображаемое имя**: отображаемое имя автоматически обновляется при изменении поля действия. 
    * **Действие**: Используйте раскрывающийся список, чтобы выбрать **развертывание на IOT Edge устройств**. В случае изменения значения действия для соответствия также обновляется отображаемое имя задачи.
    * **Подписка Azure**. Выберите подписку, которая содержит центр Интернета вещей.
    * **Имя центра Интернета вещей**: выберите центр Интернета вещей. 
    * **Выберите одно или несколько устройств**: выберите, следует ли выполнять развертывание конвейера выпуска на одном устройстве или на нескольких устройствах. 
      * При развертывании на одно устройство введите **идентификатор устройства IoT Edge**. 
      * При развертывании на нескольких устройствах следует указать **целевое условие** устройства. Условие назначения — это фильтр, который соответствует набору IoT Edge устройств в центре Интернета вещей. Если в качестве условия вы решите использовать теги устройства, не забудьте обновить соответствующие теги устройств в двойниках устройств Центра Интернета вещей. Обновите **идентификатор развертывания** и **приоритет развертывания IoT Edge** в разделе дополнительных параметров. Дополнительные сведения о создании развертывания для нескольких устройств см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в требуемом масштабе](module-deployment-monitoring.md).
    * Разверните узел Дополнительные параметры, выберите **IOT Edge идентификатор развертывания**, вставьте переменную `$(System.TeamProject)-$(Release.EnvironmentName)`. Это сопоставление проекта и имени выпуска с ИДЕНТИФИКАТОРом развертывания IoT Edge.

11. Выберите **Сохранить**, чтобы сохранить изменения в новом конвейере выпуска. Вернитесь в представление конвейера, выбрав **Конвейер** в меню. 
    
## <a name="verify-iot-edge-cicd-with-the-build-and-release-pipelines"></a>Проверка CI/CD для IoT Edge с использованием конвейеров сборки и выпуска

Чтобы запустить задание сборки, можно создать фиксацию в репозитории исходного кода или активировать задание вручную. В этом разделе вы вручную запускаете конвейер CI/CD для проверки правильности его работы. Затем вы проверите успешность развертывания.

1. Перейдите в конвейер сборки, созданный в начале этой статьи. 

2. Чтобы запустить задание сборки в конвейере сборки, нажмите кнопку **Очередь**, как показано на следующем снимке экрана.

    ![Ручной триггер](./media/how-to-ci-cd/manual-trigger.png)

3. Выберите задание сборки, чтобы просмотреть ход его выполнения. Если конвейер сборки успешно завершен, он активирует выпуск на этапе **разработки** . 

    ![Журналы сборки](./media/how-to-ci-cd/build-logs.png)

4. В успешном выпуске **dev** создается IOT Edge развертывание для целевых устройств IOT Edge.

    ![Выпуск для разработки](./media/how-to-ci-cd/pending-approval.png)

5. Щелкните этап **разработки** , чтобы просмотреть журналы выпуска.

    ![Журналы выпуска](./media/how-to-ci-cd/release-logs.png)



## <a name="next-steps"></a>Дальнейшие действия
* IoT Edge рекомендации по DevOps в [проекте DevOps Azure для IOT Edge](how-to-devops-project.md)
* Основные сведения о развертывании IoT Edge см. в статье [Understand IoT Edge deployments for single devices or at scale](module-deployment-monitoring.md) (Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе).
* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
