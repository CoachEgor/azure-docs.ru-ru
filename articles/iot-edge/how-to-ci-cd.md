---
title: Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge | Документация Майкрософт
description: Настройка непрерывной интеграции и непрерывного развертывания в Azure IoT Edge с использованием Azure DevOps, Azure Pipelines
author: shizn
manager: philmea
ms.author: xshi
ms.date: 01/22/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: f449449c542ce6ac04daa58ff37a3577f0d75aee
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "61222059"
---
# <a name="continuous-integration-and-continuous-deployment-to-azure-iot-edge"></a>Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge

Вы можете легко внедрить DevOps для приложений Azure IoT Edge, используя встроенные задания Azure IoT Edge в Azure Pipelines. В этой статье показано, как с помощью функций непрерывной интеграции и непрерывного развертывания, предоставляемых Azure Pipelines, быстро и эффективно выполнять сборку, тестирование и развертывание приложений в Azure IoT Edge. 

Из этой статьи вы узнаете, как с помощью встроенных задач Azure IoT Edge в Azure Pipelines создать два конвейера для вашего решения IoT Edge. Первый контейнер принимает код и создает решение, отправляя образы модуля в реестр контейнеров и создавая манифест развертывания, а второй развертывает модули на целевых устройствах IoT Edge.  

![Схема ветвей CI и CD для разработки и эксплуатации](./media/how-to-ci-cd/cd.png)


## <a name="prerequisites"></a>Технические условия

* Репозиторий Azure Repos. Если у вас его нет, вы можете [создать репозиторий Git в проекте](https://docs.microsoft.com/azure/devops/repos/git/create-new-repo?view=vsts&tabs=new-nav).
* Решение IoT Edge, зафиксированное и отправленное в репозиторий. Если вы хотите создать пример решения для тестирования инструкций в этой статье, следуйте шагам, изложенным в статье [Использование Visual Studio Code для разработки и отладки модулей для Azure IoT Edge](how-to-vs-code-develop-module.md) или [Сведения об использовании Visual Studio 2017 для разработки и отладки модулей C# для Azure IoT Edge (предварительная версия)](how-to-visual-studio-develop-csharp-module.md).
   * Все, что требуется в этой статье, — это папка решения, созданная по шаблону IoT Edge в Visual Studio Code или Visual Studio. Вам не требуется создавать, отправлять, развертывать или отлаживать этот код, чтобы продолжить. Необходимо настроить эти процессы в Azure Pipelines. 
   * Если вы создаете решение, сначала клонируйте репозиторий локально. Затем вы сможете создать решение непосредственно в папке репозитория. Кроме того, вы можете легко фиксировать и отправлять файлы из нее. 
* Реестр контейнеров, в который можно отправлять образы модулей. Вы можете использовать [Реестр контейнеров Azure](https://docs.microsoft.com/azure/container-registry/) или сторонний реестр. 
* Активный [Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) по крайней мере с одним устройством IoT Edge для тестирования отдельных этапов тестового и рабочего развертывания. Следуйте кратким руководствам, чтобы создать устройство IoT Edge в [Linux](quickstart-linux.md) или [Windows](quickstart.md).


Дополнительные сведения об использовании Azure Repos см. в статье [Share your code with Visual Studio 2015 and Azure Repos](https://docs.microsoft.com/azure/devops/repos/git/share-your-code-in-git-vs?view=vsts) (Предоставление общего доступа к коду с помощью Visual Studio и Azure Repos).

## <a name="configure-continuous-integration"></a>Настройка непрерывной интеграции
В этом разделе показано, как создать конвейер сборки. Настройте конвейер на автоматический запуск при регистрации любых изменений в примере решения IoT Edge и публикации журналов сборки.

>[!NOTE]
>В этой статье используется визуальный конструктор Azure DevOps. Прежде чем выполнять действия, описанные в этом разделе, отключите эту предварительную версию функции для нового интерфейса создания конвейера YAML. 
>1. В Azure DevOps щелкните значок своего профиля, а затем выберите **Функции предварительной версии**.
>2. Отключите **новый интерфейс для создания конвейеров YAML**. 
>
>Дополнительные сведения см. в разделе о [создании конвейера сборки](https://docs.microsoft.com/azure/devops/pipelines/get-started-designer?view=vsts&tabs=new-nav#create-a-build-pipeline).

1. Вход в вашей организации DevOps в Azure (**https:\//dev.azure.com/{your организации} /** ) и откройте проект, который содержит репозиторий решения IoT Edge.

   В этой статье мы создали репозиторий, который называется **IoTEdgeRepo**. Этот репозиторий содержит **IoTEdgeSolution** с кодом для модуля под названием **filtermodule**. 

   ![Открытие своего проекта DevOps](./media/how-to-ci-cd/init-project.png)

2. Перейдите к Azure Pipelines в проекте. Откройте вкладку **Сборки** и выберите **Новый конвейер**. Если же конвейеры сборки уже есть, нажмите кнопку **Создать**. Затем выберите **Новый конвейер сборки**.

    ![Создание конвейера сборки](./media/how-to-ci-cd/add-new-build.png)

3. Следуйте инструкциям на экране для создания конвейера. 

   1. Укажите сведения об источнике для нового конвейера сборки. Выберите **Azure Repos Git** в качестве источника, а затем выберите проект, репозиторий и ветвь, в которой расположен код решения IoT Edge. Затем выберите **Продолжить**. 

      ![Выбор источника конвейера](./media/how-to-ci-cd/pipeline-source.png)

   2. Выберите **Пустое задание** вместо шаблона. 

      ![Начало работы с пустым проектом](./media/how-to-ci-cd/start-with-empty.png)

4. После создания конвейера вы перейдете в редактор конвейера. В описании конвейера выберите правильный пул агентов, в зависимости от целевой платформы: 
    
   * Если вы хотите компилировать модули на платформе amd64 для контейнеров Linux, выберите **Hosted Ubuntu 1604** (Размещение в Ubuntu 1604).

   * Если вы хотите создавать модули на платформе amd64 для контейнеров Windows 1809, вам необходимо [настроить агента в Windows в локальной среде](https://docs.microsoft.com/azure/devops/pipelines/agents/v2-windows?view=vsts).

   * Если вы хотите компилировать модули на платформе arm32v7 для контейнеров Linux, вам необходимо [настроить агента в Linux в локальной среде](https://blogs.msdn.microsoft.com/iotdev/2018/11/13/setup-azure-iot-edge-ci-cd-pipeline-with-arm-agent/).
    
     ![Настройка пула агентов сборки](./media/how-to-ci-cd/configure-env.png)

5. Конвейер предварительно настроен с заданием **Agent job 1** (Задание агента 1). Выберите знак "плюс" ( **+** ), чтобы добавить три задачи в задание: две задачи **Azure IoT Edge** и одна **Publish Build Artifacts** (Публикация артефактов сборки). (Наведите указатель мыши на имя каждой задачи, чтобы увидеть кнопку **Добавить**.)

   ![Добавление задачи Azure IoT Edge](./media/how-to-ci-cd/add-iot-edge-task.png)

   После добавления всех трех задач задание агента будет выглядеть следующим образом:
    
   ![Три задачи в конвейер сборки](./media/how-to-ci-cd/add-tasks.png)

6. Выберите первую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача создает все модули в решении с указанной вами целевой платформой, а также создает файл **deployment.json** с параметрами, на основе которых устройства IoT Edge настраивают развертывание.

   * **Отображаемое имя**. Примите имя по умолчанию: **Azure IoT Edge - Build module images** (Azure IoT Edge — создание образов модулей).
   * **Действие**: Примите имя по умолчанию: **Build module images** (Создание образов модулей). 
   * **Файл template.json**. Нажмите кнопку с многоточием ( **...** ) и перейдите к файлу **deployment.template.json** в репозитории, где содержится решение IoT Edge. 
   * **Платформа по умолчанию**. Выберите соответствующую платформу для модулей, в зависимости от целевого устройства IoT Edge. 
   * **Выходные переменные**. К выходным переменным относится справочное имя, которое можно использовать для настройки пути к файлу, где будет создан файл deployment.json. Укажите какое-нибудь запоминающееся справочное имя, например **edge**. 

7. Выберите вторую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача передает все образы модулей в выбранный реестр контейнеров. Она также добавляет ваши учетные данные реестра контейнеров в файл **deployment.json** таким образом, чтобы устройство IoT Edge могло получать доступ к образам модулей. 

   * **Отображаемое имя**. Отображаемое имя автоматически обновляется при изменении поля действия. 
   * **Действие**: В раскрывающемся списке выберите **Push module images** (Отправка образов модулей). 
   * **Тип реестра контейнеров**. Выберите тип реестра контейнеров, используемый для хранения образов модулей. Форма меняется в зависимости от выбранного типа реестра. Если вы выберете **Реестр контейнеров Azure**, используйте раскрывающиеся списки, чтобы выбрать подписку Azure и имя реестра контейнеров. При выборе **универсального реестра контейнеров** щелкните **Создать**, чтобы создать подключение к службе реестра. 
   * **Файл template.json**. Нажмите кнопку с многоточием ( **...** ) и перейдите к файлу **deployment.template.json** в репозитории, где содержится решение IoT Edge. 
   * **Платформа по умолчанию**. Выберите ту же платформу, что и для созданных образов модулей.

   Если для размещения образов модулей вы используете несколько реестров контейнеров, создайте дубликат этой задачи и выберите в нем другой реестр контейнеров, затем разместите действие **Bypass module(s)** (Обойти модуль/модули) в разделе дополнительных параметров, чтобы пропускать образы, не имеющие отношение к конкретному реестру.

8. Выберите задачу **Publish Build Artifacts** (Публикация артефактов сборки), чтобы изменить его. Укажите путь к файлу развертывания, созданному задачей сборки. Задайте значение **пути для публикации**, соответствующее выходной переменной, установленной в задаче сборки модуля. Например, `$(edge.DEPLOYMENT_FILE_PATH)`. Оставьте другие значения по умолчанию. 

9. Откройте вкладку **Триггеры** и установите флажок **Enable continuous integration** (Включить непрерывную интеграцию). Убедитесь, что включена ветвь, содержащая ваш код.

    ![Включение триггера непрерывной интеграции](./media/how-to-ci-cd/configure-trigger.png)

10. Сохраните новый конвейер сборки кнопкой **Сохранить**.

Этот конвейер настроен на автоматический запуск при отправке нового кода в репозиторий. Последняя задача, публикация артефактов конвейера, активирует конвейер выпуска. Перейдите к следующему разделу для создания конвейера выпуска. 

## <a name="configure-continuous-deployment"></a>настройка непрерывного развертывания;
В этом разделе описано, как создать конвейер выпуска, настроенный для автоматического запуска при получении артефакта от конвейера сборки и отображения журналов сборки в Azure Pipelines.

В этом разделе показано, как создать два различных этапа: один для тестовых развертываний, а другой — для рабочих. 

### <a name="create-test-stage"></a>Создание этапа тестирования

Создайте конвейер и настройте его первый этап для развертываний контроля качества. 

1. На вкладке **Releases** (Выпуски) выберите **+ New pipeline** (Создать конвейер). Если у вас уже есть конвейеры выпуска, нажмите кнопку **+ Создать** и щелкните **+ Создать конвейер выпуска**.  

    ![Добавление конвейера выпуска](./media/how-to-ci-cd/add-release-pipeline.png)

2. Когда будет предложено выбрать шаблон, выберите с **пустым заданием**.

    ![Начало работы с пустым заданием](./media/how-to-ci-cd/start-with-empty-job.png)

3. Ваш новый конвейер выпуска инициализируется с одним этапом, который называется **Этап 1**. Переименуйте этап 1 в **QA**. Это будет тестовая среда. Обычно в конвейерах непрерывного развертывания есть несколько этапов. Вы можете создать дополнительные в зависимости от вашей методики DevOps. Закройте окно сведений об этапе после его переименования. 

    ![Этап создания тестовой среды](./media/how-to-ci-cd/QA-env.png)

4. Свяжите выпуск с артефактами сборки, опубликованными конвейером сборки. Щелкните **Add** (Добавить) в области артефактов.

   ![Добавление артефактов](./media/how-to-ci-cd/add-artifacts.png)  
    
5. На **странице добавления артефакта** выберите тип источника **Сборка**. Затем выберите созданный проект и конвейер сборки. а затем щелкните **Добавить**.

   ![Добавление артефакта сборки](./media/how-to-ci-cd/add-an-artifact.png)

6. Откройте триггеры артефакта и выберите переключатель для включения триггера непрерывного развертывания. Теперь новый выпуск будет создаваться каждый раз, когда новая сборка становится доступной.

   ![Настройка триггера непрерывного развертывания](./media/how-to-ci-cd/add-a-trigger.png)

7. Этап **QA** предварительно настроен с одним заданием и без задач. В меню конвейера выберите **Задачи**, а затем — этап **QA**.  Выберите число заданий и задач, чтобы настроить задачи на этом этапе.

    ![Настройка задач QA](./media/how-to-ci-cd/view-stage-tasks.png)

8. На этапе контроля качества вы должны увидеть значение по умолчанию: **Agent job** (Задание агента). Вы можете настроить сведения о задании агента, но задача развертывания не зависит от платформы, поэтому вы можете использовать **Hosted VS2017** или **Hosted Ubuntu 1604** в **пуле агентов** (или любой другой агент, управляемый вами). 

9. Щелкните знак плюса ( **+** ), чтобы добавить одну задачу. Найдите и добавьте **Azure IoT Edge**. 

    ![Добавление задач для этапа QA](./media/how-to-ci-cd/add-task-qa.png)

10. Выберите новую задачу Azure IoT Edge и настройте ее, используя следующие значения:

    * **Отображаемое имя**. Отображаемое имя автоматически обновляется при изменении поля действия. 
    * **Действие**: В раскрывающемся списке выберите **Deploy to IoT Edge device** (Развертывание на устройство IoT Edge). В случае изменения значения действия для соответствия также обновляется отображаемое имя задачи.
    * **Подписка Azure**: Выберите подписку, которая содержит Центр Интернета вещей.
    * **Имя Центра Интернета вещей**. Выберите нужный Центр Интернета вещей. 
    * **Choose single/multiple device** (Выберите одно или несколько устройств). Выберите, как следует развернуть конвейер выпуска: на одно или несколько устройств. 
      * При развертывании на одно устройство введите **идентификатор устройства IoT Edge**. 
      * При развертывании на нескольких устройствах следует указать **целевое условие** устройства. Целевое условие используется как фильтр для сопоставления с набором устройств Edge в Центре Интернета вещей. Если в качестве условия вы решите использовать теги устройства, не забудьте обновить соответствующие теги устройств в двойниках устройств Центра Интернета вещей. Обновите **идентификатор развертывания** и **приоритет развертывания IoT Edge** в разделе дополнительных параметров. Дополнительные сведения о создании развертывания для нескольких устройств см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в требуемом масштабе](module-deployment-monitoring.md).

11. Выберите **Сохранить**, чтобы сохранить изменения в новом конвейере выпуска. Вернитесь в представление конвейера, выбрав **Конвейер** в меню. 

### <a name="create-production-stage"></a>Создание этапа для рабочего развертывания

Создайте второй этап в конвейере выпуска для рабочего развертывания. 

1. Сделайте второй этап для рабочей среды путем клонирования этапа контроля качества. Наведите курсор на этап контроля качества, а затем нажмите кнопку клонирования. 

    ![Клонирование этапа](./media/how-to-ci-cd/clone-stage.png)

2. Выберите новый этап под названием **Копия QA**, чтобы открыть его свойства. Измените имя этапа, указав **PROD** для рабочей среды. Закройте окно свойств этапа. 

3. Чтобы открыть задачи этапа PROD, выберите **Задачи** в меню конвейера, а затем выберите этап **PROD**. 

4. Выберите задачу Azure IoT Edge, чтобы настроить ее для рабочей среды. Параметры развертывания, скорее всего, совпадают для этапов QA и PROD, за исключением того, что вы хотите сделать целевым объектом другое устройство или набор устройств в рабочей среде. Обновите поле идентификатора устройства или поля целевого условия и идентификатора развертывания, указав сведения о ваших устройствах для рабочей среды. 

5. Сохраните его кнопкой **Сохранить**. Затем щелкните **Конвейер**, чтобы вернуться к представлению конвейера.
    
6. Сейчас конвейер выпуска настроен так, что каждый раз при создании новой сборки артефакт сборки будет активировать этап **QA**, а затем **PROD**. Однако обычно требуется интегрировать некоторые тестовые случаи на устройства контроля качества и вручную утвердить развертывание для рабочей среды. Следуйте инструкциям ниже, чтобы создать условие утверждения для этапа PROD:

    1. Откройте панель параметров **Pre-deployment conditions** (Условия перед развертыванием).

        ![Открытие условий перед развертыванием](./media/how-to-ci-cd/pre-deploy-conditions.png)    

    2. Переведите переключатель **Pre-deployment conditions** (Условия перед развертыванием) в положение **Включено**. Добавьте одного или несколько пользователей или групп в поле **Утверждающие лица** и настройте другие необходимые политики утверждения. Чтобы сохранить изменения, закройте панель предварительных условий развертывания.
    
       ![Настройка условий](./media/how-to-ci-cd/set-pre-deployment-conditions.png)


7. Сохраните конвейер выпуска, нажав кнопку **Сохранить**. 

    
## <a name="verify-iot-edge-cicd-with-the-build-and-release-pipelines"></a>Проверка CI/CD для IoT Edge с использованием конвейеров сборки и выпуска

Чтобы запустить задание сборки, можно создать фиксацию в репозитории исходного кода или активировать задание вручную. В этом разделе вы вручную запускаете конвейер CI/CD для проверки правильности его работы. Затем вы проверите успешность развертывания.

1. Перейдите в конвейер сборки, созданный в начале этой статьи. 

2. Чтобы запустить задание сборки в конвейере сборки, нажмите кнопку **Очередь**, как показано на следующем снимке экрана.

    ![Ручной триггер](./media/how-to-ci-cd/manual-trigger.png)

3. Выберите задание сборки, чтобы просмотреть ход его выполнения. Если конвейер сборки завершится успешно, он активирует выпуск для этапа **QA**. 

    ![Журналы сборки](./media/how-to-ci-cd/build-logs.png)

4. Успешное развертывание для этапа **QA** активирует отправку уведомления утверждающему. Убедитесь, что модули успешно развернуты в одно или несколько устройств, на которые нацелен этап контроля качества. Затем перейдите к конвейеру выпуска и дайте разрешение на переход к этапу PROD, нажав кнопку **PROD**, а затем выбрав **Подтвердить**. 

    ![Ожидающие утверждения](./media/how-to-ci-cd/pending-approval.png)

5. После того, как утверждающий утвердит изменение, его можно развернуть в **PROD**.

## <a name="next-steps"></a>Дальнейшие действия

* Основные сведения о развертывании IoT Edge см. в статье [Understand IoT Edge deployments for single devices or at scale](module-deployment-monitoring.md) (Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе).
* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
