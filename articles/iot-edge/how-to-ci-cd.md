---
title: Непрерывная интеграция & непрерывное развертывание - Azure IoT Edge
description: Настройка непрерывной интеграции и непрерывного развертывания в Azure IoT Edge с использованием Azure DevOps, Azure Pipelines
author: shizn
manager: philmea
ms.author: xshi
ms.date: 08/20/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 4b99e83a8e71b13183c76321c7076b85a212f021
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76510980"
---
# <a name="continuous-integration-and-continuous-deployment-to-azure-iot-edge"></a>Непрерывная интеграция и непрерывное развертывание в Azure IoT Edge

Вы можете легко внедрить DevOps для приложений Azure IoT Edge, используя встроенные задания Azure IoT Edge в Azure Pipelines. В этой статье показано, как с помощью функций непрерывной интеграции и непрерывного развертывания, предоставляемых Azure Pipelines, быстро и эффективно выполнять сборку, тестирование и развертывание приложений в Azure IoT Edge.

![Схема ветвей CI и CD для разработки и эксплуатации](./media/how-to-ci-cd/cd.png)

Из этой статьи вы узнаете, как с помощью встроенных задач Azure IoT Edge в Azure Pipelines создать два конвейера для вашего решения IoT Edge. В задачах Azure IoT Edge можно использовать четыре действия.

* **Azure IoT Edge - Изображения модулей сборки** принимают код решения IoT Edge и создают изображения контейнеров.
* **Azure IoT Edge - Push Module Images** толкает изображения модуля в указанный вами реестр контейнеров.
* **Azure IoT Edge - Generate Deployment Manifest** принимает файл deployment.template.json и переменные, а затем генерирует окончательный файл развертывания IoT Edge.
* **Azure IoT Edge - Развертывание устройств IoT Edge** помогает создавать развертывание IoT Edge для одно-множественных устройств IoT Edge.

## <a name="prerequisites"></a>Предварительные требования

* Репозиторий Azure Repos. Если у вас его нет, вы можете [создать репозиторий Git в проекте](https://docs.microsoft.com/azure/devops/repos/git/create-new-repo?view=vsts&tabs=new-nav).
* Решение IoT Edge, зафиксированное и отправленное в репозиторий. Если вы хотите создать пример решения для тестирования инструкций в этой статье, следуйте шагам, изложенным в статье [Использование Visual Studio Code для разработки и отладки модулей для Azure IoT Edge](how-to-vs-code-develop-module.md) или [Сведения об использовании Visual Studio 2017 для разработки и отладки модулей C# для Azure IoT Edge (предварительная версия)](how-to-visual-studio-develop-csharp-module.md).

   Все, что требуется в этой статье, — это папка решения, созданная по шаблону IoT Edge в Visual Studio Code или Visual Studio. Вам не требуется создавать, отправлять, развертывать или отлаживать этот код, чтобы продолжить. Необходимо настроить эти процессы в Azure Pipelines.

   Если вы создаете решение, сначала клонируйте репозиторий локально. Затем вы сможете создать решение непосредственно в папке репозитория. Кроме того, вы можете легко фиксировать и отправлять файлы из нее.

* Реестр контейнеров, в который можно отправлять образы модулей. Вы можете использовать [Реестр контейнеров Azure](https://docs.microsoft.com/azure/container-registry/) или сторонний реестр.
* Активный [Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) по крайней мере с одним устройством IoT Edge для тестирования отдельных этапов тестового и рабочего развертывания. Следуйте кратким руководствам, чтобы создать устройство IoT Edge в [Linux](quickstart-linux.md) или [Windows](quickstart.md).

Дополнительные сведения об использовании Azure Repos см. в статье [Share your code with Visual Studio 2015 and Azure Repos](https://docs.microsoft.com/azure/devops/repos/git/share-your-code-in-git-vs?view=vsts) (Предоставление общего доступа к коду с помощью Visual Studio и Azure Repos).

## <a name="configure-continuous-integration"></a>Настройка непрерывной интеграции

В этом разделе показано, как создать конвейер сборки. Настройте конвейер на автоматический запуск при регистрации любых изменений в примере решения IoT Edge и публикации журналов сборки.

>[!NOTE]
>В этой статье используется визуальный конструктор Azure DevOps. Прежде чем выполнять действия, описанные в этом разделе, отключите эту предварительную версию функции для нового интерфейса создания конвейера YAML.
>
>1. В Azure DevOps щелкните значок своего профиля, а затем выберите **Функции предварительной версии**.
>2. Отключите **новый интерфейс для создания конвейеров YAML**.
>
>Дополнительные сведения см. в разделе о [создании конвейера сборки](https://docs.microsoft.com/azure/devops/pipelines/create-first-pipeline).

1. Вопийте в организации Azure DevOps**\/(https: /dev.azure.com/'your organization)** и откройте проект, содержащий репозиторий решения IoT Edge.

   В этой статье мы создали репозиторий, который называется **IoTEdgeRepo**. Этот репозиторий содержит **IoTEdgeSolution** с кодом для модуля под названием **filtermodule**.

   ![Открытие своего проекта DevOps](./media/how-to-ci-cd/init-project.png)

2. Перейдите к Azure Pipelines в проекте. Откройте вкладку **Сборки** и выберите **Новый конвейер**. Если же конвейеры сборки уже есть, нажмите кнопку **Создать**. Затем выберите **Новый конвейер сборки**.

    ![Создание конвейера сборки](./media/how-to-ci-cd/add-new-build.png)

3. Следуйте инструкциям на экране для создания конвейера.

   1. Укажите сведения об источнике для нового конвейера сборки. Выберите **Azure Repos Git** в качестве источника, а затем выберите проект, репозиторий и ветвь, в которой расположен код решения IoT Edge. Затем выберите **Продолжить**.

      ![Выбор источника конвейера](./media/how-to-ci-cd/pipeline-source.png)

   2. Выберите **Пустое задание** вместо шаблона.

      ![Начало работы с пустым проектом](./media/how-to-ci-cd/start-with-empty.png)

4. После создания конвейера вы перейдете в редактор конвейера. В описании конвейера выберите правильный пул агентов, в зависимости от целевой платформы:

   * Если вы хотите компилировать модули на платформе amd64 для контейнеров Linux, выберите **Hosted Ubuntu 1604** (Размещение в Ubuntu 1604).

   * Если вы хотите создавать модули на платформе amd64 для контейнеров Windows 1809, вам необходимо [настроить агента в Windows в локальной среде](https://docs.microsoft.com/azure/devops/pipelines/agents/v2-windows?view=vsts).

   * Если вы хотите построить свои модули в платформе arm32v7 или arm64 для контейнеров Linux, вам нужно [настроить самохауляток агента на Linux.](https://blogs.msdn.microsoft.com/iotdev/2018/11/13/setup-azure-iot-edge-ci-cd-pipeline-with-arm-agent/)

     ![Настройка пула агентов сборки](./media/how-to-ci-cd/configure-env.png)

5. Конвейер предварительно настроен с заданием **Agent job 1** (Задание агента 1). Выберите знак**+** плюс (), чтобы добавить три задачи в задание: **Azure IoT Edge** дважды, **копирование файлов** один раз и **публикация артефактов сборки** один раз. (Наведите указатель мыши на имя каждой задачи, чтобы увидеть кнопку **Добавить**.)

   ![Добавление задачи Azure IoT Edge](./media/how-to-ci-cd/add-iot-edge-task.png)

   При добавлении всех четырех задач задание агента выглядит следующим примером:

   ![Три задачи в конвейер сборки](./media/how-to-ci-cd/add-tasks.png)

6. Выберите первую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача создает все модули в решении с целевой платформой, которую вы указываете.

   * **Имя дисплея**: Примите **изображение Модуля Azure По умолчанию - Сборка изображений модуля.**
   * **Действие**: Примите **изображения модуля сборки**по умолчанию.
   * **Файл .template.json:** Выберите эллипсис **(...)** и перейдите к файлу **deployment.template.json** в репозитории, содержащем решение IoT Edge.
   * **Платформа по умолчанию:** Выберите подходящую платформу для модулей на основе целевого устройства IoT Edge.
   * **Переменные вывода:** Выходные переменные включают эталонное имя, которое можно использовать для настройки пути файла, по которому будет сгенерирован файл deployment.json. Укажите какое-нибудь запоминающееся справочное имя, например **edge**.

7. Выберите вторую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача передает все образы модулей в выбранный реестр контейнеров.

   * **Имя дисплея**: Имя дисплея автоматически обновляется при изменении поля действия.
   * **Действие**: Используйте список выпадающих, чтобы выбрать **изображения модуля Push.**
   * **Тип реестра контейнеров**: Выберите тип реестра контейнеров, который используется для хранения изображений модуля. Форма меняется в зависимости от выбранного типа реестра. Если вы выберете **Реестр контейнеров Azure**, используйте раскрывающиеся списки, чтобы выбрать подписку Azure и имя реестра контейнеров. При выборе **универсального реестра контейнеров** щелкните **Создать**, чтобы создать подключение к службе реестра.
   * **Файл .template.json:** Выберите эллипсис **(...)** и перейдите к файлу **deployment.template.json** в репозитории, содержащем решение IoT Edge.
   * **Платформа по умолчанию:** Выберите ту же платформу, что и изображения построенного модуля.

   Если для размещения образов модулей вы используете несколько реестров контейнеров, создайте дубликат этой задачи и выберите в нем другой реестр контейнеров, затем разместите действие **Bypass module(s)** (Обойти модуль/модули) в разделе дополнительных параметров, чтобы пропускать образы, не имеющие отношение к конкретному реестру.

8. Выберите задачу **копирования файлов,** чтобы отсвазать ее. Используйте эту задачу для копирования файлов в каталог постановки артефактов.

   * **Отображение имени**: Копировать файлы: Капля папку.
   * **Содержимое**: Поместите две `deployment.template.json` `**/module.json`строки в этом разделе, и . Эти два типа файлов являются входными данными для генерации манифеста развертывания IoT Edge. Необходимо скопировать в папку постановки артефакта и опубликовать для конвейера выпуска.
   * **Целевой Фолдер**: `$(Build.ArtifactStagingDirectory)`Поместите переменную . Ознакомьтесь с [переменными Build,](https://docs.microsoft.com/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#build-variables) чтобы узнать об описании.

9. Выберите задачу **Publish Build Artifacts** (Публикация артефактов сборки), чтобы изменить его. Предоставьте путь постановки каталога артефактов к задаче, чтобы можно было опубликовать путь для выпуска конвейера.

   * **Название дисплея**: Опубликовать Артефакт: падение.
   * **Путь к публикации** `$(Build.ArtifactStagingDirectory)`: Поместите переменную . Ознакомьтесь с [переменными Build,](https://docs.microsoft.com/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#build-variables) чтобы узнать об описании.
   * **Название артефакта**: падение.
   * **Артефакт публикует местоположение**: Лазурные трубопроводы.

10. Откройте вкладку **Триггеры** и установите флажок **Enable continuous integration** (Включить непрерывную интеграцию). Убедитесь, что включена ветвь, содержащая ваш код.

    ![Включение триггера непрерывной интеграции](./media/how-to-ci-cd/configure-trigger.png)

11. Сохраните новый конвейер сборки кнопкой **Сохранить**.

Этот конвейер настроен на автоматический запуск при отправке нового кода в репозиторий. Последняя задача, публикация артефактов конвейера, активирует конвейер выпуска. Перейдите к следующему разделу для создания конвейера выпуска.

## <a name="configure-continuous-deployment"></a>настройка непрерывного развертывания;

В этом разделе описано, как создать конвейер выпуска, настроенный для автоматического запуска при получении артефакта от конвейера сборки и отображения журналов сборки в Azure Pipelines.

Создание нового конвейера и добавление нового этапа

1. На вкладке **Releases** (Выпуски) выберите **+ New pipeline** (Создать конвейер). Если у вас уже есть конвейеры выпуска, нажмите кнопку **+ Создать** и щелкните **+ Создать конвейер выпуска**.  

    ![Добавление конвейера выпуска](./media/how-to-ci-cd/add-release-pipeline.png)

2. Когда будет предложено выбрать шаблон, выберите с **пустым заданием**.

    ![Начало работы с пустым заданием](./media/how-to-ci-cd/start-with-empty-job.png)

3. Ваш новый конвейер выпуска инициализируется с одним этапом, который называется **Этап 1**. Переименуйте этап 1 для **разработки** и рассматривать его как тестовую среду. Как правило, непрерывные конвейеры развертывания имеют несколько этапов, включая **dev,** **staging** и **prod.** Вы можете создать больше на основе вашей практики DevOps. Закройте окно сведений об этапе после его переименования.

4. Свяжите выпуск с артефактами сборки, опубликованными конвейером сборки. Щелкните **Add** (Добавить) в области артефактов.

   ![Добавление артефактов](./media/how-to-ci-cd/add-artifacts.png)  

5. На **странице добавления артефакта** выберите тип источника **Сборка**. Затем выберите созданный проект и конвейер сборки. Затем выберите **Добавить**.

   ![Добавление артефакта сборки](./media/how-to-ci-cd/add-an-artifact.png)

6. Откройте триггеры артефакта и выберите переключатель для включения триггера непрерывного развертывания. Теперь новый выпуск будет создаваться каждый раз, когда новая сборка становится доступной.

   ![Настройка триггера непрерывного развертывания](./media/how-to-ci-cd/add-a-trigger.png)

7. Стадия **разработки** предварительно настроена с одним заданием и нулевыми задачами. Из меню конвейера выберите **Задачи,** а затем выберите этап **разработки.**  Выберите число заданий и задач, чтобы настроить задачи на этом этапе.

    ![Настройка задач разработчиков](./media/how-to-ci-cd/view-stage-tasks.png)

8. На этапе **разработки** вы должны увидеть **задание агента**по умолчанию. Вы можете настроить сведения о задании агента, но задача развертывания не зависит от платформы, поэтому вы можете использовать **Hosted VS2017** или **Hosted Ubuntu 1604** в **пуле агентов** (или любой другой агент, управляемый вами).

9. Выберите знак**+** плюс (), чтобы добавить две задачи. Поиск и добавление **Azure IoT Edge** дважды.

    ![Добавление задач для dev](./media/how-to-ci-cd/add-task-qa.png)

10. Выберите первую задачу **Azure IoT Edge** и наверсните ее со следующими значениями:

    * **Имя дисплея**: Имя дисплея автоматически обновляется при изменении поля действия.
    * **Действие**: Используйте список выпадающих средств для выбора **манифеста развертывания Generate.** В случае изменения значения действия для соответствия также обновляется отображаемое имя задачи.
    * **файл .template.json**: `$(System.DefaultWorkingDirectory)/Drop/drop/deployment.template.json`Положите путь . Путь публикуется из конвейера сборки.
    * **Платформа по умолчанию**: Выберите то же значение при создании изображений модуля.
    * **Путь вывода:** Положите `$(System.DefaultWorkingDirectory)/Drop/drop/configs/deployment.json`путь . Этот путь является окончательным файлом развертывания IoT Edge.

    Эти конфигурации помогают заменить URL-адреса изображения модуля в файле. `deployment.template.json` **Манифест развертывания Generate** также помогает заменить переменные точным `deployment.template.json` значением, определенным в файле. В коде VS/VS вы указываете фактическое значение в файле. `.env` В azure Pipelines вы устанавливаете значение во вкладке Переменных конвейеров выпуска. Перейдите к вкладке Переменных и назначаем имя и значение следующим образом.

    * **ACR_ADDRESS**адрес реестра контейнеров Azure.
    * **ACR_PASSWORD**: Пароль реестра контейнеров Azure.
    * **ACR_USER**: Имя пользователя реестра контейнеров Azure.

    Если в проекте есть другие переменные, можно указать имя и значение в этой вкладке. Манифест **развертывания Generate** может распознавать `${VARIABLE}` только переменные во вкусе, убедитесь, что вы используете это в своих `*.template.json` файлах.

    ![Настройка переменных для конвейера выпуска](./media/how-to-ci-cd/configure-variables.png)

11. Выберите вторую задачу **Azure IoT Edge** и наверсните ее со следующими значениями:

    * **Имя дисплея**: Имя дисплея автоматически обновляется при изменении поля действия.
    * **Действие**: Используйте список выпадающих, чтобы выбрать **Развертывание устройств IoT Edge.** В случае изменения значения действия для соответствия также обновляется отображаемое имя задачи.
    * **Подписка Azure:** Выберите подписку, содержащую концентратор IoT.
    * **Имя концентратора IoT:** Выберите концентратор IoT.
    * **Выберите одно-несколько устройств:** Выберите, хотите ли вы развернуть конвейер выпуска на одном устройстве или нескольких устройствах.
      * При развертывании на одно устройство введите **идентификатор устройства IoT Edge**.
      * При развертывании на нескольких устройствах следует указать **целевое условие** устройства. Целевым условием является фильтр, который соответствует набору устройств IoT Edge в Концентраторе IoT. Если в качестве условия вы решите использовать теги устройства, не забудьте обновить соответствующие теги устройств в двойниках устройств Центра Интернета вещей. Обновите **идентификатор развертывания** и **приоритет развертывания IoT Edge** в разделе дополнительных параметров. Дополнительные сведения о создании развертывания для нескольких устройств см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в требуемом масштабе](module-deployment-monitoring.md).
    * Расширьте расширенные настройки, выберите **идентификатор развертывания IoT Edge,** поместите переменную. `$(System.TeamProject)-$(Release.EnvironmentName)` Это отображает имя проекта и имя релиза с идентификатором развертывания IoT Edge.

12. Выберите **Сохранить**, чтобы сохранить изменения в новом конвейере выпуска. Вернитесь в представление конвейера, выбрав **Конвейер** в меню.

## <a name="verify-iot-edge-cicd-with-the-build-and-release-pipelines"></a>Проверка CI/CD для IoT Edge с использованием конвейеров сборки и выпуска

Чтобы запустить задание сборки, можно создать фиксацию в репозитории исходного кода или активировать задание вручную. В этом разделе вы вручную запускаете конвейер CI/CD для проверки правильности его работы. Затем вы проверите успешность развертывания.

1. Перейдите в конвейер сборки, созданный в начале этой статьи.

2. Чтобы запустить задание сборки в конвейере сборки, нажмите кнопку **Очередь**, как показано на следующем снимке экрана.

    ![Ручной триггер](./media/how-to-ci-cd/manual-trigger.png)

3. Выберите задание сборки, чтобы просмотреть ход его выполнения. Если конвейер сборки завершен успешно, он запускает выпуск на стадию **разработки.**

    ![Журналы сборки](./media/how-to-ci-cd/build-logs.png)

4. Успешный **релиз разработчиков** создает развертывание IoT Edge для таргетинга устройств IoT Edge.

    ![Освобождение для разработчика](./media/how-to-ci-cd/pending-approval.png)

5. Нажмите на этап **dev,** чтобы увидеть журналы релизов.

    ![Журналы выпуска](./media/how-to-ci-cd/release-logs.png)

## <a name="next-steps"></a>Дальнейшие действия

* Пример передового опыта IoT Edge DevOps в [проекте Azure DevOps для IoT Edge](how-to-devops-project.md)
* Основные сведения о развертывании IoT Edge см. в статье [Understand IoT Edge deployments for single devices or at scale](module-deployment-monitoring.md) (Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе).
* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
