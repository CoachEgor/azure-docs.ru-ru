---
title: Подключение подчиненных устройств — Azure IoT Edge | Документация Майкрософт
description: Как настроить более низком уровне или конечных устройств для подключения к устройствам шлюза Edge Интернета вещей Azure.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 06/07/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 7a66355ca1a0c9c2c144f04cd944efe22467d3ae
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67058512"
---
# <a name="connect-a-downstream-device-to-an-azure-iot-edge-gateway"></a>Подключение подчиненного устройства к шлюзу Azure IoT Edge

В этой статье инструкции для установления доверительное соединение между подчиненными устройствами и прозрачный шлюзам IoT Edge. В случае прозрачного шлюза одно или несколько устройств можно передать свои сообщения через устройство одного шлюза, который поддерживает подключение к центру Интернета вещей. Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Подчиненное устройство может быть приложение, работающее на самом устройстве шлюза Edge Интернета вещей. 

Существует три общих действия для настройки подключения успешно прозрачного шлюза. В этой статье описывается третий шаг:

1. Устройство шлюза необходимо безопасно подключиться к подчиненных устройств, получать сообщения из подчиненных устройств и маршрутизировать сообщения нужному адресату. Дополнительные сведения см. в разделе [настроить устройство IoT Edge в качестве прозрачного шлюза](how-to-create-transparent-gateway.md).
2. Подчиненное устройство должно удостоверения устройства, чтобы иметь возможность проверки подлинности с помощью центра Интернета вещей и знать для обмена данными через его устройство шлюза. Дополнительные сведения см. в разделе [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md).
3. **Подчиненное устройство необходимо иметь возможность безопасного подключения к его устройство шлюза.**

В этой статье описаны распространенные проблемы с подключениями подчиненных устройств, приведены инструкции по настройке подчиненных устройств и представлены следующие сведения: 

* принципы работы безопасности транспортного уровня (TLS) и сертификатов; 
* сведения о работе библиотек TLS и использовании сертификатов в разных операционных системах;
* пошаговое руководство по примерам Azure IoT на нескольких языках, которые помогут вам быстро приступить к работе. 

В этой статье под терминами *шлюз* и *шлюз IoT Edge* подразумевается устройство IoT Edge, которое настроенное в качестве прозрачного шлюза. 

## <a name="prepare-a-downstream-device"></a>Подготовка подчиненного устройства

Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Подчиненное устройство может быть приложение, работающее на самом устройстве шлюза Edge Интернета вещей. 

Чтобы подключить подчиненное устройство к шлюзу Azure IoT Edge, вам потребуются следующие два компонента:

* Устройство или приложение, в настройках которого указана строка подключения устройств Центра Интернета вещей с данными для подключения к шлюзу. 

    Этот шаг описан в [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md).

* Устройство или приложение должно доверять шлюза **корневой ЦС** сертификата для проверки подключений по протоколу TLS к устройству шлюза. 

    Этот шаг описан подробно в оставшейся части этой статьи. Этот шаг может быть выполнено одно из двух способов: путем установки сертификата ЦС в хранилище сертификатов операционной системы или (для некоторых языков), ссылаясь на сертификат в приложениях с помощью пакетов SDK Интернета вещей Azure.

## <a name="tls-and-certificate-fundamentals"></a>Основные сведения о TLS и сертификатах

При создании безопасного подключения между подчиненными устройствами и IoT Edge возникают такие же трудности, как и при любом обмене данными через Интернет в режиме "клиент — сервер". Клиент и сервер безопасно обмениваются данными через Интернет по [протоколу TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security). Протокол TLS основан на конструкциях стандарта [инфраструктуры открытых ключей (PKI)](https://en.wikipedia.org/wiki/Public_key_infrastructure), называемых сертификатами. TLS представляет собой спецификацию весьма запутанным и адресов самые разнообразные темы, относящиеся к защите две конечные точки. В этом разделе перечислены основные понятия, относящиеся к вам для безопасного подключения устройств к шлюзу IoT Edge.

Когда клиент подключается к серверу, сервер предоставляет ему *цепочку сертификатов сервера*. Такая цепочка обычно состоит из сертификата корневого ЦС, одного или нескольких сертификатов промежуточных ЦС, и сертификата самого сервера. Клиент устанавливает отношения доверия с сервером, криптографически проверяя всю цепочку сертификатов сервера. Проверку клиента цепочка сертификатов сервера называется *проверку цепочки server*. Клиент запрашивает криптографически службы подтверждающего владение закрытый ключ, связанный с сертификатом сервера в процессе, называемом *проверки принадлежности*. Сочетание проверки цепочки сервера и подтверждение владения вызывается *проверки подлинности сервера*. Чтобы проверить цепочку сертификатов сервера, клиенту нужна копия сертификата корневого ЦС, который использовался для создания (выдачи) этого сертификата сервера. Обычно браузеры при подключении к веб-сайтам используют предварительно настроенный набор часто используемых сертификатов ЦС, оптимизируя работу клиента. 

Когда устройство подключается к Центру Интернета вещей, оно выполняет роль клиента облачной службы, а служба Центра Интернета вещей представляет собой сервер. Облачная служба Центра Интернета вещей поддерживается сертификатом корневого ЦС с именем **Baltimore CyberTrust Root**, который является общедоступным и широко распространенным. Так как сертификат ЦС для Центра Интернета вещей уже установлен на большинстве устройств, во многих реализациях TLS (OpenSSL, Schannel, LibreSSL) он автоматически используется для проверки сертификата сервера. Возможна ситуация, когда устройство успешно подключается к Центру Интернета вещей, но при попытке подключения к шлюзу IoT Edge возникают проблемы.

Когда устройство подключается к шлюзу IoT Edge, подчиненное устройство выполняет роль клиента, а устройство шлюза представляет собой сервер. Azure IoT Edge позволяет операторам (или пользователям) по своему усмотрению создавать любые цепочки сертификатов шлюза. Оператор может использовать сертификат общедоступного ЦС, например Baltimore, или самозаверяющий сертификат внутреннего корневого ЦС. Сертификаты общедоступных ЦС часто предоставляются за плату, что делает их использование более оправданным для рабочих сценариев. Самозаверяющие сертификаты удобны для разработки и тестирования. Настройка прозрачного шлюза, статьями во введении использовать самозаверяющие корневые сертификаты. 

Если вы используете для шлюза IoT Edge самозаверяющий корневой сертификат, он должен быть установлен или предоставлен для всех подчиненных устройств, которые будут подключаться к этому шлюзу. 

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

Дополнительные сведения о сертификатах IoT Edge и некоторых ограничениях для рабочей среды см. в статье [Сведения об использовании сертификатов Azure IoT Edge](iot-edge-certs.md).

## <a name="provide-the-root-ca-certificate"></a>Предоставьте сертификат корневого ЦС

Для проверки сертификатов устройства шлюза, подчиненное устройство необходимо свою собственную копию корневого центра сертификации. Если вы использовали скрипты, предоставленные в репозитории git IoT Edge для создания тестовых сертификатов, а затем вызывается сертификат корневого ЦС **azure-iot теста only.root.ca.cert.pem**. Если вы не вошли как часть на этапе подготовки подчиненное устройство, переместите этот файл сертификата в любой каталог на устройстве подчиненных. Можно использовать службу, например [Azure Key Vault](https://docs.microsoft.com/azure/key-vault) или функцией, такой как [протокол безопасного копирования](https://www.ssh.com/ssh/scp/) переместить файл сертификата.

## <a name="install-certificates-in-the-os"></a>Установка сертификатов в операционной системе

Установка корневого центра сертификации в хранилище сертификатов операционной системы обычно позволяет большинство приложений для использования сертификат корневого ЦС. Существуют некоторые исключения, например NodeJS приложений, которые не используют сертификат операционной системы хранения, но с помощью среды выполнения узла внутреннем хранилище сертификатов. Если не удается установить сертификат на уровне операционной системы, перейти к шагу [использовать сертификаты с Azure IoT SDKs](#use-certificates-with-azure-iot-sdks). 

### <a name="ubuntu"></a>Ubuntu

Команды из следующего примера устанавливают сертификат ЦС на узле под управлением ОС Ubuntu. В этом примере предполагается, что вы используете **azure-iot теста only.root.ca.cert.pem** сертификат, полученный в статьях предварительные требования, и вы скопировали сертификат в расположение на подчиненное устройство.

```bash
sudo cp <path>/azure-iot-test-only.root.ca.cert.pem /usr/local/share/ca-certificates/azure-iot-test-only.root.ca.cert.pem.crt
sudo update-ca-certificates
```

Должно отобразиться следующее сообщение: "Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done" (Обновление сертификатов в /etc/ssl/certs... Добавлено: 1, удалено: 0. Готово.).

### <a name="windows"></a>Windows

В следующих шагах описано, как установить сертификат ЦС на узле под управлением ОС Windows. В этом примере предполагается, что вы используете **azure-iot теста only.root.ca.cert.pem** сертификат, полученный в статьях предварительные требования, и вы скопировали сертификат в расположение на подчиненное устройство.

1. В меню "Пуск" выполните поиск по элементу **Управление сертификатами компьютеров**. Откроется служебная программа **certlm**.
2. Откройте **Сертификаты — локальный компьютер** > **Доверенные корневые центры сертификации**.
3. Щелкните правой кнопкой мыши элемент **Сертификаты** и выберите **Все задачи** > **Импорт**. Откроется мастер импорта сертификатов. 
4. Выполните действия по его подсказкам и импортируйте файл сертификата `<path>/azure-iot-test-only.root.ca.cert.pem`. По завершении вы увидите сообщение "Импорт выполнен". 

Можно также установить сертификаты программным способом с помощью API .NET, как показано в примере кода для .NET далее в этой статье. 

Обычно приложения используют стек TLS [Schannel](https://docs.microsoft.com/windows/desktop/com/schannel), предоставляемый ОС Windows, для безопасного подключения через TLS. При использовании Schannel *требуется*, чтобы все сертификаты были установлены в хранилище сертификатов Windows перед попыткой установить TLS-подключение.

## <a name="use-certificates-with-azure-iot-sdks"></a>Использование сертификатов с пакетами SDK для Azure IoT

В этом разделе на примере простых приложений описывается, как пакеты SDK для Azure IoT подключаются к устройству IoT Edge. Все эти примеры пытаются подключить клиент устройства и отправить сообщения телеметрии в шлюз, а затем закрывают подключение и завершают работу. 

Прежде чем использовать примеры уровня приложения, следует подготовить следующие два компонента:

* Строка подключения центра Интернета вещей подчиненное устройство, изменена с целью указания к устройству шлюза и все сертификаты, необходимые для проверки подлинности вашего подчиненного устройства к центру Интернета вещей. Дополнительные сведения см. в разделе [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md).

* Полный путь к сертификату корневого ЦС, который вы скопировали (сохранили) на подчиненное устройство.

    Например, `<path>/azure-iot-test-only.root.ca.cert.pem`. 

### <a name="nodejs"></a>Node.js

Этот раздел содержит пример приложения для подключения клиентского устройства Azure IoT NodeJS к шлюзу IoT Edge. Для приложений, NodeJS необходимо установить сертификат корневого ЦС на уровне приложения, как показано ниже. NodeJS приложения не используют хранилище сертификатов компьютера. 

1. Получите пример файла **edge_downstream_device.js** из [репозитория примеров использования пакета SDK для устройств Azure IoT для Node.js](https://github.com/Azure/azure-iot-sdk-node/tree/master/device/samples). 
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**). 
3. В файле edge_downstream_device.js измените переменные **connectionString** и **edge_ca_cert_path**. 
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве. 

Чтобы помочь вам разобраться в выполняемом примере, мы приводим ниже фрагмент кода, в котором клиентский пакет SDK считывает файл сертификата и использует его для создания безопасного TLS-подключения: 

```javascript
// Provide the Azure IoT device client via setOptions with the X509
// Edge root CA certificate that was used to setup the Edge runtime
var options = {
    ca : fs.readFileSync(edge_ca_cert_path, 'utf-8'),
};
```

### <a name="net"></a>.NET

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT .NET к шлюзу IoT Edge. Приложения .NET могут автоматически применять любые сертификаты, установленные в хранилище сертификатов операционной системы на узлах Windows и Linux.

1. Получите пример для **EdgeDownstreamDevice** из [папки примеров .NET для IoT Edge](https://github.com/Azure/iotedge/tree/master/samples/dotnet/EdgeDownstreamDevice). 
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**). 
3. В файле **Properties/launchSettings.json** измените переменные **DEVICE_CONNECTION_STRING** и **CA_CERTIFICATE_PATH**. Если вы хотите использовать сертификат, установленный в хост-системе в хранилище доверенных сертификатов, оставьте значение этой переменной пустым. 
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве. 

Чтобы установить доверенный сертификат в хранилище сертификатов программным способом с помощью приложения .NET, воспользуйтесь функцией **InstallCACert()** , которая определена в файле **EdgeDownstreamDevice/Program.cs**. Эта операция является идемпотентной, то есть ее можно безопасно выполнять несколько раз и получать одинаковые значения без побочных эффектов. 

### <a name="c"></a>C

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT C к шлюзу IoT Edge. Пакет SDK для C поддерживает множество библиотек TLS, включая OpenSSL, WolfSSL и Schannel. См. дополнительные сведения о [пакете SDK для Azure IoT C](https://github.com/Azure/azure-iot-sdk-c). 

1. Получите приложение **iotedge_downstream_device_sample** из [набора примеров использования пакета SDK для устройств Azure IoT для С](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples). 
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**). 
3. В файле iotedge_downstream_device_sample.c измените переменные **connectionString** и **edge_ca_cert_path**. 
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве. 

Пакет SDK для устройств Azure IoT для C предоставляет возможность зарегистрировать сертификат ЦС при настройке клиента. Эта операция не устанавливает сертификат, а просто использует сертификат в текстовом формате прямо из памяти. Сохраненный сертификат предоставляется базовому стеку TLS при установке подключения. 

```C
(void)IoTHubDeviceClient_SetOption(device_handle, OPTION_TRUSTED_CERT, cert_string);
```

Если вы не используете OpenSSL или другую библиотеку TLS, на узлах Windows пакет SDK по умолчанию применяет Schannel. Чтобы обеспечить правильную работу Schannel, сертификат корневого ЦС для IoT Edge должен быть установлен в хранилище сертификатов Windows, а не с помощью операции `IoTHubDeviceClient_SetOption`. 

### <a name="java"></a>Java

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT Java к шлюзу IoT Edge. 

1. Получите пример **Send-event** из [набора примеров использования пакета SDK для устройств Интернета Azure IoT для Java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples). 
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**). 
3. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве.

### <a name="python"></a>Python

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT Python к шлюзу IoT Edge. 

1. Получите пример **edge_downstream_client** из [набора примеров использования пакета SDK для устройств Azure IoT для Python](https://github.com/Azure/azure-iot-sdk-python/tree/master/device/samples). 
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**). 
3. В файле edge_downstream_client.py измените переменные **CONNECTION_STRING** и **TRUSTED_ROOT_CA_CERTIFICATE_PATH**. 
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве. 


## <a name="test-the-gateway-connection"></a>Тестирование подключения к шлюзу

Это пример команды, которая проверяет, что все, что настроен правильно. Должно отобразиться следующее сообщение: "verified OK" (Проверка выполнена успешно).

```cmd/sh
openssl s_client -connect mygateway.contoso.com:8883 -CAfile <CERTDIR>/certs/azure-iot-test-only.root.ca.cert.pem -showcerts
```

## <a name="troubleshoot-the-gateway-connection"></a>Устранение неполадок с подключением шлюза

Если на устройстве конечного постоянной связи его устройство шлюза, выполните следующие действия для разрешения. 

1. Совпадает имя узла шлюза в строке подключения значение имени узла в файле config.yaml IoT Edge на устройстве шлюза?
2. — Имя узла шлюза, которое разрешается в IP-адрес? Временные соединения можно устранить с помощью DNS или путем добавления записи файла host на конечном устройстве.
3. Открыты порты в брандмауэре? Связи на основе протокола используется (MQTTS:8883 / AMQPS:5671 / HTTPS:433) должен быть между подчиненное устройство и прозрачный IoT Edge.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как IoT Edge расширяет [возможности автономной работы](offline-capabilities.md) для подчиненных устройств. 
