---
title: Подключение подчиненных устройств — Azure IoT Edge | Документация Майкрософт
description: Как настроить устройства вниз по течению или листдляем для подключения к устройствам шлюза Azure IoT Edge.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/08/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
ms.openlocfilehash: 3113f01341d2a1ec6160cfea3eb9d12d18b8495c
ms.sourcegitcommit: acb82fc770128234f2e9222939826e3ade3a2a28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81687184"
---
# <a name="connect-a-downstream-device-to-an-azure-iot-edge-gateway"></a>Подключение подчиненного устройства к шлюзу Azure IoT Edge

В этой статье содержатся инструкции по установлению надежного соединения между устройствами, расположенными ниже по течению, и прозрачными шлюзами IoT Edge. В прозрачном сценарии шлюза одно или несколько устройств могут передавать свои сообщения через одно устройство шлюза, которое поддерживает подключение к IoT Hub. Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Устройство ниже по течению может быть даже приложением, работающим на самом устройстве шлюза IoT Edge.

Существует три общих шага для создания успешного прозрачного подключения шлюза. Эта статья охватывает третий шаг:

1. Устройство шлюза должно безопасно подключаться к устройствам, расположенным ниже по течению, получать сообщения с устройств вниз по течению и направлять сообщения в нужное место назначения. Для получения дополнительной информации [см.](how-to-create-transparent-gateway.md)
2. Устройство ниже по течению нуждается в идентификаторе устройства, чтобы иметь возможность аутентифицировать с помощью IoT Hub, и знать, общаться через его устройство шлюза. Для получения дополнительной информации [см.](how-to-authenticate-downstream-device.md)
3. **Устройство ниже по течению должно безопасно подключиться к устройству шлюза.**

В этой статье описаны распространенные проблемы с подключениями подчиненных устройств, приведены инструкции по настройке подчиненных устройств и представлены следующие сведения:

* принципы работы безопасности транспортного уровня (TLS) и сертификатов;
* сведения о работе библиотек TLS и использовании сертификатов в разных операционных системах;
* пошаговое руководство по примерам Azure IoT на нескольких языках, которые помогут вам быстро приступить к работе.

В этой статье под терминами *шлюз* и *шлюз IoT Edge* подразумевается устройство IoT Edge, которое настроенное в качестве прозрачного шлюза.

## <a name="prerequisites"></a>Предварительные требования

* Поиметь файл сертификата **azure-iot-test-only.root.ca.cert.pem,** который был создан в [настройке устройства IoT Edge, чтобы выступать в качестве прозрачного шлюза,](how-to-create-transparent-gateway.md) доступного на вашем устройстве вниз по течению. Устройство ниже по течению использует этот сертификат для проверки личности устройства шлюза.
* Истойте измененную строку соединения, которая указывает на устройство шлюза, как это объясняется в [Authenticate вниз по течению устройства Azure IoT концентратор.](how-to-authenticate-downstream-device.md)

## <a name="prepare-a-downstream-device"></a>Подготовка подчиненного устройства

Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Устройство ниже по течению может быть даже приложением, работающим на самом устройстве шлюза IoT Edge. Однако другое устройство IoT Edge не может быть ниже по течению шлюза IoT Edge.

>[!NOTE]
>Устройства IoT, зарегистрированные в IoT Hub, могут использовать [близнецов модулей](../iot-hub/iot-hub-devguide-module-twins.md) для изоляции различных процессов, аппаратных средств или функций на одном устройстве. Шлюзы IoT Edge поддерживают соединения нисходящего модуля с использованием симметричной проверки подлинности ключей, но не проверки подлинности сертификата X.509.

Чтобы подключить подчиненное устройство к шлюзу Azure IoT Edge, вам потребуются следующие два компонента:

* Устройство или приложение, в настройках которого указана строка подключения устройств Центра Интернета вещей с данными для подключения к шлюзу.

    Этот шаг объясняется в [Authenticate вниз по течению устройства Azure IoT концентратор](how-to-authenticate-downstream-device.md).

* Устройство или приложение должно доверять корневому сертификату **CA** шлюза для проверки подключений TLS к устройству шлюза.

    Этот шаг подробно описан в остальной части этой статьи. Этот шаг может быть выполнен одним из двух способов: путем установки сертификата CA в магазине сертификатов операционной системы или (для некоторых языков) путем ссылки на сертификат в приложениях с использованием SDK Azure IoT.

## <a name="tls-and-certificate-fundamentals"></a>Основные сведения о TLS и сертификатах

При создании безопасного подключения между подчиненными устройствами и IoT Edge возникают такие же трудности, как и при любом обмене данными через Интернет в режиме "клиент — сервер". Клиент и сервер безопасно обмениваются данными через Интернет по [протоколу TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security). Протокол TLS основан на конструкциях стандарта [инфраструктуры открытых ключей (PKI)](https://en.wikipedia.org/wiki/Public_key_infrastructure), называемых сертификатами. TLS является довольно вовлеченной спецификацией и рассматривает широкий круг вопросов, связанных с обеспечением безопасности двух конечных точек. В этом разделе кратко излагаются концепции, имеющие отношение к надежному подключению устройств к шлюзу IoT Edge.

Когда клиент подключается к серверу, сервер предоставляет ему *цепочку сертификатов сервера*. Такая цепочка обычно состоит из сертификата корневого ЦС, одного или нескольких сертификатов промежуточных ЦС, и сертификата самого сервера. Клиент устанавливает отношения доверия с сервером, криптографически проверяя всю цепочку сертификатов сервера. Эта клиентская проверка цепочки сертификатов сервера называется *проверкой серверной цепочки.* Клиент криптографически оспаривает сервис, чтобы доказать владение частным ключом, связанным с сертификатом сервера, в процессе, *называемом доказательством владения.* Комбинация проверки серверной цепочки и доказательства владения называется *аутентификацией сервера.* Чтобы проверить цепочку сертификатов сервера, клиенту нужна копия сертификата корневого ЦС, который использовался для создания (выдачи) этого сертификата сервера. Обычно браузеры при подключении к веб-сайтам используют предварительно настроенный набор часто используемых сертификатов ЦС, оптимизируя работу клиента.

Когда устройство подключается к Центру Интернета вещей, оно выполняет роль клиента облачной службы, а служба Центра Интернета вещей представляет собой сервер. Облачная служба Центра Интернета вещей поддерживается сертификатом корневого ЦС с именем **Baltimore CyberTrust Root**, который является общедоступным и широко распространенным. Так как сертификат ЦС для Центра Интернета вещей уже установлен на большинстве устройств, во многих реализациях TLS (OpenSSL, Schannel, LibreSSL) он автоматически используется для проверки сертификата сервера. Возможна ситуация, когда устройство успешно подключается к Центру Интернета вещей, но при попытке подключения к шлюзу IoT Edge возникают проблемы.

Когда устройство подключается к шлюзу IoT Edge, подчиненное устройство выполняет роль клиента, а устройство шлюза представляет собой сервер. Azure IoT Edge позволяет операторам (или пользователям) по своему усмотрению создавать любые цепочки сертификатов шлюза. Оператор может использовать сертификат общедоступного ЦС, например Baltimore, или самозаверяющий сертификат внутреннего корневого ЦС. Сертификаты общедоступных ЦС часто предоставляются за плату, что делает их использование более оправданным для рабочих сценариев. Самозаверяющие сертификаты удобны для разработки и тестирования. Прозрачные статьи настройки шлюза, перечисленные во введении, используют самоподписанные корневые сертификаты CA.

Если вы используете для шлюза IoT Edge самозаверяющий корневой сертификат, он должен быть установлен или предоставлен для всех подчиненных устройств, которые будут подключаться к этому шлюзу.

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

Дополнительные сведения о сертификатах IoT Edge и некоторых ограничениях для рабочей среды см. в статье [Сведения об использовании сертификатов Azure IoT Edge](iot-edge-certs.md).

## <a name="provide-the-root-ca-certificate"></a>Предоставить сертификат root CA

Для проверки сертификатов устройства шлюза устройству устройство, нижепом по течению, нуждается в собственной копии сертификата КОРНЕвого CA. Если вы использовали скрипты, представленные в репозитории IoT Edge git для создания тестовых сертификатов, то сертификат корневого CA называется **azure-iot-test-only.root.ca.cert.pem.** Если вы еще не участвовали в других шагах подготовки устройства вниз по течению, переместите этот файл сертификата в любой каталог на устройстве ниже по течению. Для перемещения файла сертификата можно использовать службу, например [Azure Key Vault,](https://docs.microsoft.com/azure/key-vault) или функцию, например [протокол «Безопасная копия».](https://www.ssh.com/ssh/scp/)

## <a name="install-certificates-in-the-os"></a>Установка сертификатов в ОС

Установка корневого сертификата CA в магазине сертификатов операционной системы обычно позволяет большинству приложений использовать сертификат root CA. Есть некоторые исключения, такие как приложения NodeJS, которые не используют магазин сертификатов ОС, а используют внутренний магазин сертификатов Node. Если вы не можете установить сертификат на уровне операционной системы, перейдите вперед, чтобы [использовать сертификаты с Помощью SDK Azure IoT.](#use-certificates-with-azure-iot-sdks)

### <a name="ubuntu"></a>Ubuntu

Команды из следующего примера устанавливают сертификат ЦС на узле под управлением ОС Ubuntu. Этот пример предполагает, что вы используете **сертификат azure-iot-test-only.root.ca.cert.pem** сертификат из статей предпосылок, и что вы скопировали сертификат в место на устройстве вниз по течению.

```bash
sudo cp <path>/azure-iot-test-only.root.ca.cert.pem /usr/local/share/ca-certificates/azure-iot-test-only.root.ca.cert.pem.crt
sudo update-ca-certificates
```

Вы должны увидеть сообщение, которое говорит: "Обновление сертификатов в / и т.д./ssl/certs ... 1 добавлено, 0 удалено; сделано ".

### <a name="windows"></a>Windows

В следующих шагах описано, как установить сертификат ЦС на узле под управлением ОС Windows. Этот пример предполагает, что вы используете **сертификат azure-iot-test-only.root.ca.cert.pem** сертификат из статей предпосылок, и что вы скопировали сертификат в место на устройстве вниз по течению.

Вы можете установить сертификаты с помощью [импортного сертификата](https://docs.microsoft.com/powershell/module/pkiclient/import-certificate?view=win10-ps) PowerShell в качестве администратора:

```powershell
import-certificate  <file path>\azure-iot-test-only.root.ca.cert.pem -certstorelocation cert:\LocalMachine\root
```

Вы также можете установить сертификаты с помощью **утилиты certlm:**

1. В меню "Пуск" выполните поиск по элементу **Управление сертификатами компьютеров**. Откроется служебная программа **certlm**.
2. Перейдите к **сертификатам - Местные компьютерные** > **доверенные корневые сертификационные органы.**
3. Щелкните правой кнопкой мыши элемент **Сертификаты** и выберите **Все задачи** > **Импорт**. Откроется мастер импорта сертификатов.
4. Выполните действия по его подсказкам и импортируйте файл сертификата `<path>/azure-iot-test-only.root.ca.cert.pem`. По завершении вы увидите сообщение "Импорт выполнен".

Можно также установить сертификаты программным способом с помощью API .NET, как показано в примере кода для .NET далее в этой статье.

Обычно приложения используют стек TLS [Schannel](https://docs.microsoft.com/windows/desktop/com/schannel), предоставляемый ОС Windows, для безопасного подключения через TLS. При использовании Schannel *требуется*, чтобы все сертификаты были установлены в хранилище сертификатов Windows перед попыткой установить TLS-подключение.

## <a name="use-certificates-with-azure-iot-sdks"></a>Использование сертификатов с пакетами SDK для Azure IoT

В этом разделе на примере простых приложений описывается, как пакеты SDK для Azure IoT подключаются к устройству IoT Edge. Все эти примеры пытаются подключить клиент устройства и отправить сообщения телеметрии в шлюз, а затем закрывают подключение и завершают работу.

Прежде чем использовать примеры уровня приложения, следует подготовить следующие два компонента:

* Строка подключения концентрированного устройства IoT, измененная для того, чтобы указать на устройство шлюза, и любые сертификаты, необходимые для проверки подлинности устройства ниже по течению в IoT Hub. Для получения дополнительной информации [см.](how-to-authenticate-downstream-device.md)

* Полный путь к сертификату корневого ЦС, который вы скопировали (сохранили) на подчиненное устройство.

    Например, `<path>/azure-iot-test-only.root.ca.cert.pem`.

### <a name="nodejs"></a>Node.js

Этот раздел содержит пример приложения для подключения клиентского устройства Azure IoT NodeJS к шлюзу IoT Edge. Для приложений NodeJS необходимо установить сертификат корневого CA на уровне приложения, как показано здесь. Приложения NodeJS не используют магазин сертификатов системы.

1. Получите пример файла **edge_downstream_device.js** из [репозитория примеров использования пакета SDK для устройств Azure IoT для Node.js](https://github.com/Azure/azure-iot-sdk-node/tree/master/device/samples).
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**).
3. В файле edge_downstream_device.js измените переменные **connectionString** и **edge_ca_cert_path**.
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве.

Чтобы помочь вам разобраться в выполняемом примере, мы приводим ниже фрагмент кода, в котором клиентский пакет SDK считывает файл сертификата и использует его для создания безопасного TLS-подключения:

```javascript
// Provide the Azure IoT device client via setOptions with the X509
// Edge root CA certificate that was used to setup the Edge runtime
var options = {
    ca : fs.readFileSync(edge_ca_cert_path, 'utf-8'),
};
```

### <a name="net"></a>.NET

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT .NET к шлюзу IoT Edge. Приложения .NET могут автоматически применять любые сертификаты, установленные в хранилище сертификатов операционной системы на узлах Windows и Linux.

1. Получите пример для **EdgeDownstreamDevice** из [папки примеров .NET для IoT Edge](https://github.com/Azure/iotedge/tree/master/samples/dotnet/EdgeDownstreamDevice).
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**).
3. В файле **Properties/launchSettings.json** измените переменные **DEVICE_CONNECTION_STRING** и **CA_CERTIFICATE_PATH**. Если вы хотите использовать сертификат, установленный в хост-системе в хранилище доверенных сертификатов, оставьте значение этой переменной пустым.
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве.

Чтобы установить доверенный сертификат в хранилище сертификатов программным способом с помощью приложения .NET, воспользуйтесь функцией **InstallCACert()**, которая определена в файле **EdgeDownstreamDevice/Program.cs**. Эта операция является идемпотентной, то есть ее можно безопасно выполнять несколько раз и получать одинаковые значения без побочных эффектов.

### <a name="c"></a>C

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT C к шлюзу IoT Edge. Пакет SDK для C поддерживает множество библиотек TLS, включая OpenSSL, WolfSSL и Schannel. См. дополнительные сведения о [пакете SDK для Azure IoT C](https://github.com/Azure/azure-iot-sdk-c).

1. Получите приложение **iotedge_downstream_device_sample** из [набора примеров использования пакета SDK для устройств Azure IoT для С](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples).
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**).
3. В файле iotedge_downstream_device_sample.c измените переменные **connectionString** и **edge_ca_cert_path**.
4. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве.

Пакет SDK для устройств Azure IoT для C предоставляет возможность зарегистрировать сертификат ЦС при настройке клиента. Эта операция не устанавливает сертификат, а просто использует сертификат в текстовом формате прямо из памяти. Сохраненный сертификат предоставляется базовому стеку TLS при установке подключения.

```C
(void)IoTHubDeviceClient_SetOption(device_handle, OPTION_TRUSTED_CERT, cert_string);
```

Если вы не используете OpenSSL или другую библиотеку TLS, на узлах Windows пакет SDK по умолчанию применяет Schannel. Чтобы обеспечить правильную работу Schannel, сертификат корневого ЦС для IoT Edge должен быть установлен в хранилище сертификатов Windows, а не с помощью операции `IoTHubDeviceClient_SetOption`.

### <a name="java"></a>Java

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT Java к шлюзу IoT Edge.

1. Получите пример **Send-event** из [набора примеров использования пакета SDK для устройств Интернета Azure IoT для Java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples).
2. Убедитесь, что у вас есть все необходимые компоненты для запуска примера (см. файл **readme.md**).
3. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве.

### <a name="python"></a>Python

Этот раздел знакомит вас с примером приложения для подключения клиентского устройства Azure IoT Python к шлюзу IoT Edge.

1. Получите образец для **send_message** от [устройства SDK SDK Azure для образцов Python.](https://github.com/Azure/azure-iot-sdk-python/tree/master/azure-iot-device/samples/async-edge-scenarios)
2. Убедитесь, что вы работаете в контейнере IoT Edge или `EdgeHubConnectionString` `EdgeModuleCACertificateFile` в сценарии отладки, имейте набор переменных среды.
3. В документации по пакету SDK вы найдете инструкции по запуску примера на конкретном устройстве.

## <a name="test-the-gateway-connection"></a>Тестирование подключения к шлюзу

Используйте эту команду образца, чтобы проверить, что устройство вниз по течению может подключиться к устройству шлюза:

```cmd/sh
openssl s_client -connect mygateway.contoso.com:8883 -CAfile <CERTDIR>/certs/azure-iot-test-only.root.ca.cert.pem -showcerts
```

Эта команда тестирует соединения над МЗТТС (порт 8883). Если вы используете другой протокол, отрегулируйте команду по мере необходимости для AM-PS (5671) или HTTPS (433)

Выход этой команды может быть длинным, включая информацию обо всех сертификатах в цепочке. Если подключение успешно, вы увидите строку типа `Verification: OK` или `Verify return code: 0 (ok)`.

![Проверить подключение шлюза](./media/how-to-connect-downstream-device/verification-ok.png)

## <a name="troubleshoot-the-gateway-connection"></a>Устранение проблем с подключением шлюза

Если устройство листа имеет прерывистое подключение к устройству шлюза, попробуйте следующие шаги для разрешения.

1. Является ли хост-имя шлюза в строке соединения таким же, как значение хоста в файле конфигурации IoT Edge на устройстве шлюза?
2. Является ли хост-имя шлюза разрешимым с IP-адресом? Вы можете решить прерывистые соединения либо с помощью DNS, либо путем добавления ввода файла хоста на устройстве листа.
3. Открыты ли порты связи в брандмауэре? Связь, основанная на используемом протоколе (МЗТТС:8883/АМЗПС:5671/HTTPS:433), должна быть возможна между устройством ниже по течению и прозрачным IoT Edge.

## <a name="next-steps"></a>Следующие шаги

Узнайте, как IoT Edge расширяет [возможности автономной работы](offline-capabilities.md) для подчиненных устройств.
