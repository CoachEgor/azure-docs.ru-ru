---
title: Хранение блочных BLOB-объектов на устройствах — Azure IoT Edge | Документация Майкрософт
description: Поймите многоуровневые и временные функции, см. поддерживаемые операции хранения капли и подключитесь к учетной записи хранения капли.
author: kgremban
ms.author: kgremban
ms.reviewer: arduppal
ms.date: 12/13/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: bea00f429f31f2be62ee6a9c00f88873c595d94c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76509824"
---
# <a name="store-data-at-the-edge-with-azure-blob-storage-on-iot-edge"></a>Хранение данных на пограничных устройствах с использованием хранилища BLOB-объектов Azure в IoT Edge

Azure Blob Storage on IoT Edge обеспечивает [блок капли](https://docs.microsoft.com/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-block-blobs) и решение для хранения [капли](https://docs.microsoft.com/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs) на краю. Модуль хранения кабр на устройстве IoT Edge ведет себя как служба Azure blob, за исключением того, что капли хранятся локально на устройстве IoT Edge. Вы можете получить доступ к каплям, используя те же методы хранения данных Azure или вызовы Blob API, к которым вы уже привыкли. В этой статье разъясняется концепция, связанные с хранилищем Azure Blob Storage на контейнере IoT Edge, который запускает службу blob на устройстве IoT Edge.

Этот модуль полезен в сценариях:

* где данные должны храниться локально, пока они не будут обработаны или переданы в облако. Эти данные могут быть видео, изображения, финансовые данные, данные больницы, или любые другие неструктурированные данные.
* когда устройства расположены в месте с ограниченным подключением.
* если вы хотите эффективно обрабатывать данные локально, чтобы получить доступ к данным с низкой задержкой, чтобы вы могли реагировать на чрезвычайные ситуации как можно быстрее.
* если требуется сократить затраты на пропускную способность и избежать переноса терабайт данных в облако. Вы можете обрабатывать данные локально и отправлять только обработанные данные в облако.

Смотреть видео для быстрого введения
> [!VIDEO https://www.youtube.com/embed/xbwgMNGB_3Y]

Этот модуль поставляется с **функциями deviceToCloudUpload** и **deviceAutoDelete.**

**deviceToCloudUpload** является настраиваемой функциональностью. Эта функция автоматически загружает данные из локального хранилища капли в Azure с прерывистой поддержкой подключения к Интернету. Это позволяет:

* Включите функцию устройстваToCloudUpload.
* Выберите порядок копирования данных в Azure, как NewestFirst или OldestFirst.
* Укажите учетную запись хранилища Azure, на которую вы хотите загрузить данные.
* Укажите контейнеры, которые вы хотите загрузить в Azure. Этот модуль позволяет указать имена источников и целевых контейнеров.
* Выберите возможность удалять капли сразу же, после загрузки в облачное хранилище закончено
* У полной загрузки `Put Blob` капли (с помощью `Put Block` `Put Block List` операции) и блокировать уровень загрузки (с помощью, и `Append Block` операции).

Этот модуль использует блок уровне загрузки, когда ваш капля состоит из блоков. Вот некоторые из распространенных сценариев:

* Ваше приложение обновляет некоторые блоки ранее загруженных блоков капли или прикладывает новые блоки к капле приложения, этот модуль загружает только обновленные блоки, а не весь blob.
* Модуль загружает каплю и подключение к Интернету уходит, когда подключение снова он загружает только оставшиеся блоки, а не весь капля.

Если неожиданное прекращение процесса (например, сбой питания) происходит во время загрузки капли, все блоки, которые должны были быть загружены снова, как только модуль возвращается в Интернете.

**устройствоAutoDelete** является настраиваемой функциональностью. Эта функция автоматически удаляет капли из локального хранилища, когда истекло указанная продолжительность (измеренная в минутах). Это позволяет:

* Включите функцию устройстваAutoDelete.
* Укажите время в минутах (deleteAfterMinutes), после чего капли будут автоматически удалены.
* Выберите возможность сохранить каплю во время его загрузки, если значение deleteAfterMinutes истекает.

## <a name="prerequisites"></a>Предварительные требования

Устройство Azure IoT Edge.

* Вы можете использовать машину разработки или виртуальную машину в качестве устройства IoT Edge, выполнив следующие шаги в quickstart для [Linux](quickstart-linux.md) или [Windows устройств.](quickstart.md)

* Обратитесь к [поддерживаемым системами Azure IoT Edge](support.md#operating-systems) для списка поддерживаемых операционных систем и архитектур. Модуль Azure Blob Storage on IoT Edge поддерживает следующие архитектуры:
  * Windows AMD64
  * Linux AMD64
  * Linux ARM32
  * Linux ARM64 (предварительный просмотр)

Облачные ресурсы.

[Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) цен. категории "Стандартный" в Azure.

## <a name="devicetocloudupload-and-deviceautodelete-properties"></a>deviceToCloudUpload и свойства deviceAutoDelete

Используйте желаемые свойства модуля для установки **устройстваToCloudUploadProperties** и **deviceAutoDeleteProperties.** Нежелательные свойства могут быть установлены во время развертывания или изменены позже путем редактирования двойника модуля без необходимости передислокации. Мы рекомендуем проверить "Module `reported configuration` Twin" и `configurationValidation` убедиться, что значения правильно распространяются.

### <a name="devicetoclouduploadproperties"></a>deviceToCloudUploadProperties

Название этой настройки `deviceToCloudUploadProperties`. Если вы используете симулятор IoT Edge, установите значения для соответствующих переменных среды для этих свойств, которые вы можете найти в разделе объяснения.

| Свойство | Возможные значения | Объяснение |
| ----- | ----- | ---- |
| uploadOn | true, false | Устанавливается `false` по умолчанию. Если вы хотите включить функцию, установите это поле. `true` <br><br> Переменная среды: `deviceToCloudUploadProperties__uploadOn={false,true}` |
| uploadOrder | NewestFirst, OldestFirst | Позволяет выбрать порядок, в котором данные копируется в Azure. Устанавливается `OldestFirst` по умолчанию. Порядок определяется последним измененным временем Blob. <br><br> Переменная среды: `deviceToCloudUploadProperties__uploadOrder={NewestFirst,OldestFirst}` |
| облакоStorageConnectionString |  | `"DefaultEndpointsProtocol=https;AccountName=<your Azure Storage Account Name>;AccountKey=<your Azure Storage Account Key>;EndpointSuffix=<your end point suffix>"`— это строка соединения, которая позволяет указать учетную запись хранилища, на которую вы хотите загрузить данные. Укажите, `Azure Storage Account Name` `Azure Storage Account Key`. `End point suffix`. Добавьте соответствующую EndpointSuffix Azure, где данные будут загружены, она варьируется для Global Azure, Government Azure и Microsoft Azure Stack. <br><br> Вы можете указать строку подключения Azure Storage SAS здесь. Но вы должны обновить это свойство, когда он истекает. <br><br> Переменная среды: `deviceToCloudUploadProperties__cloudStorageConnectionString=<connection string>` |
| storageContainersForUpload | `"<source container name1>": {"target": "<target container name>"}`,<br><br> `"<source container name1>": {"target": "%h-%d-%m-%c"}`, <br><br> `"<source container name1>": {"target": "%d-%c"}` | Позволяет указать имена контейнеров, которые вы хотите загрузить в Azure. Этот модуль позволяет указать имена источников и целевых контейнеров. Если вы не укажете имя контейнера-цели, оно `<IoTHubName>-<IotEdgeDeviceID>-<ModuleName>-<SourceContainerName>`автоматически присвоит имя контейнера как. Можно создать строки шаблона для имени целевого контейнера, проверить возможные столбцы значений. <br>0/> IoT Концентратор Имя (3-50 символов). <br>0-> IoT Edge Device ID (от 1 до 129 символов). <br>- %m -> Название модуля (от 1 до 64 символов). <br>- %c -> Название контейнера (от 3 до 63 символов). <br><br>Максимальный размер названия контейнера составляет 63 символа, при этом автоматически назначая имя контейнера, если размер контейнера превышает 63 символа, он обрезать каждый раздел (IoTHubName, IotEdgeDeviceID, ModuleName, SourceContainerName) до 15 Символов. <br><br> Переменная среды: `deviceToCloudUploadProperties__storageContainersForUpload__<sourceName>__target=<targetName>` |
| deleteAfterUpload | true, false | Устанавливается `false` по умолчанию. Когда он установлен `true`на , он будет автоматически удалять данные, когда загрузка в облачное хранилище закончена. <br><br> **ВНИМАНИЕ**: Если вы используете капли приложения, эта настройка будет удалять капли приложения из локального хранения после успешной загрузки, и любые будущие операции Блока приложения для этих капли не удастся. Используйте эту настройку с осторожностью, не включайте это, если ваше приложение выполняет нечастые операции приложений или не поддерживает непрерывные операции приложений<br><br> Переменная `deviceToCloudUploadProperties__deleteAfterUpload={false,true}`среда: . |

### <a name="deviceautodeleteproperties"></a>устройствоAutoDeleteProperties

Название этой настройки `deviceAutoDeleteProperties`. Если вы используете симулятор IoT Edge, установите значения для соответствующих переменных среды для этих свойств, которые вы можете найти в разделе объяснения.

| Свойство | Возможные значения | Объяснение |
| ----- | ----- | ---- |
| deleteOn | true, false | Устанавливается `false` по умолчанию. Если вы хотите включить функцию, установите это поле. `true` <br><br> Переменная среды: `deviceAutoDeleteProperties__deleteOn={false,true}` |
| deleteAfterMinutes | `<minutes>` | Укажите время в минутах. Модуль автоматически удалит капли из локального хранилища по истечении этого значения. <br><br> Переменная среды: `deviceAutoDeleteProperties__ deleteAfterMinutes=<minutes>` |
| сохранитьWhileЗагрузка | true, false | По умолчанию он `true`установлен на , и он будет сохранять капли во время его загрузки в облачное хранилище, если deleteAfterMinutes истекает. Вы можете установить его, `false` и он будет удалять данные, как только deleteAfterMinutes истекает. Примечание: Для этого свойства для работы uploadOn должны быть установлены на истину.  <br><br> **ВНИМАНИЕ**: Если вы используете капли приложения, эта настройка удалит капли приложения из локального хранилища, когда значение истекает, и любые будущие операции Блока приложения к этим каплям потерпит неудачу. Вы можете убедиться, что значение истечения достаточно большое для ожидаемой частоты операций приложения, выполняемых вашим приложением.<br><br> Переменная среды: `deviceAutoDeleteProperties__retainWhileUploading={false,true}`|

## <a name="using-smb-share-as-your-local-storage"></a>Использование доли sMB в качестве локального хранилища

При развертывании контейнера Windows этого модуля на хосте Windows можно предоставить долю SMB в качестве локального пути хранения.

Убедитесь, что доля sMB и IoT-устройство находятся во взаимно надежных доменах.

Вы можете `New-SmbGlobalMapping` запустить команду PowerShell для локальной карты sMB-доли на устройстве IoT под управлением Windows.

Ниже приведены шаги конфигурации:

```PowerShell
$creds = Get-Credential
New-SmbGlobalMapping -RemotePath <remote SMB path> -Credential $creds -LocalPath <Any available drive letter>
```

Пример:

```powershell
$creds = Get-Credential
New-SmbGlobalMapping -RemotePath \\contosofileserver\share1 -Credential $creds -LocalPath G:
```

Эта команда будет использовать учетные данные для проверки подлинности с помощью удаленного сервера SMB. Затем сопоставьте путь к удаленной общей папке с буквой диска G: (или любой другой доступной буквой диска). Теперь устройство IoT отображает объем данных на пути на диске G:

Убедитесь, что пользователь на устройстве IoT может читать/записываться на удаленную долю SMB.

Для развертывания значение `<storage mount>` может быть **G:/ContainerData:C:/BlobRoot**.

## <a name="granting-directory-access-to-container-user-on-linux"></a>Предоставление доступа к каталогу для контейнерного пользователя на Linux

Если вы использовали [объемкрепления](https://docs.docker.com/storage/volumes/) для хранения в ваших вариантах создания для контейнеров Linux, то вам не придется делать какие-либо дополнительные шаги, но если вы использовали [крепление,](https://docs.docker.com/storage/bind-mounts/) то эти шаги необходимы для правильного выполнения службы.

Следуя принципу наименьшей привилегии ограничить права доступа для пользователей минимальными разрешениями, необходимыми для выполнения их работы, этот модуль включает пользователя (имя: absie, ID: 11000) и группу пользователей (имя: absie, ID: 11000). Если контейнер запущен как **корень** (пользователь по умолчанию **корень),** наша служба будет запущена как пользователь **absie** с низкой привилегией.

Такое поведение делает конфигурацию разрешений на пути узла, которая имеет решающее значение для правильной работы службы, в противном случае служба выйдет из строя с ошибками, отклоняемыми доступом. Путь, используемый в связывании каталога, должен быть доступен пользователю контейнера (например: absie 11000). Вы можете предоставить пользователю контейнера доступ к каталогу, выдвивая команды ниже на ующем:

```terminal
sudo chown -R 11000:11000 <blob-dir>
sudo chmod -R 700 <blob-dir>
```

Пример:

```terminal
sudo chown -R 11000:11000 /srv/containerdata
sudo chmod -R 700 /srv/containerdata
```

Если вам нужно запустить службу в качестве пользователя, кроме **absie,** вы можете указать пользовательский идентификатор пользователя в createOptions под свойством "Пользователь" в манифесте развертывания. В этом случае необходимо использовать идентификатор `0`группы по умолчанию или корневую группу.

```json
"createOptions": {
  "User": "<custom user ID>:0"
}
```

Теперь предоставите пользователю контейнера доступ к каталогу

```terminal
sudo chown -R <user ID>:<group ID> <blob-dir>
sudo chmod -R 700 <blob-dir>
```

## <a name="configure-log-files"></a>Настройка файлов журнала

Для получения информации о настройке файлов [production best practices](https://docs.microsoft.com/azure/iot-edge/production-checklist#set-up-logs-and-diagnostics)журналов для модуля см.

## <a name="connect-to-your-blob-storage-module"></a>Подключение к модулю хранилища BLOB-объектов

Вы можете использовать имя учетной записи и ключ учетной записи, настроенные для вашего модуля, для доступа к хранилищу BLOB-объектов на устройстве IoT Edge.

Укажите устройство IoT Edge в качестве конечной точки большого двоичного объекта для любых запросов к хранилищу. Вы можете [создать строку подключения для явной конечной точки хранилища](../storage/common/storage-configure-connection-string.md#create-a-connection-string-for-an-explicit-storage-endpoint) с помощью сведений об устройстве IoT Edge и имени учетной записи.

* Для модулей, развернутых на том же устройстве, где работает модуль Azure Blob Storage `http://<module name>:11002/<account name>`на модуле IoT Edge, конечная точка blob:
* Для модулей или приложений, работающих на другом устройстве, необходимо выбрать правильную конечную точку для вашей сети. В зависимости от настройки сети выберите формат конечной точки, чтобы трафик данных из вашего внешнего модуля или приложения мог достичь устройства под управлением модуля Azure Blob Storage на модуле IoT Edge. Конечная точка blob для этого сценария является одной из:
  * `http://<device IP >:11002/<account name>`
  * `http://<IoT Edge device hostname>:11002/<account name>`
  * `http://<fully qualified domain name>:11002/<account name>`

## <a name="azure-blob-storage-quickstart-samples"></a>Образцы быстрого запуска Azure Blob Storage

Документация по хранению Azure Blob содержит код быстрого запуска на нескольких языках. Вы можете запустить эти образцы для тестирования хранилища Azure Blob на IoT Edge, изменив конечную точку капли для подключения к локальному модулю хранения капли.

Следующие образцы быстрого запуска используют языки, которые также поддерживаются IoT Edge, так что вы можете развернуть их в качестве модулей IoT Edge вместе с модулем хранения капли:

* [.NET](../storage/blobs/storage-quickstart-blobs-dotnet.md)
* [Python](../storage/blobs/storage-quickstart-blobs-python.md)
  * Версии до V2.1 из Python SDK имеют известную проблему, где модуль не возвращает время создания капли. Из-за этой проблемы, некоторые методы, такие как список капли не работает. В качестве обходного пути, явно установить версию API на капля клиента на '2017-04-17'. Пример: `block_blob_service._X_MS_VERSION = '2017-04-17'`
  * [Пример приложения Blob](https://github.com/Azure/azure-storage-python/blob/master/samples/blob/append_blob_usage.py)
* [Node.js](../storage/blobs/storage-quickstart-blobs-nodejs-legacy.md)
* [JS/HTML](../storage/blobs/storage-quickstart-blobs-javascript-client-libraries-legacy.md)
* [Руби](../storage/blobs/storage-quickstart-blobs-ruby.md)
* [Перейти](../storage/blobs/storage-quickstart-blobs-go.md)
* [Php](../storage/blobs/storage-quickstart-blobs-php.md)

## <a name="connect-to-your-local-storage-with-azure-storage-explorer"></a>Подключение к локальному хранилищу с помощью Azure Storage Explorer

Для подключения к локальной учетной записи хранилища можно использовать [Azure Storage Explorer.](https://azure.microsoft.com/features/storage-explorer/)

1. Загрузка и установка обозревателя службы хранилища Azure

1. Подключение к хранилищу Azure с помощью строки соединения

1. Обеспечить строку соединения:`DefaultEndpointsProtocol=http;BlobEndpoint=http://<host device name>:11002/<your local account name>;AccountName=<your local account name>;AccountKey=<your local account key>;`

1. Пройдите через шаги для подключения.

1. Создание контейнера внутри локальной учетной записи хранения

1. Начните загружать файлы в виде Блок капли или Приложение Blobs.
   > [!NOTE]
   > Этот модуль не поддерживает капли Страницы.

1. Вы также можете подключить учетные записи хранения данных Azure в Хранилище Explorer. Эта конфигурация дает единое представление как для локальной учетной записи хранения, так и для учетной записи хранения Azure

## <a name="supported-storage-operations"></a>Поддерживаемые операции в хранилище

Модули хранения Blob на IoT Edge используют SDK хранилища Azure Ис хранении и согласуются с версией 2017-04-17 API хранения Azure для конечных точек блокировки.

Поскольку не все операции хранения Azure Blob поддерживаются хранилищем Azure Blob На IoT Edge, в этом разделе перечислено состояние каждой из них.

### <a name="account"></a>Учетная запись

Поддерживается:

* Перечисление контейнеров

Не поддерживается:

* Получение и задание свойств службы BLOB-объектов
* Предварительный запрос к BLOB-объектам
* Получение статистики службы BLOB-объектов
* Получение данных об учетной записи

### <a name="containers"></a>Контейнеры

Поддерживается:

* Создание и удаление контейнера
* Получение свойств и метаданных контейнера
* Отображение списка больших двоичных объектов
* Получение и задание списка управления доступом для контейнера
* Определение метаданных контейнера

Не поддерживается:

* Аренда контейнера

### <a name="blobs"></a>BLOB-объекты

Поддерживается:

* Помещение, получение и удаление BLOB-объекта
* Получение и задание свойств BLOB-объекта
* Получение и задание метаданных BLOB-объекта

Не поддерживается:

* Аренда BLOB-объекта
* Создание моментального снимка BLOB-объекта
* Копирование и прерывание копирования BLOB-объекта
* Отмена удаления BLOB-объекта
* Установка уровня BLOB-объекта

### <a name="block-blobs"></a>Blob-блоки

Поддерживается:

* Вставка блока
* Вставка и получение списка блоков

Не поддерживается:

* Вставка блока по URL-адресу

### <a name="append-blobs"></a>Добавочные BLOB-объекты

Поддерживается:

* Блок приложения

Не поддерживается:

* Блок приложения с URL

## <a name="event-grid-on-iot-edge-integration"></a>Сетка событий на интеграции IoT Edge

> [!CAUTION]
> Интеграция с Event Grid на IoT Edge находится в предварительном просмотре

Этот модуль Azure Blob Storage on IoT Edge теперь обеспечивает интеграцию с Event Grid на IoT Edge. Подробную информацию об этой интеграции можно узнать в [учебнике по развертыванию модулей, публикации событий и проверке доставки событий.](../event-grid/edge/react-blob-storage-events-locally.md)

## <a name="release-notes"></a>Заметки о выпуске

Вот [примечания к выпуску в концентраторе докера](https://hub.docker.com/_/microsoft-azure-blob-storage) для этого модуля

## <a name="feedback"></a>Отзывы

Ваша обратная связь важна для нас, чтобы сделать этот модуль и его функции полезными и простыми в использовании. Пожалуйста, поделитесь своими отзывами и дайте нам знать, как мы можем улучшить.

Вы можете связаться с нами по адресуabsiotfeedback@microsoft.com

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [развернуть хранилище Azure Blob на Edge IoT](how-to-deploy-blob.md)

Будьте в курсе последних обновлений и объявлений в [блоге Azure Blob Storage на IoT Edge](https://aka.ms/abs-iot-blogpost)
