---
title: Установка Azure IoT Edge в Linux | Документация Майкрософт
description: Инструкции по установке Azure IoT Edge на устройствах Linux под управлением Ubuntu или Raspbian
author: kgremban
manager: philmea
ms.reviewer: veyalla
ms.service: iot-edge
services: iot-edge
ms.topic: conceptual
ms.date: 02/21/2020
ms.author: kgremban
ms.openlocfilehash: fb86ee9ce956917f8da44146e58a4775e0ba639f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79535907"
---
# <a name="install-the-azure-iot-edge-runtime-on-debian-based-linux-systems"></a>Установка среды выполнения Azure IoT Edge в системах Linux на основе Debian

Среда выполнения Azure IoT Edge превращает устройство в устройство IoT Edge. Среду выполнения можно развернуть на всех устройствах — от небольшого Raspberry Pi до технического сервера. Как только на устройстве будет настроена среда выполнения IoT Edge, вы можете начать развертывать в нее бизнес-логику из облака. Чтобы узнать больше, смотрите [время выполнения Azure IoT Edge и его архитектуру.](iot-edge-runtime.md)

В этой статье перечислены этапы установки времени выполнения Azure IoT Edge на устройстве X64, ARM32 или ARM64 Linux. Мы предоставляем пакеты для установки Ubuntu Server 16.04, Ubuntu Server 18.04 и Raspbian Stretch. Обратитесь к [поддерживаемым Системами Azure IoT Edge](support.md#operating-systems) для списка поддерживаемых операционных систем и архитектур Linux.

> [!NOTE]
> К пакетам в репозиториях программного обеспечения Linux применяются условия лицензии, которые можно найти в каждом пакете (/usr/share/doc/*имя-пакета*). Прежде чем использовать пакет, ознакомьтесь с условиями лицензии. Установка и использование пакета означают, что вы принимаете эти условия. Если вы не согласны с условиями лицензии, не используйте пакет.

## <a name="install-the-latest-runtime-version"></a>Установка последней версии времени выполнения

Используйте следующие разделы для установки последней версии времени выполнения Azure IoT Edge на устройство.

>[!NOTE]
>Поддержка устройств ARM64 находится в [открытом доступе.](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)

### <a name="register-microsoft-key-and-software-repository-feed"></a>Регистрация канала репозитория программного обеспечения и ключей (Майкрософт)

Подготовьте устройство к установке IoT Edge.

Установите конфигурацию репозитория. Выберите команду **16.04** или **18.04,** которая соответствует системе управления устройства:

* **Ubuntu Server 16.04**:

   ```bash
   curl https://packages.microsoft.com/config/ubuntu/16.04/multiarch/prod.list > ./microsoft-prod.list
   ```

* **Ubuntu Server 18.04**:

   ```bash
   curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > ./microsoft-prod.list
   ```

* **Распбиан стретч**:

   ```bash
   curl https://packages.microsoft.com/config/debian/stretch/multiarch/prod.list > ./microsoft-prod.list
   ```

Копирование сгенерированного списка.

   ```bash
   sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
   ```

Установка общедоступного ключа Microsoft GPG

   ```bash
   curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
   sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
   ```

### <a name="install-the-container-runtime"></a>Установка среды выполнения контейнера

Служба Azure IoT Edge использует среду выполнения контейнера, [совместимую с OCI](https://www.opencontainers.org/). Для производственных сценариев мы рекомендуем использовать движок [на основе Moby,](https://mobyproject.org/) представленный ниже. Двигатель Moby является единственным контейнерным двигателем, официально поддерживаемым Azure IoT Edge. Образы контейнеров Docker (Community Edition или Enterprise Edition) совместимы со средой выполнения Moby.

Обновление списков пакетов на устройстве.

   ```bash
   sudo apt-get update
   ```

Установите модуль Moby.

   ```bash
   sudo apt-get install moby-engine
   ```

Установите интерфейс командной строки (CLI) Moby. CLI применяется на стадии разработки, но при развертывании в рабочей среде он может не понадобится.

   ```bash
   sudo apt-get install moby-cli
   ```

Если вы получаете ошибки при установке времени выполнения контейнера Moby, выполните последующие действия, чтобы [проверить ядро Linux на совместимость Moby,](#verify-your-linux-kernel-for-moby-compatibility)представленную позже в этой статье.

### <a name="install-the-azure-iot-edge-security-daemon"></a>Установка управляющей программы безопасности Azure IoT Edge

**Daemon безопасности IoT Edge** обеспечивает и поддерживает стандарты безопасности на устройстве IoT Edge. Управляющая программа запускается при каждой загрузке устройства и перезагружает устройство, запуская остальные компоненты среды выполнения IoT Edge.

Команда установки также устанавливает стандартную версию **libiothsm** если не уже присутствует.

Обновление списков пакетов на устройстве.

   ```bash
   sudo apt-get update
   ```

Установите управляющую программу безопасности. Пакет устанавливается в `/etc/iotedge/`.

   ```bash
   sudo apt-get install iotedge
   ```

После успешной установки IoT Edge выход подскажет вам обновить файл конфигурации. Выполните шаги в разделе [Настройка daemon безопасности](#configure-the-security-daemon) для завершения подготовки устройства.

## <a name="install-a-specific-runtime-version"></a>Установка определенной версии времени выполнения

Если вместо последних версий необходимо установить конкретную версию Moby и Время выполнения IoT Edge вместо использования последних версий, можно настроить таргетинг на файлы компонентов непосредственно из репозитория IoT Edge GitHub. Используйте следующие шаги, чтобы получить все компоненты IoT Edge на вашем устройстве: двигатель Moby и CLI, libiothsm, и, наконец, IoT Edge безопасности daemon. Перейти к следующему разделу, [нанастройка безопасности daemon](#configure-the-security-daemon), если вы не хотите, чтобы изменить на конкретную версию времени выполнения.

1. Перейдите к [версиям Azure IoT Edge](https://github.com/Azure/azure-iotedge/releases)и найдите версию релиза, на которую вы хотите настроить таргетинг.

2. Расширьте раздел **«Активы»** для этой версии.

3. Там может быть или не может быть обновлений для движка Moby в любом данном выпуске. Если вы видите файлы, которые начинаются с **moby-engine** и **moby-cli,** используйте следующие команды для обновления этих компонентов. Если вы не видите никаких файлов Moby, вернитесь через старые активы выпуска, пока не найдете самую самую версию.

   1. Найдите файл **moby-engine,** который соответствует архитектуре устройства IoT Edge. Нажмите на ссылку файла и скопируйте адрес ссылки.

   2. Используйте скопированную ссылку в следующей команде для установки этой версии движка Moby:

      ```bash
      curl -L <moby-engine link> -o moby_engine.deb && sudo dpkg -i ./moby_engine.deb
      ```

   3. Найдите файл **moby-cli,** который соответствует архитектуре устройства IoT Edge. Moby CLI является необязательным компонентом, но может быть полезным при разработке. Нажмите на ссылку файла и скопируйте адрес ссылки.

   4. Используйте скопированную ссылку в следующей команде, чтобы установить эту версию Moby CLI:

      ```bash
      curl -L <moby-cli link> -o moby_cli.deb && sudo dpkg -i ./moby_cli.deb
      ```

4. Каждый релиз должен иметь новые файлы для daemon безопасности IoT Edge и hsmlib. Используйте следующие команды для обновления этих компонентов.

   1. Найдите файл **libiothsm-std,** который соответствует архитектуре устройства IoT Edge. Нажмите на ссылку файла и скопируйте адрес ссылки.

   2. Используйте скопированную ссылку в следующей команде, чтобы установить эту версию hsmlib:

      ```bash
      curl -L <libiothsm-std link> -o libiothsm-std.deb && sudo dpkg -i ./libiothsm-std.deb
      ```

   3. Найдите файл **iotedge,** который соответствует архитектуре устройства IoT Edge. Нажмите на ссылку файла и скопируйте адрес ссылки.

   4. Используйте скопированную ссылку в следующей команде, чтобы установить эту версию daemon безопасности IoT Edge.

      ```bash
      curl -L <iotedge link> -o iotedge.deb && sudo dpkg -i ./iotedge.deb
      ```

После успешной установки IoT Edge выход подскажет вам обновить файл конфигурации. Выполните следующие шаги в следующем разделе, чтобы завершить подготовку устройства.

## <a name="configure-the-security-daemon"></a>Настройка безопасности daemon

Настройте среду выполнения IoT Edge, чтобы связать свое физическое устройство с идентификатором, который существует в Центре Интернета вещей Azure.

Управляющую программу можно настроить с помощью файла конфигурации `/etc/iotedge/config.yaml`. По умолчанию этот файл защищен от записи, и вам потребуется использовать повышенные разрешения для его изменения.

Одно устройство IoT Edge можно подготовить к работе вручную, используя строку подключения устройства, предоставленную Центром Интернета вещей. Вы также можете использовать службу подготовки устройств, что удобно, если нужно автоматически подготовить несколько устройств. В зависимости от выбранного способа подготовки выберите соответствующий скрипт установки.

### <a name="option-1-manual-provisioning"></a>Вариант 1. Подготовка вручную

Чтобы вручную подготовить устройство, вам необходимо предоставить ему [​​строку подключения устройства](how-to-register-device.md#register-in-the-azure-portal), которую вы можете создать, зарегистрировав новое устройство в Центре Интернета вещей.

Откройте файл конфигурации.

```bash
sudo nano /etc/iotedge/config.yaml
```

Найдите конфигурации подготовки файла и не комментируйте раздел **конфигурации ручного подготовки.** Замените значение **device_connection_string** строкой подключения для устройства IoT Edge. Убедитесь, что любые другие разделы подготовки комментируются. Убедитесь, что **подготовка:** линия не имеет предшествующего пробела и что вложенные элементы отступом двумя пробелами.

```yml
# Manual provisioning configuration
provisioning:
  source: "manual"
  device_connection_string: "<ADD DEVICE CONNECTION STRING HERE>"
```

Для вставки содержимого `Shift+Right Click` буфера обмена в Nano или нажмите `Shift+Insert`.

Сохраните файл и закройте его.

   `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

```bash
sudo systemctl restart iotedge
```

### <a name="option-2-automatic-provisioning"></a>Вариант 2. Автоматическая подготовка

Устройства IoT Edge могут быть автоматически подготовлены с помощью [службы обеспечения устройств Azure IoT Hub (DPS).](../iot-dps/index.yml) В настоящее время IoT Edge поддерживает два механизма аттестации при использовании автоматической подготовки, но ваши требования к оборудованию могут повлиять на ваш выбор. Например, устройства Raspberry Pi по умолчанию не поставляются с чипом Trusted Platform Module (TPM). Дополнительные сведения см. в следующих статьях:

* [Создание и предоставление устройства IoT Edge с виртуальным TPM на Linux VM](how-to-auto-provision-simulated-device-linux.md)
* [Создание и предоставление устройства IoT Edge с использованием сертификатов X.509](how-to-auto-provision-x509-certs.md)
* [Создание и предоставление устройства IoT Edge с использованием симметричного аттестации ключей](how-to-auto-provision-symmetric-keys.md)

Эти статьи вас через создание регистрации в DPS, и генерации соответствующих сертификатов или ключей для аттестации. Независимо от того, какой механизм проверки вы выберете, информация о подготовке добавляется в файл конфигурации IoT Edge на устройстве IoT Edge.

Откройте файл конфигурации.

```bash
sudo nano /etc/iotedge/config.yaml
```

Найдите конфигурации подготовки файла и не опромите раздел, подходящий для вашего механизма аттестации. Убедитесь, что любые другие разделы подготовки комментируются. **Подготовка:** линия не должна иметь предшествующего пробела, а вложенные элементы должны быть отступом двумя пробелами. Обновление значения **scope_id** со значением из экземпляра службы обеспечения устройств IoT Hub и предоставьте соответствующие значения для полей аттестации.

TPM подтверждение:

```yml
# DPS TPM provisioning configuration
provisioning:
  source: "dps"
  global_endpoint: "https://global.azure-devices-provisioning.net"
  scope_id: "<SCOPE_ID>"
  attestation:
    method: "tpm"
    registration_id: "<REGISTRATION_ID>"
```

X.509 подтверждение:

```yml
# DPS X.509 provisioning configuration
provisioning:
  source: "dps"
  global_endpoint: "https://global.azure-devices-provisioning.net"
  scope_id: "<SCOPE_ID>"
  attestation:
    method: "x509"
#   registration_id: "<OPTIONAL REGISTRATION ID. LEAVE COMMENTED OUT TO REGISTER WITH CN OF identity_cert>"
    identity_cert: "<REQUIRED URI TO DEVICE IDENTITY CERTIFICATE>"
    identity_pk: "<REQUIRED URI TO DEVICE IDENTITY PRIVATE KEY>"
```

Симметричное подтверждение ключа:

```yml
# DPS symmetric key provisioning configuration
provisioning:
  source: "dps"
  global_endpoint: "https://global.azure-devices-provisioning.net"
  scope_id: "<SCOPE_ID>"
  attestation:
    method: "symmetric_key"
    registration_id: "<REGISTRATION_ID>"
    symmetric_key: "<SYMMETRIC_KEY>"
```

Для вставки содержимого `Shift+Right Click` буфера обмена в Nano или нажмите `Shift+Insert`.

Сохраните файл и закройте его. `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

```bash
sudo systemctl restart iotedge
```

## <a name="verify-successful-installation"></a>Проверка установки

Если вы выполняли **настройку вручную**, как описано в предыдущем разделе, подготовленная среда выполнения IoT Edge должна работать на вашем устройстве. Если вы выполняли **автоматическую настройку**, вам нужно сделать еще кое-что, чтобы среда выполнения могла зарегистрировать ваше устройство в центре Интернета вещей от вашего имени. Для следующих шагов [см. Создать и предоставить смоделированное устройство TPM IoT Edge на виртуальной машине Linux.](how-to-auto-provision-simulated-device-linux.md#give-iot-edge-access-to-the-tpm)

Вы можете проверить состояние IoT Edge Daemon:

```bash
systemctl status iotedge
```

Изучите журналы daemon:

```bash
journalctl -u iotedge --no-pager --no-full
```

Выполнить автоматизированную проверку наиболее распространенных ошибок конфигурации и сетей:

```bash
sudo iotedge check
```

До тех пор, пока ваш первый модуль не развернется на IoT Edge на устройстве, модуль **системы $edgeHub** не будет развернут на устройстве. В результате автоматизированная проверка вернет ошибку для проверки `Edge Hub can bind to ports on host` подключения. Эта ошибка может быть проигнорирована, если она не произойдет после развертывания модуля на устройство.

Наконец, перечислите запущенные модули:

```bash
sudo iotedge list
```

После установки IoT Edge на вашем устройстве, единственный модуль, который вы должны увидеть работает **edgeAgent.** Как только вы создадите свое первое развертывание, другой модуль системы **$edgeHub** начнется на устройстве, а также. Для получения дополнительной [информации](how-to-deploy-modules-portal.md)см.

## <a name="tips-and-troubleshooting"></a>Рекомендации и устранение неполадок

Для запуска команд `iotedge` требуется более высокий уровень привилегий. После установки среды выполнения выйдите из системы компьютера, а затем снова войдите для автоматического обновления разрешений. До тех пор используйте перед любой командой `iotedge` префикс **sudo**.

В устройствах с ограниченными ресурсами настоятельно рекомендуется присвоить переменной среды *OptimizeForPerformance* значение *false* согласно инструкциям в [руководстве по устранению неполадок](troubleshoot.md).

Если в вашей сети используется прокси-сервер, выполните действия, описанные в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

### <a name="verify-your-linux-kernel-for-moby-compatibility"></a>Проверьте свое ядро Linux на совместимость Moby

Многие производители встроенных устройств помещают изображения устройств, которые содержат пользовательские ядра Linux без функций, необходимых для совместимости времени выполнения контейнера. Если вы столкнулись с проблемами при установке рекомендуемого времени выполнения контейнера Moby, вы можете устранить неполадки в конфигурации ядра Linux с помощью скрипта [проверки](https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh) конфигурации из официального [репозитория Moby GitHub.](https://github.com/moby/moby) Выполнить следующие команды на устройстве, чтобы проверить конфигурацию ядра:

   ```bash
   curl -sSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o check-config.sh
   chmod +x check-config.sh
   ./check-config.sh
   ```

Эта команда предоставляет подробный вывод, содержащий состояние функций ядра, которые используются временми выполнения Moby. Вы хотите, чтобы убедиться, что все элементы под `Generally Necessary` и `Network Drivers` включены, чтобы убедиться, что ваше ядро полностью совместимо с Moby время выполнения.  Если вы определили какие-либо недостающие объекты, включите их, перестраив ядро из источника и выбрав связанные модули для включения в соответствующее ядро .config.  Аналогичным образом, если вы используете генератор `defconfig` `menuconfig`конфигурации ядра, как или , найти и включить соответствующие функции и восстановить ядро соответственно.  После развертывания недавно измененного ядра запустите сценарий проверки, чтобы убедиться, что все необходимые функции были успешно включены.

## <a name="uninstall-iot-edge"></a>Удаление IoT Edge

Если вы хотите удалить установку IoT Edge с устройства Linux, используйте следующие команды из командной строки.

Удалите среду выполнения IoT Edge.

```bash
sudo apt-get remove --purge iotedge
```

При удалении времени выполнения IoT Edge созданные контейнеры прекращаются, но все еще существуют на устройстве. Просмотрите все контейнеры, чтобы увидеть, какие из них остаются.

```bash
sudo docker ps -a
```

Удалите контейнеры с устройства, включая два контейнера в среде выполнения.

```bash
sudo docker rm -f <container name>
```

Наконец, удалите среду выполнения контейнера с устройства.

```bash
sudo apt-get remove --purge moby-cli
sudo apt-get remove --purge moby-engine
```

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда подготовлено устройство IoT Edge и установлена среда выполнения, вы можете [развернуть модули IoT Edge](how-to-deploy-modules-portal.md).

Если у вас возникли проблемы с ioT Edge время выполнения установки правильно, проверить страницу [устранения неполадок.](troubleshoot.md)

Чтобы обновить существующую установку до последней версии IoT Edge, см. раздел [Обновление управляющей программы безопасности и среды выполнения IoT Edge](how-to-update-iot-edge.md).
