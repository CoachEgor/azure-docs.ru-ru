---
title: Установка Azure IoT Edge в Linux | Документация Майкрософт
description: Azure IoT Edge инструкции по установке на устройствах Linux под управлением Ubuntu или Raspbian
author: kgremban
manager: philmea
ms.reviewer: veyalla
ms.service: iot-edge
services: iot-edge
ms.topic: conceptual
ms.date: 07/22/2019
ms.author: kgremban
ms.openlocfilehash: ec463efb1282c311757bb90fd614e1247459c80f
ms.sourcegitcommit: 12d902e78d6617f7e78c062bd9d47564b5ff2208
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2019
ms.locfileid: "74457326"
---
# <a name="install-the-azure-iot-edge-runtime-on-debian-based-linux-systems"></a>Установка среды выполнения Azure IoT Edge в системах Linux на основе Debian

Среда выполнения Azure IoT Edge превращает устройство в устройство IoT Edge. Среду выполнения можно развернуть на всех устройствах — от небольшого Raspberry Pi до технического сервера. Как только на устройстве будет настроена среда выполнения IoT Edge, вы можете начать развертывать в нее бизнес-логику из облака. Дополнительные сведения см. [в разделе Знакомство со средой выполнения Azure IOT EDGE и ее архитектурой](iot-edge-runtime.md).

В этой статье перечислены действия по установке среды выполнения Azure IoT Edge на устройстве Linux x64, ARM32 или ARM64. Пакеты установки предоставляются для Ubuntu Server 16,04, Ubuntu Server 18,04 и Raspbian Stretch. Список поддерживаемых операционных систем и архитектур Linux см. в [Azure IOT Edge поддерживаемых системах](support.md#operating-systems) .

>[!NOTE]
>Поддержка устройств ARM64 доступна в [общедоступной предварительной версии](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

> [!NOTE]
> К пакетам в репозиториях программного обеспечения Linux применяются условия лицензии, которые можно найти в каждом пакете (/usr/share/doc/*имя-пакета*). Прежде чем использовать пакет, ознакомьтесь с условиями лицензии. Установка и использование пакета свидетельствуют о принятии этих условий. Если вы не согласны с условиями лицензии, не используйте этот пакет.

## <a name="install-the-latest-runtime-version"></a>Установка последней версии среды выполнения

Используйте следующие разделы для установки последней версии среды выполнения Azure IoT Edge на устройстве. 

### <a name="register-microsoft-key-and-software-repository-feed"></a>Регистрация канала репозитория программного обеспечения и ключей (Майкрософт)

Подготовьте устройство к установке среды выполнения IoT Edge.

Установите конфигурацию репозитория. Выберите команду **16,04** или **18,04** , соответствующую операционной системе устройства:

* **Ubuntu Server 16,04**:
   ```bash
   curl https://packages.microsoft.com/config/ubuntu/16.04/multiarch/prod.list > ./microsoft-prod.list
   ```

* **Ubuntu Server 18,04**:
   ```bash
   curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > ./microsoft-prod.list
   ```

* **Raspbian Stretch**:
   ```bash
   curl https://packages.microsoft.com/config/debian/stretch/multiarch/prod.list > ./microsoft-prod.list
   ```

Скопируйте созданный список.

   ```bash
   sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
   ```

Установка открытого ключа Microsoft GPG

   ```bash
   curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
   sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
   ```

### <a name="install-the-container-runtime"></a>Установка среды выполнения контейнера

Служба Azure IoT Edge использует среду выполнения контейнера, [совместимую с OCI](https://www.opencontainers.org/). Для рабочих сценариев рекомендуется использовать подсистему [на основе значок Кита](https://mobyproject.org/) , приведенную ниже. Это единственная платформа контейнеров, которая официально поддерживается с Azure IoT Edge. Образы контейнеров Docker (Community Edition или Enterprise Edition) совместимы со средой выполнения Moby.

Выполните обновление apt.

   ```bash
   sudo apt-get update
   ```

Установите модуль Moby.

   ```bash
   sudo apt-get install moby-engine
   ```

Установите интерфейс командной строки (CLI) Moby. CLI применяется на стадии разработки, но при развертывании в рабочей среде он может не понадобится.

   ```bash
   sudo apt-get install moby-cli
   ```

Если при установке среды выполнения контейнера значок Кита возникают ошибки, выполните действия по [проверке совместимости ядра Linux для значок Кита](#verify-your-linux-kernel-for-moby-compatibility), приведенного далее в этой статье. 

### <a name="install-the-azure-iot-edge-security-daemon"></a>Установка управляющей программы безопасности Azure IoT Edge

**Управляющая программа IOT Edge безопасности** предоставляет и поддерживает стандарты безопасности на устройстве IOT Edge. Управляющая программа запускается при каждой загрузке устройства и перезагружает устройство, запуская остальные компоненты среды выполнения IoT Edge.

Команда установки также устанавливает стандартную версию **либиоссм** , если она еще не установлена.

Выполните обновление apt.

   ```bash
   sudo apt-get update
   ```

Установите управляющую программу безопасности. Пакет устанавливается в `/etc/iotedge/`.

   ```bash
   sudo apt-get install iotedge
   ```

После успешной установки IoT Edge в выходных данных будет предложено обновить файл конфигурации. Выполните действия, описанные в разделе [Настройка управляющей программы Azure IOT Edge Security](#configure-the-security-daemon) , чтобы завершить подготовку устройства. 

## <a name="install-a-specific-runtime-version"></a>Установка определенной версии среды выполнения

Если вы хотите установить определенную версию среды выполнения Azure IoT Edge, можно ориентироваться на файлы компонентов непосредственно из репозитория IoT Edge GitHub. Чтобы получить все компоненты IoT Edge на устройстве, выполните следующие действия: подсистема значок Кита и интерфейс командной строки, либиоссм и, наконец, управляющая программа безопасности IoT Edge.

1. Перейдите к [Azure IOT Edge выпускам](https://github.com/Azure/azure-iotedge/releases)и найдите целевую версию для выпуска. 

2. Разверните раздел **активы** для этой версии.

3. В любом выпуске могут быть обновления ядра значок Кита. Если вы видите файлы, которые начинаются с **значок Кита-Engine** и **значок Кита-CLI**, используйте следующие команды для обновления этих компонентов. Если вы не видите какие-либо файлы значок Кита, вернитесь назад к более старым ресурсам выпуска, пока не найдете последнюю версию. 

   1. Найдите файл **значок Кита Engine** , соответствующий архитектуре устройства IOT Edge. Щелкните ссылку на файл правой кнопкой мыши и скопируйте адрес ссылки.

   2. Чтобы установить эту версию модуля значок Кита, используйте скопированную ссылку в следующей команде: 

      ```bash
      curl -L <moby-engine link> -o moby_engine.deb && sudo dpkg -i ./moby_engine.deb
      ```

   3. Найдите файл **значок Кита-CLI** , соответствующий архитектуре устройства IOT Edge. Интерфейс командной строки значок Кита является необязательным компонентом, но он может быть полезен во время разработки. Щелкните ссылку на файл правой кнопкой мыши и скопируйте адрес ссылки. 

   4. Чтобы установить эту версию интерфейса командной строки значок Кита, используйте скопированную ссылку в следующей команде: 

      ```bash
      curl -L <moby-cli link> -o moby_cli.deb && sudo dpkg -i ./moby_cli.deb
      ```

4. Каждый выпуск должен иметь новые файлы для управляющей программы IoT Edge безопасности и хсмлиб. Используйте следующие команды для обновления этих компонентов. 

   1. Найдите файл **либиоссм-STD** , соответствующий архитектуре устройства IOT Edge. Щелкните ссылку на файл правой кнопкой мыши и скопируйте адрес ссылки. 

   2. Чтобы установить эту версию хсмлиб, используйте скопированную ссылку в следующей команде:

      ```bash
      curl -L <libiothsm-std link> -o libiothsm-std.deb && sudo dpkg -i ./libiothsm-std.deb
      ```
   
   3. Найдите файл **iotedge** , соответствующий архитектуре устройства IOT Edge. Щелкните ссылку на файл правой кнопкой мыши и скопируйте адрес ссылки. 

   4. Используйте ссылку копировать в следующей команде, чтобы установить эту версию управляющей программы IoT Edge безопасности. 

      ```bash
      curl -L <iotedge link> -o iotedge.deb && sudo dpkg -i ./iotedge.deb
      ```

После успешной установки IoT Edge в выходных данных будет предложено обновить файл конфигурации. Выполните действия, описанные в следующем разделе, чтобы завершить подготовку устройства. 

## <a name="configure-the-security-daemon"></a>Настройка управляющей программы безопасности

Настройте среду выполнения IoT Edge, чтобы связать свое физическое устройство с идентификатором, который существует в Центре Интернета вещей Azure.

Управляющую программу можно настроить с помощью файла конфигурации `/etc/iotedge/config.yaml`. По умолчанию этот файл защищен от записи, и вам потребуется использовать повышенные разрешения для его изменения.

Одно устройство IoT Edge можно подготовить к работе вручную, используя строку подключения устройства, предоставленную Центром Интернета вещей. Вы также можете использовать службу подготовки устройств, что удобно, если нужно автоматически подготовить несколько устройств. В зависимости от выбранного способа подготовки выберите соответствующий скрипт установки.

### <a name="option-1-manual-provisioning"></a>Вариант 1. Подготовка вручную

Чтобы вручную подготовить устройство, вам необходимо предоставить ему [​​строку подключения устройства](how-to-register-device.md#register-in-the-azure-portal), которую вы можете создать, зарегистрировав новое устройство в Центре Интернета вещей.

Откройте файл конфигурации.

```bash
sudo nano /etc/iotedge/config.yaml
```

Найдите конфигурации подготовки файла и раскомментируйте раздел **Настройка подготовки вручную** . Замените значение **device_connection_string** строкой подключения для устройства IoT Edge. Убедитесь, что все остальные разделы подготовки включены в комментарий.

   ```yaml
   # Manual provisioning configuration
   provisioning:
     source: "manual"
     device_connection_string: "<ADD DEVICE CONNECTION STRING HERE>"
  
   # DPS TPM provisioning configuration
   # provisioning:
   #   source: "dps"
   #   global_endpoint: "https://global.azure-devices-provisioning.net"
   #   scope_id: "{scope_id}"
   #   attestation:
   #     method: "tpm"
   #     registration_id: "{registration_id}"
```
Чтобы вставить содержимое буфера обмена в `Shift+Right Click` Nano или нажмите клавишу `Shift+Insert`.

Сохраните и закройте файл.

   `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

```bash
sudo systemctl restart iotedge
```

### <a name="option-2-automatic-provisioning"></a>Вариант 2. Автоматическая подготовка

Для автоматической подготовки устройства [настройте службу подготовки устройств и получите идентификатор регистрации устройства](how-to-auto-provision-simulated-device-linux.md). Существует несколько механизмов аттестации, поддерживаемых IoT Edge при использовании автоматической подготовки, но требования к оборудованию также влияют на выбор. Например, по умолчанию устройства Raspberry Pi не поставляются с микросхемой доверенный платформенный модуль (TPM) (TPM).

Откройте файл конфигурации.

```bash
sudo nano /etc/iotedge/config.yaml
```

Найдите конфигурации подготовки файла и раскомментируйте раздел, соответствующий вашему механизму аттестации. Например, при использовании аттестации доверенного платформенного модуля обновите значения **scope_id** и **registration_id** значениями из службы подготовки устройств центра интернета вещей и устройства IOT Edge с доверенным платформенным модулем соответственно.

   ```yaml
   # Manual provisioning configuration
   # provisioning:
   #   source: "manual"
   #   device_connection_string: "<ADD DEVICE CONNECTION STRING HERE>"
  
   # DPS TPM provisioning configuration
   provisioning:
     source: "dps"
     global_endpoint: "https://global.azure-devices-provisioning.net"
     scope_id: "{scope_id}"
     attestation:
       method: "tpm"
       registration_id: "{registration_id}"
   ```

Чтобы вставить содержимое буфера обмена в `Shift+Right Click` Nano или нажмите клавишу `Shift+Insert`.

Сохраните и закройте файл.

   `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

```bash
sudo systemctl restart iotedge
```

## <a name="verify-successful-installation"></a>Проверка успешного выполнения установки

Если вы выполняли **настройку вручную**, как описано в предыдущем разделе, подготовленная среда выполнения IoT Edge должна работать на вашем устройстве. Если вы выполняли **автоматическую настройку**, вам нужно сделать еще кое-что, чтобы среда выполнения могла зарегистрировать ваше устройство в центре Интернета вещей от вашего имени. Дальнейшие действия см. в статье [Создание и инициализация имитации устройства IOT Edge TPM на виртуальной машине Linux](how-to-auto-provision-simulated-device-linux.md#give-iot-edge-access-to-the-tpm).

Вы можете проверить состояние управляющей программы IoT Edge:

```bash
systemctl status iotedge
```

Проверьте журналы управляющей программы:

```bash
journalctl -u iotedge --no-pager --no-full
```

Выполните автоматическую проверку наиболее распространенных ошибок конфигурации и сети. 

```bash
sudo iotedge check
```

И перечислите выполняемые модули:

```bash
sudo iotedge list
```

После установки IoT Edge на устройстве доступен только тот модуль, который должен работать под **edgeAgent**. После создания первого развертывания на устройстве также будет запущен другой модуль системы **$edgeHub** . Дополнительные сведения см. в разделе [deploy IOT Edge modules](how-to-deploy-modules-portal.md).

## <a name="tips-and-troubleshooting"></a>Рекомендации и устранение неполадок

Для запуска команд `iotedge` требуется более высокий уровень привилегий. После установки среды выполнения выйдите из системы компьютера, а затем снова войдите для автоматического обновления разрешений. До тех пор используйте перед любой командой **префикс**sudo`iotedge`.

В устройствах с ограниченными ресурсами настоятельно рекомендуется присвоить переменной среды *OptimizeForPerformance* значение *false* согласно инструкциям в [руководстве по устранению неполадок](troubleshoot.md).

Если в вашей сети используется прокси-сервер, выполните действия, описанные в статье [Настройка устройства IoT Edge для обмена данными через прокси-сервер](how-to-configure-proxy-support.md).

### <a name="verify-your-linux-kernel-for-moby-compatibility"></a>Проверка совместимости ядра Linux с значок Кита

Многие производители встраиваемых устройств доставляют образы устройств, которые содержат пользовательские ядра Linux, без функций, необходимых для совместимости среды выполнения контейнеров. Если при установке рекомендуемой среды выполнения контейнеров значок Кита возникли проблемы, вы можете устранить неполадки в конфигурации ядра Linux с помощью скрипта [Check-config](https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh) из официального [репозитория значок Кита GitHub](https://github.com/moby/moby). Выполните следующие команды на устройстве, чтобы проверить конфигурацию ядра:

   ```bash
   curl -sSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o check-config.sh
   chmod +x check-config.sh
   ./check-config.sh
   ```

В результате будет предоставлен подробный результат, содержащий состояние функций ядра, которые используются средой выполнения значок Кита. Необходимо убедиться, что все элементы в разделе `Generally Necessary` и `Network Drivers` включены, чтобы обеспечить полную совместимость ядра с средой выполнения значок Кита.  Если вы определили недостающие компоненты, включите их, перестроив ядро из источника и выбрав связанные модули для включения в соответствующий файл kernel. config.  Аналогично, если вы используете генератор конфигурации ядра, например дефконфиг или менуконфиг, найдите и включите соответствующие функции и перестройте ядро соответствующим образом.  После развертывания недавно измененного ядра запустите сценарий Check-config еще раз, чтобы убедиться, что все необходимые компоненты были успешно включены.


## <a name="uninstall-iot-edge"></a>Удаление IoT Edge

Если вы хотите удалить установку IoT Edge с устройства Linux, используйте следующие команды из командной строки.

Удалите среду выполнения IoT Edge.

```bash
sudo apt-get remove --purge iotedge
```

При удалении среды выполнения IoT Edge созданные с ее помощью контейнеры остановятся, но будут по-прежнему храниться на устройстве. Просмотрите все контейнеры, чтобы увидеть, какие из них остаются.

```bash
sudo docker ps -a
```

Удалите контейнеры с устройства, включая два контейнера в среде выполнения.

```bash
sudo docker rm -f <container name>
```

Наконец, удалите среду выполнения контейнера с устройства.

```bash
sudo apt-get remove --purge moby-cli
sudo apt-get remove --purge moby-engine
```

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда подготовлено устройство IoT Edge и установлена среда выполнения, вы можете [развернуть модули IoT Edge](how-to-deploy-modules-portal.md).

Если при правильной установке среды выполнения IoT Edge возникли проблемы, ознакомьтесь со страницей [устранения неполадок](troubleshoot.md) .

Чтобы обновить существующую установку до последней версии IoT Edge, см. раздел [Обновление управляющей программы безопасности и среды выполнения IoT Edge](how-to-update-iot-edge.md).
