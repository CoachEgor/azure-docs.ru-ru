---
title: Создание тестовых сертификатов - Azure IoT Edge Документы Майкрософт
description: Создайте тестовые сертификаты и узнайте, как установить их на устройство Azure IoT Edge для подготовки к развертыванию.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 04/14/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 364846f6cef196f6cefa7872af48f262b387db4f
ms.sourcegitcommit: d6e4eebf663df8adf8efe07deabdc3586616d1e4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/15/2020
ms.locfileid: "81393819"
---
# <a name="create-demo-certificates-to-test-iot-edge-device-features"></a>Создание демо-сертификатов для тестирования функций устройства IoT Edge

Устройствам IoT Edge требуются сертификаты для безопасной связи между временем выполнения, модулями и любыми устройствами ниже по течению.
Если у вас нет сертификата для создания необходимых сертификатов, вы можете использовать демо-сертификаты для опробование функций IoT Edge в тестовой среде.
В этой статье описывается функциональность скриптов генерации сертификатов, которые IoT Edge предоставляет для тестирования.

Срок действия этих сертификатов истекает через 30 дней и не должен использоваться ни в одном производственном сценарии.

Вы можете создавать сертификаты на любой машине, а затем копировать их на устройство IoT Edge.
Проще использовать основную машину для создания сертификатов, чем создавать их на устройстве IoT Edge.
Используя основную машину, можно один раз настроить скрипты, а затем повторить процесс для создания сертификатов для нескольких устройств.

Выполните следующие действия, чтобы создать демо-сертификаты для тестирования сценария IoT Edge:

1. [Настройка скриптов](#set-up-scripts) для создания сертификата на устройстве.
2. [Создайте сертификат корневого CA,](#create-root-ca-certificate) который используется для подписания всех других сертификатов для вашего сценария.
3. Создайте сертификаты, необходимые для сценария, который вы хотите протестировать:
   * [Создание сертификатов идентификации устройства IoT Edge](#create-iot-edge-device-identity-certificates) для тестирования автоматического обеспечения с помощью службы обеспечения устройств IoT Hub.
   * [Создание сертификатов IOT Edge устройства CA](#create-iot-edge-device-ca-certificates) для тестирования сценариев производства или шлюзов.
   * [Создавайте сертификаты устройств ниже по течению](#create-downstream-device-certificates) для проверки аутентификации устройств в Концентраторе IoT в сценарии шлюза.

## <a name="prerequisites"></a>Предварительные требования

Машина разработки с установленным Git.

## <a name="set-up-scripts"></a>Настройка сценариев

Репозиторий IoT Edge на GitHub включает в себя сценарии генерации сертификатов, которые можно использовать для создания демо-сертификатов.
В этом разделе содержатся инструкции по подготовке скриптов для запуска на компьютере, как на Windows, так и на Linux.
Если вы находитесь на машине Linux, пропустите вперед, чтобы [настроить на Linux](#set-up-on-linux).

### <a name="set-up-on-windows"></a>Настройка на Windows

Чтобы создать демо-сертификаты на устройстве Windows, необходимо установить OpenSSL, а затем клонировать сценарии генерации и настроить их для локального запуска в PowerShell.

#### <a name="install-openssl"></a>Установка OpenSSL

Установите OpenSSL для Windows на компьютере, который используется для создания сертификатов.
Если на устройстве Windows уже установлен OpenSSL, вы можете пропустить этот шаг, но убедитесь, что opensl.exe доступен в переменной среды PATH.

Существует несколько способов установки OpenSSL, включая следующие варианты:

* **Проще:** Скачать и установить любые [сторонние файлы openSSL,](https://wiki.openssl.org/index.php/Binaries)например, с [OpenSSL на SourceForge](https://sourceforge.net/projects/openssl/). Добавьте полный путь к файлу openssl.exe в переменную среды PATH.

* **Рекомендуемый способ.** Скачайте исходный код OpenSSL и создайте двоичные файлы на компьютере самостоятельно или с помощью [vcpkg](https://github.com/Microsoft/vcpkg). В следующих инструкциях используется vcpkg для скачивания исходного кода, а также компиляции и установки OpenSSL на компьютере Windows с помощью простых действий.

   1. Перейдите в каталог для установки vcpkg. Следуйте указаниям, чтобы скачать и установить [vcpkg](https://github.com/Microsoft/vcpkg).

   2. После установки vcpkg запустите следующую команду из запроса PowerShell для установки пакета OpenSSL для Windows x64. Установка обычно занимает около 5 минут.

      ```powershell
      .\vcpkg install openssl:x64-windows
      ```

   3. Добавьте `<vcpkg path>\installed\x64-windows\tools\openssl` в переменную среды PATH, чтобы сделать файл openssl.exe доступным для вызова.

#### <a name="prepare-scripts-in-powershell"></a>Подготовка скриптов в PowerShell

Репозиторий Git Azure IoT Edge содержит скрипты, которые можно использовать для создания тестовых сертификатов.
В этом разделе вы клонируете репо IoT Edge и выполняете скрипты.

1. Откройте окно PowerShell с правами администратора.

2. Клонioiot Edge git репо, которое содержит скрипты для создания демо-сертификатов. Используйте команду `git clone` или [скачайте ZIP-файл](https://github.com/Azure/iotedge/archive/master.zip).

   ```powershell
   git clone https://github.com/Azure/iotedge.git
   ```

3. Перейдите в каталог, в котором вы планируете работать. На протяжении всей этой статьи, мы будем называть этот каталог * \<WRKDIR>*. Все сертификаты и ключи будут созданы в этом рабочем каталоге.

4. Копирование файлов конфигурации и скрипта из клонированного репо в рабочий каталог.

   ```powershell
   copy <path>\iotedge\tools\CACertificates\*.cnf .
   copy <path>\iotedge\tools\CACertificates\ca-certs.ps1 .
   ```

   Если вы скачали репо в качестве почтового `iotedge-master` индекса, то имя папки и остальная часть пути то же самое.

5. Включите PowerShell для выполнения скриптов.

   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
   ```

6. Принесите функции, используемые скриптами, в глобальное пространство имен PowerShell.

   ```powershell
   . .\ca-certs.ps1
   ```

   В окне PowerShell будет отображаться предупреждение о том, что сертификаты, генерируемые этим скриптом, предназначены только для целей тестирования и не должны использоваться в производственных сценариях.

7. Убедитесь, что OpenSSL был установлен правильно, и убедитесь, что не будет столкновения имен с существующими сертификатами. При возникновении проблем выход скрипта должен описывать, как исправить их в вашей системе.

   ```powershell
   Test-CACertsPrerequisites
   ```

### <a name="set-up-on-linux"></a>Настройка на Linux

Для создания демо-сертификатов на устройстве Windows необходимо клонировать сценарии генерации и настроить их для локального запуска в Bash.

1. Клонioiot Edge git репо, которое содержит скрипты для создания демо-сертификатов.

   ```bash
   git clone https://github.com/Azure/iotedge.git
   ```

2. Перейдите в каталог, в котором вы планируете работать. Мы будем ссылаться на этот каталог на протяжении всей статьи, как * \<WRKDIR>*. Все сертификаты и ключевые файлы будут созданы в этом каталоге.
  
3. Копируйте файлы конфигурации и скрипта из клонированного репо IoT Edge в рабочий каталог.

   ```bash
   cp <path>/iotedge/tools/CACertificates/*.cnf .
   cp <path>/iotedge/tools/CACertificates/certGen.sh .
   ```

<!--
4. Configure OpenSSL to generate certificates using the provided script. 

   ```bash
   chmod 700 certGen.sh 
   ```
-->

## <a name="create-root-ca-certificate"></a>Создание сертификата корневого CA

Сертификат root CA используется для изготовления всех других демо-сертификатов для тестирования сценария IoT Edge.
Вы можете продолжать использовать тот же сертификат корневой CA для изготовления демо-сертификатов для нескольких устройств IoT Edge или вниз по течению.

Если в рабочей папке уже есть один корневый сертификат CA, не создавайте новый сертификат.
Новый сертификат root CA перезавернет старый, и все сертификаты, полученные из старого, перестанут работать.
Если вам нужны несколько корневых сертификатов CA, обязательно управляйте ими в отдельных папках.

Прежде чем приступить к шагам в этом разделе, выполните последующие шаги в разделе [Настройка скриптов,](#set-up-scripts) чтобы подготовить рабочий каталог со сценариями генерации демо-сертификатов.

### <a name="windows"></a>Windows

1. Перейдите к рабочему каталогу, где вы разместили скрипты поколения сертификатов.

1. Создайте корневой сертификат CA и попросите его подписать один промежуточный сертификат. Сертификаты все помещены в рабочий каталог.

   ```powershell
   New-CACertsCertChain rsa
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов, но когда статьи запрашивают **корневой сертификат CA,** используйте следующий файл:

   * `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

### <a name="linux"></a>Linux

1. Перейдите к рабочему каталогу, где вы разместили скрипты поколения сертификатов.

1. Создайте сертификат root CA и один промежуточный сертификат.

   ```bash
   ./certGen.sh create_root_and_intermediate
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов, но когда статьи запрашивают **корневой сертификат CA,** используйте следующий файл:

   * `<WRKDIR>/certs/azure-iot-test-only.root.ca.cert.pem`  

## <a name="create-iot-edge-device-ca-certificates"></a>Создание сертификатов УСТРОЙСТВА IoT Edge CA

Каждому устройству IoT Edge, идущему в производство, требуется сертификат CA-устройства, на который ссылается файл config.yaml.
Сертификат CA устройства отвечает за создание сертификатов для модулей, работающих на устройстве.
Это также способ, как устройство IoT Edge проверяет свою идентичность при подключении к устройствам ниже по течению.

Сертификаты CA устройства идут в разделе **Сертификат** файла config.yaml на устройстве IoT Edge.

Прежде чем приступить к шагам в этом разделе, выполните следующие действия в [разделах Настройка скриптов](#set-up-scripts) и создайте разделы [сертификата root CA.](#create-root-ca-certificate)

### <a name="windows"></a>Windows

1. Перейдите к рабочему каталогу с скриптами генерации сертификатов и сертификатом CA root.

2. Создайте сертификат CA устройства IoT Edge и закрытый ключ со следующей командой. Укажите имя сертификата CA, например **MyEdgeDeviceCA**, который используется для обосвения выходных файлов.

   ```powershell
   New-CACertsEdgeDevice "MyEdgeDeviceCA"
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов. Следующий сертификат и пара ключей должны быть скопированы на устройство IoT Edge и упомянутые в файле config.yaml:

   * `<WRKDIR>\certs\iot-edge-device-MyEdgeDeviceCA-full-chain.cert.pem`
   * `<WRKDIR>\private\iot-edge-device-MyEdgeDeviceCA.key.pem`

Имя шлюза, передаваемое в эти скрипты, не должно быть таким же, как параметр "хостимя" в config.yaml или идентификатор устройства в IoT Hub.
Чтобы помочь вам избежать проблем, скрипты добавляют строку ".ca" к имени устройства шлюза. Это позволяет предотвратить конфликт имен, когда при настройке IoT Edge пользователь указывает одно и то же имя в обоих местах.
Однако все же рекомендуется не использовать одинаковые имена.

### <a name="linux"></a>Linux

1. Перейдите к рабочему каталогу с скриптами генерации сертификатов и сертификатом CA root.

2. Создайте сертификат CA устройства IoT Edge и закрытый ключ со следующей командой. Укажите имя сертификата CA, например **MyEdgeDeviceCA**, который используется для обосвения выходных файлов.

   ```bash
   ./certGen.sh create_edge_device_certificate "MyEdgeDeviceCA"
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов. Следующий сертификат и пара ключей должны быть скопированы на устройство IoT Edge и упомянутые в файле config.yaml:

   * `<WRKDIR>/certs/iot-edge-device-MyEdgeDeviceCA-full-chain.cert.pem`
   * `<WRKDIR>/private/iot-edge-device-MyEdgeDeviceCA.key.pem`

Имя шлюза, передаваемое в эти скрипты, не должно быть таким же, как параметр "хостимя" в config.yaml или идентификатор устройства в IoT Hub.
Чтобы помочь вам избежать проблем, скрипты добавляют строку ".ca" к имени устройства шлюза. Это позволяет предотвратить конфликт имен, когда при настройке IoT Edge пользователь указывает одно и то же имя в обоих местах.
Однако все же рекомендуется не использовать одинаковые имена.

## <a name="create-iot-edge-device-identity-certificates"></a>Создание идентификационных сертификатов устройства IoT Edge

Сертификаты идентификации устройств используются для предоставления устройств IoT Edge через [службу обеспечения устройств Azure IoT Hub (DPS).](../iot-dps/index.yml)

Сертификаты идентификации устройства заходят в разделе **"Подготовка** файла config.yaml" на устройстве IoT Edge.

Прежде чем приступить к шагам в этом разделе, выполните следующие действия в [разделах Настройка скриптов](#set-up-scripts) и создайте разделы [сертификата root CA.](#create-root-ca-certificate)

### <a name="windows"></a>Windows

Создайте идентификационный сертификат IoT Edge и закрытый ключ со следующей командой:

```powershell
New-CACertsEdgeDeviceIdentity "<name>"
```

Имя, которое вы передавите в эту команду, будет идентификатором устройства IoT Edge в Концентраторе IoT.

Новая команда идентификации устройства создает несколько сертификатов и ключевых файлов, в том числе три, которые вы будете использовать при создании индивидуального регистрации в DPS и установке времени выполнения IoT Edge:

* `<WRKDIR>\certs\iot-edge-device-identity-<name>-full-chain.cert.pem`
* `<WRKDIR>\certs\iot-edge-device-identity-<name>.cert.pem`
* `<WRKDIR>\private\iot-edge-device-identity-<name>.key.pem`

### <a name="linux"></a>Linux

Создайте идентификационный сертификат IoT Edge и закрытый ключ со следующей командой:

```bash
./certGen.sh create_edge_device_identity_certificate "<name>"
```

Имя, которое вы передавите в эту команду, будет идентификатором устройства IoT Edge в Концентраторе IoT.

Скрипт создает несколько сертификатов и ключевых файлов, в том числе три, которые вы будете использовать при создании индивидуальной регистрации в DPS и установке времени выполнения IoT Edge:

* `<WRKDIR>\certs\iot-edge-device-identity-<name>-full-chain.cert.pem`
* `<WRKDIR>/certs/iot-edge-device-identity-<name>.cert.pem`
* `<WRKDIR>/private/iot-edge-device-identity-<name>.key.pem`

## <a name="create-downstream-device-certificates"></a>Создание нижепопом сертификатов устройств

Если вы настраиваете устройство IoT для шлюза, можно создать демо-сертификаты для проверки подлинности X.509.
Существует два способа аутентификации устройства IoT с помощью сертификатов X.509: использование самоподписанных сертификатов или использование сертификатов (CA) подписанных сертификатов.
Для самоподписной аутентификации X.509, которую иногда называют аутентификацией отпечатков пальцев, необходимо создать новые сертификаты для размещения на устройстве IoT.
Эти сертификаты имеют отпечаток пальца в них, что вы разделяете с IoT концентратор для проверки подлинности.
Для получения сертификата X.509 (CA), подписанного в области проверки подлинности, нужен сертификат корневого CA, зарегистрированный в Концентраторе IoT, который используется для подписания сертификатов для вашего устройства IoT.
Любое устройство, используюеееемое сертификатом, выданным сертификатом root CA или любым из его промежуточных сертификатов, будет разрешено проверить подлинность.

Сценарии генерации сертификатов помогут вам сделать демо-сертификаты для тестирования любого из этих сценариев проверки подлинности.

Прежде чем приступить к шагам в этом разделе, выполните следующие действия в [разделах Настройка скриптов](#set-up-scripts) и создайте разделы [сертификата root CA.](#create-root-ca-certificate)

### <a name="self-signed-certificates"></a>Самозаверяющие сертификаты

При проверке подлинности устройства IoT с помощью самоподписанных сертификатов необходимо создать сертификаты устройства на основе сертификата root CA для вашего решения.
Затем вы получаете гексадецимальный "отпечаток пальца" из сертификатов, чтобы предоставить IoT концентратор.
Вашему устройству IoT также необходима копия сертификатов устройства, чтобы она мог проверить подлинность с помощью IoT Hub.

#### <a name="windows"></a>Windows

1. Перейдите к рабочему каталогу с скриптами генерации сертификатов и сертификатом CA root.

2. Создайте два сертификата (первичный и вторичный) для устройства ниже по течению. Простой конвенции именования для использования заключается в создании сертификатов с именем устройства IoT, а затем первичной или вторичной этикетки. Пример:

   ```PowerShell
   New-CACertsDevice "<device name>-primary"
   New-CACertsDevice "<device name>-secondary"
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов. Следующие сертификаты и пары ключей должны быть скопированы на устройство IoT вниз по течению и упомянуты ею в приложениях, которые подключаются к IoT Hub:

   * `<WRKDIR>\certs\iot-device-<device name>-primary-full-chain.cert.pem`
   * `<WRKDIR>\certs\iot-device-<device name>-secondary-full-chain.cert.pem`
   * `<WRKDIR>\certs\iot-device-<device name>-primary.cert.pem`
   * `<WRKDIR>\certs\iot-device-<device name>-secondary.cert.pem`
   * `<WRKDIR>\certs\iot-device-<device name>-primary.cert.pfx`
   * `<WRKDIR>\certs\iot-device-<device name>-secondary.cert.pfx`
   * `<WRKDIR>\private\iot-device-<device name>-primary.key.pem`
   * `<WRKDIR>\private\iot-device-<device name>-secondary.key.pem`

3. Извилисайте отпечаток ПАЛЬЦА SHA1 (называемый отпечатком пальца в контекстах IoT Hub) из каждого сертификата. Отпечаток пальца представляет собой 40 гексадецимальных символов строки. Используйте следующую команду openssl для просмотра сертификата и поиска отпечатков пальцев:

   ```PowerShell
   openssl x509 -in <WRKDIR>\certs\iot-device-<device name>-primary.cert.pem -text -fingerprint | sed 's/[:]//g'
   ```

   Запустите эту команду дважды, один раз для основного сертификата и один раз для вторичного сертификата. Вы предоставляете отпечатки пальцев для обоих сертификатов при регистрации нового устройства IoT с помощью самоподписанных сертификатов X.509.

#### <a name="linux"></a>Linux

1. Перейдите к рабочему каталогу с скриптами генерации сертификатов и сертификатом CA root.

2. Создайте два сертификата (первичный и вторичный) для устройства ниже по течению. Простой конвенции именования для использования заключается в создании сертификатов с именем устройства IoT, а затем первичной или вторичной этикетки. Пример:

   ```bash
   ./certGen.sh create_device_certificate "<device name>-primary"
   ./certGen.sh create_device_certificate "<device name>-secondary"
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов. Следующие сертификаты и пары ключей должны быть скопированы на устройство IoT вниз по течению и упомянуты ею в приложениях, которые подключаются к IoT Hub:

   * `<WRKDIR>/certs/iot-device-<device name>-primary-full-chain.cert.pem`
   * `<WRKDIR>/certs/iot-device-<device name>-secondary-full-chain.cert.pem`
   * `<WRKDIR>/certs/iot-device-<device name>-primary.cert.pem`
   * `<WRKDIR>/certs/iot-device-<device name>-secondary.cert.pem`
   * `<WRKDIR>/certs/iot-device-<device name>-primary.cert.pfx`
   * `<WRKDIR>/certs/iot-device-<device name>-secondary.cert.pfx`
   * `<WRKDIR>/private/iot-device-<device name>-primary.key.pem`
   * `<WRKDIR>/private/iot-device-<device name>-secondary.key.pem`

3. Извилисайте отпечаток ПАЛЬЦА SHA1 (называемый отпечатком пальца в контекстах IoT Hub) из каждого сертификата. Отпечаток пальца представляет собой 40 гексадецимальных символов строки. Используйте следующую команду openssl для просмотра сертификата и поиска отпечатков пальцев:

   ```bash
   openssl x509 -in <WRKDIR>/certs/iot-device-<device name>-primary.cert.pem -text -fingerprint | sed 's/[:]//g'
   ```

   При регистрации нового устройства IoT с помощью самоподписанных сертификатов X.509 вы предоставляете как первичный, так и вторичный отпечаток пальца.

### <a name="ca-signed-certificates"></a>Сертификаты, подписанные CA

При проверке подлинности устройства IoT с помощью сертификатов, подписанных самостоятельно, необходимо загрузить сертификат root CA для решения в IoT Hub.
Затем вы выполняете проверку, чтобы доказать IoT Hub, что у вас есть сертификат root CA.
Наконец, для создания сертификатов устройства для настройки IoT-устройства используется тот же сертификат CA, чтобы он мог проверить подлинность с помощью IoT Hub.

Сертификаты в этом разделе для шагов в [настройке безопасности X.509 в вашем концентраторе Azure IoT.](../iot-hub/iot-hub-security-x509-get-started.md)

#### <a name="windows"></a>Windows

1. Загрузите файл сертификата ROOT CA `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`из рабочего каталога в концентратор IoT.

2. Используйте код, представленный на портале Azure, чтобы убедиться, что у вас есть сертификат root CA.

   ```PowerShell
   New-CACertsVerificationCert "<verification code>"
   ```

3. Создайте цепочку сертификатов для устройства ниже по течению. Используйте тот же идентификатор устройства, на который зарегистрировано устройство в Концентраторе IoT.

   ```PowerShell
   New-CACertsDevice "<device id>"
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов. Следующие сертификаты и пары ключей должны быть скопированы на устройство IoT вниз по течению и упомянуты ею в приложениях, которые подключаются к IoT Hub:

   * `<WRKDIR>\certs\iot-device-<device id>.cert.pem`
   * `<WRKDIR>\certs\iot-device-<device id>.cert.pfx`
   * `<WRKDIR>\certs\iot-device-<device id>-full-chain.cert.pem`  
   * `<WRKDIR>\private\iot-device-<device id>.key.pem`

#### <a name="linux"></a>Linux

1. Загрузите файл сертификата ROOT CA `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`из рабочего каталога в концентратор IoT.

2. Используйте код, представленный на портале Azure, чтобы убедиться, что у вас есть сертификат root CA.

   ```bash
   ./certGen.sh create_verification_certificate "<verification code>"
   ```

3. Создайте цепочку сертификатов для устройства ниже по течению. Используйте тот же идентификатор устройства, на который зарегистрировано устройство в Концентраторе IoT.

   ```bash
   ./certGen.sh create_device_certificate "<device id>"
   ```

   Эта команда скрипта создает несколько сертификатов и ключевых файлов. Следующие сертификаты и пары ключей должны быть скопированы на устройство IoT вниз по течению и упомянуты ею в приложениях, которые подключаются к IoT Hub:

   * `<WRKDIR>/certs/iot-device-<device id>.cert.pem`
   * `<WRKDIR>/certs/iot-device-<device id>.cert.pfx`
   * `<WRKDIR>/certs/iot-device-<device id>-full-chain.cert.pem`  
   * `<WRKDIR>/private/iot-device-<device id>.key.pem`
