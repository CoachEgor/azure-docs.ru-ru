---
title: Развертывание модулей в масштабе на портале Azure - Azure IoT Edge
description: Создание задач автоматического развертывания для групп устройств IoT Edge с помощью портала Azure
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/30/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 0a20ea4236683e26c51bc75309435c65e24271d7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79271438"
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale-using-the-azure-portal"></a>Развертывание и мониторинг большого числа модулей IoT Edge с помощью портала Azure

Создайте **автоматическое развертывание IoT Edge** на портале Azure для управления текущими развертываниями для многих устройств одновременно. Автоматическое развертывание IoT Edge является частью функции [автоматического управления устройствами](/azure/iot-hub/iot-hub-automatic-device-management) IoT Hub. Развертывания — это динамические процессы, которые позволяют развертывать несколько модулей на несколько устройств, отслеживать состояние и работоспособность модулей и при необходимости вносить изменения.

Для получения дополнительной информации [см.](module-deployment-monitoring.md)

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием развертывания необходимо указать устройства, на которые вы хотите повлиять. Azure IoT Edge определяет устройства с помощью **тегов** в двойнике устройства. Каждое устройство может иметь несколько тегов, которые вы определяете в любом случае, что имеет смысл для вашего решения.

Например, если вы управляете кампусом умных зданий, можно добавить теги местоположения, типа комнаты и среды к устройству:

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

Дополнительные сведения о двойниках устройств и тегах см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).

## <a name="create-a-deployment"></a>Создание развертывания

IoT Edge предоставляет два различных типа автоматических развертываний, которые можно использовать для настройки сценария. Вы можете создать стандартное *развертывание,* которое включает в себя модули времени выполнения системы и любые дополнительные модули и маршруты. Каждое устройство может применить только одно развертывание. Или вы можете создать *многоуровневое развертывание,* которое включает только пользовательские модули и маршруты, а не время выполнения системы. Многие многоуровневые развертывания могут быть объединены на устройстве, поверх стандартного развертывания. Для получения дополнительной информации о том, как [Understand IoT Edge automatic deployments for single devices or at scale](module-deployment-monitoring.md)эти два типа автоматических развертываний работают вместе, см.

Шаги для создания развертывания и многоуровневого развертывания очень похожи. Любые различия вызываются в следующих шагах.

1. На [портале Azure](https://portal.azure.com)перейдите на свой концентратор IoT.
1. В меню в левом стеле выберите **IoT Edge** под **управлением автоматического устройства.**
1. На верхней панели выберите **Создать развертывание** или **создать многоуровневое развертывание.**

Процедура создания развертывания состоит из пяти шагов. В следующих разделах описан каждый из этих шагов.

### <a name="step-1-name-and-label"></a>Шаг 1: Имя и этикетка

1. Присвойте своему развертыванию уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.
1. Вы можете добавить метки в виде пар "ключ —значение" для отслеживания развертываний. Например, **HostPlatform** и **Linux** или **Версия** и **3.0.1**.
1. Выберите **следующий: Модули** для перехода на второй шаг.

### <a name="step-2-modules"></a>Шаг 2: Модули

К развертыванию можно добавить до 20 модулей. При создании развертывания без модулей он удаляет все текущие модули с целевых устройств.

В развертывании можно управлять настройками для агента IoT Edge и модулей концентратора IoT Edge. Выберите **параметры runtime** для настройки двух модулей времени выполнения. В многоуровневом развертывании модули времени выполнения не включены, поэтому не могут быть настроены.

Можно добавить три типа модулей:

* Модуль IoT Edge
* Модуль Marketplace
* Модуль аналитики потоков Azure

#### <a name="add-an-iot-edge-module"></a>Добавление модуля IoT Edge

Чтобы добавить пользовательский код в качестве модуля или вручную добавить модуль службы Azure, сделайте следующее:

1. В разделе **"Учетные данные реестра контейнеров"** на странице укажите имена и учетные данные для любых частных реестров контейнеров, содержащих изображения модуля для этого развертывания. Агент IoT Edge сообщит об ошибке 500, если не сможет найти учетные данные реестра контейнеров для изображения Docker.
1. В разделе **Модули IoT Edge** на этой странице щелкните **Добавить**.
1. Выберите **модуль IoT Edge** из выпадающего меню.
1. Дайте вашему модулю **имя модуля IoT Edge.**
1. В поле **URI образа** введите URI образа контейнера для этого модуля.
1. В раскрывающемся меню выберите **политику перезагрузки**. Выберите один из следующих параметров:
   * **всегда** - Модуль всегда перезапускается, если он выключается по какой-либо причине.
   * **никогда** - Модуль никогда не перезапускается, если он выключается по какой-либо причине.
   * **сбой** - Модуль перезапускается, если он выходит из строя, но не если он выключается чисто.
   * **on-un-неработоспособный** - Модуль перезапускается, если он выходит из строя или возвращает неработоспособный статус. Реализация функции состояния работоспособности зависит от модуля.
1. В раскрывающемся меню выберите **требуемое состояние** модуля. Выберите один из следующих параметров:
   * **работает** - Запуск является опцией по умолчанию. Модуль начнет выполняться сразу после развертывания.
   * **остановлен** - После развертывания модуль будет простаивать до тех пор, пока не будет привлечен к работе вами или другим модулем.
1. Укажите любые **параметры создания контейнера**, которые следует передать в контейнер. Дополнительные сведения см. в статье [о создании Docker](https://docs.docker.com/engine/reference/commandline/create/).
1. Выберите **параметры twin модуля,** если вы хотите добавить теги или другие свойства к двойнику модуля.
1. Введите **Переменные среды** для этого модуля. Переменные среды предоставляют информацию о конфигурации модулю.
1. Выберите **Добавить,** чтобы добавить модуль в развертывание.

#### <a name="add-a-module-from-the-marketplace"></a>Добавить модуль с marketplace

Чтобы добавить модуль из Azure Marketplace, выполните следующие действия:

1. В разделе **Модули IoT Edge** на этой странице щелкните **Добавить**.
1. Выберите **модуль Marketplace** из выпадающего меню.
1. Выберите модуль со страницы **IoT Edge Module Marketplace.** Выбранный модуль автоматически настраивается для подписки, группы ресурсов и устройства. Затем он появляется в списке модулей IoT Edge. Некоторые модули могут потребовать дополнительной конфигурации. Для получения дополнительной [информации см. Модули Deploy с рынка Azure.](how-to-deploy-modules-portal.md#deploy-modules-from-azure-marketplace)

#### <a name="add-a-stream-analytics-module"></a>Добавление модуля Stream Analytics

Чтобы добавить модуль из Azure Stream Analytics, сделайте следующее:

1. В разделе **Модули IoT Edge** на этой странице щелкните **Добавить**.
1. Выберите **модуль Azure Stream Analytics** из меню выпадающих потоков.
1. На правом стеле выберите **подписку.**
1. Выберите задание IoT **Edge.**
1. Выберите **Сохранить**, чтобы добавить модуль в развертывание.

#### <a name="configure-module-settings"></a>Настройка настройки модуля

После добавления модуля в развертывание можно выбрать его имя, чтобы открыть страницу **модуля Обновления IoT Edge.** На этой странице можно отсеивать настройки модуля, переменные среды, создавать параметры и двойной модуль. Если вы добавили модуль с рынка, он, возможно, уже некоторые из этих параметров заполнены.

При создании многоуровневого развертывания можно настроить модуль, существующий в других развертываниях, ориентированных на те же устройства. Для обновления модуля twin без перезаписи других версий откройте вкладку **Module Twin Settings.** Создайте новый модуль Twin `properties.desired.settings` **Property** с уникальным названием для подраздела в нужных свойствах модуля близнеца, например. Если вы определите `properties.desired` свойства только в поле, он перезавернет желаемые свойства для модуля, определяемого в любых развертываниях с более низким приоритетом.

![Установите двойное свойство модуля для многоуровневого развертывания](./media/how-to-deploy-monitor/module-twin-property.png)

Для получения дополнительной информации о двойной [Layered deployment](module-deployment-monitoring.md#layered-deployment)конфигурации модуля в многоуровневых развертываниях см.

После того, как все модули для развертывания настроены, выберите **Следующий: Маршруты** для перехода на шаг три.

### <a name="step-3-routes"></a>Шаг 3: Маршруты

Маршруты определяют, как модули взаимодействуют между собой в рамках развертывания. По умолчанию мастер дает вам маршрут, вызванный **вверх по течению** и определяемый как **FROM /messages/ INTO $upstream,\* **что означает, что любые сообщения, выдающиеся любыми модулями, отправляются в ваш концентратор IoT.  

Добавьте в маршруты информацию из раздела [Объявление маршрутов](module-composition.md#declare-routes), а затем щелкните **Далее**, чтобы перейти к разделу проверки.

Выберите **далее: Метрика**.

### <a name="step-4-metrics"></a>Шаг 4: Метрика

Метрики предоставляют общее количество различных состояний, которые устройство может передавать в результате применения содержимого конфигурации.

1. Введите имя **для метеоиментного имени.**

1. Введите запрос для параметра **Metric Criteria** (Критерии метрики). Запрос основан на [переданных свойствах](module-edgeagent-edgehub.md#edgehub-reported-properties) двойников модуля центра IoT Edge. Метрика представляет количество строк, возвращаемых запросом.

   Пример:

   ```sql
   SELECT deviceId FROM devices
     WHERE properties.reported.lastDesiredStatus.code = 200
   ```

Выберите **далее: Целевые устройства**.

### <a name="step-5-target-devices"></a>Шаг 5: Целевые устройства

С помощью свойств тегов ваших устройств можно назначить конкретные устройства, к которым будет применяться это развертывание.

Так как несколько развертываний могут предназначаться для одного устройства, каждому развертыванию необходимо присвоить номер приоритета. Если когда-либо возникает конфликт, вывыигрываетось развертывание с наивысшим приоритетом (большие значения указывают на более высокий приоритет). Когда оба развертывания имеют одинаковый номер приоритета, побеждает то, которое было создано недавно.

Если несколько развертываний нацелены на одно и то же устройство, то применяется только одно с более высоким приоритетом. Если несколько многоуровневых развертываний нацелены на одно и то же устройство, то все они применяются. Однако, если какие-либо свойства дублируются, например, если есть два маршрута с одинаковым именем, то один из более высокого приоритета слоистых развертывания перезаписывает остальные.

Любое многоуровневое развертывание, ориентированное на устройство, должно иметь более высокий приоритет, чем базовое развертывание для применения.

1. Введите положительное целое число для **приоритета** развертывания.
1. Введите **условие назначения**, чтобы определить, для каких устройств будет предназначено это развертывание.Условие основано на тегах двойника устройства или его сообщаемых свойствах и должно соответствовать формату выражения.Например, `tags.environment='test'` или `properties.reported.devicemodel='4000x'`.

Выберите **далее: Обзор и Создайте,** чтобы перейти к заключительному шагу.

### <a name="step-6-review-and-create"></a>Шаг 6: Обзор и создание

Просмотрите информацию о развертывании, а затем выберите **Create**.

## <a name="monitor-a-deployment"></a>Мониторинг развертывания

Чтобы просмотреть сведения о развертывании и узнать, какое устройство его выполняет, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Выберите вкладку **развертываний IoT Edge.**

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Изучите список развертывания.Для каждого развертывания можно просмотреть следующие сведения:
   * **Идентификатор**. Имя развертывания.
   * **Тип** - тип развертывания, **развертывание** или **многоуровневое развертывание.**
   * **Целевое состояние** - тег, используемый для определения целевых устройств.
   * **Приоритет.** Номер приоритета, назначенный для развертывания.
   * **Системные метрики** - **Targeted** определяют количество близнецов устройств в IoT Hub, которые соответствуют состоянию таргетинга, а **Прикладная** определяет количество устройств, содержимое которых было применено к их близнецам модулей в IoT Hub.
   * **Метрики устройств** - количество устройств IoT Edge в развертывании, сообщающих об успехе или ошибках от времени выполнения клиента IoT Edge.
   * **Custom Metrics** - количество устройств IoT Edge в данных отчетности о развертывании для любых метрик, определенных для развертывания.
   * **Время создания** - отметка времени с момента создания развертывания. Метка времени используется, чтобы разорвать связи, если два развертывания имеют одинаковый приоритет.
1. Выберите развертывание, которое вы хотите отслеживать.  
1. Изучите сведения о развертывании. Вы можете использовать вкладки для просмотра сведений о развертывании.

## <a name="modify-a-deployment"></a>Изменение развертывания

При изменении развертывания изменения немедленно реплицируются во все целевые устройства.

Если обновить целевое условие, произойдут следующие обновления:

* Если устройство не соответствует предыдущему условию назначения, однако соответствует новому и это развертывание имеет самый высокий приоритет для устройства, то оно будет применено к устройству.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, оно удаляет это развертывание и выполняет следующее развертывание с самым высоким приоритетом.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, а также условию назначения любого другого развертывания, в устройстве не происходит никаких изменений. Устройство продолжает выполнять текущие модули в их актуальном состоянии, однако больше не управляется как часть этого развертывания. Если устройство соответствует условию назначения любого другого развертывания, оно удаляет это развертывание и выполняет новое.

Чтобы изменить развертывание, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Выберите вкладку **IoT Edge Deployments.**

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Выберите развертывание, которое вы хотите изменить.
1. Сделайте обновления на следующих вкладок:
   * **Целевое состояние**
   * **Метрика** - вы можете изменить или удалить метрики, которые вы определили, или добавить новые.
   * **Метки**
   * **Модули**
   * **Маршруты**
   * **Развертывание**

1. Нажмите кнопку **Сохранить**.
1. Для отслеживания выполнения изменений следуйте указаниям раздела [Мониторинг развертывания](#monitor-a-deployment).

## <a name="delete-a-deployment"></a>Удаление развертывания

При удалении развертывания все развернутые устройства берут на себя следующий наивысший приоритет развертывания. Если устройства не соответствуют условиям назначения любого другого развертывания, то модули не будут удалены при удалении развертывания.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Выберите вкладку **IoT Edge Deployments.**

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Установите флажок, чтобы выбрать развертывание, которое необходимо удалить.
1. Выберите **Удалить**.
1. Появится запрос с сообщением о том, что это действие удалит развертывание и будут возвращены предыдущие состояния всех устройств.Это значит, что будет применено развертывание с низким приоритетом.Если не указаны другие развертывания, модули не будут удалены. Чтобы удалить все модули из устройства, создайте развертывание без модулей и разверните его на этом устройстве.Чтобы продолжить, нажмите кнопку **Да**.

## <a name="next-steps"></a>Дальнейшие действия

Подробнее о [развертывании модулей на устройстваio-прилежных.](module-deployment-monitoring.md)
