---
title: Создание задачи автоматического развертывания на портале Azure — Azure IoT Edge | Документация Майкрософт
description: Создание задач автоматического развертывания для групп устройств IoT Edge с помощью портала Azure
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 06/17/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 286bab7b7fdbe42190c32dabb42c59d6fc094b2a
ms.sourcegitcommit: 12d902e78d6617f7e78c062bd9d47564b5ff2208
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2019
ms.locfileid: "74457366"
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale-using-the-azure-portal"></a>Развертывание и мониторинг большого числа модулей IoT Edge с помощью портала Azure

Создайте **IOT Edge автоматическое развертывание** в портал Azure, чтобы управлять текущими развертываниями для нескольких устройств одновременно. Автоматические развертывания для IoT Edge входят в функцию [автоматического управления устройствами](/azure/iot-hub/iot-hub-automatic-device-management) в центре Интернета вещей. Развертывания — это динамические процессы, которые позволяют развертывать несколько модулей на нескольких устройствах, контролировать состояние и работоспособность модулей, а также вносить изменения при необходимости. 

Дополнительные сведения см. в статье [IOT Edge автоматическое развертывание для отдельных устройств или в масштабе](module-deployment-monitoring.md).

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием развертывания необходимо указать устройства, на которые вы хотите повлиять. Azure IoT Edge определяет устройства с помощью **тегов** в двойнике устройства. Каждое устройство может иметь несколько тегов, которые определяются любым способом, имеющим смысл для вашего решения. Например, при управлении кампусом интеллектуальных зданий можно добавлять к устройству следующие теги:

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

Дополнительные сведения о двойниках устройств и тегах см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).

## <a name="create-a-deployment"></a>Создание развертывания

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com). 
1. Выберите **IoT Edge**.
1. Выберите **Add IoT Edge Deployment** (Добавить развертывание IoT Edge).

Процедура создания развертывания состоит из пяти шагов. В следующих разделах описан каждый из этих шагов. 

### <a name="step-1-name-and-label"></a>Шаг 1. Имя и метка

1. Присвойте своему развертыванию уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.
1. Вы можете добавить метки в виде пар "ключ —значение" для отслеживания развертываний. Например, **HostPlatform** и **Linux** или **Версия** и **3.0.1**.
1. Нажмите кнопку **Далее**, чтобы перейти ко второму шагу. 

### <a name="step-2-add-modules-optional"></a>Шаг 2. Добавление модулей (необязательно)

В развертывание можно добавить до 20 модулей. 

Если вы создаете развертывание без модулей, оно удаляет все текущие модули с целевых устройств. 

Чтобы добавить модуль из Azure Stream Analytics, сделайте следующее:

1. В разделе **Модули развертывания** на этой странице щелкните **Добавить**.
1. Выберите модуль **Azure Stream Analytics**.
1. В раскрывающемся меню выберите свою **подписку**.
1. Выберите задание IoT **ребра** в раскрывающемся меню.
1. Выберите **Сохранить**, чтобы добавить модуль в развертывание. 

Чтобы добавить пользовательский код в качестве модуля или вручную добавить модуль службы Azure, сделайте следующее:

1. В разделе **Параметры реестра контейнеров** на этой странице введите имена и учетные данные всех реестров частных контейнеров, которые содержат образы модулей для этого развертывания. Агент IoT Edge сообщит об ошибке 500, если не удается найти учетные данные реестра контейнеров для образа DOCKER.
1. В разделе **Модули развертывания** на этой странице щелкните **Добавить**.
1. Выберите **Модуль IoT Edge**.
1. Укажите **имя** модуля.
1. В поле **URI образа** введите URI образа контейнера для этого модуля. 
1. Укажите любые **параметры создания контейнера**, которые следует передать в контейнер. Дополнительные сведения см. в статье [о создании Docker](https://docs.docker.com/engine/reference/commandline/create/).
1. В раскрывающемся меню выберите **политику перезагрузки**. Выберите один из следующих параметров: 
   * **Всегда.** Модуль всегда перезапускается, если он завершил работу по любой причине.
   * **никогда** — модуль никогда не перезагружается, если по какой-либо причине завершается.
   * **On-Failure** — модуль перезапускается, если он завершается сбоем, но не в случае чистого завершения работы. 
   * **при неработоспособном** состоянии модуль перезапускается, если он аварийно завершает работу или возвращает неработоспособное состояние. Реализация функции состояния работоспособности зависит от модуля. 
1. В раскрывающемся меню выберите **требуемое состояние** модуля. Выберите один из следующих параметров:
   * **выполнение** — это параметр по умолчанию. Модуль начнет выполняться сразу после развертывания.
   * **остановлено** — после развертывания модуль остается неактивным до тех пор, пока не будет вызван для запуска пользователем или другим модулем.
1. Выберите **Установить требуемые свойства двойника модуля**, если необходимо добавить теги или другие свойства в двойник модуля.
1. Введите **Переменные среды** для этого модуля. Переменные среды предоставляют сведения о конфигурации для модуля.
1. Выберите **Сохранить**, чтобы добавить модуль в развертывание. 

Настроив все модули для развертывания, нажмите кнопку **Далее**, чтобы перейти к шагу 3.

### <a name="step-3-specify-routes-optional"></a>Шаг 3. Указание маршрутов (необязательно)

Маршруты определяют, как модули взаимодействуют между собой в рамках развертывания. По умолчанию мастер предлагает маршрут с именем **route**, который определен как **FROM /* INTO $upstream**. Этот маршрут направляет все сообщения, выводимые любыми модулями, в Центр Интернета вещей.  

Добавьте в маршруты информацию из раздела [Объявление маршрутов](module-composition.md#declare-routes), затем щелкните **Далее**, чтобы перейти к разделу проверки.

### <a name="step-4-specify-metrics-optional"></a>Шаг 4. Указание метрик (необязательно)

Метрики предоставляют общее количество различных состояний, которые устройство может передавать в результате применения содержимого конфигурации.

1. Введите имя для параметра **Имя метрики**.

1. Введите запрос для параметра **Metric Criteria** (Критерии метрики). Запрос основан на [переданных свойствах](module-edgeagent-edgehub.md#edgehub-reported-properties) двойников модуля центра IoT Edge. Метрика представляет количество строк, возвращаемых запросом.

   Например,

   ```sql
   SELECT deviceId FROM devices
     WHERE properties.reported.lastDesiredStatus.code = 200
   ```

### <a name="step-5-target-devices"></a>Шаг 5. целевые устройства

С помощью свойств тегов ваших устройств можно назначить конкретные устройства, к которым будет применяться это развертывание. 

Так как несколько развертываний могут предназначаться для одного устройства, каждому развертыванию необходимо присвоить номер приоритета. Если возникает конфликт, развертывание с наивысшим приоритетом (более крупные значения указывает более высокий приоритет) WINS. Когда оба развертывания имеют одинаковый номер приоритета, побеждает то, которое было создано недавно. 

1. Введите положительное целое число для **приоритета** развертывания.
1. Введите **условие назначения**, чтобы определить, для каких устройств будет предназначено это развертывание. Условие основано на тегах двойникаа устройства или сообщаемых свойствах двойникаа устройства и должно соответствовать формату выражения. Например, `tags.environment='test'` или `properties.reported.devicemodel='4000x'`. 
1. Нажмите кнопку **Далее**, чтобы перейти к последнему шагу.

### <a name="step-6-review-deployment"></a>Шаг 6. Проверка развертывания

Просмотрите сведения о развертывании, а затем выберите **Отправить**.

## <a name="deploy-modules-from-azure-marketplace"></a>Развертывание модулей из Azure Marketplace

Azure Marketplace — это интернет-магазин приложений и служб, где вы можете просматривать разнообразные корпоративные приложения и решения, сертифицированные и оптимизированные для работы в Azure, включая [модули IoT Edge](https://azuremarketplace.microsoft.com/marketplace/apps/category/internet-of-things?page=1&subcategories=iot-edge-modules). Доступ к Azure Marketplace возможен также с помощью портала Azure в разделе **Создать ресурс**.

Модуль IoT Edge можно развернуть из Azure Marketplace или портал Azure.

1. Найдите модуль и начните процесс развертывания.

   * Портал Azure: Найдите модуль и выберите **создать**.

   * Azure Marketplace:

     1. Найдите модуль и выберите **Получить**.
     1. Подтвердите условия использования и политику конфиденциальности поставщика, выбрав **Продолжить**.

1. Выберите свою подписку и Центр Интернета вещей, к которому подключено целевое устройство.

1. Выберите **Развертывание в масштабе**.

1. Выберите, следует ли добавить модуль в новое развертывание или в клон существующего развертывания. При клонировании выберите существующее развертывание из списка.

1. Выберите **Создать**, чтобы продолжить процесс создания развертывания в масштабе. Вы сможете указать те же данные, что и для любого развертывания.

## <a name="monitor-a-deployment"></a>Мониторинг развертывания

Чтобы просмотреть сведения о развертывании и узнать, какое устройство его выполняет, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей. 
1. Выберите **IoT Edge**.
1. Выберите **IoT Edge deployments** (Развертывания IoT Edge). 

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Изучите список развертывания. Для каждого развертывания можно просмотреть следующие сведения:
   * **Идентификатор**. Имя развертывания.
   * **Target condition** (Условие назначения). Тег, используемый для определения целевых устройств.
   * **Приоритет.** Номер приоритета, назначенный для развертывания.
   * **Системные метрики** - **Целевые устройства**. Число двойников устройств в Центре Интернета вещей, которые соответствуют заданному условию. **Применено**. Число устройств, к двойникам которых уже применено содержимое этого развертывания в Центре Интернета вещей. 
   * **Метрики устройства** — количество IOT Edge устройств в развертывании, сообщающих об успешном выполнении или ошибках из среды выполнения клиента IOT Edge.
   * **Пользовательские метрики** — количество IOT Edgeных устройств в данных отчетов о развертывании для всех метрик, определенных для развертывания.
   * **Время создания.** Метка времени, когда было создано развертывание. Метка времени используется, чтобы разорвать связи, если два развертывания имеют одинаковый приоритет. 
1. Выберите развертывание, которое вы хотите отслеживать.  
1. Изучите сведения о развертывании. Вы можете использовать вкладки для просмотра сведений о развертывании.

## <a name="modify-a-deployment"></a>Изменение развертывания

При изменении развертывания изменения немедленно реплицируются во все целевые устройства. 

Если обновить целевое условие, произойдут следующие обновления:

* Если устройство не соответствует предыдущему условию назначения, однако соответствует новому и это развертывание имеет самый высокий приоритет для устройства, то оно будет применено к устройству. 
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, оно удаляет это развертывание и выполняет следующее развертывание с самым высоким приоритетом. 
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, а также условию назначения любого другого развертывания, в устройстве не происходит никаких изменений. Устройство продолжает выполнять текущие модули в их актуальном состоянии, однако больше не управляется как часть этого развертывания. Если устройство соответствует условию назначения любого другого развертывания, оно удаляет это развертывание и выполняет новое. 

Чтобы изменить развертывание, сделайте следующее: 

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей. 
1. Выберите **IoT Edge**.
1. Выберите **IoT Edge deployments** (Развертывания IoT Edge). 

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Выберите развертывание, которое вы хотите изменить. 
1. Внесите изменения в следующие поля: 
   * Условие назначения
   * Метрики. Вы можете изменить или удалить метрики, которые определили, или добавить новые.
   * Метки
   * Приоритет
1. Щелкните **Сохранить**.
1. Для отслеживания выполнения изменений следуйте указаниям раздела [Мониторинг развертывания](#monitor-a-deployment). 

## <a name="delete-a-deployment"></a>Удаление развертывания

При удалении развертывания все устройства выполняют следующее развертывание, которое имеет наивысший приоритет. Если устройства не соответствуют условиям назначения любого другого развертывания, то модули не будут удалены при удалении развертывания. 

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей. 
1. Выберите **IoT Edge**.
1. Выберите **IoT Edge deployments** (Развертывания IoT Edge). 

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Установите флажок, чтобы выбрать развертывание, которое необходимо удалить. 
1. Нажмите кнопку **Удалить**.
1. Появится запрос с сообщением о том, что это действие удалит развертывание и будут возвращены предыдущие состояния всех устройств.  Это означает, что будет применено развертывание с более низким приоритетом.  Если другие развертывания не предназначены, модули не удаляются. Чтобы удалить все модули из устройства, создайте развертывание без модулей и разверните его на этом устройстве. Нажмите кнопку **Да** , чтобы продолжить. 

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о [развертывании модулей на IOT Edge устройствах](module-deployment-monitoring.md).
