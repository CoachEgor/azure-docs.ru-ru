---
title: Развертывание модулей в масштабе в портал Azure Azure IoT Edge
description: Создание задач автоматического развертывания для групп устройств IoT Edge с помощью портала Azure
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/30/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 0a20ea4236683e26c51bc75309435c65e24271d7
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79271438"
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale-using-the-azure-portal"></a>Развертывание и мониторинг большого числа модулей IoT Edge с помощью портала Azure

Создайте **IOT Edge автоматическое развертывание** в портал Azure, чтобы управлять текущими развертываниями для нескольких устройств одновременно. Автоматические развертывания для IoT Edge входят в функцию [автоматического управления устройствами](/azure/iot-hub/iot-hub-automatic-device-management) в центре Интернета вещей. Развертывания — это динамические процессы, которые позволяют развертывать несколько модулей на нескольких устройствах, контролировать состояние и работоспособность модулей, а также вносить изменения при необходимости.

Дополнительные сведения см. в статье [IOT Edge автоматическое развертывание для отдельных устройств или в масштабе](module-deployment-monitoring.md).

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием развертывания необходимо указать устройства, на которые вы хотите повлиять. Azure IoT Edge определяет устройства с помощью **тегов** в двойнике устройства. Каждое устройство может иметь несколько тегов, которые определяются любым способом, имеющим смысл для вашего решения.

Например, при управлении кампусом интеллектуальных зданий на устройство можно добавить расположение, тип комнаты и Теги среды:

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

Дополнительные сведения о двойниках устройств и тегах см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).

## <a name="create-a-deployment"></a>Создание развертывания

IoT Edge предоставляет два различных типа автоматических развертываний, которые можно использовать для настройки сценария. Можно создать стандартное *развертывание*, которое включает в себя модули среды выполнения системы и дополнительные модули и маршруты. Каждое устройство может применять только одно развертывание. Также можно создать *многослойное развертывание*, которое включает в себя только пользовательские модули и маршруты, а не системную среду выполнения. Многие многоуровневые развертывания можно объединять на устройстве на основе стандартного развертывания. Дополнительные сведения о совместной работе двух типов автоматических развертываний см. [в статье IOT Edge автоматическое развертывание для отдельных устройств или в масштабе](module-deployment-monitoring.md).

Шаги по созданию развертывания и многоуровневого развертывания очень похожи. Все различия вызываются в следующих шагах.

1. В [портал Azure](https://portal.azure.com)перейдите в центр Интернета вещей.
1. В меню в левой области выберите **IOT Edge** в разделе **Автоматическое управление устройствами**.
1. На верхней панели выберите **Создать развертывание** или **создать многоуровневую развертывание**.

Процедура создания развертывания состоит из пяти шагов. В следующих разделах описан каждый из этих шагов.

### <a name="step-1-name-and-label"></a>Шаг 1. имя и метка

1. Присвойте своему развертыванию уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.
1. Вы можете добавить метки в виде пар "ключ —значение" для отслеживания развертываний. Например, **HostPlatform** и **Linux** или **Версия** и **3.0.1**.
1. Нажмите кнопку **Далее: модули** , чтобы перейти к шагу 2.

### <a name="step-2-modules"></a>Шаг 2. модули

В развертывание можно добавить до 20 модулей. Если вы создаете развертывание без модулей, оно удаляет все текущие модули с целевых устройств.

В развернутых средах можно управлять параметрами агента IoT Edge и модулей IoT Edge концентратора. Выберите **Параметры среды выполнения** , чтобы настроить два модуля среды выполнения. В многоуровневом развертывании модули среды выполнения не включаются, поэтому их нельзя настроить.

Можно добавить три типа модулей:

* Модуль IoT Edge
* Модуль Marketplace
* Модуль Azure Stream Analytics

#### <a name="add-an-iot-edge-module"></a>Добавление модуля IoT Edge

Чтобы добавить пользовательский код в качестве модуля или вручную добавить модуль службы Azure, сделайте следующее:

1. В разделе **учетные данные реестра контейнеров** на странице Укажите имена и учетные данные для любых закрытых реестров контейнеров, содержащих образы модулей для этого развертывания. Агент IoT Edge сообщит об ошибке 500, если не удается найти учетные данные реестра контейнеров для образа DOCKER.
1. В разделе **Модули IoT Edge** на этой странице щелкните **Добавить**.
1. В раскрывающемся меню выберите **IOT Edge Module (модуль** ).
1. Присвойте модулю **имя модуля IOT Edge**.
1. В поле **URI образа** введите URI образа контейнера для этого модуля.
1. В раскрывающемся меню выберите **политику перезагрузки**. Выберите один из следующих параметров:
   * **всегда** — модуль всегда перезапускается, если по какой-либо причине завершает работу.
   * **никогда** — модуль никогда не перезагружается, если по какой-либо причине завершается.
   * **On-Failure** — модуль перезапускается, если он завершается сбоем, но не в случае чистого завершения работы.
   * **при неработоспособном** состоянии модуль перезапускается, если он аварийно завершает работу или возвращает неработоспособное состояние. Реализация функции состояния работоспособности зависит от модуля.
1. В раскрывающемся меню выберите **требуемое состояние** модуля. Выберите один из следующих параметров:
   * **выполнение** — это параметр по умолчанию. Модуль начнет выполняться сразу после развертывания.
   * **остановлено** — после развертывания модуль остается неактивным до тех пор, пока не будет вызван для запуска пользователем или другим модулем.
1. Укажите любые **параметры создания контейнера**, которые следует передать в контейнер. Дополнительные сведения см. в статье [о создании Docker](https://docs.docker.com/engine/reference/commandline/create/).
1. Выберите **модуль двойника параметры** , если требуется добавить теги или другие свойства в модуль двойника.
1. Введите **Переменные среды** для этого модуля. Переменные среды предоставляют сведения о конфигурации для модуля.
1. Нажмите кнопку **Добавить** , чтобы добавить модуль в развертывание.

#### <a name="add-a-module-from-the-marketplace"></a>Добавление модуля из Marketplace

Чтобы добавить модуль из Azure Marketplace, выполните следующие действия.

1. В разделе **Модули IoT Edge** на этой странице щелкните **Добавить**.
1. В раскрывающемся меню выберите **модуль Marketplace** .
1. Выберите модуль на странице **IOT Edge модуль Marketplace** . Выбранный модуль автоматически настраивается для вашей подписки, группы ресурсов и устройства. Затем он появится в списке модулей IoT Edge. Для некоторых модулей может потребоваться дополнительная настройка. Дополнительные сведения см. [в статье Развертывание модулей из Azure Marketplace](how-to-deploy-modules-portal.md#deploy-modules-from-azure-marketplace).

#### <a name="add-a-stream-analytics-module"></a>Добавление модуля Stream Analytics

Чтобы добавить модуль из Azure Stream Analytics, сделайте следующее:

1. В разделе **Модули IoT Edge** на этой странице щелкните **Добавить**.
1. В раскрывающемся меню выберите **Azure Stream Analytics Module (модуль** ).
1. В области справа выберите свою **подписку**.
1. Выберите задание IoT **ребра**.
1. Выберите **Сохранить**, чтобы добавить модуль в развертывание.

#### <a name="configure-module-settings"></a>Настройка параметров модуля

После добавления модуля в развертывание можно выбрать его имя, чтобы открыть страницу **обновление IOT Edge модуля** . На этой странице можно изменить параметры модуля, переменные среды, параметры создания и двойника модуля. Если вы добавили модуль из Marketplace, возможно, некоторые из этих параметров уже заполнены.

При создании многоуровневого развертывания вы можете настроить модуль, который существует в других развертываниях, предназначенных для тех же устройств. Чтобы обновить модуль двойника без перезаписи других версий, откройте вкладку **Параметры двойника модуля** . Создайте новое **свойство двойника модуля** с уникальным именем для подраздела в требуемых свойствах модуля двойника, например `properties.desired.settings`. Если свойства определяются только в поле `properties.desired`, то будут перезаписаны требуемые свойства для модуля, определенного в развертываниях с более низким приоритетом.

![Задание свойства двойника модуля для многоуровневого развертывания](./media/how-to-deploy-monitor/module-twin-property.png)

Дополнительные сведения о конфигурации модуля двойника в многоуровневых развертываниях см. в разделе [Иерархическое развертывание](module-deployment-monitoring.md#layered-deployment).

После того как все модули для развертывания настроены, нажмите кнопку **Далее: Маршруты** , чтобы перейти к шагу 3.

### <a name="step-3-routes"></a>Шаг 3. маршруты

Маршруты определяют, как модули взаимодействуют между собой в рамках развертывания. По умолчанию мастер предоставляет маршрут, который называется **вышестоящим** и определяется как **/мессажес/\* в $upstream**. Это означает, что все сообщения, выводимые любыми модулями, отправляются в центр Интернета вещей.  

Добавьте в маршруты информацию из раздела [Объявление маршрутов](module-composition.md#declare-routes), а затем щелкните **Далее**, чтобы перейти к разделу проверки.

Выберите **Далее: метрики**.

### <a name="step-4-metrics"></a>Шаг 4. метрики

Метрики предоставляют общее количество различных состояний, которые устройство может передавать в результате применения содержимого конфигурации.

1. Введите имя для параметра **Имя метрики**.

1. Введите запрос для параметра **Metric Criteria** (Критерии метрики). Запрос основан на [переданных свойствах](module-edgeagent-edgehub.md#edgehub-reported-properties) двойников модуля центра IoT Edge. Метрика представляет количество строк, возвращаемых запросом.

   Пример:

   ```sql
   SELECT deviceId FROM devices
     WHERE properties.reported.lastDesiredStatus.code = 200
   ```

Выберите **Далее: целевые устройства**.

### <a name="step-5-target-devices"></a>Шаг 5. целевые устройства

С помощью свойств тегов ваших устройств можно назначить конкретные устройства, к которым будет применяться это развертывание.

Так как несколько развертываний могут предназначаться для одного устройства, каждому развертыванию необходимо присвоить номер приоритета. Если возникает конфликт, развертывание с наивысшим приоритетом (более крупные значения указывает более высокий приоритет) WINS. Когда оба развертывания имеют одинаковый номер приоритета, побеждает то, которое было создано недавно.

Если несколько развертываний предназначены для одного и того же устройства, применяется только одно из них с более высоким приоритетом. Если несколько многоуровневых развертываний нацелены на одно и то же устройство, все они применяются. Однако если какие бы то ни было свойства дублируются, например при наличии двух маршрутов с одним и тем же именем, то все остальное будет перезаписано одним из слоев с более высоким приоритетом.

Любое многоуровневое развертывание, предназначенное для устройства, должно иметь более высокий приоритет, чем базовое развертывание, чтобы оно было применено.

1. Введите положительное целое число для **приоритета** развертывания.
1. Введите **условие назначения**, чтобы определить, для каких устройств будет предназначено это развертывание. Условие основано на тегах двойникаа устройства или сообщаемых свойствах двойникаа устройства и должно соответствовать формату выражения. Например, `tags.environment='test'` или `properties.reported.devicemodel='4000x'`.

Нажмите кнопку **Далее: Проверка + создать** , чтобы перейти к последнему шагу.

### <a name="step-6-review-and-create"></a>Шаг 6. Проверка и создание

Просмотрите сведения о развертывании и нажмите кнопку **создать**.

## <a name="monitor-a-deployment"></a>Мониторинг развертывания

Чтобы просмотреть сведения о развертывании и узнать, какое устройство его выполняет, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Перейдите на вкладку **развертывания IOT Edge** .

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Изучите список развертывания. Для каждого развертывания можно просмотреть следующие сведения:
   * **Идентификатор**. Имя развертывания.
   * **Тип** — тип развертывания: **развертывание** или **Многоуровневый развертывание**.
   * **Целевое условие** — тег, используемый для определения целевых устройств.
   * **Приоритет.** Номер приоритета, назначенный для развертывания.
   * **Системные метрики** - **Целевые устройства**. Число двойников устройств в Центре Интернета вещей, которые соответствуют заданному условию. **Применено**. Число устройств, к двойникам которых уже применено содержимое этого развертывания в Центре Интернета вещей.
   * **Метрики устройства** — количество IOT Edge устройств в развертывании, сообщающих об успешном выполнении или ошибках из среды выполнения клиента IOT Edge.
   * **Пользовательские метрики** — количество IOT Edgeных устройств в данных отчетов о развертывании для всех метрик, определенных для развертывания.
   * **Время создания** — метка времени, начиная с момента создания развертывания. Метка времени используется, чтобы разорвать связи, если два развертывания имеют одинаковый приоритет.
1. Выберите развертывание, которое вы хотите отслеживать.  
1. Изучите сведения о развертывании. Вы можете использовать вкладки для просмотра сведений о развертывании.

## <a name="modify-a-deployment"></a>Изменение развертывания

При изменении развертывания изменения немедленно реплицируются во все целевые устройства.

Если обновить целевое условие, произойдут следующие обновления:

* Если устройство не соответствует предыдущему условию назначения, однако соответствует новому и это развертывание имеет самый высокий приоритет для устройства, то оно будет применено к устройству.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, оно удаляет это развертывание и выполняет следующее развертывание с самым высоким приоритетом.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, а также условию назначения любого другого развертывания, в устройстве не происходит никаких изменений. Устройство продолжает выполнять текущие модули в их актуальном состоянии, однако больше не управляется как часть этого развертывания. Если устройство соответствует условию назначения любого другого развертывания, оно удаляет это развертывание и выполняет новое.

Чтобы изменить развертывание, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Перейдите на вкладку **развертывания IOT Edge** .

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Выберите развертывание, которое вы хотите изменить.
1. Установите обновления на следующих вкладках:
   * **Целевое условие**
   * **Метрики** . Вы можете изменять или удалять определенные вами метрики или добавлять новые.
   * **Метки**
   * **Модуле**
   * **Маршруты**
   * **Deployment**

1. Щелкните **Сохранить**.
1. Для отслеживания выполнения изменений следуйте указаниям раздела [Мониторинг развертывания](#monitor-a-deployment).

## <a name="delete-a-deployment"></a>Удаление развертывания

При удалении развертывания все развернутые устройства принимаются в следующем развертывании с наивысшим приоритетом. Если устройства не соответствуют условиям назначения любого другого развертывания, то модули не будут удалены при удалении развертывания.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Перейдите на вкладку **развертывания IOT Edge** .

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Установите флажок, чтобы выбрать развертывание, которое необходимо удалить.
1. Выберите команду **Удалить**.
1. Появится запрос с сообщением о том, что это действие удалит развертывание и будут возвращены предыдущие состояния всех устройств.  Это означает, что будет применено развертывание с более низким приоритетом. Если другие развертывания не предназначены, модули не удаляются. Чтобы удалить все модули из устройства, создайте развертывание без модулей и разверните его на этом устройстве. Нажмите кнопку **Да** , чтобы продолжить.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о [развертывании модулей на IOT Edge устройствах](module-deployment-monitoring.md).
