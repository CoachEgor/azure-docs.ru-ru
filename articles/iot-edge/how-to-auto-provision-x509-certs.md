---
title: Автоматическое предоставление устройств с DPS с использованием сертификатов X.509 - Azure IoT Edge Документы Майкрософт
description: Используйте сертификаты X.509 для тестирования автоматического устройства для Azure IoT Edge с службой обеспечения устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.reviewer: kevindaw
ms.date: 03/06/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: b4d247f151240da8c3f0d38bbd22e43e230a1b95
ms.sourcegitcommit: 67addb783644bafce5713e3ed10b7599a1d5c151
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2020
ms.locfileid: "80668611"
---
# <a name="create-and-provision-an-iot-edge-device-using-x509-certificates"></a>Создание и предоставление устройства IoT Edge с использованием сертификатов X.509

С [помощью службы обеспечения устройств Концентратора Azure (DPS)](../iot-dps/index.yml)вы можете автоматически предоставлять устройства IoT Edge с помощью сертификатов X.509. При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить.

В этой статье показано, как создать службу обеспечения устройств с помощью сертификатов X.509 на устройстве IoT Edge со следующими шагами:

* Создание сертификатов и ключей.
* Создание либо индивидуальной регистрации для устройства, либо регистрации группы для набора устройств.
* Установите время выполнения IoT Edge и зарегистрируйте устройство с помощью IoT Hub.

Применение сертификатов X.509 в качестве механизма аттестации позволяет легко масштабировать производство и упростить подготовку устройств к работе. Как правило, сертификаты X.509 разоблачяются в цепочке доверительных кваранов. Начиная с самоподписанного или надежного корневого сертификата, каждый сертификат в цепочке подписывает следующий нижний сертификат. Этот шаблон создает делегированную цепочку доверия от корневого сертификата до каждого промежуточного сертификата до окончательного сертификата "лист", установленного на устройстве.

## <a name="prerequisites"></a>Предварительные требования

* Действующий Центр Интернета вещей.
* Физическое или виртуальное устройство для устройства IoT Edge.
* Последняя версия [Git](https://git-scm.com/download/) установлена.
* Пример службы обеспечения устройств Концентратора IoT в Azure, связанный с концентратором IoT.
  * Если у вас нет экземпляра Службы обеспечения устройств, следуйте инструкциям в [Настройке IoT Hub DPS.](../iot-dps/quick-setup-auto-provision.md)
  * После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="generate-device-identity-certificates"></a>Создание идентификационных сертификатов устройства

Сертификат идентификации устройства является сертификатом листа, который соединяется через цепочку доверительных аттестатов к верхнему сертификату X.509 (CA). Сертификат идентификации устройства должен иметь общее имя (CN) в идентификаторе устройства, который вы хотите иметь в вашем концентраторе IoT.

Сертификаты идентификации устройства используются только для подготовки устройства IoT Edge и аутентификации устройства с помощью Azure IoT Hub. Они не подписывают сертификаты, в отличие от сертификатов CA, которые устройство IoT Edge представляет модулям или устройствам листа для проверки. Для получения дополнительной информации смотрите [подробную информацию об использовании сертификата Azure IoT Edge.](iot-edge-certs.md)

После создания удостоверения личности устройства необходимо иметь два файла: файл .cer или .pem, содержащий общедоступную часть сертификата, и файл .cer или .pem с закрытым ключом сертификата. Если вы планируете использовать регистрацию группы в DPS, вам также нужна общегосударственная часть промежуточного или корневого сертификата CA в той же цепочке доверительных коньков.

### <a name="use-test-certificates"></a>Использование тестовых сертификатов

Если у вас нет сертификата для создания новых сертификатов идентификации и вы хотите опробовать этот сценарий, репозиторий Git Azure IoT Edge содержит скрипты, которые можно использовать для создания тестовых сертификатов. Эти сертификаты предназначены только для тестирования разработки и не должны использоваться в производстве.

Чтобы создать тестовые сертификаты, выполните последующие шаги в [создании демо-сертификатов для тестирования функций устройства IoT Edge.](how-to-create-test-certificates.md) Заполните два необходимых раздела для настройки сценариев генерации сертификатов и создания корневого сертификата CA. Затем выполните последующие действия по созданию удостоверения личности устройства. Когда вы закончите, вы должны иметь следующую цепочку сертификатов и пару ключей:

Linux:

* `<WRKDIR>/certs/iot-edge-device-identity-<name>-full-chain.cert.pem`
* `<WRKDIR>/private/iot-edge-device-identity-<name>.key.pem`

Windows:

* `<WRKDIR>\certs\iot-edge-device-identity-<name>-full-chain.cert.pem`
* `<WRKDIR>\private\iot-edge-device-identity-<name>.key.pem`

Оба этих сертификата нужны на устройстве IoT Edge. Если вы собираетесь использовать индивидуальную регистрацию в DPS, то вы загрузите файл .cert.pem. Если вы собираетесь использовать регистрацию группы в DPS, то вам также нужен промежуточный или корневой сертификат CA в той же цепочке доверительных контора для загрузки. Если вы используете демо-сертификаты, используйте `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem` сертификат для регистрации группы.

## <a name="create-a-dps-individual-enrollment"></a>Создание индивидуальной регистрации DPS

Используйте созданные сертификаты и ключи для создания индивидуальной регистрации в DPS для одного устройства IoT Edge. Индивидуальные регистрации принимают общедоступную часть удостоверения личности устройства и сопожат его с сертификатом на устройстве.

Если вы хотите предоставить несколько устройств IoT Edge, выполните следующие действия в следующем разделе, [создайте регистрацию группы DPS.](#create-a-dps-group-enrollment)

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md).

Для получения дополнительной информации о регистрации в [How to manage device enrollments](../iot-dps/how-to-manage-enrollments.md)службе обеспечения устройств см.

   > [!TIP]
   > В Azure CLI можно создать [группу регистрации](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/dps/enrollment) или [регистрации](https://docs.microsoft.com/cli/azure/ext/azure-iot/iot/dps/enrollment-group) и использовать флаг **с поддержкой края,** чтобы указать, что устройство или группа устройств — это устройство IoT Edge.

1. На [портале Azure](https://portal.azure.com)перейдите к экземпляру службы обеспечения устройств IoT Hub.

1. В разделе **Параметры**выберите **Управление регистрациями**.

1. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   * **Механизм**: Выберите **X.509**.

   * **Первичный сертификат .pem или файл .cer**: Загрузить общедоступный файл из сертификата идентификации устройства. Если вы использовали скрипты для создания тестового сертификата, выберите следующий файл:

      `<WRKDIR>/certs/iot-edge-device-identity-<name>-full-chain.cert.pem`

   * **IoT Hub Device ID:** Предоставьте идентификатор для вашего устройства, если вы хотите. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если вы не предоставили идентификатор устройства, используется общее имя (CN) в сертификате X.509.

   * **Устройство IoT Edge:** Выберите **True,** чтобы заявить, что регистрация предназначена для устройства IoT Edge.

   * **Выберите концентраторы IoT, к которым можно присвоить это устройство:** Выберите связанный концентратор IoT, к которым вы хотите подключить устройство. Вы можете выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   * **Начальное состояние Twin Device:** Добавить значение тегов, которое будет добавлено к близнецу устройства, если вы хотите. Теги можно использовать для целевых групп устройств для автоматического развертывания. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

1. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, время выполнения IoT Edge может автоматически предоставлять устройство во время установки. Продолжить [установку раздела времени выполнения IoT Edge](#install-the-iot-edge-runtime) для настройки устройства IoT Edge.

## <a name="create-a-dps-group-enrollment"></a>Создание регистрации группы DPS

Используйте созданные сертификаты и ключи для создания группы регистрации в DPS для нескольких устройств IoT Edge. Регистрация групп ы использования промежуточного или корневого сертификата CA из цепочки доверительных сертификатов, используемой для создания индивидуальных идентификационных сертификатов устройства.

Если вместо этого вы хотите предоставить одно устройство IoT Edge, выполните последующие действия в предыдущем разделе, [создайте индивидуальную регистрацию DPS.](#create-a-dps-individual-enrollment)

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md).

### <a name="verify-your-root-certificate"></a>Проверить свой корневой сертификат

При создании группы регистрации у вас есть возможность использовать проверенный сертификат. Вы можете подтвердить сертификат с DPS, доказав, что у вас есть право собственности на корневой сертификат. Для получения дополнительной информации [см.](../iot-dps/how-to-verify-certificates.md)

1. На [портале Azure](https://portal.azure.com)перейдите к экземпляру службы обеспечения устройств IoT Hub.

1. Выберите **Сертификаты** из меню левой руки.

1. Выберите **Добавить,** чтобы добавить новый сертификат.

1. Введите дружественное имя для сертификата, а затем просмотрите файл .cer или .pem, представляющий общедоступную часть сертификата X.509.

   Если вы используете демо-сертификаты, загрузите `<wrkdir>/certs/azure-iot-test-only.root.ca.cert.pem` сертификат.

1. Щелкните **Сохранить**.

1. Теперь ваш сертификат должен быть указан на странице **Сертификатов.** Выберите его, чтобы открыть данные сертификата.

1. Выберите **код проверки generate,** а затем скопируйте сгенерированный код.

1. Независимо от того, привезли ли вы свой собственный сертификат CA или использовали демо-сертификаты, вы можете использовать инструмент проверки, предоставленный в репозитории IoT Edge, для проверки подтверждения наличия. Инструмент проверки использует сертификат CA для подписания нового сертификата, который имеет предоставленный код проверки в качестве имени субъекта.

   * Windows:

     ```powershell
     New-CACertsVerificationCert "<verification code>"
     ```

   * Linux:

     ```bash
     ./certGen.sh create_verification_certificate <verification code>
     ```

1. На той же странице с подробными сведениями о сертификате на портале Azure загрузите недавно созданный сертификат проверки.

1. Нажмите кнопку **Проверить**.

### <a name="create-enrollment-group"></a>Создание группы регистрации

Для получения дополнительной информации о регистрации в [How to manage device enrollments](../iot-dps/how-to-manage-enrollments.md)службе обеспечения устройств см.

1. На [портале Azure](https://portal.azure.com)перейдите к экземпляру службы обеспечения устройств IoT Hub.

1. В разделе **Параметры**выберите **Управление регистрациями**.

1. Выберите **группу регистрации Добавить** затем выполнить следующие шаги, чтобы настроить регистрацию:

   * **Название группы**: Предоставьте памятное имя для регистрации этой группы.

   * **Тип аттестации**: Выберите **сертификат**.

   * **Устройство IoT Edge:** Выберите **True**. Для регистрации группы все устройства должны быть устройствами IoT Edge или ни один из них не может быть.

   * **Тип сертификата**: Выберите **сертификат CA,** если у вас есть проверенный сертификат CA, хранящийся в DPS, или **промежуточный сертификат,** если вы хотите загрузить новый файл только для этой регистрации.

   * **Первичный сертификат**: Если вы выбрали сертификат CA в последнем разделе, выберите сертификат из списка выпадающих. Если вы выбрали промежуточный сертификат, загрузите общедоступный файл из сертификата CA в цепочку доверительных коньков, которая использовалась для создания идентификационных сертификатов устройства.

   * **Выберите концентраторы IoT, к которым можно присвоить это устройство:** Выберите связанный концентратор IoT, к которым вы хотите подключить устройство. Вы можете выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   * **Начальное состояние Twin Device:** Добавить значение тегов, которое будет добавлено к близнецу устройства, если вы хотите. Теги можно использовать для целевых групп устройств для автоматического развертывания. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

1. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, время выполнения IoT Edge может автоматически предоставлять устройство во время установки. Перейти к следующему разделу, чтобы настроить устройство IoT Edge.

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе.

X.509 подготовка с DPS поддерживается только в версии IoT Edge 1.0.9 или более новой.

При подготовке устройства вам понадобится следующая информация:

* Значение **DPS ID Scope.** Это значение можно получить со страницы обзора экземпляра DPS на портале Azure.
* Файл удостоверения личности устройства на устройстве.
* Файл ключа идентификации устройства на устройстве.
* Дополнительный идентификатор регистрации (вытягиванный из общего имени в свидетельстве об идентификации устройства, если он не поставляется).

### <a name="linux-device"></a>Linux устройство

Используйте следующую ссылку для установки времени выполнения Azure IoT Edge на устройство, используя команды, подходящие для архитектуры устройства. Когда вы доберетесь до раздела о настройке демонстративного устройства безопасности, назначайте время выполнения IoT Edge для автоматического, а не ручного, подготовки. Вы должны иметь всю необходимую информацию и файлы сертификатов после завершения предыдущих разделов этой статьи.

[Установка времени выполнения Azure IoT Edge на Linux](how-to-install-iot-edge-linux.md)

При добавлении сертификата X.509 и ключевой информации в файл config.yaml пути должны предоставляться в виде УРИ файлов. Пример:

* `file:///<path>/identity_certificate.pem`
* `file:///<path>/identity_key.pem`

Раздел в файле конфигурации для автоматического прогона X.509 выглядит следующим образом:

```yaml
# DPS X.509 provisioning configuration
provisioning:
  source: "dps"
  global_endpoint: "https://global.azure-devices-provisioning.net"
  scope_id: "<SCOPE_ID>"
  attestation:
    method: "x509"
#   registration_id: "<OPTIONAL REGISTRATION ID. LEAVE COMMENTED OUT TO REGISTER WITH CN OF identity_cert>"
    identity_cert: "<REQUIRED URI TO DEVICE IDENTITY CERTIFICATE>"
    identity_pk: "<REQUIRED URI TO DEVICE IDENTITY PRIVATE KEY>"
```

Замените значения заполнителя `identity_pk` для, `scope_id` `identity_cert`с идентификатором области от вашего экземпляра DPS, и URIs к cert и положениям архива ключа на вашем приборе. Предоставьте `registration_id` устройство, если вы хотите, или оставить эту строку прокомментировал зарегистрировать устройство с cn имя сертификата идентификации.

Всегда перезапустите daemon безопасности после обновления файла config.yaml.

```bash
sudo systemctl restart iotedge
```

### <a name="windows-device"></a>устройство с Windows;

Установите время выполнения IoT Edge на устройстве, для которого вы создали сертификат идентификации и ключ идентификации. Вы наверстируете время выполнения IoT Edge для автоматической, а не ручной подготовки.

Для получения более подробной информации об установке IoT Edge на Windows, включая предпосылки и инструкции для таких задач, как управление контейнерами и обновление IoT Edge, [см.](how-to-install-iot-edge-windows.md)

1. Откройте окно PowerShell с правами администратора. Не забудьте использовать amD64 сессии PowerShell при установке IoT Edge, а не PowerShell (x86).

1. Команда **Deploy-IoTEdge** проверяет, что ваша машина Windows находится на поддерживаемой версии, включает функцию контейнеров, а затем загружает время выполнения moby и время выполнения IoT Edge. Команда по умолчанию использует контейнеры Windows.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Deploy-IoTEdge
   ```

1. На этом этапе устройства IoT Core могут перезапускаться автоматически. Другие устройства Windows 10 или Windows Server могут побудить вас к перезагрузке. Если да, то перезапустите устройство сейчас. Как только устройство будет готово, снова запустите PowerShell в качестве администратора.

1. Команда **Initialize-IoTEdge** настраивает среду выполнения IoT Edge на вашем компьютере. Команда по умолчанию выполняет сяочку в ручной подготовке, если только вы не используете `-Dps` флаг для автоматического обеспечения.

   Замените значения заполнителя для, `{scope_id}` `{identity cert path}`и `{identity key path}` с соответствующими значениями от вашего экземпляра DPS и путей архива на вашем приборе. Если вы хотите указать идентификатор регистрации, также включите, `-RegistrationId {registration_id}` заменив заполнителя по мере необходимости.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Initialize-IoTEdge -Dps -ScopeId {scope ID} -X509IdentityCertificate {identity cert path} -X509IdentityPrivateKey {identity key path}
   ```

   >[!TIP]
   >Файл config.yaml хранит ваш сертификат и ключевую информацию в виде УРИ файлов. Тем не менее, команда Initialize-IoTEdge обрабатывает этот шаг форматирования для вас, так что вы можете предоставить абсолютный путь к сертификату и ключевым файлам на устройстве.

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена успешно, можете перейти в Центр Интернета вещей и начать развертывание модулей IoT Edge на устройстве.

Вы можете проверить, использовалась ли была созданная вами индивидуальная регистрация в службе обеспечения устройств. Перейдите на экземпляр службы обеспечения устройств на портале Azure. Откройте сведения о регистрации для созданной вами индивидуальной регистрации. Обратите внимание, что статус регистрации **присваивается** и миноноситы мною устройства.

Чтобы убедиться, что среда выполнения установлена и запущена успешно, используйте следующие команды на устройстве:

### <a name="linux-device"></a>Linux устройство

Проверьте состояние службы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Изучите журналы служб.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

### <a name="windows-device"></a>устройство с Windows;

Проверьте состояние службы IoT Edge.

```powershell
Get-Service iotedge
```

Изучите журналы служб.

```powershell
. {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
```

Просмотрите список запущенных модулей.

```powershell
iotedge list
```

## <a name="next-steps"></a>Следующие шаги

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. Узнайте, как [развертывать и контролировать модули IoT Edge в масштабе с помощью портала Azure](how-to-deploy-monitor.md) или [с помощью Azure CLI.](how-to-deploy-monitor-cli.md)
