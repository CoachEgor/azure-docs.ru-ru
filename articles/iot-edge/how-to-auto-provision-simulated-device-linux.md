---
title: Обеспечение устройства с виртуальным TPM на Linux VM - Azure IoT Edge
description: Использование имитированного доверенного платформенного модуля на виртуальной машине Linux для тестирования службы подготовки устройств для Azure IoT Edge
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 03/01/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 6bb1282212ccff45f179b8750e3ed8aec27d129e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76511065"
---
# <a name="create-and-provision-an-iot-edge-device-with-a-virtual-tpm-on-a-linux-virtual-machine"></a>Создание и предоставление устройства IoT Edge с виртуальным TPM на виртуальной машине Linux

Устройства Azure IoT Edge могут быть автоматически подготовлены с помощью [службы обеспечения устройств.](../iot-dps/index.yml) При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить.

В этой статье показано, как тестировать автоматическое обеспечение на смоделированном устройстве IoT Edge со следующими шагами:

* Создание виртуальной машины Linux в Hyper-V с имитированным доверенным платформенным модулем (TPM) для обеспечения безопасности оборудования.
* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание отдельной регистрации устройства
* Установка среды выполнения IoT Edge и подключение устройства к Центру Интернета вещей

> [!TIP]
> В этой статье описывается, как протестировать подготовку DPS с помощью тренажера TPM, но большая часть его относится к физическим оборудованиям TPM, таким как [Infineon&trade; OPTIGA TPM](https://catalog.azureiotsolutions.com/details?title=OPTIGA-TPM-SLB-9670-Iridium-Board), Azure Certified для устройства IoT.
>
> Если вы используете физическое устройство, вы можете перейти вперед к [получению информации о получении из раздела физического устройства](#retrieve-provisioning-information-from-a-physical-device) в этой статье.

## <a name="prerequisites"></a>Предварительные требования

* Компьютер для разработки с ОС Windows с [включенным Hyper-V](https://docs.microsoft.com/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v). В этой статье используется виртуальная машина Ubuntu Server, запущенная в Windows 10.
* Действующий Центр Интернета вещей.
* При использовании смоделированного TPM, [Visual Studio](https://visualstudio.microsoft.com/vs/) 2015 или позже с включенной рабочей нагрузкой ['Desktop с включенной](https://www.visualstudio.com/vs/support/selecting-workloads-visual-studio-2017/) рабочей нагрузкой.

> [!NOTE]
> TPM 2.0 требуется при использовании TPM-аттестации с Помощью DPS и может использоваться только для создания индивидуальных, а не групповых регистраций.

## <a name="create-a-linux-virtual-machine-with-a-virtual-tpm"></a>Создание виртуальной машины Linux с помощью виртуального доверенного платформенного модуля (TPM)

В этом разделе вы создаете новую виртуальную машину Linux на Hyper-V. Вы настроили эту виртуальную машину с смоделированным TPM, чтобы вы могли использовать ее для тестирования того, как автоматическая подготовка работает с IoT Edge.

### <a name="create-a-virtual-switch"></a>Создание виртуального коммутатора

Виртуальный коммутатор позволяет виртуальной машине подключаться к физической сети.

1. Откройте Hyper-V Manager на вашем компьютере Windows.

2. В меню **Действия** выберите **Диспетчер виртуальных коммутаторов**.

3. Выберите **Внешний** виртуальный коммутатор, а затем выберите **Создать виртуальный коммутатор**.

4. Назовите новый виртуальный коммутатор, например **EdgeSwitch**. Убедитесь, что выбранный тип соединения имеет значение **Внешняя сеть**, а затем выберите **OK**.

5. Всплывающее окно предупредит, что сетевое подключение может быть разорвано. Чтобы продолжить, нажмите кнопку **Да**.

В случае возникновения ошибок при создании нового виртуального коммутатора, убедитесь, что другие коммутаторы не используют адаптер Ethernet и что для других коммутаторов не используется то же самое имя.

### <a name="create-virtual-machine"></a>Создание виртуальной машины

1. Скачайте и сохраните локально файл образа диска для виртуальной машины. Например, [Ubuntu server](https://www.ubuntu.com/download/server).

2. В Hyper-V Manager снова выберите **новую** > **виртуальную машину** в меню **Действий.**

3. В ходе работы **Мастера создания виртуальной машины** укажите следующие настройки.

   1. **Укажите поколение**. Выберите **Generation 2**. Поколение 2 виртуальные машины вложенных виртуализации включен, который требуется для запуска IoT Edge на виртуальной машине.
   2. **Настройка сети**. В параметре **Подключение** укажите виртуальный коммутатор, созданный в предыдущем разделе.
   3. **Варианты установки**. Выберите **Установить операционную систему из файла загрузочного образа** и укажите путь к сохраненному файлу образа диска.

4. Выберите **Закончить** в мастере, чтобы создать виртуальную машину.

Создание виртуальной машины может занять несколько минут.

### <a name="enable-virtual-tpm"></a>Включение виртуального доверенного платформенного модуля

Как только ваш VM создан, откройте его настройки, чтобы включить виртуальный модуль доверенной платформы (TPM), который позволяет автоматически предоставлять устройство.

1. Выберите виртуальную машину, а затем откройте ее **настройки.**

2. Перейдите в раздел **Безопасность**.

3. Снимите флажок **Включить безопасную загрузку**.

4. Поставьте флажок **Включить доверенный платформенный модуль**.

5. Нажмите кнопку **ОК**.  

### <a name="start-the-virtual-machine-and-collect-tpm-data"></a>Запуск виртуальной машины и сбор данных доверенного платформенного модуля

В виртуальной машине создайте инструмент, который можно использовать для получения **идентификатора регистрации** устройства и **ключа одобрения.**

1. Запустите виртуальную машину и подключитесь к ней.

1. Следуйте подсказкам в виртуальной машине, чтобы закончить процесс установки и перезагрузить машину.

1. Войдите в систему на VM, а затем выполните последующие шаги в [настройке среды разработки Linux](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md#linux) для установки и создания устройства SDK Azure IoT для C.

   >[!TIP]
   >В ходе этой статьи вы будете копировать и вставить из виртуальной машины, что не легко через приложение подключения Hyper-V Manager. Вы можете подключиться к виртуальной машине через Hyper-V Manager `ifconfig`один раз, чтобы получить свой IP-адрес: . Затем можно использовать IP-адрес для подключения `ssh <username>@<ipaddress>`через SSH: .

1. Выполнить следующие команды для создания инструмента SDK, который получает информацию о устройстве, подготавливая информацию из симулятора TPM.

   ```bash
   cd azure-iot-sdk-c/cmake
   cmake -Duse_prov_client:BOOL=ON -Duse_tpm_simulator:BOOL=ON ..
   cd provisioning_client/tools/tpm_device_provision
   make
   sudo ./tpm_device_provision
   ```

1. Из окна команды перейдите `azure-iot-sdk-c` в каталог и запустите тренажер TPM. Он ожидает передачи данных через сокет на портах 2321 и 2322. Не закрывайте окно команды; Вам нужно будет держать этот симулятор работает.

   Из `azure-iot-sdk-c` каталога запустите следующую команду для запуска симулятора:

   ```bash
   ./provisioning_client/deps/utpm/tools/tpm_simulator/Simulator.exe
   ```

1. С помощью Visual Studio откройте решение, генерируемое `cmake` в каталоге с именем, `azure_iot_sdks.sln`и создайте его с помощью команды решения **Build** в меню **сборки.**

1. На панели **обозревателя решений** в Visual Studio перейдите в папку **Provision\_Tools**. Щелкните проект **tpm_device_provision** правой кнопкой мыши и выберите параметр **Назначить запускаемым проектом**.

1. Запустите решение, используя одну из команд **«Пуск»** в меню **Debug.** Выходное окно отображает **идентификатор регистрации** тренажера TPM и **ключ одобрения,** который вы должны скопировать для использования позже, когда вы создаете индивидуальную регистрацию для вашего устройства в Вы можете закрыть это окно (с регистрацией ID и ключом одобрения), но оставить окно симулятора TPM работает.

## <a name="retrieve-provisioning-information-from-a-physical-device"></a>Извлечение информации о подготовке с физического устройства

На устройстве создайте инструмент, который можно использовать для получения информации о подготовке устройства.

1. Выполните последующие действия в [настройке среды разработки Linux](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md#linux) для установки и создания устройства SDK Azure IoT для C.

1. Запустите следующие команды для создания инструмента SDK, который получает информацию о предоставлении устройства с устройства TPM.

   ```bash
   cd azure-iot-sdk-c/cmake
   cmake -Duse_prov_client:BOOL=ON ..
   cd provisioning_client/tools/tpm_device_provision
   make
   sudo ./tpm_device_provision
   ```

1. Копирование значений для **id registration** ID и **ключа одобрения.** Эти значения могут быть использованы при создании отдельной регистрации устройства в Службы подготовки устройств к добавлению в Центр Интернета вещей.

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Получите сведения о подготовке из вашей виртуальной машины и используйте их, чтобы создать отдельную регистрацию в Службе подготовки устройств к добавлению в Центр Интернета вещей.

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md).

1. На [портале Azure](https://portal.azure.com)перейдите к экземпляру службы обеспечения устройств IoT Hub.

2. В разделе **Параметры**выберите **Управление регистрациями**.

3. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для параметра **Механизм** выберите **TPM**.

   2. Предоставьте **ключ одобрения** и **идентификатор регистрации,** который вы скопировали с вашей виртуальной машины.

      > [!TIP]
      > Если вы используете физическое устройство TPM, вам необходимо определить **ключ одобрения,** который является уникальным для каждого чипа TPM и получен от производителя чипов TPM, связанного с ним. Вы можете получить уникальный **идентификатор регистрации** для вашего устройства TPM, например, создав хэш SHA-256 ключа одобрения.

   3. Выберите **True,** чтобы заявить, что эта виртуальная машина является устройством IoT Edge.

   4. Выберите связанный **Центр Интернета вещей**, к которому планируется подключение устройства. Вы можете выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   5. Если необходимо, укажите идентификатор устройства. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если вы не предоставили идентификатор устройства, используется идентификатор регистрации.

   6. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

   7. Нажмите кнопку **Сохранить**.

Теперь, когда для этого устройства существует регистрация, время выполнения IoT Edge может автоматически предоставлять устройство во время установки.

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе. Установите среду выполнения IoT Edge на вашей виртуальной машине.

Узнайте **область идентификатора** Службы подготовки устройств к добавлению в Центр Интернета вещей и **идентификатор регистрации** устройства, прежде чем переходить к статье, соответствующей типу вашего устройства. Если был установлен приведенный в примере Ubuntu server, то используйте инструкции **x64**. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную.

[Установка времени выполнения Azure IoT Edge на Linux](how-to-install-iot-edge-linux.md)

## <a name="give-iot-edge-access-to-the-tpm"></a>Предоставление доступа IoT Edge доверенному платформенному модулю

Для проведения автоматической подготовки устройства среда выполнения IoT Edge должна иметь доступ к доверенному платформенному модулю.

Это можно сделать, переопределив параметры systemd, чтобы назначить службе **iotedge** привилегии суперпользователя. Если вы не хотите повышать привилегии, доступ можно предоставить вручную.

1. Найдите путь к аппаратному модулю доверенного платформенного модуля на устройстве и сохраните его в качестве локальной переменной.

   ```bash
   tpm=$(sudo find /sys -name dev -print | fgrep tpm | sed 's/.\{4\}$//')
   ```

2. Создайте новое правило, которое предоставит среде выполнения IoT Edge доступ к tpm0.

   ```bash
   sudo touch /etc/udev/rules.d/tpmaccess.rules
   ```

3. Откройте файл правил.

   ```bash
   sudo nano /etc/udev/rules.d/tpmaccess.rules
   ```

4. Скопируйте следующие сведения о доступе в файл правил.

   ```input
   # allow iotedge access to tpm0
   KERNEL=="tpm0", SUBSYSTEM=="tpm", GROUP="iotedge", MODE="0660"
   ```

5. Сохраните и закройте файл.

6. Запустите систему udev, чтобы оценить новое правило.

   ```bash
   /bin/udevadm trigger $tpm
   ```

7. Убедитесь, что правило было успешно применено.

   ```bash
   ls -l /dev/tpm0
   ```

   В случае успешного применения правила данные вывода выглядят следующим образом.

   ```output
   crw-rw---- 1 root iotedge 10, 224 Jul 20 16:27 /dev/tpm0
   ```

   В противном случае попробуйте перезагрузить компьютер, чтобы обновить Udev.

## <a name="restart-the-iot-edge-runtime"></a>Перезапуск среды выполнения IoT Edge

Перезапустите среду выполнения IoT Edge, чтобы активировать все изменения конфигурации, внесенные на устройстве.

   ```bash
   sudo systemctl restart iotedge
   ```

Убедитесь, что среда выполнения IoT Edge запущена.

   ```bash
   sudo systemctl status iotedge
   ```

Возникновение ошибки подготовки может означать, что изменения конфигурации еще не вступили в силу. Попробуйте перезапустить управляющую программу IoT Edge.

   ```bash
   sudo systemctl daemon-reload
   ```

Или попробуйте перезапустить виртуальную машину, чтобы проверить, вступят ли изменения в силу при новом запуске.

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена, перейдите в Центр Интернета вещей и проверьте, что новое устройство автоматически подготовлено и готово для запуска модулей IoT Edge.

Проверьте состояние управляющей программы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Изучите журналы управляющей программы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

Вы можете проверить, использовалась ли была созданная вами индивидуальная регистрация в службе обеспечения устройств. Перейдите на экземпляр службы обеспечения устройств на портале Azure. Откройте сведения о регистрации для созданной вами индивидуальной регистрации. Обратите внимание, что статус регистрации **присваивается** и миноноситы мною устройства.

## <a name="next-steps"></a>Дальнейшие действия

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. Узнайте, как [развертывать и контролировать модули IoT Edge в масштабе с помощью портала Azure](how-to-deploy-monitor.md) или [с помощью Azure CLI.](how-to-deploy-monitor-cli.md)
