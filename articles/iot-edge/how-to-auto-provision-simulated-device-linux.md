---
title: Автоматическая подготавливает устройства Linux с помощью DPS-Azure IoT Edge | Документация Майкрософт
description: Использование имитированного доверенного платформенного модуля на виртуальной машине Linux для тестирования службы подготовки устройств для Azure IoT Edge
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 03/01/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 1a13c130c45c746a42c0acf1ec2646f3c8f9bc51
ms.sourcegitcommit: 920ad23613a9504212aac2bfbd24a7c3de15d549
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/15/2019
ms.locfileid: "68227531"
---
# <a name="create-and-provision-an-iot-edge-device-with-a-virtual-tpm-on-a-linux-virtual-machine"></a>Создание и инициализация устройства IoT Edge с помощью виртуального доверенного платформенного модуля на виртуальной машине Linux

Azure IoT Edge устройства можно автоматически подготовить с помощью [службы подготовки устройств](../iot-dps/index.yml). При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить. 

В этой статье показано, как протестировать автоинициализацию на имитации устройства IoT Edge, выполнив следующие действия. 

* Создание виртуальной машины Linux в Hyper-V с имитированным доверенным платформенным модулем (TPM) для обеспечения безопасности оборудования.
* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание отдельной регистрации устройства
* Установка среды выполнения IoT Edge и подключение устройства к Центру Интернета вещей

Действия, описанные в этой статье, предназначены для целей тестирования.

## <a name="prerequisites"></a>предварительные требования

* Компьютер для разработки с ОС Windows с [включенным Hyper-V](https://docs.microsoft.com/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v). В этой статье используется виртуальная машина Ubuntu Server, запущенная в Windows 10. 
* Действующий Центр Интернета вещей. 

## <a name="create-a-linux-virtual-machine-with-a-virtual-tpm"></a>Создание виртуальной машины Linux с помощью виртуального доверенного платформенного модуля (TPM)

В этом разделе вы создадите новую виртуальную машину Linux в Hyper-V. Вы настроили эту виртуальную машину с помощью имитации доверенного платформенного модуля, чтобы вы могли использовать его для тестирования работы автоматической подготовки с IoT Edge. 

### <a name="create-a-virtual-switch"></a>Создание виртуального коммутатора

Виртуальный коммутатор позволяет виртуальной машине подключаться к физической сети.

1. Откройте диспетчер Hyper-V на компьютере Windows. 

2. В меню **Действия** выберите **Диспетчер виртуальных коммутаторов**. 

3. Выберите **Внешний** виртуальный коммутатор, а затем выберите **Создать виртуальный коммутатор**. 

4. Назовите новый виртуальный коммутатор, например **EdgeSwitch**. Убедитесь, что выбранный тип соединения имеет значение **Внешняя сеть**, а затем выберите **OK**.

5. Всплывающее окно предупредит, что сетевое подключение может быть разорвано. Чтобы продолжить, нажмите кнопку **Да**. 

В случае возникновения ошибок при создании нового виртуального коммутатора, убедитесь, что другие коммутаторы не используют адаптер Ethernet и что для других коммутаторов не используется то же самое имя. 

### <a name="create-virtual-machine"></a>Создание виртуальной машины

1. Скачайте и сохраните локально файл образа диска для виртуальной машины. Например, [Ubuntu server](https://www.ubuntu.com/download/server). 

2. В диспетчере Hyper-V в меню **действия** выберите пункт **создать** > **виртуальную машину** .

3. В ходе работы **Мастера создания виртуальной машины** укажите следующие настройки.

   1. **Укажите поколение**. Выберите **Поколение 2**. На виртуальных машинах поколения 2 включена вложенная виртуализация, необходимая для запуска IoT Edge на виртуальной машине.
   2. **Настройка сети**. В параметре **Подключение** укажите виртуальный коммутатор, созданный в предыдущем разделе. 
   3. **Варианты установки**. Выберите **Установить операционную систему из файла загрузочного образа** и укажите путь к сохраненному файлу образа диска.

4. Нажмите кнопку **Готово** в мастере, чтобы создать виртуальную машину.

Создание виртуальной машины может занять несколько минут. 

### <a name="enable-virtual-tpm"></a>Включение виртуального доверенного платформенного модуля

После создания виртуальной машины откройте ее параметры, чтобы включить модуль виртуальной доверенной платформы (TPM), позволяющий выполнить автоинициализацию устройства. 

1. Выберите виртуальную машину, а затем откройте ее **Параметры**.

2. Перейдите в раздел **Безопасность**. 

3. Снимите флажок **Включить безопасную загрузку**.

4. Поставьте флажок **Включить доверенный платформенный модуль**. 

5. Нажмите кнопку **ОК**.  

### <a name="start-the-virtual-machine-and-collect-tpm-data"></a>Запуск виртуальной машины и сбор данных доверенного платформенного модуля

На виртуальной машине создайте инструмент пакета SDK для C, который может извлечь **Идентификатор регистрации** и **Ключ подтверждения** устройства. 

1. Запустите виртуальную машину и подключитесь к ней.

2. Следуйте инструкциям в этой виртуальной машине, чтобы завершить процесс установки и перезагрузить компьютер. 

3. Войдите на виртуальную машину, а затем выполните действия, описанные в разделе [Настройка среды разработки Linux](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md#linux) для установки и сборки пакета SDK для устройств Azure IOT для C. 

   >[!TIP]
   >В рамках этой статьи вы научитесь копировать и вставлять их с виртуальной машины, что непросто в приложении подключения диспетчера Hyper-V. Чтобы получить IP-адрес, вам может потребоваться подключиться к виртуальной машине через диспетчер Hyper-V: `ifconfig`. Затем можно использовать IP-адрес для подключения через SSH: `ssh <username>@<ipaddress>`.

4. Выполните следующие команды для создания инструмента пакета SDK для C, извлекающего сведения о подготовке устройства. 

   ```bash
   cd azure-iot-sdk-c/cmake
   cmake -Duse_prov_client:BOOL=ON ..
   cd provisioning_client/tools/tpm_device_provision
   make
   sudo ./tpm_device_provision
   ```
   >[!TIP]
   >При тестировании с помощью симулятора TPM необходимо добавить дополнительный параметр `-Duse_tpm_simulator:BOOL=ON` , чтобы включить его. Полная команда будет иметь `cmake -Duse_prov_client:BOOL=ON -Duse_tpm_simulator:BOOL=ON ..`значение.

5. Скопируйте значения параметров **Идентификатор регистрации** и **Ключ подтверждения**. Эти значения могут быть использованы при создании отдельной регистрации устройства в Службы подготовки устройств к добавлению в Центр Интернета вещей. 

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge. 

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Получите сведения о подготовке из вашей виртуальной машины и используйте их, чтобы создать отдельную регистрацию в Службе подготовки устройств к добавлению в Центр Интернета вещей. 

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md). 

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей. 

2. В разделе **Параметры**выберите **Управление регистрациями**. 

3. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для параметра **Механизм** выберите **TPM**. 
   
   2. Укажите **ключ подтверждения** и **идентификатор регистрации** , которые вы скопировали с виртуальной машины.
   
   3. Выберите **значение true** , чтобы объявить, что эта виртуальная машина является IOT Edge устройством. 
   
   4. Выберите связанный **Центр Интернета вещей**, к которому планируется подключение устройства. Можно выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения. 
   
   5. Если необходимо, укажите идентификатор устройства. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если не указать идентификатор устройства, используется идентификатор регистрации.
   
   6. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. Пример: 

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

   7. Щелкните **Сохранить**. 

Теперь, когда для этого устройства существует регистрация, среда выполнения IoT Edge может автоматически подготавливать устройство во время установки. 

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе. Установите среду выполнения IoT Edge на вашей виртуальной машине. 

Узнайте **область идентификатора** Службы подготовки устройств к добавлению в Центр Интернета вещей и **идентификатор регистрации** устройства, прежде чем переходить к статье, соответствующей типу вашего устройства. Если был установлен приведенный в примере Ubuntu server, то используйте инструкции **x64**. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную. 

* [Установка среды выполнения Azure IoT Edge в Linux (x64)](how-to-install-iot-edge-linux.md)
* [Установка среды выполнения Azure IoT Edge в Linux (ARM32v7/армхф)](how-to-install-iot-edge-linux-arm.md)

## <a name="give-iot-edge-access-to-the-tpm"></a>Предоставление доступа IoT Edge доверенному платформенному модулю

Для проведения автоматической подготовки устройства среда выполнения IoT Edge должна иметь доступ к доверенному платформенному модулю. 

Это можно сделать, переопределив параметры systemd, чтобы назначить службе **iotedge** привилегии суперпользователя. Если вы не хотите повышать привилегии, доступ можно предоставить вручную. 

1. Найдите путь к аппаратному модулю доверенного платформенного модуля на устройстве и сохраните его в качестве локальной переменной. 

   ```bash
   tpm=$(sudo find /sys -name dev -print | fgrep tpm | sed 's/.\{4\}$//')
   ```

2. Создайте новое правило, которое предоставит среде выполнения IoT Edge доступ к tpm0. 

   ```bash
   sudo touch /etc/udev/rules.d/tpmaccess.rules
   ```

3. Откройте файл правил. 

   ```bash
   sudo nano /etc/udev/rules.d/tpmaccess.rules
   ```

4. Скопируйте следующие сведения о доступе в файл правил. 

   ```input 
   # allow iotedge access to tpm0
   KERNEL=="tpm0", SUBSYSTEM=="tpm", GROUP="iotedge", MODE="0660"
   ```

5. Сохраните и закройте файл. 

6. Запустите систему udev, чтобы оценить новое правило. 

   ```bash
   /bin/udevadm trigger $tpm
   ```

7. Убедитесь, что правило было успешно применено.

   ```bash
   ls -l /dev/tpm0
   ```

   В случае успешного применения правила данные вывода выглядят следующим образом.

   ```output
   crw-rw---- 1 root iotedge 10, 224 Jul 20 16:27 /dev/tpm0
   ```

   В противном случае попробуйте перезагрузить компьютер, чтобы обновить Udev. 

8. Откройте файл переопределений среды выполнения IoT Edge. 

   ```bash
   sudo systemctl edit iotedge.service
   ```

9. Добавьте следующий код, чтобы создать переменную среды доверенного платформенного модуля.

   ```input
   [Service]
   Environment=IOTEDGE_USE_TPM_DEVICE=ON
   ```

10. Сохраните и закройте файл.

11. Убедитесь, что переопределение прошло успешно.

    ```bash
    sudo systemctl cat iotedge.service
    ```

    Успешный вывод отобразит переменные службы **iotege** по умолчанию, а затем отобразит переменную среды, которую вы установили в **override.conf**. 

12. Перезагрузите параметры.

    ```bash
    sudo systemctl daemon-reload
    ```

## <a name="restart-the-iot-edge-runtime"></a>Перезапуск среды выполнения IoT Edge

Перезапустите среду выполнения IoT Edge, чтобы активировать все изменения конфигурации, внесенные на устройстве. 

   ```bash
   sudo systemctl restart iotedge
   ```

Убедитесь, что среда выполнения IoT Edge запущена. 

   ```bash
   sudo systemctl status iotedge
   ```

Возникновение ошибки подготовки может означать, что изменения конфигурации еще не вступили в силу. Попробуйте перезапустить управляющую программу IoT Edge. 

   ```bash
   sudo systemctl daemon-reload
   ```
   
Или попробуйте перезапустить виртуальную машину, чтобы проверить, вступят ли изменения в силу при новом запуске. 

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена, перейдите в Центр Интернета вещей и проверьте, что новое устройство автоматически подготовлено и готово для запуска модулей IoT Edge. 

Проверьте состояние управляющей программы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Изучите журналы управляющей программы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

Вы можете проверить, была ли использована отдельная регистрация, созданная в службе подготовки устройств. Перейдите к экземпляру службы подготовки устройств в портал Azure. Откройте сведения о регистрации для созданной индивидуальной регистрации. Обратите внимание, что для регистрации назначено  состояние и указан идентификатор устройства. 

## <a name="next-steps"></a>Следующие шаги

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. См. дополнительные сведения о развертывании и мониторинге модулей IoT Edge с поддержкой масштабирования с помощью [портала Azure](how-to-deploy-monitor.md) или [Azure CLI](how-to-deploy-monitor-cli.md).
