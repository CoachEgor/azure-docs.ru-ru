---
title: Обеспечение устройства с использованием симметричного key attestation - Azure IoT Edge
description: Используйте симметричное подтверждение ключа для тестирования автоматического устройства подготовки к Azure IoT Edge с службой обеспечения устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.reviewer: mrohera
ms.date: 10/04/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: d9944308d00c9cfecbd38a6443efb49913148806
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79535924"
---
# <a name="create-and-provision-an-iot-edge-device-using-symmetric-key-attestation"></a>Создание и предоставление устройства IoT Edge с использованием симметричного аттестации ключей

Устройства Azure IoT Edge можно подготовить автоматически с помощью [Службы подготовки устройств к добавлению в Центр Интернета вещей](../iot-dps/index.yml) точно так же, как и другие устройства. При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить.

В этой статье показано, как создать индивидуальную регистрацию службы обеспечения устройств с использованием симметричного аттестации ключей на устройстве IoT Edge со следующими шагами:

* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание отдельной регистрации устройства.
* Установите время выполнения IoT Edge и подключитесь к концентратору IoT.

Аттестация симметричных ключей — это простой подход к аутентификации устройства в экземпляре Службы подготовки устройств. Этот метод аттестации представляет возможности программы Hello world для разработчиков, которые не имеют опыта подготовки устройств или строгих требований к безопасности. Свидетельство устройства с помощью сертификатов [TPM](../iot-dps/concepts-tpm-attestation.md) или [X.509](../iot-dps/concepts-security.md#x509-certificates) является более безопасным и должно использоваться для более строгих требований безопасности.

## <a name="prerequisites"></a>Предварительные требования

* Активный концентратор IoT
* Физическое или виртуальное устройство

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="choose-a-unique-registration-id-for-the-device"></a>Выбор уникального идентификатора регистрации для устройства

Уникальный идентификатор регистрации должен быть определен для идентификации каждого устройства. Можно использовать MAC-адрес, серийный номер или любые уникальные сведения устройства.

В этом примере мы используем комбинацию адреса MAC и серийного номера, образующего следующую строку для идентификатора регистрации: `sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6`.

Создайте уникальный идентификатор регистрации для устройства. Допустимые знаки — буквы в нижнем регистре, цифры и дефис ("-").

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Используйте идентификатор регистрации устройства для создания индивидуальной регистрации в DPS.

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md).

> [!TIP]
> Регистрация групп также возможна при использовании симметричного key attestation и включает в себя те же решения, что и отдельные регистрации.

1. На [портале Azure](https://portal.azure.com)перейдите к экземпляру службы обеспечения устройств IoT Hub.

1. В разделе **Параметры**выберите **Управление регистрациями**.

1. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для **механизма**, выберите **симметричный ключ**.

   1. Выберите флажок **ключей авто-генера.**

   1. Укажите **идентификатор регистрации,** созданный для устройства.

   1. Предоставьте **идентификатор устройства IoT Hub,** если хотите. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если вы не предоставили идентификатор устройства, используется идентификатор регистрации.

   1. Выберите **True,** чтобы объявить, что регистрация предназначена для устройства IoT Edge. Для регистрации группы все устройства должны быть устройствами IoT Edge или ни один из них не может быть.

   1. Примите значение по умолчанию из политики распределения службы обеспечения устройств для **того, как вы хотите назначить устройства концентратам** или выбрать другое значение, специфичное для этой регистрации.

   1. Выберите связанный **Центр Интернета вещей**, к которому планируется подключение устройства. Вы можете выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   1. **Выберите, как вы хотите, чтобы данные об устройстве обрабатывались при повторном предоставлении,** когда устройства запрашивают подготовку после первого раза.

   1. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

   1. Убедитесь, что **вход в включить** установлен для **включения**.

   1. Нажмите кнопку **Сохранить**.

Теперь, когда для этого устройства существует регистрация, время выполнения IoT Edge может автоматически предоставлять устройство во время установки. Обязательно скопируйте значение **основного ключа** регистрации для использования при установке времени выполнения IoT Edge или если вы собираетесь создавать ключи устройства для использования с группой регистрации.

## <a name="derive-a-device-key"></a>Получение ключа устройства

> [!NOTE]
> Этот раздел требуется только при использовании группы регистрации.

Каждое устройство использует свой производный ключ устройства с вашим уникальным идентификатором регистрации для выполнения симметричного удостоверения ключа с регистрацией во время подготовки. Для создания ключа устройства используйте скопированный ключ с момента регистрации DPS для вычисления Уникального идентификатора [регистрации HMAC-SHA256](https://wikipedia.org/wiki/HMAC) для устройства и преобразования результата в формат Base64.

Не включайте основной или вторичный ключ регистрации в код устройства.

### <a name="linux-workstations"></a>Рабочие станции Linux

Если вы используете рабочую станцию Linux, можно использовать OpenSSL для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** идентификатором регистрации устройства.

```bash
KEY=8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw==
REG_ID=sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6

keybytes=$(echo $KEY | base64 --decode | xxd -p -u -c 1000)
echo -n $REG_ID | openssl sha256 -mac HMAC -macopt hexkey:$keybytes -binary | base64
```

```bash
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

### <a name="windows-based-workstations"></a>Рабочие станции для Windows

Если вы используете рабочую станцию для Windows, можно использовать PowerShell для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** идентификатором регистрации устройства.

```powershell
$KEY='8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw=='
$REG_ID='sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6'

$hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha256.key = [Convert]::FromBase64String($KEY)
$sig = $hmacsha256.ComputeHash([Text.Encoding]::ASCII.GetBytes($REG_ID))
$derivedkey = [Convert]::ToBase64String($sig)
echo "`n$derivedkey`n"
```

```powershell
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе.

При подготовке устройства вам понадобится следующая информация:

* Значение **dPS ID Scope**
* **Идентификатор регистрации** устройства, созданный
* **Основной ключ,** который вы скопировали из регистрации DPS

> [!TIP]
> Для регистрации группы нужен [ключ](#derive-a-device-key) каждого устройства, а не ключ регистрации DPS.

### <a name="linux-device"></a>Linux устройство

Следуйте инструкциям по архитектуре устройства. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную.

[Установка времени выполнения Azure IoT Edge на Linux](how-to-install-iot-edge-linux.md)

Раздел в файле конфигурации для симметричного обеспечения ключей выглядит следующим образом:

```yaml
# DPS symmetric key provisioning configuration
provisioning:
   source: "dps"
   global_endpoint: "https://global.azure-devices-provisioning.net"
   scope_id: "<SCOPE_ID>"
   attestation:
      method: "symmetric_key"
      registration_id: "<REGISTRATION_ID>"
      symmetric_key: "<SYMMETRIC_KEY>"
```

Замените значения заполнителя для, `<SCOPE_ID>` `<REGISTRATION_ID>`и `<SYMMETRIC_KEY>` с данными, которые вы собрали ранее. Убедитесь, что **подготовка:** линия не имеет предшествующего пробела и что вложенные элементы отступом двумя пробелами.

### <a name="windows-device"></a>устройство с Windows;

Установите время выполнения IoT Edge на устройство, для которого вы создали производный ключ устройства. Вы наверстируете время выполнения IoT Edge для автоматической, а не ручной подготовки.

Для получения более подробной информации об установке IoT Edge на Windows, включая предпосылки и инструкции для таких задач, как управление контейнерами и обновление IoT Edge, [см.](how-to-install-iot-edge-windows.md)

1. Откройте окно PowerShell с правами администратора. Не забудьте использовать amD64 сессии PowerShell при установке IoT Edge, а не PowerShell (x86).

1. Команда **Deploy-IoTEdge** проверяет, что ваша машина Windows находится на поддерживаемой версии, включает функцию контейнеров, а затем загружает время выполнения moby и время выполнения IoT Edge. Команда по умолчанию использует контейнеры Windows.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Deploy-IoTEdge
   ```

1. На этом этапе устройства IoT Core могут перезапускаться автоматически. Другие устройства Windows 10 или Windows Server могут побудить вас к перезагрузке. Если да, то перезапустите устройство сейчас. Как только устройство будет готово, снова запустите PowerShell в качестве администратора.

1. Команда **Initialize-IoTEdge** настраивает среду выполнения IoT Edge на вашем компьютере. Команда по умолчанию выполняет ручную подготовку с `-Dps` контейнерами Windows, если только вы не используете флаг для автоматического обеспечения.

   Замените значения заполнителя для, `{scope_id}` `{registration_id}`и `{symmetric_key}` с данными, которые вы собрали ранее.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Initialize-IoTEdge -Dps -ScopeId {scope ID} -RegistrationId {registration ID} -SymmetricKey {symmetric key}
   ```

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена успешно, можете перейти в Центр Интернета вещей и начать развертывание модулей IoT Edge на устройстве. Чтобы убедиться, что среда выполнения установлена и запущена успешно, используйте следующие команды на устройстве:

### <a name="linux-device"></a>Linux устройство

Проверьте состояние службы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Изучите журналы служб.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

### <a name="windows-device"></a>устройство с Windows;

Проверьте состояние службы IoT Edge.

```powershell
Get-Service iotedge
```

Изучите журналы служб.

```powershell
. {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
```

Просмотрите список запущенных модулей.

```powershell
iotedge list
```

Вы можете проверить, использовалась ли была созданная вами индивидуальная регистрация в службе обеспечения устройств. Перейдите на экземпляр службы обеспечения устройств на портале Azure. Откройте сведения о регистрации для созданной вами индивидуальной регистрации. Обратите внимание, что статус регистрации **присваивается** и миноноситы мною устройства.

## <a name="next-steps"></a>Дальнейшие действия

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. Узнайте, как [развертывать и контролировать модули IoT Edge в масштабе с помощью портала Azure](how-to-deploy-monitor.md) или [с помощью Azure CLI.](how-to-deploy-monitor-cli.md)
