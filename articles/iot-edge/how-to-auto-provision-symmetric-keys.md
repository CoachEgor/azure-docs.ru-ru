---
title: Автоинициализация устройств с помощью DPS с использованием симметричного ключа аттестации — Azure IoT Edge | Документация Майкрософт
description: Использование аттестации симметричных ключей для тестирования автоматической подготовки устройств для Azure IoT Edge с помощью службы подготовки устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.reviewer: mrohera
ms.date: 07/10/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 3c21c0bdce6f6a5cd3c8f634bf400600b30a8ead
ms.sourcegitcommit: c556477e031f8f82022a8638ca2aec32e79f6fd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2019
ms.locfileid: "68414588"
---
# <a name="create-and-provision-an-iot-edge-device-using-symmetric-key-attestation"></a>Создание и инициализация устройства IoT Edge с помощью аттестации симметричных ключей

Устройства Azure IoT Edge можно подготовить автоматически с помощью [Службы подготовки устройств к добавлению в Центр Интернета вещей](../iot-dps/index.yml) точно так же, как и другие устройства. При необходимости ознакомьтесь с [процессом автоматической подготовки](../iot-dps/concepts-auto-provisioning.md), прежде чем продолжить.

В этой статье показано, как создать отдельную регистрацию службы подготовки устройств с помощью аттестации симметричных ключей на IoT Edge устройстве, выполнив следующие действия.

* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание отдельной регистрации устройства.
* Установите среду выполнения IoT Edge и подключитесь к центру Интернета вещей.

Аттестация симметричных ключей — это простой подход к аутентификации устройства в экземпляре Службы подготовки устройств. Этот метод аттестации представляет возможности программы Hello world для разработчиков, которые не имеют опыта подготовки устройств или строгих требований к безопасности. Аттестация устройств с помощью [доверенного платформенного модуля](../iot-dps/concepts-tpm-attestation.md) является более безопасной и должна использоваться для более строгих требований к безопасности.

## <a name="prerequisites"></a>предварительные требования

* Активный центр Интернета вещей
* Физическое или виртуальное устройство

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="choose-a-unique-registration-id-for-the-device"></a>Выбор уникального идентификатора регистрации для устройства

Уникальный идентификатор регистрации должен быть определен для идентификации каждого устройства. Можно использовать MAC-адрес, серийный номер или любые уникальные сведения устройства.

В этом примере мы используем сочетание MAC-адреса и серийного номера, формирующие следующую строку для идентификатора регистрации.

```
sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6
```

Создайте уникальный идентификатор регистрации для устройства. Допустимые знаки — буквы в нижнем регистре, цифры и дефис ("-").

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Используйте идентификатор регистрации устройства для создания отдельной регистрации в DPS.

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-monitor.md).

> [!TIP]
> Групповые регистрации также возможны при использовании аттестации симметричных ключей и принимают те же решения, что и индивидуальные регистрации.

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей.

1. В разделе **Параметры**выберите **Управление регистрациями**.

1. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для параметра **механизм**выберите **симметричный ключ**.

   1. Установите флажок **Автоматическое создание ключей** .

   1. Укажите **идентификатор регистрации** , созданный для устройства.

   1. Укажите **идентификатор устройства центра Интернета вещей** для устройства, если хотите. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если не указать идентификатор устройства, используется идентификатор регистрации.

   1. Выберите **значение true** , чтобы объявить о регистрации для устройства IOT Edge. Для групповой регистрации все устройства должны быть IoT Edge устройствами или ни одно из них не может быть.

   1. Примите значение по умолчанию в политике выделения службы подготовки устройств, **чтобы назначить устройства концентраторам** , или выберите другое значение, относящееся к этой регистрации.

   1. Выберите связанный **Центр Интернета вещей**, к которому планируется подключение устройства. Можно выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   1. Выберите **способ обработки данных устройства при повторной подготовке** , когда устройства запрашивают подготовку через первый раз.

   1. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

   1. Убедитесь, что для **параметра включить запись** задано значение **включено**.

   1. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, среда выполнения IoT Edge может автоматически подготавливать устройство во время установки. Не забудьте скопировать значение **первичного ключа** регистрации, которое будет использоваться при создании ключа устройства.

## <a name="derive-a-device-key"></a>Получение ключа устройства

Устройство использует ключ производного устройства с уникальным ИДЕНТИФИКАТОРом регистрации для выполнения аттестации симметричных ключей с регистрацией во время подготовки. Чтобы создать ключ устройства, используйте ключ, скопированный из регистрации DPS, чтобы вычислить код [HMAC-SHA256](https://wikipedia.org/wiki/HMAC) уникального идентификатора регистрации для устройства и преобразовать результат в формат Base64.

Не включайте первичный или вторичный ключ регистрации в код устройства.

### <a name="linux-workstations"></a>Рабочие станции Linux

Если вы используете рабочую станцию Linux, можно использовать OpenSSL для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** на идентификатор регистрации устройства.

```bash
KEY=8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw==
REG_ID=sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6

keybytes=$(echo $KEY | base64 --decode | xxd -p -u -c 1000)
echo -n $REG_ID | openssl sha256 -mac HMAC -macopt hexkey:$keybytes -binary | base64
```

```bash
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

### <a name="windows-based-workstations"></a>Рабочие станции для Windows

Если вы используете рабочую станцию для Windows, можно использовать PowerShell для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** на идентификатор регистрации устройства.

```powershell
$KEY='8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw=='
$REG_ID='sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6'

$hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha256.key = [Convert]::FromBase64String($KEY)
$sig = $hmacsha256.ComputeHash([Text.Encoding]::ASCII.GetBytes($REG_ID))
$derivedkey = [Convert]::ToBase64String($sig)
echo "`n$derivedkey`n"
```

```powershell
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе.

При подготовке устройства вам потребуются следующие сведения:

* Значение **области идентификаторов** DPS
* Созданный **идентификатор регистрации** устройства
* Производный ключ устройства для аттестации симметричных ключей

### <a name="linux-device"></a>Устройство Linux

Следуйте инструкциям по архитектуре вашего устройства. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную.

[Установка среды выполнения Azure IoT Edge в Linux](how-to-install-iot-edge-linux.md)

Раздел файла конфигурации для подготовки симметричного ключа выглядит следующим образом:

```yaml
# DPS symmetric key provisioning configuration
provisioning:
   source: "dps"
   global_endpoint: "https://global.azure-devices-provisioning.net"
   scope_id: "{scope_id}"
   attestation:
      method: "symmetric_key"
      registration_id: "{registration_id}"
      symmetric_key: "{symmetric_key}"
```

Замените значения заполнителей для `{scope_id}`, `{registration_id}`и `{symmetric_key}` данными, собранными ранее.

### <a name="windows-device"></a>устройство с Windows;

Следуйте инструкциям по установке среды выполнения IoT Edge на устройстве, для которого создан производный ключ устройства. Среда выполнения IoT Edge должна быть настроена на автоматическую подготовку, а не подготовку вручную.

[Установка и автоматическая инициализация IoT Edge в Windows](how-to-install-iot-edge-windows.md#option-2-install-and-automatically-provision)

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена успешно, можете перейти в Центр Интернета вещей и начать развертывание модулей IoT Edge на устройстве. Чтобы убедиться, что среда выполнения установлена и запущена успешно, используйте следующие команды на устройстве:

### <a name="linux-device"></a>Устройство Linux

Проверьте состояние службы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Проверьте журналы службы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

### <a name="windows-device"></a>устройство с Windows;

Проверьте состояние службы IoT Edge.

```powershell
Get-Service iotedge
```

Проверьте журналы службы.

```powershell
. {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
```

Просмотрите список запущенных модулей.

```powershell
iotedge list
```

Вы можете проверить, была ли использована отдельная регистрация, созданная в службе подготовки устройств. Перейдите к экземпляру службы подготовки устройств в портал Azure. Откройте сведения о регистрации для созданной индивидуальной регистрации. Обратите внимание, что для регистрации назначено  состояние и указан идентификатор устройства.

## <a name="next-steps"></a>Следующие шаги

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. См. дополнительные сведения о развертывании и мониторинге модулей IoT Edge с поддержкой масштабирования с помощью [портала Azure](how-to-deploy-monitor.md) или [Azure CLI](how-to-deploy-monitor-cli.md).
