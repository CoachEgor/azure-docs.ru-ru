---
title: Автоматическое развертывание групп устройств —Azure IoT Edge | Документация Майкрософт
description: Автоматическое развертывания в Azure IoT Edge для управления группами устройств на основе общих тегов
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 09/27/2018
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 376ee74732daf526b31129fa8c93cbaa32350eae
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60318212"
---
# <a name="understand-iot-edge-automatic-deployments-for-single-devices-or-at-scale"></a>Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в требуемом масштабе

Устройства Azure IoT имеют [жизненный цикл устройств](../iot-hub/iot-hub-device-management-overview.md), аналогичный другим типам устройств Интернета вещей:

1. Подготовка устройств IoT Edge посредством развертывания образа с операционной системой и установки [среды выполнения IoT Edge](iot-edge-runtime.md).
2. Настройка устройств для выполнения [модулей IoT Edge](iot-edge-modules.md) и последующий мониторинг их работоспособности. 
3. Изъятие устройств из эксплуатации, когда они устареют или будет выполняться замена.  

Azure IoT Edge предоставляет два способа настройки модулей для выполнения на устройствах IoT Edge: один для разработки и быстрых итераций на отдельном устройстве (этот метод вы использовали в [руководствах](tutorial-deploy-function.md) Azure IoT Edge), другой — для управления большим количеством устройств IoT Edge. Оба этих метода можно использовать на портале Azure, а также программным способом. В случае с целевыми группами или большим количеством устройств вы можете указать, на какие устройства следует развернуть модули, используя [теги](../iot-edge/how-to-deploy-monitor.md#identify-devices-using-tags) на двойниках устройств. На следующих этапах рассматривается развертывание на группу устройств штата Вашингтон, определенную через свойство tags. 

В этой статье мы рассмотрим этапы настройки и мониторинга для большого количества устройств, которые совокупно называются автоматическими развертываниями IoT Edge. Ниже приведены общие шаги по развертыванию. 

1. Оператор определяет развертывание, которое описывает набор модулей, а также целевые устройства. Каждое развертывание имеет манифест развертывания, который отражает эти сведения. 
2. Служба Центра Интернета вещей взаимодействует со всеми целевыми устройствами, чтобы настроить их для нужных модулей. 
3. Служба Центра Интернета вещей извлекает сведения о состоянии устройств IoT Edge и предоставляет эти сведения оператору для мониторинга.  Например, оператор может видеть, что настройка пограничного устройства не прошла успешно или во время выполнения произошел сбой модуля. 
4. Новые устройства IoT Edge, соответствующие условиям назначения, в любое время можно настроить для развертывания. Например, развертывание, предназначенное для всех устройств IoT Edge штата Вашингтон, автоматически настраивает новое устройств IoT Edge после того, как оно будет подготовлено и добавлено в группу устройств штата Вашингтон. 
 
В этой статье описывается каждый компонент, связанный с настройкой и мониторингом развертывания. Пошаговое руководство по созданию и обновлению модулей см. в статье [Развертывание и мониторинг большого числа модулей IoT Edge с помощью портала Azure](how-to-deploy-monitor.md).

## <a name="deployment"></a>Развертывание

Автоматическое развертывание IoT Edge назначает образы модуля IoT Edge для выполнения в качестве экземпляров в целевом наборе устройств IoT Edge. Он настраивает манифест развертывания IoT Edge для включения списка модулей с соответствующими параметрами инициализации. Развертывание можно назначить одному устройству (на основе идентификатора устройства) или группе устройств (на основе тегов). Когда устройство IoT Edge получает манифест развертывания, оно загружает и устанавливает образы контейнера из соответствующих репозиториев контейнера и настраивает их соответствующим образом. После создания развертывания оператор может выполнять мониторинг состояния развертывания, чтобы отслеживать, правильно ли настроены целевые устройства.

Только устройства IoT Edge можно настроить с помощью развертывания. Чтобы устройство получило развертывание, на нем должны быть установлены следующие необходимые компоненты:

* базовая операционная система;
* система управления контейнерами, например Moby или Docker;
* подготовка среды выполнения IoT Edge. 

### <a name="deployment-manifest"></a>Манифест развертывания

Манифест развертывания — это документ JSON, описывающий модули, которые нужно настроить на целевых устройствах IoT Edge. Он содержит метаданные конфигурации для всех модулей, включая необходимые системные модули (в частности, агент IoT Edge и концентратор IoT Edge).  

Метаданные конфигурации для каждого модуля содержат: 

* Version 
* type 
* состояние (например, работает или остановлен); 
* Политика перезапуска 
* образ и реестр контейнеров;
* маршруты для входных и выходных данных. 

Если образ модуля хранится в закрытом реестре контейнеров, то агент IoT Edge содержит учетные данные реестра. 

### <a name="target-condition"></a>Условие назначения

Условие назначения непрерывно оценивается во время развертывания. Включаются новые устройства, отвечающие требованиям, а любые существующие устройства, которые больше не отвечают этим требованиям, удаляются. Развертывание повторно активируется, если служба обнаруживает любое изменение состояния целевого устройства. 

Например, есть развертывание A с целевым условием tags.environment = 'prod'. Когда вы начинаете развертывание, оно содержит 10 рабочих устройств. Модули успешно устанавливаются на эти 10 устройств. Состояние агента IoT Edge отображается так: всего 10 устройств, 10 успешных ответов, 0 ответов с ошибками и 0 ответов в ожидании. Теперь добавьте еще пять устройств с целевым условием tags.environment = 'prod'. Служба обнаружит изменение, и состояние агента IoT Edge изменится, когда служба попробует развернуть пять новых устройств. Состояние будет таким: 15 устройств, 10 успешных ответов, 0 ответов с ошибкой и 5 ответов в ожидании.

Используйте любое логическое условие в тегах двойника устройства или deviceId для выбора целевых устройств. Если вы хотите использовать условие с тегами, необходимо добавить раздел "tags":{} на двойник устройства на том же уровне, что и свойства. [См. дополнительные сведения о тегах в двойнике устройства](../iot-hub/iot-hub-devguide-device-twins.md).

Примеры целевых условий:

* deviceId ='linuxprod1'
* tags.environment ='prod'
* tags.environment = 'prod' AND tags.location = 'westus'
* tags.environment = 'prod' OR tags.location = 'westus'
* tags.operator = 'John' AND tags.environment = 'prod' NOT deviceId = 'linuxprod1'

Ниже приведены некоторые ограничения, которые нужно учитывать при создании целевого условия:

* На двойнике устройства можно создавать целевое условие, только используя теги и идентификатор устройства.
* В целевом условии не разрешается использовать двойные кавычки. Используйте одинарные кавычки.
* Одинарные кавычки представляют значения целевого условия. Поэтому необходимо экранировать одинарные кавычки с помощью других одинарных кавычек, если они являются частью имени устройства. Например, если целевым объектом является устройство с именем `operator'sDevice`, запишите `deviceId='operator''sDevice'`.
* Для значений целевого условия можно использовать цифры, буквы и следующие символы: `-:.+%_#*?!(),=@;$`.

### <a name="priority"></a>Приоритет

Приоритет определяет, следует ли применять развертывание для целевого устройства по отношению к другим развертываниям. Приоритет развертывания — это положительное целое число. Большие числа обозначают более высокий приоритет. Если для устройства IoT Edge предназначено несколько развертываний, применяется развертывание с самым высоким приоритетом.  Развертывания с низким приоритетом не применяются, а также не объединяются.  Если для устройства предназначено два или больше развертываний с одинаковым приоритетом, будет применяться самое последнее созданное развертывание (определяется меткой времени создания).

### <a name="labels"></a>Метки 

Метки — это пары строк "ключ — значение", которые можно использовать для фильтрации и группирования развертываний. Развертывание может иметь несколько меток. Метки необязательны и не влияют на итоговую конфигурацию устройств IoT Edge. 

### <a name="deployment-status"></a>Состояния развертывания

Вы можете выполнять мониторинг развертывания, чтобы определить, успешно ли оно применено для любого целевого устройства IoT Edge.  Целевое пограничное устройство будет отображаться в одной или нескольких категориях состояния: 

* **Цель.** Отображает устройства IoT Edge, которые соответствуют условиям назначения развертывания.
* **Фактически.** Отображает целевые устройства IoT Edge, которые не используются другими развертываниями с высшим приоритетом.
* **Работоспособный.** Отображает устройства IoT Edge, которые передали в службу сведения об успешном развертывании модулей. 
* **Неработоспособный.** Отображает устройства IoT Edge, которые передали в службу сведения, что при развертывании одного или нескольких модулей произошел сбой. Для дальнейшего изучения ошибки удаленно подключитесь к этим устройствам и просмотрите файлы журнала.
* **Неизвестно.** Отображает устройства IoT Edge, которые не сообщают ни о каких состояниях, относящихся к этому развертыванию. Для дальнейшего изучения просмотрите информацию о службе и файлы журнала.

## <a name="phased-rollout"></a>Поэтапное развертывание 

Поэтапное развертывание — это общий процесс, с помощью которого оператор развертывает изменения в расширенном наборе устройств IoT Edge. Цель этого развертывания — постепенно вносить изменения, чтобы уменьшить риск глобальных критических изменений.  

Поэтапное развертывание выполняется в несколько этапов и шагов: 

1. Определите тестовую среду устройств IoT Edge, подготовив их и задав тег двойника устройства следующим образом: `tag.environment='test'`. Тестовая среда должна отражать рабочую среду, для которой в итоге будет применено развертывание. 
2. Создайте развертывание, включающее необходимые модули и конфигурации. Условие назначения должно быть нацелено на тестовую среду устройства IoT Edge.   
3. Проверьте новую конфигурацию модуля в тестовой среде.
4. Обновите развертывание, чтобы включить подмножество рабочих устройств IoT Edge, добавив новый тег в условие назначения. Кроме того, убедитесь, что приоритет для развертывания выше, чем для других развертываний, которые сейчас предназначены для устройств. 
5. Убедитесь, что развертывание успешно выполнено на целевых устройствах Интернета вещей, просмотрев его состояние.
6. Обновите развертывание для использования всех оставшихся рабочих устройств IoT Edge.

## <a name="rollback"></a>Откат

Вы можете выполнить откат развертываний, если произошли ошибки или в случае неправильной конфигурации.  Так как развертывание определяет абсолютную конфигурацию модуля для устройства IoT Edge, дополнительное развертывание должно также предназначаться для того же устройства с низким приоритетом, даже если необходимо удалить все модули.  

Выполните откаты в следующей последовательности: 

1. Подтвердите, что второе развертывание также предназначено для того же набора устройств. Если целью отката является удалить все модули, второе развертывание не должно содержать никаких модулей. 
2. Измените или удалите выражение условия назначения развертывания, которое вы хотите откатить, чтобы устройство больше не соответствовало условиям назначения.
3. Убедитесь, что откат выполнен успешно, просмотрев состояние развертывания.
   * Развертывание, откат которого выполнен, не должно отображать состояние для устройств, откат которых был выполнен.
   * Второе развертывание теперь должно включать состояние развертывания для устройств, откат которых был выполнен.


## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
* Узнайте больше об основных понятиях IoT Edge, таких как [среда выполнения IoT Edge](iot-edge-runtime.md) и [модули IoT Edge](iot-edge-modules.md).

