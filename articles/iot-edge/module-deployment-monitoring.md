---
title: Автоматическое развертывание групп устройств —Azure IoT Edge | Документация Майкрософт
description: Автоматическое развертывания в Azure IoT Edge для управления группами устройств на основе общих тегов
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 12/12/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 13390de8d3008907a0b55bf3a61c931dfdcd84e6
ms.sourcegitcommit: ec2eacbe5d3ac7878515092290722c41143f151d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/31/2019
ms.locfileid: "75552361"
---
# <a name="understand-iot-edge-automatic-deployments-for-single-devices-or-at-scale"></a>Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в требуемом масштабе

Автоматическое развертывание и многоуровневое развертывание помогают управлять модулями на большом количестве IoT Edge устройств и настраивать их. 

Azure IoT Edge предоставляет два способа настройки модулей для запуска на IoT Edge устройствах. Первый способ заключается в развертывании модулей на основе каждого устройства. Создайте манифест развертывания, а затем примените его к конкретному устройству по имени. Второй способ заключается в автоматическом развертывании модулей на любом зарегистрированном устройстве, которое соответствует набору определенных условий. Создайте манифест развертывания, а затем определите, к каким устройствам он применяется, на основе [тегов](../iot-edge/how-to-deploy-monitor.md#identify-devices-using-tags) в двойникае устройства. 

В этой статье мы рассмотрим этапы настройки и мониторинга для большого количества устройств, которые совокупно называются автоматическими развертываниями IoT Edge. Ниже приведены общие шаги развертывания. 

1. Оператор определяет развертывание, которое описывает набор модулей, а также целевые устройства. Каждое развертывание имеет манифест развертывания, который отражает эти сведения. 
2. Служба Центра Интернета вещей взаимодействует со всеми целевыми устройствами, чтобы настроить их для нужных модулей. 
3. Служба Центра Интернета вещей извлекает сведения о состоянии устройств IoT Edge и предоставляет эти сведения оператору для мониторинга.  Например, оператор может видеть, когда пограничное устройство не настроено успешно или если во время выполнения произошел сбой модуля. 
4. Новые устройства IoT Edge, соответствующие условиям назначения, в любое время можно настроить для развертывания. 
 
В этой статье описывается каждый компонент, связанный с настройкой и мониторингом развертывания. Пошаговое руководство по созданию и обновлению модулей см. в статье [Развертывание и мониторинг большого числа модулей IoT Edge с помощью портала Azure](how-to-deploy-monitor.md).

## <a name="deployment"></a>Развертывание.

Автоматическое развертывание IoT Edge назначает образы модуля IoT Edge для выполнения в качестве экземпляров в целевом наборе устройств IoT Edge. Он настраивает манифест развертывания IoT Edge для включения списка модулей с соответствующими параметрами инициализации. Развертывание можно назначить одному устройству (на основе идентификатора устройства) или к группе устройств (на основе тегов). После того как устройство IoT Edge получит манифест развертывания, оно скачивает и устанавливает образы контейнеров из соответствующих репозиториев контейнеров и настраивает их соответствующим образом. После создания развертывания оператор может отслеживать состояние развертывания, чтобы узнать, правильно ли настроены целевые устройства.

Только устройства IoT Edge можно настроить с помощью развертывания. Чтобы устройство получило развертывание, на нем должны быть установлены следующие необходимые компоненты:

* базовая операционная система;
* система управления контейнерами, например Moby или Docker;
* подготовка среды выполнения IoT Edge. 

### <a name="deployment-manifest"></a>Манифест развертывания

Манифест развертывания — это документ JSON, описывающий модули, которые нужно настроить на целевых устройствах IoT Edge. Он содержит метаданные конфигурации для всех модулей, включая необходимые системные модули (в частности, агент IoT Edge и концентратор IoT Edge).  

Метаданные конфигурации для каждого модуля содержат: 

* Версия 
* Тип 
* состояние (например, работает или остановлен); 
* Политика перезапуска 
* образ и реестр контейнеров;
* маршруты для входных и выходных данных. 

Если образ модуля хранится в закрытом реестре контейнеров, то агент IoT Edge содержит учетные данные реестра. 

### <a name="target-condition"></a>Условие назначения

Целевое условие постоянно оценивается на протяжении всего времени существования развертывания. Включаются новые устройства, отвечающие требованиям, а любые существующие устройства, которые больше не отвечают этим требованиям, удаляются. Развертывание повторно активируется, если служба обнаруживает любое изменение состояния целевого устройства. 

Например, есть развертывание A с целевым условием tags.environment = 'prod'. Когда вы начинаете развертывание, оно содержит 10 рабочих устройств. Модули успешно устанавливаются на эти 10 устройств. Состояние агента IoT Edge отображается так: всего 10 устройств, 10 успешных ответов, 0 ответов с ошибками и 0 ответов в ожидании. Теперь добавьте еще пять устройств с целевым условием tags.environment = 'prod'. Служба обнаружит изменение, и состояние агента IoT Edge изменится, когда служба попробует развернуть пять новых устройств. Состояние будет таким: 15 устройств, 10 успешных ответов, 0 ответов с ошибкой и 5 ответов в ожидании.

Используйте любое логическое условие в тегах двойника устройства или deviceId для выбора целевых устройств. Если вы хотите использовать условие с тегами, необходимо добавить раздел "tags":{} на двойник устройства на том же уровне, что и свойства. [См. дополнительные сведения о тегах в двойнике устройства](../iot-hub/iot-hub-devguide-device-twins.md).

Примеры целевых условий:

* deviceId ='linuxprod1'
* tags.environment ='prod'
* tags.environment = 'prod' AND tags.location = 'westus'
* tags.environment = 'prod' OR tags.location = 'westus'
* tags.operator = 'John' AND tags.environment = 'prod' NOT deviceId = 'linuxprod1'

Ниже приведены некоторые ограничения, которые нужно учитывать при создании целевого условия:

* На двойнике устройства можно создавать целевое условие, только используя теги и идентификатор устройства.
* В целевом условии не разрешается использовать двойные кавычки. Используйте одинарные кавычки.
* Одинарные кавычки представляют значения целевого условия. Поэтому необходимо экранировать одинарные кавычки с помощью других одинарных кавычек, если они являются частью имени устройства. Например, если целевым объектом является устройство с именем `operator'sDevice`, запишите `deviceId='operator''sDevice'`.
* Для значений целевого условия можно использовать цифры, буквы и следующие символы: `-:.+%_#*?!(),=@;$`.

### <a name="priority"></a>Приоритет

Приоритет определяет, следует ли применять развертывание для целевого устройства по отношению к другим развертываниям. Приоритет развертывания — это положительное целое число. Большие числа обозначают более высокий приоритет. Если для устройства IoT Edge предназначено несколько развертываний, применяется развертывание с самым высоким приоритетом.  Развертывания с более низкими приоритетами не применяются и не объединяются.  Если устройство предназначено для двух или более развертываний с равным приоритетом, то применяется последнее созданное развертывание (определяется меткой времени создания).

### <a name="labels"></a>Метки 

Метки представляют собой строковые пары "ключ-значение", которые можно использовать для фильтрации и группирования развертываний. Развертывание может иметь несколько меток. Метки необязательны и не влияют на фактическую конфигурацию IoT Edge устройств. 

### <a name="metrics"></a>Метрики

По умолчанию все развертывания сообщают четыре метрики:

* **Целевой** объект показывает IOT Edge устройства, соответствующие условию нацеливания развертывания.
* **Применено** показывает целевые IOT Edge устройства, которые не предназначены для другого развертывания с более высоким приоритетом.
* **Отчет об успешном выполнении** показывает IOT Edge устройства, которые передавались обратно в службу, что модули были развернуты успешно. 
* **Ошибка при создании отчетов** показывает IOT Edge устройства, которые сообщают службе о том, что один или несколько модулей не были успешно развернуты. Для дальнейшего изучения ошибки удаленно подключитесь к этим устройствам и просмотрите файлы журнала.

Кроме того, можно определить собственные пользовательские метрики, помогающие отслеживать развертывание и управлять им. 

Метрики предоставляют сводное количество различных состояний, которые могут выдаваться устройствами в результате применения конфигурации развертывания. Метрики могут запрашивать [сообщаемые свойства модуля edgeHub двойника](module-edgeagent-edgehub.md#edgehub-reported-properties), например последнее требуемое состояние или время последнего подключения. Пример. 

```sql
SELECT deviceId FROM devices
  WHERE properties.reported.lastDesiredStatus.code = 200
```

Добавление собственных метрик является необязательным и не влияет на фактическую конфигурацию IoT Edge устройств. 

## <a name="layered-deployment"></a>Иерархическое развертывание

Многоуровневые развертывания — это автоматические развертывания, которые можно объединять для уменьшения количества уникальных развертываний, которые необходимо создать. Многоуровневые развертывания полезны в сценариях, где одни и те же модули повторно используются в различных сочетаниях во многих автоматических развертываниях. 

Многоуровневые развертывания имеют те же базовые компоненты, что и любое автоматическое развертывание. Они нацелены на устройства на основе тегов в двойникове устройства и предоставляют те же функциональные возможности, что и метки, метрики и отчеты о состоянии. Для многоуровневых развертываний также назначены приоритеты, но вместо использования приоритета для определения того, какое развертывание применяется к устройству, приоритет определяет ранжирование нескольких развертываний на устройстве. Например, если два многоуровневых развертывания имеют модуль или маршрут с тем же именем, то при пересчете более низкого приоритета будет применено многоуровневое развертывание с более высоким приоритетом. 

Модули системной среды выполнения, edgeAgent и edgeHub, не настраиваются как часть многоуровневого развертывания. Любое IoT Edge устройство, на которое нацелено многоуровневое развертывание, должно сначала применить к нему стандартное автоматическое развертывание, чтобы предоставить основу, в которой можно добавить многоуровневые развертывания. 

Устройство IoT Edge может применять одно и только одно стандартное автоматическое развертывание, но оно может применять несколько многоуровневых автоматических развертываний. Все многоуровневые развертывания, предназначенные для устройства, должны иметь более высокий приоритет, чем автоматическое развертывание для этого устройства. 

Например, рассмотрим следующий сценарий компании, которая управляет зданиями. Они разработали IoT Edge модули для сбора данных с камер безопасности, датчиков движения и лифты. Однако не все их строения могут использовать все три модуля. При использовании стандартных автоматических развертываний компании необходимо создать отдельные развертывания для всех сочетаний модулей, необходимых для их зданий. 

![Стандартные автоматические развертывания должны поддерживать каждое сочетание модулей](./media/module-deployment-monitoring/standard-deployment.png)

Однако, когда компания переключается на многоуровневые автоматические развертывания, она обнаружит, что они смогут создавать одни и те же сочетания модулей для своих зданий, с меньшим количеством развертываний для управления. Каждый модуль имеет собственное многоуровневое развертывание, а теги устройств определяют, какие модули добавляются в каждое здание. 

![Многоуровневое автоматическое развертывание упрощают сценарии, в которых одни и те же модули объединяются разными способами.](./media/module-deployment-monitoring/layered-deployment.png)

### <a name="module-twin-configuration"></a>Конфигурация двойника модуля

При работе с многоуровневые развертываниями вы можете, как можно, так и иным образом, иметь два развертывания с одним модулем, предназначенным для устройства. В этих случаях можно решить, будет ли развертывание с более высоким приоритетом перезаписывать двойника модуля или добавлять к нему. Например, у вас может быть развертывание, которое применяет один и тот же модуль для 100 различных устройств. Однако 10 этих устройств находятся в защищенных средствах и требуют дополнительной настройки для взаимодействия через прокси-серверы. Многоуровневую развертывание можно использовать для добавления свойств двойникаа модуля, которые обеспечивают безопасное взаимодействие этих 10 устройств без перезаписи существующих сведений о двойника модулях из базового развертывания. 

Вы можете добавить необходимые свойства модуля двойника в манифест развертывания. Где в стандартном развертывании вы добавите свойства в **Свойства. нужный** раздел модуля двойника в многоуровневом развертывании можно объявить новое подмножество требуемых свойств. 

Например, в стандартном развертывании можно добавить смоделированный модуль датчика температуры со следующими требуемыми свойствами, которые сообщают ему об отправке данных через 5-секундный интервал:

```json
"SimulatedTemperatureSensor": {
  "properties.desired": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

В многоуровневом развертывании, предназначенном для одних и тех же устройств или подмножества тех же устройств, может потребоваться добавить дополнительное свойство, которое сообщает имитируемому датчику отправку сообщений 1000, а затем останавливает работу. Вы не хотите перезаписывать существующие свойства, поэтому создайте новый раздел в нужных свойствах с именем `layeredProperties`, который содержит новое свойство:

```json
"SimulatedTemperatureSensor": {
  "properties.desired.layeredProperties": {
    "StopAfterCount": 1000
  }
}
```

Устройство, к которому применяются оба развертывания, будет отражать следующее в модуле двойника для имитации датчика температуры: 

```json
"properties": {
  "desired": {
    "SendData": true,
    "SendInterval": 5,
    "layeredProperties": {
      "StopAfterCount": 1000
    }
  }
}
```

Если задать поле `properties.desired` модуля двойника в многоуровневом развертывании, это приведет к перезаписи требуемых свойств для этого модуля в любых развертываниях с более низким приоритетом. 

## <a name="phased-rollout"></a>Поэтапное развертывание 

Поэтапное развертывание — это общий процесс, с помощью которого оператор развертывает изменения в расширенном наборе устройств IoT Edge. Цель этого развертывания — постепенно вносить изменения, чтобы уменьшить риск глобальных критических изменений. Автоматические развертывания помогают управлять поэтапным развертыванием за пределами IoT Edge устройств. 

Поэтапное развертывание выполняется в несколько этапов и шагов: 

1. Определите тестовую среду устройств IoT Edge, подготовив их и задав тег двойника устройства следующим образом: `tag.environment='test'`. Тестовая среда должна зеркально отобразить рабочую среду, на которую в конечном итоге будет производиться развертывание. 
2. Создайте развертывание, включающее необходимые модули и конфигурации. Условие назначения должно быть нацелено на тестовую среду устройства IoT Edge.   
3. Проверьте новую конфигурацию модуля в тестовой среде.
4. Обновите развертывание, чтобы включить подмножество рабочих устройств IoT Edge, добавив новый тег в условие назначения. Кроме того, убедитесь, что приоритет для развертывания выше, чем для других развертываний, которые сейчас предназначены для устройств. 
5. Убедитесь, что развертывание успешно выполнено на целевых устройствах Интернета вещей, просмотрев его состояние.
6. Обновите развертывание для использования всех оставшихся рабочих устройств IoT Edge.

## <a name="rollback"></a>Откат

Вы можете выполнить откат развертываний, если произошли ошибки или в случае неправильной конфигурации. Поскольку развертывание определяет абсолютную конфигурацию модуля для IoT Edge устройства, дополнительное развертывание также должно быть нацелено на то же устройство с более низким приоритетом, даже если целью является удаление всех модулей.  

При удалении развертывания модули не удаляются с целевых устройств. Должно быть другое развертывание, определяющее новую конфигурацию для устройств, даже если это пустое развертывание. 

Выполните откаты в следующей последовательности: 

1. Подтвердите, что второе развертывание также предназначено для того же набора устройств. Если целью отката является удалить все модули, второе развертывание не должно содержать никаких модулей. 
2. Измените или удалите выражение условия назначения развертывания, которое вы хотите откатить, чтобы устройство больше не соответствовало условиям назначения.
3. Убедитесь, что откат выполнен успешно, просмотрев состояние развертывания.
   * Развертывание, откат которого выполнен, не должно отображать состояние для устройств, откат которых был выполнен.
   * Второе развертывание теперь должно включать состояние развертывания для устройств, откат которых был выполнен.


## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
* Узнайте больше об основных понятиях IoT Edge, таких как [среда выполнения IoT Edge](iot-edge-runtime.md) и [модули IoT Edge](iot-edge-modules.md).

