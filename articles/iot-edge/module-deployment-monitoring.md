---
title: Автоматическое развертывание групп устройств —Azure IoT Edge | Документация Майкрософт
description: Автоматическое развертывания в Azure IoT Edge для управления группами устройств на основе общих тегов
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 01/30/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 8aaac6100ba980301ff3e85a3ac3959bfee89b49
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76895961"
---
# <a name="understand-iot-edge-automatic-deployments-for-single-devices-or-at-scale"></a>Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в требуемом масштабе

Автоматическое развертывание и многоуровневое развертывание помогают управлять и настраивать модули на большом количестве устройств IoT Edge.

Azure IoT Edge предоставляет два способа настройки модулей для запуска на устройствах IoT Edge. Первый метод заключается в развертывании модулей на основе одного устройства. Вы создаете манифест развертывания, а затем применяете его к определенному устройству по имени. Второй метод заключается в автоматическом развертывании модулей на любом зарегистрированном устройстве, отвечающее набору определенных условий. Вы создаете манифест развертывания, а затем определяете, к каким устройствам оно применяется на основе [тегов](../iot-edge/how-to-deploy-monitor.md#identify-devices-using-tags) в близнеце устройства.

В этой статье основное внимание уделяется настройке и мониторингу флотов устройств, которые в совокупности называются *автоматическими развертываниями IoT Edge.*Основные этапы развертывания следующие:

1. Оператор определяет развертывание, описывая набор модулей и целевых устройств.Каждое развертывание имеет манифест развертывания, который отражает эти сведения.
2. Служба Концентратора IoT общается со всеми целевыми устройствами для настройки их с заявленными модулями.
3. Служба Центра Интернета вещей извлекает сведения о состоянии устройств IoT Edge и предоставляет эти сведения оператору для мониторинга.Например, оператор может видеть, когда устройство Edge не настроено успешно или если модуль выходит из строя во время выполнения.
4. Новые устройства IoT Edge, соответствующие условиям назначения, в любое время можно настроить для развертывания.

В этой статье описывается каждый компонент, связанный с настройкой и мониторингом развертывания. Пошаговое руководство по созданию и обновлению модулей см. в статье [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md).

## <a name="deployment"></a>Развертывание

Автоматическое развертывание IoT Edge назначает образы модуля IoT Edge для выполнения в качестве экземпляров в целевом наборе устройств IoT Edge. Он настраивает манифест развертывания IoT Edge для включения списка модулей с соответствующими параметрами инициализации.Развертывание можно назначить одному устройству (на основе идентификатора устройства) или группе устройств (на основе тегов).Когда устройство IoT Edge получает манифест развертывания, оно загружает и устанавливает образы контейнера из соответствующих репозиториев контейнера и настраивает их соответствующим образом.После создания развертывания оператор может выполнять мониторинг состояния развертывания, чтобы отслеживать, правильно ли настроены целевые устройства.

Только устройства IoT Edge можно настроить с помощью развертывания. Чтобы устройство получило развертывание, на нем должны быть установлены следующие необходимые компоненты:

* базовая операционная система;
* система управления контейнерами, например Moby или Docker;
* подготовка среды выполнения IoT Edge.

### <a name="deployment-manifest"></a>Манифест развертывания

Манифест развертывания — это документ JSON, описывающий модули, которые нужно настроить на целевых устройствах IoT Edge. Он содержит метаданные конфигурации для всех модулей, включая необходимые системные модули (в частности, агент IoT Edge и концентратор IoT Edge).  

Метаданные конфигурации для каждого модуля содержат:

* Версия
* Тип
* состояние (например, работает или остановлен);
* Политика перезапуска
* образ и реестр контейнеров;
* маршруты для входных и выходных данных.

Если образ модуля хранится в закрытом реестре контейнеров, то агент IoT Edge содержит учетные данные реестра.

### <a name="target-condition"></a>Условие назначения

Целевое состояние постоянно оценивается в течение всего срока развертывания. Включаются новые устройства, отвечающие требованиям, а любые существующие устройства, которые больше не отвечают этим требованиям, удаляются. Развертывание повторно активируется, если служба обнаруживает любое изменение состояния целевого устройства.

Например, у вас есть развертывание с целевым условием tags.environment и 'prod'. Когда вы начинаете развертывание, оно содержит 10 рабочих устройств. Модули успешно устанавливаются на эти 10 устройств. Статус агента IoT Edge показывает 10 устройств, 10 успешных ответов, 0 отказов и 0 ожидающих ответов. Теперь добавьте еще пять устройств с целевым условием tags.environment = 'prod'. Служба обнаруживает изменение, и статус агента IoT Edge становится 15 общим ивсе устройств, 10 успешными ответами, 0 отказами и 5 ожидающими отработок ответов, пока он развертывается на пяти новых устройствах.

Используйте любое условие Boolean на двух тегах устройства, свойствах близнецов устройств или deviceId для выбора целевых устройств. Если вы хотите использовать условие с тегами, необходимо добавить раздел "tags":{} на двойник устройства на том же уровне, что и свойства. [См. дополнительные сведения о тегах в двойнике устройства](../iot-hub/iot-hub-devguide-device-twins.md).

Примеры целевых условий:

* deviceId ='linuxprod1'
* tags.environment ='prod'
* tags.environment = 'prod' AND tags.location = 'westus'
* tags.environment = 'prod' OR tags.location = 'westus'
* tags.operator = 'John' AND tags.environment = 'prod' NOT deviceId = 'linuxprod1'
* свойства.reported.devicemodel '4000x'

Рассмотрим эти ограничения при построении целевого состояния:

* В двух устройстве можно создать целевое состояние только с помощью тегов, сообщаемых свойств или deviceId.
* В целевом условии не разрешается использовать двойные кавычки. Используйте одинарные кавычки.
* Одинарные кавычки представляют значения целевого условия. Поэтому необходимо экранировать одинарные кавычки с помощью других одинарных кавычек, если они являются частью имени устройства. Например, если целевым объектом является устройство с именем `operator'sDevice`, запишите `deviceId='operator''sDevice'`.
* Для значений целевого условия можно использовать цифры, буквы и следующие символы: `-:.+%_#*?!(),=@;$`.

### <a name="priority"></a>Приоритет

Приоритет определяет, следует ли применять развертывание для целевого устройства по отношению к другим развертываниям. Приоритет развертывания — это положительное целое число. Большие числа обозначают более высокий приоритет. Если для устройства IoT Edge предназначено несколько развертываний, применяется развертывание с самым высоким приоритетом.Развертывания с низким приоритетом не применяются, а также не объединяются.Если для устройства предназначено два или больше развертываний с одинаковым приоритетом, будет применяться самое последнее созданное развертывание (определяется меткой времени создания).

### <a name="labels"></a>Метки

Метки — это пары ключей/значений строки, которые можно использовать для фильтрации и групповых развертываний.Развертывание может иметь несколько меток. Этикетки не являются обязательными и не влияют на фактическую конфигурацию устройств IoT Edge.

### <a name="metrics"></a>Метрики

По умолчанию все развертывания отчитываются по четырем показателям:

* **Целевые отображаются** устройства IoT Edge, которые соответствуют состоянию таргетинга развертывания.
* **Прикладная** отображает целевые устройства IoT Edge, которые не являются объектом другого развертывания с более высоким приоритетом.
* **Отчетный успех** показывает устройства IoT Edge, которые сообщили, что модули были успешно развернуты.
* **Сбой отчетности** показывает устройства IoT Edge, которые сообщили, что один или несколько модулей не были развернуты успешно. Для дальнейшего изучения ошибки удаленно подключитесь к этим устройствам и просмотрите файлы журнала.

Кроме того, можно определить собственные пользовательские метрики, которые помогут контролировать развертывание и управлять ими.

Метрики предоставляют сводные подсчеты различных состояний, которые устройства могут отчитываться в результате применения конфигурации развертывания. Метрика может заказать [модуль edgeHub с двумя объектами, такими](module-edgeagent-edgehub.md#edgehub-reported-properties)как *lastDesiredStatus* или *lastConnectTime.* Пример:

```sql
SELECT deviceId FROM devices
  WHERE properties.reported.lastDesiredStatus.code = 200
```

Добавление собственных метрик является необязательным и не влияет на фактическую конфигурацию устройств IoT Edge.

## <a name="layered-deployment"></a>Слоеное развертывание

Многоуровневые развертывания являются автоматическими развертываниями, которые могут быть объединены вместе, чтобы уменьшить количество уникальных развертываний, которые необходимо создать. Многоуровневые развертывания полезны в сценариях, где одни и те же модули используются в разных комбинациях во многих автоматических развертываниях.

Многоуровневые развертывания имеют те же основные компоненты, что и любое автоматическое развертывание. Они нацелены на устройства на основе тегов в близнецах устройства и обеспечивают ту же функциональность вокруг меток, метрик и отчетов о состоянии. У уровней развертывания также есть приоритеты, назначенные им, но вместо того, чтобы использовать приоритет для определения того, какое развертывание применяется к устройству, приоритет определяет, как несколько развертываний ранжируются на устройстве. Например, если два слоистых развертывания имеют модуль или маршрут с одинаковым именем, слоистые развертывания с более высоким приоритетом будут применены в то время как нижний приоритет перезаписан.

Модули времени выполнения системы, edgeAgent и edgeHub, не настроены как часть многоуровневого развертывания. Любое устройство IoT Edge, на которое нацелено многоуровневое развертывание, нуждается в стандартном автоматическом развертывании, применяемом к нему в первую очередь. Автоматическое развертывание обеспечивает базу, на которой можно добавлять многоуровневые развертывания.

Устройство IoT Edge может применять одно стандартное автоматическое развертывание, но оно может применять многоуровневое автоматическое развертывание. Любые многоуровневые развертывания, ориентированные на устройство, должны иметь более высокий приоритет, чем автоматическое развертывание для этого устройства.

Например, рассмотрим следующий сценарий компании, управляющей зданиями. Они разработали модули IoT Edge для сбора данных с камер безопасности, датчиков движения и лифтов. Однако не все их здания могут использовать все три модуля. При стандартных автоматических развертываниях компании необходимо создавать индивидуальные развертывания для всех комбинаций модулей, в которые нуждаются их здания.

![Стандартные автоматические развертывания должны учитывать каждую комбинацию модулей](./media/module-deployment-monitoring/standard-deployment.png)

Однако, как только компания переключается на многоуровневые автоматические развертывания, они обнаруживают, что они могут создавать те же комбинации модулей для своих зданий с меньшим количеством развертываний для управления. Каждый модуль имеет свое собственное многоуровневое развертывание, и теги устройства определяют, какие модули добавляются к каждому зданию.

![Многоуровневые автоматические развертывания упрощают сценарии, в которых одни и те же модули объединяются по-разному](./media/module-deployment-monitoring/layered-deployment.png)

### <a name="module-twin-configuration"></a>Модуль двойной конфигурации

При работе с многоуровневыми развертываниями можно намеренно или иным образом иметь два развертывания с тем же модулем, ориентированным на устройство. В этих случаях можно решить, следует ли перезаписать двойник модуля или придатиться к нему. Например, у вас может быть развертывание, которое применяет один и тот же модуль к 100 различным устройствам. Тем не менее, 10 из этих устройств находятся в безопасных условиях и нуждаются в дополнительной конфигурации для того, чтобы общаться через прокси-серверы. Можно использовать многоуровневое развертывание для добавления двойных свойств модуля, которые позволяют этим 10 устройствам безопасно общаться без перезаписи двойной информации о существующем модуле из базового развертывания.

Вы можете прибещеть модуль двойных желаемых свойств в манифесте развертывания. В тех случаях, когда в стандартном развертывании вы добавляли свойства в раздел **свойств.желаемый** модуль двойника, в многоуровневом развертывании можно объявить новый подмножество желаемых свойств.

Например, при стандартном развертывании можно добавить смоделированный модуль датчика температуры со следующими желаемыми свойствами, которые говорят ему отправлять данные через 5-секундные интервалы:

```json
"SimulatedTemperatureSensor": {
  "properties.desired": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

В многоуровневом развертывании, нацеленном на некоторые или все одни и те же устройства, можно добавить свойство, которое сообщает смоделированному датчику отправить 1000 сообщений, а затем остановиться. Не хотите перезаписывать существующие свойства, поэтому создается новый раздел `layeredProperties`в пределах желаемых свойств, называемых , который содержит новое свойство:

```json
"SimulatedTemperatureSensor": {
  "properties.desired.layeredProperties": {
    "StopAfterCount": 1000
  }
}
```

Устройство, которое имеет оба развертывания применяется будет отражать следующие свойства в модуле близнец для имитации датчика температуры:

```json
"properties": {
  "desired": {
    "SendData": true,
    "SendInterval": 5,
    "layeredProperties": {
      "StopAfterCount": 1000
    }
  }
}
```

Если вы установите `properties.desired` поле двойника модуля в многоуровневое развертывание, он перезапишет желаемые свойства для этого модуля в любых более низких приоритетных развертываниях.

## <a name="phased-rollout"></a>Поэтапное развертывание

Поэтапное развертывание — это общий процесс, с помощью которого оператор развертывает изменения в расширенном наборе устройств IoT Edge. Цель этого развертывания — постепенно вносить изменения, чтобы уменьшить риск глобальных критических изменений. Автоматическое развертывание помогает управлять поэтапными развертываниями на устройствах IoT Edge.

Поэтапное развертывание выполняется в несколько этапов и шагов:

1. Определите тестовую среду устройств IoT Edge, подготовив их и задав тег двойника устройства следующим образом: `tag.environment='test'`.Тестовая среда должна отражать рабочую среду, для которой в итоге будет применено развертывание.
2. Создайте развертывание, включающее необходимые модули и конфигурации. Условие назначения должно быть нацелено на тестовую среду устройства IoT Edge.
3. Проверьте новую конфигурацию модуля в тестовой среде.
4. Обновите развертывание, чтобы включить подмножество рабочих устройств IoT Edge, добавив новый тег в условие назначения. Кроме того, убедитесь, что приоритет для развертывания выше, чем для других развертываний, которые сейчас предназначены для устройств.
5. Убедитесь, что развертывание успешно выполнено на целевых устройствах Интернета вещей, просмотрев его состояние.
6. Обновите развертывание для использования всех оставшихся рабочих устройств IoT Edge.

## <a name="rollback"></a>Откат

Вы можете выполнить откат развертываний, если произошли ошибки или в случае неправильной конфигурации.Так как развертывание определяет абсолютную конфигурацию модуля для устройства IoT Edge, дополнительное развертывание должно также предназначаться для того же устройства с низким приоритетом, даже если необходимо удалить все модули.  

Удаление развертывания не удаляет модули с целевых устройств. Должно быть другое развертывание, определяющее новую конфигурацию для устройств, даже если это пустое развертывание.

Выполните откаты в следующей последовательности:

1. Подтвердите, что второе развертывание также предназначено для того же набора устройств. Если целью отката является удалить все модули, второе развертывание не должно содержать никаких модулей.
2. Измените или удалите выражение условия назначения развертывания, которое вы хотите откатить, чтобы устройство больше не соответствовало условиям назначения.
3. Убедитесь, что откат выполнен успешно, просмотрев состояние развертывания.
   * Развертывание, откат которого выполнен, не должно отображать состояние для устройств, откат которых был выполнен.
   * Второе развертывание теперь должно включать состояние развертывания для устройств, откат которых был выполнен.

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-monitor.md), чтобы узнать, как создавать, обновлять или удалять развертывание.
* Узнайте больше об основных понятиях IoT Edge, таких как [среда выполнения IoT Edge](iot-edge-runtime.md) и [модули IoT Edge](iot-edge-modules.md).
