---
title: Управление сертификатами устройств - Azure IoT Edge Документы Майкрософт
description: Создавайте тестовые сертификаты, устанавливайте и управляйте ими на устройстве Azure IoT Edge для подготовки к развертыванию.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 03/02/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: c18c3d560adb3c3cae54bda808ee5842c260fd6b
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79539212"
---
# <a name="manage-certificates-on-an-iot-edge-device"></a>Управление сертификатами на устройстве IoT Edge

Все устройства IoT Edge используют сертификаты для создания безопасных соединений между временем выполнения и любыми модулями, работающими на устройстве. Устройства IoT Edge, функционирующие как шлюзы, также используют эти же сертификаты для подключения к устройствам ниже по течению.

## <a name="install-production-certificates"></a>Установка рабочих сертификатов

При первой установке IoT Edge и предоставлении устройства устройство настраивается с временными сертификатами, чтобы вы могли протестировать службу.
Срок действия этих временных сертификатов истекает через 90 дней или может быть сдана путем перезапуска машины.
Как только вы будете готовы перевести устройства в производственный сценарий или хотите создать сценарий шлюза, необходимо предоставить собственные сертификаты.
В этой статье показаны шаги по установке сертификатов на устройства IoT Edge.

Подробнее о различных типах сертификатов и их ролях в сценарии IoT Edge можно узнать, [как Azure IoT Edge использует сертификаты.](iot-edge-certs.md)

>[!NOTE]
>Термин "root CA", используемый в этой статье, относится к верхнему государственному сертификату авторитета цепи сертификатов для вашего решения IoT. Вам не нужно использовать корень сертификата синдицированного сертификата или корень сертификата организации. Во многих случаях это фактически промежуточный публичный сертификат CA.

### <a name="prerequisites"></a>Предварительные требования

* Устройство IoT Edge, работающее либо на [Windows,](how-to-install-iot-edge-windows.md) либо на [Linux.](how-to-install-iot-edge-linux.md)
* Иметь сертификат авторитета (CA), либо самостоятельно подписанный или приобретенный у доверенного органа коммерческого сертификата, как Балтимор, Verisign, DigiCert, или GlobalSign.

Если у вас еще нет корневого сертификата, но вы хотите опробовать функции IoT Edge, требующие производственных сертификатов (например, сценарии шлюза), вы можете [создать демо-сертификаты для проверки функций устройства IoT Edge.](how-to-create-test-certificates.md)

### <a name="create-production-certificates"></a>Создание производственных сертификатов

Для создания следующих файлов следует использовать собственный сертификат:

* Корневой ЦС
* Сертификат ЦС устройства
* Устройство CA частный ключ

В этой статье то, что мы называем *корневым ЦА,* не является самым главным сертификатом для организации. Это самый верхний сертификат для сценария IoT Edge, который модуль концентратора IoT Edge, пользовательские модули и любые устройства вниз по течению используют для установления доверия друг к другу.

Чтобы увидеть пример этих сертификатов, просмотрите сценарии, которые создают демо-сертификаты в [сертификатах управления тестами CA для образцов и учебников.](https://github.com/Azure/iotedge/tree/master/tools/CACertificates)

### <a name="install-certificates-on-the-device"></a>Установка сертификатов на устройстве

Установите цепочку сертификатов на устройство IoT Edge и назначьте время выполнения IoT Edge для ссылки на новые сертификаты.

Например, если вы использовали образцы скриптов для [создания демо-сертификатов,](how-to-create-test-certificates.md)скопируйте следующие файлы на устройство IoT-Edge:

* Сертификат CA устройства:`<WRKDIR>\certs\iot-edge-device-MyEdgeDeviceCA-full-chain.cert.pem`
* Устройство CA частный ключ:`<WRKDIR>\private\iot-edge-device-MyEdgeDeviceCA.key.pem`
* Корень CA:`<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

1. Копируйте три сертификата и ключевые файлы на устройстве IoT Edge.

   Для перемещения файлов сертификатов можно использовать службу, например [Azure Key Vault,](https://docs.microsoft.com/azure/key-vault) или функцию, например [протокол «Безопасный копий».](https://www.ssh.com/ssh/scp/)  Если вы создали сертификаты на самом устройстве IoT Edge, вы можете пропустить этот шаг и использовать путь к рабочему каталогу.

1. Откройте файл конфигурации управляющей программы безопасности IoT Edge.

   * Windows: `C:\ProgramData\iotedge\config.yaml`
   * Linux: `/etc/iotedge/config.yaml`

1. Установите свойства **сертификата** в файле config.yaml на полный путь к сертификату и файлам ключей на устройстве IoT Edge. Удалите `#` символ перед свойствами сертификата, чтобы не прокомментировать четыре строки. Убедитесь, что сертификаты: линия не имеет предшествующего пробела, и что вложенные элементы отступом двумя **пробелами.** Пример:

   * Windows:

      ```yaml
      certificates:
        device_ca_cert: "c:\\<path>\\device-ca.cert.pem"
        device_ca_pk: "c:\\<path>\\device-ca.key.pem"
        trusted_ca_certs: "c:\\<path>\\root-ca.root.ca.cert.pem"
      ```

   * Linux:

      ```yaml
      certificates:
        device_ca_cert: "<path>/device-ca.cert.pem"
        device_ca_pk: "<path>/device-ca.key.pem"
        trusted_ca_certs: "<path>/root-ca.root.ca.cert.pem"
      ```

1. На устройствах Linux убедитесь, что пользователь **iotedge** прочитал разрешения для каталога, держащего сертификаты.

1. Если ранее вы использовали на устройстве какие-либо другие сертификаты IoT Edge, удалите файлы в следующих двух каталогах перед запуском или перезапуском IoT Edge:

   * Окна: `C:\ProgramData\iotedge\hsm\certs` и`C:\ProgramData\iotedge\hsm\cert_keys`

   * Linux: `/var/lib/iotedge/hsm/certs` и`/var/lib/iotedge/hsm/cert_keys`

## <a name="customize-certificate-lifetime"></a>Настройка срока службы сертификата

IoT Edge автоматически генерирует сертификаты на устройстве в нескольких случаях, в том числе:

* Если при установке и предоставлении IoT Edge вы не предоставляете собственные производственные сертификаты, менеджер безопасности IoT Edge автоматически генерирует **сертификат CA устройства.** Этот самоподписанный сертификат предназначен только для сценариев разработки и тестирования, а не для производства. Срок действия этого сертификата истекает через 90 дней.
* Менеджер безопасности IoT Edge также создает **сертификат CA рабочей нагрузки,** подписанный сертификатом CA устройства

Для получения дополнительной информации о функции различных сертификатов на устройстве IoT Edge [см., как Azure IoT Edge использует сертификаты.](iot-edge-certs.md)

Для этих двух автоматически генерируемых сертификатов у вас есть возможность установить **флаг auto_generated_ca_lifetime_days** в config.yaml для настройки количества дней в течение всего срока действия сертификатов.

>[!NOTE]
>Существует третий автоматически созданный сертификат, созданный менеджером безопасности IoT Edge, **сертификат сервера Концентратора IoT Edge.** Этот сертификат всегда имеет 90 дней, но автоматически продлевается до истечения срока действия. Значение **auto_generated_ca_lifetime_days** не влияет на этот сертификат.

Чтобы настроить срок действия сертификата на что-то, кроме 90 дней по умолчанию, добавьте значение в несколько дней в разделе **сертификатов** файла config.yaml.

```yaml
certificates:
  device_ca_cert: "<ADD URI TO DEVICE CA CERTIFICATE HERE>"
  device_ca_pk: "<ADD URI TO DEVICE CA PRIVATE KEY HERE>"
  trusted_ca_certs: "<ADD URI TO TRUSTED CA CERTIFICATES HERE>"
  auto_generated_ca_lifetime_days: <value>
```

Если вы предоставили свои собственные сертификаты CA устройства, то это значение по-прежнему применяется к сертификату CA рабочей нагрузки, при условии, что установленное значение продолжительности жизни короче срока действия сертификата CA устройства.

После указания флага в файле config.yaml, выполнить следующие шаги:

1. Удалите содержимое папки. `hsm`

   Windows: `C:\ProgramData\iotedge\hsm\certs and C:\ProgramData\iotedge\hsm\cert_keys` Linux:`/var/lib/iotedge/hsm/certs and /var/lib/iotedge/hsm/cert_keys`

1. Перезапустите службу IoT Edge.

   Windows:

   ```powershell
   Restart-Service iotedge
   ```

   Linux:

   ```bash
   sudo systemctl restart iotedge
   ```

1. Подтвердите настройки продолжительности жизни.

   Windows:

   ```powershell
   iotedge check --verbose
   ```

   Linux:

   ```bash
   sudo iotedge check --verbose
   ```

   Проверьте выход **производственной готовности: проверка сертификатов,** в которой перечисляется количество дней, пока не истечет срок действия автоматически генерируемых сертификатов CA.

## <a name="next-steps"></a>Дальнейшие действия

Установка сертификатов на устройстве IoT Edge является необходимым шагом перед развертыванием решения в производстве. Узнайте больше о том, как [подготовиться к развертыванию решения IoT Edge в производственной области.](production-checklist.md)
