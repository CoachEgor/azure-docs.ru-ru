---
title: Создание устройства прозрачного шлюза с помощью Azure IoT Edge | Документация Майкрософт
description: Использование устройства Azure IoT Edge в качестве прозрачного шлюза, позволяющего обрабатывать информацию из подчиненных устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 08/17/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: d0ac7fa3a1dbb1c91da5b9919bc2c62de74213b5
ms.sourcegitcommit: 12d902e78d6617f7e78c062bd9d47564b5ff2208
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2019
ms.locfileid: "74456779"
---
# <a name="configure-an-iot-edge-device-to-act-as-a-transparent-gateway"></a>Настройка устройства IoT Edge в качестве прозрачного шлюза

В этой статье содержатся подробные инструкции по настройке устройства IoT Edge для работы в качестве прозрачного шлюза для взаимодействия других устройств с центром Интернета вещей. В этой статье под термином *шлюз IoT Edge* подразумевается устройство IoT Edge, которое используется в качестве прозрачного шлюза. Дополнительные сведения см. [в статье как можно использовать IOT Edge устройство в качестве шлюза](./iot-edge-as-gateway.md).

>[!NOTE]
>В данный момент:
> * устройства с поддержкой Edge не могут подключиться к шлюзам IoT Edge; 
> * подчиненные устройства не поддерживают отправку файлов.

Существует три основных шага для настройки успешного подключения к прозрачному шлюзу. В этой статье рассматривается первый шаг:

1. **Устройство шлюза должно иметь возможность безопасного подключения к подчиненным устройствам, получать подключения от подчиненных устройств и маршрутизировать сообщения в соответствующее место назначения.**
2. Подчиненное устройство должно иметь удостоверение устройства, чтобы иметь возможность проходить проверку подлинности в центре Интернета вещей и взаимодействовать через его устройство шлюза. Дополнительные сведения см. в статье [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md).
3. Подчиненное устройство должно иметь возможность безопасного подключения к устройству шлюза. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).


Чтобы устройство могло работать как шлюз, оно должно иметь возможность безопасного подключения к его подчиненным устройствам. Решение Azure IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы разрешаем подчиненному устройству подключаться к устройству IoT Edge, выполняющему роль прозрачного шлюза. Чтобы обеспечить приемлемую безопасность, подчиненное устройство должно подтвердить удостоверение устройства шлюза. Эта проверка удостоверения не позволяет устройствам подключаться к потенциально вредоносным шлюзам.

Подчиненным устройством в сценарии с прозрачным шлюзом может быть любое приложение или платформа с удостоверением, созданным с помощью облачной службы [центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub) . Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Для любых практических целей в качестве подчиненного устройства можно использовать даже приложение, запущенное на самом устройстве шлюза IoT Edge. Однако устройство IoT Edge не может быть переIoT Edge шлюза. 

Вы можете создать любую инфраструктуру сертификата, обеспечивающую доверие, необходимое для топологии "устройство — шлюз". В этой статье мы предполагаем ту же настройку сертификата, которую вы использовали для включения [безопасности ЦС x. 509](../iot-hub/iot-hub-x509ca-overview.md) в центре Интернета вещей, которая включает сертификат ЦС x. 509, связанный с конкретным центром Интернета вещей (КОРНЕВой ЦС центра Интернета вещей), ряд сертификатов, подписанных этим ЦС, и ЦС для устройства IOT Edge.

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

>[!NOTE]
>Термин "корневой ЦС", используемый в этой статье, относится к общедоступному центру сертификации цепочки PKI-сертификатов, а не к корню сертификата в центре сертификации. Во многих случаях это фактический открытый сертификат промежуточного ЦС. 

Шлюз представляет сертификат ЦС IoT Edge устройства для подчиненного устройства во время запуска подключения. Подчиненное устройство проверяет, подписан ли сертификат ЦС устройства IoT Edge сертификатом корневого ЦС. Этот процесс позволяет подчиненному устройству подтвердить, что шлюз поступает из надежного источника.

Следующие шаги описывают процесс создания сертификатов и их установки в нужных местах шлюза. Можно создать сертификаты с помощью любого компьютера и затем скопировать их на устройство IoT Edge. 

## <a name="prerequisites"></a>предварительным требованиям

* Компьютер разработки для создания сертификатов. 
* Устройство Azure IoT Edge, настраиваемое в качестве шлюза. Используйте IoT Edge шаги установки для одной из следующих операционных систем:
  * [Windows](how-to-install-iot-edge-windows.md)
  * [Linux](how-to-install-iot-edge-linux.md)

## <a name="generate-certificates-with-windows"></a>Создание сертификатов с помощью Windows

Выполните действия, описанные в этом разделе, чтобы создать тестовые сертификаты в Windows. Вы можете использовать компьютер Windows для создания сертификатов, а затем скопировать их на любое IoT Edge устройство, работающее в любой поддерживаемой операционной системе. 

Сертификаты, создаваемые в этом разделе, предназначены только для тестирования. 

### <a name="install-openssl"></a>Установка OpenSSL

Установите OpenSSL для Windows на компьютере, который используется для создания сертификатов. Если на устройстве Windows уже установлен OpenSSL, этот шаг можно пропустить, но убедитесь, что файл OpenSSL. exe доступен в переменной среды PATH. 

Существует несколько способов установки OpenSSL, включая следующие.

* **Проще:** Скачайте и установите все [сторонние двоичные файлы OpenSSL](https://wiki.openssl.org/index.php/Binaries), например, из [OpenSSL в SourceForge](https://sourceforge.net/projects/openssl/). Добавьте полный путь к файлу openssl.exe в переменную среды PATH. 
   
* **Рекомендуемый способ.** Скачайте исходный код OpenSSL и создайте двоичные файлы на компьютере самостоятельно или с помощью [vcpkg](https://github.com/Microsoft/vcpkg). В следующих инструкциях используется vcpkg для скачивания исходного кода, а также компиляции и установки OpenSSL на компьютере Windows с помощью простых действий.

   1. Перейдите в каталог для установки vcpkg. В дальнейшем он будет называться *\<VCPKGDIR>* . Следуйте указаниям, чтобы скачать и установить [vcpkg](https://github.com/Microsoft/vcpkg).
   
   2. После установки vcpkg выполните следующую команду в командной строке PowerShell, чтобы установить пакет OpenSSL для Windows x64. Обычно установка занимает около пяти минут.

      ```powershell
      .\vcpkg install openssl:x64-windows
      ```
   3. Добавьте `<VCPKGDIR>\installed\x64-windows\tools\openssl` в переменную среды PATH, чтобы сделать файл openssl.exe доступным для вызова.

### <a name="prepare-creation-scripts"></a>Подготовка скриптов создания

Репозиторий Azure IoT Edge Git содержит скрипты, которые можно использовать для создания тестовых сертификатов. В этом разделе вы создаете точную копию репозитория IoT Edge и выполняете скрипты. 

1. Откройте окно PowerShell с правами администратора. 

2. Клонируйте репозиторий Git, который содержит скрипты для создания сертификатов, не являющихся рабочими. Эти скрипты помогут создать необходимые сертификаты для настройки прозрачного шлюза. Используйте команду `git clone` или [скачайте ZIP-файл](https://github.com/Azure/iotedge/archive/master.zip). 

   ```powershell
   git clone https://github.com/Azure/iotedge.git
   ```

3. Перейдите в каталог, в котором вы планируете работать. В этой статье мы назовем этот каталог *\<вркдир >* . Все сертификаты и ключи будут созданы в этом рабочем каталоге.

4. Скопируйте файлы конфигурации и скриптов из клонированного репозитория в рабочий каталог. 

   ```powershell
   copy <path>\iotedge\tools\CACertificates\*.cnf .
   copy <path>\iotedge\tools\CACertificates\ca-certs.ps1 .
   ```

   Если репозиторий был скачан как ZIP-файл, то имя папки будет `iotedge-master`, а остальная часть пути будет одинаковой. 
<!--
5. Set environment variable OPENSSL_CONF to use the openssl_root_ca.cnf configuration file.

    ```powershell
    $env:OPENSSL_CONF = "$PWD\openssl_root_ca.cnf"
    ```
-->
5. Включите PowerShell для выполнения скриптов.

   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
   ```

7. Перенесите функции, используемые скриптами, в глобальное пространство имен PowerShell.
   
   ```powershell
   . .\ca-certs.ps1
   ```

   В окне PowerShell отобразится предупреждение о том, что сертификаты, созданные этим сценарием, предназначены только для тестирования и не должны использоваться в рабочих сценариях.

8. Убедитесь, что OpenSSL установлен правильно, и убедитесь в отсутствии конфликтов имен с существующими сертификатами. При возникновении проблем сценарий должен описывать способы их устранения.

   ```powershell
   Test-CACertsPrerequisites
   ```

### <a name="create-certificates"></a>Создание сертификатов

В этом разделе мы создадим три сертификата, а затем соединим их в цепочку. Размещение сертификатов в файле цепочки позволяет легко установить их на устройстве шлюза IoT Edge и любых подчиненных устройствах.  

1. Создайте сертификат корневого ЦС и подпишите один промежуточный сертификат. Все сертификаты помещаются в рабочий каталог.

   ```powershell
   New-CACertsCertChain rsa
   ```

   Эта команда сценария создает несколько файлов сертификатов и ключей, но мы будем ссылаться на них в частности, далее в этой статье:
   * `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

2. Создайте сертификат ЦС устройства IoT Edge и закрытый ключ с помощью следующей команды. Укажите имя сертификата ЦС, например **меджедевицека**. Имя используется для именования файлов и во время создания сертификата. 

   ```powershell
   New-CACertsEdgeDeviceCA "MyEdgeDeviceCA"
   ```

   Эта команда скрипта создает несколько файлов сертификатов и ключей, включая два, которые мы будем называть далее в этой статье:
   * `<WRKDIR>\certs\iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem`
   * `<WRKDIR>\private\iot-edge-device-ca-MyEdgeDeviceCA.key.pem`

   >[!TIP]
   >Если указать имя, отличное от **меджедевицека**, то сертификаты и ключи, созданные этой командой, будут отражать это имя. 

Теперь, когда у вас есть сертификаты, перейдите к [установке сертификатов на шлюзе](#install-certificates-on-the-gateway) .

## <a name="generate-certificates-with-linux"></a>Создание сертификатов с помощью Linux

Выполните действия, описанные в этом разделе, чтобы создать тестовые сертификаты в Linux. Вы можете использовать компьютер Linux для создания сертификатов, а затем скопировать их на любое IoT Edge устройство, работающее в любой поддерживаемой операционной системе. 

Сертификаты, создаваемые в этом разделе, предназначены только для тестирования. 

### <a name="prepare-creation-scripts"></a>Подготовка скриптов создания

Репозиторий Azure IoT Edge Git содержит скрипты, которые можно использовать для создания тестовых сертификатов. В этом разделе вы создаете точную копию репозитория IoT Edge и выполняете скрипты. 

1. Клонируйте репозиторий Git, который содержит скрипты для создания сертификатов, не являющихся рабочими. Эти скрипты помогут создать необходимые сертификаты для настройки прозрачного шлюза. 

   ```bash
   git clone https://github.com/Azure/iotedge.git
   ```

2. Перейдите в каталог, в котором вы планируете работать. Мы будем называть этот каталог по всей статье как *\<вркдир >* . Все файлы сертификатов и ключей будут созданы в этом каталоге.
  
3. Скопируйте файлы конфигурации и скрипты из клонированного IoT Edge репозитория в рабочий каталог.

   ```bash
   cp <path>/iotedge/tools/CACertificates/*.cnf .
   cp <path>/iotedge/tools/CACertificates/certGen.sh .
   ```

<!--
4. Configure OpenSSL to generate certificates using the provided script. 

   ```bash
   chmod 700 certGen.sh 
   ```
-->

### <a name="create-certificates"></a>Создание сертификатов

В этом разделе мы создадим три сертификата, а затем соединим их в цепочку. Размещение сертификатов в файле цепочки позволяет легко установить их на устройстве шлюза IoT Edge и любых подчиненных устройствах.  

1. Создайте сертификат корневого ЦС и один промежуточный сертификат. Эти сертификаты помещаются в каталог *\<WRKDIR>* .

   Если вы уже создали корневые и промежуточные сертификаты в этом рабочем каталоге, не выполняйте этот сценарий еще раз. При повторном запуске этого скрипта существующие сертификаты будут перезаписаны. Вместо этого перейдите к следующему шагу. 

   ```bash
   ./certGen.sh create_root_and_intermediate
   ```

   Скрипт создает несколько сертификатов и ключей. Запишите его, который мы будем использовать в следующем разделе:
   * `<WRKDIR>/certs/azure-iot-test-only.root.ca.cert.pem`

2. Создайте сертификат ЦС устройства IoT Edge и закрытый ключ с помощью следующей команды. Укажите имя сертификата ЦС, например **меджедевицека**. Имя используется для именования файлов и во время создания сертификата. 

   ```bash
   ./certGen.sh create_edge_device_ca_certificate "MyEdgeDeviceCA"
   ```

   Скрипт создает несколько сертификатов и ключей. Обратите внимание на два, которые мы будем называть в следующем разделе: 
   * `<WRKDIR>/certs/iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem`
   * `<WRKDIR>/private/iot-edge-device-ca-MyEdgeDeviceCA.key.pem`

   >[!TIP]
   >Если указать имя, отличное от **меджедевицека**, то сертификаты и ключи, созданные этой командой, будут отражать это имя. 

## <a name="install-certificates-on-the-gateway"></a>Установка сертификатов в шлюзе

Теперь, когда мы создали цепочку сертификатов, необходимо установить ее на устройство шлюза IoT Edge и настроить среду выполнения IoT Edge с указанием ссылки на новые сертификаты. 

1. Скопируйте следующие файлы из каталога *\<WRKDIR>* . Сохраните их в любом расположении на устройстве IoT Edge. Каталог назначения на устройстве IoT Edge мы будем называть *\<CERTDIR>* . 

   * Сертификат ЦС устройства — `<WRKDIR>\certs\iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem`.
   * Закрытый ключ ЦС устройства — `<WRKDIR>\private\iot-edge-device-ca-MyEdgeDeviceCA.key.pem`.
   * Корневой ЦС — `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

   Для перемещения файлов сертификатов можно использовать службу, такую как [Azure Key Vault](https://docs.microsoft.com/azure/key-vault) , или функцию, например [протокол безопасного копирования](https://www.ssh.com/ssh/scp/) .  Если сертификаты созданы на самом устройстве IoT Edge, этот шаг можно пропустить и использовать путь к рабочему каталогу.

2. Откройте файл конфигурации управляющей программы безопасности IoT Edge. 

   * Windows: `C:\ProgramData\iotedge\config.yaml`
   * Linux: `/etc/iotedge/config.yaml`

3. Задайте для свойств **сертификата** в файле config. YAML полный путь к сертификату и файлам ключей на устройстве IOT Edge. Удалите символ `#` перед свойствами сертификата, чтобы раскомментировать четыре строки. Помните, что отступы в YAML — это два пробела.

   * Windows:

      ```yaml
      certificates:
        device_ca_cert: "<CERTDIR>\\certs\\iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem"
        device_ca_pk: "<CERTDIR>\\private\\iot-edge-device-ca-MyEdgeDeviceCA.key.pem"
        trusted_ca_certs: "<CERTDIR>\\certs\\azure-iot-test-only.root.ca.cert.pem"
      ```
   
   * Linux: 
      ```yaml
      certificates:
        device_ca_cert: "<CERTDIR>/certs/iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem"
        device_ca_pk: "<CERTDIR>/private/iot-edge-device-ca-MyEdgeDeviceCA.key.pem"
        trusted_ca_certs: "<CERTDIR>/certs/azure-iot-test-only.root.ca.cert.pem"
      ```

4. На устройствах Linux убедитесь, что у пользователя **iotedge** есть разрешения на чтение каталога, в котором хранятся сертификаты. 

## <a name="deploy-edgehub-to-the-gateway"></a>Развертывание модуля EdgeHub в шлюзе

При первой установке IoT Edge на устройстве автоматически запускается только один системный модуль: агент IoT Edge. Для работы устройства в качестве шлюза потребуются оба системных модуля. Если вы еще не развернули модули на устройстве шлюза, создайте начальное развертывание для устройства, чтобы запустить второй системный модуль, концентратор IoT Edge. Развертывание будет пустым, так как в мастере не будут добавляться модули, но это позволит убедиться в том, что оба системных модуля работают. 

Проверить, какие модули выполняются на устройстве, можно с помощью команды `iotedge list`. Если список возвращает только модуль **edgeAgent** без **edgeHub**, выполните следующие действия.

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Перейдите к **IoT Edge** и выберите устройство IoT Edge, которое нужно использовать в качестве шлюза.

3. Щелкните **Set Modules** (Настроить модули).

4. Нажмите кнопку **Далее**.

5. На странице **Укажите маршруты** необходимо настроить маршрут по умолчанию для отправки всех сообщений из всех модулей в Центр Интернета вещей. Если такого маршрута нет, добавьте приведенный ниже код, а затем щелкните **Далее**.

   ```JSON
   {
       "routes": {
           "route": "FROM /* INTO $upstream"
       }
   }
   ```

6. На странице **Review template** (Проверка шаблона) щелкните **Отправить**.

## <a name="open-ports-on-gateway-device"></a>Открытие портов на устройстве шлюза

Для стандартных устройств IoT Edge не требуется выполнять какие-либо входящие подключения, так как все связи с центром Интернета вещей выполняются через исходящие подключения. Устройства шлюза отличаются, так как они должны принимать сообщения со своих нижестоящих устройств. Если брандмауэр находится между подчиненными устройствами и устройством шлюза, связь также должна быть возможна через брандмауэр.

Чтобы сценарий шлюза работал, по крайней мере один из поддерживаемых протоколов концентратора IoT Edge должен быть открыт для входящего трафика от подчиненных устройств. Поддерживаемые протоколы: MQTT, AMQP и HTTPS. 

| Порт | Протокол |
| ---- | -------- |
| 8883 | MQTT |
| 5671 | AMQP |
| 443 | HTTPS <br> MQTT + WS <br> AMQP + WS | 

## <a name="route-messages-from-downstream-devices"></a>Маршрутизация сообщений с подчиненных устройств
Среда выполнения IoT Edge может маршрутизировать сообщения, отправляемые с подчиненных устройств. Например, сообщения, отправляемые модулями. Эта функция позволяет выполнять аналитику в модуле, работающем в шлюзе, перед отправкой данных в облако. 

В настоящее время маршрутизация сообщений, отправляемых подчиненными устройствами, заключается в дифференцировании их от сообщений, отправляемых модулями. Все сообщения, отправляемые модулями, в отличие от сообщений, отправляемых подчиненными устройствами, содержат системное свойство с именем **connectionModuleId**. Вы можете использовать предложение маршрута WHERE, чтобы исключить любые сообщения, содержащие это системное свойство. 

Ниже приведен пример маршрута, который отправляет сообщения с любого подчиненного устройства в модуль с именем `ai_insights`, а затем из `ai_insights` в центр Интернета вещей.

```json
{
    "routes":{
        "sensorToAIInsightsInput1":"FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO BrokeredEndpoint(\"/modules/ai_insights/inputs/input1\")", 
        "AIInsightsToIoTHub":"FROM /messages/modules/ai_insights/outputs/output1 INTO $upstream" 
    } 
}
```

Дополнительные сведения о маршрутизации сообщений см. в разделе [Объявление маршрутов](./module-composition.md#declare-routes).


## <a name="enable-extended-offline-operation"></a>Включить расширенную автономную операцию

Начиная с выпуска IoT Edge среды выполнения [версии 1.0.4](https://github.com/Azure/azure-iotedge/releases/tag/1.0.4) , устройство шлюза и подчиненные устройства, подключающиеся к нему, могут быть настроены для расширенной работы в автономном режиме. 

Благодаря этой возможности локальные модули или подчиненные устройства могут повторно пройти проверку подлинности на IoT Edge устройстве по мере необходимости и взаимодействовать друг с другом, используя сообщения и методы, даже если они отключены от центра Интернета вещей. Дополнительные сведения см. в разделе [Сведения о расширенных возможностях автономной работы устройств, модулей и дочерних устройств IoT Edge](offline-capabilities.md).

Чтобы включить расширенные возможности автономного режима, необходимо установить связь "родители-потомки" между устройством шлюза IoT Edge и подчиненными устройствами, которые будут подключаться к нему. Эти действия более подробно описаны в статье [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md).

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда у вас есть устройство IoT Edge, работающее в качестве прозрачного шлюза, необходимо настроить подчиненные устройства так, чтобы они доверяли шлюзу и отправляли ему сообщения. Продолжите [проверку подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md) , чтобы выполнить следующие действия в разделе Настройка сценария прозрачного шлюза. 
