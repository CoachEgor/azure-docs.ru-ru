---
title: Создание устройства прозрачного шлюза с помощью Azure IoT Edge | Документация Майкрософт
description: Использование устройства Azure IoT Edge в качестве прозрачного шлюза, позволяющего обрабатывать информацию из подчиненных устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 04/03/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
ms.openlocfilehash: e563e67b5e951b43e5782f8c845c8ec46ff3e9bb
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81687159"
---
# <a name="configure-an-iot-edge-device-to-act-as-a-transparent-gateway"></a>Настройка устройства IoT Edge в качестве прозрачного шлюза

В этой статье содержатся подробные инструкции по настройке устройства IoT Edge для работы в качестве прозрачного шлюза для взаимодействия других устройств с центром Интернета вещей. В этой статье используется термин *IOT Edge Gateway* для обозначения устройства IOT EDGE, настроенного в качестве прозрачного шлюза. Дополнительные сведения см. [в статье как можно использовать IOT Edge устройство в качестве шлюза](./iot-edge-as-gateway.md).

>[!NOTE]
>В данный момент:
>
> * устройства с поддержкой Edge не могут подключиться к шлюзам IoT Edge;
> * подчиненные устройства не поддерживают отправку файлов.

Существует три основных шага для настройки успешного подключения к прозрачному шлюзу. В этой статье рассматривается первый шаг:

1. **Устройство шлюза должно иметь возможность безопасного подключения к подчиненным устройствам, получать подключения от подчиненных устройств и маршрутизировать сообщения в соответствующее место назначения.**
2. Подчиненное устройство должно иметь удостоверение устройства, чтобы иметь возможность проходить проверку подлинности в центре Интернета вещей и взаимодействовать через его устройство шлюза. Дополнительные сведения см. в статье [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md).
3. Подчиненное устройство должно безопасно подключаться к устройству шлюза. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).

Чтобы устройство могло работать как шлюз, оно должно иметь возможность безопасного подключения к его подчиненным устройствам. Решение Azure IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы допускайте Подключение подчиненного устройства к IoT Edge устройству, выступающему в качестве прозрачного шлюза. Чтобы обеспечить приемлемую безопасность, подчиненное устройство должно подтвердить удостоверение устройства шлюза. Эта проверка удостоверения не позволяет устройствам подключаться к потенциально вредоносным шлюзам.

Подчиненным устройством в сценарии с прозрачным шлюзом может быть любое приложение или платформа с удостоверением, созданным с помощью облачной службы [центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub) . Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Для любых практических целей в качестве подчиненного устройства можно использовать даже приложение, запущенное на самом устройстве шлюза IoT Edge. Однако устройство IoT Edge не может быть переIoT Edge шлюза.

Вы можете создать любую инфраструктуру сертификата, обеспечивающую доверие, необходимое для топологии "устройство — шлюз". В этой статье мы предполагаем ту же настройку сертификата, которую вы использовали для включения [безопасности ЦС x. 509](../iot-hub/iot-hub-x509ca-overview.md) в центре Интернета вещей, которая включает сертификат ЦС x. 509, связанный с конкретным центром Интернета вещей (КОРНЕВой ЦС центра Интернета вещей), ряд сертификатов, подписанных этим ЦС, и ЦС для устройства IOT Edge.

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

>[!NOTE]
>Термин "корневой ЦС", используемый в этой статье, относится к общедоступному центру сертификации цепочки PKI-сертификатов, а не к корню сертификата в центре сертификации. Во многих случаях это фактический открытый сертификат промежуточного ЦС.

Управляющая программа IoT Edge безопасности использует сертификат ЦС устройства IoT Edge для подписи сертификата ЦС рабочей нагрузки, который, в свою очередь, подписывает сертификат сервера для центра IoT Edge. Шлюз представляет сертификат сервера для подчиненного устройства во время запуска подключения. Подчиненное устройство проверяет, является ли сертификат сервера частью цепочки сертификатов, которая объединяется с сертификатом корневого ЦС. Этот процесс позволяет подчиненному устройству подтвердить, что шлюз поступает из надежного источника. Дополнительные сведения см. в статье сведения [о том, как Azure IOT Edge использует сертификаты](iot-edge-certs.md).

Следующие шаги описывают процесс создания сертификатов и их установки в нужных местах шлюза. Можно создать сертификаты с помощью любого компьютера и затем скопировать их на устройство IoT Edge.

## <a name="prerequisites"></a>Предварительные условия

Устройство Azure IoT Edge, настроенное с помощью [рабочих сертификатов](how-to-manage-device-certificates.md).

## <a name="deploy-edgehub-to-the-gateway"></a>Развертывание edgeHub в шлюзе

При первой установке IoT Edge на устройстве автоматически запускается только один системный модуль: агент IoT Edge. После создания первого развертывания больше устройства также запускается второй системный модуль, IoT Edge концентратор.

Концентратор IoT Edge отвечает за получение входящих сообщений от подчиненных устройств и их маршрутизацию к следующему назначению. Если модуль **edgeHub** не запущен на вашем устройстве, создайте первоначальное развертывание для устройства. Развертывание будет пустым, так как вы не добавите модули, но убедитесь, что оба системных модуля работают.

Чтобы проверить, какие модули выполняются на устройстве, проверьте сведения об устройстве в портал Azure, просмотрите состояние устройства в Visual Studio или Visual Studio Code или выполнив команду `iotedge list` на самом устройстве.

Если модуль **edgeAgent** работает без модуля **edgeHub** , выполните следующие действия.

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Перейдите к **IoT Edge** и выберите устройство IoT Edge, которое нужно использовать в качестве шлюза.

3. Выберите **задать модули**.

4. Выберите **Далее**.

5. На странице **Укажите маршруты** необходимо настроить маршрут по умолчанию для отправки всех сообщений из всех модулей в Центр Интернета вещей. Если такого маршрута нет, добавьте приведенный ниже код, а затем щелкните **Далее**.

   ```JSON
   {
       "routes": {
           "route": "FROM /messages/* INTO $upstream"
       }
   }
   ```

6. На странице **Review template** (Проверка шаблона) щелкните **Отправить**.

## <a name="open-ports-on-gateway-device"></a>Открытие портов на устройстве шлюза

Для стандартных устройств IoT Edge не требуется выполнять какие-либо входящие подключения, так как все связи с центром Интернета вещей выполняются через исходящие подключения. Устройства шлюза отличаются, так как они должны принимать сообщения со своих нижестоящих устройств. Если брандмауэр находится между подчиненными устройствами и устройством шлюза, связь также должна быть возможна через брандмауэр.

Чтобы сценарий шлюза работал, по крайней мере один из поддерживаемых протоколов концентратора IoT Edge должен быть открыт для входящего трафика от подчиненных устройств. Поддерживаемые протоколы: MQTT, AMQP, HTTPS, MQTT через WebSockets и AMQP через WebSockets.

| Порт | Протокол |
| ---- | -------- |
| 8883 | MQTT |
| 5671 | AMQP |
| 443 | HTTPS <br> MQTT + WS <br> AMQP + WS |

## <a name="route-messages-from-downstream-devices"></a>Маршрутизация сообщений с подчиненных устройств

Среда выполнения IoT Edge может маршрутизировать сообщения, отправляемые с подчиненных устройств. Например, сообщения, отправляемые модулями. Эта функция позволяет выполнять аналитику в модуле, работающем в шлюзе, перед отправкой данных в облако.

В настоящее время маршрутизация сообщений, отправляемых подчиненными устройствами, заключается в дифференцировании их от сообщений, отправляемых модулями. Все сообщения, отправляемые модулями, в отличие от сообщений, отправляемых подчиненными устройствами, содержат системное свойство с именем **connectionModuleId**. Вы можете использовать предложение маршрута WHERE, чтобы исключить любые сообщения, содержащие это системное свойство.

Ниже приведен пример маршрута, который отправляет сообщения с любого подчиненного устройства в модуль с именем `ai_insights`, а затем из `ai_insights` в центр Интернета вещей.

```json
{
    "routes":{
        "sensorToAIInsightsInput1":"FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO BrokeredEndpoint(\"/modules/ai_insights/inputs/input1\")",
        "AIInsightsToIoTHub":"FROM /messages/modules/ai_insights/outputs/output1 INTO $upstream"
    }
}
```

Дополнительные сведения о маршрутизации сообщений см. в разделе [Объявление маршрутов](./module-composition.md#declare-routes).

## <a name="enable-extended-offline-operation"></a>Включить расширенную автономную операцию

Начиная с выпуска IoT Edge среды выполнения [версии 1.0.4](https://github.com/Azure/azure-iotedge/releases/tag/1.0.4) , устройство шлюза и подчиненные устройства, подключающиеся к нему, могут быть настроены для расширенной работы в автономном режиме.

Благодаря этой возможности локальные модули или подчиненные устройства могут повторно пройти проверку подлинности с помощью устройства IoT Edge и взаимодействовать друг с другом, используя сообщения и методы, даже если они отключены от центра Интернета вещей. Дополнительные сведения см. в разделе [Сведения о расширенных возможностях автономной работы устройств, модулей и дочерних устройств IoT Edge](offline-capabilities.md).

Чтобы включить расширенные возможности автономного режима, необходимо установить связь "родители-потомки" между устройством шлюза IoT Edge и подчиненными устройствами, которые будут подключаться к нему. Эти действия более подробно описаны в статье [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md).

## <a name="next-steps"></a>Дальнейшие шаги

Теперь, когда у вас есть устройство IoT Edge, работающее в качестве прозрачного шлюза, необходимо настроить подчиненные устройства так, чтобы они доверяли шлюзу и отправляли ему сообщения. Продолжите [проверку подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md) , чтобы выполнить следующие действия в разделе Настройка сценария прозрачного шлюза.
