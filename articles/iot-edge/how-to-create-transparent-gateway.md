---
title: Создание устройства прозрачного шлюза с помощью Azure IoT Edge | Документация Майкрософт
description: Использование устройства Azure IoT Edge в качестве прозрачного шлюза, позволяющего обрабатывать информацию из подчиненных устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/30/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 6069e0782f69d0dfb73d9be2998cbb11d59d7d22
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79529175"
---
# <a name="configure-an-iot-edge-device-to-act-as-a-transparent-gateway"></a>Настройка устройства IoT Edge в качестве прозрачного шлюза

В этой статье содержатся подробные инструкции по настройке устройства IoT Edge для работы в качестве прозрачного шлюза для связи других устройств с IoT Hub. В этой статье используется термин *IoT Edge gateway* для обозначения устройства IoT Edge, настроенного как прозрачный шлюз. Для получения дополнительной информации см., [как устройство IoT Edge может быть использовано в качестве шлюза.](./iot-edge-as-gateway.md)

>[!NOTE]
>В данный момент:
>
> * устройства с поддержкой Edge не могут подключиться к шлюзам IoT Edge;
> * подчиненные устройства не поддерживают отправку файлов.

Существует три общих шага для создания успешного прозрачного подключения шлюза. Эта статья охватывает первый шаг:

1. **Устройство шлюза должно быть в состоянии безопасно подключаться к устройствам, расположенным ниже по течению, получать сообщения с устройств вниз по течению и направлять сообщения в нужное место назначения.**
2. Устройство ниже по течению должно иметь идентификатор устройства, чтобы иметь возможность аутентифицировать с Помощью IoT Hub, и знать, общаться через его устройство шлюза. Для получения дополнительной информации [см.](how-to-authenticate-downstream-device.md)
3. Устройство ниже по течению должно безопасно подключиться к устройству шлюза. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).

Чтобы устройство функционировало как шлюз, оно должно быть в состоянии безопасно подключиться к устройствам ниже по течению. Решение Azure IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы разрешаем подчиненному устройству подключаться к устройству IoT Edge, выполняющему роль прозрачного шлюза. Для обеспечения разумной безопасности устройство ниже по течению должно подтвердить личность устройства шлюза. Эта проверка личности предотвращает подключение устройств к потенциально вредоносным шлюзам.

Устройством ниже по течению в прозрачном сценарии шлюза может быть любое приложение или платформа, которая имеет интакт, созданный с помощью облачного сервиса [Azure IoT Hub.](https://docs.microsoft.com/azure/iot-hub) Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Для любых практических целей в качестве подчиненного устройства можно использовать даже приложение, запущенное на самом устройстве шлюза IoT Edge. Однако устройство IoT Edge не может быть ниже по течению шлюза IoT Edge.

Вы можете создать любую инфраструктуру сертификата, обеспечивающую доверие, необходимое для топологии "устройство — шлюз". В этой статье мы предполагаем ту же настройку сертификата, что вы будете использовать для включения [X.509 CA безопасности](../iot-hub/iot-hub-x509ca-overview.md) в IoT концентратор, который включает в себя сертификат X.509 CA, связанный с конкретным концентратором IoT (Концентратор IoT root CA), серию сертификатов, подписанных с этим CA, и CA для устройства IoT Edge.

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

>[!NOTE]
>Термин "root CA", используемый в этой статье, относится к верхнему государственному сертификату в цепочке сертификатов PKI, а не обязательно к корне сертификата синдицированного сертификата. Во многих случаях это фактически промежуточный публичный сертификат CA.

Шлюз представляет сертификат CA устройства IoT Edge на устройство ниже по течению во время запуска соединения. Устройство ниже по течению проверяет, чтобы убедиться, что сертификат CA устройства IoT Edge подписан сертификатом root CA. Этот процесс позволяет устройству вниз по течению подтвердить, что шлюз исходит от надежного источника.

Следующие шаги проходят через процесс создания сертификатов и установки их в нужных местах на шлюзе. Можно создать сертификаты с помощью любого компьютера и затем скопировать их на устройство IoT Edge.

## <a name="prerequisites"></a>Предварительные требования

Устройство Azure IoT Edge, настроенное с [производственными сертификатами.](how-to-manage-device-certificates.md)

## <a name="deploy-edgehub-to-the-gateway"></a>Развертывание edgeHub к шлюзу

При первой установке IoT Edge на устройство автоматически запускается только один системный модуль: агент IoT Edge. После создания первого развертывания больше устройства, второй модуль системы, концентратор IoT Edge, также запускается.

Концентратор IoT Edge отвечает за получение входящих сообщений с устройств ниже по течению и их направление в следующий пункт назначения. Если модуль **edgeHub** не работает на устройстве, создайте начальное развертывание для вашего устройства. Развертывание будет выглядеть пустым, потому что вы не добавляете никаких модулей, но это будет убедиться, что оба системных модуля работают.

Вы можете проверить, какие модули работают на устройстве, проверяя его детали устройства на портале Azure, `iotedge list` просматривая состояние устройства в Visual Studio или Visual Studio Code или запустив команду на самом устройстве.

Если модуль **edgeAgent** работает без модуля **edgeHub,** используйте следующие шаги:

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Перейдите к **IoT Edge** и выберите устройство IoT Edge, которое нужно использовать в качестве шлюза.

3. Выберите **набор модулей.**

4. Нажмите кнопку **Далее**.

5. На странице **Укажите маршруты** необходимо настроить маршрут по умолчанию для отправки всех сообщений из всех модулей в Центр Интернета вещей. Если такого маршрута нет, добавьте приведенный ниже код, а затем щелкните **Далее**.

   ```JSON
   {
       "routes": {
           "route": "FROM /messages/* INTO $upstream"
       }
   }
   ```

6. На странице **Review template** (Проверка шаблона) щелкните **Отправить**.

## <a name="open-ports-on-gateway-device"></a>Открыть порты на устройстве шлюза

Устройства Standard IoT Edge не нуждаются в входящих подключениях для работы, так как вся связь с IoT Hub осуществляется через исходящие соединения. Устройства шлюза отличаются тем, что им необходимо получать сообщения со своих устройств ниже по течению. Если брандмауэр находится между устройствами вниз по течению и устройством шлюза, то связь должна быть возможной и через брандмауэр.

Для работы сценария шлюза, по крайней мере один из поддерживаемых протоколов концентратора IoT Edge должен быть открыт для входящего трафика с устройств вниз по течению. Поддерживаемые протоколы: МЗТТ, АМЗП, HTTPS, МЗТТ над WebSockets и АМЗП над WebSockets.

| Порт | Протокол |
| ---- | -------- |
| 8883 | MQTT |
| 5671 | AMQP |
| 443 | HTTPS <br> МЗТТ-ВС <br> АМЗПЗВ |

## <a name="route-messages-from-downstream-devices"></a>Маршрутизация сообщений с подчиненных устройств

Среда выполнения IoT Edge может маршрутизировать сообщения, отправляемые с подчиненных устройств. Например, сообщения, отправляемые модулями. Эта функция позволяет выполнять аналитику в модуле, работаемом на шлюзе, прежде чем отправлять какие-либо данные в облако.

В настоящее время маршрутизация сообщений, отправляемых подчиненными устройствами, заключается в дифференцировании их от сообщений, отправляемых модулями. Все сообщения, отправляемые модулями, в отличие от сообщений, отправляемых подчиненными устройствами, содержат системное свойство с именем **connectionModuleId**. Вы можете использовать предложение маршрута WHERE, чтобы исключить любые сообщения, содержащие это системное свойство.

Ниже маршрут является примером, который будет отправлять сообщения от `ai_insights`любого `ai_insights` устройства вниз по течению к модулю с именем , а затем из IoT концентратор.

```json
{
    "routes":{
        "sensorToAIInsightsInput1":"FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO BrokeredEndpoint(\"/modules/ai_insights/inputs/input1\")",
        "AIInsightsToIoTHub":"FROM /messages/modules/ai_insights/outputs/output1 INTO $upstream"
    }
}
```

Дополнительные сведения о маршрутизации сообщений см. в разделе [Объявление маршрутов](./module-composition.md#declare-routes).

## <a name="enable-extended-offline-operation"></a>Включить расширенную работу в автономном режиме

Начиная с [выпуска v1.0.4](https://github.com/Azure/azure-iotedge/releases/tag/1.0.4) времени выполнения IoT Edge, устройство шлюза и устройства вниз по течению, подключающиеся к нему, могут быть настроены для расширенной автономной работы.

С помощью этой возможности локальные модули или устройства ниже по течению могут по мере необходимости вновь аутентифицировать сясустройство IoT Edge и общаться друг с другом с помощью сообщений и методов, даже при отключении от концентратора IoT. Дополнительные сведения см. в разделе [Сведения о расширенных возможностях автономной работы устройств, модулей и дочерних устройств IoT Edge](offline-capabilities.md).

Для включения расширенных возможностей автономного общения вы устанавливаете отношения между устройством шлюза IoT Edge и устройствами ниже по течению, которые будут подключаться к нему. Эти шаги более подробно описаны в [Authenticate ниже по течению устройства Azure IoT концентратор](how-to-authenticate-downstream-device.md).

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда у вас есть устройство IoT Edge, работающее в качестве прозрачного шлюза, необходимо настроить подчиненные устройства так, чтобы они доверяли шлюзу и отправляли ему сообщения. Продолжить проверку [подлинности устройства ниже по течению к концентратору Azure IoT](how-to-authenticate-downstream-device.md) для дальнейших шагов в настройке прозрачного сценария шлюза.
