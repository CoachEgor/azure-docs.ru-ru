---
title: Создание устройства прозрачного шлюза с помощью Azure IoT Edge | Документация Майкрософт
description: Использование устройства Azure IoT Edge в качестве прозрачного шлюза, позволяющего обрабатывать информацию из подчиненных устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 04/23/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 722ee6197b467454818026c960e1ce0e5b39efb4
ms.sourcegitcommit: 37343b814fe3c95f8c10defac7b876759d6752c3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/24/2019
ms.locfileid: "63766319"
---
# <a name="configure-an-iot-edge-device-to-act-as-a-transparent-gateway"></a>Настройка устройства IoT Edge в качестве прозрачного шлюза

В этой статье приведены подробные инструкции по настройке устройств IoT Edge в качестве прозрачного шлюза для взаимодействия других устройств с Центром Интернета вещей. В этой статье под термином *шлюз IoT Edge* подразумевается устройство IoT Edge, которое используется в качестве прозрачного шлюза. Дополнительные сведения см. в разделе [как устройства IoT Edge может использоваться в качестве шлюза](./iot-edge-as-gateway.md).

>[!NOTE]
>В данный момент:
> * если шлюз не подключен к Центру Интернета вещей, подчиненные устройства не смогут выполнить аутентификацию с помощью шлюза;
> * устройства с поддержкой Edge не могут подключиться к шлюзам IoT Edge; 
> * подчиненные устройства не поддерживают отправку файлов.

Чтобы устройство могло функционировать в качестве шлюза, оно должно иметь возможность безопасно подключаться к подчиненным устройствам. Решение Azure IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы разрешаем подчиненному устройству подключаться к устройству IoT Edge, выполняющему роль прозрачного шлюза. Чтобы обеспечить достаточный уровень безопасность, подчиненное устройство должно подтвердить удостоверение устройства IoT Edge. Требуется, чтобы ваши устройства, подключающиеся к только шлюзах, не все потенциально вредоносных шлюзы.

Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Для любых практических целей в качестве подчиненного устройства можно использовать даже приложение, запущенное на самом устройстве шлюза IoT Edge. 

Вы можете создать любую инфраструктуру сертификата, обеспечивающую доверие, необходимое для топологии "устройство — шлюз". В этой статье мы предполагаем же конфигурация сертификата, который используется для включения [безопасности ЦС X.509](../iot-hub/iot-hub-x509ca-overview.md) в центре Интернета вещей, который включает в себя сертификат ЦС X.509, связанного с определенным центром Интернета вещей (IoT ЦС владельца центра), а также ряда сертификатов, подписанные этим ЦС и ЦС для устройства IoT Edge.

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

Шлюз предоставляет его Edge Интернета вещей устройства ЦС сертификат подчиненного устройства во время инициации подключения. Подчиненное устройство проверяет, чтобы убедиться в том, что сертификат ЦС устройства IoT Edge подписанный сертификат ЦС владельца. В результате этого процесса подчиненное устройство получает подтверждение о том, что шлюз предоставлен надежным источником.

Ниже приведены пошаговые инструкции по созданию сертификатов и их установке в нужных расположениях.

## <a name="prerequisites"></a>Технические условия

Устройство Azure IoT Edge, настраиваемое в качестве шлюза. Используйте действия по установке IoT Edge для следующих операционных систем:
* [Windows](./how-to-install-iot-edge-windows.md)
* [Linux x64](./how-to-install-iot-edge-linux.md)
* [Linux ARM32](./how-to-install-iot-edge-linux-arm.md)

Можно создать сертификаты с помощью любого компьютера и затем скопировать их на устройство IoT Edge.

>[!NOTE]
>«Имя шлюза» используется для создания сертификатов в данной инструкции необходимо совпадает с именем используется как имя узла в файле config.yaml IoT Edge и как GatewayHostName в строке подключения подчиненного устройства. «Имя шлюза» должно разрешаться в IP-адрес, с помощью DNS или записи файла host. Связи на основе протокола используется (MQTTS:8883 / AMQPS:5671 / HTTPS:433) должен быть между подчиненное устройство и прозрачным IoT Edge. Если используется брандмауэр между ними, соответствующие порт должен быть открыт.

## <a name="generate-certificates-with-windows"></a>Создание сертификатов с помощью Windows

Приведенные в этом разделе инструкции позволяют создать тестовые сертификаты на устройстве Windows. Эти действия можно использовать для создания сертификатов на устройстве Windows IoT Edge. Или можно создать сертификаты на компьютере разработки Windows и затем скопируйте их на любое устройство IoT Edge. 

Сертификаты, создаваемые в этом разделе, предназначены только для тестирования. 

### <a name="install-openssl"></a>Установка OpenSSL

Установите OpenSSL для Windows на компьютере, который используется для создания сертификатов. Установить OpenSSL можно несколькими способами.

   >[!NOTE]
   >Если на вашем устройстве Windows уже установлен пакет OpenSSL, этот шаг можно пропустить, но следует убедиться, что файл openssl.exe доступен в переменной среды PATH.

* **Простой способ.** Скачайте и установите любые [сторонние двоичные файлы OpenSS](https://wiki.openssl.org/index.php/Binaries), например из [этого проекта на SourceForge](https://sourceforge.net/projects/openssl/). Добавьте полный путь к файлу openssl.exe в переменную среды PATH. 
   
* **Рекомендуется:** Скачайте исходный код OpenSSL и создайте двоичные файлы на компьютере самостоятельно или с помощью [vcpkg](https://github.com/Microsoft/vcpkg). В следующих инструкциях используется vcpkg для скачивания исходного кода, а также компиляции и установки OpenSSL на компьютере Windows с помощью простых действий.

   1. Перейдите в каталог для установки vcpkg. В дальнейшем он будет называться *\<VCPKGDIR>*. Следуйте указаниям, чтобы скачать и установить [vcpkg](https://github.com/Microsoft/vcpkg).
   
   2. После установки vcpkg в командной строке PowerShell выполните следующую команду, чтобы установить пакет OpenSSL для Windows x64. Обычно установка занимает около пяти минут.

      ```powershell
      .\vcpkg install openssl:x64-windows
      ```
   3. Добавьте `<VCPKGDIR>\installed\x64-windows\tools\openssl` в переменную среды PATH, чтобы сделать файл openssl.exe доступным для вызова.

### <a name="prepare-creation-scripts"></a>Подготовка скриптов создания

Пакет SDK для устройств Azure IoT для C содержит скрипты, с помощью которых можно создать тестовые сертификаты. В этом разделе мы клонируем пакет SDK и настроим PowerShell.

1. Откройте окно PowerShell с правами администратора. 

2. Клонируйте репозиторий Git, который содержит скрипты для создания сертификатов, не являющихся рабочими. Эти скрипты помогут вам создать необходимые сертификаты для настройки прозрачного шлюза. Используйте команду `git clone` или [скачайте ZIP-файл](https://github.com/Azure/azure-iot-sdk-c/archive/master.zip). 

   ```powershell
   git clone https://github.com/Azure/azure-iot-sdk-c.git
   ```

3. Перейдите в каталог, в котором вы планируете работать. В дальнейшем он будет называться *\<WRKDIR>*.  Все файлы будут созданы в этом каталоге.

4. Скопируйте файлы конфигурации и скриптов в рабочий каталог. 

   ```powershell
   copy <path>\azure-iot-sdk-c\tools\CACertificates\*.cnf .
   copy <path>\azure-iot-sdk-c\tools\CACertificates\ca-certs.ps1 .
   ```

   Если вы скачали пакет SDK в виде ZIP-файла, то папка называется `azure-iot-sdk-c-master`, а остальная часть пути совпадает. 

5. Настройте переменную среды OPENSSL_CONF на использование файла конфигурации openssl_root_ca.cnf.

    ```powershell
    $env:OPENSSL_CONF = "$PWD\openssl_root_ca.cnf"
    ```

6. Включите PowerShell для выполнения скриптов.

   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
   ```

7. Добавьте используемые скриптами функции в глобальное пространство имен PowerShell.
   
   ```powershell
   . .\ca-certs.ps1
   ```

8. Убедитесь, что средство OpenSSL установлено правильно и не возникают конфликты имен с существующими сертификатами. При возникновении проблем сценарий должен описывать способы их устранения.

   ```powershell
   Test-CACertsPrerequisites
   ```

### <a name="create-certificates"></a>Создание сертификатов

В этом разделе мы создадим три сертификата, а затем соединим их в цепочку. Размещение сертификатов в файле цепочки позволяет легко установить их на устройстве шлюза IoT Edge и любых подчиненных устройствах.  

1. Создайте сертификат ЦС владельца и подпишите с его помощью один промежуточный сертификат. Все эти сертификаты помещаются в каталог *\<WRKDIR>*.

      ```powershell
      New-CACertsCertChain rsa
      ```

2. Создание Edge Интернета вещей устройства ЦС сертификат и закрытый ключ, выполнив следующую команду. Укажите имя для устройства шлюза, которое будет использоваться для именования файлов и во время создания сертификата. 

   ```powershell
   New-CACertsEdgeDevice "<gateway name>"
   ```

3. Создайте цепочку сертификатов от владельца сертификата ЦС, промежуточный сертификат и сертификат ЦС устройства IoT Edge с помощью следующей команды. 

   ```powershell
   Write-CACertsCertificatesForEdgeDevice "<gateway name>"
   ```

   Сценарий создает следующие сертификаты и ключ:
   * `<WRKDIR>\certs\new-edge-device.*`
   * `<WRKDIR>\private\new-edge-device.key.pem`
   * `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

## <a name="generate-certificates-with-linux"></a>Создание сертификатов с помощью Linux

Приведенные в этом разделе инструкции позволяют создать тестовые сертификаты на устройстве Linux. Можно создать сертификаты на самом устройстве IoT Edge или же использовать отдельный компьютер и скопировать конечные сертификаты на любое устройство IoT Edge под управлением любой поддерживаемой операционной системы. 

### <a name="prepare-creation-scripts"></a>Подготовка скриптов создания

1. Клонируйте репозиторий Git, который содержит скрипты для создания сертификатов, не являющихся рабочими. Эти скрипты помогут вам создать необходимые сертификаты для настройки прозрачного шлюза. 

   ```bash
   git clone https://github.com/Azure/azure-iot-sdk-c.git
   ```

2. Перейдите в каталог, в котором вы планируете работать. В дальнейшем он будет называться *\<WRKDIR>*.  Все файлы будут созданы в этом каталоге.
  
3. Скопируйте файлы конфигурации и скриптов в рабочий каталог.

   ```bash
   cp <path>/azure-iot-sdk-c/tools/CACertificates/*.cnf .
   cp <path>/azure-iot-sdk-c/tools/CACertificates/certGen.sh .
   ```

4. Настройте OpenSSL для создания сертификатов с помощью предоставленного скрипта. 

   ```bash
   chmod 700 certGen.sh 
   ```

### <a name="create-certificates"></a>Создание сертификатов

В этом разделе мы создадим три сертификата, а затем соединим их в цепочку. Размещение сертификатов в файле цепочки позволяет легко установить их на устройстве шлюза IoT Edge и любых подчиненных устройствах.  

1. Создайте сертификат ЦС владельца и один промежуточный сертификат. Эти сертификаты помещаются в каталог *\<WRKDIR>*.

   ```bash
   ./certGen.sh create_root_and_intermediate
   ```

   Скрипт создает следующие сертификаты и ключи:
   * `<WRKDIR>/certs/azure-iot-test-only.root.ca.cert.pem`
   * `<WRKDIR>/certs/azure-iot-test-only.intermediate.cert.pem`
   * `<WRKDIR>/private/azure-iot-test-only.root.ca.key.pem`
   * `<WRKDIR>/private/azure-iot-test-only.intermediate.key.pem`

2. Создание Edge Интернета вещей устройства ЦС сертификат и закрытый ключ, выполнив следующую команду. Укажите имя для устройства шлюза, которое будет использоваться для именования файлов и во время создания сертификата. 

   ```bash
   ./certGen.sh create_edge_device_certificate "<gateway name>"
   ```

   Сценарий создает следующие сертификаты и ключ:
   * `<WRKDIR>/certs/new-edge-device.*`
   * `<WRKDIR>/private/new-edge-device.key.pem`

3. Создать цепочку сертификатов, который называется **новый edge устройства full-chain.cert.pem** из сертификата ЦС владельца, промежуточный сертификат и сертификат ЦС устройство IoT Edge.

   ```bash
   cat ./certs/new-edge-device.cert.pem ./certs/azure-iot-test-only.intermediate.cert.pem ./certs/azure-iot-test-only.root.ca.cert.pem > ./certs/new-edge-device-full-chain.cert.pem
   ```

## <a name="install-certificates-on-the-gateway"></a>Установка сертификатов в шлюзе

Теперь, когда мы создали цепочку сертификатов, необходимо установить ее на устройство шлюза IoT Edge и настроить среду выполнения IoT Edge с указанием ссылки на новые сертификаты. 

1. Скопируйте следующие файлы из каталога *\<WRKDIR>*. Сохраните их в любом расположении на устройстве IoT Edge. Каталог назначения на устройстве IoT Edge мы будем называть *\<CERTDIR>*. 

   Если вы создали сертификаты на самом устройстве IoT Edge, можно пропустить этот шаг и использовать путь к рабочему каталогу.

   * Сертификат ЦС устройства — `<WRKDIR>\certs\new-edge-device-full-chain.cert.pem`.
   * Закрытый ключ ЦС устройства — `<WRKDIR>\private\new-edge-device.key.pem`.
   * ЦС владельца — `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`.

2. Откройте файл конфигурации управляющей программы безопасности IoT Edge. 

   * Windows: `C:\ProgramData\iotedge\config.yaml`
   * Linux: `/etc/iotedge/config.yaml`

3. В файле config.yaml в качестве свойств **certificate** укажите путь к каталогу на устройстве IoT Edge, в котором размещены файлы сертификатов и ключей.

   * Windows:

      ```yaml
      certificates:
        device_ca_cert: "<CERTDIR>\\certs\\new-edge-device-full-chain.cert.pem"
        device_ca_pk: "<CERTDIR>\\private\\new-edge-device.key.pem"
        trusted_ca_certs: "<CERTDIR>\\certs\\azure-iot-test-only.root.ca.cert.pem"
      ```
   
   * Linux: 
      ```yaml
      certificates:
        device_ca_cert: "<CERTDIR>/certs/new-edge-device-full-chain.cert.pem"
        device_ca_pk: "<CERTDIR>/private/new-edge-device.key.pem"
        trusted_ca_certs: "<CERTDIR>/certs/azure-iot-test-only.root.ca.cert.pem"
      ```

4. На устройствах Linux, убедитесь, что пользователь **iotedge** имеются необходимые разрешения для каталога, содержащий сертификаты. 

## <a name="deploy-edgehub-to-the-gateway"></a>Развертывание модуля EdgeHub в шлюзе

При первой установке IoT Edge на устройстве, системы только один модуль запускается автоматически: агент IoT Edge. Для работы устройства в качестве шлюза потребуются оба системных модуля. Если вы еще не развернули каких-либо модулей для устройства шлюза, прежде чем, создайте развертывание для устройства запустить второй модуль system, концентратор Edge Интернета вещей. Развертывание будет выглядеть пустым, так как в мастере не добавляются никакие модули, однако оба системных модуля будут развернуты. 

Проверить, какие модули выполняются на устройстве, можно с помощью команды `iotedge list`.

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Перейдите к **IoT Edge** и выберите устройство IoT Edge, которое нужно использовать в качестве шлюза.

3. Щелкните **Set Modules** (Настроить модули).

4. Щелкните **Далее**.

5. На странице **Укажите маршруты** необходимо настроить маршрут по умолчанию для отправки всех сообщений из всех модулей в Центр Интернета вещей. Если такого маршрута нет, добавьте приведенный ниже код, а затем щелкните **Далее**.

   ```JSON
   {
       "routes": {
           "route": "FROM /* INTO $upstream"
       }
   }
   ```

6. На странице **Review template** (Проверка шаблона) щелкните **Отправить**.

## <a name="open-ports-on-gateway-device"></a>Открытые порты на устройстве шлюза

Стандартные устройства IoT Edge не требуется исходящее подключение к функции, так как весь обмен данными с центром Интернета вещей выполняется с помощью исходящих подключений. Тем не менее шлюзы отличаются, так как они должны иметь возможность получать сообщения из их подчиненных устройств.

Для работы сценария шлюза по крайней мере один из поддерживаемых протоколов концентратора IoT Edge должны быть открыты для входящего трафика из подчиненных устройств. Поддерживаемые протоколы: MQTT, AMQP и HTTPS.

| Порт | Protocol |
| ---- | -------- |
| 8883 | MQTT |
| 5671 | AMQP |
| 443 | HTTPS <br> MQTT + WS <br> AMQP + WS | 

## <a name="route-messages-from-downstream-devices"></a>Маршрутизация сообщений с подчиненных устройств
Среда выполнения IoT Edge может маршрутизировать сообщения, отправляемые с подчиненных устройств. Например, сообщения, отправляемые модулями. Эта функция позволяет выполнять аналитику в модуле, запущенный на шлюзе отправку любых данных в облако. 

В настоящее время маршрутизация сообщений, отправляемых подчиненными устройствами, заключается в дифференцировании их от сообщений, отправляемых модулями. Все сообщения, отправляемые модулями, в отличие от сообщений, отправляемых подчиненными устройствами, содержат системное свойство с именем **connectionModuleId**. Вы можете использовать предложение маршрута WHERE, чтобы исключить любые сообщения, содержащие это системное свойство. 

Ниже представлен маршрут, по которому сообщения отправляются с любого подчиненного устройства на модуль `ai_insights`.

```json
{
    "routes":{
        "sensorToAIInsightsInput1":"FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO BrokeredEndpoint(\"/modules/ai_insights/inputs/input1\")", 
        "AIInsightsToIoTHub":"FROM /messages/modules/ai_insights/outputs/output1 INTO $upstream" 
    } 
}
```

Дополнительные сведения о маршрутизации сообщений см. в разделе [Объявление маршрутов](./module-composition.md#declare-routes).

[!INCLUDE [iot-edge-extended-ofline-preview](../../includes/iot-edge-extended-offline-preview.md)]

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда у вас есть устройство IoT Edge, работающее в качестве прозрачного шлюза, необходимо настроить подчиненные устройства так, чтобы они доверяли шлюзу и отправляли ему сообщения. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).
