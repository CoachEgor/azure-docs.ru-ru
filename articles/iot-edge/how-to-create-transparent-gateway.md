---
title: Создание устройства прозрачного шлюза с помощью Azure IoT Edge | Документация Майкрософт
description: Использование устройства Azure IoT Edge в качестве прозрачного шлюза, позволяющего обрабатывать информацию из подчиненных устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 06/07/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 5881adb7e2fc0d52cc2037d3d4a9e986b3e29d74
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67058379"
---
# <a name="configure-an-iot-edge-device-to-act-as-a-transparent-gateway"></a>Настройка устройства IoT Edge в качестве прозрачного шлюза

В этой статье приведены подробные инструкции по настройке устройства IoT Edge в качестве прозрачного шлюза для других устройств, для взаимодействия с центром Интернета вещей. В этой статье под термином *шлюз IoT Edge* подразумевается устройство IoT Edge, которое используется в качестве прозрачного шлюза. Дополнительные сведения см. в разделе [как устройства IoT Edge может использоваться в качестве шлюза](./iot-edge-as-gateway.md).

>[!NOTE]
>В данный момент:
> * устройства с поддержкой Edge не могут подключиться к шлюзам IoT Edge; 
> * подчиненные устройства не поддерживают отправку файлов.

Существует три общих действия для настройки подключения успешно прозрачного шлюза. В этой статье описывается первый этап:

1. **Шлюз должен иметь возможность безопасного подключения для подчиненных устройств, получать сообщения из подчиненных устройств и маршрутизировать сообщения нужному адресату.**
2. Подчиненное устройство должен иметь удостоверение устройства, чтобы иметь возможность проверки подлинности с помощью центра Интернета вещей и знать для обмена данными через его устройство шлюза. Дополнительные сведения см. в разделе [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md).
3. Подчиненное устройство необходимо иметь возможность безопасного подключения к его устройство шлюза. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).


Для устройства в качестве шлюза необходимо иметь возможность безопасно подключаться к его подчиненными устройствами. Решение Azure IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы разрешаем подчиненному устройству подключаться к устройству IoT Edge, выполняющему роль прозрачного шлюза. Чтобы обеспечить достаточный уровень безопасность, подчиненное устройство должно подтвердить удостоверение устройства шлюза. Эта проверка удостоверений не позволяет подключаться к небезопасному шлюзы устройств.

Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Часто для этих приложений применяется [пакет SDK для устройств Azure IoT](../iot-hub/iot-hub-devguide-sdks.md). Для любых практических целей в качестве подчиненного устройства можно использовать даже приложение, запущенное на самом устройстве шлюза IoT Edge. 

Вы можете создать любую инфраструктуру сертификата, обеспечивающую доверие, необходимое для топологии "устройство — шлюз". В этой статье мы предполагаем же конфигурация сертификата, который используется для включения [безопасности ЦС X.509](../iot-hub/iot-hub-x509ca-overview.md) в центре Интернета вещей, который включает в себя сертификат ЦС X.509, связанного с определенным центром Интернета вещей (IoT hub корневого ЦС), ряд сертификатов подписи с этим ЦС и ЦС для устройства IoT Edge.

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

>[!NOTE]
>Термин «корневой ЦС» используются в этой статье относится к верхний центра открытый сертификат цепочки сертификатов PKI, а не только корневому центру сертификации сводного сертификации. Во многих случаях это фактически промежуточный ЦС открытый сертификат. 

Шлюз предоставляет его Edge Интернета вещей устройства ЦС сертификат подчиненного устройства во время инициации подключения. Подчиненное устройство проверяет, чтобы убедиться в том, что сертификат ЦС устройства IoT Edge подписанный сертификат корневого ЦС. Этот процесс позволяет подчиненное устройство, чтобы убедиться, что шлюз поступает из надежного источника.

Ниже приведены инструкции по созданию сертификатов и устанавливать их в нужных местах на шлюзе. Можно создать сертификаты с помощью любого компьютера и затем скопировать их на устройство IoT Edge. 

## <a name="prerequisites"></a>Технические условия

Устройство Azure IoT Edge, настраиваемое в качестве шлюза. Используйте действия по установке IoT Edge для одного из следующих операционных систем:
  * [Windows](./how-to-install-iot-edge-windows.md)
  * [Linux x64](./how-to-install-iot-edge-linux.md)
  * [Linux ARM32](./how-to-install-iot-edge-linux-arm.md)

Эта статья относится к *имя узла шлюза* в нескольких точках. Имя узла шлюза объявляется в **hostname** параметр config.yaml файла на устройстве шлюза Edge Интернета вещей. Он используется для создания сертификатов в этой статье и упоминается в строке подключения для подчиненных устройств. Имя узла шлюза должен разрешаться в IP-адрес, с помощью DNS или записи файла host.

## <a name="generate-certificates-with-windows"></a>Создание сертификатов с помощью Windows

Следуйте инструкциям в этом разделе для создания проверочных сертификатов в Windows. Можно использовать компьютер Windows для создания сертификатов и затем скопировать их на любое устройство IoT Edge, под управлением любой поддерживаемой операционной системе. 

Сертификаты, создаваемые в этом разделе, предназначены только для тестирования. 

### <a name="install-openssl"></a>Установка OpenSSL

Установите OpenSSL для Windows на компьютере, который используется для создания сертификатов. При наличии OpenSSL, установленном на вашем устройстве Windows, могут пропустить этот шаг, но убедитесь, что этот openssl.exe доступен в переменную среды PATH. 

Установить OpenSSL можно несколькими способами.

* **Простой способ.** Скачать и установить любые [сторонние двоичные файлы OpenSSL](https://wiki.openssl.org/index.php/Binaries), например из [OpenSSL на SourceForge](https://sourceforge.net/projects/openssl/). Добавьте полный путь к файлу openssl.exe в переменную среды PATH. 
   
* **Рекомендуется:** Скачайте исходный код OpenSSL и создайте двоичные файлы на компьютере самостоятельно или с помощью [vcpkg](https://github.com/Microsoft/vcpkg). В следующих инструкциях используется vcpkg для скачивания исходного кода, а также компиляции и установки OpenSSL на компьютере Windows с помощью простых действий.

   1. Перейдите в каталог для установки vcpkg. В дальнейшем он будет называться *\<VCPKGDIR>* . Следуйте указаниям, чтобы скачать и установить [vcpkg](https://github.com/Microsoft/vcpkg).
   
   2. Vcpkg является счетом, выполните следующую команду в командной строке powershell для установки пакета OpenSSL для Windows x64. Обычно установка занимает около пяти минут.

      ```powershell
      .\vcpkg install openssl:x64-windows
      ```
   3. Добавьте `<VCPKGDIR>\installed\x64-windows\tools\openssl` в переменную среды PATH, чтобы сделать файл openssl.exe доступным для вызова.

### <a name="prepare-creation-scripts"></a>Подготовка скриптов создания

Репозиторий git Edge Интернета вещей Azure содержит скрипты, которые можно использовать для создания проверочных сертификатов. В этом разделе описано клонируйте репозиторий Edge Интернета вещей и выполнение сценариев. 

1. Откройте окно PowerShell с правами администратора. 

2. Клонируйте репозиторий Git, который содержит скрипты для создания сертификатов, не являющихся рабочими. Эти скрипты помогут вам создать необходимые сертификаты для настройки прозрачного шлюза. Используйте команду `git clone` или [скачайте ZIP-файл](https://github.com/Azure/iotedge/archive/master.zip). 

   ```powershell
   git clone https://github.com/Azure/iotedge.git
   ```

3. Перейдите в каталог, в котором вы планируете работать. В этой статье мы будем называть этот каталог  *\<WRKDIR >* . Все сертификаты и ключи будут создаваться в этом рабочем каталоге.

4. Скопируйте файлы конфигурации и скрипт из клонированного репозитория в рабочем каталоге. 

   ```powershell
   copy <path>\iotedge\tools\CACertificates\*.cnf .
   copy <path>\iotedge\tools\CACertificates\ca-certs.ps1 .
   ```

   Если вы загрузили репозитория, как ZIP-ФАЙЛ, то папка называется `iotedge-master` и остальная часть пути совпадает. 
<!--
5. Set environment variable OPENSSL_CONF to use the openssl_root_ca.cnf configuration file.

    ```powershell
    $env:OPENSSL_CONF = "$PWD\openssl_root_ca.cnf"
    ```
-->
5. Включите PowerShell для выполнения скриптов.

   ```powershell
   Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
   ```

7. Привносят функции, используемые сценариями в PowerShell глобальное пространство имен.
   
   ```powershell
   . .\ca-certs.ps1
   ```

   В окне PowerShell будут отображаться предупреждение сертификаты, созданные этим скриптом предназначены только для целей тестирования что не следует использовать в рабочих сценариях.

8. Убедитесь, что OpenSSL установлен правильно и убедитесь, что не будет конфликтов имен с помощью существующих сертификатов. При возникновении проблем сценарий должен описывать способы их устранения.

   ```powershell
   Test-CACertsPrerequisites
   ```

### <a name="create-certificates"></a>Создание сертификатов

В этом разделе мы создадим три сертификата, а затем соединим их в цепочку. Размещение сертификатов в файле цепочки позволяет легко установить их на устройстве шлюза IoT Edge и любых подчиненных устройствах.  

1. Создайте сертификат корневого ЦС, который будет входить один промежуточный сертификат. Все сертификаты помещаются в рабочем каталоге.

   ```powershell
   New-CACertsCertChain rsa
   ```

   Эта команда сценария создает несколько сертификат и файлы ключа, но мы будем ссылаться на один, в частности, далее в этой статье:
   * `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

2. Создание Edge Интернета вещей устройства ЦС сертификат и закрытый ключ, выполнив следующую команду. Укажите имя узла шлюза, который можно найти в файле iotedge\config.yaml на устройстве шлюза. Имя узла шлюза используется для именования файлов, а во время создания сертификата. 

   ```powershell
   New-CACertsEdgeDevice "<gateway hostname>"
   ```

   Эта команда сценария создает несколько сертификат и файлы ключа, включая два, который мы собираемся см. Далее в этой статье:
   * `<WRKDIR>\certs\iot-edge-device-<gateway hostname>-full-chain.cert.pem`
   * `<WRKDIR>\private\iot-edge-device-<gateway hostname>.key.pem`

Теперь, когда у вас есть сертификаты, сразу перейти к [установить сертификаты на шлюзе](#install-certificates-on-the-gateway)

## <a name="generate-certificates-with-linux"></a>Создание сертификатов с помощью Linux

Следуйте инструкциям в этом разделе для создания проверочных сертификатов в Linux. Можно использовать компьютер Linux для создания сертификатов и затем скопировать их на любое устройство IoT Edge, под управлением любой поддерживаемой операционной системе. 

Сертификаты, создаваемые в этом разделе, предназначены только для тестирования. 

### <a name="prepare-creation-scripts"></a>Подготовка скриптов создания

Репозиторий git Edge Интернета вещей Azure содержит скрипты, которые можно использовать для создания проверочных сертификатов. В этом разделе описано клонируйте репозиторий Edge Интернета вещей и выполнение сценариев. 

1. Клонируйте репозиторий Git, который содержит скрипты для создания сертификатов, не являющихся рабочими. Эти скрипты помогут вам создать необходимые сертификаты для настройки прозрачного шлюза. 

   ```bash
   git clone https://github.com/Azure/iotedge.git
   ```

2. Перейдите в каталог, в котором вы планируете работать. Мы будем называть этот каталог, в статье как  *\<WRKDIR >* . Все файлы сертификата и ключа будет создан в этом каталоге.
  
3. Скопируйте файлы конфигурации и скрипт из клонированного репозитория Edge Интернета вещей в рабочий каталог.

   ```bash
   cp <path>/iotedge/tools/CACertificates/*.cnf .
   cp <path>/iotedge/tools/CACertificates/certGen.sh .
   ```

<!--
4. Configure OpenSSL to generate certificates using the provided script. 

   ```bash
   chmod 700 certGen.sh 
   ```
-->

### <a name="create-certificates"></a>Создание сертификатов

В этом разделе мы создадим три сертификата, а затем соединим их в цепочку. Размещение сертификатов в файле цепочки позволяет легко установить их на устройстве шлюза IoT Edge и любых подчиненных устройствах.  

1. Создайте сертификат корневого ЦС и один промежуточный сертификат. Эти сертификаты помещаются в каталог *\<WRKDIR>* .

   ```bash
   ./certGen.sh create_root_and_intermediate
   ```

   Этот скрипт создает несколько сертификатов и ключей. Запишите один, который мы будем называть в следующем разделе:
   * `<WRKDIR>/certs/azure-iot-test-only.root.ca.cert.pem`

2. Создание Edge Интернета вещей устройства ЦС сертификат и закрытый ключ, выполнив следующую команду. Укажите имя узла шлюза, который можно найти в файле iotedge/config.yaml на устройстве шлюза. Имя узла шлюза используется для именования файлов, а во время создания сертификата. 

   ```bash
   ./certGen.sh create_edge_device_certificate "<gateway hostname>"
   ```

   Этот скрипт создает несколько сертификатов и ключей. Запишите двум, что мы будем называть в следующем разделе: 
   * `<WRKDIR>/certs/iot-edge-device-<gateway hostname>-full-chain.cert.pem`
   * `<WRKDIR>/private/iot-edge-device-<gateway hostname>.key.pem`

## <a name="install-certificates-on-the-gateway"></a>Установка сертификатов в шлюзе

Теперь, когда мы создали цепочку сертификатов, необходимо установить ее на устройство шлюза IoT Edge и настроить среду выполнения IoT Edge с указанием ссылки на новые сертификаты. 

1. Скопируйте следующие файлы из каталога *\<WRKDIR>* . Сохраните их в любом расположении на устройстве IoT Edge. Каталог назначения на устройстве IoT Edge мы будем называть *\<CERTDIR>* . 

   * Сертификат ЦС устройства — `<WRKDIR>\certs\iot-edge-device-<gateway hostname>-full-chain.cert.pem`.
   * Закрытый ключ ЦС устройства — `<WRKDIR>\private\iot-edge-device-<gateway hostname>.key.pem`.
   * Корневой ЦС — `<WRKDIR>\certs\azure-iot-test-only.root.ca.cert.pem`

   Можно использовать службу, например [Azure Key Vault](https://docs.microsoft.com/azure/key-vault) или функцией, такой как [протокол безопасного копирования](https://www.ssh.com/ssh/scp/) для перемещения файлов сертификатов.  Если вы создали сертификаты на самом устройстве IoT Edge, можно пропустить этот шаг и использовать путь к рабочему каталогу.

2. Откройте файл конфигурации управляющей программы безопасности IoT Edge. 

   * Windows: `C:\ProgramData\iotedge\config.yaml`
   * Linux: `/etc/iotedge/config.yaml`

3. Задайте **сертификат** свойств в файле config.yaml полный путь к файлам сертификат и ключ на устройстве IoT Edge. Удалить `#` символа перед свойства сертификата, чтобы Раскомментировать четыре строки. Помните, что отступы в yaml являются два пробела.

   * Windows:

      ```yaml
      certificates:
        device_ca_cert: "<CERTDIR>\\certs\\iot-edge-device-<gateway hostname>-full-chain.cert.pem"
        device_ca_pk: "<CERTDIR>\\private\\iot-edge-device-<gateway hostname>.key.pem"
        trusted_ca_certs: "<CERTDIR>\\certs\\azure-iot-test-only.root.ca.cert.pem"
      ```
   
   * Linux: 
      ```yaml
      certificates:
        device_ca_cert: "<CERTDIR>/certs/iot-edge-device-<gateway hostname>-full-chain.cert.pem"
        device_ca_pk: "<CERTDIR>/private/iot-edge-device-<gateway hostname>.key.pem"
        trusted_ca_certs: "<CERTDIR>/certs/azure-iot-test-only.root.ca.cert.pem"
      ```

4. На устройствах Linux, убедитесь, что пользователь **iotedge** имеются необходимые разрешения для каталога, содержащий сертификаты. 

## <a name="deploy-edgehub-to-the-gateway"></a>Развертывание модуля EdgeHub в шлюзе

При первой установке IoT Edge на устройстве, системы только один модуль запускается автоматически: агент IoT Edge. Для работы устройства в качестве шлюза потребуются оба системных модуля. Если вы еще не развернули каких-либо модулей для устройства шлюза, прежде чем, Создание первоначального развертывания для вашего устройства запустить второй модуль system, концентратор Edge Интернета вещей. Развертывание будет выглядеть пустой, поскольку вы не добавите все модули в мастере, но гарантирует выполнение обоих модулей системы. 

Проверить, какие модули выполняются на устройстве, можно с помощью команды `iotedge list`. Если список возвращает только модуль **edgeAgent** без **edgeHub**, выполните следующие действия:

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Перейдите к **IoT Edge** и выберите устройство IoT Edge, которое нужно использовать в качестве шлюза.

3. Щелкните **Set Modules** (Настроить модули).

4. Щелкните **Далее**.

5. На странице **Укажите маршруты** необходимо настроить маршрут по умолчанию для отправки всех сообщений из всех модулей в Центр Интернета вещей. Если такого маршрута нет, добавьте приведенный ниже код, а затем щелкните **Далее**.

   ```JSON
   {
       "routes": {
           "route": "FROM /* INTO $upstream"
       }
   }
   ```

6. На странице **Review template** (Проверка шаблона) щелкните **Отправить**.

## <a name="open-ports-on-gateway-device"></a>Открытые порты на устройстве шлюза

Стандартные устройства IoT Edge не требуется исходящее подключение к функции, так как весь обмен данными с центром Интернета вещей выполняется с помощью исходящих подключений. Шлюзы отличаются, так как им нужно получать сообщения из их подчиненных устройств. Если используется брандмауэр между подчиненными устройствами и устройством шлюза, затем необходима связь возможна через брандмауэр, а также.

Для работы сценария шлюза по крайней мере один из поддерживаемых протоколов концентратора IoT Edge должны быть открыты для входящего трафика из подчиненных устройств. Поддерживаемые протоколы: MQTT, AMQP и HTTPS. 

| Port | Протокол |
| ---- | -------- |
| 8883 | MQTT |
| 5671 | AMQP |
| 443 | HTTPS <br> MQTT + WS <br> AMQP + WS | 

## <a name="route-messages-from-downstream-devices"></a>Маршрутизация сообщений с подчиненных устройств
Среда выполнения IoT Edge может маршрутизировать сообщения, отправляемые с подчиненных устройств. Например, сообщения, отправляемые модулями. Эта функция позволяет выполнять аналитику в модуле, запущенный на шлюзе отправку любых данных в облако. 

В настоящее время маршрутизация сообщений, отправляемых подчиненными устройствами, заключается в дифференцировании их от сообщений, отправляемых модулями. Все сообщения, отправляемые модулями, в отличие от сообщений, отправляемых подчиненными устройствами, содержат системное свойство с именем **connectionModuleId**. Вы можете использовать предложение маршрута WHERE, чтобы исключить любые сообщения, содержащие это системное свойство. 

Ниже маршрута приведен пример, в котором следует отправить сообщения с любого устройства, подчиненный модуль с именем `ai_insights`, а затем из `ai_insights` к центру Интернета вещей.

```json
{
    "routes":{
        "sensorToAIInsightsInput1":"FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO BrokeredEndpoint(\"/modules/ai_insights/inputs/input1\")", 
        "AIInsightsToIoTHub":"FROM /messages/modules/ai_insights/outputs/output1 INTO $upstream" 
    } 
}
```

Дополнительные сведения о маршрутизации сообщений см. в разделе [Объявление маршрутов](./module-composition.md#declare-routes).


## <a name="enable-extended-offline-operation"></a>Включение расширенной операции в автономном режиме

Начиная с [выпуска версия 1.0.4](https://github.com/Azure/azure-iotedge/releases/tag/1.0.4) среды выполнения IoT Edge, шлюз и подчиненные устройства, подключающиеся к нему можно настроить для расширенной операции в автономном режиме. 

Благодаря этой возможности локальные модули или подчиненные устройства можно повторить проверку подлинности в устройстве IoT Edge, при необходимости и обмениваться данными друг с другом сообщениями и методами, даже в том случае, если подключен к центру Интернета вещей. Дополнительные сведения см. в разделе [Сведения о расширенных возможностях автономной работы устройств, модулей и дочерних устройств IoT Edge](offline-capabilities.md).

Для включения расширенных возможностей вне сети, установить связь родитель потомок между устройством шлюза Edge Интернета вещей и подчиненных устройств, которые будут подключаться к нему. Эти действия описаны более подробно в [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md).

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда у вас есть устройство IoT Edge, работающее в качестве прозрачного шлюза, необходимо настроить подчиненные устройства так, чтобы они доверяли шлюзу и отправляли ему сообщения. Дополнительные сведения см. в разделе [соединиться подчиненное устройство шлюза Интернета вещей Azure](how-to-connect-downstream-device.md) и [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md).
