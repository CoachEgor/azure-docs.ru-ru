---
title: Создание устройства прозрачного шлюза с помощью Azure IoT Edge | Документация Майкрософт
description: Использование устройства Azure IoT Edge в качестве прозрачного шлюза, позволяющего обрабатывать информацию из подчиненных устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 06/02/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
ms.openlocfilehash: 0155294777e1d732e5ff3874102b90049d9a123d
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84782591"
---
# <a name="configure-an-iot-edge-device-to-act-as-a-transparent-gateway"></a>Настройка устройства IoT Edge в качестве прозрачного шлюза

В этой статье содержатся подробные инструкции по настройке устройства IoT Edge для работы в качестве прозрачного шлюза для взаимодействия других устройств с центром Интернета вещей. В этой статье используется термин *IOT Edge Gateway* для обозначения устройства IOT EDGE, настроенного в качестве прозрачного шлюза. Дополнительные сведения см. [в статье как можно использовать IOT Edge устройство в качестве шлюза](./iot-edge-as-gateway.md).

>[!NOTE]
>В данный момент:
>
> * устройства с поддержкой Edge не могут подключиться к шлюзам IoT Edge;
> * подчиненные устройства не поддерживают отправку файлов.

Для настройки успешного подключения к прозрачному шлюзу необходимо выполнить три шага. В этой статье рассматривается первый шаг:

1. **Настройте устройство шлюза в качестве сервера, чтобы подчиненные устройства могли безопасно подключаться к нему. Настройте шлюз для приема сообщений от подчиненных устройств и направьте их в нужное место назначения.**
2. Создайте удостоверение устройства для подчиненного устройства, чтобы оно может проходить проверку подлинности в центре Интернета вещей. Настройте подчиненное устройство для отправки сообщений через устройство шлюза. Дополнительные сведения см. в статье [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md).
3. Подключите подчиненное устройство к устройству шлюза и начните отправлять сообщения. Дополнительные сведения см. в статье [Connect a downstream device to an Azure IoT Edge gateway](how-to-connect-downstream-device.md) (Подключение подчиненного устройства к шлюзу Azure IoT Edge).

Чтобы устройство выработало в качестве шлюза, оно должно безопасно подключаться к своим подчиненным устройствам. Решение Azure IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы допускайте Подключение подчиненного устройства к IoT Edge устройству, выступающему в качестве прозрачного шлюза. Чтобы обеспечить приемлемую безопасность, подчиненное устройство должно подтвердить удостоверение устройства шлюза. Эта проверка удостоверения не позволяет устройствам подключаться к потенциально вредоносным шлюзам.

Роль подчиненного устройства может выполнять любое приложение или платформа с идентификатором, созданным с помощью облачной службы [Центра Интернета вещей Azure](https://docs.microsoft.com/azure/iot-hub). Эти приложения часто используют [пакет SDK для устройств Azure IOT](../iot-hub/iot-hub-devguide-sdks.md). Подчиненное устройство может даже быть приложением, которое работает на IoT Edge устройстве шлюза. Однако устройство IoT Edge не может быть переIoT Edge шлюза.

Вы можете создать любую инфраструктуру сертификата, обеспечивающую доверие, необходимое для топологии "устройство — шлюз". В этой статье мы предполагаем ту же настройку сертификата, которую вы использовали для включения [безопасности ЦС x. 509](../iot-hub/iot-hub-x509ca-overview.md) в центре Интернета вещей, которая включает сертификат ЦС x. 509, связанный с конкретным центром Интернета вещей (КОРНЕВой ЦС центра Интернета вещей), ряд сертификатов, подписанных этим ЦС, и ЦС для устройства IOT Edge.

>[!NOTE]
>Термин *сертификат корневого ЦС* , используемый в этих статьях, относится к общедоступному открытому сертификату ЦЕПОЧКи PKI-сертификатов, а не к корневому центру сертификации для общедоступного центра сертификации. Во многих случаях это фактический открытый сертификат промежуточного ЦС.

Следующие шаги описывают процесс создания сертификатов и их установки в нужных местах шлюза. Можно создать сертификаты с помощью любого компьютера и затем скопировать их на устройство IoT Edge.

## <a name="prerequisites"></a>Предварительные условия

Устройство Linux или Windows с установленным IoT Edge.

## <a name="set-up-the-device-ca-certificate"></a>Настройка сертификата ЦС устройства

На всех шлюзах IoT Edge должен быть установлен сертификат ЦС устройства. Управляющая программа IoT Edge безопасности использует сертификат ЦС устройства IoT Edge для подписи сертификата ЦС рабочей нагрузки, который, в свою очередь, подписывает сертификат сервера для центра IoT Edge. Шлюз представляет сертификат сервера для подчиненного устройства во время запуска подключения. Подчиненное устройство проверяет, является ли сертификат сервера частью цепочки сертификатов, которая объединяется с сертификатом корневого ЦС. Этот процесс позволяет подчиненному устройству подтвердить, что шлюз поступает из надежного источника. Дополнительные сведения см. в статье сведения [о том, как Azure IOT Edge использует сертификаты](iot-edge-certs.md).

![Установка сертификата шлюза](./media/how-to-create-transparent-gateway/gateway-setup.png)

Сертификат корневого ЦС и сертификат ЦС устройства (с закрытым ключом) должны присутствовать на устройстве шлюза IoT Edge и быть настроены в файле конфигурации IoT Edge config. YAML. Помните, что в этом случае *сертификат корневого ЦС* означает самый верхний центр сертификации для этого IOT Edge сценария. Сертификат ЦС устройства шлюза и сертификаты подчиненных устройств должны быть сведены к одному и тому же корневому сертификату ЦС.

>[!TIP]
>Процесс установки сертификата корневого ЦС и сертификата ЦС устройства на IoT Edge устройстве также более подробно описан в разделах [Управление сертификатами на IOT Edge устройстве](how-to-manage-device-certificates.md).

Готовые к работе следующие файлы:

* Корневой сертификат ЦС
* Сертификат ЦС устройства
* Закрытый ключ ЦС устройства

В рабочих сценариях эти файлы следует создавать с помощью собственного центра сертификации. Для сценариев разработки и тестирования можно использовать демонстрационные сертификаты.

1. Если вы используете демонстрационные сертификаты, создайте файлы с помощью следующего набора действий:
   1. [Создайте сертификат корневого ЦС](how-to-create-test-certificates.md#create-root-ca-certificate). В конце этих инструкций Вы получите файл сертификата корневого ЦС:
      * `<path>/certs/azure-iot-test-only.root.ca.cert.pem`.

   2. [Создайте сертификат ЦС устройства IOT Edge](how-to-create-test-certificates.md#create-iot-edge-device-ca-certificates). В конце этих инструкций у вас будет два файла: сертификат ЦС устройства и закрытый ключ.
      * `<path>/certs/iot-edge-device-<cert name>-full-chain.cert.pem` и
      * `<path>/private/iot-edge-device-<cert name>.key.pem`

2. Если вы создали эти файлы на другом компьютере, скопируйте их на устройство IoT Edge.

3. На устройстве IoT Edge откройте файл конфигурации управляющей программы безопасности.
   * Windows: `C:\ProgramData\iotedge\config.yaml`
   * Linux: `/etc/iotedge/config.yaml`

4. Найдите в файле раздел **Certificates (сертификаты** ) и предоставьте идентификаторы URI для трех файлов в качестве значений для следующих свойств:
   * **device_ca_cert**: сертификат ЦС устройства
   * **device_ca_pk**: закрытый ключ ЦС устройства
   * **trusted_ca_certs**: сертификат КОРНЕВого ЦС

5. Сохраните и закройте файл.

6. Перезапустите IoT Edge.
   * Windows: `Restart-Service iotedge`
   * Linux: `sudo systemctl restart iotedge`

## <a name="deploy-edgehub-to-the-gateway"></a>Развертывание edgeHub в шлюзе

При первой установке IoT Edge на устройстве автоматически запускается только один системный модуль: агент IoT Edge. После создания первого развертывания для устройства также запускается второй системный модуль, IoT Edge концентратор.

Концентратор IoT Edge отвечает за получение входящих сообщений от подчиненных устройств и их маршрутизацию к следующему назначению. Если модуль **edgeHub** не запущен на вашем устройстве, создайте первоначальное развертывание для устройства. Развертывание будет пустым, так как вы не добавите модули, но убедитесь, что оба системных модуля работают.

Чтобы проверить, какие модули выполняются на устройстве, проверьте сведения об устройстве в портал Azure, просмотрите состояние устройства в Visual Studio или Visual Studio Code или выполнив команду `iotedge list` на самом устройстве.

Если модуль **edgeAgent** работает без модуля **edgeHub** , выполните следующие действия.

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Перейдите к **IoT Edge** и выберите устройство IoT Edge, которое нужно использовать в качестве шлюза.

3. Выберите **задать модули**.

4. Нажмите кнопку **Далее: Маршруты**.

5. На странице " **маршруты** " должен быть маршрут по умолчанию, который отправляет все сообщения, как из модуля, так и из подчиненного устройства в центр Интернета вещей. Если это не так, добавьте новый маршрут со следующими значениями, а затем выберите **проверить и создать**:
   * **Имя**:`route`
   * **Значение**:`FROM /messages/* INTO $upstream`

6. На странице " **Проверка и создание** " выберите **создать**.

## <a name="open-ports-on-gateway-device"></a>Открытие портов на устройстве шлюза

Для стандартных устройств IoT Edge не требуется выполнять какие-либо входящие подключения, так как все связи с центром Интернета вещей выполняются через исходящие подключения. Устройства шлюза отличаются, так как они должны принимать сообщения со своих нижестоящих устройств. Если брандмауэр находится между подчиненными устройствами и устройством шлюза, связь также должна быть возможна через брандмауэр.

Чтобы сценарий шлюза работал, по крайней мере один из поддерживаемых протоколов концентратора IoT Edge должен быть открыт для входящего трафика от подчиненных устройств. Поддерживаемые протоколы: MQTT, AMQP, HTTPS, MQTT через WebSockets и AMQP через WebSockets.

| Порт | Протокол |
| ---- | -------- |
| 8883 | MQTT |
| 5671 | AMQP |
| 443 | HTTPS <br> MQTT + WS <br> AMQP + WS |

## <a name="route-messages-from-downstream-devices"></a>Маршрутизация сообщений с подчиненных устройств

Среда выполнения IoT Edge может маршрутизировать сообщения, отправляемые с подчиненных устройств. Например, сообщения, отправляемые модулями. Эта функция позволяет выполнять аналитику в модуле, работающем в шлюзе, перед отправкой данных в облако.

В настоящее время маршрутизация сообщений, отправляемых подчиненными устройствами, заключается в дифференцировании их от сообщений, отправляемых модулями. Все сообщения, отправляемые модулями, в отличие от сообщений, отправляемых подчиненными устройствами, содержат системное свойство с именем **connectionModuleId**. Вы можете использовать предложение маршрута WHERE, чтобы исключить любые сообщения, содержащие это системное свойство.

Ниже приведен пример маршрута, который отправляет сообщения с любого подчиненного устройства в модуль с именем `ai_insights` , а затем из `ai_insights` в центр Интернета вещей.

```json
{
    "routes":{
        "sensorToAIInsightsInput1":"FROM /messages/* WHERE NOT IS_DEFINED($connectionModuleId) INTO BrokeredEndpoint(\"/modules/ai_insights/inputs/input1\")",
        "AIInsightsToIoTHub":"FROM /messages/modules/ai_insights/outputs/output1 INTO $upstream"
    }
}
```

Дополнительные сведения о маршрутизации сообщений см. в разделе [Объявление маршрутов](./module-composition.md#declare-routes).

## <a name="enable-extended-offline-operation"></a>Включить расширенную автономную операцию

Начиная с [выпуска 1.0.4](https://github.com/Azure/azure-iotedge/releases/tag/1.0.4) среды выполнения IOT EDGE, устройство шлюза и подчиненные устройства, подключающиеся к нему, могут быть настроены для расширенной работы в автономном режиме.

Благодаря этой возможности локальные модули или подчиненные устройства могут повторно пройти проверку подлинности с помощью устройства IoT Edge и взаимодействовать друг с другом, используя сообщения и методы, даже если они отключены от центра Интернета вещей. Дополнительные сведения см. в разделе [Сведения о расширенных возможностях автономной работы устройств, модулей и дочерних устройств IoT Edge](offline-capabilities.md).

Чтобы включить расширенные возможности автономного режима, необходимо установить связь "родители-потомки" между устройством шлюза IoT Edge и подчиненными устройствами, которые будут подключаться к нему. Эти действия более подробно описаны в следующей статье этой серии: [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md).

## <a name="next-steps"></a>Дальнейшие шаги

Теперь, когда IoT Edge устройство настроено в качестве прозрачного шлюза, необходимо настроить подчиненные устройства, чтобы они доверяли шлюзу и отправляли в него сообщения. Продолжите [проверку подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md) , чтобы выполнить следующие действия в разделе Настройка сценария прозрачного шлюза.
