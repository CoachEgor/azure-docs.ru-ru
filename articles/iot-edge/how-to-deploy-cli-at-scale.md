---
title: Развертывание модулей в масштабе с помощью Azure CLI Azure IoT Edge
description: Создание задач автоматического развертывания для групп устройств IoT Edge с помощью расширения IoT для Azure CLI
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 4/14/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: ff6bb9e4d4e40c02b52f35bd56bf065a8804a43a
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82134381"
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale-using-the-azure-cli"></a>Развертывание и мониторинг большого числа модулей IoT Edge с помощью Azure CLI

Создайте **IOT Edge автоматическое развертывание** с помощью интерфейса командной строки Azure, чтобы управлять текущими развертываниями для нескольких устройств одновременно. Автоматические развертывания для IoT Edge входят в функцию [автоматического управления устройствами](/azure/iot-hub/iot-hub-automatic-device-management) в центре Интернета вещей. Развертывания — это динамические процессы, которые позволяют развертывать несколько модулей на нескольких устройствах, контролировать состояние и работоспособность модулей, а также вносить изменения при необходимости.

Дополнительные сведения см. в статье [IOT Edge автоматическое развертывание для отдельных устройств или в масштабе](module-deployment-monitoring.md).

С помощью этого руководства вы настроите Azure CLI и расширение Интернета вещей. Затем вы узнаете, как развертывать модули в наборе IoT Edge устройств и отслеживать ход выполнения с помощью доступных команд CLI.

## <a name="cli-prerequisites"></a>Технические условия CLI

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure.
* [Устройство IoT Edge](how-to-register-device.md#prerequisites-for-the-azure-cli) с установленной средой выполнения IoT Edge.
* [Интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/install-azure-cli) в вашей среде. По крайней мере, Azure CLI версия должна быть 2.0.70 или выше. Для проверки используйте `az --version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack.
* [Расширение IOT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension).

## <a name="configure-a-deployment-manifest"></a>Настройка манифеста развертывания

Манифест развертывания — это документ JSON, в котором определены развертываемые модули, способ передачи данных между этими модулями и требуемые свойства для двойников модулей. Дополнительные сведения см. в статьях о [развертывании модулей и установке маршрутов в IOT Edge](module-composition.md).

Чтобы развернуть модули с помощью Azure CLI, сохраните манифест развертывания на локальный компьютер в формате TXT. Путь к файлу используется в следующем разделе при выполнении команды для применения конфигурации к устройству.

Вот пример простого манифеста развертывания с одним модулем.

```json
{
  "content": {
    "modulesContent": {
      "$edgeAgent": {
        "properties.desired": {
          "schemaVersion": "1.0",
          "runtime": {
            "type": "docker",
            "settings": {
              "minDockerVersion": "v1.25",
              "loggingOptions": "",
              "registryCredentials": {}
            }
          },
          "systemModules": {
            "edgeAgent": {
              "type": "docker",
              "settings": {
                "image": "mcr.microsoft.com/azureiotedge-agent:1.0",
                "createOptions": "{}"
              }
            },
            "edgeHub": {
              "type": "docker",
              "status": "running",
              "restartPolicy": "always",
              "settings": {
                "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
                "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"5671/tcp\":[{\"HostPort\":\"5671\"}],\"8883/tcp\":[{\"HostPort\":\"8883\"}],\"443/tcp\":[{\"HostPort\":\"443\"}]}}}"
              }
            }
          },
          "modules": {
            "SimulatedTemperatureSensor": {
              "version": "1.0",
              "type": "docker",
              "status": "running",
              "restartPolicy": "always",
              "settings": {
                "image": "mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0",
                "createOptions": "{}"
              }
            }
          }
        }
      },
      "$edgeHub": {
        "properties.desired": {
          "schemaVersion": "1.0",
          "routes": {
            "upstream": "FROM /messages/* INTO $upstream"
          },
          "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
          }
        }
      },
      "SimulatedTemperatureSensor": {
        "properties.desired": {
          "SendData": true,
          "SendInterval": 5
        }
      }
    }
  }
}
```

## <a name="layered-deployment"></a>Иерархическое развертывание

Многоуровневые развертывания — это тип автоматического развертывания, который может быть расположен поверх другого. Дополнительные сведения о многоуровневых развертываниях см. [в статье IOT Edge автоматическое развертывание для отдельных устройств или в масштабе](module-deployment-monitoring.md).

Многоуровневые развертывания можно создавать и управлять с помощью Azure CLI, как и при любом автоматическом развертывании, с помощью всего нескольких различий. После создания многоуровневого развертывания тот же Azure CLI работает для многоуровневых развертываний так же, как и любое развертывание. Чтобы создать многослойное развертывание, добавьте `--layered` флаг в команду Create.

Второе отличие заключается в построении манифеста развертывания. Хотя стандартное автоматическое развертывание должно содержать модули системной среды выполнения в дополнение к любым пользовательским модулям, многослойные развертывания могут содержать только пользовательские модули. Вместо этого для многоуровневых развертываний требуется стандартное автоматическое развертывание на устройстве, чтобы предоставить необходимые компоненты каждого IoT Edge устройства, например модули среды выполнения системы.

Ниже приведен простой многоуровневый манифест развертывания с одним модулем в качестве примера:

```json
{
  "content": {
    "modulesContent": {
      "$edgeAgent": {
        "properties.desired.modules.SimulatedTemperatureSensor": {
          "settings": {
            "image": "mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0",
              "createOptions": ""
          },
          "type": "docker",
          "status": "running",
          "restartPolicy": "always",
          "version": "1.0"
        }
      },
      "$edgeHub": {
        "properties.desired.routes.upstream": "FROM /messages/* INTO $upstream"
      },
      "SimulatedTemperatureSensor": {
        "properties.desired": {
          "SendData": true,
          "SendInterval": 5
        }
      }
    }
  }
}
```

В предыдущем примере показана многоуровневая развернутая `properties.desired` Настройка для модуля. Если это многоуровневое развертывание нацелено на устройство, в котором уже был применен тот же модуль, все существующие требуемые свойства будут перезаписаны. Для обновления вместо перезаписи, требуемых свойств можно определить новый подраздел. Пример:

```json
"SimulatedTEmperatureSensor": {
  "properties.desired.layeredProperties": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

Дополнительные сведения о настройке модуля двойников в многоуровневых развертываниях см. в статье о [многоуровневом развертывании](module-deployment-monitoring.md#layered-deployment) .

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием развертывания необходимо указать устройства, на которые вы хотите повлиять. Azure IoT Edge определяет устройства с помощью **тегов** в двойнике устройства. Каждое устройство может иметь несколько тегов, которые определяются любым способом, имеющим смысл для вашего решения. Например, при управлении кампусом интеллектуальных зданий можно добавлять к устройству следующие теги.

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

Дополнительные сведения о двойниках устройств и тегах см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).

## <a name="create-a-deployment"></a>Создание развертывания

Развертывание модулей для целевых устройств происходит при помощи создания развертывания, которое состоит из манифеста развертывания, а также других параметров.

Для создания развертывания используйте команду [AZ IOT ребра Deployment Create](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/edge/deployment?view=azure-cli-latest#ext-azure-cli-iot-ext-az-iot-edge-deployment-create) .

```cli
az iot edge deployment create --deployment-id [deployment id] --hub-name [hub name] --content [file path] --labels "[labels]" --target-condition "[target query]" --priority [int]
```

Используйте ту же команду с `--layered` флагом для создания многоуровневого развертывания.

Команда развертывания создать принимает следующие параметры:

* **--layerd** — необязательный флаг для обозначения развертывания в виде многоуровневого развертывания.
* **--deployment-id** — имя развертывания, которое будет создано в центре IoT. Присвойте своему развертыванию уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`. Обязательный параметр.
* **--content** — путь к файлу манифеста развертывания JSON. Обязательный параметр.
* **--hub-name** — имя центра IoT, в котором будет создано развертывание. Центр должен быть в текущей подписке. Измените текущую подписку с помощью `az account set -s [subscription name]` команды.
* **--labels** — добавление меток для отслеживания развертываний. Метка представляет собой пару имя и значение, которые описывают развертывание. Метки имеют формат JSON для имен и значений. Например `{"HostPlatform":"Linux", "Version:"3.0.1"}`.
* **--target-condition** — введите целевое условие, чтобы определить, для каких устройств будет предназначено это развертывание.Условие основано на тегах двойника устройства или его сообщаемых свойствах и должно соответствовать формату выражения.Например, `tags.environment='test' and properties.reported.devicemodel='4000x'`.
* **--Priority** — положительное целое число. Если одному устройству назначены два или более развертывания, будет применяться развертывание с самым высоким числовым значением параметра Priority.
* **--метрики** — создание метрик, которые запрашивают сообщаемые свойства edgeHub для отслеживания состояния развертывания. Метрики принимают входные данные JSON или путь к файлу. Например, `'{"queries": {"mymetric": "SELECT deviceId FROM devices WHERE properties.reported.lastDesiredStatus.code = 200"}}'`.

Сведения о мониторинге развертывания с помощью Azure CLI см. в разделе [мониторинг IOT Edge развертываний](how-to-monitor-iot-edge-deployments.md#monitor-a-deployment-with-azure-cli).

## <a name="modify-a-deployment"></a>Изменение развертывания

При изменении развертывания изменения немедленно реплицируются во все целевые устройства.

Если обновить целевое условие, произойдут следующие обновления:

* Если устройство не соответствует предыдущему условию назначения, однако соответствует новому и это развертывание имеет самый высокий приоритет для устройства, то оно будет применено к устройству.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, оно удаляет это развертывание и выполняет следующее развертывание с самым высоким приоритетом.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, а также условию назначения любого другого развертывания, в устройстве не происходит никаких изменений. Устройство продолжает выполнять текущие модули в их актуальном состоянии, однако больше не управляется как часть этого развертывания. Если устройство соответствует условию назначения любого другого развертывания, оно удаляет это развертывание и выполняет новое.

Нельзя обновить содержимое развертывания, включая модули и маршруты, определенные в манифесте развертывания. Если вы хотите обновить содержимое развертывания, это можно сделать, создав новое развертывание, нацеленное на те же устройства с более высоким приоритетом. Вы можете изменять определенные свойства существующего модуля, включая целевое условие, метки, метрики и приоритет.

Для обновления развертывания используйте команду [AZ IOT ребра Update](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/edge/deployment?view=azure-cli-latest#ext-azure-cli-iot-ext-az-iot-edge-deployment-update) .

```cli
az iot edge deployment update --deployment-id [deployment id] --hub-name [hub name] --set [property1.property2='value']
```

Команда обновления развертывания принимает следующие параметры:

* **--deployment-id** — имя существующего развертывания в центре IoT.
* **--Hub-Name** — имя центра Интернета вещей, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`
* **--set** — обновление свойства в развертывании. Можно обновлять следующие свойства.
  * targetCondition — например `targetCondition=tags.location.state='Oregon'`
  * метки;
  * priority
* **--Add** -добавить в развертывание новое свойство, включая целевые условия или метки.
* **--Remove** — удаление существующего свойства, включая целевые условия или метки.

## <a name="delete-a-deployment"></a>Удаление развертывания

При удалении развертывания все устройства выполняют следующее развертывание, которое имеет наивысший приоритет. Если устройства не соответствуют условиям назначения любого другого развертывания, то модули не будут удалены при удалении развертывания.

Чтобы удалить развертывание, используйте команду [AZ IOT ребра Delete](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/edge/deployment?view=azure-cli-latest#ext-azure-cli-iot-ext-az-iot-edge-deployment-delete) :

```cli
az iot edge deployment delete --deployment-id [deployment id] --hub-name [hub name]
```

Команда удаления развертывания принимает следующие параметры:

* **--deployment-id** — имя существующего развертывания в центре IoT.
* **--Hub-Name** — имя центра Интернета вещей, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о [развертывании модулей на IOT Edge устройствах](module-deployment-monitoring.md).
