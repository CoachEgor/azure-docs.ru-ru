---
title: Автономная работа устройств — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как устройства и модули IoT Edge могут работать в течение долгого периода времени без подключения к Интернету и как с помощью IoT Edge можно обеспечить автономную работу обычных устройств Интернета вещей.
author: kgremban
ms.author: kgremban
ms.date: 11/22/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 588926a90d9a40c00bca4914dc1d5ed08301ff75
ms.sourcegitcommit: 31236e3de7f1933be246d1bfeb9a517644eacd61
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/04/2020
ms.locfileid: "82780799"
---
# <a name="understand-extended-offline-capabilities-for-iot-edge-devices-modules-and-child-devices"></a>Общие сведения о расширенных возможностях автономного режима для IoT Edge устройств, модулей и дочерних устройств

Azure IoT Edge поддерживает расширенные автономные операции на устройствах IoT Edge, а также позволяет выполнять автономные операции на дочерних устройствах, отличных от IoT Edge. Пока устройство IoT Edge имеет одну возможность подключения к центру Интернета вещей, это устройство и все дочерние устройства могут продолжать работать с периодическим или без подключения к Интернету.

## <a name="how-it-works"></a>Принцип работы

Когда устройство IoT Edge переходит в автономный режим, центр IoT Edge выполняет три роли. Во-первых, он хранит все сообщения, которые необходимо отправить, до тех пор, пока соединение с устройством не будет восстановлено. Во-вторых, он выступает от имени центра Интернета вещей и проверяет подлинность модулей и дочерних устройств, чтобы они продолжали работу. В-третьих, он обеспечивает связь между дочерними устройствами, которая обычно проходит через центр Интернета вещей.

В следующем примере показано, как IoT Edge работает в автономном режиме:

1. **Настройка устройств**

   Функция автономной работы включена на устройствах IoT Edge автоматически. Чтобы дать эту возможность другим устройствам Интернета вещей, необходимо объявить отношение "родитель-дочерний элемент" между устройствами в центре Интернета вещей. Затем следует настроить дочерние устройства, чтобы они доверяли назначенному им родительскому устройству, и направить обмен данными между устройством и облаком через родительский сервер в качестве шлюза.

2. **Синхронизация с центром Интернета вещей**

   Хотя бы один раз после установки среды выполнения IoT Edge необходимо подключить устройство IoT Edge к сети для синхронизации с центром Интернета вещей. Во время синхронизации устройство IoT Edge получает сведения о назначенных ему дочерних устройствах. Устройство IoT Edge безопасно обновляет свой локальный кэш, чтобы можно было продолжать работу автономно, и извлекает параметры для локального хранения сообщений телеметрии.

3. **Переход в автономный режим**

   При отключении от центра Интернета вещей устройств IoT Edge его развернутые модули и любые дочерние устройства Интернета вещей могут работать бесконечно. Модули и дочерние устройства могут запускаться и перезапускаться с прохождением аутентификации в центре IoT Edge в автономном режиме. Восходящий поток телеметрии в центр Интернета вещей хранится локально. Обмен данными между модулями или дочерними устройствами Интернета вещей поддерживается через прямые методы или сообщения.

4. **Повторное подключение и повторная синхронизация с центром Интернета вещей**

   После восстановления связи с центром Интернета вещей устройство IoT Edge будет снова синхронизировано. Локально хранящиеся сообщения немедленно доставляются в центр Интернета вещей, но они зависят от скорости подключения, задержки центра Интернета вещей и связанных факторов. Они доставляются в том же порядке, в котором они были сохранены.

   Все различия между требуемыми и сообщаемыми свойствами модулей и устройств будут согласованы. Устройство IoT Edge передает все изменения в свои назначенные дочерние устройства.

## <a name="restrictions-and-limits"></a>Ограничения

Возможности расширенного автономного режима, описанные в этой статье, доступны в [IOT Edge версии 1.0.7 или более поздней](https://github.com/Azure/azure-iotedge/releases). Более ранние версии имеют подмножество автономных функций. Существующие устройства IoT Edge без расширенных возможностей автономной работы невозможно обновить, изменив версию среды выполнения. Необходимо изменить их конфигурацию с использованием нового удостоверения устройства IoT Edge, чтобы использовать эти функции.

В качестве дочерних устройств можно добавлять только устройства, не относящиеся к IoT Edge.

IoT Edge устройства и назначенные им дочерние устройства могут работать в неопределенном режиме вне сети после первоначальной однократной синхронизации. Однако хранение сообщений зависит от настройки срока жизни (TTL) и свободного места на диске для хранения сообщений.

## <a name="set-up-parent-and-child-devices"></a>Настройка родительских и дочерних устройств

Для расширения возможностей расширенного автономного режима до дочерних устройств IoT на IoT Edge устройстве необходимо выполнить два действия. Сначала объявите связи типа «родители-потомки» в портал Azure. Во-вторых, создайте отношение доверия между родительским устройством и любыми дочерними устройствами, а затем настройте обмен данными между устройством и облаком, чтобы сделать его родительским в качестве шлюза.

### <a name="assign-child-devices"></a>Назначение дочерних устройств

Дочерние устройства могут быть любыми устройствами, не IoT Edge, зарегистрированными в одном центре Интернета вещей. У родительских устройств может быть несколько дочерних устройств, но у дочернего устройства есть только один родительский. Существует три варианта установки дочерних устройств на пограничном устройстве: через портал Azure, с помощью Azure CLI или с помощью пакета SDK для службы центра Интернета вещей.

В следующих разделах приведены примеры объявления отношений "родители-потомки" в центре Интернета вещей для существующих устройств IoT. Дополнительные сведения о создании новых удостоверений устройств для дочерних устройств см. в статье [Проверка подлинности подчиненного устройства в центре Интернета вещей Azure](how-to-authenticate-downstream-device.md) .

#### <a name="option-1-iot-hub-portal"></a>Вариант 1. портал центра Интернета вещей

Вы можете объявить отношение "родители-потомки" при создании нового устройства. Или для существующих устройств можно объявить связь со страницы сведений об устройстве либо родительского IoT Edge устройства, либо дочернего устройства Интернета вещей.

   ![Управление дочерними устройствами на странице сведений об устройстве IoT Edge](./media/offline-capabilities/manage-child-devices.png)

#### <a name="option-2-use-the-az-command-line-tool"></a>Вариант 2. Использование программы `az` командной строки

Используя [интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest) с [расширением Интернета вещей](https://github.com/azure/azure-iot-cli-extension) (v 0.7.0 или более поздней версии), можно управлять связями родительского дочернего элемента с помощью подкоманд [удостоверения устройства](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) . В примере ниже запрос используется для назначения всех устройств, не являющихся IoT Edge, в концентраторе дочерними устройствами устройства IoT Edge.

```azurecli
# Set IoT Edge parent device
egde_device="edge-device1"

# Get All IoT Devices
device_list=$(az iot hub query \
        --hub-name replace-with-hub-name \
        --subscription replace-with-sub-name \
        --resource-group replace-with-rg-name \
        -q "SELECT * FROM devices WHERE capabilities.iotEdge = false" \
        --query 'join(`, `, [].deviceId)' -o tsv)

# Add all IoT devices to IoT Edge (as child)
az iot hub device-identity add-children \
  --device-id $egde_device \
  --child-list $device_list \
  --hub-name replace-with-hub-name \
  --resource-group replace-with-rg-name \
  --subscription replace-with-sub-name
```

Можно изменить [запрос](../iot-hub/iot-hub-devguide-query-language.md) , чтобы выбрать другое подмножество устройств. Выполнение команды может занять несколько секунд, если указать большой набор устройств.

#### <a name="option-3-use-iot-hub-service-sdk"></a>Вариант 3. Использование пакета SDK службы центра Интернета вещей

Наконец, можно управлять родительскими дочерними связями программно с помощью пакета SDK службы центра Интернета вещей C#, Java или Node. js. Ниже приведен [Пример назначения дочернего устройства](https://aka.ms/set-child-iot-device-c-sharp) с помощью пакета SDK для C#.

### <a name="set-up-the-parent-device-as-a-gateway"></a>Настройка родительского устройства в качестве шлюза

Отношение "родители-потомки" можно считать прозрачным шлюзом, где дочернее устройство имеет собственное удостоверение в центре Интернета вещей, но взаимодействует через облако через его родительский узел. Для безопасного взаимодействия дочернее устройство должно иметь возможность убедиться, что родительское устройство поступает из надежного источника. В противном случае сторонние устройства могут настроить для олицетворения родителей и перехвата взаимодействий с вредоносными устройствами.

Один из способов создания этого отношения доверия подробно описан в следующих статьях:

* [Настройка устройства IoT Edge для работы в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
* [Подключение подчиненного (дочернего) устройства к шлюзу Azure IoT Edge](how-to-connect-downstream-device.md)

## <a name="specify-dns-servers"></a>Указание DNS-серверов

Для повышения надежности настоятельно рекомендуется указать адреса DNS-серверов, используемые в вашей среде. Сведения о настройке DNS-сервера для IoT Edge см. в разделе разрешение [модуля агента ребра непрерывно сообщает о пустом файле конфигурации и не запускайте модули на устройстве](troubleshoot-common-errors.md#edge-agent-module-reports-empty-config-file-and-no-modules-start-on-the-device) в статье Устранение неполадок.

## <a name="optional-offline-settings"></a>Дополнительные параметры автономной работы

Если устройства переходят в автономный режим, IoT Edge родительское устройство сохраняет все сообщения, отправляемые с устройства в облако, до тех пор, пока подключение не будет восстановлено. Модуль IoT Edge концентратора управляет хранением и пересылкой автономных сообщений. Для устройств, которые могут переключиться в автономный режим в течение продолжительного периода времени, оптимизируйте производительность, настроив два параметра центра IoT Edge.

Во-первых, увеличьте время жизни, чтобы центр IoT Edge сохранит сообщения достаточно долго для того, чтобы устройство подключится. Затем добавьте дополнительное место на диске для хранения сообщений.

### <a name="time-to-live"></a>Срок жизни

Срок жизни — это период времени (в секундах), в течение которого сообщение ожидает доставки, прежде чем срок его действия истечет. По умолчанию это 7200 секунд (два часа). Максимальное значение ограничивается только максимальным значением целочисленной переменной, которое обходится около 2 000 000 000.

Этот параметр является требуемым свойством центра IoT Edge, которое хранится в двойнике модуля. Его можно настроить в портал Azure или непосредственно в манифесте развертывания.

```json
"$edgeHub": {
    "properties.desired": {
        "schemaVersion": "1.0",
        "routes": {},
        "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
        }
    }
}
```

### <a name="host-storage-for-system-modules"></a>Хранилище узлов для системных модулей

Сообщения и сведения о состоянии модуля хранятся в локальной файловой системе контейнера IoT Edge по умолчанию. Для повышения надежности, особенно при работе в автономном режиме, можно также выделить хранилище на узле IoT Edge устройстве. Дополнительные сведения см. в разделе [предоставление модулям доступа к локальному хранилищу устройства](how-to-access-host-storage-from-module.md) .

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о настройке прозрачного шлюза для подключений между родительскими и дочерними устройствами:

* [Настройка устройства IoT Edge для работы в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
* [Аутентификация подчиненного устройства в Центре Интернета вещей](how-to-authenticate-downstream-device.md)
* [Подключение подчиненного устройства к шлюзу Azure IoT Edge](how-to-connect-downstream-device.md)
