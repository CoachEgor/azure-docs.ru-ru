---
title: Автономная работа устройств — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как устройства и модули IoT Edge могут работать в течение долгого периода времени без подключения к Интернету и как с помощью IoT Edge можно обеспечить автономную работу обычных устройств Интернета вещей.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 01/30/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 74d2601c2319ccad9cc980b83894a3242705aa46
ms.sourcegitcommit: f6ba5c5a4b1ec4e35c41a4e799fb669ad5099522
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65148119"
---
# <a name="understand-extended-offline-capabilities-for-iot-edge-devices-modules-and-child-devices"></a>Понять расширенных возможностей вне сети для устройства, модули и дочерних устройств IoT Edge

Azure IoT Edge поддерживает расширенную автономную работу устройств IoT Edge и обеспечивает автономную работу для дочерних устройств не из Edge. Пока у устройства IoT Edge есть возможность подключиться к центру Интернета вещей, оно и его дочерние устройства могут продолжать работу с нестабильным подключением к Интернету или даже без него. 


## <a name="how-it-works"></a>Принцип работы

Когда устройство IoT Edge переходит в автономный режим, центр IoT Edge выполняет три роли. Во-первых, он хранит все сообщения, которые необходимо отправить, до тех пор, пока соединение с устройством не будет восстановлено. Во-вторых, он выступает от имени центра Интернета вещей и проверяет подлинность модулей и дочерних устройств, чтобы они продолжали работу. В-третьих, он обеспечивает связь между дочерними устройствами, которая обычно проходит через центр Интернета вещей. 

В следующем примере показано, как IoT Edge работает в автономном режиме:

1. **Настройте устройство IoT Edge.**

   Функция автономной работы включена на устройствах IoT Edge автоматически. Чтобы дать эту возможность другим устройствам Интернета вещей, необходимо объявить отношение "родитель-дочерний элемент" между устройствами в центре Интернета вещей. 

2. **Синхронизируйтесь с Центром Интернета вещей.**

   Хотя бы один раз после установки среды выполнения IoT Edge необходимо подключить устройство IoT Edge к сети для синхронизации с центром Интернета вещей. Во время синхронизации устройство IoT Edge получает сведения о назначенных ему дочерних устройствах. Устройство IoT Edge безопасно обновляет свой локальный кэш, чтобы можно было продолжать работу автономно, и извлекает параметры для локального хранения сообщений телеметрии. 

3. **Перейдите в автономный режим.**

   При отключении от центра Интернета вещей устройств IoT Edge его развернутые модули и любые дочерние устройства Интернета вещей могут работать бесконечно. Модули и дочерние устройства могут запускаться и перезапускаться с прохождением аутентификации в центре IoT Edge в автономном режиме. Восходящий поток телеметрии в центр Интернета вещей хранится локально. Обмен данными между модулями или дочерними устройствами Интернета вещей поддерживается через прямые методы или сообщения. 

4. **Подключитесь повторно и снова синхронизируйтесь с Центром Интернета вещей.**

   После восстановления связи с центром Интернета вещей устройство IoT Edge будет снова синхронизировано. Локально хранимые сообщения доставляются в том же порядке, в котором они были сохранены. Все различия между требуемыми и сообщаемыми свойствами модулей и устройств будут согласованы. Устройство IoT Edge передает все изменения в свои назначенные дочерние устройства.

## <a name="restrictions-and-limits"></a>Ограничения

Расширенные возможности автономной работы, описанные в этой статье, доступны в [IoT Edge 1.0.4 или более поздней версии](https://github.com/Azure/azure-iotedge/releases). Более ранние версии имеют подмножество автономных функций. Существующие устройства IoT Edge без расширенных возможностей автономной работы невозможно обновить, изменив версию среды выполнения. Необходимо изменить их конфигурацию с использованием нового удостоверения устройства IoT Edge, чтобы использовать эти функции. 

Расширенная поддержка автономной работы доступна во всех регионах, где есть Центр Интернета вещей, **за исключением** региона "Восточная часть США".

В качестве дочерних устройств можно добавить только устройства не из IoT Edge. 

Устройства IoT Edge и их дочерние устройства могут неограниченное время работать в автономном режиме после первой однократной синхронизации. Однако хранение сообщений зависит от срока жизни (TTL) и доступного места на диске для хранения сообщений. 

## <a name="set-up-an-iot-edge-device"></a>Настройка устройства IoT Edge

Чтобы возможности автономной работы устройства IoT Edge распространялись на дочерние устройства Интернета вещей, необходимо объявить отношения "родитель-дочерний элемент" на портале Azure.

### <a name="assign-child-devices"></a>Назначение дочерних устройств

Дочерние устройства могут быть любыми устройствами не Edge, зарегистрированными в одном центре Интернета вещей. Родительские устройства могут иметь несколько дочерних устройств, но дочернее устройство может иметь только один родительский элемент. Существует три варианта для задания дочерних устройств на пограничном устройстве:

#### <a name="option-1-iot-hub-portal"></a>Вариант 1: Портал центра Интернета вещей

 Вы можете привязывать дочерние устройства при создании нового устройства или на странице сведений о родительском или дочернем устройстве Интернета вещей. 

   ![Управление дочерними устройствами на странице сведений об устройстве IoT Edge](./media/offline-capabilities/manage-child-devices.png)


#### <a name="option-2-use-the-az-command-line-tool"></a>Вариант 2. Используйте `az` средство командной строки

С помощью [интерфейса командной строки Azure](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest) с [расширения Интернета вещей](https://github.com/azure/azure-iot-cli-extension) (версии 0.7.0 или более поздней версии), вы можете управлять родительского потомок с [удостоверения устройства](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) вложенные команды. В приведенном ниже примере мы выполнить запрос для назначения устройств в центре всех не IoT Edge в качестве дочерних устройств устройства IoT Edge. 

```shell
# Set IoT Edge parent device
egde_device="edge-device1"

# Get All IoT Devices
device_list=$(az iot hub query \
        --hub-name replace-with-hub-name \
        --subscription replace-with-sub-name \
        --resource-group replace-with-rg-name \
        -q "SELECT * FROM devices WHERE capabilities.iotEdge = false" \
        --query 'join(`, `, [].deviceId)' -o tsv)

# Add all IoT devices to IoT Edge (as child)
az iot hub device-identity add-children \
  --device-id $egde_device \
  --child-list $device_list \
  --hub-name replace-with-hub-name \
  --resource-group replace-with-rg-name \
  --subscription replace-with-sub-name 
```

Вы можете изменить [запроса](../iot-hub/iot-hub-devguide-query-language.md) для выбора подмножества данных разных устройств. Команда может занять несколько секунд, если указать большого набора устройств.

#### <a name="option-3-use-iot-hub-service-sdk"></a>Вариант 3. Используйте пакет SDK для службы центра Интернета вещей 

Наконец, вы можете управлять программным способом с помощью родительского потомок C#, Java или пакета SDK службы центра Интернета вещей Node.js. Вот [присвоить дочернего устройства](https://aka.ms/set-child-iot-device-c-sharp) с помощью C# пакета SDK.

### <a name="specifying-dns-servers"></a>Указание DNS-серверов 

Чтобы повысить надежность, настоятельно рекомендуется задать адреса DNS-серверов, используемых в вашей среде. См. в разделе [два варианта, чтобы сделать это из статьи по устранению неполадок](troubleshoot.md#resolution-7).

## <a name="optional-offline-settings"></a>Дополнительные параметры автономной работы

Если вы планируете собрать все сообщения, которые устройства создают во время длительных периодов работы в автономном режиме, настройте центр IoT Edge для хранения всех сообщений. Существует два изменения, которые можно внести в центр IoT Edge, чтобы включить долгосрочное хранение сообщений. Во-первых, увеличьте срок жизни. Затем добавьте дополнительное место на диске для хранения сообщений. 

### <a name="time-to-live"></a>Срок жизни

Срок жизни — это период времени (в секундах), в течение которого сообщение ожидает доставки, прежде чем срок его действия истечет. По умолчанию это 7200 секунд (два часа). Максимальное значение ограничено только максимальным значением для целочисленной переменной, которой составляет около 2 млрд. 

Этот параметр является требуемым свойством центра IoT Edge, которое хранится в двойнике модуля. Его можно настроить на портале Azure в разделе **Настройка дополнительных параметров среды выполнения Edge** или непосредственно в манифесте развертывания. 

```json
"$edgeHub": {
    "properties.desired": {
        "schemaVersion": "1.0",
        "routes": {},
        "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
        }
    }
}
```

### <a name="additional-offline-storage"></a>Дополнительное хранилище в автономном режиме

По умолчанию сообщения хранятся в файловой системе контейнера центра IoT Edge. Если этого объема недостаточно для ваших потребностей, вы можете выделить локальное хранилище на устройстве IoT Edge. Создайте переменную среды для центра IoT Edge, которая указывает на папку хранения в контейнере. Затем используйте параметры создания для привязки этой папки хранения к папке на хост-компьютере. 

Вы можете настроить переменные среды и параметры создания для модуля центра IoT Edge на портале Azure в разделе **Настройка дополнительных параметров среды выполнения Edge**. Или вы можете указать эти значения непосредственно в манифесте развертывания. 

```json
"edgeHub": {
    "type": "docker",
    "settings": {
        "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
        "createOptions": {
            "HostConfig": {
                "Binds": ["<HostStoragePath>:<ModuleStoragePath>"],
                "PortBindings": {
                    "8883/tcp": [{"HostPort":"8883"}],
                    "443/tcp": [{"HostPort":"443"}],
                    "5671/tcp": [{"HostPort":"5671"}]
                }
            }
        }
    },
    "env": {
        "storageFolder": {
            "value": "<ModuleStoragePath>"
        }
    },
    "status": "running",
    "restartPolicy": "always"
}
```

Замените `<HostStoragePath>` и `<ModuleStoragePath>` путями к хранилищу узла и модуля соответственно; это должны быть абсолютные пути. В параметрах создания свяжите пути к хранилищу узла и модуля. Затем создайте переменную среды, которая указывает путь к хранилищу модуля.  

Например, `"Binds":["/etc/iotedge/storage/:/iotedge/storage/"]` означает, что каталог **/etc/iotedge/storage** в хост-системе сопоставляется с каталогом **/iotedge/storage/** в контейнере. Вот еще один пример для систем Windows: `"Binds":["C:\\temp:C:\\contemp"]` означает, что каталог **C:\\temp** в хост-системе сопоставляется с каталогом **C:\\contemp** в контейнере. 

Кроме того, дополнительные сведения о параметрах создания можно найти в [документации Docker](https://docs.docker.com/engine/api/v1.32/#operation/ContainerCreate).

## <a name="next-steps"></a>Дальнейшие действия

Включите расширенные возможности автономной работы при использовании [прозрачного шлюза](how-to-create-transparent-gateway.md).
