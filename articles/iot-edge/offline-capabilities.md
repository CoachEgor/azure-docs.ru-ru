---
title: Автономная работа устройств — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как устройства и модули IoT Edge могут работать в течение долгого периода времени без подключения к Интернету и как с помощью IoT Edge можно обеспечить автономную работу обычных устройств Интернета вещей.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 06/04/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: seodec18
ms.openlocfilehash: 4f3e5c1566271573b43e24a1749b42daa7530555
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67051951"
---
# <a name="understand-extended-offline-capabilities-for-iot-edge-devices-modules-and-child-devices"></a>Понять расширенных возможностей вне сети для устройства, модули и дочерних устройств IoT Edge

Azure IoT Edge поддерживает расширенные автономных операций на устройствах IoT Edge и позволяет автономных операций на устройствах IoT Edge дочерних слишком. Пока у устройства IoT Edge есть возможность подключиться к центру Интернета вещей, оно и его дочерние устройства могут продолжать работу с нестабильным подключением к Интернету или даже без него. 


## <a name="how-it-works"></a>Принцип работы

Когда устройство IoT Edge переходит в автономный режим, центр IoT Edge выполняет три роли. Во-первых, он хранит все сообщения, которые необходимо отправить, до тех пор, пока соединение с устройством не будет восстановлено. Во-вторых, он выступает от имени центра Интернета вещей и проверяет подлинность модулей и дочерних устройств, чтобы они продолжали работу. В-третьих, он обеспечивает связь между дочерними устройствами, которая обычно проходит через центр Интернета вещей. 

В следующем примере показано, как IoT Edge работает в автономном режиме:

1. **Настройка устройств**

   Функция автономной работы включена на устройствах IoT Edge автоматически. Чтобы дать эту возможность другим устройствам Интернета вещей, необходимо объявить отношение "родитель-дочерний элемент" между устройствами в центре Интернета вещей. Затем настраивается дочерних устройств доверять их назначенного родительское устройство и выполнять маршрутизацию связи устройства в облако через родительский как шлюз. 

2. **Синхронизация с центром Интернета вещей**

   Хотя бы один раз после установки среды выполнения IoT Edge необходимо подключить устройство IoT Edge к сети для синхронизации с центром Интернета вещей. Во время синхронизации устройство IoT Edge получает сведения о назначенных ему дочерних устройствах. Устройство IoT Edge безопасно обновляет свой локальный кэш, чтобы можно было продолжать работу автономно, и извлекает параметры для локального хранения сообщений телеметрии. 

3. **Перейти в автономный режим**

   При отключении от центра Интернета вещей устройств IoT Edge его развернутые модули и любые дочерние устройства Интернета вещей могут работать бесконечно. Модули и дочерние устройства могут запускаться и перезапускаться с прохождением аутентификации в центре IoT Edge в автономном режиме. Восходящий поток телеметрии в центр Интернета вещей хранится локально. Обмен данными между модулями или дочерними устройствами Интернета вещей поддерживается через прямые методы или сообщения. 

4. **Повторное подключение и повторной синхронизации с центром Интернета вещей**

   После восстановления связи с центром Интернета вещей устройство IoT Edge будет снова синхронизировано. Локально хранимые сообщения доставляются в том же порядке, в котором они были сохранены. Все различия между требуемыми и сообщаемыми свойствами модулей и устройств будут согласованы. Устройство IoT Edge передает все изменения в свои назначенные дочерние устройства.

## <a name="restrictions-and-limits"></a>Ограничения

Расширенные возможности автономной работы, описанные в этой статье, доступны в [IoT Edge 1.0.4 или более поздней версии](https://github.com/Azure/azure-iotedge/releases). Более ранние версии имеют подмножество автономных функций. Существующие устройства IoT Edge без расширенных возможностей автономной работы невозможно обновить, изменив версию среды выполнения. Необходимо изменить их конфигурацию с использованием нового удостоверения устройства IoT Edge, чтобы использовать эти функции. 

Расширенная поддержка автономной работы доступна во всех регионах, где есть Центр Интернета вещей, **за исключением** региона "Восточная часть США".

Можно добавить только устройства IoT Edge в качестве дочерних устройств. 

Устройства IoT Edge и их дочерние устройства могут неограниченное время работать в автономном режиме после первой однократной синхронизации. Однако хранение сообщений зависит от срока жизни (TTL) и доступного места на диске для хранения сообщений. 

## <a name="set-up-parent-and-child-devices"></a>Настройка устройств с родительской и дочерней

Для устройства IoT Edge для расширения его расширенных возможностей автономной работы дочернего устройств Интернета вещей необходимо выполнить два шага. Сначала объявите иерархические связи на портале Azure. Во-вторых Создайте отношение доверия между устройство родительского и дочернего устройства, а затем настроить device-to-cloud communications проходить через родительский элемент в качестве шлюза. 

### <a name="assign-child-devices"></a>Назначение дочерних устройств

Дочерние устройства могут быть любого устройства IoT Edge, зарегистрированные в один и тот же центр Интернета вещей. Родительский устройства могут иметь несколько дочерних устройств, но дочернего устройства имеет только один родительский элемент. Существует три варианта для задания дочерних устройств на устройстве edge: через портал Azure, с помощью Azure CLI или пакет SDK для служб центра Интернета вещей. 

В следующих разделах примеры как объявить отношению предка/потомка в центре Интернета вещей для существующих устройств Интернета вещей. Если вы создаете новые удостоверения устройства для вашего ребенка устройств, см. в разделе [проверки подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md) Дополнительные сведения.

#### <a name="option-1-iot-hub-portal"></a>Вариант 1. Портал центра Интернета вещей

Вы можете объявить «родитель потомок», при создании нового устройства. Или для существующих устройств, можно объявить связи на странице сведений об устройстве либо родительского устройство IoT Edge или дочерних устройства Интернета вещей. 

   ![Управление дочерними устройствами на странице сведений об устройстве IoT Edge](./media/offline-capabilities/manage-child-devices.png)


#### <a name="option-2-use-the-az-command-line-tool"></a>Вариант 2. Используйте `az` средство командной строки

С помощью [интерфейса командной строки Azure](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest) с [расширения Интернета вещей](https://github.com/azure/azure-iot-cli-extension) (версии 0.7.0 или более поздней версии), вы можете управлять родительского потомок с [удостоверения устройства](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) подкоманды. В приведенном ниже примере используется запрос для назначения всех устройств IoT Edge в концентраторе, чтобы быть дочерних устройств устройства IoT Edge. 

```shell
# Set IoT Edge parent device
egde_device="edge-device1"

# Get All IoT Devices
device_list=$(az iot hub query \
        --hub-name replace-with-hub-name \
        --subscription replace-with-sub-name \
        --resource-group replace-with-rg-name \
        -q "SELECT * FROM devices WHERE capabilities.iotEdge = false" \
        --query 'join(`, `, [].deviceId)' -o tsv)

# Add all IoT devices to IoT Edge (as child)
az iot hub device-identity add-children \
  --device-id $egde_device \
  --child-list $device_list \
  --hub-name replace-with-hub-name \
  --resource-group replace-with-rg-name \
  --subscription replace-with-sub-name 
```

Вы можете изменить [запроса](../iot-hub/iot-hub-devguide-query-language.md) для выбора подмножества данных разных устройств. Команда может занять несколько секунд, если указать большого набора устройств.

#### <a name="option-3-use-iot-hub-service-sdk"></a>Вариант 3. Используйте пакет SDK для службы центра Интернета вещей 

Наконец, вы можете управлять программным способом с помощью родительского потомок C#, Java или пакета SDK службы центра Интернета вещей Node.js. Вот [присвоить дочернего устройства](https://aka.ms/set-child-iot-device-c-sharp) с помощью C# пакета SDK.

### <a name="set-up-the-parent-device-as-a-gateway"></a>Настройка родительского устройства в качестве шлюза

Можно представить как прозрачный шлюз, где дочерние устройство имеет свой собственный удостоверений в центре Интернета вещей, но обменивается данными через облако с помощью родительского связи "родители потомки". Для безопасного взаимодействия дочерние устройство должно иметь возможность проверить, что родительское устройство поступает из надежного источника. В противном случае третьим сторонам настроить вредоносных устройств для олицетворения родительских элементов, а также перехватывать связь. 

Один из способов создать это отношение доверия подробно в следующих статьях: 
* [Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
* [Подключение устройства подчиненных (дочерний) в шлюз Edge Интернета вещей Azure](how-to-connect-downstream-device.md)

## <a name="specify-dns-servers"></a>Указание DNS-серверов 

Чтобы повысить надежность, настоятельно рекомендуется задать адреса DNS-серверов, используемых в вашей среде. См. в разделе два варианта [задать DNS-сервер в статье об устранении неполадок](troubleshoot.md#resolution-7).

## <a name="optional-offline-settings"></a>Дополнительные параметры автономной работы

Если устройства переходят в автономный режим, родительское устройство IoT Edge хранит все сообщения с устройства в облако, пока оно устанавливается заново. Модуль центра IoT Edge управляет хранением и пересылку сообщений в автономном режиме. Для устройств, которые может перейти в автономный режим на длительное время Оптимизируйте производительность, настроив две настройки концентратора IoT Edge. 

Во-первых увеличьте время динамический параметр для концентратора IoT Edge сохранит сообщения, достаточно для вашего устройства для повторного подключения. Затем добавьте дополнительное место на диске для хранения сообщений. 

### <a name="time-to-live"></a>Срок жизни

Срок жизни — это период времени (в секундах), в течение которого сообщение ожидает доставки, прежде чем срок его действия истечет. По умолчанию это 7200 секунд (два часа). Максимальное значение ограничено только максимальным значением для целочисленной переменной, которой составляет около 2 млрд. 

Этот параметр является требуемым свойством центра IoT Edge, которое хранится в двойнике модуля. Его можно настроить на портале Azure или непосредственно в манифесте развертывания. 

```json
"$edgeHub": {
    "properties.desired": {
        "schemaVersion": "1.0",
        "routes": {},
        "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
        }
    }
}
```

### <a name="additional-offline-storage"></a>Дополнительное хранилище в автономном режиме

По умолчанию сообщения хранятся в файловой системе контейнера центра IoT Edge. Если этого объема недостаточно для ваших потребностей, вы можете выделить локальное хранилище на устройстве IoT Edge. Создайте переменную среды для центра IoT Edge, которая указывает на папку хранения в контейнере. Затем используйте параметры создания для привязки этой папки хранения к папке на хост-компьютере. 

Вы можете настроить переменные среды и параметры создания для модуля центра IoT Edge на портале Azure в разделе **Настройка дополнительных параметров среды выполнения Edge**. Или вы можете указать эти значения непосредственно в манифесте развертывания. 

```json
"edgeHub": {
    "type": "docker",
    "settings": {
        "image": "mcr.microsoft.com/azureiotedge-hub:1.0",
        "createOptions": {
            "HostConfig": {
                "Binds": ["<HostStoragePath>:<ModuleStoragePath>"],
                "PortBindings": {
                    "8883/tcp": [{"HostPort":"8883"}],
                    "443/tcp": [{"HostPort":"443"}],
                    "5671/tcp": [{"HostPort":"5671"}]
                }
            }
        }
    },
    "env": {
        "storageFolder": {
            "value": "<ModuleStoragePath>"
        }
    },
    "status": "running",
    "restartPolicy": "always"
}
```

Замените `<HostStoragePath>` и `<ModuleStoragePath>` путями к хранилищу узла и модуля соответственно; это должны быть абсолютные пути. В параметрах создания свяжите пути к хранилищу узла и модуля. Затем создайте переменную среды, которая указывает путь к хранилищу модуля.  

Например, `"Binds":["/etc/iotedge/storage/:/iotedge/storage/"]` означает, что каталог **/etc/iotedge/storage** в хост-системе сопоставляется с каталогом **/iotedge/storage/** в контейнере. Вот еще один пример для систем Windows: `"Binds":["C:\\temp:C:\\contemp"]` означает, что каталог **C:\\temp** в хост-системе сопоставляется с каталогом **C:\\contemp** в контейнере. 

Кроме того, дополнительные сведения о параметрах создания можно найти в [документации Docker](https://docs.docker.com/engine/api/v1.32/#operation/ContainerCreate).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о настройке прозрачного шлюза для подключений родители потомки устройства: 

* [Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
* [Проверка подлинности подчиненного устройства к центру Интернета вещей Azure](how-to-authenticate-downstream-device.md)
* [Подключение к шлюзу Azure IoT Edge подчиненного устройства](how-to-connect-downstream-device.md)
