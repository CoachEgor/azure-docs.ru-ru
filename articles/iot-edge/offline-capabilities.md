---
title: Автономная работа устройств — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как устройства и модули IoT Edge могут работать в течение долгого периода времени без подключения к Интернету и как с помощью IoT Edge можно обеспечить автономную работу обычных устройств Интернета вещей.
author: kgremban
ms.author: kgremban
ms.date: 11/22/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 55512491121aee28404ab5f85b4223c67a2f0e1e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80236060"
---
# <a name="understand-extended-offline-capabilities-for-iot-edge-devices-modules-and-child-devices"></a>Понимание расширенных возможностей автономного номлина для устройств, модулей и детских устройств IoT Edge

Azure IoT Edge поддерживает расширенные автономные операции на устройствах IoT Edge и позволяет выполнять операции в автономном режиме и на детских устройствах, не относясь от IoT Edge. До тех пор, пока устройство IoT Edge имеет одну возможность подключиться к IoT Hub, это устройство и любые детские устройства могут продолжать функционировать с прерывистым или без подключения к Интернету.

## <a name="how-it-works"></a>Принцип работы

Когда устройство IoT Edge переходит в автономный режим, центр IoT Edge выполняет три роли. Во-первых, он хранит все сообщения, которые необходимо отправить, до тех пор, пока соединение с устройством не будет восстановлено. Во-вторых, он выступает от имени центра Интернета вещей и проверяет подлинность модулей и дочерних устройств, чтобы они продолжали работу. В-третьих, он обеспечивает связь между дочерними устройствами, которая обычно проходит через центр Интернета вещей.

В следующем примере показано, как IoT Edge работает в автономном режиме:

1. **Настройка устройств**

   Функция автономной работы включена на устройствах IoT Edge автоматически. Чтобы дать эту возможность другим устройствам Интернета вещей, необходимо объявить отношение "родитель-дочерний элемент" между устройствами в центре Интернета вещей. Затем вы настраиваете устройства ребенка, чтобы доверять назначенному родительскому устройству, и направите связь с устройством к облаку через родительский шлюз.

2. **Синхронизация с концентратором IoT**

   Хотя бы один раз после установки среды выполнения IoT Edge необходимо подключить устройство IoT Edge к сети для синхронизации с центром Интернета вещей. Во время синхронизации устройство IoT Edge получает сведения о назначенных ему дочерних устройствах. Устройство IoT Edge безопасно обновляет свой локальный кэш, чтобы можно было продолжать работу автономно, и извлекает параметры для локального хранения сообщений телеметрии.

3. **Перейти в автономный режим**

   При отключении от центра Интернета вещей устройств IoT Edge его развернутые модули и любые дочерние устройства Интернета вещей могут работать бесконечно. Модули и дочерние устройства могут запускаться и перезапускаться с прохождением аутентификации в центре IoT Edge в автономном режиме. Восходящий поток телеметрии в центр Интернета вещей хранится локально. Обмен данными между модулями или дочерними устройствами Интернета вещей поддерживается через прямые методы или сообщения.

4. **Воссоединение и ресинхронизация с помощью Концентратора IoT**

   После восстановления связи с центром Интернета вещей устройство IoT Edge будет снова синхронизировано. Локально сохраненные сообщения сразу же доставляются в концентратор IoT, но зависят от скорости соединения, задержки Концентратора IoT и связанных с ними факторов. Они доставляются в том же порядке, в котором они хранились.

   Все различия между требуемыми и сообщаемыми свойствами модулей и устройств будут согласованы. Устройство IoT Edge передает все изменения в свои назначенные дочерние устройства.

## <a name="restrictions-and-limits"></a>Ограничения

Расширенные возможности автономного номлайн, описанные в этой статье, доступны в [версии IoT Edge 1.0.7 или выше.](https://github.com/Azure/azure-iotedge/releases) Более ранние версии имеют подмножество автономных функций. Существующие устройства IoT Edge без расширенных возможностей автономной работы невозможно обновить, изменив версию среды выполнения. Необходимо изменить их конфигурацию с использованием нового удостоверения устройства IoT Edge, чтобы использовать эти функции.

В качестве детских устройств можно добавлять только устройства, не относяшиеся к IoT Edge.

Устройства IoT Edge и назначенные ими детские устройства могут функционировать в автономном режиме после первоначальной одноразовой синхронизации. Однако хранение сообщений зависит от времени для проживания (TTL) и доступного дискового пространства для хранения сообщений.

## <a name="set-up-parent-and-child-devices"></a>Настройка родительских и детских устройств

Для того чтобы устройство IoT Edge расширило свои расширенные автономные возможности на детские устройства IoT, необходимо выполнить два этапа. Во-первых, объявить отношения между родителями и детьми на портале Azure. Во-вторых, создать доверительные отношения между родительским устройством и любыми устройствами ребенка, а затем настроить коммуникации от устройства к облаку, чтобы пройти через родительский доступ в качестве шлюза.

### <a name="assign-child-devices"></a>Назначение дочерних устройств

Детские устройства могут быть любым устройством, не являющееся IoT Edge, зарегистрированным в том же концентраторе IoT. Родительские устройства могут иметь несколько детских устройств, но детское устройство имеет только одного родителя. Существует три варианта установки устройств для детей на устройство края: через портал Azure, с помощью Azure CLI или с помощью службы Концентратора IoT SDK.

В следующих разделах приводятся примеры того, как можно объявить отношения родителей и детей в Концентраторе IoT для существующих устройств IoT. Если вы создаете новые идентификаторы устройств для ваших детских устройств, см. [Authenticate ниже по течению устройства в Azure IoT концентратор](how-to-authenticate-downstream-device.md) для получения дополнительной информации.

#### <a name="option-1-iot-hub-portal"></a>Вариант 1: Портал IoT концентратор

При создании нового устройства можно объявить отношения между родителями и детьми. Или для существующих устройств можно объявить связь со страницы данных устройства либо родительского устройства IoT Edge, либо детского IoT-устройства.

   ![Управление дочерними устройствами на странице сведений об устройстве IoT Edge](./media/offline-capabilities/manage-child-devices.png)

#### <a name="option-2-use-the-az-command-line-tool"></a>Вариант 2: `az` Используйте инструмент командной строки

Используя [интерфейс командной строки Azure](https://docs.microsoft.com/cli/azure/?view=azure-cli-latest) с [расширением IoT](https://github.com/azure/azure-iot-cli-extension) (v0.7.0 или более новым), можно управлять отношениями родительского ребенка с подкомандами [устройства-идентификации.](https://docs.microsoft.com/cli/azure/ext/azure-cli-iot-ext/iot/hub/device-identity?view=azure-cli-latest) Приведенный ниже пример использует запрос для присвоения всем устройствам, не отчаиваемым ioT Edge, в концентраторе, детским устройствам устройства IoT Edge.

```azurecli
# Set IoT Edge parent device
egde_device="edge-device1"

# Get All IoT Devices
device_list=$(az iot hub query \
        --hub-name replace-with-hub-name \
        --subscription replace-with-sub-name \
        --resource-group replace-with-rg-name \
        -q "SELECT * FROM devices WHERE capabilities.iotEdge = false" \
        --query 'join(`, `, [].deviceId)' -o tsv)

# Add all IoT devices to IoT Edge (as child)
az iot hub device-identity add-children \
  --device-id $egde_device \
  --child-list $device_list \
  --hub-name replace-with-hub-name \
  --resource-group replace-with-rg-name \
  --subscription replace-with-sub-name
```

Можно изменить [запрос,](../iot-hub/iot-hub-devguide-query-language.md) чтобы выбрать другой подмножество устройств. Команда может занять несколько секунд, если указать большой набор устройств.

#### <a name="option-3-use-iot-hub-service-sdk"></a>Вариант 3: Использование службы концентратора IoT SDK

Наконец, можно программно управлять отношениями с родительскими детьми, используя s-, Java или Node.js IoT Hub Service SDK. Вот [пример присвоения детского устройства](https://aka.ms/set-child-iot-device-c-sharp) с помощью SDK C'SDK.

### <a name="set-up-the-parent-device-as-a-gateway"></a>Настройка родительского устройства в качестве шлюза

Отношения между родителями и детьми можно считать прозрачным шлюзом, где устройство ребенка имеет свою собственную идентичность в Концентре IoT, но общается через облако через своего родителя. Для безопасной связи устройство ребенка должно быть в состоянии проверить, что родительское устройство происходит из надежного источника. В противном случае третьи стороны могут настроить вредоносные устройства для того, чтобы выдавать себя за родителей и перехватывать сообщения.

Один из способов создания этого доверительного отношения подробно описан в следующих статьях:

* [Налажить устройство IoT Edge в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
* [Подключение устройства ниже по течению (детское) к шлюзу Azure IoT Edge](how-to-connect-downstream-device.md)

## <a name="specify-dns-servers"></a>Указание DNS-серверов

Для повышения надежности настоятельно рекомендуется указать адреса DNS-серверов, используемые в вашей среде. Чтобы настроить DNS-сервер для IoT Edge, см. разрешение [модуля Edge Agent, постоянно отчитывающееся о "пустом файле конфигурации", и в](troubleshoot.md#edge-agent-module-continually-reports-empty-config-file-and-no-modules-start-on-the-device) статье по устранению неполадок на устройстве не запускаются модули.

## <a name="optional-offline-settings"></a>Дополнительные параметры автономной работы

Если устройства переходят в автономный режим, родительское устройство IoT Edge хранит все сообщения от устройства к облаку до тех пор, пока соединение не будет восстановлено. Модуль концентратора IoT Edge управляет хранением и пересылкой сообщений в автономном режиме. Для устройств, которые могут переходить в автономный режим в течение длительных периодов времени, оптимизируйте производительность, настроив два настройки концентрата IoT Edge.

Во-первых, увеличьте время для работы, чтобы концентратор IoT Edge сохранял сообщения достаточно долго для повторного подключения устройства. Затем добавьте дополнительное место на диске для хранения сообщений.

### <a name="time-to-live"></a>Срок жизни

Срок жизни — это период времени (в секундах), в течение которого сообщение ожидает доставки, прежде чем срок его действия истечет. По умолчанию это 7200 секунд (два часа). Максимальное значение ограничено только максимальным значением переменной, которая составляет около 2 миллиардов.

Этот параметр является требуемым свойством центра IoT Edge, которое хранится в двойнике модуля. Вы можете настроить его на портале Azure или непосредственно в манифесте развертывания.

```json
"$edgeHub": {
    "properties.desired": {
        "schemaVersion": "1.0",
        "routes": {},
        "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
        }
    }
}
```

### <a name="host-storage-for-system-modules"></a>Хранилище хостов для системных модулей

Сообщения и сведения о состоянии модуля хранятся в локальной файловой файловой системе контейнера Концентратора IoT Edge по умолчанию. Для повышения надежности, особенно при работе в автономном режиме, можно также выделить хранилище на устройстве IoT Edge. Для получения дополнительной [информации см.](how-to-access-host-storage-from-module.md)

## <a name="next-steps"></a>Дальнейшие действия

Узнайте больше о том, как настроить прозрачный шлюз для подключений к родительскому/детскому устройству:

* [Налажить устройство IoT Edge в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
* [Аутентификация подчиненного устройства в Центре Интернета вещей](how-to-authenticate-downstream-device.md)
* [Подключение подчиненного устройства к шлюзу Azure IoT Edge](how-to-connect-downstream-device.md)
