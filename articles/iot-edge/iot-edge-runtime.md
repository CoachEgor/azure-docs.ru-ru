---
title: Сведения об управлении устройствами в среде выполнения — Azure IoT Edge | Документация Майкрософт
description: Узнайте, как среда выполнения IoT Edge управляет модулями, безопасностью, обменом данными и отчетами на устройствах.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/01/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: amqp, mqtt, devx-track-csharp
ms.openlocfilehash: 25493312854bbd495dce01f8f107b3e3320cb92c
ms.sourcegitcommit: 419cf179f9597936378ed5098ef77437dbf16295
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2020
ms.locfileid: "89016960"
---
# <a name="understand-the-azure-iot-edge-runtime-and-its-architecture"></a>Общие сведения о среде выполнения Azure IoT Edge и ее архитектуре

Среда выполнения IoT Edge — это набор программ, превращающих устройство в устройство IoT Edge. В совокупности компоненты среды выполнения IoT Edge позволяют устройствам IoT Edge получать код для выполнения на границе и передавать результаты.

Среда выполнения IoT Edge отвечает за следующие функции на IoT Edge устройствах:

* Установка и обновление рабочих нагрузок на устройстве.
* Техническое обслуживание стандартов безопасности Azure IoT Edge на устройстве.
* Убедитесь, что [модули IOT Edge](iot-edge-modules.md) всегда работают.
* Передача данных о состоянии работоспособности модуля в облако для удаленного мониторинга.
* Управление связью между подчиненными устройствами и IoT Edge устройствами.
* Управление связью между модулями на IoT Edge устройстве.
* Управление связью между устройством IoT Edge и облаком.

![Среда выполнения передает аналитические сведения и информацию о работоспособности модуля в Центр Интернета вещей](./media/iot-edge-runtime/Pipeline.png)

Обязанности среды выполнения IoT Edge делятся на две категории: обмен данными и управление модулями. Эти две роли выполняются двумя компонентами, которые являются частью среды выполнения IoT Edge.*Центр IOT Edge* отвечает за обмен данными, а *Агент IOT Edge* развертывает и отслеживает модули.

Агент IoT Edge и центр IoT Edge — это модули, и они, как и любые другие модули, выполняются на устройстве IoT Edge. Иногда они называются *модулями среды выполнения*.

## <a name="iot-edge-hub"></a>Концентратор IoT Edge

Центр IoT Edge — это один из двух модулей, составляющих среду выполнения Azure IoT Edge. Он действует в качестве локального прокси-сервера для Центра Интернета вещей, предоставляя те же конечные точки протокола, что и Центр Интернета вещей. Эта согласованность означает, что клиенты (устройства или модули) могут подключаться к среде выполнения IoT Edge так же, как к Центру Интернета вещей.

>[!NOTE]
> Центр IoT Edge поддерживает клиенты, подключающиеся с помощью MQTT или AMQP. Он не поддерживает клиенты, использующие HTTP.

Центр IoT Edge не является полной версией центра Интернета вещей, работающего локально. IoT Edge концентратор автоматически делегирует некоторые задачи в центр Интернета вещей. Например, центр IoT Edge переадресовывает запросы на проверку подлинности в Центр Интернета вещей при первом подключении устройства. После установки первого подключения сведения о безопасности будут кэшированы локально центром IoT Edge. Будущие подключения с этого устройства разрешены без необходимости повторной проверки подлинности в облаке.

Чтобы уменьшить пропускную способность, используемую решением IoT Edge, центр IoT Edge оптимизирует количество фактических подключений к облаку. Концентратор IoT Edge принимает логические соединения от модулей или подчиненных устройств и объединяет их для одного физического подключения к облаку. Сведения об этом процессе прозрачны для остальной части решения. Клиенты думают, что имеют собственное подключение к облаку, несмотря на то что передача данных выполняется через одно подключение.

![Центр IoT Edge — это шлюз между физическими устройствами и Центром Интернета вещей](./media/iot-edge-runtime/Gateway.png)

Центр IoT Edge может определить, подключен ли он к Центру Интернета вещей. Если подключение потеряно, центр IoT Edge сохранит сообщения или операции обновления двойников локально. Когда подключение будет снова установлено, он выполнит синхронизацию всех данных. Расположение, используемое для этого временного кэша, определяется свойством двойникаого модуля концентратора IoT Edge. Размер кэша не ограничен и будет увеличиваться, пока у устройства есть емкость хранилища.Дополнительные сведения см. в разделе [возможности автономного режима](offline-capabilities.md).

### <a name="module-communication"></a>Обмен данными между модулями

Центр IoT Edge облегчает обмен данными между модулями. Благодаря использованию центра IoT Edge в качестве брокера сообщений модули независимы друг от друга. Модулям необходимо указывать только те входы, на которые они принимают сообщения, и выходы, на которые они записывают сообщения. Разработчик решения может объединить эти входные и выходные данные вместе, чтобы модули обрабатывали данные в порядке, определенном для этого решения.

![Центр IoT Edge облегчает обмен данными между модулями](./media/iot-edge-runtime/module-endpoints.png)

Для отправки данных в центр IoT Edge модуль вызывает метод SendEventAsync. Первый аргумент указывает, в какой выход нужно отправить сообщение. Следующий псевдокод отправляет сообщение в **output1**:

   ```csharp
   ModuleClient client = await ModuleClient.CreateFromEnvironmentAsync(transportSettings);
   await client.OpenAsync();
   await client.SendEventAsync("output1", message);
   ```

Для получения сообщений зарегистрируйте обратный вызов, который обрабатывает сообщения, приходящие в определенный вход. Следующий псевдокод регистрирует функцию Мессажепроцессор, которая будет использоваться для обработки всех сообщений, полученных в **INPUT1**:

   ```csharp
   await client.SetInputMessageHandlerAsync("input1", messageProcessor, userContext);
   ```

Дополнительные сведения о классе модулеклиент и его методах связи см. в справочнике по API для вашего предпочтительного языка SDK: [C#](https://docs.microsoft.com/dotnet/api/microsoft.azure.devices.client.moduleclient?view=azure-dotnet), [C](https://docs.microsoft.com/azure/iot-hub/iot-c-sdk-ref/iothub-module-client-h), [Python](https://docs.microsoft.com/python/api/azure-iot-device/azure.iot.device.iothubmoduleclient?view=azure-python), [Java](https://docs.microsoft.com/java/api/com.microsoft.azure.sdk.iot.device.moduleclient?view=azure-java-stable)или [Node.js](https://docs.microsoft.com/javascript/api/azure-iot-device/moduleclient?view=azure-node-latest).

Разработчик решений отвечает за указание правил, определяющих, как центр IoT Edge передает сообщения между модулями. Правила маршрутизации определяются в облаке и передаются в IoT Edge Hub в своем модуле двойника. Тот же синтаксис для маршрутов Центра Интернета вещей используется при определении маршрутов между модулями в Azure IoT Edge. Подробную информацию см. в статье [Сведения о развертывании модулей и настройке маршрутов в IoT Edge](module-composition.md).

![Маршруты между модулями проходят через центр IoT Edge](./media/iot-edge-runtime/module-endpoints-with-routes.png)

## <a name="iot-edge-agent"></a>Агент IoT Edge

Агент IoT Edge — это другой модуль, который составляет среду выполнения Azure IoT Edge. Он отвечает за создание экземпляров модулей, обеспечивая их работу и сообщение о состоянии модулей обратно в Центр Интернета вещей. Эти данные конфигурации записываются как свойство модуля IoT Edge агента двойника.

[Управляющая программа безопасности IoT Edge](iot-edge-security-manager.md) запускает агент IoT Edge при запуске устройства. Агент получает свой двойник модуля из Центра Интернета вещей и проверяет манифест развертывания. Манифест развертывания — это файл JSON, который объявляет необходимые для запуска модули.

Каждый элемент в манифесте развертывания содержит определенные сведения о модуле и используется агентом IoT Edge для управления жизненным циклом модуля. Ниже приведены некоторые из наиболее интересных свойств:

* **settings.image**. Образ контейнера, который агент IoT Edge использует для запуска модуля. Агент IoT Edge должен быть настроен с учетными данными для реестра контейнеров, если образ защищен паролем. Учетные данные для реестра контейнеров можно настроить удаленно с помощью манифеста развертывания или на самом устройстве IoT Edge, обновив файл `config.yaml` в папке программы IoT Edge.
* **Settings. креатеоптионс** — строка, которая передается непосредственно в управляющую программу-контейнер значок Кита при запуске контейнера модуля. Добавление параметров в это свойство позволяет выполнять дополнительные настройки, такие как пересылка портов или подключение томов, в контейнер модуля.  
* **status**. Состояние, в котором агент IoT Edge помещает модуль. Обычно для этого параметра задано значение *работает* , так как большинство пользователей хотят, чтобы агент IOT Edge сразу же запустить все модули на устройстве. Однако можно указать начальное состояние модуля, который должен быть остановлен, и дождаться нужного времени, чтобы сообщить агенту IoT Edge о запуске модуля.Агент IoT Edge сообщает состояние каждого модуля обратно в облако в сообщаемых свойствах. Различие между требуемым свойством и сообщаемым свойством является индикатором некорректно работающего устройства. Ниже перечислены поддерживаемые состояния:

  * Загрузка
  * Выполнение
  * Unhealthy
  * Сбой
  * Остановлена

* **restartPolicy**. То, как агент IoT Edge перезапускает модуль. Ниже перечислены возможные значения.
  
  * `never` — Агент IoT Edge никогда не перезапускает модуль.
  * `on-failure` — Если модуль завершается сбоем, агент IoT Edge перезапускает его. Если модуль завершает работу аккуратно, агент IoT Edge не перезапускает его.
  * `on-unhealthy` — Если модуль завершается сбоем или считается неработоспособным, агент IoT Edge перезапускает его.
  * `always` — Если модуль завершается сбоем, считается неработоспособным или завершает работу каким-либо образом, агент IoT Edge перезапускает его.

* **имажепуллполици** — указывает, пытается ли агент IOT EDGE автоматически запрашивать последнюю версию образа для модуля. Если значение не указано, используется значение по умолчанию — *OnCreate*. Ниже перечислены возможные значения.

  * `on-create` — При запуске модуля или обновлении модуля на основе нового манифеста развертывания агент IoT Edge будет пытаться извлечь образ модуля из реестра контейнеров.
  * `never` — Агент IoT Edge никогда не будет пытаться извлечь образ модуля из реестра контейнеров. В этой конфигурации вы несете ответственность за получение образа модуля на устройстве и управление обновлениями образа.

Агент IoT Edge отправляет ответ среды выполнения в центр Интернета вещей. Ниже перечислены возможные ответы:
  
* 200 – OK
* 400 — конфигурация развертывания имеет неправильный формат или недопустима.
* 417-у устройства нет набора конфигураций развертывания.
* 412 — версия схемы в конфигурации развертывания недопустима.
* 406 — устройство IoT Edge работает в автономном режиме или не отправляет отчеты о состоянии.
* 500 — в среде выполнения IoT Edge произошла ошибка.

Подробную информацию см. в статье [Сведения о развертывании модулей и настройке маршрутов в IoT Edge](module-composition.md).

### <a name="security"></a>Безопасность

Агент IoT Edge играет важную роль в обеспечении безопасности устройства IoT Edge. Например, он выполняет такие действия, как проверка образа модуля перед его запуском.

Дополнительные сведения о Azure IoT Edgeной платформе безопасности см. в статье [Диспетчер безопасности IOT Edge](iot-edge-security-manager.md).

## <a name="next-steps"></a>Дальнейшие действия

[Общие сведения о модулях Azure IoT Edge](iot-edge-modules.md)
