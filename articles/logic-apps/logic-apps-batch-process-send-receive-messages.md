---
title: Пакетные обработки сообщений как группы
description: Отправка и получение сообщений в группах между рабочими процессами с помощью пакетной обработки в приложениях логики Azure
services: logic-apps
ms.suite: integration
author: divyaswarnkar
ms.author: divswa
ms.reviewer: estfan, jonfan, logicappspm
ms.topic: article
ms.date: 01/16/2019
ms.openlocfilehash: e48d2bb2ffce0dd4f9293417534165165d426784
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75666760"
---
# <a name="send-receive-and-batch-process-messages-in-azure-logic-apps"></a>Отправка, получение и пакетная обработка сообщений в Azure Logic Apps

Чтобы отправлять и обрабатывать сообщения, сгруппировав их определенным образом, можно создать решение пакетной обработки. Такое решение собирает сообщения в *пакеты*, ожидая, пока не будут достигнуты определенные условия для отправки и обработки сообщений в этих пакетах. Пакетная обработка помогает снизить частоту обработки сообщений в приложении логики. В этой статье описано, как подготовить решение пакетной обработки, создав два приложения логики в одной подписке и регионе Azure и выполнив следующие действия в указанном порядке: 

* Приложение логики для [получения пакета](#batch-receiver) ("получатель"), которое принимает и собирает сообщения в пакет до тех пор, пока не будут выполнены определенные условия для отправки и обработки этих сообщений.

  Сначала создайте получатель пакетов, чтобы потом при создании отправителя пакетов можно было выбрать назначение для пакетов.

* Одно или несколько приложений логики для [отправки пакетов](#batch-sender) ("отправители"), которые отправляют сообщения ранее созданному получателю пакетов. 

   Вы также можете указать уникальный ключ, например номер клиента, чтобы *секционировать* (разделить) по этому ключу целевой пакет на подмножества. Это позволит получающему приложению получать все элементы с одинаковыми значениями ключа и обрабатывать их одновременно.

Убедитесь, что для получателя и отправителя пакетов используется одна и та же подписка Azure *и* регион Azure. В противном случае при создании отправителя пакетов вы не сможете выбрать получателя пакетов, так как они не видны друг другу.

## <a name="prerequisites"></a>Предварительные требования

Для выполнения этого примера необходимы следующие компоненты:

* Подписка Azure. Если у вас нет подписки, вы можете [начать с бесплатной учетной записи Azure.](https://azure.microsoft.com/free/) Или [зарегистрируйтесь для получения подписки с оплатой по мере использования](https://azure.microsoft.com/pricing/purchase-options/).

* Учетная запись электронной почты любого [поставщика электронной почты, поддерживаемого Azure Logic Apps](../connectors/apis-list.md).

* Основные знания о [том, как создавать логические приложения](../logic-apps/quickstart-create-first-logic-app-workflow.md) 

* Чтобы использовать Visual Studio, а не портал Azure, [настройте Visual Studio для работы с приложениями логики](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md).

<a name="batch-receiver"></a>

## <a name="create-batch-receiver"></a>Создание получателя пакетов

Прежде чем вы сможете отправлять сообщения в пакет, такой пакет должен существовать как назначение для отправки. Поэтому сначала необходимо создать приложение логики для получения пакета, которое запускает триггер **Пакет**. Тогда при создании приложения логики для отправки пакетов вы сможете выбрать это приложение логики для получения пакетов. Получатель пакетов продолжает собирать сообщения до тех пор, пока не будут выполнены определенные условия для отправки и обработки этих сообщений. Получателям пакетов не требуются сведения об отправителях пакетов, но отправители должны знать параметры назначения для отправки сообщений. 

1. На [портале Azure](https://portal.azure.com) или в Visual Studio создайте приложение логики с именем BatchReceiver. 

2. В конструкторе Logic Apps добавьте триггер **Пакет**, который запускает рабочий процесс приложения логики. В поле поиска введите слово "пакет" в качестве фильтра. Выберите триггер **Пакетные сообщения**.

   ![Добавление триггера "Пакетные сообщения"](./media/logic-apps-batch-process-send-receive-messages/add-batch-receiver-trigger.png)

3. Задайте эти свойства для получения пакетов: 

   | Свойство | Описание | 
   |----------|-------------|
   | **Пакетный режим** | - **Встроенный** — позволяет определить условия отправки прямо в триггере пакета. <br>- **Учетная запись интеграции** — позволяет определить несколько конфигураций для условий отправки с помощью [учетной записи интеграции](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md). Благодаря учетной записи интеграции эти конфигурации можно сохранять в одном расположении, а не в отдельных приложениях логики. | 
   | **Имя пакета** | В нашем примере пакет имеет имя TestBatch. Этот параметр применяется только к **встроенному** пакетному режиму. |  
   | **Условия отправки** | Применяется только ко **встроенному** пакетному режиму и определяет критерии, которые должны выполняться для обработки каждого пакета: <p>- **Количество сообщений на основе**: Отпустите пакет на основе количества сообщений, собранных пакетом. <br>- **Размер на основе**: Отпустите пакет на основе общего размера в байтах для всех сообщений, собранных этой партии. <br>- **Расписание**: Отпустите пакет на основе графика повторения, который определяет интервал и частоту. В дополнительных параметрах можно также выбрать часовой пояс и указать дату начала и время. <br>- **Выбрать все**. Задает использование всех настроенных условий. | 
   | **Граф сообщений** | Определяет, сколько сообщений нужно собрать в одном пакете (например, 10). Ограничение пакета — 8000 сообщений. | 
   | **Размер пакета** | Общий размер в байтах для сбора в пакете (например, 10 МБ). Ограничение размера пакета — 80 МБ. | 
   | **Расписание** | Определяет интервал и частоту отправки пакетов (например, 10 минут). Минимальное значение повторов составляет 60 секунд (1 минута). Дробные значения минут округляются до 1 минуты. Чтобы указать часовой пояс или дату и время начала, выберите **Показать расширенные параметры**. | 
   ||| 

   > [!NOTE]
   > 
   > Если вы изменяете условие выпуска, когда в триггере еще есть пакетные неотправленные сообщения, триггер использует обновленные критерии выпуска для обработки неотправленных сообщений. 

   В этом примере показаны все условия, но в своих тестах попробуйте выполнить только один критерий:

   ![Ввод сведений для триггера "Пакет"](./media/logic-apps-batch-process-send-receive-messages/batch-receiver-criteria.png)

4. Теперь добавьте одно или несколько действий для обработки каждого пакета. 

   В нашем примере добавляется действие, которое отправляет сообщение электронной почты, когда срабатывает триггер "Пакет". 
   Этот триггер запускается и отправляет сообщение электронной почты, когда в пакете собирается 10 сообщений, их общий размер достигает 10 МБ или проходит 10 минут.

   1. В области триггера "Пакет" щелкните **Новый шаг**.

   2. В поле поиска введите "отправка сообщения" в качестве условия фильтра.
   Выберите соединитель электронной почты в зависимости от своего поставщика электронной почты.

      Например, если у вас есть личная учетная запись (например, @outlook.com или @hotmail.com), выберите соединитель Outlook.com. 
      Если у вас учетная запись Gmail, то выберите соединитель Gmail. 
      В этом примере используется Office 365 Outlook. 

   3. Выберите это действие: **Отправить сообщение электронной почты — <*поставщик услуг электронной почты*>**.

      Пример:

      ![Выбор действия "Отправить электронное письмо" для поставщика электронной почты](./media/logic-apps-batch-process-send-receive-messages/batch-receiver-send-email-action.png)

5. Если отобразится запрос на вход в учетную запись электронной почты, выполните его. 

6. Задайте свойства для добавленного действия.

   * В поле **Кому** введите адрес электронной почты получателя. 
   Для тестировании можете использовать свой собственный адрес.

   * В поле **Тема**, когда отобразится список динамического содержимого, выберите поле **Имя секции**.

     ![Выбор значения "Имя секции" в списке "Динамическое содержимое"](./media/logic-apps-batch-process-send-receive-messages/send-email-action-details.png)

     В следующем отправителе пакетов можно указать уникальный ключ секции, который разделит целевой пакет на логические наборы, в которые затем можно отправлять сообщения. 
     Каждый набор имеет уникальный номер, который создается приложением логики, отправляющим пакеты. 
     Эта функция позволяет использовать один пакет с несколькими подмножествами и определить каждое подмножество с помощью задаваемого имени.

     > [!IMPORTANT]
     > Раздел имеет ограничение в 5000 сообщений или 80 МБ. Если выполняется любое из этих условий, Logic Apps отправит очередной пакет даже без соблюдения условия отправки.

   * В поле **Текст**, когда отобразится список динамического содержимого, выберите поле **Идентификатор сообщения**. 

     Конструктор Logic Apps автоматически добавляет цикл For each для действия отправки электронной почты, так как это действие рассматривает выходные данные с предыдущего действия как коллекцию, а не пакет. 

     ![Выбор значения "Идентификатор сообщения" для поля "Текст"](./media/logic-apps-batch-process-send-receive-messages/send-email-action-details-for-each.png)

7.  Сохраните приложение логики. Итак, вы создали получатель пакетов.

    ![Сохранение приложения логики](./media/logic-apps-batch-process-send-receive-messages/save-batch-receiver-logic-app.png)

8. Если вы используете Visual Studio, [разверните приложение логики для получения пакетов в Azure](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md#deploy-logic-app-to-azure). В противном случае вы не сможете выбрать этот получатель пакетов при создании отправителя пакетов.

<a name="batch-sender"></a>

## <a name="create-batch-sender"></a>Создание отправителя пакетов

Теперь создайте одно или несколько приложений логики, которые отправляют пакеты сообщений в приложение логики для получения пакетов. В каждом отправителе пакетов укажите получатель пакетов, имя пакета, содержимое сообщения и другие параметры. При необходимости можно указать уникальный ключ раздела, чтобы разделить пакет на логические подмножества для сбора сообщений с помощью этого ключа. 

* Убедитесь, что вы уже [создали получатель пакетов](#batch-receiver), чтобы при создании отправителя пакетов можно было выбрать имеющийся получатель пакетов в качестве назначения. Получателям пакетов не требуются сведения об отправителях пакетов, но отправители должны знать параметры назначения для отправки сообщений. 

* Убедитесь, что для получателя и отправителя пакетов используется одна и та же подписка Azure *и* один регион Azure. В противном случае при создании отправителя пакетов вы не сможете выбрать получателя пакетов, так как они не видны друг другу.

1. Создайте второе приложение логики с именем BatchSender.

   1. В поле поиска введите слово "повторение" в качестве фильтра. 
   Выберите триггер **Расписание — повторение**.

      ![Добавление триггера "Расписание — повторение".](./media/logic-apps-batch-process-send-receive-messages/add-schedule-trigger-batch-sender.png)

   2. Задайте частоту и интервал, чтобы отправляющее приложение логики запускалось каждую минуту.

      ![Настройка частоты и интервала триггера повторения](./media/logic-apps-batch-process-send-receive-messages/recurrence-trigger-batch-sender-details.png)

2. Добавьте новое действие для отправки сообщений в пакет.

   1. В области триггера повторения выберите **Новый шаг**.

   2. В поле поиска введите слово "пакет" в качестве фильтра. 
   Выберите список **Действия**, а затем выберите это действие: **Выберите рабочий процесс Logic Apps с триггером пакета — Отправить сообщения в пакет**.

      ![Выбор действия "Выберите рабочий процесс Logic Apps с триггером пакета"](./media/logic-apps-batch-process-send-receive-messages/send-messages-batch-action.png)

   3. Теперь выберите приложение логики для получения пакетов, которое вы создали ранее.

      ![Выбор приложения логики для "получения пакета"](./media/logic-apps-batch-process-send-receive-messages/batch-sender-select-batch-receiver.png)

      > [!NOTE]
      > В этом списке также отображаются все прочие приложения логики, которые содержат триггеры пакетной обработки. 
      > 
      > Если вы используете Visual Studio и не видите доступных для выбора получателей пакетов, убедитесь, что вы развернули получатель пакетов в Azure. В противном случае изучите инструкции по [развертыванию приложения логики для получения пакетов в Azure](../logic-apps/quickstart-create-logic-apps-with-visual-studio.md#deploy-logic-app-to-azure). 

   4. Выберите действие: **Batch_messages (Пакетировать сообщения) — <*получатель_пакетов*>**.

      ![Выбор действия "Batch_messages (Пакетировать сообщения) — <приложение_логики>"](./media/logic-apps-batch-process-send-receive-messages/batch-sender-select-batch.png)

3. Задайте свойства для отправителя пакетов.

   | Свойство | Описание | 
   |----------|-------------| 
   | **Имя пакета** | Имя пакета, определяемое принимающим приложением логики. В нашем примере это TestBatch. <p>**Важно**! Имя пакета проверяется во время выполнения. Оно должно совпадать с именем, указанным в принимающем приложении логики. Изменение имени пакета приводит к сбою в работе приложения логики для отправки пакета. | 
   | **Содержимое сообщения** | Содержимое сообщения, которое вы хотите отправить | 
   ||| 

   В нашем примере добавляется следующее выражение, которое вставляет текущую дату и время в сообщение, отправляемое в пакет:

   1. Щелкните в любом месте поля **Содержимое сообщения**. 

   2. Когда отобразится список динамического содержимого, выберите **Выражение**. 

   3. Введите выражение `utcnow()` и щелкните **ОК**. 

      ![В поле "Содержимое сообщения" выберите "Выражение", введите utcnow() и щелкните "ОК".](./media/logic-apps-batch-process-send-receive-messages/batch-sender-details.png)

4. Теперь настройте для пакета секцию. В действии BatchReceiver выберите **Показать расширенные параметры** и настройте следующие параметры:

   | Свойство | Описание | 
   |----------|-------------| 
   | **Имя секции** | Необязательный уникальный ключ раздела для разбивки отправляемых пакетов на логические подмножества и сбора сообщений с учетом этого ключа. | 
   | **Идентификатор сообщения** | Необязательный идентификатор сообщения. Если значение не указано, автоматически генерируется глобально уникальный идентификатор (GUID). | 
   ||| 

   В нашем примере добавьте в поле **Имя раздела** выражение, которое генерирует случайное число от 1 до 5. Оставьте пустым поле **Идентификатор сообщения**.
   
   1. Щелкните внутри поля **Имя раздела**, чтобы отобразить динамический список содержимого. 

   2. В списке динамического содержимого выберите **Выражение**.
   
   3. Введите выражение `rand(1,6)` и щелкните **ОК**.

      ![Настройка секции для целевого пакета](./media/logic-apps-batch-process-send-receive-messages/batch-sender-partition-advanced-options.png)

      Эта функция **rand** генерирует число от 1 до 5. 
      То есть пакет разделяется на пять нумерованных секций, которые динамически задаются этим выражением.

5. Сохраните приложение логики. Теперь ваше отправляющее приложение логики выглядит примерно так:

   ![Сохранение отправляющего приложения логики](./media/logic-apps-batch-process-send-receive-messages/batch-sender-finished.png)

## <a name="test-your-logic-apps"></a>Тестирование приложений логики

Чтобы проверить решение пакетной обработки, запустите приложения логики и дайте им поработать несколько минут. Скоро вы начнете получать сообщения электронной почты группами по пять сообщений. Все они будут иметь один ключ секции.

Приложение логики для отправки пакетов запускается каждую минуту, генерирует случайное число в диапазоне от 1 до 5 и использует это число в качестве ключа секции для целевого пакета, в который отправляются сообщения. Когда в пакете собирается пять элементов с одинаковым ключом секции, приложение логики для получения пакетов активируется и отправляет сообщения электронной почты для каждого элемента.

> [!IMPORTANT]
> После выполнения проверки убедитесь, что приложение логики BatchSender отключено, чтобы оно прекратило отправлять сообщения и не перегружало папку "Входящие".

## <a name="next-steps"></a>Дальнейшие действия

* [Отправка сообщений EDI в пакетах торговым партнерам с помощью Azure Logic Apps](../logic-apps/logic-apps-scenario-edi-send-batch-messages.md)
* [Создание определений рабочих процессов для приложений логики с помощью JSON](../logic-apps/logic-apps-author-definitions.md)
* [Создание бессерверного приложения в Visual Studio с использованием приложений логики и функций](../logic-apps/logic-apps-serverless-get-started-vs.md)
* [Сценарий обработки исключений и ведения журнала ошибок для приложений логики](../logic-apps/logic-apps-scenario-error-and-exception-handling.md)
