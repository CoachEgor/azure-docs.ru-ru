---
title: Установка локального шлюза данных — Azure Logic Apps
description: Чтобы получить доступ к данным в локальной среде из Azure Logic Apps, нужно скачать и установить локальный шлюз данных.
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: arthii, LADocs
ms.topic: article
ms.date: 07/01/2019
ms.openlocfilehash: 657bc704e33e89b1646dffa6123a27169e6c317a
ms.sourcegitcommit: 65131f6188a02efe1704d92f0fd473b21c760d08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2019
ms.locfileid: "70860774"
---
# <a name="install-on-premises-data-gateway-for-azure-logic-apps"></a>Установка локального шлюза данных для Azure Logic Apps

Прежде чем подключиться к локальным источникам данных из Azure Logic Apps, необходимо загрузить и установить локальный шлюз данных на локальном компьютере. Этот шлюз работает как мост для шифрования и быстрой передачи данных между локальными источниками данных (не в облаке) и приложениями логики. Вы можете использовать ту же установку шлюза с другими облачными службами, такими как Power BI, Microsoft Flow, PowerApps и Azure Analysis Services. Сведения об использовании шлюза с этими службами см. в следующих статьях:

* [Локальный шлюз данных](https://powerbi.microsoft.com/documentation/powerbi-gateway-onprem/)
* [Управление локальным шлюзом данных в PowerApps](https://powerapps.microsoft.com/tutorials/gateway-management/)
* [Управление локальным шлюзом данных в Microsoft Flow](https://flow.microsoft.com/documentation/gateway-manage/)
* [Локальный шлюз данных](../analysis-services/analysis-services-gateway.md)

В этой статье показано, как скачать, установить и настроить локальный шлюз данных, чтобы получить доступ к локальным источникам данных из Azure Logic Apps. Дополнительные сведения о [работе шлюза данных см](#gateway-cloud-service) . Далее в этом разделе.

<a name="supported-connections"></a>

Шлюз поддерживает [локальные соединители](../connectors/apis-list.md#on-premises-connectors) для следующих источников данных в Azure Logic Apps.

* BizTalk Server 2016
* Файловая система
* IBM DB2  
* IBM Informix
* IBM MQ
* MySQL
* Oracle Database
* PostgreSQL
* SAP
* SharePoint Server
* SQL Server
* Teradata

Хотя шлюз не требует дополнительных затрат, [модель ценообразования Logic Apps](../logic-apps/logic-apps-pricing.md) применяется к этим соединителям и другим операциям в Azure Logic Apps.

<a name="requirements"></a>

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, [зарегистрируйтесь для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

  * Для установки и администрирования шлюза необходимо использовать одну и ту же учетную запись Azure. Во время установки эта учетная запись Azure используется для связывания шлюза на компьютере с подпиской Azure. Позже вы используете ту же учетную запись Azure при создании ресурса Azure в портал Azure для установки шлюза. 

  * Необходимо выполнить вход с помощью рабочей учетной записи или учебной учетной записи, которая также называется учетной записью `username@contoso.com`Организации, которая выглядит как. Вы не можете использовать учетные записи Azure B2B (гостевые) или личные учетные @outlook.comзаписи Майкрософт, например @hotmail.com или.

    > [!TIP]
    > Если вы зарегистрировались в предложении Office 365 и не представите свой рабочий адрес электронной почты, ваш адрес `username@domain.onmicrosoft.com`может выглядеть так. Ваша учетная запись хранится в клиенте в Azure Active Directory (Azure AD). В большинстве случаев имя участника-пользователя (UPN) для учетной записи Azure AD совпадает с адресом электронной почты.
    >
    > Чтобы использовать [стандартную подписку Visual Studio](https://visualstudio.microsoft.com/vs/pricing/) , связанную с учетная запись Майкрософт, сначала [Создайте клиент в Azure AD](../active-directory/develop/quickstart-create-new-tenant.md)или используйте каталог по умолчанию. Добавьте в каталог пользователя с паролем, а затем предоставьте этому пользователю доступ к своей подписке. 
    > Затем вы можете войти в систему во время установки шлюза, используя эти имя пользователя и пароль.

* Требования для локального компьютера приведены ниже.

  **Минимальные требования**

  * .NET Framework 4.6
  * 64-разрядная версия Windows 7 или Windows Server 2008 R2 (или более поздняя версия).

  **Рекомендуемые требования**

  * 8-ядерный ЦП.
  * 8 ГБ ОЗУ.
  * 64-разрядная версия Windows Server 2012 R2 или более поздней версии
  * Хранилище твердотельных накопителей (SSD) для буферизации

  > [!NOTE]
  > Шлюз не поддерживает Windows Server 2016 Core.

* **Связанные вопросы**

  * Локальный шлюз данных должен быть установлен только на локальном компьютере, который не является контроллером домена. Тем не менее не нужно устанавливать шлюз на компьютере, на котором размещен источник данных. Вам нужен только один шлюз для всех источников данных, поэтому вам не нужно устанавливать шлюз для каждого источника данных.

    > [!TIP]
    > Чтобы свести к минимуму задержки, шлюз можно установить как можно ближе к источнику данных или даже на том же компьютере, если только у вас есть соответствующие разрешения.

  * Установите шлюз на компьютере, который находится в проводной сети, подключенном к Интернету, всегда включается и не переходит в спящий режим. В противном случае шлюз не сможет работать, и производительность может снизиться по беспроводной сети.

  * Если вы планируете использовать проверку подлинности Windows, убедитесь, что шлюз установлен на компьютере, который является членом той же среды Active Directory, что и источники данных.

  * Регион, выбранный для установки шлюза, является тем же расположением, которое необходимо выбрать при последующем создании ресурса шлюза Azure для приложения логики. По умолчанию этот регион совпадает с расположением клиента Azure AD, который управляет учетной записью Azure. Однако расположение можно изменить во время установки шлюза.

  * Шлюз имеет два режима: Стандартный и личный режим, который применяется только к Power BI. На одном компьютере нельзя запустить несколько шлюзов в одном и том же режиме.

<a name="install-gateway"></a>

## <a name="install-data-gateway"></a>Установка шлюза данных

1. [Скачайте и запустите установщик шлюза на локальном компьютере](https://aka.ms/on-premises-data-gateway-installer).

1. После открытия установщика нажмите кнопку **Далее**.

   ![Введение в установщик](./media/logic-apps-gateway-install/gateway-intro-screen.png)

1. Выберите **локальный шлюз данных (рекомендуется)** , который является стандартным режимом, и нажмите кнопку **Далее**.

   ![Выбор режима шлюза](./media/logic-apps-gateway-install/select-gateway-mode.png)

1. Просмотрите минимальные требования, оставьте путь установки по умолчанию, примите условия использования и нажмите кнопку **установить**.

   ![Проверка требований и принятие условий использования](./media/logic-apps-gateway-install/accept-terms.png)

1. После успешной установки шлюза укажите адрес электронной почты для учетной записи организации, а затем выберите **Вход**, например:

   ![Выполнение входа в рабочую или учебную учетную запись](./media/logic-apps-gateway-install/sign-in-gateway-install.png)

   Теперь вы вошли в свою учетную запись.

1. **Далее**выберите **зарегистрировать новый шлюз на этом компьютере** > . Этот шаг регистрирует установку шлюза в [облачной службе шлюза](#gateway-cloud-service).

   ![Зарегистрировать шлюз](./media/logic-apps-gateway-install/register-gateway.png)

1. Для установки шлюза необходимо указать следующие сведения.

   * Имя шлюза, уникальное для клиента Azure AD
   * Ключ восстановления, который должен содержать по крайней мере восемь символов, которые вы хотите использовать.
   * Подтверждение ключа восстановления

   ![Настойка шлюза](./media/logic-apps-gateway-install/set-up-gateway.png)

   > [!IMPORTANT]
   > Сохраните и держите ключ восстановления в безопасном месте. Этот ключ необходим, если вам когда-либо нужно изменить расположение, переместить, восстановить или перехватить установку шлюза.

   Обратите внимание на возможность **добавления в существующий кластер шлюза**, который выбирается при установке дополнительных шлюзов для [сценариев с высоким уровнем доступности](#high-availability).

1. Проверьте регион облачной службы шлюза и служебной [шины Azure](https://azure.microsoft.com/services/service-bus/) , которая используется для установки шлюза. По умолчанию этот регион совпадает с расположением клиента Azure AD для вашей учетной записи Azure.

   ![Проверка региона](./media/logic-apps-gateway-install/check-region.png)

1. Чтобы принять регион по умолчанию, щелкните **настроить**. Однако если область по умолчанию не является ближайшим к вам, можно изменить регион.

   *Причины изменения региона установки шлюза.*

   Например, чтобы уменьшить задержку, можно изменить регион своего шлюза на тот регион, что и в приложении логики. Или можно выбрать регион, который находится ближе всего к локальному источнику данных. *Ресурс шлюза в Azure* и приложение логики могут размещаться в разных расположениях.

   1. Рядом с текущим регионом выберите **Изменить регион**.

      ![Изменение региона](./media/logic-apps-gateway-install/change-region.png)

   1. На следующей странице откройте список **Выбор региона** , выберите нужный регион и нажмите кнопку **Готово**.

      ![Выберите другой регион](./media/logic-apps-gateway-install/select-region-gateway-install.png)

1. Проверьте сведения в окончательном окне подтверждения. В этом примере используется та же учетная запись для Logic Apps, Power BI, PowerApps и Microsoft Flow, поэтому шлюз доступен для всех этих служб. Когда будете готовы, нажмите кнопку **Закрыть**.

   ![Завершение подключения шлюза](./media/logic-apps-gateway-install/finished-gateway-default-location.png)

1. Теперь [Создайте ресурс Azure для установки шлюза](../logic-apps/logic-apps-gateway-connection.md).

<a name="high-availability"></a>

## <a name="high-availability-support"></a>Поддержка высокой доступности

Чтобы избежать единой точки отказа для доступа к локальному доступу к данным, можно установить несколько вариантов шлюза (только для стандартного режима) с каждым на разных компьютерах и настроить их как кластер или группу. Таким образом, если основной шлюз недоступен, запросы данных направляются на второй шлюз и т. д. Так как на компьютере можно установить только один стандартный шлюз, необходимо установить каждый дополнительный шлюз, который находится в кластере, на другом компьютере. Все соединители, работающие с локальным шлюзом данных, поддерживают высокий уровень доступности. 

* Для этой установки требуется наличие хотя бы одного установленного шлюза в той же подписке Azure, в которой находятся основной шлюз и ключ восстановления.

* На основном шлюзе должны быть установлены обновления от ноября 2017 г. или более ранние.

После настройки основного шлюза, когда вы переходите к установке другого шлюза, выберите **Добавить в существующий кластер шлюза**, выберите основной шлюз, который является первым установленным шлюзом, и укажите ключ восстановления для этого шлюза. Дополнительные сведения см. в разделе [Кластеры с высоким уровнем доступности для локальных шлюзов данных](https://docs.microsoft.com/data-integration/gateway/service-gateway-install#add-another-gateway-to-create-a-cluster).

<a name="update-gateway-installation"></a>

## <a name="change-location-migrate-restore-or-take-over-existing-gateway"></a>Изменение расположения, миграции, восстановления или перехват имеющегося шлюза

Если необходимо изменить расположение шлюза, переместить установку шлюза на новый компьютер, восстановить поврежденный шлюз или использовать владельца существующего шлюза, вам потребуется ключ восстановления, предоставленный во время установки шлюза.

1. Запустите установщик шлюза на компьютере с имеющимся шлюзом. Если у вас нет последнего установщика шлюза, [скачайте последнюю версию шлюза](https://aka.ms/on-premises-data-gateway-installer).

   > [!NOTE]
   > Перед восстановлением шлюза на компьютере с исходной установкой шлюза необходимо сначала удалить шлюз на этом компьютере. Это действие отключает исходный шлюз.
   > Если вы удалите или удалите кластер шлюза для любой облачной службы, вы не сможете восстановить этот кластер.

1. После открытия установщика Войдите в систему, используя ту же учетную запись Azure, которая использовалась для установки шлюза.

1. Выберите **миграция, восстановление или перенаправление существующий шлюз** >  **, например**:

   ![Выберите "Перенос, восстановление или перехват имеющегося шлюза"](./media/logic-apps-gateway-install/migrate-recover-take-over-gateway.png)

1. Выберите из доступных кластеров и шлюзов и введите ключ восстановления для выбранного шлюза, например:

   ![Выбор шлюза](./media/logic-apps-gateway-install/select-existing-gateway.png)

1. Чтобы изменить регион, щелкните **изменить регион**и выберите новый регион.

1. Когда будете готовы, нажмите кнопку **настроить** , чтобы завершить выполнение задачи.

## <a name="configure-proxy-or-firewall"></a>Настройка прокси-сервера или брандмауэра

Если ваша рабочая среда требует, чтобы трафик проработал через прокси-сервер для доступа к Интернету, это ограничение может препятствовать подключению локального шлюза данных к облачной службе шлюза и служебной [шине Azure](../service-bus-messaging/service-bus-messaging-overview.md). Дополнительные сведения см. в статье [Настройка параметров прокси-сервера для локального шлюза данных](https://docs.microsoft.com/power-bi/service-gateway-proxy).

Чтобы проверить, может ли ваш прокси-сервер или брандмауэр блокировать подключения, проверьте, действительно ли ваш компьютер подключается к Интернету и служебной шине Azure. В командной строке PowerShell выполните следующую команду.

`Test-NetConnection -ComputerName watchdog.servicebus.windows.net -Port 9350`

> [!NOTE]
> Эта команда только проверяет возможность подключения к сети и служебной шине Azure. Данная команда ничего не делает со шлюзом или облачной службой шлюза, которая шифрует и хранит учетные данные и сведения о шлюзах. 
>
> Кроме того, эта команда используется только в Windows Server 2012 R2 или более поздней версии и Windows 8.1 или более поздней версии. В более ранних версиях ОС для проверки возможности подключения можно использовать Telnet. Узнайте больше о [служебной шине Azure и гибридных решениях](../service-bus-messaging/service-bus-messaging-overview.md).

Полученные результаты должны напоминать результаты из примера, где значению параметра **TcpTestSucceeded** соответствует значение **True**.

```text
ComputerName           : watchdog.servicebus.windows.net
RemoteAddress          : 70.37.104.240
RemotePort             : 5672
InterfaceAlias         : vEthernet (Broadcom NetXtreme Gigabit Ethernet - Virtual Switch)
SourceAddress          : 10.120.60.105
PingSucceeded          : False
PingReplyDetails (RTT) : 0 ms
TcpTestSucceeded       : True
```

Если значение **TcpTestSucceeded** не равно **True**, возможно, шлюз блокируется брандмауэром. Чтобы обеспечить исчерпывающие сведения, замените значения параметров **ComputerName** и **Port** значениями, приведенными ниже в подразделе [Настройка портов](#configure-ports) этой статьи.

Брандмауэр может также блокировать подключения, устанавливаемые служебной шиной Azure с центрами обработки данных Azure. В этом случае разрешите (разблокируйте) все IP-адреса этих центров обработки данных в своем регионе. Чтобы узнать эти IP-адреса, [получите список IP-адресов Azure здесь](https://www.microsoft.com/download/details.aspx?id=41653).

<a name="configure-ports"></a>

## <a name="configure-ports"></a>Настройка портов

Шлюз создает исходящее подключение к служебной шине Azure и взаимодействует с исходящими портами: TCP-порты 443 (по умолчанию), 5671, 5672 и 9350–9354. Шлюзу не требуются входящие порты. Узнайте больше о [служебной шине Azure и гибридных решениях](../service-bus-messaging/service-bus-messaging-overview.md).

Шлюзом используются следующие полные доменные имена.

| Доменные имена | Исходящие порты | Описание |
| ------------ | -------------- | ----------- |
| *.analysis.windows.net | 443 | HTTPS |
| *.core.windows.net | 443 | HTTPS |
| *.frontend.clouddatahub.net | 443 | HTTPS |
| *.login.windows.net | 443 | HTTPS |
| *.microsoftonline-p.com | 443 | Используется для проверки подлинности в зависимости от конфигурации. |
| *.msftncsi.com | 443 | Используется для проверки подключения к Интернету, если шлюз недоступен для службы Power BI. |
| *.servicebus.windows.net | 443, 9350–9354 | Прослушиватели ретрансляции служебной шины по протоколу TCP (порт 443 требуется для получения маркера контроля доступа). |
| *.servicebus.windows.net | 5671–5672 | Протокол AMQP |
| login.microsoftonline.com | 443 | HTTPS |
||||

В некоторых случаях подключения к служебной шине Azure будут устанавливаться по IP-адресам, а не полным доменным именам. Поэтому может потребоваться разблокировать IP-адреса для вашей области данных в брандмауэре. Чтобы разрешить доступ к IP-адресам, а не доменам, можно скачать и использовать [список диапазонов IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). IP-адреса из этого списка перечислены в нотации [Бесклассовая адресация](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing).

### <a name="force-https-communication-with-azure-service-bus"></a>Принудительное взаимодействие протокола HTTPS со служебной шиной Azure

Некоторые прокси-серверы пропускают трафик только через порты под номером 80 и 443. По умолчанию обмен данными со служебной шиной Azure происходит через порты, отличные от 443. Можно настроить шлюз для принудительного использования служебной шины Azure через протокол HTTPS вместо прямого подключения TCP. Но это может значительно снизить производительность. Дополнительные сведения см. в статье [Принудительная связь по протоколу HTTPS с служебной шиной Azure](https://docs.microsoft.com/data-integration/gateway/service-gateway-communication#force-https-communication-with-azure-service-bus).

<a name="windows-service-account"></a>

## <a name="windows-service-account"></a>Учетная запись службы Windows

По умолчанию установка шлюза на локальном компьютере выполняется как учетная запись службы Windows с именем "Служба локального шлюза данных". Однако при установке шлюза используется `NT SERVICE\PBIEgwService` имя учетной записи для входа в систему, а также разрешения «вход в качестве службы».

> [!NOTE]
> Учетная запись службы Windows отличается от учетной записи, используемой для подключения к локальным источникам данных, и от учетной записи Azure, используемой при входе в облачные службы.

<a name="restart-gateway"></a>

## <a name="restart-gateway"></a>Перезапуск шлюза

Шлюз данных работает как служба Windows и, как и любая другая служба Windows, может быть запущен и остановлен различными способами. Дополнительные сведения см. [в статье перезапуск локального шлюза данных](https://docs.microsoft.com/data-integration/gateway/service-gateway-restart).

## <a name="tenant-level-administration"></a>Администрирование на уровне клиента

Чтобы получить сведения о всех локальных шлюзах данных в клиенте Azure AD, глобальные администраторы этого клиента могут войти в [центр администрирования Power Platform](https://powerplatform.microsoft.com) в качестве администратора клиента и выбрать параметр " **шлюзы данных** ". Дополнительные сведения см. в статье [Администрирование на уровне клиента для локального шлюза данных](https://docs.microsoft.com/data-integration/gateway/service-gateway-tenant-level-admin).

<a name="gateway-cloud-service"></a>

## <a name="how-the-gateway-works"></a>Как работает шлюз

Шлюз данных обеспечивает быстрый и безопасный обмен данными между приложением логики, облачной службой шлюза и локальным источником данных. Облачная служба шлюза шифрует и хранит учетные данные источников данных и сведения о шлюзах. Эта служба также передает запросы и их результаты между приложением логики, локальным шлюзом данных и локальными источниками данных.

Шлюз работает с брандмауэрами и использует только исходящие соединения. Весь трафик поступает как безопасный исходящий трафик от агента шлюза. Шлюз передает данные из локальных источников в зашифрованные каналы через служебную шину Azure. Служебная шина создает канал между шлюзом и службой вызовов, при этом она не хранит никаких данных. Шифруются все данные, которые передаются через шлюз.

![Архитектура локального шлюза данных](./media/logic-apps-gateway-install/how-on-premises-data-gateway-works-flow-diagram.png)

Шаги ниже описывают, что случится, когда пользователь в облаке взаимодействует с элементом, подключенным к локальному источнику данных.

1. Облачная служба шлюза создает запрос, а также зашифрованные учетные данные для источника данных, и отправляет запрос в очередь для обработки шлюзом.

1. Облачная служба шлюза анализирует запрос и отправляет его в служебную шину Azure.

1. Локальный шлюз данных опрашивает служебную шину Azure, чтобы проверить наличие ожидающих запросов.

1. Шлюз получает запрос, расшифровывает учетные данные и подключается к источникам данных, используя эти учетные данные.

1. Затем шлюз отправляет запрос к источнику данных для выполнения.

1. Результаты отправляются из источника данных обратно в шлюз, а затем — в облачную службу шлюза. Затем облачная служба шлюза использует эти результаты.

<a name="faq"></a>

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="general"></a>Общее

**Вопрос**. Нужно ли устанавливать шлюз для источников данных в облаке, например для Базы данных SQL Azure? <br/>
**Ответ**. Нет, шлюз подключается только к локальным источникам данных.

**Вопрос**. Нужно ли устанавливать шлюз на том же компьютере, на котором находится источник данных? <br/>
**Ответ**. Нет, шлюз подключается к источнику данных, используя предоставленные сведения о подключении. В этом смысле шлюз можно рассматривать как клиентское приложение. Ему просто необходима возможность подключения к серверу, имя которого было предоставлено.

<a name="why-azure-work-school-account"></a>

**Вопрос**. Почему для входа необходимо использовать рабочую или учебную учетную запись? <br/>
**Ответ**. При установке локального шлюза данных можно использовать только рабочую или учебную учетную запись. Учетная запись для входа хранится в клиенте, которым управляет Azure Active Directory (Azure AD). Как правило, имя участника-пользователя учетной записи Azure AD совпадает с адресом электронной почты.

**Вопрос**. Где хранятся мои учетные данные? <br/>
**Ответ**. Учетные данные, введенные для источника данных, хранятся в облачной службе шлюза в зашифрованном виде. Расшифровываются они в локальном шлюзе данных.

**Вопрос**. Есть ли какие-либо требования к пропускной способности сети? <br/>
**Ответ**. Проверьте пропускную способность сети, так как она должна быть высокой. Все среды разные, и объем отправляемых данных может повлиять на результаты. Чтобы гарантировать определенный уровень пропускной способности между локальным источником данных и центрами данных Azure, воспользуйтесь [ExpressRoute](https://azure.microsoft.com/services/expressroute/). Чтобы измерить пропускную способность, воспользуйтесь внешним инструментом, например Azure Speed Test.

**Вопрос**. Что такое задержка при выполнении запросов к источнику данных из шлюза? Какая архитектура подойдет лучше всего? <br/>
**Ответ**. Чтобы уменьшить задержки в сети, необходимо установить шлюз как можно ближе к источнику данных. Вы можете установить шлюз на фактический источник данных, что сведет к минимуму соответствующие задержки. Кроме того, рассмотрите взаимодействие с центрами данных Azure. Например, если служба использует центр обработки данных в западной части США, а SQL Server размещен на виртуальной машине Azure, тогда, возможно, эту виртуальную машину Azure лучше также разместить в регионе "Западная часть США". Это позволит свести к минимуму задержки и избежать затрат на исходящий трафик виртуальной машины Azure.

**Вопрос**. Как результаты отправляются обратно в облако? <br/>
**Ответ**. Результаты отправляются с помощью Служебной шины Azure.

**Вопрос**. Устанавливаются ли какие-либо входящие подключения к шлюзу из облака? <br/>
**Ответ**. Нет, шлюз использует исходящие подключения к Служебной шине Azure.

**Вопрос**. Что делать, если мной заблокированы исходящие подключения? Что нужно открыть? <br/>
**Ответ**. Проверьте порты и узлы, которые использует шлюз.

**Вопрос**. Как на самом деле называется служба Windows? <br/>
**Ответ**. На вкладке "Службы" в диспетчере задач имя службы — "PBIEgwService" или "Power BI Enterprise Gateway Service". В консоли служб имя службы — "On-premises data gateway service" (служба "Локальный шлюз данных"). В качестве идентификатора безопасности службы служба Windows использует NT SERVICE\PBIEgwService.

**Вопрос**. Может ли служба Windows шлюза работать с учетной записью Azure Active Directory? <br/>
**Ответ**. Нет, службе Windows требуется действительная учетная запись Windows.

### <a name="disaster-recovery"></a>Аварийное восстановление

**Вопрос**. Какие варианты доступны для аварийного восстановления? <br/>
**Ответ**. Чтобы восстановить или перенести шлюз, вы можете использовать ключ восстановления. Ключ восстановления указывается при установке шлюза.

**Вопрос**. В чем заключается преимущество ключа восстановления? <br/>
**Ответ**. Он позволяет перенести шлюз или восстановить параметры шлюза после аварии.

## <a name="troubleshooting"></a>Устранение неполадок

В этом разделе рассматриваются некоторые распространенные проблемы, которые могут возникнуть при настройке и использовании локального шлюза данных.

**Вопрос**. Установка шлюза завершилась ошибкой. Почему? <br/>
**Ответ**. Данная ошибка может возникнуть, если антивирусное программное обеспечение на конечном компьютере устарело. Можно обновить антивирусное программное обеспечение или отключить антивирусное программное обеспечение на время установки шлюза, а затем снова его включить.

**Вопрос**. Почему при создании ресурса шлюза в Azure процесс его установки не отображается? <br/>
**Ответ**. Такая ошибка может произойти по нескольким причинам.

* Установка шлюза уже зарегистрирована и заявлена другим ресурсом шлюза в Azure. Установки шлюзов не отображаются в списке экземпляров после создания ресурсов для шлюзов. Чтобы проверить регистрации шлюзов на портале Azure, необходимо просмотреть все ресурсы Azure с типом **Локальные шлюзы данных** для *всех* подписок Azure.

* Идентификаторы пользователя, который установил шлюз в Azure AD, и пользователя, который вошел на портал Azure, отличаются. Убедитесь, что для входа в систему и установки шлюза использовался один и тот же идентификатор.

[!INCLUDE [existing-gateway-location-changed](../../includes/logic-apps-existing-gateway-location-changed.md)]

**Вопрос**. Где находятся журналы шлюза? <br/>
**Ответ**. Ознакомьтесь с [разделом **Журналы**](#logs), приведенным далее в этой статье.

**Вопрос**. Как узнать, какие запросы отправляются к локальному источнику данных? <br/>
**Ответ**. Вы можете включить трассировку запросов, в том числе и отправляемых. Не забудьте вернуть исходное значение трассировки запросов после устранения неполадок. При включенной трассировке запросов создаются журналы большего размера.

Кроме того, можно рассмотреть инструменты трассировки запросов, доступные для вашего источника данных. Например, можно использовать расширенные события или SQL Profiler для SQL Server и служб Analysis Services.

### <a name="outdated-gateway-version"></a>Устаревшая версия шлюза

При использовании устаревшей версии шлюза может возникать ряд проблем. Рекомендуем убедиться, что используется последняя версия. Если шлюз не обновлялся месяц или дольше, то можно установить его последнюю версию и проверить, получится ли воспроизвести проблему.

### <a name="error-failed-to-add-user-to-group--2147463168-pbiegwservice-performance-log-users"></a>Ошибка: не удалось добавить пользователя в группу. (-2147463168 PBIEgwService Performance Log Users ) (-2147463168 пользователей журналов производительности PBIEgwService)

Эта ошибка появляется, если вы пытаетесь установить шлюз на контроллер домена, который не поддерживается. Убедитесь, что развертывание шлюза происходит на компьютере, который не является контроллером домена.

<a name="logs"></a>

### <a name="logs"></a>Журналы

Чтобы облегчить устранение неполадок, всегда запускайте сбор и просмотр журналов шлюза. Существует несколько способов сбора журналов. Простейшим вариантом является использование пользовательского интерфейса установщика шлюза после установки шлюза.

1. Откройте установщик локального шлюза данных на компьютере.

1. В меню слева выберите **Диагностика**.

1. В разделе **Журналы шлюза** выберите **Экспорт журналов**.

   ![Экспорт журналов из установщика шлюза](./media/logic-apps-gateway-install/export-logs.png)

Различные журналы можно найти в других расположениях, приведенных ниже.

| Тип журнала | Местоположение |
|----------|----------|
| **Журналы установщика** | %localappdata%\Temp\On-premises_data_gateway_<*ггггммдд*>.<*номер*>.log |
| **Журналы конфигурации** | C:\Users\<*имя пользователя*>\AppData\Local\Microsoft\On-premises data gateway\GatewayConfigurator<*ггггммдд*>.<*номер*>.log |
| **Журналы службы корпоративного шлюза** | C:\Users\PBIEgwService\AppData\Local\Microsoft\On-premises data gateway\Gateway<*ггггммдд*>.<*номер*>.log |
|||

**Журналы событий**

Чтобы найти журналы событий шлюза, выполните следующие действия.

1. На компьютере, где установлен шлюз, откройте средство **Просмотр событий**.

1. Разверните **Просмотр событий (локально)**  > **Applications and Services Logs** (Журналы приложений и служб).

1. Установите флажок **On-premises data gateway service** (служба "Локальный шлюз данных").

   ![Просмотр журналов событий шлюза](./media/logic-apps-gateway-install/event-viewer.png)

### <a name="review-slow-query-performance"></a>Обзор производительности медленных запросов

Если будет обнаружено, что запросы медленно работают через шлюз, можно включить дополнительное ведение журнала, которое выводит запросы и их длительность. Эти журналы могут указать, какие из запросов медленные или долго выполняются. Чтобы настроить производительность запросов, может потребоваться изменить источник данных, например настроить индексы запросов SQL Server.

Чтобы определить длительность запроса, выполните следующие действия.

1. Перейдите в то же расположение, где находится клиент шлюза. Обычно его можно найти по адресу ```C:\Program Files\On-premises data gateway```

   В противном случае для поиска расположения клиента откройте консоль служб на том же компьютере, найдите **On-premises data gateway service** (служба "Локальный шлюз данных") и просмотрите свойство **Path to executable** (Путь к исполняемому файлу).

1. Откройте и измените файл конфигурации, как описано ниже.

   * **Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config**

     В этом файле измените значение **параметра emitquerytraces** с **false** на **true** , чтобы шлюз мог регистрировать запросы, отправленные из шлюза в источник данных:

     ```html
     <setting name="EmitQueryTraces" serializeAs="String">
        <value>true</value>
     </setting>
     ```

     > [!IMPORTANT]
     > Включение параметра EmitQueryTraces может сильно увеличить размер журнала, который зависит от использования шлюза. Завершив просмотр журналов, убедитесь, что вы снова выполнили сброс параметра EmitQueryTraces на **false**, вместо того чтобы оставить этот параметр активным на длительный срок.

   * **Microsoft.PowerBI.DataMovement.Pipeline.Diagnostics.dll.config**

     Чтобы подробные записи журнала шлюза, включая записи, отображающие продолжительность, изменили значение **TracingVerbosity** с **4** на **5**, необходимо выполнить следующие действия.

     * В этом файле конфигурации измените значение **TracingVerbosity** с **4** на **5**

       ```html
       <setting name="TracingVerbosity" serializeAs="String">
          <value>5</value>
       </setting>
       ```

     * Откройте установщик шлюза, выберите **Диагностики**, включите **Дополнительное ведение журнала**, а затем нажмите кнопку **Применить**.

       ![Включение дополнительного ведения журнала](./media/logic-apps-gateway-install/turn-on-additional-logging.png)

     > [!IMPORTANT]
     > Включение параметра TracingVerbosity может сильно увеличить размер журнала, который зависит от использования шлюза. Завершив просмотр журналов, убедитесь, что **Дополнительное ведение журнала** отключено в установщике шлюза или значение параметра TracingVerbosity в файле конфигурации снова сброшено на **4**, вместо того чтобы оставлять этот параметр активным на длительный срок.

1. Чтобы определить длительность запроса, выполните следующие действия.

   1. [Экспортируйте](#logs) и откройте журнал шлюза.

   1. Чтобы найти запрос, выполните поиск типа активности. Пример.

      | Тип действия | Описание |
      |---------------|-------------|
      | MGEQ | Запросы, выполняемые через ADO.NET |
      | MGEO | Запросы, выполняемые через OLEDB |
      | MGEM | Запросы, выполняемые из механизма гибридного веб-приложения |
      |||

   1. Обратите внимание на второй GUID, который является идентификатором запроса.

   1. Продолжайте поиск типа действия, пока не найдете запись с именем "FireActivityCompletedSuccessfullyEvent", продолжительность которой исчисляется в миллисекундах. Подтвердите, что запись имеет тот же идентификатор запроса. Пример.

      ```text
      DM.EnterpriseGateway Verbose: 0 : 2016-09-26T23:08:56.7940067Z DM.EnterpriseGateway    baf40f21-2eb4-4af1-9c59-0950ef11ec4a    5f99f566-106d-c8ac-c864-c0808c41a606    MGEQ    21f96cc4-7496-bfdd-748c-b4915cb4b70c    B8DFCF12 [DM.Pipeline.Common.TracingTelemetryService] Event: FireActivityCompletedSuccessfullyEvent (duration=5004)
      ```

      > [!NOTE]
      > Запись "FireActivityCompletedSuccessfullyEvent" является подробной записью и не регистрируется, если параметр "TracingVerbosity" находится на уровне 5.

### <a name="trace-traffic-with-fiddler"></a>Трассировка трафика с помощью Fiddler

[Fiddler](https://www.telerik.com/fiddler) — это бесплатный инструмент от компании Telerik, который отслеживает трафик HTTP. Вы можете просмотреть трафик с помощью службы Power BI с клиентского компьютера. Эта служба позволит выявить ошибки и другие сопутствующие сведения.

## <a name="next-steps"></a>Следующие шаги

* [Подключение к локальным данным из приложений логики](../logic-apps/logic-apps-gateway-connection.md)
* [Возможности интеграции Enterprise](../logic-apps/logic-apps-enterprise-integration-overview.md)
* [Список соединителей](../connectors/apis-list.md)
