---
title: Подключение к системам SAP — Azure Logic Apps
description: Доступ к ресурсам SAP и управление ими путем автоматизации рабочих процессов с помощью Azure Logic Apps
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: divswa, LADocs
ms.topic: article
ms.date: 08/30/2019
tags: connectors
ms.openlocfilehash: 98e6b515d5e9d60f95873016ad1cb06a13799bb2
ms.sourcegitcommit: 88ae4396fec7ea56011f896a7c7c79af867c90a1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/06/2019
ms.locfileid: "70390120"
---
# <a name="connect-to-sap-systems-from-azure-logic-apps"></a>Подключение к системам SAP из Azure Logic Apps

> [!IMPORTANT]
> Более ранний сервер приложений SAP и соединители сервера сообщений SAP запланированы на прекращение 30 ноября 2019. Текущий соединитель SAP объединяет эти предыдущие соединители SAP, чтобы не менять тип подключения, полностью совместимый с предыдущими соединителями, предоставляет множество дополнительных возможностей и по-прежнему использует библиотеку соединителей SAP .NET ( SAP NCo).
>
> Для приложений логики, использующих старые соединители, перейдите [на последнюю версию соединителя](#migrate) до даты устаревания. В противном случае эти приложения логики будут испытывать сбои при выполнении и не смогут передавать сообщения в систему SAP.

В этой статье показано, как можно получить доступ к локальным ресурсам SAP из приложения логики с помощью соединителя SAP. Соединитель работает с классическими выпусками SAP, такими как R/3 и системами ECC в локальной среде. Соединитель также обеспечивает интеграцию с более новыми системами SAP на основе SAP, такими как S/4 HANA, независимо от того, где они размещены: локально или в облаке. Соединитель SAP поддерживает интеграцию сообщений или данных с системами SAP NetWeaver через промежуточный документ (IDoc), интерфейс программирования бизнес-приложений (BAPI) или удаленный вызов функций (RFC).

Соединитель SAP использует [библиотеку SAP .NET Connector (NCo)](https://support.sap.com/en/product/connectors/msnet.html) и предоставляет следующие операции или действия:

* **Отправка в SAP**. Отправьте IDoc через Трфк, вызовите функции BAPI в RFC или позвоните RFC/Трфк в системах SAP.
* **Получение из SAP**. Получение IDoc через Трфк, вызов функций BAPI через Трфк или вызов RFC/Трфк в системах SAP.
* **Создание схем**. Создайте схемы для артефактов SAP для IDoc, BAPI или RFC.

Для этих операций соединитель SAP поддерживает обычную проверку подлинности с помощью имен пользователей и паролей. Соединитель также поддерживает [безопасный обмен данными по сети (SNC)](https://help.sap.com/doc/saphelp_nw70/7.0.31/e6/56f466e99a11d1a5b00000e835363f/content.htm?no_cache=true). SNC можно использовать для единого входа (SSO) SAP NetWeaver или для дополнительных возможностей безопасности, предоставляемых внешним продуктом безопасности.

Соединитель SAP интегрируется с локальными системами SAP через [локальный шлюз данных](../logic-apps/logic-apps-gateway-connection.md). В сценариях отправки, например при отправке сообщения из приложения логики в систему SAP, шлюз данных выступает в качестве клиента RFC и направляет запросы, полученные от приложения логики в SAP. Аналогично, в сценариях приема шлюз данных выступает в качестве сервера RFC, который получает запросы от SAP и пересылает их в приложение логики.

В этой статье показано, как создать пример приложения логики, которое интегрируется с SAP, и использовать его для описанных ранее сценариев интеграции. Для приложений логики, использующих старые соединители SAP, в этой статье показано, как перенести приложения логики в последнюю версию соединителя SAP.

<a name="pre-reqs"></a>

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, потребуется следующее:

* Подписка Azure. Если у вас еще нет подписки Azure, [получите бесплатную учетную запись Azure](https://azure.microsoft.com/free/).

* Приложение логики, из которого требуется осуществлять доступ к системе SAP, и триггер, который запускает рабочий процесс приложения логики. Если вы не знакомы с приложениями логики, см. статью [что такое Azure Logic Apps?](../logic-apps/logic-apps-overview.md) и [краткое руководство: Создание первого автоматизированного рабочего процесса с помощью Azure Logic Apps на портале Azure](../logic-apps/quickstart-create-first-logic-app-workflow.md).

* [Сервер приложений SAP](https://wiki.scn.sap.com/wiki/display/ABAP/ABAP+Application+Server) или [сервер сообщений SAP](https://help.sap.com/saphelp_nw70/helpdata/en/40/c235c15ab7468bb31599cc759179ef/frameset.htm).

* Скачайте и установите последнюю версию [локального шлюза данных](https://www.microsoft.com/download/details.aspx?id=53127) на любом компьютере в локальной среде. Не забудьте настроить шлюз на портале Azure, прежде чем продолжить. Шлюз обеспечивает безопасный доступ к локальным данным и ресурсам. Дополнительные сведения см. [в статье Установка локального шлюза данных для Azure Logic Apps](../logic-apps/logic-apps-gateway-install.md).

* При использовании SNC с SSO убедитесь, что шлюз работает от имени пользователя, сопоставленного с пользователем SAP. Чтобы изменить учетную запись по умолчанию, выберите **изменить учетную запись**и введите учетные данные пользователя.

  ![Изменение учетной записи шлюза](./media/logic-apps-using-sap-connector/gateway-account.png)

* Если вы включили SNC с внешним продуктом безопасности, Скопируйте библиотеку SNC или файлы на том же компьютере, где установлен шлюз. К некоторым примерам продуктов SNC относятся [сапсекулиб](https://help.sap.com/saphelp_nw74/helpdata/en/7a/0755dc6ef84f76890a77ad6eb13b13/frameset.htm), Kerberos и NTLM.

* Скачайте и установите последнюю версию клиентской библиотеки SAP, которая сейчас является [соединителем SAP (NCo 3,0) для Microsoft .NET 3.0.22.0, скомпилированного с .NET Framework 4,0-Windows 64-bit (x64)](https://softwaredownloads.sap.com/file/0020000001000932019), на том же компьютере, что и локальный шлюз данных. Необходимо установить эту или более позднюю версию по следующим причинам:

  * Более ранние версии SAP NCo могут быть взаимоблокированы, когда одновременно отправляется несколько сообщений IDoc. Это условие блокирует все последующие сообщения, отправляемые в назначение SAP, что приводит к истечению времени ожидания сообщений.
  
  * Локальный шлюз данных работает только в 64-разрядных системах. В противном случае возникает ошибка неправильного образа, так как служба узла шлюза управления данными не поддерживает 32-разрядные сборки.
  
  * Как служба узла шлюза управления данными, так и Microsoft SAP Adapter используют .NET Framework 4.5. SAP NCo для .NET Framework 4.0 работает с процессами, использующими среду выполнения .NET версии от 4.0 до 4.7.1. SAP NCo для .NET Framework 2,0 работает с процессами, которые используют среду выполнения .NET 2,0 – 3,5, но больше не работают с последним локальным шлюзом данных.

* Содержимое сообщения, которое можно отправить на сервер SAP, например пример файла IDoc, должно быть в формате XML и содержать пространство имен для действия SAP, которое вы хотите использовать.

<a name="migrate"></a>

## <a name="migrate-to-current-connector"></a>Перенести в текущий соединитель

1. Если вы еще не сделали этого, обновите [локальный шлюз данных](https://www.microsoft.com/download/details.aspx?id=53127) , чтобы получить последнюю версию. Дополнительные сведения см. [в статье Установка локального шлюза данных для Azure Logic Apps](../logic-apps/logic-apps-gateway-install.md).

1. В приложении логики, использующем старый соединитель SAP, удалите действие **Send to SAP** .

1. Из последней версии соединителя SAP добавьте действие **Send to SAP** . Прежде чем использовать это действие, воссоздайте подключение к системе SAP.

1. Сохраните приложение логики, когда закончите.

<a name="add-trigger"></a>

## <a name="send-to-sap"></a>Отправка в SAP

В этом примере используется приложение логики, которое может запускаться по HTTP-запросу. Приложение логики отправляет IDoc на сервер SAP и возвращает ответ запрашивающему инициатору, вызвавшему приложение логики.

### <a name="add-an-http-request-trigger"></a>Добавление триггера HTTP-запроса

В Azure Logic Apps каждое приложение логики должно запускаться по [триггеру](../logic-apps/logic-apps-overview.md#logic-app-concepts), который активируется, когда происходит определенное событие или если выполняются заданные условия. При каждом срабатывании триггера обработчик Logic Apps создает экземпляр приложения логики, запускающий рабочий процесс.

В этом примере создается приложение логики с конечной точкой в Azure, позволяющее отправлять *HTTP-запросы POST* в приложение логики. Когда приложение логики получает эти HTTP-запросы, триггер срабатывает и выполняет следующий шаг рабочего процесса.

1. На [портале Azure](https://portal.azure.com) создайте пустое приложение логики. Откроется конструктор приложений логики.

1. В поле поиска введите фильтр "http-запрос". В списке **триггеры** выберите **время получения HTTP-запроса**.

   ![Добавление триггера HTTP-запроса](./media/logic-apps-using-sap-connector/add-trigger.png)

1. Теперь сохраните приложение логики, чтобы можно было создать URL-адрес конечной точки для приложения логики. На панели инструментов конструктора щелкните **Сохранить**.

   Теперь URL-адрес конечной точки появится в триггере, например:

   ![Создание URL-адреса для конечной точки](./media/logic-apps-using-sap-connector/generate-http-endpoint-url.png)

<a name="add-action"></a>

### <a name="add-an-sap-action"></a>Добавление действия SAP

В Azure Logic Apps [действие](../logic-apps/logic-apps-overview.md#logic-app-concepts) — это шаг в рамках рабочего процесса, выполняемый после срабатывания триггера или другого действия. Если вы еще не добавили триггер в приложение логики и хотите следовать этому примеру, добавьте [этот триггер](#add-trigger).

1. В конструкторе приложений логики под триггером выберите **новый шаг**.

   ![Выберите "новый шаг".](./media/logic-apps-using-sap-connector/add-action.png)

1. В поле поиска введите слово sap в качестве фильтра. В списке **действия** выберите **Отправить сообщение в SAP**.
  
   ![Выбор действия отправки в SAP](media/logic-apps-using-sap-connector/select-sap-send-action.png)

   Вместо поиска перейдите на вкладку **предприятие** и выберите действие SAP.

   ![Выбор действия отправки в SAP на вкладке "Корпоративный"](media/logic-apps-using-sap-connector/select-sap-send-action-ent-tab.png)

1. Если потребуется ввести сведения о подключении, создайте подключение SAP. В противном случае, если подключение уже существует, перейдите к следующему шагу, чтобы можно было настроить действие SAP.

   **Создание локального подключения SAP**

   Укажите сведения для подключения к серверу SAP. В качестве свойства **Шлюз данных** выберите шлюз данных, созданный на портале Azure при установке шлюза. По завершении нажмите кнопку **создать**. Logic Apps устанавливает и проверяет подключение, чтобы убедиться, что подключение работает правильно.

   * Если для свойства **Logon Type** (Тип входа) установлено значение **Application Server** (Сервер приложений), необходимо указать следующие свойства, которые обычно отображаются как необязательные:

     ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

   * Если для свойства **Logon Type** (Тип входа) задано значение **Группа**, необходимо указать следующие свойства, которые обычно отображаются как необязательные:

     ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)

   По умолчанию строгая типизация используется для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Дополнительные сведения о [параметре безопасного ввода](#safe-typing).

1. Теперь найдите и выберите действие с сервера SAP.

   1. В окне **действие SAP** выберите значок папки. В списке файлов найдите и выберите сообщение SAP, которое следует использовать. Переходите по списку, используя стрелки.

      В этом примере выбирается IDoc с типом **Orders** .

      ![Поиск и выбор действия IDoc](./media/logic-apps-using-sap-connector/SAP-app-server-find-action.png)

      Если не удается найти необходимое действие, можно вручную ввести путь, например:

      ![Указание пути к действию IDoc вручную](./media/logic-apps-using-sap-connector/SAP-app-server-manually-enter-action.png)

      > [!TIP]
      > Укажите значение для **действия SAP** в редакторе выражений. Таким образом, можно использовать одно и то же действие для различных типов сообщений.

      Дополнительные сведения об операциях IDoc см. в статье [Message schemas for IDOC operations](https://docs.microsoft.com/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations) (Схемы сообщений для операций IDoc).

   1. Щелкните внутри поля **Входное сообщение**, чтобы отобразился список динамического содержимого. В этом списке в разделе **При получении HTTP-запроса** выберите поле **Текст**.

      Этот шаг включает содержимое текста из триггера HTTP-запроса и отправляет эти выходные данные на сервер SAP.

      ![Выбор поля "Текст"](./media/logic-apps-using-sap-connector/SAP-app-server-action-select-body.png)

      Когда вы закончите, действие SAP будет выглядеть, как в следующем примере:

      ![Готовое действие SAP](./media/logic-apps-using-sap-connector/SAP-app-server-complete-action.png)

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

<a name="add-response"></a>

### <a name="add-an-http-response-action"></a>Добавление действия HTTP-ответа

Теперь добавьте действие ответа в рабочий процесс приложения логики и включите в него выходные данные действия SAP. Таким образом приложение логики будет возвращать результаты с сервера SAP исходной запросившей стороне.

1. В конструкторе приложений логики в разделе действие SAP выберите **новый шаг**.

1. В поле поиска введите фильтр "ответ". В списке **действия** выберите **ответ**.

1. Щелкните внутри поля **Текст**, чтобы отобразился список динамического содержимого. В списке в разделе **Отправить сообщение в SAP**выберите поле **Body** .

   ![Готовое действие SAP](./media/logic-apps-using-sap-connector/select-sap-body-for-response-action.png)

1. Сохраните приложение логики.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. Если приложение логики еще не включено, в меню приложения логики выберите **Обзор**. На панели инструментов выберите **включить**.

1. На панели инструментов конструктора выберите **выполнить**. Так приложение логики будет запущено вручную.

1. Активируйте приложение логики, отправив запрос HTTP POST по URL-адресу в триггере HTTP-запроса.
Включите содержимое сообщения в запрос. Для отправки запроса можно использовать, например, средство [Postman](https://www.getpostman.com/apps).

   В этой статье запрос передает файл IDoc, который должен быть в формате XML и включать в себя пространство имен для используемого действия SAP, например:

   ``` xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <Send xmlns="http://Microsoft.LobServices.Sap/2007/03/Idoc/2/ORDERS05//720/Send">
      <idocData>
         <...>
      </idocData>
   </Send>
   ```

1. После отправки HTTP-запроса дождитесь ответа от приложения логики.

   > [!NOTE]
   > Время ожидания приложения логики может истечь, если все действия, необходимые для ответа, не будут завершены в течение [времени ожидания запроса](./logic-apps-limits-and-config.md). Если это произойдет, запросы могут быть заблокированы. Для помощи в диагностике неполадок узнайте, как можно [проверять и отслеживать приложения логики](../logic-apps/logic-apps-monitor-your-logic-apps.md).

Теперь вы создали приложение логики, которое может взаимодействовать с сервером SAP. Теперь с настроенным подключением SAP для приложения логики можно изучить другие доступные действия SAP, например BAPI и RFC.

## <a name="receive-from-sap"></a>Получение из SAP

В этом примере используется приложение логики, которое активируется, когда приложение получает сообщение от системы SAP.

### <a name="add-an-sap-trigger"></a>Добавление триггера SAP

1. На портале Azure создайте пустое приложение логики. Откроется конструктор приложений логики.

1. В поле поиска введите слово sap в качестве фильтра. В списке **триггеры** выберите **время получения сообщения от SAP**.

   ![Добавление триггера SAP](./media/logic-apps-using-sap-connector/add-sap-trigger.png)

   Также можно открыть вкладку " **предприятие** " и выбрать триггер:

   ![Добавление триггера SAP из вкладки "Корпоративный"](./media/logic-apps-using-sap-connector/add-sap-trigger-ent-tab.png)

1. Если потребуется ввести сведения о подключении, создайте подключение SAP. Если подключение уже существует, перейдите к следующему шагу, чтобы можно было настроить действие SAP.

   **Создание локального подключения SAP**

   Укажите сведения для подключения к серверу SAP. В качестве свойства **Шлюз данных** выберите шлюз данных, созданный на портале Azure при установке шлюза. По завершении нажмите кнопку **создать**. Logic Apps устанавливает и проверяет подключение, чтобы убедиться, что подключение работает правильно.

   * Если для свойства **Logon Type** (Тип входа) установлено значение **Application Server** (Сервер приложений), необходимо указать следующие свойства, которые обычно отображаются как необязательные:

     ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

   * Если для свойства **Logon Type** (Тип входа) задано значение **Группа**, необходимо указать следующие свойства, которые обычно отображаются как необязательные:

     ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)  

   По умолчанию строгая типизация используется для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Дополнительные сведения о [параметре безопасного ввода](#safe-typing).

1. Укажите необходимые параметры в зависимости от конфигурации системы SAP.

   При необходимости можно указать одно или несколько действий SAP. Этот список действий определяет сообщения, получаемые триггером с сервера SAP через шлюз данных. Пустой список означает, что триггер будет получать все сообщения. Если в списке указано несколько сообщений, триггер получает только те сообщения, которые указаны в списке. Другие сообщения, отправленные с сервера SAP, будут отклонены шлюзом.

   Действие SAP можно выбрать с помощью средства выбора файла:

   ![Выбор действия SAP](media/logic-apps-using-sap-connector/select-SAP-action-trigger.png)  

   Можно также указать действие вручную:

   ![Ввод действия SAP вручную](media/logic-apps-using-sap-connector/manual-enter-SAP-action-trigger.png)

   Ниже приведен пример, в котором показано, как действие отображается в случае настройки триггера для получения более одного сообщения.

   ![Пример триггера](media/logic-apps-using-sap-connector/example-trigger.png)  

   Дополнительные сведения о действиях SAP см. в статье [Message schemas for IDOC operations](https://docs.microsoft.com/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations) (Схемы сообщений для операций IDoc).

1. Теперь сохраните приложение логики, чтобы вы могли начать получать сообщения из системы SAP.
На панели инструментов конструктора щелкните **Сохранить**.

Теперь приложение логики может получать сообщения из системы SAP.

> [!NOTE]
> Триггер SAP не является опрашивающим триггером, но вместо него используется триггер на основе веб-перехватчика. Триггер вызывается из шлюза, только если существует сообщение, поэтому опрос не требуется.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. Чтобы активировать приложение логики, отправьте сообщение из системы SAP.

1. В меню приложение логики выберите **Обзор**. Проверьте **журнал запусков** для всех новых запусков приложения логики.

1. Откройте последний запуск, в котором отображается сообщение, отправленное из системы SAP, в разделе выходных данных триггера.

## <a name="receive-idoc-packets-from-sap"></a>Получение пакетов IDOC из SAP

Вы можете настроить SAP для [отправки iDoc в пакеты](https://help.sap.com/viewer/8f3819b0c24149b5959ab31070b64058/7.4.16/en-US/4ab38886549a6d8ce10000000a42189c.html), которые являются пакетами или группами iDoc. Для получения пакетов IDOC, соединитель SAP, в частности триггер, не требует дополнительной настройки. Однако для обработки каждого элемента в пакете IDOC после того, как триггер получит пакет, необходимо выполнить некоторые дополнительные действия, чтобы разделить пакет на отдельные iDoc.

Ниже приведен пример, демонстрирующий извлечение отдельных iDoc из пакета с помощью [ `xpath()` функции](./workflow-definition-language-functions-reference.md#xpath).

1. Прежде чем начать, вам потребуется приложение логики с триггером SAP. Если у вас еще нет этого приложения логики, выполните описанные выше действия в этом разделе, чтобы настроить [приложение логики с помощью триггера SAP](#receive-from-sap).

   Пример:

   ![Триггер SAP](./media/logic-apps-using-sap-connector/first-step-trigger.png)

1. Получите корневое пространство имен из IDOC XML, которое приложение логики получает из SAP. Чтобы извлечь это пространство имен из XML-документа, добавьте шаг, который создает локальную строковую переменную и сохраняет это пространство `xpath()` имен с помощью выражения:

   `xpath(xml(triggerBody()?['Content']), 'namespace-uri(/*)')`

   ![Получить пространство имен](./media/logic-apps-using-sap-connector/get-namespace.png)

1. Чтобы извлечь отдельные iDoc, добавьте шаг, который создает переменную массива и сохраняет коллекцию IDOC с помощью другого `xpath()` выражения:

   `xpath(xml(triggerBody()?['Content']), '/*[local-name()="Receive"]/*[local-name()="idocData"]')`

   ![Получить массив элементов](./media/logic-apps-using-sap-connector/get-array.png)

   Переменная массива делает каждый IDOC доступным для приложения логики по отдельности, перечисляя коллекцию. В этом примере приложение логики передает каждую IDOC на SFTP-сервер с помощью цикла:

   ![Отправить IDOC](./media/logic-apps-using-sap-connector/loop-batch.png)

   Каждый iDoc должен включать корневое пространство имен. это причина, по которой содержимое файла упаковывается внутри `<Receive></Receive` элемента вместе с корневым пространством имен перед отправкой iDoc в подчиненное приложение, или SFTP-сервер в этом случае.

> [!TIP]
> Вы можете использовать шаблон быстрого запуска для этого шаблона, выбрав этот шаблон в конструкторе приложений логики при создании нового приложения логики.
>
> ![Шаблон пакетной службы](./media/logic-apps-using-sap-connector/batch-template.png)

## <a name="generate-schemas-for-artifacts-in-sap"></a>Создание схем для артефактов в SAP

В этом примере используется приложение логики, которое может запускаться по HTTP-запросу. Действие SAP отправляет запрос в систему SAP для создания схем для указанных IDoc и BAPI. Схемы, возвращаемые в ответе, передаются в учетную запись интеграции с помощью соединителя Azure Resource Manager.

### <a name="add-an-http-request-trigger"></a>Добавление триггера HTTP-запроса

1. На портале Azure создайте пустое приложение логики. Откроется конструктор приложений логики.

1. В поле поиска введите фильтр "http-запрос". В списке **триггеры** выберите **время получения HTTP-запроса**.

   ![Добавление триггера HTTP-запроса](./media/logic-apps-using-sap-connector/add-trigger.png)

1. Теперь сохраните приложение логики, чтобы можно было создать для него URL-адрес конечной точки.
На панели инструментов конструктора щелкните **Сохранить**.

   Теперь URL-адрес конечной точки появится в триггере, например:

   ![Создание URL-адреса для конечной точки](./media/logic-apps-using-sap-connector/generate-http-endpoint-url.png)

### <a name="add-an-sap-action-to-generate-schemas"></a>Добавление действия SAP для создания схем

1. В конструкторе приложений логики под триггером выберите **новый шаг**.

   ![Выберите "новый шаг".](./media/logic-apps-using-sap-connector/add-action.png)

1. В поле поиска введите слово sap в качестве фильтра. В списке **действия** выберите **создать схемы**.
  
   ![Выбор действия отправки в SAP](media/logic-apps-using-sap-connector/select-sap-schema-generator-action.png)

   Также можно выбрать вкладку " **предприятие** " и выбрать действие SAP.

   ![Выбор действия отправки в SAP на вкладке "Корпоративный"](media/logic-apps-using-sap-connector/select-sap-schema-generator-ent-tab.png)

1. Если потребуется ввести сведения о подключении, создайте подключение SAP. Если подключение уже существует, перейдите к следующему шагу, чтобы можно было настроить действие SAP.

   **Создание локального подключения SAP**

   1. Укажите сведения для подключения к серверу SAP. В качестве свойства **Шлюз данных** выберите шлюз данных, созданный на портале Azure при установке шлюза.

      * Если для свойства **Logon Type** (Тип входа) установлено значение **Application Server** (Сервер приложений), необходимо указать следующие свойства, которые обычно отображаются как необязательные:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Если для свойства **Logon Type** (Тип входа) задано значение **Группа**, необходимо указать следующие свойства, которые обычно отображаются как необязательные:

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)

      По умолчанию строгая типизация используется для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Дополнительные сведения о [параметре безопасного ввода](#safe-typing).

   1. По завершении нажмите кнопку **создать**.

      Logic Apps устанавливает и проверяет подключение, чтобы убедиться, что подключение работает правильно.

1. Укажите путь к артефакту, для которого требуется создать схему.

   Действие SAP можно выбрать с помощью средства выбора файла:

   ![Выбор действия SAP](media/logic-apps-using-sap-connector/select-SAP-action-schema-generator.png)  

   Можно также ввести действие вручную:

   ![Ввод действия SAP вручную](media/logic-apps-using-sap-connector/manual-enter-SAP-action-schema-generator.png)

   Чтобы создать схемы для нескольких артефактов, укажите сведения о действии SAP для каждого артефакта, например:

   ![Выбор команды "Добавить новый элемент"](media/logic-apps-using-sap-connector/schema-generator-array-pick.png)

   ![Отображение двух элементов](media/logic-apps-using-sap-connector/schema-generator-example.png)

   Дополнительные сведения о действии SAP см. в статье [схемы сообщений для операций iDoc](https://docs.microsoft.com/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations).

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. На панели инструментов конструктора выберите **выполнить** , чтобы активировать запуск для приложения логики.

1. Откройте выполнение и проверьте выходные данные для действия **создать схемы** .

   В выходных данных отображаются созданные схемы для указанного списка сообщений.

### <a name="upload-schemas-to-an-integration-account"></a>Отправка схем в учетную запись интеграции

При необходимости можно загрузить созданные схемы и сохранить их в репозиториях, таких как большой двоичный объект, хранилище или учетная запись интеграции. Учетные записи интеграции предоставляют отличный интерфейс для работы с другими действиями XML, поэтому в этом примере показано, как отправить схемы в учетную запись интеграции для того же приложения логики с помощью соединителя Azure Resource Manager.

1. В конструкторе приложений логики под триггером выберите **новый шаг**.

1. В поле поиска введите "диспетчер ресурсов" в качестве фильтра. Выберите **создать или обновить ресурс**.

   ![Выбор действия Azure Resource Manager](media/logic-apps-using-sap-connector/select-azure-resource-manager-action.png)

1. Введите сведения о действии, включая подписку Azure, группу ресурсов Azure и учетную запись интеграции. Чтобы добавить маркеры SAP в поля, щелкните внутри полей для этих полей и выберите в появившемся списке динамическое содержимое.

   1. Откройте список **Добавить новый параметр** и выберите поля **Расположение** и **Свойства** .

   1. Укажите сведения для этих новых полей, как показано в этом примере.

      ![Ввод сведений для действия Azure Resource Manager](media/logic-apps-using-sap-connector/azure-resource-manager-action.png)

   Действие SAP **Generate schemas** (Создать схемы) создает схемы в виде коллекции, поэтому конструктор автоматически добавляет цикл **for each** в действие. Ниже приведен пример, в котором показано, как выглядит это действие:

   ![Действие Azure Resource Manager с циклом for each](media/logic-apps-using-sap-connector/azure-resource-manager-action-foreach.png)  
   > [!NOTE]
   > Схемы используют формат в кодировке base64. Чтобы отправить схемы в учетную запись интеграции, они должны быть декодированы с помощью функции `base64ToString()`. Ниже приведен пример, содержащий код для элемента `"properties"`:
   >
   > ```json
   > "properties": {
   >    "Content": "@base64ToString(items('For_each')?['Content'])",
   >    "ContentType": "application/xml",
   >    "SchemaType": "Xml"
   > }
   > ```

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. На панели инструментов конструктора выберите **выполнить** , чтобы вручную запустить приложение логики.

1. После успешного выполнения перейдите к учетной записи интеграции и убедитесь, что созданные схемы существуют.

## <a name="enable-secure-network-communications"></a>Включить безопасные сетевые подключения

Прежде чем начать, убедитесь, что выполнены перечисленные выше [Предварительные требования](#pre-reqs).

* Локальный шлюз данных устанавливается на компьютере, который находится в той же сети, что и система SAP.
* Для единого входа шлюз работает как пользователь, сопоставленный с пользователем SAP.
* Библиотека SNC, которая предоставляет дополнительные функции безопасности, устанавливается на том же компьютере, что и шлюз данных. Некоторые примеры включают [сапсекулиб](https://help.sap.com/saphelp_nw74/helpdata/en/7a/0755dc6ef84f76890a77ad6eb13b13/frameset.htm), Kerberos и NTLM.

   Чтобы включить SNC для запросов или из системы SAP, установите флажок **использовать SNC** в подключении SAP и укажите следующие свойства:

   ![Настройка SAP SNC в подключении](media/logic-apps-using-sap-connector/configure-sapsnc.png)

   | Свойство | Описание |
   |----------| ------------|
   | **Путь к библиотеке SNC** | Имя библиотеки SNC или путь относительно расположения установки NCo или абсолютного пути. Примеры: `sapsnc.dll` `.\security\sapsnc.dll` или.`c:\security\sapsnc.dll` |
   | **ЕДИНЫЙ ВХОД SNC** | При подключении через SNC для проверки подлинности вызывающего объекта обычно используется удостоверение SNC. Другой вариант — переопределить, чтобы данные пользователя и пароля можно было использовать для проверки подлинности вызывающего объекта, но строка по-прежнему шифруется. |
   | **Имя SNC** | В большинстве случаев это свойство можно опустить. Установленное решение SNC обычно знает свое собственное имя SNC. Для решений, которые поддерживают несколько удостоверений, может потребоваться указать удостоверение, которое будет использоваться для этого конкретного назначения или сервера. |
   | **Имя партнера SNC** | Имя серверной части SNC. |
   | **Качество защиты SNC** | Качество обслуживания, используемое для обмена данными с этим конкретным местом назначения или сервером. Значение по умолчанию определяется внутренней системой. Максимальное значение определяется продуктом безопасности, используемым для SNC. |
   |||

   > [!NOTE]
   > Не устанавливайте переменные среды SNC_LIB и SNC_LIB_64 на компьютере, где есть шлюз данных и библиотека SNC. Если задано значение, они имеют приоритет над значением библиотеки SNC, передаваемым через соединитель.

<a name="safe-typing"></a>

## <a name="safe-typing"></a>Надежная типизация

По умолчанию при создании подключения SAP используется строгая типизация для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Если выбрана **надежная типизация**, тип DATS и тип TIMS в SAP обрабатываются как строки, `xs:date` а не как их эквиваленты в формате XML и `xs:time`, где `xmlns:xs="http://www.w3.org/2001/XMLSchema"`. В результате безопасного ввода влияет на поведение всех поколений схемы, сообщение Send для полезных данных "Отправлено" и "получено" и триггер. 

При использовании строгой**типизации** схема СОПОСТАВЛЯЕТ типы DATS и TIMS с более простыми типами XML:

```xml
<xs:element minOccurs="0" maxOccurs="1" name="UPDDAT" nillable="true" type="xs:date"/>
<xs:element minOccurs="0" maxOccurs="1" name="UPDTIM" nillable="true" type="xs:time"/>
```

При отправке сообщений с помощью строгой типизации ответ DATS и TIMS соответствует формату соответствующего XML-типа:

```xml
<DATE>9999-12-31</DATE>
<TIME>23:59:59</TIME>
```

Если включена возможность **безопасного ввода** , схема СОПОСТАВЛЯЕТ типы DATS и TIMS с СТРОКОВЫМИ XML-полями с ограничениями длины, например:

```xml
<xs:element minOccurs="0" maxOccurs="1" name="UPDDAT" nillable="true">
  <xs:simpleType>
    <xs:restriction base="xs:string">
      <xs:maxLength value="8" />
    </xs:restriction>
  </xs:simpleType>
</xs:element>
<xs:element minOccurs="0" maxOccurs="1" name="UPDTIM" nillable="true">
  <xs:simpleType>
    <xs:restriction base="xs:string">
      <xs:maxLength value="6" />
    </xs:restriction>
  </xs:simpleType>
</xs:element>
```

Когда сообщения отправляются с включенной службой **безопасного ввода** , ответ DATS и TIMS выглядит следующим образом:

```xml
<DATE>99991231</DATE>
<TIME>235959</TIME>
```

## <a name="advanced-scenarios"></a>Расширенные сценарии

### <a name="confirm-transaction-explicitly"></a>Явно подтвердить транзакцию

При отправке транзакций в SAP из Logic Apps этот обмен происходит в два этапа, как описано в документе SAP, [серверные программы RFC, используемые в транзакции](https://help.sap.com/doc/saphelp_nwpi71/7.1/en-US/22/042ad7488911d189490000e829fbbd/content.htm?no_cache=true). По умолчанию действие **Send to SAP** обрабатывает Оба шага передачи функции и для подтверждения транзакции в одном вызове. Соединитель SAP предоставляет возможность отделения этих шагов. Вы можете отправить IDOC, а не автоматически подтверждать транзакцию, можно использовать действие явно **подтвердить идентификатор транзакции** .

Эта возможность отделения идентификатора транзакции может оказаться полезной, если вы не хотите дублировать транзакции в SAP, например в случаях, когда сбои могут произойти из-за таких причин, как проблемы с сетью. Проверив идентификатор транзакции отдельно, транзакция будет выполнена только один раз в системе SAP.

Ниже приведен пример, демонстрирующий этот шаблон:

1. Создайте пустое приложение логики и добавьте триггер HTTP.

1. Из соединителя SAP добавьте действие **Send iDoc** . Укажите сведения о IDOC, отправляемых в систему SAP.

1. Чтобы явно подтвердить идентификатор транзакции на отдельном шаге, в свойстве " **подтвердить TID** " выберите **нет**. Для необязательного свойства **GUID идентификатора транзакции** можно либо вручную указать значение, либо автоматически создать соединитель и вернуть этот идентификатор GUID в ответе действия Send iDoc.

   ![Отправить свойства действия IDOC](./media/logic-apps-using-sap-connector/send-idoc-action-details.png)

1. Чтобы явно подтвердить идентификатор транзакции, добавьте действие **Подтверждение идентификатора транзакции** . Щелкните внутри поля **идентификатор транзакции** , чтобы появился список динамического содержимого. В этом списке выберите значение **идентификатора транзакции** , возвращаемое действием **Send iDoc** .

   ![Действие "подтвердить идентификатор транзакции"](./media/logic-apps-using-sap-connector/explicit-transaction-id.png)

   После выполнения этого шага текущая транзакция помечается как завершенная на обоих концах, на стороне соединителя SAP и на стороне системы SAP.

## <a name="known-issues-and-limitations"></a>Известные проблемы и ограничения

Ниже приведены известные проблемы и ограничения для соединителя SAP:

* Триггер SAP не поддерживает кластеры шлюза данных. В некоторых случаях отработки отказа узел шлюза данных, взаимодействующий с системой SAP, может отличаться от активного узла, что приводит к непредвиденному поведению. Для сценариев отправки поддерживаются кластеры шлюза данных.

* Соединитель SAP в настоящее время не поддерживает строки маршрутизатора SAP. Локальный шлюз данных должен существовать в той же локальной сети, что и система SAP, к которой нужно подключиться.

## <a name="connector-reference"></a>Справочник по соединителям

Технические сведения о триггерах, действиях и ограничениях, которые описаны в описании OpenAPI (ранее — Swagger) соединителя, см. на [странице справочника по соединителю](/connectors/sap/).

## <a name="next-steps"></a>Следующие шаги

* [Подключитесь к локальным системам](../logic-apps/logic-apps-gateway-connection.md) с Azure Logic Apps.
* Узнайте, как проверять, преобразовывать и использовать другие операции с сообщениями с [пакет интеграции Enterprise](../logic-apps/logic-apps-enterprise-integration-overview.md).
* Дополнительные сведения о других [соединителях Logic Apps](../connectors/apis-list.md).
