---
title: Подключение к системам SAP
description: Доступ и управление ресурсами SAP путем автоматизации рабочих процессов с помощью приложений логики Azure
services: logic-apps
ms.suite: integration
author: divyaswarnkar
ms.author: divswa
ms.reviewer: estfan, logicappspm
ms.topic: article
ms.date: 08/30/2019
tags: connectors
ms.openlocfilehash: 39ab222f64d964e95b16e043c9cdeccd8170ace3
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77651021"
---
# <a name="connect-to-sap-systems-from-azure-logic-apps"></a>Подключение к системам SAP из Azure Logic Apps

> [!IMPORTANT]
> Предыдущие разъемы SAP Application Server и SAP Message Server были отключены 29 февраля 2020 года. Текущий разъем SAP консолидирует эти предыдущие разъемы SAP, так что вам не придется менять тип соединения, полностью совместим с предыдущими разъемами, предоставляет множество дополнительных возможностей и продолжает использовать библиотеку разъема SAP .Net ( SAP NCo).
>
> Для логических приложений, которые используют старые разъемы, пожалуйста, [перейти к последнему разъему](#migrate) до даты амортизм. В противном случае эти логические приложения будут испытывать сбои выполнения и не смогут отправлять сообщения в вашу систему SAP.

В этой статье показано, как можно получить доступ к вашим внутренним ресурсам SAP из приложения логики с помощью разъема SAP. Разъем работает с классическими версиями SAP, такими как R/3 и ECC систем на месте. Разъем также обеспечивает интеграцию с новыми системами SAP на базе SAP, такими как S/4 HANA, независимо от того, размещаются ли они на месте или в облаке. Разъем SAP поддерживает интеграцию сообщений или данных в системы sAP NetWeaver и из них через промежуточный документ (IDoc), интерфейс программирования бизнес-приложений (BAPI) или удаленный вызов функций (RFC).

Разъем SAP использует [библиотеку SAP .NET Connector (NCo)](https://support.sap.com/en/product/connectors/msnet.html) и предоставляет следующие действия:

* **Отправьте сообщение sAP**: Отправьте IDoc через tRFC, позвоните в функции BAPI через RFC или позвоните в RFC/tRFC в системах SAP.
* **Когда сообщение получено от SAP**: Получите IDoc над tRFC, позвоните в функции BAPI по сравнению с tRFC или позвоните в RFC/tRFC в системах SAP.
* **Создание схем**: Создание схем для артефактов SAP для IDoc, BAPI или RFC.

Для этих операций разъем SAP поддерживает базовую аутентификацию через имена пользователей и пароли. Разъем также поддерживает [безопасную сетевую связь (SNC).](https://help.sap.com/doc/saphelp_nw70/7.0.31/e6/56f466e99a11d1a5b00000e835363f/content.htm?no_cache=true) SNC может быть использован для sAP NetWeaver для одного входного (SSO) или для дополнительных возможностей безопасности, предоставляемых внешним продуктом безопасности.

Соединитель SAP интегрируется с локальными системами SAP через [локальный шлюз данных](../logic-apps/logic-apps-gateway-connection.md). В сценариях отправки, например, когда сообщение отправляется из приложения логики в систему SAP, шлюз данных выступает в качестве клиента RFC и перенаправляет запросы, полученные из приложения логики, в SAP. Аналогичным образом, в сценариях получения шлюз данных действует как сервер RFC, который получает запросы от SAP и перенаправляет их в логическое приложение.

В этой статье показано, как создать пример приложения логики, которое интегрируется с SAP, и использовать его для описанных ранее сценариев интеграции. Для логических приложений, которые используют старые разъемы SAP, эта статья показывает, как перенести логические приложения в последний разъем SAP.

<a name="pre-reqs"></a>

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, потребуется следующее:

* Подписка Azure. Если у вас еще нет подписки Azure, [получите бесплатную учетную запись Azure](https://azure.microsoft.com/free/).

* Приложение логики, из которого требуется осуществлять доступ к системе SAP, и триггер, который запускает рабочий процесс приложения логики. Если вы новичок в логических приложениях, [Quickstart: Create your first logic app](../logic-apps/quickstart-create-first-logic-app-workflow.md)см. [What is Azure Logic Apps?](../logic-apps/logic-apps-overview.md)

* Ваш [сервер приложений SAP](https://wiki.scn.sap.com/wiki/display/ABAP/ABAP+Application+Server) или [сервер сообщений SAP.](https://help.sap.com/saphelp_nw70/helpdata/en/40/c235c15ab7468bb31599cc759179ef/frameset.htm)

* Скачайте и установите последнюю версию [локального шлюза данных](https://www.microsoft.com/download/details.aspx?id=53127) на любом компьютере в локальной среде. Не забудьте настроить шлюз на портале Azure, прежде чем продолжить. Шлюз помогает вам безопасно получить доступ к данным и ресурсам. Для получения дополнительной информации [см.](../logic-apps/logic-apps-gateway-install.md)

* Если вы используете SNC с SSO, убедитесь, что шлюз работает как пользователь, который отображается против пользователя SAP. Чтобы изменить учетную запись по умолчанию, выберите **учетную запись Change**и введите учетные данные пользователя.

  ![Изменение учетной записи шлюза](./media/logic-apps-using-sap-connector/gateway-account.png)

* Если вы включите SNC с внешним продуктом безопасности, скопируйте библиотеку SNC или файлы на той же машине, где установлен шлюз. Некоторые примеры продуктов SNC включают [sapseculib,](https://help.sap.com/saphelp_nw74/helpdata/en/7a/0755dc6ef84f76890a77ad6eb13b13/frameset.htm)Kerberos, и NTLM.

* Скачать и установить последнюю клиентскую библиотеку SAP, которая в настоящее время [SAP Connector (NCo 3.0) для Microsoft .NET 3.0.22.0, составленную с помощью .NET Framework 4.0 - Windows 64-bit (x64)](https://softwaredownloads.sap.com/file/0020000001000932019)на том же компьютере, что и шлюз данных. Необходимо установить эту или более позднюю версию по следующим причинам:

  * Ранее версии SAP NCo могут завести в тупик, когда одновременно отправляется несколько сообщений IDoc. Это условие блокирует все последующие сообщения, которые отправляются в пункт назначения SAP, что приводит к тайм-ауту сообщений.
  
  * Локальный шлюз данных работает только в 64-разрядных системах. В противном случае возникает ошибка неправильного образа, так как служба узла шлюза управления данными не поддерживает 32-разрядные сборки.
  
  * Как служба узла шлюза управления данными, так и Microsoft SAP Adapter используют .NET Framework 4.5. SAP NCo для .NET Framework 4.0 работает с процессами, использующими среду выполнения .NET версии от 4.0 до 4.7.1. SAP NCo для .NET Framework 2.0 работает с процессами, которые используют время выполнения .NET от 2.0 до 3.5, но больше не работает с последним исданным шлюзом данных.

* Содержимое сообщений, которое можно отправить на ваш сервер SAP, например образец файла IDoc, должно быть в формате XML и включать в себя пространство имен для действий SAP, которые вы хотите использовать.

<a name="migrate"></a>

## <a name="migrate-to-current-connector"></a>Мигрировать в текущий разъем

1. Если вы еще не сделали этого, обновите [свой шлюз данных,](https://www.microsoft.com/download/details.aspx?id=53127) чтобы у вас была последняя версия. Для получения дополнительной информации [см.](../logic-apps/logic-apps-gateway-install.md)

1. В приложении логики, используюемом старый разъем SAP, удалите действие **Send to SAP.**

1. Из последнего разъема SAP добавьте **сообщение «Отправить» в действие SAP.** Прежде чем вы сможете использовать это действие, воссоздайте подключение к системе SAP.

1. Сохраните приложение логики, когда закончите.

<a name="add-trigger"></a>

## <a name="send-message-to-sap"></a>Send message to SAP (Отправить сообщение в SAP)

В этом примере используется приложение логики, которое может запускаться по HTTP-запросу. Приложение логики отправляет IDoc на сервер SAP и возвращает ответ запрашиванию, который называется приложением логики.

### <a name="add-an-http-request-trigger"></a>Добавить триггер запроса HTTP

В Azure Logic Apps каждое приложение логики должно запускаться по [триггеру](../logic-apps/logic-apps-overview.md#logic-app-concepts), который активируется, когда происходит определенное событие или если выполняются заданные условия. При каждом срабатывании триггера обработчик Logic Apps создает экземпляр приложения логики, запускающий рабочий процесс.

В этом примере создается приложение логики с конечной точкой в Azure, позволяющее отправлять *HTTP-запросы POST* в приложение логики. Когда приложение логики получает эти HTTP-запросы, триггер срабатывает и выполняет следующий шаг рабочего процесса.

1. На [портале Azure](https://portal.azure.com)создайте пустое логическое приложение, которое открывает Logic App Designer.

1. В поле поиска введите `http request` в качестве фильтра. Из списка **триггеров** выберите **При получении запроса HTTP.**

   ![Добавление триггера HTTP-запроса](./media/logic-apps-using-sap-connector/add-http-trigger-logic-app.png)

1. Теперь сохраните приложение логики, чтобы можно было создать URL-адрес для приложения логики. На панели инструментов конструктора щелкните **Сохранить**.

   Теперь URL-адрес конечной точки появится в триггере, например:

   ![Создание URL-адреса для конечной точки](./media/logic-apps-using-sap-connector/generate-http-endpoint-url.png)

<a name="add-action"></a>

### <a name="add-an-sap-action"></a>Добавление действия SAP

В Azure Logic Apps [действие](../logic-apps/logic-apps-overview.md#logic-app-concepts) — это шаг в рамках рабочего процесса, выполняемый после срабатывания триггера или другого действия. Если вы еще не добавили триггер в приложение логики и хотите следовать этому примеру, добавьте [этот триггер](#add-trigger).

1. В Logic App Designer, под спусковым крючком, выберите **новый шаг**.

   ![Добавление нового шага в логическое приложение](./media/logic-apps-using-sap-connector/add-sap-action-logic-app.png)

1. В поле поиска введите `sap` в качестве фильтра. Из списка **действий** выберите **Отправить сообщение в SAP.**
  
   ![Выберите действие «Отправить сообщение в SAP»](media/logic-apps-using-sap-connector/select-sap-send-action.png)

   Или можно выбрать вкладку **Enterprise** и выбрать действие SAP.

   ![Выберите действие «Отправить сообщение в SAP» из вкладки «Предприятие»](media/logic-apps-using-sap-connector/select-sap-send-action-ent-tab.png)

1. Если ваше соединение уже существует, продолжайте следующий шаг, чтобы можно настроить действие SAP. Однако, если вам предложено предоставить информацию о подключении, предоставьте информацию, чтобы можно было создать подключение к своему предприимчивому серверу SAP.

   1. Укажите имя соединения.

   1. В разделе **Шлюз данных** под **подпиской**сначала выберите подписку Azure для ресурса шлюза, созданного на портале Azure, для установки шлюза. 
   
   1. Под **шлюзом подключения**выберите ресурс шлюза.

   1. Продолжайте предоставлять информацию о подключении. Для свойства **Logon Type** следуйте за шагом, основанным на том, настроено ли свойство на **сервер приложений** или **группу:**
   
      * Для **Application Server**требуются эти свойства, которые обычно кажутся необязательными:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Для **группы**требуются следующие свойства, которые обычно кажутся необязательными:

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)  

      По умолчанию сильный ввод используется для проверки недействительных значений при выполнении проверки XML против схемы. Такое поведение может помочь вам обнаружить проблемы раньше. Опция **Safe Typing** доступна для обратной совместимости и проверяет только длину строки. Подробнее о [опции безопасного ввода.](#safe-typing)

   1. Когда вы закончите, выберите **Создать**.

      Логические приложения настраивают и тестирует соединение, чтобы убедиться, что соединение работает должным образом.

1. Теперь найдите и выберите действие с сервера SAP.

   1. В поле **SAP Action** выберите значок папки. В списке файлов найдите и выберите сообщение SAP, которое следует использовать. Переходите по списку, используя стрелки.

      Этот пример выбирает IDoc с типом **заказов.**

      ![Поиск и выбор действия IDoc](./media/logic-apps-using-sap-connector/SAP-app-server-find-action.png)

      Если не удается найти необходимое действие, можно вручную ввести путь, например:

      ![Указание пути к действию IDoc вручную](./media/logic-apps-using-sap-connector/SAP-app-server-manually-enter-action.png)

      > [!TIP]
      > Укажите значение **SAP Action** через редактор выражения. Таким образом, можно использовать одно и то же действие для различных типов сообщений.

      Для получения дополнительной информации [Message schemas for IDOC operations](https://docs.microsoft.com/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations)об операциях IDoc см.

   1. Щелкните внутри поля **Входное сообщение**, чтобы отобразился список динамического содержимого. В этом списке в разделе **При получении HTTP-запроса** выберите поле **Текст**.

      Этот шаг включает содержимое тела с триггера HTTP Request и отправляет этот вывод на ваш сервер SAP.

      ![Выберите свойство "Тело" из триггера](./media/logic-apps-using-sap-connector/SAP-app-server-action-select-body.png)

      Когда вы закончите, действие SAP выглядит следующим образом:

      ![Заполните действие SAP](./media/logic-apps-using-sap-connector/SAP-app-server-complete-action.png)

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

<a name="add-response"></a>

### <a name="add-an-http-response-action"></a>Добавление действия ответа HTTP

Теперь добавьте действие ответа в рабочий процесс приложения логики и включите в него выходные данные действия SAP. Таким образом приложение логики будет возвращать результаты с сервера SAP исходной запросившей стороне.

1. В Logic App Designer, под действием SAP, выберите **новый шаг.**

1. В поле поиска введите `response` в качестве фильтра. Из списка **действий** выберите **ответ.**

1. Щелкните внутри поля **Текст**, чтобы отобразился список динамического содержимого. Из этого списка, под **Отправить сообщение в SAP**, выберите поле **тела.**

   ![Готовое действие SAP](./media/logic-apps-using-sap-connector/select-sap-body-for-response-action.png)

1. Сохраните приложение логики.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. Если приложение логики еще не включено, в меню приложения логики выберите **Обзор**. На панели инструментов выберите **Включить**.

1. На панели инструментов дизайнера выберите **Run**. Так приложение логики будет запущено вручную.

1. Запустите логическое приложение, отправив запрос HTTP POST на URL-адрес в триггере HTTP Request.
Включите содержимое сообщения в свой запрос. Для отправки запроса можно использовать, например, средство [Postman](https://www.getpostman.com/apps).

   В этой статье запрос передает файл IDoc, который должен быть в формате XML и включать в себя пространство имен для используемого действия SAP, например:

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <Send xmlns="http://Microsoft.LobServices.Sap/2007/03/Idoc/2/ORDERS05//720/Send">
      <idocData>
         <...>
      </idocData>
   </Send>
   ```

1. После отправки HTTP-запроса дождитесь ответа от приложения логики.

   > [!NOTE]
   > Время ожидания приложения логики может истечь, если все действия, необходимые для ответа, не будут завершены в течение [времени ожидания запроса](./logic-apps-limits-and-config.md). Если это произойдет, запросы могут быть заблокированы. Для помощи в диагностике неполадок узнайте, как можно [проверять и отслеживать приложения логики](../logic-apps/monitor-logic-apps.md).

Теперь вы создали логическое приложение, которое может общаться с вашим сервером SAP. Теперь с настроенным подключением SAP для приложения логики можно изучить другие доступные действия SAP, например BAPI и RFC.

<a name="receive-from-sap"></a>

## <a name="receive-message-from-sap"></a>Получайте сообщение от SAP

В этом примере используется приложение логики, которое запускается, когда приложение получает сообщение из системы SAP.

### <a name="add-an-sap-trigger"></a>Добавить спусковой крючок SAP

1. На портале Azure создайте пустое приложение логики. Откроется конструктор приложений логики.

1. В поле поиска введите `sap` в качестве фильтра. Из списка **триггеров** **выберите, когда сообщение получено от SAP.**

   ![Добавление триггера SAP](./media/logic-apps-using-sap-connector/add-sap-trigger-logic-app.png)

   Или можно выбрать вкладку **Enterprise,** а затем выбрать триггер:

   ![Добавление триггера SAP из вкладки Enterprise](./media/logic-apps-using-sap-connector/add-sap-trigger-ent-tab.png)

1. Если ваше соединение уже существует, продолжайте следующий шаг, чтобы можно настроить действие SAP. Однако, если вам предложено предоставить информацию о подключении, предоставьте информацию, чтобы можно было создать подключение к своему предприимчивому серверу SAP.

   1. Укажите имя соединения.

   1. В разделе **Шлюз данных** под **подпиской**сначала выберите подписку Azure для ресурса шлюза, созданного на портале Azure, для установки шлюза. 

   1. Под **шлюзом подключения**выберите ресурс шлюза.

   1. Продолжайте предоставлять информацию о подключении. Для свойства **Logon Type** следуйте за шагом, основанным на том, настроено ли свойство на **сервер приложений** или **группу:**

      * Для **Application Server**требуются эти свойства, которые обычно кажутся необязательными:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Для **группы**требуются следующие свойства, которые обычно кажутся необязательными:

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)

      По умолчанию сильный ввод используется для проверки недействительных значений при выполнении проверки XML против схемы. Такое поведение может помочь вам обнаружить проблемы раньше. Опция **Safe Typing** доступна для обратной совместимости и проверяет только длину строки. Подробнее о [опции безопасного ввода.](#safe-typing)

   1. Когда вы закончите, выберите **Создать**.

      Логические приложения настраивают и тестирует соединение, чтобы убедиться, что соединение работает должным образом.

1. Укажите необходимые параметры в зависимости от конфигурации системы SAP.

   При необходимости можно указать одно или несколько действий SAP. Этот список действий определяет сообщения, получаемые триггером с сервера SAP через шлюз данных. Пустой список означает, что триггер будет получать все сообщения. Если в списке указано несколько сообщений, триггер получает только те сообщения, которые указаны в списке. Другие сообщения, отправленные с сервера SAP, будут отклонены шлюзом.

   Действие SAP можно выбрать с помощью средства выбора файла:

   ![Добавление действий SAP в приложение логики](media/logic-apps-using-sap-connector/select-SAP-action-trigger.png)  

   Можно также указать действие вручную:

   ![Ввод действия SAP вручную](media/logic-apps-using-sap-connector/manual-enter-SAP-action-trigger.png)

   Ниже приведен пример, в котором показано, как действие отображается в случае настройки триггера для получения более одного сообщения.

   ![Пример триггера, который получает несколько сообщений](media/logic-apps-using-sap-connector/example-trigger.png)

   Для получения дополнительной информации об [Message schemas for IDOC operations](https://docs.microsoft.com/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations) действии SAP см.

1. Теперь сохраните приложение логики, чтобы вы могли начать получать сообщения из системы SAP. На панели инструментов конструктора щелкните **Сохранить**.

Теперь приложение логики может получать сообщения из системы SAP.

> [!NOTE]
> Спусковой крючок SAP не является триггером опроса, а вместо этого является триггером на основе веб-крючка. Триггер вызывается из шлюза, только если существует сообщение, поэтому опрос не требуется.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. Чтобы активировать приложение логики, отправьте сообщение из системы SAP.

1. В меню приложения логики выберите **Обзор**. Просмотрите **историю запусков** для любых новых запусков для вашего приложения логики.

1. Откройте последний запуск, в котором отображается сообщение, отправленное из системы SAP, в разделе выходных данных триггера.

## <a name="receive-idoc-packets-from-sap"></a>Получение пакетов IDOC от SAP

Можно настроить SAP для [отправки IDOCs в пакеты,](https://help.sap.com/viewer/8f3819b0c24149b5959ab31070b64058/7.4.16/en-US/4ab38886549a6d8ce10000000a42189c.html)которые являются партиями или группами IDOCs. Для получения пакетов IDOC разъем SAP и, в частности, триггера не требуется дополнительная конфигурация. Однако для обработки каждого элемента в пакете IDOC после получения триггера необходимо разделить пакет на отдельные IDOCs.

Вот пример, который показывает, как извлечь отдельные IDOCs из пакета с помощью [ `xpath()` функции:](./workflow-definition-language-functions-reference.md#xpath)

1. Перед запуском вам нужно приложение логики с триггером SAP. Если у вас еще нет этого приложения логики, выполните предыдущие шаги в этой теме, чтобы [настроить логическое приложение с триггером SAP.](#receive-from-sap)

   Пример:

   ![Добавление триггера SAP в приложение логики](./media/logic-apps-using-sap-connector/first-step-trigger.png)

1. Получите корневое пространство имен из XML IDOC, которое ваше приложение логики получает от SAP. Чтобы извлечь это пространство имен из документа XML, добавьте шаг, который создает `xpath()` локальную переменную строки и сохраняет это пространство с помощью выражения:

   `xpath(xml(triggerBody()?['Content']), 'namespace-uri(/*)')`

   ![Получите корневое пространство имен от IDOC](./media/logic-apps-using-sap-connector/get-namespace.png)

1. Чтобы извлечь отдельный IDOC, добавьте шаг, который создает переменную `xpath()` массива и сохраняет коллекцию IDOC с помощью другого выражения:

   `xpath(xml(triggerBody()?['Content']), '/*[local-name()="Receive"]/*[local-name()="idocData"]')`

   ![Получить массив элементов](./media/logic-apps-using-sap-connector/get-array.png)

   Переменная массива делает каждый IDOC доступным для вашего приложения логики для индивидуальной обработки, перечисляя коллекцию. В этом примере приложение логики передает каждый IDOC на сервер SFTP с помощью цикла:

   ![Отправить IDOC на сервер SFTP](./media/logic-apps-using-sap-connector/loop-batch.png)

   Каждый IDOC должен включать корневое пространство имен, что является `<Receive></Receive` причиной, почему содержимое файла завернуто в элемент вместе с корневым пространством имен перед отправкой IDOC в приложение ниже по течению или сервер SFTP в этом случае.

Вы можете использовать шаблон quickstart для этого шаблона, выбрав этот шаблон в Logic App Designer при создании нового приложения логики.

![Выберите шаблон приложения пакетной логики](./media/logic-apps-using-sap-connector/select-batch-logic-app-template.png)

## <a name="generate-schemas-for-artifacts-in-sap"></a>Создание схем для артефактов в SAP

В этом примере используется приложение логики, которое может запускаться по HTTP-запросу. Действие SAP отправляет запрос в систему SAP для генерации схем для указанных IDoc и BAPI. Схемы, возвращающиеся в ответе, загружаются в учетную запись интеграции с помощью разъема управления ресурсами Azure.

### <a name="add-an-http-request-trigger"></a>Добавить триггер запроса HTTP

1. На портале Azure создайте пустое приложение логики. Откроется конструктор приложений логики.

1. В поле поиска введите `http request` в качестве фильтра. Из списка **триггеров** выберите **При получении запроса HTTP.**

   ![Добавление триггера HTTP-запроса](./media/logic-apps-using-sap-connector/add-http-trigger-logic-app.png)

1. Теперь сохраните приложение логики, чтобы можно было создать для него URL-адрес конечной точки.
На панели инструментов конструктора щелкните **Сохранить**.

   Теперь URL-адрес конечной точки появится в триггере, например:

   ![Создание URL-адреса для конечной точки](./media/logic-apps-using-sap-connector/generate-http-endpoint-url.png)

### <a name="add-an-sap-action-to-generate-schemas"></a>Добавление действия SAP для генерации схем

1. В Logic App Designer, под спусковым крючком, выберите **новый шаг**.

   ![Добавление нового шага в логическое приложение](./media/logic-apps-using-sap-connector/add-sap-action-logic-app.png)

1. В поле поиска введите `sap` в качестве фильтра. Из списка **действий** выберите **Схемы генерации.**
  
   ![Добавление действия "Generate schemas" в логическое приложение](media/logic-apps-using-sap-connector/select-sap-schema-generator-action.png)

   Или можно выбрать вкладку **Enterprise** и выбрать действие SAP.

   ![Выбор действия отправки в SAP на вкладке "Корпоративный"](media/logic-apps-using-sap-connector/select-sap-schema-generator-ent-tab.png)

1. Если ваше соединение уже существует, продолжайте следующий шаг, чтобы можно настроить действие SAP. Однако, если вам предложено предоставить информацию о подключении, предоставьте информацию, чтобы можно было создать подключение к своему предприимчивому серверу SAP.

   1. Укажите имя соединения.

   1. В разделе **Шлюз данных** под **подпиской**сначала выберите подписку Azure для ресурса шлюза, созданного на портале Azure, для установки шлюза. 
   
   1. Под **шлюзом подключения**выберите ресурс шлюза.

   1. Продолжайте предоставлять информацию о подключении. Для свойства **Logon Type** следуйте за шагом, основанным на том, настроено ли свойство на **сервер приложений** или **группу:**
   
      * Для **Application Server**требуются эти свойства, которые обычно кажутся необязательными:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Для **группы**требуются следующие свойства, которые обычно кажутся необязательными:

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)  

      По умолчанию сильный ввод используется для проверки недействительных значений при выполнении проверки XML против схемы. Такое поведение может помочь вам обнаружить проблемы раньше. Опция **Safe Typing** доступна для обратной совместимости и проверяет только длину строки. Подробнее о [опции безопасного ввода.](#safe-typing)

   1. Когда вы закончите, выберите **Создать**.

      Логические приложения настраивают и тестирует соединение, чтобы убедиться, что соединение работает должным образом.

1. Укажите путь к артефакту, для которого требуется создать схему.

   Действие SAP можно выбрать с помощью средства выбора файла:

   ![Выбор действия SAP](media/logic-apps-using-sap-connector/select-SAP-action-schema-generator.png)  

   Можно также ввести действие вручную:

   ![Ввод действия SAP вручную](media/logic-apps-using-sap-connector/manual-enter-SAP-action-schema-generator.png)

   Чтобы создать схемы для нескольких артефактов, укажите сведения о действии SAP для каждого артефакта, например:

   ![Выбор команды "Добавить новый элемент"](media/logic-apps-using-sap-connector/schema-generator-array-pick.png)

   ![Отображение двух элементов](media/logic-apps-using-sap-connector/schema-generator-example.png)

   Для получения дополнительной информации об [Message schemas for IDOC operations](https://docs.microsoft.com/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations)действии SAP см.

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. На панели инструментов дизайнера выберите **Run,** чтобы вызвать запуск для приложения логики.

1. Откройте запуск и проверьте выводы для действия **схемы создания.**

   В выходных данных отображаются созданные схемы для указанного списка сообщений.

### <a name="upload-schemas-to-an-integration-account"></a>Загрузка схем на интеграционную учетную запись

При необходимости можно загрузить созданные схемы и сохранить их в репозиториях, таких как большой двоичный объект, хранилище или учетная запись интеграции. Учетные записи интеграции предоставляют отличный интерфейс для работы с другими действиями XML, поэтому в этом примере показано, как отправить схемы в учетную запись интеграции для того же приложения логики с помощью соединителя Azure Resource Manager.

1. В Logic App Designer, под спусковым крючком, выберите **новый шаг**.

1. В поле поиска введите `Resource Manager` в качестве фильтра. Выберите **Создать или обновить ресурс.**

   ![Выбор действия Azure Resource Manager](media/logic-apps-using-sap-connector/select-azure-resource-manager-action.png)

1. Введите сведения о действиях, включая подписку Azure, группу ресурсов Azure и учетную запись интеграции. Чтобы добавить токены SAP в поля, щелкните внутри полей для этих полей и выберите из списка динамического содержимого, который появляется.

   1. Откройте новый список **параметров и** выберите поля **местоположения** и **свойства.**

   1. Предоставьте подробную информацию об этих новых полях, как показано в этом примере.

      ![Ввод сведений для действия Azure Resource Manager](media/logic-apps-using-sap-connector/azure-resource-manager-action.png)

   Действие SAP **Generate schemas** (Создать схемы) создает схемы в виде коллекции, поэтому конструктор автоматически добавляет цикл **for each** в действие. Ниже приведен пример, в котором показано, как выглядит это действие:

   ![Действие Azure Resource Manager с циклом for each](media/logic-apps-using-sap-connector/azure-resource-manager-action-foreach.png)

   > [!NOTE]
   > Схемы используют формат в кодировке base64. Чтобы отправить схемы в учетную запись интеграции, они должны быть декодированы с помощью функции `base64ToString()`. Ниже приведен пример, содержащий код для элемента `"properties"`:
   >
   > ```json
   > "properties": {
   >    "Content": "@base64ToString(items('For_each')?['Content'])",
   >    "ContentType": "application/xml",
   >    "SchemaType": "Xml"
   > }
   > ```

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. На панели инструментов дизайнера выберите **Run,** чтобы вручную вызвать приложение логики.

1. После успешного запуска перейдите на интеграционный счет и убедитесь, что генерируемые схемы существуют.

## <a name="enable-secure-network-communications"></a>Включить безопасную сетевую связь

Перед тем, как начать, убедитесь, что вы выполнили ранее [перечисленные предпосылки:](#pre-reqs)

* Шлюз данных установлен на машине, которая находится в той же сети, что и ваша система SAP.
* Для SSO шлюз работает как пользователь, который отображается для пользователя SAP.
* Библиотека SNC, предоставляющая дополнительные функции безопасности, устанавливается на той же машине, что и шлюз данных. Некоторые примеры включают [sapseculib,](https://help.sap.com/saphelp_nw74/helpdata/en/7a/0755dc6ef84f76890a77ad6eb13b13/frameset.htm)Kerberos, и NTLM.

   Чтобы включить SNC для ваших запросов в систему SAP или из нее, выберите флажок **Use SNC** в соединении SAP и предоставьте следующие свойства:

   ![Настройка SAP SNC в связи](media/logic-apps-using-sap-connector/configure-sapsnc.png)

   | Свойство | Описание |
   |----------| ------------|
   | **Путь библиотеки SNC** | Имя библиотеки SNC или путь относительно местоположения установки NCo или абсолютного пути. Примеры `sapsnc.dll` `.\security\sapsnc.dll` есть `c:\security\sapsnc.dll`или . |
   | **SNC SSO** | При подключении через SNC идентификационная личность SNC обычно используется для проверки подлинности вызывающего абонента. Другой вариант заключается в переопределение, так что пользователь и пароль информация может быть использована для проверки подлинности вызывающего абонента, но линия по-прежнему зашифрованы. |
   | **SNC Мое имя** | В большинстве случаев это свойство может быть опущено. Установленное решение SNC обычно знает свое собственное имя SNC. Только для решений, поддерживающих несколько идентификационных данных, может потребоваться указать идентификатор, который будет использоваться для данного конкретного пункта назначения или сервера. |
   | **Имя партнера SNC** | Название для бэк-энда SNC. |
   | **Качество защиты SNC** | Качество обслуживания, используемого для SNC связи данного конкретного назначения или сервера. Значение по умолчанию определяется системой бэк-энда. Максимальное значение определяется продуктом безопасности, используемым для SNC. |
   |||

   > [!NOTE]
   > Не устанавливайте переменные среды SNC_LIB и SNC_LIB_64 на машине, где у вас есть шлюз данных и библиотека SNC. Если набор, они имеют приоритет над значением библиотеки SNC, передаваемым через разъем.

<a name="safe-typing"></a>

## <a name="safe-typing"></a>Безопасный ввод

По умолчанию при создании соединения SAP для проверки недействительных значений используется сильный ввод при выполнении xML-проверки против схемы. Такое поведение может помочь вам обнаружить проблемы раньше. Опция **Safe Typing** доступна для обратной совместимости и проверяет только длину строки. Если вы выберете **Безопасный Типирование,** тип DATS и тип TIMS в SAP `xs:date` рассматриваются как строки, а не как их эквиваленты XML, и `xs:time`, где `xmlns:xs="http://www.w3.org/2001/XMLSchema"`. Безопасный ввод влияет на поведение для всех генерации схемы, отправки сообщения как для "отправленной" полезной нагрузки, так и для "полученного" ответа, а также для триггера. 

При использовании сильного ввода **(Безопасный тип** ирование не включен), схема отображает типы DATS и TIMS на более простые типы XML:

```xml
<xs:element minOccurs="0" maxOccurs="1" name="UPDDAT" nillable="true" type="xs:date"/>
<xs:element minOccurs="0" maxOccurs="1" name="UPDTIM" nillable="true" type="xs:time"/>
```

При отправке сообщений с помощью сильного ввода ответ DATS и TIMS соответствует соответствующему формату типа XML:

```xml
<DATE>9999-12-31</DATE>
<TIME>23:59:59</TIME>
```

При включении **safe Typing** схема отображает типы DATS и TIMS на поля хмл-строки только с ограничениями длины, например:

```xml
<xs:element minOccurs="0" maxOccurs="1" name="UPDDAT" nillable="true">
  <xs:simpleType>
    <xs:restriction base="xs:string">
      <xs:maxLength value="8" />
    </xs:restriction>
  </xs:simpleType>
</xs:element>
<xs:element minOccurs="0" maxOccurs="1" name="UPDTIM" nillable="true">
  <xs:simpleType>
    <xs:restriction base="xs:string">
      <xs:maxLength value="6" />
    </xs:restriction>
  </xs:simpleType>
</xs:element>
```

При отправке сообщений с включенным **safe Typing** ответ DATS и TIMS выглядит следующим образом:

```xml
<DATE>99991231</DATE>
<TIME>235959</TIME>
```

## <a name="advanced-scenarios"></a>Сложные сценарии

### <a name="confirm-transaction-explicitly"></a>Подтверждение транзакции явно

При отправке транзакций в SAP из logic Apps этот обмен происходит в двух шагах, как описано в документе SAP, [транзакционных серверных программах RFC.](https://help.sap.com/doc/saphelp_nwpi71/7.1/en-US/22/042ad7488911d189490000e829fbbd/content.htm?no_cache=true) По умолчанию действие **Send to SAP** обрабатывает как этапы для передачи функции, так и для подтверждения транзакции в одном вызове. Разъем SAP дает вам возможность разъединить эти шаги. Вы можете отправить IDOC и вместо автоматического подтверждения транзакции можно использовать явное действие **Идентификатора транзакции.**

Эта возможность разъединить подтверждение идентификатора транзакции полезна, когда не требуется дублировать транзакции в SAP, например, в сценариях, где сбои могут произойти из-за причин, таких как проблемы сети. Подтверждая идентификатор транзакции отдельно, транзакция завершается только один раз в вашей системе SAP.

Вот пример, который показывает этот шаблон:

1. Создайте пустое приложение логики и добавьте триггер HTTP.

1. Из разъема SAP добавьте действие **Send IDOC.** Предоставьте подробную информацию для IDOC, которую вы отправляете в систему SAP.

1. Чтобы явно подтвердить идентификатор транзакции в отдельном шаге, в поле **Confirm TID** выберите **No.** Для дополнительного поля **GuiD-транзакции** можно либо вручную указать значение, либо автоматически создать разъем и вернуть этот GUID в ответе от действия Send IDOC.

   ![Отправка свойств действий IDOC](./media/logic-apps-using-sap-connector/send-idoc-action-details.png)

1. Чтобы явно подтвердить идентификатор транзакции, добавьте действие **Идентификатора транзакции Confirm.** Нажмите внутри окна **ИДента транзакций,** чтобы появится список динамических содержимого. Из этого списка выберите значение **идентификатора транзакций,** возвращенное из действия **Send IDOC.**

   ![Подтверждение действия идентификатора транзакции](./media/logic-apps-using-sap-connector/explicit-transaction-id.png)

   После выполнения этого шага текущая транзакция будет завершена на обоих концах, на стороне разъема SAP и на стороне системы SAP.

## <a name="known-issues-and-limitations"></a>Известные проблемы и ограничения

Ниже приведены известные проблемы и ограничения для соединителя SAP:

* Триггер SAP не поддерживает кластеры шлюза данных. В некоторых случаях шлюз шлюза данных, который общается с системой SAP, может отличаться от активного узла, что приводит к неожиданному поведению. Для сценариев отправки поддерживаются кластеры шлюзов данных.

* Соединитель SAP в настоящее время не поддерживает строки маршрутизатора SAP. Локальный шлюз данных должен существовать в той же локальной сети, что и система SAP, к которой нужно подключиться.

## <a name="connector-reference"></a>Справочник по соединителям

Для получения более подробной информации об этом разъеме, таких как триггеры, действия и ограничения, описанные в файле Swagger разъема, смотрите [страницу ссылки разъема.](https://docs.microsoft.com/connectors/sap/)

> [!NOTE]
> Для логических приложений в [среде служб интеграции (ISE)](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md)эта версия с маркировкой ISE разъема использует вместо этого [ограничения сообщений ISE.](../logic-apps/logic-apps-limits-and-config.md#message-size-limits)

## <a name="next-steps"></a>Дальнейшие действия

* [Подключение к предприимным системам](../logic-apps/logic-apps-gateway-connection.md) из приложений Azure Logic Apps.
* Узнайте, как проверить, преобразовать и использовать другие операции с помощью пакета [интеграции enterprise.](../logic-apps/logic-apps-enterprise-integration-overview.md)
* Узнайте о других [разъемах логических приложений](../connectors/apis-list.md).
