---
title: Подключение к виртуальным сетям Azure с помощью ISE
description: Создание среды интеграционных служб (ISE), которая может получить доступ к виртуальным сетям Azure (VNETs) из приложений Azure Logic Apps
services: logic-apps
ms.suite: integration
ms.reviewer: klam, logicappspm
ms.topic: conceptual
ms.date: 03/12/2020
ms.openlocfilehash: fedc1f6ce8fbaeaf0d2cae3a1b04169192868e61
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79270697"
---
# <a name="connect-to-azure-virtual-networks-from-azure-logic-apps-by-using-an-integration-service-environment-ise"></a>Подключение к виртуальным сетям Azure из Azure Logic Apps с помощью среды службы интеграции (ISE)

Для сценариев, где вашим логическим приложениям и учетным записям интеграции необходим доступ к [виртуальной сети Azure,](../virtual-network/virtual-networks-overview.md)создайте [ *среду службы интеграции* (ISE).](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md) ISE — это изолированная среда, использующая специализированное хранилище и другие ресурсы, которые хранятся отдельно от «глобального» мультитенантного сервиса Logic Apps. Такое разделение помогает уменьшить любое влияние других клиентов Azure на производительность вашего приложения. ISE также предоставляет вам свои собственные статические IP-адреса. Эти IP-адреса отделены от статических IP-адресов, которые используются логическими приложениями в общедоступной мультитенантной службе.

При создании ISE Azure *вводит* ISE в виртуальную сеть Azure, которая затем развертывает службу Logic Apps в виртуальную сеть. При создании приложения логики или учетной записи интеграции выберите ISE в качестве места их расположения. После этого приложение логики или учетная запись интеграции смогут напрямую получать доступ к ресурсам в виртуальной сети, таким как виртуальные машины, серверы, системы и службы.

![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/select-logic-app-integration-service-environment.png)

> [!IMPORTANT]
> Для того чтобы логические приложения и учетные записи интеграции работали вместе в ISE, оба должны использовать тот *же ISE,* что и их местоположение.

ISE увеличил адеки по продолжительности выполнения, хранению хранилища, пропускной записи, тайм-аутам запросов и отсылки HTTP, размерам сообщений и пользовательским запросам разъемов. Для получения дополнительной [информации см.](../logic-apps/logic-apps-limits-and-config.md) Чтобы узнать больше о ISI, смотрите [доступ к ресурсам виртуальной сети Azure из приложений логики Azure.](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md)

В этой статье показано, как выполнить эти задачи с помощью портала Azure:

* Включите доступ для вашего ISE.
* Создайте свой ISE.
* Добавьте дополнительную емкость к вашему ISE.

Вы также можете создать ISE с помощью Logic Apps REST API, включая настройку ключей, управляемых клиентами:

* [Создание среды интеграционных служб (ISE) с помощью Logic Apps REST API](../logic-apps/create-integration-service-environment-rest-api.md)
* [Настройка ключей, управляемых клиентами, для шифрования данных в состоянии покоя для ИС-едоков](../logic-apps/customer-managed-keys-integration-service-environment.md)

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, [зарегистрируйтесь для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

  > [!IMPORTANT]
  > Логические приложения, встроенные триггеры, встроенные действия и разъемы, которые работают в ISE, используют план ценообразования, отличный от плана ценообразования на основе потребления. Чтобы узнать, как ценообразование и выставление счетов для ISEs, [см.](../logic-apps/logic-apps-pricing.md#fixed-pricing) Для ценообразования цены, см [Логика Apps ценообразования](../logic-apps/logic-apps-pricing.md).

* [Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md). Если у вас нет виртуальной сети, узнайте, [как ее создать](../virtual-network/quick-create-portal.md).

  * Ваша виртуальная сеть должна иметь четыре *пустых* подсети для создания и развертывания ресурсов в вашем ISE. Каждая подсеть поддерживает другой компонент Logic Apps, который используется в вашем ISE. Вы можете создать эти подсети заранее, или вы можете подождать, пока вы создаете ваш ISE, где вы можете создать подсети в то же время. Узнайте больше о [требованиях к подсети](#create-subnet).

  * Названия подсетей нужно начинать либо с алфавитного персонажа, либо с подчеркивать `%`и `&` `\\`не `?` `/`могут использовать эти символы: `<`, `>`, , . 
  
  * Если вы хотите развернуть ISE через шаблон Azure Resource Manager, сначала убедитесь, что вы делегируете одну пустую подсеть Microsoft.Logic/integrationServiceEnvironment. Вам не нужно делать эту делегацию при развертывании через портал Azure.

  * Убедитесь, что ваша виртуальная сеть [обеспечивает доступ к вашему ISE,](#enable-access) чтобы ваш ISE мог работать правильно и оставаться доступным.

  * Если вы используете [ExpressRoute](../expressroute/expressroute-introduction.md), который обеспечивает частное подключение к облачным службам Майкрософт, которое облегчается поставщиком подключения, необходимо [создать таблицу маршрутов,](../virtual-network/manage-route-table.md) которая имеет следующий маршрут и связать эту таблицу с каждой подсетью, используемой вашим ISE:

    **Имя**: <*название маршрута*><br>
    **Адресная префикс**: 0.0.0.0/0<br>
    **Следующий прыжок**: Интернет

* Если вы хотите использовать пользовательские DNS-серверы для виртуальной сети Azure, [навяжьте эти серверы, выдвинув эти действия](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md) перед развертыванием ISE в виртуальную сеть. Для получения дополнительной информации об управлении настройками DNS сервера [см.](../virtual-network/manage-virtual-network.md#change-dns-servers)

  > [!NOTE]
  > Если вы измените настройки DNS-сервера или DNS-сервера, необходимо перезапустить ISE, чтобы ISE мог получить эти изменения. Для получения дополнительной информации смотрите [перезапуск ISE](../logic-apps/ise-manage-integration-service-environment.md#restart-ISE).

<a name="enable-access"></a>

## <a name="enable-access-for-ise"></a>Включите доступ к ISE.

При использовании ISE с виртуальной сетью Azure общая проблема настройки заключается в том, что один или несколько заблокированных портов. Разъемы, которые используются для создания соединений между системами ISE и назначения, также могут иметь свои собственные портовые требования. Например, если вы общаетесь с системой FTP с помощью разъема FTP, порт, который используется в системе FTP, должен быть доступен, например, порт 21 для отправки команд.

Чтобы убедиться, что ваш ISE доступен и что логические приложения в том, что ISE может общаться через каждую подсеть в вашей виртуальной сети, [откройте порты, описанные в этой таблице для каждой подсети.](#network-ports-for-ise) Если какие-либо требуемые порты недоступны, isE не будет работать правильно.

* Если у вас есть несколько экземпляров ISE, которые нуждаются в доступе к другим конечным точкам, которые имеют ограничения IP, развернуть [брандмауэр Azure](../firewall/overview.md) или [виртуальный прибор сети](../virtual-network/virtual-networks-overview.md#filter-network-traffic) в виртуальной сети и маршрут исходящего трафика через этот брандмауэр или виртуальный прибор сети. Затем можно [настроить единый, исходящий, общедоступный, статический и предсказуемый IP-адрес,](connect-virtual-network-vnet-set-up-single-ip-address.md) который все экземпляры ISE в вашей виртуальной сети могут использовать для связи с системами назначения. Таким образом, вам не нужно устанавливать дополнительные брандмауэры в этих системах назначения для каждого ISE.

   > [!NOTE]
   > Этот подход можно использовать для одного ISE, когда сценарий требует ограничения количества IP-адресов, которым необходим доступ. Подумайте, имеют ли смысл дополнительные затраты на брандмауэр или виртуальный сетевой прибор для вашего сценария. Узнайте больше о [ценах на брандмауэр Azure Firewall.](https://azure.microsoft.com/pricing/details/azure-firewall/)

* Если вы создали новую виртуальную сеть и подсети Azure без каких-либо ограничений, вам не нужно создавать [группы сетевой безопасности (НСГ)](../virtual-network/security-overview.md#network-security-groups) в виртуальной сети для управления трафиком через подсети.

* В существующей виртуальной сети можно *дополнительно* настроить НСГ, [фильтруя сетевой трафик через подсети.](../virtual-network/tutorial-filter-network-traffic.md) Если вы хотите пойти по этому маршруту, или если вы уже используете НСГ, убедитесь, что вы [открываете порты в этой таблице](#network-ports-for-ise) в виртуальной сети, где у вас есть НСГ или хотите настроить НСГ.

  > [!NOTE]
  > Если вы используете [правила безопасности NSG,](../virtual-network/security-overview.md#security-rules)вам необходимо использовать *протоколы* TCP и UDP. Правила безопасности NSG описывают порты, которые необходимо открыть для IP-адресов, которые нуждаются в доступе к этим портам. Убедитесь, что любые брандмауэры, маршрутизаторы или другие элементы, существующие между этими конечными точками, также сохраняют доступ к этим IP-адресам.

<a name="network-ports-for-ise"></a>

### <a name="network-ports-used-by-your-ise"></a>Сетевые порты, используемые вашим ISE

В этой таблице описаны порты в виртуальной сети Azure, которые использует ISE и где используются эти порты. Чтобы снизить сложность при создании правил безопасности, [теги служб](../virtual-network/service-tags-overview.md) ы и таблицы представляют группы префиксов IP-адресов для определенной службы Azure.

> [!IMPORTANT]
> Порты исходных источников являются эфемерными, `*` поэтому убедитесь, что вы установите их для всех правил. Где отмечено, внутренние ISE и внешние ISE относятся к [конечной точке, которая выбрана в создании ISE](connect-virtual-network-vnet-isolated-environment.md#create-environment). Для получения дополнительной [Endpoint access](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md#endpoint-access)информации см. 

| Назначение | Направление | Конечные порты | Тег службы источника | Тег целевой службы | Примечания |
|---------|-----------|-------------------|--------------------|-------------------------|-------|
| Интерсубнеткоммуникация в виртуальной сети | Входящий и исходящий | * | Адресное пространство для виртуальной сети, которая имеет подсети ISE | Адресное пространство для виртуальной сети, которая имеет подсети ISE | Требуется для того, чтобы трафик перетекал *между* подсетями в виртуальной сети. <p><p>**Важно:** Для того, чтобы трафик между *компонентами* в каждой подсети, убедитесь, что вы открываете все порты в каждой подсети. |
| Связь с вашим логическим приложением | Входящий трафик | 443 | Внутренний ISE: <br>Виртуальная сеть <p><p>Внешний ISE: <br>Интернет <br>(см. **колонку Примечаний)** | Виртуальная сеть | Вместо того, чтобы использовать тег **интернет-сервиса,** можно указать исходный IP-адрес для компьютера или службы, который вызывает любые триггеры запроса или webhooks в вашем приложении логики. <p><p>**Важно:** Закрытие или блокировка этого порта предотвращает http звонки в логические приложения, которые имеют триггеры запроса. |
| Логика приложение запустить историю | Входящий трафик | 443 | Внутренний ISE: <br>Виртуальная сеть <p><p>Внешний ISE: <br>Интернет <br>(см. **колонку Примечаний)** | Виртуальная сеть | Вместо того, чтобы использовать тег **интернет-сервиса,** можно указать исходный IP-адрес для компьютера или службы, откуда вы хотите просмотреть историю запуска приложения логики. <p><p>**Важно:** Хотя закрытие или блокировка этого порта не мешает просматривать историю выполнения, вы не можете просматривать входы и выходы для каждого шага в этой истории выполнения. |
| Конструктор Logic Apps — динамические свойства | Входящий трафик | 454 | LogicAppsManagement | Виртуальная сеть | Запросы поступают с конечных IP-адресов Logic Apps, [входящих в](../logic-apps/logic-apps-limits-and-config.md#inbound) этот регион. |
| Развертывание соединителя | Входящий трафик | 454 | Лазурные Коннектодоры | Виртуальная сеть | Требуется для развертывания и обновления разъемов. Закрытие или блокировка этого порта приводит к сбою развертывания ISE и предотвращает обновление или исправление разъема. |
| Проверка работоспособности сети | Входящий трафик | 454 | LogicApps | Виртуальная сеть | Запросы поступают из конечных точек доступа Logic Apps как для [входящих,](../logic-apps/logic-apps-limits-and-config.md#inbound) так и [для исходящих](../logic-apps/logic-apps-limits-and-config.md#outbound) IP-адресов для этого региона. |
| Зависимость от управления службой приложений | Входящий трафик | 454, 455 | AppServiceManagement | Виртуальная сеть | |
| Связь от менеджера azure Traffic | Входящий трафик | Внутреннее ISE: 454 <p><p>Внешний ISE: 443 | AzureTrafficManager. | Виртуальная сеть | |
| Управление API — конечная точка управления | Входящий трафик | 3443 | APIManagement | Виртуальная сеть | |
| Развертывание политики соединения | Входящий трафик | 3443 | APIManagement | Виртуальная сеть | Требуется для развертывания и обновления разъемов. Закрытие или блокировка этого порта приводит к сбою развертывания ISE и предотвращает обновление или исправление разъема. |
| Связь из приложения логики | Исходящие | 80, 443 | Виртуальная сеть | Варианты в зависимости от назначения | Конечные точки для внешнего сервиса, с которым необходимо общаться приложению логики. |
| Azure Active Directory | Исходящие | 80, 443 | Виртуальная сеть | AzureActiveDirectory | |
| Управление соединениями | Исходящие | 443 | Виртуальная сеть  | AppService | |
| Публикация журналов диагностики и метрик | Исходящие | 443 | Виртуальная сеть  | AzureMonitor | |
| Зависимость от службы хранилища Azure | Исходящие | 80, 443, 445 | Виртуальная сеть | Хранилище | |
| Зависимость лазурного сИ-L | Исходящие | 1433 | Виртуальная сеть | SQL | |
| Служба работоспособности ресурса Azure | Исходящие | 1886 | Виртуальная сеть | AzureMonitor | Требуется для публикации состояния здоровья ресурса |
| Зависимость от политики передачи журнала в концентратор событий и от агента мониторинга | Исходящие | 5672 | Виртуальная сеть | концентратор событий. | |
| Доступ к экземплярам кэша Azure для Redis между экземплярами ролей | Входящий трафик <br>Исходящие | 6379 - 6383 | Виртуальная сеть | Виртуальная сеть | Кроме того, для работы ISE с Azure Cache для Redis необходимо открыть эти [исходящие и входящие порты, описанные в кэше Azure для часто задаваемых вопросов Redis.](../azure-cache-for-redis/cache-how-to-premium-vnet.md#outbound-port-requirements) |
||||||

<a name="create-environment"></a>

## <a name="create-your-ise"></a>Создание среды службы интеграции

1. На [портале Azure](https://portal.azure.com)в главном поле поиска `integration service environments` Azure введите фильтр и выберите **среды службы интеграции.**

   ![Найти и выбрать "Интеграционные услуги среды"](./media/connect-virtual-network-vnet-isolated-environment/find-integration-service-environment.png)

1. На панели **среды интеграции службы,** выберите **Добавить**.

   ![Найти и выбрать "Интеграционные услуги среды"](./media/connect-virtual-network-vnet-isolated-environment/add-integration-service-environment.png)

1. Предоставьте эти сведения для среды, а затем выберите **Обзор и создайте,** например:

   ![Предоставление сведений о среде](./media/connect-virtual-network-vnet-isolated-environment/integration-service-environment-details.png)

   | Свойство | Обязательно | Значение | Описание |
   |----------|----------|-------|-------------|
   | **Подписка** | Да | <*Имя подписки Azure*> | Подписка Azure, используемая для среды. |
   | **Группа ресурсов** | Да | <*Azure-ресурс-группа-имя*> | Новая или существующая группа ресурсов Azure, в которой требуется создать среду |
   | **Название среды интеграции** | Да | <*имя окружающей среды*> | Ваше имя ISE, которое может содержать только`-`буквы,`_`цифры,`.`дефисы (), подчеркивает (), и периоды (). |
   | **Расположение** | Да | <*Azure-центр обработки данных-регион*> | Регион центра обработки данных Azure, в котором нужно развернуть среду. |
   | **номер SKU** | Да | **Премиум** или **разработчик (без SLA)** | ISE SKU для создания и использования. Для различий между этими SKUS, [см.](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md#ise-level) <p><p>**Важно:** Эта опция доступна только при создании ISE и не может быть изменена позже. |
   | **Дополнительная емкость** | Премиум: <br>Да <p><p>Разработчик: <br>Неприменимо | Премиум: <br>От 0 до 10 <p><p>Разработчик: <br>Неприменимо | Количество дополнительных единиц обработки для использования для этого ресурса ISE. Чтобы добавить емкость после создания, [см.](../logic-apps/ise-manage-integration-service-environment.md#add-capacity) |
   | **Конечная точка доступа** | Да | **Внутренние** или **внешние** | Тип конечных точек доступа для использования для вашего ISE. Эти конечные точки определяют, могут ли триггеры запроса или веб-крючка для логических приложений в вашем ISE принимать звонки из-за пределов вашей виртуальной сети. <p><p>Выбор также влияет на способ просмотра и доступа к входным данным и выводам в приложении логики, который выполняет историю. Для получения дополнительной информации смотрите [доступ к конечным точкам ISE](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md#endpoint-access). <p><p>**Важно:** Эта опция доступна только при создании ISE и не может быть изменена позже. |
   | **Виртуальная сеть** | Да | <*Azure-виртуальное сетевое имя*> | Виртуальная сеть Azure, в которую нужно внедрить среду, чтобы приложения логики в этой среде могли получить доступ к виртуальной сети. Если у вас нет сети, [сначала создайте виртуальную сеть Azure.](../virtual-network/quick-create-portal.md) <p><p>**Важно:** Вы можете выполнить эту инъекцию *только* при создании ISE. |
   | **Подсетей** | Да | <*поднет-ресурс-лист*> | ISE требует четырех *пустых* подсетей для создания и развертывания ресурсов в вашей среде. Для создания каждой подсети [выполните действия, описанные в этой таблице](#create-subnet). |
   |||||

   <a name="create-subnet"></a>

   **Создание подсети**

   Для создания и развертывания ресурсов в среде ISE требуется четыре *пустых* подсети, которые не делегируются ни одной службе. Каждая подсеть поддерживает другой компонент Logic Apps, который используется в вашем ISE. Вы *не можете* изменить эти адреса подсети после создания среды. Каждая подсеть должна соответствовать этим требованиям:

   * Имеет имя, которое начинается с алфавитного характера или подчеркивать (без цифр), `%`и `&` `\\`не `?` `/`использует эти символы: `<`, `>`, , , .

   * Использует [формат Classless Inter-Domain Routing (CIDR)](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) и адресное пространство класса B.

   * Использует по `/27` крайней мере в адресном пространстве, потому что каждая подсеть требует 32 адресов *как минимум.* Пример:

     * `10.0.0.0/28`имеет только 16 адресов и слишком мал, потому что 2<sup>(32-28)</sup> 2<sup>4</sup> или 16.

     * `10.0.0.0/27` содержит 32 адреса, потому что 2<sup>(32-27)</sup> равно 2<sup>5</sup> или 32.

     * `10.0.0.0/24` содержит 256 адресов, потому что 2<sup>(32–24)</sup> равно 2<sup>8</sup> или 256. Однако больше адресов не предоставляют никаких дополнительных преимуществ.

     Чтобы узнать больше о расчете [адресов, см.](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks)

   * Если вы используете [ExpressRoute,](../expressroute/expressroute-introduction.md)вы должны [создать таблицу маршрутов,](../virtual-network/manage-route-table.md) которая имеет следующий маршрут и связать эту таблицу с каждой подсетью, используемой вашим ISE:

     **Имя**: <*название маршрута*><br>
     **Адресная префикс**: 0.0.0.0/0<br>
     **Следующий прыжок**: Интернет

   1. Под списком **подсетей** выберите **конфигурацию подсети Manage.**

      ![Управление конфигурацией подсети](./media/connect-virtual-network-vnet-isolated-environment/manage-subnet-configuration.png)

   1. На панели **подсетей** выберите **Subnet**.

      ![Добавить четыре пустых подсетей](./media/connect-virtual-network-vnet-isolated-environment/add-empty-subnets.png)

   1. На панели **Добавить подсеть** введите следующие сведения.

      * **Имя**: Имя вашей подсети
      * **Диапазон адресов (блок CIDR)**: Диапазон вашей подсети в виртуальной сети и в формате CIDR

      ![Добавление сведений о подсети](./media/connect-virtual-network-vnet-isolated-environment/provide-subnet-details.png)

   1. Закончив, нажмите кнопку **OK**.

   1. Повторите эти шаги еще для трех подсетей.

      > [!NOTE]
      > Если подсети, которые пытаются создать, недействительны, портал Azure показывает сообщение, но не блокирует ход работ.

   Для получения дополнительной информации о создании подсетей, [см.](../virtual-network/virtual-network-manage-subnet.md)

1. После того, как Azure успешно проверяет информацию ISE, **выберите, например, создать:**

   ![После успешной проверки выберите "Создать"](./media/connect-virtual-network-vnet-isolated-environment/ise-validation-success.png)

   Azure начинает развертывание среды, которая обычно занимает в течение двух часов. Иногда развертывание может занять до четырех часов. Чтобы проверить состояние развертывания на панели инструментов Azure, выберите значок уведомлений, который открывает панель уведомлений.

   ![Проверка состояния развертывания](./media/connect-virtual-network-vnet-isolated-environment/environment-deployment-status.png)

   Если развертывание будет успешно завершено, в Azure отобразится следующее уведомление:

   ![Развертывание выполнено](./media/connect-virtual-network-vnet-isolated-environment/deployment-success-message.png)

   В противном случае следуйте инструкциям портала Azure для развертывания устранения неполадок.

   > [!NOTE]
   > Если развертывание завершится ошибкой или вы удалите среду службы интеграции, освобождение подсетей в Azure может занять до одного часа. Эта задержка означает, что вам, возможно, придется подождать, прежде чем повторно использовать эти подсети в другом ISE.
   >
   > Если вы удалите виртуальную сеть, Azure обычно занимает до двух часов, прежде чем выпустить ваши подсети, но эта операция может занять больше времени. 
   > При удалянии виртуальных сетей убедитесь, что ресурсы по-прежнему не подключены. 
   > Смотрите [Удалить виртуальную сеть](../virtual-network/manage-virtual-network.md#delete-a-virtual-network).

1. Для просмотра среды выберите **«Перейти к ресурсу,** если Azure не автоматически переходит в среду после завершения развертывания.

1. Чтобы проверить работоспособность сети для ISE, [см.](../logic-apps/ise-manage-integration-service-environment.md#check-network-health)

1. Чтобы начать создавать логические приложения и другие артефакты в ISE, [см.](../logic-apps/add-artifacts-integration-service-environment-ise.md)

   > [!IMPORTANT]
   > Управляемые разъемы ISE, которые становятся доступными после создания ISE, автоматически не отображаются в сборщике разъемов на Logic App Designer. Прежде чем вы сможете использовать эти разъемы ISE, вы должны вручную [добавить эти разъемы к вашему ISE](../logic-apps/add-artifacts-integration-service-environment-ise.md#add-ise-connectors-environment) так, чтобы они появляются в Logic App Designer.

## <a name="next-steps"></a>Дальнейшие действия

* [Добавление ресурсов в среды служб интеграции](../logic-apps/add-artifacts-integration-service-environment-ise.md)
* [Управление средами службы интеграции](../logic-apps/ise-manage-integration-service-environment.md#check-network-health)
* Узнайте больше о [виртуальной сети Azure](../virtual-network/virtual-networks-overview.md)
* Узнайте об [интеграции виртуальной сети для служб Azure](../virtual-network/virtual-network-for-azure-services.md).
