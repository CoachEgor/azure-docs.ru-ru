---
title: Подключение к виртуальным сетям Azure из Azure Logic Apps через среду службы интеграции (ISE)
description: Создайте среду службы интеграции (ISE), чтобы приложения логики и учетные записи интеграции могли получать доступ к виртуальным сетям Azure, оставаясь при этом частными и изолированными от общедоступной ("глобальной") среды Azure
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: klam, LADocs
ms.topic: conceptual
ms.date: 07/19/2019
ms.openlocfilehash: fe92d36eca05b47f928f6644053fb9b0149d6db9
ms.sourcegitcommit: 4b431e86e47b6feb8ac6b61487f910c17a55d121
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/18/2019
ms.locfileid: "68326768"
---
# <a name="connect-to-azure-virtual-networks-from-azure-logic-apps-by-using-an-integration-service-environment-ise"></a>Подключение к виртуальным сетям Azure из Azure Logic Apps с помощью среды службы интеграции (ISE)

Для сценариев, в которых приложениям логики и учетным записям интеграции требуется доступ к [виртуальной сети Azure](../virtual-network/virtual-networks-overview.md), создайте [*среду службы интеграции*](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md). ISE — это частная и изолированная среда, использующая выделенное хранилище и другие ресурсы, которые хранятся отдельно от общедоступной или глобальной службы Logic Apps. Такое разделение помогает уменьшить любое влияние других клиентов Azure на производительность вашего приложения.

При создании интегрированной среды сценариев Azure *внедряет* интегрированную среду сценариев в виртуальную сеть Azure, которая затем развертывает службу Logic Apps в виртуальной сети. При создании приложения логики или учетной записи интеграции выберите в качестве своего расположения интегрированную среду сценариев. После этого приложение логики или учетная запись интеграции смогут напрямую получать доступ к ресурсам в виртуальной сети, таким как виртуальные машины, серверы, системы и службы.

![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/select-logic-app-integration-service-environment.png)

В интегрированной среде сценариев увеличены ограничения на длительность выполнения, срок хранения, пропускную способность, HTTP-запрос и время ожидания ответа, размер сообщений и пользовательские запросы соединителей. Дополнительные сведения см. в разделе [ограничения и настройка для Azure Logic Apps](logic-apps-limits-and-config.md). Дополнительные сведения о Исес см. в статье [доступ к ресурсам виртуальной сети Azure из Azure Logic Apps](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md).

В этой статье показано, как выполнять следующие задачи:

* Убедитесь, что все необходимые порты в виртуальной сети открыты, чтобы трафик мог перемещаться по подсетям в этой виртуальной сети через среду службы интеграции (ISE).

* создавать среду службы интеграции;

* создавать приложение логики, которое может выполняться в среде службы интеграции;

* создавать учетную запись интеграции для приложений логики в среде службы интеграции.

> [!IMPORTANT]
> Приложения логики, встроенные триггеры, встроенные действия и соединители, работающие в интегрированной среде сценариев, используют тарифный план, отличный от плана ценообразования на основе потребления. Чтобы узнать, как цены и данные о выставлении счетов для Исес, см. [Logic Apps модель ценообразования](../logic-apps/logic-apps-pricing.md#fixed-pricing). Цены см. на странице [цен на Logic Apps](../logic-apps/logic-apps-pricing.md).

## <a name="prerequisites"></a>предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, <a href="https://azure.microsoft.com/free/" target="_blank">зарегистрируйтесь для получения бесплатной учетной записи Azure</a>.

* [Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md). Если у вас нет виртуальной сети, узнайте, [как ее создать](../virtual-network/quick-create-portal.md). 

  * Ваша виртуальная сеть должна иметь четыре *пустые* подсети для создания и развертывания ресурсов в интегрированной среде сценариев. Вы можете создать эти подсети заранее или дождаться создания интегрированной среды сценариев, где вы сможете создавать подсети одновременно. Дополнительные сведения о [требованиях к подсети](#create-subnet). 
  
    > [!NOTE]
    > Если вы используете [ExpressRoute](../expressroute/expressroute-introduction.md), который предоставляет частное подключение к облачным службам Майкрософт, необходимо [создать таблицу маршрутов](../virtual-network/manage-route-table.md) , которая имеет следующий маршрут и свяжет эту таблицу с каждой подсетью, используемой интегрированной средой.
    > 
    > **Имя**: <*Route-Name* .><br>
    > **Префикс адреса**: 0.0.0.0/0<br>
    > **Определение следующего прыжка**. Интернет

  * Убедитесь, что ваша виртуальная сеть [предоставляет доступ к этим портам](#ports) , чтобы интегрированная среда сценариев работала правильно и оставалась доступной.

* Если вы хотите использовать пользовательские DNS-серверы для виртуальной сети Azure, [Настройте эти серверы, выполнив следующие действия](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md) перед развертыванием интегрированной среды сценариев в виртуальной сети. Иначе при каждом изменении DNS-сервера вам придется перезагружать среду службы интеграции. Такая возможность доступна в общедоступной предварительной версии среды службы интеграции.

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

<a name="ports"></a>

## <a name="check-network-ports"></a>Проверка сетевых портов

При использовании среды службы Integration Services (ISE) с виртуальной сетью общая проблема установки состоит в наличии одного или нескольких заблокированных портов. Соединители, используемые для создания подключений между средой ISE и целевой системой, также могут иметь собственные требования к портам. Например, если для связи с системой FTP вы используете соединитель FTP, убедитесь в доступности порта, который нужен для этой системы FTP (обычно это порт 21).

Для управления трафиком в подсетях виртуальной сети, в которых развертывается интегрированная среда сценариев, при необходимости можно настроить [группы безопасности сети (группы безопасности сети)](../virtual-network/security-overview.md) в виртуальной сети путем [фильтрации сетевого трафика между](../virtual-network/tutorial-filter-network-traffic.md)подсетями. При выборе этого маршрута убедитесь, что интегрированная среда сценариев открывает определенные порты, как описано в следующей таблице в виртуальной сети, использующей группы безопасности сети. Если в виртуальной сети есть существующие группы безопасности сети или брандмауэры, убедитесь, что они открывают эти порты. Таким образом, интегрированная среда сценариев остается доступной и может работать правильно, чтобы не потерять доступ к интегрированной среде сценариев. В противном случае, если все необходимые порты недоступны, интегрированная среда сценариев перестанет работать.

В этих таблицах указаны порты, которые среда службы интеграции использует в виртуальной сети, и описано их назначение. [Теги службы Диспетчер ресурсов](../virtual-network/security-overview.md#service-tags) представляют собой группу ПРЕФИКСОВ IP-адресов, которые позволяют сократить сложность при создании правил безопасности.

> [!IMPORTANT]
> Для внутренней связи внутри подсетей интегрированная среда сценариев ISE требует, чтобы вы открывали все порты в этих подсетях.

| Цель | Direction | порты; | Тег службы источника | Тег целевой службы | Примечания |
|---------|-----------|-------|--------------------|-------------------------|-------|
| Поток данных из Azure Logic Apps | Исходящие | 80 и 443 | VirtualNetwork | Интернет | Порт зависит от внешней службы, с которой взаимодействует служба Logic Apps. |
| Azure Active Directory | Исходящие | 80 и 443 | VirtualNetwork | AzureActiveDirectory | |
| Зависимость от службы хранилища Azure | Исходящие | 80 и 443 | VirtualNetwork | Хранилище | |
| Взаимодействие между подсетями | Входящий и исходящий | 80 и 443 | VirtualNetwork | VirtualNetwork | Для связи между подсетями |
| Поток данных в Azure Logic Apps | Входящий трафик | 443 | Интернет | VirtualNetwork | IP-адрес компьютера или службы, который вызывает любой триггер запроса или веб-перехватчик, существующий в приложении логики. Закрытие или блокировка этого порта предотвращает вызовы HTTP в Logic Apps с триггерами запросов.  |
| Журнал выполнения приложений логики | Входящий трафик | 443 | Интернет | VirtualNetwork | IP-адрес компьютера, с которого вы просматриваете журнал выполнения приложения логики. Хотя закрытие или блокирование этого порта не мешает просмотру журнала выполнения, вы не сможете просматривать входные и выходные данные для каждого шага в этом журнале выполнения. |
| Управление соединениями | Исходящие | 443 | VirtualNetwork  | Интернет | |
| Публикация журналов диагностики и метрик | Исходящие | 443 | VirtualNetwork  | AzureMonitor | |
| Обмен данными с диспетчером трафика Azure | Входящий трафик | 443 | AzureTrafficManager | VirtualNetwork | |
| Конструктор Logic Apps — динамические свойства | Входящий трафик | 454 | Интернет  | VirtualNetwork | Запросы поступают из Logic Apps [доступа к входящим IP-адресам конечной точки в этом регионе](../logic-apps/logic-apps-limits-and-config.md#inbound). |
| Зависимость от управления службой приложений | Входящий трафик | 454 и 455 | AppServiceManagement | VirtualNetwork | |
| Развертывание соединителя | Входящий трафик | 454 & 3443 | Интернет  | VirtualNetwork | Требуется для развертывания и обновления соединителей. Закрытие или блокировка этого порта приводит к сбою развертываний интегрированной среды сценариев и предотвращает обновления или исправления соединителя. |
| Зависимость SQL Azure | Исходящие | 1433 | VirtualNetwork | SQL |
| Служба работоспособности ресурса Azure | Исходящие | 1886 | VirtualNetwork | Интернет | Для публикации состояния работоспособности в Работоспособность ресурсов |
| Управление API — конечная точка управления | Входящий трафик | 3443 | APIManagement  | VirtualNetwork | |
| Зависимость от политики передачи журнала в концентратор событий и от агента мониторинга | Исходящие | 5672 | VirtualNetwork  | концентратор событий. | |
| Доступ к экземплярам кэша Azure для Redis между экземплярами ролей | Входящий трафик <br>Исходящие | 6379-6383 | VirtualNetwork  | VirtualNetwork | Кроме того, чтобы интегрированная среда сценариев работала с кэшем Azure для Redis, необходимо открыть эти [порты для исходящего и входящего трафика, описанные в статье вопросы и ответы по кэшу Azure для Redis](../azure-cache-for-redis/cache-how-to-premium-vnet.md#outbound-port-requirements). |
| Azure Load Balancer | Входящий трафик | * | AzureLoadBalancer | VirtualNetwork |  |
||||||

<a name="create-environment"></a>

## <a name="create-your-ise"></a>Создание среды службы интеграции

Чтобы создать среду службы интеграции, выполните следующие действия:

1. На [портале Azure](https://portal.azure.com) в главном меню Azure выберите **Создать ресурс**.
В поле поиска введите "среда службы интеграции" в качестве фильтра.

   ![Создание ресурса](./media/connect-virtual-network-vnet-isolated-environment/find-integration-service-environment.png)

1. На панели создания среда службы интеграции выберите **создать**.

   ![Нажатие кнопки "Создать"](./media/connect-virtual-network-vnet-isolated-environment/create-integration-service-environment.png)

1. Укажите следующие сведения для своей среды, а затем выберите **Просмотр и создание**, как показано здесь:

   ![Предоставление сведений о среде](./media/connect-virtual-network-vnet-isolated-environment/integration-service-environment-details.png)

   | Свойство | Обязательно для заполнения | Value | Описание |
   |----------|----------|-------|-------------|
   | **Подписка** | Да | <*Azure-subscription-name*> | Подписка Azure, используемая для среды. |
   | **Группа ресурсов** | Да | <*имя_группы_ресурсов_Azure*> | Группа ресурсов Azure, в которой необходимо создать среду. |
   | **Имя среды службы интеграции** | Да | <*имя_среды*> | Имя, которое будет присвоено среде. |
   | **Location** | Да | <*регион_центра_обработки_данных_Azure*> | Регион центра обработки данных Azure, в котором нужно развернуть среду. |
   | **SKU** | Да | **Premium** или **Developer (без соглашения об уровне обслуживания)** | Номер SKU интегрированной среды сценариев для создания и использования. Различия между этими номерами SKU см. в разделе [номера SKU интегрированной среды сценариев](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md#ise-level). |
   | **Дополнительная емкость** | Premium: <br>Да <p><p>Developer: <br>Неприменимо | Premium: <br>от 0 до 10 <p><p>Developer: <br>Неприменимо | Число дополнительных единиц обработки, используемых для этого ресурса ISE. Сведения о добавлении емкости после создания см. в разделе [Добавление емкости интегрированной среды сценариев](#add-capacity). |
   | **Виртуальная сеть** | Да | <*имя_виртуальной_сети_Azure*> | Виртуальная сеть Azure, в которую нужно внедрить среду, чтобы приложения логики в этой среде могли получить доступ к виртуальной сети. Если у вас нет сети, [сначала создайте виртуальную сеть Azure](../virtual-network/quick-create-portal.md). <p>**Важно!** Внедрение среды службы интеграции можно выполнить *только* при ее создании. |
   | **Подсети** | Да | <*subnet-resource-list*> | Интегрированная среда сценариев  требует наличия четырех пустых подсетей для создания и развертывания ресурсов в среде. Для создания каждой подсети [выполните действия, описанные в этой таблице](#create-subnet).  |
   |||||

   <a name="create-subnet"></a>

   **Создание подсети**

   Для создания и развертывания ресурсов в вашей среде интегрированная среда сценариев требует  наличия четырех пустых подсетей, которые не делегируются ни одной службе. 
   Эти адреса подсети *нельзя* изменить после создания среды. Каждая подсеть должна соответствовать следующим критериям:

   * Имеет имя, которое начинается с буквы или символа `<`подчеркивания и не содержит следующие символы:, `>`, `%`, `&`, `\\`, `?`,`/`

   * Использует [Формат CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) и адресное пространство класса B.

   * Использует по крайней `/27` мере в адресном пространстве, так как в каждой подсети должен быть *минимум*32 адресов. Пример:

     * `10.0.0.0/27`имеет 32 адресов, так как 2<sup>(32-27)</sup> — 2<sup>5</sup> или 32.

     * `10.0.0.0/24`имеет 256 адресов, так как 2<sup>(32-24)</sup> — 2<sup>8</sup> или 256.

     * `10.0.0.0/28`имеет только 16 адресов и слишком мал, так как 2<sup>(32-28)</sup> — 2<sup>4</sup> или 16.

     Дополнительные сведения о вычислении адресов см. в разделе [IPv4-блоки CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks).

   * Если вы используете [ExpressRoute](../expressroute/expressroute-introduction.md), не забудьте [создать таблицу маршрутов](../virtual-network/manage-route-table.md) , которая имеет следующий маршрут и свяжет эту таблицу с каждой подсетью, используемой интегрированной средой.

     **Имя**: <*Route-Name* .><br>
     **Префикс адреса**: 0.0.0.0/0<br>
     **Определение следующего прыжка**. Интернет

   1. В списке **Подсети** выберите **Управление конфигурацией подсети**.

      ![Управление конфигурацией подсети](./media/connect-virtual-network-vnet-isolated-environment/manage-subnet.png)

   1. На панели **Подсети** выберите **Подсеть**.

      ![Добавление подсети](./media/connect-virtual-network-vnet-isolated-environment/add-subnet.png)

   1. На панели **Добавить подсеть** введите следующие сведения.

      * **Имя**. Имя для этой подсети.
      * **Диапазон адресов (блок CIDR)** . Диапазон адресов для подсети в виртуальной сети, выраженный в формате CIDR.

      ![Добавление сведений о подсети](./media/connect-virtual-network-vnet-isolated-environment/subnet-details.png)

   1. Когда все будет готово, нажмите кнопку **ОК**.

   1. Повторите эти шаги еще для трех подсетей.

      > [!NOTE]
      > Если подсети, которые вы пытаетесь создать, недействительны, портал Azure отображает сообщение, но не блокирует ход выполнения.

1. После того как Azure успешно проверит данные для среды службы интеграции, щелкните **Создать**, как показано здесь:

   ![После успешной проверки щелкните "Создать"](./media/connect-virtual-network-vnet-isolated-environment/ise-validation-success.png)

   Azure начнет развертывание среды. Выполнение этого процесса *может* занять до двух часов. 
   Чтобы проверить состояние развертывания, на панели инструментов Azure выберите значок уведомлений, который открывает область уведомлений.

   ![Проверка состояния развертывания](./media/connect-virtual-network-vnet-isolated-environment/environment-deployment-status.png)

   Если развертывание будет успешно завершено, в Azure отобразится следующее уведомление:

   ![Развертывание выполнено](./media/connect-virtual-network-vnet-isolated-environment/deployment-success.png)

   В противном случае следуйте инструкциям по портал Azure для устранения неполадок развертывания.

   > [!NOTE]
   > Если развертывание завершается сбоем или вы удаляете интегрированную среду сценариев, то перед освобождением подсетей Azure может пройти до часа. Эта задержка означает, что может потребоваться подождать, прежде чем повторно использовать эти подсети в другой интегрированной среде сценариев. 
   >
   > При удалении виртуальной сети Azure, как правило, занимает до двух часов, прежде чем выпустить подсети, но эта операция может занять больше времени. 
   > При удалении виртуальных сетей убедитесь, что все ресурсы не подключены. См. раздел [Удаление виртуальной сети](../virtual-network/manage-virtual-network.md#delete-a-virtual-network).

1. Если Azure не перейдет автоматически к вашей среде после завершения развертывания, выберите **Перейти к ресурсу**, чтобы просмотреть среду.  

Дополнительные сведения о создании подсетей см. в разделе Добавление подсети [виртуальной сети](../virtual-network/virtual-network-manage-subnet.md).

<a name="create-logic-apps-environment"></a>

## <a name="create-logic-app---ise"></a>Создание приложения логики, использующего среду службы интеграции

Чтобы создать приложения логики, которые выполняются в среде службы интеграции (ISE), [Создайте приложения логики обычным образом](../logic-apps/quickstart-create-first-logic-app-workflow.md) , за исключением случаев, когда вы задаете свойство **Location** , выберите интегрированную среду сценариев в разделе **среды службы интеграции** . Например

  ![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/create-logic-app-with-integration-service-environment.png)

Сведения о том, как работают триггеры и действия и как они помечаются при использовании интегрированной среды сценариев по сравнению с глобальной службой Logic Apps, см. [в разделе «изолированные и глобальные» в обзоре интегрированной среды сценариев](connect-virtual-network-vnet-isolated-environment-overview.md#difference).

<a name="create-integration-account-environment"></a>

## <a name="create-integration-account---ise"></a>Создание учетной записи интеграции для среды службы интеграции

Если вы хотите использовать учетную запись интеграции с приложениями логики в среде службы интеграции (ISE), эта учетная запись интеграции должна использовать ту *же среду* , что и приложения логики. Приложения логики в среде ISE могут ссылаться только на учетные записи интеграции, которые находятся в одной с ними среде ISE. В зависимости от [номера SKU](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md#ise-level) , выбранного при создании, интегрированная среда разработки включает в себя конкретные сведения об использовании учетной записи интеграции без дополнительной оплаты. Чтобы узнать, как цены и данные о выставлении счетов для учетных записей интеграции с Исес, см. [Logic Apps модель ценообразования](../logic-apps/logic-apps-pricing.md#fixed-pricing). Цены см. на странице [цен на Logic Apps](https://azure.microsoft.com/pricing/details/logic-apps/).

Чтобы создать учетную запись интеграции, которая использует интегрированную среду сценариев, [Создайте учетную запись интеграции обычным образом](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md) , за исключением случаев, когда вы задаете свойство **Location** , выберите интегрированную среду сценариев в разделе **среды службы интеграции** , например:

![Выбор среды службы интеграции](./media/connect-virtual-network-vnet-isolated-environment/create-integration-account-with-integration-service-environment.png)

<a name="add-capacity"></a>

## <a name="add-ise-capacity"></a>Добавление емкости интегрированной среды сценариев

Базовая единица "Премиум" ИНТЕГРИРОВАНа с фиксированной емкостью, поэтому, если требуется дополнительная пропускная способность, можно добавить дополнительные единицы масштабирования во время создания или позже. Автоматическое масштабирование можно выполнить на основе метрик производительности или на основе ряда дополнительных единиц обработки. Если выбрать автомасштабирование на основе метрик, можно выбрать один из различных критериев и указать пороговые условия для удовлетворения этих условий. SKU для разработчиков не включают в себя возможность добавления единиц масштабирования.

1. В портал Azure найдите интегрированную среду сценариев.

1. Чтобы просмотреть метрики использования и производительности ИНТЕГРИРОВАНной среды сценариев, в главном меню интегрированной среды сценариев выберите **Обзор**.

   ![Просмотр сведений об использовании интегрированной среды сценариев](./media/connect-virtual-network-vnet-isolated-environment/integration-service-environment-usage.png)

1. Чтобы настроить Автомасштабирование, в разделе **Параметры**выберите **масштабное развертывание**. На вкладке **Настройка** выберите **включить**Автомасштабирование.

   ![Включение автомасштабирования](./media/connect-virtual-network-vnet-isolated-environment/scale-out.png)

1. В качестве **имени параметра автомасштабирования**укажите имя параметра.

1. В разделе **по умолчанию** выберите масштабирование на **основе метрики** или **масштабирование до определенного числа экземпляров**.

   * Если выбрано значение на основе экземпляра, введите число единиц обработки от 0 до 10 включительно.

   * Если выбрано значение на основе метрик, выполните следующие действия.

     1. В разделе **правила** выберите **Добавить правило**.

     1. На панели **правило масштабирования** настройте критерии и действия, которые будут выполняться при срабатывании правила.

     1. Когда все будет готово, нажмите кнопку **Добавить**.

1. Завершив работу с параметрами автомасштабирования, сохраните изменения.

## <a name="next-steps"></a>Следующие шаги

* Узнайте больше о [виртуальной сети Azure](../virtual-network/virtual-networks-overview.md).
* Узнайте об [интеграции виртуальной сети для служб Azure](../virtual-network/virtual-network-for-azure-services.md).
