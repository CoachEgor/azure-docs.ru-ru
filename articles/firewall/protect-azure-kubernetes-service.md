---
title: Защита развертываний службы Azure Kubernetes Service (AKS) с помощью брандмауэра Azure
description: Узнайте, как использовать брандмауэр Azure для защиты развертываний Azure Kubernetes Service (AKS)
author: vhorne
ms.service: firewall
services: firewall
ms.topic: how-to
ms.date: 07/29/2020
ms.author: victorh
ms.openlocfilehash: 602671f1052de2d9446f32946271cea2f9995044
ms.sourcegitcommit: e71da24cc108efc2c194007f976f74dd596ab013
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2020
ms.locfileid: "87412955"
---
# <a name="use-azure-firewall-to-protect-azure-kubernetes-service-aks-deployments"></a>Защита развертываний службы Azure Kubernetes Service (AKS) с помощью брандмауэра Azure

Служба Azure Kubernetes Service (AKS) предлагает управляемый кластер Kubernetes в Azure. Это снижает сложность и эксплуатационные расходы на управление Kubernetes путем разгрузки значительных обязанностей в Azure. AKS обрабатывает критически важные задачи, такие как мониторинг работоспособности и обслуживание, а также обеспечивает безопасный и управляемый кластер корпоративного уровня с упрощенным управлением.

Kubernetes управляет кластерами виртуальных машин и планирует выполнение контейнеров на этих виртуальных машинах на основе доступных ресурсов вычислений и требований к ресурсам каждого контейнера. Контейнеры группируются в модули Pod, базовую операционную единицу для Kubernetes, а они масштабируются в нужное состояние.

Для управления и эксплуатации узлам в кластере AKS нужен доступ к определенным портам и полным доменным именам (FQDN). Это может быть связано с передачей данных на сервер API или скачиванием и установкой базовых компонентов кластера Kubernetes и обновлений для системы безопасности узла. Брандмауэр Azure помогает заблокировать среду и отфильтровать исходящий трафик.

Следуйте указаниям в этой статье, чтобы обеспечить дополнительную защиту кластера Azure Kubernetes с помощью брандмауэра Azure.

## <a name="prerequisites"></a>Предварительные требования

- Развернутый кластер Azure Kubernetes с выполняющимся приложением.

   Дополнительные сведения см. в разделе [учебник. Развертывание кластера Azure Kubernetes Service (AKS)](../aks/tutorial-kubernetes-deploy-cluster.md) и [учебник. Запуск приложений в службе KUBERNETES Azure (AKS)](../aks/tutorial-kubernetes-deploy-application.md).


## <a name="securing-aks"></a>Защита AKS

Брандмауэр Azure предоставляет тег полного доменного имени AKS для упрощения настройки. Чтобы разрешить исходящий трафик платформы AKS, выполните следующие действия.

- При использовании брандмауэра Azure для ограничения исходящего трафика и создания определяемого пользователем маршрута (UDR) для направления всего исходящего трафика убедитесь, что в брандмауэре создано соответствующее правило ДНаТ, чтобы правильно разрешить входящий трафик. 

   Использование брандмауэра Azure с UDR прерывает настройку входящих подключений из-за асимметричной маршрутизации. Эта проблема возникает, если подсеть AKS имеет маршрут по умолчанию, который переходит на частный IP-адрес брандмауэра, но вы используете общедоступную подсистему балансировки нагрузки. Например, входящая или Kubernetes служба типа "балансировщик *".*

   В этом случае входящий трафик подсистемы балансировки нагрузки поступает через общедоступный IP-адрес, а обратный путь проходит через частный IP-адрес брандмауэра. Так как брандмауэр отслеживает состояние и не имеет информации об активных сеансах, он отбрасывает возвращаемые пакеты. Сведения о том, как интегрировать Брандмауэр Azure с подсистемой балансировки нагрузки для входящего трафика или служб, см. в статье [Интеграция Брандмауэра Azure с Azure Load Balancer (цен. категория "Стандартный")](integrate-lb.md).
- Создайте коллекцию правил приложений и добавьте правило, чтобы включить тег полного доменного имени *азурекубернетессервице* . Диапазон исходных IP-адресов — это виртуальная сеть пула узлов, протокол HTTPS, а целевой объект — Азурекубернетессервице.
- Для работы кластера AKS требуются следующие исходящие порты и правила сети.

   - TCP-порт 443
   - TCP [*ипаддрофйоураписервер*]: 443 требуется, если у вас есть приложение, которое должно взаимодействовать с сервером API. Это значение можно изменить после создания кластера.
   - TCP-порт 9000 и UDP-порт 1194 для клиентского модуля туннелирования для взаимодействия с конечным сервером на сервере API.

      Дополнительные сведения см. в разделе **. HCP. <location> . azmk8s.io* и адреса в следующей таблице.
   - UDP-порт 123 для синхронизации времени по протоколу NTP (узлы Linux).
   - UDP-порт 53 для DNS также является обязательным, если ваши pod напрямую обращаются к серверу API.

   Дополнительные сведения см. в статье управление исходящим [трафиком для узлов кластера в службе Kubernetes Azure (AKS)](../aks/limit-egress-traffic.md).
- Настройка тегов Азуремонитор и службы хранилища. Azure Monitor получает данные log Analytics.

   Вы также можете разрешить URL-адрес рабочей области по отдельности: `<worksapceguid>.ods.opinsights.azure.com` и `<worksapceguid>.oms.opinsights.azure.com` . Это можно решить одним из следующих способов.

    - Разрешите доступ по протоколу HTTPS из подсети пула узлов к `*. ods.opinsights.azure.com` , и `*.oms. opinsights.azure.com` . Эти полные доменные имена обеспечивают необходимый доступ, но менее строгие.
    - Используйте следующий запрос log Analytics для вывода точных полных доменных имен, а затем разрешите их явно в правилах приложения брандмауэра.
   ```
   AzureDiagnostics 
   | where Category == "AzureFirewallApplicationRule" 
   | search "Allow" 
   | search "*. ods.opinsights.azure.com" or "*.oms. opinsights.azure.com"
   | parse msg_s with Protocol " request from " SourceIP ":" SourcePort:int " to " FQDN ":" * 
   | project TimeGenerated,Protocol,FQDN 
   ```


## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о службе Azure Kubernetes см. в разделе [Основные понятия Kubernetes Core для службы Kubernetes Azure (AKS)](../aks/concepts-clusters-workloads.md).
