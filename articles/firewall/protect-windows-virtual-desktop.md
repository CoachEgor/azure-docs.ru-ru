---
title: Использование брандмауэра Azure для защиты виртуального рабочего стола Windows
description: Узнайте, как использовать брандмауэр Azure для защиты развертываний виртуальных рабочих столов Windows
author: vhorne
ms.service: firewall
services: firewall
ms.topic: conceptual
ms.date: 04/28/2020
ms.author: victorh
ms.openlocfilehash: c5d7281d50c151722303b48b2b28a597eec72d79
ms.sourcegitcommit: 58faa9fcbd62f3ac37ff0a65ab9357a01051a64f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82254178"
---
# <a name="use-azure-firewall-to-protect-window-virtual-desktop-deployments"></a>Защита развертывания виртуальных рабочих столов в Windows с помощью брандмауэра Azure

Виртуальный рабочий стол Windows (ВВД) — это служба виртуализации для настольных систем и приложений, которая работает в Azure. Когда конечный пользователь подключается к среде виртуальных рабочих столов Windows, его сеанс выполняется пулом узлов. Пул узлов — это коллекция виртуальных машин Azure, которые регистрируются в виртуальном рабочем столе Windows в качестве узлов сеансов. Эти виртуальные машины работают в виртуальной сети и подчиняются элементам управления безопасности виртуальной сети. Им требуется исходящий доступ к Интернету для правильной работы службы ВВД, а также для конечных пользователей требуется исходящий доступ в Интернет. Брандмауэр Azure помогает заблокировать среду и отфильтровать исходящий трафик.

[![Архитектура](media/protect-windows-virtual-desktop/windows-virtual-desktop-architecture-diagram.png) виртуальных рабочих столов Windows](media/protect-windows-virtual-desktop/windows-virtual-desktop-architecture-diagram.png#lightbox)

Следуйте указаниям в этой статье, чтобы обеспечить дополнительную защиту пула узлов ВВД с помощью брандмауэра Azure.

## <a name="prerequisites"></a>Предварительные условия


 - Развернутая среда ВВД и пул узлов.

   Дополнительные сведения см. в разделе [учебник. Создание пула узлов с помощью Azure Marketplace](../virtual-desktop/create-host-pools-azure-marketplace.md) и [Создание пула узлов с шаблоном Azure Resource Manager](../virtual-desktop/create-host-pools-arm-template.md).

Дополнительные сведения о средах ВВД см. в разделе [Среда виртуальных рабочих столов Windows](../virtual-desktop/environment-setup.md).

## <a name="host-pool-outbound-access-to-windows-virtual-desktop"></a>Исходящий доступ пула узлов к виртуальному рабочему столу Windows

Виртуальные машины Azure, созданные для виртуальных рабочих столов Windows, должны иметь доступ к нескольким полным доменным именам (FQDN) для правильной работы. Брандмауэр Azure предоставляет тег полного доменного имени виртуальной среды Windows для упрощения этой настройки. Чтобы разрешить исходящий трафик платформы ВВД, выполните следующие действия.

- Разверните брандмауэр Azure и настройте определенный пользователем маршрут подсети пула узлов ВВД (UDR), чтобы направить весь трафик через брандмауэр Azure. Теперь ваш маршрут по умолчанию указывает на брандмауэр.
- Создайте коллекцию правил приложений и добавьте правило, чтобы включить тег полного доменного имени *виндовсвиртуалдесктоп* . Диапазон исходных IP-адресов — это виртуальная сеть пула узлов, протокол **HTTPS**, а целевой объект — **виндовсвиртуалдесктоп**.

- Набор необходимых учетных записей хранилища и служебной шины для пула узлов ВВД зависит от развертывания, поэтому он еще не захватывается в теге полного доменного имени Виндовсвиртуалдесктоп. Это можно решить одним из следующих способов.

   - Разрешите доступ по протоколу HTTPS из подсети пула узлов в * xt.blob.core.windows.net, * eh.servicebus.windows.net и * xt.table.core.windows.net. Эти полные доменные имена обеспечивают необходимый доступ, но менее строгие.
   - Используйте следующий запрос log Analytics для вывода точных полных доменных имен, а затем разрешите их явно в правилах приложения брандмауэра.
   ```
   AzureDiagnostics
   | where Category == "AzureFirewallApplicationRule"
   | search "Deny"
   | search "gsm*eh.servicebus.windows.net" or "gsm*xt.blob.core.windows.net" or "gsm*xt.table.core.windows.net"
   | parse msg_s with Protocol " request from " SourceIP ":" SourcePort:int " to " FQDN ":" *
   | project TimeGenerated,Protocol,FQDN
   ```

- Создайте коллекцию сетевых правил, добавив следующие правила.

   - Разрешить DNS — разрешить передачу трафика из частного IP-адреса в * для TCP-и UDP-портов 53.
   - Разрешить KMS — разрешить трафик от виртуальных машин ВВД к порту TCP 1688 службы активации Windows. Дополнительные сведения о IP-адресах назначения см. [в статье сбой активации Windows в сценарии принудительного туннелирования](../virtual-machines/troubleshooting/custom-routes-enable-kms-activation.md#solution).

> [!NOTE]
> В некоторых развертываниях могут не требоваться правила DNS, например Azure Active Directory контроллеры домена перенаправлять запросы DNS на Azure DNS по адресу 168.63.129.16.

## <a name="host-pool-outbound-access-to-the-internet"></a>Исходящий доступ к Интернету для пула узлов

В зависимости от потребностей Организации может потребоваться включить безопасный исходящий доступ в Интернет для конечных пользователей. В случаях, когда список разрешенных назначений определен правильно (например, [Office 365 Access](https://docs.microsoft.com/Office365/Enterprise/office-365-ip-web-service)), можно использовать правила приложения и сети брандмауэра Azure для настройки требуемого доступа. Этот параметр направляет трафик конечных пользователей непосредственно в Интернет для лучшей производительности.

Чтобы отфильтровать исходящий Интернет-трафик пользователей с помощью существующего локального безопасного веб-шлюза, можно настроить браузер или другие приложения, работающие в пуле узлов ВВД, с явной конфигурацией прокси-сервера. Например, см. статью [Использование параметров командной строки Microsoft ребра для настройки параметров прокси-сервера](https://docs.microsoft.com/deployedge/edge-learnmore-cmdline-options-proxy-settings). Эти параметры прокси-сервера влияют только на доступ к Интернету для конечных пользователей, что позволяет ВВДной платформе исходящий трафик напрямую через брандмауэр Azure.

## <a name="additional-considerations"></a>Дополнительные сведения

В зависимости от требований может потребоваться настроить дополнительные правила брандмауэра.

- Доступ к NTP-серверу

   По умолчанию виртуальные машины под управлением Windows подключаются к time.windows.com через UDP-порт 123 для синхронизации времени. Создайте Сетевое правило, разрешающее этот доступ, или для сервера времени, который используется в вашей среде.


## <a name="next-steps"></a>Следующие шаги

- Дополнительные сведения о виртуальном рабочем столе Windows: [что такое виртуальный рабочий стол Windows?](../virtual-desktop/overview.md)