---
title: Логика обработки правил Брандмауэра Azure
description: В Брандмауэре Azure есть правила преобразования сетевых адресов (NAT), правила сети и правила приложений. Каждое из них обрабатывается в соответствии с типом.
services: firewall
author: vhorne
ms.service: firewall
ms.topic: article
ms.date: 04/10/2020
ms.author: victorh
ms.openlocfilehash: 93677b3e473ab825665fed5590ac345a8cfcc300
ms.sourcegitcommit: fb23286d4769442631079c7ed5da1ed14afdd5fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/10/2020
ms.locfileid: "81113430"
---
# <a name="azure-firewall-rule-processing-logic"></a>Логика обработки правил Брандмауэра Azure
Правила NAT, сетевые правила и приложения можно настроить в Azure Firewall. Сборы правил обрабатываются в соответствии с типом правил в порядке приоритета, с меньшим числом до более высоких номеров от 100 до 65 000. Имя сбора правил может иметь только буквы, цифры, подчеркнутые, периоды или дефисы. Она должна начинаться с буквы или номера, и в конечном итоге с письмом, номером или подчеркнуть. Максимальная длина имени составляет 80 символов.

Лучше всего изначально пространство ваших номеров приоритета сбора правил в 100 шагом (100, 200, 300, и так далее), так что у вас есть место, чтобы добавить больше коллекций правил, если это необходимо.

> [!NOTE]
> Если включить фильтрацию на основе анализа на основе угроз, эти правила являются наивысшим приоритетом и всегда обрабатываются в первую очередь. Фильтрация информации о угрозах может отказать трафику до обработки любых настроенных правил. Для получения дополнительной [Azure Firewall threat intelligence-based filtering](threat-intel.md)информации см.

## <a name="outbound-connectivity"></a>Исходящие подключения

### <a name="network-rules-and-applications-rules"></a>Правила сети и правила приложений

Если настроить сетевые правила и правила применения, то сетевые правила применяются в приоритетном порядке перед правилами приложения. Затем выполнение правил завершается. Таким образом, если совпадение найдено в сетевом правиле, никакие другие правила не обрабатываются.  Если нет сетевого правила, и если протокол HTTP, HTTPS или MSS'L, то пакет затем оценивается по правилам приложения в порядке приоритета. Если совпадение еще не найдено, пакет оценивается по [сбору правил инфраструктуры.](infrastructure-fqdns.md) Если правило по-прежнему не выполняется, пакет отклоняется по умолчанию.

## <a name="inbound-connectivity"></a>Входная связь

### <a name="nat-rules"></a>Правила преобразования сетевых адресов

Входное подключение к Интернету может быть включено путем настройки адресного перевода сети назначения (DNAT), как описано в [учебном уме: Фильтр входящий трафик с Azure Firewall DNAT с помощью портала Azure.](tutorial-firewall-dnat.md) Правила NAT применяются в приоритетном порядке перед сетевыми правилами. Если совпадение найдено, добавляется неявно соответствующее правило сети, чтобы разрешить преобразованный трафик. Чтобы переопределить эту реакцию, явно добавьте коллекцию правил сети с запрещающими правилами, которые соответствуют преобразованному трафику.

Правила применения не применяются для входящих соединений. Так что если вы хотите фильтровать входящий трафик HTTP/S, следует использовать веб-приложение Firewall (WAF). Для получения дополнительной информации смотрите [Что такое брандмауэр веб-приложений Azure?](../web-application-firewall/overview.md)

## <a name="examples"></a>Примеры

Следующие примеры показывают результаты некоторых из этих комбинаций правил.

### <a name="example-1"></a>Пример 1

Подключение к google.com допускается из-за соответствующего сетевого правила.

**Сетевое правило**

- Действие: "Разрешить".


|name  |Протокол  |Тип исходного значения  |Источник  |Тип назначения  |Адрес назначения  |Конечные порты|
|---------|---------|---------|---------|----------|----------|--------|
|Разрешить-веб     |TCP|IP-адрес|*|IP-адрес|*|80, 443

**Правило применения**

- Действие: Отрицание

|name  |Тип исходного значения  |Источник  |Протокол:Порт|Целевые ФЗН|
|---------|---------|---------|---------|----------|----------|
|Дени-гугл     |IP-адрес|*|http:80,https:443|google.com

**Результат**

Подключение к google.com разрешено, поскольку пакет соответствует правилу сети *Allow-web.* Обработка правил останавливается в этой точке.

### <a name="example-2"></a>Пример 2

Трафик SSH отказано, потому что более высокий приоритет *Отрицание* сбора сетевых правил блокирует его.

**Сбор правил сети 1**

- Название: Разрешить-сбор
- Приоритет: 200.
- Действие: "Разрешить".

|name  |Протокол  |Тип исходного значения  |Источник  |Тип назначения  |Адрес назначения  |Конечные порты|
|---------|---------|---------|---------|----------|----------|--------|
|Разрешить-SSH     |TCP|IP-адрес|*|IP-адрес|*|22

**Коллекция правил сети 2**

- Имя: Deny-коллекция
- Приоритет: 100.
- Действие: Отрицание

|name  |Протокол  |Тип исходного значения  |Источник  |Тип назначения  |Адрес назначения  |Конечные порты|
|---------|---------|---------|---------|----------|----------|--------|
|Дени-СШ     |TCP|IP-адрес|*|IP-адрес|*|22

**Результат**

Соединения SSH отказано, поскольку сбор сетевых правил с более высоким приоритетом блокирует его. Обработка правил останавливается в этой точке.

## <a name="rule-changes"></a>Изменения правил

При изменении правила, чтобы отказать ранее разрешенного трафика, все соответствующие существующие сеансы отменяются.

## <a name="next-steps"></a>Дальнейшие действия

- См. дополнительные сведения о [развертывании и настройке Брандмауэра Azure](tutorial-firewall-deploy-portal.md).