---
title: Kerberos ограничила делегацию для служб доменов Azure AD (ru) Документы Майкрософт
description: Узнайте, как включить ресурсо-ориентированную делегацию Kerberos с ограниченной базой (KCD) в домене Сугче Активных Каталогов.
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.assetid: 938a5fbc-2dd1-4759-bcce-628a6e19ab9d
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: how-to
ms.date: 03/30/2020
ms.author: iainfou
ms.openlocfilehash: 07aa9ade25d1d986833b6da2f3907d07b752b662
ms.sourcegitcommit: 62c5557ff3b2247dafc8bb482256fef58ab41c17
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2020
ms.locfileid: "80655429"
---
# <a name="configure-kerberos-constrained-delegation-kcd-in-azure-active-directory-domain-services"></a>Настройка ограниченной делегации Kerberos (KCD) в службах активных доменов каталогов Azure

При запуске приложений может возникнуть необходимость в доступе к ресурсам в контексте другого пользователя. Active Directory Domain Services (AD DS) поддерживает механизм под названием *Kerberos delegation,* который позволяет использовать этот случай использования. Затем Kerberos *ограничила* делегацию (KCD), которая основывается на этом механизме для определения конкретных ресурсов, к которым можно получить доступ в контексте пользователя. Службы домена Active Directory Domain Services (Azure AD DS) более надежно блокируются, чем традиционные наземные среды AD DS, поэтому используйте более безопасный *ресурсоемкий* KCD.

В этой статье показано, как настроить ресурсо-ориентированную делегацию Kerberos, ограниченную в домене Azure AD DS.

## <a name="prerequisites"></a>Предварительные требования

Для завершения этой статьи необходимы следующие ресурсы:

* Активная подписка Azure.
    * Если у вас нет подписки НаAz, [создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].
* Управляемый домен доменных служб Azure Active Directory, включенный и настроенный в клиенте Azure AD.
    * Если потребуется, [создайте и настройте экземпляр доменных служб Azure Active Directory][create-azure-ad-ds-instance].
* VM управления Windows Server, который соединен с доменом Azure AD DS.
    * При необходимости заполните учебник для [создания Windows Server VM и присоединитесь к управляемому домену,][create-join-windows-vm] а затем [установите инструменты управления AD DS.][tutorial-create-management-vm]
* Учетная запись пользователя, входящая в группу *администраторов Azure AD DC* в клиенте Azure AD.

## <a name="kerberos-constrained-delegation-overview"></a>Kerberos ограничил обзор делегации

Делегация Kerberos позволяет одной учетной записи выдавать себя за другую учетную запись для доступа к ресурсам. Например, веб-приложение, которое получает доступ к бэк-энду веб-компонента может выдавать себя за другую учетную запись пользователя, когда он делает обратное соединение. Делегация Kerberos небезопасна, так как не ограничивает доступ к ресурсам, к которым может получить доступ имитирующая учетная запись.

Делегация Kerberos ограничена (KCD) ограничивает службы или ресурсы, которые указанный сервер или приложение могут подключить при выдаче себя за другое удостоверение личности. Традиционный KCD требует привилегий администратора домена для настройки учетной записи домена для службы, и он ограничивает учетную запись для запуска на одном домене.

Традиционный KCD также имеет несколько вопросов. Например, в более ранних операционных системах администратор службы не имел полезного способа узнать, какие фронтовые службы делегированы службам ресурсов, которыми они владели. Любая фронтовая служба, которая может делегировать ресурсную службу, является потенциальной точкой атаки. Если сервер, размещаемый фронтовой службой, настроенной для делегирования ресурсных служб, скомпрометирован, службы ресурсов также могут быть скомпрометированы.

В домене Azure AD DS, управляемом DS, у вас нет привилегий администратора домена. В результате традиционный KCD на основе учетной записи не может быть настроен в управляемый домен Azure AD DS. Вместо этого можно использовать на основе ресурсов KCD, что также является более безопасным.

### <a name="resource-based-kcd"></a>Ограниченное делегирование Kerberos на основе ресурсов

Windows Server 2012 и позже предоставляет администраторам службы возможность настроить ограниченную делегацию для своих услуг. Такая модель называется ограниченным делегированием Kerberos на основе ресурсов. При таком подходе администратор службы бэк-энда может разрешить или отказать в использовании KCD определенным ими служб.

Ограниченное делегирование Kerberos на основе ресурсов настраивается с помощью PowerShell. Вы используете [cmdlets Set-ADComputer][Set-ADComputer] или [Set-ADUser,][Set-ADUser] в зависимости от того, является ли учетная запись, выдающая себя за компьютер, учетную запись компьютера или учетную запись пользователя/сервис.

## <a name="configure-resource-based-kcd-for-a-computer-account"></a>Настройка ресурсо-ориентированного KCD для компьютерной учетной записи

В этом сценарии предположим, что у вас есть веб-приложение, которое работает на компьютере под названием *contoso-webapp.aaddscontoso.com*. Веб-приложению необходимо получить доступ к веб-aPI, который работает на компьютере, названном *contoso-api.aaddscontoso.com* в контексте пользователей доменов. Выполнить следующие шаги для настройки этого сценария:

1. [Создайте настраиваемое подразделение](create-ou.md). Можно делегировать разрешения на управление этим пользовательским OU пользователям в домене Azure AD DS.
1. [Домен-присоединиться к виртуальным машинам][create-join-windows-vm], как тот, который работает веб-приложение, и тот, который работает веб-API, к Azure AD DS управляемый домен. Создайте эти учетные записи компьютера в пользовательском OU от предыдущего шага.

    > [!NOTE]
    > Учет компьютера для веб-приложения и веб-API должен быть в пользовательском OU, где у вас есть разрешения на настройку на основе ресурсов KCD. Вы не можете настроить ресурсо-налажено KCD для учетной записи компьютера во встроенном контейнере *AAD DC Computers.*

1. Наконец, настроить ресурсо-наосноветельный KCD с помощью [Set-ADComputer][Set-ADComputer] PowerShell cmdlet. Из совместного управления VM, связанного с доменом, и вошел в систему в качестве учетной записи пользователя, являющуюся членом *группы администраторов Azure AD DC,* запустите следующие cmdlets. Предоставьте по мере необходимости собственные имена компьютеров:
    
    ```powershell
    $ImpersonatingAccount = Get-ADComputer -Identity contoso-webapp.aaddscontoso.com
    Set-ADComputer contoso-api.aaddscontoso.com -PrincipalsAllowedToDelegateToAccount $ImpersonatingAccount
    ```

## <a name="configure-resource-based-kcd-for-a-user-account"></a>Настройка на основе ресурсов KCD для учетной записи пользователя

В этом сценарии предположим, что у вас есть веб-приложение, которое работает как учетная запись службы под названием *appsvc.* Веб-приложению необходимо получить доступ к веб-aPI, который работает как учетная запись службы под названием *backendsvc* в контексте пользователей доменов. Выполнить следующие шаги для настройки этого сценария:

1. [Создайте настраиваемое подразделение](create-ou.md). Можно делегировать разрешения на управление этим пользовательским OU пользователям в домене Azure AD DS.
1. [Домен присоединяетесь к виртуальным машинам,][create-join-windows-vm] запускаемым веб-API/ресурсом бэкэнда в управляемый домен Azure AD DS. Создайте учетную запись компьютера в настраиваемом подразделении.
1. Создайте учетную запись службы (например, appsvc), используемую при запуске веб-приложения в настраиваемом подразделении.

    > [!NOTE]
    > Опять же, учетная запись компьютера для веб-API VM, и учетная запись службы для веб-приложения, должны быть в пользовательском OU, где у вас есть разрешения на настройку на основе ресурсов KCD. Вы не можете настроить ресурсо-ориентированные KCD для учетных записей во встроенных *aAD DC Computers* или контейнерах *aAD DC Users.* Это также означает, что вы не можете использовать учетные записи пользователей, синхронизированные с Azure AD, для настройки на основе ресурсов KCD. Необходимо создавать и использовать учетные записи служб, специально созданные в Azure AD DS.

1. Наконец, настроить ресурсо-ориентированный KCD с помощью [cmdlet Set-ADUser][Set-ADUser] PowerShell. Из совместного управления VM, связанного с доменом, и вошел в систему в качестве учетной записи пользователя, являющуюся членом *группы администраторов Azure AD DC,* запустите следующие cmdlets. По мере необходимости предоставьте свои собственные названия услуг:

    ```powershell
    $ImpersonatingAccount = Get-ADUser -Identity appsvc
    Set-ADUser backendsvc -PrincipalsAllowedToDelegateToAccount $ImpersonatingAccount
    ```

## <a name="next-steps"></a>Дальнейшие действия

Подробнее о работе делегации в службах доменов Active Directory можно узнать в службах доменов [Active][kcd-technet]Directory, см.

<!-- INTERNAL LINKS -->
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance]: tutorial-create-instance.md
[create-join-windows-vm]: join-windows-vm.md
[tutorial-create-management-vm]: tutorial-create-management-vm.md
[Set-ADComputer]: /powershell/module/addsadministration/set-adcomputer
[Set-ADUser]: /powershell/module/addsadministration/set-aduser

<!-- EXTERNAL LINKS -->
[kcd-technet]: https://technet.microsoft.com/library/jj553400.aspx
