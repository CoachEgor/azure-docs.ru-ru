---
title: Присоединение виртуальной машины Windows Server к управляемому домену | Документация Майкрософт
description: В этом учебнике вы узнаете, как присоединить виртуальную машину Windows Server к управляемому домену доменных служб Azure Active Directory.
author: iainfoulds
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: tutorial
ms.date: 10/30/2019
ms.author: iainfou
ms.openlocfilehash: 4753cc9a98cd59c0c5d446b3d92280aabfb72c12
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73474692"
---
# <a name="tutorial-join-a-windows-server-virtual-machine-to-a-managed-domain"></a>Руководство по Присоединение виртуальной машины Windows Server к управляемому домену

Доменные службы Azure Active Directory (Azure AD DS) предоставляют управляемые доменные службы, отвечающие за присоединение к домену, применение групповой политики, использование протокола LDAP, выполнение аутентификации Kerberos или NTLM, которые полностью совместимы с Windows Server Active Directory. Управляемый домен Azure AD DS позволяет предоставить функции присоединения к домену и управления для виртуальных машин Azure. В этом руководстве показано, как создать виртуальную машину Windows Server и присоединить ее к управляемому домену Azure AD DS.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * создание виртуальной машины Windows Server;
> * подключение виртуальной машины Windows Server к виртуальной сети Azure;
> * присоединение виртуальной машины к управляемому домену Azure AD DS.

Если у вас еще нет подписки Azure, создайте [учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником требуются следующие ресурсы:

* Активная подписка Azure.
    * Если у вас еще нет подписки Azure, создайте [учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].
* Управляемый домен доменных служб Azure Active Directory, включенный и настроенный в клиенте Azure AD.
    * Если потребуется, [создайте и настройте экземпляр доменных служб Azure Active Directory][create-azure-ad-ds-instance].
* Учетная запись пользователя, входящая в группу *администраторов Azure AD DC* в клиенте Azure AD.
    * Убедитесь, что в Azure AD Connect была выполнена синхронизация хэша паролей или самостоятельный сброс пароля, чтобы учетная запись могла входить в управляемый домен Azure AD DS.

Если у вас уже есть виртуальная машина, которую вы хотите присоединить к домену, перейдите к разделу [о присоединении виртуальной машины к управляемому домену Azure AD DS](#join-the-vm-to-the-azure-ad-ds-managed-domain).

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

В этом руководстве вы создадите виртуальную машину Windows Server и присоедините ее к управляемому домену Azure AD DS с помощью портала Azure. Чтобы начать, войдите на [портал Azure](https://portal.azure.com).

## <a name="create-a-windows-server-virtual-machine"></a>Создание виртуальной машины Windows Server

Чтобы продемонстрировать, как присоединить компьютер к управляемому домену Azure AD DS, мы для начала создадим виртуальную машину Windows Server. Эта виртуальная машина подключается к виртуальной сети Azure, которая обеспечивает подключение к управляемому домену Azure AD DS. Процесс присоединения к управляемому домену Azure AD DS аналогичен присоединению к обычному локальному домену доменных служб Active Directory.

Если у вас уже есть виртуальная машина, которую вы хотите присоединить к домену, перейдите к разделу [о присоединении виртуальной машины к управляемому домену Azure AD DS](#join-the-vm-to-the-azure-ad-ds-managed-domain).

1. На **домашней странице** или в меню портала Azure выберите команду **Создать ресурс**.

1. В разделе **Начало работы** выберите **Windows Server 2016 Datacenter**.

    ![Выбор действия по созданию Windows Server 2016 Datacenter на портале Azure](./media/join-windows-vm/select-vm-image.png)

1. В окне **Основные сведения** настройте основные параметры виртуальной машины. Сохраните значения по умолчанию в полях *Параметры доступности*, *Образ* и *Размер*.

    | Параметр            | Рекомендуемое значение   |
    |----------------------|-------------------|
    | группа ресурсов.       | Выберите или создайте группу ресурсов, например *myResourceGroup*. |
    | Имя виртуальной машины | Введите имя виртуальной машины, например *myVM*. |
    | Регион               | Выберите регион для создания виртуальной машины, например *Восточная часть США.* |
    | Имя пользователя             | Введите имя пользователя для учетной записи локального администратора виртуальной машины, например *azureuser*. |
    | Пароль             | Введите и подтвердите надежный пароль для локального администратора, который будет создан на виртуальной машине. Не вводите учетные данные пользователя домена. |

1. По умолчанию виртуальная машина, создаваемая в Azure, не доступна из Интернета. Такая конфигурация повышает безопасность виртуальной машины и сокращает потенциальную область атаки. На следующем шаге этого учебника вы подключитесь к виртуальной машине по протоколу удаленного рабочего стола (RDP) и присоедините Windows Server к управляемому домену Azure AD DS.

    При включенном протоколе удаленного рабочего стола крайне вероятны атаки с автоматическим входом, что может привести к отключению учетных записей с типичными именами (*admin*, *administrator* и т. п.) после многочисленных неудачных попыток входа. Протокол RDP нужно включать только при необходимости и только для нескольких разрешенных IP-адресов. [JIT-доступ Azure к виртуальным машинам][jit-access], предоставляемый Центром безопасности Azure, позволяет включать кратковременные и ограниченные сеансы RDP. Вы также можете [создать и использовать узел Бастиона Azure (предоставляется в режиме предварительной версии)][azure-bastion], чтобы разрешить доступ только через портал Azure по протоколу SSL.

    В рамках этого учебника вы вручную включите протокол RDP для виртуальной машины.

    В разделе **Общедоступные входящие порты** выберите вариант **Разрешить выбранные порты**. В раскрывающемся меню **Выберите входящие порты** укажите вариант *RDP (3389)* .

1. По завершении нажмите **Далее: Диски**.
1. В раскрывающемся меню **Тип диска ОС** выберите *SSD (цен. категория "Стандартный")* и нажмите кнопку **Далее: сеть**.
1. Виртуальная машина должна подключаться к подсети виртуальной сети Azure, которая может взаимодействовать с подсетью, в которой развернут управляемый домен AD DS Azure. Мы рекомендуем развертывать управляемый домен AD DS Azure в собственной выделенной подсети. Не развертывайте виртуальную машину в той же подсети, что и управляемый домен Azure AD DS.

    Есть два основных способа развернуть виртуальную машину и правильно подключить ее к подсети виртуальной сети.
    
    * Создайте или выберите существующую подсеть в той же виртуальной сети, где развернут управляемый домен Azure AD DS.
    * Выберите подсеть в виртуальной сети Azure, которая подключена к ней через [пиринг виртуальной сети Azure][vnet-peering].
    
    Если вы выберете подсеть виртуальной сети, которая не подключена к подсети с экземпляром Azure AD DS, вы не сможете присоединить виртуальную машину к управляемому домену. В этом учебнике мы создадим новую подсеть в виртуальной сети Azure.

    В области **Параметры** выберите виртуальную сеть, в которой развернут управляемый домен Azure AD DS, например *aaads-vnet*.
1. В этом примере отображается существующая подсеть *aaads-subnet*, к которой подключен управляемый домен Azure AD DS. Не подключайте виртуальную машину к этой подсети. Чтобы создать подсеть для виртуальной машины, выберите **Управление конфигурацией подсети**.

    ![Выбор действия для управления конфигурацией подсети на портале Azure](./media/join-windows-vm/manage-subnet.png)

1. В окне виртуальной сети выберите в меню слева элемент **Адресное пространство**. Виртуальная сеть создается с одним адресным пространством *10.0.1.0/24*, которое используется для создаваемой по умолчанию сети.

    Добавьте еще один диапазон IP-адресов к этой виртуальной сети. Размер этого диапазона адресов и фактические значения IP-адресов следует выбирать с учетом уже развернутых сетевых ресурсов. Этот диапазон IP-адресов не должен перекрываться с существующими диапазонами адресов в Azure или локальной среде. Предоставьте диапазон IP-адресов достаточного размера для размещения всех запланированных виртуальных машин.

    В следующем примере добавляется диапазон IP-адресов *10.0.2.0/24*. Когда все будет готово, щелкните **Сохранить**.

    ![Добавление диапазона IP-адресов к виртуальной сети на портале Azure](./media/tutorial-configure-networking/add-vnet-address-range.png)

1. Теперь в окне виртуальной сети выберите в меню слева элемент **Подсети**, а затем щелкните **+Подсеть**, чтобы добавить подсеть.

1. Выберите **+ Подсеть** и введите имя подсети, например *management*. Укажите **Диапазон адресов (блок CIDR)** , например *10.0.2.0/24*. Этот диапазон IP-адресов не должен перекрываться другими существующими диапазонами адресов Azure или локальных адресов. Для других параметров сохраните значения по умолчанию и щелкните **ОК**.

    ![Создание конфигурации подсети на портале Azure](./media/join-windows-vm/create-subnet.png)

1. Создание виртуальной сети занимает несколько секунд. Когда создание завершится, щелкните *X*, чтобы закрыть окно подсети.
1. Теперь в панели **Сети**, которую вы открыли для создания виртуальной машины, выберите из раскрывающегося меню созданную подсеть, например *management*. Здесь также убедитесь, что выбрана правильная подсеть, и не развертывайте виртуальную машину в той же подсети, что и управляемый домен Azure AD DS.
1. Для других параметров сохраните значения по умолчанию и щелкните **Управление**.
1. Для параметра **Диагностика загрузки** укажите значение *Выкл*. Для других параметров сохраните значения по умолчанию и щелкните **Просмотреть и создать**.
1. Проверьте параметры виртуальной машины и щелкните **Создать**.

Создание виртуальной машины занимает несколько минут. Портал Azure отображает текущее состояние развертывания: Когда виртуальная машина будет готова, выберите **Перейти к ресурсу**.

![Переход к ресурсу виртуальной машины на портале Azure после его успешного создания](./media/join-windows-vm/vm-created.png)

## <a name="connect-to-the-windows-server-vm"></a>Подключение к виртуальной машине Windows Server

Теперь мы подключимся к созданной виртуальной машине Windows Server по протоколу RDP и присоединимся к управляемому домену Azure AD DS. Используйте учетные данные локального администратора, которые вы указали на предыдущем шаге при создании виртуальной машины, но не существующие учетные данные домена.

1. В области **Обзор** выберите **Подключиться**.

    ![Подключение к виртуальной машине Windows на портале Azure](./media/join-windows-vm/connect-to-vm.png)

1. Выберите вариант *Скачать RDP-файл*. Сохраните этот RDP-файл в веб-браузере.
1. Чтобы подключиться к виртуальной машине, откройте скачанный RDP-файл. При появлении запроса выберите **Подключиться**.
1. Введите учетные данные локального администратора, которые вы указали на предыдущем шаге при создании виртуальной машины, например *localhost\azureuser*.
1. Если в процессе входа отобразится предупреждение о сертификате, нажмите **Да** или **Продолжить**, чтобы подключиться.

## <a name="join-the-vm-to-the-azure-ad-ds-managed-domain"></a>Присоединение виртуальной машины к управляемому домену Azure AD DS

После создания виртуальной машины и подключения RDP мы присоединим виртуальную машину Windows Server к управляемому домену Azure AD DS. Процесс будет таким же, как и при присоединении к обычному локальному домену доменных служб Active Directory.

1. Если **диспетчер сервера** не открывается по умолчанию при входе в виртуальную машину, откройте меню **Пуск**, а затем выберите **Диспетчер сервера**.
1. В левой области окна **диспетчера серверов** выберите **Локальный сервер**. В разделе **Свойства** в правой области выберите **Рабочая группа**.

    ![Изменение свойства "Рабочая группа" в диспетчере сервера на виртуальной машине](./media/join-windows-vm/server-manager.png)

1. В окне **Свойства системы** выберите **Изменить**, чтобы подключиться к управляемому домену Azure AD DS.

    ![Выбор действия для изменения свойств рабочей группы или домена](./media/join-windows-vm/change-domain.png)

1. В поле **Домен** укажите имя управляемого домена Azure AD DS, например *contoso.com*, а затем щелкните **ОК**.

    ![Выбор управляемого домена Azure AD DS для присоединения](./media/join-windows-vm/join-domain.png)

1. Введите учетные данные для присоединения к домену. Укажите учетные данные пользователя, входящего в группу *Администраторы Azure AD DC*. Только члены этой группы имеют право присоединять компьютеры к управляемому домену Azure AD DS. Учетная запись должна входить в управляемый домен Azure AD DS или клиент Azure AD — учетные записи из внешних каталогов, связанных с клиентом Azure AD, не смогут пройти проверку подлинности в процессе присоединения к домену. Учетные данные учетной записи можно задать одним из следующих способов.

    * **Формат имени участника-пользователя (рекомендуется):** введите суффикс имени участника-пользователя (UPN), настроенный в Azure AD для учетной записи пользователя. В этом примере суффикс UPN для пользователя *contosoadmin* имеет значение `contosoadmin@contoso.onmicrosoft.com`. Есть несколько распространенных сценариев, позволяющих надежно использовать для входа в домен формат имени участника-пользователя вместо формата *SamAccountName*:
        * Если префикс имени участника-пользователя слишком длинный (например, *joehasareallylongname*), можно создавать имя *SAMAccountName* автоматически.
        * Если в вашем клиенте Azure AD есть несколько пользователей с одинаковым UPN префиксом (например, *dee*), можно создавать имя в формате *SAMAccountName* автоматически.
    * **Формат SAMAccountName:** введите имя учетной записи в формате *SAMAccountName*. Например, для пользователя *contosoadmin* параметр *SAMAccountName* имеет значение `CONTOSO\contosoadmin`.

1. Присоединение к управляемому домену Azure AD DS занимает несколько секунд. Когда этот процесс завершится, появится сообщение с приветствием.

    ![Сообщение с приветствием](./media/join-windows-vm/join-domain-successful.png)

    Чтобы продолжить, нажмите кнопку **ОК** .

1. Чтобы завершить процесс присоединения к управляемому домену Azure AD DS, перезапустите виртуальную машину.

> [!TIP]
> Вы можете присоединить виртуальную машину к домену с помощью PowerShell, используя командлет [Add-Computer][add-computer]. Следующий пример присоединяет виртуальную машину к домену *CONTOSO* и перезапускает ее. Укажите учетные данные пользователя, который входит в группу *Администраторы Azure AD DC*, когда появится соответствующий запрос.
>
> `Add-Computer -DomainName CONTOSO -Restart`
>
> Чтобы присоединить к домену виртуальную машину, не подключаясь к ней и не настраивая подключение вручную, вы также можете воспользоваться командлетом Azure PowerShell под названием [Set-AzVmAdDomainExtension][set-azvmaddomainextension].

После перезапуска виртуальной машины Windows Server на нее отправляются все политики, настроенные в управляемом домене Azure AD DS. Также вы после этого сможете войти на виртуальную машину Windows Server, используя соответствующие учетные данные домена.

## <a name="clean-up-resources"></a>Очистка ресурсов

В следующем учебнике вы используете эту виртуальную машину Windows Server для установки средств управления, которые позволяют администрировать управляемый домен Azure AD DS. Если вы не хотите продолжать работу с этой серией учебников, воспользуйтесь описанными ниже шагами для очистки ресурсов, то есть [отключения RDP](#disable-rdp) и (или) [удаления виртуальной машины](#delete-the-vm). В противном случае перейдите к [следующему учебнику](#next-steps).

### <a name="un-join-the-vm-from-azure-ad-ds-managed-domain"></a>Отсоединение виртуальной машины от управляемого домена Azure AD DS

Чтобы удалить виртуальную машину из управляемого домена Azure AD DS, выполните шаги еще раз, чтобы [присоединить виртуальную машину к домену](#join-the-vm-to-the-azure-ad-ds-managed-domain). Вместо присоединения к управляемому домену Azure AD DS выберите присоединение к рабочей группе, например к *РАБОЧЕЙ ГРУППЕ* по умолчанию. После перезагрузки виртуальной машины объект-компьютер будет удален из управляемого домена Azure AD DS.

Если [удалить виртуальную машину](#delete-the-vm), не отсоединяя ее от домена, потерянный объект-компьютер останется в Azure AD DS.

### <a name="disable-rdp"></a>Отключение RDP

Если вы будете использовать виртуальную машину Windows Server, которую вы создали в этом учебнике, для запуска собственных приложений или рабочих нагрузок, учтите, что в ней был открыт доступ по RDP из Интернета. Чтобы повысить безопасность и снизить риск атаки, следует отключить доступ по протоколу RDP из Интернета. Чтобы отключить доступ из Интернета по RDP для виртуальной машины Windows Server, выполните следующие действия.

1. В меню слева выберите **Группы ресурсов**.
1. Выберите группу ресурсов, например *myResourceGroup*.
1. Выберите виртуальную машину, например *myVM*, а затем щелкните *Сети*.
1. В разделе **Входящие правила безопасности сети** для группы безопасности сети выберите правило, разрешающее RDP, а затем щелкните **Удалить**. Удаление правила безопасности для входящего трафика займет несколько секунд.

### <a name="delete-the-vm"></a>Удаление виртуальной машины

Если вы не намерены использовать эту виртуальную машину Windows Server, удалите ее с помощью следующей процедуры.

1. В меню слева выберите **Группы ресурсов**.
1. Выберите группу ресурсов, например *myResourceGroup*.
1. Выберите виртуальную машину, например *myVM*, а затем щелкните **Удалить**. Выберите **Да**, чтобы подтвердить удаление ресурса. Удаление виртуальной машины занимает несколько минут.
1. После удаления виртуальной машины выберите диск операционной системы, сетевой интерфейс и другие ресурсы с префиксом *myVM-* и удалите их.

## <a name="troubleshoot-domain-join-issues"></a>Устранение неполадок при присоединении к домену

Виртуальная машина Windows Server должна успешно присоединиться к управляемому домену Azure AD DS точно так же, как обычный локальный компьютер к домену доменных служб Active Directory. Если виртуальная машина Windows Server не может присоединиться к управляемому домену Azure AD DS, значит, существуют проблемы с подключением или учетными данными. Изучите следующие разделы по устранению неполадок, чтобы успешно присоединиться к управляемому домену.

### <a name="connectivity-issues"></a>Проблемы, связанные с подключением

Если не отображается приглашение для ввода учетных данных на присоединение к домену, это означает проблему с подключением. Виртуальная машина не может связаться с управляемым доменом Azure AD DS в виртуальной сети.

После каждого из предложенных шагов по устранению неполадок повторяйте попытку присоединить виртуальную машину Windows Server к управляемому домену.

* Убедитесь, что виртуальная машина подключена к виртуальной сети, в которой включены Azure AD DS или для которой настроено пиринговое подключение.
* Выполните проверку связи по DNS-имени управляемого домена, например `ping contoso.com`.
    * Если проверка связи завершается сбоем, повторите попытку для IP-адресов управляемого домена, например `ping 10.0.0.4`. IP-адрес для вашей среды отображается на *странице свойств* при выборе управляемого домена Azure AD DS из списка ресурсов Azure.
    * Если есть связь с IP-адресом, но не с доменом, это может указывать на неправильную настройку DNS. Проверьте, указаны ли IP-адреса домена как DNS-серверы для виртуальной сети.
* Попробуйте очистить кэш сопоставителя DNS на виртуальной машине с помощью команды `ipconfig /flushdns`.

### <a name="credentials-related-issues"></a>Проблемы, связанные с учетными данными

Если появляется запрос на ввод учетных данных для присоединения к домену, но после ввода учетных данных вы получаете сообщение об ошибке, значит, виртуальная машина успешно подключается к управляемому домену Azure AD DS. Но предоставленные вами учетные данные не дают виртуальной машине прав на присоединение к управляемому домену Azure AD DS.

После каждого из предложенных шагов по устранению неполадок повторяйте попытку присоединить виртуальную машину Windows Server к управляемому домену.

* Убедитесь, что используемая учетная запись пользователя входит в группу *Администраторы AAD AD*.
* Убедитесь, что учетная запись входит в состав управляемого домена Azure AD DS или клиента Azure AD. Учетные записи из внешних каталогов, связанных с клиентом Azure AD, не смогут пройти проверку подлинности в процессе присоединения к домену.
* Для указания учетных данных рекомендуется использовать формат имени участника-пользователя, например `contosoadmin@contoso.onmicrosoft.com`. Если в клиенте зарегистрировано много пользователей с одинаковым префиксом имени участника-пользователя или если этот префикс слишком длинный, имя для входа в формате *SAMAccountName* для вашей учетной записи может создаваться автоматически. В таких случаях имя для входа в формате *SAMAccountName* для вашей учетной записи может отличаться от ожидаемого или используемого в локальном домене.
* Обязательно [включите синхронизацию паролей][password-sync] с управляемым доменом. Без этого шага настройки необходимые хэши паролей не будут присутствовать в управляемом домене Azure AD DS, что не позволит выполнить проверку подлинности при попытке входа.
* Дождитесь, пока завершится синхронизация паролей. При изменении пароля учетной записи пользователя автоматическая фоновая синхронизация, выполняемая Azure AD, обновляет пароль в AD DS Azure. Использовать пароль для присоединения к домену можно будет через некоторое время.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Создание виртуальной машины Windows Server
> * подключение виртуальной машины Windows Server к виртуальной сети Azure;
> * Присоединение виртуальной машины к управляемому домену Azure AD DS

Чтобы администрировать управляемый домен Azure AD DS, настройте виртуальную машину управления с помощью Центра администрирования Active Directory (ADAC).

> [!div class="nextstepaction"]
> [Установка средств администрирования на виртуальной машине управления](tutorial-create-management-vm.md)

<!-- INTERNAL LINKS -->
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance]: tutorial-create-instance.md
[vnet-peering]: ../virtual-network/virtual-network-peering-overview.md
[password-sync]: active-directory-ds-getting-started-password-sync.md
[add-computer]: /powershell/module/microsoft.powershell.management/add-computer
[jit-access]: ../security-center/security-center-just-in-time.md
[azure-bastion]: ../bastion/bastion-create-host-portal.md
[set-azvmaddomainextension]: /powershell/module/az.compute/set-azvmaddomainextension
