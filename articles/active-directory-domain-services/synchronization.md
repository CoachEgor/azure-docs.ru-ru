---
title: Как работает синхронизация в доменных службах Azure AD | Документация Майкрософт
description: Узнайте, как работает процесс синхронизации для объектов и учетных данных из клиента Azure AD или локальной среды служб домен Active Directory Services в домен Azure Active Directory, управляемый службами домена.
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.assetid: 57cbf436-fc1d-4bab-b991-7d25b6e987ef
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 08/20/2019
ms.author: iainfou
ms.openlocfilehash: 88a5e5fa1267e834a04c46ed38868cf74acd9bb0
ms.sourcegitcommit: ee61ec9b09c8c87e7dfc72ef47175d934e6019cc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/30/2019
ms.locfileid: "70171931"
---
# <a name="how-objects-and-credentials-are-synchronized-in-an-azure-ad-domain-services-managed-domain"></a>Синхронизация объектов и учетных данных в управляемом домене доменных служб Azure AD

Объекты и учетные данные в управляемом домене доменных служб Azure Active Directory (AD DS) могут быть созданы локально в домене или синхронизированы из клиента Azure Active Directory (AD). При первом развертывании AD DS Azure автоматическая односторонняя синхронизация настраивается и запускается для репликации объектов из Azure AD. Эта односторонняя синхронизация продолжает выполняться в фоновом режиме, чтобы поддерживать управляемый домен Azure AD DS в актуальном состоянии с изменениями из Azure AD.

В гибридной среде объекты и учетные данные из локального домена AD DS можно синхронизировать с Azure AD с помощью Azure AD Connect. После успешной синхронизации этих объектов в Azure AD автоматическая фоновая синхронизация делает эти объекты и учетные данные доступными для приложений, использующих управляемый домен Azure AD DS.

На следующей схеме показано, как работает синхронизация между Azure AD DS, Azure AD и дополнительной локальной AD DSной средой.

![Общие сведения о синхронизации для управляемого домена доменных служб Azure AD](./media/active-directory-domain-services-design-guide/sync-topology.png)

## <a name="synchronization-from-azure-ad-to-azure-ad-ds"></a>Синхронизация из Azure AD в Azure AD DS

Учетные записи пользователей, членства в группах и хэши учетных данных синхронизируются одним способом из Azure AD в Azure AD DS. Этот процесс синхронизации выполняется автоматически. Вам не нужно настраивать и отслеживать этот процесс синхронизации, а также управлять им. Начальная синхронизация может занять несколько часов в течение нескольких дней в зависимости от числа объектов в каталоге Azure AD. После завершения начальной синхронизации изменения, внесенные в Azure AD, такие как изменения паролей или атрибутов, автоматически синхронизируются с AD DS Azure.

Процесс синхронизации является одним способом или однонаправленным. Обратная синхронизация изменений из Azure AD DS обратно в Azure AD не выполняется. Управляемый домен AD DS Azure в основном доступен только для чтения, за исключением пользовательских подразделений, которые можно создать. Вы не можете вносить изменения в атрибуты пользователей, пароли пользователей или членство в группах в управляемом домене Azure AD DS.

## <a name="attribute-synchronization-and-mapping-to-azure-ad-ds"></a>Синхронизация атрибутов и сопоставление с Azure AD DS

В следующей таблице перечислены некоторые общие атрибуты и их синхронизация с Azure AD DS.

| Атрибут в AD DS Azure | Source | Примечания |
|:--- |:--- |:--- |
| Имя субъекта-пользователя | Атрибут *имени участника* -пользователя в клиенте Azure AD | Атрибут UPN из клиента Azure AD синхронизирован как есть в Azure AD DS. Самым надежным способом входа в управляемый домен AD DS Azure является использование имени участника-пользователя. |
| SAMAccountName | Атрибут *mailNickname* пользователя в клиенте Azure AD или автоматически сформированный | Источником атрибута *SamAccountName* является атрибут *mailNickname* в клиенте Azure AD. Если несколько учетных записей пользователей имеют одинаковый атрибут *mailNickname* , то *SamAccountName* создается автоматически. Если длина префикса *mailNickname* или *имени участника* -пользователя превышает 20 символов, *SamAccountName* создается автоматически в соответствии с ограничением в 20 символов для атрибутов *SamAccountName* . |
| пароли; | Пароль пользователя из клиента Azure AD | Устаревшие хэши паролей, необходимые для проверки подлинности NTLM или Kerberos, синхронизируются с клиентом Azure AD. Если клиент Azure AD настроен для гибридной синхронизации с помощью Azure AD Connect, эти хэши паролей помещаются из локальной среды AD DS. |
| Основной идентификатор безопасности (SID) пользователя или группы | Автоматически сформированный | Основной идентификатор безопасности учетных записей пользователей или групп создается автоматически в AD DS Azure. Этот атрибут не соответствует идентификатору безопасности основного пользователя или группы объекта в локальной среде AD DS. Это несоответствие связано с тем, что управляемый домен AD DS Azure имеет другое пространство имен SID, чем локальный домен AD DS. |
| Журнал идентификаторов безопасности для пользователей и групп | Локальный основной идентификатор безопасности пользователя и группы | Атрибут *SIDHistory* для пользователей и групп в Azure AD DS настроен в соответствии с соответствующим идентификатором безопасности основного пользователя или группы в локальной среде AD DS. Эта функция позволяет выполнять перенос локальных приложений в Azure AD DS проще, так как не требуется повторно использовать ресурсы ACL. |

> [!TIP]
> **Войдите в управляемый домен, используя формат имени участника-пользователя** Атрибут *SamAccountName* , например `CONTOSO\driley`, может быть автоматически создан для некоторых учетных записей пользователей в управляемом домене Azure AD DS. Автоматически созданный пользователь *SamAccountName* может отличаться от префикса имени участника-пользователя, поэтому не всегда надежный способ входа в систему. Например, если несколько пользователей имеют одинаковый атрибут *mailNickname* или пользователи имеют более длинные префиксы имени участника-пользователя, *SamAccountName* для этих пользователей может быть создан автоматически. Используйте формат имени участника-пользователя, `driley@contoso.com`например, для надежного входа в управляемый домен Azure AD DS.

### <a name="attribute-mapping-for-user-accounts"></a>Сопоставление атрибутов для учетных записей пользователей

В следующей таблице показано, как определенные атрибуты для пользовательских объектов в Azure AD синхронизируются с соответствующими атрибутами в AD DS Azure.

| Атрибут пользователя в Azure AD | Атрибут пользователя в Azure AD DS |
|:--- |:--- |
| AccountEnabled |userAccountControl (задает или удаляет значение ACCOUNT_DISABLED) |
| city |l |
| country |co |
| department |department |
| displayName |displayName |
| facsimileTelephoneNumber |facsimileTelephoneNumber |
| givenName |givenName |
| jobTitle |title |
| mail |mail |
| mailNickname |msDS-AzureADMailNickname |
| mailNickname |SAMAccountName (иногда может быть автоматически создан) |
| mobile |mobile |
| objectid |msDS-AzureADObjectId |
| onPremiseSecurityIdentifier |sidHistory |
| passwordPolicies |userAccountControl (задает или удаляет значение DONT_EXPIRE_PASSWORD) |
| physicalDeliveryOfficeName |physicalDeliveryOfficeName |
| postalCode |postalCode |
| preferredLanguage |preferredLanguage |
| state |st |
| streetAddress |streetAddress |
| surname |sn |
| TelephoneNumber |TelephoneNumber |
| userPrincipalName |userPrincipalName |

### <a name="attribute-mapping-for-groups"></a>Сопоставление атрибутов для групп

В следующей таблице показано, как определенные атрибуты для групповых объектов в Azure AD синхронизируются с соответствующими атрибутами в AD DS Azure.

| Атрибут Group в Azure AD | Атрибут Group в AD DS Azure |
|:--- |:--- |
| displayName |displayName |
| displayName |SAMAccountName (иногда может быть автоматически создан) |
| mail |mail |
| mailNickname |msDS-AzureADMailNickname |
| objectid |msDS-AzureADObjectId |
| onPremiseSecurityIdentifier |sidHistory |
| securityEnabled |groupType |

## <a name="synchronization-from-on-premises-ad-ds-to-azure-ad-and-azure-ad-ds"></a>Синхронизация из локальной AD DS в Azure AD и Azure AD DS

Azure AD Connect используется для синхронизации учетных записей пользователей, членства в группах и хэшей учетных данных из локальной AD DS среды в Azure AD. Атрибуты учетных записей пользователей, таких как UPN и локальный идентификатор безопасности (SID), синхронизируются. Для входа с использованием доменных служб Azure AD устаревшие хэши паролей, необходимые для проверки подлинности NTLM и Kerberos, также синхронизируются с Azure AD.

При настройке обратной записи изменения из Azure AD синхронизируются с локальной AD DSой средой. Например, если пользователь изменяет пароль с помощью функции самостоятельного управления паролями Azure AD, пароль обновляется в локальной среде AD DS.

> [!NOTE]
> Всегда используйте последнюю версию Azure AD Connect. В этом случае у вас точно будут исправления для всех известных ошибок.

### <a name="synchronization-from-a-multi-forest-on-premises-environment"></a>Синхронизация из локальной среды с несколькими лесами

Многие организации имеют довольно сложную локальную среду AD DS, включающую несколько лесов. Azure AD Connect поддерживает синхронизацию пользователей, групп и хэшей учетных данных из сред с несколькими лесами в Azure AD.

Azure AD имеет гораздо более простое и неструктурированное пространство имен. Чтобы предоставить пользователям надежный доступ к приложениям, защищенным с помощью Azure AD, устраните конфликты имен участников-пользователей между учетными записями пользователей в разных лесах. Управляемые домены Azure AD DS используют плоскую структуру подразделений, аналогичную Azure AD. Все учетные записи пользователей и группы хранятся в контейнере *AADDC Users* , несмотря на синхронизацию из разных локальных доменов или лесов, даже если иерархическая структура подразделений настроена локально. Управляемый домен Azure AD DS выполняет сведение всех иерархических структур подразделений.

Как уже было описано выше, синхронизация из Azure AD DS обратно в Azure AD не выполняется. Вы можете [создать пользовательское подразделение (OU)](create-ou.md) в Azure AD DS а затем — пользователей, группы или учетные записи служб в этих пользовательских подразделениях. Ни один из объектов, созданных в пользовательских подразделениях, не синхронизирован обратно в Azure AD. Эти объекты доступны только в управляемом домене Azure AD DS и не отображаются с помощью командлетов Azure AD PowerShell, Azure AD API Graph или пользовательского интерфейса управления Azure AD.

## <a name="what-isnt-synchronized-to-azure-ad-ds"></a>Что не синхронизировано с Azure AD DS

Следующие объекты или атрибуты не синхронизируются с Azure AD или с AD DS Azure:

* **Исключенные атрибуты**. Вы можете исключить определенные атрибуты из синхронизации с Azure AD из локальной AD DS среды с помощью Azure AD Connect. Эти исключенные атрибуты в Azure AD DS недоступны.
* **Групповые политики**. Групповые политики, настроенные в локальной среде AD DS, не синхронизируются с Azure AD DS.
* **Папка SYSVOL:** Содержимое папки *SYSVOL* в локальной среде AD DS не синхронизируется с Azure AD DS.
* **Объекты-компьютеры**. Объекты-компьютеры для компьютеров, присоединенных к локальной среде AD DS, не синхронизируются с Azure AD DS. Эти компьютеры не имеют отношения доверия с управляемым доменом Azure AD DS и принадлежат только локальной среде AD DS. В AD DS Azure отображаются только объекты компьютеров, присоединенные к управляемому домену, которые явно присоединены к домену.
* **Атрибуты SidHistory для пользователей и групп**. Идентификаторы безопасности основного пользователя и основной группы из локальной AD DS среды синхронизируются с AD DS Azure. Однако существующие атрибуты *SIDHistory* для пользователей и групп не синхронизируются из локальной AD DS среды в Azure AD DS.
* **Структуры подразделений**. Подразделения, определенные в локальной среде AD DS, не синхронизируются с AD DS Azure. В Azure AD DS два встроенных подразделения — один для пользователей и один для компьютеров. Управляемый домен Azure AD DS имеет плоскую структуру подразделений. Вы можете [создать пользовательское подразделение в управляемом домене](create-ou.md).

## <a name="password-hash-synchronization-and-security-considerations"></a>Вопросы по синхронизации и безопасности хэша паролей

При включении AD DS Azure необходимо использовать устаревшие хэши паролей для проверки подлинности NTLM + Kerberos. Azure AD не хранит пароли в виде открытого текста, поэтому эти хэши не могут автоматически создаваться для существующих учетных записей пользователей. После создания и сохранения хэшей паролей, совместимых с NTLM и Kerberos, всегда хранятся в Azure AD в зашифрованном виде. Ключи шифрования уникальны для каждого клиента Azure AD. Эти хэши шифруются так, что только AD DS Azure имеет доступ к ключам дешифрования. Другие службы или компоненты в Azure AD не имеют доступа к этим ключам. Затем старые хэши паролей синхронизируются из Azure AD в контроллеры домена для управляемого домена Azure AD DS. Диски для этих управляемых контроллеров домена в Azure AD DS шифруются неактивных данных. Эти хэши паролей хранятся и защищаются на этих контроллерах домена аналогично хранению и защите паролей в локальной среде AD DS.

Для облачных сред Azure AD [Пользователи должны сбросить или изменить свой пароль](tutorial-create-instance.md#enable-user-accounts-for-azure-ad-ds) , чтобы создать и сохранить в Azure AD необходимые хэши паролей. Для любой облачной учетной записи пользователя в Azure AD хэши паролей сохраняются и создаются в совместимых форматах NTLM и Kerberos после включения доменных служб Azure AD. Эти новые учетные записи не требуют сброса или изменения пароля для создания устаревших хэшей паролей.

Для гибридных учетных записей пользователей, синхронизированных из локальной среды AD DS с помощью Azure AD Connect, необходимо [настроить Azure AD Connect для синхронизации хэшей паролей в форматах, совместимых с NTLM и Kerberos](tutorial-configure-password-hash-sync.md).

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения об особенностях синхронизации паролей см. в статье [как работает синхронизация хэшей паролей с Azure AD Connect](../active-directory/hybrid/how-to-connect-password-hash-synchronization.md?context=/azure/active-directory-domain-services/context/azure-ad-ds-context).

Чтобы начать работу с Azure AD DS, [создайте управляемый домен](tutorial-create-instance.md).
