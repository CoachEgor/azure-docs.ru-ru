---
title: Как работает синхронизация в службах домена Azure AD Документы Майкрософт
description: Узнайте, как работает процесс синхронизации для объектов и учетных данных от арендатора Azure AD или на месте среды доменных служб Active Directory Domain Services до домена Azure Active Directory Domain Domain.
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.assetid: 57cbf436-fc1d-4bab-b991-7d25b6e987ef
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 02/10/2020
ms.author: iainfou
ms.openlocfilehash: 38ed48df4d681543cc30daccf46b98635d973b89
ms.sourcegitcommit: d791f8f3261f7019220dd4c2dbd3e9b5a5f0ceaf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2020
ms.locfileid: "81639916"
---
# <a name="how-objects-and-credentials-are-synchronized-in-an-azure-ad-domain-services-managed-domain"></a>Как синхронизируются объекты и учетные данные в домене домена Azure AD, управляемый

Объекты и учетные данные в домене Active Directory Domain Services (AD DS) могут быть созданы локально в домене или синхронизированы с арендатором Azure Active Directory (Azure AD). При первом развертывании Azure AD DS настраивается автоматическая односторонней синхронизации и начинается репликация объектов из Azure AD. Эта одностороннее синхронизация продолжает работать в фоновом режиме, чтобы поддерживать домен управления Azure AD DS в актуальном состоянии с любыми изменениями из Azure AD. Синхронизация не происходит от Azure AD DS обратно в Azure AD.

В гибридной среде объекты и учетные данные из предварительного домена AD DS могут быть синхронизированы с Azure AD с помощью Azure AD Connect. После успешной синхронизации этих объектов с Azure AD автоматическая синхронизация фона делает эти объекты и учетные данные доступными для приложений, использующих доступный домен Azure AD DS.

Следующая диаграмма иллюстрирует, как синхронизация работает между Azure AD DS, Azure AD и дополнительной предварительной средой AD DS:

![Обзор синхронизации для домена Azure AD Domain](./media/active-directory-domain-services-design-guide/sync-topology.png)

## <a name="synchronization-from-azure-ad-to-azure-ad-ds"></a>Синхронизация от Azure AD к Azure AD DS

Учетные записи пользователей, членство в группах и хэши учетных данных синхронизируются в одну сторону от Azure AD до Azure AD DS. Этот процесс синхронизации выполняется автоматически. Вам не нужно настраивать, контролировать или управлять этим процессом синхронизации. Первоначальная синхронизация может занять от нескольких часов до нескольких дней, в зависимости от количества объектов в каталоге Azure AD. После завершения первоначальной синхронизации изменения, внесенные в Azure AD, такие как изменения пароля или атрибута, автоматически синхронизируются с Azure AD DS.

Когда пользователь создан в Azure AD, он не синхронизируется с DS Azure AD до тех пор, пока не изменит свой пароль в Azure AD. При смене пароля хэши паролей автоматически создаются и сохраняются в Azure AD для аутентификации Kerberos и NTLM. Хэши паролей необходимы для успешной аутентификации пользователя в Azure AD DS.

Процесс синхронизации является одним из способов / однонаправленный дизайн. Обратной синхронизации изменений от Azure AD DD до Azure AD не происходит обратной синхронизации. Управляемый домен Azure AD DS в основном читается только за исключением пользовательских oUs, которые можно создавать. Нельзя вносить изменения в атрибуты пользователя, пароли пользователей или членство в группе в домене Azure AD DS.

## <a name="attribute-synchronization-and-mapping-to-azure-ad-ds"></a>Синхронизация атрибутов и отображение с Azure AD DS

В следующей таблице перечислены некоторые общие атрибуты и способ их синхронизации с DS Azure AD.

| Атрибут в Azure AD DS | Источник | Примечания |
|:--- |:--- |:--- |
| Имя участника-пользователя (UPN) | Атрибут *UPN* пользователя в агонии Azure AD | Атрибут UPN от арендатора Azure AD синхронизирован как с Azure AD DS. Самый надежный способ войти в управляемый домен Azure AD DS — это использование UPN. |
| SAMAccountName | Атрибут *почтового сообщения* пользователя в ad-налечке Azure AD или в автогенерированном | Атрибут *SAMAccountName* получен из атрибута *mailNickname* в арендаторе Azure AD. Если несколько учетных записей пользователей имеют один и тот же атрибут *mailNickname,* *SAMAccountName* является автоматическигенерированным. Если приставка *mailNickname* или *UPN* пользователя длиннее 20 символов, *SAMAccountName* автоматически генерируется для удовлетворения 20 символов в атрибутах *SAMAccountName.* |
| паролей | Пароль пользователя от арендатора Azure AD | Устаревшие хэши паролей, необходимые для проверки подлинности NTLM или Kerberos, синхронизируются с арендатором Azure AD. Если арендатор Azure AD настроен для гибридной синхронизации с помощью Azure AD Connect, эти хэши паролей получены из предварительной среды AD DS. |
| Основной идентификатор безопасности (SID) пользователя или группы | Автогенерируемый | Основной SID для учетных записей пользователей/групп является автогенерируемым в Azure AD DS. Этот атрибут не соответствует основному пользователю/группе SID объекта в предварительной среде AD DS. Это несоответствие объясняется тем, что управляемый домен Azure AD DS имеет другое пространство имен SID, чем в домене AD DS. |
| Журнал идентификаторов безопасности для пользователей и групп | Локальный основной идентификатор безопасности пользователя и группы | Атрибут *SidHistory* для пользователей и групп в Azure AD DS соответствует соответствующему основному пользователю или группе SID в предварительной среде AD DS. Эта функция помогает упростить переключение приложений на Azure AD DS, так как вам не нужно переносить ресурсы ACL. |

> [!TIP]
> **Войти на управляемый домен с помощью формата UPN** Атрибут *SAMAccountName,* `AADDSCONTOSO\driley`например, может быть автоматически генерирован для некоторых учетных записей пользователей в домене Azure AD DS. Автоматически генерируемый *пользователями SAMAccountName* может отличаться от префикса UPN, поэтому не всегда это надежный способ войти в систему.
>
> Например, если у нескольких пользователей один и тот же атрибут *mailNickname* или у пользователей слишком длинные префиксы UPN, *SAMAccountName* для этих пользователей может быть автоматически генерируемым. Используйте формат UPN, `driley@aaddscontoso.com`например, чтобы надежно войти в домен Azure AD DS.

### <a name="attribute-mapping-for-user-accounts"></a>Сопоставление атрибутов для учетных записей пользователей

В следующей таблице показано, как конкретные атрибуты для пользовательских объектов в Azure AD синхронизируются с соответствующими атрибутами в Azure AD DS.

| Атрибут пользователя в Azure AD | Атрибут пользователя в Azure AD DS |
|:--- |:--- |
| AccountEnabled |userAccountControl (задает или удаляет значение ACCOUNT_DISABLED) |
| city |l |
| country |co |
| department |department |
| displayName |displayName |
| facsimileTelephoneNumber |facsimileTelephoneNumber |
| givenName |givenName |
| jobTitle |title |
| mail |mail |
| mailNickname |msDS-AzureADMailNickname |
| mailNickname |SAMAccountName (иногда может быть аутогенерирован) |
| mobile |mobile |
| objectid |msDS-AzureADObjectId |
| onPremiseSecurityIdentifier |sidHistory |
| passwordPolicies |userAccountControl (задает или удаляет значение DONT_EXPIRE_PASSWORD) |
| physicalDeliveryOfficeName |physicalDeliveryOfficeName |
| postalCode |postalCode |
| preferredLanguage |preferredLanguage |
| state |st |
| streetAddress |streetAddress |
| surname |sn |
| TelephoneNumber |TelephoneNumber |
| userPrincipalName |userPrincipalName |

### <a name="attribute-mapping-for-groups"></a>Сопоставление атрибутов для групп

В следующей таблице показано, как конкретные атрибуты для групповых объектов в Azure AD синхронизируются с соответствующими атрибутами в Azure AD DS.

| Атрибут группы в Azure AD | Атрибут группы в Azure AD DS |
|:--- |:--- |
| displayName |displayName |
| displayName |SAMAccountName (иногда может быть аутогенерирован) |
| mail |mail |
| mailNickname |msDS-AzureADMailNickname |
| objectid |msDS-AzureADObjectId |
| onPremiseSecurityIdentifier |sidHistory |
| securityEnabled |groupType |

## <a name="synchronization-from-on-premises-ad-ds-to-azure-ad-and-azure-ad-ds"></a>Синхронизация от предприимчезных AD DS к Azure AD и Azure AD DS

Azure AD Connect используется для синхронизации учетных записей пользователей, членства в группах и хэшов учетных данных от предварительной среды AD DS до Azure AD. Атрибуты учетных записей пользователей, таких как UPN и идентификатор безопасности (SID), синхронизированы. Для вху в систему с помощью Azure AD DS устареваемые хэши паролей, необходимые для проверки подлинности NTLM и Kerberos, также синхронизированы с Azure AD.

> [!IMPORTANT]
> Azure AD Connect следует устанавливать и настраивать только для синхронизации с локальными средами AD DS. Установка Azure AD Connect в управляемом домене Azure AD DS для синхронизации объектов обратно в Azure AD не поддерживается.

При настройке возврата записи изменения из Azure AD синхронизируются с предварительной средой AD DS. Например, если пользователь меняет свой пароль с помощью управления паролем самообслуживания Azure AD, пароль обновляется обратно в среде AD DS.

> [!NOTE]
> Всегда используйте последнюю версию Azure AD Connect. В этом случае у вас точно будут исправления для всех известных ошибок.

### <a name="synchronization-from-a-multi-forest-on-premises-environment"></a>Синхронизация из локальной среды с несколькими лесами

Многие организации имеют довольно сложную среду AD DS, которая включает в себя несколько лесов. Azure AD Connect поддерживает синхронизацию пользователей, групп и хэшов учетных данных из мультилесных сред в Azure AD.

Azure AD имеет гораздо более простое и плоское пространство имен. Чтобы предоставить пользователям надежный доступ к приложениям, защищенным с помощью Azure AD, устраните конфликты имен участников-пользователей между учетными записями пользователей в разных лесах. Управляемые домены Azure AD DS используют плоскую структуру OU, похожую на Azure AD. Все учетные записи и группы пользователей хранятся в контейнере *AADDC Users,* несмотря на синхронизацию с разных локальной области или лесов, даже если вы настроили иерархическую структуру OU в помещениях. Управляемый доменом Azure AD DS сглаживает любые иерархические структуры OU.

Как сообщалось ранее, синхронизация от Azure AD DS обратно в Azure AD отсутствует. Можно [создать пользовательскую организационную группу (OU)](create-ou.md) в Azure AD DS, а затем учетных записей пользователей, групп или служб в этих пользовательских OUs. Ни один из объектов, созданных в пользовательских OUs, не синхронизирован обратно в Azure AD. Эти объекты доступны только в домене Azure AD DS и не видны с помощью cmdlets Azure AD PowerShell, Microsoft Graph API или с помощью uI управления Azure AD.

## <a name="what-isnt-synchronized-to-azure-ad-ds"></a>Что не синхронизировано с Azure AD DS

Следующие объекты или атрибуты не синхронизируются с предварительной средой AD DS с Azure AD или Azure AD DS:

* **Исключенные атрибуты:** Можно исключить некоторые атрибуты из синхронизации с Azure AD из предварительной среды AD DS с помощью Azure AD Connect. Эти исключенные атрибуты не доступны в Azure AD DS.
* **Политики группы:** Политики группы, настроенные в среде AD DS, не синхронизированы с Azure AD DS.
* **Папка Sysvol:** Содержимое папки *Sysvol* в предварительной среде AD DS не синхронизировано с Azure AD DS.
* **Компьютерные объекты:** Компьютерные объекты для компьютеров, объединенные в среду AD DS, не синхронизированы с Azure AD DS. Эти компьютеры не имеют доверительных отношений с доменом Azure AD DS и принадлежат только к предварительной среде AD DS. В Azure AD DS отображаются только компьютерные объекты для компьютеров, которые явно присоединились к управляемому домену.
* **Атрибуты SidHistory для пользователей и групп:** Основные sID-разбитомы группы из предварительной среды AD DS синхронизированы с Azure AD DS. Однако существующие атрибуты *SidHistory* для пользователей и групп не синхронизированы с предварительной средой AD DS на Azure AD DS.
* **Структуры подразделений организации (OU):** Организационные подразделения, определяемые в предварительной среде AD DS, не синхронизируются с Azure AD DS. В Azure AD DS есть два встроенных oUs - один для пользователей и один для компьютеров. Управляемый домен Azure AD DS имеет плоскую структуру OU. Вы можете [создать пользовательский OU в управляемом домене.](create-ou.md)

## <a name="password-hash-synchronization-and-security-considerations"></a>Вопросы по синхронизации и безопасности хэша паролей

При включании Azure AD DS требуются устаревшие хэши паролей для проверки подлинности NTLM и Kerberos. Azure AD не хранит пароли с четким текстом, поэтому эти хэши не могут быть автоматически сгенерированы для существующих учетных записей пользователей. После того, как они генерируются и хранятся, хэши совместимых с NTLM и Kerberos паролей всегда хранятся в зашифрованном виде в Azure AD.

Ключи шифрования уникальны для каждого арендатора Azure AD. Эти хэши зашифрованы таким образом, что только Azure AD DS имеет доступ к ключам расшифровки. Другие службы или компоненты в Azure AD не имеют доступа к этим ключам.

Затем хэши устаревших паролей синхронизируются с Azure AD в контроллеры домена для домена Azure AD DS. Диски для этих управляемых контроллеров доменов в Azure AD DS шифруются в состоянии покоя. Эти хэши паролей хранятся и защищены на этих контроллерах домена, подобно тому, как пароли хранятся и защищены в локальной среде AD DS.

Для сред Azure AD только для облака [пользователи должны сбросить/изменить пароль,](tutorial-create-instance.md#enable-user-accounts-for-azure-ad-ds) чтобы необходимые хэши паролей были сгенерированы и сохранены в Azure AD. Для любой облачной учетной записи пользователя в Azure AD хэши паролей сохраняются и создаются в совместимых форматах NTLM и Kerberos после включения доменных служб Azure AD. Все учетные записи пользователей облака должны изменить свой пароль, прежде чем они будут синхронизированы с Azure AD DS.

Для гибридных учетных записей пользователей, синхронизированных с предварительной средой AD DS с помощью Azure AD Connect, необходимо [настроить Azure AD Connect для синхронизации хэшей паролей в форматах, совместимых с NTLM и Kerberos.](tutorial-configure-password-hash-sync.md)

## <a name="next-steps"></a>Дальнейшие действия

Для получения дополнительной информации о специфике синхронизации паролей [см.](../active-directory/hybrid/how-to-connect-password-hash-synchronization.md?context=/azure/active-directory-domain-services/context/azure-ad-ds-context)

Чтобы начать работу с Azure AD DS, [создайте управляемый домен.](tutorial-create-instance.md)
