---
title: Синхронизация с заданной областью для доменных служб Azure AD | Документация Майкрософт
description: Узнайте, как настроить синхронизацию с заданной областью из Azure AD в управляемый домен доменных служб Azure Active Directory.
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.assetid: 9389cf0f-0036-4b17-95da-80838edd2225
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: how-to
ms.date: 03/31/2020
ms.author: iainfou
ms.openlocfilehash: 097c894594987e92038beeaf4b17a3e67538fdad
ms.sourcegitcommit: 3d79f737ff34708b48dd2ae45100e2516af9ed78
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2020
ms.locfileid: "87046055"
---
# <a name="configure-scoped-synchronization-from-azure-ad-to-azure-active-directory-domain-services"></a>Настройка синхронизации с заданной областью из Azure AD в Azure Active Directory доменных служб

Чтобы предоставить службы проверки подлинности, Azure Active Directory доменные службы (Azure AD DS) синхронизирует пользователей и группы из Azure AD. В гибридной среде пользователи и группы из локальной среды домен Active Directory служб (AD DS) можно сначала синхронизировать с Azure AD с помощью Azure AD Connect, а затем синхронизировать с Azure AD DS.

По умолчанию все пользователи и группы из каталога Azure AD синхронизируются с управляемым доменом AD DS Azure. При наличии конкретных потребностей можно выбрать синхронизацию только определенного набора пользователей.

В этой статье показано, как создать управляемый домен, использующий синхронизацию с заданной областью, а затем изменить или отключить набор пользователей с областью действия.

## <a name="scoped-synchronization-overview"></a>Общие сведения о синхронизации с заданной областью

По умолчанию все пользователи и группы из каталога Azure AD синхронизируются с управляемым доменом. Если доступ к управляемому домену требуется только некоторым пользователям, можно синхронизировать только эти учетные записи пользователей. Эта синхронизация с областью действия основана на группе. При настройке синхронизации с областью действия на уровне группы только учетные записи пользователей, принадлежащие к указанным вами группам, синхронизируются с управляемым доменом.

В следующей таблице показано, как использовать синхронизацию с заданной областью.

| Текущее состояние | Требуемое состояние | Необходимая настройка |
| --- | --- | --- |
| Существующий управляемый домен настроен для синхронизации всех учетных записей и групп пользователей. | Необходимо синхронизировать только учетные записи пользователей, принадлежащие к конкретным группам. | Вы не можете изменить синхронизацию всех пользователей для использования синхронизации с заданной областью. [Удалите существующий управляемый домен](delete-aadds.md), а затем выполните действия, описанные в этой статье, чтобы повторно создать управляемый домен с настроенной синхронизацией с заданной областью. |
| Нет существующего управляемого домена. | Вы хотите создать управляемый домен и синхронизировать учетные записи только тех пользователей, которые принадлежат к определенным группам. | Выполните действия, описанные в этой статье, чтобы создать управляемый домен с настроенной синхронизацией с заданной областью. |
| Существующий управляемый домен настраивается для синхронизации только учетных записей, принадлежащих к конкретным группам. | Необходимо изменить список групп, пользователи которых должны синхронизироваться с управляемым доменом. | Выполните действия, описанные в этой статье, чтобы изменить синхронизацию с заданной областью. |

Для настройки параметров синхронизации с областью действия используется портал Azure или PowerShell:

| Действие | Используйте<br>портал Azure; | Используйте<br>PowerShell |
| ------ | ------------------- | ----------------- |
| Создание управляемого домена и Настройка синхронизации с заданной областью | [Портал Azure](#enable-scoped-synchronization-using-the-azure-portal) | [PowerShell](#enable-scoped-synchronization-using-powershell) |
| Изменение синхронизации с заданной областью | [Портал Azure](#modify-scoped-synchronization-using-the-azure-portal) | [PowerShell](#modify-scoped-synchronization-using-powershell) |
| Отключить синхронизацию с заданной областью | [Портал Azure](#disable-scoped-synchronization-using-the-azure-portal) | [PowerShell](#disable-scoped-synchronization-using-powershell) |

> [!WARNING]
> Изменение области синхронизации приводит к повторной синхронизации всех данных управляемым доменом. Действительны следующие условия.
> 
>  * При изменении области синхронизации для управляемого домена происходит полная повторная синхронизация.
>  * Объекты, которые больше не требуются в управляемом домене, удаляются. В управляемом домене создаются новые объекты.
>  * Повторная синхронизация может занять длительное время. Время синхронизации зависит от числа объектов, таких как пользователи, группы и членство в группах в управляемом домене и каталоге Azure AD. В больших каталогах с сотнями тысяч объектов повторная синхронизация может занять несколько дней.

## <a name="enable-scoped-synchronization-using-the-azure-portal"></a>Включение синхронизации с заданной областью с помощью портал Azure

Чтобы включить синхронизацию с заданной областью в портал Azure, выполните следующие действия.

1. Следуйте указаниям [учебника, чтобы создать и настроить управляемый домен](tutorial-create-instance-advanced.md). Выполните все необходимые условия и шаги развертывания, кроме области синхронизации.
1. Выберите **область действия** на шаге синхронизации, а затем выберите группы Azure AD для синхронизации с управляемым доменом.

Для завершения развертывания управляемый домен может занять до часа. На портале Azure на странице **Обзор** для управляемого домена на этом этапе развертывания отображаются сведения о текущем состоянии.

Когда на портале Azure отобразятся сведения о том, что подготовка управляемого домена к работе завершена, выполните следующие задачи.

* Обновите параметры DNS для виртуальной сети, чтобы виртуальные машины могли найти управляемый домен для присоединения к нему или для аутентификации.
    * Чтобы настроить DNS, выберите на портале управляемый домен. В окне **Обзор** отобразится запрос на автоматическую настройку этих параметров DNS.
* [Включите синхронизацию паролей с доменными службами Azure AD](tutorial-create-instance-advanced.md#enable-user-accounts-for-azure-ad-ds), чтобы пользователи могли входить в управляемый домен с помощью рабочих учетных данных.

## <a name="modify-scoped-synchronization-using-the-azure-portal"></a>Измените синхронизацию с областью с помощью портал Azure

Чтобы изменить список групп, пользователей которых нужно синхронизировать с управляемым доменом, выполните следующие действия.

1. В портал Azure найдите и выберите **доменные службы Azure AD**. Выберите нужный управляемый домен, например *aaddscontoso.com*
1. Выберите **Синхронизация** в меню в левой части.
1. Чтобы добавить группу, в верхней части щелкните **+ выбрать группы** , а затем выберите группы для добавления.
1. Чтобы удалить группу из области синхронизации, выберите ее из списка синхронизированных групп и нажмите кнопку **удалить группы**.
1. После внесения всех изменений выберите **Сохранить область синхронизации**.

Изменение области синхронизации приводит к повторной синхронизации всех данных управляемым доменом. Объекты, которые больше не требуются в управляемом домене, удаляются, и повторная синхронизация может занять длительное время.

## <a name="disable-scoped-synchronization-using-the-azure-portal"></a>Отключение синхронизации с заданной областью с помощью портал Azure

Чтобы отключить синхронизацию с областью действия на уровне группы для управляемого домена, выполните следующие действия.

1. В портал Azure найдите и выберите **доменные службы Azure AD**. Выберите нужный управляемый домен, например *aaddscontoso.com*
1. Выберите **Синхронизация** в меню в левой части.
1. Задайте **для области синхронизации значение** **все**, а затем выберите **Сохранить область синхронизации**.

Изменение области синхронизации приводит к повторной синхронизации всех данных управляемым доменом. Объекты, которые больше не требуются в управляемом домене, удаляются, и повторная синхронизация может занять длительное время.

## <a name="powershell-script-for-scoped-synchronization"></a>Скрипт PowerShell для синхронизации с заданной областью

Чтобы настроить синхронизацию с заданной областью с помощью PowerShell, сначала сохраните следующий скрипт в файл с именем `Select-GroupsToSync.ps1` . Этот сценарий настраивает AD DS Azure для синхронизации выбранных групп из Azure AD. Все учетные записи пользователей, которые являются частью указанных групп, синхронизируются с управляемым доменом.

Этот сценарий используется в дополнительных шагах в этой статье.

```powershell
param (
    [Parameter(Position = 0)]
    [String[]]$groupsToAdd
)

Connect-AzureAD
$sp = Get-AzureADServicePrincipal -Filter "AppId eq '2565bd9d-da50-47d4-8b85-4c97f669dc36'"
$role = $sp.AppRoles | where-object -FilterScript {$_.DisplayName -eq "User"}

Write-Output "`n****************************************************************************"

Write-Output "Total group-assignments need to be added: $($groupsToAdd.Count)"
$newGroupIds = New-Object 'System.Collections.Generic.HashSet[string]'
foreach ($groupName in $groupsToAdd)
{
    try
    {
        $group = Get-AzureADGroup -Filter "DisplayName eq '$groupName'"
        $newGroupIds.Add($group.ObjectId)

        Write-Output "Group-Name: $groupName, Id: $($group.ObjectId)"
    }
    catch
    {
        Write-Error "Failed to find group: $groupName. Exception: $($_.Exception)."
    }
}

Write-Output "****************************************************************************`n"
Write-Output "`n****************************************************************************"

$currentAssignments = Get-AzureADServiceAppRoleAssignment -ObjectId $sp.ObjectId
Write-Output "Total current group-assignments: $($currentAssignments.Count), SP-ObjectId: $($sp.ObjectId)"

$currAssignedObjectIds = New-Object 'System.Collections.Generic.HashSet[string]'
foreach ($assignment in $currentAssignments)
{
    Write-Output "Assignment-ObjectId: $($assignment.PrincipalId)"

    if ($newGroupIds.Contains($assignment.PrincipalId) -eq $false)
    {
        Write-Output "This assignment is not needed anymore. Removing it! Assignment-ObjectId: $($assignment.PrincipalId)"
        Remove-AzureADServiceAppRoleAssignment -ObjectId $sp.ObjectId -AppRoleAssignmentId $assignment.ObjectId
    }
    else
    {
        $currAssignedObjectIds.Add($assignment.PrincipalId)
    }
}

Write-Output "****************************************************************************`n"
Write-Output "`n****************************************************************************"

foreach ($id in $newGroupIds)
{
    try
    {
        if ($currAssignedObjectIds.Contains($id) -eq $false)
        {
            Write-Output "Adding new group-assignment. Role-Id: $($role.Id), Group-Object-Id: $id, ResourceId: $($sp.ObjectId)"
            New-AzureADGroupAppRoleAssignment -Id $role.Id -ObjectId $id -PrincipalId $id -ResourceId $sp.ObjectId
        }
        else
        {
            Write-Output "Group-ObjectId: $id is already assigned."
        }
    }
    catch
    {
        Write-Error "Exception occurred assigning Object-ID: $id. Exception: $($_.Exception)."
    }
}

Write-Output "****************************************************************************`n"
```

## <a name="enable-scoped-synchronization-using-powershell"></a>Включение синхронизации с заданной областью с помощью PowerShell

Используйте PowerShell для выполнения следующего набора действий. Чтобы включить доменные службы Azure Active Directory с помощью PowerShell, [обратитесь к инструкциям](powershell-create-instance.md). Несколько шагов в этой статье немного изменены для настройки синхронизации определенных учетных записей.

1. Выполните следующие задачи из статьи, чтобы включить AD DS Azure с помощью PowerShell. Чтобы на самом деле создать управляемый домен, завершите работу на шаге. Вы настраиваете синхронизацию с областью действия, которая создает управляемый домен.

   * [Установите необходимые модули PowerShell](powershell-create-instance.md#prerequisites).
   * [Создайте требуемый субъект-службу и группу Azure AD для административного доступа](powershell-create-instance.md#create-required-azure-ad-resources).
   * [Создавайте вспомогательные ресурсы Azure, такие как виртуальная сеть и подсети](powershell-create-instance.md#create-supporting-azure-resources).

1. Определите группы и пользователей, которые они содержат, которые вы хотите синхронизировать из Azure AD. Создайте список отображаемых имен групп для синхронизации с AD DS Azure.

1. Запустите [скрипт из предыдущего раздела](#powershell-script-for-scoped-synchronization) и используйте параметр *-граупстоадд* , чтобы передать список групп для синхронизации.

   > [!WARNING]
   > Группу *администраторов контроллера домена AAD* необходимо включить в список групп для синхронизации с заданной областью. Если эта группа не включена, управляемый домен будет непригоден для использования.

   ```powershell
   .\Select-GroupsToSync.ps1 -groupsToAdd @("AAD DC Administrators", "GroupName1", "GroupName2")
   ```

1. Теперь создайте управляемый домен и включите синхронизацию с областью на основе группы. Включите *"филтередсинк" = "Enabled"* в параметр *-Properties* .

    Задайте идентификатор подписки Azure, а затем укажите имя управляемого домена, например *aaddscontoso.com*. Вы можете получить идентификатор подписки с помощью командлета [Get-AzSubscription][Get-AzSubscription]. Задайте для имени группы ресурсов, имени виртуальной сети и региона значения, которые использовались на предыдущих шагах для создания вспомогательных ресурсов Azure.

   ```powershell
   $AzureSubscriptionId = "YOUR_AZURE_SUBSCRIPTION_ID"
   $ManagedDomainName = "aaddscontoso.com"
   $ResourceGroupName = "myResourceGroup"
   $VnetName = "myVnet"
   $AzureLocation = "westus"

   # Enable Azure AD Domain Services for the directory.
   New-AzResource -ResourceId "/subscriptions/$AzureSubscriptionId/resourceGroups/$ResourceGroupName/providers/Microsoft.AAD/DomainServices/$ManagedDomainName" `
   -Location $AzureLocation `
   -Properties @{"DomainName"=$ManagedDomainName; "filteredSync" = "Enabled"; `
    "SubnetId"="/subscriptions/$AzureSubscriptionId/resourceGroups/$ResourceGroupName/providers/Microsoft.Network/virtualNetworks/$VnetName/subnets/DomainServices"} `
   -Force -Verbose
   ```

Создание ресурса и возврат управления в командную строку PowerShell занимает несколько минут. Подготовка к работе управляемого домена продолжается в фоновом режиме. На завершение развертывания может понадобиться до часа. На портале Azure на странице **Обзор** для управляемого домена на этом этапе развертывания отображаются сведения о текущем состоянии.

Когда на портале Azure отобразятся сведения о том, что подготовка управляемого домена к работе завершена, выполните следующие задачи.

* Обновите параметры DNS для виртуальной сети, чтобы виртуальные машины могли найти управляемый домен для присоединения к нему или для аутентификации.
    * Чтобы настроить DNS, выберите на портале управляемый домен. В окне **Обзор** отобразится запрос на автоматическую настройку этих параметров DNS.
* Если вы создали управляемый домен в регионе, который поддерживает зоны доступности, создайте группу безопасности сети. Это позволит ограничить трафик в виртуальной сети для управляемого домена. Будет создана стандартная подсистема балансировки нагрузки Azure, для работы которой должны действовать эти правила. Эта группа безопасности сети защищает Azure AD DS и требуется для правильной работы управляемого домена.
    * Чтобы создать группу безопасности сети и необходимые правила, выберите на портале управляемый домен. В окне **Обзор** отобразится запрос на автоматическое создание и настройку группы безопасности сети.
* [Включите синхронизацию паролей с доменными службами Azure AD](tutorial-create-instance-advanced.md#enable-user-accounts-for-azure-ad-ds), чтобы пользователи могли входить в управляемый домен с рабочими учетными данными.

## <a name="modify-scoped-synchronization-using-powershell"></a>Изменение ограниченной синхронизации с помощью PowerShell

Чтобы изменить список групп, пользователей которых нужно синхронизировать с управляемым доменом, повторно запустите [сценарий PowerShell](#powershell-script-for-scoped-synchronization) и укажите новый список групп. В следующем примере группы для синхронизации больше не включают *GroupName2*и теперь включают *GroupName3*.

> [!WARNING]
> Группу *администраторов контроллера домена AAD* необходимо включить в список групп для синхронизации с заданной областью. Если эта группа не включена, управляемый домен будет непригоден для использования.

```powershell
.\Select-GroupsToSync.ps1 -groupsToAdd @("AAD DC Administrators", "GroupName1", "GroupName3")
```

Изменение области синхронизации приводит к повторной синхронизации всех данных управляемым доменом. Объекты, которые больше не требуются в управляемом домене, удаляются, и повторная синхронизация может занять длительное время.

## <a name="disable-scoped-synchronization-using-powershell"></a>Отключение синхронизации с заданной областью с помощью PowerShell

Чтобы отключить синхронизацию с областью действия группы для управляемого домена, установите *"филтередсинк" = "Disabled"* в ресурсе Azure AD DS, а затем обновите управляемый домен. По завершении настройки для всех пользователей и групп будет настроена синхронизация из Azure AD.

```powershell
// Retrieve the Azure AD DS resource.
$DomainServicesResource = Get-AzResource -ResourceType "Microsoft.AAD/DomainServices"

// Disable group-based scoped synchronization.
$disableScopedSync = @{"filteredSync" = "Disabled"}

// Update the Azure AD DS resource
Set-AzResource -Id $DomainServicesResource.ResourceId -Properties $disableScopedSync
```

Изменение области синхронизации приводит к повторной синхронизации всех данных управляемым доменом. Объекты, которые больше не требуются в управляемом домене, удаляются, и повторная синхронизация может занять длительное время.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о процессе синхронизации см. в разделе [Общие сведения о синхронизации в доменных службах Azure AD](synchronization.md).

<!-- EXTERNAL LINKS -->
[Get-AzSubscription]: /powershell/module/Az.Accounts/Get-AzSubscription
