---
title: Руководство. Создание доверия лесов в доменных службах Azure AD | Документация Майкрософт
description: Узнайте, как создать односторонний исходящий лес для локального AD DS домена в портал Azure доменных служб Azure AD.
services: active-directory-ds
author: iainfoulds
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 11/19/2019
ms.author: iainfou
ms.openlocfilehash: f861303b7f3bc8d37caf6da0eaf2f4cef4b36ee5
ms.sourcegitcommit: d6b68b907e5158b451239e4c09bb55eccb5fef89
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74233601"
---
# <a name="tutorial-create-an-outbound-forest-trust-to-an-on-premises-domain-in-azure-active-directory-domain-services-preview"></a>Руководство. Создание исходящего доверия лесов для локального домена в доменных службах Azure Active Directory (Предварительная версия)

В средах, где нельзя синхронизировать хэши паролей, или пользователи, которые используют только смарт-карты для входа в систему, могут использовать лес ресурсов в Azure Active Directory доменных службах (AD DS). Лес ресурсов использует одностороннее исходящее доверие от Azure AD DS к одной или нескольким локальным AD DSым средам. Это отношение доверия позволяет пользователям, приложениям и компьютерам проходить проверку подлинности в локальном домене из управляемого домена Azure AD DS. В настоящее время доступны предварительные версии лесов ресурсов Azure AD DS.

![Схема доверия лесов из AD DS Azure к локальной AD DS](./media/concepts-resource-forest/resource-forest-trust-relationship.png)

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Настройка DNS в локальной среде AD DS для поддержки подключения AD DS Azure
> * Создание одностороннего входящего доверия лесов в локальной среде AD DS
> * Создание одностороннего исходящего доверия леса в Azure AD DS
> * Проверка и проверка отношений доверия для проверки подлинности и доступа к ресурсам

Если у вас еще нет подписки Azure, создайте [учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>предварительным требованиям

Для работы с этим учебником требуются следующие ресурсы и разрешения:

* Активная подписка Azure.
    * Если у вас еще нет подписки Azure, создайте [учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].
* Управляемый домен доменных служб Azure Active Directory, созданный с помощью леса ресурсов и настроенный в клиенте Azure AD.
    * Если потребуется, [создайте и настройте экземпляр доменных служб Azure Active Directory][create-azure-ad-ds-instance-advanced].

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

В этом руководстве вы создадите и настроите исходящее доверие лесов из Azure AD DS с помощью портал Azure. Чтобы начать работу, войдите на [портал Azure](https://portal.azure.com).

## <a name="networking-considerations"></a>Рекомендации по работе с сетями

Для виртуальной сети, в которой размещается лес ресурсов Azure AD DS, требуется сетевое подключение к локальной Active Directory. Приложениям и службам также требуется сетевое подключение к виртуальной сети, в которой размещается лес ресурсов Azure AD DS. Сетевое подключение к лесу ресурсов Azure AD DS должно быть всегда включено и стабильны. в противном случае пользователи могут не пройти проверку подлинности или получить доступ к ресурсам.

Перед настройкой доверия лесов в Azure AD DS убедитесь, что сеть между Azure и локальной средой соответствует следующим требованиям.

* Используйте частные IP-адреса. Не полагайтесь на DHCP с использованием динамического назначения IP-адресов.
* Избегайте перекрытия пространств IP-адресов, чтобы разрешить пиринг виртуальных сетей и маршрутизацию для успешной связи между Azure и локальной средой.
* Виртуальной сети Azure требуется подсеть шлюза для настройки подключения VPN типа "сеть — сеть" (S2S) или ExpressRoute.
* Создайте подсети с достаточным количеством IP-адресов для поддержки вашего сценария.
* Убедитесь, что AD DS Azure имеет собственную подсеть, не предоставляйте эту подсеть виртуальной сети виртуальным машинам и службам приложений.
* Одноранговые виртуальные сети не являются транзитивными.
    * Пиринг виртуальных сетей Azure должен быть создан между всеми виртуальными сетями, которые должны использовать доверие лесов ресурсов Azure AD DS в локальной среде AD DS.
* Обеспечение непрерывного сетевого подключения к локальному Active Directory лесу. Не используйте подключения по требованию.
* Убедитесь в наличии непрерывного разрешения имен (DNS) между именем леса ресурсов Azure AD DS и локальным Active Directory именем леса.

## <a name="configure-dns-in-the-on-premises-domain"></a>Настройка DNS в локальном домене

Чтобы правильно разрешить управляемый домен AD DS Azure из локальной среды, может потребоваться добавить серверы пересылки на существующие DNS-сервера. Если локальная среда не настроена для взаимодействия с управляемым доменом AD DS Azure, выполните следующие действия на рабочей станции управления для локального домена AD DS.

1. Выберите **Пуск | Администрирование | DNS-сервер**
1. Щелкните правой кнопкой мыши DNS-сервер, например *myAD01*, выберите пункт **свойства** .
1. Выберите **серверы пересылки**, а затем нажмите кнопку **изменить** , чтобы добавить дополнительные серверы пересылки.
1. Добавьте IP-адреса управляемого домена AD DS Azure, например *10.0.1.4* и *10.0.1.5*.

## <a name="create-inbound-forest-trust-in-the-on-premises-domain"></a>Создание входящего доверия лесов в локальном домене

Локальному домену AD DS требуется входящее доверие лесов для управляемого домена AD DS Azure. Это отношение доверия должно быть создано вручную в локальном домене AD DS, его нельзя создать из портал Azure.

Чтобы настроить входящее доверие в локальном домене AD DS, выполните следующие действия на рабочей станции управления для локального домена AD DS.

1. Выберите **Пуск | Администрирование | Домены и отношения доверия Active Directory**
1. Щелкните правой кнопкой мыши домен, например *onprem.contoso.com*, выберите пункт **свойства** .
1. Выберите вкладку **доверия** , затем **новое отношение доверия** .
1. Введите имя в доменном имени Azure AD DS, например *aadds.contoso.com*, а затем нажмите кнопку **Далее** .
1. Выберите этот параметр, чтобы создать **отношение доверия с лесом**, а затем создайте **один из способов: входящее** доверие.
1. Выберите, чтобы создать отношение доверия **только для этого домена**. На следующем шаге вы создадите доверие в портал Azure для управляемого домена AD DS Azure.
1. Выберите использование **проверки подлинности на уровне леса**, а затем введите и подтвердите пароль доверия. Этот же пароль также можно указать в портал Azure в следующем разделе.
1. Выполните действия в следующих нескольких окнах с параметрами по умолчанию, а затем выберите параметр **нет, не подтверждайте исходящее доверие**.
1. Нажмите кнопку **Готово**.

## <a name="create-outbound-forest-trust-in-azure-ad-ds"></a>Создание исходящего доверия лесов в Azure AD DS

Если локальный домен AD DS настроен для разрешения управляемого домена AD DS Azure и создания отношения доверия входящего леса, теперь создано исходящее доверие лесов. Это отношение доверия между исходящим лесом завершает отношения доверия между локальным доменом AD DS и управляемым доменом AD DS Azure.

Чтобы создать исходящее доверие для управляемого домена Azure AD DS в портал Azure, выполните следующие действия.

1. В портал Azure найдите и выберите **доменные службы Azure AD**, а затем выберите управляемый домен, например *aadds.contoso.com* .
1. В меню в левой части управляемого домена AD DS Azure выберите **отношения доверия**, а затем выберите **+ Добавить** доверие.
1. Введите отображаемое имя, идентифицирующее доверие, а затем локальное DNS-имя доверенного леса, например *onprem.contoso.com* .
1. Укажите тот же пароль доверия, который использовался при настройке входящего доверия лесов для локального AD DS домена в предыдущем разделе.
1. Укажите по меньшей мере два DNS-сервера для локального домена AD DS, например *10.0.2.4* и *10.0.2.5* .
1. При готовности **сохранить** доверие к исходящему лесу

    [Создание исходящего доверия лесов в портал Azure](./media/create-forest-trust/portal-create-outbound-trust.png)

## <a name="validate-resource-authentication"></a>Проверка проверки подлинности ресурса

Следующие распространенные сценарии позволяют проверить, что доверие леса правильно проверяет подлинность пользователей и доступ к ресурсам.

* [Проверка подлинности локального пользователя из леса ресурсов Azure AD DS](#on-premises-user-authentication-from-the-azure-ad-ds-resource-forest)
* [Доступ к ресурсам в лесу ресурсов Azure AD DS с помощью локального пользователя](#access-resources-in-the-azure-ad-ds-resource-forest-using-on-premises-user)
    * [Включить общий доступ к файлам и принтерам](#enable-file-and-printer-sharing)
    * [Создание группы безопасности и добавление участников](#create-a-security-group-and-add-members)
    * [Создание общей папки для доступа между лесами](#create-a-file-share-for-cross-forest-access)
    * [Проверка проверки подлинности между лесами для ресурса](#validate-cross-forest-authentication-to-a-resource)

### <a name="on-premises-user-authentication-from-the-azure-ad-ds-resource-forest"></a>Проверка подлинности локального пользователя из леса ресурсов Azure AD DS

У вас должна быть виртуальная машина Windows Server, присоединенная к домену ресурсов Azure AD DS. Используйте эту виртуальную машину для тестирования проверки подлинности локального пользователя на виртуальной машине.

1. Подключитесь к виртуальной машине Windows Server, присоединенной к лесу ресурсов Azure AD DS, используя удаленный рабочий стол и учетные данные администратора Azure AD DS. Если вы получаете ошибку проверка подлинности на уровне сети (NLA), проверьте, что используемая учетная запись пользователя не является учетной записью пользователя домена.

    > [!NOTE]
    > Для безопасного подключения к виртуальным машинам, присоединенным к доменным службам Azure AD, можно использовать [службу узла Azure бастиона](https://docs.microsoft.com/azure/bastion/bastion-overview) в поддерживаемых регионах Azure.

1. Откройте командную строку и используйте команду `whoami`, чтобы отобразить различающееся имя пользователя, прошедшего проверку подлинности:

    ```console
    whoami /fqdn
    ```

1. Используйте команду `runas` для проверки подлинности в качестве пользователя из локального домена. В следующей команде замените `userUpn@trusteddomain.com` именем участника-пользователя из доверенного локального домена. Команда запрашивает пароль пользователя:

    ```console
    Runas /u:userUpn@trusteddomain.com cmd.exe
    ```

1. Если проверка подлинности выполнена успешно, откроется новая Командная строка. Заголовок новой командной строки содержит `running as userUpn@trusteddomain.com`.
1. Используйте `whoami /fqdn` в новой командной строке, чтобы просмотреть различающееся имя пользователя, прошедшего проверку подлинности, из локальной Active Directory.

### <a name="access-resources-in-the-azure-ad-ds-resource-forest-using-on-premises-user"></a>Доступ к ресурсам в лесу ресурсов Azure AD DS с помощью локального пользователя

Используя виртуальную машину Windows Server, присоединенную к лесу ресурсов Azure AD DS, можно протестировать сценарий, в котором пользователи могут получить доступ к ресурсам, размещенным в лесу ресурсов, при проверке подлинности с компьютеров в локальном домене с пользователями из локального домена. В следующих примерах показано, как создавать и тестировать различные распространенные сценарии.

#### <a name="enable-file-and-printer-sharing"></a>Включить общий доступ к файлам и принтерам

1. Подключитесь к виртуальной машине Windows Server, присоединенной к лесу ресурсов Azure AD DS, используя удаленный рабочий стол и учетные данные администратора Azure AD DS. Если вы получаете ошибку проверка подлинности на уровне сети (NLA), проверьте, что используемая учетная запись пользователя не является учетной записью пользователя домена.

    > [!NOTE]
    > Для безопасного подключения к виртуальным машинам, присоединенным к доменным службам Azure AD, можно использовать [службу узла Azure бастиона](https://docs.microsoft.com/azure/bastion/bastion-overview) в поддерживаемых регионах Azure.

1. Откройте **Параметры Windows**, а затем найдите и выберите **центр управления сетями и общим доступом**.
1. Выберите параметр **изменить дополнительные параметры общего доступа** .
1. В разделе **профиль домена**выберите **включить общий доступ к файлам и принтерам** , а затем **Сохраните изменения**.
1. Закройте **центр управления сетями и общим доступом**.

#### <a name="create-a-security-group-and-add-members"></a>Создание группы безопасности и добавление участников

1. Откройте оснастку **Пользователи и компьютеры Active Directory**.
1. Щелкните правой кнопкой мыши имя домена, выберите **создать**, а затем выберите **подразделение**.
1. В поле Имя введите *локалобжектс*, а затем нажмите кнопку **ОК**.
1. Выберите и щелкните правой кнопкой мыши **локалобжектс** в области навигации. Выберите **создать** , а затем — **Группа**.
1. В поле **имя группы** введите *филесерверакцесс* . В **области групп**выберите **домен локальный**, а затем нажмите кнопку **ОК**.
1. В области содержимого дважды щелкните **филесерверакцесс**. Выберите **элементы**, щелкните **Добавить**, а затем выберите **расположения**.
1. Выберите локальную Active Directory в представлении **Расположение** , а затем нажмите кнопку **ОК**.
1. Введите *домен пользователи* в поле **Введите имена объектов для выбора** . Выберите **Проверить имена**, укажите учетные данные для локального Active Directory, а затем нажмите кнопку **ОК**.

    > [!NOTE]
    > Необходимо указать учетные данные, так как отношение доверия является только одним способом. Это означает, что пользователи из AD DS Azure не могут получить доступ к ресурсам или искать пользователей или группы в доверенном (локальном) домене.

1. Группа " **Пользователи домена** " из локальной Active Directory должна быть членом группы **филесерверакцесс** . Нажмите кнопку **ОК** , чтобы сохранить группу и закрыть окно.

#### <a name="create-a-file-share-for-cross-forest-access"></a>Создание общей папки для доступа между лесами

1. На виртуальной машине Windows Server, присоединенной к лесу ресурсов Azure AD DS, создайте папку и укажите имя, например *кроссфорестшаре*.
1. Выберите папку правой кнопкой мыши и выберите пункт **Свойства**.
1. Перейдите на вкладку **Безопасность** и нажмите кнопку **изменить**.
1. В диалоговом окне *разрешения для кроссфорестшаре* выберите **Добавить**.
1. Введите *филесерверакцесс* в **поле Введите имена объектов для выбора**, а затем нажмите кнопку **ОК**.
1. Выберите *филесерверакцесс* в списке **группы или имена пользователей** . В списке **разрешения для филесерверакцесс** выберите *Разрешить* для разрешений **изменение** и **запись** , а затем нажмите кнопку **ОК**.
1. Перейдите на вкладку **общий доступ** , а затем выберите **Расширенный общий доступ...**
1. Выберите **общий доступ к этой папке**, а затем введите запоминающее имя общей папки в **имени общего ресурса** , например *кроссфорестшаре*.
1. Выберите **разрешения**. В списке **разрешения для всех пользователей** выберите **Разрешить** для разрешения **изменение** .
1. Нажмите кнопку **ОК** два раза, а затем **закройте**.

#### <a name="validate-cross-forest-authentication-to-a-resource"></a>Проверка проверки подлинности между лесами для ресурса

1. Войдите в компьютер Windows, присоединенный к локальному Active Directory используя учетную запись пользователя из локальной Active Directory.
1. С помощью **проводника Windows**подключитесь к созданной общей папке, используя полное имя узла и общую папку, например `\\fs1.aadds.contoso.com\CrossforestShare`.
1. Чтобы проверить разрешение на запись, щелкните правой кнопкой мыши в папке, выберите **создать**, а затем выберите **текстовый документ**. Используйте имя по умолчанию **новый текстовый документ**.

    Если разрешения на запись заданы правильно, создается новый текстовый документ. Следующие шаги открывают, изменяют и удаляют файл соответствующим образом.
1. Чтобы проверить разрешение чтение, откройте **новый текстовый документ**.
1. Чтобы проверить разрешение на изменение, добавьте текст в файл и закройте **Блокнот**. При появлении запроса на сохранение изменений нажмите кнопку **сохранить**.
1. Чтобы проверить разрешение DELETE, щелкните правой кнопкой мыши **новый текстовый документ** и выберите команду **Удалить**. Нажмите кнопку **Да** , чтобы подтвердить удаление файла.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Настройка DNS в локальной среде AD DS для поддержки подключения AD DS Azure
> * Создание одностороннего входящего доверия лесов в локальной среде AD DS
> * Создание одностороннего исходящего доверия леса в Azure AD DS
> * Проверка и проверка отношений доверия для проверки подлинности и доступа к ресурсам

Дополнительные сведения о типах лесов в Azure AD DS см. в статье [что такое леса ресурсов?][concepts-forest] и [как работают отношения доверия лесов в Azure AD DS?][concepts-trust]

<!-- INTERNAL LINKS -->
[concepts-forest]: concepts-resource-forest.md
[concepts-trust]: concepts-forest-trust.md
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance-advanced]: tutorial-create-instance-advanced.md