---
title: Отработка отказа и исправление — кэш Azure для Redis | Документация Майкрософт
description: Сведения об отработке отказа, установке исправлений и процессе обновления кэша Azure для Redis.
services: cache
author: asasine
ms.assetid: 928b9b9c-d64f-4252-884f-af7ba8309af6
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache
ms.topic: conceptual
ms.date: 10/18/2019
ms.author: adsasine
ms.openlocfilehash: 305511efe86d2b241ef5014d9c3f0501cfd3fbdc
ms.sourcegitcommit: 9a4296c56beca63430fcc8f92e453b2ab068cc62
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/20/2019
ms.locfileid: "72675906"
---
# <a name="failover-and-patching-for-azure-cache-for-redis"></a>Отработка отказа и исправление для кэша Azure для Redis

Понимание того, что происходит отработка отказа в контексте службы кэша Azure для Redis, крайне важно для создания устойчивых и успешных клиентских приложений. Распространенная причина отработки отказа кэша заключается в том, что в службе управления устанавливается Исправление двоичных файлов Redis. В этой статье описывается, что такое отработка отказа, как они возникают во время установки исправлений, а также описывается создание отказоустойчивого клиентского приложения.

## <a name="what-is-a-failover"></a>Что такое отработка отказа?

### <a name="a-quick-summary-of-our-architecture"></a>Краткий обзор нашей архитектуры

Кэш состоит из нескольких виртуальных машин с отдельными частными IP-адресами. Каждая виртуальная машина, также известная как узел, подключается к общей подсистеме балансировки нагрузки с одним виртуальным IP-адресом. Каждый узел запускает серверный процесс Redis и доступен через имя узла и порты Redis. Каждый узел считается узлом главной или реплики. Когда клиентское приложение подключается к кэшу, его трафик проходит через эту подсистему балансировки нагрузки и автоматически направляется на главный узел.

В базовом кэше один узел всегда является главным. В кэше уровня "Стандартный" или "Премиум" существует два узла, где один из них выбирается главным, а другой — репликой. Так как кэши уровня "Стандартный" и "Премиум" имеют несколько узлов, один узел может быть недоступен, пока другие продолжают обрабатывать запросы. Кластеризованные кэши состоят из множества сегментов, каждый из которых имеет отдельные узлы главной и реплики. Возможно, один сегмент не работает, а другие остаются доступными.

> [!NOTE]
> Базовый кэш не содержит несколько узлов и не предоставляет соглашение об уровне обслуживания для доступности. Базовые кэши рекомендуются только для целей разработки и тестирования. Используйте кэш уровня "Стандартный" или "Премиум" для развертывания с несколькими узлами, чтобы повысить доступность.

### <a name="a-failover-explained"></a>Описание отработки отказа

Отработка отказа происходит, когда узел реплики становится главным узлом, а старый главный узел закрывает существующие соединения. После того как главный узел получит резервную копию, он заметит изменение ролей и понизить его, чтобы стать репликой. Затем он подключится к новой базе данных master и будет синхронизировать данные. Отработка отказа может быть запланирована или незапланирована.

Плановая отработка отказа выполняется во время обновлений системы, таких как установка исправлений или обновление ОС, а также операции управления, такие как масштабирование и перезагрузка. Поскольку узлы получают расширенное уведомление об обновлении, они могут совместно менять роли и быстро обновлять подсистему балансировки нагрузки изменения. Плановая отработка отказа должна завершиться менее 1 секунды.

Внеплановая отработка отказа может произойти из-за сбоя оборудования, сбоя сети или других непредвиденных сбоев главного узла. Узел реплики будет додвигаться до главной, но процесс занимает больше времени. Узел реплики сначала должен определить, что его главный узел недоступен, прежде чем он сможет запустить процесс отработки отказа. Узел реплики также должен проверить, что незапланированный сбой не является временным или локальным, чтобы избежать переработки отказа. Задержка при обнаружении означает, что внеплановая отработка отказа обычно завершается в течение 10 – 15 секунд.

## <a name="how-does-patching-occur"></a>Как происходит исправление?

Кэш Azure для службы Redis регулярно выполняет обслуживание для обновления кэша с помощью новейших функций и исправлений платформы. Для исправления кэша служба выполняет следующие действия.

1. Служба управления выбирает один узел для исправления.
1. Если выбранный узел является главным узлом, его узел реплики совместно продвигает себя. Это повышение считается плановой отработкой отказа.
1. Выбранный узел перезагружается для получения новых изменений и резервного копирования в качестве узла реплики. Узлы реплики подключаются к главному узлу и синхронизируют данные.
1. После завершения синхронизации данных процесс исправления повторяется для оставшихся узлов.

Поскольку установка исправлений является плановой отработкой отказа, узел реплики быстро становится главным и начинает обслуживать запросы и новые подключения. Базовые кэши не имеют узла реплики и недоступны до завершения обновления. Каждый сегмент кластеризованного кэша обновляется отдельно и не закрывает соединения с другим сегментом.

> [!IMPORTANT]
> Узлы исправлены по одному, чтобы предотвратить потери данных. Базовые кэши будут содержать потери данных. В кластеризованные кэши внесены исправления по одному сегменту за раз.

Несколько кэшей в одной группе ресурсов и регионе также будут исправлены по одному за раз.  Кэши, которые находятся в разных группах ресурсов или в разных регионах, могут быть исправлены одновременно.

Так как полная синхронизация данных происходит до повторения процесса, вероятность потери данных при использовании кэша уровня "Стандартный" или "Премиум" вряд ли будет возникать. Вы можете дополнительно защититься от потери данных с помощью [экспорта](cache-how-to-import-export-data.md#export) данных и включения [сохраняемости](cache-how-to-premium-persistence.md).

### <a name="additional-cache-load"></a>Дополнительная загрузка кэша

В случае отработки отказа кэш уровня "Стандартный" и "Премиум" должен реплицировать данные с одного узла на другой. Эта репликация приводит к увеличению нагрузки в памяти сервера и ЦП. Если экземпляр кэша уже загружен, то клиентские приложения могут столкнуться с увеличенной задержкой. В экстремальных случаях клиентские приложения могут получить исключения времени ожидания. [Настройте](cache-configure.md#memory-policies) параметр `maxmemory-reserved` кэша, чтобы уменьшить влияние этой дополнительной нагрузки.

## <a name="how-does-a-failover-impact-my-client-application"></a>Как отработка отказа влияет на мое клиентское приложение?

Количество ошибок, обнаруженных в клиентском приложении, зависит от того, сколько операций было отложено для этого подключения во время отработки отказа. Все подключения, направляемые через узел, который закрыл соединения, увидят ошибки. Многие клиентские библиотеки могут вызывать различные типы ошибок, включая исключения времени ожидания, исключения соединения или исключения сокета при разрыве соединений. Количество и тип исключений зависит от того, где в коде пути к коду происходит, когда кэш закрывает свои подключения. Например, операция, которая отправляет запрос, но не получила ответ при отработке отказа, может получить исключение времени ожидания. Новые запросы к закрытому объекту соединения будут принимать исключения подключения до тех пор, пока не будет выполнено повторное подключение.

Большинство клиентских библиотек попытаются повторно подключиться к кэшу, если они настроены, но непредвиденные ошибки могут иногда поместить объекты библиотеки в невосстанавливаемое состояние. Если ошибки сохраняются дольше, чем предварительно настроенное время, объект соединения следует создать заново. В .NET и других объектно-ориентированных языках повторное создание подключения без перезапуска приложения можно выполнить с помощью [шаблона отложенной \<T \>](https://gist.github.com/JonCole/925630df72be1351b21440625ff2671f#reconnecting-with-lazyt-pattern).

### <a name="what-should-i-do-in-my-application"></a>Что делать в моем приложении?

Поскольку отработку отказа невозможно полностью избежать, клиентские приложения должны быть написаны для обеспечения устойчивости к разрывам соединений и неудачным запросам. Несмотря на то, что большинство клиентских библиотек автоматически повторно подключается к конечной точке кэша, несколько клиентских библиотек пытаются повторить неудачные запросы. В зависимости от сценария приложения логика повторных попыток с резервным копированием может иметь смысл.

Чтобы проверить устойчивость клиентского приложения, используйте [перезагрузку](cache-administration.md#reboot) в качестве ручного триггера для разрыва соединения. Кроме того, рекомендуется [запланировать обновление](cache-administration.md#schedule-updates) кэша, чтобы служба управления установила исправления среды выполнения Redis во время указанных еженедельных окон. Обычно эти окна выбираются в периоды, когда трафик клиентского приложения уменьшается во избежание потенциальных инцидентов.

### <a name="client-network-configuration-changes"></a>Изменения конфигурации сети клиента

Некоторые изменения конфигурации сети на стороне клиента могут вызвать ошибки "нет подключения".  Переключение виртуального IP-адреса клиентского приложения между промежуточным и рабочим слотами или масштабирование размера или количества экземпляров приложения может вызвать проблемы с подключением, которые были меньше одной минуты. Как правило, клиентское приложение теряет подключение к другим внешним сетевым ресурсам в дополнение к Redis.

## <a name="next-steps"></a>Дальнейшие действия

- [Запланируйте обновление](cache-administration.md#schedule-updates) кэша.
- Протестируйте устойчивость приложения с помощью [перезагрузки](cache-administration.md#reboot).
- [Настройка](cache-configure.md#memory-policies) резервирования и политик памяти.
