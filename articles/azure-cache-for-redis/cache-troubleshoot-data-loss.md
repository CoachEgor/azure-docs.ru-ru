---
title: Устранение неполадок с потерей данных в кэше Azure для Redis | Документация Майкрософт
description: Узнайте, как устранять проблемы с потерей данных в кэше Azure для Redis
services: cache
documentationcenter: ''
author: yegu-ms
manager: maiye
editor: ''
ms.assetid: ''
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache
ms.devlang: na
ms.topic: article
ms.date: 10/17/2019
ms.author: yegu
ms.openlocfilehash: 8165ce3195c12af52cfee2fff598d9417697f4cb
ms.sourcegitcommit: ac56ef07d86328c40fed5b5792a6a02698926c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73806558"
---
# <a name="troubleshoot-data-loss-in-azure-cache-for-redis"></a>Устранение потери данных в кэше Azure для Redis

В этой статье описывается, как диагностировать фактические или наблюдаемые потери данных, которые могут возникнуть в кэше Azure для Redis.

> [!NOTE]
> Шаги по устранению проблем в этой статье также включают в себя указания по выполнению команд Redis и мониторингу различных метрик производительности. Дополнительные сведения и указания см. в разделе [Дополнительные сведения](#additional-information).
>

## <a name="partial-loss-of-keys"></a>Частичная утрата ключей

Кэш Azure для Redis не удаляет ключи случайным образом после их сохранения в памяти. Однако он удаляет ключи в ответ на политики истечения срока действия или вытеснений и явные команды удаления ключа. Ключи, которые были записаны в главный узел в кэше Azure уровня "Премиум" или "Стандартный" для экземпляра Redis, также могут быть недоступны в реплике сразу. Данные реплицируются из главного экземпляра в реплику асинхронным образом и без блокировки.

Если вы обнаружите, что ключи исчезли из кэша, проверьте следующие возможные причины.

| Причина: | Description (Описание) |
|---|---|
| [Срок действия ключа](#key-expiration) | Ключи удалены, так как для них заданы истечение времени ожидания. |
| [Вытеснение ключа](#key-eviction) | Ключи удаляются при нехватке памяти. |
| [Удаление ключа](#key-deletion) | Ключи удаляются командами явного удаления. |
| [Асинхронная репликация](#async-replication) | Ключи недоступны в реплике из-за задержек репликации данных. |

### <a name="key-expiration"></a>Срок действия ключа

Кэш Azure для Redis удаляет ключ автоматически, если этому ключу назначено время ожидания, и этот период прошел. Дополнительные сведения об истечении срока действия ключа Redis см. в документации по команде [Expires](http://redis.io/commands/expire) . Значения времени ожидания также можно задать с помощью команд [Set](http://redis.io/commands/set), [сетекс](https://redis.io/commands/setex), [жетсет](https://redis.io/commands/getset)и других **\*хранилища** .

Чтобы получить статистику о том, сколько ключей устарело, используйте команду [info](http://redis.io/commands/info) . В разделе `Stats` показано общее число ключей с истекшим сроком действия. В разделе `Keyspace` содержатся дополнительные сведения о числе ключей с истечением времени ожидания и средним значением времени ожидания.

```
# Stats

expired_keys:46583

# Keyspace

db0:keys=3450,expires=2,avg_ttl=91861015336
```

Вы также можете просмотреть метрики диагностики для кэша, чтобы увидеть, существует ли корреляция между моментом отсутствия ключа и пиками в ключах с истекшим сроком действия. Сведения об использовании уведомлений или **монитора** пространства ключей для отладки этих типов проблем см. в приложении [Отладка Redis пространства ключей промахов](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix) .

### <a name="key-eviction"></a>Вытеснение ключа

Для хранения данных в кэше Azure для Redis требуется пространство памяти. Он очищает ключи для освобождения доступной памяти при необходимости. Если значения **used_memory** или **Used_memory_rss** в команде [info](http://redis.io/commands/info) имеют настроенный параметр **MaxMemory** , то в кэше Azure для Redis начинается удаление ключей из памяти на основе [политики кэша](http://redis.io/topics/lru-cache).

Количество вытесненных ключей можно отслеживать с помощью команды [info](http://redis.io/commands/info) :

```
# Stats

evicted_keys:13224
```

Вы также можете просмотреть метрики диагностики для кэша, чтобы увидеть, существует ли корреляция между моментом отсутствия ключа и пик в вытесненных ключах. Сведения об использовании уведомлений или **монитора** пространства ключей для отладки этих типов проблем см. в приложении [Отладка Redis пространства ключей промахов](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix) .

### <a name="key-deletion"></a>Удаление ключа

Клиенты Redis могут выдать команду [Del](http://redis.io/commands/del) или [хдел](http://redis.io/commands/hdel) , чтобы явно удалить ключи из кэша Azure для Redis. Количество операций удаления можно отвести с помощью команды [info](http://redis.io/commands/info) . Если были вызваны команды **Del** или **хдел** , они будут перечислены в разделе `Commandstats`.

```
# Commandstats

cmdstat_del:calls=2,usec=90,usec_per_call=45.00

cmdstat_hdel:calls=1,usec=47,usec_per_call=47.00
```

### <a name="async-replication"></a>Асинхронная репликация

Любой кэш Azure для экземпляра Redis на уровне "Стандартный" или "Премиум" настраивается с главным узлом и по крайней мере одной репликой. Данные копируются из главного сервера в реплику асинхронно с помощью фонового процесса. На веб-сайте [Redis.IO](http://redis.io/topics/replication) описано, как работает репликация данных Redis в целом. Для сценариев, в которых клиенты часто пишут данные в Redis, может произойти частичная утрата данных, так как репликация гарантируется мгновенно. Например, если *после того* , как клиент запишет в него ключ, он перестает работать, но *до* того, как фоновый процесс попытается отправить этот ключ в реплику, этот ключ будет потерян, когда реплика станет новым главным.

## <a name="major-or-complete-loss-of-keys"></a>Значительная или полная утрата ключей

Если большинство или все ключи исчезли из кэша, проверьте следующие возможные причины.

| Причина: | Description (Описание) |
|---|---|
| [Очистка ключа](#key-flushing) | Ключи были удалены вручную. |
| [Неверный выбор базы данных](#incorrect-database-selection) | Кэш Azure для Redis настроен на использование базы данных, отличной от используемой по умолчанию. |
| [Сбой экземпляра Redis](#redis-instance-failure) | Сервер Redis недоступен. |

### <a name="key-flushing"></a>Очистка ключа

Клиенты могут вызвать команду [флушдб](http://redis.io/commands/flushdb) , чтобы удалить все ключи из *одной* базы данных или [флушалл](http://redis.io/commands/flushall) , чтобы удалить все ключи из *всех* баз данных в кэше Redis. Чтобы узнать, были ли ключи очищены, используйте команду [info](http://redis.io/commands/info) . В разделе `Commandstats` показано, вызвана ли команда **flush** :

```
# Commandstats

cmdstat_flushall:calls=2,usec=112,usec_per_call=56.00

cmdstat_flushdb:calls=1,usec=110,usec_per_call=52.00
```

### <a name="incorrect-database-selection"></a>Неверный выбор базы данных

Кэш Azure для Redis по умолчанию использует базу данных **Db0** . Если переключиться на другую базу данных (например, **DB1**) и попытаться прочитать ключи из нее, то кэш Azure для Redis не обнаружит их там. Каждая база данных является логически отдельной единицей и содержит другой набор данных. Используйте команду [SELECT](http://redis.io/commands/select) , чтобы использовать другие доступные базы данных и найти в них ключи.

### <a name="redis-instance-failure"></a>Сбой экземпляра Redis

Redis — это хранилище данных в памяти. Данные хранятся на физических компьютерах или виртуальных машинах, где размещается кэш Redis. Кэш Azure для экземпляра Redis на уровне "базовый" работает только на одной виртуальной машине. Если эта виртуальная машина не работает, все данные, сохраненные в кэше, теряются. 

Кэши на уровнях "Стандартный" и "Премиум" обеспечивают более высокую устойчивость к потери данных с помощью двух виртуальных машин в реплицированной конфигурации. При сбое главного узла в таком кэше узел реплики принимает данные для автоматической обработки данных. Эти виртуальные машины размещаются в отдельных доменах для сбоев и обновлений, что позволяет избежать одновременного недоступности обоих этих виртуальных машин. Однако если происходит сбой основного центра обработки данных, виртуальные машины могут продолжать работать вместе. В этих редких случаях ваши данные будут потеряны.

Рекомендуется использовать [сохраняемость данных Redis](http://redis.io/topics/persistence) и [георепликацию](https://docs.microsoft.com/azure/azure-cache-for-redis/cache-how-to-geo-replication) , чтобы улучшить защиту данных от этих сбоев инфраструктуры.

## <a name="additional-information"></a>Дополнительная информация

- [Устранение неполадок в кэше Azure для Redis неполадок на стороне сервера](cache-troubleshoot-server.md)
- [Какое предложение и размер кэша Azure для Redis мне следует использовать?](cache-faq.md#what-azure-cache-for-redis-offering-and-size-should-i-use)
- [Как отслеживать кэш Redis для Azure?](cache-how-to-monitor.md)
- [Как выполнять команды Redis?](cache-faq.md#how-can-i-run-redis-commands)
