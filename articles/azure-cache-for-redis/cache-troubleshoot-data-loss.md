---
title: Устранение неполадок, связанных с потерей данных в Кэше Azure для Redis
description: Узнайте, как решить проблемы с потерей данных с помощью Кэша Azure для Redis, такие как частичная потеря ключей, срок действия ключей или полная потеря ключей.
author: yegu-ms
ms.author: yegu
ms.service: cache
ms.topic: conceptual
ms.date: 10/17/2019
ms.openlocfilehash: d54506b94f076f0a3d967f88bd4e2960a1ca6396
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75530907"
---
# <a name="troubleshoot-data-loss-in-azure-cache-for-redis"></a>Устранение неполадок, связанных с потерей данных в Кэше Azure для Redis

В этой статье рассматривается, как диагностировать фактические или предполагаемые потери данных, которые могут возникнуть в Azure Cache для Redis.

> [!NOTE]
> Шаги по устранению проблем в этой статье также включают в себя указания по выполнению команд Redis и мониторингу различных метрик производительности. Дополнительные сведения и указания см. в разделе [Дополнительные сведения](#additional-information).
>

## <a name="partial-loss-of-keys"></a>Частичная потеря ключей

Azure Cache для Redis не удаляет ключи случайным образом после их хранения в памяти. Тем не менее, он удаляет ключи в ответ на истечение срока действия или политики выселения и на явные команды удаления ключей. Ключи, написанные в главном узеле в экземпляре Premium или Standard Azure для экземпляра Redis, также могут быть недоступны в реплике сразу. Данные реплицируются от мастера к реплике асинхронным и неблокирующим образом.

Если вы обнаружите, что ключи исчезли из кэша, проверьте следующие возможные причины:

| Причина | Описание |
|---|---|
| [Окончание срока действия ключа](#key-expiration) | Ключи удаляются из-за установленных на них тайм-аутов. |
| [Ключевое выселение](#key-eviction) | Ключи удаляются под давлением памяти. |
| [Удаление ключей](#key-deletion) | Ключи удаляются с помощью явных команд удаления. |
| [Репликация Async](#async-replication) | Ключи не доступны на реплике из-за задержек репликации данных. |

### <a name="key-expiration"></a>Окончание срока действия ключа

Azure Cache для Redis удаляет ключ автоматически, если ключ назначен тайм-аутик и этот период прошел. Для получения дополнительной информации об истечении срока действия ключа Redis см. [EXPIRE](https://redis.io/commands/expire) Значения тайм-аута также можно установить с помощью [set,](https://redis.io/commands/set) [SETEX,](https://redis.io/commands/setex) [GETSET](https://redis.io/commands/getset)и других ** \*** команд STORE.

Чтобы получить статистику о том, сколько ключей истек, используйте команду [INFO.](https://redis.io/commands/info) В `Stats` разделе отображается общее количество ключей с истекшим сроком действия. В `Keyspace` разделе содержится более подробная информация о количестве ключей с тайм-аутами и средней стоимости тайм-аута.

```
# Stats

expired_keys:46583

# Keyspace

db0:keys=3450,expires=2,avg_ttl=91861015336
```

Вы также можете посмотреть на диагностические метрики для кэша, чтобы увидеть, есть ли корреляция между тем, когда ключ пропал и всплеск ключей с истекшим сроком действия. См в приложении [Debugging Redis Keyspace Misses](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix) можно ознакомиться с информацией об использовании уведомлений keyspace или **MONITOR** для отладки этих типов проблем.

### <a name="key-eviction"></a>Ключевое выселение

Кэш Azure для Redis требует пространства памяти для хранения данных. Он очищает ключи, чтобы освободить доступную память, когда это необходимо. Когда **used_memory** или **used_memory_rss** значения в команде [INFO](https://redis.io/commands/info) приближаются к настроенной настройке **макспамяти,** кэш Azure для Redis начинает выселять ключи из памяти на основе [политики кэша.](https://redis.io/topics/lru-cache)

Вы можете контролировать количество выселяемых ключей с помощью команды [INFO:](https://redis.io/commands/info)

```
# Stats

evicted_keys:13224
```

Вы также можете посмотреть на диагностические метрики для кэша, чтобы увидеть, есть ли корреляция между тем, когда ключ пропал и всплеск выселили ключей. См в приложении [Debugging Redis Keyspace Misses](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix) можно ознакомиться с информацией об использовании уведомлений keyspace или **MONITOR** для отладки этих типов проблем.

### <a name="key-deletion"></a>Удаление ключей

Клиенты Redis могут выдавать команду [DEL](https://redis.io/commands/del) или [HDEL](https://redis.io/commands/hdel) для явного удаления ключей из кэша Azure для Redis. Вы можете отслеживать количество операций удаления с помощью команды [INFO.](https://redis.io/commands/info) Если команды **DEL** или **HDEL** были вызваны, они `Commandstats` будут перечислены в разделе.

```
# Commandstats

cmdstat_del:calls=2,usec=90,usec_per_call=45.00

cmdstat_hdel:calls=1,usec=47,usec_per_call=47.00
```

### <a name="async-replication"></a>Репликация Async

Любой кэш Azure для экземпляра Redis в уровне Standard или Premium настроен с помощью главного узла и, по крайней мере, одной реплики. Данные копируются с мастером на реплику асинхронно с помощью фонового процесса. На веб-сайте [redis.io](https://redis.io/topics/replication) описывается, как работает репликация данных Redis в целом. Для сценариев, где клиенты часто пишут Redis, может произойти частичная потеря данных, поскольку эта репликация гарантированно будет мгновенной. Например, если мастер выходит из-под захода после *того,* как клиент записывает ключ к нему, но *до того,* как фоновый процесс имеет возможность отправить этот ключ в реплику, ключ теряется, когда реплика берет на себя роль нового мастера.

## <a name="major-or-complete-loss-of-keys"></a>Крупная или полная потеря ключей

Если большинство или все ключи исчезли из кэша, проверьте следующие возможные причины:

| Причина | Описание |
|---|---|
| [Ключевое промывка](#key-flushing) | Ключи были очищены вручную. |
| [Неправильный выбор базы данных](#incorrect-database-selection) | Кэш Azure для Redis будет использоваться в базе данных без дефолта. |
| [Сбой экземпляра Redis](#redis-instance-failure) | Сервер Redis недоступен. |

### <a name="key-flushing"></a>Ключевое промывка

Клиенты могут позвонить в команду [FLUSHDB,](https://redis.io/commands/flushdb) чтобы удалить все ключи в *одной* базе данных или [FLUSHALL,](https://redis.io/commands/flushall) чтобы удалить все ключи из *всех* баз данных в кэше Redis. Чтобы узнать, были ли промыты ключи, используйте команду [INFO.](https://redis.io/commands/info) В `Commandstats` разделе показано, была ли вызвана команда **FLUSH:**

```
# Commandstats

cmdstat_flushall:calls=2,usec=112,usec_per_call=56.00

cmdstat_flushdb:calls=1,usec=110,usec_per_call=52.00
```

### <a name="incorrect-database-selection"></a>Неправильный выбор базы данных

Azure Cache для Redis использует базу данных **db0** по умолчанию. Если вы переключитесь на другую базу данных (например, **db1)** и попытаетесь прочитать из нее ключи, Azure Cache для Redis не найдет их там. Каждая база данных является логически отдельным блоком и содержит другой набор данных. Используйте команду [SELECT,](https://redis.io/commands/select) чтобы использовать другие доступные базы данных и искать ключи в каждой из них.

### <a name="redis-instance-failure"></a>Сбой экземпляра Redis

Redis — это хранилище данных в памяти. Данные хранятся на физических или виртуальных машинах, вмещающие кэш Redis. Кэш Azure для экземпляра Redis в базовом уровне работает только на одной виртуальной машине (VM). Если этот VM не работает, все данные, которые вы хранили в кэше, теряются. 

Кэши в уровнях Standard и Premium обеспечивают гораздо более высокую устойчивость к потере данных с помощью двух вдвистых в конфигурации. Когда основной узла в таком кэше выходит из строя, узла реплики берет на себя для автоматического обслуживания данных. Эти ВМ расположены на отдельных доменах для сбоев и обновлений, чтобы свести к минимуму вероятность того, что оба станут недоступными одновременно. Однако, если происходит крупное отключение центра обработки данных, им. М. могут по-прежнему идти вниз вместе. Ваши данные будут потеряны в этих редких случаях.

Рассмотрите возможность использования [сохранения данных Redis](https://redis.io/topics/persistence) и [георепликации](https://docs.microsoft.com/azure/azure-cache-for-redis/cache-how-to-geo-replication) для улучшения защиты данных от этих сбоев в инфраструктуре.

## <a name="additional-information"></a>Дополнительные сведения

- [Устранение неполадок с Кэшем Azure для Redis на стороне сервера](cache-troubleshoot-server.md)
- [Какое предложение и размер кэша Azure для Redis мне следует использовать?](cache-faq.md#what-azure-cache-for-redis-offering-and-size-should-i-use)
- [Как отслеживать кэш Redis для Azure?](cache-how-to-monitor.md)
- [Как выполнять команды Redis?](cache-faq.md#how-can-i-run-redis-commands)
