---
title: Устранение неполадок с потерей данных в кэше Azure для Redis | Документация Майкрософт
description: Узнайте, как устранить проблемы с потерей данных в кэше Azure для Redis
services: cache
documentationcenter: ''
author: yegu-ms
manager: maiye
editor: ''
ms.assetid: ''
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache
ms.devlang: na
ms.topic: article
ms.date: 10/17/2019
ms.author: yegu
ms.openlocfilehash: 4fee7c84b394e84369b28d2a4191d0e581f3beba
ms.sourcegitcommit: 38251963cf3b8c9373929e071b50fd9049942b37
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2019
ms.locfileid: "73044365"
---
# <a name="troubleshoot-azure-cache-for-redis-data-loss"></a>Устранение неполадок с потерей данных в кэше Azure для Redis

В этом разделе описывается, как диагностировать фактические или наблюдаемые потери данных, которые могут возникнуть в кэше Azure для Redis.

- [Частичная утрата ключей](#partial-loss-of-keys)
- [Значительная или полная утрата ключей](#major-or-complete-loss-of-keys)

> [!NOTE]
> Шаги по устранению проблем в этой статье также включают в себя указания по выполнению команд Redis и мониторингу различных метрик производительности. Дополнительные сведения и указания см. в разделе [Дополнительные сведения](#additional-information).
>

## <a name="partial-loss-of-keys"></a>Частичная утрата ключей

Redis не удаляет ключи случайным образом после их сохранения в памяти. При этом удаляются ключи в ответ на политики истечения срока действия или вытеснение, а также явные команды удаления ключей. Кроме того, ключи, которые были записаны в главный узел в кэше Premium или Standard Azure для Redis, могут быть недоступны в реплике сразу. Данные реплицируются из главного экземпляра в реплику асинхронным образом и без блокировки.

Если вы обнаружите, что ключи исчезли из кэша, можно проверить следующее, чтобы узнать, что может быть причиной:

| Причина: | Описание |
|---|---|
| [Срок действия ключа](#key-expiration) | Ключи удалены, так как для них заданы значения времени ожидания |
| [Вытеснение ключа](#key-eviction) | Ключи удаляются при нехватке памяти |
| [Удаление ключа](#key-deletion) | Ключи удаляются с помощью явных команд DELETE |
| [Асинхронная репликация](#async-replication) | Ключи недоступны в реплике из-за задержки репликации данных |

### <a name="key-expiration"></a>Срок действия ключа

Redis удалит ключ автоматически, если ему присвоено время ожидания, и этот период прошел. Дополнительные сведения см. в разделе Redis Key Expires в документации по [сроку действия](http://redis.io/commands/expire) . Значения времени ожидания также можно задать с помощью команд [Set](http://redis.io/commands/set), [сетекс](https://redis.io/commands/setex), [жетсет](https://redis.io/commands/getset)и других \*STORE.

Можно использовать команду [info](http://redis.io/commands/info) , чтобы получить статистику по количеству ключей, срок действия которых истек. В разделе *Статистика* отображается общее число ключей с истекшим сроком действия. В разделе *пространства ключей* содержатся дополнительные сведения о числе ключей с временем ожидания и средним значением времени ожидания.

```
# Stats

expired_keys:46583

# Keyspace

db0:keys=3450,expires=2,avg_ttl=91861015336
```

Кроме того, вы можете просмотреть метрики диагностики для кэша, чтобы проверить, существует ли корреляция между моментом отсутствия ключа и пиками в ключах с истекшим сроком действия. Сведения об использовании уведомлений или монитора пространства ключей для отладки этих типов проблем см. в [приложении](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix) .

### <a name="key-eviction"></a>Вытеснение ключа

Redis требуется место в памяти для хранения данных. При необходимости будут очищены ключи для освобождения доступной памяти. Если значения **used_memory** или **Used_memory_rss** в команде [info](http://redis.io/commands/info) имеют настроенный параметр **MaxMemory** , Redis начнет удалять ключи из памяти на основе [политики кэша](http://redis.io/topics/lru-cache).

Можно отслеживать количество исключаемых ключей с помощью команды [info](http://redis.io/commands/info) .

```
# Stats

evicted_keys:13224
```

Кроме того, можно просмотреть метрики диагностики для кэша, чтобы проверить, существует ли корреляция между моментом отсутствия ключа и пик в вытесненных ключах. Сведения об использовании уведомлений или монитора пространства ключей для отладки этих типов проблем см. в [приложении](https://gist.github.com/JonCole/4a249477142be839b904f7426ccccf82#appendix) .

### <a name="key-deletion"></a>Удаление ключа

Клиенты Redis могут выдать команду [Del](http://redis.io/commands/del) или [хдел](http://redis.io/commands/hdel) , чтобы явно удалить ключи из Redis. Количество операций удаления можно отвести с помощью команды [info](http://redis.io/commands/info) . Если были вызваны команды DEL или ХДЕЛ, они будут перечислены в разделе *коммандстатс* .

```
# Commandstats

cmdstat_del:calls=2,usec=90,usec_per_call=45.00

cmdstat_hdel:calls=1,usec=47,usec_per_call=47.00
```

### <a name="async-replication"></a>Асинхронная репликация

Любой кэш Azure для Redis на уровне "Стандартный" или "Премиум" настраивается с главным узлом и по крайней мере одной репликой. Данные копируются из мастера в реплику асинхронно с помощью фонового процесса. На веб-сайте [Redis.IO](http://redis.io/topics/replication) описано, как работает репликация данных Redis в целом. Для сценариев, в которых клиенты часто пишут данные в Redis, может произойти частичная утрата данных из-за того факта, что репликация гарантированно будет мгновенной. Например, если _после того_ , как клиент запишет в него ключ, но _перед_ тем, как фоновый процесс попытается отправить этот ключ в реплику, этот ключ будет потерян, когда реплика станет новым главным процессом.

## <a name="major-or-complete-loss-of-keys"></a>Значительная или полная утрата ключей

Если вы обнаружите, что большая часть или все ключи исчезли из кэша, можно проверить следующее, чтобы узнать, что может быть причиной:

| Причина: | Описание |
|---|---|
| [Очистка ключа](#key-flushing) | Ключи были удалены вручную |
| [Неверный выбор базы данных](#incorrect-database-selection) | Redis настроен на использование базы данных, отличной от используемой по умолчанию |
| [Сбой экземпляра Redis](#redis-instance-failure) | Сервер Redis недоступен |

### <a name="key-flushing"></a>Очистка ключа

Клиенты могут вызвать команду [флушдб](http://redis.io/commands/flushdb) , чтобы удалить все ключи из **одной** базы данных или [флушалл](http://redis.io/commands/flushall) , чтобы удалить все ключи из **всех** баз данных в кэше Redis. Узнать, были ли ключи записаны, можно с помощью команды [info](http://redis.io/commands/info) . Он показывает, была ли вызвана команда FLUSH в разделе *коммандстатс* .

```
# Commandstats

cmdstat_flushall:calls=2,usec=112,usec_per_call=56.00

cmdstat_flushdb:calls=1,usec=110,usec_per_call=52.00
```

### <a name="incorrect-database-selection"></a>Неверный выбор базы данных

Кэш Azure для Redis по умолчанию использует базу данных **Db0** . При переключении на другую базу данных (например, DB1) и попытке чтения ключей из нее Redis не обнаружит их, так как каждая база данных является логически отдельной единицей и содержит другой набор данных. Используйте команду [SELECT](http://redis.io/commands/select) , чтобы использовать другие доступные базы данных и найти в них ключи.

### <a name="redis-instance-failure"></a>Сбой экземпляра Redis

Redis — это хранилище данных в памяти. Данные хранятся на физических компьютерах или виртуальных машинах, на которых размещены Redis. Кэш Azure для экземпляра Redis на уровне "базовый" работает только на одной виртуальной машине. Если эта виртуальная машина не работает, все данные, сохраненные в кэше, теряются. Кэши на уровнях "Стандартный" и "Премиум" обеспечивают более высокую устойчивость к потери данных с помощью двух виртуальных машин в реплицированной конфигурации. При сбое главного узла в таком кэше узел реплики переключается на автоматическое обслуживание данных. Эти виртуальные машины размещаются в отдельных доменах сбоя и обновления, чтобы максимально предотвратить одновременное недоступность. Однако в случае сбоя основного центра обработки данных виртуальные машины могут продолжать работать вместе. В этих редких случаях ваши данные будут потеряны.

Следует рассмотреть возможность использования [Redis данных](http://redis.io/topics/persistence) и [георепликации](https://docs.microsoft.com/azure/azure-cache-for-redis/cache-how-to-geo-replication) для улучшения защиты данных от этих сбоев инфраструктуры.

## <a name="additional-information"></a>Дополнительные сведения

- [Устранение неполадок в кэше Azure для Redis неполадок на стороне сервера](cache-troubleshoot-server.md)
- [Какое предложение и размер кэша Redis для Azure мне следует использовать?](cache-faq.md#what-azure-cache-for-redis-offering-and-size-should-i-use)
- [Как отслеживать кэш Redis для Azure?](cache-how-to-monitor.md)
- [Как выполнять команды Redis?](cache-faq.md#how-can-i-run-redis-commands)
