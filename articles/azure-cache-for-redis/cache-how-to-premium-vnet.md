---
title: Настройка виртуальной сети — кэш Azure уровня "Премиум" для Redis
description: Узнайте, как настроить поддержку виртуальной сети и управлять ей для экземпляров кэша Azure для Redis ценовой категории "Премиум"
author: yegu-ms
ms.author: yegu
ms.service: cache
ms.custom: devx-track-csharp
ms.topic: conceptual
ms.date: 10/09/2020
ms.openlocfilehash: 5fd82105c94bb9be2d07c8843834465821acd8bc
ms.sourcegitcommit: 6a770fc07237f02bea8cc463f3d8cc5c246d7c65
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2020
ms.locfileid: "95803771"
---
# <a name="how-to-configure-virtual-network-support-for-a-premium-azure-cache-for-redis"></a>Настройка поддержки виртуальной сети для кэша Azure для Redis ценовой категории "Премиум"
Кэш Azure для Redis предлагает разные варианты кэша, которые позволяют выбирать размер и функции кэша, включая функции ценовой категории "Премиум", такие как кластеризация, постоянное хранение данных и поддержка виртуальной сети. Виртуальная сеть — это частная сеть в облаке. Если экземпляр кэша Azure для Redis настроен в виртуальной сети, он не является общедоступным, а доступен только для виртуальных машин и приложений в этой виртуальной сети. В этой статье описана настройка поддержки виртуальных сетей для экземпляра кэша Azure для Redis ценовой категории "Премиум".

> [!NOTE]
> Кэш Azure для Redis поддерживает классические виртуальные сети и виртуальные сети Resource Manager.
> 
> 

## <a name="why-vnet"></a>Зачем использовать виртуальные сети?
Развертывание [виртуальной сети Azure](https://azure.microsoft.com/services/virtual-network/) обеспечивает дополнительные возможности защиты и изоляции для кэша Azure для Redis. Такие развертывания позволяют определять подсети, настраивать политики контроля доступа, а также использовать другие функции ограничения доступа.

## <a name="virtual-network-support"></a>Поддержка виртуальной сети
Поддержка виртуальной сети настраивается во время создания кэша в колонке **New Azure Cache for Redis** (Новый кэш Azure для Redis). 

1. Чтобы создать кэш уровня "Премиум", войдите в [портал Azure](https://portal.azure.com) и выберите **создать ресурс**. Обратите внимание, что помимо создания кэшей в портал Azure их также можно создать с помощью шаблонов диспетчер ресурсов, PowerShell или Azure CLI. Дополнительные сведения о создании кэша Azure для Redis см. в разделе [Создание кэша](cache-dotnet-how-to-use-azure-redis-cache.md#create-a-cache).

    :::image type="content" source="media/cache-private-link/1-create-resource.png" alt-text="Создать ресурс.":::
   
2. На странице **Создание** выберите **Базы данных**, а затем **Кэш Azure для Redis**.

    :::image type="content" source="media/cache-private-link/2-select-cache.png" alt-text="Выбор элемента &quot;Кэш Azure для Redis&quot;.":::

3. На странице **новый кэш Redis** настройте параметры для нового кэша Premium.
   
   | Параметр      | Рекомендуемое значение  | Description |
   | ------------ |  ------- | -------------------------------------------------- |
   | **DNS-имя** | Введите глобально уникальное имя | Имя кэша должно быть строкой длиной от 1 до 63 символов и содержать только цифры, буквы и дефисы. Имя должно начинаться и заканчиваться цифрой или буквой и не может содержать более одного дефиса подряд. *Имя узла* для экземпляра кэша получит значение *\<DNS name>.redis.cache.windows.net*. | 
   | **подписка** | Раскрывающийся список и выберите свою подписку. | В этой подписке будет создан новый экземпляр кэша Redis для Azure. | 
   | **Группа ресурсов** | Выберите группу ресурсов или щелкните **создать** и введите новое имя группы ресурсов. | Имя группы ресурсов, в которой будут созданы кэш и другие ресурсы. Поместив все ресурсы приложения в одну группу ресурсов, вы сможете легко управлять ими и/или удалить их вместе. | 
   | **Местоположение** | Раскрывающийся список и выберите расположение. | Выберите оптимальный [регион](https://azure.microsoft.com/regions/) для других служб, которые будут использовать кэш. |
   | **Тип кэша** | И выберите кэш уровня "Премиум", чтобы настроить функции уровня "Премиум". Дополнительные сведения см. в статье о [ценах на кэш Azure для Redis](https://azure.microsoft.com/pricing/details/cache/). |  Ценовая категория определяет размер, производительность и функции, доступные для кэша. Дополнительные сведения см. в [обзоре предложения "Кэш Redis для Azure"](cache-overview.md). |

4. Выберите вкладку **Сети** или нажмите кнопку **Сети** в нижней части страницы.

5. На вкладке " **сеть** " в качестве метода подключения выберите **виртуальные сети** . Чтобы использовать новую виртуальную сеть, сначала создайте ее, выполнив действия, описанные в статье [Создание виртуальной сети с помощью портал Azure](../virtual-network/manage-virtual-network.md#create-a-virtual-network) или [Создание классической виртуальной сети с помощью портал Azure](/previous-versions/azure/virtual-network/virtual-networks-create-vnet-classic-pportal) , а затем вернитесь в колонку **новый кэш Azure для Redis** , чтобы создать и настроить кэш уровня "Премиум".

   > [!IMPORTANT]
   > При развертывании кэша Azure для Redis в виртуальной сети Resource Manager этот кэш следует разместить в выделенной подсети, которая не содержит других ресурсов, кроме экземпляров кэша Azure для Redis. При попытке развернуть кэш Azure для Redis в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, развертывание завершается сбоем.
   > 
   > 

   | Параметр      | Рекомендуемое значение  | Описание |
   | ------------ |  ------- | -------------------------------------------------- |
   | **Виртуальная сеть** | И выберите виртуальную сеть. | Выберите виртуальную сеть, которая находится в той же подписке и расположении, что и ваш кэш. | 
   | **Подсеть** | Раскрывающийся список и выберите подсеть. | Диапазон адресов подсети должен быть в нотации CIDR (например, 192.168.1.0/24). Он должен содержаться в адресном пространстве виртуальной сети. | 
   | **Статический IP-адрес** | Используемых Введите статический IP-адрес. | Если не указать статический IP-адрес, IP-адреса выбирается автоматически. | 

   > [!IMPORTANT]
   > Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)
   > 
   > Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается имеющим один сегмент.
   > 
   > 

6. Нажмите кнопку **Далее: дополнительно** в нижней части страницы или выберите вкладку **Далее: дополнительно**.

7. На вкладке **Дополнительно** для экземпляра кэша уровня "Премиум" настройте параметры для неtls-порта, кластеризации и сохраняемости данных. 

8. Нажмите кнопку **Далее: теги** или нажмите кнопку **Далее: теги** в нижней части страницы.

9. При необходимости на вкладке **Теги** введите имя и значение, чтобы классифицировать ресурс. 

10. Выберите **Проверить и создать**. Вы будете перенаправлены на вкладку "Просмотр и создание", где Azure проверит вашу конфигурацию.

11. Когда отобразится сообщение "Проверка пройдена" зеленого цвета, выберите **Создать**.

На создание кэша требуется некоторое время. Вы можете отслеживать ход выполнения на странице **обзорных сведений** кэша Azure для Redis. Когда **Состояние** примет значение **Running** (Выполняется), кэш будет готов к использованию. Создав кэш, конфигурацию виртуальной сети можно просмотреть, щелкнув **Виртуальная сеть** в **меню ресурсов**.

![Виртуальная сеть][redis-cache-vnet-info]

Чтобы подключиться к экземпляру кэша Azure для Redis при использовании виртуальной сети, укажите в строке подключения имя узла кэша, как показано в приведенном ниже примере.

```csharp
private static Lazy<ConnectionMultiplexer>
    lazyConnection = new Lazy<ConnectionMultiplexer> (() =>
    {
        return ConnectionMultiplexer.Connect("contoso5premium.redis.cache.windows.net,abortConnect=false,ssl=true,password=password");
    });

public static ConnectionMultiplexer Connection
{
    get
    {
        return lazyConnection.Value;
    }
}
```

## <a name="azure-cache-for-redis-vnet-faq"></a>Вопросы и ответы по виртуальной сети кэша Azure для Redis
Следующий список содержит ответы на часто задаваемые вопросы о виртуальных сетях кэша Azure для Redis.

* Каковы распространенные ошибки в конфигурации кэша Azure для Redis и виртуальных сетей?
* [Как проверить, работает ли кэш в виртуальной сети?](#how-can-i-verify-that-my-cache-is-working-in-a-vnet)
* Почему при попытке подключения к моему кэшу Azure для Redis в виртуальной сети происходит ошибка и появляется сообщение о том, что удаленный сертификат недействителен?
* [Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?](#can-i-use-vnets-with-a-standard-or-basic-cache)
* Почему в одних подсетях не удается создать кэш Azure для Redis, а в других удается?
* [Каковы требования к адресному пространству подсети?](#what-are-the-subnet-address-space-requirements)
* [Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)](#do-all-cache-features-work-when-hosting-a-cache-in-a-vnet)

### <a name="what-are-some-common-misconfiguration-issues-with-azure-cache-for-redis-and-vnets"></a>Каковы распространенные ошибки в конфигурации кэша Azure для Redis и виртуальных сетей?
При размещении кэша Redis Azure для Redis в виртуальной сети используются порты, указанные в следующих таблицах. 

>[!IMPORTANT]
>Если эти порты заблокированы, кэш может работать неправильно. Блокировка одного или нескольких из этих портов является самой распространенной ошибкой при настройке кэша Azure для Redis в виртуальной сети.
> 
> 

- [Обязательные порты для исходящего трафика](#outbound-port-requirements)
- [Обязательные порты для входящего трафика](#inbound-port-requirements)

#### <a name="outbound-port-requirements"></a>Обязательные порты для исходящего трафика

Существует девять требований к исходящему порту. Исходящие запросы в этих диапазонах являются либо исходящими для других служб, необходимых для функционирования кэша, либо внутренними в подсети Redis для взаимодействия между узлами. Для георепликации существуют дополнительные требования к исходящему трафику между подсетями первичного и репликового кэша.

| Порты | Направление | Транспортный протокол | Назначение | Локальный IP-адрес | Удаленный IP-адрес |
| --- | --- | --- | --- | --- | --- |
| 80, 443 |Исходящие |TCP |Зависимости Redis в службе хранилища Azure или PKI (Интернет) | (Подсеть Redis) |* <sup>четырех</sup> |
| 443 | Исходящие | TCP | Зависимость Redis от Azure Key Vault и Azure Monitor | (Подсеть Redis) | AzureKeyVault, Азуремонитор <sup>1</sup> |
| 53 |Исходящий трафик |TCP/UDP |Зависимости Redis в DNS (Интернет/виртуальная сеть) | (Подсеть Redis) | 168.63.129.16 и 169.254.169.254 <sup>2</sup> , а также любой пользовательский DNS-сервер для подсети <sup>3</sup> |
| 8443 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) | (Подсеть Redis) |
| 10221-10231 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) | (Подсеть Redis) |
| 20226 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 13000-13999 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 15000-15999 |Исходящие |TCP |Внутренние коммуникации для Redis и Geo-Replication | (Подсеть Redis) |(Подсеть Redis) (Геореплика одноранговая подсеть) |
| 6379-6380 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |

<sup>1</sup> можно использовать теги службы "AzureKeyVault" и "азуремонитор" с диспетчер ресурсов группами безопасности сети.

<sup>2</sup> эти IP-адреса, принадлежащие корпорации Майкрософт, используются для адресации виртуальной машины узла, которая обслуживает Azure DNS.

<sup>3</sup> не требуется для подсетей без НАСТРАИВАЕМОГО DNS-сервера или более новых кэшей Redis, которые игнорируют пользовательский DNS.

<sup>4</sup> дополнительные сведения см. в разделе [Дополнительные требования к СЕТЕВЫМ подключениям виртуальной](#additional-vnet-network-connectivity-requirements)сети.

#### <a name="geo-replication-peer-port-requirements"></a>Требования к портам, связанные с георепликацией

Если вы используете георепликацию между кэшами в виртуальных сетях Azure, то следует отметить, что рекомендуемой конфигурацией является разблокировка портов 15000-15999 для всей подсети как входящих, так и исходящих направлений для обоих кэшей, чтобы все компоненты реплики в подсети могли взаимодействовать напрямую друг с другом даже в случае последующей географической отработки отказа.

#### <a name="inbound-port-requirements"></a>Обязательные порты для входящего трафика

Существует восемь обязательных диапазонов портов для входящего трафика. Входящие запросы в этих диапазонах исходят от других служб, размещенных в той же виртуальной сети, или являются результатом внутреннего обмена данными в подсети Redis.

| Порты | Направление | Транспортный протокол | Назначение | Локальный IP-адрес | Удаленный IP-адрес |
| --- | --- | --- | --- | --- | --- |
| 6379, 6380 |Входящий трафик |TCP |Обмен данными между клиентом и Redis, балансировка нагрузки Azure | (Подсеть Redis) | (Подсеть Redis), (подсеть клиента), AzureLoadBalancer <sup>1</sup> |
| 8443 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 8500 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure | (Подсеть Redis) | AzureLoadBalancer |
| 10221-10231 |Входящий трафик |TCP |Взаимодействие клиента с кластерами Redis, внутренняя связь для Redis | (Подсеть Redis) |(Подсеть Redis), AzureLoadBalancer, (подсеть клиента) |
| 13000-13999 |Входящий трафик |TCP |Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure | (Подсеть Redis) | (Подсеть Redis), (подсеть клиента), AzureLoadBalancer |
| 15000-15999 |Входящий трафик |TCP |Клиентское взаимодействие с кластерами Redis, балансировкой нагрузки Azure и Geo-Replication | (Подсеть Redis) | (Подсеть Redis), (подсеть клиента), AzureLoadBalancer, (одноранговая подсеть геореплики) |
| 16001 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure | (Подсеть Redis) | AzureLoadBalancer |
| 20226 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |

<sup>1</sup> можно использовать тег службы "AzureLoadBalancer" (диспетчер ресурсов) (или "AZURE_LOADBALANCER" для классической модели) для создания правил NSG.

#### <a name="additional-vnet-network-connectivity-requirements"></a>Дополнительные требования к подключению к виртуальной сети

Существуют требования к сетевому подключению кэша Azure для Redis, которым виртуальная сеть изначально может не соответствовать. Чтобы кэш Azure для Redis в виртуальной сети работал правильно, нужно выполнить все перечисленные ниже требования.

* Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру. Это относится к конечным точкам, находящимся в одном регионе с экземпляром кэша Azure для Redis, а также к конечным точкам хранилища, расположенным в **других** регионах Azure. Конечные точки службы хранилища Azure разрешаются в следующих доменах DNS: *Table.Core.Windows.NET*, *BLOB.Core.Windows.NET*, *Queue.Core.Windows.NET* и *File.Core.Windows.NET*. 
* Исходящее сетевое подключение к *OCSP.DigiCert.com*, *crl4.DigiCert.com*, *OCSP.msocsp.com*, *mscrl.Microsoft.com*, *crl3.DigiCert.com*, *cacerts.DigiCert.com*, *oneocsp.Microsoft.com* и *CRL.Microsoft.com*. Это подключение требуется для поддержки функций TLS/SSL.
* Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках. Эти требования DNS обеспечиваются за счет настройки допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.
* Исходящее сетевое подключение к следующим Azure Monitor конечным точкам, которые разрешаются в следующих доменах DNS: *shoebox2-Black.shoebox2.Metrics.nsatc.NET*, *North-prod2.prod2.Metrics.nsatc.NET*, *azglobal-Black.azglobal.Metrics.nsatc.NET*, *shoebox2-Red.shoebox2.Metrics.nsatc.NET*, *East-prod2.prod2.Metrics.nsatc.NET*, *azglobal-Red.azglobal.Metrics.nsatc.NET*.

### <a name="how-can-i-verify-that-my-cache-is-working-in-a-vnet"></a>Как проверить, что кэш работает в виртуальной сети?

>[!IMPORTANT]
>При подключении к кэшу Azure для экземпляра Redis, размещенного в виртуальной сети, клиенты кэша должны находиться в одной виртуальной сети или в виртуальной сети с включенным пирингом виртуальных сетей в одном регионе Azure. Глобальная Пиринг виртуальных сетей в настоящее время не поддерживается. Сюда входят все тестовые приложения и средства диагностики для проверки связи. Независимо от того, где размещается клиентское приложение, необходимо настроить группы безопасности сети или другие уровни сети таким, чтобы сетевой трафик клиента был доступен экземпляру Redis.
>
>

Когда обязательные порты настроены, как описано в предыдущем разделе, можно проверить работу кэша, выполнив следующие действия.

- [Перезагрузите](cache-administration.md#reboot) все узлы кэша. Если не установить все необходимые зависимости кэша (как описано в разделах [Обязательные порты для входящего трафика](cache-how-to-premium-vnet.md#inbound-port-requirements) и [Обязательные порты для исходящего трафика](cache-how-to-premium-vnet.md#outbound-port-requirements)), то кэш не сможет перезапускаться.
- После перезапуска узлов кэша (по данным о состоянии кэша на портале Azure) можно выполнить следующие поверки:
  - проверить связь с конечной точкой кэша (через порт 6380) с компьютера, который находится с кэшем в одной виртуальной сети, используя инструмент [tcping](https://www.elifulkerson.com/projects/tcping.php). Пример:
    
    `tcping.exe contosocache.redis.cache.windows.net 6380`
    
    Если инструмент `tcping` сообщает, что порт открыт, то кэш доступен для подключения с клиентов в виртуальной сети.

  - Другой способ проверки — создать тестовый клиент кэша (это может быть простое консольное приложение, использующее StackExchange.Redis), который подключается к кэшу и добавляет какие-то элементы в кэш или извлекает их из него. Установите пример клиентского приложения на виртуальную машину, которая находится с кэшем в одной виртуальной сети, и запустите его, чтобы проверить подключение к кэшу.


### <a name="when-trying-to-connect-to-my-azure-cache-for-redis-in-a-vnet-why-am-i-getting-an-error-stating-the-remote-certificate-is-invalid"></a>Почему при попытке подключения к моему кэшу Azure для Redis в виртуальной сети происходит ошибка и появляется сообщение о том, что удаленный сертификат недействителен?

При попытке подключения к кэшу Azure для Redis в виртуальной сети появляется сообщение об ошибке проверки сертификатов, например такое:

`{"No connection is available to service this operation: SET mykey; The remote certificate is invalid according to the validation procedure.; …"}`

Причина может заключаться в том, что вы подключаетесь к узлу по IP-адресу. Мы рекомендуем использовать имя узла. Другими словами, используйте следующее:     

`[mycachename].redis.windows.net:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False`

Не используйте IP-адрес, похожий на следующую строку подключения:

`10.128.2.84:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False`

Если не удается разрешить имя DNS, некоторые клиентские библиотеки содержат параметры конфигурации, например `sslHost`, которые предоставляет клиент StackExchange.Redis. Это позволяет переопределить имя узла, используемое для проверки сертификата. Пример:

`10.128.2.84:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False;sslHost=[mycachename].redis.windows.net`

### <a name="can-i-use-vnets-with-a-standard-or-basic-cache"></a>Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?
Виртуальные сети доступны только для кэшей уровня "Премиум".

### <a name="why-does-creating-an-azure-cache-for-redis-fail-in-some-subnets-but-not-others"></a>Почему в одних подсетях не удается создать кэш Azure для Redis, а в других удается?
При развертывании кэша Azure для Redis в виртуальной сети кэш должен находиться в выделенной подсети, которая не содержит других типов ресурсов. Если предпринята попытка развернуть кэш Azure для Redis в подсети диспетчер ресурсов VNet, которая содержит другие ресурсы (например, шлюзы приложений, исходящий трафик NAT и т. д.), то развертывание обычно завершится ошибкой. Прежде чем можно будет создать новый кэш Azure для Redis, необходимо удалить существующие ресурсы других типов.

Кроме того, необходимо иметь достаточное количество доступных IP-адресов в подсети.

### <a name="what-are-the-subnet-address-space-requirements"></a>Каковы требования к адресному пространству подсети?
Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)

В дополнение к IP-адресам, используемым инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса для сегмента кластера (а также дополнительные IP-адреса для дополнительных реплик, если таковые имеются) и один дополнительный IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается имеющим один сегмент.

### <a name="do-all-cache-features-work-when-hosting-a-cache-in-a-vnet"></a>Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)
Если кэш является частью виртуальной сети, то к нему могут обращаться только клиенты в этой виртуальной сети. Поэтому следующие функции управления кэшем в данный момент не работают.

* Консоль Redis. Поскольку консоль Redis работает в локальном браузере, который обычно находится на компьютере разработчика, который не подключен к виртуальной сети, он не может подключиться к кэшу.


## <a name="use-expressroute-with-azure-cache-for-redis"></a>Использование ExpressRoute с кэшем Azure для Redis

Клиенты могут подключить канал [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к своей инфраструктуре виртуальной сети, расширяя таким образом свою локальную сеть в Azure. 

По умолчанию только что созданный канал ExpressRoute не выполняет принудительное туннелирование (объявление маршрута по умолчанию, 0.0.0.0/0) в виртуальной сети. В результате исходящие подключения к Интернету выполняются напрямую из виртуальной сети, а клиентские приложения могут подключаться к другим конечным точкам Azure, включая кэш Azure для Redis.

Однако распространенной конфигурацией клиента является использование принудительного туннелирования (объявление маршрута по умолчанию), что приводит к тому, что исходящий Интернет-трафик передается в локальный поток. Этот поток трафика прерывает подключение к кэшу Azure для Redis, если исходящий трафик затем блокируется локально, так что экземпляр кэша Azure для Redis не может связаться со своими зависимыми компонентами.

Чтобы устранить эту проблему, следует указать один или несколько определяемых пользователем маршрутов в подсети, которая содержит кэш Azure для Redis. Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.

При возможности рекомендуется использовать следующую конфигурацию:

* Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.
* Определяемый пользователем маршрут в подсети, содержащей кэш Azure для Redis, направляет трафик TCP/IP к диапазону адресов 0.0.0.0/0 в общедоступный Интернет, например определяя тип "Интернет" для следующего прыжка.

В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из кэша Azure для Redis.

Подключение к экземпляру кэша Azure для Redis из локального приложения с помощью ExpressRoute используется редко, так как оказывает отрицательное влияние на производительность (для повышения производительности клиенты кэша Azure для Redis должны находиться в том же регионе, что и кэш Azure для Redis).

>[!IMPORTANT] 
>Маршруты, определенные в UDR, **должны** быть достаточно конкретными, чтобы иметь приоритет над любыми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном ниже примере используется широкий диапазон адресов 0.0.0.0/0, и, таким образом, он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.

>[!WARNING]  
>Кэш Azure для Redis не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов неправильно перекрестно объявляются в пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра кэша Azure для Redis ошибочно принудительно туннелируются в локальную сетевую инфраструктуру клиента. Такой сетевой поток нарушает работу кэша Azure для Redis. Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.


Справочные сведения об определяемых пользователем маршрутах см. в этом [обзоре](../virtual-network/virtual-networks-udr-overview.md).

Дополнительные сведения об ExpressRoute см. в статье [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о кэше Azure для функций Redis.

* [Кэш Azure для уровней службы Redis Premium](cache-overview.md#service-tiers)

<!-- IMAGES -->

[redis-cache-vnet]: ./media/cache-how-to-premium-vnet/redis-cache-vnet.png

[redis-cache-vnet-ip]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-ip.png

[redis-cache-vnet-info]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-info.png
