---
title: Рабочий процесс архитектуры Windows Azure VM (ru) Документы Майкрософт
description: В этой статье содержится обзор процессов рабочего процесса при развертывании службы.
services: cloud-services
documentationcenter: ''
author: genlin
manager: dcscontentpm
editor: ''
tags: top-support-issue
ms.assetid: 9f2af8dd-2012-4b36-9dd5-19bf6a67e47d
ms.service: cloud-services
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: tbd
ms.date: 04/08/2019
ms.author: kwill
ms.openlocfilehash: 5dd57a87658554bf59acf5cee1b6daf67b8692b8
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "71162147"
---
#    <a name="workflow-of-windows-azure-classic-vm-architecture"></a>Рабочий процесс классической vM-архитектуры Windows Azure 
В этой статье приводится обзор процессов рабочего процесса, возникающих при развертывании или обновлении ресурса Azure, например виртуальной машины. 

> [!NOTE]
>В Azure предусмотрены две модели развертывания для создания ресурсов и работы с ними: модель Resource Manager и классическая модель. В этой статье рассматривается использование классической модели развертывания.

Следующая диаграмма представляет архитектуру ресурсов Azure.

![Лазурный рабочий процесс](./media/cloud-services-workflow-process/workflow.jpg)

## <a name="workflow-basics"></a>Основы рабочего процесса
   
**A**. RDFE / FFE — это путь коммуникации от пользователя к ткани. RDFE (RedDog Front End) — это открытый API, который является передним концом портала управления и API управления обслуживанием, таких как Visual Studio, Azure MMC и так далее.  Все запросы от пользователя проходят через RDFE. FFE (Fabric Front End) — это слой, который переводит запросы от RDFE в команды ткани. Все запросы от RDFE проходят через FFE для достижения ткани контроллеров.

**B**. Контроллер ткани отвечает за обслуживание и мониторинг всех ресурсов в центре обработки данных. Он общается с агентами-хостаями на ткани Os отправки информации, такой как версия Гостевой ОС, пакет услуг, конфигурация обслуживания, и состояние обслуживания.

**C**. Агент-хозяин живет на Хост-ОС и отвечает за настройку Гостевой ОС и общение с гостем-агентом (WindowsAzureGuestAgent) для обновления роли в направлении состояния цели и проверки сердцебиения с агентом гостя. Если агент-хозяин не получает ответа на сердцебиение в течение 10 минут, агент host перезапускает ОС для гостей.

**C2**. WaAppAgent отвечает за установку, настройку и обновление WindowsAzureGuestAgent.exe.

**D**.  WindowsAzureGuestAgent отвечает за следующее:

1. Настройка гостевой ОС, включая брандмауэр, ACL, ресурсы LocalStorage, пакет услуг и конфигурацию, а также сертификаты.
2. Настройка SID для учетной записи пользователя, под которым будет работать роль.
3. Сообщение статуса роли в ткани.
4. Запуск WaHostBootstrapper и мониторинг его, чтобы убедиться, что роль в состоянии цели.

**E**. WaHostBootstrapper отвечает за:

1. Чтение конфигурации роли и запуск всех соответствующих задач и процессов для настройки и выполнения роли.
2. Мониторинг всех своих детских процессов.
3. Повышение события StatusCheck в процессе размещения ролей.

**F**. IISConfigurator работает, если роль настроена как полная веб-роль IIS (она не будет работать для sDK 1.2 HWC ролей). Он отвечает за:

1. Запуск стандартных сервисов IIS
2. Настройка модуля перезаписи в конфигурации веб-страниц
3. Настройка AppPool для настроенной роли в модели обслуживания
4. Настройка регистрации IIS для отопарения в папку DiagnosticStore LocalStorage
5. Настройка разрешений и AcL
6. Веб-сайт находится в %roleroot%:'sitesroot'0, и AppPool указывает на это место для запуска IIS. 

**G**. Задачи запуска определяются образцом для подражания и запускаются WaHostBootstrapper. Задачи запуска могут быть настроены для асинхронного выполнения в фоновом режиме, и хост-загрузчик запустит задачу запуска, а затем продолжит выполнение других задач запуска. Задачи запуска также могут быть настроены для выполнения в режиме Simple (по умолчанию), в котором хост-загрузчик будет ждать завершения задачи, чтобы закончить работу и вернуть код выхода успеха (0), прежде чем перейти к следующему задаче запуска.

**H**. Эти задачи являются частью SDK и определяются как плагины в определении службы роли (.csdef). При расширении в запуск задач, **DiagnosticsAgent** и **RemoteAccessAgent** уникальны тем, что каждый из них определяет две задачи запуска, один регулярный и один, который имеет **/ блок-старт параметр.** Обычная задача запуска определяется как задача фонового запуска, чтобы она работала в фоновом режиме во время выполнения самой роли. Задача **запуска BlockStartup** определяется как простая задача запуска, так что WaHostBootstrapper ждет его выхода, прежде чем продолжить. Задача **/blockStartup** ждет, пока обычная задача завершится инициализацией, а затем выходит и позволяет хост-загрузочному механизму продолжить сядер. Это делается для того, чтобы диагностика и доступ к RDP можно было настроить до начала ролевых процессов (это делается через задачу /blockStartup). Это также позволяет диагностике и доступу RDP продолжать работать после того, как хост-загрузчик закончил задачи запуска (это делается через обычную задачу).

**Я**. WaWorkerHost — это стандартный процесс узла для обычных ролей работников. Этот процесс хоста содержит все DLL-адреса роли и код точки входа, такие как OnStart и Run.

**J**. WaWebHost — это стандартный процесс узлов для веб-ролей, если они настроены на использование SDK 1.2-совместимого хостефируемого web Core (HWC). Роли могут включить режим HWC, удалив элемент из определения службы (.csdef). В этом режиме все коды службы и DLL-режиме работают из процесса WaWebHost. IIS (w3wp) не используется, и в IIS Manager нет AppPools, поскольку IIS размещается внутри WaWebHost.exe.

**K**. WaIISHost — это процесс хоста для кода точки входа роли для веб-ролей, которые используют Full IIS. Этот процесс загружает первый DLL, который используется класс **RoleEntryPoint** и выполняет код из этого класса (OnStart, Run, OnStop). Любые события **RoleEnvironment** (такие как StatusCheck и Измененные), которые создаются в классе RoleEntryPoint, поднимаются в этом процессе.

**L**. W3WP — это стандартный рабочий процесс IIS, который используется, если роль настроена на использование полного IIS. Это работает AppPool, который настроен из IISConfigurator. Любые события RoleEnvironment (такие как StatusCheck и Измененные), которые создаются здесь, поднимаются в этом процессе. Обратите внимание, что события RoleEnvironment будут проводиться в обоих местах (WaIISHost и w3wp.exe), если вы подпишитесь на события в обоих процессах.

## <a name="workflow-processes"></a>Процессы рабочего процесса

1. Пользователь делает запрос, например, загружает файлы ".cspkg" и ".cscfg", сообщая ресурсу, чтобы остановить или сделать изменение конфигурации, и так далее. Это можно сделать через портал Azure или инструмент, который использует API управления обслуживанием, например функцию Visual Studio Publish. Этот запрос направляется в RDFE, чтобы выполнить всю работу, связанную с подпиской, а затем сообщить запрос в FFE. Остальные этапы рабочего процесса должны развернуть новый пакет и запустить его.
2. FFE находит правильный пул машин (на основе ввода клиента, например, группы сродства или географического местоположения плюс вход ные данные из ткани, такие как наличие машины) и общается с мастером контроллера ткани в этом пуле машин.
3. Контроллер ткани находит хост, который имеет доступные ядра процессора (или вращает новый хост). Пакет услуг и конфигурация копируются хосте, а контроллер ткани общается с агентом-хозяином на хост-ОС для развертывания пакета (настройка DIPs, портов, гостевой ОС и так далее).
4. Агент-хозяин запускает ОС для гостей и общается с агентом гостя (WindowsAzureGuestAgent). Хозяин посылает биения сердца к гостю, чтобы убедиться, что роль работает к своему состоянию цели.
5. WindowsAzureGuestAgent настраивает гостевую ОС (брандмауэр, ACLs, LocalStorage и так далее), копирует новый файл конфигурации XML на c: 'Config, а затем запускает процесс WaHostBootstrapper.
6. Для полного IIS веб-ролей, WaHostBootstrapper начинает IISConfigurator и говорит ему, чтобы удалить любые существующие AppPools для веб-роли из IIS.
7. WaHostBootstrapper читает задачи **запуска** с E: 'RoleModel.xml и начинает выполнять задачи запуска. WaHostBootstrapper ждет, пока все простые задачи запуска закончили и вернулся "успех" сообщение.
8. Для полного IIS веб-ролей, WaHostBootstrapper говорит IISConfigurator настроить IIS `E:\Sitesroot\<index>`AppPool и указывает на сайт, где `<index>` 0 на основе индекса в число элементов, определенных `<Sites>` для службы.
9. WaHostBootstrapper запустит процесс хостаста в зависимости от типа роли:
    1. **Рабочая роль**: Запущен waWorkerHost.exe. WaHostBootstrapper выполняет метод OnStart() После его возвращения WaHostBootstrapper начинает выполнять метод Run() и одновременно отмечает роль готовой и помещает ее в вращение балансоуправляемости нагрузки (если определены inputEndpoints). WaHostBootsrapper затем переходит в цикл проверки статуса роли.
    1. **SDK 1.2 HWC Веб Роль**: WaWebHost запущен. WaHostBootstrapper выполняет метод OnStart() После его возвращения WaHostBootstrapper начинает выполнять метод Run() и одновременно отмечает роль готовой и помещает ее в вращение балансоуправляемого баланса нагрузки. WaWebHost выдает запрос на разминку (GET /do.rd_runtime_init). Все веб-запросы отправляются на waWebHost.exe. WaHostBootsrapper затем переходит в цикл проверки статуса роли.
    1. **Полная веб-роль IIS:** aIISHost запущен. WaHostBootstrapper выполняет метод OnStart() После его возвращения он начинает выполнять метод Run() и одновременно отмечает роль готовой и помещает ее в вращение балансоилизатора нагрузки. WaHostBootsrapper затем переходит в цикл проверки статуса роли.
10. Входящие веб-запросы на веб-роль Full IIS вызывают IIS для начала процесса W3WP и обслуживания запроса, так же, как это было бы в предварительной среде IIS.

## <a name="log-file-locations"></a>Местоположение файлов журнала

**WindowsAzureGuestAgent**

- C: «Входы»AppAgentRuntime.Log.  
Этот журнал содержит изменения в службе, включая запуски, остановки и новые конфигурации. Если служба не изменяется, можно ожидать больших пробелов во времени в этом файле журнала.
- C: «Логы»WaAppAgent.Log.  
Этот журнал содержит обновления статуса и уведомления об сердцебиении и обновляется каждые 2-3 секунды.  Этот журнал содержит историческое представление о состоянии экземпляра и покажет вам, когда экземпляр не находился в состоянии готовности.
 
**WaHostBootstrapper**

`C:\Resources\Directory\<deploymentID>.<role>.DiagnosticStore\WaHostBootstrapper.log`
 
**WaWebHost**

`C:\Resources\Directory\<guid>.<role>\WaWebHost.log`
 
**Ваисхост**

`C:\Resources\Directory\<deploymentID>.<role>\WaIISHost.log`
 
**IISConfigurator**

`C:\Resources\Directory\<deploymentID>.<role>\IISConfigurator.log`
 
**Журналы IIS**

`C:\Resources\Directory\<guid>.<role>.DiagnosticStore\LogFiles\W3SVC1`
 
**Журналы событий Windows**

`D:\Windows\System32\Winevt\Logs`
 



