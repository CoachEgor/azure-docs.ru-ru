---
title: Интеграция управления API Azure в Azure Application Insights | Документы Майкрософт
description: Сведения о просмотре и записи в журнал для событий управления API Azure в Azure Application Insights.
services: api-management
documentationcenter: ''
author: mikebudzynski
manager: erikre
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 06/20/2018
ms.author: apimpm
ms.openlocfilehash: ae467e3def65d446a8c331c4f15033b4c01886ae
ms.sourcegitcommit: 3fa4384af35c64f6674f40e0d4128e1274083487
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2019
ms.locfileid: "71219493"
---
# <a name="how-to-integrate-azure-api-management-with-azure-application-insights"></a>Интеграция управления API Azure в Azure Application Insights

Управление API Azure может быть легко интегрировано в Azure Application Insights. Azure Application Insights — это расширяемая служба управления производительностью приложений (APM), предназначенная для веб-разработчиков, создающих приложения и управляющих ими на нескольких платформах. В этом руководстве описываются все этапы этой интеграции и стратегии для снижения влияния интеграции на производительность вашего экземпляра службы управления API.

## <a name="prerequisites"></a>Предварительные требования

Для выполнения действий, описанных в этом руководстве, вам потребуется экземпляр службы управления API. Если у вас его нет, выполните действия, указанные в [этом руководстве](get-started-create-service-instance.md).

## <a name="create-an-azure-application-insights-instance"></a>Создание экземпляра Azure Application Insights

Перед использованием Azure Application Insights необходимо создать экземпляр службы.

1. Откройте **портал Azure** и перейдите к **Application Insights**.  
    ![Создание App Insights](media/api-management-howto-app-insights/apim-app-insights-instance-1.png)  
2. Щелкните **+ Добавить**.  
    ![Создание App Insights](media/api-management-howto-app-insights/apim-app-insights-instance-2.png)  
3. Заполните форму. В качестве **Типа приложения** выберите **Универсальный**.
4. Нажмите кнопку **Создать**.

## <a name="create-a-connection-between-azure-application-insights-and-azure-api-management-service-instance"></a>Создание подключения между Azure Application Insights и экземпляром службы управления API Azure

1. На **портале Azure** перейдите к экземпляру **службы управления API Azure**.
2. Выберите **Application Insights** в меню слева.
3. Щелкните **+ Добавить**.  
    ![Средство ведения журнала App Insights](media/api-management-howto-app-insights/apim-app-insights-logger-1.png)  
4. Выберите ранее созданный экземпляр **Application Insights** и укажите краткое описание.
5. Нажмите кнопку **Создать**.
6. Только что вы создали средство ведения журнала Azure Application Insights с ключом инструментирования. Оно должно появиться в списке.  
    ![Средство ведения журнала App Insights](media/api-management-howto-app-insights/apim-app-insights-logger-2.png)  

> [!NOTE]
> Фактически сущность [средства ведения журнала](https://docs.microsoft.com/rest/api/apimanagement/2019-01-01/logger/createorupdate) создается в экземпляре службы управления API с ключом инструментирования экземпляра Application Insights.

## <a name="enable-application-insights-logging-for-your-api"></a>Включение ведения Application Insights для вашего API

1. На **портале Azure** перейдите к экземпляру **службы управления API Azure**.
2. Выберите **API** в меню слева.
3. Выберите свой API, в данном случае **Demo Conference API**.
4. Перейдите на вкладку **Параметры** на верхней панели.
5. Прокрутите содержимое вкладки вниз до раздела **Журналы диагностики**.  
    ![Средство ведения журнала App Insights](media/api-management-howto-app-insights/apim-app-insights-api-1.png)  
6. Установите флажок **Включить**.
7. Выберите подключенное средство ведения журнала в раскрывающемся списке **Назначение**.
8. Укажите значение **100** в поле **Выборка (%)** и установите флажок **Всегда записывать ошибки в журнал**.
9. Нажмите кнопку **Сохранить**.

> [!WARNING]
> Если переопределить значение **0** по умолчанию в поле **First bytes of body** (Первые байты тела запроса), можно существенно снизить производительность интерфейсов API.

> [!NOTE]
> Фактически сущность [Диагностика](https://docs.microsoft.com/rest/api/apimanagement/2019-01-01/diagnostic/createorupdate) с именем applicationinsights создается на уровне API.

| Имя параметра                        | Тип значения                        | Описание                                                                                                                                                                                                                                                                                                                                      |
|-------------------------------------|-----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Включить                              | boolean                           | Указывает, включено ли ведение журнала для данного API.                                                                                                                                                                                                                                                                                                |
| Destination                         | Средство ведения журнала Azure Application Insights | Указывает используемое средство ведения журнала Azure Application Insights                                                                                                                                                                                                                                                                                           |
| Выборка (%)                        | decimal                           | Значения от 0 до 100 (в процентах). <br/> Указывает, какой процент запросов будет записываться в журналы в Azure Application Insights. Выборка в 0 % означает, что в журнал не будет записан ни один запрос, а выборка в 100 % — что в журнал будут записаны все запросы. <br/> Этот параметр используется для снижения влияния на производительность записываемых в журнал запросов Azure Application Insights (см. раздел ниже). |
| Всегда записывать ошибки в журнал                   | boolean                           | Если этот параметр установлен, то все ошибки будут записываться в журналы Azure Application Insights независимо от значения параметра **Выборка**.                                                                                                                                                                                                                  |
| Основные параметры: Заголовки              | list                              | Задает заголовки для запросов и ответов, которые будут записываться в журналы Azure Application Insights.  По умолчанию: заголовки не записываются в журналы.                                                                                                                                                                                                             |
| Основные параметры: Первый байт в теле  | integer                           | Задает количество первых байт текста для запросов и ответов, которые будут записываться в журналы Azure Application Insights.  По умолчанию: текст не записывается в журналы.                                                                                                                                                                                                    |
| Расширенные параметры: Verbosity         |                                   | Задает уровень детализации. В журнал будут занесены только пользовательские трассировки с более высоким уровнем серьезности. Значение по умолчанию: Об.                                                                                                                                                                                                                               |
| Расширенные параметры: Запрос к интерфейсу  |                                   | Указывает, будут ли *запросы клиента* записываться в журналы в Azure Application Insights и как они будут записываться. *Запросы клиента* — это запросы, поступающие к службе управления API Azure.                                                                                                                                                                        |
| Расширенные параметры: Ответ интерфейса |                                   | Указывает, будут ли *ответы клиента* записываться в журналы в Azure Application Insights и как они будут записываться. *Ответы клиента* — это ответы, возвращаемые службой управления API Azure.                                                                                                                                                                   |
| Расширенные параметры: Запрос к серверу   |                                   | Указывает, будут ли *запросы сервера* записываться в журналы в Azure Application Insights и как они будут записываться. *Запросы сервера* — это запросы, поступающие от службы управления API Azure.                                                                                                                                                                        |
| Расширенные параметры: Ответ сервера  |                                   | Указывает, будут ли *ответы сервера* записываться в журналы в Azure Application Insights и как они будут записываться. *Ответы сервера* — это ответы, поступающие к службе управления API Azure.                                                                                                                                                                       |

> [!NOTE]
> Вы можете указать средства ведения журнала на различных уровнях — одно средство ведения журнала для одного API или одно средство ведения журнала для всех API.
>  
> Если указываются оба средства ведения журнала одновременно, используется следующий механизм:
> + если это различные средства ведения журнала, будут использованы оба средства ведения журнала (мультиплексирование журналов);
> + если это же одни и те же средства ведения журнала, но с различными параметрами, то средство ведения журнала для одного API (с более высоким уровнем детализации) переопределит средство ведения журнала для всех API.

## <a name="what-data-is-added-to-azure-application-insights"></a>Какие данные передаются в Azure Application Insights

Azure Application Insights получает следующие данные:

+ Элемент данных телеметрии *Запрос* для каждого входящего запроса (*запрос клиента*, *ответ клиента*);
+ Элемент данных телеметрии *Зависимость* для каждого запроса, направляемого в службу сервера (*запрос сервера*, *ответ сервера*);
+ Элемент данных телеметрии *Исключение* для каждого неудачного запроса.

К неудачным запросам относятся запросы, которые:

+ завершились сбоем из-за закрытия подключения клиента;
+ привели к возникновению состояния *on-error* политик API;
+ возвратили код ответа HTTP 4xx или 5xx.

## <a name="performance-implications-and-log-sampling"></a>Влияние выборок журналов на производительность

> [!WARNING]
> Запись всех событий может привести к серьезному снижению производительности в зависимости от частоты входящих запросов.

По результатам внутренних нагрузочных тестов включение этой функции приводит к снижению пропускной способности на 40–50 %, если частота запросов превышает 1000 запросов в секунду. Служба Azure Application Insights предназначена для оценки влияния на производительность с помощью статистического анализа. Она не может использоваться в качестве системы аудита и не предназначена для записи в журналы всех запросов для интенсивно используемых API.

Количество запросов, записываемых в журналы, можно изменить с помощью параметра **Выборка** (см. выше). Значение 100 % означает, что записываются все запросы, а 0 % — что не записывается ни один запрос. **Выборка** позволяет сократить объем данных телеметрии, эффективно избежав существенного снижения производительности, с сохранением преимуществ ведения журналов.

Пропуск заголовков и текста запросов также позволяет уменьшить отрицательное влияние на производительность.

## <a name="video"></a>Видео

> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE2pkXv]
>
>

## <a name="next-steps"></a>Следующие шаги

+ Дополнительные сведения об [Azure Application Insights](https://docs.microsoft.com/azure/application-insights/).
+ См. раздел [ведение журналов с помощью Центров событий Azure](api-management-howto-log-event-hubs.md).
