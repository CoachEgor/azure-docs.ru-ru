---
title: Как использовать управление API Azure с виртуальными сетями
description: Узнайте, как настроить подключение к виртуальной сети в управлении API Azure и обращаться к веб-службам через него.
services: api-management
documentationcenter: ''
author: vlvinogr
manager: erikre
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/01/2019
ms.author: apimpm
ms.openlocfilehash: 532c1051522410c496fb3809c06c7e3a74340adb
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "66141440"
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a>Как использовать управление API Azure с виртуальными сетями
Виртуальные сети Azure позволяют размещать любые ресурсы Azure в сети, недоступной из Интернета, доступом к которой управляете вы сами. Эти сети можно подключать к локальным сетям с помощью различных технологий VPN. Начать изучение виртуальных сетей Azure лучше всего со статьи [Что такое виртуальная сеть Azure?](../virtual-network/virtual-networks-overview.md).

Службу управления API Azure можно развернуть в пределах виртуальной сети, обеспечив доступ к серверным службам в этой сети. Портал разработчика и шлюз API можно настроить для предоставления доступа как из Интернета, так и только в пределах виртуальной сети.

> [!NOTE]
> Служба управления API Azure поддерживает классические виртуальные сети и виртуальные сети Azure Resource Manager.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

[!INCLUDE [premium-dev.md](../../includes/api-management-availability-premium-dev.md)]

## <a name="prerequisites"></a>Технические условия

Чтобы выполнить действия, описанные в этой статье, необходимо следующее.

+ Активная подписка Azure.

    [!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

+ Экземпляр APIM. Дополнительные сведения см. в статье о [создании экземпляра управления API Azure](get-started-create-service-instance.md).

## <a name="enable-vpn"> </a>Включение подключения к виртуальной сети

### <a name="enable-vnet-connectivity-using-the-azure-portal"></a>Активация возможности подключения к виртуальной сети с помощью портала Azure

1. Перейдите к экземпляру APIM на [портале Azure](https://portal.azure.com/).
2. Щелкните **Виртуальная сеть**.
3. Настройте развертывание экземпляра управления API внутри виртуальной сети.

    ![Меню "Виртуальная сеть" для управления API][api-management-using-vnet-menu]
4. Выберите нужный тип доступа.

   * **Внешний**: шлюз управления API и портал разработчика доступны из общедоступного Интернета через внешнюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

     ![Общедоступный пиринг][api-management-vnet-public]

   * **Внутренний**: шлюз управления API и портал разработчика доступны только из виртуальной сети через внутреннюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

     ![Частный пиринг][api-management-vnet-private]

     Будет показан список всех регионов, где предоставляется служба управления API. Выберите виртуальную сеть и подсеть для каждого региона. Список заполняется классическими виртуальными сетями и виртуальными сетями Resource Manager, имеющимися в подписках Azure, которые настроены в настраиваемом регионе.

     > [!NOTE]
     > **Конечная точка службы** на схеме выше включает в себя конечную точку шлюза или прокси-сервера, портала Azure, портала разработчика, GIT и конечную точку для прямого управления.
     > На схеме выше **конечная точка управления** размещается в службе для управления конфигурацией через портал Azure и PowerShell.
     > Кроме того, обратите внимание, что несмотря на то, что на схеме показаны IP-адреса различных конечных точек, служба управления API отвечает **только** на настроенных именах узлов.

     > [!IMPORTANT]
     > При развертывании экземпляра службы управления API Azure в виртуальной сети Resource Manager служба должна находиться в выделенной подсети, в которой нет других ресурсов, кроме экземпляров управления API Azure. Если попытаться развернуть экземпляр управления API Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, это приведет к сбою.
     >

     ![Выбор VPN][api-management-setup-vpn-select]

5. Нажмите кнопку **Сохранить** в верхней панели навигации.
6. Нажмите кнопку **применить конфигурацию сети** в верхней панели навигации.

> [!NOTE]
> Виртуальный IP-адрес экземпляра управления API будет изменяться при каждом включении или отключении виртуальной сети.
> Кроме того, виртуальный IP-адрес будет изменяться при изменении типа доступа для управления API с **внешнего** на **внутренний** или наоборот.
>

> [!IMPORTANT]
> Если удалить службу управления API из виртуальной сети или изменить виртуальную сеть, в которой она развернута, ранее использовавшаяся виртуальная сеть может быть заблокирована максимум на два часа. В этот период вы не сможете удалить виртуальную сеть или развернуть в ней новый ресурс.

## <a name="enable-vnet-powershell"> </a>Активация подключения к виртуальной сети с помощью командлетов PowerShell
Подключение к виртуальной сети можно также активировать с помощью командлетов PowerShell.

* **Создание службы управления API в виртуальной сети**. Используйте командлет [New AzApiManagement](/powershell/module/az.apimanagement/new-azapimanagement) для создания службы управления API Azure внутри виртуальной сети.

* **Развертывание существующей службы управления API в виртуальной сети**. Используйте командлет [AzApiManagementRegion обновления](/powershell/module/az.apimanagement/update-azapimanagementregion) для перемещения существующей службы управления API Azure в виртуальной сети.

## <a name="connect-vnet"> </a>Подключение к веб-службе, размещенной в виртуальной сети
После подключения службы управления API к виртуальной сети обращение к размещенным в ней внутренним службам ничем не будет отличаться от обращения к общедоступным службам. Просто введите локальный IP-адрес или имя узла (если для виртуальной сети настроен DNS-сервер) веб-службы в поле **URL-адрес веб-службы** при создании нового API или редактировании существующего.

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <a name="network-configuration-issues"> </a>Распространенные проблемы конфигурации сети
Ниже приведен список распространенных ошибок конфигурации, возникающих при развертывании службы управления API в виртуальной сети.

* **Настройка пользовательского DNS-сервера**. Служба управления API зависит от нескольких служб Azure. Если служба управления API размещается в виртуальной сети, в которой используется пользовательский DNS-сервер, она должна разрешить имена узлов этих служб Azure. Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера. Для справки ниже приведена таблица портов, а также другие требования к сети.

> [!IMPORTANT]
> Если вы планируете использовать настраиваемые DNS-серверы для виртуальной сети, настройте их **перед** развертыванием службы управления API в этой сети. В противном случае службу управления API необходимо обновлять каждый раз при изменении DNS-серверов с помощью [операции применения конфигурации сети](https://docs.microsoft.com/rest/api/apimanagement/ApiManagementService/ApplyNetworkConfigurationUpdates).

* **Порты, необходимые для управления API**. Входящим и исходящим трафиком в подсети, в которой развернута служба управления API, можно управлять с помощью [группы безопасности сети][Network Security Group]. Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и даже стать недоступной. Блокировка одного или нескольких из этих портов является одной из распространенных проблем неправильной конфигурации при использовании управления API в виртуальной сети.

<a name="required-ports"> </a> Когда экземпляр службы управления API размещается в виртуальной сети, используются порты в следующей таблице.

| Исходные и конечные порты | Направление          | Транспортный протокол |   [Теги служб](../virtual-network/security-overview.md#service-tags) <br> Ресурс и назначение   | Назначение (*)                                                 | Тип виртуальной сети |
|------------------------------|--------------------|--------------------|---------------------------------------|-------------------------------------------------------------|----------------------|
| * / 80, 443                  | Входящий трафик            | TCP                | INTERNET — VIRTUAL_NETWORK            | Подключения клиентов к службе управления API                      | Внешние             |
| * / 3443                     | Входящий трафик            | TCP                | ApiManagement / VIRTUAL_NETWORK       | Конечная точка управления для портала Azure и PowerShell         | Внешний и внутренний  |
| * / 80, 443                  | Исходящие           | TCP                | VIRTUAL_NETWORK / Storage             | **Зависимость от службы хранилища Azure**                             | Внешний и внутренний  |
| * / 80, 443                  | Исходящие           | TCP                | VIRTUAL_NETWORK / AzureActiveDirectory | Приложения Azure Active Directory (где применяется)                   | Внешний и внутренний  |
| * / 1433                     | Исходящие           | TCP                | VIRTUAL_NETWORK / SQL                 | **Доступ к конечным точкам службы SQL Azure**                           | Внешний и внутренний  |
| * / 5672                     | Исходящие           | TCP                | VIRTUAL_NETWORK / EventHub            | Зависимость для политики ведения журнала концентратора событий и агента мониторинга | Внешний и внутренний  |
| * / 445                      | Исходящие           | TCP                | VIRTUAL_NETWORK / Storage             | Зависимость для общей папки Azure для GIT                      | Внешний и внутренний  |
| * / 1886                     | Исходящие           | TCP                | VIRTUAL_NETWORK — INTERNET            | Необходимо опубликовать сведения о работоспособности в службе "Работоспособность ресурсов"          | Внешний и внутренний  |
| * / 443                     | Исходящие           | TCP                | VIRTUAL_NETWORK / AzureMonitor         | Публикация журналов диагностики и метрик                        | Внешний и внутренний  |
| * / 25                       | Исходящие           | TCP                | VIRTUAL_NETWORK — INTERNET            | Подключение к SMTP-ретранслятору для отправки сообщений электронной почты                    | Внешний и внутренний  |
| * / 587                      | Исходящие           | TCP                | VIRTUAL_NETWORK — INTERNET            | Подключение к SMTP-ретранслятору для отправки сообщений электронной почты                    | Внешний и внутренний  |
| * / 25028                    | Исходящие           | TCP                | VIRTUAL_NETWORK — INTERNET            | Подключение к SMTP-ретранслятору для отправки сообщений электронной почты                    | Внешний и внутренний  |
| * / 6381 - 6383              | Входящий и исходящий | TCP                | VIRTUAL_NETWORK — VIRTUAL_NETWORK     | Доступ к экземплярам кэша Azure для Redis между экземплярами RoleInstance          | Внешний и внутренний  |
| * / *                        | Входящий трафик            | TCP                | AZURE_LOAD_BALANCER / VIRTUAL_NETWORK | Подсистема балансировки нагрузки инфраструктуры Azure                          | Внешний и внутренний  |

>[!IMPORTANT]
> Порты, для которых *назначение* выделено **полужирным**, требуются для успешного развертывания службы управления API. Но блокировка остальных портов приведет к снижению производительности при использовании и отслеживании работающей службы.

+ **Функции SSL.** Чтобы разрешить создание и проверку цепочки сертификатов SSL, службе управления API требуется исходящее сетевое подключение к узлам ocsp.msocsp.com, mscrl.microsoft.com и crl.microsoft.com. Эта зависимость не является обязательной, если любой сертификат, передаваемый в службу управления API, содержит полную цепочку до корневого ЦС.

+ **Доступ к DNS.** Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами. Если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, этот сервер должен быть доступен из подсети, в которой размещена служба управления API.

+ **Наблюдение за работоспособностью и метриками.** Исходящее сетевое подключение к конечным точкам мониторинга Azure, которое разрешается в следующих доменах.

    | Среда Azure | Конечные точки                                                                                                                                                                                                                                                                                                                                                              |
    |-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | Azure Public      | <ul><li>prod.warmpath.msftcloudes.com;</li><li>shoebox2.metrics.nsatc.net;</li><li>prod3.metrics.nsatc.net;</li><li>prod3-black.prod3.metrics.nsatc.net;</li><li>prod3-red.prod3.metrics.nsatc.net.</li><li>prod.warm.ingestion.msftcloudes.com</li><li>`azure region`.warm.ingestion.msftcloudes.com где `East US 2` является eastus2.warm.ingestion.msftcloudes.com</li></ul> |
    | Azure Government  | <ul><li>fairfax.warmpath.usgovcloudapi.net;</li><li>shoebox2.metrics.nsatc.net;</li><li>prod3.metrics.nsatc.net.</li></ul>                                                                                                                                                                                                                                                |
    | Azure для Китая       | <ul><li>mooncake.warmpath.chinacloudapi.cn;</li><li>shoebox2.metrics.nsatc.net;</li><li>prod3.metrics.nsatc.net.</li></ul>                                                                                                                                                                                                                                                |

+ **Службы SMTP-ретрансляции.** Исходящие сетевые подключения для ретрансляции SMTP, который разрешается в контексте `smtpi-co1.msn.com`, `smtpi-ch1.msn.com`, `smtpi-db3.msn.com`, `smtpi-sin.msn.com` и `ies.global.microsoft.com`

+ **CAPTCHA на портале разработчика**. Исходящее сетевое подключение для CAPTCHA на портале разработчика, которое разрешается в узле `client.hip.live.com`.

+ **Портал Azure Diagnostics.** Включает поток журналов диагностики на портале Azure при использовании расширения управления API внутри виртуальной сети; требуется исходящий доступ к `dc.services.visualstudio.com` на порте 443. Это помогает в устранении неполадок, которые могут возникнуть при использовании расширения.

+ **Принудительное туннелирование трафика брандмауэра в локальной среде, с помощью Express Route или сетевой виртуальный модуль**: В типовой клиентской конфигурации — определить собственный основной маршрут (0.0.0.0/0), который направляет весь трафик из службы управления API делегировать подсети, проходят через брандмауэр подключения к локальным или виртуальным сетевым устройством. Этот поток трафика неизменно прерывает подключение к службе управления API Azure, так как исходящий трафик или блокируется локально, или преобразуется с помощью NAT в нераспознаваемый набор адресов, которые больше не относятся к различным конечным точкам Azure. Решение необходимо сделать несколько вещей:

  * Включите конечные точки службы в подсети, в которой развернута служба управления API. [Конечные точки службы] [ ServiceEndpoints] необходимо включить для Azure Sql, службе хранилища Azure, концентратору событий Azure и служебной шины Azure. Включение конечных точек, непосредственно из службы управления API позволяет использовать в магистральной сети Microsoft Azure, предоставляя оптимальную маршрутизацию трафика службы делегированного подсети, к этим службам. Если вы используете конечные точки службы с Принудительное туннелирование управления Api, указанных выше служб Azure, трафик не будет принудительно туннелируется. Другие, принудительно трафика зависимостей службы управления API туннелируется и не может быть утерян или службе управления API будет работать неправильно.
    
  * Все управления плоскости Интернет-трафик для конечной точки управления в службе управления API направляются через определенный набор входящих IP-адресов размещенной службой управления API. Когда трафик принудительным туннелированием ответы не сопоставляет симметрично обратно в эти входящие исходные IP-адреса. Для преодоления ограничений, нам нужно добавить следующие определяемые пользователем маршруты ([определяемые пользователем маршруты][UDRs]) для направления трафика обратно в Azure по настройке этих маршрутов, чтобы «Интернет». Набор входящих IP-адресов для контроля трафика выглядит следующим образом:
    
    > 13.84.189.17/32, 13.85.22.63/32, 23.96.224.175/32, 23.101.166.38/32, 52.162.110.80/32, 104.214.19.224/32, 13.64.39.16/32, 40.81.47.216/32, 51.145.179.78/32, 52.142.95.35/32, 40.90.185.46/32, 20.40.125.155/32

  * Для других зависимостей службы управления API, которые принудительно туннелируются должно быть возможность разрешить имя узла и подключиться к конечной точке. К ним относятся
      - Мониторинг работоспособности и метрик
      - Портал Azure Diagnostics
      - Службы ретрансляции SMTP
      - Портал разработчиков CAPTCHA

## <a name="troubleshooting"> </a>Устранение неполадок
* **Начальная настройка.** Если первоначальное развертывание службы управления API в подсети завершится неудачно, попробуйте сначала развернуть виртуальную машину в той же подсети. После этого подключитесь к удаленному рабочему столу на этой виртуальной машине и проверьте наличие связи хотя бы с одним экземпляром каждого из ресурсов в подписке Azure, перечисленных ниже.
    * Большой двоичный объект хранилища Azure
    * Базы данных SQL Azure
    * Таблица хранилища Azure

  > [!IMPORTANT]
  > Проверив подключение, обязательно удалите все ресурсы, развернутые в подсети, прежде чем развертывать в этой подсети службу управления API.

* **Добавочные операции обновления.** При внесении изменений в вашей сети, см. [NetworkStatus API](https://docs.microsoft.com/rest/api/apimanagement/networkstatus), чтобы убедиться, что служба управления API не потерял доступ к критически важным ресурсам, которых она зависит. Состояние подключения должно обновляться каждые 15 минут.

* **Ссылки для перехода на ресурсы.** При развертывании в подсеть виртуальной сети, созданной с помощью модели Resource Manager, API управления резервирует эту подсеть, создавая ссылку для перехода на ресурс. Если эта подсеть уже содержит ресурс другого поставщика, развертывание **завершится ошибкой**. Аналогично, если вы перемещаете службу управления API в другую подсеть или удаляете ее, мы удаляем соответствующую ссылку для перехода на ресурс.

## <a name="subnet-size"></a>Требования к размеру подсети
Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)

Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр службы управления API в подсети использует два IP-адреса на единицу SKU уровня "Премиум" или один IP-адрес на SKU уровня "Разработка". Каждый экземпляр резервирует дополнительный IP-адрес для внешней подсистемы балансировки нагрузки. При развертывании во внутренней виртуальной сети требуется дополнительный IP-адрес для внутренней подсистемы балансировки нагрузки.

Согласно приведенным выше расчетам минимальный размер подсети, в котором можно развернуть службы управления API — / 29, которая предоставляет три IP-адреса.

## <a name="routing"> </a> Маршрутизация
+ Чтобы обеспечить доступ ко всем конечным точкам службы, резервируется общедоступный IP-адрес для подсистемы балансировки нагрузки.
+ Для доступа к ресурсам в пределах виртуальной сети используется выделенный IP-адрес из диапазона подсети, а за пределами этой сети — общедоступный виртуальный IP-адрес.
+ Общедоступный IP-адрес для балансировки нагрузки можно узнать в колонке "Обзор и основные сведения" на портале Azure.

## <a name="limitations"> </a>Ограничения
* Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.
* Эта подсеть и служба управления API должны находиться в одной подписке.
* Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.
* Если служба управления API развернута в нескольких регионах в режиме внутренней виртуальной сети, пользователи должны самостоятельно настроить балансировку нагрузки, так как они отвечают за маршрутизацию.
* Подключение от ресурса, находящегося в пиринговой виртуальной сети в другом регионе, к службе управления API во внутреннем режиме невозможно из-за ограничений платформы. Дополнительные сведения см. в разделе [Требования и ограничения](../virtual-network/virtual-network-manage-peering.md#requirements-and-constraints).


## <a name="related-content"> </a>Связанная информация
* [Подключение типа "сеть — сеть" и многосайтовое подключение (через VPN-туннель IPsec/IKE)](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [Подключение виртуальных сетей из различных моделей развертывания с использованием PowerShell](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [Как использовать инспектор API для трассировки вызовов в службе управления API Azure](api-management-howto-api-inspector.md)
* [Виртуальная сеть Azure: часто задаваемые вопросы](../virtual-network/virtual-networks-faq.md)
* [Теги служб](../virtual-network/security-overview.md#service-tags)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-internal.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-external.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/security-overview.md
[ServiceEndpoints]: ../virtual-network/virtual-network-service-endpoints-overview.md
[ServiceTags]: ../virtual-network/security-overview.md#service-tags
