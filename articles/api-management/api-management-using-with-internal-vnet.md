---
title: Используйте управление API Azure с внутренними виртуальными сетями
titleSuffix: Azure API Management
description: Узнайте, как установить и настроить управление API Azure для внутренней виртуальной сети
services: api-management
documentationcenter: ''
author: vladvino
manager: kjoshi
editor: ''
ms.assetid: dac28ccf-2550-45a5-89cf-192d87369bc3
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 07/31/2019
ms.author: apimpm
ms.openlocfilehash: 6054c595bca26dc2a0432c53369a60a61e3efde0
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76841869"
---
# <a name="using-azure-api-management-service-with-an-internal-virtual-network"></a>Использование службы управления API Azure совместно с внутренней виртуальной сетью
Служба управления API Azure в сочетании с виртуальными сетями Azure позволяет работать с интерфейсами API, которые недоступны из Интернета. Подключение можно создать с применением разных технологий VPN. Управление API можно развернуть в виртуальной сети в одном из двух основных режимов:
* External
* Внутренние

Когда API Management развертывается во внутреннем режиме виртуальной сети, все конечные точки службы (прокси-шлюз, портал разработчиков, прямое управление и Git) видны только в виртуальной сети, к которым вы управляете доступом. Ни одна из конечных точек служб не регистрируется на общедоступных DNS-серверах.

> [!NOTE]
> Поскольку нет записей DNS для конечных точек службы, эти конечные точки не будут доступны до тех пор, пока [DNS](#apim-dns-configuration) не будет настроен для виртуальной сети.

Используя управление API во внутреннем режиме, вы можете реализовать следующие сценарии:

* предоставлять третьим лицам защищенный доступ к API, размещенным в частном центре обработки данных, с помощью VPN-подключений типа "сеть — сеть" или Azure ExpressRoute;
* создать гибридное облачное развертывание, предоставляя единый шлюз для облачных и локально размещенных API-интерфейсов;
* управлять API-интерфейсами, размещенными в нескольких географических расположениях, через одну общую конечную точку шлюза.

[!INCLUDE [premium-dev.md](../../includes/api-management-availability-premium-dev.md)]

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, необходимо следующее.

+ **Активная подписка Azure**.

    [!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

+ **Экземпляр Azure API Management.** Дополнительные сведения см. в статье о [создании экземпляра управления API Azure](get-started-create-service-instance.md).
+ При развертывании службы управления API в виртуальной сети используется [список портов,](./api-management-using-with-vnet.md#required-ports) и его необходимо открывать. 

## <a name="creating-an-api-management-in-an-internal-virtual-network"></a><a name="enable-vpn"> </a>Создание управления API во внутренней виртуальной сети
Служба управления API во внутренней виртуальной сети размещается за [внутренним балансером нагрузки (классическим).](https://docs.microsoft.com/azure/load-balancer/load-balancer-get-started-ilb-classic-cloud) Это единственный доступный вариант, который не может быть изменен.

### <a name="enable-a-virtual-network-connection-using-the-azure-portal"></a>Настройка подключения к виртуальной сети с помощью портала Azure

1. Перейдите к экземпляру управления API Azure на [портале Azure](https://portal.azure.com/).
2. Выберите **Виртуальную сеть**.
3. Укажите, что развертывание экземпляра управления API выполняется внутри виртуальной сети.

    ![Меню для настройки управления API Azure во внутренней виртуальной сети][api-management-using-internal-vnet-menu]

4. Нажмите кнопку **Сохранить**.

После успешного развертывания на лезвии обзора следует видеть **частный** виртуальный IP-адрес и **общедоступный** виртуальный IP-адрес службы управления API. **Частный** виртуальный IP-адрес представляет собой сбалансированный IP-адрес из `gateway`нутри `portal` `management` aPI Management делегировал подсеть, `scm` по которой можно получить доступ к конечным точкам. **Публичный** виртуальный IP-адрес используется **только** для управления трафиком самолета в конечную точку `management` над портом 3443 и может быть заблокирован в сервисный тег [ApiManagement.][ServiceTags]

![Панель мониторинга службы управления API, демонстрирующая настроенную внутреннюю виртуальную сеть][api-management-internal-vnet-dashboard]

> [!NOTE]
> Консоль тестирования, доступная на портале Azure, не будет работать для **внутренней** развернутой службы виртуальной сети, так как URL-адрес шлюза не зарегистрирован в общедоступной службе DNS. Вместо этого следует использовать консоль тестирования, доступную на **портале разработчика**.

### <a name="enable-a-virtual-network-connection-by-using-powershell-cmdlets"></a>Настройка подключения к виртуальной сети с помощью командлетов PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Вы можете настроить подключение к виртуальной сети с помощью командлетов PowerShell.

* Создайте службу управления API внутри виртуальной сети: используйте cmdlet [New-AzApiManagement](/powershell/module/az.apimanagement/new-azapimanagement) для создания службы управления API Azure внутри виртуальной сети и настройки его для использования внутреннего виртуального типа сети.

* Обновление существующего развертывания службы управления API внутри виртуальной сети: используйте cmdlet [Update-AzApiManagementRegion](/powershell/module/az.apimanagement/update-azapimanagementregion) для перемещения существующей службы управления API внутри виртуальной сети и настройки ее для использования внутреннего виртуального типа сети.

## <a name="dns-configuration"></a><a name="apim-dns-configuration"></a>DNS configuration (Настройка DNS)
Если управление API настроено во внешнем режиме виртуальной сети, службой DNS управляет Azure. Чтобы использовать внутренний режим виртуальной сети, управлять маршрутизацией вы должны самостоятельно.

> [!NOTE]
> Служба управления API не прослушивает запросы, поступающие на IP-адреса. Она реагирует только на запросы к имени узла, которое настроено на конечных точках службы. К ним относятся шлюз, портал Azure и портал разработчика, конечная точка прямого управления и репозиторий Git.

### <a name="access-on-default-host-names"></a>Доступ по именам узлов по умолчанию
При создании службы управления API, названной, например, "contosointernalvnet", следующие конечные точки службы настраиваются по умолчанию:

   * Шлюз или прокси: contosointernalvnet.azure-api.net

   * Портал разработчиков: contosointernalvnet.portal.azure-api.net

   * Новый портал разработчиков: contosointernalvnet.developer.azure-api.net

   * Конечная точка прямого управления: contosointernalvnet.management.azure-api.net

   * Git: contosointernalvnet.scm.azure-api.net

Чтобы получить доступ к этим конечным точкам службы управления API, можно создать виртуальную машину в подсети, подключенной к виртуальной сети, в которой развернута служба управления API. Предполагая, что внутренний виртуальный IP-адрес для вашей службы составляет 10.1.0.5, вы можете сопоставить файл хостов, %SystemDrive% »драйверы и хосты, следующим образом:

   * 10.1.0.5 contosointernalvnet.azure-api.net

   * 10.1.0.5 contosointernalvnet.portal.azure-api.net

   * 10.1.0.5 contosointernalvnet.developer.azure-api.net

   * 10.1.0.5 contosointernalvnet.management.azure-api.net

   * 10.1.0.5 contosointernalvnet.scm.azure-api.net

Теперь вы сможете обращаться с этой виртуальной машины к любой из конечных точек службы.
Если в вашей в виртуальной сети действует пользовательский DNS-сервер, вы можете создать на нем записи DNS типа A. Тогда доступ к конечным точкам будет возможен из любого расположения в пределах виртуальной сети.

### <a name="access-on-custom-domain-names"></a>Доступ по пользовательским доменным именам

1. Если для обращения к службе управления API вы не хотите использовать имена узлов по умолчанию, для всех конечных точек службы можно настроить пользовательские доменные имена, как указано ниже:

   ![Настройка пользовательского домена для управления API][api-management-custom-domain-name]

2. После этого создайте на DNS-сервере записи типа A для обращения к конечным точкам, которые будут доступны только в пределах виртуальной сети.

## <a name="routing"></a><a name="routing"> </a> Реутоминг

* Сбалансированный *частный* виртуальный IP-адрес нагрузки из диапазона подсетей будет зарезервирован и использован для доступа к конечным точкам службы управления API из виртуальной сети. Этот *частный* IP-адрес можно найти на лезвии Обзора для службы на портале Azure. Этот адрес должен быть зарегистрирован на DNS-серверах, используемых виртуальной сетью.
* Сбалансированный *общественный* IP-адрес (VIP) также будет зарезервирован для обеспечения доступа к конечная точка службы управления над портом 3443. Этот *общедоступный* IP-адрес можно найти на лезвии «Обзор» для службы на портале Azure. *Публичный* IP-адрес используется только для `management` управления движением самолетов до конечных точек над портом 3443 и может быть заблокирован в сервисный тег [ApiManagement.][ServiceTags]
* IP-адреса из диапазона IP-адресов подсети (DIP) будут присваиваны каждому VM в службе и будут использоваться для доступа к ресурсам в виртуальной сети. Общественный IP-адрес (VIP) будет использоваться для доступа к ресурсам за пределами виртуальной сети. Если списки ограничений ИС используются для защиты ресурсов в виртуальной сети, необходимо указать весь диапазон для подсети, в которой развернута служба управления API, для предоставления или ограничения доступа от службы.
* Сбалансированную нагрузку на общедоступные и частные IP-адреса можно найти на лезвии Обзора на портале Azure.
* IP-адреса, назначенные для публичного и частного доступа, могут изменяться, если служба будет удалена, а затем добавлена обратно в виртуальную сеть. В этом случае может потребоваться обновление регистраций DNS, правил маршрута и ip-ограничений в виртуальной сети.

## <a name="related-content"></a><a name="related-content"> </a>Связанная информация
Дополнительные сведения см. в следующих статьях:
* [Распространенные проблемы конфигурации сети][Common network configuration problems] при настройке управления API Azure с виртуальными сетями
* [Виртуальная сеть Azure: часто задаваемые вопросы](../virtual-network/virtual-networks-faq.md)
* Инструкции по [созданию записей DNS типа A](/previous-versions/windows/it-pro/windows-2000-server/bb727018(v=technet.10))

[api-management-using-internal-vnet-menu]: ./media/api-management-using-with-internal-vnet/api-management-using-with-internal-vnet.png
[api-management-internal-vnet-dashboard]: ./media/api-management-using-with-internal-vnet/api-management-internal-vnet-dashboard.png
[api-management-custom-domain-name]: ./media/api-management-using-with-internal-vnet/api-management-custom-domain-name.png

[Create API Management service]: get-started-create-service-instance.md
[Common network configuration problems]: api-management-using-with-vnet.md#network-configuration-issues

[ServiceTags]: ../virtual-network/security-overview.md#service-tags

