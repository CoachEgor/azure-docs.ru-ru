---
title: Делегирование пользователю регистрации и подписки на продукт
description: Узнайте, как делегировать регистрации пользователей и подписки на продукты третьим лицам в службе управления API Azure.
services: api-management
documentationcenter: ''
author: vladvino
manager: cfowler
editor: ''
ms.assetid: 8b7ad5ee-a873-4966-a400-7e508bbbe158
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 04/04/2019
ms.author: apimpm
ms.openlocfilehash: 63ff91c6b4db351e5ec72973874466cff74432b5
ms.sourcegitcommit: 82499878a3d2a33a02a751d6e6e3800adbfa8c13
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70073449"
---
# <a name="how-to-delegate-user-registration-and-product-subscription"></a>Делегирование пользователю регистрации и подписки на продукт

Делегирование позволяет использовать существующий веб-сайт для управления входом и регистрацией разработчиков, а также подписки на продукты, в отличие от использования встроенных функций на портале разработчика. В результате этого веб-сайт будет владеть пользовательскими данными и проверять эти шаги в соответствии с вашими настройками.

[!INCLUDE [premium-dev-standard-basic.md](../../includes/api-management-availability-premium-dev-standard-basic.md)]

## <a name="delegate-signin-up"> </a>Делегирование входа и регистрация для разработчиков

Чтобы делегировать вход в систему разработчика и зарегистрироваться на существующем веб-сайте, необходимо создать специальную конечную точку делегирования на сайте. Он должен действовать в качестве точки входа для любого такого запроса, инициированного на портале разработчика управления API.

Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик щелкает ссылку входа или регистрации на портале разработчика управления API.
2. Браузер перенаправляется в конечную точку делегирования
3. Конечная точка делегирования в возврате перенаправляет в или представляет интерфейс пользователя, запрашивающий вход или регистрацию
4. При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс

Сначала следует настроить службу управления API так, чтобы он направлял запросы через вашу конечную точку делегирования. В портал Azure выполните поиск по запросу **Безопасность** в ресурсе управления API, а затем щелкните элемент делегирование. Установите флажок, чтобы включить функцию "делегирование входа & регистрации".

![Страница "Делегирование"][api-management-delegation-signin-up]

* Выберите для себя нужный URL-адрес своей специальной конечной точки делегирования и введите его в поле **URL-адрес конечной точки делегирования** . 
* В поле "Ключ проверки подлинности делегирования" введите секретный ключ, который будет использоваться для вычисления сигнатуры, благодаря которой будет можно убедиться, что запрос действительно поступает из службы управления Azure API. Вы можете нажать кнопку **Создать**, и служба управления API сгенерирует для вас случайный ключ.

Теперь необходимо создать **конечную точку делегирования**. Для этого следует выполнить несколько действий:

1. Получите запрос в следующей форме:
   
   > *http:\//ВВВ.йоурвебсите.ком/апимделегатион? Operation = Signing & ReturnUrl = {URL-адрес исходной страницы} & Salt = {String} & SIG = {строка}*
   > 
   > 
   
    Параметры запроса для регистра входа и регистрации:
   
   * **operation**: идентифицирует тип запроса на делегирование (в данном случае может быть только **SignIn**).
   * **ReturnUrl**: URL-адрес страницы, на которой пользователь щелкнул ссылку для входа или регистрации.
   * **salt**– специальная строка случайных данных, используемая для вычисления хэша безопасности.
   * **sig**– вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.
2. Убедитесь, что запрос поступает из службы управления Azure API (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)
   
   * Вычислите хэш HMAC-SHA512 строки на основе параметров запроса **returnUrl** и **salt** ([на приведенном ниже примере кода]).
     
     > HMAC(**salt** + '\n' + **returnUrl**)
     > 
     > 
   * Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.
3. Убедитесь, что вы получили запрос на вход и регистрацию: параметр запроса **операции** будет иметь значение "**Signing**".
4. Предоставление пользователю пользовательского интерфейса для входа или регистрации
5. Если пользователь регистрируется, для него необходимо создать соответствующую учетную запись в API Management. [Создание пользователя] с помощью интерфейса API Management REST API. При этом убедитесь, что для идентификатора пользователя задано то же значение, что и в хранилище пользователя, или идентификатор, который можно отследить.
6. После успешной проверки подлинности пользователя:
   
   * [запросите маркер единого входа (SSO)] через API Management REST API
   * добавьте параметр запроса returnUrl в URL-адреса SSO, который вы получили из вызова API, указанного выше:
     
     > Например: https://customer.portal.azure-api.net/signin-sso?token&returnUrl=/return/url 
     > 
     > 
   * перенаправьте пользователя на вышеупомянутый URL-адрес

Помимо использования операции **SignIn**, вы можете управлять учетными записями, выполнив указанные выше действия и одну из следующих операций.

* **ChangePassword;**
* **ChangeProfile;**
* **CloseAccount.**

Для операций управления учетными записями необходимо передать следующие параметры запроса.

* **operation**– определяет тип запроса на делегирование (ChangePassword, ChangeProfile или CloseAccount).
* **UserID**: идентификатор пользователя учетной записи для управления.
* **salt**– специальная строка случайных данных, используемая для вычисления хэша безопасности.
* **sig**– вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.

## <a name="delegate-product-subscription"> </a>Делегирование подписки на продукт
Делегирование подписки на продукт работает аналогично делегированию входа пользователя. Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик выбирает продукт на портале разработчика управления API и нажимает кнопку подписывать.
2. Браузер перенаправляется в конечную точку делегирования.
3. Конечная точка делегирования выполняет обязательные шаги подписки продукта. Вы можете разработать шаги. Они могут включать перенаправление на другую страницу для запроса сведений о выставлении счетов, запрашивать дополнительные вопросы или просто хранить информацию и не требует вмешательства пользователя.

Чтобы включить функцию, на странице **Делегирование** щелкните **Делегировать подписку на продукт**.

Затем убедитесь, что конечная точка делегирования выполняет следующие действия.

1. Получите запрос в следующей форме:
   
   > *http:\//ВВВ.йоурвебсите.ком/апимделегатион? Operation = {Operation} & ProductID = {продукт для подписки} & UserID = {пользователь, выполняющий запрос} & Salt = {String} & SIG = {строка}*
   >
   
    Параметры запроса для подписки на продукт:
   
   * **operation**: идентифицирует тип запроса на делегирование. Для запросов подписки на продукт допустимыми являются следующие параметры:
     * "Subscribe": запрос на подписку пользователя на заданный продукт с предоставленным идентификатором (см. ниже).
     * "Unsubscribe": запрос на отказ от подписки пользователя на продукт;
     * "Renew": запрос на обновление подписки (например, в случае истечения срока действия).
   * **productId**: идентификатор продукта, подписку на который запрашивает пользователь.
   * **SubscriptionId**: при *отмене подписки* и *продлении* — идентификатор подписки продукта.
   * **UserID**: идентификатор пользователя, для которого выполняется запрос
   * **salt**– специальная строка случайных данных, используемая для вычисления хэша безопасности.
   * **sig**– вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.

2. Убедитесь, что запрос поступает из службы управления Azure API (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)
   
   * Вычисление HMAC-SHA512 строки на основе параметров запроса **ProductID**, **UserID**и **Salt** :
     
     > HMAC(**salt** + '\n' + **productId** + '\n' + **userId**)
     > 
     > 
   * Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.
3. Обработка подписки на продукт на основе типа операции, запрошенной в **операции** . Например, выставление счетов, дальнейшие вопросы и т. д.
4. В случае успешной подписки пользователя на продукт на стороне пользователя Подпишитесь на продукт управления API, [вызов REST API для подписок].

## <a name="delegate-example-code"> </a> Пример кода

В следующих примерах кода показано, как:

* Возьмем *ключ проверки делегирования*, заданный на экране делегирования на портале издателя.
* Создайте код HMAC, который затем используется для проверки подписи, подтверждая допустимость переданного returnUrl.

Тот же код с незначительными изменениями подходит для productId и userId.

**Код C# для создания хэша returnUrl**

```csharp
using System.Security.Cryptography;

string key = "delegation validation key";
string returnUrl = "returnUrl query parameter";
string salt = "salt query parameter";
string signature;
using (var encoder = new HMACSHA512(Convert.FromBase64String(key)))
{
    signature = Convert.ToBase64String(encoder.ComputeHash(Encoding.UTF8.GetBytes(salt + "\n" + returnUrl)));
    // change to (salt + "\n" + productId + "\n" + userId) when delegating product subscription
    // compare signature to sig query parameter
}
```

**Код NodeJS для создания хэша returnUrl**

```
var crypto = require('crypto');

var key = 'delegation validation key'; 
var returnUrl = 'returnUrl query parameter';
var salt = 'salt query parameter';

var hmac = crypto.createHmac('sha512', new Buffer(key, 'base64'));
var digest = hmac.update(salt + '\n' + returnUrl).digest();
// change to (salt + "\n" + productId + "\n" + userId) when delegating product subscription
// compare signature to sig query parameter

var signature = digest.toString('base64');
```

## <a name="next-steps"></a>Следующие шаги
Дополнительную информацию о делегировании см. в следующем видео.

> [!VIDEO https://channel9.msdn.com/Blogs/AzureApiMgmt/Delegating-User-Authentication-and-Product-Subscription-to-a-3rd-Party-Site/player]
> 
> 

[Delegating developer sign in and sign up]: #delegate-signin-up
[Delegating product subscription]: #delegate-product-subscription
[запросите маркер единого входа (SSO)]: https://docs.microsoft.com/rest/api/apimanagement/2019-01-01/User/GenerateSsoUrl
[Создание пользователя]: https://docs.microsoft.com/rest/api/apimanagement/2019-01-01/user/createorupdate
[вызов REST API для подписок]: https://docs.microsoft.com/rest/api/apimanagement/2019-01-01/subscription/createorupdate
[Next steps]: #next-steps
[на приведенном ниже примере кода]: #delegate-example-code

[api-management-delegation-signin-up]: ./media/api-management-howto-setup-delegation/api-management-delegation-signin-up.png 
