---
title: Делегирование пользователю регистрации и подписки на продукт
description: Узнайте, как делегировать регистрации пользователей и подписки на продукты третьим лицам в службе управления API Azure.
services: api-management
documentationcenter: ''
author: vladvino
manager: cfowler
editor: ''
ms.assetid: 8b7ad5ee-a873-4966-a400-7e508bbbe158
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 04/04/2019
ms.author: apimpm
ms.openlocfilehash: c28872e6cffa973f01b3f5a87c423d9dd93a2aa5
ms.sourcegitcommit: 8dc84e8b04390f39a3c11e9b0eaf3264861fcafc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2020
ms.locfileid: "81259108"
---
# <a name="how-to-delegate-user-registration-and-product-subscription"></a>Делегирование пользователю регистрации и подписки на продукт

Делегация позволяет использовать существующий веб-сайт для обработки разработчика войти / зарегистрироваться и подписки на продукты, в отличие от использования встроенной функциональности в портале разработчиков. Это позволяет вашему веб-сайту владеть данными пользователей и выполнять проверку этих шагов на заказ.

[!INCLUDE [premium-dev-standard-basic.md](../../includes/api-management-availability-premium-dev-standard-basic.md)]

## <a name="delegating-developer-sign-in-and-sign-up"></a><a name="delegate-signin-up"> </a>Делегирование входа и регистрации разработчика

Чтобы делегировать разработчика, войти в систему и зарегистрироваться на существующий веб-сайт, необходимо создать специальную конечную точку делегации на вашем сайте. Он должен выступать в качестве точки входа для любого такого запроса, инициированного с портала разработчика API Management.

Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик нажимает на ссылку или регистрируется на портале разработчика API Management
2. Браузер перенаправляется в конечную точку делегирования
3. Конечная точка делегирования в свою очередь перенаправляет на пользовательский интерфейс или представляет его, прося пользователя войти или зарегистрироваться
4. При успешном выполнении данной операции пользователь перенаправляется обратно на ту страницу портала разработчика API Management, с которой он начал данный процесс

Сначала следует настроить службу управления API так, чтобы он направлял запросы через вашу конечную точку делегирования. На портале Azure ищите **безопасность** на ресурсе управления API, а затем щелкните элемент **«Делегация».** Нажмите на флажок, чтобы включить "Делегат войти в & зарегистрироваться".

![Страница "Делегирование"][api-management-delegation-signin-up]

* Выберите для себя нужный URL-адрес своей специальной конечной точки делегирования и введите его в поле **URL-адрес конечной точки делегирования** . 
* В поле "Ключ проверки подлинности делегирования" введите секретный ключ, который будет использоваться для вычисления сигнатуры, благодаря которой будет можно убедиться, что запрос действительно поступает из службы управления Azure API. Вы можете нажать кнопку **Создать**, и служба управления API сгенерирует для вас случайный ключ.

Теперь необходимо создать **конечную точку делегирования**. Для этого следует выполнить несколько действий:

1. Получите запрос в следующей форме:
   
   > *http:\//www.yourwebsite.com/apimdelegation?operation=SignIn&returnUrl (URL исходной страницы &соли) (строка &sig' string)*
   > 
   > 
   
    Параметры запроса для ввоза /регистрации случая:
   
   * **operation**: идентифицирует тип запроса на делегирование (в данном случае может быть только **SignIn**).
   * **returnUrl**: URL страницы, где пользователь нажал на входе или зарегистрируйтесь ссылку
   * **salt**– специальная строка случайных данных, используемая для вычисления хэша безопасности.
   * **sig**– вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.
2. Убедитесь, что запрос поступает из службы управления Azure API (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)
   
   * Вычислите хэш HMAC-SHA512 строки на основе параметров запроса **returnUrl** и **salt** ([на приведенном ниже примере кода]).
     
     > HMAC(**salt** + '\n' + **returnUrl**)
     > 
     > 
   * Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.
3. Убедитесь, что вы получаете запрос на регистрацию/регистрацию: параметр запроса **операции** будет установлен на "**SignIn**".
4. Представить пользователю пользовательский интерфейс для регистрации или регистрации
5. Если пользователь регистрируется, для него необходимо создать соответствующую учетную запись в API Management. [Создание пользователя] с помощью интерфейса API Management REST API. При этом убедитесь, что идентификатор пользователя будет значением, которое имеется в вашем магазине пользователя, или к идентификатору, который можно отслеживать.
6. После успешной проверки подлинности пользователя:
   
   * [запросите маркер единого входа (SSO)] через API Management REST API
   * добавьте параметр запроса returnUrl в URL-адреса SSO, который вы получили из вызова API, указанного выше:
     
     > Например: https://customer.portal.azure-api.net/signin-sso?token&returnUrl=/return/url 
     > 
     > 
   * перенаправьте пользователя на вышеупомянутый URL-адрес

Помимо использования операции **SignIn**, вы можете управлять учетными записями, выполнив указанные выше действия и одну из следующих операций.

* **ChangePassword;**
* **ChangeProfile;**
* **CloseAccount.**

Для операций управления учетными записями необходимо передать следующие параметры запроса.

* **operation**– определяет тип запроса на делегирование (ChangePassword, ChangeProfile или CloseAccount).
* **userId**: идентификатор пользователя учетной записи для управления
* **salt**– специальная строка случайных данных, используемая для вычисления хэша безопасности.
* **sig**– вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.

## <a name="delegating-product-subscription"></a><a name="delegate-product-subscription"> </a>Делегирование подписки на продукт
Делегирование подписки на продукт работает аналогично делегированию пользовательского вхинга в/вверх. Итоговый рабочий процесс будет иметь следующий вид:

1. Разработчик выбирает продукт на портале разработчика API Management и нажимает на кнопку Подписки.
2. Браузер перенаправляется в конечную точку делегации.
3. Конечная точка делегирования выполняет необходимые шаги подписки продукта. Это до вас, чтобы разработать шаги. Они могут включать перенаправление на другую страницу, чтобы запросить платежную информацию, задавая дополнительные вопросы, или просто хранить информацию и не требуя каких-либо действий пользователя.

Чтобы включить функцию, на странице **Делегирование** щелкните **Делегировать подписку на продукт**.

Далее убедитесь, что конечная точка делегирования выполняет следующие действия:

1. Получите запрос в следующей форме:
   
   > *http:\//www.yourwebsite.com/apimdelegation?operation -&productId'product, чтобы подписаться на &пользователь, делающих запрос, &солью ,"строка &sig"*
   >
   
    Параметры запроса для подписки на продукт:
   
   * **operation**: идентифицирует тип запроса на делегирование. Для запросов подписки на продукт допустимыми являются следующие параметры:
     * "Subscribe": запрос на подписку пользователя на заданный продукт с предоставленным идентификатором (см. ниже).
     * "Unsubscribe": запрос на отказ от подписки пользователя на продукт;
     * "Renew": запрос на обновление подписки (например, в случае истечения срока действия).
   * **productId**: идентификатор продукта, подписку на который запрашивает пользователь.
   * **subscriptionId**: на *Отписаться* и *обновить* - идентификатор подписки продукта
   * **userId**: идентификатор пользователя, для запроса
   * **salt**– специальная строка случайных данных, используемая для вычисления хэша безопасности.
   * **sig**– вычисленный хэш безопасности, который будет сравниваться с вашим вычисленным хэшем.

2. Убедитесь, что запрос поступает из службы управления Azure API (это необязательный шаг, но мы настоятельно рекомендуем его выполнять для обеспечения безопасности)
   
   * Вычислите HMAC-SHA512 строки на основе параметров **productId,** **userId**и **соляного** запроса:
     
     > HMAC(**salt** + '\n' + **productId** + '\n' + **userId**)
     > 
     > 
   * Сравните вычисленный выше хэш со значением параметра запроса **sig**. Если два хэша совпадают друг с другом, перейдите к следующему шагу. Если нет, отклоните запрос.
3. Обработайте подписку на продукт в зависимости от типа запрашиваемых операций **-** например, выставления счетов, дополнительных вопросов и т.д.
4. Успешно подписавшись на продукт на вашей стороне, подпишитесь на продукт API Management, позвонив в [REST API для подписки.]

## <a name="example-code"></a><a name="delegate-example-code"> </a> Пример кода

Эти образцы кода показывают, как:

* Возьмите *ключ проверки делегации,* который установлен на экране делегации портала издателя
* Создайте HMAC, который затем используется для проверки подписи, доказывающей действительность пройденного returnUrl.

Тот же код с незначительными изменениями подходит для productId и userId.

**Код C# для создания хэша returnUrl**

```csharp
using System.Security.Cryptography;

string key = "delegation validation key";
string returnUrl = "returnUrl query parameter";
string salt = "salt query parameter";
string signature;
using (var encoder = new HMACSHA512(Convert.FromBase64String(key)))
{
    signature = Convert.ToBase64String(encoder.ComputeHash(Encoding.UTF8.GetBytes(salt + "\n" + returnUrl)));
    // change to (salt + "\n" + productId + "\n" + userId) when delegating product subscription
    // compare signature to sig query parameter
}
```

**Код NodeJS для создания хэша returnUrl**

```
var crypto = require('crypto');

var key = 'delegation validation key'; 
var returnUrl = 'returnUrl query parameter';
var salt = 'salt query parameter';

var hmac = crypto.createHmac('sha512', new Buffer(key, 'base64'));
var digest = hmac.update(salt + '\n' + returnUrl).digest();
// change to (salt + "\n" + productId + "\n" + userId) when delegating product subscription
// compare signature to sig query parameter

var signature = digest.toString('base64');
```

> [!IMPORTANT]
> Для вхлаживнесенных изменений в составе делегации необходимо [переиздать портал разработчика.](api-management-howto-developer-portal-customize.md#publish)

## <a name="next-steps"></a>Дальнейшие действия
Дополнительную информацию о делегировании см. в следующем видео.

> [!VIDEO https://channel9.msdn.com/Blogs/AzureApiMgmt/Delegating-User-Authentication-and-Product-Subscription-to-a-3rd-Party-Site/player]
> 
> 

[Delegating developer sign in and sign up]: #delegate-signin-up
[Delegating product subscription]: #delegate-product-subscription
[запросите маркер единого входа (SSO)]: https://docs.microsoft.com/rest/api/apimanagement/2019-12-01/User/GenerateSsoUrl
[Создание пользователя]: https://docs.microsoft.com/rest/api/apimanagement/2019-12-01/user/createorupdate
[вызов АИС REST для подписки]: https://docs.microsoft.com/rest/api/apimanagement/2019-12-01/subscription/createorupdate
[Next steps]: #next-steps
[на приведенном ниже примере кода]: #delegate-example-code

[api-management-delegation-signin-up]: ./media/api-management-howto-setup-delegation/api-management-delegation-signin-up.png 
