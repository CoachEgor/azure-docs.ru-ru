---
title: Защитите API, используя OAuth 2.0 с AAD и API Management
titleSuffix: Azure API Management
description: Информация о защите внутренней службы веб-API с помощью Azure Active Directory и службы управления API.
services: api-management
documentationcenter: ''
author: miaojiang
manager: cfowler
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 05/21/2019
ms.author: apimpm
ms.openlocfilehash: 8b396b782c1254b3229aeeb8e51b61cc744d6318
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77190365"
---
# <a name="protect-an-api-by-using-oauth-20-with-azure-active-directory-and-api-management"></a>Защита API с помощью протокола OAuth 2.0 и службы управления API в Azure Active Directory

В этом руководстве показано, как настроить имеющийся экземпляр управления API Azure для защиты API с помощью протокола OAuth 2.0 в Azure Active Directory. 

> [!NOTE]
> Эта функция доступна в **разработчике,** **стандартном** и **премиум-уровнях** управления API.

## <a name="prerequisites"></a>Предварительные требования
Чтобы выполнить шаги в этой статье, необходимо иметь следующее:
* Экземпляр управления API.
* Публикуемый API, использующий экземпляр управления API (APIM).
* клиент Azure AD;

## <a name="overview"></a>Обзор

Ниже приведен краткий обзор шагов.

1. Регистрация приложения (серверного приложения) в Azure Active Directory для представления API.
2. Регистрация другого приложения (клиентского приложения) в Azure Active Directory для представления клиентского приложения, которое будет вызывать API.
3. Предоставление разрешения в Azure Active Directory, чтобы разрешить клиентскому приложению вызывать серверное.
4. Назначайте консоль разработчика для вызова API с помощью авторизации пользователя OAuth 2.0.
5. Добавление политики **validate-jwt** для проверки токена OAuth для каждого входящего запроса.

## <a name="register-an-application-in-azure-ad-to-represent-the-api"></a>Регистрация приложения в Azure Active Directory для представления API

Первым шагом в защите API в Azure Active Directory является регистрация приложения в Azure Active Directory, которое представляет API. 

1. Зарегистрируйтесь на [портале Azure.](https://portal.azure.com) Поиск и выбор **регистраций APP**.

1. Выберите **Новая регистрация**. 

1. При **попавании страницы заявки** введите регистрационную информацию в ашего заявлении: 
    - В разделе **Имя** введите значимое имя приложения, которое будет отображаться пользователям приложения, например *бэкэнд-приложение.* 
    - В разделе **Поддерживаемые типы учетных записей** выберите опцию, которая подходит для вашего сценария. 

1. Оставьте раздел **Redirect URI** пустым.

1. Выберите **Зарегистрировать**, чтобы создать приложение. 

1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже.

1. Выберите **Expose API** и установите **URI ИДента приложения** со значением по умолчанию. Запишите это значение на более поздний срок.

1. Выберите **кнопку «Добавить область»** для отображения **страницы Добавить область.** Затем создайте новую область, поддерживаемую API `Files.Read`(например, ). Наконец, выберите кнопку **Добавить область для** создания области. Повторите этот шаг, чтобы добавить все области, поддерживаемые API.

1. Когда области созданы, обратите внимание на их использование в следующем шаге. 

## <a name="register-another-application-in-azure-ad-to-represent-a-client-application"></a>Регистрация другого приложения в Azure Active Directory для представления клиентского приложения

Каждое клиентское приложение, вызывающее API, должно быть также зарегистрировано в Azure Active Directory. В этом примере клиентское приложение является консолью разработчиков на портале разработчиков API Management. Ниже показано, как зарегистрировать другое приложение в Azure Active Directory для представления консоли разработчика.

1. Зарегистрируйтесь на [портале Azure.](https://portal.azure.com) Поиск и выбор **регистраций APP**.

1. Выберите **Новая регистрация**.

1. При **попавании страницы заявки** введите регистрационную информацию в ашего заявлении: 
    - В разделе **«Имя»** введите значимое имя приложения, которое будет отображаться пользователям приложения, например *клиент-приложение.* 
    - В разделе **Поддерживаемые типы учетных записей** выберите **учетные записи в любом каталоге организации (любой каталог Azure AD - Multitenant).** 

1. В разделе **Redirect** URI `Web` выберите `https://contoso5.portal.azure-api.net/signin`и введите URL.

1. Выберите **Зарегистрировать**, чтобы создать приложение. 

1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже.

Теперь создайте секрет клиента для этого приложения для использования в следующем шаге.

1. Из списка страниц для клиентского приложения выберите **Сертификаты & секреты**и выберите **новый секрет клиента.**

1. Под **Добавить секрет клиента,** предоставить **описание**. Выберите, когда ключ должен истечь, и выберите **Добавить**.

При создании секрета обратите внимание на ключевое значение для использования в следующем шаге. 

## <a name="grant-permissions-in-azure-ad"></a>Предоставление разрешений в AAD

Теперь, когда зарегистрированы два приложения для представления API и консоли разработчика, необходимо предоставить разрешения, позволяющие клиентскому приложению вызывать серверное приложение.  

1. Перейдите на [портал Azure,](https://portal.azure.com) чтобы предоставить разрешения на приложение клиента. Поиск и выбор **регистраций APP**.

1. Выберите клиентское приложение. Затем в списке страниц для приложения выберите **разрешения API.**

1. Выберите **Добавление Разрешения.**

1. При **выборе API**выберите **API,** а затем найдите и выберите приложение бэкэнда.

1. В соответствии с **делегированными разрешениями**выберите соответствующие разрешения для бэкэнд-приложения, а затем выберите **разрешения Добавить.**

1. Дополнительно, на странице **разрешений API,** выберите **согласие \<админа Гранта на>вашего арендатора** дать согласие от имени всех пользователей в этом каталоге. 

## <a name="enable-oauth-20-user-authorization-in-the-developer-console"></a>Включение авторизации пользователей по протоколу OAuth 2.0 в консоли разработчика

На данный момент мы создали приложения в Azure Active Directory и предоставили соответствующие разрешения, позволяющие клиентскому приложению вызывать серверное. 

В этом примере консоль разработчика является клиентским приложением. В следующих шагах описано включение авторизации пользователя по протоколу OAuth 2.0 в консоли разработчика. 

1. На портале Azure просмотрите экземпляр Управления API.

1. Выберите **OAuth 2.0** > **Добавить**.

1. Укажите **отображаемое имя** и **описание**.

1. Для **URL-адреса страницы регистрации Клиента**введите значение заполнителя, `http://localhost`например. **URL-адрес страницы регистрации клиента** указывает на страницу, которую пользователи могут использовать для создания и настройки собственных учетных записей для поставщиков OAuth 2.0, которые поддерживают это. В этом примере пользователи не создают и не настраивают собственные учетные записи, поэтому используется заполнитель.

1. Выберите **Код авторизации** для **типов предоставления авторизации**.

1. Затем укажите **URL-адрес конечной точки авторизации** и **URL-адрес конечной точки маркера**. Эти значения можно извлечь на странице **конечных точек** в клиенте Azure Active Directory. Снова перейдите на страницу **Регистрация приложений** и выберите **Конечные точки**.


1. Скопируйте значение **конечной точки авторизации OAuth 2.0** и вставьте его в текстовое поле **URL-адрес конечной точки авторизации**. Выберите **POST** по методу запроса авторизации.

1. Скопируйте значение **конечной точки маркера OAuth 2.0** и вставьте его в текстовое поле **URL-адрес конечной точки маркера**. 

    >[!IMPORTANT]
    > Вы можете использовать либо **v1** или **v2** конечные точки. Однако, в зависимости от того, какую версию вы выберете, ниже шаг будет отличаться. Рекомендуем использовать конечные точки v2. 

1. Если вы используете конечные точки **v1,** добавьте параметр тела, названный **ресурсом.** Для значения этого параметра используйте **идентификатор приложения для** задней части. 

1. Если вы используете конечные точки **v2,** используйте область, созданную для бэкэнд-приложения в области **области по умолчанию.**

1. Затем укажите учетные данные клиента. Это должны быть учетные данные клиентского приложения.

1. Для **идентификатора клиента**используйте **идентификатор приложения** клиент-приложения.

1. Для **секрета клиента** используйте ранее созданный для клиентского приложения ключ. 

1. Далее в качестве типа предоставления кода авторизации указан **redirect_url**. Запишите этот URL-адрес.

1. Выберите **Создать**.

1. Вернитесь к клиенту-приложению и выберите **аутентификацию.**

1. Под **перенаправление URIs**, выберите тип как **паутина,** вставьте **redirect_url** под **перенаправить URI,** и после этого сохранить.

Теперь, когда сервер авторизации OAuth 2.0 настроен, консоль разработчика должна получать маркеры доступа от Azure Active Directory. 

Следующим шагом является включение авторизации пользователей по протоколу OAuth 2.0 для API, чтобы консоль разработчика получала маркер доступа от имени пользователя перед вызовом API.

1. Перейдите к экземпляру службы управления API и выберите раздел **API**.

2. Выберите API, который нужно защитить. Например, можно использовать `Echo API`.

3. Перейдите в **Параметры**.

4. В разделе **безопасности** выберите **OAuth 2.0**, а также настроенный ранее сервер OAuth 2.0. 

5. Нажмите кнопку **Сохранить**.

## <a name="successfully-call-the-api-from-the-developer-portal"></a>Удачный вызов API с портала разработчика

> [!NOTE]
> Этот раздел не относится к ценовой категории **Потребление**, которая не поддерживает портал разработчика.

Теперь, когда авторизация пользователя OAuth 2.0 включена в API, консоль разработчика получит токен доступа от имени пользователя, прежде чем позвонить в API.

1. Просмотрите любую операцию под API на портале разработчика и выберите **Try it.** Откроется консоль разработчика.

2. Обратите внимание на новый элемент в разделе **Авторизация,** соответствующий только что добавленного серверу авторизации.

3. Выберите **Код авторизации** в раскрывающемся списке авторизации, после чего будет предложено войти в клиент Azure Active Directory. Если вы уже вошли с помощью учетной записи, запрос на ввод учетных данных не появится.

4. После успешного входа в систему заголовок `Authorization` будет добавлен в запрос с маркером доступа из Azure Active Directory. Ниже приведен пример маркера (в кодировке Base64).

   ```
   Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IlNTUWRoSTFjS3ZoUUVEU0p4RTJnR1lzNDBRMCIsImtpZCI6IlNTUWRoSTFjS3ZoUUVEU0p4RTJnR1lzNDBRMCJ9.eyJhdWQiOiIxYzg2ZWVmNC1jMjZkLTRiNGUtODEzNy0wYjBiZTEyM2NhMGMiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC80NDc4ODkyMC05Yjk3LTRmOGItODIwYS0yMTFiMTMzZDk1MzgvIiwiaWF0IjoxNTIxMTUyNjMzLCJuYmYiOjE1MjExNTI2MzMsImV4cCI6MTUyMTE1NjUzMywiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhHQUFBQUptVzkzTFd6dVArcGF4ZzJPeGE1cGp2V1NXV1ZSVnd1ZXZ5QU5yMlNkc0tkQmFWNnNjcHZsbUpmT1dDOThscUJJMDhXdlB6cDdlenpJdzJLai9MdWdXWWdydHhkM1lmaDlYSGpXeFVaWk9JPSIsImFtciI6WyJyc2EiXSwiYXBwaWQiOiJhYTY5ODM1OC0yMWEzLTRhYTQtYjI3OC1mMzI2NTMzMDUzZTkiLCJhcHBpZGFjciI6IjEiLCJlbWFpbCI6Im1pamlhbmdAbWljcm9zb2Z0LmNvbSIsImZhbWlseV9uYW1lIjoiSmlhbmciLCJnaXZlbl9uYW1lIjoiTWlhbyIsImlkcCI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzcyZjk4OGJmLTg2ZjEtNDFhZi05MWFiLTJkN2NkMDExZGI0Ny8iLCJpcGFkZHIiOiIxMzEuMTA3LjE3NC4xNDAiLCJuYW1lIjoiTWlhbyBKaWFuZyIsIm9pZCI6IjhiMTU4ZDEwLWVmZGItNDUxMS1iOTQzLTczOWZkYjMxNzAyZSIsInNjcCI6InVzZXJfaW1wZXJzb25hdGlvbiIsInN1YiI6IkFGaWtvWFk1TEV1LTNkbk1pa3Z3MUJzQUx4SGIybV9IaVJjaHVfSEM1aGciLCJ0aWQiOiI0NDc4ODkyMC05Yjk3LTRmOGItODIwYS0yMTFiMTMzZDk1MzgiLCJ1bmlxdWVfbmFtZSI6Im1pamlhbmdAbWljcm9zb2Z0LmNvbSIsInV0aSI6ImFQaTJxOVZ6ODBXdHNsYjRBMzBCQUEiLCJ2ZXIiOiIxLjAifQ.agGfaegYRnGj6DM_-N_eYulnQdXHhrsus45QDuApirETDR2P2aMRxRioOCR2YVwn8pmpQ1LoAhddcYMWisrw_qhaQr0AYsDPWRtJ6x0hDk5teUgbix3gazb7F-TVcC1gXpc9y7j77Ujxcq9z0r5lF65Y9bpNSefn9Te6GZYG7BgKEixqC4W6LqjtcjuOuW-ouy6LSSox71Fj4Ni3zkGfxX1T_jiOvQTd6BBltSrShDm0bTMefoyX8oqfMEA2ziKjwvBFrOjO0uK4rJLgLYH4qvkR0bdF9etdstqKMo5gecarWHNzWi_tghQu9aE3Z3EZdYNI_ZGM-Bbe3pkCfvEOyA
   ```

5. Выберите **Отправить**. После этого вы сможете успешно вызывать API.


## <a name="configure-a-jwt-validation-policy-to-pre-authorize-requests"></a>Настройка политики проверки JWT для запросов предварительной авторизации

На этом этапе, когда пользователь пытается выполнить вызов из консоли разработчика, ему предлагается выполнить вход. Консоль разработчика получает токен доступа от имени пользователя и включает токен в запрос, сделанный в API.

Однако что делать, если кто-то вызывает ваш API без токена или с недействительным токеном? Например, попробуйте вызвать API без `Authorization` заголовка, вызов все равно будет проходить. Причина в том, что на этом этапе экземпляр службы управления API не проверяет маркер доступа. Он просто передает заголовок `Authorization` в API серверной части.

Используйте политику [Проверка JWT](api-management-access-restriction-policies.md#ValidateJWT) для предварительной авторизации запросов в службе управления API путем проверки маркеров доступа каждого входящего запроса. Если у запроса нет допустимого маркера, управление API блокирует его. Например, добавьте следующую `<inbound>` политику в `Echo API`раздел политики в разделе . Она проверяет наличие утверждения "Аудитория" в маркере доступа и возвращает сообщение об ошибке, если маркер является недопустимым. Сведения о настройке политик см. в статье [How to set or edit Azure API Management policies](set-edit-policies.md) (Как настроить или изменить политики в службе управления API Azure).

```xml
<validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized. Access token is missing or invalid.">
    <openid-config url="https://login.microsoftonline.com/{aad-tenant}/.well-known/openid-configuration" />
    <required-claims>
        <claim name="aud">
            <value>{Application ID of backend-app}</value>
        </claim>
    </required-claims>
</validate-jwt>
```
> [!NOTE]
> Этот `openid-config` URL соответствует конечной точке v1. Для конечных `openid-config`точек `https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`v2 используйте .

## <a name="build-an-application-to-call-the-api"></a>Создание приложения для вызова API

В этом руководстве мы использовали консоль разработчика в APIM как пример клиентского приложения для вызова `Echo API`, защищенного OAuth 2.0. Чтобы узнать больше о том, как создать приложение и реализовать OAuth 2.0, изучите [примеры кода Azure Active Directory](../active-directory/develop/sample-v2-code.md).

## <a name="next-steps"></a>Дальнейшие действия
* Узнайте больше об [Azure Active Directory и OAuth 2.0](../active-directory/develop/authentication-scenarios.md).
* См. другие [видео](https://azure.microsoft.com/documentation/videos/index/?services=api-management) об управлении API.
* Другие способы защиты внутренней серверной службы см. в разделе [Взаимная проверка подлинности на основе сертификата](api-management-howto-mutual-certificates.md).

* [Создайте экземпляр службы управления API.](get-started-create-service-instance.md)

* [Импорт и публикация первого API](import-and-publish.md)
