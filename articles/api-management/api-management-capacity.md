---
title: Емкость экземпляра управления API Azure | Документация Майкрософт
description: В этой статье описаны метрики емкости и способы принятия обоснованных решений относительно масштабирования экземпляра управления API Azure.
services: api-management
documentationcenter: ''
author: mikebudzynski
manager: anneta
editor: ''
ms.service: api-management
ms.workload: integration
ms.topic: article
ms.date: 06/18/2018
ms.author: apimpm
ms.custom: fasttrack-edit
ms.openlocfilehash: b6d949b50be348e72cedfc3710383308b04de106
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80336013"
---
# <a name="capacity-of-an-azure-api-management-instance"></a>Емкость экземпляра управления API Azure

**Емкость** — это наиболее важная [метрика Azure Monitor](api-management-howto-use-azure-monitor.md#view-metrics-of-your-apis) для принятия обоснованных решений о масштабе экземпляра Управления API для большего нагрузок. Это сложная метрика, обязывающая следовать определенному поведению.

В этой статье объясняется, что такое **емкость** и ее поведение. Здесь показано, как получить доступ к метрикам **емкости** на портале Azure, и описаны случаи, когда следует рассмотреть возможность масштабирования или обновления экземпляра управления API.

> [!IMPORTANT]
> В этой статье рассказывается о том, как можно отслеживать и масштабировать экземпляр Управления API Azure на основе метрики емкости. Однако не менее важно понимать, что происходит, когда отдельный экземпляр Управления API фактически *достиг своей* емкости. Управление API Azure не будет применять регулирование на уровне службы для предотвращения физической перегрузки экземпляров. Когда экземпляр достигает своей физической емкости, он будет вести себя подобно любому перегруженного веб-сервера, который не в состоянии обрабатывать входящие запросы: задержка увеличится, соединения будут удалены, ошибки тайм-аута будут происходить и т.д. Это означает, что клиенты API должны быть готовы иметь дело с такой возможностью, как и с любой другой внешней услугой (например, при применении политики повторной попытки).

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить шаги из этой статьи, понадобится следующее:

+ Активная подписка Azure.

    [!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

+ Экземпляр APIM. Дополнительные сведения см. в статье о [создании экземпляра управления API Azure](get-started-create-service-instance.md).

[!INCLUDE [premium-dev-standard-basic.md](../../includes/api-management-availability-premium-dev-standard-basic.md)]

## <a name="what-is-capacity"></a>Что такое емкость

![Метрики емкости](./media/api-management-capacity/capacity-ingredients.png)

**Емкость** — это индикатор нагрузки на экземпляр Управления API. Он отражает использование ресурсов (ЦП, памяти) и длину очереди сети. Использование ЦП и памяти показывает потребление ресурсов по:

+ Службы плоскости данных Управления API, такие как обработка запросов, которые могут включать в себя запросы на пересылку или запуск политики.
+ Услуги управления API управления самолетами, такие как действия управления, применяемые через портал Azure или ARM, или нагрузка, поступающее с [портала разработчика.](api-management-howto-developer-portal.md)
+ Выбранные процессы операционной системы, включая процессы, связанные с затратами на рукопожатия TLS на новых соединениях.

Общей **емкостью** является среднее значение всех единиц экземпляра управления API.

Хотя **метрика емкости** предназначена для поверхности проблем с экземпляром Управления API, бывают случаи, когда проблемы не будут отражены в изменениях в **метрике емкости.**

## <a name="capacity-metric-behavior"></a>Поведение метрик емкости

На практике из-за собственной конструкции на **емкость** может повлиять множество переменных, например:

+ Шаблоны подключения (новое подключение по запросу и повторное использование имеющегося подключения).
+ Размеры запроса и ответа.
+ Политики, настроенные на каждом API, или количество клиентов, отправляющих запросы.

Чем сложнее операции в запросе, тем выше **емкость** потребления. Например, сложные политики преобразования потребляют гораздо больше ресурсов ЦП, чем перенаправление простого запроса. Медленные ответы внутренней службы также приводят к повышенному потреблению емкости.

> [!IMPORTANT]
> **Емкость** не является прямым расчетом числа обрабатываемых запросов.

![Пики метрик емкости](./media/api-management-capacity/capacity-spikes.png)

В **емкости** могут также наблюдаться периодические пики или значения больше нуля (даже при отсутствии обрабатываемых запросов). Это происходит из-за определенных действий системы или платформы. Такие случаи не следует принимать во внимание при принятии решения о масштабировании экземпляра.

Метрика низкой **емкости** не обязательно означает, что экземпляр API Management не испытывает никаких проблем.
  
## <a name="use-the-azure-portal-to-examine-capacity"></a>Использование портала Azure для изучения емкости
  
![Метрики емкости](./media/api-management-capacity/capacity-metric.png)  

1. Перейдите к экземпляру APIM на [портале Azure](https://portal.azure.com/).
2. Выберите **метрики**.
3. В сиреневом разделе выберите метрику **Емкость** из доступных метрик и оставьте значение агрегирования по умолчанию **Среднее**.

    > [!TIP]
    > Всегда следует обращать внимание на подразделение метрики **емкости** для каждого расположения с целью предотвращения неверной интерпретации.

4. В зеленом разделе выберите **Расположение**, чтобы разделить метрики по измерению.
5. Выберите нужный временной интервал на верхней панели раздела.

    Также можно настроить оповещение по метрикам, чтобы получать информацию о непредвиденных ситуациях. Например, получайте уведомления, когда экземпляр APIM превышал ожидаемую пиковую емкость более 20 минут.

    >[!TIP]
    > Вы можете настроить получение оповещений, когда служба работает в условиях нехватки емкости, или использовать функциональные возможности автоматического масштабирования Azure Monitor, чтобы автоматически добавлять единицу управления API Azure. Операция масштабирования может занять около 30 минут, поэтому следует планировать правила соответствующим образом.  
    > Допускается только масштабирование главного расположения.

## <a name="use-capacity-for-scaling-decisions"></a>Использование емкости для решений масштабирования

**Емкость** является метрикой, позволяющей принимать решения относительно масштабирования экземпляра управления API для предоставления дополнительных ресурсов, позволяющих справиться с большей нагрузкой. Попробуйте следующее:

+ Просмотреть долгосрочные тенденции и средние значения.
+ Игнорировать внезапные пики, которые, скорее всего, не связаны с увеличением нагрузки (подробное описание см. в разделе "Поведение метрик емкости").
+ Обновить или масштабировать экземпляр, если значение **емкости** превышает 60 % или 70 % на протяжении длительного времени (например, 30 минут). Разные значения могут работать лучше в вашей службе или сценарии.

>[!TIP]  
> Если вы можете заранее оценить трафик, выполните тестирование экземпляра APIM на ожидаемых рабочих нагрузках. Вы можете постепенно увеличивать нагрузку запросов на клиент и отследить, какое значение метрики емкости соответствует пиковой нагрузке. Выполните шаги из предыдущего раздела, чтобы понять, какая емкость используется в любой момент времени, используя портал Azure.

## <a name="next-steps"></a>Дальнейшие действия

[Обновление и масштабирование экземпляра API Management](upgrade-and-scale.md)