---
title: Защитите бэкэнд SPA с OAuth 2.0 с помощью Azure Active Directory B2C и Управления API Azure.
description: Защитите API с OAuth 2.0, используя Azure Active Directory B2C, управление API Azure и Easy Auth, чтобы вызвать сярприг из JAVAScript SPA.
services: api-management, azure-ad-b2c, app-service
documentationcenter: ''
author: WillEastbury
manager: alberts
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/20/2020
ms.author: wieastbu
ms.custom: fasttrack-new
ms.openlocfilehash: 55acea360de11c5fcc699d65daf92cf24dfd691d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79475482"
---
# <a name="protect-spa-backend-with-oauth-20-azure-active-directory-b2c-and-azure-api-management"></a>Защитите бэкэнд SPA с OAuth 2.0, Активным каталогом Azure B2C и API-управлениеAzу

В этом сценарии показано, как настроить экземпляр управления API Azure для защиты API.
Мы будем использовать протокол OAuth 2.0 с Azure AD B2C, наряду с управлением API, чтобы обеспечить бэкэнд Azure Functions с помощью EasyAuth.

## <a name="aims"></a>Цели
Мы увидим, как управление API может быть использовано в упрощенном сценарии с функциями Azure и Azure AD B2C. Вы создадите приложение JavaScript (JS), вызывая API, которое подписывает пользователей с Azure AD B2C. Затем для защиты API API API Management будет использовать функции политики проверки jwt.

Для глубокой защиты мы используем EasyAuth для проверки токена снова внутри API бэк-энда.

## <a name="prerequisites"></a>Предварительные требования
Чтобы выполнить шаги в этой статье, необходимо иметь следующее:
* Учетная запись хранения v2 общего назначения Azure (StorageV2) для размещения приложения для хранения единой страницы переднего минисха JS
* Экземпляр управления API Azure 
* Пустое приложение Azure Function (запуск времени выполнения V2 .NET Core, в плане потребления Windows) для размещения так называемого API
* Арендатор Azure AD B2C, связанный с подпиской 

Хотя на практике ресурсы в одном и том же регионе используются в производственных нагрузках, для этой статьи область развертывания не имеет значения.

## <a name="overview"></a>Обзор
Вот иллюстрация компонентов в использовании и поток между ними, как только этот процесс завершен.
![Компоненты в использовании и потоке](../api-management/media/howto-protect-backend-frontend-azure-ad-b2c/image-arch.png "Компоненты в использовании и потоке")

Ниже приведен краткий обзор шагов.

1. Создание приложений Azure AD B2C (Frontend, API Management) и API-приложений с областями и предоставления доступа к API
1. Создайте регистрацию или входе в политики, чтобы пользователи смогут войти в систему С Azure AD B2C 
1. Настроите управление API с новыми идентиумами клиентов Azure AD B2C и ключами для включения авторизации пользователя OAuth2 в консоль разработчиков
1. Создание API функции
1. Настроите API функции, чтобы включить EasyAuth с новым идентификатором и ключами клиента Azure AD B2C и заблокировать APIM VIP 
1. Создание определения API в управлении API
1. Настройка Oauth2 для конфигурации API Management API
1. Настройка политики **CORS** и добавление политики **проверки jwt** для проверки токена OAuth для каждого входящего запроса
1. Создание вызывающей приложения для потребления API
1. Загрузить образец JS SPA
1. Нанастройка примера JS Клиентское приложение с новым Идентификатором клиента Azure AD B2C и ключами 
1. Протестировать клиентское приложение

## <a name="configure-azure-ad-b2c"></a>Настройка Azure AD B2C 
Откройте лезвие Azure AD B2C на портале и сделайте следующие шаги.
1. Выберите вкладку **Приложения** 
1. Нажмите кнопку 'Добавить' и создайте три приложения для следующих целей
   * Фронтенд Клиент.
   * API функции бэкэнда.
   * (Необязательно) Портал разработчика API Management (если вы не работаете с Управлением API Azure на уровне потребления, подробнее об этом сценарии позже).
1. Установите WebApp / Web API для всех 3 приложений и установите "Разрешить неявный поток" на "да" только для Frontend Client.
1. Теперь установите App ID URI, выберите что-то уникальное и отношение к создаваемой службе.
1. Используйте заполнители для URL-адресов ответов на данный момент, такие как, https://localhostмы будем обновлять эти URL-адреса позже.
1. Нажмите "Создать", а затем повторить шаги 2-5 для каждого из трех приложений выше, запись AppID URI, имя и идентификатор приложения для последующего использования для всех трех приложений.
1. Откройте приложение API Management Developer Portal из списка приложений и выберите вкладку *Keys* (под общим управлением), а затем нажмите кнопку "Generate Key", чтобы создать ключ auth
1. При нажатии сохранить, запишите ключ где-то безопасно для последующего использования - обратите внимание, что это место - единственный шанс вы получите, чтобы посмотреть и скопировать этот ключ.
1. Теперь выберите *вкладку «Опубликованные области»* (под доступом API)
1. Создайте и назовите область действия API функции и запишите область действия и заселенное значение полной области, а затем нажмите кнопку «Сохранить».
   > [!NOTE]
   > Сферы Azure AD B2C фактически являются разрешениями в вашем API, к которым другие приложения могут запрашивать доступ через лезвие доступа API из своих приложений, фактически вы только что создали разрешения приложений для вызванного API.
1. Откройте два других приложения, а затем посмотрите под вкладкой *API Access.*
1. Предоставить им доступ к области API бэкэнда и уже имеющемуся ("Доступ к профилю пользователя").
1. Создайте их ключ каждый, выбрав *вкладку ключи* под "Генерал" для создания ключа auth и записи этих ключей в безопасном месте на потом.

## <a name="create-a-sign-up-or-sign-in-user-flow"></a>Создание потока пользователей "Зарегистрируйтесь или восподписании"
1. Возвращение к корню (или "Обзор") лезвия Azure AD B2C 
1. Затем выберите "Потоки пользователей (политики)" и нажмите кнопку "Новый поток пользователей"
1. Выберите тип потока пользователя «Зарегистрируйтесь и воведите»
1. Дайте политику имя и запишите его на более поздний срок.
1. Затем под 'Identity провайдеров', а затем проверить 'User ID зарегистрироваться' (это может сказать "Электронная почта зарегистрироваться") и нажмите OK. 
1. В соответствии с "Атрибуты пользователей и претензий", нажмите "Показать больше ... затем выберите варианты претензий, которые вы хотите, чтобы ваши пользователи ввели и вернулись в маркер. Проверьте, по крайней мере, "Имя дисплея" и "Адрес электронной почты", чтобы собрать и вернуть, и нажмите "OK", а затем нажмите кнопку "Создать".
1. Выберите политику, созданную в списке, а затем нажмите кнопку «Запуск потока пользователей».
1. Это действие откроет лезвие потока пользователя, выберет приложение интерфейса, а затем запишет адрес b2clogin.com домена, отображаемого под выпадающим для домена 'Select'.
1. Нажмите на ссылку в верхней части, чтобы открыть "хорошо известный openid конечной точки конфигурации", и записывать authorization_endpoint и token_endpoint значения, а также значение самой ссылки, как хорошо известный openid конечной конфигурации.

   > [!NOTE]
   > Политики B2C позволяют разоблачать конечные точки входа Azure AD B2C, чтобы иметь возможность по-разному фиксировать различные компоненты данных и подписывать их в пользователях. В этом случае мы настроили знак или регистрацию в конечную точку, которая обнажила хорошо известную конечную точку конфигурации, в частности, наша созданная политика была идентифицирована в URL по параметру p'.
   > 
   > Как только это будет сделано - теперь у вас есть функциональная платформа бизнес-потребитель идентичности, которая будет подписывать пользователей в нескольких приложениях. 
   > Если вы хотите, чтобы вы можете нажать кнопку "Запуск потока пользователей" здесь (чтобы пройти через зарегистрироваться или войти в процесс) и почувствовать, что он будет делать на практике, но шаг перенаправления в конце не удастся, как приложение еще не было развернуто.

## <a name="build-the-function-api"></a>Создание API функции
1. Вернитесь к стандартному клиенту Azure AD на портале Azure, чтобы мы могли настроить элементы в вашей подписке снова 
1. Перейдите на лезвие функциональных приложений портала Azure, откройте приложение для пустой функции, а затем создайте новую функцию In-Portal 'Webhook и API' с помощью быстрого запуска.
1. Вставьте образец кода снизу в Run.csx над существующим кодом, который появляется.

   ```csharp
   
   using System.Net;
   using Microsoft.AspNetCore.Mvc;
   using Microsoft.Extensions.Primitives;
   
   public static async Task<IActionResult> Run(HttpRequest req, ILogger log)
   {
      log.LogInformation("C# HTTP trigger function processed a request.");
      
      return (ActionResult)new OkObjectResult($"Hello World, time and date are {DateTime.Now.ToString()}");
   }
   
   ```

   > [!NOTE]
   > Код функции скрипта, который вы только что вставили, просто регистрирует строку в журналы функций и возвращает текст "Hello World" с некоторыми динамическими данными (дата и время).

3. Выберите "Интеграция" из левого лезвия, а затем выберите "Продвинутый редактор" в правом верхнем углу панели.
4. Вставьте образец кода ниже над существующим Json.

   ```json
   {
      "bindings": [
       {
        "authLevel": "function",
        "name": "req",
        "type": "httpTrigger",
        "direction": "in",
        "methods": [
           "get"
        ],
        "route": "hello"
       },
       {
         "name": "$return",
         "type": "http",
         "direction": "out"
       }
     ]
   }
   ```

5. Вернитесь на вкладку HttpTrigger1, нажмите кнопку "Получить URL функции", а затем скопировать URL-адрес, который появляется.

   > [!NOTE]
   > Привязки вы только что создали просто сказать Функции ответить на анонимные запросы http GET на URL вы только что скопировали. (https://yourfunctionappname.azurewebsites.net/api/hello?code=secretkey) Теперь у нас есть масштабируемый безсерверный https API, который способен вернуть очень простую полезную нагрузку.
   > Теперь вы можете протестировать вызов этого API из веб-браузера, используя URL выше, вы также можете лишить ?code-secret часть URL-адреса и доказать, что Azure Functions вернет ошибку 401.

## <a name="configure-and-secure-the-function-api"></a>Настройка и безопасность API функции
1. Две дополнительные области в приложении функции должны быть настроены (Auth и сетевые ограничения).
1. Во-первых, давайте настройим аутентификацию / авторизацию, так &lt;&gt; что нажмите на имя приложения функции (рядом с иконой функций), чтобы показать страницу обзора.
1. Далее Выберите вкладку «Функции платформы» и выберите «Аутентификация / Авторизация».
1. Включите функцию аутентификации службы приложений.
1. В рамках "Аутентификации провайдеры" выбирают "Активный каталог Azure" и выбирают "Advanced" из коммутатора режима управления.
1. Вставьте идентификатор приложения Функции Бэкэнда (от Azure AD B2C в поле 'Client ID')
1. Вставьте известную конечную точку конфигурации open-id от регистрации или войти в политику в поле URL-адреса эмитента (мы записали эту конфигурацию ранее).
1. Нажмите кнопку "ОК".
1. Установите действие, которое необходимо принять, когда запрос не является аутентифицированным отсеивом для "Вход в с Azure Active Directory", а затем нажмите Сохранить.

   > [!NOTE]
   > Теперь ваш API функции развернут и должен бросить 401 ответ, если правильный ключ не поставляется, и должен вернуть данные при представлении действительного запроса.
   > Вы добавили дополнительную защитную безопасность в EasyAuth, настроив опцию «Login With Azure AD» для обработки непроверенных запросов. Имейте в виду, что это изменит поведение несанкционированного запроса между приложением Backend Function App и Frontend SPA, так как EasyAuth выдаст 302 перенаправления в AAD вместо ответа 401 Not Authorized, мы исправим это с помощью Управления API позже.
   > У нас до сих пор нет IP-безопасности применяется, если у вас есть действительный ключ и токен OAuth2, любой может назвать это из любого места - в идеале мы хотим, чтобы заставить все запросы прийти через API Management.
   > Если вы используете уровень потребления API Management, вы не сможете выполнить эту блокировку VIP, так как для этого уровня нет выделенного статического IP- исключа, вам нужно будет полагаться на метод блокировки ваших вызовов API через общий секретный ключ функции , поэтому шаги 11-13 не будет возможным.

1. Закройте лезвие «Аутентификация / Авторизация» 
1. Выберите «Сеть», а затем выберите «Ограничения доступа»
1. Затем заблокируйте I-е-х по функциям приложения для функции в VIP-персоне Управления API. Этот VIP показан в разделе API - обзорном разделе портала.
1. Если вы хотите продолжать взаимодействовать с функциями портала, и для выполнения дополнительных шагов ниже, вы должны добавить свой собственный публичный IP-адрес или диапазон CIDR здесь тоже.
1. После включения в список есть разрешителяя запись, Azure добавляет правило неявного отрицания, чтобы заблокировать все другие адреса. 

Вам нужно будет добавить отформатированные CIDR блоки адресов в панель ограничений IP. When you need to add a single address such as the API Management VIP, you need to add it in the format xx.xx.xx.xx.

   > [!NOTE]
   > Теперь ваш API функции не должен быть callable из любого места, кроме как через управление API, или ваш адрес.
   
## <a name="import-the-function-app-definition"></a>Импортировать определение приложения функции
1. Откройте *лезвие управления API,* а затем откройте *экземпляр.*
1. Выберите API Blade из раздела Управления API вашего экземпляра.
1. Из панели «Добавить новый API» выберите «Функциональное приложение», а затем выберите «Полный» из верхней части всплывающих данных.
1. Нажмите «Просмотрите», выберите функциональное приложение, в которых вы размещаете API внутри, и выберите кнопку.
1. Дайте API имя и описание для внутреннего использования API Management и добавьте его в «неограниченный» продукт.
1. Убедитесь, что вы записываете базовый URL для последующего использования, а затем нажмите создать.

## <a name="configure-oauth2-for-api-management"></a>Настройка Oauth2 для управления API

1. Далее выберите лезвие Oauth 2.0 из вкладки безопасности и нажмите кнопку "Добавить"
1. Дайте значения для *имени дисплея* и *описания* добавленной точки Oauth (эти значения будут отображаться на следующем этапе в качестве конечной точки Oauth2).
1. Вы можете ввести любое значение в URL-адресе страницы регистрации Клиента, так как это значение не будет использоваться.
1. Проверьте тип *Implicit Auth* Grant и оставьте тип гранта кода авторизации проверенным.
1. Перейдите к полям конечных точек *авторизации* и *маркеров* и введите значения, захваченные ранее из известного документа xml конфигурации.
1. Прокрутите вниз и заселите *дополнительный параметр тела,* называемый «ресурсом» с идентификатором клиента Backend Function API от регистрации приложения Azure AD B2C
1. Выберите "Клиентские учетные данные", установите идентификатор клиента в идентификатор приложения консоли разработчика - пропустите этот шаг при использовании модели управления API потребления.
1. Установите секрет клиента на ключ, который вы записали ранее - пропустить этот шаг при использовании модели управления API потребления.
1. Наконец, теперь запишите redirect_uri гранта ath code от API Management для последующего использования.

## <a name="set-up-oauth2-for-your-api"></a>Настройка Oauth2 для Вашего API
1. Ваш API появится на левой стороне портала в разделе "Все API", откройте API, нажав на него.
1. Выберите вкладку "Настройки".
1. Обновите настройки, выбрав кнопку "Oauth 2.0" из кнопки радиоавторизации пользователя.
1. Выберите сервер Oauth, который вы определили ранее.
1. Проверьте флажок 'Override scope' и введите область, записанную ранее для вызова API бэкэнда.

   > [!NOTE]
   > Теперь у нас есть экземпляр Управления API, который знает, как получить токены доступа от Azure AD B2C для авторизации запросов и понимает нашу конфигурацию Oauth2 Active Directory B2C.

## <a name="set-up-the-cors-and-validate-jwt-policies"></a>Настройка политик **CORS** и **проверки jwt**

> Следующие разделы должны следовать независимо от используемого уровня APIM. 

1. Вернитесь на вкладку проектирования и выберите "Все AI", а затем нажмите кнопку просмотра кода, чтобы показать редакторполитики.
1. Оторите входящий раздел и вставьте ниже xml поэтому оно читает как следующее.

   ```xml
   <inbound>
      <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized. Access token is missing or invalid.">
         <openid-config url="https://tenant.b2clogin.com/tenant.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=B2C_1_MyDefaultPolicy" />
         <required-claims>
            <claim name="aud">
               <value>your-backend-api-application-client-id</value>
            </claim>
         </required-claims>
      </validate-jwt>
      <cors>
         <allowed-origins>
            <origin>*</origin>
         </allowed-origins>
         <allowed-methods>
           <method>GET</method>
         </allowed-methods>
         <allowed-headers>
            <header>*</header>
         </allowed-headers>
         <expose-headers>
           <header>*</header>
         </expose-headers>
       </cors>
   </inbound>
   ```
1. Отспособьте URL-адрес openid-конфигурации в соответствии с хорошо известным конечным пунктом Azure AD B2C для регистрации или регистрации в политике.
1. Отспособьте значение претензии в соответствии с действительным идентификатором приложения, также известным как идентификатор клиента для приложения API бэкэнда и сохраните.

   > [!NOTE]
   > Теперь руководство API может отвечать на запросы о перекрестном происхождении в приложениях JS SPA, и оно будет выполнять регулирование, ограничение скорости и предварительную проверку токена JWT, передаваемого перед пересылкой запроса на API функции.

   > [!NOTE]
   > Следующий раздел является необязательным и не распространяется на уровень **потребления,** который не поддерживает портал разработчика.
   > Если вы не собираетесь использовать портал разработчика или не можете использовать его, так как вы используете уровень потребления, пожалуйста, пропустите этот шаг и перейдите прямо к ["Построить JavaScript SPA, чтобы потреблять API".](#build-the-javascript-spa-to-consume-the-api)

## <a name="optional-configure-the-developer-portal"></a>(Необязательно) Настройка портала разработчиков

1. Откройте лезвие Azure AD B2C и перейдите к регистрации приложения для портала разработчиков
1. Установите запись "Ответить URL" на тот, который вы отметили вниз, когда вы настроили redirect_uri гранта кода Auth в API Management ранее.

   Теперь, когда авторизация пользователя OAuth `Echo API`2.0 включена на , консоль разработчика получает токен доступа для пользователя, прежде чем позвонить в API.

1. Просмотрите любую операцию в рамках `Echo API` портала разработчика и выберите **подобрать ее,** чтобы привести вас к консоли разработчика.
1. Обратите внимание на новый элемент в разделе **Авторизация,** соответствующий только что добавленного серверу авторизации.
1. Выберите **код авторизации** из списка авторизации, и вам будет предложено войти в список AD Azure. Если вы уже зарегистрировались в учетной записи, вам может не быть предложено.
1. После успешного входе `Authorization: Bearer` в систему к запросу добавляется заголовок с токеном доступа из Azure AD B2C, закодированным в Base64. 
1. Выберите **Отправить,** и вы можете вызвать API успешно.

   > [!NOTE]
   > Теперь руководство API может приобретать токены для портала разработчика для тестирования API и может понять его определение и сделать соответствующую тестовую страницу на портале разработчиков.

1. Из обзора blade портала управления API нажмите кнопку "Портал разработчиков", чтобы войти в систему в качестве администратора API.
1. Здесь вы и другие выбранные потребители Вашего API можете протестировать и вызвать их с консоли.
1. Выберите 'Продукты', затем выберите 'Unlimited', затем выберите API, который мы создали ранее, и нажмите кнопку 'TRY IT'
1. Отключите ключ подписки API и скопируйте его в безопасном месте вместе с URL-адресом запроса, который вам понадобится позже.
1. Кроме того, выберите неявные, от Oauth Auth dropdown и вы, возможно, придется проверить подлинность здесь с всплывающее окно.
1. Нажмите кнопку "Отправить", и если все хорошо, ваше приложение функция должна ответить на привет сообщение через управление API с 200 OK сообщение и некоторые JSON.

   > [!NOTE]
   > Поздравляем вас, теперь у вас есть Azure AD B2C, Управление API и функции Azure, работающие вместе, чтобы публиковать, обезопасить и потреблять API. Вы могли заметить, что API на самом деле защищен дважды с помощью этого метода, один раз с API Управления Ocp-Подписка-ключ заголовок, и один раз с авторизации: Носитель JWT.
   > Вы были бы правы, так как этот пример является JavaScript одностраничное приложение, мы используем ключ управления API только для ограничения скорости и выставления счетов звонки.
   > Фактическая авторизация и аутентификация обрабатываются Azure AD B2C и инкапсулируется в JWT, который проверяется дважды, один раз по управлению API, а затем функциями Azure.

## <a name="build-the-javascript-spa-to-consume-the-api"></a>Создайте JAVAScript SPA для потребления API
1. Откройте лезвие учетных записей на портале Azure 
1. Выберите созданную учетную запись и выберите лезвие «Статический веб-сайт» из раздела «Настройки» (если вы не видите опцию «Статический веб-сайт», проверьте, что вы создали учетную запись V2).
1. Установите функцию статического веб-хостинга на "включено" и установите имя документа индекса на 'index.html', а затем нажмите кнопку "Сохранить".
1. Запишите содержимое основной конечной точки, так как это место, где будет размещен сайт прифронтового. 

   > [!NOTE]
   > Вы можете использовать либо Azure Blob Storage и CDN переписать, или Azure App Service - но функция статического веб-сайта Blob Storage дает нам контейнер по умолчанию для обслуживания статического веб-контента / html / js / css из Azure Storage и сделает вывод о странице по умолчанию для нас за нулевую работу.

## <a name="upload-the-js-spa-sample"></a>Загрузить образец JS SPA
1. Все еще в лезвии учетной записи хранилища выберите лезвие 'Blobs' из раздела Blob Service и нажмите на контейнер $web, который появляется в правой панели.
1. Сохраните приведенный ниже код файла локально на вашей машине в качестве index.html, а затем загрузить файл index.html в $web контейнер.

   ```html
   <!doctype html>
   <html lang="en">
   <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Sample JS SPA</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
   </head>
   <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <nav class="navbar navbar-expand-lg navbar-light bg-light navbar-dark bg-dark">
                        <a class="navbar-brand" href="#">Sample Code</a>
                        <ul class="navbar-nav ml-md-auto">
                            <li class="nav-item dropdown">
                                <a class="btn btn-large btn-success" onClick="login()">Sign In</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="jumbotron">
                        <h2>
                    <div id="message">Hello, world!</div>
                    </h2>
                        <p>
                            <a class="btn btn-primary btn-large" onClick="GetAPIData()">Call API</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.js"></script>
        <script lang="javascript">
            var applicationConfig = {
                clientID: "clientidgoeshere",
                authority: "https://tenant.b2clogin.com/tfp/tenant/policy",
                b2cScopes: ["https://tenant/app/scope"],
                webApi: 'http://functionurl',
                subKey: 'apimkeygoeshere'
            };
            var msalConfig = {
                auth: {
                        clientId: applicationConfig.clientID, 
                        authority:  applicationConfig.authority,
                        validateAuthority: false
                },
                cache: {
                        cacheLocation: "localStorage",
                        storeAuthStateInCookie: true
                }
            };
            var clientApplication = new Msal.UserAgentApplication(msalConfig);
            function login() {
                var loginRequest = {
                    scopes: applicationConfig.b2cScopes
                };
                clientApplication.loginPopup(loginRequest).then(function (loginResponse) {
                    var tokenRequest = {
                        scopes: applicationConfig.b2cScopes
                    };
                    clientApplication.acquireTokenSilent(tokenRequest).then(function (tokenResponse) {
                        document.getElementById("signinbtn").innerHTML = "Logged in as: " + clientApplication.account.name;
                        document.getElementById("callapibtn").hidden = false
                        }).catch(function (error) {
                            clientApplication.acquireTokenPopup(tokenRequest).then(function (tokenResponse) {
                                }).catch (function (error) {
                                    console.log("Error acquiring the popup:\n" + error);
                                });
                        })
                    }).catch (function (error) {
                        console.log("Error during login:\n" + error);
                });
            }
            function GetAPIData() {
                var tokenRequest = {
                    scopes: applicationConfig.b2cScopes
                }
                clientApplication.acquireTokenSilent(tokenRequest).then(function (tokenResponse) {
                    callApiWithAccessToken(tokenResponse.accessToken);
                    }).catch(function (error) {
                        clientApplication.acquireTokenPopup(tokenRequest).then(function (tokenResponse) {
                            callApiWithAccessToken(tokenResponse.accessToken);
                            
                        }).catch(function (error) {
                            console.log("Error acquiring the access token to call the Web api:\n" + error);
                        });
                    })
            }
            function callApiWithAccessToken(token)
            {
                console.log("calling "  + applicationConfig.webApi +  " with " + token);
                    // Make the api call here
                $.ajax({
                    type: "get",
                    headers: {'Authorization': 'Bearer ' + token, 'Ocp-Apim-Subscription-Key': applicationConfig.subKey},                   url: applicationConfig.webApi
                }
                ).done(function (body) {
                    document.getElementById("message").innerHTML = "The API Said " + body;
                });
            }
        </script>
    </body>
   </html>
   
   ```

1. Просмотрите первичную конечную точку веб-сайта, сохраненную ранее в последнем разделе.

   > [!NOTE]
   > Поздравляем, вы только что развернули приложение JavaScript Single Page App в Azure Storage, так как мы еще не настроили приложение JS с вашими ключами для api или настроили приложение JS с вашими деталями Azure AD B2C — страница еще не будет работать, если вы откроете его.

## <a name="configure-the-js-spa-for-azure-ad-b2c"></a>Нанастройка JS SPA для Azure AD B2C
1. Теперь мы знаем, где все: мы можем настроить SPA с соответствующим адресом API Management API и правильным приложением Azure AD B2C/ идентионное дело клиента
1. Вернитесь к лезвию хранения портала Azure и нажмите на index.html, а затем выберите 'Edit Blob' 
1. Обновите сведения auth в соответствии с вашим фронтовым приложением, которое вы зарегистрировали в B2C ранее, отметив, что значения 'b2cScopes» для бэкэнда API.
1. Ключ webApi и URL-адрес api можно найти в тестовом панели Управления API для операции API.
1. Создайте ключ подписки APIM, отправившись в управление API, вернитесь к лезвию управления API, выбрав «Подписку» и нажав кнопку «Добавить подписку», а затем сохранив запись. Нажав на Ellipsis (...) рядом с созданной строкой позволит вам показать ключи, чтобы вы могли скопировать основной ключ.
1. Он должен выглядеть примерно так же, как ниже код:-  

   ```javascript
   var applicationConfig =
      clientID: "{aadb2c-clientid-goeshere}",
      authority: "https://{tenant}.b2clogin.com/{tenant}/{policy}",
      b2cScopes: ["https://{tenant}/{app}/{scope}"], 
      webApi: 'http://{apim-url-for-your-function}',
      subKey: '{apim-subscription-key-goes-here}'
   };
   ```

1. Щелкните Сохранить

## <a name="set-the-redirect-uris-for-the-azure-ad-b2c-frontend-app"></a>Установите перенаправление URIs для припередательного приложения Azure AD B2C
1. Откройте лезвие Azure AD B2C и перейдите к регистрации приложения для приложения JavaScript Frontend
1. Установите URL-адрес перенаправления на тот, который вы отметили, когда вы ранее настраивали статическую основную конечную точку веб-сайта выше

   > [!NOTE] 
   > Эта конфигурация приведет к тому, что клиент приложения frontend получит токен доступа с соответствующими претензиями от Azure AD B2C.
   > SPA сможет добавить это в качестве маркера носителя в заголовке https в вызове к бэкэнду API.
   > API Management предварительно проверит токен, ограничивающий скорость вызовы к конечной точке ключом абонента, прежде чем передать запрос в наполучениеющий Azure Function API.
   > SPA будет оказывать ответ в браузере.

   > *Поздравляем, вы настроили Azure AD B2C, управление API Azure, функции Azure, авторизацию службы приложений Azure для работы в полной гармонии!*

   > [!NOTE]
   > Теперь у нас есть простое приложение с простым защищенным API, давайте протестируем его.

## <a name="test-the-client-application"></a>Протестировать клиентское приложение
1. Откройте URL-адрес приложения, который вы отметили, из созданной ранее учетной записи хранилища
1. Нажмите кнопку "Войти" в правом верхнем углу, этот клик появится ваш Azure AD B2C зарегистрироваться или войти в профиль.
1. Почтовый знак в разделе "Войти как" экран будет заселен от вашего JWT.
1. Теперь нажмите кнопку "Вызов Web Api", и вы, страница должна обновляться с значениями, отправленными обратно из защищенного API.

## <a name="and-were-done"></a>И мы закончили
Приведенные выше шаги могут быть адаптированы и отредактированы, чтобы позволить много различных видов использования Azure AD B2C с API Management.

## <a name="next-steps"></a>Дальнейшие действия
* Узнайте больше об [Azure Active Directory и OAuth 2.0](../active-directory/develop/authentication-scenarios.md).
* См. другие [видео](https://azure.microsoft.com/documentation/videos/index/?services=api-management) об управлении API.
* Другие способы защиты внутренней серверной службы см. в разделе [Взаимная проверка подлинности на основе сертификата](api-management-howto-mutual-certificates.md).
* [Создайте экземпляр службы управления API.](get-started-create-service-instance.md)
* [Импорт и публикация первого API](import-and-publish.md)
