---
title: Мониторинг опубликованных API-интерфейсов в службе управления API Azure | Документация Майкрософт
description: Следуйте инструкциям из этого руководства, чтобы узнать, как выполнять мониторинг API в службе управления API Azure.
services: api-management
documentationcenter: ''
author: vladvino
manager: cfowler
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.custom: mvc
ms.topic: tutorial
ms.date: 06/15/2018
ms.author: apimpm
ms.openlocfilehash: b06301ab424a29d8f0e31e8f4dee26265327896b
ms.sourcegitcommit: 509b39e73b5cbf670c8d231b4af1e6cfafa82e5a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78359734"
---
# <a name="monitor-published-apis"></a>Мониторинг опубликованных API-интерфейсов

С помощью Azure Monitor можно визуализировать, запрашивать, маршрутизировать, архивировать метрики или журналы, полученные от ресурсов Azure, а также реагировать на них.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Просмотр журналов действий
> * просмотр журналов диагностики;
> * просмотр метрик API; 
> * настройка правила генерации оповещений на случай несанкционированных вызовов API.

В следующем видео показано, как отслеживать управление API с помощью Azure Monitor. 

> [!VIDEO https://channel9.msdn.com/Blogs/AzureApiMgmt/Monitor-API-Management-with-Azure-Monitor/player]

## <a name="prerequisites"></a>Предварительные требования

+ Ознакомьтесь с [терминологией службы управления API в Azure](api-management-terminology.md).
+ Выполните инструкции из краткого руководства [Создание экземпляра службы управления API Azure](get-started-create-service-instance.md).
+ Также выполните инструкции из руководства [Импорт и публикация первого API](import-and-publish.md).

[!INCLUDE [premium-dev-standard-basic.md](../../includes/api-management-availability-premium-dev-standard-basic.md)]

## <a name="view-metrics-of-your-apis"></a>Просмотр метрик API

Служба управления API каждую минуту передает метрики, позволяя отслеживать состояние и работоспособность API-интерфейсов практически в реальном времени. Ниже приведено описание некоторых доступных метрик.

* Емкость: позволяет принимать решения о необходимости повышения или понижения уровня служб Управления API. Метрика отправляется каждую минуту и отражает емкость шлюза в момент создания отчета. Значение метрики колеблется в диапазоне от 0 до 100. Оно вычисляется на основе ресурсов шлюза, таких как загрузка центрального процессора и использование памяти.
* Общее количество запросов к шлюзу. Количество запросов API за период. 
* Успешные запросы к шлюзу. Количество запросов API, которые успешно получили коды ответов HTTP, включая 304, 307 и все, не превышающие 301 (например, 200).
* Неудачные запросы к шлюзу. Количество запросов API, которые получили ошибочные коды ответов HTTP, включая 400 и все, превышающие 500.
* Неавторизованные запросы к шлюзу. Количество запросов API, которые получили коды ответов HTTP, включая 401, 403 и 429.
* Другие запросы к шлюзу. Количество запросов API, которые получили коды ответов HTTP, не принадлежащие ни к одной из указанных выше категорий (например, 418).

![Диаграмма метрик](./media/api-management-azure-monitor/apim-monitor-metrics.png)

Для доступа к метрике сделайте следующее:

1. В меню внизу страницы выберите пункт **Метрика**.

    ![Метрики](./media/api-management-azure-monitor/api-management-metrics-blade.png)

1. В раскрывающемся списке выберите метрики, которые вас интересуют. Например, **Requests**. 
1. Просмотрите диаграмму с общим числом вызовов API.
1. Диаграмму можно отфильтровать с помощью измерений метрики **запросов**. Например, щелкните **Добавить фильтр**, выберите **Backend Response Code** (Код ответа серверной части) и введите 500 в качестве значения. Теперь на диаграмме показано количество запросов, завершившихся сбоем в серверной части API.   

## <a name="set-up-an-alert-rule-for-unauthorized-request"></a>Настройка правила генерации оповещений на случай несанкционированного запроса

Вы можете настроить получение уведомлений на основе метрик и журналов действий. Azure Monitor позволяет настроить действие, выполняемое при активации оповещения:

* Отправка уведомления по электронной почте.
* Вызов webhook.
* Вызов приложения логики Azure.

Чтобы настроить оповещения, сделайте следующее:

1. В меню внизу страницы выберите пункт **Оповещения**.

    ![оповещения](./media/api-management-azure-monitor/alert-menu-item.png)

2. Щелкните **Новое правило генерации оповещений** для нужного оповещения.
3. Щелкните **Добавить условие**.
4. В раскрывающемся списке "Тип сигнала" выберите **Метрики**.
5. Выберите **Unauthorized Gateway Requests** (Несанкционированные запросы через шлюз) в качестве сигнала для мониторинга.

    ![оповещения](./media/api-management-azure-monitor/signal-type.png)

6. В представлении **Настроить логику сигналов** укажите пороговое значение, после которого будет активироваться оповещение, и щелкните **Готово**.

    ![оповещения](./media/api-management-azure-monitor/threshold.png)

7. Создайте группу действий или выберите имеющуюся. В примере ниже сообщение электронной почты будет отправляться администраторам. 

    ![оповещения](./media/api-management-azure-monitor/action-details.png)

8. Введите имя и описание правила генерации оповещений и выберите уровень серьезности. 
9. Нажмите кнопку **Создать правило генерации оповещений**.
10. Теперь попытайтесь вызвать Conference API без ключа API. Активируется оповещение, и администраторам будет отправлено сообщение электронной почты. 

## <a name="activity-logs"></a>Журналы действий

Журналы действий позволяют подробно проанализировать операции, выполненные в службах управления API. С помощью журналов изменений можно ответить на вопросы "что? кто? когда?" о любой операции записи (PUT, POST, DELETE) в службах управления API.

> [!NOTE]
> Журналы действий не содержат операций чтения (GET) и операций, выполненных на портале Azure или с помощью исходных API управления.

Вы можете получить доступ к журналам действий в службе управления API или получить доступ к журналам всех ресурсов Azure в Azure Monitor. 

![Журналы действий](./media/api-management-azure-monitor/apim-monitor-activity-logs.png)

Чтобы просмотреть журналы действий, сделайте следующее:

1. Выберите свой экземпляр службы управления API.
2. Щелкните **Журнал действий**.

    ![Журнал действий](./media/api-management-azure-monitor/api-management-activity-logs-blade.png)

3. Выберите требуемую область фильтрации и щелкните **Применить**.

## <a name="diagnostic-logs"></a>Журналы диагностики

Журналы диагностики предоставляют подробные сведения об операциях и ошибках, которые важны для аудита, а также для устранения неполадок. Журналы диагностики отличаются от журналов действий. Журналы действий позволяют подробно проанализировать операции, выполненные с ресурсами Azure. Журналы диагностики дают представление об операциях, выполняемых ресурсом.

Настройка журналов диагностики.

1. Выберите свой экземпляр службы управления API.
2. Щелкните **Параметры диагностики**.

    ![Журналы диагностики](./media/api-management-azure-monitor/api-management-diagnostic-logs-blade.png)

3. Щелкните **Включить диагностику**. Вы можете архивировать журналы диагностики и метрики в учетную запись хранения, передать их потоком в концентратор событий или отправить в журналы Azure Monitor. 

Сейчас в службе управления API предоставляются журналы диагностики (выполняемые в пакетном режиме каждый час) отдельных запросов API со следующей схемой каждой записи:

```json
{  
    "isRequestSuccess" : "",
    "time": "",
    "operationName": "",
    "category": "",
    "durationMs": ,
    "callerIpAddress": "",
    "correlationId": "",
    "location": "",
    "httpStatusCodeCategory": "",
    "resourceId": "",
    "properties": {   
        "method": "", 
        "url": "", 
        "clientProtocol": "", 
        "responseCode": , 
        "backendMethod": "", 
        "backendUrl": "", 
        "backendResponseCode": ,
        "backendProtocol": "",  
        "requestSize": , 
        "responseSize": , 
        "cache": "", 
        "cacheTime": "", 
        "backendTime": , 
        "clientTime": , 
        "apiId": "",
        "operationId": "", 
        "productId": "", 
        "userId": "", 
        "apimSubscriptionId": "", 
        "backendId": "",
        "lastError": { 
            "elapsed" : "", 
            "source" : "", 
            "scope" : "", 
            "section" : "" ,
            "reason" : "", 
            "message" : ""
        } 
    }      
}  
```

| Свойство  | Тип | Описание |
| ------------- | ------------- | ------------- |
| isRequestSuccess | Логическое | Значение true, если в ответ на HTTP-запрос получен код состояния ответа в пределах диапазона 2xx или 3xx |
| time | date-time | Метка времени начала обработки запроса шлюзом |
| operationName | строка | Постоянное значение Microsoft.ApiManagement/GatewayLogs |
| категория | строка | Постоянное значение GatewayLogs |
| durationMs | Целое число | Количество миллисекунд с момента поступления запроса в шлюз до момента полной отправки ответа. Он включает clienTime, cacheTime и backendTime. |
| callerIpAddress | строка | IP-адрес непосредственно вызывающего объекта шлюза (может быть посредником) |
| correlationId | строка | Уникальный идентификатор HTTP-запроса, назначенный службой управления API |
| location | строка | Имя региона Azure, в котором находится шлюз, обработавший запрос |
| httpStatusCodeCategory | строка | Категория кода состояния HTTP-ответа: успешно (301 или меньше, 304 или 307), запрос не авторизован (401, 403, 429), ошибка (400, от 500 до 600), другое |
| resourceId | строка | Идентификатор ресурса управления API /SUBSCRIPTIONS/\<подписка>/RESOURCEGROUPS/\<группа_ресурсов>/PROVIDERS/MICROSOFT.APIMANAGEMENT/SERVICE/\<имя> |
| properties | объект | Свойства текущего запроса |
| method | строка | Метод HTTP входящего запроса |
| url | строка | URL-адрес входящего запроса |
| clientProtocol | строка | Версия протокола HTTP входящего запроса |
| responseCode | Целое число | Код состояния ответа HTTP, отправленного клиенту |
| backendMethod | строка | Метод HTTP запроса, отправленного в серверную часть |
| backendUrl | строка | URL-адрес запроса, отправленного в серверную часть |
| backendResponseCode | Целое число | Код HTTP-ответа, полученного от серверной части |
| backendProtocol | строка | Версия протокола HTTP для запроса, отправленного в серверную часть | 
| requestSize | Целое число | Число байтов, полученных от клиента во время обработки запроса | 
| responseSize | Целое число | Число байтов, отправленных клиенту во время обработки запроса | 
| cache | строка | Состояние участия кэша управления API в обработке запроса (т. е. попадания, пропуски, ничего) | 
| cacheTime | Целое число | Время в миллисекундах, затраченное на все операции ввода-вывода кэша службы управления API (подключение, отправка и получение байтов) | 
| backendTime | Целое число | Время в миллисекундах, затраченное на все операции ввода-вывода серверной части (подключение, отправка и получение байтов) | 
| clientTime | Целое число | Время в миллисекундах, затраченное на все операции ввода-вывода клиента (подключение, отправка и получение байтов) | 
| apiId | строка | Идентификатор сущности API для текущего запроса | 
| operationId | строка | Идентификатор сущности операции для текущего запроса | 
| productId | строка | Идентификатор сущности продукта для текущего запроса | 
| userId | строка | Идентификатор сущности пользователя для текущего запроса | 
| apimSubscriptionId | строка | Идентификатор сущности подписки для текущего запроса | 
| backendId | строка | Идентификатор сущности серверной части для текущего запроса | 
| lastError | объект | Ошибка обработки последнего запроса | 
| elapsed | Целое число | Время в миллисекундах, истекшее с момента поступления запроса в шлюз и до момента возникновения ошибки | 
| source | строка | Имя политики или внутреннего обработчика, вызвавшего ошибку | 
| область | строка | Область действия документа, содержащего политику, которая вызвала ошибку | 
| section | строка | Раздел документа, содержащего политику, которая вызвала ошибку | 
| reason | строка | Причина ошибки | 
| message | строка | Сообщение об ошибке | 

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Просмотр журналов действий
> * просмотр журналов диагностики;
> * просмотр метрик API;
> * настройка правила генерации оповещений на случай несанкционированных вызовов API.

Перейдите к следующему руководству:

> [!div class="nextstepaction"]
> [Трассировка вызовов](api-management-howto-api-inspector.md)
