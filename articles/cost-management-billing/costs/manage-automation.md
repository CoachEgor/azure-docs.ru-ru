---
title: Автоматизация управления затратами Azure
description: В этой статье объясняется, как можно управлять затратами Azure с помощью автоматизации.
author: bandersmsft
ms.author: banders
ms.date: 04/15/2020
ms.topic: conceptual
ms.service: cost-management-billing
ms.reviewer: adwise
ms.openlocfilehash: 0727f98b917944f3721c6c6758fde05c2efd8773
ms.sourcegitcommit: 0a5bb9622ee6a20d96db07cc6dd45d8e23d5554a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/05/2020
ms.locfileid: "84449837"
---
# <a name="manage-costs-with-automation"></a>Автоматизация управления затратами

С помощью автоматизации Управления затратами Azure можно создавать пользовательские наборы решений для получения данных о затратах и управления ими. В этой статье описаны распространенные сценарии автоматизации Управления затратами и параметры, доступные в зависимости от конкретной ситуации. Если вы хотите разрабатывать интерфейсы API, ознакомьтесь с представленными примерами общих запросов API, которые помогут ускорить процесс разработки.

## <a name="automate-cost-data-retrieval-for-offline-analysis"></a>Автоматизация получения данных о затратах для автономного анализа

Вам может потребоваться скачать данные о затратах Azure, чтобы объединить их с другими наборами данных. Вы также можете захотеть интегрировать данные о затратах в собственные системы. Существуют разные варианты сделать это, в зависимости от объема интересующих вас данных. В любом случае для использования API и инструментов вам необходимы разрешения Управления затратами в соответствующей области. Дополнительные сведения см. в разделе [Назначение доступа к данным](https://docs.microsoft.com/azure/cost-management-billing/costs/assign-access-acm-data).

## <a name="suggestions-for-handling-large-datasets"></a>Рекомендации по обработке больших наборов данных

Если ваша организация широко использует многие ресурсы и подписки Azure, у вас будет большой объем данных об использовании. Excel часто не может загружать такие большие файлы. В этом случае мы рекомендуем следующие варианты.

**Power BI**

Power BI используется для приема и обработки больших объемов данных. Если вы являетесь клиентом Соглашения Enterprise, то можете использовать приложение-шаблон Power BI для анализа затрат согласно выставленным счетам. Этот отчет содержит основные представления, используемые клиентами. Дополнительные сведения см. в разделе [Анализ затрат на Azure с помощью приложения-шаблона Power BI](https://docs.microsoft.com/azure/cost-management-billing/costs/analyze-cost-data-azure-cost-management-power-bi-template-app).

**Соединитель данных Power BI**

Если вы хотите анализировать данные ежедневно, мы рекомендуем использовать [соединитель данных Power BI](https://docs.microsoft.com/power-bi/connect-data/desktop-connect-azure-cost-management), чтобы получать данные для подробного анализа. Все созданные вами отчеты будут поддерживаться соединителем в актуальном состоянии по мере начисления затрат.

**Функция экспорта в Управлении затратами**

Возможно, вам не требуется анализировать данные ежедневно. В этом случае подумайте об использовании функции [экспорта](https://docs.microsoft.com/azure/cost-management-billing/costs/tutorial-export-acm-data) в службе "Управление затратами" для планирования экспорта данных в учетную запись хранения Azure. Затем можно загружать данные в Power BI по мере необходимости или анализировать их в Excel, если размер файла это позволяет. Функция экспорта доступна на портале Azure. Вы также можете настроить экспорт с помощью [API экспорта](https://docs.microsoft.com/rest/api/cost-management/exports).

**API сведений о потреблении**

Если ваш набор данных о затратах невелик, рассмотрите возможность использования [API сведений о потреблении](https://docs.microsoft.com/rest/api/consumption/usageDetails). При наличии большого количества данных о затратах следует запрашивать минимально возможный объем данных о потреблении за некоторый период. Для этого либо укажите небольшой диапазон времени, либо используйте в запросе фильтр. Например, если требуется получить данные о затратах за 3 года, этот API будет работать лучше, если вы будете вызывать его несколько раз для разных диапазонов времени, чем если вы сделаете один вызов для всего диапазона времени. После этого можно загрузить данные в Excel для дальнейшего анализа.

## <a name="automate-retrieval-with-usage-details-api"></a>Автоматизация получения с помощью API сведений о потреблении

[API сведений о потреблении](https://docs.microsoft.com/rest/api/consumption/usageDetails) — это простой способ получения необработанных и неагрегированных данных о затратах, соответствующих счету за использование Azure. Этот API полезен, если вашей организации требуется программное решение для получения данных. Если вы хотите анализировать небольшие наборы данных о затратах, рассмотрите возможность использования этого API. Однако при наличии больших наборов данных следует использовать другие решения, указанные ранее. Данные в сведениях о потреблении предоставляются в единицах измерения в день. Они используются при выставлении ежемесячного счета. Общедоступная версия этих API — `2019-10-01`. Используйте `2019-04-01-preview`, чтобы получить доступ к предварительной версии для резервирования и приобретения в Azure Marketplace с помощью этих API.

### <a name="usage-details-api-suggestions"></a>Предложения API сведений о потреблении

**Расписание запроса**

Рекомендуется делать _не более одного запроса_ в API сведений о потреблении в день. Дополнительные сведения о частоте обновления данных о затратах и обработке округления см. в разделе [Обзор данных службы "Управление затратами"](https://docs.microsoft.com/azure/cost-management-billing/costs/understand-cost-mgt-data#rated-usage-data-refresh-schedule).

**Целевые области верхнего уровня без фильтрации**

Используйте API для получения всех необходимых данных в области наивысшего уровня. Перед выполнением фильтрации, группирования или обзорного анализа дождитесь приема всех необходимых данных. Этот API оптимизирован для предоставления больших объемов необработанных неагрегированных данных. Дополнительные сведения об областях, доступных в службе "Управление затратами", см. в разделе [Основные сведения об областях и работе с ними](https://docs.microsoft.com/azure/cost-management-billing/costs/understand-work-scopes). После загрузки необходимых данных для области используйте Excel для дальнейшего анализа данных с помощью фильтров и сводных таблиц.

## <a name="example-usage-details-api-requests"></a>Примеры запросов API сведений о потреблении

Следующие примеры запросов используются клиентами Майкрософт во многих распространенных сценариях.

### <a name="get-usage-details-for-a-scope-during-specific-date-range"></a>Получение сведений о потреблении для области в определенном диапазоне дат

Данные, возвращаемые запросом, соответствуют дате получения сведений о потреблении системой выставления счетов. Могут быть включены затраты из нескольких счетов.

```http
GET https://management.azure.com/{scope}/providers/Microsoft.Consumption/usageDetails?$filter=properties%2FusageStart%20ge%20'2020-02-01'%20and%20properties%2FusageEnd%20le%20'2020-02-29'&$top=1000&api-version=2019-10-01

```

### <a name="get-amortized-cost-details"></a>Получение сведений об амортизационной стоимости

Если вы хотите увидеть фактические затраты на покупки по мере их возникновения, в следующем запросе измените значение *metric* на `ActualCost`. Для получения сведений об амортизационной стоимости и фактических затратах необходимо использовать версию `2019-04-01-preview`. Текущая версия API работает так же, как версия `2019-10-01`, кроме нового атрибута type/metric и измененных имен свойств. Если у вас имеется Клиентское соглашение Майкрософт, в следующем примере ваши фильтры будут `startDate` и `endDate`.

```http
GET https://management.azure.com/{scope}/providers/Microsoft.Consumption/usageDetails?metric=AmortizedCost&$filter=properties/usageStart+ge+'2019-04-01'+AND+properties/usageEnd+le+'2019-04-30'&api-version=2019-04-01-preview
```

## <a name="retrieve-large-cost-datasets-recurringly-with-exports"></a>Периодическое извлечение больших наборов данных о затратах с помощью функции экспорта

Функция экспорта — это решение для планирования дампов данных о затратах на регулярной основе. Это рекомендуемый способ получения неагрегированных данных о затратах для организаций, чьи файлы данных о потреблении могут быть слишком большими для использования API сведений о потреблении. Данные помещаются в выбранную вами учетную запись хранения Azure. Из этой учетной записи вы можете загружать эти данные в свои системы, где ваши команды будут их анализировать по мере необходимости. Сведения о настройке функции экспорта на портале Azure см. в разделе [Экспорт данных](https://docs.microsoft.com/azure/cost-management-billing/costs/tutorial-export-acm-data).

## <a name="data-latency-and-rate-limits"></a>Задержка данных и ограничения скорости

Рекомендуется вызывать интерфейсы API не чаще одного раза в день. Данные Управления затратами обновляются каждые четыре часа по мере получения новых данных о потреблении от поставщиков ресурсов Azure. Более частые вызовы не предоставят никаких дополнительных данных, но создадут повышенную нагрузку. Дополнительные сведения о частоте изменения данных и обработке задержки данных см. в разделе [Общие сведения о данных Управления затратами](https://docs.microsoft.com/azure/cost-management-billing/costs/understand-cost-mgt-data).

### <a name="error-code-429---call-count-has-exceeded-rate-limits"></a>Код ошибки 429 — количество вызовов превысило ограничения скорости

Чтобы обеспечить согласованную работу всех подписчиков Управления затратами, интерфейсы API Управления затратами имеют ограничения скорости. По достижении ограничения отображается код состояния HTTP `429: Too many requests`. Текущие ограничения пропускной способности для наших API приведены ниже.

- 30 вызовов в минуту — на область, пользователя или приложение.
- 200 вызовов в минуту — на клиента, пользователя или приложение.

## <a name="next-steps"></a>Дальнейшие действия

- [Анализ затрат на Azure с помощью приложения-шаблона Power BI](https://docs.microsoft.com/azure/cost-management-billing/costs/analyze-cost-data-azure-cost-management-power-bi-template-app).
- [Создание данных для экспорта и управление ими](https://docs.microsoft.com/azure/cost-management-billing/costs/tutorial-export-acm-data) с помощью функции экспорта.
- Узнайте больше об [API сведений о потреблении](https://docs.microsoft.com/rest/api/consumption/usageDetails).