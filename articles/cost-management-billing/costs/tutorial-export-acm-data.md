---
title: Руководство. Создание экспортированных данных из Управления затратами Azure и управление этими данными
description: В этой статье показано, как создавать экспортированные данные в службе "Управление затратами Azure" и управлять ими, чтобы использовать эти данные во внешних системах.
author: bandersmsft
ms.author: banders
ms.date: 12/7/2020
ms.topic: tutorial
ms.service: cost-management-billing
ms.subservice: cost-management
ms.reviewer: adwise
ms.custom: seodec18, devx-track-azurepowershell
ms.openlocfilehash: e3c1fa071cd23b871f754e89d6f17eb2cc44b394
ms.sourcegitcommit: cc13f3fc9b8d309986409276b48ffb77953f4458
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2020
ms.locfileid: "97400358"
---
# <a name="tutorial-create-and-manage-exported-data"></a>Руководство. Создание задачи для экспорта данных и управление экспортированными данными

Если вы изучили учебник по анализу затрат, вы знакомы с процедурой загрузки данных из системы управления затратами вручную. Но можно создать повторяющуюся задачу, которая будет ежедневно, еженедельно или ежемесячно автоматически экспортировать ваши данные из системы управления затратами в хранилище Azure. Экспортированные данные представлены в формате CSV и содержат все сведения, собираемые системой управления затратами. Затем можно использовать экспортированные данные в хранилище Azure в работе с внешними системами и объединять их с собственными пользовательскими данными. Кроме того, можно использовать экспортированные данные во внешней системе, например на панели мониторинга или в другой финансовой системе.

Сведения о создании запланированной операции экспорта данных о затратах Azure в хранилище Azure см. в видео [How to schedule exports to storage with Azure Cost Management](https://www.youtube.com/watch?v=rWa_xI1aRzo) (Как запланировать операции экспорта в хранилище с помощью службы "Управление затратами Azure"). Чтобы просмотреть другие видео, посетите канал YouTube, посвященный [службе "Управление затратами"](https://www.youtube.com/c/AzureCostManagement).

>[!VIDEO https://www.youtube.com/embed/rWa_xI1aRzo]

Примеры в этом руководстве по шагам демонстрируют экспорт ваших данных из системы управления затратами, а затем проверку успешности экспорта данных.

В этом руководстве описано следующее.

> [!div class="checklist"]
> * Создание ежедневного экспорта
> * Проверка сбора данных

## <a name="prerequisites"></a>Предварительные требования
Экспорт данных доступен в различных типах учетной записи Azure, включая клиентов [Соглашения Enterprise (EA)](https://azure.microsoft.com/pricing/enterprise-agreement/) и клиентов [Клиентского соглашения Майкрософт](get-started-partners.md). Полный список поддерживаемых типов учетных записей см. в статье [Understand Cost Management data](understand-cost-mgt-data.md) (Интерпретация данных службы "Управление затратами"). Для экспорта данных пользователем или группой поддерживаются следующие разрешения или области Azure на подписку. См. [основные сведения об областях и работе с ними](understand-work-scopes.md).

- Владелец: может создавать, изменять или удалять операции экспорта для подписки.
- Участник: может создавать, изменять или удалять свои запланированные операции экспорта. Может изменять имена запланированных операций экспорта, созданных другими пользователями.
- Читатель: может просматривать операции экспорта, для которых имеет разрешение.

Для учетных записей хранения Azure:
- Чтобы изменить настроенную учетную запись хранения, требуются разрешения на запись, вне зависимости от разрешений на экспорт.
- Ваша учетная запись хранения Azure должна быть настроена для использования хранилища BLOB-объектов или хранилища файлов.

Если у вас новая подписка, вы не сможете сразу начать использовать функции Управления затратами. Полная активация всех функций Управления затратами может потребовать до 48 часов.

## <a name="sign-in-to-azure"></a>Вход в Azure
Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com/).

## <a name="create-a-daily-export"></a>Создание ежедневного экспорта

### <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы создать или запланировать операцию экспорта либо же просмотреть сведения о ней, откройте требуемую область на портале Azure и выберите в меню **Анализ затрат**. Например, перейдите к разделу **Подписки**, выберите подписку из списка и щелкните в меню **Анализ затрат**. В верхней части страницы анализа затрат выберите **Параметры**, а затем — **Экспорт**.

> [!NOTE]
> - Помимо подписок можно экспортировать группы ресурсов, группы управления, подразделения и регистрации. См. [основные сведения об областях и работе с ними](understand-work-scopes.md).
>- Войдя в систему как партнер в области учетной записи выставления счетов или в клиентском арендаторе, вы можете экспортировать данные в учетную запись хранения Azure, связанную с учетной записью хранения партнера. При этом в арендаторе CSP должна быть активная подписка.

1. Выберите **Добавить** и введите имя для экспорта.
1. Для параметра **Метрика** выберите одно из следующих значений:
    - Выберите **Actual cost (Usage and Purchases)** (Фактическая стоимость (использование и покупки)), чтобы экспортировать стандартное использование и покупки.
    - Выберите **Amortized cost (Usage and Purchases)** (Амортизированная стоимость (использование и покупки)), чтобы экспортировать амортизированную стоимость покупок, например резервирований Azure.
1. Для параметра **Тип экспорта** выберите одно из следующих значений:
    - **Ежедневный экспорт расходов за текущий месяц** — ежедневное предоставление нового файла экспорта для расходов за текущий месяц. Последние данные агрегируются из предыдущего ежедневного экспорта.
    - **Weekly export of cost for the last seven days** (Еженедельный экспорт расходов за последние семь дней) — создание еженедельного экспорта расходов за последние семь дней с выбранной даты начала экспорта.
    - **Monthly export of last month's costs** (Ежемесячный экспорт расходов за прошлый месяц) — предоставление экспорта расходов за прошлый месяц по сравнению с текущим месяцем создания экспорта. Далее экспорт будет выполняться по расписанию на пятый день каждого нового месяца с расходами за предыдущие месяцы.
    - **One-time export** (Однократный экспорт) — позволяет выбрать диапазон дат для экспорта исторических данных в хранилище BLOB-объектов Azure. Вы можете экспортировать историю затрат максимум за 90 дней со дня, который вы выберете. Этот экспорт выполняется немедленно и будет доступен в вашей учетной записи хранения в течение двух часов.
        В зависимости от типа экспорта выберите дату начала или дату **С** и **До**.
1. Укажите подписку для учетной записи хранения Azure, а затем выберите группу ресурсов или создайте новую.
1. Выберите имя учетной записи хранения или создайте новую.
1. Выберите расположение (регион Azure).
1. Укажите контейнер хранилища и путь к каталогу для экспорта файла.
    :::image type="content" source="./media/tutorial-export-acm-data/basics_exports.png" alt-text="Пример нового экспорта" lightbox="./media/tutorial-export-acm-data/basics_exports.png":::
1. Просмотрите данные об экспорте и нажмите кнопку **Создать**.

Новый экспорт отобразится в списке экспорта. По умолчанию новые задачи экспорта включены. Если требуется отключить или удалить запланированный экспорт, выберите любой пункт в списке, а затем **Выключить** или **Удалить**.

Изначально до начала экспорта может потребоваться от 12 до 24 часов. Однако для отображения данных в экспортированных файлах может понадобиться больше времени.

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы подготовить среду для Azure CLI, выполните указанные ниже действия.

[!INCLUDE [azure-cli-prepare-your-environment-no-header.md](../../../includes/azure-cli-prepare-your-environment-no-header.md)]

1. Чтобы просмотреть свои текущие экспорты после входа в систему, используйте команду [az costmanagement export list](/cli/azure/ext/costmanagement/costmanagement/export#ext_costmanagement_az_costmanagement_export_list):

   ```azurecli
   az costmanagement export list --scope "subscriptions/00000000-0000-0000-0000-000000000000"
   ```

   >[!NOTE]
   >
   >* Помимо подписок можно экспортировать группы ресурсов и группы управления. См. [основные сведения об областях и работе с ними](understand-work-scopes.md).
   >* Войдя в систему как партнер в области учетной записи выставления счетов или в клиентском арендаторе, вы можете экспортировать данные в учетную запись хранения Azure, связанную с учетной записью хранения партнера. При этом в арендаторе CSP должна быть активная подписка.

1. Создайте группу ресурсов или используйте существующую. Чтобы создать группу ресурсов, используйте команду [az group create](/cli/azure/group#az_group_create):

   ```azurecli
   az group create --name TreyNetwork --location "East US"
   ```

1. Создайте учетную запись хранения, чтобы получать экспортируемые данные, или используйте уже существующую. Для создания учетной записи хранения используйте команду [az storage account create](/cli/azure/storage/account#az_storage_account_create):

   ```azurecli
   az storage account create --resource-group TreyNetwork --name cmdemo
   ```

1. Выполните команду [az costmanagement export create](/cli/azure/ext/costmanagement/costmanagement/export#ext_costmanagement_az_costmanagement_export_create), чтобы создать экспорт:

   ```azurecli
   az costmanagement export create --name DemoExport --type ActualCost \
   --scope "subscriptions/00000000-0000-0000-0000-000000000000" --storage-account-id cmdemo \
   --storage-container democontainer --timeframe MonthToDate --recurrence Daily \
   --recurrence-period from="2020-06-01T00:00:00Z" to="2020-10-31T00:00:00Z" \
   --schedule-status Active --storage-directory demodirectory
   ```

   Для параметра **--type** можно выбирать между `ActualCost`, `AmortizedCost` или `Usage`.

   В этом примере используется `MonthToDate`. Экспорт ежедневно создает файл экспорта для дневных расходов за текущий месяц. Последние данные агрегируются из предыдущего ежедневного экспорта текущего месяца.

1. Для просмотра подробных сведений об операции экспорта используйте команду [az costmanagement export show](/cli/azure/ext/costmanagement/costmanagement/export#ext_costmanagement_az_costmanagement_export_show):

   ```azurecli
   az costmanagement export show --name DemoExport \
      --scope "subscriptions/00000000-0000-0000-0000-000000000000"
   ```

1. Экспорт можно обновить с помощью команды [az costmanagement export update](/cli/azure/ext/costmanagement/costmanagement/export#ext_costmanagement_az_costmanagement_export_update):

   ```azurecli
   az costmanagement export update --name DemoExport
      --scope "subscriptions/00000000-0000-0000-0000-000000000000" --storage-directory demodirectory02
   ```

   В этом примере изменяется выходной каталог.

>[!NOTE]
>Изначально до начала экспорта может потребоваться от 12 до 24 часов. Однако для отображения данных в экспортированных файлах может понадобиться больше времени.

Вы можете удалить экспорт, используя команду [az costmanagement export delete](/cli/azure/ext/costmanagement/costmanagement/export#ext_costmanagement_az_costmanagement_export_delete):

```azurecli
az costmanagement export delete --name DemoExport --scope "subscriptions/00000000-0000-0000-0000-000000000000"
```

### <a name="azure-powershell"></a>[Azure PowerShell](#tab/azure-powershell)

Сначала подготовьте среду для Azure PowerShell:

[!INCLUDE [azure-powershell-requirements-no-header.md](../../../includes/azure-powershell-requirements-no-header.md)]

  > [!IMPORTANT]
  > Так как предоставляется предварительная версия модуля PowerShell **Az.CostManagement**, его нужно установить отдельно с помощью командлета `Install-Module`. Как только этот модуль PowerShell станет общедоступным, он будет включен в один из будущих выпусков модуля Az PowerShell и по умолчанию встроен в Azure Cloud Shell.

  ```azurepowershell-interactive
  Install-Module -Name Az.CostManagement
  ```

1. Чтобы просмотреть сведения о своих текущих операциях экспорта после входа в систему, используйте командлет [Get-AzCostManagementExport](/powershell/module/Az.CostManagement/get-azcostmanagementexport):

   ```azurepowershell-interactive
   Get-AzCostManagementExport -Scope 'subscriptions/00000000-0000-0000-0000-000000000000'
   ```

   >[!NOTE]
   >
   >* Помимо подписок можно экспортировать группы ресурсов и группы управления. См. [основные сведения об областях и работе с ними](understand-work-scopes.md).
   >* Войдя в систему как партнер в области учетной записи выставления счетов или в клиентском арендаторе, вы можете экспортировать данные в учетную запись хранения Azure, связанную с учетной записью хранения партнера. При этом в арендаторе CSP должна быть активная подписка.

1. Создайте группу ресурсов или используйте существующую. Чтобы создать группу ресурсов, выполните командлет [New-AzResourceGroup](/powershell/module/az.resources/new-azresourcegroup):

   ```azurepowershell-interactive
   New-AzResourceGroup -Name TreyNetwork -Location eastus
   ```

1. Создайте учетную запись хранения, чтобы получать экспортируемые данные, или используйте уже существующую. Чтобы создать учетную запись хранения, выполните командлет [New-AzStorageAccount](/powershell/module/az.storage/new-azstorageaccount):

   ```azurepowershell-interactive
   New-AzStorageAccount -ResourceGroupName TreyNetwork -AccountName cmdemo -SkuName Standard_RAGRS -Location eastus
   ```

1. Выполните командлет [New-AzCostManagementExport](/powershell/module/Az.CostManagement/new-azcostmanagementexport), чтобы создать операцию экспорта:

   ```azurepowershell-interactive
   $Params = @{
     Name = 'DemoExport'
     DefinitionType = 'ActualCost'
     Scope = 'subscriptions/00000000-0000-0000-0000-000000000000'
     DestinationResourceId = '/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/treynetwork/providers/Microsoft.Storage/storageAccounts/cmdemo'
     DestinationContainer = 'democontainer'
     DefinitionTimeframe = 'MonthToDate'
     ScheduleRecurrence = 'Daily'
     RecurrencePeriodFrom = '2020-06-01T00:00:00Z'
     RecurrencePeriodTo = '2020-10-31T00:00:00Z'
     ScheduleStatus = 'Active'
     DestinationRootFolderPath = 'demodirectory'
     Format = 'Csv'
   }
   New-AzCostManagementExport @Params
   ```

   Значение параметра **DefinitionType** можно выбирать между `ActualCost`, `AmortizedCost` или `Usage`.

   В этом примере используется `MonthToDate`. Экспорт ежедневно создает файл экспорта для дневных расходов за текущий месяц. Последние данные агрегируются из предыдущего ежедневного экспорта текущего месяца.

1. Просмотреть сведения об операции экспорта можно с помощью командлета `Get-AzCostManagementExport`:

   ```azurepowershell-interactive
   Get-AzCostManagementExport -Scope 'subscriptions/00000000-0000-0000-0000-000000000000'
   ```

1. Обновите операцию экспорта с использованием командлета [Update-AzCostManagementExport](/powershell/module/Az.CostManagement/update-azcostmanagementexport):

   ```azurepowershell-interactive
   Update-AzCostManagementExport -Name DemoExport -Scope 'subscriptions/00000000-0000-0000-0000-000000000000' -DestinationRootFolderPath demodirectory02
   ```

   В этом примере изменяется выходной каталог.

>[!NOTE]
>Изначально до начала экспорта может потребоваться от 12 до 24 часов. Однако для отображения данных в экспортированных файлах может понадобиться больше времени.

Удалить операцию экспорта можно с помощью командлета [Remove-AzCostManagementExport](/powershell/module/Az.CostManagement/remove-azcostmanagementexport):

```azurepowershell-interactive
Remove-AzCostManagementExport -Name DemoExport -Scope 'subscriptions/00000000-0000-0000-0000-000000000000'
```

---

### <a name="export-schedule"></a>Экспорт расписания

Запланированный экспорт зависит от времени и дня недели, когда изначально был создан экспорт. При создании запланированного экспорта он выполняется с той же частотой для каждого последующего выхода экспорта. Например, ежедневный экспорт расходов за текущий месяц выполняется каждый день. Аналогично для еженедельного экспорта экспорт выполняется каждую неделю в тот же день, когда он был запланирован. Точное время доставки при экспорте не гарантируется, а экспортированные данные доступны в течение четырех часов со времени выполнения.

Каждый экспорт создает новый файл, поэтому старые экспорты не перезаписываются.

#### <a name="create-an-export-for-multiple-subscriptions"></a>Создание задачи экспорта для нескольких подписок

Если у вас Соглашение Enterprise, вы можете объединить данные о затратах на подписки в одном контейнере с помощью группы управления. Затем вы сможете экспортировать данные управления затратами для группы.

Экспортирование не поддерживается для групп управления другими типами подписки.

1. Если группа управления еще не создана, создайте одну группу и назначьте ей подписки.
1. В поле анализа затрат задайте область для группы управления и щелкните **Select this management group** (Выбрать эту группу управления).
    :::image type="content" source="./media/tutorial-export-acm-data/management-group-scope.png" alt-text="Пример параметра выбора группы управления" lightbox="./media/tutorial-export-acm-data/management-group-scope.png":::
1. Создайте операцию экспорта в этой области, чтобы получить данные по управлению затратами для подписок в этой группе управления.
    :::image type="content" source="./media/tutorial-export-acm-data/new-export-management-group-scope.png" alt-text="Пример параметра создания нового экспорта с областью группы управления":::

## <a name="verify-that-data-is-collected"></a>Проверка сбора данных

Вы легко можете убедиться, что ваши данные из системы управления расходами были собраны, и просмотреть экспортированный CSV-файл с помощью Обозревателя службы хранилища Azure.

В списке экспорта выберите имя учетной записи хранения. На странице учетной записи хранения в Обозревателе выберите "Открыть". Если появится поле подтверждения, выберите **Да**, чтобы открыть файл в Обозревателе службы хранилища Azure.

![Страница учетной записи хранения со справочными данными и ссылкой "Открыть в обозревателе"](./media/tutorial-export-acm-data/storage-account-page.png)

В обозревателе службы хранилища перейдите в контейнер, который требуется открыть, и выберите папку, соответствующую текущему месяцу. Отобразится список CSV-файлов. Выберите файл, а затем — **Открыть**.

![Справочные данные, отображаемые в Обозревателе службы хранилища](./media/tutorial-export-acm-data/storage-explorer.png)

Файл открывается с помощью программы или приложения, которое задано для открытия файлов с расширением CSV. Ниже приведен пример в Excel.

![Пример экспортированных данных CSV в Excel](./media/tutorial-export-acm-data/example-export-data.png)

### <a name="download-an-exported-csv-data-file"></a>Скачивание экспортированного CSV-файла данных

Экспортированный CSV-файл также можно скачать на портале Azure. Ниже описано, как найти его в разделе "Анализ затрат".

1. В разделе "Анализ затрат" выберите **Параметры**, а затем выберите **Экспортируемые элементы**.
1. В списке экспортируемых элементов выберите учетную запись хранения для элемента.
1. В учетной записи хранения выберите **Контейнеры**.
1. В списке контейнеров выберите нужный контейнер.
1. Перейдите к нужной дате в каталоге и списке больших двоичных объектов хранилища.
1. Выберите CSV-файл и нажмите **Загрузить**.

[![Пример загрузки экспорта данных](./media/tutorial-export-acm-data/download-export.png)](./media/tutorial-export-acm-data/download-export.png#lightbox)

## <a name="view-export-run-history"></a>Просмотр журнала выполнения экспорта

Чтобы просмотреть журнал выполнения запланированного экспорта, выберите отдельный экспорт на странице со списком экспортов. На этой же странице вы можете быстро просмотреть время выполнения предыдущих операций экспорта, а также запустить следующий экспорт. Ниже приведен пример журнала выполнения.

:::image type="content" source="./media/tutorial-export-acm-data/run-history.png" alt-text="Снимок экрана: панель &quot;Экспортируемые элементы&quot;":::

Выберите экспорт, чтобы просмотреть его журнал выполнения.

:::image type="content" source="./media/tutorial-export-acm-data/single-export-run-history.png" alt-text="Снимок экрана: журнал выполнения экспорта.":::

## <a name="access-exported-data-from-other-systems"></a>Доступ к экспортированным данным из других систем

Одной из целей экспорта данных системы управления затратами является возможность доступа к данным из внешних систем. Можно использовать систему панелей мониторинга или другую финансовую систему. Такие системы значительно варьируются, поэтому приводить примеры нецелесообразно.  Однако для начала можно осуществлять доступ к данным из ваших приложений, следуя инструкциям в разделе [Общие сведения о службе хранилища Azure](../../storage/common/storage-introduction.md).

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание ежедневного экспорта
> * Проверка сбора данных

Перейдите к следующему руководству, чтобы повысить эффективность своей работы благодаря выявлению незадействованных или недостаточно используемых ресурсов.

> [!div class="nextstepaction"]
> [Просмотр рекомендаций по оптимизации и реагирование на них](tutorial-acm-opt-recommendations.md)
