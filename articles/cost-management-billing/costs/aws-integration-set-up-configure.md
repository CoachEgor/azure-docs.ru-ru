---
title: Настройка интеграции AWS с помощью службы "Управление затратами Azure"
description: В этой статье описывается установка и настройка интеграции отчетов о затратах и использовании AWS с помощью службы "Управление затратами Azure".
author: bandersmsft
ms.author: banders
ms.date: 02/12/2020
ms.topic: conceptual
ms.service: cost-management-billing
ms.reviewer: matrive
ms.openlocfilehash: c0f6f18abf7c05cf5ae6dcaa31a57974ecfca806
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "79203089"
---
# <a name="set-up-and-configure-aws-cost-and-usage-report-integration"></a>Установка и настройка интеграции отчетов о затратах и использовании AWS

После интеграции отчетов о затратах и использовании Amazon Web Services (AWS) вы сможете отслеживать и контролировать расходы AWS в службе "Управление затратами Azure". Интеграция позволяет получить единое расположение на портале Azure, где вы будете отслеживать и контролировать расходы для Azure и AWS. В этой статье объясняется, как установить и настроить интеграцию, чтобы вы могли использовать функции Управления затратами Azure для анализа расходов и просмотра бюджетов.

Чтобы получить определения отчетов и скачать CSV-файлы GZIP-отчетов, служба "Управление затратами Azure" обрабатывает хранящийся в контейнере S3 отчет о затратах и использовании AWS, используя учетные данные для доступа к AWS.

## <a name="create-a-cost-and-usage-report-in-aws"></a>Создание отчета о затратах и использовании в AWS

Для получения данных о затратах и их обработки в AWS рекомендуется применять отчет о затратах и использовании. Дополнительные сведения см. в документации по [отчетам о затратах и использовании в AWS](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/billing-reports-costusage.html).

Для создания отчета о затратах и использовании см. страницу **Cost & Usage Reports** (Отчеты о затратах и использовании) в консоли Управления затратами и выставления счетов в AWS, выполнив следующие шаги.

1. Войдите в консоль управления AWS и откройте [консоль Управления затратами и выставления счетов](https://console.aws.amazon.com/billing).
2. В области навигации щелкните **Cost & Usage Reports** (Отчеты о затратах и использовании).
3. Щелкните **Create report** (Создать отчет).
4. Заполните поле **Report name** (Имя отчета).
5. В разделе **Additional report details** (Дополнительные сведения об отчете) выберите **Include resource IDs** (Включить идентификаторы ресурсов).
6. В разделе **Data refresh settings** (Параметры обновления данных) укажите, следует ли обновлять отчет о затратах и использовании AWS, если AWS применяет возмещения, кредиты или плату за поддержку к вашей учетной записи после оформления счета. Если отчет обновляется, в Amazon S3 загружается новый отчет. Рекомендуется оставить параметры установленными.
7. Выберите **Далее**.
8. Для **контейнера S3** щелкните **Configure** (Настройка).
9. В диалоговом окне Configure S3 Bucket (Настройка контейнера S3) выполните одно из следующих действий:
    1. Выберите имеющийся контейнер в раскрывающемся списке и щелкните **Next** (Далее).
    2. Введите имя контейнера и регион, в котором нужно создать новый контейнер, и щелкните **Next** (Далее).
10.    Установите флажок **I have confirmed that this policy is correct** (Подтверждаю правильность политики), а затем нажмите кнопку **Save** (Сохранить).
11.    (Дополнительно) Введите префикс пути отчета, который необходимо добавлять в начало имени отчета.
Если префикс не указан, то им по умолчанию будет имя, указанное для отчета. Для диапазона дат действует такой формат: `/report-name/date-range/`.
12. Для параметра **Time unit** (Единицы времени) выберите **Hourly** (Ежечасно).
13.    Для параметра **Report versioning** (Управление версиями отчетов) выберите, должна ли каждая версия отчета перезаписывать предыдущую или требуются отдельные новые отчеты.
14. Параметр **Enable data integration for** (Включить интеграцию данных для) не нужно устанавливать.
15. В поле **Compression** (Сжатие) выберите значение **GZIP**.
16. Выберите **Далее**.
17. Просмотрите параметры отчета и щелкните **Review and Complete** (Проверить и завершить).

    Запишите имя отчета. Оно понадобится вам на последующих шагах.

Чтобы начать доставку отчетов в ваш контейнер Amazon S3, AWS может понадобиться до 24 часов. После начала доставки AWS обновляет файлы отчетов о затратах и использовании AWS по крайней мере один раз в день. Вы можете продолжить настройку среды AWS, не дожидаясь начала доставки.

## <a name="create-a-role-and-policy-in-aws"></a>Создание роли и политики в AWS

Служба "Управление затратами Azure" обращается к контейнеру S3, в котором несколько раз в день размещается отчет о затратах и использовании. Службе требуется доступ к учетным данным для проверки новых данных. Вам необходимо создать роль и политику в AWS, чтобы разрешить к ним доступ службе "Управление затратами".

Чтобы включить доступ на основе ролей к учетной записи AWS в Управлении затратами, создается роль в консоли AWS. В консоли AWS необходимо получить _ARN роли_ и _внешний идентификатор_. Позже вы используете их на странице **создания соединителя AWS** в службе "Управление затратами".

Используйте мастер создания ролей:

1. Войдите в консоль AWS и выберите **Services** (Службы).
2. В списке служб выберите **IAM**.
3. Щелкните **Roles** (Роли), а затем **Create Role** (Создать роль).
4. На следующей странице выберите **Another AWS account** (Другая учетная запись AWS).
5. В поле **Account ID** (Идентификатор учетной записи) введите **432263259397**.
6. В разделе **Options** (Параметры) установите флажок **Require external ID (Best practice when a third party will assume this role)** (Требовать внешний идентификатор (рекомендуется, если сторонний производитель предполагает эту роль)).
7. В поле **External ID** (Внешний идентификатор) введите этот идентификатор, который является общим секретным кодом для роли AWS и службы "Управление затратами Azure". Тот же внешний идентификатор также используется на странице **Новый соединитель** в службе "Управление затратами". Корпорация Майкрософт рекомендует придерживаться строгой политики секретного кода при вводе внешнего идентификатора.

    > [!NOTE]
    > Не меняйте параметр **Require MFA** (Требовать MFA). Флажок должен оставаться неустановленным.
8. По завершении выберите **Next: разрешения**.
9. Выберите**Create policy** (Создать политику). Откроется новая вкладка браузера. Здесь вам необходимо создать политику.
10. Щелкните **Choose a service** (Выбрать службу).

Настройте разрешения для отчета о затратах и использовании:

1. Введите **Cost and Usage Report** (Отчет о затратах и использовании).
2. Выберите **Access level (Уровень доступа)**  > **Чтение (Read)**  > **DescribeReportDefinitions**. Этот шаг позволяет службе "Управление затратами" узнать, какие отчеты о затратах и использовании определены и соответствуют ли они необходимым условиям определения отчетов.
3. Выберите **Add additional permissions** (Добавить дополнительные разрешения).

Настройте разрешения для объектов и контейнера S3:

1. Щелкните **Choose a service** (Выбрать службу).
2. Введите **S3**.
3. Выберите **Access level** (Уровень доступа) > **List** (Список) > **ListBucket**. Вы получите список объектов в контейнере S3.
4. Выберите **Access level** (Уровень доступа) > **Read** (Чтение) > **GetObject**. Это действие позволит скачать файлы выставления счетов.
5. Выберите **Resources** (Ресурсы).
6. Щелкните **bucket – Add ARN** (Контейнер — добавить ARN).
7. В поле **Bucket name** (Имя контейнера) введите контейнер, используемый для хранения файлов отчетов о затратах и использовании.
8. Щелкните **object – Add ARN** (Объект — добавить ARN).
9. В поле **Bucket name** (Имя контейнера) введите контейнер, используемый для хранения файлов отчетов о затратах и использовании.
10. В поле **Object name** (Имя объекта) выберите **Any** (Любое).
11. Выберите **Add additional permissions** (Добавить дополнительные разрешения).

Настройка разрешений для Анализатора затрат:

1. Щелкните **Choose a service** (Выбрать службу).
2. Введите **Cost Explorer Service** (Служба "Анализатор затрат").
3. Щелкните **All Cost Explorer Service actions (ce:\*)** (Все действия службы "Анализатор затрат" (ce:*)). Это действие проверяет правильность коллекции.
4. Выберите **Add additional permissions** (Добавить дополнительные разрешения).

Добавление разрешений для организаций AWS:

1. Введите **Organizations** (Организации).
2. Выберите **Access level** (Уровень доступа) > **List** (Список) > **ListAccounts**. Вы получите имена учетных записей.
3. Введите имя новой политики в поле **Review Policy** (Политика проверки). Убедитесь, что введены правильные сведения, а затем щелкните **Create Policy** (Создать политику).
4. Вернитесь на предыдущую вкладку и обновите страницу в браузере. Через поле поиска найдите новую политику.
5. По завершении выберите **Next: Review** (Далее: проверка).
6. Введите имя для новой роли. Убедитесь, что введены правильные сведения, а затем выберите **Create Role** (Создать роль).

    Запишите ARN роли и внешний идентификатор, которые использовались на предыдущих шагах при создании роли. Они нам понадобятся позже при настройке соединителя Управления затратами Azure.

Политика JSON должна быть аналогичной примеру ниже. Замените _bucketname_ именем контейнера S3.

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
"organizations:ListAccounts",
             "ce:*",
             "cur:DescribeReportDefinitions"
            ],
            "Resource": "*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::bucketname",
                "arn:aws:s3:::bucketname/*"
            ]
        }
    ]
}
```

## <a name="set-up-a-new-aws-connector-in-azure"></a>Настройка нового соединителя AWS в Azure

Используйте следующие сведения, чтобы создать соединитель AWS и начать мониторинг затрат AWS:

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Управление затратами + выставление счетов** > **Управление затратами**.
3. В разделе **Параметры** выберите **Облачные соединители (предварительная версия)** .  
    ![Пример, в котором показан параметр "Облачные соединители (предварительная версия)"](./media/aws-integration-setup-configure/cloud-connectors-preview01.png).
4. Щелкните **+Добавить** в верхней части страницы, чтобы создать соединитель.
5. На странице **создания соединителя AWS** в поле **Отображаемое имя** введите имя соединителя.  
    ![Пример страницы для создания соединителя AWS](./media/aws-integration-setup-configure/create-aws-connector01.png)
6. При необходимости выберите группу управления по умолчанию. Будут сохранены все обнаруженные связанные учетные записи. Группу можно настроить позже.
7. В разделе **Выставление счетов** установите флажок **Автоматически взимать 1 % расходов при выходе общедоступной версии**, если требуется обеспечить непрерывную работу по истечении срока действия предварительной версии. Если выбран автоматический параметр, необходимо выбрать подписку для выставления счетов.
8. В поле **ARN роли** введите значение, которое использовалось при настройке роли в AWS.
9. В поле **Внешний идентификатор** введите значение, которое использовалось при настройке роли в AWS.
10. В поле **Имя отчета** введите имя, созданное в AWS.
11. Щелкните **Далее**, а затем **Создать**.

Новые области AWS, консолидированная учетная запись AWS, связанные учетные записи AWS и их данные о затратах могут отобразиться через несколько часов.

После создания соединителя рекомендуем назначить ему контроль доступа. Пользователям назначаются разрешения для вновь обнаруженных областей: консолидированной учетной записи AWS и связанной учетной записи AWS. Пользователь, создающий соединитель, является владельцем соединителя, объединенной учетной записи и всех связанных учетных записей.

Назначение разрешений соединителя пользователям после обнаружения не приводит к назначению разрешений для существующих областей AWS. Вместо этого разрешения назначаются только новым связанным учетным записям.

## <a name="take-additional-steps"></a>Выполнение дополнительных действий

- [Настройте группы управления](../../governance/management-groups/overview.md#initial-setup-of-management-groups), если это еще не сделано.
- Убедитесь, что в средство выбора области добавлены новые области. Щелкните **Обновить**, чтобы просмотреть последние данные.
- На странице **Облачные соединители** щелкните соединитель, а затем **Перейти к учетной записи выставления счетов**, чтобы назначить связанную учетную запись группам управления.

## <a name="manage-cloud-connectors"></a>Управление облачными соединителями

При выборе соединителя на странице **Облачные соединители** можно выполнить следующие действия:

- Щелкните **Перейти к учетной записи выставления счетов**, чтобы просмотреть сведения о консолидированной учетной записи AWS.
- Щелкните **Контроль доступа**, чтобы настроить управление назначением ролей для соединителя.
- Щелкните **Изменить**, чтобы обновить соединитель. Вы не можете изменить номер учетной записи AWS, так как он используется в ARN роли. Но можно создать другой соединитель.
- Щелкните **Проверить** для повторного запуска проверочного теста, чтобы убедиться, что служба "Управление затратами" может получать данные, используя параметры соединителя.

![Пример списка созданных соединителей AWS](./media/aws-integration-setup-configure/list-aws-connectors.png)

## <a name="set-up-azure-management-groups"></a>Настройка групп управления Azure

Разместите подписки Azure и связанные учетные записи AWS в одной группе управления, чтобы создать единое расположение, в котором можно просмотреть сведения о поставщике в нескольких облачных службах. Если вы еще не настроили в среде Azure группы управления, см. [этот раздел](../../governance/management-groups/overview.md#initial-setup-of-management-groups).

Если вы хотите разделить затраты, можно создать группу управления, в которой будут только связанные учетные записи AWS.

## <a name="set-up-an-aws-consolidated-account"></a>Настройка консолидированной учетной записи AWS

В консолидированной учетной записи AWS объединяется выставление счетов и оплата для нескольких учетных записей AWS. Она также служит связанной учетной записью AWS.

![Пример консолидированной учетной записи AWS](./media/aws-integration-setup-configure/aws-consolidated-account01.png)

На этой странице можно выполнить следующие действия:

- Щелкните **Update** (Обновить), чтобы выполнить массовое обновление связанных учетных записей AWS для группы управления.
- Щелкните **Access Control** (Контроль доступа), чтобы задать назначение ролей для области.

### <a name="permissions-for-an-aws-consolidated-account"></a>Разрешения для консолидированной учетной записи AWS

По умолчанию разрешения для объединенной учетной записи AWS задаются при создании учетной записи на основе разрешений соединителя AWS. Создатель соединителя является владельцем.

Управление уровнем доступа осуществляется на странице **Access Level** (Уровень доступа) в консолидированной учетной записи AWS. Но связанные учетные записи AWS не наследуют разрешения консолидированной учетной записи AWS.

## <a name="set-up-an-aws-linked-account"></a>Настройка связанной учетной записи AWS

Связанная учетная запись AWS — это место, где создаются ресурсы AWS и осуществляется управление ими. Связанная учетная запись также выступает в качестве границы безопасности.

На этой странице можно выполнить следующие действия:

- Щелкните **Update** (Обновить), чтобы обновить связывание учетной записи AWS с группой управления.
- Щелкните **Access Control** (Контроль доступа), чтобы задать назначение ролей для области.

![Пример страницы связанной учетной записи AWS](./media/aws-integration-setup-configure/aws-linked-account01.png)

### <a name="permissions-for-an-aws-linked-account"></a>Разрешения для связанной учетной записи AWS

По умолчанию разрешения для связанной учетной записи AWS задаются при создании на основе разрешений соединителя AWS. Создатель соединителя является владельцем. Управление уровнем доступа осуществляется на странице **Access Level** (Уровень доступа) связанной учетной записи AWS. Связанные учетные записи AWS не наследуют разрешения от консолидированной учетной записи AWS.

Связанные учетные записи AWS всегда наследуют разрешения от группы управления, к которой они принадлежат.

## <a name="next-steps"></a>Дальнейшие действия

- Теперь, когда вы установили и настроили интеграцию отчетов о затратах и использовании AWS, перейдите к статье [Управление затратами и использованием AWS](aws-integration-manage.md).
- Если вы не знакомы с анализом затрат, см. [это](quick-acm-cost-analysis.md) краткое руководство.
- Если вы не знакомы с бюджетами в Azure, см. статью [об их создании и управлении ими в Azure](tutorial-acm-create-budgets.md).
