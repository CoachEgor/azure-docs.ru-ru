---
title: Развертывание шаблонов диспетчер ресурсов с помощью действий GitHub
description: Описывает, как развертывать шаблоны Azure Resource Manager с помощью действий GitHub.
ms.topic: conceptual
ms.date: 05/05/2020
ms.openlocfilehash: 5fe147a9c42e83d5e644b0c08dfa67de88ec05c0
ms.sourcegitcommit: f57297af0ea729ab76081c98da2243d6b1f6fa63
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82875198"
---
# <a name="deploy-azure-resource-manager-templates-by-using-github-actions"></a>Развертывание шаблонов Azure Resource Manager с помощью действий GitHub

[Действия GitHub](https://help.github.com/en/actions) позволяют создавать пользовательские рабочие процессы жизненного цикла разработки программного обеспечения непосредственно в репозитории GitHub, где хранятся шаблоны Azure Resource Manager (ARM). [Рабочий процесс](https://help.github.com/actions/reference/workflow-syntax-for-github-actions) ОПРЕДЕЛЯЕТСЯ файлом YAML. Рабочие процессы имеют одно или несколько заданий с несколькими заданиями, содержащими набор действий, выполняющих отдельные задачи. Шаги могут выполнять команды или использовать действие. Вы можете создавать собственные действия или использовать действия, общие для [сообщества GitHub](https://github.com/marketplace?type=actions) , и при необходимости настраивать их. В этой статье показано, как использовать [Azure CLI действие](https://github.com/marketplace/actions/azure-cli-action) для развертывания шаблонов диспетчер ресурсов.

Azure CLI действие имеет два зависимых действия:

- **[Извлечение](https://github.com/marketplace/actions/checkout)**: Изучите репозиторий, чтобы рабочий процесс мог получить доступ к любому указанному шаблону диспетчер ресурсов.
- **[Вход в Azure](https://github.com/marketplace/actions/azure-login)**. вход с использованием учетных данных Azure

Базовый рабочий процесс развертывания шаблона диспетчер ресурсов может содержать три шага:

1. Извлеките файл шаблона.
2. Войдите в Azure.
3. Развертывание шаблона диспетчер ресурсов

## <a name="prerequisites"></a>Предварительные условия

Для хранения шаблонов диспетчер ресурсов и файлов рабочих процессов необходим репозиторий GitHub. Чтобы создать его, см. раздел [Создание нового репозитория](https://help.github.com/en/enterprise/2.14/user/articles/creating-a-new-repository).

## <a name="configure-deployment-credentials"></a>Настройка учетных данных развертывания

Действие входа в Azure использует субъект-службу для проверки подлинности в Azure. Для развертывания ресурсов Azure участнику рабочего процесса CI/CD обычно требуется встроенный участник.

В следующем Azure CLI скрипте показано, как создать субъект-службу Azure с разрешениями участника в группе ресурсов Azure. В этой группе ресурсов рабочий процесс развертывает ресурсы, определенные в шаблоне диспетчер ресурсов.

```azurecli
$projectName="[EnterAProjectName]"
$location="centralus"
$resourceGroupName="${projectName}rg"
$appName="http://${projectName}"
$scope=$(az group create --name $resourceGroupName --location $location --query 'id')
az ad sp create-for-rbac --name $appName --role Contributor --scopes $scope --sdk-auth
```

Настройте значение **$ProjectName** и **$Location** в скрипте. Имя группы ресурсов — это имя проекта с добавлением **rg**. Необходимо указать имя группы ресурсов в рабочем процессе.

Скрипт выводит объект JSON, подобный следующему:

```json
{
   "clientId": "<GUID>",
   "clientSecret": "<GUID>",
   "subscriptionId": "<GUID>",
   "tenantId": "<GUID>",
   (...)
}
```

Скопируйте выходные данные JSON и сохраните их в качестве секрета GitHub в репозитории GitHub. Если у вас еще нет репозитория, см. раздел [Предварительные требования](#prerequisites) .

1. В репозитории GitHub перейдите на вкладку **Параметры** .
1. В меню слева выберите **секрет** .
1. Введите следующие значения.

    - **Имя**: AZURE_CREDENTIALS
    - **Значение**: (вставьте выходные данные JSON)
1. Выберите **Добавить секрет**.

Необходимо указать имя секрета в рабочем процессе.

## <a name="add-resource-manager-template"></a>Добавление шаблона диспетчер ресурсов

Добавьте шаблон диспетчер ресурсов в репозиторий GitHub. Если у вас ее нет, можно использовать следующий шаблон. Шаблон создает учетную запись хранения.

```url
https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/101-storage-account-create/azuredeploy.json
```

Файл можно разместить в любом месте репозитория. В примере рабочего процесса в следующем разделе предполагается, что файл шаблона называется **azuredeploy. JSON**и хранится в папке с именем **Templates** в корне вашего репозитория.

## <a name="create-workflow"></a>Создание рабочего процесса

Файл рабочего процесса должен храниться в папке **. GitHub/Workflow** в корне репозитория. Расширение файла рабочего процесса может иметь значение **. yml** или **. YAML**.

Можно создать файл рабочего процесса, а затем отправить или передать его в репозиторий или выполнить следующую процедуру:

1. В репозитории GitHub выберите **действия** в верхнем меню.
1. Выберите **новый рабочий процесс**.
1. Выберите **настроить рабочий процесс самостоятельно**.
1. Переименуйте файл рабочего процесса, если вы предпочитаете другое имя, отличное от **Main. yml**. Например: **деплойсторажеаккаунт. yml**.
1. Замените содержимое файла yml следующим:

    ```yml
    name: Deploy ARM Template

    on:
      push:
        branches:
          - master
        paths:
          - ".github/workflows/deployStorageAccount.yml"
          - "templates/azuredeploy.json"

    jobs:
      deploy-storage-account-template:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout source code
            uses: actions/checkout@master

          - name: Login to Azure
            uses: azure/login@v1
            with:
              creds: ${{ secrets.AZURE_CREDENTIALS }}


          - name: Deploy ARM Template
            uses: azure/CLI@v1
            with:
              inlineScript: |
                az deployment group create --resource-group myResourceGroup --template-file ./templates/azuredeploy.json
    ```

    Файл рабочего процесса содержит три раздела:

    - **имя**. имя рабочего процесса.
    - **On**: имя событий GitHub, которые инициируют рабочий процесс. Рабочий процесс активируется при наличии события push в главной ветви, которое изменяет по крайней мере один из двух указанных файлов. Два файла — это файл рабочего процесса и файл шаблона.

        > [!IMPORTANT]
        > Убедитесь, что два файла и их пути совпадают.
    - **задания**: запуск рабочего процесса состоит из одного или нескольких заданий. Существует только одно задание с именем **deploy-Storage-Account-Template**.  Это задание включает три шага:

        - **Извлечение исходного кода**.
        - **Войдите в Azure**.

            > [!IMPORTANT]
            > Убедитесь, что имя секрета соответствует сохраненному в репозитории. См. раздел [Настройка учетных данных развертывания](#configure-deployment-credentials).
        - **Разверните шаблон ARM**. Замените значение **resourceGroupName**.  Если вы использовали Azure CLI сценарий в [настройке учетных данных развертывания](#configure-deployment-credentials), имя создаваемой группы ресурсов — это имя проекта с добавленным **RG** . Проверьте значение **темплателокатион**.

1. Выберите **начать фиксацию**.
1. Выберите параметр **зафиксировать непосредственно в главной ветви**.
1. Выберите **зафиксировать новый файл** (или **сохранить изменения**).

Так как рабочий процесс настроен на активацию как с помощью файла рабочего процесса, так и из обновляемого файла шаблона, Рабочий процесс запускается сразу после фиксации изменений.

## <a name="check-workflow-status"></a>Проверить состояние рабочего процесса

1. Перейдите на вкладку **действия** . Вы увидите рабочий процесс **CREATE деплойсторажеаккаунт. yml** , указанный в списке. Выполнение рабочего процесса занимает 1-2 минут.
1. Выберите рабочий процесс, чтобы открыть его.
1. В меню слева выберите **развернуть — хранилище — учетная запись — шаблон** (имя задания). Имя задания определено в рабочем процессе.
1. Выберите пункт **развернуть шаблон ARM** (имя шага), чтобы развернуть его. Вы видите ответ REST API.

## <a name="next-steps"></a>Дальнейшие действия

Пошаговое руководство, в котором описывается процесс создания шаблона, см. в разделе [учебник. Создание и развертывание первого шаблона ARM](template-tutorial-create-first-template.md).
