---
title: Перемещение ресурсов в новую группу подписчиков или ресурсов
description: Перемещайте ресурсы в новую группу ресурсов или новую подписку с помощью Azure Resource Manager.
ms.topic: conceptual
ms.date: 03/02/2020
ms.openlocfilehash: ffb5f8be81d3628084d127db404ab994d4d5b938
ms.sourcegitcommit: d597800237783fc384875123ba47aab5671ceb88
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2020
ms.locfileid: "80631504"
---
# <a name="move-resources-to-a-new-resource-group-or-subscription"></a>Перемещение ресурсов в новую группу ресурсов или подписку

В этой статье показано, как переместить ресурсы Azure в другую подписку Azure или другую группу ресурсов в той же подписке. Для перемещения ресурса можно использовать портал Azure, Azure PowerShell, интерфейс командной строки Azure или REST API.

Группа источника и группа назначения блокируются на время операции перемещения. Операции записи и удаления для групп ресурсов блокируются до завершения перемещения. Эта блокировка означает, что вы не можете добавлять, обновлять или удалять ресурсы в группах ресурсов. Это не значит, что ресурсы заморожены. Например, если переместить в новую группу ресурсов экземпляр SQL Server и его базу данных, то приложение, использующее эту базу данных, не будет испытывать простоев в работе. Оно по-прежнему сможет считывать данные из базы данных и записывать их в нее. Блокировка может длиться не более четырех часов, но большинство ходов завершены за гораздо меньше времени.

Ресурс всего лишь перемещается в новую группу ресурсов или подписку. Расположение ресурса изменить невозможно.

## <a name="checklist-before-moving-resources"></a>Рекомендации перед перемещением ресурсов

Вот некоторые важные особенности, которые следует учитывать перед перемещением ресурса. Проверив эти условия, можно избежать ошибок.

1. Ресурсы, которые вы хотите переместить, должны поддерживать операцию перемещения. Список ресурсов, поддерживающих перемещение [Move operation support for resources](move-support-resources.md)ресурсов, см.

1. Некоторые службы имеют определенные ограничения или требования при перемещении ресурсов. Если вы перемещаете какие-либо из следующих служб, проверьте это руководство перед переездом.

   * [Службы приложений перемещаются наведения](./move-limitations/app-service-move-limitations.md)
   * [Службы Azure DevOps перемещают руководство](/azure/devops/organizations/billing/change-azure-subscription?toc=/azure/azure-resource-manager/toc.json)
   * [Классическая модель развертывания двигаться руководство](./move-limitations/classic-model-move-limitations.md) - Классический compute, Классический хранения, Классические виртуальные сети, и облачные услуги
   * [Руководство по движению сетей](./move-limitations/networking-move-limitations.md)
   * [Службы восстановления перемещаются наведения](../../backup/backup-azure-move-recovery-services-vault.md?toc=/azure/azure-resource-manager/toc.json)
   * [Виртуальные машины перемещаются наведения](./move-limitations/virtual-machines-move-limitations.md)

1. Исходная и целевая подписки должны быть активными. Если у вас возникла проблема при включении учетной записи, которая была отключена, [создайте запрос на поддержку Azure](../../azure-portal/supportability/how-to-create-azure-support-request.md). Выберите тип проблемы **Управление подпиской**.

1. Исходная и целевая подписка должны существовать в пределах одного [клиента Azure Active Directory](../../active-directory/develop/quickstart-create-new-tenant.md). Используя Azure PowerShell или командную строку Azure, можно убедиться, что обе подписки имеют один и тот же идентификатор клиента.

   Для Azure PowerShell:

   ```azurepowershell-interactive
   (Get-AzSubscription -SubscriptionName <your-source-subscription>).TenantId
   (Get-AzSubscription -SubscriptionName <your-destination-subscription>).TenantId
   ```

   Для интерфейса командной строки Azure:

   ```azurecli-interactive
   az account show --subscription <your-source-subscription> --query tenantId
   az account show --subscription <your-destination-subscription> --query tenantId
   ```

   Если идентификаторы клиентов исходных и целевых подписок не совпадают, используйте следующие методы для выверки идентификаторов клиентов:

   * [Передача прав владения подпиской Azure другой учетной записи](../../billing/billing-subscription-transfer.md)
   * [Как связать или добавить подписку Azure в Active Directory Azure](../../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md)

1. Подписка назначения должна быть зарегистрирована для перемещаемого поставщика ресурсов. В противном случае отображается сообщение о том, что **подписка не зарегистрирована для типа ресурса**. Эта ошибка может возникнуть при перемещении ресурса в новую подписку, которая никогда не использовалась с этим типом ресурса.

   Для PowerShell используйте следующие команды, чтобы получить состояние регистрации:

   ```azurepowershell-interactive
   Set-AzContext -Subscription <destination-subscription-name-or-id>
   Get-AzResourceProvider -ListAvailable | Select-Object ProviderNamespace, RegistrationState
   ```

   Чтобы зарегистрировать поставщик ресурсов, воспользуйтесь командой:

   ```azurepowershell-interactive
   Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
   ```

   Для Azure CLI используйте следующие команды, чтобы получить состояние регистрации:

   ```azurecli-interactive
   az account set -s <destination-subscription-name-or-id>
   az provider list --query "[].{Provider:namespace, Status:registrationState}" --out table
   ```

   Чтобы зарегистрировать поставщик ресурсов, воспользуйтесь командой:

   ```azurecli-interactive
   az provider register --namespace Microsoft.Batch
   ```

1. Учетная запись, используемая для перемещения ресурсов, должна предоставлять по крайней мере следующие разрешения:

   * **Microsoft.Resources/подписки/ресурсгруппы/перемещениеРесурсы/действия** на группе ресурсов источника.
   * **Microsoft.Resources/подписки/ресурсгруппы/запись** в группе ресурсов назначения.

1. Прежде чем перемещать ресурсы, проверьте квоты подписки, в которую вы перемещаете ресурсы. Если при перемещении ресурсов квота подписки будет превышена, возможно, вам придется запросить увеличение квоты. Полный список ограничений и способы запросить увеличение квоты см. в статье [Подписка Azure, границы, квоты и ограничения службы](../../azure-resource-manager/management/azure-subscription-service-limits.md).

1. **Для перемещения по подпискам ресурс и зависимые от них ресурсы должны находиться в одной группе ресурсов, и они должны перемещаться вместе.** Например, VM с управляемыми дисками потребует перемещения VM и управляемых дисков вместе с другими зависимыми ресурсами.

   Если ресурс перемещается в новую подписку, проверьте, есть ли у ресурса зависимые ресурсы и находятся ли они в одной группе ресурсов. Если ресурсы не втойной группе ресурсов, проверьте, можно ли объединить ресурсы в одну и ту же группу ресурсов. Если это так, то переведите все эти ресурсы в одну группу ресурсов, используя операцию перемещения в группах ресурсов.

   Для получения дополнительной [информации см.](#scenario-for-move-across-subscriptions)

## <a name="scenario-for-move-across-subscriptions"></a>Scenario for move across subscriptions (Сценарий перемещения между подписками)

Перемещение ресурсов из одной подписки в другую — это трехступенчатый процесс:

![сценарий перемещения по перекрестной подписке](./media/move-resource-group-and-subscription/cross-subscription-move-scenario.png)

Для иллюстраций у нас есть только один зависимый ресурс.

* Шаг 1: Если зависимые ресурсы распределены между различными группами ресурсов, сначала переместите их в одну группу ресурсов.
* Шаг 2: Перемещение ресурсов и зависимых ресурсов вместе из подписки источника в целевую подписку.
* Шаг 3: Дополнительно перераспределите зависимые ресурсы между различными группами ресурсов в рамках целевой подписки.

## <a name="validate-move"></a>Проверка перемещения

[Операция проверки перемещения](/rest/api/resources/resources/validatemoveresources) позволяет проверить сценарий перемещения без фактического перемещения ресурсов. Используйте эту операцию, чтобы проверить, удастся ли ходу. Проверка автоматически вызывается при отправке запроса на перемещение. Используйте эту операцию только тогда, когда вам нужно предопределить результаты. Для запуска этой операции вам необходимо:

* имя исходной группы ресурсов;
* идентификатор ресурса целевой группы ресурсов;
* идентификатор каждого перемещаемого ресурса;
* [маркер доступа](/rest/api/azure/#acquire-an-access-token) для вашей учетной записи.

Отправьте следующий запрос:

```HTTP
POST https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<source-group>/validateMoveResources?api-version=2019-05-10
Authorization: Bearer <access-token>
Content-type: application/json
```

С текстом запроса:

```json
{
 "resources": ["<resource-id-1>", "<resource-id-2>"],
 "targetResourceGroup": "/subscriptions/<subscription-id>/resourceGroups/<target-group>"
}
```

Если запрос имеет правильный формат, операция возвращает следующее:

```HTTP
Response Code: 202
cache-control: no-cache
pragma: no-cache
expires: -1
location: https://management.azure.com/subscriptions/<subscription-id>/operationresults/<operation-id>?api-version=2018-02-01
retry-after: 15
...
```

Код состояния 202 указывает, что запрос на проверку был принят, но еще не определено, завершится ли операция перемещения успешно. Значение `location` содержит URL-адрес, который используется для проверки состояния продолжительной операции.  

Чтобы проверить состояние, отправьте следующий запрос:

```HTTP
GET <location-url>
Authorization: Bearer <access-token>
```

Пока операция все еще выполняется, вы по-прежнему получаете код состояния 202. Подождите в течение времени, указанного в значении `retry-after`, прежде чем повторять попытку. Если проверка операции перемещения завершена успешно, вы получите код состояния 204. Если проверка перемещения закончилась ошибкой, вы получите сообщение об ошибке, например:

```json
{"error":{"code":"ResourceMoveProviderValidationFailed","message":"<message>"...}}
```

## <a name="use-the-portal"></a>Использование портала

Чтобы переместить ресурсы, выберите группу ресурсов, в которой они содержатся, а затем нажмите кнопку **Переместить**.

![перемещение ресурсов](./media/move-resource-group-and-subscription/select-move.png)

Укажите, куда будут перемещены ресурсы: в новую группу ресурсов или новую подписку.

Выберите ресурсы, которые необходимо переместить, и целевую группу ресурсов. Подтвердите обновление сценариев для этих ресурсов и нажмите кнопку **ОК**. Если на предыдущем шаге был выбран значок редактирования подписки, то также необходимо выбрать целевую подписку.

![выбор места назначения](./media/move-resource-group-and-subscription/select-destination.png)

В области **уведомлений**вы увидите, что операция перемещения выполняется.

![отображение состояния перемещения](./media/move-resource-group-and-subscription/show-status.png)

После ее завершения отобразится уведомление о результате.

![отображение результата перемещения](./media/move-resource-group-and-subscription/show-result.png)

Если вы обнаружите ошибку, см. [Troubleshoot, перемещая ресурсы Azure в новую группу ресурсов или подписку.](troubleshoot-move.md)

## <a name="use-azure-powershell"></a>Использование Azure PowerShell

Чтобы переместить существующие ресурсы в другую группу ресурсов или подписку, используйте команду [Move-AzResource](/powershell/module/az.resources/move-azresource). В следующем примере показано, как переместить несколько ресурсов в новую группу ресурсов.

```azurepowershell-interactive
$webapp = Get-AzResource -ResourceGroupName OldRG -ResourceName ExampleSite
$plan = Get-AzResource -ResourceGroupName OldRG -ResourceName ExamplePlan
Move-AzResource -DestinationResourceGroupName NewRG -ResourceId $webapp.ResourceId, $plan.ResourceId
```

Чтобы переместить ресурс в новую подписку, добавьте значение параметра `DestinationSubscriptionId`.

Если вы обнаружите ошибку, см. [Troubleshoot, перемещая ресурсы Azure в новую группу ресурсов или подписку.](troubleshoot-move.md)

## <a name="use-azure-cli"></a>Использование Azure CLI

Чтобы переместить существующие ресурсы в другую группу или подписку, используйте команду [az resource move](/cli/azure/resource?view=azure-cli-latest#az-resource-move). Укажите идентификаторы перемещаемых ресурсов. В следующем примере показано, как переместить несколько ресурсов в новую группу ресурсов. В параметре `--ids` укажите перемещаемый список идентификаторов ресурсов с разделителями-пробелами.

```azurecli
webapp=$(az resource show -g OldRG -n ExampleSite --resource-type "Microsoft.Web/sites" --query id --output tsv)
plan=$(az resource show -g OldRG -n ExamplePlan --resource-type "Microsoft.Web/serverfarms" --query id --output tsv)
az resource move --destination-group newgroup --ids $webapp $plan
```

Для перемещения в новую подписку нужно указать параметр `--destination-subscription-id`.

Если вы обнаружите ошибку, см. [Troubleshoot, перемещая ресурсы Azure в новую группу ресурсов или подписку.](troubleshoot-move.md)

## <a name="use-rest-api"></a>Использование REST API

Чтобы переместить существующие ресурсы в другую группу ресурсов или подписку, используйте операцию [Ресурсов Move.](/rest/api/resources/Resources/MoveResources)

```HTTP
POST https://management.azure.com/subscriptions/{source-subscription-id}/resourcegroups/{source-resource-group-name}/moveResources?api-version={api-version}
```

В тексте запроса укажите целевую группу ресурсов и ресурсы для перемещения.

```json
{
 "resources": ["<resource-id-1>", "<resource-id-2>"],
 "targetResourceGroup": "/subscriptions/<subscription-id>/resourceGroups/<target-group>"
}
```

Если вы обнаружите ошибку, см. [Troubleshoot, перемещая ресурсы Azure в новую группу ресурсов или подписку.](troubleshoot-move.md)

## <a name="frequently-asked-questions"></a>Вопросы и ответы

**Вопрос: Операция перемещения ресурса, которая обычно занимает несколько минут, работает уже почти час. Что-то не так?**

Перемещение ресурса — это сложная операция с различными фазами. Это может включать в себя больше, чем просто поставщик ресурсов ресурса, который вы пытаетесь переместить. Из-за зависимостей между поставщиками ресурсов диспетчер ресурсов Azure позволяет завершить операцию за 4 часа. Этот период времени дает поставщикам ресурсов возможность оправиться от временных проблем. Если ваш запрос на перемещение выполняется в течение 4-часового периода, операция продолжает попытки завершиться и может все еще увенчаться успехом. Группы ресурсов источника и назначения блокируются в течение этого времени, чтобы избежать проблем согласованности.

**Вопрос: Почему моя группа ресурсов заблокирована на 4 часа во время перемещения ресурсов?**

4-часовое окно — это максимальное время перемещения ресурса. Для предотвращения изменений в перемещаемых ресурсах группы ресурсов источника и назначения блокируются на время перемещения ресурса.

Запрос перемещения имеет два этапа. На первом этапе ресурс перемещается. На втором этапе уведомления отправляются другим поставщикам ресурсов, которые зависят от перемещенного ресурса. Группа ресурсов может быть заблокирована для всего 4-часового окна, когда поставщик ресурсов не выполняет ни одной из фаз. В течение разрешенного времени диспетчер ресурсов повторно делает неудачный шаг.

Если ресурс не может быть перемещен в 4-часовое окно, диспетчер ресурсов разблокирует обе группы ресурсов. Ресурсы, которые были успешно перемещены, находятся в группе ресурсов назначения. Ресурсы, которые не переместились, остаются группой ресурсов источника.

**Вопрос: Каковы последствия блокировки групп ресурсов источника и назначения во время перемещения ресурса?**

Блокировка не позволяет удалять группу ресурсов, создавать новый ресурс в группе ресурсов или удалять любой из ресурсов, участвующих в перемещении.

Следующее изображение показывает сообщение об ошибке с портала Azure, когда пользователь пытается удалить группу ресурсов, которая является частью текущего перемещения.

![Перемещение сообщения об ошибке при попытке удалить](./media/move-resource-group-and-subscription/move-error-delete.png)

**Вопрос: Что означает код ошибки "MissingMoveDependentResources"?**

При перемещении ресурса его зависимые ресурсы должны либо существовать в группе ресурсов назначения или подписке, либо быть включены в запрос перемещения. Вы получаете код ошибки MissingMoveDependentResources, когда зависимый ресурс не соответствует этому требованию. Сообщение об ошибке содержит сведения о зависимом ресурсе, который должен быть включен в запрос перемещения.

Например, для перемещения виртуальной машины может потребоваться перемещение семи типов ресурсов с тремя различными поставщиками ресурсов. Эти поставщики ресурсов и типы:

* Microsoft.Compute;

  * virtualMachines
  * disks
* Microsoft.Network.
  * networkInterfaces
  * publicIPAddresses
  * networkSecurityGroups
  * virtualNetworks
* Microsoft.Storage;
  * storageAccounts

Другой распространенный пример включает перемещение виртуальной сети. Возможно, вам придется переместить несколько других ресурсов, связанных с этой виртуальной сетью. Запрос перемещения может потребовать перемещения общедоступных IP-адресов, таблиц маршрутов, виртуальных сетевых шлюзов, групп сетевой безопасности и других.

**Вопрос: Почему я не могу переместить некоторые ресурсы в Azure?**

В настоящее время не все ресурсы в поддержке Azure перемещаются. Список ресурсов, поддерживающих перемещение, [см.](move-support-resources.md)

## <a name="next-steps"></a>Дальнейшие действия

Список ресурсов, поддерживающих перемещение [Move operation support for resources](move-support-resources.md)ресурсов, см.
