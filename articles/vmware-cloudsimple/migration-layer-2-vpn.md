---
title: Решение VMware для Azure, Клаудсимпле перетягивание локальной сети уровня 2 в частное облако
description: Описывает, как настроить VPN уровня 2 между НСКС-T в частном облаке Клаудсимпле и локальном изолированном клиенте НСКС пограничной Организации.
author: sharaths-cs
ms.author: b-shsury
ms.date: 08/19/2019
ms.topic: article
ms.service: azure-vmware-cloudsimple
ms.reviewer: cynthn
manager: dikamath
ms.openlocfilehash: 1f5ff48f4d5a658a1bbb4e6b9fb4b3f0f3fb190f
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81602691"
---
# <a name="migrate-workloads-using-layer-2-stretched-networks"></a>Перенос рабочих нагрузок с помощью растянутых сетей уровня 2

В этом руководство вы узнаете, как использовать VPN уровня 2 (L2VPN) для переноса сети уровня 2 из локальной среды в частное облако Клаудсимпле. Это решение позволяет выполнять миграцию рабочих нагрузок, работающих в локальной среде VMware, в частное облако в Azure в рамках одного адресного пространства подсети без необходимости повторного IP-адреса рабочих нагрузок.

Растяжение на основе L2VPN в сетях уровня 2 может работать с сетями на основе НСКС или без них в локальной среде VMware. Если у вас нет сетей на основе НСКС для рабочих нагрузок в локальной среде, можно использовать изолированный шлюз служб НСКС ребра.

> [!NOTE]
> В этом руководстве рассматривается сценарий, в котором локальные и частные облачные центры данных подключены через VPN типа "сеть — сеть".

## <a name="deployment-scenario"></a>Сценарий развертывания

Чтобы растянуть локальную сеть с помощью L2VPN, необходимо настроить сервер L2VPN (назначение маршрутизатора назначения НСКС-T Tier0) и клиент L2VPN (исходный автономный клиент).  

В этом сценарии развертывания ваше частное облако подключается к локальной среде через VPN-туннель типа "сеть — сеть", который позволяет локальным средам управления и виртуальным подсетям vMotion обмениваться данными с подсетями управления частным облаком и vMotion. Это расположение необходимо для перекрестного vCenter vMotion (КСВК-vMotion). Маршрутизатор НСКС-T Tier0 развертывается в частном облаке как сервер L2VPN.

Автономный НСКСный периметр развертывается в локальной среде как клиент L2VPN и затем связывается с сервером L2VPN. Конечная точка туннеля GRE создается на каждой стороне и настроена для переноса локальной сети уровня 2 в частное облако. Эта конфигурация показана на следующем рисунке.

![Сценарий развертывания](media/l2vpn-deployment-scenario.png)

Дополнительные сведения о миграции с помощью VPN уровня "L2" см. в статье [Виртуальные частные сети](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.3/com.vmware.nsxt.admin.doc/GUID-A8B113EC-3D53-41A5-919E-78F1A3705F58.html#GUID-A8B113EC-3D53-41A5-919E-78F1A3705F58__section_44B4972B5F12453B90625D98F86D5704) в документации по VMware.

## <a name="prerequisites-for-deploying-the-solution"></a>Необходимые условия для развертывания решения

Перед развертыванием и настройкой решения убедитесь, что выполняются следующие действия.

* Локальная версия vSphere — 6.7 U1 + или 6.5 P03 +.
* Локальная лицензия vSphere находится на уровне "Корпоративный Плюс" (для распределенного коммутатора vSphere).
* Найдите сеть уровня рабочей нагрузки 2, которую нужно растянуть в частном облаке.
* Найдите сеть уровня 2 в локальной среде для развертывания клиентского устройства L2VPN.
* [Частное облако уже создано](create-private-cloud.md).
* Версия автономного НСКС-T пограничной устройства совместима с версией НСКС-T Manager (НСКС-T 2.3.0), используемой в среде частного облака.
* Группа магистральных портов была создана в локальном vCenter с включенными подложными передачами.
* Общедоступный IP-адрес зарезервирован для использования с IP-адресом исходящей связи автономного клиента НСКС-T, и для преобразования между двумя адресами используется NAT 1:1.
* Пересылка DNS задается на локальных DNS-серверах, чтобы домен az.cloudsimple.io указывал на DNS-серверы частного облака.
* Задержка приема-передачи меньше или равна 150 мс, так как требуется для выполнения операции vMotion между двумя сайтами.

## <a name="limitations-and-considerations"></a>Ограничения и рекомендации

В следующей таблице перечислены поддерживаемые версии vSphere и типы сетевых адаптеров.  

| Версия vSphere | Исходный тип vSwitch | Драйвер виртуального сетевого адаптера | Целевой тип vSwitch | Поддержка |
------------ | ------------- | ------------ | ------------- | ------------- 
| Все | Программа | Все | Программа | Да |
| vSphere 6.7 UI или более поздней версии, 6.5 P03 или более поздней версии | Программа | VMXNET3 | N — VDS | Да |
| vSphere 6.7 UI или более поздней версии, 6.5 P03 или более поздней версии | Программа | E1000 | N — VDS | [Не поддерживается для Ввваре](https://kb.vmware.com/s/article/56991) |
| vSphere 6.7 UI или 6.5 P03, НСКС-V или версии ниже НСКС-T 2.2, 6.5 P03 или выше | Все | Все | N — VDS | [Не поддерживается для Ввваре](https://kb.vmware.com/s/article/56991) |

Начиная с версии VMware НСКС-T 2,3:

* Логический коммутатор на стороне частного облака, который дотягивается в локальную среду через L2VPN, нельзя маршрутизировать одновременно. Растянутый логический коммутатор не может быть подключен к логическому маршрутизатору.
* Виртуальные частные сети IPSEC на основе L2VPN и route можно настроить только с помощью вызовов API.

Дополнительные сведения см. в статье [Виртуальные частные сети](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.3/com.vmware.nsxt.admin.doc/GUID-A8B113EC-3D53-41A5-919E-78F1A3705F58.html#GUID-A8B113EC-3D53-41A5-919E-78F1A3705F58__section_44B4972B5F12453B90625D98F86D5704) в документации по VMware.

### <a name="sample-l2-vpn-deployment-addressing"></a>Пример адресации VPN-развертывания L2

### <a name="on-premises-network-where-the-standalone-esg-l2-vpn-client-is-deployed"></a>Локальная сеть, в которой развернут автономный ESG (VPN-клиент L2)

| **Элемент** | **Значение** |
|------------|-----------------|
| Сетевое имя | MGMT_NET_VLAN469 |
| Виртуальная локальная сеть | 469 |
| CIDR| 10.250.0.0/24 |
| IP-адрес автономного пограничных устройств | 10.250.0.111 |
| IP-адрес автономного пограничных устройств NAT | 192.227.85.167 |

### <a name="on-premises-network-to-be-stretched"></a>Локальная сеть для растягивания

| **Элемент** | **Значение** |
|------------|-----------------|
| Виртуальная локальная сеть | 472 |
| CIDR| 10.250.3.0/24 |

### <a name="private-cloud-ip-schema-for-nsx-t-tier0-router-l2-vpn-serve"></a>IP-схема частного облака для маршрутизатора НСКС-T Tier0 (виртуальные частные сети L2)

| **Элемент** | **Значение** |
|------------|-----------------|
| Интерфейс замыкания на себя | 192.168.254.254/32 |
| Туннельный интерфейс | 5.5.5.1/29 |
| Логический коммутатор (растянутый) | Stretch_LS |
| Интерфейс замыкания на себя (IP-адрес NAT) | 104.40.21.81 |

### <a name="private-cloud-network-to-be-mapped-to-the-stretched-network"></a>Сеть частного облака, которая будет сопоставлена с растянутой сетью

| **Элемент** | **Значение** |
|------------|-----------------|
| Виртуальная локальная сеть | 712 |
| CIDR| 10.200.15.0/24 |

## <a name="fetch-the-logical-router-id-needed-for-l2vpn"></a>Получение идентификатора логического маршрутизатора, необходимого для L2VPN

В следующих шагах показано, как получить идентификатор логического маршрутизатора для экземпляра логического маршрутизатора Tier0 DR для служб IPsec и L2VPN. ИДЕНТИФИКАТОР логического маршрутизатора требуется позже при реализации L2VPN.

1. Войдите в диспетчер `https://*nsx-t-manager-ip-address*` НСКС-T и выберите **Сетевые** > **маршрутизаторы** > **поставщик —** > **Обзор**LR. В **режиме высокого уровня доступности выберите режим**" **Активный — ожидание**". Это действие открывает всплывающее окно, в котором отображается пограничная виртуальная машина, на которой в данный момент активен маршрутизатор Tier0.

    ![Выбор режима "активный — резервный"](media/l2vpn-fetch01.png)

2. Выберите **Fabric** > **Nodes** > **границы**узлов структуры. Запишите IP-адрес активной виртуальной машины (ребра VM1), указанной на предыдущем шаге.

    ![IP-адрес управления заметками](media/l2vpn-fetch02.png)

3. Откройте сеанс SSH с IP-адресом управления пограничной виртуальной машины. Выполните ```get logical-router``` команду с именем пользователя **Admin** и паролем **клаудсимпле 123!**.

    ![получение выходных данных логического маршрутизатора](media/l2vpn-fetch03.png)

4. Если вы не видите запись "DR-Provider-LR", выполните следующие действия.

5. Создайте два логических коммутатора, поддерживающих перекрытие. Один логический коммутатор растягивается в локальную среду, где находятся перенесенные рабочие нагрузки. Другой логический коммутатор — фиктивный параметр. Инструкции см. в разделе [Создание логического коммутатора](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.3/com.vmware.nsxt.admin.doc/GUID-23194F9A-416A-40EA-B9F7-346B391C3EF8.html) в документации по VMware.

    ![Создание логического коммутатора](media/l2vpn-fetch04.png)

6. Подключите фиктивный коммутатор к маршрутизатору 1 класса с локальным IP-адресом канала или любой другой непересекающейся подсетью из локального или частного облака. См. раздел [Добавление порта разную на логическом маршрутизаторе уровня 1](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.3/com.vmware.nsxt.admin.doc/GUID-E7EA867C-604C-4224-B61D-2A8EF41CB7A6.html) в документации по VMware.

    ![Присоединить фиктивный параметр](media/l2vpn-fetch05.png)

7. Выполните `get logical-router` команду еще раз в СЕАНСе SSH пограничной виртуальной машины. Отображается UUID логического маршрутизатора DR-Provider-LR. Запишите идентификатор UUID, который требуется при настройке L2VPN.

    ![получение выходных данных логического маршрутизатора](media/l2vpn-fetch06.png)

## <a name="fetch-the-logical-switch-id-needed-for-l2vpn"></a>Получение идентификатора логического коммутатора, необходимого для L2VPN

1. Войдите в [НСКС-T Manager](https://nsx-t-manager-ip-address).
2. Выберите **Networking** > **коммутаторы**  > **Overview****Switching** >  сетевой коммутации > < обзор** \>коммутатора \логикал**.
3. Запишите UUID логического коммутатора растяжения, который требуется при настройке L2VPN.

    ![получение выходных данных логического маршрутизатора](media/l2vpn-fetch-switch01.png)

## <a name="routing-and-security-considerations-for-l2vpn"></a>Вопросы маршрутизации и безопасности для L2VPN

Чтобы установить VPN на основе маршрутов IPsec между маршрутизатором НСКС-T Tier0 и изолированным клиентским клиентом НСКС, интерфейс замыкания на себя маршрутизатора НСКС-T Tier0 должен иметь возможность взаимодействовать с общедоступным IP-адресом локального клиента НСКС по протоколу UDP 500/4500.

### <a name="allow-udp-5004500-for-ipsec"></a>Разрешить UDP 500/4500 для IPsec

1. [Создайте общедоступный IP-адрес](public-ips.md) для интерфейса замыкания на себя НСКС-T Tier0 на портале клаудсимпле.

2. [Создайте таблицу брандмауэра](firewall.md) с правилами с отслеживанием состояния, разрешающими входящий трафик UDP 500/4500, и вложите таблицу брандмауэра в подсеть НСКС-T хосттранспорт.

### <a name="advertise-the-loopback-interface-ip-to-the-underlay-network"></a>Объявление IP-адреса интерфейса замыкания на себя в сети ундерлай

1. Создайте маршрут со значением NULL для сети интерфейса замыкания на себя. Войдите в НСКС Manager и выберите **сеть** > поставщик**маршрутизаторов** > **маршрутизации** > **-LR** > **Маршрутизация** > **статических маршрутов**. Нажмите кнопку **Добавить**. В поле **сеть**введите IP-адрес интерфейса замыкания на себя. Для **следующих прыжков**нажмите кнопку **Добавить**, укажите значение NULL для следующего прыжка и выберите значение по умолчанию 1 для параметра Расстояние администратора.

    ![Добавить статический маршрут](media/l2vpn-routing-security01.png)

2. Создайте список префиксов IP-адресов. Войдите в НСКС Manager и выберите **сеть** > поставщик**маршрутизаторов** > **маршрутизации** > —**списки IP-префиксов****маршрутизации** > **LR** > . Нажмите кнопку **Добавить**. Введите имя для указания списка. Для добавления **префиксов**нажмите кнопку **Добавить** дважды. В первой строке введите "0.0.0.0/0" для команды " **сеть** " и "запретить" для **действия**. Во второй строке выберите **любой** для **сети** и **разрешите** **действие**.
3. Присоедините список префиксов IP-адресов к соседам BGP (TOR). Присоединение списка префиксов IP-адресов к соседу BGP предотвращает объявление маршрута по умолчанию в BGP для коммутаторов TOR. Однако любой другой маршрут, который содержит маршрут null, будет объявлять IP-адрес интерфейса замыкания на себя для коммутаторов TOR.

    ![Создать список префиксов IP-адресов](media/l2vpn-routing-security02.png)

4. Войдите в Диспетчер НСКС-T и выберите **сеть** > поставщик**маршрутизаторов** > **маршрутизации** > **(** > **Маршрутизация** > **BGP** > **Neighbors**для маршрутизации). Выберите первый сосед. Щелкните **изменить** > **семейства адресов**. В семействе IPv4 измените столбец **исходящий фильтр** и выберите созданный список IP-префиксов. Нажмите кнопку **Сохранить**. Повторите этот шаг для второго соседа.

    ![Подключить IP-префикс список](media/l2vpn-routing-security03.png) ![1 присоединить IP-префикс список 2](media/l2vpn-routing-security04.png)

5. Повторно распространите статический маршрут NULL в BGP. Чтобы объявить маршрут интерфейса замыкания на ундерлай, необходимо повторно распространить статический маршрут NULL в BGP. Войдите в НСКС Manager и выберите **сеть** > поставщик**маршрутизаторов** > **маршрутизации** > -репликация**маршрутов** > **Neighbors****маршрутизации** > **LR** > . Выберите **поставщик-LR-Route_Redistribution** и нажмите кнопку **изменить**. Установите флажок **статический** и нажмите кнопку **сохранить**.

    ![Повторное распространение статического маршрута NULL в BGP](media/l2vpn-routing-security05.png)

## <a name="configure-a-route-based-vpn-on-the-nsx-t-tier0-router"></a>Настройка VPN на основе маршрутов на маршрутизаторе НСКС-T Tier0

Используйте следующий шаблон, чтобы заполнить все сведения о настройке VPN на основе маршрутов на маршрутизаторе НСКС-T Tier0. Идентификаторы UUID в каждом вызове POST необходимы во всех последующих вызовах POST. IP-адреса для интерфейсов замыкания на себя и туннеля для L2VPN должны быть уникальными и не перекрываться с локальными или частными сетями.

IP-адреса, выбранные для интерфейса замыкания на себя и туннеля, используемые для L2VPN, должны быть уникальными и не перекрываться локальными или частными сетями. Сеть интерфейса замыкания на себя всегда должна иметь значение/32.

```
Loopback interface ip : 192.168.254.254/32
Tunnel interface subnet : 5.5.5.0/29
Logical-router ID : UUID of Tier0 DR logical router obtained in section "Steps to fetch Logical-Router ID needed for L2VPN"
Logical-switch ID(Stretch) : UUID of Stretch Logical Switch obtained earlier
IPSec Service ID :
IKE profile ID :
DPD profile ID :
Tunnel Profile ID :
Local-endpoint ID :
Peer end-point ID :
IPSec VPN session ID (route-based) :
L2VPN service ID :
L2VPN session ID :
Logical-Port ID :
Peer Code :
```

Для всех приведенных ниже вызовов API Замените IP-адрес своим IP адресом НСКС-T Manager. Все эти вызовы API можно выполнять из пост-клиента или с помощью `curl` команд.

### <a name="enable-the-ipsec-vpn-service-on-the-logical-router"></a>Включение службы VPN IPSec на логическом маршрутизаторе

```
POST   https://192.168.110.201/api/v1/vpn/ipsec/services/
{
"resource_type": "IPSecVPNService",
"description": "Manage VPN service",
"display_name": "IPSec VPN service",
"logical_router_id": "Logical-router ID",
"ike_log_level": "INFO",
"enabled": true
}
```

### <a name="create-profiles-ike"></a>Создание профилей: IKE

```
POST https://192.168.110.201/api/v1/vpn/ipsec/ike-profiles
 
{
"resource_type": "IPSecVPNIKEProfile",
"description": "IKEProfile for siteA",
"display_name": "IKEProfile siteA",
"encryption_algorithms": ["AES_128"],
"ike_version": "IKE_V2",
"digest_algorithms": ["SHA2_256"],
"sa_life_time":21600,
"dh_groups": ["GROUP14"]
}
```

### <a name="create-profiles-dpd"></a>Создание профилей: DPD

```
POST  https://192.168.110.201/api/v1/vpn/ipsec/dpd-profiles  

{
"resource_type": "IPSecVPNDPDProfile",
"display_name": "nsx-default-dpd-profile",
"enabled": true
}
```

### <a name="create-profiles-tunnel"></a>Создание профилей: туннелирование

```
POST  https://192.168.110.201/api/v1/vpn/ipsec/tunnel-profiles
 
{
"resource_type": "IPSecVPNTunnelProfile",
"display_name": "nsx-default-tunnel-profile",
"enable_perfect_forward_secrecy": true,
"encryption_algorithms": ["AES_GCM_128"],
"digest_algorithms": [],
"sa_life_time":3600,
"dh_groups": ["GROUP14"],
"encapsulation_mode": "TUNNEL_MODE",
"transform_protocol": "ESP",
"df_policy": "COPY"
}
```

### <a name="create-a-local-endpoint"></a>Создание локальной конечной точки

``` 
POST https://192.168.110.201/api/v1/vpn/ipsec/local-endpoints
 
{
"resource_type": "IPSecVPNLocalEndpoint",
"description": "Local endpoint",
"display_name": "Local endpoint",
"local_id": "<Public IP of Loopback interface>",
"ipsec_vpn_service_id": {
"target_id": "IPSec VPN service ID"},
"local_address": "<IP of Loopback interface>",
"trust_ca_ids": [],
"trust_crl_ids": []
}
```

### <a name="create-a-peer-endpoint"></a>Создание одноранговой конечной точки

```
POST https://192.168.110.201/api/v1/vpn/ipsec/peer-endpoints

{
"resource_type": "IPSecVPNPeerEndpoint",
"description": "Peer endpoint for site B",
"display_name": "Peer endpoint for site B",
"connection_initiation_mode": "INITIATOR",
"authentication_mode": "PSK",
"ipsec_tunnel_profile_id": "IPSec Tunnel profile ID",
"dpd_profile_id": "DPD profile ID",
"psk":"nsx",
"ike_profile_id": "IKE profile ID",
"peer_address": "<Public IP of Standalone client",
"peer_id": "<Public IP of Standalone client>"
}
```

### <a name="create-a-route-based-vpn-session"></a>Создание сеанса VPN на основе маршрута

```
POST :  https://192.168.110.201/api/v1/vpn/ipsec/sessions
 
{
"resource_type": "RouteBasedIPSecVPNSession",
"peer_endpoint_id": "Peer Endpoint ID",
"ipsec_vpn_service_id": "IPSec VPN service ID",
"local_endpoint_id": "Local Endpoint ID",
"enabled": true,
"tunnel_ports": [
{
"ip_subnets": [
{
"ip_addresses": [
 "5.5.5.1"
],
"prefix_length": 24
}
  ]
}
]
}
```

## <a name="configure-l2vpn-on-nsx-t-tier0-router"></a>Настройка L2VPN на маршрутизаторе НСКС-T Tier0

После каждого вызова POST заполните следующие сведения. Идентификаторы необходимы при последующих вызовах POST.

```
L2VPN Service ID:
L2VPN Session ID:
Logical Port ID:
```

### <a name="create-the-l2vpn-service"></a>Создание службы L2VPN

Выходные данные следующей команды GET будут пустыми, так как конфигурация еще не завершена.

```
GET : https://192.168.110.201/api/v1/vpn/l2vpn/services
```

Для следующей команды POST идентификатор логического маршрутизатора — это UUID логического маршрутизатора Tier0 DR, полученного ранее.

```
POST : https://192.168.110.201/api/v1/vpn/l2vpn/services

{
"logical_router_id": "Logical Router ID",
"enable_full_mesh" : true
}
```

### <a name="create-the-l2vpn-session"></a>Создание сеанса L2VPN

Для следующей команды POST идентификатор службы L2VPN — это только что полученный идентификатор, а идентификатор сеанса VPN-подключения IPsec — это идентификатор, полученный в предыдущем разделе.

```    
POST: https://192.168.110.201/api/v1/vpn/l2vpn/sessions

{
"l2vpn_service_id" : "L2VPN service ID",
"transport_tunnels" : [
    {
    "target_id" : "IPSec VPN session ID"
    }]
}
```

Эти вызовы создают конечную точку туннеля GRE. Чтобы проверить состояние, выполните следующую команду.

```
edge-2> get tunnel-port
Tunnel      : 44648dae-8566-5bc9-a065-b1c4e5c3e03f
IFUID       : 328
LOCAL       : 169.254.64.1
REMOTE      : 169.254.64.2
ENCAP       : GRE

Tunnel      : cf950ca1-5cf8-5438-9b1a-d2c8c8e7229b
IFUID       : 318
LOCAL       : 192.168.140.155
REMOTE      : 192.168.140.152
ENCAP       : GENEVE

Tunnel      : 63639321-87c5-529e-8a61-92c1939799b2
IFUID       : 304
LOCAL       : 192.168.140.155
REMOTE      : 192.168.140.156
ENCAP       : GENEVE
```

### <a name="create-logical-port-with-the-tunnel-id-specified"></a>Создание логического порта с указанным ИДЕНТИФИКАТОРом туннеля

```
    POST https://192.168.110.201/api/v1/logical-ports/

{
"resource_type": "LogicalPort",
"display_name": "Extend logicalSwitch, port for service",
"logical_switch_id": "Logical switch ID",
"admin_state" : "UP",
"attachment": {
"attachment_type":"L2VPN_SESSION",
"id":"L2VPN session ID",
"context" : {
"resource_type" : "L2VpnAttachmentContext",
    "tunnel_id" : 10
}
    }
        }
```

## <a name="obtain-the-peer-code-for-l2vpn-on-the-nsx-t-side"></a>Получение кода однорангового узла для L2VPN на стороне НСКС-T

Получите одноранговый код конечной точки НСКС-T. При настройке удаленной конечной точки требуется одноранговый код. Идентификатор сеанса> L2VPN <можно получить из предыдущего раздела. Дополнительные сведения см. в разделе [НСКС-T 2,3 API Guide](https://www.vmware.com/support/nsxt/doc/nsxt_23_api.html).

```
GET https://192.168.110.201/api/v1/vpn/l2vpn/sessions/<session-id>/peer-codes
```

## <a name="deploy-the-nsx-t-standalone-client-on-premises"></a>Развертывание автономного клиента НСКС-T (локально)

Перед развертыванием убедитесь, что локальные правила брандмауэра разрешают входящий и исходящий трафик UDP 500/4500 от/к общедоступному IP-адресу Клаудсимпле, который был зарезервирован ранее для интерфейса замыкания маршрутизатора НСКС-T T0. 

1. [Скачайте автономный клиент НСКС пограничных](https://my.vmware.com/group/vmware/details?productId=673&rPId=33945&downloadGroup=NSX-T-230) устройств OVF и извлеките файлы из скачанного пакета в папку.

    ![Скачать автономный клиент НСКС пограничных устройств](media/l2vpn-deploy-client01.png)

2. Перейдите в папку со всеми извлеченными файлами. Выберите все VMDK (НСКС-L2T-Client-Large. MF и NSX-l2t-client-large. ovf для большого размера устройства или НСКС-L2T-Client-Ксларже. MF и NSX-l2t-client-Xlarge. ovf для очень большого размера устройства). Щелкните **Далее**.

    ![](media/l2vpn-deploy-client02.png) ![Выбор шаблона выбор шаблона](media/l2vpn-deploy-client03.png)

3. Введите имя автономного клиента НСКС-T и нажмите кнопку **Далее**.

    ![Введите имя шаблона](media/l2vpn-deploy-client04.png)

4. Нажмите кнопку **Далее** по мере необходимости, чтобы получить доступ к параметрам хранилища данных. Выберите соответствующее хранилище данных для автономного клиента НСКС-T и нажмите кнопку **Далее**.

    ![Выбор хранилища данных](media/l2vpn-deploy-client06.png)

5. Выберите правильные группы портов для магистрали (магистральная PG), общедоступный (канал PG) и интерфейс высокой доступности (исходящей связи PG) для автономного клиента НСКС-T. Щелкните **Далее**.

    ![Выбор групп портов](media/l2vpn-deploy-client07.png)

6. Введите следующие сведения на экране **Настройка шаблона** и нажмите кнопку **Далее**.

    Разверните L2T:

    * **Одноранговый адрес**. Введите IP-адрес, зарезервированный на портале Azure Клаудсимпле, для интерфейса замыкания на себя НСКС-T Tier0.
    * **Одноранговый код**. Вставьте одноранговый код, полученный на последнем шаге развертывания сервера L2VPN.
    * **Подинтерфейсы VLAN (идентификатор туннеля)**. Введите идентификатор виртуальной ЛС для растяжения. В скобках () введите идентификатор туннеля, который был ранее настроен.

    Разверните узел интерфейс исходящей связи:

    * **IP-адрес DNS**. Введите локальный IP-адрес DNS.
    * **Шлюз по умолчанию**.  Введите шлюз по умолчанию виртуальной ЛС, который будет использоваться в качестве шлюза по умолчанию для этого клиента.
    * **IP-адрес**. Введите IP-адрес канала исходящей связи автономного клиента.
    * **Длина префикса**. Введите длину префикса VLAN или подсети исходящей связи.
    * **Администратор CLI, включение и ввод пароля пользователя root**. Задайте пароль для учетной записи администратора/Enable/root.

      ![](media/l2vpn-deploy-client08.png)
      ![Настройка шаблона настройки шаблона — дополнительно](media/l2vpn-deploy-client09.png)

7. Проверьте параметры и нажмите кнопку **Готово**.

    ![Полная конфигурация](media/l2vpn-deploy-client10.png)

## <a name="configure-an-on-premises-sink-port"></a>Настройка локального порта приемника

Если на одном из сайтов VPN не развернут НСКС, можно настроить VPN уровня "L2", развернув автономную НСКС границу на этом сайте. Автономный НСКСный периметр развертывается с помощью файла OVF на узле, который не управляется НСКС. Это позволяет развернуть устройство шлюза служб НСКС ребра для работы в качестве VPN-клиента L2.

Если автономная пограничная магистральная vNIC подключена к vSphere распределенному коммутатору, то для функции VPN уровня "L2" требуется либо неизбирательный режим, либо порт приемника. Использование неизбирательного режима может привести к дублированию проверки связи и дублированию ответов. По этой причине используйте режим порта приемника в конфигурации автономной НСКС границы виртуальной частной сети L2. См. раздел [Настройка порта приемника](https://docs.vmware.com/en/VMware-NSX-Data-Center-for-vSphere/6.4/com.vmware.nsx.admin.doc/GUID-3CDA4346-E692-4592-8796-ACBEEC87C161.html) в документации по VMware.

## <a name="ipsec-vpn-and-l2vpn-verification"></a>Проверка VPN и L2VPN IPsec

Используйте следующие команды для проверки сеансов IPsec и L2VPN из автономной НСКС-T.

```
nsx-l2t-edge> show service ipsec
-----------------------------------------------------------------------
vShield Edge IPSec Service Status:
IPSec Server is running.
AESNI is enabled.
Total Sites: 1, 1 UP, 0 Down
Total Tunnels: 1, 1 UP, 0 Down
----------------------------------
Site:  10.250.0.111_0.0.0.0/0-104.40.21.81_0.0.0.0/0
Channel: PeerIp: 104.40.21.81    LocalIP: 10.250.0.111  Version: IKEv2  Status: UP
Tunnel: PeerSubnet: 0.0.0.0/0    LocalSubnet: 0.0.0.0/0   Status: UP
----------------------------------
```

```
nsx-l2t-edge> show service l2vpn
L2 VPN is running
----------------------------------------
L2 VPN type: Client/Spoke

SITENAME                       IPSECSTATUS          VTI                  GRE
1ecb00fb-a538-4740-b788-c9049e8cb6c6 UP                   vti-100              l2t-1
```

Используйте следующие команды для проверки сеансов IPsec и L2VPN из маршрутизатора НСКС-T Tier0.

```
edge-2> get ipsecvpn session
Total Number of Sessions: 1

IKE Session ID : 3
UUID           : 1ecb00fb-a538-4740-b788-c9049e8cb6c6
Type           : Route

Local IP       : 192.168.254.254      Peer IP        : 192.227.85.167
Local ID       : 104.40.21.81         Peer ID        : 192.227.85.167
Session Status : Up

Policy Rules
    VTI UUID       : 4bf96e3b-e50b-49cc-a16e-43a6390e3d53
    ToRule ID      : 560874406            FromRule ID    : 2708358054
    Local Subnet   : 0.0.0.0/0            Peer Subnet    : 0.0.0.0/0
    Tunnel Status  : Up
```

```
edge-2> get l2vpn session
Session       : f7147137-5dd0-47fe-9e53-fdc2b687b160
Tunnel        : b026095b-98c8-5932-96ff-dda922ffe316
IPSEC Session : 1ecb00fb-a538-4740-b788-c9049e8cb6c6
Status        : UP
```

Используйте следующие команды, чтобы проверить порт приемника на узле ESXi, где находится виртуальная машина НСКС-T в локальной среде.

```
 [root@esxi02:~] esxcfg-vswitch -l |grep NSX
  53                  1           NSXT-client-large.eth2
  225                1           NSXT-client-large.eth1
  52                  1           NSXT-client-large.eth0
```

```
[root@esxi02:~] net-dvs -l | grep "port\ [0-9]\|SINK\|com.vmware.common.alias"
                com.vmware.common.alias = csmlab2DS ,   propType = CONFIG
        port 24:
        port 25:
        port 26:
        port 27:
        port 13:
        port 19:
        port 169:
        port 54:
        port 110:
        port 6:
        port 107:
        port 4:
        port 199:
        port 168:
        port 201:
        port 0:
        port 49:
        port 53:
        port 225:
                com.vmware.etherswitch.port.extraEthFRP =   SINK
        port 52:
```
