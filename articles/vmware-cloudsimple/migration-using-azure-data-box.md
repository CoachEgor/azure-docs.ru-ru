---
title: Решение Azure VMware — перенос с помощью Azure Data Box
description: Использование Azure Data Box для упаковки данных в решение VMware для Azure.
author: sharaths-cs
ms.author: dikamath
ms.date: 09/27/2019
ms.topic: article
ms.service: azure-vmware-cloudsimple
ms.reviewer: cynthn
manager: dikamath
ms.openlocfilehash: ab772bd9cb415045ef70cb4cf9a518791befb192
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "86507675"
---
# <a name="migrating-data-to-azure-vmware-solution-by-using-azure-data-box"></a>Перенос данных в решение VMware для Azure с помощью Azure Data Box

Облачное решение Microsoft Azure Data Box позволяет вам быстро, недорого и надежно отсылать ТБ данных в Azure. Защищенное устройство хранения Azure Data Box обеспечивает безопасную передачу данных. Для каждого запоминающего устройства предусмотрена максимальная емкость хранилища 80 ТБ, которая передается в центр обработки данных региональным перевозчиком. Прочный корпус защищает устройство и хранящиеся на нем ваши данные во время передачи.

С помощью Data Box можно выполнить массовый перенос данных VMware в частное облако. Данные из локальной среды VMware vSphere копируются в Data Box с помощью протокола NFS. Перенос данных с помощью групповой миграции включает в себя сохранение копии виртуальных машин, конфигурации и связанных данных на момент времени, чтобы Data Box, а затем вручную доставлять их в Azure.

В этой статье вы узнаете о следующих возможностях:

* Настройка Data Box.
* Копирование данных из локальной среды VMware в Data Box с помощью NFS.
* Подготовка к возврату Data Box.
* Подготовка данных большого двоичного объекта для копирования в решение VMware для Azure.
* Копирование данных из Azure в частное облако.

## <a name="scenarios"></a>Сценарии

Используйте Data Box в следующих сценариях для выполнения групповой миграции данных.

* Для переноса большого объема данных из локальной среды в решение VMware для Azure. Этот метод устанавливает базовый план и синхронизирует различия по сети.
* Для переноса большого числа отключенных виртуальных машин (холодных виртуальных машин).
* Для миграции данных виртуальной машины для настройки сред разработки и тестирования.
* Для переноса большого количества шаблонов виртуальных машин, ISO-файлов и дисков виртуальных машин.

## <a name="before-you-begin"></a>Перед началом

* Проверьте предварительные требования и [порядок Data Box](../databox/data-box-deploy-ordered.md) с помощью портал Azure. В процессе заказа необходимо выбрать учетную запись хранения, которая включает хранилище BLOB-объектов. Получив устройство Data Box, подключите его к локальной сети и [Настройте устройство](../databox/data-box-deploy-set-up.md) с IP-адресом, который доступен из сети управления vSphere.

* Создайте виртуальную сеть и учетную запись хранения в том же регионе, в котором подготовлено решение VMware для Azure.

* Создайте [подключение виртуальной сети Azure](cloudsimple-azure-network-connection.md) из частного облака к виртуальной сети, в которой создана учетная запись хранения, выполнив действия, описанные в статье [подключение виртуальной сети Azure к Клаудсимпле с помощью ExpressRoute](virtual-network-connection.md).

## <a name="set-up-data-box-for-nfs"></a>Настройка Data Box для NFS

Подключитесь к локальному веб-ИНТЕРФЕЙСу Data Box, выполнив действия, описанные в подразделе "подключение к устройству" раздела [учебник. Подключение кабелей и соединение с Azure Data Box](../databox/data-box-deploy-set-up.md).  Настройте Data Box, чтобы разрешить доступ клиентам NFS:

1. В локальном веб-ИНТЕРФЕЙСе перейдите на страницу **подключение и копирование** . В разделе **параметры NFS**выберите **клиентский доступ NFS**. 

    ![Настройка клиентского доступа NFS 1](media/nfs-client-access.png)

2. Введите IP-адрес узлов VMware ESXi и нажмите кнопку **Добавить**. Вы можете настроить доступ для всех узлов в кластере vSphere, повторив этот шаг. Щелкните **ОК**.

    ![Настройка клиентского доступа NFS 2](media/nfs-client-access2.png)
> [!IMPORTANT]
> **Всегда создавайте отдельную папку для файлов, которые вы собираетесь скопировать в общую папку**. Папка, созданная в общих папках блочных и страничных BLOB-объектов, представляет собой контейнер, куда передаются данные в виде больших двоичных объектов. Вы не можете копировать файлы непосредственно в *корневую* папку в учетной записи хранения.

В общих папках для блочных и страничных BLOB-объектов объектами первого уровня являются контейнеры, а второго — большие двоичные объекты. В разделе Общие папки для файлов Azure сущности первого уровня являются общими, а сущности второго уровня — файлами.

В следующей таблице приведен UNC-путь к общим папкам в Data Box и URL-адрес службы хранилища Azure, куда отправляются данные. Конечный URL-адрес службы хранилища Azure может быть производным от UNC-пути к общей папке.
 
| Большие двоичные объекты и файлы | Путь и URL-адрес |
|---------------- | ------------ |
| Блочные BLOB-объекты Azure | <li>UNC-путь к общим папкам: `//<DeviceIPAddress>/<StorageAccountName_BlockBlob>/<ContainerName>/files/a.txt`</li><li>URL-адрес службы хранилища Azure: `https://<StorageAccountName>.blob.core.windows.net/<ContainerName>/files/a.txt`</li> |  
| Страничные BLOB-объекты Azure  | <li>UNC-путь к общим папкам: `//<DeviceIPAddres>/<StorageAccountName_PageBlob>/<ContainerName>/files/a.txt`</li><li>URL-адрес службы хранилища Azure: `https://<StorageAccountName>.blob.core.windows.net/<ContainerName>/files/a.txt`</li>   |  
| Файлы Azure       |<li>UNC-путь к общим папкам: `//<DeviceIPAddres>/<StorageAccountName_AzFile>/<ShareName>/files/a.txt`</li><li>URL-адрес службы хранилища Azure: `https://<StorageAccountName>.file.core.windows.net/<ShareName>/files/a.txt`</li>        |

> [!NOTE]
> Используйте блочные BLOB-объекты Azure для копирования данных VMware.

## <a name="mount-the-nfs-share-as-a-datastore-on-your-on-premises-vcenter-cluster-and-copy-the-data"></a>Подключите общий ресурс NFS в качестве хранилища данных в локальном кластере vCenter и скопируйте данные.

Общий ресурс NFS из Data Box должен быть подключен как хранилище данных в локальном кластере vCenter или на узле VMware ESXi, чтобы скопировать данные в хранилище NFS.

1. Войдите на локальный сервер vCenter.

2. Щелкните правой кнопкой мыши **центр обработки**данных, выберите **хранилище**, выберите пункт **создать хранилище данных**, а затем нажмите кнопку **Далее**.

   ![Добавить новое хранилище данных](media/databox-migration-add-datastore.png)

3. На шаге 1 мастера добавления хранилища данных выберите **NFS** в поле **тип**.

   ![Добавить новое хранилище данных-тип](media/databox-migration-add-datastore-type.png)

4. На шаге 2 мастера выберите **NFS 3** в качестве версии NFS, а затем нажмите кнопку **Далее**.

   ![Добавление нового хранилища данных — версия NFS](media/databox-migration-add-datastore-nfs-version.png)

5. На шаге 3 мастера укажите имя хранилища данных, путь и сервер. Для сервера можно использовать IP-адрес Data Box. Путь к папке будет иметь `/<StorageAccountName_BlockBlob>/<ContainerName>/` Формат.

   ![Добавление нового хранилища данных — конфигурация NFS](media/databox-migration-add-datastore-nfs-configuration.png)

6. На шаге 4 мастера выберите узлы ESXi, в которых необходимо подключить хранилище данных, а затем нажмите кнопку **Далее**.  В кластере выберите все узлы, чтобы обеспечить миграцию виртуальных машин.

   ![Добавление нового хранилища данных — выбор узлов](media/databox-migration-add-datastore-nfs-select-hosts.png)

7. На шаге 5 мастера проверьте сводку и нажмите кнопку **Готово**.

## <a name="copy-data-to-the-data-box-nfs-datastore"></a>Копировать данные в хранилище данных Data Box NFS

Виртуальные машины можно перенести или клонировать в новое хранилище данных.  Все неиспользуемые виртуальные машины, которые вы хотите перенести, можно перенести в хранилище данных Data Box NFS с помощью параметра **Storage VMotion** . Активные виртуальные машины можно клонировать в хранилище данных Data Box NFS.

* Найдите и перечислите виртуальные машины, которые можно **переместить**.
* Найдите и перечислите виртуальные машины, которые должны быть **Клонированы**.

### <a name="move-a-virtual-machine-to-a-data-box-datastore"></a>Перемещение виртуальной машины в хранилище данных Data Box

1. Щелкните правой кнопкой мыши виртуальную машину, которую нужно переместить в хранилище данных Data Box, а затем выберите пункт **Миграция**.

    ![Миграция виртуальной машины](media/databox-migration-vm-migrate.png)

2. Выберите **изменить хранилище только** для типа миграции, а затем нажмите кнопку **Далее**.

    ![Миграция виртуальной машины — только хранилище](media/databox-migration-vm-migrate-change-storage.png)

3. Выберите **датабокс — хранилище данных** в качестве места назначения, а затем нажмите кнопку **Далее**.

    ![Миграция виртуальной машины — Выбор хранилища данных](media/databox-migration-vm-migrate-change-storage-select-datastore.png)

4. Проверьте сведения и нажмите кнопку **Готово**.

5. Повторите шаги с 1 по 4 для дополнительных виртуальных машин.

> [!TIP]
> Можно выбрать несколько виртуальных машин, которые находятся в одном и том же состоянии электропитания (включено или выключено), и перенести их в небольшую степень.

Виртуальная машина будет перенесена в хранилище данных NFS из Data Box. После переноса всех виртуальных машин можно отключить (выключить) активные виртуальные машины в процессе подготовки к переносу данных в решение VMware для Azure.

### <a name="clone-a-virtual-machine-or-a-virtual-machine-template-to-the-data-box-datastore"></a>Клонирование виртуальной машины или шаблона виртуальной машины в хранилище данных Data Box

1. Щелкните правой кнопкой мыши виртуальную машину или шаблон виртуальной машины, который необходимо клонировать. Выберите **клонировать**  >  **клон в виртуальную машину**.

    ![Клон виртуальной машины](media/databox-migration-vm-clone.png)

2. Выберите имя клонированной виртуальной машины или шаблона виртуальной машины.

3. Выберите папку, в которую нужно поместить клонированный объект, а затем нажмите кнопку **Далее**.

4. Выберите кластер или пул ресурсов, в котором нужно поместить клонированный объект, а затем нажмите кнопку **Далее**.

5. Выберите **датабокс — хранилище** данных в качестве места хранения и нажмите кнопку **Далее**.

    ![Клон виртуальной машины — выберите хранилище данных.](media/databox-migration-vm-clone-select-datastore.png)

6. Если необходимо настроить параметры клонированного объекта, выберите параметры настройки, а затем нажмите кнопку **Далее**.

7. Проверьте конфигурации и нажмите кнопку **Готово**.

8. Повторите шаги 1 – 7 для дополнительных виртуальных машин или шаблонов виртуальных машин.

Виртуальные машины будут клонированы и сохранены в хранилище данных NFS из Data Box. После клонирования виртуальных машин убедитесь, что они отключены при подготовке к переносу данных в решение VMware для Azure.

### <a name="copy-iso-files-to-the-data-box-datastore"></a>Копирование ISO-файлов в хранилище данных Data Box

1. В локальном веб-ИНТЕРФЕЙСе vCenter перейдите в раздел **хранилище**.  Выберите **датабокс — хранилище данных** , а затем выберите **файлы**. Создайте новую папку для хранения ISO-файлов.

    ![Копирование ISO-файла — создание новой папки](media/databox-migration-create-folder.png)

2. Укажите имя папки, в которой будут храниться файлы ISO.

3. Дважды щелкните только что созданную папку, чтобы открыть ее.

4. Выберите **отправить файлы** , а затем выберите ISO-файлы, которые требуется передать.
    
    ![Копирование ISO-передача файлов](media/databox-migration-upload-iso.png)

> [!TIP]
> Если у вас уже есть ISO-файлы в локальном хранилище данных, можно выбрать файлы и **скопировать их** в, чтобы скопировать их в хранилище данных Data Box NFS.


## <a name="prepare-data-box-for-return"></a>Подготовка Data Box к возврату

После того как все данные виртуальной машины, данные шаблона виртуальной машины и все ISO-файлы копируются в хранилище данных Data Box NFS, можно отключить хранилище данных от vCenter. Прежде чем отключать хранилище данных, необходимо удалить все виртуальные машины и шаблоны виртуальных машин из инвентаризации.

### <a name="remove-objects-from-inventory"></a>Удаление объектов из инвентаризации

1. В локальном веб-ИНТЕРФЕЙСе vCenter перейдите в раздел **хранилище**. Выберите **датабокс — хранилище данных** , а затем выберите **виртуальные машины**.

    ![Удаление виртуальных машин из инвентаризации-отключено](media/databox-migration-select-databox-vm.png)

2. Убедитесь, что все виртуальные машины выключены.

3. Выберите все виртуальные машины, щелкните правой кнопкой мыши и выберите **удалить из запасов**.

    ![Удаление виртуальных машин из инвентаризации](media/databox-migration-remove-vm-from-inventory.png)

4. Выберите **шаблоны виртуальных машин в папках** и повторите шаг 3.

### <a name="remove-the-data-box-nfs-datastore-from-vcenter"></a>Удаление хранилища данных Data Box NFS из vCenter

Перед началом подготовки к возврату хранилище данных Data Box NFS должно быть отключено от узлов VMware ESXi.

1. В локальном веб-ИНТЕРФЕЙСе vCenter перейдите в раздел **хранилище**.

2. Щелкните правой кнопкой мыши **датабокс-DataStore** и выберите **Отключить хранилище данных**.

    ![Отключение хранилища данных Data Box](media/databox-migration-unmount-datastore.png)

3. Выберите все узлы ESXi, на которых подключено хранилище данных, и нажмите кнопку **ОК**.

    ![Отключение Data Box хранилища данных — выбор узлов](media/databox-migration-unmount-datastore-select-hosts.png)

4. Проверьте и примите все предупреждения и нажмите кнопку **ОК**.

### <a name="prepare-data-box-for-return-and-then-return-it"></a>Подготовка Data Box к возврату и возврат

Выполните действия, описанные в статье [возврат Azure Data Box и проверьте передачу данных в Azure](../databox/data-box-deploy-picked-up.md) , чтобы получить Data Box. Проверьте состояние копии данных в учетной записи хранения Azure. После того как состояние отобразится как завершенное, можно проверить данные в учетной записи хранения Azure.

## <a name="copy-data-from-azure-storage-to-azure-vmware-solution"></a>Копирование данных из службы хранилища Azure в решение VMware для Azure

Данные, скопированные на устройство Data Box, будут доступны в учетной записи хранения Azure после того, как состояние заказа Data Box будет показано как завершенное. Теперь данные можно скопировать в решение Azure VMware. Данные в учетной записи хранения должны быть скопированы в хранилище данных vSAN частного облака с помощью протокола NFS. 

Сначала скопируйте данные хранилища BLOB-объектов на управляемый диск в виртуальной машине Linux в Azure с помощью **AzCopy**. Сделайте управляемый диск доступным через NFS, подключите общий ресурс NFS в качестве хранилища данных в частном облаке, а затем скопируйте данные. Этот метод позволяет ускорить копирование данных в частное облако.

### <a name="copy-data-to-your-private-cloud-using-a-linux-virtual-machine-and-managed-disks-and-then-export-as-nfs-share"></a>Копирование данных в частное облако с помощью виртуальной машины Linux и управляемых дисков, а затем Экспорт в качестве общего ресурса NFS

1. Создайте [виртуальную машину Linux](../virtual-machines/linux/quick-create-portal.md) в Azure в том же регионе, где создана Ваша учетная запись хранения, и подключение к частному облаку с помощью виртуальной сети Azure.

2. Создайте управляемый диск, емкость которого больше, чем объем данных BLOB-объекта, и [подключите ее к виртуальной машине Linux](../virtual-machines/linux/attach-disk-portal.md).  Если объем данных большого двоичного объекта превышает емкость максимально доступного управляемого диска, данные необходимо скопировать в несколько шагов или с помощью нескольких управляемых дисков.

3. Подключитесь к виртуальной машине Linux и подключите управляемый диск.

4. Установите [AzCopy на виртуальной машине Linux](../storage/common/storage-use-azcopy-v10.md).

5. Скачайте данные из хранилища BLOB-объектов Azure на управляемый диск с помощью AzCopy.  Синтаксис команды: `azcopy copy "https://<storage-account-name>.blob.core.windows.net/<container-name>/*" "<local-directory-path>/"` .  Замените `<storage-account-name>` именем учетной записи хранения Azure и `<container-name>` контейнером, который содержит данные, скопированные с помощью Data Box.

6. Установите NFS Server на виртуальной машине Linux:

    - В дистрибутиве Ubuntu/Debian: `sudo apt install nfs-kernel-server` .
    - В дистрибутиве Enterprise Linux: `sudo yum install nfs-utils` .

7. Измените разрешения папки на управляемом диске, куда были скопированы данные из хранилища BLOB-объектов Azure.  Измените разрешения для всех папок, которые требуется экспортировать в общую папку NFS.

    ```bash
    chmod -R 755 /<folder>/<subfolder>
    chown nfsnobody:nfsnobody /<folder>/<subfolder>
    ```

8. Назначьте разрешения для IP-адресов клиента для доступа к общему ресурсу NFS, отредактировав `/etc/exports` файл.

    ```bash
    sudo vi /etc/exports
    ```
    
    Введите следующие строки в файл для каждого IP-адреса узла ESXi частного облака.  Если вы создаете общие папки для нескольких папок, добавьте все папки.

    ```bash
    /<folder>/<subfolder> <ESXiNode1IP>(rw,sync,no_root_squash,no_subtree_check)
    /<folder>/<subfolder> <ESXiNode2IP>(rw,sync,no_root_squash,no_subtree_check)
    .
    .
    ```

9. Экспортируйте общие папки NFS с помощью `sudo exportfs -a` команды.

10. Перезапустите сервер ядра NFS с помощью `sudo systemctl restart nfs-kernel-server` команды.


### <a name="mount-the-linux-virtual-machine-nfs-share-as-a-datastore-on-a-private-cloud-vcenter-cluster-and-then-copy-data"></a>Подключите общий ресурс NFS виртуальной машины Linux в качестве хранилища данных в кластере vCenter с частным облаком, а затем скопируйте данные.

Общая папка NFS из виртуальной машины Linux должна быть подключена в качестве хранилища данных в кластере vCenter с частным облаком. После подключения данные можно скопировать из хранилища данных NFS в хранилище данных частного облака vSAN.

1. Войдите на свой частный облачный сервер vCenter.

2. Щелкните правой кнопкой мыши **центр обработки**данных, выберите **хранилище**, выберите пункт **создать хранилище данных**, а затем нажмите кнопку **Далее**.

   ![Добавить новое хранилище данных](media/databox-migration-add-datastore.png)

3. На шаге 1 мастера добавления хранилища данных выберите тип **NFS** .

   ![Добавить новое хранилище данных-тип](media/databox-migration-add-datastore-type.png)

4. На шаге 2 мастера выберите **NFS 3** в качестве версии NFS, а затем нажмите кнопку **Далее**.

   ![Добавление нового хранилища данных — версия NFS](media/databox-migration-add-datastore-nfs-version.png)

5. На шаге 3 мастера укажите имя хранилища данных, путь и сервер.  Для сервера можно использовать IP-адрес виртуальной машины Linux.  Путь к папке будет иметь `/<folder>/<subfolder>/` Формат.

   ![Добавление нового хранилища данных — конфигурация NFS](media/databox-migration-add-datastore-nfs-configuration.png)

6. На шаге 4 мастера выберите узлы ESXi, в которых необходимо подключить хранилище данных, а затем нажмите кнопку **Далее**.  В кластере выберите все узлы, чтобы обеспечить миграцию виртуальных машин.

   ![Добавление нового хранилища данных — выбор узлов](media/databox-migration-add-datastore-nfs-select-hosts.png)

7. На шаге 5 мастера просмотрите сводку и нажмите кнопку **Готово**.

### <a name="add-virtual-machines-and-virtual-machine-templates-from-an-nfs-datastore-to-the-inventory"></a>Добавление виртуальных машин и шаблонов виртуальных машин из хранилища данных NFS в опись

1. Из веб-интерфейса частного облака vCenter перейдите в раздел **хранилище**.  Выберите хранилище данных NFS виртуальной машины Linux, а затем выберите **файлы**.

    ![Выбор файлов из хранилища данных NFS](media/databox-migration-datastore-select-files.png)

2. Выберите папку, содержащую виртуальную машину или шаблон виртуальной машины.  В области сведений выберите vmx-файл для виртуальной машины или vmtx-файл для шаблона виртуальной машины.

3. Выберите **зарегистрировать** виртуальную машину для регистрации виртуальной машины в частном облаке vCenter.

    ![Зарегистрировать виртуальную машину](media/databox-migration-datastore-register-vm.png)

4. Выберите центр обработки данных, папку, кластер или пул ресурсов, в которых требуется зарегистрировать виртуальную машину.

4. Повторите шаги 3 и 4 для всех виртуальных машин и шаблонов виртуальных машин.

5. Перейдите в папку, содержащую ISO-файлы.  Выберите ISO-файлы, а затем нажмите кнопку **Копировать в** , чтобы скопировать файлы в папку в хранилище данных vSAN.

Виртуальные машины и шаблоны виртуальных машин теперь доступны в частном облаке vCenter. Перед включением эти виртуальные машины необходимо переместить из хранилища данных NFS в хранилище данных vSAN. Можно использовать параметр **Storage VMotion** и выбрать хранилище данных vSAN в качестве целевого объекта для виртуальных машин.

Шаблоны виртуальных машин должны быть клонированы из хранилища данных NFS виртуальной машины Linux в хранилище данных vSAN.

### <a name="clean-up-your-linux-virtual-machine"></a>Очистка виртуальной машины Linux

После копирования всех данных в частное облако можно удалить хранилище данных NFS из частного облака.

1. Убедитесь, что все виртуальные машины и шаблоны перемещены и клонированы в хранилище данных vSAN.

2. Удалить из инвентаризации все шаблоны виртуальных машин из хранилища данных NFS.

3. Отключите хранилище данных виртуальной машины Linux от вашего частного облака vCenter.

4. Удалите виртуальную машину и управляемый диск из Azure.

5. Если вы не хотите хранить данные, которые были переданы Data Box в учетной записи хранения, удалите учетную запись хранения Azure.  
    


## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [Data Box](../databox/data-box-overview.md).
* Узнайте больше о различных вариантах [переноса рабочих нагрузок в частное облако](migrate-workloads.md).
