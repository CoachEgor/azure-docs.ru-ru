---
title: Решение Azure VMware - миграция с помощью коробки данных Azure
description: Как использовать пазовые данные для массового переноса данных в решение Azure VMware.
author: sharaths-cs
ms.author: dikamath
ms.date: 09/27/2019
ms.topic: article
ms.service: azure-vmware-cloudsimple
ms.reviewer: cynthn
manager: dikamath
ms.openlocfilehash: 65167169248d83ebfec2c49c308673ec9315934e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77019763"
---
# <a name="migrating-data-to-azure-vmware-solution-by-using-azure-data-box"></a>Миграция данных в решение Azure VMware с помощью ящика данных Azure

Облачное решение Microsoft Azure Data Box позволяет отправлять терабайты (TBs) данных в Azure быстрым, недорогим и надежным способом. Защищенное устройство хранения Azure Data Box обеспечивает безопасную передачу данных. Каждое устройство хранения данных имеет максимальную допустимую емкость хранения 80 ТБ и транспортируется в ваш центр обработки данных региональным перевозчиком. Прочный корпус защищает устройство и хранящиеся на нем ваши данные во время передачи.

С помощью Data Box можно мигрировать данные VMware в частное облако. Данные из вашей предварительной среды VMware vSphere копируются в Data Box через протокол сетевой файловой системы (NFS). Массовая миграция данных предполагает сохранение своевременной копии виртуальных машин, конфигурации и связанных с ними данных в Data Box, а затем вручную отправку в Azure.

В этой статье вы узнаете о:

* Настройка коробки данных.
* Копирование данных из среды vMware в поле данных через NFS.
* Подготовка к возвращению коробки данных.
* Подготовка данных о blob для копирования в решение Azure VMware.
* Копирование данных из Azure в частное облако.

## <a name="scenarios"></a>Сценарии

Используйте box data в следующих сценариях для массовой миграции данных:

* Перенести большой объем данных из находиныты в решение Azure VMware. Этот метод устанавливает базовый уклад и синхронизирует различия по сети.
* Перенести большое количество виртуальных машин, которые выключены (холодные виртуальные машины).
* Перенос виртуальных машинных данных для создания сред разработки и тестирования.
* Перенести большое количество виртуальных шаблонов машин, файлов ISO и виртуальных машинных дисков.

## <a name="before-you-begin"></a>Перед началом

* Проверьте предпосылки и [закажите Data Box](../databox/data-box-deploy-ordered.md) через портал Azure. В процессе заказа необходимо выбрать учетную запись хранения, которая позволяет хранить Blob. После получения устройства Data Box подключите его к своей сети и [навяжете устройство](../databox/data-box-deploy-set-up.md) с IP-адресом, который можно получить из вашей сети управления vSphere.

* Создайте виртуальную сеть и учетную запись хранилища в том же регионе, где готовится ваше решение Azure VMware.

* Создайте [виртуальное сетевое соединение Azure](cloudsimple-azure-network-connection.md) из частного облака в виртуальную сеть, где создается учетная запись хранилища, следуя шагам в [виртуальной сети Connect Azure в CloudSimple с помощью ExpressRoute.](virtual-network-connection.md)

## <a name="set-up-data-box-for-nfs"></a>Настройка коробки данных для NFS

Подключитесь к локальному веб-пользователю Data Box, выяснив следующие действия в разделе учебника «Подключение к устройству»: [Кабель и подключитесь к вашему ящику данных Azure.](../databox/data-box-deploy-set-up.md)  Налажить box данных, чтобы обеспечить доступ к клиентам NFS:

1. В локальном веб-пользователи перейдите на страницу **Connect и скопируйте** его. В **настройках NFS**выберите **доступ к клиенту NFS.** 

    ![Настройка клиентского доступа NFS 1](media/nfs-client-access.png)

2. Введите IP-адрес хостов VMware ESXi и выберите **Добавить**. Вы можете настроить доступ для всех узлов в кластере vSphere, повторив этот шаг. Нажмите кнопку **ОК**.

    ![Настройка клиентского доступа NFS 2](media/nfs-client-access2.png)
> [!IMPORTANT]
> **Всегда создавайте отдельную папку для файлов, которые вы собираетесь скопировать в общую папку**. Папка, созданная в общих папках блочных и страничных BLOB-объектов, представляет собой контейнер, куда передаются данные в виде больших двоичных объектов. Нельзя копировать файлы непосредственно в *корневую* папку в учетной записи хранилища.

В общих папках для блочных и страничных BLOB-объектов объектами первого уровня являются контейнеры, а второго — большие двоичные объекты. Под долями для Azure Files — объекты первого уровня — это акции, а сущности второго уровня — файлы.

В следующей таблице приведен UNC-путь к общим папкам в Data Box и URL-адрес службы хранилища Azure, куда отправляются данные. Конечный URL-адрес службы хранилища Azure может быть производным от UNC-пути к общей папке.
 
|                   |                                                            |
|-------------------|--------------------------------------------------------------------------------|
| Блочные BLOB-объекты Azure | <li>UNC-путь к общим папкам: `//<DeviceIPAddress>/<StorageAccountName_BlockBlob>/<ContainerName>/files/a.txt`</li><li>URL-адрес службы хранилища Azure: `https://<StorageAccountName>.blob.core.windows.net/<ContainerName>/files/a.txt`</li> |  
| Страничные BLOB-объекты Azure  | <li>UNC-путь к общим папкам: `//<DeviceIPAddres>/<StorageAccountName_PageBlob>/<ContainerName>/files/a.txt`</li><li>URL-адрес службы хранилища Azure: `https://<StorageAccountName>.blob.core.windows.net/<ContainerName>/files/a.txt`</li>   |  
| Файлы Azure       |<li>UNC-путь к общим папкам: `//<DeviceIPAddres>/<StorageAccountName_AzFile>/<ShareName>/files/a.txt`</li><li>URL-адрес службы хранилища Azure: `https://<StorageAccountName>.file.core.windows.net/<ShareName>/files/a.txt`</li>        |

> [!NOTE]
> Используйте капли Azure Block для копирования данных VMware.

## <a name="mount-the-nfs-share-as-a-datastore-on-your-on-premises-vcenter-cluster-and-copy-the-data"></a>Смонтируйте долю NFS в качестве хранилища данных в вашем кластере vCenter и копируйте данные

Доля NFS из вашего ящика данных должна быть установлена в качестве хранилища данных в вашем предварительном кластере vCenter или vMware ESXi хосте, чтобы скопировать данные в хранилище данных NFS:

1. Войдите на свой сервер vCenter.

2. Правый **щелчком центра обработки данных,** выберите **Хранилище,** выберите **новый магазин данных,** а затем выберите **Следующий.**

   ![Добавление нового хранилища данных](media/databox-migration-add-datastore.png)

3. В шаге 1 мастера Хранилища данных выберите **NFS** под **типом.**

   ![Добавление нового хранилища данных - тип](media/databox-migration-add-datastore-type.png)

4. В шаге 2 мастера выберите **NFS 3** в качестве версии NFS, а затем выберите **Следующий.**

   ![Добавление нового хранилища данных - версия NFS](media/databox-migration-add-datastore-nfs-version.png)

5. В шаге 3 мастера укажите имя хранилища данных, путь и сервер. Для сервера можно использовать IP-адрес коробки данных. Путь папки будет `/<StorageAccountName_BlockBlob>/<ContainerName>/` в формате.

   ![Добавление нового хранилища данных - конфигурация NFS](media/databox-migration-add-datastore-nfs-configuration.png)

6. В шаге 4 мастера выберите хосты ESXi, где вы хотите, чтобы хранилище данных было установлено, а затем выберите **Следующий.**  В кластере выберите все узлы для обеспечения миграции виртуальных машин.

   ![Добавление нового хранилища данных - Выберите хосты](media/databox-migration-add-datastore-nfs-select-hosts.png)

7. В шаге 5 мастера просмотрите резюме и выберите **Finish.**

## <a name="copy-data-to-the-data-box-nfs-datastore"></a>Копирование данных в хранилище данных Box NFS

Виртуальные машины могут быть перенесены или клонированы в новый магазин данных.  Любые неиспользованные виртуальные машины, которые вы хотите перенести, могут быть перенесены в хранилище данных Box NFS с помощью опции **хранения vMotion.** Активные виртуальные машины могут быть клонированы в хранилище данных Box NFS.

* Определите и перечислите виртуальные машины, которые могут быть **перемещены.**
* Определите и перечислите виртуальные машины, которые должны быть **клонированы.**

### <a name="move-a-virtual-machine-to-a-data-box-datastore"></a>Переместите виртуальную машину в хранилище данных

1. Нажмите правой кнопкой мыши виртуальную машину, которую вы хотите переместить в хранилище данных Box, а затем выберите **Migrate.**

    ![Мигрировать виртуальная машина](media/databox-migration-vm-migrate.png)

2. Выберите **хранилище изменений только** для типа миграции, а затем выберите **Следующий**.

    ![Мигрировать виртуальная машина - хранение только](media/databox-migration-vm-migrate-change-storage.png)

3. Выберите **Databox-Datastore** в качестве пункта назначения, а затем выберите **Следующий**.

    ![Мигрировать виртуальная машина - выберите хранилище данных](media/databox-migration-vm-migrate-change-storage-select-datastore.png)

4. Просмотрите информацию и выберите **Finish**.

5. Повторите шаги с 1 по 4 для дополнительных виртуальных машин.

> [!TIP]
> Можно выбрать несколько виртуальных машин, которые находятся в одном и том же состоянии питания (включены или выключены) и перенести их оптом.

Виртуальная машина будет перенесена в хранилище данных NFS из Data Box. После того, как все виртуальные машины будут перенесены, вы можете отключить (выключить) активные виртуальные машины в рамках подготовки к переносу данных в Решение Azure VMware.

### <a name="clone-a-virtual-machine-or-a-virtual-machine-template-to-the-data-box-datastore"></a>Клон виртуальной машины или виртуального шаблона машины в хранилище данных Data Box

1. Нажмите правой кнопкой виртуальной машины или виртуального шаблона машины, который вы хотите клонировать. Выберите клон **клона** > **для виртуальной машины.**

    ![Виртуальный клон машины](media/databox-migration-vm-clone.png)

2. Выберите имя для клонированной виртуальной машины или шаблон виртуальной машины.

3. Выберите папку, где вы хотите поместить клонированный объект, а затем выберите **Следующий.**

4. Выберите кластер или пул ресурсов, где требуется поместить клонированный объект, а затем выберите **Следующий.**

5. Выберите **Databox-Datastore** в качестве места хранения, а затем выберите **Следующий.**

    ![Клон виртуальной машины - выберите хранилище данных](media/databox-migration-vm-clone-select-datastore.png)

6. Если вы хотите настроить любые параметры для клонированного объекта, выберите параметры настройки, а затем выберите **Следующий.**

7. Просмотрите конфигурации и выберите **Finish**.

8. Повторите шаги от 1 до 7 для дополнительных виртуальных машин или виртуальных шаблонов машин.

Виртуальные машины будут клонированы и хранятся в хранилище данных NFS из Data Box. После клонирования виртуальных машин убедитесь, что они закрыты в рамках подготовки к переносу данных в решение Azure VMware.

### <a name="copy-iso-files-to-the-data-box-datastore"></a>Копирование файлов ISO в хранилище данных Data Box

1. С вашего на-предпосылки vCenter веб-uI, перейдите на **хранение**.  Выберите **Databox-Datastore,** а затем выберите **файлы.** Создайте новую папку для хранения файлов ISO.

    ![Копировать ISO - создать новую папку](media/databox-migration-create-folder.png)

2. Укажите имя для папки, в которой будут храниться файлы ISO.

3. Чтобы открыть ее, дважды щелкните недавно созданную папку.

4. Выберите **загружать файлы,** а затем выберите файлы ISO, которые вы хотите загрузить.
    
    ![Копия ISO - загрузить файлы](media/databox-migration-upload-iso.png)

> [!TIP]
> Если у вас уже есть файлы ISO в магазине данных, вы можете выбрать файлы и **скопировать** для копирования файлов в хранилище данных Data Box NFS.


## <a name="prepare-data-box-for-return"></a>Подготовка коробки данных к возврату

После того, как все виртуальные данные машины, данные виртуального шаблона машины, и любые файлы ISO копируются в хранилище данных Box NFS, вы можете отключить хранилище данных от вашего vCenter. Все виртуальные машины и шаблоны виртуальных машин должны быть удалены из инвентаря перед отключением хранилища данных.

### <a name="remove-objects-from-inventory"></a>Удаление объектов из инвентаря

1. С вашего на-предпосылки vCenter веб-uI, перейдите на **хранение**. Выберите **Databox-Datastore,** а затем выберите **VMs.**

    ![Удалить виртуальные машины из инвентаря - выключите](media/databox-migration-select-databox-vm.png)

2. Убедитесь, что все виртуальные машины выключены.

3. Выберите все виртуальные машины, нажмите правой кнопкой мыши, а затем выберите **Удалить из инвентаря.**

    ![Удалить виртуальные машины из инвентаря](media/databox-migration-remove-vm-from-inventory.png)

4. Выберите **шаблоны VM в Фолдестерах,** а затем повторите шаг 3.

### <a name="remove-the-data-box-nfs-datastore-from-vcenter"></a>Удалите хранилище данных NFS из vCenter

Перед подготовкой к возврату хранилище данных Data Box NFS должно быть отключено от хостов VMware ESXi.

1. С вашего на-предпосылки vCenter веб-uI, перейдите на **хранение**.

2. Правый щелчок **Databox-Datastore** и выберите **Unmount Datastore.**

    ![Немонтажный хранилище данных](media/databox-migration-unmount-datastore.png)

3. Выберите все хосты ESXi, где установлен хранилище данных, и выберите **OK.**

    ![Unmount Data Box datastore - выберите хосты](media/databox-migration-unmount-datastore-select-hosts.png)

4. Просмотрите и примите любые предупреждения и выберите **OK.**

### <a name="prepare-data-box-for-return-and-then-return-it"></a>Подготовьте коробку данных для возврата, а затем верните его

Выполните действия, изложенные в статье [Return Azure Data Box, и проверьте загрузку данных в Azure,](../databox/data-box-deploy-picked-up.md) чтобы вернуть коробку данных. Проверьте состояние копии данных в учетной записи хранения данных Azure. После того, как состояние отображается как завершенное, вы можете проверить данные в учетной записи хранения Azure.

## <a name="copy-data-from-azure-storage-to-azure-vmware-solution"></a>Копирование данных из хранилища Azure в решение Azure VMware

Данные, скопированные на устройство Box, будут доступны в вашей учетной записи хранения Azure после того, как состояние заказа вашего Box отображает как завершенное. Теперь данные можно скопировать в решение Azure VMware. Данные в учетной записи хранилища должны быть скопированы в хранилище данных vSAN вашего частного облака с помощью протокола NFS. 

Во-первых, скопируйте данные памяти Blob на управляемый диск на виртуальной машине Linux в Azure с помощью **AzCopy.** Сделайте управляемый диск доступным через NFS, установите долю NFS в качестве хранилища данных в вашем частном облаке, а затем скопируйте данные. Этот метод позволяет быстрее копировать данные в ваше личное облако.

### <a name="copy-data-to-your-private-cloud-using-a-linux-virtual-machine-and-managed-disks-and-then-export-as-nfs-share"></a>Копирование данных в частное облако с помощью виртуальной машины Linux и управляемых дисков, а затем экспортировать как долю NFS

1. Создайте [виртуальную машину Linux](../virtual-machines/linux/quick-create-portal.md) в Azure в том же регионе, где создается учетная запись хранения и имеет виртуальное сетевое подключение Azure к частному облаку.

2. Создайте управляемый диск, емкость хранилища которого превышает объем данных капли, и [прикрепите его к виртуальной машине Linux.](../virtual-machines/linux/attach-disk-portal.md)  Если объем данных blob превышает емкость крупнейшего управляемого диска, данные должны быть скопированы в несколько шагов или с помощью нескольких управляемых дисков.

3. Подключитесь к виртуальной машине Linux и установите управляемый диск.

4. Установите [AzCopy на виртуальную машину Linux.](../storage/common/storage-use-azcopy-v10.md)

5. Загрузите данные из хранилища Azure Blob на управляемый диск с помощью AzCopy.  Командный синтаксис: `azcopy copy "https://<storage-account-name>.blob.core.windows.net/<container-name>/*" "<local-directory-path>/"`.  Замените `<storage-account-name>` имя учетной записи хранилища Azure и `<container-name>` контейнер, вмещаевщем данные, скопированные через Data Box.

6. Установите сервер NFS на виртуальную машину Linux:

    - О распределении Ubuntu/Debian: `sudo apt install nfs-kernel-server`.
    - О дистрибутиве Корпоративного Linux: `sudo yum install nfs-utils`.

7. Измените разрешение папки на управляемом диске, где копировались данные из хранилища Azure Blob.  Измените разрешения для всех папок, которые вы хотите экспортировать в качестве общей акции NFS.

    ```bash
    chmod -R 755 /<folder>/<subfolder>
    chown nfsnobody:nfsnobody /<folder>/<subfolder>
    ```

8. Назначайте разрешения на IP-адреса клиента для `/etc/exports` доступа к совместной работе NFS путем редактирования файла.

    ```bash
    sudo vi /etc/exports
    ```
    
    Введите следующие строки в файле для каждого IP-адреса ESXi вашего частного облака.  Если вы создаете акции для нескольких папок, добавьте все папки.

    ```bash
    /<folder>/<subfolder> <ESXiNode1IP>(rw,sync,no_root_squash,no_subtree_check)
    /<folder>/<subfolder> <ESXiNode2IP>(rw,sync,no_root_squash,no_subtree_check)
    .
    .
    ```

9. Экспорт акций NFS `sudo exportfs -a` с помощью команды.

10. Перезапустите сервер ядра NFS с помощью `sudo systemctl restart nfs-kernel-server` команды.


### <a name="mount-the-linux-virtual-machine-nfs-share-as-a-datastore-on-a-private-cloud-vcenter-cluster-and-then-copy-data"></a>Маунт Linux виртуальная машина NFS доля в качестве хранилища данных на частном кластере облако vCenter, а затем копировать данные

Доля NFS с виртуальной машины Linux должна быть установлена в качестве хранилища данных в вашем частном кластере cloud vCenter. После его установки данные можно скопировать из хранилища данных NFS в частный облачный магазин данных vSAN.

1. Войти на свой частный облачный сервер vCenter.

2. Правый **щелчком центра обработки данных,** выберите **Хранилище,** выберите **новый магазин данных,** а затем выберите **Следующий.**

   ![Добавление нового хранилища данных](media/databox-migration-add-datastore.png)

3. В шаге 1 мастера Хранилища данных выберите тип **NFS.**

   ![Добавление нового хранилища данных - тип](media/databox-migration-add-datastore-type.png)

4. В шаге 2 мастера выберите **NFS 3** в качестве версии NFS, а затем выберите **Следующий.**

   ![Добавление нового хранилища данных - версия NFS](media/databox-migration-add-datastore-nfs-version.png)

5. В шаге 3 мастера укажите имя хранилища данных, путь и сервер.  Вы можете использовать IP-адрес вашей виртуальной машины Linux для сервера.  Путь папки будет `/<folder>/<subfolder>/` в формате.

   ![Добавление нового хранилища данных - конфигурация NFS](media/databox-migration-add-datastore-nfs-configuration.png)

6. В шаге 4 мастера выберите хосты ESXi, где вы хотите, чтобы хранилище данных было установлено, а затем выберите **Следующий.**  В кластере выберите все узлы для обеспечения миграции виртуальных машин.

   ![Добавление нового хранилища данных - Выберите хосты](media/databox-migration-add-datastore-nfs-select-hosts.png)

7. В шаге 5 мастера просмотрите резюме, а затем выберите **Finish.**

### <a name="add-virtual-machines-and-virtual-machine-templates-from-an-nfs-datastore-to-the-inventory"></a>Добавление виртуальных машин и виртуальных шаблонов машин из хранилища данных NFS в инвентарь

1. С вашего частного облака vCenter веб-uI, перейдите к **хранению**.  Выберите виртуальную машину Linux NFS datastore, а затем выберите **Файлы.**

    ![Выберите файлы из хранилища данных NFS](media/databox-migration-datastore-select-files.png)

2. Выберите папку, содержащую виртуальную машину или виртуальный шаблон машины.  В деталях панели, выберите файл .vmx для виртуальной машины или файл .vmtx для виртуального шаблона машины.

3. Выберите **Регистрация VM** для регистрации виртуальной машины на вашем частном облачном vCenter.

    ![Регистрация виртуальной машины](media/databox-migration-datastore-register-vm.png)

4. Выберите центр обработки данных, папку и пул кластера/ресурсов, где требуется регистрация виртуальной машины.

4. Повторите шаги 3 и 4 для всех виртуальных машин и виртуальных шаблонов машин.

5. Перейдите в папку, содержащую файлы ISO.  Выберите файлы ISO, а затем выберите **Copy, чтобы** скопировать файлы в папку в хранилище данных vSAN.

Виртуальные машины и шаблоны виртуальных машин теперь доступны на вашем частном облачном vCenter. Эти виртуальные машины должны быть перемещены из хранилища данных NFS в хранилище данных vSAN, прежде чем включить их. Вы можете использовать опцию **хранения vMotion** и выбрать хранилище данных vSAN в качестве мишени для виртуальных машин.

Шаблоны виртуальной машины должны быть клонированы из виртуальной машины Linux NFS Datastore в ваш магазин данных vSAN.

### <a name="clean-up-your-linux-virtual-machine"></a>Очистка виртуальной машины Linux

После того, как все данные будут скопированы в ваше личное облако, вы можете удалить хранилище данных NFS из вашего частного облака:

1. Убедитесь, что все виртуальные машины и шаблоны перемещены и клонированы в ваш магазин данных vSAN.

2. Удалите из инвентаря все шаблоны виртуальных машин из хранилища данных NFS.

3. Открепите магазин данных виртуальной машины Linux из вашего частного облачного vCenter.

4. Удалите виртуальную машину и управляемый диск из Azure.

5. Если вы не хотите хранить данные, которые были переданы Box, в учетной записи хранения данных, удалите учетную запись хранения Azure.  
    


## <a name="next-steps"></a>Дальнейшие действия

* Подробнее о [коробке данных](../databox/data-box-overview.md).
* Узнайте больше о различных [вариантах переноса рабочих нагрузок в частное облако.](migrate-workloads.md)
