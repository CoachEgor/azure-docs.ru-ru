---
title: Горизонтальное масштабирование служб Azure Analysis Services | Документация Майкрософт
description: Повторите серверы аналитических служб Azure с масштабированием. Затем запросы клиентов могут быть распределены между несколькими репликами запросов в пуле запросов.
author: minewiskan
ms.service: azure-analysis-services
ms.topic: conceptual
ms.date: 03/02/2020
ms.author: owend
ms.reviewer: minewiskan
ms.openlocfilehash: 3ea304d038618fc428f20e7ad72b398f593d09a8
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78247993"
---
# <a name="azure-analysis-services-scale-out"></a>Горизонтальное масштабирование служб Azure Analysis Services

При масштабе клиентские запросы могут быть распределены между *несколькими репликами запросов* в *пуле запросов,* сокращая время отклика во время больших рабочих нагрузок запроса. Операции обработки могут выполняться отдельно от пула запросов, чтобы эти операции не оказывали отрицательного влияния на клиентские запросы. Горизонтальное масштабирование можно настроить на портале Azure или с помощью REST API служб Analysis Services.

Горизонтальное масштабирование доступно для серверов в ценовой категории "Стандартный". Каждая реплика запросов оплачивается по той же ставке, что и сервер. Все реплики запроса создаются в том же регионе, что и сервер. Число реплик запросов, которые вы можете настроить, ограничено регионом, в котором находится ваш сервер. Дополнительные сведения см. в разделе [Доступность по регионам](analysis-services-overview.md#availability-by-region). Горизонтальное масштабирование не увеличивает объем доступной памяти сервера. Чтобы увеличить объем памяти, необходимо изменить план. 

## <a name="why-scale-out"></a>Зачем масштабировать?

В обычном развертывании сервера один сервер выступает в роли сервера обработки и сервера запросов. Если количество клиентских запросов к моделям на сервере превышает число единиц обработки запросов (QPU) в плане сервера или обработка модели производится во время выполнения рабочей нагрузки с большим числом запросов, это может привести к снижению производительности. 

При масштабе масштабирования можно создать пул запросов с до семи дополнительными ресурсами реплики запросов (всего восемь, включая *основной* сервер). Можно масштабировать количество реплик в пуле запросов, чтобы соответствовать требованиям к ЗПу в критические моменты, и можно в любое время отделить процессуационный сервер от пула запросов. 

Независимо от числа реплик запросов, имеющихся в пуле запросов, обработка рабочих нагрузок не распределяется между репликами запросов. Основной сервер выполняет функции процессорного сервера. Реплики запросов обслуживают только запросы против баз данных моделей, синхронизированных между основным сервером и каждой репликой в пуле запросов. 

При масштабировании может пройти до пяти минут, чтобы новые реплики запроса были постепенно добавлены в пул запросов. Когда все новые реплики запросов запущены и запущены, новые клиентские соединения загружаются сбалансированными между ресурсами в пуле запросов. Имеющиеся клиентские подключения останутся в пуле, к которому они в настоящее время подключены. При свертывании любые имеющиеся клиентские подключения к ресурсу пула запросов, которые удаляются из пула, завершаются. Клиенты могут повторно подключиться к оставшемуся ресурсу пула запросов.

## <a name="how-it-works"></a>Принцип работы

При настройке масштабирования в первый раз базы данных моделей на основном сервере *автоматически* синхронизируются с новыми репликами в новом пуле запросов. Автоматическая синхронизация происходит только один раз. Во время автоматической синхронизации файлы данных основного сервера (зашифрованные в состоянии покоя в хранилище кабы) копируются во вторую локацию, а также шифруются в состоянии покоя в хранилище кабл. Реплики в пуле запросов *затем увлажняются* данными из второго набора файлов. 

В то время как автоматическая синхронизация выполняется только при первом масштабировании сервера, можно также выполнить ручную синхронизацию. Синхронизация гарантирует, что данные о репликах в пуле запросов совпадают с данными основного сервера. При обработке (обновлении) моделей на основном сервере после завершения операций по *обработке* необходимо выполнить синхронизацию. Эта синхронизация копирует обновленные данные из файлов первичного сервера в хранилище кабы на второй набор файлов. Реплики в пуле запросов затем увлажняются с обновленными данными из второго набора файлов в хранилище кабл. 

При выполнении последующей операции масштабирования, например, увеличивая количество реплик в пуле запросов с двух до пяти, новые реплики увлажняются данными из второго набора файлов в хранилище кабл. Синхронизации нет. Если вы затем выполните синхронизацию после масштабирования, новые реплики в пуле запросов будут увлажнены дважды - избыточное увлажнение. При выполнении последующей операции масштабирования важно иметь в виду:

* Выполните синхронизацию *перед масштабной операцией,* чтобы избежать избыточной гидратации добавленных реплик. Не допускаются параллельные операции синхронизации и масштабирования, проводимые одновременно.

* При автоматизации как обработки, так *и* масштабирования операций важно сначала обрабатывать данные на основном сервере, затем выполнять синхронизацию, а затем выполнять операцию масштабирования. Эта последовательность обеспечивает минимальное влияние на ресурсы ЗПУ и памяти.

* Синхронизация допускается даже при отсутствии реплик в пуле запросов. Если вы масштабируете от нуля до одной или нескольких реплик с новыми данными из операции обработки на основном сервере, выполните синхронизацию сначала без реплик в пуле запросов, а затем масштабируйте. Синхронизация перед масштабированием позволяет избежать избыточной гидратации недавно добавленных реплик.

* При удалении базы данных модели с основного сервера она автоматически не удаляется из реплик в пуле запросов. Вы должны выполнить операцию синхронизации с помощью команды [Sync-AzAnalysisServicesInstance](https://docs.microsoft.com/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance) PowerShell, которая удаляет файл/с для этой базы данных из общего местоположения хранилища капли, а затем удаляет базу данных модели на репликах в пуле запросов. Чтобы определить, существует ли база данных моделей на репликах в пуле запросов, но не на основном сервере, убедитесь, что **отделять сервер обработки от настройки пула запросов** до **Yes**. Затем используйте SSMS для подключения `:rw` к основному серверу с помощью квалификатора, чтобы увидеть, существует ли база данных. Затем подключитесь к репликам в пуле запросов, подключившись без `:rw` квалификатора, чтобы увидеть, существует ли та же база данных. Если база данных существует на репликах в пуле запросов, но не на основном сервере, запустите операцию синхронизации.   

* При переименовании базы данных на основном сервере необходимо провести дополнительный шаг, чтобы обеспечить надлежащую синхронизацию базы данных с любыми репликами. После переименования выполняйте синхронизацию с помощью команды [Sync-AzAnalysisServicesInstance,](https://docs.microsoft.com/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance) определяющей `-Database` параметр со старым именем базы данных. Эта синхронизация удаляет базу данных и файлы со старым именем из любых реплик. Затем выполните другую синхронизацию `-Database` с указанием параметра с новым именем базы данных. Вторая синхронизация копирует недавно названную базу данных ко второму набору файлов и увлажняет любые реплики. Эти синхронизации не могут быть выполнены с помощью команды модели синхронизации в портале.

### <a name="synchronization-mode"></a>Режим синхронизации

По умолчанию реплики запроса регидратируются в полном объеме, а не постепенно. Регидратация происходит поэтапно. Они отделены и прикреплены два в то время (при условии Есть по крайней мере три реплики), чтобы обеспечить по крайней мере одна реплика хранится в Интернете для запросов в любой момент времени. В некоторых случаях клиентам может потребоваться повторное подключение к одной из онлайн-копий во время этого процесса. С помощью параметра (в предварительном просмотре) **ReplicaSyncMode** можно указать синхронизацию реплики запроса параллельно. Параллельная синхронизация обеспечивает следующие преимущества: 

- Значительное сокращение времени синхронизации. 
- Данные по копиям, скорее всего, будут последовательными в процессе синхронизации. 
- Поскольку базы данных хранятся в режиме онлайн на всех репликах на протяжении всего процесса синхронизации, клиентам не нужно повторно подключаться. 
- Кэш в памяти обновляется постепенно только с измененными данными, которые могут быть быстрее, чем полностью регидратировать модель. 

#### <a name="setting-replicasyncmode"></a>Настройка ReplicaSyncMode

Используйте SSMS для установки ReplicaSyncMode в расширенных свойствах. Вы можете выбрать 

- `1`(по умолчанию): Регидратация базы данных полную реплику поэтапно (инкрементные). 
- `2`: Оптимизация синхронизации параллельно. 

![Установка RelicaSyncMode](media/analysis-services-scale-out/aas-scale-out-sync-mode.png)

При настройке **ReplicaSyncMode 2**, в зависимости от того, сколько кэша должно быть обновлено, дополнительная память может быть использована репликами запроса. Для поддержания базы данных в режиме онлайн и доступной для запросов, в зависимости от того, сколько данных изменилось, операция может потребовать до *удвоения памяти* на реплике, поскольку старые и новые сегменты хранятся в памяти одновременно. Узлы реплики имеют такое же распределение памяти, как и основной узла, и обычно на первичном узах для операций обновления имеется дополнительная память, поэтому маловероятно, что реплики закончатся из памяти. Кроме того, общий сценарий заключается в том, что база данных постепенно обновляется на первичном узло, и поэтому требование о удвоении памяти должно быть редкостью. Если операция Sync действительно столкнулась с ошибкой памяти, она повторно припытается использовать технику по умолчанию (прикрепить/отсоединить по два за раз). 

### <a name="separate-processing-from-query-pool"></a>Отделение обработки от пула запросов

Чтобы достичь максимальной производительности во время выполнения операций обработки и запросов, отделите сервер обработки от пула запросов. При разделении новые соединения клиента назначаются только репликам запросов в пуле запросов. Если для операций обработки требуется лишь короткий промежуток времени, вы можете отделить сервер обработки от пула запросов только на время, затрачиваемое на выполнение операций обработки и синхронизации, а затем снова включить его в пул запросов. При отделении сервера обработки от пула запросов или добавлении его обратно в пул запросов может пройти до пяти минут.

## <a name="monitor-qpu-usage"></a>Мониторинг использования QPU

Чтобы определить, нужен ли масштаб для вашего сервера, [следите за сервером](analysis-services-monitor.md) на портале Azure с помощью Metrics. Регулярно используется максимальное число QPU, это означает, что количество запросов к моделям превышает квоту QPU для плана. Значение метрики длины очереди заданий для пула запросов также увеличивается, когда количество запросов в очереди пула потока запросов превышает доступную квоту QPU. 

Еще один хороший показатель для просмотра является средний ЗПУ по ServerResourceType. Эта метрика сравнивает средний qPU для основного сервера с пулом запросов. 

![Масштабирование запроса метрик](media/analysis-services-scale-out/aas-scale-out-monitor.png)

**Настройка ЗПУ по СерверРесурсТипу**

1. В диаграмме линии метрики щелкните **метрику Добавления**. 
2. В **RESOURCE**, выберите свой сервер, затем в **METRIC NAMESPACE**, выберите **Анализ услуг стандартных метрик**, затем в **METRIC**, выберите **ЗПУ**, а затем в **АГРЕГАЦИЯ**, выберите **Avg**. 
3. Нажмите **Применить Расщепление**. 
4. В **VALUES**выберите **ServerResourceType**.  

### <a name="detailed-diagnostic-logging"></a>Подробный диагностический журнал

Используйте журналы Azure Monitor для более детальной диагностики масштабированных серверных ресурсов. С журналами можно использовать запросы Log Analytics для того, чтобы вырваться из QPU и памяти по серверу и реплике. Чтобы узнать больше, смотрите примеры запросов в [журнале диагностики аналитических служб.](analysis-services-logging.md#example-queries)


## <a name="configure-scale-out"></a>Настройка горизонтального масштабирования

### <a name="in-azure-portal"></a>На портале Azure

1. На портале нажмите **Scale-out**. Используйте ползунок, чтобы выбрать количество серверов реплик запросов. Число выбранных реплик помимо существующего сервера.  

2. В разделе **Отделить сервер обработки от пула запросов** выберите "Да", чтобы отделить сервер обработки от серверов запросов. [Соединения](#connections) клиента, использующие строку подключения по умолчанию (без `:rw`) перенаправляются на реплики в пуле запросов. 

   ![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-slider.png)

3. Нажмите кнопку **Сохранить**, чтобы подготовить новые серверы-реплики запросов. 

При настройке масштабирования для сервера в первый раз модели на основном сервере автоматически синхронизируются с репликами в пуле запросов. Автоматическая синхронизация происходит только один раз, когда вы впервые настраиваете масштабирование на одну или несколько реплик. Последующие изменения в количестве реплик на том же сервере *не вызовут еще одну автоматическую синхронизацию.* Автоматическая синхронизация не повторится, даже если вы установите сервер до нуля реплик, а затем снова масштабируется до любого количества реплик. 

## <a name="synchronize"></a>Synchronize 

Операции синхронизации должны выполняться вручную или с помощью REST API.

### <a name="in-azure-portal"></a>На портале Azure

Выберите **Обзор** > модель > **Синхронизировать модель**.

![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-sync.png)

### <a name="rest-api"></a>REST API

Используйте операцию **sync**.

#### <a name="synchronize-a-model"></a>Синхронизация модели:   

`POST https://<region>.asazure.windows.net/servers/<servername>:rw/models/<modelname>/sync`

#### <a name="get-sync-status"></a>Получение состояния синхронизации  

`GET https://<region>.asazure.windows.net/servers/<servername>/models/<modelname>/sync`

Коды статуса возврата:


|Код  |Описание  |
|---------|---------|
|-1     |  Недопустимо       |
|0     | Replicating        |
|1     |  Регидратация       |
|2     |   Завершено       |
|3     |   Ошибка      |
|4     |    Завершение     |
|||


### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Перед использованием PowerShell [установите или обновите новейший модуль Azure PowerShell.](/powershell/azure/install-az-ps) 

Для синхронизации используйте [Sync-AzAnalysisServicesInstance.](https://docs.microsoft.com/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance)

Чтобы установить количество реплик запросов, используйте [Set-AzAnalysisServicesServer.](https://docs.microsoft.com/powershell/module/az.analysisservices/set-azanalysisservicesserver) Укажите необязательный параметр `-ReadonlyReplicaCount`.

Чтобы отделить процессуательный сервер от пула запросов, используйте [Set-AzAnalysisServicesServer.](https://docs.microsoft.com/powershell/module/az.analysisservices/set-azanalysisservicesserver) Укажите `-DefaultConnectionMode` дополнительный `Readonly`параметр для использования.

Чтобы узнать больше, смотрите [С помощью основного сервиса с модулем Az.AnalysisServices](analysis-services-service-principal.md#azmodule).

## <a name="connections"></a>Соединения

На странице "Обзор" вашего сервера указаны два имени сервера. Если вы еще не настроили горизонтальное масштабирование для сервера, оба его имени работают одинаково. После настройки горизонтального масштабирования для сервера нужно указать соответствующее имя сервера в зависимости от типа подключения. 

Для подключений конечных пользователей, таких как Power BI Desktop, Excel и пользовательские приложения, используйте **имя сервера.** 

Для SSMS, Visual Studio и строк связи в приложениях PowerShell, Azure Function и AMO используйте **имя сервера управления.** Имя сервера управления содержит специальный квалификатор `:rw` (чтение и запись). Все операции обработки происходят на (первичном) сервере управления.

![имена серверов;](media/analysis-services-scale-out/aas-scale-out-name.png)

## <a name="scale-up-scale-down-vs-scale-out"></a>Масштабирование, масштаб вниз против масштабирования

Вы можете изменить уровень ценообразования на сервере с несколькими репликами. Один и тот же уровень ценообразования применяется ко всем репликам. Операция масштаба сначала сведет все реплики сразу, а затем подведет все реплики на новом уровне ценообразования.

## <a name="troubleshoot"></a>Устранение неполадок

**Проблема.** У пользователей возникает ошибка **Не удается найти экземпляр сервера "\<имя сервера>" в режиме соединения ReadOnly.**

**Решение:** При выборе **сервера «Отдельное» из опции пула запросов** клиентские соединения, использующие строку подключения по умолчанию (без) `:rw`перенаправляются на реплики пула запросов. Если реплики в пуле запросов еще не подключены, так как синхронизация еще не завершена, возможен сбой перенаправления клиентских подключений. Чтобы предотвратить неудачные попытки соединения, должны существовать по крайней мере два сервера в пуле запросов при выполнении синхронизации. Каждый сервер синхронизируется по отдельности, а другие остаются в сети. Если вы решили отказаться от сервера обработки в пуле запросов во время обработки, вы можете удалить его из пула для обработки и затем повторно добавить его туда после завершение этого процесса, но перед синхронизацией. Вы можете использовать метрики памяти и единицы обработки запросов для проверки состояния синхронизации.



## <a name="related-information"></a>Дополнительные сведения

[Мониторинг метрик сервера](analysis-services-monitor.md)   
[Управление службами Azure Analysis Services](analysis-services-manage.md) 
