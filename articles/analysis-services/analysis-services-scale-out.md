---
title: Горизонтальное масштабирование служб Azure Analysis Services | Документация Майкрософт
description: Репликация серверов Azure Analysis Services с помощью горизонтального масштабирования.
author: minewiskan
manager: kfile
ms.service: azure-analysis-services
ms.topic: conceptual
ms.date: 05/06/2019
ms.author: owend
ms.reviewer: minewiskan
ms.openlocfilehash: 5524645153db0468076cc9b567965bff79d915cb
ms.sourcegitcommit: 0568c7aefd67185fd8e1400aed84c5af4f1597f9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65192319"
---
# <a name="azure-analysis-services-scale-out"></a>Горизонтальное масштабирование служб Azure Analysis Services

С помощью горизонтального масштабирования клиентские запросы можно распределить между несколькими *репликами запросов* в *запрос пула*, уменьшив время отклика при высоких рабочих нагрузках запросов. Операции обработки могут выполняться отдельно от пула запросов, чтобы эти операции не оказывали отрицательного влияния на клиентские запросы. Горизонтальное масштабирование можно настроить на портале Azure или с помощью REST API служб Analysis Services.

Горизонтальное масштабирование доступно для серверов в ценовой категории "Стандартный". Каждая реплика запросов оплачивается по той же ставке, что и сервер. Все реплики запроса создаются в том же регионе, что и сервер. Число реплик запросов, которые вы можете настроить, ограничено регионом, в котором находится ваш сервер. Дополнительные сведения см. в разделе [Доступность по регионам](analysis-services-overview.md#availability-by-region). Горизонтальное масштабирование не увеличивает объем доступной памяти сервера. Чтобы увеличить объем памяти, необходимо изменить план. 

## <a name="why-scale-out"></a>Почему горизонтального масштабирования?

В обычном развертывании сервера один сервер выступает в роли сервера обработки и сервера запросов. Если количество клиентских запросов к моделям на сервере превышает число единиц обработки запросов (QPU) в плане сервера или обработка модели производится во время выполнения рабочей нагрузки с большим числом запросов, это может привести к снижению производительности. 

С помощью горизонтального масштабирования, можно создать пул запросов с ресурсами реплики до семи дополнительных запросов (восемь общее, включая ваши *основной* сервера). Вы можете масштабировать число реплик в пуле запросов, чтобы удовлетворять требования к QPU в критические моменты времени, и в любое время можно отделить сервер обработки от пула запросов. 

Независимо от числа реплик запросов, имеющихся в пуле запросов, обработка рабочих нагрузок не распределяется между репликами запросов. Основной сервер выступает в качестве сервера обработки. Реплики запросов обслуживают только запросы к базам данных модели, синхронизируются между основным сервером и каждой реплики в пуле запросов. 

При масштабировании, может занять до пяти минут для новых реплик запросов, чтобы постепенно добавлять в пул запросов. При всех новых реплик запросов не будут, и выполнение, новые клиентские подключения равномерно распределяются между ресурсами в пуле запросов. Имеющиеся клиентские подключения останутся в пуле, к которому они в настоящее время подключены. При свертывании любые имеющиеся клиентские подключения к ресурсу пула запросов, которые удаляются из пула, завершаются. Клиенты могут переключиться на оставшийся ресурс пула запросов.

## <a name="how-it-works"></a>Принцип работы

При настройке масштабного первый раз, базы данных модели на сервере-источнике, *автоматически* синхронизирована с новой реплики в новом пуле запросов. Автоматическая синхронизация выполняется только один раз. Во время автоматической синхронизации файлы данных сервера-источника (шифрование в хранилище BLOB-объектов) копируются в расположение, также шифруются в хранилище BLOB-объектов. Реплики в пуле запросов, затем *расконсервированы* с данными из второго набора файлов. 

Поскольку автоматическая синхронизация выполняется только тогда, когда вы горизонтального масштабирования сервера в первый раз, можно также выполнить синхронизацию вручную. Синхронизация гарантирует, что данные реплик в пуле запросов совпадать с сервера-источника. При обработке моделей (Обновить) на сервере-источнике, необходимо выполнить синхронизацию *после* завершения операции обработки. Процесс синхронизации копирует обновленные данные из файлов с сервера-источника в хранилище BLOB-объектов ко второму набору файлов. Реплики в пуле запросов затем Структура данных с обновленными данными из второго набора файлов в хранилище BLOB-объектов. 

При выполнении последующих операций горизонтального масштабирования, например, увеличение числа реплик в пуле запросов от двух до пяти, новых реплик структура данных с данными из второго набора файлов в хранилище BLOB-объектов. Синхронизация не выполняется. Если выполнить синхронизацию после становятся масштабирование, новых реплик в пуле запросов дважды — структура избыточных расконсервации. При выполнении последующих операций горизонтального масштабирования, важно помнить:

* Выполнять синхронизацию *перед выполнением операции горизонтального масштабирования* во избежание избыточного расконсервации добавлена реплик. Одновременно синхронизируемой и горизонтального масштабирования операций, выполняемых в то же время не допускаются.

* При автоматизации обоих обработки *и* операций масштабирования, очень важно сначала обработки данных на сервере-источнике, а затем выполнять синхронизацию и затем выполнять операции горизонтального масштабирования. Эта последовательность гарантирует минимальное влияние на ресурсы памяти и QPU.

* Синхронизация разрешена, даже в том случае, если существует отсутствуют ли реплики в пуле запросов. Если масштабирование от нуля до одной или нескольких реплик с новыми данными из операции обработки на сервере-источнике, сначала выполнения синхронизации без реплик в пуле запросов и затем горизонтальное масштабирование. Синхронизация перед горизонтальное масштабирование позволяет избежать избыточных расконсервации вновь добавленный реплик.

* При удалении базы данных модели с сервера-источника, он не автоматически удаляются из реплик в пуле запросов. Необходимо выполнить операцию синхронизации с помощью [AzAnalysisServicesInstance синхронизации](https://docs.microsoft.com/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance) команду PowerShell, которая удаляет из реплики общего хранилища больших двоичных файлов в секунду для этой базы данных, а затем удаляет модели База данных в реплики в пуле запросов. Чтобы определить, существует ли с шаблоном базы данных реплики в пуле запросов, но не на сервере-источнике, убедитесь, **отделить сервер обработки от пула запросов** параметр предназначен для **Да**. Затем с помощью SSMS подключитесь к основной сервер, используя `:rw` квалификатор наличие базы данных. Затем подключитесь к реплик в пуле запросов, подключение без `:rw` квалификатор, существует ли также той же базе данных. Если база данных существует в репликах в пуле запросов, но не на сервере-источнике, запустите операцию синхронизации.   

* При переименовании базы данных на сервере-источнике, есть дополнительный шаг, необходимо убедиться, что база данных синхронизирована должным образом для всех реплик. После переименования, выполнять синхронизацию с помощью [синхронизации AzAnalysisServicesInstance](https://docs.microsoft.com/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance) указания команды `-Database` параметра со старым именем базы данных. Процесс синхронизации базы данных и файлы со старым именем удаляются из всех реплик. Затем выполните указания другой синхронизации `-Database` параметр с новым именем базы данных. Второй синхронизации второй набор файлов выполняется копирование под новым именем базы данных и заполняет все реплики. Невозможно выполнить эти операции синхронизации с помощью модели команда Synchronize на портале.

### <a name="separate-processing-from-query-pool"></a>Отделение обработки от пула запросов

Чтобы достичь максимальной производительности во время выполнения операций обработки и запросов, отделите сервер обработки от пула запросов. После разделения, реплик запросов в пуле запросов только назначаются новые клиентские подключения. Если для операций обработки требуется лишь короткий промежуток времени, вы можете отделить сервер обработки от пула запросов только на время, затрачиваемое на выполнение операций обработки и синхронизации, а затем снова включить его в пул запросов. При разделении сервер обработки от пула запросов или добавить его обратно в пул запросов может занять до пяти минут для завершения операции.

## <a name="monitor-qpu-usage"></a>Мониторинг использования QPU

Чтобы определить, требуется ли горизонтальное масштабирование для вашего сервера, можно отслеживать его работу с помощью метрик на портале Azure. Регулярно используется максимальное число QPU, это означает, что количество запросов к моделям превышает квоту QPU для плана. Значение метрики длины очереди заданий для пула запросов также увеличивается, когда количество запросов в очереди пула потока запросов превышает доступную квоту QPU. 

Другим хорошим для просмотра метрика среднее QPU, ServerResourceType. Эта метрика сравнивает среднее QPU для сервера-источника с этим пула запросов. 

![Масштабирование запросов для метрики](media/analysis-services-scale-out/aas-scale-out-monitor.png)

### <a name="to-configure-qpu-by-serverresourcetype"></a>Чтобы настроить QPU, ServerResourceType
1. На графике метрики щелкните **добавить метрику**. 
2. В **РЕСУРСОВ**, выберите сервер, а затем в **пространство ИМЕН МЕТРИКИ**выберите **стандартных метрик для служб Analysis Services**, а затем в **МЕТРИКА**, Выберите **QPU**, а затем в **статистической ОБРАБОТКИ**выберите **Avg**. 
3. Нажмите кнопку **применить разделение**. 
4. В **значения**выберите **ServerResourceType**.  

Чтобы узнать больше, ознакомьтесь с [отслеживанием метрик сервера](analysis-services-monitor.md).

## <a name="configure-scale-out"></a>Настройка горизонтального масштабирования

### <a name="in-azure-portal"></a>На портале Azure

1. На портале щелкните **Масштабируемый**. Используйте ползунок, чтобы выбрать количество серверов-реплик запросов. Число выбранных реплик помимо существующего сервера.

2. В разделе **Отделить сервер обработки от пула запросов** выберите "Да", чтобы отделить сервер обработки от серверов запросов. Клиент [подключений](#connections) с помощью строки подключения по умолчанию (без `:rw`) будете перенаправлены к репликам в пуле запросов. 

   ![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-slider.png)

3. Нажмите кнопку **Сохранить**, чтобы подготовить новые серверы-реплики запросов. 

При настройке горизонтального масштабирования для сервера в первый раз, моделей на сервере-источнике, автоматически синхронизируются с репликами в пуле запросов. Автоматическая синхронизация происходит только один раз, при первой настройке горизонтального масштабирования для одной или нескольких реплик. Последующие изменения числа реплик на одном сервере *не запустит автоматическую синхронизацию в другой*. Автоматическая синхронизация не будет выполняться снова, даже если вы настроите сервер ноль реплик и затем снова горизонтального масштабирования с любым количеством реплик. 

## <a name="synchronize"></a>синхронизировать 

Синхронизация операции должны выполняться вручную или с помощью REST API.

### <a name="in-azure-portal"></a>На портале Azure

Выберите **Обзор** > модель > **Синхронизировать модель**.

![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-sync.png)

### <a name="rest-api"></a>REST API

Используйте операцию **sync**.

#### <a name="synchronize-a-model"></a>Синхронизация модели:   

`POST https://<region>.asazure.windows.net/servers/<servername>:rw/models/<modelname>/sync`

#### <a name="get-sync-status"></a>Получение состояния синхронизации  

`GET https://<region>.asazure.windows.net/servers/<servername>/models/<modelname>/sync`

Возвращаемые коды состояния:


|Код  |ОПИСАНИЕ  |
|---------|---------|
|-1     |  Недействительно       |
|0     | Выполняется репликация        |
|1     |  Восстановление       |
|2     |   Завершено       |
|3     |   Сбой      |
|4.     |    Завершение     |
|||


### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Прежде чем использовать PowerShell, [установить или обновить последнюю версию модуля Azure PowerShell](/powershell/azure/install-az-ps). 

Чтобы запустить службу синхронизации, используйте [AzAnalysisServicesInstance синхронизации](https://docs.microsoft.com/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance).

Чтобы задать число реплик запросов, используйте [AzAnalysisServicesServer набора](https://docs.microsoft.com/powershell/module/az.analysisservices/set-azanalysisservicesserver). Укажите необязательный параметр `-ReadonlyReplicaCount`.

Чтобы отделить сервер обработки от пула запросов, используйте [AzAnalysisServicesServer набора](https://docs.microsoft.com/powershell/module/az.analysisservices/set-azanalysisservicesserver). Укажите необязательное `-DefaultConnectionMode` параметр `Readonly`.

Дополнительные сведения см. в разделе [с помощью субъекта-службы с помощью модуля Az.AnalysisServices](analysis-services-service-principal.md#azmodule).

## <a name="connections"></a>Подключения

На странице "Обзор" вашего сервера указаны два имени сервера. Если вы еще не настроили горизонтальное масштабирование для сервера, оба его имени работают одинаково. После настройки горизонтального масштабирования для сервера нужно указать соответствующее имя сервера в зависимости от типа подключения. 

Для таких клиентских подключений пользователей, как Power BI Desktop, Excel и настраиваемые приложения, используйте **имя сервера**. 

Для SSMS, SSDT, строк подключения в PowerShell, приложений службы "Функции Azure" и AMO используйте **имя сервера управления**. Имя сервера управления содержит специальный квалификатор `:rw` (чтение и запись). Все операции обработки выполняются на сервере управления (основная).

![имена серверов;](media/analysis-services-scale-out/aas-scale-out-name.png)

## <a name="troubleshoot"></a>Устранение неполадок

**Проблема.** У пользователей возникает ошибка **Не удается найти экземпляр сервера "\<имя сервера>" в режиме соединения ReadOnly.**

**Решение.** При выборе **отделить сервер обработки от пула запросов** параметр подключения клиентов, с помощью строки подключения по умолчанию (без `:rw`) будете перенаправлены на пул реплик запросов. Если реплики в пуле запросов еще не подключены, так как синхронизация еще не завершена, возможен сбой перенаправления клиентских подключений. Чтобы предотвратить неудачные попытки соединения, должны существовать по крайней мере два сервера в пуле запросов при выполнении синхронизации. Каждый сервер синхронизируется по отдельности, а другие остаются в сети. Если вы решили отказаться от сервера обработки в пуле запросов во время обработки, вы можете удалить его из пула для обработки и затем повторно добавить его туда после завершение этого процесса, но перед синхронизацией. Вы можете использовать метрики памяти и единицы обработки запросов для проверки состояния синхронизации.



## <a name="related-information"></a>Связанные сведения

[Мониторинг метрик сервера](analysis-services-monitor.md)   
[Управление службами Azure Analysis Services](analysis-services-manage.md) 
