---
title: Подключение примера кода устройства IoT Plug and Play (предварительная версия) компонента Python к Центру Интернета вещей | Документация Майкрософт
description: Создайте и запустите пример кода Python устройства IoT Plug and Play (предварительная версия), который использует несколько компонентов и подключается к Центру Интернета вещей. С помощью обозревателя Интернета вещей Azure просматривайте сведения, отправленные устройством в центр.
author: ericmitt
ms.author: ericmitt
ms.date: 7/14/2020
ms.topic: tutorial
ms.service: iot-pnp
services: iot-pnp
ms.openlocfilehash: 0cde9caa2f2b68b1e75eac635a81865cc4b6b33c
ms.sourcegitcommit: 46f8457ccb224eb000799ec81ed5b3ea93a6f06f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87351869"
---
# <a name="tutorial-connect-a-sample-iot-plug-and-play-preview-multiple-component-device-application-to-iot-hub-python"></a>Руководство по подключению примера приложения многокомпонентного устройства IoT Plug and Play (предварительная версия) к Центру Интернета вещей (Python)

[!INCLUDE [iot-pnp-tutorials-device-selector.md](../../includes/iot-pnp-tutorials-device-selector.md)]

В этом учебнике показано, как создать пример приложения устройства IoT Plug and Play с компонентами и корневым интерфейсом, подключить его к Центру Интернета вещей и с помощью обозревателя Центра Интернета вещей Azure просмотреть сведения, отправляемые в центр. Пример приложения написан на языке Python и включен в пакет SDK для устройств центра Интернета вещей Azure для Python. Разработчик решения может использовать обозреватель Интернета вещей Azure, чтобы ознакомиться с возможностями устройства IoT Plug and Play, не просматривая код устройства.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="prerequisites"></a>Предварительные требования

Для выполнения инструкций, приведенных в этом учебнике, на компьютере для разработки необходимо установить Python 3.7. Вы можете скачать последнюю рекомендуемую версию для нескольких платформ на сайте [python.org](https://www.python.org/). Проверить версию Python можно с помощью следующей команды:  

```cmd/sh
python --version
```

Вы можете скачать последнюю рекомендуемую версию для нескольких платформ на сайте [python.org](https://www.python.org/).

### <a name="azure-iot-explorer"></a>Обозреватель Интернета вещей Azure

Для взаимодействия с примером устройства во второй части этого учебника используется **обозреватель Интернета вещей Azure**. [Скачайте и установите последний выпуск обозревателя Интернета вещей Azure](./howto-use-iot-explorer.md) для вашей операционной системы.

[!INCLUDE [iot-pnp-prepare-iot-hub.md](../../includes/iot-pnp-prepare-iot-hub.md)]

Выполните следующую команду, чтобы получить _строку подключения к Центру Интернета вещей_ для вашего концентратора. Запишите эту строку подключения. Вы будете использовать ее позже при работе с этим учебником.

```azurecli-interactive
az iot hub show-connection-string --hub-name <YourIoTHubName> --output table
```

> [!TIP]
> Вы также можете использовать обозреватель Интернета вещей, чтобы найти строку подключения для центра Интернета вещей.

Выполните указанную ниже команду, чтобы получить _строку подключения устройства_, добавленного в центр. Запишите эту строку подключения. Вы будете использовать ее позже при работе с этим учебником.

```azurecli-interactive
az iot hub device-identity show-connection-string --hub-name <YourIoTHubName> --device-id <YourDeviceID> --output table
```

[!INCLUDE [iot-pnp-download-models.md](../../includes/iot-pnp-download-models.md)]

## <a name="set-up-your-environment"></a>Настройка среды

Этот пакет опубликован в качестве PIP для обновления общедоступной предварительной версии. Версия пакета должна быть последней или `2.1.4`.

В локальной среде Python установите файл следующим образом:

```cmd/sh
pip install azure-iot-device
```

Клонируйте репозиторий пакета SDK Интернета вещей для Python и извлеките **pnp-preview-refresh**:

```cmd/sh
git clone https://github.com/Azure/azure-iot-sdk-python
```

## <a name="review-the-code"></a>Просмотр кода

В этом примере реализуется устройство контроллера температуры IoT Plug and Play. Модель, которую реализует этот пример, использует [несколько компонентов](concepts-components.md). [Файл модели языка определения Digital Twins (DTDL) для устройства определения температуры](https://github.com/Azure/opendigitaltwins-dtdl/blob/master/DTDL/v2/samples/TemperatureController.json) определяет телеметрию, свойства и команды, реализуемые устройством.

В папке *azure-iot-sdk-python\azure-iot-device\samples\pnp* содержится пример кода для устройства IoT Plug and Play. Ниже приведены файлы для устройства контроля температуры:

- pnp_temp_controller_with_thermostats.py
- pnp_helper_preview_refresh.py

Устройство для контроля температуры имеет несколько компонентов и корневой интерфейс на основе модели DTDL.

Откройте файл *pnp_temp_controller_with_thermostats.py* в любом редакторе. Код в этом файле:

1. Импортирует `pnp_helper_preview_refresh.py`, чтобы получить доступ к вспомогательным методам.

1. Определяет два идентификатора модели цифрового двойника (DTMIs), которые уникальным образом представляют два разных интерфейса, определенные в модели DTDL. Компоненты в реальном контроллере температуры должны реализовывать эти два интерфейса. Эти два интерфейса уже опубликованы в центральном репозитории. Эти DTMIs должны быть известны пользователю и изменяться в зависимости от сценария реализации устройства. Для текущего примера эти два интерфейса представляют собой:

  - Терморегулятор.
  - Сведения об устройстве, разработанном Azure.

. Определяет DTMI `model_id`для реализуемого устройства. DTMI определяется пользователем и должен соответствовать DTMI в файле модели DTDL.

1. Определяет имена, присвоенные компонентам в файле DTDL. В DTDL есть два терморегулятора и один информационный компонент устройства. Константа `serial_number` также определяется в корневом интерфейсе. Невозможно изменить `serial_number` устройства.

1. Определяет реализации обработчика команд. Они определяют действия устройства при получении запросов команд.

1. Определяет функции для создания ответа команды. Они определяют реакцию устройства на запросы команд. Функции ответа команды создаются, если команде необходимо отправить пользовательский ответ обратно в Центр Интернета вещей. Если функция ответа для команды не указана, отправляется универсальный ответ. В этом примере пользовательский ответ есть только у команды **getMaxMinReport**.

1. Определяет функцию для отправки данных телеметрии с этого устройства. Данные телеметрии отправляются с помощью терморегуляторов и корневого интерфейса. Эта функция принимает дополнительный параметр имени компонента, чтобы определить, какой компонент отправил данные телеметрии.

1. Определяет прослушиватель для запросов команд.

1. Определяет прослушиватель для требуемых обновлений свойств.

1. Имеет функцию `main`, которая:

    1. Использует пакет SDK для устройств для создания клиента устройства и подключения к Центру Интернета вещей. Устройство отправляет `model_id`, чтобы Центр Интернета вещей мог определить устройство IoT Plug and Play.

    1. Использует функцию `create_reported_properties` во вспомогательном файле для создания свойств. Передайте имя компонента и свойства в виде пар "ключ — значение" для этой функции.

    1. Обновляет доступные для чтения свойства своих компонентов путем вызова `patch_twin_reported_properties`.

    1. Начинает прослушивание запросов команд с помощью функции `execute_command_listener`. Функция настраивает прослушиватель для запросов команд от службы. При настройке прослушивателя вы предоставляете параметры `method_name`, `user_command_handler` и дополнительный параметр `create_user_response_handler`.
        - `method_name` определяет запрос команды. В этом примере модель определяет команды **перезагрузки**и **getMaxMinReport**.
        - Функция `user_command_handler` определяет действия устройства при получении команды.
        - Функция `create_user_response_handler` создает ответ, который будет отправлен в Центр Интернета вещей при успешном выполнении команды. Этот ответ можно просмотреть на портале. Если эта функция не указана, в службу отправляется общий ответ.

    1. Использует `execute_property_listener` для прослушивания обновлений свойств.

    1. Начинает отправку телеметрии с помощью `send_telemetry`. В примере кода используется цикл для вызова трех функций отправки телеметрии. Все они вызываются каждые восемь секунд

    1. Отключает все прослушиватели и задачи и выходит из цикла при нажатии кнопки **Q** или **q**.

Теперь, когда вы видели код, создайте переменную среды с именем **IOTHUB_DEVICE_CONNECTION_STRING**, чтобы сохранить строку подключения устройства, которую вы записали ранее. Чтобы запустить пример, используйте следующую команду:

```cmd/sh
python pnp_temp_controller_with_thermostats.py
```

Пример устройства отправляет сообщения телеметрии каждые несколько секунд в Центр Интернета вещей.

Вы увидите приведенный ниже результат, который указывает на то, что устройство начало отправлять данные телеметрии в центр и готово к получению команд и обновлений свойств.

![Сообщения о подтверждении устройства](media/tutorial-multiple-components-python/multiple-component.png)

Продолжите работу примера, после того как выполните следующие действия.

## <a name="use-azure-iot-explorer-to-validate-the-code"></a>Проверка кода с помощью обозревателя Интернета вещей Azure

После запуска примера клиента устройства используйте обозреватель Интернета вещей Azure, чтобы убедиться, что он работает.

[!INCLUDE [iot-pnp-iot-explorer.md](../../includes/iot-pnp-iot-explorer.md)]

[!INCLUDE [iot-pnp-clean-resources.md](../../includes/iot-pnp-clean-resources.md)]

## <a name="next-steps"></a>Дальнейшие действия

Из этого учебника вы узнали, как подключить устройство IoT Plug and Play с компонентами к Центру Интернета вещей. Дополнительные сведения о моделях устройства IoT Plug and Play см. в статье

> [!div class="nextstepaction"]
> [Руководство для разработчиков IoT Plug and Play (предварительная версия)](concepts-developer-guide.md)
