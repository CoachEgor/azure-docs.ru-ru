---
title: Подключение примера кода устройства IoT Plug and Play (предварительная версия) компонента Node.js к Центру Интернета вещей | Документация Майкрософт
description: Создание и запуск примера кода Node.js устройства IoT Plug and Play (предварительная версия), который использует несколько компонентов и подключается к Центру Интернета вещей. С помощью обозревателя Интернета вещей Azure просматривайте сведения, отправленные устройством в центр.
author: olivakar
ms.author: olkar
ms.date: 07/10/2020
ms.topic: tutorial
ms.service: iot-pnp
services: iot-pnp
ms.custom: devx-track-javascript
ms.openlocfilehash: d26179ab82f29ce8f937f5b444463c1308d92047
ms.sourcegitcommit: 4e5560887b8f10539d7564eedaff4316adb27e2c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2020
ms.locfileid: "87904111"
---
# <a name="tutorial-connect-a-sample-iot-plug-and-play-preview-multiple-component-device-application-to-iot-hub-nodejs"></a>Руководство по подключению примера приложения многокомпонентного устройства IoT Plug and Play (предварительная версия) к Центру Интернета вещей (Node.js)

[!INCLUDE [iot-pnp-tutorials-device-selector.md](../../includes/iot-pnp-tutorials-device-selector.md)]

В этом учебнике показано, как создать пример приложения устройства IoT Plug and Play с компонентами и корневым интерфейсом, подключить его к центру Интернета вещей и с помощью обозревателя центра Интернета вещей Azure просмотреть сведения, отправляемые в центр. Пример приложения написан для Node.js и включен в пакет SDK для устройств Центра Интернета вещей Azure для Node.js. Разработчик решения может использовать обозреватель Интернета вещей Azure, чтобы ознакомиться с возможностями устройства IoT Plug and Play, не просматривая код устройства.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="prerequisites"></a>Предварительные требования

Для выполнения инструкций, приведенных в этом учебнике, на компьютере для разработки необходимо установить платформу Node.js. Вы можете скачать последнюю рекомендуемую версию для нескольких платформ на сайте [nodejs.org](https://nodejs.org).

Текущую версию Node.js на компьютере, на котором ведется разработка, можно проверить, используя следующую команду:

```cmd/sh
node --version
```

### <a name="azure-iot-explorer"></a>Обозреватель Интернета вещей Azure

Для взаимодействия с примером устройства во второй части этого учебника используется **обозреватель Интернета вещей Azure**. [Скачайте и установите последний выпуск обозревателя Интернета вещей Azure](./howto-use-iot-explorer.md) для вашей операционной системы.

[!INCLUDE [iot-pnp-prepare-iot-hub.md](../../includes/iot-pnp-prepare-iot-hub.md)]

Выполните следующую команду, чтобы получить _строку подключения к Центру Интернета вещей_ для вашего концентратора. Запишите эту строку подключения. Вы будете использовать ее позже при работе с этим учебником.

```azurecli-interactive
az iot hub show-connection-string --hub-name <YourIoTHubName> --output table
```

> [!TIP]
> Вы также можете использовать обозреватель Интернета вещей, чтобы найти строку подключения для центра Интернета вещей.

Выполните указанную ниже команду, чтобы получить _строку подключения устройства_, добавленного в центр. Запишите эту строку подключения. Вы будете использовать ее позже при работе с этим учебником.

```azurecli-interactive
az iot hub device-identity show-connection-string --hub-name <YourIoTHubName> --device-id <YourDeviceID> --output table
```

[!INCLUDE [iot-pnp-download-models.md](../../includes/iot-pnp-download-models.md)]

## <a name="download-the-code"></a>Загрузка кода

С помощью этого учебника вы подготовите среду разработки, которую можно использовать для клонирования и сборки пакета SDK для устройств Центра Интернета вещей Azure для Node.js.

Откройте командную строку в выбранном каталоге. Выполните следующую команду для клонирования репозитория [пакетов SDK для Интернета вещей Microsoft Azure для Node.js](https://github.com/Azure/azure-iot-sdk-node) с GitHub в это расположение:

```cmd/sh
git clone https://github.com/Azure/azure-iot-sdk-node
```

Выполнение этой операции займет несколько минут.

## <a name="install-required-libraries"></a>Установка обязательных библиотек

Используйте пакет SDK для устройств, чтобы выполнить сборку прилагаемого примера кода. Создаваемое приложение имитирует многокомпонентное устройство Plug and Play с корневым интерфейсом, которое подключается к центру Интернета вещей. Оно отправляет данные телеметрии и свойства, а также получает команды.

1. В окне локального терминала перейдите в папку клонированного репозитория, а затем в папку */azure-iot-sdk-node/device/samples/pnp*. Затем выполните следующую команду, чтобы установить обязательные библиотеки:

```cmd/sh
npm install
```

При этом будут установлены соответствующие NPM-файлы, необходимые для выполнения примеров в папке.

1. Настройте переменную среды, используя строку подключения устройства, записанную ранее.

```cmd/sh
set DEVICE_CONNECTION_STRING=<YourDeviceConnectionString>
```

## <a name="review-the-code"></a>Просмотр кода

Перейдите в папку *azure-iot-sdk-node\device\samples\pnp*.

В папке *azure-iot-sdk-node\device\samples\pnp* содержится пример кода для устройства контроллера температуры IoT Plug and Play.

Код в файле *pnpTemperatureController.js* реализует устройство контроллера температуры IoT Plug and Play. Модель, которую реализует этот пример, использует [несколько компонентов](concepts-components.md). [Файл модели языка определения Digital Twins (DTDL) для устройства определения температуры](https://github.com/Azure/opendigitaltwins-dtdl/blob/master/DTDL/v2/samples/TemperatureController.json) определяет телеметрию, свойства и команды, реализуемые устройством.

Откройте файл *pnpTemperatureController.js* в предпочитаемом редакторе кода. В примере кода показано, как:

1. Определяет идентификатор `modelId`, который является DTMI для реализуемого устройства. Этот DTMI определяется пользователем и должен соответствовать DTMI [модели DTDL контроллера температуры](https://github.com/Azure/opendigitaltwins-dtdl/blob/master/DTDL/v2/samples/TemperatureController.json).

2. Реализуйте компоненты, определенные в модели DTDL контроллера температуры. Компоненты в реальном контроллере температуры должны реализовывать эти два интерфейса. Эти два интерфейса уже опубликованы в центральном репозитории. В этом примере этими двумя интерфейсами являются:
  - Терморегулятор
  - Сведения об устройстве, разработанном Azure.

3. Определить имена компонентов. В этом примере содержится два терморегулятора и один информационный компонент устройства.

4. Определить имя команды. Это команды, на которые отвечает устройство.

5. Определить `serialNumber` константы. `serialNumber` закрепляется за каждым заданным устройством.

6. Определить обработчики команд.

7. Определить функции, предназначенные для отправки ответов команд.

8. Определить вспомогательные функции, предназначенные для регистрации запросов команд.

9. Определить вспомогательную функцию для создания свойств.

10. Определить прослушиватель обновлений свойств.

11. Определить функцию для отправки данных телеметрии с этого устройства. Данные телеметрии отправляются с помощью терморегуляторов и корневого компонента. Эта функция получает имя компонента в качестве параметра.

12. Определить функцию `main`, которая:

    1. Использует пакет SDK для устройств для создания клиента устройства и подключения к центру Интернета вещей. Устройство предоставляет `modelId`, чтобы Центр Интернета вещей мог определить устройство IoT Plug and Play.

    1. Начинает прослушивание запросов команд с помощью функции `onDeviceMethod`. Функция настраивает прослушиватель для запросов команд от службы.
        - DTDL устройства определяют команды `reboot` и `getMaxMinReport`.
        - Функция `commandHandler` определяет способ реагирования устройства на команду.

    1. Начинает отправку данных телеметрии с помощью `setInterval` и `sendTelemetry`.

    1. Использует функцию `helperCreateReportedPropertiesPatch`, чтобы создавать свойства, а `updateComponentReportedProperties` — чтобы их обновлять.

    1. Использует `desiredPropertyPatchListener` для прослушивания обновлений свойств.

    1. Отключает все прослушиватели и задачи и выходит из цикла при нажатии кнопки **Q** или **q**.

Теперь, когда вы просмотрели код, выполните следующую команду, чтобы запустить пример:

```cmd\sh
node pnpTemperatureController.js
```

Вы увидите приведенный ниже результат, который указывает на то, что устройство начало отправлять данные телеметрии в центр и готово к получению команд и обновлений свойств.

![Сообщения о подтверждении устройства](media/tutorial-multiple-components-node/multiple-component.png)

Продолжите работу примера, после того как выполните следующие действия.

## <a name="use-azure-iot-explorer-to-validate-the-code"></a>Проверка кода с помощью обозревателя Интернета вещей Azure

После запуска примера клиента устройства используйте обозреватель Интернета вещей Azure, чтобы убедиться, что он работает.

[!INCLUDE [iot-pnp-iot-explorer.md](../../includes/iot-pnp-iot-explorer.md)]

[!INCLUDE [iot-pnp-clean-resources.md](../../includes/iot-pnp-clean-resources.md)]

## <a name="next-steps"></a>Дальнейшие действия

Из этого учебника вы узнали, как подключить устройство IoT Plug and Play с компонентами к центру Интернета вещей. Дополнительные сведения о моделях устройства IoT Plug and Play см. в статье

> [!div class="nextstepaction"]
> [Руководство для разработчиков IoT Plug and Play (предварительная версия)](concepts-developer-guide.md)
