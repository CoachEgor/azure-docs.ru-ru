---
title: Использование службы "Аналитика временных рядов" для хранения и анализа данных телеметрии устройств Azure IoT Plug and Play | Документация Майкрософт
description: Настройка среды службы "Аналитика временных рядов" и подключение центра Интернета вещей для просмотра и анализа данных телеметрии устройств IoT Plug and Play.
author: lyrana
ms.author: lyhughes
ms.date: 10/14/2020
ms.topic: tutorial
ms.service: iot-pnp
services: iot-pnp
ms.openlocfilehash: ad5c6f205fc832eb125e52b4135990fc58742e62
ms.sourcegitcommit: 6a350f39e2f04500ecb7235f5d88682eb4910ae8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/01/2020
ms.locfileid: "96453241"
---
# <a name="preview-tutorial-create-and-connect-to-time-series-insights-gen2-to-store-visualize-and-analyze-iot-plug-and-play-device-telemetry"></a>Руководство по работе с предварительной версией. Создание службы "Аналитика временных рядов" 2-го поколения и подключению к ней для хранения, визуализации и анализа данных телеметрии устройств IoT Plug and Play

Из этого руководства вы узнаете, как создать и правильно настроить среду службы ["Аналитика временных рядов Azure" 2-го поколения](../time-series-insights/overview-what-is-tsi.md) (TSI) для интеграции с решением IoT Plug and Play. С помощью TSI вы можете собирать, обрабатывать, хранить, запрашивать и визуализировать данные временного ряда в масштабе Интернета вещей.

Сначала вы подготовите среду TSI и подключите центр Интернета вещей в качестве источника событий с потоковой передачей данных. Затем вы выполните синхронизацию модели, чтобы создать [модель временных рядов](../time-series-insights/concepts-model-overview.md), основанную на файлах примера модели [языка определения цифровых двойников (DTDL)](https://github.com/Azure/opendigitaltwins-dtdl), которые вы использовали для контроллера температуры и термостатов.

> [!NOTE]
> Такая интеграция предоставляется в предварительной версии. То, как модели устройств DTDL сопоставляются с моделью временных рядов, может измениться в будущем.

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [iot-pnp-prerequisites](../../includes/iot-pnp-prerequisites.md)]

На этом этапе у вас есть следующее:

* Центр интернета вещей Azure.
* Экземпляр DPS, связанный с центром Интернета вещей, с регистрацией отдельного устройства IoT Plug and Play.
* Подключение к центру Интернета вещей от устройства с одним или несколькими компонентами, передающего смоделированные данные в потоковом режиме.

Чтобы не устанавливать Azure CLI локально, можно использовать Azure Cloud Shell для настройки облачных служб.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="prepare-your-event-source"></a>Подготовка источника событий

Центр Интернета вещей, который вы создали ранее, будет выполнять роль [источника событий](../time-series-insights/concepts-streaming-ingestion-event-sources.md) в вашей среде TSI.

> [!IMPORTANT]
> Отключите все существующие маршруты Центра Интернета вещей. Существует известная проблема, связанная с использованием центра Интернета вещей в качестве источника событий TSI с настроенной [маршрутизацией](../iot-hub/iot-hub-devguide-messages-d2c.md#routing-endpoints). Временно отключите все конечные точки маршрутизации, а затем повторно активируйте их, когда ваш центр Интернета вещей подключится к TSI.

Создайте уникальную группу потребителей в центре Интернета вещей, с которой будет работать TSI. Замените значение `my-pnp-hub` именем использованного ранее центра Интернета вещей:

```azurecli-interactive
az iot hub consumer-group create --hub-name my-pnp-hub --name tsi-consumer-group
```

## <a name="choose-your-time-series-id"></a>Выбор идентификатора временных рядов

При подготовке среды TSI вам понадобится выбрать *идентификатор временного ряда*. Выбор соответствующего идентификатора временного ряда очень важен, так как свойство нельзя изменить после установки. Идентификатор временного ряда аналогичен ключу секции базы данных. Он выполняет роль первичного ключа для модели временных рядов. Дополнительные сведения см. в статье [Рекомендации по выбору идентификатора временного ряда](../time-series-insights/how-to-select-tsid.md).

В качестве пользователя IoT Plug and Play укажите _составной ключ_, включающий `iothub-connection-device-id` и `dt-subject`, в качестве идентификатора временного ряда. Центр Интернета вещей добавляет такие системные свойства, которые содержат идентификатор устройства IoT Plug and Play, и имена компонентов устройств соответственно.

Даже если в ваших моделях устройств IoT Plug and Play в настоящее время не используются компоненты, укажите `dt-subject` как часть составного ключа, чтобы их можно было использовать в будущем. Так как идентификатор временного ряда является неизменяемым, корпорация Майкрософт рекомендует включить этот параметр, так как он может понадобится в будущем.

> [!NOTE]
> Приведенные ниже примеры предназначены для многокомпонентного устройства **TemperatureController**, но основные понятия применимы и к устройству **Thermostat** без компонентов.

## <a name="provision-your-tsi-environment"></a>Подготовка среды TSI к работе

В этом разделе описано, как подготовить среду службы "Аналитика временных рядов Azure" 2-го поколения к работе.

Приведенная ниже команда:

* Создает учетную запись хранения Azure для [холодного хранилища](../time-series-insights/concepts-storage.md#cold-store) вашей среды, которое предназначено для долгосрочного хранения и анализа данных журнала.
  * Замените `mytsicoldstore` уникальным именем учетной записи для холодного хранения.
* Создает среду службы "Аналитика временных рядов Azure" 2-го поколения, включая теплое хранилище с периодом хранения 7 дней, а также холодное хранилище для бессрочного хранения.
  * Замените значение `my-tsi-env` уникальным именем для среды TSI.
  * Замените значение `my-pnp-resourcegroup` именем группы ресурсов, которую вы использовали во время настройки.
  * `iothub-connection-device-id, dt-subject` — это свойство идентификатора временного ряда.

```azurecli-interactive
storage=mytsicoldstore
rg=my-pnp-resourcegroup
az storage account create -g $rg -n $storage --https-only
key=$(az storage account keys list -g $rg -n $storage --query [0].value --output tsv)
az timeseriesinsights environment longterm create --name my-tsi-env --resource-group $rg --time-series-id-properties iothub-connection-device-id, dt-subject --sku-name L1 --sku-capacity 1 --data-retention 7 --storage-account-name $storage --storage-management-key $key --location eastus2
```

Подключите источник событий Центра Интернета вещей. Замените значения `my-pnp-resourcegroup`, `my-pnp-hub` и `my-tsi-env` выбранными значениями. Следующая команда ссылается на созданную вами ранее группу потребителей для TSI:

```azurecli-interactive
rg=my-pnp-resourcegroup
iothub=my-pnp-hub
env=my-tsi-env
es_resource_id=$(az iot hub create -g $rg -n $iothub --query id --output tsv)
shared_access_key=$(az iot hub policy list -g $rg --hub-name $iothub --query "[?keyName=='service'].primaryKey" --output tsv)
az timeseriesinsights event-source iothub create -g $rg --environment-name $env -n iot-hub-event-source --consumer-group-name tsi-consumer-group  --key-name iothubowner --shared-access-key $shared_access_key --event-source-resource-id $es_resource_id
```

Перейдите к группе ресурсов на [портале Azure](https://portal.azure.com) и выберите новую среду службы "Аналитика временных рядов". Перейдите по *URL-адресу Обозревателя Аналитики временных рядов*, показанному на странице обзора экземпляра:

![Страница обзора портала](./media/tutorial-configure-tsi/view-environment.png)

В Обозревателе вы увидите три экземпляра:

* &lt;идентификатор вашего устройства pnp&gt; — thermostat1;
* &lt;идентификатор вашего устройства pnp&gt; — thermostat2;
* &lt;идентификатор вашего устройства pnp&gt; — `null`.

> [!NOTE]
> Третий тег представляет данные телеметрии от **TemperatureController**, например рабочий набор памяти устройства. Так как это свойство верхнего уровня, имя компонента будет иметь значение NULL. На следующем шаге мы изменим его на более удобное имя.

![Представление обозревателя 1](./media/tutorial-configure-tsi/tsi-env-first-view.png)

## <a name="configure-model-translation"></a>Настройка преобразования модели

Далее вы преобразуете модель устройства DTDL в модель активов в службе "Аналитика временных рядов Azure" (TSI). Модель временного ряда TSI — это средство семантического моделирования для контекстуализации данных в TSI. Модель временного ряда содержит три основных компонента:

* [Экземпляры модели временного ряда.](../time-series-insights/concepts-model-overview.md#time-series-model-instances) Экземпляры — это собственно виртуальные представления временного ряда. Экземпляры принадлежат к временному ряду с уникальным идентификатором.
* [Иерархии модели временного ряда.](../time-series-insights/concepts-model-overview.md#time-series-model-hierarchies) Иерархии организуют экземпляры, определяя имена свойств и их связи.
* [Типы модели временного ряда.](../time-series-insights/concepts-model-overview.md#time-series-model-types) Типы помогают определить [переменные](../time-series-insights/concepts-variables.md) или формулы для выполнения вычислений. Типы связаны с конкретным экземпляром.

### <a name="define-your-types"></a>Определение типов

Вы можете начать прием данных в службе "Аналитика временных рядов Azure" 2-го поколения без предварительно определенной модели. Когда вы получите данные телеметрии, TSI попытается автоматически разрешить экземпляры временного ряда на основе значений свойства идентификатора временного ряда. Всем экземплярам будет назначен *тип по умолчанию*. Вам потребуется вручную создать новый тип для корректной классификации экземпляров. Ниже приведены сведения о самом простом методе для синхронизации ваших моделей устройств DTDL с типами модели временных рядов:

* Идентификатор модели цифрового двойника будет вашим идентификатором типа.
* Именем типа может быть либо имя модели, либо отображаемое имя.
* Описание модели преобразуется в описание типа.
* Для каждого компонента телеметрии с числовой схемой создается по крайней мере одна переменная типа.
  * Для переменных можно использовать только числовые типы данных, но если значение отправляется как элемент другого типа, который может быть преобразован (например, `"0"`), вы можете использовать функцию [преобразования](/rest/api/time-series-insights/reference-time-series-expression-syntax.md#conversion-functions) (например, `toDouble`).
* Именем переменной может быть либо имя телеметрии, либо отображаемое имя.
* При определении выражения временного ряда переменной обратите внимание на имя телеметрии в сети, а также ее тип данных.

| JSON DTDL | JSON для типа модели временных рядов | Пример значения |
|-----------|------------------|-------------|
| `@id` | `id` | `dtmi:com:example:TemperatureController;1` |
| `displayName`    | `name`   |   `Temperature Controller`  |
| `description`  |  `description`  |  `Device with two thermostats and remote reboot.` |  
|`contents` (массив)| `variables` (объект)  | См. пример ниже

![DTDL в тип модели временных рядов](./media/tutorial-configure-tsi/DTDL-to-TSM-Type.png)

> [!NOTE]
> В этом примере приведены три переменные, но каждый тип может имет до 100 переменных. Разные переменные могут ссылаться на одно и то же значение телеметрии, чтобы при необходимости выполнять различные вычисления. Полный список фильтров, статистических выражений и скалярных функций см. в статье о [синтаксисе выражения временного ряда службы "Аналитика временных рядов" 2-го поколения](/rest/api/time-series-insights/reference-time-series-expression-syntax.md).

Откройте текстовый редактор и сохраните следующий файл JSON на локальном диске:

```JSON
{
  "put": [
    {
      "id": "dtmi:com:example:TemperatureController;1",
      "name": "Temperature Controller",
      "description": "Device with two thermostats and remote reboot.",
      "variables": {
        "workingSet": {
          "kind": "numeric",
          "value": {
            "tsx": "coalesce($event.workingSet.Long, toLong($event.workingSet.Double))"
          }, 
          "aggregation": {
            "tsx": "avg($value)"
          }
        },
        "temperature": {
          "kind": "numeric",
          "value": {
            "tsx": "coalesce($event.temperature.Long, toLong($event.temperature.Double))"
          },
          "aggregation": {
            "tsx": "avg($value)"
          }
        },
        "eventCount": {
          "kind": "aggregate",
          "aggregation": {
            "tsx": "count()"
          }
        }
      }
    }
  ]
}
```

В Обозревателе Аналитики временных рядов перейдите на вкладку **Модель**, щелкнув значок модели слева. Выберите **Типы** и нажмите кнопку **Отправить JSON**:

![Передать](./media/tutorial-configure-tsi/upload-type.png)

Щелкните **Выбрать файл**, выберите сохраненный ранее файл JSON, а затем — **Отправить**.

Вы увидите только что определенный тип **Temperature Controller**.

### <a name="create-a-hierarchy"></a>Создание иерархии

Создайте иерархию, чтобы упорядочить теги, связанные с родительским элементом **TemperatureController**. Следующий простой пример включает один уровень, но решения Интернета вещей обычно имеют несколько уровней вложенности для поддержания контекста тегов в рамках физической и семантической позиций в организации.

Щелкните **Иерархии** и нажмите кнопку **Добавить иерархию**. Введите имя *Парк устройств* и создайте один уровень с именем *Имя устройства*. Затем выберите **Сохранить**.

![Добавление иерархии](./media/tutorial-configure-tsi/add-hierarchy.png)

### <a name="assign-your-instances-to-the-correct-type"></a>Присвойте экземплярам правильный тип

Затем измените тип экземпляров и поместите их в иерархию.

Откройте вкладку **Экземпляры**, найдите экземпляр, представляющий рабочий набор устройства, и щелкните значок **Изменить** справа:

![Редактирование экземпляров](./media/tutorial-configure-tsi/edit-instance.png)

Щелкните раскрывающийся список **Тип** и выберите **Temperature Controller**. Введите *defaultComponent, <your device name>* , чтобы обновить имя экземпляра, представляющего все теги верхнего уровня, которые связаны с вашим устройством.

![Изменение типа экземпляра](./media/tutorial-configure-tsi/change-type.png)

Прежде чем нажать кнопку "Сохранить", откройте вкладку **Поля экземпляра** и установите флажок **Парк устройств**. Введите `<your device name> - Temp Controller`, чтобы сгруппировать данные телеметрии, и нажмите кнопку **Сохранить**.

![Назначение иерархии](./media/tutorial-configure-tsi/assign-to-hierarchy.png)

Повторите предыдущие шаги, чтобы назначить тегам термостата соответствующий тип и иерархию.

## <a name="view-your-data"></a>Просмотр данных

Вернитесь к панели диаграмм и разверните узел **Парк устройств > ваше устройство**. Щелкните **thermostat1**, выберите переменную **Temperature** и нажмите кнопку **Добавить**, чтобы внести значение в диаграмму. Повторите эти же действия для **thermostat2** и компонента **defaultComponent** со значением **workingSet**.

![Изменение типа экземпляра для thermostat2](./media/tutorial-configure-tsi/charting-values.png)

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о различных параметрах построения диаграмм, включая размер интервала и элементы управления оси Y, см. в статье [Обозреватель Аналитики временных рядов Azure](../time-series-insights/concepts-ux-panels.md).

* Подробные сведения о модели временных рядов для среды см. в статье [Модель временных рядов в службе "Аналитика временных рядов Azure" 2-го поколения](../time-series-insights/concepts-model-overview.md).

* Чтобы узнать больше об интерфейсах API запросов и синтаксисе выражений временного ряда, см. статью [API запросов Аналитики временных рядов Azure 2-го поколения](/rest/api/time-series-insights/reference-query-apis.md).
