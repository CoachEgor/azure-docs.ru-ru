---
title: Создание устройства IoT Plug and Play (предварительная версия) | Документация Майкрософт
description: Используйте модель возможностей устройства для создания кода устройства. Затем запустите код устройства и проверьте, подключено ли устройство к Центру Интернета вещей.
author: miagdp
ms.author: miag
ms.date: 08/02/2019
ms.topic: quickstart
ms.service: iot-pnp
services: iot-pnp
ms.custom: mvc
ms.openlocfilehash: 7cfa6e63f74233e9a3fab8f235584fdbe01e67d9
ms.sourcegitcommit: b3bad696c2b776d018d9f06b6e27bffaa3c0d9c3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2019
ms.locfileid: "69881543"
---
# <a name="quickstart-use-a-device-capability-model-to-create-an-iot-plug-and-play-device"></a>Краткое руководство. Создание устройства IoT Plug and Play с помощью модели возможностей устройства

_Модель возможностей устройства_ (DCM) описывает возможности устройства IoT Plug and Play. DCM часто связана с номером SKU продукта. Возможности, определенные в DCM, упорядочены в многократно используемые интерфейсы. Вы можете создать каркас кода устройства на основе DCM. В этом кратком руководстве показано, как создать устройство IoT Plug and Play с помощью DCM в VS Code.

## <a name="prerequisites"></a>Предварительные требования

Для выполнения инструкций, указанных в этом кратком руководстве, вам необходимо установить на локальный компьютер следующее программное обеспечение:

* [Visual Studio (Community, Professional или Enterprise)](https://visualstudio.microsoft.com/downloads/). При установке Visual Studio обязательно добавьте компонент **Диспетчер пакетов NuGet** и рабочую нагрузку **Разработка классических приложений на C++** .
* [Git](https://git-scm.com/download/).
* [CMake](https://cmake.org/download/).
* [Visual Studio Code](https://code.visualstudio.com/).

### <a name="install-azure-iot-device-workbench"></a>Установка Azure IoT Device Workbench

Чтобы установить расширение Azure IoT Device Workbench в VS Code, выполните следующие действия:

1. В VS Code выберите вкладку **Расширения**.
1. Выполните поиск по запросу **Azure IoT Device Workbench**.
1. Щелкните **Установить**.

### <a name="install-the-azure-iot-explorer"></a>Установка обозревателя Azure IoT

Скачайте обозреватель Azure IoT со [страницы последнего выпуска](https://github.com/Azure/azure-iot-explorer/releases) и установите его на компьютере.

### <a name="get-the-connection-string-for-your-company-model-repository"></a>Получение строки подключения для репозитория моделей компании

_Строку подключения к репозиторию моделей компании_ можно найти на [портале Microsoft Azure Certified for IoT](https://preview.catalog.azureiotsolutions.com) при входе с помощью рабочей или учебной учетной записи Майкрософт или ИД партнера Майкрософт, если таковой имеется. Выполнив вход, выберите **Company repository** (Корпоративный репозиторий), а затем **Connection strings** (Строки подключения).

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="prepare-an-iot-hub"></a>Подготовка Центра Интернета вещей

Для выполнения инструкций, приведенных в этом кратком руководстве, также необходим Центр Интернета вещей Azure в подписке Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

Добавьте расширение Интернета вещей Microsoft Azure в интерфейсе командной строки Azure:

```azurecli-interactive
az extension add --name azure-cli-iot-ext
```

Выполните приведенную ниже команду, чтобы создать удостоверение устройства в Центре Интернета вещей. Замените заполнители **YourIoTHubName** и **YourDevice** фактическими именами. Если у вас нет Центра Интернета вещей, создайте его, выполнив инструкции, указанные в [этой статье](../iot-hub/iot-hub-create-using-cli.md).

```azurecli-interactive
az iot hub device-identity create --hub-name [YourIoTHubName] --device-id [YourDevice]
```

Выполните приведенные ниже команды, чтобы получить _строку подключения к только что зарегистрированному устройству_:

```azurecli-interactive
az iot hub device-identity show-connection-string --hub-name [YourIoTHubName] --device-id [YourDevice] --output table
```

Выполните приведенные ниже команды, чтобы получить _строку подключения к вашему Центру Интернета вещей_:

```azurecli-interactive
az iot hub show-connection-string --hub-name [YourIoTHubName] --output table
```

## <a name="prepare-the-development-environment"></a>Подготовка среды разработки

### <a name="get-azure-iot-device-sdk-for-c"></a>Получение пакета SDK для устройств Azure IoT для C

С помощью этого краткого руководства вы подготовите среду разработки, которую можно использовать для клонирования и сборки пакета SDK для устройств Azure IoT для C.

1. Откройте окно командной строки. Выполните следующую команду для клонирования репозитория GitHub [пакета SDK для устройства C Интернета вещей Azure](https://github.com/Azure/azure-iot-sdk-c):

    ```cmd/sh
    git clone https://github.com/Azure/azure-iot-sdk-c --recursive -b public-preview
    ```

    Выполнение этой операции может занять несколько минут.

1. Создайте подкаталог `pnp_app` ​​в корне локального клона репозитория. Эта папка используется для файлов модели устройства и заглушки кода устройства.

    ```cmd/sh
    cd azure-iot-sdk-c
    mkdir pnp_app
    ```

## <a name="author-your-model"></a>Создание модели

В этом кратком руководстве используется имеющийся пример модели возможностей устройства и связанные интерфейсы.

1. Скачайте [модель возможностей устройства](https://github.com/Azure/IoTPlugandPlay/blob/master/samples/SampleDevice.capabilitymodel.json) и [пример интерфейса](https://github.com/Azure/IoTPlugandPlay/blob/master/samples/EnvironmentalSensor.interface.json) и сохраните файлы в папке `pnp_app`.

    > [!TIP]
    > Чтобы скачать файл с сайта GitHub, перейдите к файлу, щелкните правой кнопкой мыши **Необработанный**, а затем выберите **Сохранить ссылку как**.

1. Откройте папку `pnp_app` ​​с помощью VS Code. Файлы можно просмотреть с помощью IntelliSense:

    ![Модель возможностей устройства](media/quickstart-create-pnp-device/dcm.png)

1. В скачанных файлах замените `<YOUR_COMPANY_NAME_HERE>` в полях `@id` и `schema` уникальным значением. Используйте только символы a–z, A–Z, 0–9 и знак подчеркивания. Дополнительные сведения см. в статье [о формате идентификаторов цифровых двойников](https://github.com/Azure/IoTPlugandPlay/tree/master/DTDL#digital-twin-identifier-format).

## <a name="generate-the-c-code-stub"></a>Создание заглушки кода C

Теперь у вас есть модель DCM и связанные с ней интерфейсы, и вы можете сгенерировать код устройства, который реализует модель. Чтобы создать заглушку кода C в VS Code:

1. В открытой папке с файлами DCM нажмите сочетание клавиш **CTRL+SHIFT+P**, чтобы открыть палитру команд, введите **IoT Plug and Play** и выберите **Generate Device Code Stub** (Создать заглушку кода устройства).

    > [!NOTE]
    > При первом использовании служебной программы IoT Plug and Play Code Generator загрузка занимает несколько секунд.

1. Выберите файл DCM, который будет использоваться для создания заглушки кода устройства.

1. Введите название проекта **sample_device**. Это будет именем вашего устройства приложения.

1. Выберите **ANSI C** в качестве языка.

1. Выберите **Проект CMake** в качестве типа проекта.

1. В качестве способа подключения выберите **Via IoT Hub device connection string** (Через строку подключения к устройству Центра Интернета вещей).

1. В VS Code откроется новое окно, содержащее созданные файлы заглушек кода устройства.
    ![Код устройства](media/quickstart-create-pnp-device/device-code.png)

## <a name="build-the-code"></a>Сборка кода

Вы используете пакет SDK устройства для сборки созданной заглушки кода устройства. Создаваемое приложение имитирует устройство, которое подключается к Центру Интернета вещей. Оно отправляет данные телеметрии и свойства, а также получает команды.

1. В VS Code откройте `CMakeLists.txt` в корневой папке пакета SDK для устройства.

1. Добавьте приведенную ниже строку в нижней части файла `CMakeLists.txt`, чтобы включить папку заглушки кода устройства при компиляции:

    ```txt
    add_subdirectory(pnp_app/sample_device)
    ```

1. Создайте подкаталог cmake в корневой папке пакета SDK для устройства и перейдите к этой папке:

    ```cmd\sh
    mkdir cmake
    cd cmake
    ```

1. Выполните приведенные ниже команды, чтобы собрать пакет SDK для устройства и сгенерированную заглушку кода:

    ```cmd\sh
    cmake .. -Duse_prov_client=ON -Dhsm_type_symm_key:BOOL=ON
    cmake --build . -- /m /p:Configuration=Release
    ```

    > [!NOTE]
    > Если cmake не может найти ваш компилятор C++, при запуске предыдущей команды отобразятся ошибки сборки. В этом случае попробуйте выполнить эту команду в [командной строке Visual Studio](https://docs.microsoft.com/dotnet/framework/tools/developer-command-prompt-for-vs).

1. После успешного выполнения сборки запустите приложение, передав в качестве параметра строку подключения к устройству Центра Интернета вещей.

    ```cmd\sh
    cd azure-iot-sdk-c\cmake\pnp_app\sample_device\Release\
    sample_device.exe "[IoT Hub device connection string]"
    ```

1. Приложение устройства начнет отправку данных в Центр Интернета вещей.

    ![Приложение устройства работает](media/quickstart-create-pnp-device/device-app-running.png)

## <a name="validate-the-code"></a>Проверка кода

### <a name="publish-device-model-files-to-model-repository"></a>Публикация файлов модели устройства в репозитории моделей

Чтобы проверить код устройства с помощью **обозревателя Интернета вещей Azure**, необходимо опубликовать файлы в репозитории моделей.

1. В открытой папке с файлами DCM нажмите сочетание клавиш **CTRL+SHIFT+P**, чтобы открыть палитру команд, введите и выберите **IoT Plug & Play: Submit files to Model Repository** (Отправка файлов в репозиторий моделей IoT Plug and Play).

1. Выберите файлы `SampleDevice.capabilitymodel.json` и `EnvironmentalSensor.interface.json`.

1. Введите строку подключения к репозиторию моделей компании.

    > [!NOTE]
    > Строка подключения требуется только при первом подключении к репозиторию.

1. В окне вывода и уведомлений VS Code можно проверить, успешно ли опубликованы файлы.

    > [!NOTE]
    > При возникновении ошибок во время публикации файлов модели устройств можно попробовать использовать команду **IoT Plug and Play: Sign out Model Repository** (Выход из репозитория моделей IoT Plug and Play), чтобы выйти и повторить шаги.

### <a name="use-the-azure-iot-explorer-to-validate-the-code"></a>Проверка кода с помощью обозревателя Azure IoT

1. Откройте обозреватель Центра Интернета вещей Azure. Отобразится страница **конфигураций приложения**.

1. Введите строку подключения к Центру Интернета вещей и щелкните **Подключить**.

1. После подключения откроется страница обзора устройства.

1. Чтобы добавить репозиторий своей компании, выберите **Параметры** и **+ Создать**, а затем — **Company repository** (Корпоративный репозиторий).

1. Добавьте строку подключения к репозиторию моделей компании. Нажмите кнопку **Подключиться**.

1. На странице обзора устройства найдите и выберите созданное ранее удостоверение устройства, чтобы просмотреть более подробную информацию.

1. Разверните интерфейс, указав идентификатор **urn:azureiot:EnvironmentalSensor:1**, чтобы увидеть примитивы IoT Plug and Play: свойства, команды и данные телеметрии.

1. Выберите страницу **Телеметрия**, чтобы просмотреть данные телеметрии, которые отправляет устройство.

1. Выберите страницу **Properties(non-writable)​​** (Свойства (недоступные для записи)), чтобы просмотреть недоступные для записи свойства, сообщаемые устройством.

1. Выберите страницу **Properties(writable)** (Свойства (доступные для записи)), чтобы просмотреть доступные для записи свойства, которые можно обновить.

1. Разверните свойство **name**, укажите в качестве его значения новое имя и выберите **Update writeable property** (Обновить свойство, доступное для записи). 
2. Чтобы увидеть новое имя в столбце **Передаваемое свойство**, нажмите кнопку **Обновить** в верхней части страницы.

1. Выберите страницу **команд**, чтобы просмотреть все команды, поддерживаемые устройством.

1. Разверните команду **​​blink** и установите новый интервал времени мигания. Выберите **Отправить команду**, чтобы вызвать команду на устройстве.

1. Перейдите к имитированному устройству, чтобы проверить, выполнена ли команда должным образом.

## <a name="next-steps"></a>Дополнительная информация

Из этого краткого руководства вы узнали, как создать устройство IoT Plug and Play с помощью DCM.

Чтобы узнать больше о Plug and Play IoT, перейдите к учебнику по

> [!div class="nextstepaction"]
> [созданию и тестированию модели возможностей устройства с помощью Visual Studio Code](tutorial-pnp-visual-studio-code.md)
