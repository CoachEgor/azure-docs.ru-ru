---
title: Подключение к серверу SFTP с помощью SSH-Azure Logic Apps
description: Автоматизация задач, которые отслеживают, создают, отправляют и получают файлы для SFTP-сервера, а также управляют ими с помощью SSH и Azure Logic Apps
services: logic-apps
ms.service: logic-apps
ms.suite: integration
author: ecfan
ms.author: estfan
ms.reviewer: divswa, klam, LADocs
ms.topic: article
ms.date: 06/18/2019
tags: connectors
ms.openlocfilehash: a48ba0d2d691314a1ca7c91ac7ae27b62fbb379b
ms.sourcegitcommit: ac56ef07d86328c40fed5b5792a6a02698926c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73825241"
---
# <a name="monitor-create-and-manage-sftp-files-by-using-ssh-and-azure-logic-apps"></a>Мониторинг и создание SFTP-файлов, а также управление ими с помощью SSH и Azure Logic Apps

Чтобы автоматизировать задачи мониторинга, создания, отправки и получения файлов на сервере [безопасного протокола передачи файлов (SFTP)](https://www.ssh.com/ssh/sftp/) с помощью протокола [SSH](https://www.ssh.com/ssh/protocol/), создайте и автоматизируйте рабочие процессы интеграции с помощью Azure Logic Apps и соединителя SFTP-SSH. SFTP является сетевым протоколом, которому предоставляется доступ к файлам, передаче файлов и управлению файлами на основе надежного потока данных. Ниже приведены некоторые примеры задач, которые можно автоматизировать:

* мониторинг добавления или изменения файлов;
* получение, создание, копирование, переименование, перечисление, обновление и удаление файлов;
* создание папок;
* получение содержимого и метаданных файлов;
* извлечение архивов в папки.

Вы можете использовать триггеры, которые отслеживают события сервера SFTP и делают выходные данные доступными для других действий. Вы можете использовать действия для выполнения различных задач на SFTP-сервере. Кроме того, в вашем приложении логики есть другие действия, которые могут использовать выходные данные действий SFTP. Например, если вы регулярно извлекаете файлы с сервера SFTP, то можете отправлять сообщения оповещений об этих файлах и их содержимое с помощью соединителя Outlook Office 365 или Outlook.com. Если вы не знакомы с приложениями логики, ознакомьтесь со статьей [Что такое Azure Logic Apps](../logic-apps/logic-apps-overview.md).

Сведения о различиях между соединителем SFTP-SSH и соединителем SFTP см. Далее в разделе [Сравнение SFTP-SSH и SFTP](#comparison) .

## <a name="limits"></a>Ограничения

* По умолчанию действия SFTP-SSH могут считывать или записывать файлы, которые имеют *Размер 1 ГБ или меньше* , но только за один раз блоки размером *15 МБ* . Для работы с файлами, превышающими 15 МБ, действия SFTP-SSH поддерживают [фрагментацию сообщений](../logic-apps/logic-apps-handle-large-messages.md), за исключением действия копирование файла, которое может работать только с 15 МБ файлов. Действие **получить содержимое файла** неявно использует фрагменты сообщений.

* SFTP-триггеры SSH не поддерживают фрагментацию. При запросе содержимого файла триггеры выбирают только те файлы, которые имеют размер не менее 15 МБ. Чтобы получить файлы размером более 15 МБ, используйте следующий шаблон:

  * Используйте триггер SFTP-SSH, возвращающий свойства файла, например **при добавлении или изменении файла (только свойства)** .

  * Следуйте указаниям триггера с действием SFTP-SSH **Get File Content** , которое считывает полный файл и неявно использует фрагменты сообщений.

<a name="comparison"></a>

## <a name="compare-sftp-ssh-versus-sftp"></a>Сравнение SFTP-SSH и SFTP

Ниже приведены остальные ключевые различия между соединителями SFTP-SSH и SFTP. Соединитель SFTP-SSH имеет следующие возможности:

* Использует [библиотеку SSH.NET](https://github.com/sshnet/SSH.NET), которая является библиотекой Secure Shell с открытым исходным кодом (SSH), которая поддерживает .NET.

* По умолчанию действия SFTP-SSH могут считывать или записывать файлы, которые имеют *Размер 1 ГБ или меньше* , но только за один раз блоки размером *15 МБ* . Для работы с файлами, превышающими 15 МБ, действия SFTP-SSH могут использовать [фрагменты сообщений](../logic-apps/logic-apps-handle-large-messages.md). Для отправки больших файлов также требуются разрешения на чтение и запись. Однако действие копирование файла поддерживает только 15 МБ файлов, так как это действие не поддерживает фрагментацию сообщений. SFTP-триггеры SSH не поддерживают фрагментацию.

* Предоставляет действие **Создание папки**, которое создает папку по указанному пути на сервере SFTP.

* Предоставляет действие **Переименование файла**, которое переименовывает файл на сервере SFTP.

* Выполняет кэширование подключения к серверу SFTP *продолжительностью до 1 часа*, что повышает производительность и уменьшает количество попыток подключения к серверу. Чтобы указать длительность этого поведения кэширования, измените свойство [**ClientAliveInterval**](https://man.openbsd.org/sshd_config#ClientAliveInterval) в конфигурации SSH на SFTP-сервере.

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, [зарегистрируйтесь для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

* Ваши адреса сервера SFTP и учетные данные учетной записи, которые позволяют приложению логики получать доступ к учетной записи SFTP. Вам также необходим доступ к закрытому ключу SSH и паролю закрытого ключа SSH. Для использования фрагментации при отправке больших файлов требуются разрешения на чтение и запись.

  > [!IMPORTANT]
  >
  > Соединитель SFTP-SSH поддерживает *только* эти закрытые ключи, форматы, алгоритмы и отпечатки пальцев:
  >
  > * **Форматы закрытых ключей**: ключи RSA (Ривест Шамир Адельман) и DSA (алгоритм цифровой подписи) в форматах OpenSSH и SSH.com. Если закрытый ключ находится в формате файла выводимого (. PPK), сначала [преобразуйте ключ в формат файла OpenSSH (PEM)](#convert-to-openssh).
  >
  > * **Алгоритмы шифрования**. DES-EDE3-CBC, DES-EDE3-CFB, DES CBC, AES-128-CBC, AES-192-CBC и AES-256-CBC.
  >
  > * **Отпечаток**. MD5
  >
  > После добавления триггера SFTP или действия, которое требуется для приложения логики, необходимо указать сведения о подключении для сервера SFTP. При предоставлении закрытого ключа SSH для этого подключения ***не вводите и не изменяйте ключ вручную***, что может привести к сбою подключения. Вместо этого необходимо ***скопировать ключ*** из файла закрытого ключа SSH и ***Вставить*** этот ключ в сведения о подключении. 
  > Дополнительные сведения см. в разделе [Подключение к SFTP с помощью SSH далее в](#connect) этой статье.

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

* Приложение логики, из которого необходимо получить доступ к учетной записи SFTP. Чтобы начать работу с триггером SFTP-SSH, [создайте пустое приложение логики](../logic-apps/quickstart-create-first-logic-app-workflow.md). Чтобы использовать действие SFTP-SSH, запустите приложение логики с другим триггером, например триггером **Периодичность**.

## <a name="how-sftp-ssh-triggers-work"></a>Как работают триггеры SFTP-SSH

Протокол SFTP. триггеры SSH работают путем опроса файловой системы SFTP и поиска файла, который был изменен с момента последнего опроса. При изменении файлов некоторые средства позволяют сохранить метку времени. В этом случае необходимо отключить эту функцию, чтобы триггер мог работать. Ниже приведены некоторые распространенные параметры:

| Клиент SFTP | Действие |
|-------------|--------|
| Winscp | Выберите **Параметры** > **Настройки** > **Перенос** > **Изменить** > **Сохранение метки времени** > **Отключить** |
| FileZilla | Выберите **Перенос** > **Preserve timestamps of transferred files** (Сохранение метки времени перенесенных файлов)  > **Отключить**. |
|||

Найдя новый файл, триггер проверяет, записан ли файл полностью, а не частично. Например, во время проверки файлового сервера триггером в файл могут вноситься изменения. Чтобы избежать возврата частично записанного файла, триггер отмечает метку времени для файла с последними изменениями и не возвращает его сразу. Он возвращает его только при повторном опросе сервера. Иногда такое поведение может вызвать задержку, которая удваивает интервал опроса триггера.

<a name="convert-to-openssh"></a>

## <a name="convert-putty-based-key-to-openssh"></a>Преобразование ключа на основе выводимых данных в OpenSSH

Если закрытый ключ имеет формат выводимого, который использует расширение имени файла PPK (выведение закрытого ключа), сначала преобразуйте ключ в формат OpenSSH, который использует расширение имени файла PEM (Privacy Enhanced Mail).

### <a name="unix-based-os"></a>ОС на основе UNIX

1. Если средства выводятся в системе еще не установлены, сделайте это сейчас, например:

   `sudo apt-get install -y putty`

1. Выполните следующую команду, которая создает файл, который можно использовать с соединителем SFTP-SSH:

   `puttygen <path-to-private-key-file-in-PuTTY-format> -O private-openssh -o <path-to-private-key-file-in-OpenSSH-format>`

   Например:

   `puttygen /tmp/sftp/my-private-key-putty.ppk -O private-openssh -o /tmp/sftp/my-private-key-openssh.pem`

### <a name="windows-os"></a>ОС Windows

1. Если вы еще не сделали этого, [скачайте последнюю версию генератора выводимых программных средств (PuTTYgen. exe)](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html), а затем запустите средство.

1. На этом экране нажмите кнопку **загрузить**.

   ![Выбор загрузки](./media/connectors-sftp-ssh/puttygen-load.png)

1. Перейдите к файлу закрытого ключа в формате выводимого файла и выберите **Открыть**.

1. В меню **преобразования** выберите **Экспорт ключа OpenSSH**.

   ![Выберите "экспортировать ключ OpenSSH".](./media/connectors-sftp-ssh/export-openssh-key.png)

1. Сохраните файл закрытого ключа с расширением имени файла `.pem`.

<a name="connect"></a>

## <a name="connect-to-sftp-with-ssh"></a>Подключение к SFTP с помощью SSH

[!INCLUDE [Create connection general intro](../../includes/connectors-create-connection-general-intro.md)]

1. Войдите на [портал Azure](https://portal.azure.com) и откройте свое приложение логики в конструкторе приложений логики, если оно еще не открыто.

1. Для пустых приложений логики в поле поиска в качестве фильтра введите sftp ssh. В списке триггеров выберите нужный триггер.

   -или-

   В имеющихся приложениях логики на последнем шаге, в котором необходимо добавить действие, выберите **Новый шаг**. В поле поиска введите sftp ssh в качестве фильтра. В списке действий выберите любое необходимое действие.

   Чтобы добавить действие между шагами, переместите указатель на стрелку между шагами. Выберите появившийся знак "плюс" ( **+** ), а затем щелкните **Добавить действие**.

1. Укажите необходимые сведения для подключения.

   > [!IMPORTANT]
   >
   > При вводе закрытого ключа SSH в свойстве **закрытого ключа SSH** выполните следующие дополнительные шаги, которые помогут убедиться, что вы предоставили полное и правильное значение для этого свойства. Недопустимый ключ вызывает сбой подключения.

   Несмотря на то, что можно использовать любой текстовый редактор, ниже приведены примеры шагов, которые показывают, как правильно копировать и вставлять в него ключ. Например, с помощью Notepad.exe.

   1. Откройте файл закрытого ключа SSH в текстовом редакторе. В этих шагах Notepad используется в качестве примера.

   1. В меню **Правка** Блокнота выберите **команду выбрать все**.

   1. Выберите **Правка** > **Копировать**.

   1. В триггере SFTP-SSH или действии, которое вы добавили, вставьте *полный* ключ, скопированный в свойство **закрытого ключа SSH**, которое поддерживает несколько строк.  ***Обязательно вставьте*** ключ. ***Не вводите и не изменяйте ключ вручную***.

1. Закончив вводить сведения о подключении, выберите **Создать**.

1. Теперь укажите необходимые сведения для выбранного триггера или действия и продолжайте создание рабочего процесса приложения логики.

## <a name="examples"></a>Примеры

<a name="file-added-modified"></a>

### <a name="sftp---ssh-trigger-when-a-file-is-added-or-modified"></a>Триггер SFTP-SSH. Добавление или изменение файла

Если на сервере SFTP добавлен или изменен файл, триггер запускает рабочий процесс приложения логики. Например, вы можете добавить условие, которое проверяет содержимое файла и получает его в зависимости от того, соответствует ли содержимое указанному условию. Затем вы можете добавить действие, которое получает содержимое файла и помещает его в папку на сервере SFTP.

В **контексте предприятия** можно использовать этот триггер, чтобы отслеживать в папке SFTP новые файлы, представляющие заказы клиентов. Вы также можете использовать действие SFTP **Получить содержимое файла**, чтобы получить содержимое заказа для дальнейшей обработки и хранения в базе данных заказов.

<a name="get-content"></a>

### <a name="sftp---ssh-action-get-content-using-path"></a>SFTP — действие SSH: получение содержимого с помощью пути

Это действие получает содержимое из файла на сервере SFTP. Например, вы можете добавить триггер из предыдущего примера и условие, которому должно соответствовать содержимое файла. Если оно соответствует условию, действие, которое получает содержимое, может выполняться.

## <a name="connector-reference"></a>Справочник по соединителям

Дополнительные технические сведения о триггерах, действиях и ограничениях, которые приведены в описании OpenAPI соединителя (прежнее название — Swagger), можно найти на [странице справки](/connectors/sftpconnector/) соединителя.

## <a name="next-steps"></a>Дальнейшие действия

* См. дополнительные сведения о других [соединителях Logic Apps](../connectors/apis-list.md).
