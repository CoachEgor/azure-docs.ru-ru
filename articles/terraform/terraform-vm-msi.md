---
title: Использование образа Azure Marketplace для создания виртуальной машины Terraform Linux с управляемым удостоверением
description: Используйте образ Marketplace для создания виртуальной машины Terraform Linux с управляемым удостоверением и управлением удаленным состоянием, чтобы легко развертывать ресурсы в Azure.
services: terraform
ms.service: azure
keywords: terraform, devops, MSI, виртуальная машина, удаленное состояние, azure
author: tomarchermsft
manager: jeconnoc
ms.author: tarcher
ms.topic: tutorial
ms.date: 09/20/2019
ms.openlocfilehash: 835170448db8709812ca62ac67f8659b3b6a2807
ms.sourcegitcommit: f2771ec28b7d2d937eef81223980da8ea1a6a531
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/20/2019
ms.locfileid: "71173057"
---
# <a name="use-an-azure-marketplace-image-to-create-a-terraform-linux-virtual-machine-with-managed-identities-for-azure-resources"></a>Использование образа Azure Marketplace для создания виртуальной машины Terraform Linux с управляемым удостоверением для ресурсов Azure

В статье описано, как использовать [образ Terraform из Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/azure-oss.terraform?tab=Overview) для создания виртуальной машины Ubuntu Linux (16.04 LTS) с последней версией [Terraform](https://www.terraform.io/intro/index.html), установленной и настроенной с помощью [управляемых удостоверений для ресурсов Azure](https://docs.microsoft.com/azure/active-directory/managed-service-identity/overview). Этот образ также настраивает удаленный сервер, чтобы включить управление [удаленным состоянием](https://www.terraform.io/docs/state/remote.html) с помощью Terraform. 

С помощью образа Terraform Marketplace можно быстро приступить к работе с Terraform в Azure без необходимости устанавливать и настраивать Terraform вручную. 

Плата за программное обеспечение для образа виртуальной машины Terraform не взимается. Вы платите только за оборудование Azure в зависимости от размера виртуальной машины, которая подготавливается. Дополнительные сведения об оплате вычислительных ресурсов см. на [странице цен на виртуальные машины Linux](https://azure.microsoft.com/pricing/details/virtual-machines/linux/).

## <a name="prerequisites"></a>Предварительные требования
Перед созданием виртуальной машины Linux Terraform необходимо убедиться в наличии подписки Azure. Если у вас ее нет, [создайте бесплатную учетную запись в Azure](https://azure.microsoft.com/free/).  

## <a name="create-your-terraform-virtual-machine"></a>Создание виртуальной машины Terraform 

Ниже приведены шаги по созданию экземпляра виртуальной машины Linux Terraform. 

1. На портале Azure перейдите к списку [Создать ресурс](https://ms.portal.azure.com/#create/hub).

2. В поисковой строке **поиска в Marketplace** выполните поиск по запросу **Terraform**. Выберите шаблон **Terraform**. 

3. На вкладке сведений о Terraform в правом нижнем углу нажмите кнопку **создать**.

    ![Создание виртуальной машины Terraform](media/terraformmsi.png)

4. В следующих разделах приведены входные данные для прохождения всех шагов мастера по созданию виртуальной машины Terraform Linux. В следующем разделе приведены входные данные, необходимые для выполнения настройки на каждом из этих шагов.

## <a name="details-on-the-create-terraform-tab"></a>Сведения на вкладке создания Terraform

Введите следующие данные на вкладке **создания Terraform** .

1. **Основы**
    
   * **Имя**. Имя виртуальной машины Terraform.
   * **Имя пользователя**. Идентификатор для входа первой учетной записи.
   * **Пароль**. Пароль первой учетной записи. (Вместо пароля можно использовать открытый ключ SSH.)
   * **Подписка**: Подписка, в которой будет создана виртуальная машина и за которую будет взиматься плата. Вам необходимо иметь права на создание ресурсов для этой подписки.
   * **Группа ресурсов**. Новая или существующая группа ресурсов.
   * **Расположение**. Наиболее подходящий центр обработки данных. Обычно это центр обработки данных, где размещена большая часть ваших данных, или ближайший к вашему физическому расположению центр для наиболее быстрого доступа к сети.

2. **Дополнительные параметры**

   * **Размер**: Размер виртуальной машины. 
   * **Тип диска виртуальной машины**. SSD или HDD.

3. **Сводка по Terraform**

   * Проверьте, все ли сведения введены правильно. 

4. **Купить**

   * Чтобы начать процесс подготовки, выберите **Купить**. Отобразится ссылка на условия транзакции. За использование виртуальной машины не взимается дополнительная плата, кроме платы за размер сервера, выбранный на шаге "Размер".

Образ виртуальной машины Terraform выполняет следующие шаги:

* Создает виртуальную машину с присвоенным системой идентификатором на основе образа Ubuntu 16.04 LTS.
* Устанавливает на виртуальной машине расширение MSI для обеспечения возможности выдавать токены OAuth для ресурсов Azure.
* Назначает управляемому удостоверению разрешения RBAC, которые предоставляют права владельца группы ресурсов.
* Создает папку шаблона Terraform (tfTemplate).
* Предварительно настраивает удаленное состояние Terraform с сервером Azure.

## <a name="access-and-configure-a-linux-terraform-virtual-machine"></a>Получение доступа и настройка виртуальной машины Linux Terraform

После создания виртуальной машины вы можете войти в нее с помощью протокола SSH. Для входа с помощью интерфейса текстовой оболочки используйте учетную запись, созданную в разделе "Основные сведения" на шаге 3. В Windows можно скачать клиент SSH, например [Putty](https://www.putty.org/).

После подключения к виртуальной машине по SSH управляемым удостоверениям для ресурсов Azure на виртуальной машине нужно предоставить права участника на всю подписку. 

Таким образом с помощью MSI на виртуальной машине можно создавать ресурсы вне группы ресурсов этой машины, используя Terraform. Это можно сделать, выполнив скрипт один раз. Используйте следующую команду:

`. ~/tfEnv.sh`

В предыдущем скрипте для аутентификации в Azure и назначения управляемому удостоверению виртуальной машины прав участника на всю подписку используется механизм [интерактивного входа с помощью Azure CLI 2.0](https://docs.microsoft.com/cli/azure/authenticate-azure-cli?view=azure-cli-latest#sign-in-interactively). 

 У виртуальной машины есть сервер удаленного состояния Terraform. Чтобы включить его в развертывание Terraform, скопируйте файл remoteState.tf из каталога tfTemplate в корень скриптов Terraform.  

 `cp  ~/tfTemplate/remoteState.tf .`

 Дополнительные сведения об управлении удаленным состоянием см. на [этой странице](https://www.terraform.io/docs/state/remote.html). В этом файле предоставляется ключ доступа к хранилищу, который нужно исключить перед фиксацией файлов конфигурации Terraform в системе управления версиями.

## <a name="next-steps"></a>Дополнительная информация
В этой статье вы узнали, как настроить виртуальную машину Terraform Linux в Azure. Ниже приведены ресурсы, содержащие дополнительные сведения о Terraform в Azure. 

 [Terraform в документации по Azure](https://docs.microsoft.com/azure/terraform/)  
 [Документация по поставщику для Terraform Azure](https://aka.ms/terraform)  
 [Документация по разработке поставщика Terraform Azure](https://aka.ms/tfgit)  
 [Модули Terraform Azure](https://aka.ms/tfmodules)
 

















