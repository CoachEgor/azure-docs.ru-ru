---
title: Руководство. Создание виртуальной машины Linux с управляемым удостоверением из образа Azure Marketplace с помощью Terraform
description: Создание виртуальной машины Linux Terraform с управляемым удостоверением и Удаленным управлением состоянием с помощью образа Azure Marketplace
ms.service: terraform
author: tomarchermsft
ms.author: tarcher
ms.topic: tutorial
ms.date: 11/07/2019
ms.openlocfilehash: 233012d6caf1280914a6d2439ae856d69570fff7
ms.sourcegitcommit: 35715a7df8e476286e3fee954818ae1278cef1fc
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73838052"
---
# <a name="tutorial-create-a-linux-vm-with-a-managed-identity-from-the-azure-marketplace-image-using-terraform"></a>Руководство по созданию виртуальной машины Linux с управляемым удостоверением из образа Azure Marketplace с помощью Terraform

В статье описано, как использовать [образ Terraform из Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/azure-oss.terraform?tab=Overview) для создания виртуальной машины Ubuntu Linux (16.04 LTS) с последней версией [Terraform](https://www.terraform.io/intro/index.html), установленной и настроенной с помощью [управляемых удостоверений для ресурсов Azure](/azure/active-directory/managed-service-identity/overview). Этот образ также настраивает удаленный сервер, чтобы включить управление [удаленным состоянием](https://www.terraform.io/docs/state/remote.html) с помощью Terraform. 

С помощью образа Terraform Marketplace можно быстро приступить к работе с Terraform в Azure без необходимости устанавливать и настраивать Terraform вручную. 

Плата за программное обеспечение для образа виртуальной машины Terraform не взимается. Плата за использование оборудования Azure начисляется в зависимости от размера подготовленной виртуальной машины. 

Дополнительные сведения об оплате вычислительных ресурсов см. на [странице цен на виртуальные машины Linux](https://azure.microsoft.com/pricing/details/virtual-machines/linux/).

## <a name="prerequisites"></a>Предварительные требования
Перед созданием виртуальной машины Linux Terraform, необходимо убедиться в наличии подписки Azure. Если у вас ее нет, [создайте бесплатную учетную запись в Azure](https://azure.microsoft.com/free/).  

## <a name="create-your-terraform-vm"></a>Создание виртуальной машины Terraform 

Ниже приведены шаги по созданию экземпляра виртуальной машины Linux Terraform. 

1. На портале Azure перейдите к списку [Создать ресурс](https://ms.portal.azure.com/#create/hub).

1. В поисковой строке **поиска в Marketplace** выполните поиск по запросу **Terraform**. 

1. Нажмите **Создать**. 

1. В следующих разделах приведены входные данные для прохождения всех шагов мастера по созданию виртуальной машины Terraform Linux. В следующем разделе приведены входные данные, необходимые для выполнения настройки на каждом из этих шагов.

## <a name="details-on-the-create-terraform-tab"></a>Сведения на вкладке создания Terraform

Введите следующие данные на вкладке **создания Terraform** .

1. **Основы**
    
   * **Имя.** Имя виртуальной машины Terraform.
   * **Имя пользователя.** Идентификатор для входа первой учетной записи.
   * **Пароль**. Пароль первой учетной записи. (Вместо пароля можно использовать открытый ключ SSH.)
   * **Подписка**: Подписка, в которой будет создана виртуальная машина и за которую будет взиматься плата. Вам необходимо иметь права на создание ресурсов для этой подписки.
   * **Группа ресурсов**. Новая или существующая группа ресурсов.
   * **Расположение**. Наиболее подходящий центр обработки данных. Обычно это центр обработки данных, где размещена большая часть ваших данных, или ближайший к вашему физическому расположению центр для наиболее быстрого доступа к сети.

2. **Дополнительные параметры**

   * **Размер**: Размер виртуальной машины. 
   * **Тип диска виртуальной машины**. SSD или HDD.

3. **Сводка по Terraform**

   * Проверьте, все ли сведения введены правильно. 

4. **Купить**

   * Чтобы начать процесс подготовки, выберите **Купить**. Отобразится ссылка на условия транзакции. За использование виртуальной машины не взимается дополнительная плата, кроме платы за размер сервера, выбранный на шаге "Размер".

Образ виртуальной машины Terraform выполняет следующие шаги:

* Создает виртуальную машину с присвоенным системой идентификатором на основе образа Ubuntu 16.04 LTS.
* Устанавливает расширение "управляемые удостоверения для ресурсов Azure" на виртуальной машине, чтобы позволить выдачу токенов OAuth для ресурсов Azure.
* Назначает управляемому удостоверению разрешения RBAC, которые предоставляют права владельца группы ресурсов.
* Создает папку шаблона Terraform (tfTemplate).
* Предварительно настраивает удаленное состояние Terraform с сервером Azure.

## <a name="access-and-configure-a-linux-terraform-vm"></a>Настройка виртуальной машины Linux Terraform и доступ к ней

После создания виртуальной машины выполните указанные ниже действия.

1. Войдите на виртуальную машину с помощью SSH. Используйте учетные данные, созданные в предыдущем разделе. В Windows можно скачать клиент SSH, например [Putty](https://www.putty.org/).

1. Предоставьте разрешения участника для всей подписки на управляемые удостоверения для ресурсов Azure на виртуальной машине. 

    Таким образом с помощью управляемого удостоверения для ресурсов Azure на виртуальной машине можно создавать ресурсы вне группы ресурсов этой машины, используя Terraform. Для этого выполните следующий сценарий. 
    
    ```bash
    . ~/tfEnv.sh
    ```

    Этот сценарий использует [Интерактивный вход Azure CLI](/cli/azure/authenticate-azure-cli?view=azure-cli-latest#sign-in-interactively) для аутентификации в Azure. Этот процесс назначает [Разрешение "Участник управляемого удостоверения"](/azure/role-based-access-control/built-in-roles#managed-identity-contributor) для всей подписки. 

1. У виртуальной машины есть сервер удаленного состояния Terraform. Чтобы включить его в развертывание Terraform, скопируйте файл `remoteState.tf` в корень сценариев Terraform.

    ```bash
    cp  ~/tfTemplate/remoteState.tf .
    ```

    Дополнительные сведения об Управлении удаленным состоянием см. на странице [Terraform remote state](https://www.terraform.io/docs/state/remote.html) (Удаленное состояние Terraform). Ключ доступа к хранилищу представлен в этом файле. Перед фиксацией файлов конфигурации Terraform в системе управления версиями их следует исключить.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"] 
> [Документация по Terraform в Azure](/azure/terraform)