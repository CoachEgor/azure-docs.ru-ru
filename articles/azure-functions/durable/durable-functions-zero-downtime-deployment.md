---
title: Развертывание нулевого времени для долгосрочных функций
description: Узнайте, как включить согласование долговременных функций для развертывания с нулевым простоем.
author: tsushi
ms.topic: conceptual
ms.date: 10/10/2019
ms.author: azfuncdf
ms.openlocfilehash: 8e12d58c0077084c181d111b0b017665b74b9157
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74231258"
---
# <a name="zero-downtime-deployment-for-durable-functions"></a>Развертывание нулевого времени для долгосрочных функций

Надежная [модель выполнения](durable-functions-checkpointing-and-replay.md) функций durable functions требует детерминационной детерминации, что создает дополнительную проблему для рассмотрения при развертывании обновлений. При развертывании содержится изменение подписей функции действия или логики оркестратора, экземпляры оркестровки в полете сходят на нет. Эта ситуация является особенно актуальной для случаев длительных согласований, которые могут представлять собой часы или дни работы.

Чтобы предотвратить эти сбои, у вас есть два варианта: 
- Отложите развертывание до завершения всех запущенных экземпляров оркестровки.
- Убедитесь, что в любых запущенных экземплярах оркестровки используются существующие версии ваших функций. 

> [!NOTE]
> В этой статье содержатся рекомендации для приложений для функций, ориентированных на функции durable 1.x. Он не был обновлен для учета изменений, внесенных в функции durable 2.x. Для получения дополнительной информации о различиях между версиями расширения [см.](durable-functions-versions.md)

На следующей диаграмме сравниваются три основные стратегии для достижения развертывания с нулевым простоем для долгосрочных функций: 

| Стратегия |  Назначение | Плюсы | Минусы |
| -------- | ------------ | ---- | ---- |
| [Управление версиями](#versioning) |  Приложения, которые не испытывают частых [изменений.](durable-functions-versioning.md) | Простой в реализации. |  Увеличение размера приложения функции в памяти и количество функций.<br/>Дублирование кода. |
| [Проверка состояния с слотом](#status-check-with-slot) | Система, которая не имеет длительных оркестровок продолжительностью более 24 часов или часто перекрывающейся оркестровки. | Простая кодовая база.<br/>Не требует дополнительного управления функциями приложения. | Требуется дополнительная учетная запись хранения или управление концентратором задач.<br/>Требуется период времени, когда не работает оркестровка. |
| [Разгром приложений](#application-routing) | Система, которая не имеет периодов времени, когда оркестровки не работают, например, те периоды времени с оркестровкой, которые длятся более 24 часов или с часто перекрывающимися оркестровками. | Обрабатывает новые версии систем с постоянно запускаемыми, которые имеют нарушения. | Требуется интеллектуальный маршрутизатор приложений.<br/>Может быть max out число функциональных приложений, разрешенных вашей подпиской. Значение по умолчанию — 100. |

## <a name="versioning"></a>Управление версиями

Определите новые версии своих функций и оставьте старые версии в приложении функции функции. Как вы можете видеть на диаграмме, версия функции становится частью ее названия. Поскольку предыдущие версии функций сохраняются, экземпляры оркестровки в полете могут продолжать ссылаться на них. В то же время запросы на новые экземпляры оркестровки требуют последней версии, на которую функция клиента оркестровки может ссылаться из настройки приложения.

![Стратегия версий](media/durable-functions-zero-downtime-deployment/versioning-strategy.png)

В этой стратегии каждая функция должна быть скопирована, а ее ссылки на другие функции должны быть обновлены. Вы можете сделать это проще, написав сценарий. Вот пример [проекта](https://github.com/TsuyoshiUshio/DurableVersioning) со скриптом миграции.

>[!NOTE]
>Эта стратегия использует слоты развертывания, чтобы избежать простоя во время развертывания. Для получения более подробной информации о том, [Azure Functions deployment slots](../functions-deployment-slots.md)как создавать и использовать новые слоты развертывания, см.

## <a name="status-check-with-slot"></a>Проверка состояния с слотом

В то время как текущая версия приложения функции функции работает в производственном слоте, развернуть новую версию приложения функции в постановочном слоте. Перед заменой производственных и постановочных слотов проверьте, есть ли какие-либо запущенные экземпляры оркестровки. После того, как все случаи оркестровки завершены, вы можете сделать своп. Эта стратегия работает, когда у вас есть предсказуемые периоды, когда нет случаев оркестровки в полете. Это лучший подход, когда ваши оркестровки не являются длительными и когда выполнение оркестровки часто не перекрывается.

### <a name="function-app-configuration"></a>Конфигурация приложения функции

Для настройки этого сценария используйте следующую процедуру.

1. [Добавьте слоты развертывания](../functions-deployment-slots.md#add-a-slot) в приложение функции для постановки и производства.

1. Для каждого слота установите [настройку приложения AzureWebJobsStorage](../functions-app-settings.md#azurewebjobsstorage) в строку подключения общей учетной записи хранилища. Эта строка подключения к учетной записи хранилища используется во время выполнения программы Azure Functions. Эта учетная запись используется временем выполнения функций Azure и управляет ключами функции.

1. Для каждого слота создайте новую настройку приложения, например, `DurableManagementStorage`. Установите его значение строке соединения различных учетных записей хранения. Эти учетные записи хранения используются расширением Durable Functions для [надежного выполнения.](durable-functions-checkpointing-and-replay.md) Используйте отдельный учет хранения для каждого слота. Не помечайте эту настройку как настройку слота развертывания.

1. В [разделе прочная задача файла host.json файла](durable-functions-bindings.md#hostjson-settings)функции — укажите `azureStorageConnectionStringName` как имя настройки приложения, созданного в шаге 3.

На следующей диаграмме показана описанная конфигурация слотов развертывания и учетных записей хранения. В этом потенциальном сценарии предразвертывания версия 2 приложения функции работает в производственном слоте, в то время как версия 1 остается в слоте постановки.

![Слоты развертывания и учетные записи хранения](media/durable-functions-zero-downtime-deployment/deployment-slot.png)

### <a name="hostjson-examples"></a>примеры host.json

Следующие фрагменты JSON являются примерами настройки строки соединения в файле *host.json.*

#### <a name="functions-20"></a>Функции 2.0

```json
{
  "version": 2.0,
  "extensions": {
    "durableTask": {
      "azureStorageConnectionStringName": "DurableManagementStorage"
    }
  }
}
```

#### <a name="functions-1x"></a>Функции 1.x

```json
{
  "durableTask": {
    "azureStorageConnectionStringName": "DurableManagementStorage"
  }
}
```

### <a name="cicd-pipeline-configuration"></a>Конфигурация конвейера CI/CD

Наверстуйте конвейер CI/CD для развертывания только в том случае, если приложение функции не имеет ожидающих или запущенных экземпляров оркестровки. При использовании трубопроводов Azure можно создать функцию, которая проверяет эти условия, как в следующем примере:

```csharp
[FunctionName("StatusCheck")]
public static async Task<IActionResult> StatusCheck(
    [HttpTrigger(AuthorizationLevel.Function, "get", "post")] HttpRequestMessage req,
    [OrchestrationClient] DurableOrchestrationClient client,
    ILogger log)
{
    var runtimeStatus = new List<OrchestrationRuntimeStatus>();

    runtimeStatus.Add(OrchestrationRuntimeStatus.Pending);
    runtimeStatus.Add(OrchestrationRuntimeStatus.Running);

    var status = await client.GetStatusAsync(new DateTime(2015,10,10), null, runtimeStatus);
    return (ActionResult) new OkObjectResult(new Status() {HasRunning = (status.Count != 0)});
}
```

Затем настроите промежуточные ворота, чтобы подождать, пока не будут запущены оркестровки. Для получения дополнительной [Release deployment control using gates](/azure/devops/pipelines/release/approvals/gates?view=azure-devops) информации см.

![Шлюз развертывания](media/durable-functions-zero-downtime-deployment/deployment-gate.png)

Azure Pipelines проверяет приложение функции для выполнения экземпляров оркестровки до начала развертывания.

![Ворота развертывания (запуск)](media/durable-functions-zero-downtime-deployment/deployment-gate-2.png)

Теперь новая версия приложения функции функции должна быть развернута в постановочном слоте.

![Постановочная слот](media/durable-functions-zero-downtime-deployment/deployment-slot-2.png)

Наконец, поменяйте слоты. 

Настройки приложений, которые не помечены как настройки слота развертывания, также заменены, поэтому приложение версии 2 сохраняет ссылку на учетную запись хранения A. Поскольку состояние оркестровки отслеживается в учетной записи хранилища, любые оркестровки, работающие в приложении версии 2, продолжают работать в новом слоте без перерыва.

![Слот развертывания](media/durable-functions-zero-downtime-deployment/deployment-slot-3.png)

Чтобы использовать одну и ту же учетную запись хранилища для обоих слотов, можно изменить имена концентраторов задач. В этом случае необходимо управлять состоянием слотов и настройками HubName вашего приложения. Чтобы узнать больше, смотрите [концентраторы задач в функционал.](durable-functions-task-hubs.md)

## <a name="application-routing"></a>Разгром приложений

Эта стратегия является наиболее сложной. Тем не менее, он может быть использован для функциональных приложений, которые не имеют времени между запуском оркестровки.

Для этой стратегии необходимо создать *маршрутизатор приложений* перед вашими функциями. Этот маршрутизатор может быть реализован с помощью функций durable. Маршрутизатор несет ответственность за:

* Развертывание приложения функции.
* Управление версией функций длительного пользования. 
* Запросы на согласование маршрутов для функции приложений.

При первом получении запроса на согласование маршрутизатор выполняет следующие задачи:

1. Создает новое приложение функции в Azure.
2. Развертывает код приложения в новое приложение функции в Azure.
3. Направляет запрос на оркестровку в новое приложение.

Маршрутизатор управляет состоянием, какая версия кода приложения развернута, в какую функцию приложения в Azure.

![Разгром приложения (первый раз)](media/durable-functions-zero-downtime-deployment/application-routing.png)

Маршрутизатор направляет запросы на развертывание и оркестровку в соответствующее приложение функции на основе версии, отправленной с запросом. Он игнорирует версию патча.

При развертывании новой версии приложения без изменения, вы можете приравнить версию патча. Маршрутизатор развертывается в существующем приложении функции и отправляет запросы на старые и новые версии кода, которые направляются в одно и то же приложение функции.

![Разгром приложений (без изменения)](media/durable-functions-zero-downtime-deployment/application-routing-2.png)

При развертывании новой версии приложения с нарушением изменения можно приравнить основную или незначительную версию. Затем маршрутизатор приложения создает новое приложение функции в Azure, развертывает его и направляет запросы на новую версию приложения. На следующей диаграмме запуск оркестровки на версии приложения 1.0.1 продолжает работать, но запросы на версию 1.1.0 направляются в новое приложение функции.

![Разгром приложений (нарушение изменения)](media/durable-functions-zero-downtime-deployment/application-routing-3.png)

Маршрутизатор отслеживает состояние оркестровки на версии 1.0.1 и удаляет приложения после завершения всех согласований. 

### <a name="tracking-store-settings"></a>Отслеживание настроек магазина

Каждое приложение функции должно использовать отдельные очереди планирования, возможно, в отдельных учетных записях хранилища. Если требуется задать запрос во всех случаях оркестровки во всех версиях приложения, можно обмениваться таблицами экземпляров и истории в функциональных приложениях. Вы можете поделиться таблицами, настроив настройки `trackingStoreConnectionStringName` и `trackingStoreNamePrefix` настройки в [файле настроек host.json](durable-functions-bindings.md#host-json) таким образом, чтобы все они использовали одни и те же значения.

Для получения дополнительной [информации см.](durable-functions-instance-management.md)

![Отслеживание настроек магазина](media/durable-functions-zero-downtime-deployment/tracking-store-settings.png)

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Версия долговечных функций](durable-functions-versioning.md)

