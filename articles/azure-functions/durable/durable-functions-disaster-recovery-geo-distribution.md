---
title: Аварийное восстановление и географическое распределение в устойчивых функциях — Azure
description: Узнайте об аварийном восстановлении и географическом распределении в устойчивых функциях.
services: functions
author: MS-Santi
manager: jeconnoc
keywords: ''
ms.service: azure-functions
ms.devlang: multiple
ms.topic: conceptual
ms.date: 04/25/2018
ms.author: azfuncdf
ms.openlocfilehash: 1363dd3c620789b9f3c8ce1dbe0892ee61d66051
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "60741380"
---
# <a name="disaster-recovery-and-geo-distribution"></a>Аварийное восстановление и географическое распределение

## <a name="overview"></a>Обзор

В Устойчивых функциях все состояния сохраняются в службе хранилища Azure. [Центр задач](durable-functions-task-hubs.md) — это логический контейнер для ресурсов службы хранилища Azure, которые используются для оркестрации. Функции оркестраторов и действий могут взаимодействовать друг с другом, только когда они принадлежат к одному центру задач.
Описанные сценарии предлагают варианты развертывания для повышения уровня доступности и минимизации времени простоя в процессе аварийного восстановления.

Важно заметить, что эти сценарии основаны на конфигурации "активный — пассивный", так как они ориентированы на использование службы хранилища Azure. В этом шаблоне выполняется развертывание резервной копии (пассивного) приложения-функции в другой регион. Диспетчер трафика будет отслеживать доступность основного (активного) приложения-функции. Если основное приложение выйдет из строя, будет выполнена отработка отказа в резервную копию приложения-функции. Дополнительные сведения см. в разделе [Метод маршрутизации трафика по приоритету](../../traffic-manager/traffic-manager-routing-methods.md#priority-traffic-routing-method) статьи о [диспетчере трафика](https://azure.microsoft.com/services/traffic-manager/).

>[!NOTE]
>
> - Предложенная конфигурация "активный — пассивный" гарантирует, что у клиента всегда будет возможность активировать новую оркестрацию через протокол HTTP. Тем не менее, в результате наличия двух приложений-функций в одном хранилище фоновая обработка будет распределена между ними, конкурируя за сообщения в одной очереди. Эта конфигурация учитывает дополнительные затраты на исходящий трафик для дополнительного приложения.
> - Основная учетная запись хранения и центр задач создаются в основном регионе и совместно используются обоими приложениями-функциями.
> - Все приложения-функции, которые развертываются дополнительно, должны совместно использовать одинаковые ключи доступа к функции в случае активации через HTTP. Среда выполнения функций предоставляет [API управления](https://github.com/Azure/azure-functions-host/wiki/Key-management-API), который позволяет потребителям программно добавлять, удалять и обновлять ключи функций.

## <a name="scenario-1---load-balanced-compute-with-shared-storage"></a>Сценарий 1. Распределение нагрузки вычислений при использовании общего хранилища

Если в Azure происходит сбой инфраструктуры вычисления, приложение-функция может стать недоступным. Чтобы свести к минимуму вероятность такого простоя, в этом сценарии используются два приложения-функции, развернутые в разных регионах.
Диспетчер трафика настроен обнаруживать проблемы в основном приложении-функции и автоматически перенаправлять трафик в приложение-функцию во вторичном регионе. Приложения-функции совместно используют одну учетную запись службы хранилища Azure и центр задач. Таким образом состояние приложений-функций не будет потеряно и работу можно возобновить в обычном режиме. Когда работоспособность в основном регионе восстанавливается, диспетчер траффика Azure автоматически направляет запросы к этому приложению-функции.

![Схема, демонстрирующая сценарий 1.](./media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario01.png)

Этот сценарий развертывания обладает несколькими преимуществами:

- Если происходит сбой вычислительной инфраструктуры, работу можно возобновить в регионе отработки отказа без потери состояния.
- Диспетчер трафика выполняет отработку отказа в работоспособное приложение-функцию автоматически.
- Диспетчер трафика автоматически настраивает направление трафика к основному приложению-функции после устранения сбоя.

Тем не менее, при использовании этого сценария учтите следующее:

- Если приложение-функция развертывается с помощью выделенного плана службы приложений, репликация инфраструктуры вычислений в центр обработки данных для отработки отказа увеличивает затраты.
- Этот сценарий охватывает сбои в инфраструктуре вычислений, но учетная запись хранилища остается единственной точкой отказа для приложения-функции. Если нет доступа к хранилищу, в приложении происходит простой.
- При отработке отказа приложения-функции будет увеличена задержка, так как оно будет получать доступ к своей учетной записи хранилища между регионами.
- Доступ приложения к службе хранения не из того региона, в котором он находится, влечет за собой более высокие затраты из-за исходящего трафика.
- Этот сценарий зависит от диспетчера трафика. Учитывая, [как работает диспетчер трафика](../../traffic-manager/traffic-manager-how-it-works.md), может потребоваться некоторое время, прежде чем клиентскому приложению, которое потребляет устойчивые функции, снова потребуется запрашивать адрес приложения-функции из диспетчера трафика.

## <a name="scenario-2---load-balanced-compute-with-regional-storage"></a>Сценарий 2. Распределение нагрузки вычислений при использовании регионального хранилища

В предыдущем сценарии рассматриваются только случаи сбоя в инфраструктуре вычислений. Если происходит сбой службы хранилища, это приведет к сбою приложения-функции.
Для обеспечения непрерывной работы устойчивых функций в этом сценарии используется локальная учетная запись хранения для каждого региона, в котором развернуто приложение-функция.

![Схема, демонстрирующая сценарий 2.](./media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario02.png)

Этот подход добавляет улучшения в предыдущий сценарий:

- При сбое приложения-функции диспетчер трафика выполняет отработку отказа в дополнительный регион. Тем не менее, так как приложение-функция использует собственную учетную запись хранения, устойчивые функции будут продолжать работать.
- Во время отработки отказа отсутствует дополнительная задержка в регионе, куда выполняется отработка отказа, так как приложение-функция и учетная запись хранения находятся в одном расположении.
- Сбой уровня хранилища приведет к сбоям в устойчивых функциях, что, в свою очередь, активирует перенаправление в регион отработки отказа. Опять же, так как приложение-функция и хранилище изолированы в регионе, устойчивые функции будут продолжать работать.

Что следует учитывать при работе с данным сценарием:

- Если приложение-функция развертывается с помощью выделенного плана службы приложений, репликация инфраструктуры вычислений в центр обработки данных для отработки отказа увеличивает затраты.
- Отработка отказа текущего состояния не выполняется, что означает, что функции выполнения и установки контрольных точек не будут работать. Повторные попытки или перезапуск работы зависят от клиентского приложения.

## <a name="scenario-3---load-balanced-compute-with-grs-shared-storage"></a>Сценарий 3. Распределение нагрузки вычислений при использовании общего хранилища GRS

Этот сценарий является модификацией первого сценария, использующего общую учетную запись хранения. Основное отличие заключается в том, что учетная запись хранения создается с включенной георепликацией.
С функциональной точки зрения этот сценарий предоставляет те же преимущества, что и сценарий 1, но он обеспечивает дополнительные преимущества восстановления данных:

- Геоизбыточное хранилище (GRS) и геоизбыточное хранилище с доступом на чтение (RA-GRS) максимально увеличивают доступность учетной записи хранения.
- Если в обслуживании службы хранилища в регионе произойдет сбой, одна из возможностей заключается в том, что операции центра обработки данных определяют, что для хранилища нужно выполнить отработку отказа в дополнительный регион. В этом случае запросы на доступ к учетной записи хранения будут прозрачно перенаправлены к ее геореплицированной копии без вмешательства пользователя.
- В этом случае состояние устойчивых функций будет сохранено на момент последней репликации учетной записи хранения, которая происходит каждые несколько минут.

Как и в других сценариях, есть важные сведения, которые нужно учитывать:

- Отработка отказа в реплику выполняется операторами центра обработки данных и может занять некоторое время. До этого времени приложение-функция не будет работать.
- За использование учетных записей хранения с географической репликацией взимается увеличенная плата.
- Репликация в геоизбыточное хранилище происходит асинхронно. Некоторые последние транзакции могут быть потерны из-за задержки процесса репликации.

![Схема, демонстрирующая сценарий 3.](./media/durable-functions-disaster-recovery-geo-distribution/durable-functions-geo-scenario03.png)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в статье [Проектирование высокодоступных приложений с использованием RA-GRS](../../storage/common/storage-designing-ha-apps-with-ragrs.md).
