---
title: Производительность и масштабирование в устойчивых функциях — Azure
description: Общие сведения о расширении устойчивых функций для Функций Azure.
author: cgillum
ms.topic: conceptual
ms.date: 11/03/2019
ms.author: azfuncdf
ms.openlocfilehash: 260811c4ae15b45de6f7bc1b22e3ed6dcea44259
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79277912"
---
# <a name="performance-and-scale-in-durable-functions-azure-functions"></a>Производительность и масштабирование в устойчивых функциях (Функции Azure)

Чтобы оптимизировать производительность и масштабирование, важно понять уникальные характеристики масштабирования [устойчивых функций](durable-functions-overview.md).

Чтобы понять реакции на события масштабирования, необходимо изучить некоторые сведения о базовом поставщике службы хранилища Azure.

## <a name="history-table"></a>Таблица журнала

Таблица **журнала** — это таблица службы хранилища Azure, содержащая события журнала для всех экземпляров оркестрации внутри центра задач. Имя этой таблицы — указывается в формате журнала *TaskHubName*. При выполнении экземпляров в таблицу добавляются новые строки. Ключ раздела этой таблицы является производным от идентификатора экземпляра оркестрации. В большинстве случаев экземпляр идентификатора является случайным, что обеспечивает оптимальное распределение внутренних разделов в службе хранилища Azure.

Когда необходимо выполнить экземпляр оркестрации, в память загружаются нужные строки таблицы журнала. Затем эти *события журнала* воспроизводятся в коде функции оркестратора, чтобы вернуть их в предыдущее состояние из контрольной точки. Использование журнала выполнения для перестройки состояния, является путем, обусловленным [шаблоном источников событий](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).

## <a name="instances-table"></a>Экземпляры таблицы

Таблица **Instances** — это еще одна таблица хранения Azure, содержащая статусы всех экземпляров оркестровки и сущности в концентраторе задач. При создании экземпляров в таблицу добавляются новые строки. Ключом раздела этой таблицы является идентификатор экземпляра оркестровки или ключ сущности, а ключ строки — фиксированной константой. Существует одна строка на оркестровку или экземпляр сущности.

Эта таблица используется для удовлетворения `GetStatusAsync` запросов запросов `getStatus` запросов экземпляров из API (.NET) и (JavaScript), а также [запроса состояния HTTP API.](durable-functions-http-api.md#get-instance-status) В конечном итоге она поддерживается в соответствии с содержанием таблицы **Журнала**, упомянутой ранее. Использование отдельных таблиц хранилища Azure для эффективного удовлетворения операций запроса экземпляров, является путем, обусловленным [шаблоном CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs).

## <a name="internal-queue-triggers"></a>Триггеры внутренней очереди

Функции оркестратора и действия активируются внутренними очередями в учетной записи хранения центра задач приложения-функции. Такое использование очередей обеспечивает надежные гарантии доставки сообщений, как минимум один раз. Существует два типа очередей в устойчивых функциях: очередь **управления** и **очередь рабочих элементов**.

### <a name="the-work-item-queue"></a>Очередь рабочих элементов

В устойчивых функциях на каждый центр задач приходится одна очередь рабочих элементов. Это основная очередь, и ее поведение аналогично любым другим очередям `queueTrigger` в Функциях Azure. Эта очередь используется для активации *функций действий* путем вывода только одного сообщения за один раз. Каждое из этих сообщений содержит входные данные функции действия и дополнительные метаданные, например, какую функцию выполнять. Когда приложение устойчивых функций масштабируется до нескольких виртуальных машин, все они конкурируют за получение работы из очереди рабочих элементов.

### <a name="control-queues"></a>Очередь управления

В устойчивых функциях на каждый центр задач имеется несколько *очередей управления*. *Очередь управления* является более сложной, чем очередь рабочих элементов. Очереди управления используются для запуска функций оркестратора состояния и сущности. Поскольку экземпляры функции оркестратора и сущности являются государственными синглтонами, невозможно использовать конкурируюую модель потребителя для распределения нагрузки по VMs. Вместо этого сообщения оркестратора и сущности сбалансированы по пересчету контрольных очередей. Дополнительные сведения об этом поведении можно найти в последующих разделах.

Очереди управления содержат различные типы сообщений жизненного цикла оркестрации. Примеры включают [сообщения об управлении оркестрацией](durable-functions-instance-management.md), сообщения *ответа* функции действия и сообщения таймера. За один опрос из очереди управления может быть удалено до 32 сообщений. Эти сообщения содержат полезные данные, а также метаданные, включая экземпляр оркестрации, для которого они предназначены. Если для одного и того же экземпляра оркестрации предназначены несколько сообщений удаленных из очереди, они будут обрабатываться как пакет.

### <a name="queue-polling"></a>Очередные опросы

Долгосрочное расширение задачи реализует случайный экспоненциальный алгоритм резервного копирования, чтобы уменьшить влияние опроса без простоя на транзакционные затраты на хранение. При обнаружении сообщения время выполнения немедленно проверяется на наличие другого сообщения; когда сообщение не найдено, оно ждет некоторое время, прежде чем снова попытаться. После последующих неудачных попыток получить сообщение очереди время ожидания продолжает увеличиваться до достижения максимального времени ожидания, которое по умолчанию составляет 30 секунд.

Максимальная задержка опроса настраивается `maxQueuePollingInterval` через свойство в [файле host.json.](../functions-host-json.md#durabletask) Установка этого свойства на более высокое значение может привести к более высокой обработке сообщений. Более высокие прослушка будут ожидаться только после периодов бездействия. Установка этого свойства на более низкое значение может привести к увеличению затрат на хранение из-за увеличения транзакций хранения.

> [!NOTE]
> При запуске в планах потребления функций Azure и Premium [контроллер шкалы функций Azure](../functions-scale.md#how-the-consumption-and-premium-plans-work) будет опрашивать каждую очередь управления и элементов работы один раз в 10 секунд. Этот дополнительный опрос необходим для определения того, когда активировать экземпляры приложения функций и принимать масштабные решения. На момент написания статьи этот 10-секундный интервал является постоянным и не может быть настроен.

## <a name="storage-account-selection"></a>Выбор учетной записи хранения

Очереди, таблицы и капли, используемые функциями durable Functions, создаются в настроенной учетной записи хранения Azure. Используемая учетная запись может `durableTask/storageProvider/connectionStringName` быть `durableTask/azureStorageConnectionStringName` указана с помощью настройки (или настройки в течение длительного периода функций 1.x) в файле **host.json.**

### <a name="durable-functions-2x"></a>Долгосрочные функции 2.x

```json
{
  "extensions": {
    "durableTask": {
      "storageProvider": {
        "connectionStringName": "MyStorageAccountAppSetting"
      }
    }
  }
}
```

### <a name="durable-functions-1x"></a>Долгосрочные функции 1.x

```json
{
  "extensions": {
    "durableTask": {
      "azureStorageConnectionStringName": "MyStorageAccountAppSetting"
    }
  }
}
```

Если значение не указано, учетная запись `AzureWebJobsStorage` используется по умолчанию. Однако, для рабочих нагрузок, требующих высокой производительности, рекомендуется настроить учетную запись хранения, кроме используемой по умолчанию. Устойчивые функции сильно полагаются на хранилище Azure и используют отдельную учетную запись хранения для изоляции использования хранилища устойчивых функций узлом функций Azure.

## <a name="orchestrator-scale-out"></a>Развертывание оркестратора

Функции действий не отслеживают состояние и автоматически масштабируются путем добавления виртуальных машин. Функции и сущности оркестратора, с другой стороны, *разделены* между одной или несколько контрольными очередями. Число очередей управления определено в файле **host.json**. Следующий пример фрагмент host.json `durableTask/storageProvider/partitionCount` устанавливает свойство (или `durableTask/partitionCount` в долгосрочных функциях 1.x) на `3`.

### <a name="durable-functions-2x"></a>Долгосрочные функции 2.x

```json
{
  "extensions": {
    "durableTask": {
      "storageProvider": {
          "partitionCount": 3
      }
    }
  }
}
```

### <a name="durable-functions-1x"></a>Долгосрочные функции 1.x

```json
{
  "extensions": {
    "durableTask": {
      "partitionCount": 3
    }
  }
}
```

Центр задач может быть настроен в диапазоне от 1 до 16 секций. Если значение не задано, по умолчанию количеству секций соответствует значение **4**.

При развертывании нескольких экземпляров узлов функции (обычно на разных виртуальных машинах) каждый экземпляр блокируется на одной из очередей управления. Эти блокировки интернированные входят в аренду хранилища капли и гарантируют, что экземпляр или сущность оркестровки выполняется только на одном экземпляре хоста одновременно. Если концентратор задач настроен с тремя очередями управления, экземпляры и объекты оркестровки могут быть сбалансированы нагрузкой на целых три ВМ. Для повышения емкости выполнения функции действия можно добавить дополнительные виртуальные машины.

На схеме ниже показано взаимодействие узла Функций Azure с сущностями хранилища в развернутой среде.

![Схема масштабирования](./media/durable-functions-perf-and-scale/scale-diagram.png)

Как показано на предыдущей схеме, все виртуальные машины могут конкурировать за сообщения в очереди рабочих элементов. Тем не менее получать сообщения из очередей управления могут только три виртуальные машины, и каждая из них блокирует одиночную очередь управления.

Случаи оркестровки и сущности распределены по всем случаям очереди управления. Распределение выполняется путем хэширования идентификатора экземпляра оркестровки или имени сущности и пары ключей. Иди цид окреации по умолчанию являются случайными GUID, гарантируя, что экземпляры будут равномерно распределены по всем контрольным очередям.

Как правило, функции оркестратора должны быть упрощенными, поэтому они не должны требовать больших вычислительных мощностей. Поэтому нет необходимости создавать большое количество разделов очереди управления, чтобы получить большую пропускную выливку для оркестровки. Большая часть работы должна выполняться в функциях действий без отслеживания состояния, которые можно масштабировать бесконечно.

## <a name="auto-scale"></a>Автомасштабирование

Как и все функции Azure, работающие в планах Потребления и Упругой Премиум, компании Durable Functions поддерживают автоматическое масштабирование через [контроллер azure Functions.](../functions-scale.md#runtime-scaling) Контроллер масштабирования занимается мониторингом задержки всех очередей, периодически выполняя команды _peek_. Основываясь на задержках просматриваемых сообщений, контроллер масштабирования будет решать, следует ли добавлять или удалять виртуальные машины.

Если контроллер масштабирования определит что задержка от сообщения очереди управления слишком большая, он будет увеличивать количество экземпляров виртуальных машин пока она не вернется до приемлемого уровня или достигнет максимального количества разделов очереди управления. Аналогичным образом контроллер масштабирования будет непрерывно добавлять экземпляры виртуальных машин в случае если задержки в очереди на рабочих элементах слишком большие, независимо от количества разделов.

> [!NOTE]
> Начиная с функций Durable 2.0, функциональные приложения могут быть настроены для работы в конечных точках службы, защищенных VNET, в плане Elastic Premium. В этой конфигурации функции «Долговечные функции» инициируют запросы масштаба вместо контроллера масштаба.

## <a name="thread-usage"></a>Использование потока

Функции оркестратора выполняются в одном потоке, чтобы убедится, что выполнение можно детерминировать на множество воспроизведений. Так как выполнение является однопоточным, очень важно, чтобы потоки функции оркестратора по любой причине не выполняли задачи, интенсивно использующие ЦП, операции ввода-вывода или блокировку. Все операции, которым может потребоваться ввод-вывод, блокировка или несколько потоков, должны выполняться с помощью функций действий.

Функции действий имеют такие же реакции на события, как и регулярные активируемые очередью функции. Они могут безопасно выполнять операции ввода-вывода, операции с интенсивным потреблением ЦП и использовать несколько потоков. Так как триггеры действия не отслеживают состояние, они могут свободно масштабироваться на неограниченное количество виртуальных машин.

Функции сущности также выполняются на одном потоке, а операции обрабатываются один за раз. Однако функции сущности не имеют каких-либо ограничений на тип кода, который может быть выполнен.

## <a name="concurrency-throttles"></a>Регулирование параллелизма

Функции Azure поддерживают параллельное выполнение нескольких функций в рамках одного экземпляра приложения. Параллельное выполнение помогает улучшить параллелизм и минимизировать число холодного запуска, с которым со времени столкнется стандартное приложение. Тем не менее, высокая параллель может исчерпать на-VM системных ресурсов, таких как сетевые соединения или доступной памяти. В зависимости от потребностей приложения функции, может потребоваться отрегулировать параллелизм для каждого экземпляра, чтобы избежать возможности исчерпания памяти в ситуациях с высокой нагрузкой.

Ограничения на согласование функций активности, оркестратора и функции сущности могут быть настроены в файле **host.json.** Соответствующие настройки `durableTask/maxConcurrentActivityFunctions` относятся `durableTask/maxConcurrentOrchestratorFunctions` к функциям деятельности и как для функций оркестратора, так и для сущности.

### <a name="functions-20"></a>Функции 2.0

```json
{
  "extensions": {
    "durableTask": {
      "maxConcurrentActivityFunctions": 10,
      "maxConcurrentOrchestratorFunctions": 10
    }
  }
}
```

### <a name="functions-1x"></a>Функции 1.x

```json
{
  "durableTask": {
    "maxConcurrentActivityFunctions": 10,
    "maxConcurrentOrchestratorFunctions": 10
  }
}
```

В предыдущем примере не более 10 функций оркестратора или сущности и 10 функций активности могут выполняться одновременно на одном VM. Если не указано, количество параллельных действий и выполнения функций оркестранта или сущности ограничено 10X числом ядер на VM.

> [!NOTE]
> Эти параметры полезны для управления памятью и использованием ЦП на одной виртуальной машине. Однако при масштабировании по нескольким ВМ каждый VM имеет свой собственный набор ограничений. Эти параметры не могут быть использованы для управления параллелизмом на глобальном уровне.

## <a name="extended-sessions"></a>Расширенные сеансы

Расширенные сеансы — это параметр, который сохраняет в памяти оркестровки и сущности даже после завершения обработки сообщений. Распространенным эффектом от включения расширенных сеансов является сокращение операций ввода-вывода с использованием учетной записи службы хранения Azure и повсеместное улучшение пропускной способности.

Вы можете включить расширенные `durableTask/extendedSessionsEnabled` `true` сеансы, установив в файле **host.json.** Настройка `durableTask/extendedSessionIdleTimeoutInSeconds` может быть использована для контроля, как долго простаивает сеанс будет проводиться в памяти:

**Функции 2.0**
```json
{
  "extensions": {
    "durableTask": {
      "extendedSessionsEnabled": true,
      "extendedSessionIdleTimeoutInSeconds": 30
    }
  }
}
```

**Функции 1.0**
```json
{
  "durableTask": {
    "extendedSessionsEnabled": true,
    "extendedSessionIdleTimeoutInSeconds": 30
  }
}
```

Есть два потенциальных недостатка этого параметра, чтобы быть в курсе:

1. Общее увеличение использования памяти функционального приложения.
2. Возможно общее снижение пропускной выхажины, если есть много одновременных, недолговечных выполнения функций оркестранта или сущности.

Например, если `durableTask/extendedSessionIdleTimeoutInSeconds` он установлен на 30 секунд, то недолговечный эпизод функции оркестратора или сущности, который выполняется менее чем за 1 секунду, по-прежнему занимает память в течение 30 секунд. Он также учитывает `durableTask/maxConcurrentOrchestratorFunctions` указанную квоту, упомянутую ранее, потенциально предотвращая работу других функций оркестратора или сущности.

Конкретные эффекты расширенных сессий для функций оркестратора и сущности описаны в следующих разделах.

### <a name="orchestrator-function-replay"></a>Повторение функции оркестратора

Как было упомянуто ранее, функции оркестратора воспроизводятся с помощью содержимого таблицы **Журнал**. По умолчанию код функции оркестратора воспроизводится каждый раз, когда пакет сообщений удаляется из очереди управления. Даже если вы используете фан-аут, шаблон фан-ин и ожидаете выполнения всех `Task.WhenAll` задач (например, с помощью .NET или `context.df.Task.all` JavaScript), будут повторы, которые происходят по мере обработки пакетов ответов задач с течением времени. При включении расширенных сеансов экземпляры функции оркестратора удерживаются в памяти дольше, а новые сообщения могут обрабатываться без полного воспроизведения истории.

Улучшение производительности расширенных сессий чаще всего наблюдается в следующих ситуациях:

* При одновременном согласовании имеется ограниченное число экземпляров оркестровки.
* При согласовании имеется большое количество последовательных действий (например, сотни вызовов функций активности), которые выполняются быстро.
* При организации вентилятора и вентилятора в большое количество действий, которые завершают примерно в то же время.
* Когда функции оркестратора должны обрабатывать большие сообщения или делать любую обработку данных с интенсивным процессором.

Во всех других ситуациях, как правило, нет заметного улучшения производительности для функций оркестратора.

> [!NOTE]
> Эти параметры следует использовать только после того, как функция оркестратора будет полностью разработана и протестирована. Агрессивное поведение воспроизведения по умолчанию может быть полезно для обнаружения нарушений [кодов функций функции оркестранта](durable-functions-code-constraints.md) во время разработки и, следовательно, отключено по умолчанию.

### <a name="entity-function-unloading"></a>Разгрузка функции сущности

Функции сущности обрабатывают до 20 операций в одной партии. Как только сущность завершает обработку партии операций, она сохраняет свое состояние и выгружается из памяти. Вымотать объекты из памяти можно с помощью расширенной настройки сеансов. Сущности продолжают сохранять свои изменения состояния, как и раньше, но остаются в памяти в течение настроенного периода времени, чтобы уменьшить количество нагрузок из хранилища Azure. Такое уменьшение нагрузок из хранилища Azure может улучшить общую пропускную связь часто доступных объектов.

## <a name="performance-targets"></a>Цели анализа производительности

Планируя использовать устойчивые функции в рабочем приложении, на раннем этапе планирования необходимо учесть требования к производительности. В этом разделе рассматриваются некоторое основные сценарии использования и ожидаемое максимальной число пропускной способности.

* **Выполнение последовательного действия**. В этом сценарии описывается функция оркестратора, которая по очереди выполняет ряд функций действия. Максимально похожим на этот сценарий является [цепочка функции](durable-functions-sequence.md).
* **Параллельное выполнение одного действия**. В этом сценарии описано действие оркестратора, которое выполняет множество функций действий параллельно, с помощью шаблона [развертывания, слияния](durable-functions-cloud-backup.md).
* **Параллельная обработка ответа**. Этот сценарий является второй половиной шаблона [развертывания, слияния](durable-functions-cloud-backup.md). Этот раздел посвящен производительность слияния. Важно отметить, что в отличие от развертывания, слияние создается единым экземпляром функции а затем может быть запущено на единой виртуальной машине.
* **Обработка внешних событий**. В этом сценарии представлено единый экземпляр функции оркестратора, который последовательно ожидает [внешних событий](durable-functions-external-events.md).
* **Обработка операций сущности**: Этот сценарий проверяет, как быстро _одна_ [сущность Counter](durable-functions-entities.md) может обрабатывать постоянный поток операций.

> [!TIP]
> В отличие от развертывания, операции слияния могут размещаться только на одной виртуальной машине. Если ваше приложение использует шаблоны развертывания и слияния, и вы беспокоитесь через производительность развертывания, необходимо рассмотреть разделение действия функции развертывания на несколько [вложенных оркестраций](durable-functions-sub-orchestrations.md).

В следующей таблице показаны ожидаемые *максимальные* показателей пропускной способности для сценариев, описанных ранее. Термин "экземпляр" относиться к единому экземпляру функции оркестратора, запущенной на небольшом экземпляре виртуальной машины ([серии A1](../../virtual-machines/sizes-previous-gen.md)) в службе приложений Azure. Во всех случаях предполагается, что [расширенные сеансы](#orchestrator-function-replay) включены. Фактические результаты могут варьировать, в зависимости от ЦП или ввода-вывода, выполняемых кодом функции.

| Сценарий | Максимальная пропускная способность |
|-|-|
| Выполнение последовательного действия | 5 действий на экземпляр в секунду |
| Параллельное выполнение одного действия (при развертывании) | 100 действий на экземпляр в секунду |
| Параллельная обработка ответа (при слиянии) | 150 ответов на экземпляр в секунду |
| Обработка внешних событий | 50 событий на экземпляр в секунду |
| Обработка операций сущности | 64 операции в секунду |

> [!NOTE]
> Эти номера являются текущими по сравнению с выпуском расширения устойчивых функций v1.4.0 (GA). Со временем эти числа могут изменятся (по мере роста функции и оптимизации).

Если вы не видите показателей пропускной способности, и ваш ЦП и использование памяти отображаются в работоспособном состоянии, проверьте, описаны ли эти случаи в разделе [рекомендации по устранению неполадок](../../storage/common/storage-monitoring-diagnosing-troubleshooting.md#troubleshooting-guidance). Расширение устойчивых функций может существенно увеличить нагрузку на учетную запись службы хранения Azure, что при достаточно высоких загрузках может привести к регулированию учетной записи.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Узнайте о аварийном восстановлении и геораспределении](durable-functions-disaster-recovery-geo-distribution.md)
