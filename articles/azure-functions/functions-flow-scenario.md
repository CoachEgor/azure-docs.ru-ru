---
title: Вызов функции Azure из Microsoft Flow | Документация Майкрософт
description: Создание пользовательского соединителя и вызов функции с его помощью.
services: functions
keywords: облачные приложения, облачные службы, Microsoft Flow, бизнес-процессы, бизнес-приложение
author: ggailey777
manager: jeconnoc
ms.assetid: ''
ms.service: azure-functions
ms.topic: conceptual
ms.date: 12/14/2017
ms.author: glenga
ms.reviewer: sunayv
ms.custom: ''
ms.openlocfilehash: d3e777b5611dec382dc4eaaac5ec1594abcdab31
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65787674"
---
# <a name="call-a-function-from-microsoft-flow"></a>Вызов функции из Microsoft Flow

[Microsoft Flow](https://flow.microsoft.com/) позволяет легко автоматизировать рабочие и бизнес-процессы между избранными приложениями и службами. Профессиональные разработчики могут расширить возможности Microsoft Flow с помощью Функций Azure. Благодаря этому разработчикам последовательностей не нужно вникать в технические детали.

В рамках этой статьи вы создадите поток для обслуживания ветряных турбин. Здесь показано, как вызвать функцию, определенную в статье [Создание определения OpenAPI функции](functions-openapi-definition.md). Функция определяет экономичность аварийного ремонта ветроэлектрической установки. Если это экономически оправдано, поток отправит рекомендации по ремонту на электронную почту.

Сведения о вызове этой же функции из PowerApps вы найдете в статье [Вызов функции из PowerApps](functions-powerapps-scenario.md).

В этой статье:

> [!div class="checklist"]
> * создавать список в SharePoint;
> * импортировали определения API;
> * добавили подключения к API;
> * создавать поток для отправки электронной почты, если ремонт экономически оправдан;
> * запускать потоки.

[!INCLUDE [functions-openapi-note](../../includes/functions-openapi-note.md)]

## <a name="prerequisites"></a>Технические условия

+ Активная [учетная запись Microsoft Flow](https://flow.microsoft.com/documentation/sign-up-sign-in/) с такими же учетными данными, что и в учетной записи Azure. 
+ Сайт SharePoint, который используется в качестве источника данных для этого потока. Зарегистрируйтесь для использования [пробной версии Office 365](https://signup.microsoft.com/Signup?OfferId=467eab54-127b-42d3-b046-3844b860bebf&dl=O365_BUSINESS_PREMIUM&ali=1), если у вас нет SharePoint.
+ Выполните шаги, описанные в руководстве [Создание определения OpenAPI функции](functions-openapi-definition.md).

## <a name="create-a-sharepoint-list"></a>Создание списка SharePoint
Для начала вам нужно создать список, который будет использоваться в качестве источника данных для потока. Ниже перечислены столбцы этого списка.

| Столбец списка     | Тип данных           | Примечания                                    |
|-----------------|---------------------|------------------------------------------|
| **Заголовок**           | Одна строка текста | Имя турбины                      |
| **Дата_последнего_обслуживания** | Дата                |                                          |
| **Максимальная_мощность**       | Number              | Мощность турбины в кВт/ч            |
| **Требуется_обслуживание** | Да/нет              |                                          |
| **Ожидаемые_затраты** | Number              | Предполагаемое время для восстановления, в часах |

1. На сайте SharePoint нажмите кнопку **Создать**, затем **Список**.

    ![Создание нового списка SharePoint](./media/functions-flow-scenario/new-list.png)

2. Введите имя `Turbines`, затем нажмите кнопку **Создать**.

    ![Укажите имя для нового списка](./media/functions-flow-scenario/create-list.png)

    Список **Турбины** создается с заданным по умолчанию полем **Заголовок**.

    ![Список турбин](./media/functions-flow-scenario/initial-list.png)

3. Щелкните ![значок нового элемента](./media/functions-flow-scenario/icon-new.png), а затем выберите **Дата**.

    ![Добавление строки в текстовое поле](./media/functions-flow-scenario/add-column.png)

4. Введите имя `LastServiceDate`, затем нажмите кнопку **Создать**.

    ![Создание столбца Дата_последнего_обслуживания](./media/functions-flow-scenario/date-column.png)

5. Повторите последние два шага для других трех столбцов в списке:

    1. **Число** > "Максимальная_мощность"

    2. **Да/Нет** > "Требуется_обслуживание"

    3. **Число** > "Ожидаемые_затраты"

Пока это все. Ваш пустой список должен выглядеть так, как показано на следующем рисунке. Данные в список вы будете добавлять после создания потока.

![Пустой список](media/functions-flow-scenario/empty-list.png)

[!INCLUDE [Export an API definition](../../includes/functions-export-api-definition.md)]

## <a name="add-a-connection-to-the-api"></a>Добавление подключения к API
В Microsoft Flow доступен пользовательский API-интерфейс (пользовательский соединитель). Чтобы использовать его в последовательности, к нему нужно подключиться.

1. На странице [flow.microsoft.com](https://flow.microsoft.com) щелкните значок шестеренки (в правом верхнем углу), а затем щелкните **Подключения**.

    ![Подключения потока](media/functions-flow-scenario/flow-connections.png)

1. Щелкните **Создать подключение**, прокрутите вниз до соединителя **Ремонт турбин** и выберите его.

    ![Создание подключения](media/functions-flow-scenario/create-connection.png)

1. Введите ключ API и нажмите кнопку **Создать подключение**.

    ![Введите ключ API и запустите создание](media/functions-flow-scenario/api-key.png)

> [!NOTE]
> Если поток используется совместно с другими пользователями, каждый, кто работает с этим потоком, должен также ввести ключ API, чтобы подключиться к API. Это поведение может измениться в будущем. В связи с этим мы обновим этот раздел.


## <a name="create-a-flow"></a>Создание потока

Теперь все готово для создания потока, в котором применяется пользовательский соединитель и созданный вами ранее список SharePoint.

### <a name="add-a-trigger-and-specify-a-condition"></a>Добавление триггера и выбор условия

Сначала создайте пустой поток (без шаблона), а затем добавьте *триггер*, который срабатывает при создании элемента в списке SharePoint. Затем добавьте *условие*, в котором будет определено следующее действие.

1. На странице [flow.microsoft.com](https://flow.microsoft.com) выберите **Мои потоки**, а затем — **Создать с нуля**.

    ![Создание с нуля](media/functions-flow-scenario/create-from-blank.png)

2. Щелкните триггер SharePoint **При создании элемента**.

    ![Выбор триггера](media/functions-flow-scenario/choose-trigger.png)

    Если вы еще не вошли в SharePoint, вы увидите запрос на вход.

3. Для параметра **Адрес узла** укажите имя сайта SharePoint, а в качестве значения параметра **Имя списка** укажите список, который содержит данные о турбинах.

    ![Выбор триггера](media/functions-flow-scenario/site-list.png)

4. Нажмите кнопку **Новый шаг**, а затем — **Добавить условие**.

    ![Добавить условие](media/functions-flow-scenario/add-condition.png)

    Microsoft Flow добавляет последовательность две ветви: **Если Да** и **Если**. Вы сможете добавить шаги в любую из этих ветвей, когда определите условие.

    ![Ветви условия](media/functions-flow-scenario/condition-branches.png)

5. На карте **Условие** щелкните первое поле, а затем выберите **Требуется_обслуживание** в диалоговом окне **Динамическое содержимое**.

    ![Выбор поля для условия](media/functions-flow-scenario/condition1-field.png)

6. Введите для этого условия значение `True`.

    ![Ввод значения true для условия](media/functions-flow-scenario/condition1-yes.png)

    В списке SharePoint это значение отображается как `Yes` или `No`, но оно хранится в виде *логического значения*, то есть `True` или `False`. 

7. Щелкните **Создание соединителя** в верхней части страницы. Не забывайте регулярно выполнять действие **Обновить поток**.

Для всех элементов, создаваемых в нашем списке, этот поток проверяет значение параметра **Требуется_обслуживание**. Если это `Yes`, он переходит к ветви **Да**, а в противном случае — к ветви **Нет**. Чтобы сэкономить время, в этом разделе мы создадим действия только для ветви **Да**.

### <a name="add-the-custom-connector"></a>Добавление пользовательского соединителя

Теперь вы создадите пользовательский соединитель, который вызывает функцию в Azure. Пользовательский соединитель добавляется в поток точно так же, как и стандартный соединитель. 

1. В ветви **Да** щелкните **Добавить действие**.

    ![Добавление действия](media/functions-flow-scenario/condition1-yes-add-action.png)

2. В диалоговом окне **Выбор действия** выполните поиск по запросу `Turbine Repair`, затем выберите действие **Turbine Repair - Calculates costs** (Восстановление турбины: расчет стоимости).

    ![Выбор действия](media/functions-flow-scenario/choose-turbine-repair.png)

    На следующем рисунке представлена карта, добавляемая в поток. Поля и описания взяты из определения OpenAPI для соединителя.

    ![Карта по умолчанию для вычисления затрат](media/functions-flow-scenario/calculates-costs-default.png)

3. На карте **Вычисление стоимости** выберите входящие данные для функции с помощью диалогового окна **Динамическое содержимое**. Microsoft Flow отображает здесь числовые поля, но не отображает поля даты, поскольку в определении OpenAPI поля **Часы** и **Мощность** имеют числовой тип.

    Для поля **часы** выберите **Ожидаемые_затраты**, а для поля **Мощность**выберите **Максимальная_мощность**.

    ![Выбор действия](media/functions-flow-scenario/calculates-costs-fields.png)

     Теперь добавьте новое условие, которое проверяет результат выполнения функции.

4. В нижней части ветви **Да** щелкните **Дополнительно**, а затем — **Добавить условие**.

    ![Добавить условие](media/functions-flow-scenario/condition2-add.png)

5. На карте **Условие 2** щелкните первое поле, а затем выберите **Сообщение** в диалоговом окне **Динамическое содержимое**.

    ![Выбор поля для условия](media/functions-flow-scenario/condition2-field.png)

6. Введите значение `Yes`. Поток перейдет к следующей ветви **Да** или **Нет** в зависимости от того, возвратит ли эта функция сообщение "Да" (выполнить ремонт) или "Нет" (не нужно выполнять ремонт). 

    ![Ввод значения "Да" для условия](media/functions-flow-scenario/condition2-yes.png)

Теперь поток должен выглядеть, как на изображении ниже.

![Ввод значения "Да" для условия](media/functions-flow-scenario/flow-checkpoint1.png)

### <a name="send-email-based-on-function-results"></a>Отправка письма по электронной почте в зависимости от результатов выполнения функции

На этом этапе потока функция возвращает из функции **сообщение** со значением `Yes` или `No`, а также дополнительные сведения о затратах и потенциальных доходах. В ветви **Да** для второго условия настройте отправку сообщения электронной почты. Здесь можно выполнить множество разных действий, например записать новые данные в список SharePoint или запустить [процесс утверждения](https://flow.microsoft.com/documentation/modern-approvals/).

1. В ветви **Да** для второго условия щелкните **Добавить действие**.

    ![Добавление действия](media/functions-flow-scenario/condition2-yes-add-action.png)

2. В диалоговом окне **Выбор действия** выполните поиск по запросу `email`, затем выберите действие отправки электронной почты, которое применимо для вашей системы электронной почты (в нашем примере это Outlook).

    ![Отправка сообщения электронной почты через Outlook](media/functions-flow-scenario/outlook-send-email.png)

3. На карте **Отправка сообщения электронной почты** создайте шаблон сообщения. В поле **Кому** введите имя пользователя из своей организации. Как видно на следующем изображении, остальные поля заполняются сочетаниями текста и токенов из диалогового окна **Динамическое содержимое**. 

    ![Поля сообщения электронной почты](media/functions-flow-scenario/email-fields.png)

    Токен **Заголовок** поступает из списка SharePoint, а **Стоимость_ремонта** и **Возможность_дохода** возвращаются функцией.

    Готовый поток должен выглядеть так, как на следующем рисунке (мы исключили первую ветвь **Нет** для экономии места).

    ![Готовый поток](media/functions-flow-scenario/complete-flow.png)

4. Щелкните **Обновить поток**  в верхней части страницы, затем щелкните **Готово**.

## <a name="run-the-flow"></a>Запуск потока

Теперь, когда наш поток готов, добавьте строку в список SharePoint и понаблюдайте реакцию этого потока.

1. Вернитесь к списку SharePoint и нажмите кнопку **Быстрое редактирование**.

    ![Быстрое редактирование](media/functions-flow-scenario/quick-edit.png)

2. Введите в сетку редактирования приведенные ниже значения.

    | Столбец списка     | Значение           |
    |-----------------|---------------------|
    | **Заголовок**           | Турбина 60 |
    | **Дата_последнего_обслуживания** | 08/04/2017 |
    | **Максимальная_мощность**       | 2500 |
    | **Требуется_обслуживание** | Да |
    | **Ожидаемые_затраты** | 10 |

3. Нажмите кнопку **Done**(Готово).

    ![Завершение быстрого редактирования](media/functions-flow-scenario/quick-edit-done.png)

    Когда вы добавляете элемент, срабатывает триггер потока, который вы можете увидеть на следующем шаге.

4. На странице [flow.microsoft.com](https://flow.microsoft.com) нажмите **Мои потоки**, а затем выберите созданный ранее поток.

    ![Мои потоки](media/functions-flow-scenario/my-flows.png)

5. В разделе **ЖУРНАЛ ВЫПОЛНЕНИЯ** нажмите кнопку выполнения потока.

    ![Журнал выполнения](media/functions-flow-scenario/run-history.png)

    Если выполнение прошло успешно, на следующей странице вы увидите операции потока. Если выполнение завершилось ошибкой, на следующей странице отобразится информация об устранении неполадок.

6. Разверните карточки, чтобы увидеть все события при выполнении потока. Например, разверните карточку **Вычисление стоимости**, чтобы просмотреть входные и выходные данные функции. 

    ![Входные и выходные данные для вычисления стоимости](media/functions-flow-scenario/calculates-costs-outputs.png)

7. Проверьте учетную запись электронной почты, адрес которой вы указали в поле **Кому** в карте **Отправка сообщения электронной почты**. Письмо, отправленное из этого потока, должно выглядеть, как на изображении ниже.

    ![Сообщение из потока](media/functions-flow-scenario/flow-email.png)

    Вы увидите, что все токены заменены правильными значениями из списка SharePoint и результатов выполнения функции.

## <a name="next-steps"></a>Дальнейшие действия
В этой статье вы выполнили следующие действия:

> [!div class="checklist"]
> * создавать список в SharePoint;
> * импортировали определения API;
> * добавили подключения к API;
> * создавать поток для отправки электронной почты, если ремонт экономически оправдан;
> * запускать потоки.

Дополнительные сведения о Microsoft Flow вы найдете в статье [Начало работы с Microsoft Flow](https://flow.microsoft.com/documentation/getting-started/).

Дополнительные сведения о других сценариях использования Функций Azure см. в статьях [Вызов функции из PowerApps](functions-powerapps-scenario.md) и [Создание функции, интегрируемой с Azure Logic Apps](functions-twitter-email.md).
