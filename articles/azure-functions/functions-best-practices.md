---
title: Рекомендации по Функциям Azure
description: Ознакомьтесь с рекомендациями и шаблонами для Функций Azure.
ms.assetid: 9058fb2f-8a93-4036-a921-97a0772f503c
ms.topic: conceptual
ms.date: 12/17/2019
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: a41a5828a82d81c5e7e8749fee70cd15e17bb9d0
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79277782"
---
# <a name="optimize-the-performance-and-reliability-of-azure-functions"></a>Оптимизация производительности и надежности Функций Azure

В этой статье описано, как повысить производительность и надежность [бессерверных](https://azure.microsoft.com/solutions/serverless/) приложений-функций.  

## <a name="general-best-practices"></a>Общие рекомендации

Ниже приведены рекомендации по созданию и разработке бессерверных решений с помощью службы "Функции Azure".

### <a name="avoid-long-running-functions"></a>Избегайте длительных функций

Крупные длительные функции могут вызывать непредвиденные проблемы времени ожидания. Чтобы узнать больше о тайм-аутах для [function app timeout duration](functions-scale.md#timeout)данного плана хостинга, см. 

Функция может стать большой из-за многих зависимостей Node.js. Импорт зависимостей может также привести к замедлению загрузки, что, в свою очередь, приводит к непредвиденным проблемам времени ожидания. Зависимости можно загрузить явно и неявно. Один модуль, загруженный в коде, может загрузить собственные дополнительные модули. 

По возможности выполняйте рефакторинг крупных функций и перерабатывайте их на более мелкие совместимые наборы функций, которые работают сообща и быстро возвращают ответ. Например, функция триггера Webhook или HTTP может потребовать ответа на подтверждение в течение определенного срока; обычно веб-крючки требуют немедленного ответа. Полезные данные триггера HTTP можно передать в очередь для обработки с помощью функции триггера очереди. Такой подход позволяет отложить фактическую работу и немедленно отреагировать.


### <a name="cross-function-communication"></a>Взаимодействие функций

[Устойчивые функции](durable/durable-functions-overview.md) и [Azure Logic Apps](../logic-apps/logic-apps-overview.md) используются для управления переходами состояний и обмена данными между несколькими функциями.

Если для интеграции с несколькими функциями нет функций длительного или логических приложений, лучше всего использовать очереди хранения для межфункциональных коммуникаций. Основная причина заключается в том, что очереди хранения дешевле и гораздо проще в предоставлении, чем другие варианты хранения. 

Размер отдельных сообщений в очереди хранилища ограничен до 64 КБ. Если между функциями нужно передать сообщения большего размера, можно использовать очередь служебной шины Azure, которая поддерживает сообщения размером до 256 КБ на уровне "Стандартный" и 1 МБ на уровне "Премиум".

Если перед обработкой сообщений их нужно отфильтровать, ознакомьтесь со статьями о служебной шине.

Для поддержки обмена крупными сообщениями используются Центры событий.


### <a name="write-functions-to-be-stateless"></a>Создавайте функции без отслеживания состояния 

По возможности функции должны быть без отслеживания состояния и идемпотентными. Свяжите любые необходимые сведения о состоянии со своими данными. Например, с обрабатываемым заказом скорее всего будет связан элемент `state`. Функция может обработать заказ, основываясь на этом состоянии, но в ней самой при этом не отслеживается состояние. 

Идемпотентные функции рекомендуется использовать с триггерами таймера. Например, если у вас есть что-то, что абсолютно необходимо запустить один раз в день, напишите его, чтобы он мог работать в любое время в течение дня с теми же результатами. Функция может выйти, когда нет работы в течение определенного дня. Кроме того, если предыдущее выполнение завершилось ошибкой, следующее выполнение должно начаться с прерванного момента.


### <a name="write-defensive-functions"></a>Создавайте защищенные функции

Предположим, что в любое время в функции может возникнуть исключение. Реализуйте в функции возможность продолжения с предыдущей точки сбоя во время следующего выполнения. Давайте рассмотрим сценарий, в котором необходимо сделать следующее:

1. Запрос на 10 000 строк в базе данных.
2. Создать сообщение очереди для каждой из этих строк для дальнейшей обработки.
 
В зависимости от сложности вашей системы, вы можете иметь: участие ниже по течению услуг ведет себя плохо, сетевые перебои, или ограничения по квотам достигнута, и т.д. Все это может повлиять на вашу функцию в любое время. Функции необходимо подготавливать к таким проблемам.

Как отреагирует ваш код при сбое после вставки 5000 элементов в очередь для обработки? Отслеживайте элементы в наборе, работа с которым завершена. В противном случае их можно вставить позже. Эта двойная вставка может иметь серьезное влияние на ваш рабочий поток, так что [сделайте ваши функции идемпотентными.](functions-idempotent.md) 

Если элемент очереди уже обработан, разрешите холостой цикл выполнения функции.

Воспользуйтесь предоставленными возможностями защиты для компонентов, используемых на платформе Функций Azure. Например, ознакомьтесь с разделом **Обработка подозрительных сообщений очереди** в документации по [триггерам и привязкам очереди службы хранилища Azure](functions-bindings-storage-queue-trigger.md#poison-messages). 

## <a name="scalability-best-practices"></a>Рекомендации по масштабируемости

Существует ряд факторов, влияющих на масштаб приложений вашей функции. Дополнительные сведения см. в документации по [масштабированию функций](functions-scale.md).  Ниже приведены рекомендации по оптимальному масштабированию приложения-функции.

### <a name="share-and-manage-connections"></a>Управление подключениями и общий доступ к ним

Повторное использование подключений к внешним ресурсам, когда это возможно. См. раздел [Способы управления подключениями в службе "Функции Azure"](./manage-connections.md).

### <a name="avoid-sharing-storage-accounts"></a>Избегайте совместного использования учетных записей хранения

При создании приложения функции необходимо связать его с учетной записью хранения. Подключение учетной записи хранилища поддерживается в [настройках приложения AzureWebJobsStorage.](./functions-app-settings.md#azurewebjobsstorage) 

[!INCLUDE [functions-shared-storage](../../includes/functions-shared-storage.md)]

### <a name="dont-mix-test-and-production-code-in-the-same-function-app"></a>Не используйте тестовый и рабочий код в одном приложении-функции

Функции в приложении-функции совместно используют ресурсы. Например, память. Если приложение-функция используется в рабочей среде, не добавляйте в нее тестовые функции и ресурсы. Это может вызвать непредвиденные затраты во время выполнения кода в рабочей среде.

Следите за тем, что вы загружаете в рабочие приложения-функции. Память усредняется для каждой функции в приложении.

Если у вас есть общая сборка, на которая ссылаются несколько функций .NET, поместите ее в общую общую папку. В противном случае можно случайно развернуть несколько версий одного и того же двоичного файла, которые ведут себя по-разному между функциями.

Не используйте многословную запись в производственном коде, что оказывает негативное влияние на производительность.

### <a name="use-async-code-but-avoid-blocking-calls"></a>Использование асинхронного кода без блокирующих вызовов

Асинхронное программирование является рекомендуемой наилучшей практикой, особенно при блокировании операций ввоза/от.

В C, всегда избегайте ссылки на свойство `Result` или метод вызова `Wait` на экземпляре. `Task` Применение этого подхода может привести к нехватке потоков.

[!INCLUDE [HTTP client best practices](../../includes/functions-http-client-best-practices.md)]

### <a name="use-multiple-worker-processes"></a>Используйте несколько рабочих процессов

По умолчанию любой экземпляр хоста для Функций использует один рабочий процесс. Для повышения производительности, особенно при однопоточном времени выполнения, таких как Python, используйте [FUNCTIONS_WORKER_PROCESS_COUNT](functions-app-settings.md#functions_worker_process_count) для увеличения количества рабочих процессов на участок (до 10). Затем Azure Functions пытается равномерно распределить одновременные вызовы функций между этими сотрудниками. 

В FUNCTIONS_WORKER_PROCESS_COUNT применяется к каждому узлам, который создает Функции при масштабировании приложения для удовлетворения спроса. 

### <a name="receive-messages-in-batch-whenever-possible"></a>По возможности получайте сообщения в пакетном режиме

Некоторые триггеры, например триггер концентратора событий, позволяют получать сообщения в пакетном режиме в рамках одного вызова.  Пакетная обработка сообщений обеспечивает более высокую производительность.  Вы можете настроить максимальный размер пакета в файле `host.json`, как описано в [справочной документации по host.json](functions-host-json.md).

Для функций C', вы можете изменить тип на сильно типированный массив.  Например, вместо `EventData sensorEvent` можно использовать сигнатуру метода `EventData[] sensorEvent`.  Для других языков необходимо четко установить свойство кардинальности `function.json` `many` в вашем для того, чтобы включить пакетирование, [как показано здесь.](https://github.com/Azure/azure-webjobs-sdk-templates/blob/df94e19484fea88fc2c68d9f032c9d18d860d5b5/Functions.Templates/Templates/EventHubTrigger-JavaScript/function.json#L10)

### <a name="configure-host-behaviors-to-better-handle-concurrency"></a>Настройте поведение узла для обеспечения оптимального параллелизма

Файл `host.json` в приложении-функции позволяет настраивать среду выполнения узла и поведение триггера.  Кроме настройки поведения пакетной обработки, вы можете управлять параллелизмом определенного числа триггеров. Часто настройка этих параметров помогает масштабировать каждый экземпляр согласно требованиям вызванных функций.

Настройки в файле host.json применяются во всех функциях в приложении, в *пределах одного экземпляра* функции. Например, если у вас есть функциональное [`maxConcurrentRequests`](functions-bindings-http-webhook-output.md#hostjson-settings) приложение с двумя функциями HTTP и запросы, установленные на 25, запрос на любой триггер HTTP будет учитываться в общих 25 одновременных запросах.  Когда это приложение функции масштабируется до 10 экземпляров, эти две функции фактически позволяют 250 одновременных запросов (10 экземпляров и 25 одновременных запросов на экземпляр). 

Другие параметры конфигурации хоста можно найти в [статье конфигурации host.json.](functions-host-json.md)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих ресурсах:

* [Способы управления подключениями в службе "Функции Azure"](manage-connections.md)
* [Рекомендации по использованию службы приложений Azure](../app-service/app-service-best-practices.md)
