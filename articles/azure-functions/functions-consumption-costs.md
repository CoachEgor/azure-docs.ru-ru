---
title: Оценка затрат на план потребления в функциях Azure
description: Узнайте, как лучше оценить затраты, которые могут возникнуть при запуске приложения-функции в плане потребления в Azure.
ms.date: 9/20/2019
ms.topic: conceptual
ms.openlocfilehash: 9d81c99f3602e3d7ed5508884b0b313ef2f2fcaf
ms.sourcegitcommit: d6b68b907e5158b451239e4c09bb55eccb5fef89
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74230856"
---
# <a name="estimating-consumption-plan-costs"></a>Оценка затрат на план потребления

В настоящее время существует три типа планов размещения для приложения, которое выполняется в службе "функции Azure", и каждый план имеет собственную модель ценообразования: 

| План | ОПИСАНИЕ |
| ---- | ----------- |
| [**Затрат**](functions-scale.md#consumption-plan) | Плата насчитывается только за время запуска приложения функции. Этот план включает [бесплатную страницу предоставления][странице цен] на каждую подписку.|
| [**Приоритет**](functions-scale.md#premium-plan) | Предоставляет те же функции и механизм масштабирования, что и план потребления, но с повышенной производительностью и доступом к виртуальной сети. Стоимость зависит от выбранной ценовой категории. Дополнительные сведения см. в статье [план функций Azure Premium](functions-premium-plan.md). |
| [**Выделенная (служба приложений)** ](functions-scale.md#app-service-plan) <br/>(уровень "базовый" или выше) | Если вам нужно работать на выделенных виртуальных машинах или в изоляции, используйте пользовательские образы или вы хотите использовать избыточную емкость плана службы приложений. Использует [обычную выставление счетов по плану службы приложений](https://azure.microsoft.com/pricing/details/app-service/). Стоимость зависит от выбранной ценовой категории.|

Вы выбрали план, который наилучшим образом поддерживает ваши требования к производительности и затратам функций. Дополнительные сведения см. в статье [Масштабирование и размещение Функций Azure](functions-scale.md).

Эта статья относится только к плану потребления, так как этот план приводит к переменным затратам. 

Устойчивые функции также может выполняться в плане потребления. Дополнительные сведения о затратах на использование Устойчивые функции см. в разделе [устойчивые функции выставления счетов](./durable/durable-functions-billing.md).

## <a name="consumption-plan-costs"></a>Стоимость плана потребления

*Стоимость* выполнения одной функции измеряется в *ГБ/с*. Затраты на выполнение рассчитываются путем объединения использования памяти с временем выполнения. Функция, которая выполняется более длительные затраты, как и функция, которая потребляет больше памяти. 

Рассмотрим случай, когда объем памяти, используемый функцией, остается постоянным. В этом случае вычисление затрат является простым умножением. Например, предположим, что функция заняла 0,5 ГБ в течение 3 секунд. Затем стоимость выполнения `0.5GB * 3s = 1.5 GB-seconds`. 

С момента изменения использования памяти с течением времени вычисление фактически является неотъемлемой частью использования памяти с течением времени.  Система выполняет это вычисление, выполняя выборку памяти процесса (вместе с дочерними процессами) через регулярные промежутки времени. Как упоминалось на [странице цен], использование памяти округляется до ближайшего сегмента 128 МБ. Если в процессе используется 160 МБ, плата выставляются за 256 МБ. При расчете учитывается параллелизм, который представляет собой несколько одновременных выполняемых функций в одном процессе.

> [!NOTE]
> Хотя загрузка ЦП не учитывается непосредственно в стоимости выполнения, она может повлиять на затраты, когда она влияет на время выполнения функции.

## <a name="other-related-costs"></a>Другие связанные затраты

При оценке общей стоимости выполнения функций в любом плане Помните, что среда выполнения функций использует несколько других служб Azure, каждый из которых оплачивается отдельно. При расчете цен для приложений функций все триггеры и привязки, которые интегрируются с другими службами Azure, нуждаются в создании и оплате этих дополнительных служб. 

Для функций, выполняемых в плане потребления, Общая стоимость — это стоимость выполнения функций, а также стоимость пропускной способности и дополнительных служб. 

При оценке общих затрат на приложение функции и связанные службы используйте [Калькулятор цен Azure](https://azure.microsoft.com/pricing/calculator/?service=functions). 

| Связанные затраты | ОПИСАНИЕ |
| ------------ | ----------- |
| **Учетная запись хранения** | Для каждого приложения-функции требуется связанная [учетная запись хранения общего назначения Azure](../storage/common/storage-introduction.md#types-of-storage-accounts), которая [оплачивается отдельно](https://azure.microsoft.com/pricing/details/storage/). Эта учетная запись используется внутри среды выполнения функций, но ее также можно использовать для триггеров и привязок хранилища. Если у вас нет учетной записи хранения, она будет создана при создании приложения-функции. Дополнительные сведения см. в статье [требования к учетной записи хранения](functions-scale.md#storage-account-requirements).|
| **Application Insights** | Функции используют [Application Insights](../azure-monitor/app/app-insights-overview.md) для обеспечения высокопроизводительного мониторинга для приложений-функций. Хотя это и не является обязательным, следует [включить интеграцию Application Insights](functions-monitoring.md#enable-application-insights-integration). Бесплатное предоставление данных телеметрии включается каждый месяц. Дополнительные сведения см. [на странице цен на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/). |
| **Пропускная способность сети** | Вы не платите за обмен данными между службами Azure в одном регионе. Однако вы можете взимать расходы на передачу исходящих данных в другой регион или за пределы Azure. Дополнительные сведения см. в разделе [сведения о ценах на пропускную способность](https://azure.microsoft.com/pricing/details/bandwidth/). |

## <a name="behaviors-affecting-execution-time"></a>Поведение, влияющее на время выполнения

Следующие поведения функций могут повлиять на время выполнения:

+ **Триггеры и привязки**. время, затрачиваемое на чтение входных данных и запись выходных данных в [привязки функций](functions-triggers-bindings.md) , учитывается как время выполнения. Например, если функция использует выходную привязку для записи сообщения в очередь службы хранилища Azure, то время выполнения включает время, затраченное на запись сообщения в очередь, которое включается в вычисление стоимости функции. 

+ **Асинхронное выполнение**. время, в течение которого функция ожидает результаты асинхронного запроса (`await` в C#), учитывается как время выполнения. Вычисление с ГБ по секундам основано на времени начала и окончания функции и использовании памяти за этот период. Что происходит в течение этого времени с точки зрения активности ЦП, вычисление не выполняется. Вы можете снизить затраты во время асинхронных операций с помощью [устойчивые функции](durable/durable-functions-overview.md). Вы не оплачиваете время, потраченное на ожидание в функциях Orchestrator.

## <a name="view-execution-data"></a>Просмотр данных выполнения

В [счете](/azure/billing/billing-download-azure-invoice)можно просмотреть связанные с затратами данные о **количестве выполнений — функции** и **функции времени выполнения**, а также фактические оплачиваемые затраты. Однако эти данные счета представляют собой ежемесячное Статистическое выражение за прошедшее время счета. 

Чтобы лучше понять влияние функций на затраты, можно использовать Azure Monitor для просмотра метрик, связанных с затратами, которые в настоящее время создаются приложениями-функциями. Для получения этих данных можно использовать [Azure Monitor обозреватель метрик](../azure-monitor/platform/metrics-getting-started.md) в [портал Azure] или интерфейсы API-интерфейса.

### <a name="monitor-metrics-explorer"></a>Обозреватель мониторинга метрик

Используйте [Azure Monitor обозревателе метрик](../azure-monitor/platform/metrics-getting-started.md) для просмотра данных, связанных с затратами, для приложений-функций плана потребления в графическом формате. 

1. В верхней части [портал Azure] в **службах поиска, ресурсах и документах** найдите `monitor` и выберите **мониторинг** в разделе **службы**.

1. Слева выберите **метрики** > **выберите ресурс**, а затем используйте параметры под изображением, чтобы выбрать приложение-функцию.

    ![Выберите ресурс приложения функции](media/functions-consumption-costing/select-a-resource.png)

      
    |Настройка  |Рекомендуемое значение  |ОПИСАНИЕ  |
    |---------|---------|---------|
    | подписку    |  Ваша подписка  | Подписка с приложением функции.  |
    | Группа ресурсов     | Ваша группа ресурсов  | Группа ресурсов, содержащая приложение функции.   |
    | Тип ресурса     |  Службы приложений | Приложения функций отображаются в мониторе как экземпляры служб приложений. |
    | Resource     |  Приложение функции  | Отслеживаемое приложение функции.        |

1. Выберите **Применить** , чтобы выбрать приложение функции в качестве отслеживаемого ресурса.

1. В параметре **Метрика**выберите **число выполнений функций** и **Сумма** для **статистической обработки**. В результате на диаграмму будет добавлена сумма счетчиков выполнения за выбранный период.

    ![Определение метрики приложения функций для добавления в диаграмму](media/functions-consumption-costing/monitor-metrics-add-metric.png)

1. Выберите **Добавить метрику** и повторите шаги 2-4, чтобы добавить **единицы выполнения функции** в диаграмму. 

Результирующая диаграмма содержит итоги для метрик выполнения в выбранном диапазоне времени, что в данном случае составляет два часа.

![Диаграмма счетчиков выполнения функций и единиц выполнения](media/functions-consumption-costing/monitor-metrics-execution-sum.png)

Так как количество единиц выполнения значительно превышает число выполнений, на диаграмме просто отображаются единицы выполнения.

На этой диаграмме показано общее количество 1 110 000 000 `Function Execution Units`, потребляемых в течение двух часов, измеряется в МБ-миллисекундах. Чтобы преобразовать в GB-seconds, разделите на 1024000. В этом примере приложение-функция потребляет `1110000000 / 1024000 = 1083.98` ГБ-с. Вы можете взять это значение и умножить его на текущую стоимость времени выполнения на [цен на странице][странице цен] ценообразования, что дает вам затраты на эти два часа, предполагая, что вы уже использовали любые бесплатные гранты времени выполнения. 

### <a name="azure-cli"></a>Интерфейс командной строки Azure

[Azure CLI](/cli/azure/) содержит команды для получения метрик. Интерфейс командной строки можно использовать из локальной среды командной строки или непосредственно с портала с помощью [Azure Cloud Shell](../cloud-shell/overview.md). Например, следующая команда [AZ Monitor метрик List](/cli/azure/monitor/metrics#az-monitor-metrics-list) возвращает данные за один и тот же период времени, которые использовались ранее.

Не забудьте заменить `<AZURE_SUBSCRIPTON_ID>` на идентификатор подписки Azure, выполняющей команду.

```azurecli-interactive
az monitor metrics list --resource /subscriptions/<AZURE_SUBSCRIPTION_ID>/resourceGroups/metrics-testing-consumption/providers/Microsoft.Web/sites/metrics-testing-consumption --metric FunctionExecutionUnits,FunctionExecutionCount --aggregation Total --interval PT1H --start-time 2019-09-11T21:46:00Z --end-time 2019-09-11T23:18:00Z
```

Эта команда возвращает полезные данные JSON, которые выглядят, как в следующем примере:

```json
{
  "cost": 0.0,
  "interval": "1:00:00",
  "namespace": "Microsoft.Web/sites",
  "resourceregion": "centralus",
  "timespan": "2019-09-11T21:46:00Z/2019-09-11T23:18:00Z",
  "value": [
    {
      "id": "/subscriptions/XXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX/resourceGroups/metrics-testing-consumption/providers/Microsoft.Web/sites/metrics-testing-consumption/providers/Microsoft.Insights/metrics/FunctionExecutionUnits",
      "name": {
        "localizedValue": "Function Execution Units",
        "value": "FunctionExecutionUnits"
      },
      "resourceGroup": "metrics-testing-consumption",
      "timeseries": [
        {
          "data": [
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T21:46:00+00:00",
              "total": 793294592.0
            },
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T22:46:00+00:00",
              "total": 316576256.0
            }
          ],
          "metadatavalues": []
        }
      ],
      "type": "Microsoft.Insights/metrics",
      "unit": "Count"
    },
    {
      "id": "/subscriptions/XXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX/resourceGroups/metrics-testing-consumption/providers/Microsoft.Web/sites/metrics-testing-consumption/providers/Microsoft.Insights/metrics/FunctionExecutionCount",
      "name": {
        "localizedValue": "Function Execution Count",
        "value": "FunctionExecutionCount"
      },
      "resourceGroup": "metrics-testing-consumption",
      "timeseries": [
        {
          "data": [
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T21:46:00+00:00",
              "total": 33538.0
            },
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T22:46:00+00:00",
              "total": 13040.0
            }
          ],
          "metadatavalues": []
        }
      ],
      "type": "Microsoft.Insights/metrics",
      "unit": "Count"
    }
  ]
}
```
В этом конкретном ответе показано, что от `2019-09-11T21:46` до `2019-09-11T23:18`, в течение которого приложение потребляет 1110000000 МБ — миллисекунды (1083,98 ГБ/с).

## <a name="determine-memory-usage"></a>Определение использования памяти

Единицы выполнения функции — это сочетание времени выполнения и использования памяти, что делает ее несложной метрикой для понимания использования памяти. Данные памяти не являются метрикой, доступной в настоящее время с помощью Azure Monitor. Однако если вы хотите оптимизировать использование памяти приложением, может использовать данные счетчиков производительности, собранные Application Insights.  

[Включите Application Insights в приложении функции](functions-monitoring.md#enable-application-insights-integration), если вы еще этого не сделали. Если эта интеграция включена, вы можете [запросить эти данные телеметрии на портале](functions-monitoring.md#query-telemetry-data).  

В разделе **мониторинг**выберите **журналы (Analytics)** , затем скопируйте следующий запрос телеметрии и вставьте его в окно запроса и выберите **выполнить**. Этот запрос возвращает общее использование памяти для каждого образца времени.

```
performanceCounters
| where name == "Private Bytes"
| project timestamp, name, value
```

Результаты выглядят, как в следующем примере:

| timestamp \[\] времени в формате UTC          | Имя          | Значение       |
|----------------------------|---------------|-------------|
| 9/12/2019, 1:05:14\.947 | Байты исключительного пользования | 209 932 288 |
| 9/12/2019, 1:06:14\.994 | Байты исключительного пользования | 212 189 184 |
| 9/12/2019, 1:06:30\.010 | Байты исключительного пользования | 231 714 816 |
| 9/12/2019, 1:07:15\.040 | Байты исключительного пользования | 210 591 744 |
| 9/12/2019, 1:12:16\.285 | Байты исключительного пользования | 216 285 184 |
| 9/12/2019, 1:12:31\.376 | Байты исключительного пользования | 235 806 720 |

## <a name="function-level-metrics"></a>Метрики уровня функции

Azure Monitor отслеживает метрики на уровне ресурсов, который для функций — это приложение-функция. Интеграция Application Insights выдает метрики для каждой функции. Ниже приведен пример запроса аналитики для получения средней длительности функции:

```
customMetrics
| where name contains "Duration"
| extend averageDuration = valueSum / valueCount
| summarize averageDurationMilliseconds=avg(averageDuration) by name
```

| Имя                       | аверажедуратионмиллисекондс |
|----------------------------|-----------------------------|
| QueueTrigger Авгдуратионмс | 16\.087                     |
| QueueTrigger Максдуратионмс | 90\.249                     |
| QueueTrigger Миндуратионмс | 8\.522                      |

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Дополнительные сведения о мониторинге приложений функций](functions-monitoring.md)

[странице цен]: https://azure.microsoft.com/pricing/details/functions/
[портал Azure]: https://portal.azure.com
