---
title: Оценка затрат на план потребления в функциях Azure
description: Узнайте, как лучше оценить затраты, которые вы можете понести при запуске приложения функции в плане потребления в Azure.
ms.date: 9/20/2019
ms.topic: conceptual
ms.openlocfilehash: 0e3177d7c65eb1624441427f123e6f95095bdbbd
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76963994"
---
# <a name="estimating-consumption-plan-costs"></a>Оценка затрат на план потребления

В настоящее время существует три типа планов хостинга для приложения, которое работает в Azure Functions, при этом каждый план имеет свою собственную модель ценообразования: 

| План | Описание |
| ---- | ----------- |
| [**Потребление**](functions-scale.md#consumption-plan) | Плата взимается только за время работы приложения функции. Этот план включает в себя бесплатную[страницу ценообразования] [гранта]на основе подписки.|
| [**Премиум**](functions-scale.md#premium-plan) | Предоставляет вам те же функции и механизм масштабирования, что и план потребления, но с повышенной производительностью и доступом КВЕТ. Стоимость основана на выбранном уровне ценообразования. Чтобы узнать больше, смотрите [премиум-план Azure Functions Premium.](functions-premium-plan.md) |
| [**Выделено (Служба приложений)**](functions-scale.md#app-service-plan) <br/>(базовый уровень или выше) | Если вам нужно работать в выделенных VMs или в изоляции, используйте пользовательские изображения, или хотите использовать излишнюю емкость плана службы app. Использует [регулярные счета плана App Service.](https://azure.microsoft.com/pricing/details/app-service/) Стоимость основана на выбранном уровне ценообразования.|

Вы выбрали план, который наилучшим образом поддерживает производительность функции и требования к затратам. Дополнительные сведения см. в статье [Масштабирование и размещение Функций Azure](functions-scale.md).

Эта статья касается только плана потребления, так как этот план приводит к переменным затратам. Эта статья вытесняет стоимость оплаты расходов на [оплату часто задаваемых вопросов.](https://github.com/Azure/Azure-Functions/wiki/Consumption-Plan-Cost-Billing-FAQ)

Долгосрочные функции также могут выполняться в плане потребления. Чтобы узнать больше о расходах при использовании долгосрочных [функций, см.](./durable/durable-functions-billing.md)

## <a name="consumption-plan-costs"></a>Стоимость плана потребления

*Стоимость* выполнения одного выполнения функции измеряется в *ГБ-секундах.* Стоимость выполнения рассчитывается путем объединения его использования памяти с временем выполнения. Функция, которая работает дольше, стоит дороже, как и функция, которая потребляет больше памяти. 

Рассмотрим случай, когда объем памяти, используемой функцией, остается неизменным. В этом случае расчет стоимости является простым умножением. Например, скажите, что ваша функция потребляется 0,5 ГБ в течение 3 секунд. Тогда стоимость исполнения `0.5GB * 3s = 1.5 GB-seconds`. 

Поскольку использование памяти меняется с течением времени, расчет по существу является неотъемлемой частью использования памяти с течением времени.  Система делает этот расчет путем выборки использования памяти процесса (наряду с детскими процессами) через регулярные промежутки времени. Как уже упоминалось на [странице ценообразования,]использование памяти округляется до ближайшего 128-Mb ведро. Когда ваш процесс использует 160 МБ, с вас взимается плата за 256 МБ. Расчет учитывает параллелизм, который представляет собой несколько одновременных выполнения функций в одном и том же процессе.

> [!NOTE]
> Хотя использование процессора непосредственно не учитывается в стоимости выполнения, оно может повлиять на стоимость, когда оно влияет на время выполнения функции.

## <a name="other-related-costs"></a>Прочие связанные с этим расходы

При оценке общей стоимости выполнения функций в любом плане помните, что время выполнения функций использует несколько других служб Azure, каждый из которых выставляется отдельно. При расчете цен на функциональные приложения любые триггеры и привязки, которые объединяются с другими службами Azure, требуют создания и оплаты этих дополнительных услуг. 

Для функций, работающих в плане Потребления, общая стоимость — это стоимость выполнения ваших функций, а также стоимость пропускной способности и дополнительных услуг. 

При оценке общих затрат приложения функции и связанных с ним служб используйте [калькулятор ценообразования Azure.](https://azure.microsoft.com/pricing/calculator/?service=functions) 

| Связанные с этим расходы | Описание |
| ------------ | ----------- |
| **Учетная запись хранилища** | Каждое приложение функции требует, чтобы у вас была связанная учетная запись общего назначения [Azure Storage,](../storage/common/storage-introduction.md#types-of-storage-accounts)которая [выставляется отдельно.](https://azure.microsoft.com/pricing/details/storage/) Эта учетная запись используется внутренне временем выполнения функций, но вы также можете использовать ее для триггеров и привязок хранения. Если у вас нет учетной записи хранилища, она создается для вас при создании приложения функции. Чтобы узнать [Storage account requirements](storage-considerations.md#storage-account-requirements)больше, см.|
| **Application Insights** | Функции опираются на [Application Insights,](../azure-monitor/app/app-insights-overview.md) чтобы обеспечить высокопроизводительный опыт мониторинга для ваших функциональных приложений. Хотя это и не требуется, необходимо [включить интеграцию Application Insights.](functions-monitoring.md#enable-application-insights-integration) Бесплатный грант телеметрических данных включается каждый месяц. Чтобы узнать больше, смотрите [страницу ценообразования Azure Monitor.](https://azure.microsoft.com/pricing/details/monitor/) |
| **Пропускная способность сети** | Вы не платите за передачу данных между службами Azure в одном регионе. Однако можно понести расходы на передачу исходящих данных в другой регион или за пределами Azure. Чтобы узнать больше, смотрите [подробности ценообразования Bandwidth](https://azure.microsoft.com/pricing/details/bandwidth/). |

## <a name="behaviors-affecting-execution-time"></a>Поведение, влияющие на время выполнения

Следующее поведение ваших функций может повлиять на время выполнения:

+ **Триггеры и привязки**: Время, задеваемые для чтения входных данных и записи вывода в [привязки функций,](functions-triggers-bindings.md) засчитывается как время выполнения. Например, когда функция использует выходную привязку для записи сообщения в очередь хранения Azure, время выполнения включает время, затрачаемые для записи сообщения в очередь, которое включено в расчет стоимости функции. 

+ **Асинхронное выполнение**: Время ожидания результатов запроса async`await` (в C) засчитывается как время выполнения. Расчет ГБ-секунды основан на времени начала и окончания функции и использовании памяти в течение этого периода. То, что происходит за это время с точки зрения активности процессора, не учитывается в расчете. Вы можете сократить затраты во время асинхронных операций с помощью [функций Durable.](durable/durable-functions-overview.md) Вам не выставляется счет за время, проведенное в ожидании в оркестраторных функций.

## <a name="view-execution-data"></a>Просмотр данных исполнения

В [счете-фактуре](/azure/billing/billing-download-azure-invoice)можно просматривать данные, связанные с **затратами, Total Executions - Функции** и **время выполнения - функции,** а также фактические затраты. Однако эти данные счета-фактуры — это ежемесячный агрегированный счет за прошлый период выставления счетов. 

Чтобы лучше понять влияние затрат на ваши функции, можно использовать Azure Monitor для просмотра метрик, связанных с затратами, которые в настоящее время генерируются вашими функциональными приложениями. Для получения этих данных можно использовать как [explorer метрик Azure Monitor, так](../azure-monitor/platform/metrics-getting-started.md) и [aIS REST.]

### <a name="monitor-metrics-explorer"></a>Исследователь метрик монитора

Используйте [explorer метрик Azure Monitor](../azure-monitor/platform/metrics-getting-started.md) для просмотра данных, связанных с затратами, для приложений функции плана потребления в графическом формате. 

1. В верхней части [портала Azure] в **поисковых сервисах, ресурсах и документах** поиск `monitor` и выбор **монитора** под **службами.**

1. Слева выберите **метрики** > **Выберите ресурс,** а затем используйте настройки ниже изображения, чтобы выбрать приложение функции.

    ![Выберите ресурс приложения функции](media/functions-consumption-costing/select-a-resource.png)

      
    |Параметр  |Рекомендуемое значение  |Описание  |
    |---------|---------|---------|
    | Подписка    |  Ваша подписка  | Подписка с вашим приложением функции.  |
    | Группа ресурсов     | Ваша группа ресурсов  | Группа ресурсов, содержащая приложение функции.   |
    | Тип ресурса     |  Службы приложений | Функциональные приложения отображаются как экземпляры служб приложений в Monitor. |
    | Ресурс     |  Приложение функции  | Функция приложение для мониторинга.        |

1. Выберите **Применить,** чтобы выбрать приложение функции в качестве ресурса для мониторинга.

1. Из **metric**выберите **количество функциональных исполнений** и **Sum** для **агрегации.** Это добавляет сумму выполнения рассчитывает в выбранный период на диаграмму.

    ![Определите метрику приложения функций для добавления в диаграмму](media/functions-consumption-costing/monitor-metrics-add-metric.png)

1. Выберите **Добавить метрические** и повторить шаги 2-4, чтобы добавить **блоки выполнения функций** в диаграмму. 

Полученная диаграмма содержит итоги для обеих метрик выполнения в выбранном временном диапазоне, который в данном случае составляет два часа.

![График количества выполнения функций и единиц выполнения](media/functions-consumption-costing/monitor-metrics-execution-sum.png)

Поскольку количество единиц выполнения намного больше, чем количество выполнения, диаграмма просто показывает единицы выполнения.

На этой диаграмме показано в `Function Execution Units` общей сложности 1,11 миллиарда, потребляемых в течение двух часов, измеренных в MB-миллисекундах. Чтобы преобразовать в ГБ-секунды, разделите на 1024000. В этом примере приложение `1110000000 / 1024000 = 1083.98` функции потребляется ГБ-секунд. Вы можете взять это значение и умножить текущую цену времени исполнения на[странице ценообразования] [цена функций,]которая дает вам стоимость этих двух часов, предполагая, что вы уже использовали любые бесплатные гранты времени исполнения. 

### <a name="azure-cli"></a>Azure CLI

В [Azure CLI](/cli/azure/) есть команды для извлечения метрик. Использовать CLI можно из локальной командной среды или непосредственно с портала с помощью [Azure Cloud Shell.](../cloud-shell/overview.md) Например, следующие [показатели мониторинга мониторинга списка](/cli/azure/monitor/metrics#az-monitor-metrics-list) командных данных возвращают почасовые данные за тот же период времени, который использовался ранее.

Убедитесь в `<AZURE_SUBSCRIPTON_ID>` том, чтобы заменить идентификатор подписки Azure под управлением команды.

```azurecli-interactive
az monitor metrics list --resource /subscriptions/<AZURE_SUBSCRIPTION_ID>/resourceGroups/metrics-testing-consumption/providers/Microsoft.Web/sites/metrics-testing-consumption --metric FunctionExecutionUnits,FunctionExecutionCount --aggregation Total --interval PT1H --start-time 2019-09-11T21:46:00Z --end-time 2019-09-11T23:18:00Z
```

Эта команда возвращает полезную нагрузку JSON, которая выглядит как следующий пример:

```json
{
  "cost": 0.0,
  "interval": "1:00:00",
  "namespace": "Microsoft.Web/sites",
  "resourceregion": "centralus",
  "timespan": "2019-09-11T21:46:00Z/2019-09-11T23:18:00Z",
  "value": [
    {
      "id": "/subscriptions/XXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX/resourceGroups/metrics-testing-consumption/providers/Microsoft.Web/sites/metrics-testing-consumption/providers/Microsoft.Insights/metrics/FunctionExecutionUnits",
      "name": {
        "localizedValue": "Function Execution Units",
        "value": "FunctionExecutionUnits"
      },
      "resourceGroup": "metrics-testing-consumption",
      "timeseries": [
        {
          "data": [
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T21:46:00+00:00",
              "total": 793294592.0
            },
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T22:46:00+00:00",
              "total": 316576256.0
            }
          ],
          "metadatavalues": []
        }
      ],
      "type": "Microsoft.Insights/metrics",
      "unit": "Count"
    },
    {
      "id": "/subscriptions/XXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX/resourceGroups/metrics-testing-consumption/providers/Microsoft.Web/sites/metrics-testing-consumption/providers/Microsoft.Insights/metrics/FunctionExecutionCount",
      "name": {
        "localizedValue": "Function Execution Count",
        "value": "FunctionExecutionCount"
      },
      "resourceGroup": "metrics-testing-consumption",
      "timeseries": [
        {
          "data": [
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T21:46:00+00:00",
              "total": 33538.0
            },
            {
              "average": null,
              "count": null,
              "maximum": null,
              "minimum": null,
              "timeStamp": "2019-09-11T22:46:00+00:00",
              "total": 13040.0
            }
          ],
          "metadatavalues": []
        }
      ],
      "type": "Microsoft.Insights/metrics",
      "unit": "Count"
    }
  ]
}
```
Данный ответ показывает, что от `2019-09-11T21:46` до `2019-09-11T23:18`, приложение потребляется 1110000000 МБ-миллисекунд (1083,98 ГБ-секунд).

## <a name="determine-memory-usage"></a>Определение использования памяти

Блоки выполнения функций представляют собой сочетание времени выполнения и использования памяти, что делает его трудным показателем для понимания использования памяти. Данные памяти не имеются в настоящее время в доступе через Azure Monitor. Однако, если вы хотите оптимизировать использование памяти вашего приложения, можно использовать данные счетчика производительности, собранные Insights приложения.  

Если вы еще не сделали этого, [включите приложение Application Insights в приложении функции.](functions-monitoring.md#enable-application-insights-integration) С помощью этой интеграции можно [загнать эти данные телеметрии на портале.](functions-monitoring.md#query-telemetry-data)  

Под **мониторингом**, выберите **журналы (аналитика)**, затем скопировать следующий запрос телеметрии и вставьте его в окно запроса и выберите **Выполнить.** Этот запрос возвращает общее использование памяти в каждое выбранное время.

```
performanceCounters
| where name == "Private Bytes"
| project timestamp, name, value
```

Результаты выглядят следующим примером:

| метка \[времени UTC\]          | name          | значение       |
|----------------------------|---------------|-------------|
| 9/12/2019, 1:05:14\.947 AM | Байты исключительного пользования | 209,932,288 |
| 9/12/2019, 1:06:14\.994 AM | Байты исключительного пользования | 212,189,184 |
| 9/12/2019, 1:06:30\.010 AM | Байты исключительного пользования | 231,714,816 |
| 9/12/2019, 1:07:15\.040 AM | Байты исключительного пользования | 210,591,744 |
| 9/12/2019, 1:12:16\.285 | Байты исключительного пользования | 216,285,184 |
| 9/12/2019, 1:12:31\.376 AM | Байты исключительного пользования | 235,806,720 |

## <a name="function-level-metrics"></a>Метрики уровня функции

Azure Monitor отслеживает метрики на уровне ресурсов, который для функций является функциональным приложением. Интеграция Application Insights излучает метрики на основе функции. Вот пример запроса аналитики, чтобы получить среднюю продолжительность функции:

```
customMetrics
| where name contains "Duration"
| extend averageDuration = valueSum / valueCount
| summarize averageDurationMilliseconds=avg(averageDuration) by name
```

| name                       | averageDurationMilliseconds |
|----------------------------|-----------------------------|
| ОчередьТриггер AvgDurationMs | 16\.087                     |
| ОчередьТриггер MaxDurationMs | 90\.249                     |
| ОчередьТриггер MinDurationMs | 8\.522                      |

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Подробнее о приложениях функции мониторинга](functions-monitoring.md)

[страница ценообразования]:https://azure.microsoft.com/pricing/details/functions/
[Портал Azure]: https://portal.azure.com
