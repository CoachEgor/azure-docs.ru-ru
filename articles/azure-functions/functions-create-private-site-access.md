---
title: Установка закрытого доступа к сайту к Функциям Azure
description: Сведения о настройке закрытого доступа к сайту для Функций Azure в виртуальной сети Azure.
author: mcollier
ms.author: mcollier
ms.service: azure-functions
ms.topic: tutorial
ms.date: 02/15/2020
ms.openlocfilehash: ada08de182791c6ecb2b83ef3b924bf40975e1ee
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "78852019"
---
# <a name="tutorial-establish-azure-functions-private-site-access"></a>Руководство по установке закрытого доступа к сайту для Функций Azure

В этом руководстве показано, как включить [закрытый доступ к сайту](./functions-networking-options.md#private-site-access) с Функциями Azure. Используя закрытый доступ к сайту, можно потребовать, чтобы код функции запускался только из определенной виртуальной сети.

Закрытый доступ к сайту удобен в ситуациях, когда доступ к приложению-функции необходимо ограничить конкретной виртуальной сетью. Например, приложение-функция может быть применимо только для сотрудников определенной организации или служб, находящихся в заданной виртуальной сети (например, это может быть другая функция Azure, виртуальная машина Azure или кластер AKS).

Если приложению-функции требуется доступ к ресурсам Azure в виртуальной сети или подключение осуществляется через [конечные точки службы](../virtual-network/virtual-network-service-endpoints-overview.md), требуется [интеграция виртуальной сети](./functions-create-vnet.md).

Из этого руководства вы узнаете, как настроить частный доступ к сайту для приложения-функции.

> [!div class="checklist"]
> * Создание виртуальной машины
> * Создание службы "Бастион Azure"
> * Создание приложения Функций Azure
> * Настройка конечной точки службы в виртуальной сети
> * Создание и развертывание функции Azure
> * Вызов функции изнутри и извне виртуальной сети

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="topology"></a>Топология

На следующей схеме показана архитектура создаваемого решения.

![Общая схема архитектуры решения для частного доступа к сайту](./media/functions-create-private-site-access/topology.png)

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством важно понимать принципы назначения IP-адресов и определения подсети. Вы можете начать с [этой статьи, в которой изложены основы назначения адресов и определения подсети](https://support.microsoft.com/help/164015/understanding-tcp-ip-addressing-and-subnetting-basics). В Интернете доступно множество других статей и видеоматериалов по этой теме.

## <a name="sign-in-to-azure-portal"></a>Вход на портал Azure

Войдите на [портал Azure](https://portal.azure.com).

## <a name="create-a-virtual-machine"></a>Создание виртуальной машины

Согласно данному руководству, первое, что необходимо сделать, — создать новую виртуальную машину в виртуальной сети.  Виртуальная машина будет использоваться для доступа к функции после того, как она (из-за ограничения доступа) станет доступна только в виртуальной сети.

1. Нажмите кнопку **Создать ресурс**.

2. В поле поиска введите `Windows Server` и выберите **Windows Server** в результатах поиска.

3. Выберите **Windows Server 2019 Datacenter** из списка вариантов Windows Server и нажмите кнопку **Создать**.

4. На вкладке **Основные сведения** задайте параметры виртуальной машины, указанные в таблице под этим изображением.

    >[!div class="mx-imgBorder"]
    >![Вкладка "Основные сведения" для новой виртуальной машины Windows](./media/functions-create-private-site-access/create-vm-3.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | **Подписка** | Ваша подписка | Подписка, в рамках которой создан ресурс. |
    | [**Группа ресурсов**](../azure-resource-manager/management/overview.md) | myResourceGroup | Выберите группу ресурсов, которая будет содержать ресурсы для работы с этим руководством.  Использование одной и той же группы ресурсов упрощает задачу очистки ресурсов после завершения работы с этим руководством. |
    | **Имя виртуальной машины** | myVM | Имя виртуальной машины должно быть уникальным в группе ресурсов. |
    | [**Регион**](https://azure.microsoft.com/regions/) | Центрально-северная часть США (США) | Выберите регион, ближайший к вам или к месту расположения функций, к которым будет осуществляться доступ. |
    | **Общедоступные входящие порты** | None | Выберите **отсутствует**, чтобы гарантировать отсутствие входящего подключения к виртуальной машине из Интернета. Удаленный доступ к виртуальной машине будет настроен с помощью службы "Бастион Azure". |

5. Перейдите на вкладку **Сетевые подключения** и выберите **Создать**, чтобы настроить новую виртуальную сеть.

    >[!div class="mx-imgBorder"]
    >![Создание новой виртуальной сети для новой виртуальной машины](./media/functions-create-private-site-access/create-vm-networking.png)

6. В разделе **Создание виртуальной сети** задайте параметры, указанные в таблице под изображением.

    >[!div class="mx-imgBorder"]
    >![Создание новой виртуальной сети для новой виртуальной машины](./media/functions-create-private-site-access/create-vm-vnet-1.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | **имя**; | myResourceGroup-vnet | Вы можете использовать имя по умолчанию, созданное для виртуальной сети. |
    | **Диапазон адресов** | 10.10.0.0/16 | Используйте один диапазон адресов для виртуальной сети. |
    | **Имя подсети** | Учебник | Имя подсети. |
    | **Диапазон адресов** (подсеть) | 10.10.1.0/24 | От размера подсети зависит, сколько интерфейсов можно в нее добавить. Эта подсеть используется виртуальной машиной. Подсеть `/24` предоставляет 254 адреса узлов. |

7. Нажмите кнопку **ОК**, чтобы создать виртуальную сеть.
8. Вернитесь на вкладку **Сетевые подключения** убедитесь, что для параметра **Общедоступный IP-адрес** выбрано значение **отсутствует**.
9. Перейдите на вкладку **Управление**, а затем в разделе **Diagnostic storage account** (Учетная запись хранения диагностики) выберите **Создать**, чтобы создать новую учетную запись хранения.
10. Оставьте значения по умолчанию в разделах **Идентификатор**, **Автозавершение работы** и **Резервное копирование**.
11. Выберите **Review + create** (Просмотреть и создать). После завершения проверки щелкните **Создать**. Процесс создания виртуальной машины займет несколько минут.

## <a name="configure-azure-bastion"></a>Настройка Бастиона Azure

[Бастион Azure](https://azure.microsoft.com/services/azure-bastion/) — это полностью управляемая служба Azure, которая обеспечивает безопасный доступ к виртуальным машинам по протоколам RDP и SSH непосредственно с портала Azure. Использование службы "Бастион Azure" избавляет от необходимости настройки параметров сети, связанных с доступом по протоколу RDP.

1. На портале в верхней части представления группы ресурсов выберите **Добавить**.
2. В поле поиска введите "Бастион".  Выберите "Бастион".
3. Выберите **Создать**, чтобы начать процесс создания нового ресурса типа "Бастион Azure". В разделе **Виртуальная сеть** отобразится сообщение об ошибке, так как подсети `AzureBastionSubnet` еще нет. Подсеть создается на следующих этапах. Затем используйте настройки из таблицы под изображением.

    >[!div class="mx-imgBorder"]
    >![Начало создания Бастиона Azure](./media/functions-create-private-site-access/create-bastion-basics-1.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | **имя**; | myBastion | Имя нового ресурса типа "Бастион". |
    | **Регион** | Центрально-северная часть США | Выберите ближайший [регион](https://azure.microsoft.com/regions/) или регион рядом с другими службами, к которому получают доступ ваши функции. |
    | **Виртуальная сеть** | myResourceGroup-vnet | Виртуальная сеть, в которой будет создан ресурс типа "Бастион". |
    | **Подсеть** | AzureBastionSubnet | Подсеть в виртуальной сети, в которой будет развернут новый ресурс типа "Узел-бастион". Необходимо создать подсеть, используя в качестве имени значение `AzureBastionSubnet`. По этому значению Azure сможет определить, в какую подсеть следует развертывать ресурсы типа "Бастион". Необходимо использовать подсеть размером не меньше `/27` или больше (`/27`, `/26` и т. д.). |

    > [!NOTE]
    > Подробное пошаговое руководство по созданию ресурса типа "Бастион Azure" см. в учебнике [Создание узла-бастиона Azure](../bastion/bastion-create-host-portal.md).

4. Создайте подсеть, в которой Azure может подготовить узел-бастион Azure. При выборе элемента **Управление конфигурацией подсети** откроется новая область, в которой можно определить новую подсеть.  Выберите **+ Подсеть** для создания новой подсети.
5. Подсеть должна иметь имя `AzureBastionSubnet`, а длина префикса подсети должна быть не менее `/27`.  Нажмите кнопку **ОК**, чтобы создать подсеть.

    >[!div class="mx-imgBorder"]
    >![Создание подсети для узла-бастиона Azure](./media/functions-create-private-site-access/create-bastion-subnet-2.png)

6. На странице **Создание бастиона** выберите только что созданную подсеть `AzureBastionSubnet` из списка доступных подсетей.

    >[!div class="mx-imgBorder"]
    >![Создание узла-бастиона Azure с определенной подсетью](./media/functions-create-private-site-access/create-bastion-basics-2.png)

7. Выберите **Просмотреть и создать**. По завершении проверки выберите **Создать**. Создание ресурса типа "Бастион Azure" займет несколько минут.

## <a name="create-an-azure-functions-app"></a>Создание приложения Функций Azure

Следующий этап — создание приложения-функции в Azure с использованием [плана потребления](functions-scale.md#consumption-plan). Развертывание кода функции в этом ресурсе описано далее в этом руководстве.

1. На портале в верхней части представления группы ресурсов выберите **Добавить**.
2. Выберите **Среда выполнения приложений > Приложение-функция**.
3. В разделе **Основные сведения** используйте параметры приложения-функции как указано в таблице ниже.

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | **Группа ресурсов** | myResourceGroup | Выберите группу ресурсов, которая будет содержать ресурсы для работы с этим руководством.  Использование одной и той же группы ресурсов для приложения-функции и виртуальной машины упрощает задачу очистки ресурсов после завершения работы с этим руководством. |
    | **Имя приложения-функции** | Глобально уникальное имя | Имя, которое идентифицирует ваше новое приложение-функцию. Допустимые символы: a–z (без учета регистра), 0–9 и -. |
    | **Опубликовать** | Код | Параметр для публикации файлов кода или контейнера Docker. |
    | **Стек среды выполнения** | Предпочитаемый язык | Выберите среду выполнения, которая поддерживает нужный функциональный язык программирования. |
    | **Регион** | Центрально-северная часть США | Выберите ближайший [регион](https://azure.microsoft.com/regions/) или регион рядом с другими службами, к которому получают доступ ваши функции. |

    Нажмите кнопку **Далее: размещение >** .
4. В разделе **Размещение** выберите соответствующие значения для параметров **Учетная запись хранения**, **Операционная система** и **План**, описанные в следующей таблице.

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | **Учетная запись хранения** | Глобально уникальное имя | Создайте учетную запись хранения для использования приложением-функцией. Имя учетной записи хранения должно содержать от 3 до 24 символов и состоять только из цифр и строчных букв. Можно также использовать существующую учетную запись при условии, что она соответствует [требованиям учетной записи хранилища](./functions-scale.md#storage-account-requirements). |
    | **Операционная система** | Предпочтительная операционная система | Операционная система предварительно выбирается с учетом выбранного стека среды выполнения, но при необходимости ее можно изменить. |
    | **План** | Потребление | От [плана размещения](./functions-scale.md) зависит, как масштабируется приложение-функция и какие ресурсы доступны для каждого экземпляра. |
5. Выберите **Просмотр и создание** , чтобы просмотреть выбранные параметры конфигурации приложения.
6. Выберите **Создать**, чтобы подготовить и развернуть приложение-функцию.

## <a name="configure-access-restrictions"></a>Настройка ограничений доступа

Следующий этап — настройка таких [ограничений доступа](../app-service/app-service-ip-restrictions.md), при которых вызывать функцию смогут только ресурсы в виртуальной сети.

[Закрытый доступ к сайту](functions-networking-options.md#private-site-access) включается при создании [конечной точки службы](../virtual-network/virtual-network-service-endpoints-overview.md) виртуальной сети Azure между приложением-функцией и указанной виртуальной сетью. Ограничения доступа реализуются через конечные точки службы. Конечные точки службы гарантируют, что только трафик, исходящий из указанной виртуальной сети, может получить доступ к назначенному ресурсу. В данном случае назначенным ресурсом является функция Azure.

1. В приложении функции перейдите на вкладку **Функции платформы**. Щелкните ссылку **Сетевые подключения** в разделе *Сетевые подключения*, чтобы открыть раздел "Состояние компонента сети".
2. Страница **Состояние компонента сети** является отправной точкой для настройки Azure Front Door, Azure CDN, а также ограничений доступа. Выберите **Настройка ограничений доступа** для настройки закрытого доступа к сайту.
3. На странице **Ограничения доступа** отображается только ограничение по умолчанию. Ограничения на доступ к приложению-функции по умолчанию не устанавливаются.  Выберите **Добавить правило**, чтобы создать конфигурацию ограничения для закрытого доступа к сайту.
4. В области **Добавление ограничения доступа** выберите в раскрывающемся списке **Тип** значение **Виртуальная сеть**, а затем выберите созданные ранее виртуальную сеть и подсеть.
5. Теперь на странице **Ограничения доступа** отображается новое ограничение. Для изменения значения параметра **Состояние конечной точки** с `Disabled` на `Provisioning`, а затем — `Enabled` может потребоваться несколько секунд.

    >[!IMPORTANT]
    > У каждого приложения-функции есть [сайт расширенного инструмента (Kudu)](../app-service/app-service-ip-restrictions.md#scm-site), который используется для управления развертываниями приложений-функций. Для доступа к этому сайту используется URL-адрес, например `<FUNCTION_APP_NAME>.scm.azurewebsites.net`. Так как ограничения на доступ на этом сайте развертывания не включены, вы по-прежнему можете развернуть код проекта с локальной рабочей станции разработчика или службы сборок без подготовки агента в виртуальной сети.

## <a name="access-the-functions-app"></a>Доступ к приложению-функции

1. Вернитесь к ранее созданному приложению-функции.  В разделе **Обзор** скопируйте URL-адрес.

    >[!div class="mx-imgBorder"]
    >![Получение URL-адреса приложения-функции](./media/functions-create-private-site-access/access-function-overview.png)

2. Если вы теперь попытаетесь получить доступ к приложению-функции с компьютера, находящегося за пределами виртуальной сети, вы получите страницу HTTP 403, указывающую, что приложение остановлено.  Приложение не остановлено. В действительности ответ — это состояние "HTTP 403: доступ по протоколу IP запрещен".
3. Теперь нужно получить доступ к функции из ранее созданной виртуальной машины, которая подключена к виртуальной сети. Чтобы получить доступ к сайту из виртуальной машины, необходимо подключиться к ней через службу "Бастион Azure".  Сначала выберите **Подключить**, а затем — **Бастион**.
4. Укажите необходимые имя пользователя и пароль для входа на виртуальную машину.  Выберите **Подключиться**. Появится новое окно браузера, позволяющее взаимодействовать с виртуальной машиной.
5. Так как эта виртуальная машина обращается к функции через виртуальную сеть, из веб-браузера на этой виртуальной машине можно получить доступ к сайту.  Важно отметить, что хотя приложение-функция доступно только в назначенной виртуальной сети, общедоступная запись DNS остается. Как показано выше, попытка доступа к сайту приведет к ответу HTTP 403.

## <a name="create-a-function"></a>Создание функции

Следующий этап в этом руководстве — создание функции Azure, активируемой по HTTP. Вызов функции с помощью метода HTTP GET или POST должен приводить к отправке ответа "Hello, {имя}".  

1. Выполните указания в одном из следующих кратких руководств, чтобы создать и развернуть приложение Функций Azure.

    * [Visual Studio Code](./functions-create-first-function-vs-code.md)
    * [Visual Studio](./functions-create-your-first-function-visual-studio.md)
    * [Командная строка](./functions-create-first-azure-function-azure-cli.md)
    * [Maven (Java)](./functions-create-first-java-maven.md)

2. При публикации проекта Функций Azure выберите ресурс типа "Приложение-функция", созданный ранее в этом руководстве.
3. Убедитесь, что функция развернута.

    >[!div class="mx-imgBorder"]
    >![Развернутая функция в списке функций](./media/functions-create-private-site-access/verify-deployed-function.png)

## <a name="invoke-the-function-directly"></a>Непосредственный вызов функции

1. Чтобы проверить доступ к функции, необходимо скопировать ее URL-адрес. Выберите развернутую функцию, а затем — **</> Получить URL-адрес функции**. Затем нажмите кнопку **Копировать**, чтобы скопировать URL-адрес в буфер обмена.

    >[!div class="mx-imgBorder"]
    >![Копирование URL-адреса функции](./media/functions-create-private-site-access/get-function-url.png)

    > [!NOTE]
    > При выполнении функции на портале отобразится сообщение об ошибке среды выполнения, указывающая на то, что запустить среду выполнения функции не удается. Несмотря на текст сообщения, приложение-функция на самом деле работает. Эта ошибка является результатом новых ограничений доступа, которые не позволяют порталу запрашивать данные для проверки среды выполнения.

2. Вставьте URL-адрес в веб-браузер. Если вы теперь попытаетесь получить доступ к приложению-функции с компьютера, находящегося за пределами виртуальной сети, вы получите ответ HTTP 403, указывающий, что приложение остановлено.

## <a name="invoke-the-function-from-the-virtual-network"></a>Вызов функции из виртуальной сети

Доступ к функции через веб-браузер (с помощью службы "Бастион Azure") на настроенной виртуальной машине в виртуальной сети успешно получен.

>[!div class="mx-imgBorder"]
>![Доступ к функции Azure через Бастион Azure](./media/functions-create-private-site-access/access-function-via-bastion-final.png)

[!INCLUDE [clean-up-section-portal](../../includes/clean-up-section-portal.md)]

## <a name="next-steps"></a>Дальнейшие действия


> [!div class="nextstepaction"]
> [Дополнительные сведения о параметрах сети в Функциях](./functions-networking-options.md)
