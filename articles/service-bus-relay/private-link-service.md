---
title: Интеграция Azure Relay со службой частной связи Azure
description: Узнайте, как интегрировать Azure Relay со службой "Частная связь Azure"
services: service-bus-relay
author: spelluru
ms.author: spelluru
ms.date: 05/07/2020
ms.service: service-bus-relay
ms.topic: article
ms.openlocfilehash: ad57ea4ddeab2fb2af0da68d199445d9737a67cd
ms.sourcegitcommit: 999ccaf74347605e32505cbcfd6121163560a4ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2020
ms.locfileid: "82984464"
---
# <a name="integrate-azure-relay-with-azure-private-link-preview"></a>Интеграция Azure Relay с помощью частной связи Azure (Предварительная версия)
**Служба "Частная связь** Azure" позволяет получить доступ к службам Azure (например, Azure Relay, служебную шину Azure, концентраторы событий Azure, службу хранилища azure и Azure Cosmos DB) и службы Azure для клиентов и партнеров в частной конечной точке в виртуальной сети. Дополнительные сведения см. в статье [What is Azure Private Link? (Preview)](../private-link/private-link-overview.md) (Что такое Приватный канал Azure (предварительная версия)?)

**Частная конечная точка** — это сетевой интерфейс, который позволяет рабочим нагрузкам, выполняемым в виртуальной сети, безопасно подключаться к службе с **ресурсом закрытой ссылки** (например, пространством имен ретранслятора). Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому не требуются шлюзы, устройства NAT, ExpressRoute, VPN-подключения или общедоступные IP-адреса. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать раскрытия из общедоступного Интернета. Можно обеспечить уровень гранулярности в контроле доступа, разрешая подключения к конкретным пространствам имен Azure Relay. 


> [!IMPORTANT]
> Сейчас эта функция доступна в **предварительной версии**. 
>
> В настоящее время поддерживаются подключения к частным ссылкам на клиентах отправителя. 


## <a name="add-a-private-endpoint-using-azure-portal"></a>Добавление частной конечной точки с помощью портал Azure

### <a name="prerequisites"></a>Предварительные условия
Чтобы интегрировать пространство имен Azure Relay с помощью частной связи Azure (Предварительная версия), вам потребуются следующие сущности или разрешения:

- Пространство имен Azure Relay.
- Виртуальная сеть Azure.
- Подсеть в виртуальной сети.
- Разрешения владельца или участника на виртуальную сеть.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. При выборе региона для частной конечной точки с помощью портала будут автоматически фильтроваться только виртуальные сети в этом регионе. Пространство имен может находиться в другом регионе.

Частная конечная точка использует частный IP-адрес в виртуальной сети.

### <a name="steps"></a>Шаги
Пошаговые инструкции по созданию нового пространства имен Azure Relay и сущностей в нем см. в разделе [Создание пространства имен Azure Relay с помощью портал Azure](relay-create-namespace-portal.md).

1. Войдите на [портал Azure](https://portal.azure.com). 
2. В строке поиска введите **реле**.
3. Выберите **пространство имен** из списка, в который необходимо добавить частную конечную точку.
4. Выберите вкладку **сети** в разделе **Параметры**.
5. Выберите вкладку **подключения к частным конечным точкам (Предварительная версия)** в верхней части страницы.
6. Нажмите кнопку **+ Частная конечная точка** в верхней части страницы.

    ![Кнопка добавления закрытой конечной точки](./media/private-link-service/add-private-endpoint-button.png)
7. На странице **Основные сведения** выполните следующие действия. 
    1. Выберите **подписку Azure** , в которой вы хотите создать закрытую конечную точку. 
    2. Выберите **группу ресурсов** для ресурса частной конечной точки.
    3. Введите **имя** частной конечной точки. 
    5. Выберите **регион** для закрытой конечной точки. Частная конечная точка должна находиться в том же регионе, что и виртуальная сеть, но может находиться в другом регионе из пространства имен Azure Relay, к которому вы подключаетесь. 
    6. Нажмите кнопку **Далее: >ресурсов** в нижней части страницы.

        ![Создание частной конечной точки — страница "Основные сведения"](./media/private-link-service/create-private-endpoint-basics-page.png)
8. На странице **ресурсов** выполните следующие действия.
    1. Если для метода подключения выбрано **Подключение к ресурсу Azure в каталоге**, то у вас есть доступ владельца или участника к пространству имен, а это пространство имен находится в том же каталоге, что и частная конечная точка. выполните следующие действия. 
        1. Выберите **подписку Azure** , в которой существует **пространство имен Azure Relay** . 
        2. Для типа **ресурса**выберите **Microsoft. Relay/Namespaces** для **типа ресурса**.
        3. В поле **ресурс**выберите пространство имен ретранслятора из раскрывающегося списка. 
        4. Убедитесь, что **целевой подресурс** имеет значение **пространство имен**.
        5. Нажмите кнопку **Далее: >конфигурации** в нижней части страницы. 
        
            ![Создание частной конечной точки — страница ресурсов](./media/private-link-service/create-private-endpoint-resource-page.png)    
    2. Если выбран параметр **подключиться к ресурсу Azure по идентификатору или псевдониму ресурса** , так как пространство имен не находится в том же каталоге, что и частная конечная точка, выполните следующие действия.
        1. Введите идентификатор или **псевдоним** **ресурса** . Это может быть идентификатор ресурса или псевдоним, к которому вам предоставили доступ кто-то. Самый простой способ получить идентификатор ресурса — перейти к пространству имен Azure Relay в портал Azure и скопировать часть URI, начиная с `/subscriptions/`. Ниже приведен пример.`/subscriptions/000000000-0000-0000-0000-000000000000000/resourceGroups/myresourcegroup/providers/Microsoft.Relay/namespaces/myrelaynamespace.` 
        2. В качестве **целевого вспомогательного ресурса**введите **Namespace**. Это тип подресурса, к которому имеет доступ частная конечная точка.
        3. используемых Введите **сообщение запроса**. Владелец ресурса видит это сообщение при управлении подключением к частной конечной точке.
        4. Затем нажмите кнопку **Далее: настройка >** в нижней части страницы.

            ![Создание частной конечной точки — подключение с использованием идентификатора ресурса](./media/private-link-service/connect-resource-id.png)
9. На странице **Конфигурация** выберите подсеть в виртуальной сети, в которую требуется развернуть закрытую конечную точку. 
    1. Выберите **виртуальную сеть**. В раскрывающемся списке перечислены только виртуальные сети в выбранной подписке и расположении. 
    2. Выберите **подсеть** в выбранной виртуальной сети. 
    3. Включите **интеграцию с частной зоной DNS** , если хотите интегрировать закрытую конечную точку с частной зоной DNS. 
    
        Для частного подключения к частной конечной точке требуется запись DNS. Рекомендуется интегрировать закрытую конечную точку с **частной зоной DNS**. Вы также можете использовать собственные DNS-серверы или создать записи DNS с помощью файлов узлов на виртуальных машинах. Дополнительные сведения см. в разделе [Конфигурация DNS для частной конечной точки Azure](../private-link/private-endpoint-dns.md). В этом примере выбран параметр **интегрировать с частной зоной DNS** , и для вас будет создана частная зона DNS. 
    3. Нажмите кнопку **Далее: теги >** в нижней части страницы. 

        ![Создание частной конечной точки — страница конфигурации](./media/private-link-service/create-private-endpoint-configuration-page.png)
10. На странице **теги** создайте теги (имена и значения), которые нужно связать с частной конечной точкой и частной зоной DNS (если вы включили параметр). Затем в нижней части страницы нажмите кнопку **Просмотр и создание** . 
11. На странице **Просмотр и создание**проверьте все параметры и выберите **создать** , чтобы создать частную конечную точку.
    
    ![Создание закрытой конечной точки — Просмотр и создание страницы](./media/private-link-service/create-private-endpoint-review-create-page.png)
12. На странице **Частная конечная точка** можно увидеть состояние подключения к частной конечной точке. Если вы являетесь владельцем пространства имен ретранслятора или имеете возможность управлять доступом к **ресурсу в моем каталоге** для **метода подключения**, подключение к конечной точке должно быть **утверждено с помощью автоматического утверждения**. Если он находится в состоянии **ожидания** , см. раздел [управление частными конечными точками с помощью портал Azure](#manage-private-endpoints-using-azure-portal) .

    ![Страница частной конечной точки](./media/private-link-service/private-endpoint-page.png)
13. Вернитесь на страницу " **сеть** " **пространства имен**и перейдите на вкладку " **подключения частной конечной точки (Предварительная версия)** ". Вы должны увидеть созданную закрытую конечную точку. 

    ![Закрытая конечная точка создана](./media/private-link-service/private-endpoint-created.png)

## <a name="add-a-private-endpoint-using-powershell"></a>Добавление частной конечной точки с помощью PowerShell
В следующем примере показано, как использовать Azure PowerShell для создания частного подключения конечной точки к пространству имен Azure Relay.

Частная конечная точка и виртуальная сеть должны находиться в одном регионе. Пространство имен Azure Relay может находиться в другом регионе. И частная конечная точка использует частный IP-адрес в виртуальной сети.

```azurepowershell-interactive

$rgName = "<RESOURCE GROUP NAME>"
$vnetlocation = "<VNET LOCATION>"
$vnetName = "<VIRTUAL NETWORK NAME>"
$subnetName = "<SUBNET NAME>"
$namespaceLocation = "<NAMESPACE LOCATION>"
$namespaceName = "<NAMESPACE NAME>"
$peConnectionName = "<PRIVATE ENDPOINT CONNECTION NAME>"

# create resource group
az group create -l $vnetLocation -n $rgName

# create virtual network
$virtualNetwork = New-AzVirtualNetwork `
                    -ResourceGroupName $rgName `
                    -Location $vnetlocation `
                    -Name $vnetName `
                    -AddressPrefix 10.0.0.0/16

# create subnet with endpoint network policy disabled
$subnetConfig = Add-AzVirtualNetworkSubnetConfig `
                    -Name $subnetName `
                    -AddressPrefix 10.0.0.0/24 `
                    -PrivateEndpointNetworkPoliciesFlag "Disabled" `
                    -VirtualNetwork $virtualNetwork

# update virtual network
$virtualNetwork | Set-AzVirtualNetwork

# create a relay namespace
$namespaceResource = New-AzResource -Location $namespaceLocation -ResourceName $namespaceName -ResourceGroupName $rgName -Properties @{} -ResourceType "Microsoft.Relay/namespaces" 

# create a private link service connection
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
                                -Name $peConnectionName `
                                -PrivateLinkServiceId $namespaceResource.ResourceId `
                                -GroupId "namespace"

# get subnet object that you will use in the next step                                
$virtualNetwork = Get-AzVirtualNetwork -ResourceGroupName  $rgName -Name $vnetName
$subnet = $virtualNetwork | Select -ExpandProperty subnets `
                                | Where-Object  {$_.Name -eq $subnetName}  
   
# now, create private endpoint   
$privateEndpoint = New-AzPrivateEndpoint -ResourceGroupName $rgName  `
                                -Name $vnetName   `
                                -Location $vnetlocation `
                                -Subnet  $subnet   `
                                -PrivateLinkServiceConnection $privateEndpointConnection

(Get-AzResource -ResourceId $namespaceResource.ResourceId -ExpandProperties).Properties


```

## <a name="manage-private-endpoints-using-azure-portal"></a>Управление частными конечными точками с помощью портал Azure

При создании частной конечной точки подключение должно быть утверждено. Если ресурс (пространство имен ретранслятора), для которого создается частная конечная точка, находится в вашем каталоге, можно одобрить запрос на подключение, в котором есть права на управление пространством имен ретранслятора. При подключении к пространству имен ретранслятора, для которого отсутствует доступ для управления, необходимо дождаться, пока владелец этого ресурса утвердит запрос на подключение.

Существует четыре состояния подготовки:

| Действие службы | Состояние частной конечной точки объекта-получателя службы | Описание |
|--|--|--|
| None | Ожидает | Соединение создается вручную и ожидает утверждения от владельца Azure Relay пространства имен. |
| Утверждение | Approved | Подключение утверждено автоматически или вручную и готово к использованию. |
| Reject | Отклонено | Соединение было отклонено владельцем Azure Relay пространства имен. |
| Удалить | Отключено | Соединение было удалено владельцем Azure Relay пространства имен. Частная конечная точка будет информативной и должна быть удалена для очистки. |
 
###  <a name="approve-reject-or-remove-a-private-endpoint-connection"></a>Утверждение, отклонение или удаление подключения к частной конечной точке

1. Войдите на портал Azure.
1. В строке поиска введите **Relay**.
1. Выберите **пространство имен** , которым требуется управлять.
1. Перейдите на вкладку **сети** .
5. Перейдите к соответствующему разделу в зависимости от операции, которую нужно выполнить: утвердить, отклонить или удалить. 

### <a name="approve-a-private-endpoint-connection"></a>Утверждение подключения к частной конечной точке

1. Если ожидаются какие-либо подключения, в состоянии подготовки вы увидите подключение в списке **Ожидание** . 
2. Выберите **закрытую конечную точку** , которую вы хотите утвердить
3. Нажмите кнопку **утвердить** .

    ![Утвердить закрытую конечную точку](./media/private-link-service/private-endpoint-approve.png)
4. На странице **утверждение соединения** введите необязательный **Комментарий**и нажмите кнопку **Да**. Если выбрано значение **нет**, ничего не происходит. 

    ![Страница «утверждение соединения»](./media/private-link-service/approve-connection-page.png)
5. Вы увидите, что состояние соединения в списке изменено на **утверждено**.

### <a name="reject-a-private-endpoint-connection"></a>Отклонение подключения к частной конечной точке

1. Если существуют подключения к частным конечным точкам, которые вы хотите отклонить, будь то ожидающий запрос или существующее подключение, которое было утверждено ранее, выберите подключение к конечной точке и нажмите кнопку **отклонить** .

    ![Кнопка "отклонить"](./media/private-link-service/private-endpoint-reject.png)
2. На странице **отклонить подключение** введите необязательный комментарий и нажмите кнопку **Да**. Если выбрано значение **нет**, ничего не происходит. 

    ![Страница «отклонение соединения»](./media/private-link-service/reject-connection-page.png)
3. Состояние подключения должно отобразиться в списке **отклонено**.


### <a name="remove-a-private-endpoint-connection"></a>Удаление подключения к частной конечной точке

1. Чтобы удалить подключение к частной конечной точке, выберите его в списке и нажмите кнопку **Удалить** на панели инструментов. 

    ![Кнопка "Удалить"](./media/private-link-service/remove-endpoint.png)
2. На странице **Удаление подключения** выберите **Да** , чтобы подтвердить удаление закрытой конечной точки. Если выбрано значение **нет**, ничего не происходит. 

    ![Страница «Удаление соединения»](./media/private-link-service/delete-connection-page.png)
3. Вы увидите, что состояние изменилось на **отключено**. Затем вы увидите, что конечная точка исчезнет из списка. 

## <a name="validate-that-the-private-link-connection-works"></a>Проверка работоспособности подключения Приватного канала
Необходимо проверить, что ресурсы в той же подсети частной конечной точки подключаются к пространству имен Azure Relay по его частному IP-адресу.

Для этого теста создайте виртуальную машину, выполнив действия, описанные в разделе [Создание виртуальной машины Windows на портал Azure](../virtual-machines/windows/quick-create-portal.md)

На вкладке **Сетевые подключения** выполните следующие действия. 

1. Укажите **виртуальную сеть** и **подсеть**. Необходимо выбрать виртуальную сеть, в которой развернута частная конечная точка.
2. Укажите ресурс **общедоступного IP-адреса** .
3. Для **группы безопасности сети сетевой карты**выберите **нет**.
4. Для **балансировки нагрузки**выберите **нет**.

Подключитесь к виртуальной машине и откройте командную строку и выполните следующую команду:

```console
nslookup <your-relay-namespace-name>.servicebus.windows.net
```

Вы увидите результат, который выглядит следующим образом. 

```console
Non-authoritative answer:
Name:    <namespace-name>.privatelink.servicebus.windows.net
Address:  10.0.0.4 (private IP address associated with the private endpoint)
Aliases:  <namespace-name>.servicebus.windows.net
```

## <a name="limitations-and-design-considerations"></a>Проблемы и ограничения разработки

### <a name="design-considerations"></a>Рекомендации по проектированию
- Частная конечная точка для Azure Relay доступна в **общедоступной предварительной версии**. 
- Сведения о ценах для Приватного канала Azure (предварительная версия) см. [здесь](https://azure.microsoft.com/pricing/details/private-link/).

### <a name="limitations"></a>Ограничения 
- Максимальное число частных конечных точек на Azure Relayое пространство имен: 64.
- Максимальное число Azure Relay пространств имен с частными конечными точками на подписку: 64.
- Правила группы безопасности сети (NSG) и определяемые пользователем маршруты не применяются к частной конечной точке. Дополнительные сведения см. в разделе [Служба частной связи Azure: ограничения](../private-link/private-link-service-overview.md#limitations)

## <a name="next-steps"></a>Next Steps

- См. дополнительные сведения о службе [Приватный канал Azure (предварительная версия)](../private-link/private-link-service-overview.md).
- Дополнительные сведения о [Azure Relay](relay-what-is-it.md)
