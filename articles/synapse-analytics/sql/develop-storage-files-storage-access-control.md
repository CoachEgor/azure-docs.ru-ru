---
title: Управление доступом к учетной записи хранения в SQL по запросу (предварительная версия)
description: В этой статье приведены сведения о том, как служба SQL по запросу (предварительная версия) обращается к службе хранилища Azure и как можно управлять доступом к хранилищу для SQL по запросу в Azure Synapse Analytics.
services: synapse-analytics
author: filippopovic
ms.service: synapse-analytics
ms.topic: overview
ms.subservice: ''
ms.date: 04/15/2020
ms.author: fipopovi
ms.reviewer: jrasnick, carlrab
ms.openlocfilehash: 0d2683091898e9c84457b3b538776f0e6b0469d4
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81420058"
---
# <a name="control-storage-account-access-for-sql-on-demand-preview-in-azure-synapse-analytics"></a>Управление доступом к учетной записи хранения в SQL по запросу (предварительная версия) в Azure Synapse Analytics

SQL по запросу (предварительная версия) позволяет создавать запросы для чтения файлов непосредственно из службы хранилища Azure. Так как учетная запись хранения является внешним объектом по отношению к ресурсу SQL по запросу, нужно предоставить соответствующие учетные данные. Пользователь должен иметь разрешения на использование учетных данных для доступа. В этой статье описываются типы учетных данных, которые вы можете использовать, и способ поиска учетных данных для пользователей SQL и Azure AD.

## <a name="supported-storage-authorization-types"></a>Поддерживаемые типы авторизации в службе хранилища

Пользователь, выполнивший вход в ресурс SQL по запросу, должен иметь права на доступ и запросы к файлам в службе хранилища Azure. Поддерживаются три типа авторизации.

- [Подписанный URL-адрес](#shared-access-signature)
- [Управляемое удостоверение](#managed-identity)
- [Удостоверение пользователя](#user-identity)

> [!NOTE]
> По умолчанию при создании рабочей области действует [сквозная аутентификация Azure AD](#force-azure-ad-pass-through). Это избавляет от необходимости создавать учетные данные для каждой учетной записи хранения, к которой осуществляется доступ по имени входа AD. Это поведение [можно отключить](#disable-forcing-azure-ad-pass-through).

В таблице ниже перечислены различные типы авторизации, которые уже поддерживаются или будут поддерживаться в ближайшее время.

| Тип авторизации                    | *Пользователь SQL*    | *Пользователь Azure AD*     |
| ------------------------------------- | ------------- | -----------    |
| [SAS](#shared-access-signature)       | Поддерживается     | Поддерживается      |
| [Управляемое удостоверение](#managed-identity) | Не поддерживается | Не поддерживается  |
| [Удостоверение пользователя](#user-identity)       | Не поддерживается | Поддерживается      |

### <a name="shared-access-signature"></a>Подписанный URL-адрес

**Подписанный URL-адрес (SAS)** предоставляет делегированный доступ к ресурсам в учетной записи хранения. С помощью SAS можно предоставить клиентам доступ к ресурсам в учетной записи хранения, не передавая им ключи учетной записи. SAS обеспечивает детальный контроль над типом доступа, который вы предоставляете клиентам с конкретным SAS, включая период действия, предоставленные разрешения, допустимый диапазон IP-адресов и допустимый протокол (HTTPS или HTTP).

Маркер SAS можно получить на портале Azure, последовательно открыв пункты **Учетная запись хранения —> Подписанный URL-адрес —> Настроить разрешения —> Создать SAS и строку подключения**.

> [!IMPORTANT]
> Созданный маркер SAS содержит вопросительный знак ("?") в начале строки. Чтобы применить этот маркер для SQL по запросу, удалите символ вопросительного знака ("?") при создании учетных данных. Пример:
>
> Маркер SAS: ?sv=2018-03-28&ss=bfqt&srt=sco&sp=rwdlacup&se=2019-04-18T20:42:12Z&st=2019-04-18T12:42:12Z&spr=https&sig=lQHczNvrk1KoYLCpFdSsMANd0ef9BrIPBNJ3VYEIq78%3D

### <a name="user-identity"></a>Удостоверение пользователя

**Удостоверение пользователя** используется для типа авторизации "сквозная аутентификация", при которой удостоверение пользователя Azure AD, выполнившего вход в SQL по запросу, применяется для авторизации доступа к данным. Перед обращением к данным администратор службы хранилища Azure должен предоставить разрешения соответствующему пользователю Azure AD. Как указано в таблице выше, этот тип не поддерживается для типа пользователя SQL.

> [!NOTE]
> Использование [сквозной аутентификации Azure AD](#force-azure-ad-pass-through) избавляет от необходимости создавать учетные данные для каждой учетной записи хранения, к которой осуществляется доступ по именам входа AD.

> [!IMPORTANT]
> Чтобы использовать удостоверение для доступа к данным, необходимо иметь роль владельца, участника или читателя данных для BLOB-объекта в хранилище.
> Даже если вы являетесь владельцем учетной записи хранения, вам придется добавить себя в одну из ролей для данных BLOB-объекта хранилища.
>
> Дополнительные сведения см. в статье [Access control in Azure Data Lake Storage Gen2](../../storage/blobs/data-lake-storage-access-control.md) (Контроль доступа в Azure Data Lake Storage 2-го поколения).
>

### <a name="managed-identity"></a>Управляемое удостоверение

**Управляемое удостоверение** иногда обозначается как MSI. Это функция Azure Active Directory (Azure AD), которая предоставляет службы Azure для SQL по запросу. Также она развертывает автоматически управляемое удостоверение в Azure AD. Это удостоверение можно использовать для авторизации запроса на доступ к данным в службе хранилища Azure.

Перед обращением к данным администратор службы хранилища Azure должен предоставить управляемому удостоверению разрешения на доступ к данным. Предоставление разрешений управляемому удостоверению выполняется точно так же, как любому другому пользователю Azure AD.

## <a name="create-credentials"></a>Создание учетных данных

Чтобы выполнить запрос к файлу, который размещен в службе хранилища Azure, конечная точка SQL по запросу должна иметь учетные данные (CREDENTIAL) уровня сервера с информацией об аутентификации. Для добавления учетных данных выполните инструкцию [CREATE CREDENTIAL](/sql/t-sql/statements/create-credential-transact-sql?toc=/azure/synapse-analytics/toc.json&bc=/azure/synapse-analytics/breadcrumb/toc.json&view=azure-sqldw-latest). Необходимо указать аргумент CREDENTIAL NAME. Он должен соответствовать пути к данным в хранилище или некоторой части этого пути (см. ниже).

> [!NOTE]
> Аргумент FOR CRYPTOGRAPHIC PROVIDER не поддерживается.

Для всех поддерживаемых типов авторизации учетные данные могут указывать на учетную запись, контейнер, любой каталог (ниже корневого) или отдельный файл.

Аргумент CREDENTIAL NAME должен содержать полный путь к контейнеру, папке или файлу в следующем формате: `<prefix>://<storage_account_path>/<storage_path>`

| Внешний источник данных       | Prefix | Путь к учетной записи хранения                                |
| -------------------------- | ------ | --------------------------------------------------- |
| хранилище BLOB-объектов Azure         | HTTPS  | <учетная_запись_хранилища>.blob.core.windows.net             |
| Хранилище Azure Data Lake Storage 1-го поколения | HTTPS  | <учетная_запись_хранилища>.azuredatalakestore.net/webhdfs/v1 |
| Azure Data Lake Storage 2-го поколения | HTTPS  | <учетная_запись_хранилища>.dfs.core.windows.net              |

 Элемент <учетная_запись_хранилища> содержит путь в хранилище, указывающий на папку или файл, который нужно считать.

> [!NOTE]
> Существует специальное значение `UserIdentity` для CREDENTIAL NAME, которое [принудительно применяет сквозную аутентификацию Azure AD](#force-azure-ad-pass-through). Изучите, как оно влияет на [поиск учетных данных](#credential-lookup) при выполнении запросов.

Кроме того, чтобы разрешить пользователю создавать или удалять учетные данные, администратор может предоставить пользователю разрешение GRANT/DENY ALTER ANY CREDENTIAL.

```sql
GRANT ALTER ANY CREDENTIAL TO [user_name];
```

### <a name="supported-storages-and-authorization-types"></a>Поддерживаемые типы авторизации и хранилища

Вы можете использовать следующие сочетания типов авторизации и хранилища Azure.

|                     | Хранилище BLOB-объектов   | ADLS 1-го поколения        | ADLS 2-го поколения     |
| ------------------- | ------------   | --------------   | -----------   |
| *SAS*               | Поддерживается      | Не поддерживается   | Поддерживается     |
| *Управляемое удостоверение* | Не поддерживается  | Не поддерживается    | Не поддерживается |
| *Удостоверение пользователя*    | Поддерживается      | Поддерживается        | Поддерживается     |

### <a name="examples"></a>Примеры

В зависимости от [типа авторизации](#supported-storage-authorization-types) вы можете создать учетные данные с помощью приведенного ниже синтаксиса T-SQL.

**Подписанные URL-адреса и хранилище BLOB-объектов**

Замените <*mystorageaccountname*> реальным именем учетной записи хранения, а <*mystorageaccountcontainername*> — именем контейнера:

```sql
CREATE CREDENTIAL [https://<mystorageaccountname>.blob.core.windows.net/<mystorageaccountcontainername>]
WITH IDENTITY='SHARED ACCESS SIGNATURE'
, SECRET = 'sv=2018-03-28&ss=bfqt&srt=sco&sp=rwdlacup&se=2019-04-18T20:42:12Z&st=2019-04-18T12:42:12Z&spr=https&sig=lQHczNvrk1KoYLCpFdSsMANd0ef9BrIPBNJ3VYEIq78%3D';
GO
```

**Удостоверение пользователя и Azure Data Lake Storage 1-го поколения**

Замените <*mystorageaccountname*> реальным именем учетной записи хранения, а <*mystorageaccountcontainername*> — именем контейнера:

```sql
CREATE CREDENTIAL [https://<mystorageaccountname>.azuredatalakestore.net/webhdfs/v1/<mystorageaccountcontainername>]
WITH IDENTITY='User Identity';
GO
```

**Удостоверение пользователя и Azure Data Lake Storage 2-го поколения**

Замените <*mystorageaccountname*> реальным именем учетной записи хранения, а <*mystorageaccountcontainername*> — именем контейнера:

```sql
CREATE CREDENTIAL [https://<mystorageaccountname>.dfs.core.windows.net/<mystorageaccountcontainername>]
WITH IDENTITY='User Identity';
GO
```

## <a name="force-azure-ad-pass-through"></a>Принудительное применение сквозной аутентификации Azure AD

Сквозная аутентификация Azure AD применяется принудительно по умолчанию, если указано специальное значение `UserIdentity` для параметра CREDENTIAL NAME, которое создается автоматически во время подготовки рабочей области Azure Synapse. В этом режиме использование сквозной аутентификации Azure AD является обязательным для каждого запроса от любого имени входа Azure AD, независимо от наличия других учетных данных.

> [!NOTE]
> Сквозная аутентификация Azure AD является поведением по умолчанию. Вам не нужно создавать учетные данные для каждой учетной записи хранения, к которой осуществляется доступ по именам входа AD.

Если вы [отключили принудительное применение сквозной аутентификации Azure AD для каждого запроса](#disable-forcing-azure-ad-pass-through) и намерены снова включить ее, выполните следующую команду:

```sql
CREATE CREDENTIAL [UserIdentity]
WITH IDENTITY = 'User Identity';
```

Чтобы включить принудительное применение сквозной аутентификации Azure AD для конкретного пользователя, предоставьте этому пользователю разрешение REFERENCE для учетных данных `UserIdentity`. Следующий пример включает принудительное применение сквозной аутентификации Azure AD для пользователя user_name:

```sql
GRANT REFERENCES ON CREDENTIAL::[UserIdentity] TO USER [user_name];
```

Дополнительные сведения о поиске учетных данных для использования в SQL по запросу см. в [этой статье](#credential-lookup).

## <a name="disable-forcing-azure-ad-pass-through"></a>Отключение принудительного применения сквозной аутентификации Azure AD

Вы можете отключить [принудительное применение сквозной аутентификации Azure AD для каждого запроса](#force-azure-ad-pass-through). Для этого удалите учетные данные `Userdentity` с помощью этой команды:

```sql
DROP CREDENTIAL [UserIdentity];
```

Если вы решите снова включить этот режим, воспользуйтесь инструкцией [Принудительное применение сквозной аутентификации Azure AD](#force-azure-ad-pass-through).

Чтобы отключить принудительное применение сквозной аутентификации Azure AD для конкретного пользователя, отмените для этого пользователя разрешение REFERENCE для учетных данных `UserIdentity`. Следующий пример отключает принудительное применение сквозной аутентификации Azure AD для пользователя user_name:

```sql
DENY REFERENCES ON CREDENTIAL::[UserIdentity] TO USER [user_name];
```

Дополнительные сведения о поиске учетных данных для использования в SQL по запросу см. в [этой статье](#credential-lookup).

## <a name="grant-permissions-to-use-credential"></a>Предоставление разрешений на использование учетных данных

Чтобы использовать учетные данные, пользователь должен иметь разрешение REFERENCES для этих учетных данных. Чтобы предоставить разрешение REFERENCES для учетных данных хранилища storage_credential конкретному пользователю specific_user, выполните такую команду:

```sql
GRANT REFERENCES ON CREDENTIAL::[storage_credential] TO [specific_user];
```

Чтобы обеспечить беспроблемную сквозную аутентификацию Azure AD, все пользователи по умолчанию получают право использовать учетные данные `UserIdentity`. Для этого при подготовке рабочей области Azure Synapse автоматически выполняется следующая инструкция:

```sql
GRANT REFERENCES ON CREDENTIAL::[UserIdentity] TO [public];
```

## <a name="credential-lookup"></a>Поиск учетных данных

При авторизации запросов применяется поиск учетных данных для доступа к учетной записи хранения и действуют следующие правила:

- Пользователь вошел в систему с именем для входа Azure AD.

  - Если существуют учетные данные UserIdentity и у пользователя есть разрешения на доступ к ним, будет использоваться сквозная аутентификация Azure AD. В противном случае выполняется [поиск учетных данных по пути](#lookup-credential-by-path).

- Пользователь вошел в систему с именем для входа SQL.

  - Используется [поиск учетных данных по пути](#lookup-credential-by-path).

### <a name="lookup-credential-by-path"></a>Поиск учетных данных по пути

Если принудительное применение сквозной аутентификации Azure AD отключено, выполняется поиск учетных данных на основе пути к хранилищу (в глубину), а также проверяется наличие разрешения REFERENCES для этих учетных данных. Если для доступа к одному файлу можно использовать несколько учетных данных, SQL по запросу будет использовать наиболее конкретный вариант.  

Ниже приведен пример запроса по следующему пути к файлу: *account.dfs.core.windows.net/filesystem/folder1/.../folderN/fileX.ext*

Поиск учетных данных в этом примере будет выполнен в следующем порядке:

```
account.dfs.core.windows.net/filesystem/folder1/.../folderN/fileX
account.dfs.core.windows.net/filesystem/folder1/.../folderN
account.dfs.core.windows.net/filesystem/folder1
account.dfs.core.windows.net/filesystem
account.dfs.core.windows.net
```

Если пользователь не имеет разрешения REFERENCES на учетные данные с номером 5, SQL по запросу проверит, имеет ли пользователь разрешение REFERENCES на учетные данные на один уровень выше, и так далее, пока не обнаружит учетные данные, на которые пользователь имеет такое разрешение. Если разрешение не найдено, возвращается сообщение об ошибке.

### <a name="credential-and-path-level"></a>Учетные данные и уровень пути

В зависимости от нужной формы пути к выполнению запросов предъявляются следующие требования.

- Если запрос затрагивает несколько файлов или папок (независимо от наличия подстановочных знаков), пользователь должен иметь доступ к учетным данным по крайней мере на уровне корневого каталога (контейнера). Это связано с тем, что файлы перечисляются относительно корневого каталога (ограничения службы хранилища Azure).
- Если запрос выполняется для одного файла, пользователь должен иметь доступ к учетным данным на любом уровне, так как SQL по запросу обращается к файлу напрямую, то есть без перечисления папок.

|                  | *Учетная запись* | *Корневой каталог* | *Любой другой каталог* | *Файл*        |
| ---------------- | --------- | ---------------- | --------------------- | ------------- |
| *Один файл*    | Поддерживается | Поддерживается        | Поддерживается             | Поддерживается     |
| *Несколько файлов* | Поддерживается | Поддерживается        | Не поддерживается         | Не поддерживается |

## <a name="next-steps"></a>Дальнейшие действия

Приведенные ниже статьи помогут узнать, как включать в запрос разные типы папок и файлов, а также создавать и использовать представления.

- [Запрашивание одного CSV-файла](query-single-csv-file.md)
- [Запрашивание папок и нескольких CSV-файлов](query-folders-multiple-csv-files.md)
- [Запрашивание конкретных файлов](query-specific-files.md)
- [Запрашивание файлов Parquet](query-parquet-files.md)
- [Создание и использование представлений](create-use-views.md)
- [Запрашивание JSON-файлов](query-json-files.md)
- [Запрашивание вложенных типов Parquet](query-parquet-nested-types.md)
