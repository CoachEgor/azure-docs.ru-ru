---
title: Рекомендации по использованию SQL по запросу (предварительная версия)
description: Рекомендации и лучшие методики, которые следует учитывать при работе с SQL по запросу (предварительная версия).
services: synapse-analytics
author: filippopovic
manager: craigg
ms.service: synapse-analytics
ms.topic: conceptual
ms.subservice: ''
ms.date: 05/01/2020
ms.author: fipopovi
ms.reviewer: jrasnick
ms.openlocfilehash: 79318ab67ec58ed10520365a366785ea0de41666
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83836334"
---
# <a name="best-practices-for-sql-on-demand-preview-in-azure-synapse-analytics"></a>Рекомендации по использованию SQL по запросу (предварительная версия) в Azure Synapse Analytics

В этой статье предоставлен набор рекомендаций по использованию SQL по запросу (предварительная версия). SQL по запросу — это ресурс в Azure Synapse Analytics.

## <a name="general-considerations"></a>Общие рекомендации

SQL по запросу позволяет запрашивать файлы в учетных записях хранения Azure. SQL по запросу не предоставляет возможности локального хранилища или приема данных. Таким образом, все файлы, предназначенные для запроса, являются внешними по отношению к SQL по запросу. Все, что связано с чтением файлов из хранилища, может оказать влияние на производительность запросов.

## <a name="colocate-your-azure-storage-account-and-sql-on-demand"></a>Совместное размещение учетной записи хранения Azure и SQL по запросу

Чтобы минимизировать задержку, разместите свою учетную запись хранения Azure совместно с конечной точкой SQL по запросу. Учетные записи хранения и конечные точки, подготовленные во время создания рабочей области, расположены в одном регионе.

Для обеспечения оптимальной производительности при доступе к другим учетным записям хранения с помощью SQL по запросу убедитесь, что они расположены в одном регионе. Если они не расположены в одном регионе, будет увеличена задержка сетевой передачи данных между удаленным регионом и регионом конечной точки.

## <a name="azure-storage-throttling"></a>Регулирование службы хранилища Azure

Несколько приложений и служб могут получить доступ к вашей учетной записи хранения. Регулирование хранилища происходит, когда общая скорость операций ввода-вывода в секунду или пропускная способность приложений, служб и рабочей нагрузки SQL по запросу превышают ограничения учетной записи хранения. В результате вы получаете значительное негативное воздействие на производительность запросов.

В SQL по запросу предусмотрена встроенная обработка для устранения регулирования при его обнаружении. SQL по запросу будет выполнять запросы к хранилищу в более низком темпе, пока регулирование не будет завершено.

> [!TIP]
> Для оптимального выполнения запросов не следует усложнять работу учетной записи хранения другими рабочими нагрузками во время выполнения запроса.

## <a name="prepare-files-for-querying"></a>Подготовка файлов к запросам

По возможности вы можете подготовить файлы для повышения производительности:

- Преобразуйте CSV и JSON в Parquet. Parquet — это формат столбцов. Благодаря сжатию файлы в этом формате меньше по размеру, чем CSV- или JSON-файлы с теми же данными. Для SQL по запросу требуется меньше времени и запросов к хранилищу для чтения данных.
- Если запрос предназначен для одного большого файла, рекомендуется разделить его на несколько файлов меньшего размера.
- Попробуйте использовать CSV-файл размером менее 10 ГБ.
- Лучше иметь одинаковый размер файлов для одного пути OPENROWSET или для РАСПОЛОЖЕНИЯ внешней таблицы.
- Разделите данные, сохранив разделы в разных папках или файлах. См. раздел [Использование функций fileinfo и filepath для назначения конкретных разделов](#use-filename-and-filepath-functions-to-target-specific-partitions).

## <a name="push-wildcards-to-lower-levels-in-the-path"></a>Отправка подстановочных знаков на более низкие уровни в пути

В пути можно использовать подстановочные знаки, чтобы [запрашивать несколько файлов и папок](develop-storage-files-overview.md#query-multiple-files-or-folders). SQL по запросу с помощью API хранилища выводит список файлов в учетной записи хранения, начиная с первого знака "*". При этом файлы, которые не соответствуют указанному пути, исключаются. Сокращение исходного списка файлов может повысить производительность, если есть много файлов, соответствующих указанному пути до первого подстановочного знака.

## <a name="use-appropriate-data-types"></a>Использование соответствующих типов данных

Типы данных, используемые в запросе, влияют на производительность. Производительность можно повысить следующим образом: 

- Используйте наименьший размер данных, соответствующий максимально возможному значению.
  - Если максимальная длина символьного значения равна 30 символам, используйте символьный тип данных длиной 30 символов.
  - Если все символьные значения столбцов имеют фиксированный размер, используйте тип **char** или **nchar**. В противном случае используйте тип **varchar** или **nvarchar**.
  - Если максимальное значение целочисленного столбца равно 500, используйте **smallint**, так как это минимальный тип данных, который может соответствовать этому значению. Диапазоны целочисленных типов данных можно найти в [этой статье](https://docs.microsoft.com/sql/t-sql/data-types/int-bigint-smallint-and-tinyint-transact-sql?view=sql-server-ver15).
- По возможности используйте тип **varchar** и **char** вместо **nvarchar** и **nchar**.
- По возможности используйте целочисленные типы данных. Операции SORT, JOIN и GROUP BY выполняются быстрее на основе целых чисел, чем на основе символьных данных.
- Если используется вывод схемы, [проверьте выводимые типы данных](#check-inferred-data-types).

## <a name="check-inferred-data-types"></a>Проверка выводимых типов данных

[Вывод схемы](query-parquet-files.md#automatic-schema-inference) помогает быстро создавать запросы и исследовать данные, не зная схемы файлов. Недостаток, связанный с этим удобством, заключается в том, что выводимые типы данных больше, чем фактические типы данных. Это происходит, когда в исходных файлах недостаточно сведений, чтобы обеспечить использование соответствующего типа данных. Например, файлы Parquet не содержат метаданных о максимальной длине символьного столбца, поэтому SQL по запросу выводит их как тип varchar (8000).

Вы можете проверить результирующие типы данных запроса с помощью [sp_describe_first_results_set](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-describe-first-result-set-transact-sql?view=sql-server-ver15).

В следующем примере показано, как оптимизировать выводимые типы данных. Эта процедура используется для отображения выводимых типов данных: 
```sql  
EXEC sp_describe_first_result_set N'
    SELECT
        vendor_id, pickup_datetime, passenger_count
    FROM 
        OPENROWSET(
            BULK ''https://sqlondemandstorage.blob.core.windows.net/parquet/taxi/*/*/*'',
            FORMAT=''PARQUET''
        ) AS nyc';
```

Вот результирующий набор:

|is_hidden|column_ordinal|name|system_type_name|max_length|
|----------------|---------------------|----------|--------------------|-------------------||
|0|1|vendor_id|varchar(8000)|8000|
|0|2|pickup_datetime|datetime2(7)|8|
|0|3|passenger_count|INT|4|

После получения сведений о выводимых типах данных для запроса можно указать соответствующие типы данных:

```sql  
SELECT
    vendor_id, pickup_datetime, passenger_count
FROM 
    OPENROWSET(
        BULK 'https://sqlondemandstorage.blob.core.windows.net/parquet/taxi/*/*/*',
        FORMAT='PARQUET'
    ) 
    WITH (
        vendor_id varchar(4), -- we used length of 4 instead of the inferred 8000
        pickup_datetime datetime2,
        passenger_count int
    ) AS nyc;
```

## <a name="use-filename-and-filepath-functions-to-target-specific-partitions"></a>Использование функций filename и filepath для назначения конкретных разделов

Данные часто организованы в разделы. Вы можете указать, чтобы служба "SQL по запросу" запрашивала определенные папки и файлы. Это сокращает количество файлов и объем данных для чтения и обработки в рамках запроса. Дополнительное преимущество — это увеличение производительности.

См. дополнительные сведения о функциях [filename](develop-storage-files-overview.md#filename-function) и [filepath](develop-storage-files-overview.md#filepath-function), а также примеры [запросов к конкретным файлам](query-specific-files.md).

> [!TIP]
> Всегда приводите результаты функций filepath и filename к соответствующим типам данных. Если используются символьные типы данных, убедитесь, что используется соответствующая длина.

> [!NOTE]
> Функции filepath и filename, используемые для исключения разделов, сейчас не поддерживаются для внешних таблиц (кроме функций, созданных автоматически для каждой таблицы, созданной в Apache Spark для Azure Synapse Analytics).

Если хранимые данные не секционированы, рекомендуем их секционировать. В таком случае вы сможете использовать эти функции для оптимизации запросов, предназначенных для этих файлов. При [выполнении запроса к секционированным таблицам Apache Spark для Azure Synapse](develop-storage-files-spark-tables.md) из SQL по запросу запрос будет автоматически направлен только к необходимым файлам.

## <a name="use-parser_version-20-to-query-csv-files"></a>Использование PARSER_VERSION 2.0 для запросов к CSV-файлам

При запросах к CSV-файлам можно использовать оптимизированное для высокой производительности средство синтаксического анализа. Дополнительные сведения см. в статье о [PARSER_VERSION](develop-openrowset.md).

## <a name="use-cetas-to-enhance-query-performance-and-joins"></a>Использование CETAS для повышения производительности и улучшения соединений запросов

[CETAS](develop-tables-cetas.md) — одна из наиболее важных функций, доступных в SQL по запросу. CETAS — это параллельная операция, которая создает метаданные внешней таблицы и экспортирует результаты запроса SELECT в набор файлов в учетной записи хранения.

CETAS можно использовать для сохранения часто используемых частей запросов (например, соединенных ссылочных таблиц) в новый набор файлов. Далее можно выполнить объединение с этой отдельной внешней таблицей вместо повторного выполнения операций объединения в нескольких запросах.

Так как CETAS создает файлы Parquet, статистика создается автоматически, когда первый запрос направляется в эту внешнюю таблицу, что приводит к повышению производительности.

## <a name="azure-ad-pass-through-performance"></a>Производительность сквозного доступа через Azure AD

SQL по запросу позволяет получать доступ к файлам в хранилище, используя сквозной доступ через Azure Active Directory (Azure AD) или учетные данные SAS. Использование сквозного доступа через Azure AD может вызвать снижение производительности по сравнению с использованием SAS.

Если вы хотите увеличить производительность, попробуйте использовать учетные данные SAS для доступа к хранилищу, пока не будет увеличена производительность сквозного доступа через Azure AD.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о распространенных проблемах и способах их решения см. в статье об [устранении неполадок](../sql-data-warehouse/sql-data-warehouse-troubleshoot.md?toc=/azure/synapse-analytics/toc.json&bc=/azure/synapse-analytics/breadcrumb/toc.json). Если вы работаете с пулами SQL, а не с SQL по запросу, для получения справочных сведений см. [рекомендации по использованию пулов SQL](best-practices-sql-pool.md).
