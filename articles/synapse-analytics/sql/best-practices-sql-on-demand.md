---
title: Рекомендации по использованию SQL по запросу (Предварительная версия) в Azure синапсе Analytics
description: Рекомендации и рекомендации, которые следует учитывать при работе с SQL по запросу (Предварительная версия).
services: synapse-analytics
author: filippopovic
manager: craigg
ms.service: synapse-analytics
ms.topic: conceptual
ms.subservice: ''
ms.date: 05/01/2020
ms.author: fipopovi
ms.reviewer: jrasnick
ms.openlocfilehash: 0015beadfea61fc31bf3f37232105b9cfd2ced71
ms.sourcegitcommit: 366e95d58d5311ca4b62e6d0b2b47549e06a0d6d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2020
ms.locfileid: "82692145"
---
# <a name="best-practices-for-sql-on-demand-preview-in-azure-synapse-analytics"></a>Рекомендации по использованию SQL по запросу (Предварительная версия) в Azure синапсе Analytics

В этой статье вы найдете набор рекомендаций по использованию SQL по запросу (Предварительная версия). SQL по запросу — это дополнительный ресурс в Azure синапсе Analytics.

## <a name="general-considerations"></a>Общие рекомендации

SQL on-Demand позволяет запрашивать файлы в учетных записях хранения Azure. У него нет возможностей локального хранилища или приема. Таким образом, все файлы, предназначенные для запроса, являются внешними по отношению к SQL по запросу. Все, что связано с чтением файлов из хранилища, может оказать влияние на производительность запросов.

## <a name="colocate-azure-storage-account-and-sql-on-demand"></a>Совместное размещение учетной записи хранения Azure и SQL по запросу

Чтобы максимально сокращать задержку, совместно находите учетную запись хранения Azure и конечную точку SQL по запросу. Учетные записи хранения и конечные точки, подготовленные во время создания рабочей области, находятся в одном регионе.

Для обеспечения оптимальной производительности при доступе к другим учетным записям хранения с помощью SQL по требованию убедитесь, что они находятся в одном регионе. Если они не находятся в одном регионе, будет увеличена задержка передачи данных между регионами удаленной и конечной точки.

## <a name="azure-storage-throttling"></a>Регулирование хранилища Azure

Несколько приложений и служб могут получить доступ к вашей учетной записи хранения. Регулирование хранилища происходит, когда общая скорость операций ввода-вывода или пропускная способность, создаваемая приложениями, службами и рабочей нагрузкой SQL по запросу, превышает ограничения учетной записи хранения. В результате вы получаете значительное негативное воздействие на производительность запросов.

После обнаружения регулирования в SQL по запросу предусмотрена встроенная обработка этого сценария. SQL по запросу будет выполнять запросы к хранилищу в более низком темпе, пока регулирование не будет разрешено.

> [!TIP]
> Для оптимального выполнения запросов не следует запутать учетную запись хранения с другими рабочими нагрузками во время выполнения запроса.

## <a name="prepare-files-for-querying"></a>Подготовка файлов к запросам

По возможности вы можете подготовить файлы для повышения производительности:

- Преобразование CSV в Parquet-Parquet имеет формат столбцов. Так как он сжимается, размер файлов меньше CSV-файлов с теми же данными. SQL по запросу требует меньше времени и запросов на хранение для чтения.
- Если запрос предназначен для одного большого файла, вы получите преимущество от разделения его на несколько файлов меньшего размера.
- Попробуйте сохранить размер CSV-файла ниже 10 ГБ.
- Лучше иметь одинаковый размер файлов для одного пути OPENROWSET или расположения внешней таблицы.
- Разбейте данные путем хранения секций в разных папках или именах файлов. Установите флажок [использовать функции filename и FilePath для конкретных секций](#use-fileinfo-and-filepath-functions-to-target-specific-partitions).

## <a name="push-wildcards-to-lower-levels-in-path"></a>Отправка подстановочных знаков для более низких уровней по пути

В пути можно использовать подстановочные знаки для [запроса нескольких файлов и папок](develop-storage-files-overview.md#query-multiple-files-or-folders). Файлы SQL по запросу перечисляются в учетной записи хранения начиная с первого * с помощью API хранилища и удаляются файлы, не соответствующие указанному пути. Сокращение исходного списка файлов может повысить производительность, если имеется много файлов, соответствующих указанному пути вплоть до первого подстановочного знака.

## <a name="use-appropriate-data-types"></a>Использование соответствующих типов данных

Типы данных, используемые в запросе, влияют на производительность. Производительность можно повысить, если: 

- Используйте наименьший размер данных, который будет соответствовать максимально возможному значению.
  - Если максимальная длина символьного значения равна 30 символам, используйте символьный тип данных длиной 30 символов.
  - Если все значения символьных столбцов имеют фиксированный размер, используйте тип char или nchar. В противном случае используйте varchar или nvarchar.
  - Если максимальное значение целочисленного столбца равно 500, используйте smallint, так как это минимальный тип данных, который может разместить это значение. [Здесь](https://docs.microsoft.com/sql/t-sql/data-types/int-bigint-smallint-and-tinyint-transact-sql?view=sql-server-ver15)можно найти диапазоны целочисленных типов данных.
- По возможности используйте varchar и char вместо nvarchar и nchar.
- По возможности используйте типы данных на основе целых чисел. Операции сортировки, объединения и группировки выполняются быстрее на целых числах, чем на данных символов.
- Если используется вывод схемы, [Проверьте выводимый тип данных](#check-inferred-data-types).

## <a name="check-inferred-data-types"></a>Проверка выводимых типов данных

[Определение схемы](query-parquet-files.md#automatic-schema-inference) помогает быстро создавать запросы и исследовать данные, не зная схемы файлов. Это некомфортное дело касается расходов на выводимые типы данных, превышающие фактические. Это происходит, когда в исходных файлах недостаточно сведений, чтобы гарантировать использование соответствующего типа данных. Например, файлы Parquet не содержат метаданные о максимальной длине символьного столбца, а SQL on-Demand выводит его как varchar (8000). 

С помощью [sp_describe_first_results_set](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-describe-first-result-set-transact-sql?view=sql-server-ver15)можно проверить результирующие типы данных запроса.

В следующем примере показано, как оптимизировать выводимые типы данных. Процедура используется для отображения выводимых типов данных. 
```sql  
EXEC sp_describe_first_result_set N'
    SELECT
        vendor_id, pickup_datetime, passenger_count
    FROM 
        OPENROWSET(
            BULK ''https://sqlondemandstorage.blob.core.windows.net/parquet/taxi/*/*/*'',
            FORMAT=''PARQUET''
        ) AS nyc';
```

Результирующий набор:

|is_hidden|column_ordinal|name|system_type_name|max_length|
|----------------|---------------------|----------|--------------------|-------------------||
|0|1|vendor_id|varchar (8000)|8000|
|0|2|pickup_datetime|datetime2(7)|8|
|0|3|passenger_count|int|4|

После получения сведений о выводимых типах данных для запроса можно указать соответствующие типы данных:

```sql  
SELECT
    vendor_id, pickup_datetime, passenger_count
FROM 
    OPENROWSET(
        BULK 'https://sqlondemandstorage.blob.core.windows.net/parquet/taxi/*/*/*',
        FORMAT='PARQUET'
    ) 
    WITH (
        vendor_id varchar(4), -- we used length of 4 instead of inferred 8000
        pickup_datetime datetime2,
        passenger_count int
    ) AS nyc;
```

## <a name="use-fileinfo-and-filepath-functions-to-target-specific-partitions"></a>Использование функций FileInfo и FilePath для назначения конкретных секций

Данные часто организованы в секции. Можно указать SQL по запросу на выполнение запросов к определенным папкам и файлам. Эта функция сокращает количество файлов и объем данных, необходимых для чтения и обработки запроса. Дополнительная премия — это достижение лучшей производительности.

Дополнительные сведения см. в подменю функции [filename](develop-storage-files-overview.md#filename-function) и [FilePath](develop-storage-files-overview.md#filepath-function) и примеры [запросов к конкретным файлам](query-specific-files.md).

> [!TIP]
> Всегда приведите результат функции FilePath и FileInfo к соответствующим типам данных. Если используются символьные типы данных, убедитесь, что используется соответствующая длина.

Если хранимые данные не секционированы, рассмотрите возможность их секционирования, чтобы можно было использовать эти функции для оптимизации запросов, предназначенных для этих файлов. При [запросе секционированных таблиц Spark](develop-storage-files-spark-tables.md) из SQL по запросу будут автоматически нацелены только необходимые файлы.

## <a name="use-cetas-to-enhance-query-performance-and-joins"></a>Использование CETAS для повышения производительности и соединений запросов

[CETAS](develop-tables-cetas.md) — одна из наиболее важных функций, доступных в SQL по запросу. CETAS — это параллельная операция, которая создает метаданные внешней таблицы и экспортирует результаты запроса SELECT в набор файлов в учетной записи хранения.

CETAS можно использовать для хранения часто используемых частей запросов, например Объединенных ссылочных таблиц, в новый набор файлов. Далее можно присоединиться к этой отдельной внешней таблице, а не к повторяющимся частым объединениям в нескольких запросах.

Поскольку CETAS создает файлы Parquet, статистика создается автоматически, когда первый запрос обращается к этой внешней таблице, что приводит к повышению производительности.

## <a name="next-steps"></a>Дальнейшие действия

Общие проблемы и решения см. в статье [Устранение неполадок](../sql-data-warehouse/sql-data-warehouse-troubleshoot.md?toc=/azure/synapse-analytics/toc.json&bc=/azure/synapse-analytics/breadcrumb/toc.json) . Если вы работаете с пулом SQL, а не с SQL по запросу, ознакомьтесь со статьей рекомендации [по использованию пула SQL](best-practices-sql-pool.md) для получения конкретных руководств.
