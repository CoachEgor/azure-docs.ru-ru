---
title: Схема аналитики трафика Azure | Документация Майкрософт
description: Понимание схемы трафик аналитики для анализа журналов потоков для групп безопасности сети Azure.
services: network-watcher
documentationcenter: na
author: vinynigam
manager: agummadi
editor: ''
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/26/2019
ms.author: vinigam
ms.openlocfilehash: 9a02a56df85c5c6aa9fd177ad42a2f9bfb303e44
ms.sourcegitcommit: ac1cfe497341429cf62eb934e87f3b5f3c79948e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2019
ms.locfileid: "67491954"
---
# <a name="schema-and-data-aggregation-in-traffic-analytics"></a>Схема и данные агрегирование в аналитике трафика

"Аналитика трафика" — это облачное решение, которое позволяет следить за действиями пользователя и приложения в облачных сетях. Это решение анализирует журналы потоков группы безопасности сети (NSG) Наблюдателя за сетями, чтобы предоставить сведения о потоке трафика в облаке Azure. Решение "Аналитика трафика" позволяет выполнять следующее:

- Визуализировать сетевую активность в подписках Azure и определять самые активные узлы.
- Выявлять угрозы безопасности в сети и защитить ее инфраструктуру на основе сведений об открытых портах, приложениях, пытающихся получить доступ к Интернету, а также виртуальных машинах, подключающихся к несанкционированным сетям.
- Понять шаблоны потока трафика в регионах Azure и Интернете, чтобы оптимизировать развертывание сети для лучшей производительности и эффективного использования емкости.
- Оперативно обнаружить неверные сетевые конфигурации, которые приводят к сбоям подключений в сети.
- Знаете использования сети, в байтах, пакетов или потоки.

### <a name="data-aggregation"></a>Агрегация данных

1. Все журналы потоков в группу безопасности сети между «FlowIntervalStartTime_t» и «FlowIntervalEndTime_t» захватываются в интервалом в одну минуту в учетной записи хранения в виде больших двоичных объектов перед обработкой аналитики трафика.
2. По умолчанию обработка аналитики трафика выполняется 60 минут. Это означает, что каждые 60 минут, аналитика трафика выбирает BLOB-объектов из хранилища для статистической обработки.
3. Протокол (TCP или UDP) уровня последовательности с тем же исходный IP-адрес, конечный IP-адрес, порт назначения, имя группы безопасности сети, правила группы безопасности сети, направление потока и транспорта (Примечание: Исходный порт исключается для статистической обработки) установка маршрутов в один поток по аналитике трафика
4. Этот одну запись — декорированного (подробности в разделе ниже) и полученные в Log Analytics процессом Analytics.This трафика может потребоваться около 1 часа max.
5. Поле FlowStartTime_t Указывает первое вхождение такие статистические поток (же четырехэлементный кортеж) в последовательность журнала, обрабатывая интервал между «FlowIntervalStartTime_t» и «FlowIntervalEndTime_t».
6. Для любого ресурса в TA потоков, в пользовательском Интерфейсе, всего потоков, увиденное в группу безопасности сети, но в Log Anlaytics пользователь видит только один, уменьшенное на запись. Чтобы просмотреть все потоки, используйте поле blob_id, который можно ссылаться из хранилища. Общий поток для расчета, что запись будет соответствовать отдельных потоков, в большой двоичный объект.

Ниже запрос, помогает вам изучает поток журналов из локальной за последние 30 дней.
```
AzureNetworkAnalytics_CL
| where SubType_s == "FlowLog" and FlowStartTime_t >= ago(30d) and FlowType_s == "ExternalPublic"
| project Subnet_s  
```
Чтобы просмотреть путь BLOB-объектов для потоков в упомянутое выше запросе, используйте приведенный ниже запрос:

```
let TableWithBlobId =
(AzureNetworkAnalytics_CL
   | where SubType_s == "Topology" and ResourceType == "NetworkSecurityGroup" and DiscoveryRegion_s == Region_s and IsFlowEnabled_b
   | extend binTime = bin(TimeProcessed_t, 6h),
            nsgId = strcat(Subscription_g, "/", Name_s),
            saNameSplit = split(FlowLogStorageAccount_s, "/")
   | extend saName = iif(arraylength(saNameSplit) == 3, saNameSplit[2], '')
   | distinct nsgId, saName, binTime)
| join kind = rightouter (
   AzureNetworkAnalytics_CL
   | where SubType_s == "FlowLog"  
   | extend binTime = bin(FlowEndTime_t, 6h)
) on binTime, $left.nsgId == $right.NSGList_s  
| extend blobTime = format_datetime(todatetime(FlowIntervalStartTime_t), "yyyy MM dd hh")
| extend nsgComponents = split(toupper(NSGList_s), "/"), dateTimeComponents = split(blobTime, " ")
| extend BlobPath = strcat("https://", saName,
                        "@insights-logs-networksecuritygroupflowevent/resoureId=/SUBSCRIPTIONS/", nsgComponents[0],
                        "/RESOURCEGROUPS/", nsgComponents[1],
                        "/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/", nsgComponents[2],
                        "/y=", dateTimeComponents[0], "/m=", dateTimeComponents[1], "/d=", dateTimeComponents[2], "/h=", dateTimeComponents[3],
                        "/m=00/macAddress=", replace(@"-", "", MACAddress_s),
                        "/PT1H.json")
| project-away nsgId, saName, binTime, blobTime, nsgComponents, dateTimeComponents;

TableWithBlobId
| where SubType_s == "FlowLog" and FlowStartTime_t >= ago(30d) and FlowType_s == "ExternalPublic"
| project Subnet_s , BlobPath
```

Приведенный выше запрос создает URL-адрес для прямого доступа к BLOB-объекта. URL-адрес с заполнители приведен ниже:

```
https://{saName}@insights-logs-networksecuritygroupflowevent/resoureId=/SUBSCRIPTIONS/{subscriptionId}/RESOURCEGROUPS/{resourceGroup}/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/{nsgName}/y={year}/m={month}/d={day}/h={hour}/m=00/macAddress={macAddress}/PT1H.json

```

### <a name="fields-used-in-traffic-analytics-schema"></a>Поля, используемые в схеме аналитики трафика

Аналитика трафика построена на основе Log Analytics, пользовательские запросы могут выполняться на данных с аналитикой трафика и настройки оповещений на том же.

Ниже перечислены поля в схеме и будет

| Поле | Формат | Комментарии |
|:---   |:---    |:---  |
| TableName | AzureNetworkAnalytics_CL | Таблица для данных Anlaytics трафика
| SubType_s | FlowLog | Подтип для журналов потоков. Использовать только «FlowLog», другие значения SubType_s предназначены для внутренних рабочих компонентов продукта |
| FASchemaVersion_s |   1   | Версия Scehma. Не отражает версии журнала потоков NSG |
| TimeProcessed_t   | Дата и время в формате UTC  | Время, время аналитики трафика обработки журналов потоков необработанные из учетной записи хранения |
| FlowIntervalStartTime_t | Дата и время в формате UTC |  Время начала интервала обработки потока журнала. Это время, из которого измеряется интервал потока |
| FlowIntervalEndTime_t | Дата и время в формате UTC | Конечное время интервала обработки журнала потока |
| FlowStartTime_t | Дата и время в формате UTC |  Первое вхождение поток (который будет получить сводное) в интервал обработки журнала потока между «FlowIntervalStartTime_t» и «FlowIntervalEndTime_t». Этот поток получает объединяются в зависимости от логики статистической обработки |
| FlowEndTime_t | Дата и время в формате UTC | Последнее появление потока (который будет получить сводное) в интервал обработки журнала потока между «FlowIntervalStartTime_t» и «FlowIntervalEndTime_t». С точки зрения потока журнала v2 это поле содержит время начала последней последовательности с тем же четырехэлементный кортеж в (помечено как «B» в записи необработанных потока) |
| FlowType_s |  * IntraVNet <br> * InterVNet <br> * S2S <br> * P2S <br> * AzurePublic <br> * ExternalPublic <br> * MaliciousFlow <br> * Unknown Private <br> * Неизвестно | Определение в примечаниях ниже таблицы |
| SrcIP_s | Исходный IP-адрес | Будет пустым в случае AzurePublic и ExternalPublic потоков |
| DestIP_s | Конечный IP-адрес | Будет пустым в случае AzurePublic и ExternalPublic потоков |
| VMIP_s | IP-адрес виртуальной машины | Используется для AzurePublic и ExternalPublic потоков |
| PublicIP_s | Общедоступные IP-адреса | Используется для AzurePublic и ExternalPublic потоков |
| DestPort_d | Конечный порт | Порт, по которому входящего трафика |
| L4Protocol_s  | * T <br> * U  | Транспортный протокол. T = TCP <br> U = UDP |
| L7Protocol_s  | Имя протокола | Производный от конечный порт |
| FlowDirection_s | * Я = входящего трафика<br> * O = исходящего трафика | Направление потока в/из группы безопасности сети в соответствии с журнала потоков |
| FlowStatus_s  | * = Разрешен правилом группы безопасности сети <br> * D = запрещены правилом группы безопасности сети  | Состояние потока разрешено/nblocked группой безопасности в соответствии с журнала потоков |
| NSGList_s | \<SUBSCRIPTIONID>\/<RESOURCEGROUP_NAME>\/<NSG_NAME> | Группа безопасности сети (NSG), связанный с потоком |
| NSGRules_s | \<Значение 0 для индекса) >< NSG_RULENAME >\<направление потока >\<состояние потока >\<FlowCount ProcessedByRule > |  Правило группы безопасности сети, разрешен или запрещен этот поток |
| NSGRuleType_s | * Определяемые пользователем * по умолчанию |   Тип правила группы безопасности сети, используемые потоком |
| MACAddress_s | MAC-адрес | MAC-адрес сетевого адаптера, по которому был записан поток |
| Subscription_s | Подписка Azure виртуальной сети и сетевой интерфейс / виртуальной машины заполняется в этом поле | Применимо только для FlowType = S2S, P2S, AzurePublic, ExternalPublic, MaliciousFlow и UnknownPrivate типы flow (flow типы, где только одна сторона — azure) |
| Subscription1_s | Идентификатор подписки | Идентификатор подписки, виртуальной сети / сетевой интерфейс или виртуальную машину, к которой принадлежит IP-адрес источника в потоке |
| Subscription2_s | Идентификатор подписки | Идентификатор подписки, виртуальной сети / сетевой интерфейс или виртуальную машину, к которой принадлежит IP-адрес назначения в потоке |
| Region_s | Регион Azure в виртуальной сети / сетевой интерфейс или виртуальную машину, к которой принадлежит IP-адрес в потоке | Применимо только для FlowType = S2S, P2S, AzurePublic, ExternalPublic, MaliciousFlow и UnknownPrivate типы flow (flow типы, где только одна сторона — azure) |
| Region1_s | Регион Azure | Регион Azure в виртуальной сети / сетевой интерфейс или виртуальную машину, к которой принадлежит IP-адрес источника в потоке |
| Region2_s | Регион Azure | Регион Azure в виртуальной сети, к которой принадлежит IP-адрес назначения в потоке |
| NIC_s | \<resourcegroup_Name >\/\<NetworkInterfaceName > |  Сетевая КАРТА, связанная с виртуальной Машиной, отправки и приема трафика |
| NIC1_s | < resourcegroup_Name > /\<NetworkInterfaceName > | Сетевая КАРТА, связанная с IP-адресом источника в потоке |
| NIC2_s | < resourcegroup_Name > /\<NetworkInterfaceName > | Сетевая КАРТА, связанная с IP-адрес назначения в потоке |
| VM_s | < Resourcegroup_Name >\/\<NetworkInterfaceName > | Виртуальная машина, связанная с сетевым интерфейсом NIC_s |
| VM1_s | < resourcegroup_Name > /\<VirtualMachineName > | Виртуальная машина, связанная с IP-адресом источника в потоке |
| VM2_s | < resourcegroup_Name > /\<VirtualMachineName > | Виртуальная машина, связанная с IP-адрес назначения в потоке |
| Subnet_s | <ResourceGroup_Name>/<VNET_Name>/\<SubnetName> | Подсеть, связанная с NIC_s |
| Subnet1_s | <ResourceGroup_Name>/<VNET_Name>/\<SubnetName> | Подсеть, связанная с IP-адрес источника в потоке |
| Subnet2_s | <ResourceGroup_Name>/<VNET_Name>/\<SubnetName>    | Подсеть, связанная с IP-адрес назначения в потоке |
| ApplicationGateway1_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<ApplicationGatewayName > | Шлюз приложений, связанных с IP-адрес источника в потоке |
| ApplicationGateway2_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<ApplicationGatewayName > | Шлюз приложений, связанных с IP-адрес назначения в потоке |
| LoadBalancer1_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<LoadBalancerName > | Подсистема балансировки нагрузки, связанная с IP-адрес источника в потоке |
| LoadBalancer2_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<LoadBalancerName > | Подсистема балансировки нагрузки, связанная с IP-адрес назначения в потоке |
| LocalNetworkGateway1_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<LocalNetworkGatewayName > | Шлюз локальной сети, связанные с IP-адрес источника в потоке |
| LocalNetworkGateway2_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<LocalNetworkGatewayName > | Шлюз локальной сети, связанные с IP-адрес назначения в потоке |
| ConnectionType_s | Возможные значения: VNetPeering VpnGateway и ExpressRoute |    Тип соединения |
| ConnectionName_s | \<Идентификатор подписки > /\<ResourceGroupName > /\<имя_подключения > | Имя подключения |
| ConnectingVNets_s | Разделенные пробелом список имен виртуальной сети | В случае звездообразной топологии здесь будут заполнены концентратора виртуальных сетей |
| Country_s | Двухбуквенный код страны (ISO 3166-1 альфа-версия 2) | Заполняется для типа потока ExternalPublic. Все IP-адреса в поле PublicIPs_s будут совместно использовать один и тот же код страны |
| AzureRegion_s | Регион Azure расположений | Заполняется для типа потока AzurePublic. Все IP-адреса в поле PublicIPs_s будут совместно использовать регион Azure |
| AllowedInFlows_d | | Число входящих потоков, которые были разрешены. Представляет число потоков, которые совместно же четырехэлементный кортеж, входящий на интерфейс netweork, по которому был записан поток |
| DeniedInFlows_d |  | Число входящих потоков, которые были запрещены. (Входящий трафик к сетевому интерфейсу, по которому был записан поток) |
| AllowedOutFlows_d | | Количество исходящих потоков, которые были разрешены (исходящий трафик к сетевому интерфейсу, по которому был записан поток) |
| DeniedOutFlows_d  | | Количество исходящих потоков, не получившие (исходящий трафик к сетевому интерфейсу, по которому был записан поток) |
| FlowCount_d | Не рекомендуется. Всего потоков, которые соответствуют же четырехэлементный кортеж. В случае типа потока ExternalPublic и AzurePublic: счетчик будет включать потоки из различных адресов общедоступный IP-адрес также.
| InboundPackets_d | Пакетов, полученных по мере отслеживания на уровне сетевого интерфейса, где правило NSG было применено | Это поле заполняется только для схемы журнала потока версии 2 группы безопасности сети |
| OutboundPackets_d  | Пакеты, отправляемые по мере отслеживания на уровне сетевого интерфейса, где правило NSG было применено | Это поле заполняется только для схемы журнала потока версии 2 группы безопасности сети |
| InboundBytes_d |  Байтов, полученных по мере отслеживания на уровне сетевого интерфейса, где правило NSG было применено | Это поле заполняется только для схемы журнала потока версии 2 группы безопасности сети |
| OutboundBytes_d | Байтов, отправленных по мере отслеживания на уровне сетевого интерфейса, где правило NSG было применено | Это поле заполняется только для схемы журнала потока версии 2 группы безопасности сети |
| CompletedFlows_d  |  | Это поле заполняется с помощью ненулевое значение только для схемы журнала потока версии 2 группы безопасности сети |
| PublicIPs_s | <PUBLIC_IP>\|\<FLOW_STARTED_COUNT>\|\<FLOW_ENDED_COUNT>\|\<OUTBOUND_PACKETS>\|\<INBOUND_PACKETS>\|\<OUTBOUND_BYTES>\|\<INBOUND_BYTES> | Записей, разделенных полосы |

### <a name="notes"></a>Примечания

1. В случае AzurePublic и ExternalPublic потоки принадлежащие клиенту IP-адрес виртуальной Машины Azure заполняется в поле VMIP_s, хотя общедоступные IP-адреса заполняются в поле PublicIPs_s. Для этих типов два потока мы должны использовать VMIP_s и PublicIPs_s вместо SrcIP_s и DestIP_s полей. Для адреса AzurePublic и ExternalPublicIP мы собираем, таким образом, минимальное количество записей, которые поступают на рабочую область log analytics клиента. (Это поле скоро будет прекращена, и мы должны использовать SrcIP_ и DestIP_s в зависимости от того, была ли виртуальная машина azure источником или назначением в потоке)
1. Подробные сведения о типах потоков: На основании IP-адреса, участвующие в потоке, мы классификации в потоках на следующие типы последовательности:
1. IntraVNet — IP-адреса в потоке, которые находятся в той же виртуальной сети Azure.
1. Между виртуальными сетями — IP-адресов в потоке, которые находятся в двух разных виртуальных сетях Azure.
1. S2S — (узлами) один из IP-адреса принадлежит виртуальной сети Azure во время другой IP-адрес относится к сети клиентов (сайт), подключенные к виртуальной сети Azure через VPN-шлюз или Express Route.
1. P2S - (точка — сеть) один из IP-адреса принадлежит виртуальной сети Azure, пока другой IP-адрес принадлежит сети клиента (сайт), подключенных к виртуальной сети Azure через VPN-шлюза.
1. AzurePublic - один из IP-адреса принадлежит к виртуальной сети Azure во время другой IP-адрес принадлежит внутренний общедоступный IP-адресов Azure принадлежит корпорации Майкрософт. Клиентов, которым владеет общедоступные IP-адреса не будет частью этого типа потока. Например любой клиент принадлежащие виртуальной Машины, отправлять трафик в службе Azure (конечной точки хранилища) будут разделены этого типа потока.
1. ExternalPublic - один из IP-адреса принадлежит к виртуальной сети Azure не сообщается как вредоносный в ASC веб-каналы, которые аналитики трафика использует для обработки интервала между несмотря на то другой IP-адрес, общедоступный IP-адрес, который не находится в Azure " FlowIntervalStartTime_t» и «FlowIntervalEndTime_t».
1. MaliciousFlow - одна из IP-адреса принадлежит виртуальной сети azure во время другой IP-адрес — это общедоступный IP-адрес, который не находится в Azure и сообщается как вредоносный в ASC веб-каналы, которые аналитики трафика использует для обработки интервала между» FlowIntervalStartTime_t» и «FlowIntervalEndTime_t».
1. UnknownPrivate - одна из IP-адреса принадлежит виртуальной сети Azure во время другой IP-адрес принадлежит диапазон частных IP-адрес, как определено в RFC 1918 и не могут быть сопоставлены с аналитикой трафика клиента сайта или виртуальной сети Azure.
1. Unknown — не удается отобразить либо IP-адреса в потоки в топологии клиента в Azure также локальный (сайт).
1. Некоторые имена полей дополняются _s или _d. Это означает источника и назначения.

### <a name="next-steps"></a>Следующие шаги
Чтобы получить ответы на часто задаваемые вопросы, см. в разделе [трафик аналитики часто задаваемые вопросы о](traffic-analytics-faq.md) сведения о функциональных возможностях см. в разделе [документация по аналитике трафика](traffic-analytics.md)
