---
title: 'Наблюдатель за сетями Azure: управление записью пакетов с помощью портала Azure | Документация Майкрософт'
description: Сведения о том, как управлять функцией записи пакетов Наблюдателя за сетями с помощью портала Azure.
services: network-watcher
documentationcenter: na
author: KumudD
manager: twooley
editor: ''
ms.assetid: 59edd945-34ad-4008-809e-ea904781d918
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/10/2018
ms.author: kumud
ms.openlocfilehash: 00349a7e681beab447e585139e481c04755b7879
ms.sourcegitcommit: 44e85b95baf7dfb9e92fb38f03c2a1bc31765415
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70102851"
---
# <a name="manage-packet-captures-with-azure-network-watcher-using-the-portal"></a>Управление записью пакетов с помощью Наблюдателя за сетями Azure на портале Azure

Возможность записи пакетов Наблюдателя за сетями позволяет создавать сеансы записи для отслеживания входящего и исходящего трафика виртуальной машины. Для сеанса записи предоставляются фильтры, которые позволяют убедиться, что записывается только требуемый трафик. Запись пакетов позволяет выявлять аномалии в работе сети в случае их возникновения или заранее. Также она помогают выполнять сбор сетевой статистики, получать сведения о сетевых вторжениях, выполнять отладку обмена данных между клиентом и сервером и многое другое. Так как запись пакетов активируется удаленно, ее не нужно запускать вручную на требуемой виртуальной машине, что также позволяет сэкономить ценное время.

В этой статье описано, как запустить, остановить, скачать и удалить запись пакетов. 

## <a name="before-you-begin"></a>Перед началом работы

Для записи пакетов требуются следующие подключения.
* исходящее подключение к учетной записи хранения через порт 443;
* входящее и исходящее подключение по адресу 169.254.169.254;
* входящее и исходящее подключение по адресу 168.63.129.16.

Если группа безопасности сети связана с сетевым интерфейсом или подсетью, в которой находится сетевой интерфейс, убедитесь, что существуют правила, разрешающие подключение через указанные порты. Аналогичным образом, Добавление определяемых пользователем маршрутов трафика в сеть может помешать подключению указанных выше IP-адресов и портов. Убедитесь, что они доступны. 

## <a name="start-a-packet-capture"></a>Запуск записи пакета

1. В браузере перейдите на [портал Azure](https://portal.azure.com) и выберите **Все службы**, затем выберите **Наблюдатель за сетями** в **разделе "Сети"** .
2. В разделе **Средства диагностики сети** выберите **Запись пакетов**. Отобразится список всех существующих записей пакетов независимо от их состояния.
3. Выберите **Добавить** для создания записи пакетов. Можно выбрать значения следующих свойств:
   - **Подписка**: Подписка, в которой виртуальная машина, для которой требуется создать запись пакетов, находится в.
   - **Группа ресурсов.** Группа ресурсов виртуальной машины.
   - **Целевая виртуальная машина**. Виртуальная машина, для которой необходимо создать запись пакетов.
   - **Имя записи пакетов**: Имя записи пакета.
   - **Учетная запись хранения или файл**: Выберите **учетную запись хранения**, **файл**или и то, и другое. Если выбрать **Файл**, собранные данные будут записываться в папку на виртуальной машине.
   - **Путь к локальному файлу**: Локальный путь на виртуальной машине, где сохраняется запись пакетов (действует только при выборе *файла* ). Необходимо указать допустимый путь. Для виртуальной машины Linux путь должен начинаться с */var/captures*.
   - **Учетные записи хранения**. Выберите существующую учетную запись хранения, если выбрана *учетная запись хранения*. Этот параметр доступен только при выборе параметра **Хранилище**.
   
     > [!NOTE]
     > Учетные записи хранения класса Premium сейчас не поддерживаются для сохранения записи пакетов.

   - **Максимальное число байтов на пакет**: Число байтов из каждого записанного пакета. Если оставить это поле пустым, записываются все байты.
   - **Максимальное число байтов на сеанс**: Общее число записанных байтов. После достижения этого значения запись пакетов останавливается.
   - **Ограничение времени (в секундах)** : Предельное время до остановки записи пакетов. Значение по умолчанию — 18 000 секунд.
   - Фильтрация (необязательно). Выберите **+ Добавить фильтр**
     - **Протокол**: Протокол фильтрации для записи пакетов. Возможны такие значения: "TCP", "UDP" и "Любой".
     - **Локальный IP-адрес**: Фильтрует запись пакетов для пакетов, в которых локальный IP-адрес соответствует этому значению.
     - **Локальный порт**: Фильтрует запись пакетов для пакетов, в которых локальный порт соответствует этому значению.
     - **Удаленный IP-адрес**: Фильтрует запись пакетов для пакетов, в которых удаленный IP-адрес совпадает с этим значением.
     - **Удаленный порт**: Фильтрует запись пакетов для пакетов, в которых удаленный порт соответствует этому значению.
    
     > [!NOTE]
     > Значения портов и IP-адресов могут представлять собой одиночное значение, ряд значений или диапазон, например 80–1024 (для порта). Можно определить любое число фильтров.

4. Нажмите кнопку **ОК**.

По достижении ограничения на время записи пакетов процесс будет остановлен и можно будет просмотреть результаты. Также сеанс записи пакетов можно остановить вручную.

> [!NOTE]
> Портал автоматически выполняет следующие действия:
>  * создает наблюдатель за сетями в том же регионе, где существует выбранная виртуальная машина, если в этом регионе еще нет наблюдателя за сетями;
>  * добавляет к виртуальной машине расширение *AzureNetworkWatcherExtension* для [Linux](../virtual-machines/linux/extensions-nwa.md) или [Windows](../virtual-machines/windows/extensions-nwa.md), если оно еще не установлено.

## <a name="delete-a-packet-capture"></a>Удаление записи пакета

1. В представлении записи пакетов выберите **…** с правой стороны записи пакетов или щелкните правой кнопкой мыши существующую запись пакетов и выберите **Удалить**.
2. Вам будет предложено подтвердить удаление записи пакетов. Выберите **Да**.

> [!NOTE]
> При удалении записи пакетов файл этой записи в учетной записи хранения или на виртуальной машине не удаляется.

## <a name="stop-a-packet-capture"></a>Прекращение записи пакета

В представлении записи пакетов выберите **…** с правой стороны записи пакетов или щелкните правой кнопкой мыши существующую запись пакетов и выберите **Остановить**.

## <a name="download-a-packet-capture"></a>Скачивание записи пакета

Когда сеанс записи пакетов завершается, файл записи передается в хранилище BLOB-объектов или сохраняется в локальный файл на виртуальной машине. Место хранения записи пакетов определяется при создании записи. Удобное средство для доступа к файлам записи пакетов, сохраненным в учетной записи хранения, — Обозреватель службы хранилища Microsoft Azure, который можно [скачать](https://storageexplorer.com/).

При указании учетной записи хранения файлы записи пакетов сохраняются в ней по следующему адресу:

```
https://{storageAccountName}.blob.core.windows.net/network-watcher-logs/subscriptions/{subscriptionId}/resourcegroups/{storageAccountResourceGroup}/providers/microsoft.compute/virtualmachines/{VMName}/{year}/{month}/{day}/packetCapture_{creationTime}.cap
```

Если при создании записи был выбран вариант **Файл**, можно просмотреть или скачать этот файл из папки, настроенной на виртуальной машине.

## <a name="next-steps"></a>Следующие шаги

- Дополнительные сведения об автоматизации записи пакетов с помощью оповещений на виртуальной машине см. в статье, посвященной [созданию записи пакетов, активируемой с использованием оповещений](network-watcher-alert-triggered-packet-capture.md).
- Чтобы определить, разрешен ли определенный входящий или исходящий трафик на виртуальной машине, см. статью о [диагностике проблем фильтрации трафика виртуальной машины](diagnose-vm-network-traffic-filtering-problem.md).
