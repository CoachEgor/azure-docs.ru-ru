---
title: Монитор подключения (Предварительная версия) | Документация Майкрософт
description: Узнайте, как использовать монитор подключений (Предварительная версия) для мониторинга сетевого взаимодействия в распределенной среде.
services: network-watcher
documentationcenter: na
author: vinynigam
manager: agummadi
editor: ''
tags: azure-resource-manager
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/27/2020
ms.author: vinigam
ms.custom: mvc
ms.openlocfilehash: 8f3a6f002fbebe215699c9b97a6dce63177c446f
ms.sourcegitcommit: 99ac4a0150898ce9d3c6905cbd8b3a5537dd097e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/25/2020
ms.locfileid: "77599331"
---
# <a name="network-connectivity-monitoring-with-connection-monitor-preview"></a>Мониторинг сетевых подключений с помощью монитора подключений (Предварительная версия)

Монитор подключения (Предварительная версия) обеспечивает единый мониторинг сквозного подключения в наблюдателе за сетями Azure. Функция монитора подключений (Предварительная версия) поддерживает Гибридные развертывания и облачное развертывание Azure. Наблюдатель за сетями предоставляет средства для мониторинга, диагностики и просмотра метрик, связанных с подключением, для развертываний Azure.

Ниже приведены некоторые варианты использования монитора подключения (Предварительная версия).

- Клиентская виртуальная машина веб-сервера взаимодействует с виртуальной машиной сервера базы данных в многоуровневом приложении. Необходимо проверить сетевое подключение между двумя виртуальными машинами.
- Вы хотите, чтобы виртуальные машины в регионе "Восточная часть США" могли проверить связь с виртуальными машинами в центральном регионе США и вы хотите сравнить задержки сети между регионами.
- У вас есть несколько локальных сайтов Office в Сиэтле, штат Вашингтон и Эшберн, Виргиния. Сайты Office подключаются к URL-адресам Office 365. Для пользователей URL-адресов Office 365 Сравните задержки между Сиэтлом и Эшберн.
- Гибридному приложению требуется подключение к конечной точке службы хранилища Azure. Локальный сайт и приложение Azure подключаются к одной конечной точке службы хранилища Azure. Необходимо сравнить задержки локального сайта с задержкой приложения Azure.
- Необходимо проверить подключение между локальными настройками и виртуальными машинами Azure, на которых размещается ваше облачное приложение.

На этапе предварительной версии монитор подключения объединяет лучшие из двух компонентов: функция [монитора подключения](https://docs.microsoft.com/azure/network-watcher/network-watcher-monitoring-overview#monitor-communication-between-a-virtual-machine-and-an-endpoint) наблюдателя за сетями и функция [монитора подключения службы](https://docs.microsoft.com/azure/azure-monitor/insights/network-performance-monitor-service-connectivity) монитор производительности сети (NPM).

Ниже приведены некоторые преимущества монитора подключений (Предварительная версия).

* Унифицированный, интуитивно понятный интерфейс для потребностей в Azure и гибридного мониторинга
* Мониторинг подключения между регионами и между рабочими областями
* Более высокие частоты проверки и более наглядное представление о производительности сети
* Более быстрое оповещение для гибридных развертываний
* Поддержка проверок подключения, основанных на HTTP, TCP и ICMP 
* Метрики и поддержка Log Analytics для настройки тестирования Azure и не в Azure

![Диаграмма, показывающая, как монитор подключения взаимодействует с виртуальными машинами Azure, узлами, конечными точками и местами хранения данных, отличными от Azure.](./media/connection-monitor-2-preview/hero-graphic.png)

Чтобы начать работу с монитором подключений (Предварительная версия) для мониторинга, выполните следующие действия. 

1. Установите агенты наблюдения.
1. Включите наблюдатель за сетями в подписке.
1. Создайте монитор подключения.
1. Настройка анализа данных и оповещений.
1. Диагностика проблем в сети.

В следующих разделах приводятся подробные сведения по этим действиям.

## <a name="install-monitoring-agents"></a>Установка агентов наблюдения

Монитор подключения использует упрощенные исполняемые файлы для выполнения проверок подключения.  Она поддерживает проверки подключения как из среды Azure, так и из локальных сред. Используемый исполняемый файл зависит от того, размещена ли виртуальная машина в Azure или в локальной среде.

### <a name="agents-for-azure-virtual-machines"></a>Агенты для виртуальных машин Azure

Чтобы монитор подключения распознал виртуальные машины Azure в качестве источников мониторинга, установите на них расширение виртуальной машины агента наблюдателя за сетями. Это расширение также называется *расширением наблюдателя за сетями*. Для виртуальных машин Azure требуется расширение, чтобы активировать сквозное наблюдение и другие расширенные функции. 

Расширение наблюдателя за сетями можно установить при [создании виртуальной машины](https://docs.microsoft.com/azure/network-watcher/connection-monitor#create-the-first-vm). Вы также можете отдельно установить, настроить и устранить неполадки расширения наблюдателя за сетями для [Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/network-watcher-linux) и [Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/network-watcher-windows).

Правила для группы безопасности сети (NSG) или брандмауэра могут блокировать обмен данными между источником и назначением. Монитор подключения обнаруживает эту ошибку и показывает ее как диагностическое сообщение в топологии. Чтобы включить мониторинг подключения, убедитесь, что правила NSG и брандмауэра разрешают пакеты по протоколу TCP или ICMP между источником и назначением.

### <a name="agents-for-on-premises-machines"></a>Агенты для локальных компьютеров

Чтобы монитор подключения распознал локальные компьютеры как источники для мониторинга, установите агент Log Analytics на компьютерах. Затем включите решение Монитор производительности сети. Эти агенты связаны с рабочими областями Log Analytics, поэтому необходимо настроить идентификатор и первичный ключ рабочей области, прежде чем агенты смогут начать мониторинг.

Сведения об установке агента Log Analytics для компьютеров Windows см. в разделе [Azure Monitor расширение виртуальной машины для Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/oms-windows).

Если путь включает брандмауэры или сетевые виртуальные устройства (NVA), убедитесь, что назначение доступно.

## <a name="enable-network-watcher-on-your-subscription"></a>Включение наблюдателя за сетями в подписке

Для всех подписок с виртуальной сетью используется наблюдатель за сетями. При создании виртуальной сети в подписке наблюдатель за сетями автоматически включается в регионе и подписке виртуальной сети. Это автоматическое включение не влияет на ресурсы или стоимость. Убедитесь, что наблюдатель за сетями не отключен явным образом в вашей подписке. 

Дополнительные сведения см. в разделе [Включение наблюдателя за сетями](https://docs.microsoft.com/azure/network-watcher/network-watcher-create).

## <a name="create-a-connection-monitor"></a>Создание монитора подключения 

Монитор подключений отслеживает связь через регулярные интервалы. Он информирует вас об изменениях в достижимости и задержке. Вы также можете проверить текущую и прошлую топологию сети между исходными агентами и конечными точками назначения.

Источники могут быть виртуальными машинами Azure или локальными компьютерами, на которых установлен агент мониторинга. Конечными точками назначения могут быть URL-адреса Office 365, URL-адреса Dynamics 365, настраиваемые URL-адреса, идентификаторы ресурсов виртуальной машины Azure, IPv4, IPv6, FQDN или любое доменное имя.

### <a name="access-connection-monitor-preview"></a>Доступ к монитору подключений (Предварительная версия)

1. На домашней странице портал Azure перейдите к **наблюдателю за сетями**.
1. Слева в разделе **мониторинг** выберите **монитор подключения (Предварительная версия)** .
1. Вы увидите все мониторы подключений, созданные в мониторе подключений (Предварительная версия). Чтобы просмотреть мониторы подключения, созданные в классическом интерфейсе монитора подключения, перейдите на вкладку **монитор подключения** .

    ![Снимок экрана, показывающий мониторы подключений, созданные в мониторе подключений (Предварительная версия)](./media/connection-monitor-2-preview/cm-resource-view.png)


### <a name="create-a-connection-monitor"></a>Создание монитора подключения

В мониторах подключений, создаваемых в мониторе подключений (Предварительная версия), можно добавить локальные компьютеры и виртуальные машины Azure в качестве источников. Эти мониторы соединений также могут отслеживать подключение к конечным точкам. Конечные точки могут находиться в Azure или на любом другом URL-адресе или IP.

Монитор подключения (Предварительная версия) включает следующие сущности:

* **Ресурс монитора подключения** — ресурс Azure определенного региона. Все следующие сущности являются свойствами ресурса монитора подключения.
* **Конечная точка** — источник или назначение, участвующие в проверках подключения. Примеры конечных точек: виртуальные машины Azure, локальные агенты, URL-адреса и IP-адрес.
* **Конфигурация теста** — конфигурация, зависящая от протокола, для теста. В зависимости от выбранного протокола можно определить порт, пороговые значения, частоту проверки и другие параметры.
* **Тестовая группа** — группа, содержащая конечные точки источника, конечные точки назначения и конфигурации тестов. Монитор подключения может содержать более одной тестовой группы.
* **Тест** — сочетание исходной конечной точки, конечной точки назначения и конфигурации теста. Тест — это наиболее детализированный уровень доступности данных мониторинга. Данные мониторинга включают в себя процент проверок, завершившихся сбоем, и время приема-передачи (RTT).

 ![Схема, показывающая монитор подключения, определение связи между группами тестов и тестами](./media/connection-monitor-2-preview/cm-tg-2.png)

#### <a name="create-a-connection-monitor-from-the-azure-portal"></a>Создание монитора подключения из портал Azure

Чтобы создать монитор подключения из портал Azure, выполните следующие действия.

1. На панели мониторинга **монитора подключения (Предварительная версия)** в левом верхнем углу выберите **создать**.
1. На вкладке **основные** сведения введите данные для монитора подключения:
   * **Имя монитора подключения** — добавьте имя монитора подключения. Используйте стандартные правила именования для ресурсов Azure.
   * **Подписка** — выберите подписку для монитора подключения.
   * **Регион** — выберите регион для монитора подключения. Вы можете выбрать только исходные виртуальные машины, созданные в этом регионе.
   * **Конфигурация рабочей области** . в рабочей области хранятся данные мониторинга. Можно использовать пользовательскую рабочую область или рабочую область по умолчанию. 
       * Чтобы использовать рабочую область по умолчанию, установите флажок. 
       * Чтобы выбрать настраиваемую рабочую область, снимите флажок. Затем выберите подписку и регион для пользовательской рабочей области. 
1. В нижней части вкладки выберите пункт **Далее: тестовые группы**.

   ![Снимок экрана, показывающий вкладку "основные" в мониторе подключения](./media/connection-monitor-2-preview/create-cm-basics.png)

1. На вкладке **группы тестов** выберите **+ Тестовая группа**. Сведения о настройке тестовых групп см. [в разделе Создание тестовых групп в мониторе подключения](#create-test-groups-in-a-connection-monitor). 
1. В нижней части вкладки щелкните **Далее: Проверка и создать** , чтобы проверить монитор подключения.

   ![Снимок экрана с вкладкой "группы тестов" и областью добавления сведений о группе тестов](./media/connection-monitor-2-preview/create-tg.png)

1. На вкладке **Просмотр и создание** перед созданием монитора подключения ознакомьтесь с основными сведениями и группами тестирования. Если необходимо изменить монитор подключения:
   * Чтобы изменить основные сведения, щелкните значок карандаша.
   * Чтобы изменить тестовую группу, выберите ее.

   > [!NOTE] 
   > На вкладке **Проверка и создание** отображаются затраты за месяц на этапе просмотра монитора подключения. В настоящее время в столбце **текущие затраты** не взимается плата. Когда монитор подключения становится общедоступным, в этом столбце будет показана ежемесячная плата. 
   > 
   > Даже на этапе предварительного просмотра монитора подключения применяются оплаты за Log Analytics приема.

1. Когда вы будете готовы создать монитор подключения, в нижней части вкладки **Просмотр и создание** выберите **создать**.

   ![Снимок экрана: монитор подключения, отображающий вкладку "Проверка и создание"](./media/connection-monitor-2-preview/review-create-cm.png)

Монитор подключения (Предварительная версия) создает ресурс монитора подключения в фоновом режиме.

#### <a name="create-a-connection-monitor-by-using-armclient"></a>Создание монитора подключения с помощью ARMClient

Используйте следующий код, чтобы создать монитор подключения с помощью ARMClient.

```armclient
$connectionMonitorName = "sampleConnectionMonitor"

$ARM = "[https://](https://apac01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fbrazilus.management.azure.com&amp;data=02%7C01%7CManasi.Sant%40microsoft.com%7Cd900da4ed7f24366842108d68022159b%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636837281231186904&amp;sdata=qHL8zWjkobY9MatRpAVbODwboKSQAqqEFOMnjmfyOnU%3D&amp;reserved=0)management.azure.com"

$SUB = "subscriptions/\&lt;subscription id 1\&gt;"

$NW = "resourceGroups/NetworkWatcherRG/providers/Microsoft.Network/networkWatchers/NetworkWatcher\_centraluseuap"

$body =

"{

location: 'eastus',

properties: {

endpoints: [{

name: 'workspace',

resourceId: '/subscriptions/\&lt;subscription id\&gt;/resourcegroups/\&lt;resource group\&gt;/providers/Microsoft.OperationalInsights/workspaces/sampleWorkspace',

filter: {

 items: [{

type: 'AgentAddress',

address: '\&lt;FQDN of your on-premises agent'

}]

}

          },

 {

name: 'vm1',

resourceId: '/subscriptions/\&lt;subscription id\&gt;/resourceGroups/\&lt;resource group\&gt;/providers/Microsoft.Compute/virtualMachines/\&lt;vm-name\&gt;'

},

 {

name: 'vm2',

resourceId: '/subscriptions/\&lt;subscription id\&gt;/resourceGroups/\&lt;resource group\&gt;/providers/Microsoft.Compute/virtualMachines/\&lt;vm-name\&gt;'

   },

{

name: 'azure portal'

address: '\&lt;URL\&gt;'

   },

 {

    name: 'ip',

     address: '\&lt;IP\&gt;'

 }

  ],

  testGroups: [{

    name: 'Connectivity to Azure Portal and Public IP',

    testConfigurations: ['http', 'https', 'tcpEnabled', 'icmpEnabled'],

    sources: ['vm1', 'workspace'],

    destinations: ['azure portal', 'ip']

   },

{

    name: 'Connectivty from Azure VM 1 to Azure VM 2',

    testConfigurations: ['http', 'https', 'tcpDisabled', 'icmpDisabled'],

    sources: ['vm1'],

    destinations: ['vm2'],

    disable: true

   }

  ],

  testConfigurations: [{

    name: 'http',

    testFrequencySec: 60,

    protocol: 'HTTP',

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'https',

    testFrequencySec: 60,

    protocol: 'HTTP',

    httpConfiguration: {

     preferHTTPS: true

    },

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'tcpEnabled',

    testFrequencySec: 30,

    protocol: 'TCP',

    tcpConfiguration: {

     port: 80

    },

    successThreshold: {

     checksFailedPercent: 30,

     roundTripTimeMs: 5.2

    }

   }, {

    name: 'icmpEnabled',

    testFrequencySec: 90,

    protocol: 'ICMP',

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'icmpDisabled',

    testFrequencySec: 120,

    protocol: 'ICMP',

    icmpConfiguration: {

     disableTraceRoute: true

    },

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'tcpDisabled',

    testFrequencySec: 45,

    protocol: 'TCP',

    tcpConfiguration: {

     port: 80,

     disableTraceRoute: true

    },

    successThreshold: {

     checksFailedPercent: 30,

     roundTripTimeMs: 5.2

    }

   }

  ]

 }

} "
```

Ниже приведена команда развертывания.
```
armclient PUT $ARM/$SUB/$NW/connectionMonitors/$connectionMonitorName/?api-version=2019-07-01 $body -verbose
```

### <a name="create-test-groups-in-a-connection-monitor"></a>Создание тестовых групп в мониторе соединений

Каждая группа тестов в мониторе соединений включает источники и назначения, которые проверяются по сетевым параметрам. Они проверяются на процент проверок, которые завершаются сбоем, и о конфигурациях тестирования на время приема-передачи.

В портал Azure для создания тестовой группы в мониторе соединений необходимо указать значения для следующих полей:

* **Отключить тестовую группу** — можно выбрать это поле, чтобы отключить наблюдение для всех источников и назначений, которые указывает группа тестирования. По умолчанию этот вариант сброшен.
* **Имя** — имя группы тестов.
* **Источники** . при установке агентов на них можно указать как виртуальные машины Azure, так и локальные компьютеры в качестве источников. Сведения об установке агента для источника см. в разделе [Install Monitoring](#install-monitoring-agents)Agents.
   * Чтобы выбрать агенты Azure, перейдите на вкладку **агенты Azure** . Здесь отображаются только виртуальные машины, привязанные к региону, указанному при создании монитора подключения. По умолчанию виртуальные машины группируются в подписку, к которой они принадлежат. Эти группы свернуты. 
   
       Вы можете перейти от уровня подписки к другим уровням в иерархии:

      **Подписки** > **группы ресурсов** > **виртуальных сетей** > **подсети** > **виртуальных машин с агентами**

      Можно также изменить значение поля **Группировать по,** чтобы начать дерево с любого другого уровня. Например, если вы выполнили группировку по виртуальной сети, вы увидите виртуальные машины с агентами в иерархии **виртуальных сетей** > **подсети** > **виртуальные машины с агентами**.

      ![Снимок экрана: монитор подключения, отображающий панель "Добавление источников" и вкладку "агенты Azure"](./media/connection-monitor-2-preview/add-azure-sources.png)

   * Чтобы выбрать локальные агенты, перейдите на вкладку **не — агенты Azure** . По умолчанию агенты группируются в рабочие области по регионам. Для всех этих рабочих областей настроено Монитор производительности сети решение. 
   
       Если вам нужно добавить Монитор производительности сети в рабочую область, скачайте ее из [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/Microsoft.NetworkMonitoringOMS?tab=Overview). Дополнительные сведения о добавлении Монитор производительности сети см. в разделе [мониторинг решений в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/insights/solutions). 
   
       В представлении " **Создание монитора подключения** " на вкладке " **основные** " выбрана область по умолчанию. При изменении региона можно выбрать агенты из рабочих областей в новом регионе. Можно также изменить значение поля **Группировать по** подсетями.

      ![Снимок экрана: монитор подключения, отображающий панель "Добавление источников" и вкладку "агенты, не относящиеся к Azure"](./media/connection-monitor-2-preview/add-non-azure-sources.png)


   * Чтобы ознакомиться с выбранными агентами Azure и не в Azure, перейдите на вкладку " **Проверка** ".

      ![Снимок экрана: монитор подключения, отображающий панель "Добавление источников" и вкладку "Проверка"](./media/connection-monitor-2-preview/review-sources.png)

   * После завершения настройки источников в нижней части панели **Добавление источников** выберите **Готово**.

* **Назначения** — вы можете отслеживать подключение к виртуальным машинам Azure или любой конечной точке (общедоступный IP-адрес, URL-адреса или FQDN), указав их в качестве назначений. В одной тестовой группе можно добавить виртуальные машины Azure, URL-адреса Office 365, URL-адреса Dynamics 365 и пользовательские конечные точки.

    * Чтобы выбрать виртуальные машины Azure в качестве мест назначения, перейдите на вкладку **виртуальные машины Azure** . По умолчанию виртуальные машины Azure группируются в иерархию подписки, которая находится в том же регионе, что и выбранный в представлении " **Создание монитора подключения** " на вкладке " **основы** ". Вы можете изменить регион и выбрать виртуальные машины Azure из вновь выбранного региона. Затем можно перейти от уровня подписки к другим уровням в иерархии, например к уровню агентов Azure.

       ![Снимок экрана: область "Добавление назначений" с вкладкой "виртуальные машины Azure"](./media/connection-monitor-2-preview/add-azure-dests1.png)

       ![Снимок экрана: область "Добавление назначений" с уровнем подписки](./media/connection-monitor-2-preview/add-azure-dests2.png)

    * Чтобы выбрать конечные точки в качестве мест назначения, перейдите на вкладку **конечные точки** . Список конечных точек включает тестовые URL-адреса Office 365 и URL-адреса тестов Dynamics 365, сгруппированные по имени. Помимо этих конечных точек можно выбрать конечную точку, созданную в других тестовых группах в том же мониторе подключения. 
    
        Чтобы добавить новую конечную точку, в правом верхнем углу выберите **+ конечные точки**. Затем укажите имя и URL-адрес конечной точки, IP-адреса или FQDN.

       ![Снимок экрана: Добавление конечных точек в качестве назначений в мониторе подключения](./media/connection-monitor-2-preview/add-endpoints.png)

    * Чтобы ознакомиться с выбранными виртуальными машинами и конечными точками Azure, перейдите на вкладку " **Проверка** ".
    * Завершив выбор пунктов назначения, выберите **Готово**.

* **Конфигурации тестов** — можно связать конфигурации тестов в тестовой группе. Портал Azure допускает только одну конфигурацию теста для каждой группы тестирования, но можно использовать ARMClient для добавления дополнительных.

    * **Имя** — имя конфигурации теста.
    * **Протокол** — выберите TCP, ICMP или HTTP. Чтобы изменить HTTP на HTTPS, выберите **http** в качестве протокола и в качестве порта выберите **443** .
        * **Создать конфигурацию тестирования сети** — этот флажок отображается, только если в поле **протокол** выбрано значение **http** . Установите этот флажок, чтобы создать еще одну конфигурацию теста, использующую те же источники и назначения, которые вы указали в любом другом расположении в конфигурации. Вновь созданная конфигурация теста называется `<the name of your test configuration>_networkTestConfig`.
        * **Disable traceroute (отключить** ) — это поле применяется к тестовым группам с протоколом TCP или ICMP. Установите этот флажок, чтобы предотвратить обнаружение источников для обнаружения топологии и приема-передачи по прыжкам.
    * **Порт назначения** — вы можете настроить в этом поле выбранный порт назначения.
    * **Периодичность проверки** — используйте это поле, чтобы выбрать, как часто источники будут проверять связь с назначениями указанного протокола и порта. Можно выбрать 30 секунд, 1 минуту, 5 минут, 15 минут или 30 минут. Источники проверяют возможность подключения к местам назначения на основе выбранного значения.  Например, если выбрать 30 секунд, источники будут проверять подключение к назначению по крайней мере один раз в течение 30 секунд.
    * **Порог успеха** — вы можете задать пороговые значения для следующих сетевых параметров:
       * **Проверки с ошибками** — укажите процент проверок, которые могут завершаться ошибкой, когда источники проверяют подключение к местам назначения, используя указанные критерии. Для протокола TCP или ICMP процент неудачных проверок может равняться проценту потери пакетов. Для протокола HTTP это поле представляет процент HTTP-запросов, которые не получили ответа.
       * **Время кругового** пути — задайте значение RTT в миллисекундах, определяющее время, в течение которого источники могут подключаться к назначению в конфигурации теста.
    
       ![Снимок экрана, на котором показано, где настроить конфигурацию теста в мониторе подключения](./media/connection-monitor-2-preview/add-test-config.png)

Все источники, назначения и конфигурации тестов, добавленные в тестовую группу, будут разбиты на отдельные тесты. Ниже приведен пример разрыва работы источников и назначений.

* Тестовая группа: TG1
* Источники: 3 (A, B, C)
* Назначения: 2 (D, E)
* Конфигурации тестов: 2 (конфигурация 1, конфигурация 2)
* Всего тестов создано: 12

| Номер теста | Источник | Назначение | Конфигурация теста |
| --- | --- | --- | --- |
| 1 | А | Г | Конфигурация 1 |
| 2 | А | Г | Конфигурация 2 |
| 3 | А | Д | Конфигурация 1 |
| 4 | А | Д | Конфигурация 2 |
| 5 | B | Г | Конфигурация 1 |
| 6 | B | Г | Конфигурация 2 |
| 7 | B | Д | Конфигурация 1 |
| 8 | B | Д | Конфигурация 2 |
| 9 | C | Г | Конфигурация 1 |
| 10 | C | Г | Конфигурация 2 |
| 11 | C | Д | Конфигурация 1 |
| 12 | C | Д | Конфигурация 2 |

### <a name="scale-limits"></a>Ограничения масштабирования

Мониторы подключений имеют следующие ограничения масштабирования:

* Максимальное число мониторов подключения на подписку в одном регионе: 100
* Максимальное число групп тестов на монитор каждого подключения: 20
* Максимальное число источников и назначений на монитор подключения: 100
* Максимальное число конфигураций тестов на монитор каждого подключения: 
    * 20 через ARMClient
    * 2 через портал Azure

## <a name="analyze-monitoring-data-and-set-alerts"></a>Анализ данных мониторинга и Настройка оповещений

После создания монитора подключения источники проверяют подключение к местам назначения на основе конфигурации теста.

### <a name="checks-in-a-test"></a>Проверки в тесте

В зависимости от протокола, выбранного в конфигурации теста, монитор подключения (Предварительная версия) выполняет ряд проверок для пары "источник-назначение". Проверки выполняются в соответствии с выбранной частотой тестирования.

При использовании протокола HTTP служба вычисляет количество HTTP-ответов, которые возвращали код ответа. Результат определяет процент неудачных проверок. Для вычисления RTT служба измеряет время между вызовом HTTP и ответом.

При использовании протокола TCP или ICMP служба вычисляет процент потерь пакетов, чтобы определить процент неудачных проверок. Для вычисления RTT служба измеряет время, затраченное на получение подтверждения (ACK) отправленных пакетов. Если вы включили данные traceroute для проверки сети, вы можете увидеть потери прыжков и задержки для локальной сети.

### <a name="states-of-a-test"></a>Состояния теста

На основе данных, возвращаемых проверками, тесты могут иметь следующие состояния.

* **Pass** — фактические значения для процента неудачных проверок и RTT находятся в пределах указанных пороговых значений.
* **Fail** — фактические значения для процента неудачных проверок или RTT превысили указанные пороговые значения. Если пороговое значение не указано, тест достигает состояния сбоя, если процент неудачных проверок равен 100.
* **Предупреждение** — для процента неудачных проверок не было указано ни одного критерия. При отсутствии указанных критериев монитор подключения (Предварительная версия) автоматически назначает пороговое значение. При превышении этого порога состояние теста изменится на Warning (предупреждение).

### <a name="data-collection-analysis-and-alerts"></a>Сбор, анализ и оповещения данных

Данные, собираемые монитором подключения (Предварительная версия), хранятся в Log Analytics рабочей области. Эта Рабочая область настраивается при создании монитора подключения. 

Данные мониторинга также доступны в метриках Azure Monitor. Вы можете использовать Log Analytics для хранения данных мониторинга до тех пор, пока хотите. По умолчанию Azure Monitor хранит метрики за 30 дней. 

[Для данных можно задать оповещения на основе метрик](https://azure.microsoft.com/blog/monitor-at-scale-in-azure-monitor-with-multi-resource-metric-alerts/).

#### <a name="monitoring-dashboards"></a>Мониторинг панелей мониторинга

На панелях мониторинга отображаются список мониторов подключений, к которым можно получить доступ для подписок, регионов, меток времени, источников и типов назначения.

Когда вы переходите к монитору подключений (Предварительная версия) из наблюдателя за сетями, вы можете просматривать данные следующим образом.

* **Монитор подключения** — список всех мониторов подключения, созданных для подписок, регионов, меток времени, источников и типов назначения. Это представление используется по умолчанию.
* **Группы тестов** — список всех групп тестов, созданных для подписок, регионов, меток времени, источников и типов назначения. Эти группы тестов не фильтруются мониторами подключения.
* **Тест** — список всех тестов, выполняемых для подписок, регионов, меток времени, источников и типов назначения. Эти тесты не фильтруются с помощью мониторов подключения или тестовых групп.

На следующем рисунке три представления данных обозначаются стрелкой 1.

На панели мониторинга можно развернуть каждый монитор подключения, чтобы просмотреть его тестовые группы. Затем можно развернуть каждую тестовую группу, чтобы увидеть тесты, которые выполняются в ней. 

Вы можете отфильтровать список на основе:

* **Фильтры верхнего уровня** — выберите подписки, регионы, источники меток времени и типы назначения. См. Box 2 на следующем рисунке.
* **Фильтры на основе состояния** — фильтрация по состоянию монитора подключения, тестовой группы или теста. См. стрелку 3 на следующем рисунке.
* **Настраиваемые фильтры** — выберите **выбрать все** , чтобы выполнить общий поиск. Чтобы выполнить поиск по определенной сущности, выберите в раскрывающемся списке. См. стрелку 4 на следующем рисунке.

![Снимок экрана, показывающий, как фильтровать представления мониторов подключений, тестовых групп и тестов в мониторе подключений (Предварительная версия)](./media/connection-monitor-2-preview/cm-view.png)

Например, чтобы просмотреть все тесты в мониторе подключения (Предварительная версия), где исходный IP-адрес — 10.192.64.56:
1. Измените представление для **проверки**.
1. В поле поиска введите *10.192.64.56* .
1. В раскрывающемся списке выберите **Sources (источники**).

Для отображения только неудачных тестов в мониторе подключения (Предварительная версия) с исходным IP-адресом 10.192.64.56:
1. Измените представление для **проверки**.
1. Для фильтра, основанного на состоянии, выберите **сбой**.
1. В поле поиска введите *10.192.64.56* .
1. В раскрывающемся списке выберите **Sources (источники**).

Для отображения только неудачных тестов в мониторе подключения (Предварительная версия), где назначением является outlook.office365.com:
1. Измените представление на " **тестирование**".
1. Для фильтра, основанного на состоянии, выберите **сбой**.
1. В поле поиска введите *Outlook.Office365.com* .
1. В раскрывающемся списке выберите пункт **назначения**.

   ![Снимок экрана, показывающий представление, которое отфильтровано для отображения только неудачных тестов для назначения Outlook.Office365.com](./media/connection-monitor-2-preview/tests-view.png)

Для просмотра тенденций в режиме приема-передачи и процента неудачных проверок для монитора подключения:
1. Выберите монитор подключения, который необходимо исследовать. По умолчанию данные мониторинга упорядочиваются по группам тестов.

   ![Снимок экрана, показывающий метрики для монитора подключения, отображаемый тестовой группой](./media/connection-monitor-2-preview/cm-drill-landing.png)

1. Выберите тестовую группу, которую необходимо исследовать.

   ![Снимок экрана, на котором показано, где выбрать тестовую группу](./media/connection-monitor-2-preview/cm-drill-select-tg.png)

    Вы увидите пять основных неудачных тестов группы тестов на основе RTT или процента неудачных проверок. Для каждого теста отображаются линии RTT и тренда для процента неудачных проверок.
1. Выберите тест из списка или выберите другой тест для изучения. Для интервала времени и процента неудачных проверок отображается порог и фактические значения. Для RTT отображаются значения порога, среднего, минимума и максимума.

   ![Снимок экрана, показывающий результаты проверки приема-передачи и процента неудачных проверок](./media/connection-monitor-2-preview/cm-drill-charts.png)

1. Измените интервал времени, чтобы просмотреть дополнительные данные.
1. Измените представление для просмотра источников, назначений или конфигураций тестов. 
1. Выберите источник на основе неудачных тестов и изучите пять основных неудачных тестов. Например, выберите **Просмотр по** > **источники** и **Просмотр по** > назначениям для изучения соответствующих тестов в мониторе подключения.

   ![Снимок экрана, показывающий метрики производительности для пяти ведущих неудачных тестов](./media/connection-monitor-2-preview/cm-drill-select-source.png)

Для просмотра тенденций в режиме приема-передачи и процента неудачных проверок для тестовой группы:

1. Выберите тестовую группу, которую необходимо исследовать. 

    По умолчанию данные мониторинга упорядочиваются по источникам, назначениям и конфигурациям тестов (тестам). Позже можно будет изменить представление тестовых групп на источники, назначения или конфигурации тестов. Затем выберите сущность, чтобы исследовать пять первых неудачных тестов. Например, измените представление на источники и назначения, чтобы исследовать соответствующие тесты в выбранном мониторе подключения.
1. Выберите тест, который необходимо исследовать.

   ![Снимок экрана, на котором показано, где выбрать тест](./media/connection-monitor-2-preview/tg-drill.png)

    В течение интервала времени и в процентах от неудачных проверок отображаются пороговые значения и фактические значения. Для RTT отображаются значения порога, среднего, минимума и максимума. Вы также видите оповещения для выбранного теста.
1. Измените интервал времени, чтобы просмотреть дополнительные данные.

Чтобы просмотреть тренды в RTT и процент неудачных проверок для теста, выполните следующие действия.
1. Выберите источник, назначение и конфигурацию тестирования, которые необходимо исследовать.

    В течение интервала времени и в процентах неудачных проверок отображаются пороговые значения и фактические значения. Для RTT отображаются значения порога, среднего, минимума и максимума. Вы также видите оповещения для выбранного теста.

   ![Снимок экрана, показывающий метрики для теста](./media/connection-monitor-2-preview/test-drill.png)

1. Чтобы просмотреть топологию сети, выберите **топология**.

   ![Снимок экрана, показывающий вкладку "топология сети"](./media/connection-monitor-2-preview/test-topo.png)

1. Чтобы просмотреть выявленные проблемы, в топологии выберите любой прыжок в пути. (Эти прыжки являются ресурсами Azure.) В настоящее время эта функция недоступна для локальных сетей.

   ![Снимок экрана со ссылкой на выбранный прыжок на вкладке "топология"](./media/connection-monitor-2-preview/test-topo-hop.png)

#### <a name="log-queries-in-log-analytics"></a>Запросы к журналу в Log Analytics

Используйте Log Analytics для создания пользовательских представлений данных мониторинга. Все данные, отображаемые в пользовательском интерфейсе, — из Log Analytics. Данные в репозитории можно анализировать в интерактивном режиме. Сопоставьте данные из Работоспособность агентов или других решений, основанных на Log Analytics. Экспортируйте данные в Excel или Power BI или создайте ссылку с общим доступом.

#### <a name="metrics-in-azure-monitor"></a>Метрики в Azure Monitor

В мониторах соединений, созданных до работы монитора подключений (Предварительная версия), доступны все четыре метрики:% Зонды Failed, Аверажераундтрипмс, Чекксфаиледперцент (Предварительная версия) и Раундтриптимемс (Предварительная версия). В мониторах соединений, созданных в интерфейсе монитора подключений (Предварительная версия), данные доступны только для тех метрик, которые помечены *(Предварительная версия)* .

![Снимок экрана, показывающий метрики в мониторе подключения (Предварительная версия)](./media/connection-monitor-2-preview/monitor-metrics.png)

При использовании метрик задайте тип ресурса Microsoft. Network/Нетворкватчерс/Коннектионмониторс.

| Метрика | Отображаемое имя | Единицы | Тип агрегирования | Описание | Измерения |
| --- | --- | --- | --- | --- | --- |
| ProbesFailedPercent | Доля проб с ошибками, в процентах | Процентный | Среднее | Сбой пробы мониторинга подключения. | Нет измерений |
| AverageRoundtripMs | Среднее время приема-передачи (МС) | Миллисекунд | Среднее | Среднее время приема сетевого соединения для проверок мониторинга подключения, отправляемых между источником и назначением. |             Нет измерений |
| Чекксфаиледперцент (Предварительная версия) | % Проверок с ошибками (Предварительная версия) | Процентный | Среднее | Процент неудачных проверок для теста. | коннектионмониторресаурцеид <br>саурцеаддресс <br>SourceName <br>Значение sourceresourceid <br>SourceType <br>Протокол <br>DestinationAddress <br>DestinationName <br>дестинатионресаурцеид <br>DestinationType <br>DestinationPort <br>тестграупнаме <br>тестконфигуратионнаме <br>Регион |
| Раундтриптимемс (Предварительная версия) | Время приема-передачи (МС) (Предварительная версия) | Миллисекунд | Среднее | RTT для проверок, отправленных между источником и назначением. Это значение не является средним. | коннектионмониторресаурцеид <br>саурцеаддресс <br>SourceName <br>Значение sourceresourceid <br>SourceType <br>Протокол <br>DestinationAddress <br>DestinationName <br>дестинатионресаурцеид <br>DestinationType <br>DestinationPort <br>тестграупнаме <br>тестконфигуратионнаме <br>Регион |

#### <a name="metric-alerts-in-azure-monitor"></a>Оповещения метрик в Azure Monitor

Чтобы создать оповещение в Azure Monitor, выполните следующие действия.

1. Выберите ресурс монитора подключения, созданный в мониторе подключения (Предварительная версия).
1. Убедитесь, что **Метрика** отображается как тип сигнала для монитора подключения.
1. В поле **Добавить условие**для **имени сигнала**выберите **чекксфаиледперцент (Предварительная версия)** или **раундтриптимемс (Предварительная версия)** .
1. В качестве **типа сигнала**выберите **метрики**. Например, выберите **чекксфаиледперцент (Предварительная версия)** .
1. Перечислены все измерения для метрики. Выберите имя измерения и значение измерения. Например, выберите **адрес источника** , а затем введите IP-адрес любого источника в мониторе подключения.
1. В окне **логика оповещения**введите следующие сведения:
   * **Тип условия**: **статический**.
   * **Условие** и **пороговое значение**.
   * **Детализация статистической обработки и частота оценки**: монитор подключения (Предварительная версия) обновляет данные каждую минуту.
1. В списке **действия**выберите группу действий.
1. Укажите сведения о предупреждении.
1. Создайте правило генерации оповещений.

   ![Снимок экрана, показывающий область создания правила в Azure Monitor; "Исходный адрес" и "имя конечной точки источника" выделены](./media/connection-monitor-2-preview/mdm-alerts.jpg)

## <a name="diagnose-issues-in-your-network"></a>Диагностика проблем в сети

Монитор подключения (Предварительная версия) помогает диагностировать проблемы в мониторе подключения и в сети. Проблемы в гибридной сети обнаруживаются установленными ранее агентами Log Analytics. Проблемы в Azure обнаруживаются расширением наблюдателя за сетями. 

Вы можете просматривать проблемы в сети Azure в топологии сети.

Для сетей, источники которых являются локальными виртуальными машинами, можно обнаружить следующие проблемы.

* Истекло время ожидания для запроса.
* Конечная точка не разрешается DNS-временными или постоянными. Недопустимый URL-адрес.
* Узлы не найдены.
* Источнику не удалось подключиться к назначению. Целевой объект недоступен по протоколу ICMP.
* Проблемы, связанные с сертификатом: 
    * Для проверки подлинности агента требуется сертификат клиента. 
    * Список перерасположения сертификатов недоступен. 
    * Имя узла конечной точки не соответствует субъекту или альтернативному имени субъекта сертификата. 
    * Корневой сертификат отсутствует в хранилище доверенных центров сертификации на локальном компьютере исходного компьютера. 
    * Истек срок действия SSL-сертификата, недопустимый, отозванный или несовместимый.

Для сетей, источники которых являются виртуальными машинами Azure, можно обнаружить следующие проблемы.

* Проблемы с агентом:
    * Агент остановлен.
    * Сбой разрешения DNS.
    * Ни приложение, ни прослушиватель не ожидают передачи данных на порт назначения.
    * Не удалось открыть сокет.
* Проблемы состояния виртуальной машины: 
    * Запуск
    * Stopping
    * Остановлена
    * Отмена выделения
    * Освобождено
    * Перезагрузки
    * Не выделено
* Отсутствует запись в таблице ARP.
* Трафик заблокирован из-за проблем с локальным брандмауэром или NSG правил.
* Проблемы шлюза виртуальной сети: 
    * Отсутствующие маршруты.
    * Туннель между двумя шлюзами отключен или отсутствует.
    * Второй шлюз не найден в туннеле.
    * Сведения об пиринга не найдены.
* В Microsoft погранично отсутствует маршрут.
* Трафик остановлен из-за системных маршрутов или UDR.
* BGP не включен в подключении шлюза.
* Проверка DIP не работает в подсистеме балансировки нагрузки.
