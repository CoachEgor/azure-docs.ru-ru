---
title: Монитор подключения (Предварительный просмотр) Документы Майкрософт
description: Узнайте, как использовать монитор соединения (Preview) для мониторинга сетевой связи в распределенной среде.
services: network-watcher
documentationcenter: na
author: vinynigam
manager: agummadi
editor: ''
tags: azure-resource-manager
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/27/2020
ms.author: vinigam
ms.custom: mvc
ms.openlocfilehash: 8f3a6f002fbebe215699c9b97a6dce63177c446f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77599331"
---
# <a name="network-connectivity-monitoring-with-connection-monitor-preview"></a>Мониторинг сетевой связи с помощью монитора соединения (Предварительный просмотр)

Монитор подключения (Preview) обеспечивает унифицированный сквозной мониторинг соединения в Azure Network Watcher. Функция Connection Monitor (Preview) поддерживает гибридные и облачные развертывания Azure. Network Watcher предоставляет инструменты для мониторинга, диагностики и просмотра метрик, связанных с подключением, для развертывания Azure.

Вот некоторые случаи использования для монитора соединения (Предварительный просмотр):

- Ваш передний веб-сервер VM общается с сервером баз данных VM в многоуровневом приложении. Вы хотите проверить подключение к сети между двумя ВМ.
- Вы хотите, чтобы в Восточном регионе США в ежевые в регионе США были высечены на всасывания, и вы хотите сравнить пропонизы между регионами сети.
- У вас есть несколько офисных площадок в Сиэтле, штат Вашингтон, и в Эшберне, штат Вирджиния. Сайты вашего офиса подключаются к URL-адресам Office 365. Для пользователей URL-адресов Office 365 сравните протекания между Сиэтлом и Эшберном.
- Гибридное приложение нуждается в подключении к конечной точке хранения Azure. Ваш сайт и приложение Azure подключаются к той же точке хранения Azure. Необходимо сравнить поздние сроки нахустья сайта с опозданием приложения Azure.
- Необходимо проверить связь между настройками в помещениях и vMs-мизанами Azure, вмещающие облачное приложение.

На этапе предварительного просмотра, Connection Monitor сочетает в себе лучшие из двух функций: функция сетевого наблюдателя [подключения и](https://docs.microsoft.com/azure/network-watcher/network-watcher-monitoring-overview#monitor-communication-between-a-virtual-machine-and-an-endpoint) функция сетевого монитора производительности (NPM) Service [Connectivity Monitor.](https://docs.microsoft.com/azure/azure-monitor/insights/network-performance-monitor-service-connectivity)

Вот некоторые преимущества connection Monitor (Предварительный просмотр):

* Единый, интуитивно понятный опыт для потребностей Azure и гибридного мониторинга
* Кросс-регион, кросс-рабочее пространство мониторинга подключения
* Более высокие частоты зондирования и лучшая видимость в производительности сети
* Более быстрое оповещение для гибридных развертываний
* Поддержка проверок подключения, основанных на HTTP, TCP и ICMP 
* Поддержка метрик и аналитики журналов для тестовых насработок Azure и не Azure

![Диаграмма, показывающая, как монитор соединения взаимодействует с MMs-мизантами Azure, не-Azure хостами, конечными точками и местами хранения данных](./media/connection-monitor-2-preview/hero-graphic.png)

Чтобы начать использовать connection Monitor (Preview) для мониторинга, выполните следующие действия: 

1. Установите агенты мониторинга.
1. Включить сетевой наблюдатель в подписке.
1. Создайте монитор соединения.
1. Настройка анализа данных и оповещений.
1. Диагностика проблем в вашей сети.

В следующих разделах приведены подробные сведения об этих шагах.

## <a name="install-monitoring-agents"></a>Установка агентов мониторинга

Connection Monitor полагается на легкие исполняемые файлы для выполнения проверок подключения.  Он поддерживает проверки подключения как из сред Azure, так и из местных сред. Используемая используйте файл зависит от того, размещается ли ваш VM в Azure или в предварительном помещении.

### <a name="agents-for-azure-virtual-machines"></a>Агенты для виртуальных машин Azure

Чтобы сделать connection Monitor распознавать ваши виртуальные компании Azure в качестве источников мониторинга, установите на них виртуальное расширение машины Network Watcher Agent. Это расширение также известно как *расширение Network Watcher.* Виртуальные машины Azure требуют расширения для запуска сквозного мониторинга и других передовых функций. 

Вы можете установить расширение Network Watcher при [создании VM.](https://docs.microsoft.com/azure/network-watcher/connection-monitor#create-the-first-vm) Вы также можете отдельно установить, настроить и устранить неполадки расширение Network Watcher для [Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/network-watcher-linux) и [Windows.](https://docs.microsoft.com/azure/virtual-machines/extensions/network-watcher-windows)

Правила для группы сетевой безопасности (NSG) или брандмауэра могут блокировать связь между источником и пунктом назначения. Connection Monitor обнаруживает эту проблему и отображает ее как диагностическое сообщение в топологии. Чтобы обеспечить мониторинг соединения, убедитесь, что правила NSG и брандмауэра позволяют пакеты над TCP или ICMP между источником и пунктом назначения.

### <a name="agents-for-on-premises-machines"></a>Агенты для наемных машин

Чтобы сделать Connection Monitor распознавать ваши наемные машины в качестве источников мониторинга, установите агент Log Analytics на машинах. Затем включите решение Network Performance Monitor. Эти агенты связаны с рабочими областями анализа журналов, поэтому необходимо настроить идентификатор рабочего пространства и основной ключ, прежде чем агенты смогут начать мониторинг.

Чтобы установить агент Log Analytics [Azure Monitor virtual machine extension for Windows](https://docs.microsoft.com/azure/virtual-machines/extensions/oms-windows)для компьютеров Windows, см.

Если путь включает в себя брандмауэры или сетевые виртуальные приборы (NVA), то убедитесь, что пункт назначения достижим.

## <a name="enable-network-watcher-on-your-subscription"></a>Включить сетевой наблюдатель в подписке

Все подписки с виртуальной сетью включены с помощью Network Watcher. При создании виртуальной сети в подписке Network Watcher автоматически включается в регионе виртуальной сети и подписке. Это автоматическое включение не влияет на ваши ресурсы и не несет заряда. Убедитесь, что Network Watcher не будет явно отключен абонементом в подписку. 

Для получения дополнительной информации [см.](https://docs.microsoft.com/azure/network-watcher/network-watcher-create)

## <a name="create-a-connection-monitor"></a>Создание монитора подключения 

Connection Monitor отслеживает связь через регулярные промежутки времени. Он информирует вас об изменениях в охватности и задержке. Вы также можете проверить текущую и историческую топологию сети между исходными агентами и конечными точками назначения.

Источниками могут быть VMs-ми лазурные вышивы или наемные машины с установленным агентом мониторинга. Конечными точками назначения могут быть URL-адреса Office 365, URL-адреса Dynamics 365, пользовательские URL-адреса, иномарки ресурсов Azure VM, IPv4, IPv6, F-DN или любое доменное имя.

### <a name="access-connection-monitor-preview"></a>Монитор подключения к доступу (Предварительный просмотр)

1. На главной странице портала Azure перейдите на **сайт Network Watcher**.
1. Слева, в разделе **Мониторинг,** выберите **монитор соединения (Preview)**.
1. Вы видите все мониторы соединения, которые были созданы в Connection Monitor (Preview). Чтобы увидеть мониторы соединения, которые были созданы в классическом опыте Connection Monitor, перейдите на вкладку **Connection Monitor.**

    ![Скриншот, показывающий мониторы соединения, которые были созданы в Connection Monitor (Предварительный просмотр)](./media/connection-monitor-2-preview/cm-resource-view.png)


### <a name="create-a-connection-monitor"></a>Создание монитора подключения

В связи с созданием мониторов в connection Monitor (Preview) можно добавить в качестве источников как припреденные машины, так и VMs-м ввоз. Эти мониторы соединения также могут контролировать подключение к конечным точкам. Конечные точки могут быть на Azure или любой другой URL или IP.

Монитор подключения (Preview) включает в себя следующие сущности:

* **Ресурс мониторинга соединения** — ресурс Azure, специфичный для региона. Все следующие сущности являются свойствами ресурса монитора соединения.
* **Конечная точка** — источник или пункт назначения, участвующий в проверках подключения. Примеры конечных точек включают ВМ Azure, агенты, URL-адреса и I-адреса.
* **Тестовая конфигурация** — конфигурация для теста для конкретного протокола. На основе выбранного вами протокола можно определить порт, пороги, частоту тестов и другие параметры.
* **Тестовая группа** — группа, содержащая исходные точки, конечные точки назначения и тестовые конфигурации. Монитор соединения может содержать несколько тестовых групп.
* **Тест** — сочетание конечной точки источника, конечной точки назначения и тестовой конфигурации. Тест является наиболее детальным уровнем, на котором доступны данные мониторинга. Данные мониторинга включают процент проверок, которые не удалось, и время в оба конца (RTT).

 ![Диаграмма, показывающая монитор соединения, определяющая взаимосвязь между тестовыми группами и тестами](./media/connection-monitor-2-preview/cm-tg-2.png)

#### <a name="create-a-connection-monitor-from-the-azure-portal"></a>Создание монитора соединения с портала Azure

Чтобы создать монитор соединения с портала Azure, выполните следующие действия:

1. На панели мониторинга **Connection Monitor (Preview)** в верхнем левом углу выберите **Создать.**
1. На вкладке **"Основы"** введите информацию для монитора соединения:
   * **Имя монитора соединения** - Добавить имя монитора соединения. Используйте стандартные правила именования для ресурсов Azure.
   * **Подписка** - Выберите подписку для монитора соединения.
   * **Регион** - Выберите регион для монитора соединения. Вы можете выбрать только исходные визы, созданные в этом регионе.
   * **Конфигурация рабочего пространства** - Ваше рабочее пространство содержит данные мониторинга. Можно использовать пользовательское рабочее пространство или рабочее пространство по умолчанию. 
       * Чтобы использовать рабочее пространство по умолчанию, выберите флажок. 
       * Чтобы выбрать пользовательское рабочее пространство, очистите флажок. Затем выберите подписку и регион для пользовательского рабочего пространства. 
1. В нижней части вкладки выберите **Следующая: Тестовые группы.**

   ![Скриншот, показывающий вкладку Основы в Connection Monitor](./media/connection-monitor-2-preview/create-cm-basics.png)

1. На вкладке **группы тестов** выберите **группу тестирования.** Чтобы настроить тестовые группы, [см. Создать тестовые группы в Connection Monitor.](#create-test-groups-in-a-connection-monitor) 
1. В нижней части вкладки выберите **Следующий: Обзор и создать** для просмотра монитора соединения.

   ![Скриншот, показывающий вкладку групп тестирования и панель, где вы добавляете детали тестовой группы](./media/connection-monitor-2-preview/create-tg.png)

1. На вкладке **«Обзор» — создайте** основную информацию и тестовые группы перед созданием монитора соединения. Если вам нужно отсваить монитор соединения:
   * Чтобы отсеять основные детали, выберите значок карандаша.
   * Чтобы отсеять тестовую группу, выберите ее.

   > [!NOTE] 
   > Вкладка **«Обзор и создание»** показывает стоимость в месяц на этапе предварительного просмотра Connection Monitor. В настоящее время столбец **CURRENT COST** не заряжает. Когда монитор подключения становится общедоступным, в этом столбце будет отображаться ежемесячная плата. 
   > 
   > Даже на этапе предварительного просмотра Connection Monitor взимается плата за прием в журнал analytics.

1. Когда вы будете готовы к созданию монитора соединения, в нижней части вкладки **«Обзор»** — создайте — **создайте — Создайте**— Создать.

   ![Скриншот монитора соединения, показывающий вкладку «Обзор» и «Создать»](./media/connection-monitor-2-preview/review-create-cm.png)

Монитор подключения (Preview) создает ресурс монитора соединения в фоновом режиме.

#### <a name="create-a-connection-monitor-by-using-armclient"></a>Создание монитора соединения с помощью ARMClient

Используйте следующий код для создания монитора соединения с помощью ARMClient.

```armclient
$connectionMonitorName = "sampleConnectionMonitor"

$ARM = "[https://](https://apac01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fbrazilus.management.azure.com&amp;data=02%7C01%7CManasi.Sant%40microsoft.com%7Cd900da4ed7f24366842108d68022159b%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636837281231186904&amp;sdata=qHL8zWjkobY9MatRpAVbODwboKSQAqqEFOMnjmfyOnU%3D&amp;reserved=0)management.azure.com"

$SUB = "subscriptions/\&lt;subscription id 1\&gt;"

$NW = "resourceGroups/NetworkWatcherRG/providers/Microsoft.Network/networkWatchers/NetworkWatcher\_centraluseuap"

$body =

"{

location: 'eastus',

properties: {

endpoints: [{

name: 'workspace',

resourceId: '/subscriptions/\&lt;subscription id\&gt;/resourcegroups/\&lt;resource group\&gt;/providers/Microsoft.OperationalInsights/workspaces/sampleWorkspace',

filter: {

 items: [{

type: 'AgentAddress',

address: '\&lt;FQDN of your on-premises agent'

}]

}

          },

 {

name: 'vm1',

resourceId: '/subscriptions/\&lt;subscription id\&gt;/resourceGroups/\&lt;resource group\&gt;/providers/Microsoft.Compute/virtualMachines/\&lt;vm-name\&gt;'

},

 {

name: 'vm2',

resourceId: '/subscriptions/\&lt;subscription id\&gt;/resourceGroups/\&lt;resource group\&gt;/providers/Microsoft.Compute/virtualMachines/\&lt;vm-name\&gt;'

   },

{

name: 'azure portal'

address: '\&lt;URL\&gt;'

   },

 {

    name: 'ip',

     address: '\&lt;IP\&gt;'

 }

  ],

  testGroups: [{

    name: 'Connectivity to Azure Portal and Public IP',

    testConfigurations: ['http', 'https', 'tcpEnabled', 'icmpEnabled'],

    sources: ['vm1', 'workspace'],

    destinations: ['azure portal', 'ip']

   },

{

    name: 'Connectivty from Azure VM 1 to Azure VM 2',

    testConfigurations: ['http', 'https', 'tcpDisabled', 'icmpDisabled'],

    sources: ['vm1'],

    destinations: ['vm2'],

    disable: true

   }

  ],

  testConfigurations: [{

    name: 'http',

    testFrequencySec: 60,

    protocol: 'HTTP',

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'https',

    testFrequencySec: 60,

    protocol: 'HTTP',

    httpConfiguration: {

     preferHTTPS: true

    },

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'tcpEnabled',

    testFrequencySec: 30,

    protocol: 'TCP',

    tcpConfiguration: {

     port: 80

    },

    successThreshold: {

     checksFailedPercent: 30,

     roundTripTimeMs: 5.2

    }

   }, {

    name: 'icmpEnabled',

    testFrequencySec: 90,

    protocol: 'ICMP',

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'icmpDisabled',

    testFrequencySec: 120,

    protocol: 'ICMP',

    icmpConfiguration: {

     disableTraceRoute: true

    },

    successThreshold: {

     checksFailedPercent: 50,

     roundTripTimeMs: 3.4

    }

   }, {

    name: 'tcpDisabled',

    testFrequencySec: 45,

    protocol: 'TCP',

    tcpConfiguration: {

     port: 80,

     disableTraceRoute: true

    },

    successThreshold: {

     checksFailedPercent: 30,

     roundTripTimeMs: 5.2

    }

   }

  ]

 }

} "
```

Вот команда развертывания:
```
armclient PUT $ARM/$SUB/$NW/connectionMonitors/$connectionMonitorName/?api-version=2019-07-01 $body -verbose
```

### <a name="create-test-groups-in-a-connection-monitor"></a>Создание испытательных групп на мониторе соединения

Каждая испытательная группа в мониторе соединения включает в себя источники и направления, которые проходят тестирование по параметрам сети. Они проверяются на процент проверок, которые не удались, и RTT над тестовыми конфигурациями.

С портала Azure для создания тестовой группы в мониторе соединения указаны значения для следующих полей:

* **Отоверьте тестовую группу** - Вы можете выбрать это поле, чтобы отключить мониторинг для всех источников и направлений, которые указывает испытательная группа. Этот выбор очищается по умолчанию.
* **Имя** - Назовите свою тестовую группу.
* **Источники** — Вы можете указать как VM Azure, так и в предварительные машины в качестве источников, если на них установлены агенты. Чтобы установить агент для вашего источника, [см.](#install-monitoring-agents)
   * Чтобы выбрать агенты Azure, выберите вкладку **Azure Agents.** Здесь вы видите только вс-чаевые, которые привязаны к указанному региону при создании монитора соединения. По умолчанию VMs группируются в подписку, к которой они принадлежат. Эти группы рухнули. 
   
       Вы можете сверлить с уровня подписки на другие уровни в иерархии:

      **Подписные** > **ресурсные группы** > **VNETs** > **Подсети** > **VMs с агентами**

      Вы также можете изменить значение **группы по полю,** чтобы начать дерево с любого другого уровня. Например, если группироваться по виртуальной сети, вы видите виртуальные вымотворцы, которые имеют агентов в иерархии **VNETs** > **Subnets** > **VMs с агентами.**

      ![Скриншот монитора соединения, показывающий панель добавленных источников и вкладку «Агенты Azure»](./media/connection-monitor-2-preview/add-azure-sources.png)

   * Чтобы выбрать штатные агенты, выберите вкладку **Non-Azure Agents.** По умолчанию агенты группируются в рабочие области по регионам. Все эти рабочие области настроены на решение Network Performance Monitor. 
   
       Если вам нужно добавить монитор производительности сети в рабочее пространство, получите его из [Azure Marketplace.](https://azuremarketplace.microsoft.com/marketplace/apps/Microsoft.NetworkMonitoringOMS?tab=Overview) Для получения информации о том, [Monitoring solutions in Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/insights/solutions)как добавить монитор производительности сети, см. 
   
       В представлении **«Монитор подключения»** на **вкладке «Основы»** выбирается область по умолчанию. Если вы измените область, вы можете выбрать агентов из рабочих областей в новом регионе. Вы также можете изменить значение **Группы по** полю в группу по подсетям.

      ![Скриншот монитора соединения, показывающий панель добавленных источников и вкладку не-azure Agents](./media/connection-monitor-2-preview/add-non-azure-sources.png)


   * Чтобы просмотреть выбранные вами агенты Azure и не-Azure, перейдите на вкладку **«Обзор».**

      ![Скриншот монитора соединения, показывающий панель добавленных источников и вкладку «Обзор»](./media/connection-monitor-2-preview/review-sources.png)

   * Когда вы закончите настройку источников, в нижней части панели **Добавления источников,** выберите **Done.**

* **Направления** — Вы можете отслеживать подключение к VMs-адресам Azure или любой конечней точке (публичный IP, URL или F-DN), указывая их в качестве пунктов назначения. В одной тестовой группе можно добавить MMs Azure VMs, URL-адреса Office 365, URL-адреса Dynamics 365 и пользовательские конечные точки.

    * Чтобы выбрать ВМ Azure в качестве пунктов назначения, выберите вкладку **Azure VMs.** По умолчанию в вкладке «Основы» в иерархии подписчиков, выбранной в представлении **«Монитор подключения»,** в **вкладке «Основы»** группируются в иерархии подписчиков. Вы можете изменить область и выбрать VMs Azure из недавно выбранного региона. Затем можно сверлить с уровня подписки на другие уровни иерархии, например уровень агентов Azure.

       ![Скриншот панели Добавления Destinations, показывающей вкладку Azure VMs](./media/connection-monitor-2-preview/add-azure-dests1.png)

       ![Скриншот панели «Добавление направлений», показывающей уровень подписки](./media/connection-monitor-2-preview/add-azure-dests2.png)

    * Чтобы выбрать конечные точки в качестве пунктов назначения, выберите вкладку **Endpoints.** Список конечных точек включает в себя тестовые URL-адреса Office 365 и тестовых URL-адресов Dynamics 365, сгруппированные по имени. В дополнение к этим конечным точкам можно выбрать конечную точку, которая была создана в других группах тестирования в том же мониторе соединения. 
    
        Чтобы добавить новую конечную точку в правом верхнем углу, выберите **конечные точки.** Затем укажите имя конечных точек и URL-адрес, IP или F-DN.

       ![Скриншот, показывающий, где добавить конечные точки в качестве пунктов назначения в Connection Monitor](./media/connection-monitor-2-preview/add-endpoints.png)

    * Чтобы просмотреть выбранные вами визы Azure и выбранные конечные точки, выберите вкладку **«Обзор».**
    * Когда вы закончите выбор направлений, выберите **Done**.

* **Тестовые конфигурации** — Можно связать тестовые конфигурации в тестовой группе. Портал Azure позволяет только одну тестовую конфигурацию в одной тестовой группе, но вы можете использовать ARMClient, чтобы добавить больше.

    * **Имя** - Назовите тестовую конфигурацию.
    * **Протокол** - Выберите TCP, ICMP или HTTP. Чтобы изменить HTTPНа в HTTPS, выберите **HTTP** в качестве протокола и выберите **443** в качестве порта.
        * **Создание конфигурации сетевого тестирования** - Этот флажок появляется только при выборе **HTTP** в поле **протокола.** Выберите это поле для создания другой тестовой конфигурации, которая использует те же источники и направления, которые вы указали в других местах в вашей конфигурации. Названа недавно созданная тестовая `<the name of your test configuration>_networkTestConfig`конфигурация.
        * **Удаивной трассу** - Это поле применяется к тестовых групп, протоколом которых является TCP или ICMP. Выберите эту коробку, чтобы остановить источники от обнаружения топологии и хоп-на-хоп RTT.
    * **Порт назначения** - Вы можете настроить это поле с портом назначения по вашему выбору.
    * **Частота тестирования** - Используйте это поле, чтобы выбрать, как часто источники будут пинг назначения на протокол и порт, который вы указали. Вы можете выбрать 30 секунд, 1 минуту, 5 минут, 15 минут или 30 минут. Источники будут тестировать подключение к назначениям на основе значения, которое вы выбираете.  Например, если вы выберете 30 секунд, источники будут проверять подключение к пункту назначения по крайней мере один раз в 30-секундный период.
    * **Порог успеха** - Вы можете установить пороги на следующих параметрах сети:
       * **Не удалось выполнить проверки** — Установить процент проверок, которые могут выйти из строя при проверке источников подключения к пунктам назначения, используя указанные критерии. Для протокола TCP или ICMP процент неудачных проверок можно приравнять к проценту потерь пакетов. Для протокола HTTP это поле представляет процент запросов HTTP, которые не получили ответа.
       * **Время в оба конца** - Установите RTT в миллисекундах, сколько времени может занять источники для подключения к месту назначения по тестовой конфигурации.
    
       ![Скриншот, показывающий, где настроить тестовую конфигурацию в Connection Monitor](./media/connection-monitor-2-preview/add-test-config.png)

Все источники, направления и тестовые конфигурации, добавленные в тестовую группу, разбиты на отдельные тесты. Вот пример того, как разбиваются источники и направления:

* Испытательная группа: TG1
* Источники: 3 (A, B, C)
* Направления: 2 (D, E)
* Тестовые конфигурации: 2 (Конфигурация 1, Конфигурация 2)
* Всего созданных тестов: 12

| Номер теста | Источник | Назначение | Конфигурация теста |
| --- | --- | --- | --- |
| 1 | Объект | D | Конфиг 1 |
| 2 | Объект | D | Конфиг 2 |
| 3 | Объект | E | Конфиг 1 |
| 4 | Объект | E | Конфиг 2 |
| 5 | B | D | Конфиг 1 |
| 6 | B | D | Конфиг 2 |
| 7 | B | E | Конфиг 1 |
| 8 | B | E | Конфиг 2 |
| 9 | C | D | Конфиг 1 |
| 10 | C | D | Конфиг 2 |
| 11 | C | E | Конфиг 1 |
| 12 | C | E | Конфиг 2 |

### <a name="scale-limits"></a> Ограничения масштабирования

Мониторы подключения имеют следующие ограничения масштаба:

* Мониторы максимального подключения на одну подписку в регионе: 100
* Максимальные тестовые группы на монитор соединения: 20
* Максимальные источники и направления на монитор соединения: 100
* Максимальные тестовые конфигурации на монитор соединения: 
    * 20 через ARMClient
    * 2 через портал Azure

## <a name="analyze-monitoring-data-and-set-alerts"></a>Анализ данных мониторинга и набора оповещений

После создания монитора соединения источники проверяют подключение к пунктам назначения на основе тестовой конфигурации.

### <a name="checks-in-a-test"></a>Проверка в тесте

На основе выбранного вами протокола в тестовой конфигурации, Connection Monitor (Preview) выполняет серию проверок пары исходных пунктов назначения. Проверки проходят в соответствии с выбранной частотой тестирования.

Если вы используете HTTP, служба вычисляет количество ответов HTTP, которые вернули код ответа. Результат определяет процент неудачных проверок. Для расчета RTT служба измеряет время между вызовом HTTP и ответом.

Если вы используете TCP или ICMP, служба вычисляет процент потерь пакетов, чтобы определить процент неудачных проверок. Для расчета RTT служба измеряет время, затрачаемые на получение подтверждения (ACK) для отправленных пакетов. Если вы включили данные трассы для сетевых тестов, можно увидеть потерю и задержку в вашей сети.

### <a name="states-of-a-test"></a>Состояния теста

На основе данных, которые возвращаются чеки, тесты могут иметь следующие состояния:

* **Pass** - Фактические значения по проценту неудачных проверок и RTT находятся в пределах указанных пороговых значений.
* **Fail** - Фактические значения для процента невыполненных проверок или RTT превысили указанные пороговые значения. Если порог не указан, тест достигает состояния Fail, когда процент неудачных проверок составляет 100.
* **Предупреждение** - Не было определено критериев для процента неудачных проверок. При отсутствии указанных критериев, Connection Monitor (Preview) автоматически назначает порог. При превышении порога статус теста изменяется в Предупреждение.

### <a name="data-collection-analysis-and-alerts"></a>Сбор, анализ и оповещения

Данные, собираемые монитором соединения (Preview), хранятся в рабочей области Log Analytics. Вы настраиваете это рабочее пространство при создании монитора соединения. 

Данные мониторинга также доступны в Azure Monitor Metrics. Вы можете использовать Log Analytics для сохранения данных мониторинга до тех пор, пока вы хотите. Azure Monitor хранит метрики только 30 дней по умолчанию. 

Можно [настроить предупреждения на основе метрики на данных.](https://azure.microsoft.com/blog/monitor-at-scale-in-azure-monitor-with-multi-resource-metric-alerts/)

#### <a name="monitoring-dashboards"></a>Панели мониторинга

На панелях мониторинга можно увидеть список мониторов соединения, к которым можно получить доступ для подписок, регионов, временных меток, источников и типов назначения.

При перейдите на монитор соединения (Preview) от Network Watcher, вы можете просматривать данные по:

* **Монитор соединения** — Список всех мониторов соединения, созданных для подписок, регионов, временных штампов, источников и типов назначения. Это представление используется по умолчанию.
* **Тестовые группы** — Список всех тестовых групп, созданных для ваших подписок, регионов, временных штампов, источников и типов назначения. Эти тестовые группы не фильтруются мониторами соединения.
* **Тест** — Список всех тестов, которые работают для ваших подписок, регионов, временных марок, источников и типов назначения. Эти тесты не фильтруются мониторами соединения или тестовыми группами.

На следующем изображении три представления данных указаны стрелой 1.

На панели мониторинга можно расширить каждый монитор соединения, чтобы увидеть его тестовые группы. Затем можно расширить каждую тестовую группу, чтобы увидеть тесты, которые в ней работают. 

Вы можете отфильтровать список на основе:

* **Фильтры верхнего уровня** - Выберите подписки, регионы, источники штампов времени и типы назначения. Смотрите поле 2 на следующем изображении.
* **Фильтры на основе состояния** — Фильтр по состоянию монитора соединения, тестовой группы или теста. Смотрите стрелку 3 на следующем изображении.
* **Пользовательские фильтры** - **Выберите все,** чтобы сделать общий поиск. Для поиска по определенной сущности выберите из списка выпадающих. Смотрите стрелку 4 на следующем изображении.

![Скриншот, показывающий, как фильтровать представления мониторов соединения, тестовых групп и тестов в Connection Monitor (Предварительный просмотр)](./media/connection-monitor-2-preview/cm-view.png)

Например, чтобы посмотреть на все тесты в Connection Monitor (Preview), где источник IP 10.192.64.56:
1. Измените представление на **тест.**
1. В поле поиска, тип *10.192.64.56*
1. В списке выпадающих вниз, выберите **Источники**.

Чтобы показать только неудачные тесты в Connection Monitor (Preview), где источник IP 10.192.64.56:
1. Измените представление на **тест.**
1. Для фильтра на основе состояния выберите **Fail**.
1. В поле поиска, тип *10.192.64.56*
1. В списке выпадающих вниз, выберите **Источники**.

Чтобы показать только неудачные тесты в Connection Monitor (Preview), где пункт назначения находится outlook.office365.com:
1. Изменение представления для **тестирования**.
1. Для фильтра на основе состояния выберите **Fail**.
1. В поле поиска введите *outlook.office365.com*
1. В списке выпадающих направлений выберите **Направления.**

   ![Скриншот, показывающий представление, отфильтрованное для отображения только неудачных тестов для Outlook.Office365.com назначения](./media/connection-monitor-2-preview/tests-view.png)

Для просмотра тенденций в RTT и процент неудачных проверок для монитора соединения:
1. Выберите монитор соединения, который вы хотите исследовать. По умолчанию данные мониторинга организуется тестовой группой.

   ![Скриншот, показывающий метрики для монитора соединения, отображаемые тестовой группой](./media/connection-monitor-2-preview/cm-drill-landing.png)

1. Выберите тестовую группу, которую вы хотите исследовать.

   ![Скриншот, показывающий, где выбрать тестовую группу](./media/connection-monitor-2-preview/cm-drill-select-tg.png)

    Вы видите пять лучших неудачных тестов вашей тестовой группы, основанные на RTT или проценте неудачных проверок. Для каждого теста вы видите RTT и трендовые линии для процента неудачных проверок.
1. Выберите тест из списка или выберите другой тест для исследования. Для интервала времени и процента неудачных проверок вы видите пороговые и фактические значения. Для RTT вы видите значения для порога, среднего, минимального и максимального.

   ![Скриншот, показывающий результаты теста для RTT и процент неудачных проверок](./media/connection-monitor-2-preview/cm-drill-charts.png)

1. Измените временной интервал для просмотра дополнительных данных.
1. Измените представление, чтобы увидеть источники, назначения или тестовые конфигурации. 
1. Выберите источник на основе неудачных тестов и исследуйте пять лучших неудачных тестов. Например, выберите **View by** > **Sources** и **View by** > **Destinations** для изучения соответствующих тестов в мониторе соединения.

   ![Скриншот, показывающий показатели производительности для пяти неудавшихся тестов](./media/connection-monitor-2-preview/cm-drill-select-source.png)

Для просмотра тенденций в РТТ и процент неудачных проверок для тестовой группы:

1. Выберите тестовую группу, которую вы хотите исследовать. 

    По умолчанию данные мониторинга расположены источниками, назначениями и тестовыми конфигурациями (тестами). Позже можно изменить представление из тестовых групп в источники, направления или тестовые конфигурации. Затем выберите сущность для исследования пяти неудачных тестов. Например, измените представление в источники и пункты назначения для изучения соответствующих тестов в выбранном мониторе соединения.
1. Выберите тест, который вы хотите исследовать.

   ![Скриншот, показывающий, где выбрать тест](./media/connection-monitor-2-preview/tg-drill.png)

    Для интервала времени и процента невыполненных проверок вы видите пороговые значения и фактические значения. Для RTT вы видите значения для порога, среднего, минимального и максимального. Вы также видите выбранные предупреждения об увольнении.
1. Измените временной интервал для просмотра дополнительных данных.

Для просмотра тенденций в RTT и процент неудачных проверок для теста:
1. Выберите исходную конфигурацию, пункт назначения и тестовую конфигурацию, которую необходимо исследовать.

    Для интервала времени и для процента неудачных проверок вы видите пороговые значения и фактические значения. Для RTT вы видите значения для порога, среднего, минимального и максимального. Вы также видите выбранные предупреждения об увольнении.

   ![Скриншот, показывающий метрики для теста](./media/connection-monitor-2-preview/test-drill.png)

1. Чтобы увидеть топологию сети, выберите **топологию.**

   ![Скриншот, показывающий вкладку топологии сети](./media/connection-monitor-2-preview/test-topo.png)

1. Чтобы увидеть выявленные проблемы, в топологии выберите любой переход в пути. (Эти прыжки являются ресурсами Azure.) Эта функциональность в настоящее время недоступна для сетей.

   ![Скриншот, показывающий выбранную ссылку на хмель на вкладке Topology](./media/connection-monitor-2-preview/test-topo-hop.png)

#### <a name="log-queries-in-log-analytics"></a>Запросы журнала в журнале Analytics

Используйте log Analytics для создания пользовательских представлений данных мониторинга. Все данные, отображаемые uI, получены в журнале Log Analytics. Можно интерактивно анализировать данные в репозитории. Соотвеничайте данные из Agent Health или других решений, основанных на журнале Analytics. Экспортировать данные в Excel или Power BI или создавать общую ссылку.

#### <a name="metrics-in-azure-monitor"></a>Метрики в Azure Monitor

В связи с мониторами, созданными до появления интерфейсного монитора (Preview), доступны все четыре метрики: % зондов Не удалось, AverageRoundtripMs, ChecksFailedPercent (Предварительный просмотр) и RoundTripTimeMs (Предварительный просмотр). В связи с мониторами, созданными в опыте connection Monitor (Preview), данные доступны только для метрик, отмеченных *(Preview)*.

![Скриншот, показывающий метрики в мониторе соединения (Предварительный просмотр)](./media/connection-monitor-2-preview/monitor-metrics.png)

При использовании метрик установите тип ресурса как Microsoft.Network/networkWatchers/connectionMonitors

| Метрика | Отображаемое имя | Единицы | Тип агрегирования | Описание | Измерения |
| --- | --- | --- | --- | --- | --- |
| ProbesFailedPercent | Доля проб с ошибками, в процентах | Процент | Среднее | Процент зондов мониторинга подключения не удалось. | Нет измерений |
| AverageRoundtripMs | Avg. Время в оба конца (ms) | Миллисекунды | Среднее | Средняя сеть RTT для зондов мониторинга подключения, отправляемых между источником и пунктом назначения. |             Нет измерений |
| ChecksFailedPercent (Предварительный просмотр) | % Проверки не удалось (Предварительный просмотр) | Процент | Среднее | Процент неудачных проверок для теста. | ConnectionMonitorResourceId <br>ИсточникАдрес <br>SourceName <br>ИсточникРесурсИд <br>Тип источника <br>Протокол <br>DestinationAddress <br>DestinationName <br>НаправлениеРесурсИд <br>DestinationType <br>DestinationPort <br>TestGroupName <br>TestConfigurationNameName <br>Регион |
| RoundTriptimeMs (Предварительный просмотр) | Время в оба конца (ms) (Предварительный просмотр) | Миллисекунды | Среднее | RTT для проверки, отправленной между источником и пунктом назначения. Это значение не усреднено. | ConnectionMonitorResourceId <br>ИсточникАдрес <br>SourceName <br>ИсточникРесурсИд <br>Тип источника <br>Протокол <br>DestinationAddress <br>DestinationName <br>НаправлениеРесурсИд <br>DestinationType <br>DestinationPort <br>TestGroupName <br>TestConfigurationNameName <br>Регион |

#### <a name="metric-alerts-in-azure-monitor"></a>Метрические оповещения в Azure Monitor

Чтобы создать оповещение в Azure Monitor:

1. Выберите ресурс монитора соединения, созданный в Connection Monitor (Preview).
1. Убедитесь, что **Метрика** отображается в качестве типа сигнала для монитора соединения.
1. В **Добавлении Условие**, для **названия сигнала**, выберите **ChecksFailedPercent (Предварительный просмотр)** или **RoundTripTimeMs (Предварительный просмотр)**.
1. Для **типа сигнала**выберите **метрики.** Например, выберите **ChecksFailedPercent (Предварительный просмотр)**.
1. Перечислены все размеры метрики. Выберите имя и значение измерения. Например, выберите **адрес источника,** а затем введите IP-адрес любого источника в мониторе соединения.
1. В **логике оповещения**, заполните следующие детали:
   * **Тип состояния**: **Статический**.
   * **Состояние** и **порог**.
   * **Агрегация Детализация и частота оценки**: Connection Monitor (Предварительный просмотр) обновляет данные каждую минуту.
1. В **действиях**выберите группу действий.
1. Предоставьте сведения о помехе.
1. Создайте правило генерации оповещений.

   ![Скриншот, показывающий область правил «Создание» в Azure Monitor; Выделены "Источник адреса" и "Имя конечная точка источника"](./media/connection-monitor-2-preview/mdm-alerts.jpg)

## <a name="diagnose-issues-in-your-network"></a>Диагностика проблем в сети

Монитор подключения (Preview) помогает диагностировать проблемы в мониторе соединения и вашей сети. Проблемы в гибридной сети обнаруживаются агентами Log Analytics, которые вы установили ранее. Проблемы в Azure обнаруживаются расширением Network Watcher. 

Вы можете просматривать проблемы в сети Azure в топологии сети.

Для сетей, источники которых являются на территории ВМ, можно обнаружить следующие проблемы:

* Истекло время ожидания для запроса.
* Конечная точка не решена DNS - временной или постоянной. URL недействителен.
* Хозяина не найдено.
* Источник не может подключиться к пункту назначения. Цель не достижима через ICMP.
* Вопросы, связанные с сертификатом: 
    * Сертификат клиента, необходимый для проверки подлинности агента. 
    * Список перемещения сертификатов недоступен. 
    * Имя хоста конечной точки не совпадает с темой или альтернативным именем предмета сертификата. 
    * Корневой сертификат отсутствует в локальном магазине органов по сертификации. 
    * Сертификат SSL просрочен, недействителен, аннулирован или несовместим.

Для сетей, источниками которых являются M Ms Azure, можно обнаружить следующие проблемы:

* Вопросы агента:
    * Агент остановился.
    * Не удалось dNS-разрешение.
    * Нет приложения или слушателя прослушивания в порту назначения.
    * Разъем не удалось открыть.
* Вопросы состояния VM: 
    * Запуск
    * Остановка
    * Остановлена
    * Отмена выделения
    * Освобождено
    * Перезагрузки
    * Не выделено
* Запись таблицы ARP отсутствует.
* Трафик был заблокирован из-за локальных проблем с брандмауэром или правил NSG.
* Проблемы с виртуальными сетевыми шлюзами: 
    * Отсутствующие маршруты.
    * Туннель между двумя шлюзами отключен или отсутствует.
    * Второй шлюз не был найден в туннеле.
    * Не было найдено никакой вглядывающей информации.
* Маршрут отсутствовал в Microsoft Edge.
* Движение остановлено из-за системных маршрутов или УДР.
* BGP не включен в подключении шлюза.
* Зонд DIP не работает на балансере нагрузки.
