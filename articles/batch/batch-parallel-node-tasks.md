---
title: Параллельное выполнение задач для оптимизации вычислительных ресурсов
description: Вы можете увеличить эффективность и снизить стоимость, используя меньшее количество вычислительных узлов. Это возможно благодаря параллельному выполнению задач на каждом узле в пуле пакетной службы Azure.
ms.topic: how-to
ms.date: 10/08/2020
ms.custom: H1Hack27Feb2017, devx-track-csharp
ms.openlocfilehash: 3c3a81aa624ccc67c0f9e8ec23e5ef9b8e61c724
ms.sourcegitcommit: efaf52fb860b744b458295a4009c017e5317be50
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/08/2020
ms.locfileid: "91851005"
---
# <a name="run-tasks-concurrently-to-maximize-usage-of-batch-compute-nodes"></a>Параллельное выполнение задач для эффективного использования вычислительных узлов пакетной службы

Выполняя несколько задач одновременно на каждом вычислительном узле в пуле пакетной службы Azure, можно увеличить использование ресурсов при меньшем количестве узлов в пуле. Для некоторых рабочих нагрузок это позволит сократить время выполнения заданий и уменьшить затраты.

Во многих случаях выгоднее использовать все ресурсы узла для выполнения одной задачи. Но для нескольких ситуаций совместное использование ресурсов несколькими задачами дает следующие преимущества:

* **уменьшается объем передачи данных** . В этом сценарии можно существенно сократить стоимость передачи данных, копируя общие данные на меньшее количество узлов и выполняя задачи в параллельном режиме на каждом узле. Это особенно актуально, если данные, которые копируются на каждый узел, необходимо передавать между географическими регионами.
* **повышается эффективность использования памяти** . Для эффективной обработки таких нагрузок можно использовать меньшее число более крупных вычислительных узлов с большим объемом памяти. Эти узлы могли бы иметь параллельные задачи, которые выполняются на каждом узле, но каждая задача использовала бы большой объем памяти узлов в разное время.
* **уменьшается ограничение по количеству узлов** . Сейчас существует ограничение в 50 вычислительных узлов для пулов, в которых настроен обмен данными между узлами. Поэтому если каждый узел в таком пуле будет выполнять задачи параллельно, можно будет выполнять больше задач одновременно.
* **Выполняется репликация локального вычислительного кластера**, например, как при первичном переходе в вычислительную среду Azure. Увеличение максимального числа задач на узле позволит точнее скопировать существующую физическую конфигурацию, если текущее локальное решение позволяет выполнять несколько задач на каждом вычислительном узле.

## <a name="example-scenario"></a>Пример сценария
Чтобы продемонстрировать преимущества параллельного выполнения задач, рассмотрим такой пример. Допустим, ваше приложение имеет такие требования к ЦП и памяти, что для его работы достаточно узла размера [Standard\_D1](../cloud-services/cloud-services-sizes-specs.md). Однако для выполнения задачи в заданное время потребуется 1000 таких узлов.

Вместо узлов размера Standard\_D1, каждый из которых содержит одно ядро ЦП, вы можете использовать 16-ядерные узлы [Standard\_D14](../cloud-services/cloud-services-sizes-specs.md), включив на них параллельное выполнение задач. Таким образом, потребуется *в 16 раз меньше узлов* , то есть 63 узла вместо 1000. Кроме того, если каждому узлу требуются большие файлы приложений либо эталонные данные, время выполнения и эффективность будут улучшены, так как данные будут копироваться только на 63 узла.

## <a name="enable-parallel-task-execution"></a>Включение параллельного выполнения задач
Настройка параллельного выполнения задач для вычислительных узлов выполняется на уровне пула. При создании пула с помощью библиотеки .NET для пакетной службы задайте свойство [CloudPool. таскслотсперноде][maxtasks_net] . Если вы используете пакетную REST API, задайте элемент [таскслотсперноде][rest_addpool] в тексте запроса во время создания пула.

Пакетная служба Azure позволяет устанавливать слоты задач на каждый узел вплоть до (4X) количества ядер узлов. Например, если для пула настроены узлы размера "Большой" (четыре ядра), для параметра `taskSlotsPerNode` можно задать значение 16. Однако независимо от того, сколько ядер имеет узел, у вас не может быть более 256 слотов задач на каждый узел. Сведения о количестве ядер для каждого узла см. в статье [Размеры для облачных служб](../cloud-services/cloud-services-sizes-specs.md). Дополнительные сведения об ограничениях службы см. в статье [Квоты и ограничения пакетной службы Azure](batch-quota-limit.md).

> [!TIP]
> Обязательно учитывайте значение параметра `taskSlotsPerNode` при создании [формулы автомасштабирования][enable_autoscaling] для пула. Например, если в формуле учитывается параметр `$RunningTasks`, изменение количества задач существенно повлияет на результат ее применения. Дополнительные сведения см. в статье [Автоматическое масштабирование вычислительных узлов в пуле пакетной службы Azure](batch-automatic-scaling.md).
>
>

> [!NOTE]
> `taskSlotsPerNode`Элемент и свойство [таскслотсперноде][maxtasks_net] можно задать только во время создания пула. Их невозможно изменить после создания пула.
>
>

## <a name="distribution-of-tasks"></a>Распределение задач
Если вычислительные узлы в пуле могут выполнять задачи параллельно, важно указать правила распределения задач между узлами пула.

С помощью свойства [CloudPool.TaskSchedulingPolicy][task_schedule] можно указать, что задачи должны назначаться ("распространяться") равномерно по всем узлам в кластере. Или можно указать, что перед переходом к следующему узлу необходимо назначить максимальное количество задач текущему узлу ("упаковка").

В качестве примера того, как эта функция ценна, рассмотрим пул [стандартных узлов \_ D14](../cloud-services/cloud-services-sizes-specs.md) (в примере выше), для которого настроено значение [CloudPool. таскслотсперноде][maxtasks_net] , равное 16. Если в свойстве [CloudPool.TaskSchedulingPolicy][task_schedule] для параметра [ComputeNodeFillType][fill_type] будет указано значение *Pack*, то на каждом узле все 16 ядер будут задействованы по максимуму. При этом [автомасштабируемый пул](batch-automatic-scaling.md) будет исключать неиспользуемые узлы (для которых не назначены задачи). Это снизит использование ресурсов и расходы на них.

## <a name="variable-slots-per-task"></a>Переменные слоты на задачу
Задачу можно определить с помощью свойства [CloudTask. рекуиредслотс][taskslots_net] , чтобы указать, сколько слотов требуется для выполнения на кластерном узле со значением по умолчанию 1. Можно задать переменные слоты задач, если задачи имеют разные весовые коэффициенты в отношении использования ресурсов на вычислительном узле, поэтому каждый вычислительный узел может иметь разумное количество параллельно выполняемых задач без переполнения системных ресурсов, таких как ЦП или память.

Например, для пула с свойством `taskSlotsPerNode = 8` можно отправить многоядерные задачи, требующие интенсивного использования ЦП, с помощью `requiredSlots = 8` , а другие задачи — с `requiredSlots = 1` . Когда эта смешанная рабочая нагрузка планируется в пуле, задачи с интенсивным использованием ЦП будут выполняться исключительно на вычислительном узле, а другие задачи могут выполняться одновременно (до восьми задач) на других узлах. Это поможет сбалансировать рабочую нагрузку на разных компьютерах вычислений и повысить эффективность использования ресурсов.

> [!TIP]
> При использовании переменных слотов задач возможно, что большие задачи с большим количеством слотов могут быть временно невозможны из-за недостаточного количества доступных слотов на любом из узлов вычислений, даже если на некоторых узлах остались свободные слоты. Вы можете увеличить приоритет задания для этих задач, чтобы повысить вероятность того, что они будут конкурировать за доступные слоты на узлах.
>
> Пакетная служба также выдает [тасксчедулефаилевент](batch-task-schedule-fail-event.md) , когда не удается запланировать выполнение задачи, в то же время продолжает повторять планирование до тех пор, пока нужные слоты не станут доступными. Вы можете прослушать это событие, чтобы определить потенциальную ошибку планирования задач и выполнить соответствующие меры.
>

> [!NOTE]
> Не указывайте значение задачи, превышающее `requiredSlots` значение в пуле `taskSlotsPerNode` . Это приведет к тому, что задача не сможет выполняться. В настоящее время Пакетная служба не выполняет эту проверку при отправке задач, так как задание может не иметь привязки к пулу во время отправки или быть изменено на другой пул путем отключения или повторного включения.
>

## <a name="batch-net-example"></a>Пример использования компонента .NET пакетной службы
В следующих фрагментах кода API [.NET пакетной][api_net] службы показано, как создать пул с несколькими слотами задач на один узел и отправить задачу с нужными слотами.

### <a name="create-pool"></a>Создание пула
Этот фрагмент кода показывает запрос на создание пула, содержащего четыре узла с четырьмя слотами задач, разрешенными для каждого узла. Он задает политику планирования задач, при которой каждому узлу назначается максимальное количество задач перед переходом к следующему узлу пула. Дополнительные сведения о добавлении пулов с использованием API .NET пакетной службы см. в описании метода [BatchClient.PoolOperations.CreatePool][poolcreate_net].

```csharp
CloudPool pool =
    batchClient.PoolOperations.CreatePool(
        poolId: "mypool",
        targetDedicatedComputeNodes: 4
        virtualMachineSize: "standard_d1_v2",
        cloudServiceConfiguration: new CloudServiceConfiguration(osFamily: "5"));

pool.TaskSlotsPerNode = 4;
pool.TaskSchedulingPolicy = new TaskSchedulingPolicy(ComputeNodeFillType.Pack);
pool.Commit();
```

### <a name="create-task-with-required-slots"></a>Создание задачи с необходимыми слотами
Этот фрагмент кода создает задачу со значением, отличным от значения по умолчанию `requiredSlots` . Эта задача будет выполняться только при наличии достаточного количества свободных слотов на кластерном узле.
```csharp
CloudTask task = new CloudTask(taskId, taskCommandLine)
{
    RequiredSlots = 2
};
```

### <a name="list-compute-nodes-with-counts-for-running-tasks-and-slots"></a>Вывод списка расчетных узлов с учетом количества выполняемых задач и слотов
Этот фрагмент кода перечисляет все расчетные узлы в пуле и выводит счетчики для выполняемых задач и слотов задач на каждом узле.
```csharp
ODATADetailLevel nodeDetail = new ODATADetailLevel(selectClause: "id,runningTasksCount,runningTaskSlotsCount");
IPagedEnumerable<ComputeNode> nodes = batchClient.PoolOperations.ListComputeNodes(poolId, nodeDetail);

await nodes.ForEachAsync(node =>
{
    Console.WriteLine(node.Id + " :");
    Console.WriteLine($"RunningTasks = {node.RunningTasksCount}, RunningTaskSlots = {node.RunningTaskSlotsCount}");

}).ConfigureAwait(continueOnCapturedContext: false);
```

### <a name="list-task-counts-for-the-job"></a>Перечисление количества задач для задания
Этот фрагмент кода возвращает количество задач для задания, которое включает число слотов задач и задач для каждого состояния задачи.
```csharp
TaskCountsResult result = await batchClient.JobOperations.GetJobTaskCountsAsync(jobId);

Console.WriteLine("\t\tActive\tRunning\tCompleted");
Console.WriteLine($"TaskCounts:\t{result.TaskCounts.Active}\t{result.TaskCounts.Running}\t{result.TaskCounts.Completed}");
Console.WriteLine($"TaskSlotCounts:\t{result.TaskSlotCounts.Active}\t{result.TaskSlotCounts.Running}\t{result.TaskSlotCounts.Completed}");
```

## <a name="batch-rest-example"></a>Пример интерфейса REST API пакетной службы
Этот фрагмент кода для [REST API пакетной службы][api_rest] содержит запрос на создание пула с двумя большими узлами и максимальным количеством задач на каждый узел, равным четырем. Дополнительные сведения о добавлении пулов с помощью REST API см. в статье [Добавление пула к учетной записи][rest_addpool].

```json
{
  "odata.metadata":"https://myaccount.myregion.batch.azure.com/$metadata#pools/@Element",
  "id":"mypool",
  "vmSize":"large",
  "cloudServiceConfiguration": {
    "osFamily":"4",
    "targetOSVersion":"*",
  },
  "targetDedicatedComputeNodes":2,
  "taskSlotsPerNode":4,
  "enableInterNodeCommunication":true,
}
```

В этом фрагменте кода показан запрос на добавление задачи со значением, отличным от значения по умолчанию `requiredSlots` . Эта задача будет выполняться только при наличии достаточного количества свободных слотов на кластерном узле.
```json
{
  "id": "taskId",
  "commandLine": "bash -c 'echo hello'",
  "userIdentity": {
    "autoUser": {
      "scope": "task",
      "elevationLevel": "nonadmin"
    }
  },
  "requiredSLots": 2
}
```

## <a name="code-sample"></a>Пример кода
Проект [параллелнодетаскс][parallel_tasks_sample] на сайте GitHub иллюстрирует использование свойства [CloudPool. таскслотсперноде][maxtasks_net] .

Это консольное приложение C# использует библиотеку [.NET пакетной службы][api_net] для создания пула с одним или несколькими вычислительными узлами. Для имитации переменной нагрузки оно выполняет заданное количество задач на этих узлах. Вывод приложения указывает, на каких узлах выполнялась каждая задача. Приложение также предоставляет сводку параметров задания и времени его выполнения. Ниже приводится часть сводки выходных данных примера приложения по двум различным запускам.

```
Nodes: 1
Node size: large
Task slots per node: 1
Max slots per task: 1
Tasks: 32
Duration: 00:30:01.4638023
```

Первый запуск примера приложения показывает, что с одним узлом в пуле и с одной задачей на узел (настройка по умолчанию) на выполнение задания потребовалось более 30 минут.

```
Nodes: 1
Node size: large
Task slots per node: 4
Max slots per task: 1
Tasks: 32
Duration: 00:08:48.2423500
```

Второй запуск примера показывает значительное уменьшение времени выполнения задания. Это вызвано тем, что пул был настроен с четырьмя задачами на узел, что позволяет параллельно выполнять задачи для выполнения задания примерно за четверть исходного времени.

> [!NOTE]
> В приведенных выше сводках длительность выполнения задания не включает время создания пула. Каждое из заданий в примерах выше отправлялось в уже созданные пулы, вычислительные узлы которых на момент отправки находились в состоянии *простоя* .
>
>

## <a name="next-steps"></a>Дальнейшие действия
### <a name="batch-explorer-heat-map"></a>Тепловая карта обозревателя пакетной службы
[Batch Explorer][batch_labs] — это бесплатный автономный клиентский инструмент с множеством функций для создания, отладки и мониторинга приложений пакетной службы Azure. Batch Explorer содержит компонент *тепловой карты*, который предоставляет визуализацию выполнения задач. Используйте этот компонент при выполнении примера приложения [ParallelTasks][parallel_tasks_sample], чтобы наглядно представить параллельное выполнение задач на каждом узле.


[api_net]: /dotnet/api/microsoft.azure.batch
[api_rest]: /rest/api/batchservice/
[batch_labs]: https://azure.github.io/BatchExplorer/
[cloudpool]: /dotnet/api/microsoft.azure.batch.cloudpool
[enable_autoscaling]: /rest/api/batchservice/pool/enableautoscale
[fill_type]: /dotnet/api/microsoft.azure.batch.common.computenodefilltype
[github_samples]: https://github.com/Azure/azure-batch-samples
[maxtasks_net]: /dotnet/api/microsoft.azure.batch.cloudpool
[rest_addpool]: /rest/api/batchservice/pool/add
[parallel_tasks_sample]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/ParallelTasks
[poolcreate_net]: /dotnet/api/microsoft.azure.batch.pooloperations
[task_schedule]: /dotnet/api/microsoft.azure.batch.cloudpool
[taskslots_net]: /dotnet/api/microsoft.azure.batch.cloudtask.requiredslots
