---
title: Создание пользовательского пула с помощью коллекции общих образов
description: Создайте пул пакетной службы с помощью коллекции общих образов для подготовки пользовательских образов к вычисленным узлам, содержащим программное обеспечение и данные, необходимые для вашего приложения. Пользовательские образы представляют собой эффективный способ настройки вычислительных узлов для выполнения рабочих нагрузок пакетной службы.
ms.topic: article
ms.date: 08/28/2019
ms.openlocfilehash: 45f721dbdf11e0a6f58da71c644acf687dfadd49
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82116525"
---
# <a name="use-the-shared-image-gallery-to-create-a-custom-pool"></a>Создание пользовательского пула с помощью коллекции общих образов

При создании пула в пакетной службе Azure с помощью конфигурации виртуальной машины необходимо указать образ виртуальной машины, предоставляющий операционную систему, для каждого вычислительного узла в пуле. Пул виртуальных машин можно создать с помощью поддерживаемого образа Azure Marketplace или создать пользовательский образ с помощью [общей коллекции образов](../virtual-machines/windows/shared-image-galleries.md).

## <a name="benefits-of-the-shared-image-gallery"></a>Преимущества коллекции общих образов

При использовании коллекции общих образов для пользовательского образа вы можете управлять типом и конфигурацией операционной системы, а также типами дисков данных. Общий образ может включать приложения и справочные данные, которые становятся доступными на всех узлах пула пакетной службы сразу после их подготовки.

Можно также иметь несколько версий образа, необходимых для вашей среды. При использовании версии образа для создания виртуальной машины используется версия образа для создания новых дисков для виртуальной машины.

Использование общего образа экономит время при подготовке расчетных узлов пула для выполнения рабочей нагрузки пакетной службы. После подготовки можно использовать образ Azure Marketplace и установить программное обеспечение на каждом из них, но использование общего образа, как правило, более эффективно. Кроме того, можно указать несколько реплик для общего образа, поэтому при создании пулов с несколькими виртуальными машинами (более 600 виртуальных машин) вы сэкономите время на создание пула.

Использование общего образа, настроенного для вашего сценария, может предоставить несколько преимуществ.

* **Используйте одни и те же изображения в разных регионах.** Вы можете создавать реплики общих образов в разных регионах, чтобы все пулы использовали один и тот же образ.
* **Настройка операционной системы (ОС).** Можно настроить конфигурацию диска операционной системы образа.
* **Предварительная установка приложений.** Предварительная установка приложений на диске операционной системы является более эффективной и менее подверженной ошибкам, чем установка приложений после подготовки вычислений для узлов с задачей запуска.
* **Копирование больших объемов данных один раз.** Сделайте часть статических данных управляемого общего образа, скопировав ее на диски данных управляемого образа. Это необходимо сделать только один раз, и данные станут доступными в каждом узле пула.
* **Расширяйте пулы до большего размера.** С помощью коллекции общих образов можно создавать более крупные пулы с настроенными образами вместе с другими репликами общих образов.
* **Повышенная производительность, чем пользовательский образ.** Используя общие образы, время, необходимое пулу для достижения стабильного состояния, будет быстрее на 25%, а задержка простоя виртуальной машины составляет 30%.
* **Управление версиями и группирование изображений для упрощения управления.** Определение группирования изображений содержит сведения о том, почему было создано изображение, какую операционную систему он использует, а также сведения об использовании образа. Группирование изображений позволяет упростить управление образами. Дополнительные сведения см. в разделе [определения изображений](../virtual-machines/windows/shared-image-galleries.md#image-definitions).

## <a name="prerequisites"></a>Предварительные условия

> [!NOTE]
> Необходимо пройти проверку подлинности с помощью Azure AD. Если вы используете Shared-Key-AUTH, вы получите ошибку проверки подлинности.  

* **Учетная запись пакетной службы Azure.** Чтобы создать учетную запись пакетной службы, ознакомьтесь с краткими руководствами по пакетной службе, используя [портал Azure](quick-create-portal.md) или [Azure CLI](quick-create-cli.md).

* **Образ общей коллекции образов**. Для создания общего образа необходимо иметь или создать ресурс управляемого образа. Образ должен быть создан на основе моментального снимка дисков ОС виртуальной машины и при необходимости ее подключенных дисков данных. Дополнительные сведения см. [в разделе Подготовка управляемого образа](#prepare-a-managed-image).

> [!NOTE]
> Общий образ должен находиться в той же подписке, что и учетная запись пакетной службы. Общий образ может находиться в разных регионах, если у него есть реплики в том же регионе, что и учетная запись пакетной службы.

## <a name="prepare-a-managed-image"></a>Подготовка управляемого образа

В Azure можно подготовить управляемый образ из:

* Моментальные снимки ОС и дисков данных виртуальной машины Azure
* Обобщенная виртуальная машина Azure с управляемыми дисками
* Обобщенный локальный виртуальный жесткий диск, отправленный в облако

Чтобы пулы пакетной службы на основе пользовательского образа масштабировались надежно, рекомендуется создавать управляемый образ *только* с помощью первого метода с использованием моментальных снимков дисков виртуальной машины. Ниже приведены действия по подготовке виртуальной машины, созданию моментального снимка и созданию образа на основе моментального снимка.

### <a name="prepare-a-vm"></a>Подготовка виртуальной машины

Если вы создаете новую виртуальную машину для образа, используйте образ Azure Marketplace первого производителя, поддерживаемый пакетом в качестве базового образа управляемого образа. В качестве базового образа можно использовать только образы первого производителя. Полный список ссылок на образы Azure Marketplace, поддерживаемых пакетной службой Azure, см. в разделе операция [SKU агента узла списка](/java/api/com.microsoft.azure.batch.protocol.accounts.listnodeagentskus) .

> [!NOTE]
> В качестве базового образа нельзя использовать образы сторонних производителей, для которых предусматриваются дополнительные условия покупки и лицензия. Сведения об образах из Marketplace, см. в руководствах по виртуальным машинам [Linux](../virtual-machines/linux/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
) или [Windows](../virtual-machines/windows/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
).

* Убедитесь, что виртуальная машина создана с управляемым диском. Это параметр хранилища по умолчанию при создании виртуальной машины.
* На виртуальной машине не следует устанавливать расширения Azure, например расширение пользовательских скриптов. Если образ содержит предварительно установленное расширение, в Azure могут возникнуть проблемы при развертывании пула пакетной службы.
* При использовании подключенных дисков данных необходимо подключить и отформатировать диски в виртуальной машине, чтобы использовать их.
* Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
* После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные.  

### <a name="create-a-vm-snapshot"></a>Создание моментального снимка виртуальной машины

Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Чтобы создать моментальный снимок дисков ОС или дисков данных виртуальной машины, можно использовать портал Azure или средства командной строки. Описание действий и параметров, используемых для создания моментального снимка, см. в руководстве по виртуальным машинам [Linux](../virtual-machines/linux/snapshot-copy-managed-disk.md) или [Windows](../virtual-machines/windows/snapshot-copy-managed-disk.md).

### <a name="create-an-image-from-one-or-more-snapshots"></a>Создание образа на основе одного или нескольких моментальных снимков

Чтобы создать управляемый образ на основе моментального снимка, используйте средства командной строки Azure, такие как команда [az image create](/cli/azure/image). Создайте образ, указав моментальный снимок диска ОС и при необходимости один или несколько моментальных снимков диска данных.

### <a name="create-a-shared-image-gallery"></a>Создание Общей коллекции образов.

После успешного создания управляемого образа необходимо создать коллекцию общих образов, чтобы сделать пользовательский образ доступным. Сведения о создании коллекции общих образов для изображений см. в статье [Создание коллекции общих образов с Azure CLI](../virtual-machines/linux/shared-images.md) или [Создание общей коллекции образов с помощью портал Azure](../virtual-machines/linux/shared-images-portal.md).

## <a name="create-a-pool-from-a-shared-image-using-the-azure-cli"></a>Создание пула из общего образа с помощью Azure CLI

Чтобы создать пул из общего образа с помощью Azure CLI, используйте `az batch pool create` команду. Укажите идентификатор общего образа в `--image` поле. Убедитесь, что тип ОС и номер SKU соответствуют версиям, указанным в параметре`--node-agent-sku-id`

> [!NOTE]
> Необходимо пройти проверку подлинности с помощью Azure AD. Если вы используете Shared-Key-AUTH, вы получите ошибку проверки подлинности.  

```azurecli
az batch pool create \
    --id mypool --vm-size Standard_A1_v2 \
    --target-dedicated-nodes 2 \
    --image "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/galleries/{gallery name}/images/{image definition name}/versions/{version id}" \
    --node-agent-sku-id "batch.node.ubuntu 16.04"
```

## <a name="create-a-pool-from-a-shared-image-using-c"></a>Создание пула из общего образа с помощью C #

Кроме того, можно создать пул из общего образа с помощью пакета SDK для C#.

```csharp
private static VirtualMachineConfiguration CreateVirtualMachineConfiguration(ImageReference imageReference)
{
    return new VirtualMachineConfiguration(
        imageReference: imageReference,
        nodeAgentSkuId: "batch.node.windows amd64");
}

private static ImageReference CreateImageReference()
{
    return new ImageReference(
        virtualMachineImageId: "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/galleries/{gallery name}/images/{image definition name}/versions/{version id}");
}

private static void CreateBatchPool(BatchClient batchClient, VirtualMachineConfiguration vmConfiguration)
{
    try
    {
        CloudPool pool = batchClient.PoolOperations.CreatePool(
            poolId: PoolId,
            targetDedicatedComputeNodes: PoolNodeCount,
            virtualMachineSize: PoolVMSize,
            virtualMachineConfiguration: vmConfiguration);

        pool.Commit();
    }
    ...
}
```

## <a name="create-a-pool-from-a-shared-image-using-the-azure-portal"></a>Создание пула из общего образа с помощью портал Azure

Чтобы создать пул из общего образа в портал Azure, выполните следующие действия.

1. Откройте [портал Azure](https://portal.azure.com).
1. Перейдите в раздел **учетные записи пакетной** службы и выберите свою учетную запись.
1. Выберите **Пулы** , а затем — **Добавить** , чтобы создать новый пул.
1. В разделе **тип образа** выберите **Коллекция общих образов**.
1. Выполните остальные разделы со сведениями об управляемом образе.
1. Нажмите кнопку **OK**.

![Создайте пул из общего образа с помощью портала.](media/batch-sig-images/create-custom-pool.png)

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями или тысячами виртуальных машин или более с помощью общего образа, используйте следующие рекомендации.

* **Номера реплик коллекции общих образов.**  Для каждого пула, имеющего до 600 экземпляров, рекомендуется разместить по крайней мере одну реплику. Например, при создании пула с 3000 виртуальными машинами необходимо иметь по крайней мере 5 реплик образа. Мы всегда рекомендуем хранить больше реплик, чем минимальные требования для повышения производительности.

* **Время ожидания изменения размера.** Если в пуле содержится фиксированное число узлов (если он не выполняет Автомасштабирование), увеличьте `resizeTimeout` свойство пула в зависимости от размера пула. Для каждых 1000 виртуальных машин рекомендуемое время ожидания изменения размера составляет не менее 15 минут. Например, рекомендуемое время ожидания изменения размера для пула с 2000 виртуальными машинами составляет не менее 30 минут.

## <a name="next-steps"></a>Дальнейшие шаги

* Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
