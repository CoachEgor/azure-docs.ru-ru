---
title: Используйте общую галерею изображений для создания пользовательского пула - Azure Batch Документы Майкрософт
description: Создайте пул пакетов с общей галереей изображений для предоставления пользовательских изображений для вычисления узлов, содержащих программное обеспечение и данные, необходимые для приложения. Пользовательские образы представляют собой эффективный способ настройки вычислительных узлов для выполнения рабочих нагрузок пакетной службы.
services: batch
author: LauraBrenner
manager: evansma
ms.service: batch
ms.topic: article
ms.date: 08/28/2019
ms.author: labrenne
ms.openlocfilehash: 95f27d913cd288c186bae1a6375212b072f50bb4
ms.sourcegitcommit: 7581df526837b1484de136cf6ae1560c21bf7e73
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2020
ms.locfileid: "80422440"
---
# <a name="use-the-shared-image-gallery-to-create-a-custom-pool"></a>Используйте общую галерею изображений для создания пользовательского пула

При создании пула в пакетной службе Azure с помощью конфигурации виртуальной машины необходимо указать образ виртуальной машины, предоставляющий операционную систему, для каждого вычислительного узла в пуле. Вы можете создать пул виртуальных машин либо с поддерживаемым изображением Azure Marketplace, либо создать пользовательское изображение с [общей галереей изображений.](../virtual-machines/windows/shared-image-galleries.md)

## <a name="benefits-of-the-shared-image-gallery"></a>Преимущества общей фотогалерее

При использовании общей галереи изображений для пользовательского изображения у вас есть контроль над типом и конфигурацией операционной системы, а также типом дисков данных. Ваше общее изображение может включать приложения и справочные данные, которые становятся доступными на всех узлах пула пакетов, как только они будут подготовлены.

Вы также можете иметь несколько версий изображения по мере необходимости для вашей среды. При использовании версии изображения для создания VM версия изображения используется для создания новых дисков для VM.

Использование общего изображения экономит время при подготовке вычислительных узлов пула для выполнения рабочей нагрузки пакета. Можно использовать изображение Azure Marketplace и устанавливать программное обеспечение на каждом вычислительном узле после подготовки, но использование общего изображения, как правило, более эффективно. Кроме того, можно указать несколько реплик для общего изображения, поэтому при создании пулов с большим количеством вм-случаев (более 600 вм) вы сэкономите время на создание пула.

Использование совместного изображения, настроенного для сценария, может обеспечить несколько преимуществ:

* **Используйте одни и те же изображения в регионах.** Можно создавать реплики общих изображений в разных регионах, чтобы все пулы использовали одно и то же изображение.
* **Настройка операционной системы (ОС).** Можно настроить конфигурацию диска операционной системы образа.
* **Предварительная установка приложений.** Предварительная установка приложений на диске ОС является более эффективной и менее подверженной ошибкам, чем установка приложений после подготовки вычислительных узлов с задачей запуска.
* **Копирование больших объемов данных один раз.** Сделайте статические данные частью управляемого общего изображения, скопируя их на диски данных управляемого изображения. Это необходимо сделать только один раз, и данные станут доступными в каждом узле пула.
* **Выращивайте бассейны до больших размеров.** С помощью общей галереи изображений можно создавать большие пулы с настраиваемыми изображениями вместе с большим количеством копий общих изображений.
* **Более высокую производительность, чем пользовательское изображение.** Используя общие изображения, время, необходимое пулу для достижения стабильного состояния, на 25% быстрее, а задержка в холостом ходу VM на 30% короче.
* **Версия изображений и группировка для облегчения управления.** Определение группирования изображений содержит информацию о том, почему изображение было создано, для чего оно предназначено для ОС, и информацию об использовании изображения. Группировка изображений позволяет упростить управление изображениями. Для получения дополнительной [информации см.](../virtual-machines/windows/shared-image-galleries.md#image-definitions)

## <a name="prerequisites"></a>Предварительные требования

> [!NOTE]
> Необходимо проверить подлинность с помощью Azure AD. Если вы используете общий ключ-auth, вы получите ошибку аутентификации.  

* **Учетная запись пакетной службы Azure.** Для создания учетной записи пакета смотрите быстрые запуски пакета с помощью [портала Azure](quick-create-portal.md) или [Azure CLI.](quick-create-cli.md)

* **Изображение галереи общего изображения**. Для создания общего изображения необходимо иметь или создавать управляемый ресурс изображения. Образ должен быть создан на основе моментального снимка дисков ОС виртуальной машины и при необходимости ее подключенных дисков данных. Для получения дополнительной информации [см.](#prepare-a-managed-image)

> [!NOTE]
> Ваше общее изображение должно быть в той же подписке, что и учетная запись Пакета. Общее изображение может находиться в разных регионах до тех пор, пока оно имеет реплики в том же регионе, что и учетная запись Пакета.

## <a name="prepare-a-managed-image"></a>Подготовка управляемого изображения

В Azure можно подготовить управляемое изображение из:

* Снимки ОС ИТ-и дисков данных Azure VM
* Обобщенный Azure VM с управляемыми дисками
* Обобщенный предприимчатенный VHD, загруженный в облако

Чтобы пулы пакетной службы на основе пользовательского образа масштабировались надежно, рекомендуется создавать управляемый образ *только* с помощью первого метода с использованием моментальных снимков дисков виртуальной машины. Ниже приведены действия по подготовке виртуальной машины, созданию моментального снимка и созданию образа на основе моментального снимка.

### <a name="prepare-a-vm"></a>Подготовка виртуальной машины

Если вы создаете новый VM для изображения, используйте изображение Azure Marketplace первой стороны, поддерживаемое Пакетом, в качестве базового изображения для управляемого изображения. Только изображения первой партии могут быть использованы в качестве базового изображения. Чтобы получить полный список ссылок на изображения Azure [List node agent SKUs](/java/api/com.microsoft.azure.batch.protocol.accounts.listnodeagentskus) Marketplace, поддерживаемых Azure Batch, см.

> [!NOTE]
> В качестве базового образа нельзя использовать образы сторонних производителей, для которых предусматриваются дополнительные условия покупки и лицензия. Сведения об образах из Marketplace, см. в руководствах по виртуальным машинам [Linux](../virtual-machines/linux/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
) или [Windows](../virtual-machines/windows/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
).

* Убедитесь, что VM создается с управляемым диском. Это параметр хранилища по умолчанию при создании виртуальной машины.
* На виртуальной машине не следует устанавливать расширения Azure, например расширение пользовательских скриптов. Если образ содержит предварительно установленное расширение, в Azure могут возникнуть проблемы при развертывании пула пакетной службы.
* При использовании прикрепленных дисков данных необходимо монтировать и форматировать диски из впределах VM, чтобы использовать их.
* Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
* После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные.  

### <a name="create-a-vm-snapshot"></a>Создание моментального снимка виртуальной машины

Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Чтобы создать моментальный снимок дисков ОС или дисков данных виртуальной машины, можно использовать портал Azure или средства командной строки. Описание действий и параметров, используемых для создания моментального снимка, см. в руководстве по виртуальным машинам [Linux](../virtual-machines/linux/snapshot-copy-managed-disk.md) или [Windows](../virtual-machines/windows/snapshot-copy-managed-disk.md).

### <a name="create-an-image-from-one-or-more-snapshots"></a>Создание образа на основе одного или нескольких моментальных снимков

Чтобы создать управляемый образ на основе моментального снимка, используйте средства командной строки Azure, такие как команда [az image create](/cli/azure/image). Создайте изображение, указав снимок диска ОС и опционально один или несколько снимков диска данных.

### <a name="create-a-shared-image-gallery"></a>Создание Общей коллекции образов.

После того как вы успешно создали управляемое изображение, вам нужно создать общую галерею изображений, чтобы сделать пользовательское изображение доступным. Чтобы узнать, как создать общую галерею изображений для изображений, [Create a Shared Image Gallery using the Azure portal](../virtual-machines/linux/shared-images-portal.md) [см.](../virtual-machines/linux/shared-images.md)

## <a name="create-a-pool-from-a-shared-image-using-the-azure-cli"></a>Создание пула из общего изображения с помощью Azure CLI

Чтобы создать пул из совместного изображения с помощью `az batch pool create` Azure CLI, используйте команду. Укажите общий идентификатор изображения в `--image` поле. Убедитесь, что тип ОС и SKU соответствуют версиям, указанным`--node-agent-sku-id`

> [!NOTE]
> Необходимо проверить подлинность с помощью Azure AD. Если вы используете общий ключ-auth, вы получите ошибку аутентификации.  

```azurecli
az batch pool create \
    --id mypool --vm-size Standard_A1_v2 \
    --target-dedicated-nodes 2 \
    --image "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/galleries/{gallery name}/images/{image definition name}/versions/{version id}" \
    --node-agent-sku-id "batch.node.ubuntu 16.04"
```

## <a name="create-a-pool-from-a-shared-image-using-c"></a>Создание пула из общего изображения с помощью C #

Кроме того, можно создать пул из общего изображения с помощью SDK.

```csharp
private static VirtualMachineConfiguration CreateVirtualMachineConfiguration(ImageReference imageReference)
{
    return new VirtualMachineConfiguration(
        imageReference: imageReference,
        nodeAgentSkuId: "batch.node.windows amd64");
}

private static ImageReference CreateImageReference()
{
    return new ImageReference(
        virtualMachineImageId: "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/galleries/{gallery name}/images/{image definition name}/versions/{version id}");
}

private static void CreateBatchPool(BatchClient batchClient, VirtualMachineConfiguration vmConfiguration)
{
    try
    {
        CloudPool pool = batchClient.PoolOperations.CreatePool(
            poolId: PoolId,
            targetDedicatedComputeNodes: PoolNodeCount,
            virtualMachineSize: PoolVMSize,
            virtualMachineConfiguration: vmConfiguration);

        pool.Commit();
    }
    ...
}
```

## <a name="create-a-pool-from-a-shared-image-using-the-azure-portal"></a>Создание пула из общего изображения с помощью портала Azure

Используйте следующие шаги для создания пула из общего изображения на портале Azure.

1. Откройте [портал Azure](https://portal.azure.com).
1. Перейдите к **учетным записям Пакет** и выберите свою учетную запись.
1. Выберите **пулы,** а затем **добавьте,** чтобы создать новый пул.
1. В разделе **Тип изображения** выберите **Галерею общих изображений.**
1. Заполните оставшиеся разделы информацией о управляемом изображении.
1. Щелкните **ОК**.

![Создайте пул с общим изображением с порталом.](media/batch-sig-images/create-custom-pool.png)

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями или тысячами вммигов или более с помощью общего изображения, используйте следующее руководство.

* **Общие номера реплик иреплика галереи изображений.**  Для каждого пула с до 600 экземпляров, мы рекомендуем вам сохранить по крайней мере одну реплику. Например, если вы создаете пул с 3000 вм: вы должны сохранить по крайней мере 5 копий изображения. Мы всегда предлагаем сохранить больше реплик, чем минимальные требования для повышения производительности.

* **Повторное времяотизм.** Если пул содержит фиксированное количество узлов (если он не автомасштабируется), увеличьте `resizeTimeout` свойство пула в зависимости от размера пула. Для каждых 1000 ВМ рекомендуемый тайм-аут в размере не менее 15 минут. Например, рекомендуемый тайм-аут повторного размера для пула с 2000 ВМ составляет не менее 30 минут.

## <a name="next-steps"></a>Следующие шаги

* Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
