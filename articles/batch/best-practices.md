---
title: Лучшие практики - Azure Batch
description: Узнайте о рекомендациях и полезных советах по разработке решения Azure Batch.
author: LauraBrenner
ms.author: labrenne
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: evansma
ms.openlocfilehash: ea5cd8012324cc0727a46308f4d5621f2ce40727
ms.sourcegitcommit: 632e7ed5449f85ca502ad216be8ec5dd7cd093cb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2020
ms.locfileid: "80397924"
---
# <a name="azure-batch-best-practices"></a>Лучшие практики Azure Batch

В этой статье обсуждается набор рекомендаций по эффективному и эффективному использованию сервиса Azure Batch. Эти рекомендации основаны на нашем опыте работы с Batch и опыте клиентов Batch. Важно понимать эту статью, чтобы избежать ошибок в проектировании, потенциальных проблем с производительностью и антишаблонов при разработке и использовании пакета.

Из этой статьи вы узнаете следующее.

> [!div class="checklist"]
> - Каковы наилучшие практики
> - Почему следует использовать лучшие практики
> - Что может произойти, если вы не будете следовать лучшим практикам
> - Как следовать лучшим практикам

## <a name="pools"></a>Пулы

Пакетные пулы являются вычислительными ресурсами для выполнения заданий в службе пакета. В следующих разделах содержатся рекомендации по лучшим рекомендациям при работе с пулами пакетов.

### <a name="pool-configuration-and-naming"></a>Конфигурация пула и именование

- **Режим распределения пула**  
    При создании учетной записи Batch можно выбрать между двумя режимами распределения пула: **служба пакетов** или **подписка пользователя.** В большинстве случаев следует использовать режим обслуживания пакетов по умолчанию, в котором пулы распределяются за кулисами в подписках, управляемых пакетами. В альтернативном режиме "Пользовательская подписка" виртуальные машины пакетной службы и другие ресурсы создаются непосредственно в подписке пользователя при создании пула. Учетные записи подписки пользователей в основном используются для включения важного, но небольшого подмноза сценариев. Вы можете прочитать больше о режиме подписки пользователя в [дополнительной конфигурации для режима подписки пользователя.](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)

- **Рассмотрим время выполнения задания и задачи при определении задания для объединения картографических карт.**  
    Если у вас есть задания, состоящие в основном из неработающих задач, и ожидаемые общие подсчеты задач невелики, так что общее ожидаемое время выполнения задания не является длительным, не выделяйте новый пул для каждого задания. Время выделения узлов уменьшит время выполнения задания.

- **Бассейны должны иметь более одного вычислительного узла.**  
    Индивидуальные узлы не всегда будут доступны. В то время как редкость, аппаратные сбои, обновления операционной системы, и множество других проблем может привести к отдельным узлам, чтобы быть в автономном режиме. Если рабочая нагрузка пакета требует детерминированного, гарантированного прогресса, следует выделить пулы с несколькими узлами.

- **Не используйте имена ресурсов повторно.**  
    Ресурсы пакетов (рабочие места, пулы и т.д.) часто приходят и уходят с течением времени. Например, в понедельник можно создать пул, удалить его во вторник, а затем создать другой пул в четверг. Каждому новому ресурсу, который вы создаете, должно быть дано уникальное имя, которое вы не использовали раньше. Это можно сделать с помощью GUID (как имя всего ресурса, либо как его часть) или встраивая время создания ресурса в имя ресурса. Пакет поддерживает [DisplayName](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet), который может быть использован, чтобы дать ресурсу человеческое читаемое имя, даже если фактический идентификатор ресурса является то, что не является, что человек дружественных. Использование уникальных имен упрощает для вас дифференцировать, какой именно ресурс сделал что-то в журналах и метриках. Он также удаляет двусмысленность, если вам когда-либо придется подать заявление о поддержке ресурса.

- **Непрерывность во время обслуживания и отказа бассейна.**  
    Лучше всего, чтобы ваши рабочие места использовать бассейны динамично. Если ваши рабочие места используют тот же пул для всего, есть шанс, что ваши рабочие места не будут работать, если что-то пойдет не так с бассейном. Это особенно важно для рабочих нагрузок, учитывая время. Чтобы исправить это, выберите или создайте пул динамически, когда вы запланируете каждое задание, или у вас есть способ переопределить имя пула, чтобы можно было обойти неработоспособный пул.

- **Непрерывность бизнеса во время обслуживания и сбоя в бассейне**  
    Существует множество возможных причин, которые могут помешать пулу вырасти до требуемого размера, таких как внутренние ошибки, ограничения емкости и т.д. По этой причине вы должны быть готовы перенацелить задания в другом пуле (возможно, с другим размером VM - Batch поддерживает это через [UpdateJob),](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet)если это необходимо. Избегайте использования статического идентификатора пула в надежде, что он никогда не будет удален и никогда не изменится.

### <a name="pool-lifetime-and-billing"></a>Срок службы пула и выставление счетов

Срок службы пула может варьироваться в зависимости от способа распределения и параметров, применяемых к конфигурации пула. Бассейны могут иметь произвол произвольного произвола и различное количество вычислительных узлов в пуле в любой момент времени. Вы несете ответственность за управление вычислительными узлами в пуле либо явно, либо через функции, предоставляемые службой (автомасштаб или автопул).

- **Держите бассейны свежими.**  
    Каждые несколько месяцев необходимо изменять размер пулов до нуля, чтобы получить последние обновления агента узлов и исправление ошибок. Пул не будет получать обновления агента узлов, если он не будет воссоздан или не будет переодена до 0 вычислительных узлов. Перед воссозданием или переразмерным размером пула рекомендуется загрузить журналы любых узлового агента для отладки, как это обсуждается в разделе [Узлы.](#nodes)

- **Воссоздание пула**  
    На аналогичной ноте не рекомендуется ежедневно удалять и создавать пулы. Вместо этого создайте новый пул, обновите существующие рабочие места, чтобы указать на новый пул. После того, как все задачи были перемещены в новый пул, затем удалите старый пул.

- **Эффективность пула и выставление счетов**  
    Сам пакет не несет никаких дополнительных расходов, но вы берете плату за используемые вычислительные ресурсы. Выставляете счет за каждый вычислительный узла в пуле, независимо от состояния, в который он велен. Это включает в себя любые расходы, необходимые для запуска узла, такие как затраты на хранение и сетевые сети. Чтобы узнать больше [Cost analysis and budgets for Azure Batch](budget.md)рекомендаций, см.

### <a name="pool-allocation-failures"></a>Сбои распределения пула

Сбои распределения пула могут произойти в любой момент во время первого распределения или последующего повторного размера. Это может быть связано с временным истощением емкости в регионе или сбоями в других службах Azure, на которые опирается Пакет. Ваша основная квота не является гарантией, а скорее пределом.

### <a name="unplanned-downtime"></a>Внеплановый простой

Пулы пакетов могут испытывать события простоя в Azure. Это важно иметь в виду при планировании и разработке сценария или рабочего процесса для Batch.

В случае сбоя узла Пакет автоматически пытается восстановить эти вычислительные узлы от вашего имени. Это может вызвать перенос любой задачи выполнения на восстановленном узлах. [См. Проектирование для повторов,](#designing-for-retries-and-re-execution) чтобы узнать больше о прерванных задачах.

- **Зависимость региона Лазурного региона**  
    Рекомендуется не зависеть от одного региона Azure, если у вас есть рабочая нагрузка, учитывая время или рабочую нагрузку. Хотя это редко, Есть вопросы, которые могут повлиять на весь регион. Например, если ваша обработка должна начаться в определенное время, подумайте о масштабировании пула в основной области *задолго до начала работы.* При сбой этой шкалы пула можно вернуться к масштабированию пула в области резервного копирования (или регионов). Пулы в нескольких учетных записях в разных регионах обеспечивают готовую, легко доступную резервную линию, если что-то пойдет не так с другим пулом. Для получения дополнительной [информации](high-availability-disaster-recovery.md)см.

## <a name="jobs"></a>Задания

Задание — это контейнер, предназначенный для хранения сотен, тысяч или даже миллионов задач.

- **Поставьте много задач на задание**  
    Использование задания для выполнения одной задачи является неэффективным. Например, более эффективно использовать одно задание, содержащее 1000 заданий, вместо создания 100 заданий, содержащих по 10 заданий. Запуск 1000 заданий, каждая из которых имеет одну задачу, будет наименее эффективным, медленным и самым дорогим подходом.  

    Не разрабатывайте решение Batch, которое требует одновременно тысяч активных заданий. Нет квоты для задач, поэтому выполнение как можно больше заданий под как можно меньшим числом заданий эффективно использует квоты на [работу и график работы.](batch-quota-limit.md#resource-quotas)

- **Срок службы**  
    Задание пакета имеет бессрочный срок службы до тех пор, пока оно не будет удалено из системы. Состояние задания определяет, может ли оно принимать больше задач для планирования или нет. Задание не переходит автоматически в завершенное состояние, если явно не будет завершено. Это может быть автоматически срабатывает через [свойство onAllTasksComplete](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet) или [maxWallClockTime.](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints)

Существует по умолчанию [активная квота задания и графика работы.](batch-quota-limit.md#resource-quotas) Вакансии и графики заданий в заполненном состоянии не учитываются в этой квоте.

## <a name="tasks"></a>Задания

Задачи представляют собой отдельные единицы работы, которые составляют задание. Задачи передаются пользователем и запланировалися Пакетом на вычисление узлов. Есть несколько соображений дизайна, чтобы при создании и выполнении задач. В следующих разделах объясняются общие сценарии и способы проектирования задач для решения проблем и эффективного выполнения задач.

- **Сохранение данных о задачах как части задачи.**  
    Вычислительные узлы по своей природе эфемерны. Есть много функций в пакете, таких как автопул и автомасштаб, которые делают его легким для узлов исчезают. Когда узлы покидают пул (из-за повторного размера или удаления пула) все файлы на этих узлах также удаляются. Из-за этого рекомендуется, прежде чем задача завершится, она перемещает свой выход от узла, который он работает на и в прочный магазин, аналогичным образом, если задача не удается она должна переместить журналы, необходимые для диагностики отказа в прочный магазин. Пакет интегрировал поддержку Azure Storage для загрузки данных через [OutputFiles,](batch-task-output-files.md)а также различные общие файловые системы, или вы можете выполнять загрузку самостоятельно в своих задачах.

### <a name="task-lifetime"></a>Срок действия задачи

- **Удаление задач, когда они будут завершены.**  
    Удалите задачи, когда они больше не нужны, или установите ограничение задачи [удержания.](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet) При `retentionTime` установке пакет автоматически очищает дисковое пространство, используемое `retentionTime` задачей по истечении срока действия.  

    Удалять задачи выполняет две вещи. Это гарантирует, что у вас нет наращивания задач в задании, что делает запрос / поиск задачи, которую вы заинтересованы в труднее (потому что вам придется фильтровать через завершенные задачи). Он также очищает соответствующие данные о задаче на узел (при условии, `retentionTime` еще не был поражен). Это гарантирует, что ваши узлы не заполнятся данными о задачах и не будут работать в нерабочее время.

### <a name="task-submission"></a>Представление задачи

- **Отправить большое количество задач в коллекции.**  
    Задачи могут быть представлены на индивидуальной основе или в коллекциях. Отправка задач в [коллекциях](https://docs.microsoft.com/rest/api/batchservice/task/addcollection) до 100 в то время, когда выполнение массового представления задач для сокращения накладных расходов и время представления.

### <a name="task-execution"></a>Выполнение задач

- **Выбор максимальных задач на узла**  
    Пакет поддерживает переподписку задач на узлах (выполнение большего количества задач, чем у зла к ядрам). Это до вас, чтобы убедиться, что ваши задачи "вписываются" в узлы в бассейне. Например, при попытке запланировать восемь задач, каждая из которых потребляет 25% использования процессора на `maxTasksPerNode = 8`одном узло (в пуле с) может иметь ухудшиве впечатление.

### <a name="designing-for-retries-and-re-execution"></a>Проектирование для повторов и повторного исполнения

Задачи могут быть автоматически повторены Пакетом. Существует два типа повторов: управляемый пользователем и внутренний. Ретриты, контролируемые пользователем, определяются [maxTaskRetryCount](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet)задачи. Когда программа, указанная в задаче, выходит с ненулевым кодом выхода, `maxTaskRetryCount`задача переоценивается до значения .

Хотя задача редка, может быть повторена внутренне из-за сбоев на вычислительном узеле, таких как неспособность обновить внутреннее состояние или сбой в узеле во время выполнения задачи. Задача будет повторена на том же вычислительном узлах, если это возможно, до внутреннего предела, прежде чем отказаться от задачи и отложить задачу, которая будет перенесена пакетом, потенциально на другом вычислительном узлах.

- **Создание прочных задач**  
    Задачи должны быть разработаны, чтобы выдержать неудачу и разместить повторную попытку. Это особенно важно для длительных задач. Для этого убедитесь, что задачи генерируют один и тот же, единый результат, даже если они выполняются более одного раза. Один из способов достижения этой цели заключается в том, чтобы сделать ваши задачи "цель поиска". Другой способ заключается в том, чтобы убедиться, что ваши задачи являются идемпотентными (задачи будут иметь тот же результат независимо от того, сколько раз они выполняются).

    Распространенным примером является задача копирования файлов в вычислительный узел. Простой подход — это задача, которая копирует все указанные файлы каждый раз, когда он работает, что является неэффективным и не построено, чтобы выдержать сбой. Вместо этого создайте задачу, чтобы обеспечить наличие файлов на вычислительном узеле; задача, которая не копирует файлы, которые уже присутствуют. Таким образом, задача забирает, где она остановилась, если она была прервана.

- **Узлы с низким приоритетом**  
    При выполнении задач на выделенных или низкоприоритетных узлах нет никаких различий в конструкции. Независимо от того, упредивалась ли задача при работе на низкоприоритетном узах или прерывалась из-за сбоя на выделенном узлах, обе ситуации смягчаются путем проектирования задачи для выдерживания сбоя.

- **Время выполнения задачи**  
    Избегайте задач с коротким временем выполнения. Задачи, которые выполняются только в течение одной-двух секунд, не являются идеальными. Вы должны попытаться сделать значительный объем работы в отдельной задаче (10 второй минимум, подойдя к часам или дням). Если каждая задача выполнения в течение одной минуты (или более), то планирование накладных расходов в качестве доли общего времени вычисления невелика.

## <a name="nodes"></a>Узлы

- **Запуск задач должен быть идемпотент**  
    Как и в других задачах, задача запуска узла должна быть идемпотентной, так как она будет повторяться каждый раз, когда узлы бутсы. Идемпотентная задача — это просто задача, которая дает последовательный результат при выполнении нескольких раз.

- **Управление долгосрочными службами через интерфейс служб операционной системы.**  
    Иногда возникает необходимость запустить другой агент вместе с агентом пакета в уделе, например, для сбора данных из узла и сообщения о нем. Мы рекомендуем развертывать эти агенты в качестве служб ОС, таких как служба Windows или служба Linux. `systemd`  

    При запуске этих служб они не должны принимать блокировки файлов на любых файлах в каталогах, управляемых пакетами, на узеле, потому что в противном случае Batch не сможет удалить эти каталоги из-за блокировок файлов. Например, при установке службы Windows в задаче запуска, вместо запуска службы непосредственно из рабочего каталога задачи запуска, скопируйте файлы в другом месте (если файлы существуют, просто пропустите копию). Установите службу из этого места. Когда пакет повторно выполняет задачу запуска, он удалит рабочий каталог задачи запуска и создаст его снова. Это работает, потому что служба имеет блокировки файлов на другом каталоге, а не в рабочем каталоге задачи запуска.

- **Избегайте создания узлов каталогов в Windows**  
    Каталог соединений, иногда называемый каталог жестких ссылок, трудно иметь дело с во время задачи и очистки работы. Используйте симлинки (мягкие ссылки), а не жесткие ссылки.

- **Сбор журналов агента пакета, если есть проблема**  
    Если вы заметили проблему, связанную с поведением узла или задач, работающих на уделе, рекомендуется собирать журналы агента пакета до того, как будет решенвопрос с указанными узлами. Журналы агентов пакета могут быть собраны с помощью API службы обслуживания Upload Batch. Эти журналы могут быть предоставлены как часть поддержки билет атак в Корпорацию Майкрософт и поможет с проблемой устранения неполадок и разрешения.

## <a name="security"></a>Безопасность

### <a name="security-isolation"></a>Защита путем изоляции

Для целей изоляции, если ваш сценарий требует изоляции рабочих мест друг от друга, то вы должны изолировать эти рабочие места, имея их в отдельных пулах. Пул — это граница изоляции безопасности в пакете, и по умолчанию два пула не видны и не могут общаться друг с другом. Избегайте использования отдельных учетных записей пакета в качестве средства изоляции.

## <a name="moving"></a>Перемещение

### <a name="move-batch-account-across-regions"></a>Перемещение учетной записи пакета в разных регионах 

Существуют различные сценарии, в которых необходимо переместить существующую учетную запись Batch из одного региона в другой. Например, в рамках планирования аварийного восстановления может потребоваться переезд в другой регион.

Учетные записи Azure Batch не могут быть перемещены из одного региона в другой. Однако можно использовать шаблон менеджера ресурсов Azure для экспорта существующей конфигурации учетной записи Пакета.  Затем можно разместить ресурс в другом регионе, экспортируя учетную запись Пакета в шаблон, изменяя параметры в соответствии с регионом назначения, а затем развертывая шаблон в новом регионе. После загрузки шаблона в новый регион вам придется воссоздать сертификаты, графики работы и пакеты приложений. Чтобы зафиксировать изменения и завершить перемещение учетной записи Пакета, не забудьте удалить исходную учетную запись пакета или группу ресурсов.  

Для получения дополнительной информации об [Quickstart: Create and deploy Azure Resource Manager templates by using the Azure portal](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal)управлении ресурсами и шаблонах см.


