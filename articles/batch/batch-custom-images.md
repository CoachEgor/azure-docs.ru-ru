---
title: Предоставление пользовательского пула из управляемого образа в пакетной службе Azure | Документация Майкрософт
description: Создайте пул пакетной службы на основе ресурса управляемого образа, чтобы подготавливать в расчетные узлы с программным обеспечением и данными для вашего приложения.
services: batch
author: LauraBrenner
manager: evansma
ms.service: batch
ms.topic: article
ms.date: 09/16/2019
ms.author: labrenne
ms.openlocfilehash: 1ef6be2ba9364203dceba54ab51325c05dbbbe41
ms.sourcegitcommit: 21e33a0f3fda25c91e7670666c601ae3d422fb9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2020
ms.locfileid: "77020154"
---
# <a name="use-a-managed-image-to-create-a-pool-of-virtual-machines"></a>Использование управляемого образа для создания пула виртуальных машин

Чтобы создать пользовательский образ для виртуальных машин пула пакетной службы, можно использовать [коллекцию общих образов](batch-sig-images.md)или *управляемый ресурс образа* .

> [!TIP]
> В большинстве случаев пользовательские образы следует создавать с помощью общей коллекции образов. С помощью коллекции общих образов можно быстрее подготавливать пулы, масштабировать большие объемы виртуальных машин и повысить надежность при подготовке виртуальных машин. Дополнительные сведения см. в статье [Создание пользовательского пула с помощью коллекции общих образов](batch-sig-images.md).

## <a name="prerequisites"></a>Технические условия

- **Ресурс управляемого образа**. Чтобы создать пул виртуальных машин с помощью пользовательского образа, необходимо иметь или создать ресурс управляемого образа в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы. Образ должен быть создан на основе моментального снимка дисков ОС виртуальной машины и при необходимости ее подключенных дисков данных. Дополнительные сведения и действия по подготовке управляемого образа см. в следующем разделе.
  - Используйте уникальный пользовательский образ для каждого создаваемого пула.
  - Чтобы создать пул на основе образа с помощью API пакетной службы, укажите **идентификатор ресурса** в формате `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`. Чтобы выполнить эту операцию на портале, используйте **имя** образа.  
  - Ресурс управляемого образа должен существовать в течение всего времени существования пула, чтобы обеспечивать возможность масштабирования. Ресурс можно удалить после удаления пула.

- **Проверка подлинности Azure Active Directory (AAD)** . API клиента пакетной службы должен использовать проверку подлинности AAD. Поддержка AAD пакетной службой Azure описана в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).

## <a name="prepare-a-custom-image"></a>Подготовка пользовательского образа

В Azure можно подготовить управляемый образ из:

- Моментальные снимки ОС и дисков данных виртуальной машины Azure
- Обобщенная виртуальная машина Azure с управляемыми дисками
- Обобщенный локальный виртуальный жесткий диск, отправленный в облако

Чтобы пулы пакетной службы на основе пользовательского образа масштабировались надежно, рекомендуется создавать управляемый образ *только* с помощью первого метода с использованием моментальных снимков дисков виртуальной машины. Ниже приведены действия по подготовке виртуальной машины, созданию моментального снимка и созданию образа на основе моментального снимка.

### <a name="prepare-a-vm"></a>Подготовка виртуальной машины

Если вы создаете новую виртуальную машину для образа, используйте образ Azure Marketplace первого производителя, поддерживаемый пакетом в качестве базового образа управляемого образа. В качестве базового образа можно использовать только образы первого производителя. Полный список ссылок на образы Azure Marketplace, поддерживаемых пакетной службой Azure, см. в разделе операция [SKU агента узла списка](/java/api/com.microsoft.azure.batch.protocol.accounts.listnodeagentskus) .

> [!NOTE]
> В качестве базового образа нельзя использовать образы сторонних производителей, для которых предусматриваются дополнительные условия покупки и лицензия. Сведения об образах из Marketplace, см. в руководствах по виртуальным машинам [Linux](../virtual-machines/linux/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
) или [Windows](../virtual-machines/windows/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
).

- Убедитесь, что виртуальная машина создана с управляемым диском. Это параметр хранилища по умолчанию при создании виртуальной машины.
- На виртуальной машине не следует устанавливать расширения Azure, например расширение пользовательских скриптов. Если образ содержит предварительно установленное расширение, в Azure могут возникнуть проблемы при развертывании пула пакетной службы.
- При использовании подключенных дисков данных необходимо подключить и отформатировать диски в виртуальной машине, чтобы использовать их.
- Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
- После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные.  

### <a name="create-a-vm-snapshot"></a>Создание моментального снимка виртуальной машины

Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Чтобы создать моментальный снимок дисков ОС или дисков данных виртуальной машины, можно использовать портал Azure или средства командной строки. Описание действий и параметров, используемых для создания моментального снимка, см. в руководстве по виртуальным машинам [Linux](../virtual-machines/linux/snapshot-copy-managed-disk.md) или [Windows](../virtual-machines/windows/snapshot-copy-managed-disk.md).

### <a name="create-an-image-from-one-or-more-snapshots"></a>Создание образа на основе одного или нескольких моментальных снимков

Чтобы создать управляемый образ на основе моментального снимка, используйте средства командной строки Azure, такие как команда [az image create](/cli/azure/image). Можно создать образ, указав моментальный снимок диска ОС и при необходимости один или несколько моментальных снимков дисков данных.

## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>Создание пула на основе пользовательского образа на портале

Сохранив пользовательский образ и зная его имя или идентификатор ресурса, можно создать пул пакетной службы из этого образа. Ниже показано, как это сделать с помощью портала Azure.

> [!NOTE]
> При создании пула с помощью API пакетной службы убедитесь, что идентификатор, используемый для проверки подлинности AAD, имеет разрешения на ресурс образа. Дополнительные сведения см. в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).
>
> Ресурс для управляемого образа должен существовать в течение времени существования пула. При удалении базового ресурса невозможно масштабировать пул.

1. Войдите в свою учетную запись пакетной службы на портале Azure. Эта учетная запись должна принадлежать к той же подписке и к тому же региону, что и группа ресурсов, содержащая пользовательский образ.
2. В окне **Параметры** слева выберите пункт меню **Пулы**.
3. В окне **Пулы** выберите команду **Добавить**.
4. В окне **Добавить пул** из раскрывающегося списка **Тип образа** выберите **Пользовательский образ (Linux или Windows)** . В раскрывающемся списке **Custom VM image** (Пользовательский образ виртуальной машины) выберите имя образа (краткую форму идентификатора ресурсов).
5. Выберите правильного **издателя, предложение, SKU** для пользовательского образа.
6. Укажите оставшиеся обязательные параметры, включая **размер узла**, **целевые выделенные узлы**и **узлы с низким приоритетом**, а также любые необходимые дополнительные параметры.

    Например, для пользовательского образа Microsoft Windows Server Datacenter 2016 окно **Добавить пул** отображается, как показано ниже:

    ![Добавление пула из пользовательского образа Windows](media/batch-custom-images/add-pool-custom-image.png)
  
Чтобы проверить, основан ли имеющийся пул на пользовательском образе, найдите свойство **Операционная система** в разделе сводки по ресурсу окна **Пул**. Если пул был создан с помощью пользовательского образа, ему будет присвоено значение **Пользовательский образ виртуальной машины**.

Все пользовательские образы, связанные с пулом, отображаются в окне **Свойства** пула.

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями виртуальных машин на основе пользовательского образа, нужно обязательно следовать изложенным выше рекомендациям и использовать образ, созданный на основе моментального снимка виртуальной машины.

Также обратите внимание на следующие моменты.

- **Максимально допустимые размеры**. Размер пула в пакетной службе ограничивается 2500 выделенными вычислительными узлами или 1000 низкоприоритетными узлами, если используется пользовательский образ.

  Если вы используете один образ (или несколько образов, созданных на основе одного базового моментального снимка) для создания нескольких пулов, общее количество вычислительных узлов в пулах не может превышать указанные выше ограничения. Не рекомендуется использовать один образ или его базовый моментальный снимок для более чем одного пула.

  Максимально допустимые размеры пула могут быть меньше, если пул настраивается как [пул NAT для входящего трафика](pool-endpoint-configuration.md).

- **Время ожидания для изменения размера**. Если пул содержит фиксированное количество узлов (автомасштабирование не выполняется), увеличьте свойство resizeTimeout пула до значения 20–30 минут. Если пулу не удается достичь целевого размера в течение времени ожидания, выполните еще одну [операцию по изменению размера](/rest/api/batchservice/pool/resize).

  Если пул имеет более чем 300 вычислительных узлов, может потребоваться изменить размер пула несколько раз, чтобы достичь целевого размера.
  
С помощью [коллекции общих образов](batch-sig-images.md)можно создавать большие пулы с настроенными образами вместе с другими репликами общих образов. Используя общие образы, время, необходимое пулу для достижения стабильного состояния, будет быстрее на 25%, а задержка простоя виртуальной машины составляет 30%.

## <a name="considerations-for-using-packer"></a>Рекомендации по использованию Pack

Создание ресурса управляемого образа непосредственно с помощью Pack может выполняться только с учетными записями пакетной службы в режиме пользовательской подписки. Для учетных записей в режиме пакетной службы сначала необходимо создать виртуальный жесткий диск, а затем импортировать его в ресурс управляемого образа. В зависимости от режима распределения пула (подписка пользователя или Пакетная служба) действия по созданию ресурса управляемого образа будут отличаться.

Убедитесь, что ресурс, используемый для создания управляемого образа, существует для времени существования любого пула, ссылающегося на пользовательский образ. Несоблюдение этого действия может привести к сбоям при выделении пула и (или) сбою при изменении размера.

При удалении образа или базового ресурса может появиться сообщение об ошибке следующего вида: `There was an error encountered while performing the last resize on the pool. Please try resizing the pool again. Code: AllocationFailed`. При возникновении этой ошибки убедитесь, что базовый ресурс не был удален.

Дополнительные сведения об использовании пакета Pack для создания виртуальной машины см. в статье Создание [образа Linux с](../virtual-machines/linux/build-image-with-packer.md) помощью средства упаковки или [Создание образа Windows с помощью](../virtual-machines/windows/build-image-with-packer.md)средства упаковки.

## <a name="next-steps"></a>Дальнейшие действия

Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
