---
title: Подготовка пула пакетной службы Azure на основе пользовательского образа | Документация Майкрософт
description: Создайте пул пакетной службы на основе пользовательского образа для подготовки вычислительных узлов, которые содержат программное обеспечение и данные, необходимые для приложения. Пользовательские образы представляют собой эффективный способ настройки вычислительных узлов для выполнения рабочих нагрузок пакетной службы.
services: batch
author: laurenhughes
manager: jeconnoc
ms.service: batch
ms.topic: article
ms.date: 04/15/2019
ms.author: lahugh
ms.openlocfilehash: 886dea0e53519870aaa27dea721a9eb78515cf86
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "64706327"
---
# <a name="use-a-custom-image-to-create-a-pool-of-virtual-machines"></a>Использование пользовательского образа для создания пула виртуальных машин 

При создании пула в пакетной службе Azure с помощью конфигурации виртуальной машины необходимо указать образ виртуальной машины, предоставляющий операционную систему, для каждого вычислительного узла в пуле. Пул виртуальных машин можно создать на основе поддерживаемого образа из Azure Marketplace или пользовательского образа (образ виртуальной машины, который вы создали и настроили самостоятельно). Пользовательский образ должен быть ресурсом *управляемого образа* в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы.

## <a name="benefits-of-custom-images"></a>Преимущества использования пользовательских образов

При предоставлении пользовательского образа вы можете управлять конфигурацией и типом операционной системы, а также используемыми дисками данных. Пользовательский образ может содержать данные о приложениях и справочные данные, которые становятся доступными на всех узлах пула пакетной службы сразу после их подготовки.

Пользовательский образ позволяет сэкономить время за счет подготовки вычислительных узлов пула к выполнению рабочей нагрузки пакетной службы. Вы всегда можете использовать образ Azure Marketplace и установить программное обеспечение на каждом вычислительном узле после его подготовки. Однако использование пользовательского образа более эффективно.

Использование пользовательского образа, настроенного для конкретного сценария, дает определенные преимущества.

- **Настройки операционной системы (ОС)** . Можно настроить конфигурацию диска операционной системы образа. 
- **Предварительная установка приложений.** Предварительная установка приложений на диск операционной системы — это более эффективный и безопасный способ, чем установка приложений после подготовки вычислительных узлов с помощью задачи запуска.
- **Экономия времени перезагрузки на виртуальных машинах.** Для установки приложения обычно требуется затратная по времени перезагрузка виртуальной машины. Это время можно сэкономить, установив приложения предварительно. 
- **Копирование очень больших объемов данных один раз.** Включите статические данные в управляемый пользовательский образ, скопировав их на его диски данных. Это необходимо сделать только один раз, и данные станут доступными в каждом узле пула.
- **Выбор типов дисков.** Для диска операционной системы и диска данных можно использовать хранилище класса Premium.
- **Увеличение пулов до больших размеров.** Пул, создаваемый на основе управляемого пользовательского образа, можно увеличить без необходимости создавать копии виртуальных жестких дисков с BLOB-объектами, содержащими образы.

## <a name="prerequisites"></a>Технические условия

- **Ресурс управляемого образа**. Чтобы создать пул виртуальных машин с помощью пользовательского образа, необходимо иметь или создать ресурс управляемого образа в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы. Образ должен быть создан на основе моментального снимка дисков ОС виртуальной машины и при необходимости ее подключенных дисков данных. Дополнительные сведения и действия по подготовке управляемого образа см. в следующем разделе.
  - Используйте уникальный пользовательский образ для каждого создаваемого пула.
  - Чтобы создать пул на основе образа с помощью API пакетной службы, укажите **идентификатор ресурса** в формате `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`. Чтобы выполнить эту операцию на портале, используйте **имя** образа.  
  - Ресурс управляемого образа должен существовать в течение всего времени существования пула, чтобы обеспечивать возможность масштабирования. Ресурс можно удалить после удаления пула.

- **Проверка подлинности Azure Active Directory (AAD)** . API клиента пакетной службы должен использовать проверку подлинности AAD. Поддержка AAD пакетной службой Azure описана в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).

## <a name="prepare-a-custom-image"></a>Подготовка пользовательского образа

В Azure можно подготовить управляемый образ на основе моментальных снимков дисков ОС и дисков данных виртуальной машины Azure, используя для этого универсальную виртуальную машину Azure с управляемыми дисками или универсальные локальные виртуальные жесткие диски, которые вы загрузили. Чтобы пулы пакетной службы на основе пользовательского образа масштабировались надежно, рекомендуется создавать управляемый образ *только* с помощью первого метода с использованием моментальных снимков дисков виртуальной машины. Ниже приведены действия по подготовке виртуальной машины, созданию моментального снимка и созданию образа на основе моментального снимка.

### <a name="prepare-a-vm"></a>Подготовка виртуальной машины

Если вы создаете новую виртуальную Машину для образа, используйте первый образ Azure Marketplace сторона, поддерживаются пакетной службой в качестве базового образа для управляемого образа. Только первые сторона изображений можно использовать как базовый образ. Чтобы получить полный список ссылок образа Azure Marketplace поддерживает пакетная служба Azure, см. в разделе [списка номеров SKU агентов узлов](/rest/api/batchservice/account/listnodeagentskus) операции.

> [!NOTE]
> В качестве базового образа нельзя использовать образы сторонних производителей, для которых предусматриваются дополнительные условия покупки и лицензия. Сведения об образах из Marketplace, см. в руководствах по виртуальным машинам [Linux](../virtual-machines/linux/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
) или [Windows](../virtual-machines/windows/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
).


* Убедитесь, что виртуальная машина создается с управляемым диском. Это параметр хранилища по умолчанию при создании виртуальной машины.
* На виртуальной машине не следует устанавливать расширения Azure, например расширение пользовательских скриптов. Если образ содержит предварительно установленное расширение, в Azure могут возникнуть проблемы при развертывании пула пакетной службы.
* Если использование присоединенных дисков с данными, необходимо подключать и форматировать диски в виртуальную Машину для использования их.
* Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
* После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные.  

### <a name="create-a-vm-snapshot"></a>Создание моментального снимка виртуальной машины

Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Чтобы создать моментальный снимок дисков ОС или дисков данных виртуальной машины, можно использовать портал Azure или средства командной строки. Описание действий и параметров, используемых для создания моментального снимка, см. в руководстве по виртуальным машинам [Linux](../virtual-machines/linux/snapshot-copy-managed-disk.md) или [Windows](../virtual-machines/windows/snapshot-copy-managed-disk.md).

### <a name="create-an-image-from-one-or-more-snapshots"></a>Создание образа на основе одного или нескольких моментальных снимков

Чтобы создать управляемый образ на основе моментального снимка, используйте средства командной строки Azure, такие как команда [az image create](/cli/azure/image). Можно создать образ, указав моментальный снимок диска ОС и при необходимости один или несколько моментальных снимков дисков данных.

## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>Создание пула на основе пользовательского образа на портале

Сохранив пользовательский образ и зная его имя или идентификатор ресурса, можно создать пул пакетной службы из этого образа. Ниже показано, как это сделать с помощью портала Azure.

> [!NOTE]
> При создании пула с помощью API пакетной службы убедитесь, что идентификатор, используемый для проверки подлинности AAD, имеет разрешения на ресурс образа. Дополнительные сведения см. в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).
>
> Ресурс управляемого образа должен существовать в течение времени существования пула. Если основной ресурс удаляется, пул не может быть масштабирована. 

1. Войдите в свою учетную запись пакетной службы на портале Azure. Эта учетная запись должна принадлежать к той же подписке и к тому же региону, что и группа ресурсов, содержащая пользовательский образ. 
2. В окне **Параметры** слева выберите пункт меню **Пулы**.
3. В окне **Пулы** выберите команду **Добавить**.
4. В окне **Добавить пул** из раскрывающегося списка **Тип образа** выберите **Пользовательский образ (Linux или Windows)** . В раскрывающемся списке **Custom VM image** (Пользовательский образ виртуальной машины) выберите имя образа (краткую форму идентификатора ресурсов).
5. Выберите правильного **издателя, предложение, SKU** для пользовательского образа.
6. Укажите оставшиеся необходимые параметры, в том числе **Размер узла**, **Target dedicated nodes** (Целевые выделенные узлы) и **Узлы с низким приоритетом**, а также любые необходимые дополнительные параметры.

    Например, для пользовательского образа Microsoft Windows Server Datacenter 2016 окно **Добавить пул** отображается, как показано ниже:

    ![Добавление пула из пользовательского образа Windows](media/batch-custom-images/add-pool-custom-image.png)
  
Чтобы проверить, основан ли имеющийся пул на пользовательском образе, найдите свойство **Операционная система** в разделе сводки по ресурсу окна **Пул**. Если пул был создан с помощью пользовательского образа, ему будет присвоено значение **Пользовательский образ виртуальной машины**.

Все пользовательские образы, связанные с пулом, отображаются в окне **Свойства** пула.

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями виртуальных машин на основе пользовательского образа, нужно обязательно следовать изложенным выше рекомендациям и использовать образ, созданный на основе моментального снимка виртуальной машины.

Обратите внимание на следующее:

- **Максимально допустимые размеры**. Размер пула в пакетной службе ограничивается 2500 выделенными вычислительными узлами или 1000 низкоприоритетными узлами, если используется пользовательский образ.

  Если вы используете один образ (или несколько образов, созданных на основе одного базового моментального снимка) для создания нескольких пулов, общее количество вычислительных узлов в пулах не может превышать указанные выше ограничения. Не рекомендуется использовать один образ или его базовый моментальный снимок для более чем одного пула.

  Максимально допустимые размеры пула могут быть меньше, если пул настраивается как [пул NAT для входящего трафика](pool-endpoint-configuration.md).

- **Время ожидания для изменения размера**. Если пул содержит фиксированное количество узлов (автомасштабирование не выполняется), увеличьте свойство resizeTimeout пула до значения 20–30 минут. Если пулу не удается достичь целевого размера в течение времени ожидания, выполните еще одну [операцию по изменению размера](/rest/api/batchservice/pool/resize).

  Если пул имеет более чем 300 вычислительных узлов, может потребоваться изменить размер пула несколько раз, чтобы достичь целевого размера.

## <a name="considerations-for-using-packer"></a>Рекомендации по использованию Packer

Создается ресурс управляемого образа непосредственно с помощью Packer может быть выполнено только учетные записи пакетной службы режиме подписки пользователя. Для режима службы учетных записей пакетной службы необходимо сначала создать виртуальный жесткий ДИСК, а затем импортировать ресурс управляемого образа виртуального жесткого диска. Зависит от режима выделения пула (пользовательская подписка или пакетной службы) зависит от действия таким образом, чтобы создать ресурс управляемого образа.

Убедитесь в наличии ресурсов, используемый для создания управляемого образа для политик времени жизни любого пула, ссылки на пользовательский образ. Невыполнение этого требования может привести к сбою выделения пула и/или изменить размер сбоев. 

Если удаляется из образа и базовый ресурс, может появиться ошибка аналогичную: `There was an error encountered while performing the last resize on the pool. Please try resizing the pool again. Code: AllocationFailed`. В этом случае убедитесь, что базовый ресурс не был удален.

Дополнительные сведения об использовании Packer для создания виртуальной Машины, см. в разделе [Создание образа Linux с помощью Packer](../virtual-machines/linux/build-image-with-packer.md) или [Создание образа Windows с помощью Packer](../virtual-machines/windows/build-image-with-packer.md).

## <a name="next-steps"></a>Дальнейшие действия

- Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
