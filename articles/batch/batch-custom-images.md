---
title: Предоставление пользовательского пула из управляемого изображения - Azure Batch Документы Майкрософт
description: Создание пула пакетов из управляемого ресурса изображений для обеспечения вычислительных узлов с программным обеспечением и данными для приложения.
services: batch
author: LauraBrenner
manager: evansma
ms.service: batch
ms.topic: article
ms.date: 09/16/2019
ms.author: labrenne
ms.openlocfilehash: 1ef6be2ba9364203dceba54ab51325c05dbbbe41
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77020154"
---
# <a name="use-a-managed-image-to-create-a-pool-of-virtual-machines"></a>Используйте управляемое изображение для создания пула виртуальных машин

Для создания пользовательского изображения для виртуальных машин вашего пула (VM) можно использовать как [общую галерею изображений,](batch-sig-images.md)так и *управляемый* ресурс изображений.

> [!TIP]
> В большинстве случаев следует создавать пользовательские изображения с помощью общей галереи изображений. Используя общую галерею изображений, можно предоставлять пулы быстрее, масштабировать большие объемы вс-а и повышаетнадежность при подготовке VMs. Чтобы узнать больше, [см. Воспользуйтесь общей галереей изображений для создания пользовательского пула.](batch-sig-images.md)

## <a name="prerequisites"></a>Предварительные требования

- **Ресурс управляемого образа**. Чтобы создать пул виртуальных машин с помощью пользовательского образа, необходимо иметь или создать ресурс управляемого образа в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы. Образ должен быть создан на основе моментального снимка дисков ОС виртуальной машины и при необходимости ее подключенных дисков данных. Дополнительные сведения и действия по подготовке управляемого образа см. в следующем разделе.
  - Используйте уникальный пользовательский образ для каждого создаваемого пула.
  - Чтобы создать пул на основе образа с помощью API пакетной службы, укажите **идентификатор ресурса** в формате `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`. Чтобы выполнить эту операцию на портале, используйте **имя** образа.  
  - Ресурс управляемого образа должен существовать в течение всего времени существования пула, чтобы обеспечивать возможность масштабирования. Ресурс можно удалить после удаления пула.

- **Активная проверка подлинности Azure Active Directory (AAD).** API клиента пакетной службы должен использовать проверку подлинности AAD. Поддержка AAD пакетной службой Azure описана в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).

## <a name="prepare-a-custom-image"></a>Подготовка пользовательского образа

В Azure можно подготовить управляемое изображение из:

- Снимки ОС ИТ-и дисков данных Azure VM
- Обобщенный Azure VM с управляемыми дисками
- Обобщенный предприимчатенный VHD, загруженный в облако

Чтобы пулы пакетной службы на основе пользовательского образа масштабировались надежно, рекомендуется создавать управляемый образ *только* с помощью первого метода с использованием моментальных снимков дисков виртуальной машины. Ниже приведены действия по подготовке виртуальной машины, созданию моментального снимка и созданию образа на основе моментального снимка.

### <a name="prepare-a-vm"></a>Подготовка виртуальной машины

Если вы создаете новый VM для изображения, используйте изображение Azure Marketplace первой стороны, поддерживаемое Пакетом, в качестве базового изображения для управляемого изображения. Только изображения первой партии могут быть использованы в качестве базового изображения. Чтобы получить полный список ссылок на изображения Azure [List node agent SKUs](/java/api/com.microsoft.azure.batch.protocol.accounts.listnodeagentskus) Marketplace, поддерживаемых Azure Batch, см.

> [!NOTE]
> В качестве базового образа нельзя использовать образы сторонних производителей, для которых предусматриваются дополнительные условия покупки и лицензия. Сведения об образах из Marketplace, см. в руководствах по виртуальным машинам [Linux](../virtual-machines/linux/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
) или [Windows](../virtual-machines/windows/cli-ps-findimage.md#deploy-an-image-with-marketplace-terms
).

- Убедитесь, что VM создается с управляемым диском. Это параметр хранилища по умолчанию при создании виртуальной машины.
- На виртуальной машине не следует устанавливать расширения Azure, например расширение пользовательских скриптов. Если образ содержит предварительно установленное расширение, в Azure могут возникнуть проблемы при развертывании пула пакетной службы.
- При использовании прикрепленных дисков данных необходимо монтировать и форматировать диски из впределах VM, чтобы использовать их.
- Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
- После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные.  

### <a name="create-a-vm-snapshot"></a>Создание моментального снимка виртуальной машины

Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Чтобы создать моментальный снимок дисков ОС или дисков данных виртуальной машины, можно использовать портал Azure или средства командной строки. Описание действий и параметров, используемых для создания моментального снимка, см. в руководстве по виртуальным машинам [Linux](../virtual-machines/linux/snapshot-copy-managed-disk.md) или [Windows](../virtual-machines/windows/snapshot-copy-managed-disk.md).

### <a name="create-an-image-from-one-or-more-snapshots"></a>Создание образа на основе одного или нескольких моментальных снимков

Чтобы создать управляемый образ на основе моментального снимка, используйте средства командной строки Azure, такие как команда [az image create](/cli/azure/image). Можно создать образ, указав моментальный снимок диска ОС и при необходимости один или несколько моментальных снимков дисков данных.

## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>Создание пула на основе пользовательского образа на портале

Сохранив пользовательский образ и зная его имя или идентификатор ресурса, можно создать пул пакетной службы из этого образа. Ниже показано, как это сделать с помощью портала Azure.

> [!NOTE]
> При создании пула с помощью API пакетной службы убедитесь, что идентификатор, используемый для проверки подлинности AAD, имеет разрешения на ресурс образа. Дополнительные сведения см. в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).
>
> Ресурс для управляемого изображения должен существовать в течение всего срока службы пула. Если базовый ресурс удален, пул не может быть масштабирован.

1. Войдите в свою учетную запись пакетной службы на портале Azure. Эта учетная запись должна принадлежать к той же подписке и к тому же региону, что и группа ресурсов, содержащая пользовательский образ.
2. В окне **Параметры** слева выберите пункт меню **Пулы**.
3. В окне **Пулы** выберите команду **Добавить**.
4. В окне **Добавить пул** из раскрывающегося списка **Тип образа** выберите **Пользовательский образ (Linux или Windows)**. В раскрывающемся списке **Custom VM image** (Пользовательский образ виртуальной машины) выберите имя образа (краткую форму идентификатора ресурсов).
5. Выберите правильного **издателя, предложение, SKU** для пользовательского образа.
6. Укажите оставшиеся требуемые параметры, включая **размер узла,** **целевые выделенные узлы**и **узлы с низким приоритетом,** а также любые желаемые дополнительные настройки.

    Например, для пользовательского образа Microsoft Windows Server Datacenter 2016 окно **Добавить пул** отображается, как показано ниже:

    ![Добавление пула из пользовательского образа Windows](media/batch-custom-images/add-pool-custom-image.png)
  
Чтобы проверить, основан ли имеющийся пул на пользовательском образе, найдите свойство **Операционная система** в разделе сводки по ресурсу окна **Пул**. Если пул был создан с помощью пользовательского образа, ему будет присвоено значение **Пользовательский образ виртуальной машины**.

Все пользовательские образы, связанные с пулом, отображаются в окне **Свойства** пула.

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями виртуальных машин на основе пользовательского образа, нужно обязательно следовать изложенным выше рекомендациям и использовать образ, созданный на основе моментального снимка виртуальной машины.

Также обратите внимание на следующие соображения:

- **Максимально допустимые размеры**. Размер пула в пакетной службе ограничивается 2500 выделенными вычислительными узлами или 1000 низкоприоритетными узлами, если используется пользовательский образ.

  Если вы используете один образ (или несколько образов, созданных на основе одного базового моментального снимка) для создания нескольких пулов, общее количество вычислительных узлов в пулах не может превышать указанные выше ограничения. Не рекомендуется использовать один образ или его базовый моментальный снимок для более чем одного пула.

  Максимально допустимые размеры пула могут быть меньше, если пул настраивается как [пул NAT для входящего трафика](pool-endpoint-configuration.md).

- **Время ожидания для изменения размера**. Если пул содержит фиксированное количество узлов (автомасштабирование не выполняется), увеличьте свойство resizeTimeout пула до значения 20–30 минут. Если пулу не удается достичь целевого размера в течение времени ожидания, выполните еще одну [операцию по изменению размера](/rest/api/batchservice/pool/resize).

  Если пул имеет более чем 300 вычислительных узлов, может потребоваться изменить размер пула несколько раз, чтобы достичь целевого размера.
  
С помощью [общей галереи изображений](batch-sig-images.md)можно создавать большие пулы с настраиваемыми изображениями вместе с большим количеством реплик общих изображений. Используя общие изображения, время, необходимое пулу для достижения стабильного состояния, на 25% быстрее, а задержка в холостом ходу VM на 30% короче.

## <a name="considerations-for-using-packer"></a>Рассмотрение вопроса об использовании Packer

Создание управляемого ресурса изображений непосредственно с помощью Packer может быть сделано только с помощью пользовательского режима подписки Пакет счетов. Для учетных записей режима обслуживания Batch необходимо сначала создать VHD, а затем импортировать VHD на управляемый ресурс изображения. В зависимости от режима распределения пула (подписка пользователя или служба пакетов) ваши шаги по созданию управляемого ресурса изображений будут меняться.

Убедитесь, что ресурс, используемый для создания управляемого изображения, существует в течение всего срока службы любого пула, ссылаясь на пользовательское изображение. Невыполнение этого требования может привести к сбоям распределения пула и/или сбоям в размерах.

Если изображение или базовый ресурс удалены, вы можете `There was an error encountered while performing the last resize on the pool. Please try resizing the pool again. Code: AllocationFailed`получить ошибку, аналогичную: . Если вы обнаружите эту ошибку, убедитесь, что базовый ресурс не был удален.

Для получения дополнительной информации об использовании Packer для создания [Build a Windows image with Packer](../virtual-machines/windows/build-image-with-packer.md)VM [см.](../virtual-machines/linux/build-image-with-packer.md)

## <a name="next-steps"></a>Дальнейшие действия

Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
