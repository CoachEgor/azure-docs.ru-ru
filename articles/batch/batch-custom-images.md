---
title: Подготовка пула пакетной службы Azure на основе пользовательского образа | Документация Майкрософт
description: Создайте пул пакетной службы на основе пользовательского образа для подготовки вычислительных узлов, которые содержат программное обеспечение и данные, необходимые для приложения. Пользовательские образы представляют собой эффективный способ настройки вычислительных узлов для выполнения рабочих нагрузок пакетной службы.
services: batch
author: laurenhughes
manager: gwallace
ms.service: batch
ms.topic: article
ms.date: 08/07/2019
ms.author: lahugh
ms.openlocfilehash: d8bda817231ec0a5a733d5e586e49639c62ea177
ms.sourcegitcommit: aa042d4341054f437f3190da7c8a718729eb675e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/09/2019
ms.locfileid: "68882842"
---
# <a name="use-a-custom-image-to-create-a-pool-of-virtual-machines"></a>Использование пользовательского образа для создания пула виртуальных машин

При создании пула в пакетной службе Azure с помощью конфигурации виртуальной машины необходимо указать образ виртуальной машины, предоставляющий операционную систему, для каждого вычислительного узла в пуле. Пул виртуальных машин можно создать с помощью поддерживаемого образа Azure Marketplace или создать пользовательский образ с помощью [общей коллекции образов](../virtual-machines/windows/shared-image-galleries.md).

## <a name="benefits-of-the-shared-image-gallery"></a>Преимущества коллекции общих образов

При использовании коллекции общих образов для пользовательского образа вы можете управлять типом и конфигурацией операционной системы, а также типами дисков данных. Общий образ может включать приложения и справочные данные, которые становятся доступными на всех узлах пула пакетной службы сразу после их подготовки.

Можно также иметь несколько версий образа, необходимых для вашей среды. При использовании версии образа для создания виртуальной машины используется версия образа для создания новых дисков для виртуальной машины. 

Использование общего образа экономит время при подготовке расчетных узлов пула для выполнения рабочей нагрузки пакетной службы. После подготовки можно использовать образ Azure Marketplace и установить программное обеспечение на каждом из них, но использование общего образа, как правило, более эффективно. Кроме того, можно указать несколько реплик для общего образа, поэтому при создании пулов с несколькими виртуальными машинами (более 600 виртуальных машин) вы сэкономите время на создание пула.

Использование общего образа, настроенного для вашего сценария, может предоставить несколько преимуществ.

* **Используйте одни и те же изображения в разных регионах.** Вы можете создавать реплики общих образов в разных регионах, чтобы все пулы использовали один и тот же образ.
* **Настройка операционной системы (ОС).** Можно настроить конфигурацию диска операционной системы образа.
* **Предварительная установка приложений.** Предварительная установка приложений на диске операционной системы является более эффективной и менее подверженной ошибкам, чем установка приложений после подготовки вычислений для узлов с задачей запуска.
* **Копирование больших объемов данных один раз.** Сделайте часть статических данных управляемого общего образа, скопировав ее на диски данных управляемого образа. Это необходимо сделать только один раз, и данные станут доступными в каждом узле пула.
* **Расширяйте пулы до большего размера.** С помощью коллекции общих образов можно создавать более крупные пулы с настроенными образами вместе с другими репликами общих образов.
* **Повышенная производительность, чем пользовательский образ.** Используя общие образы, время, необходимое пулу для достижения стабильного состояния, будет быстрее на 25%, а задержка простоя виртуальной машины составляет 30%.
* **Управление версиями и группирование изображений для упрощения управления.** Определение группирования изображений содержит сведения о том, почему было создано изображение, какую операционную систему он использует, а также сведения об использовании образа. Группирование изображений позволяет упростить управление образами. Дополнительные сведения см. в разделе [определения изображений](../virtual-machines/windows/shared-image-galleries.md#image-definitions).

## <a name="prerequisites"></a>предварительные требования

* **Учетная запись пакетной службы Azure.** Чтобы создать учетную запись пакетной службы, ознакомьтесь с краткими руководствами по пакетной службе, используя [портал Azure](quick-create-portal.md) или [Azure CLI](quick-create-cli.md).

* **Образ общей коллекции образов**. Дополнительные сведения и инструкции по подготовке общего образа см. в статье [Создание коллекции общих образов с Azure CLI](../virtual-machines/linux/shared-images.md) или [Создание общей коллекции образов с помощью портал Azure](../virtual-machines/linux/shared-images-portal.md).

> [!NOTE]
> Общий образ должен находиться в той же подписке, что и учетная запись пакетной службы. Общий образ может находиться в разных регионах, если у него есть реплики в том же регионе, что и учетная запись пакетной службы.

## <a name="create-a-pool-from-a-shared-image-using-the-azure-cli"></a>Создание пула из общего образа с помощью Azure CLI

Чтобы создать пул из общего образа с помощью Azure CLI, используйте `az batch pool create` команду. Укажите идентификатор общего образа в `--image` поле. Убедитесь, что тип ОС и номер SKU соответствуют версиям, указанным в параметре`--node-agent-sku-id`

```azurecli
az batch pool create \
    --id mypool --vm-size Standard_A1_v2 \
    --target-dedicated-nodes 2 \
    --image "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/galleries/{gallery name}/images/{image definition name}/versions/{version id}" \
    --node-agent-sku-id "batch.node.ubuntu 16.04"
```

## <a name="create-a-pool-from-a-shared-image-using-c"></a>Создание пула из общего образа с помощьюC#

Кроме того, можно создать пул из общего образа с помощью C# пакета SDK.

```csharp
private static VirtualMachineConfiguration CreateVirtualMachineConfiguration(ImageReference imageReference)
{
    return new VirtualMachineConfiguration(
        imageReference: imageReference,
        nodeAgentSkuId: "batch.node.windows amd64");
}

private static ImageReference CreateImageReference()
{
    return new ImageReference(
        virtualMachineImageId: "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/galleries/{gallery name}/images/{image definition name}/versions/{version id}");
}

private static void CreateBatchPool(BatchClient batchClient, VirtualMachineConfiguration vmConfiguration)
{
    try
    {
        CloudPool pool = batchClient.PoolOperations.CreatePool(
            poolId: PoolId,
            targetDedicatedComputeNodes: PoolNodeCount,
            virtualMachineSize: PoolVMSize,
            virtualMachineConfiguration: vmConfiguration);

        pool.Commit();
    }
    ...
}
```

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями или тысячами виртуальных машин или более с помощью общего образа, используйте следующие рекомендации.

* **Номера реплик коллекции общих образов.**  Для каждого пула, имеющего до 600 экземпляров, рекомендуется разместить по крайней мере одну реплику. Например, при создании пула с 3000 виртуальными машинами необходимо иметь по крайней мере 5 реплик образа. Мы всегда рекомендуем хранить больше реплик, чем минимальные требования для повышения производительности.

* **Время ожидания изменения размера** Если в пуле содержится фиксированное число узлов (если он не выполняет Автомасштабирование), увеличьте `resizeTimeout` свойство пула в зависимости от размера пула. Для каждых 1000 виртуальных машин рекомендуемое время ожидания изменения размера составляет не менее 15 минут. Например, рекомендуемое время ожидания изменения размера для пула с 2000 виртуальными машинами составляет не менее 30 минут.

## <a name="next-steps"></a>Следующие шаги

* Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
