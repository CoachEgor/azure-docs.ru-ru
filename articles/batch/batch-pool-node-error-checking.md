---
title: Проверка на наличие ошибок в пуле и узле с помощью пакетной службы Azure
description: В этой статье рассматриваются фоновые операции, которые могут возникнуть, а также ошибки для проверки и способы их предотвращения при создании пулов и узлов.
services: batch
ms.service: batch
author: mscurrell
ms.author: markscu
ms.date: 08/23/2019
ms.topic: conceptual
ms.openlocfilehash: a68d812a044c776819d169d5bf179f011d06390f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79472951"
---
# <a name="check-for-pool-and-node-errors"></a>Проверка на наличие ошибок в пуле и узле

При создании и управлении пулами пакетной службы Azure некоторые операции выполняются немедленно. Тем не менее, некоторые операции являются асинхронными и выполняются в фоновом режиме, что занимает несколько минут.

Процесс обнаружения ошибок для операций, которые выполняются немедленно, довольно прост, так как все ошибки сразу возвращаются через API, интерфейс командной строки или пользовательский интерфейс.

В этой статье рассматриваются фоновые операции, которые могут выполняться для пулов и узлов пулов. Здесь указано, каким образом можно их обнаружить и избежать сбоев.

## <a name="pool-errors"></a>Ошибки пула

### <a name="resize-timeout-or-failure"></a>Время ожидания изменения размера или сбой

При создании пула или изменении размера имеющегося пула вы указываете целевое количество узлов.  Операция создания или размера выполняется немедленно, но фактическое распределение новых узлов или удаление существующих узлов может занять несколько минут.  Время ожидания изменения размера указывается в API [создания](https://docs.microsoft.com/rest/api/batchservice/pool/add) или [изменения размера](https://docs.microsoft.com/rest/api/batchservice/pool/resize). Если Batch не может получить целевое количество узлов в период повторного тайм-аута, пул переходит в стабильное состояние и сообщает об ошибках повторного размера.

Свойство [ResizeError](https://docs.microsoft.com/rest/api/batchservice/pool/get#resizeerror) для последней оценки перечисляет ошибки, которые произошли.

Общие причины ошибок повторного размера включают в себя:

- Слишком короткое время ожидания изменения размера.
  - В большинстве случаев время ожидания по умолчанию в 15 минут достаточно для выделения или удаления узлов пула.
  - Если вы выделяете большое количество узлов, рекомендуется установить время ожидания изменения размера на 30 минут. Например, при изменении размера более 1000 узлов из образа Azure Marketplace или более 300 узлов из пользовательского образа виртуальной машины.
- Недостаточная квота ядер.
  - Учетная запись пакетной службы ограничена количеством ядер, которые можно выделить во всех пулах. После достижения данной квоты пакетная служба прекращает выделять узлы. Вы [можете увеличить](https://docs.microsoft.com/azure/batch/batch-quota-limit) квоту ядер, чтобы пакет мог выделить больше узлов.
- Недостаточно IP-адресов подсети, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - В подсети виртуальной сети должно быть достаточно неназначенных IP-адресов для выделения каждому запрошенному узлу пула. В противном случае узлы не могут быть созданы.
- Недостаточно ресурсов, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - Вы можете создавать ресурсы, такие как балансировщики нагрузки, общедоступные IP-адреса и группы безопасности сети, в той же подписке, что и учетная запись пакетной службы. Убедитесь, что квоты подписки достаточны для этих ресурсов.
- Большие пулы с пользовательскими образами виртуальных машин
  - Для выделения больших пулов, использующих пользовательские образы виртуальных машин, может потребоваться больше времени, из-за чего время ожидания может истечь.  Смотрите [Создать пул с общей галереей изображений](batch-sig-images.md) для рекомендаций по ограничениям и конфигурации.

### <a name="automatic-scaling-failures"></a>Сбои автоматического масштабирования

Вы также можете настроить пакетную службу Azure для автоматического масштабирования количества узлов в пуле. Вы определяете параметры для [формулы автоматического масштабирования для пула](https://docs.microsoft.com/azure/batch/batch-automatic-scaling). Пакетная служба использует формулу для периодической оценки количества узлов в пуле и установки нового целевого количества. Возможны следующие проблемы.

- Сбой оценки автоматического масштабирования.
- Итоговая операция изменения размера завершается ошибкой и истечением времени ожидания.
- Проблема с формулой автоматического масштабирования приводит к неверным целевым значениям узла. Изменение размера работает, или истекает время ожидания.

Сведения о последней оценке автоматического масштабирования можно получить с помощью свойства [autoScaleRun](https://docs.microsoft.com/rest/api/batchservice/pool/get#autoscalerun). Это свойство сообщает время оценки, значения и результат, а также все ошибки производительности.

Сведения обо всех оценках автоматически фиксируются в [событии завершения изменения размера пула](https://docs.microsoft.com/azure/batch/batch-pool-resize-complete-event).

### <a name="delete"></a>DELETE

При удалении пула, содержащего узлы, первый пакет удаляет узлы. Затем он удаляет сам объект пула. Удаление узлов пула может занять несколько минут.

В процессе удаления в качестве [состояния пула](https://docs.microsoft.com/rest/api/batchservice/pool/get#poolstate) пакетная служба указывает значение **deleting** (Удаление). Вызывающее приложение может обнаружить слишком долгое время удаления пула на основе свойств **state** и **stateTransitionTime**.

## <a name="pool-compute-node-errors"></a>Ошибки вычислительных узлов в пуле

Даже если Пакет успешно выделяет узлы в пуле, различные проблемы могут привести к тому, что некоторые узлы будут неработоспособными и немогут выполнять задачи. Эти узлы по-прежнему несут расходы, поэтому важно обнаружить проблемы, чтобы избежать оплаты узлов, которые не могут быть использованы. Помимо общих ошибок узлов, знание текущего [состояния задания](/rest/api/batchservice/job/get#jobstate) полезно для устранения неполадок.

### <a name="start-task-failures"></a>Запуск сбоев задач

Возможно, вы захотите указать необязательную [задачу запуска](/rest/api/batchservice/pool/add#starttask) для пула. Как и в любой задаче, вы можете использовать командную строку и файлы ресурсов для загрузки из хранилища. Задача запуска выполняется для каждого узла после его запуска. Свойство **waitForSuccess** указывает, будет ли пакетная служба ждать успешного завершения задачи запуска, прежде чем планировать какие-либо задачи для узла.

Что делать, если вы настроили узел на ожидание успешного завершения задачи запуска, но задача запуска завершилась сбоем? В этом случае узел не будет пригодным к употреблению, но все равно будет нести расходы.

Сбои выполнения задачи запуска можно обнаружить с помощью свойств [result](/rest/api/batchservice/computenode/get#taskexecutionresult) и [failureInfo](/rest/api/batchservice/computenode/get#taskfailureinformation) свойства узла верхнего уровня [startTaskInfo](/rest/api/batchservice/computenode/get#starttaskinformation).

Неудачная задача запуска также приводит к тому, что пакет установит [состояние](/rest/api/batchservice/computenode/get#computenodestate) узла **для starttaskfailed,** если **waitForSuccess** был настроен **на истину.**

Как и в любой задаче, может быть множество причин сбоя задачи запуска.  Для устранения неполадок следует проверить файлы журнала stdout, stderr и другие файлы журнала для конкретных задач.

Задачи запуска должны быть повторно вне зависимости от участников, так как возможно, что задача запуска несколько раз выполняются на одном и том же узлах; задача запуска запущена, когда узла переобозаключена или перезагружена. В редких случаях задача запуска будет запущена после того, как событие вызвало перезагрузку узла, где один из операционных систем или эфемерных дисков был reimaged в то время как другой не был. Поскольку задачи запуска пакета (как и все задачи пакета) выполняются с эфемерного диска, это обычно не является проблемой, но в некоторых случаях, когда задача запуска заключается в установке приложения на диск операционной системы и хранении других данных на эфемерном диске, это может привести к проблемы, потому что вещи не синхронизированы. Защитите приложение соответствующим образом, если вы используете оба диска.

### <a name="application-package-download-failure"></a>Не удалось скачать пакет приложения

Вы можете указать один или несколько пакетов приложений для пула. Пакет загружает указанные файлы пакета в каждый узел и распаковывает файлы после запуска узла, но до того, как запланированы задачи. Обычно используется командная строка запуска задачи совместно с пакетами приложений. Например, чтобы скопировать файлы в другое место или запустить программу установки.

Свойство узла [ошибки](/rest/api/batchservice/computenode/get#computenodeerror) сообщает о сбое загрузки и сдавливание пакета приложений; состояние узла настроено на **непригоденное.**

### <a name="container-download-failure"></a>Сбой загрузки контейнера

Можно указать одну или несколько ссылок на контейнер в пуле. Пакет загружает указанные контейнеры в каждый узла. Свойство узла [сообщает](/rest/api/batchservice/computenode/get#computenodeerror) о сбое загрузки контейнера и устанавливает состояние узла в **непригодный для узла.**

### <a name="node-in-unusable-state"></a>Узел с состоянием unusable (Непригоден)

Пакетная служба Azure может установить [состояние узла](/rest/api/batchservice/computenode/get#computenodestate) на **unusable** (Непригоден) по многим причинам. Если состояние узла установлено на **unusable** (Непригоден), задачи для узла не могут быть запланированы, но плата по-прежнему взимается.

Узлы в **непригодном** для ней состоянии, но без [ошибок](/rest/api/batchservice/computenode/get#computenodeerror) означают, что Batch не может общаться с VM. В этом случае Batch всегда пытается восстановить VM. Пакет не будет автоматически пытаться восстановить VMs, которые не смогли установить пакеты приложений или контейнеры, даже если их состояние **непригово.**

Если пакетная служба может определить причину, свойство узла [errors](/rest/api/batchservice/computenode/get#computenodeerror) сообщает об этом.

Ниже приведены дополнительные примеры возможных причин возникновения состояния узлов **unusable** (Непригоден).

- Образ виртуальной машины является недопустимым. Например, образ подготовлено неправильно.

- Виртуальная машина перемещена из-за сбоя инфраструктуры или обновления нижнего уровня. Пакетная служба восстанавливает узел.

- Изображение VM было развернуто на оборудовании, которое не поддерживает его. Например, попытка запустить изображение HPC CentOS на [Standard_D1_v2](../virtual-machines/dv2-dsv2-series.md) VM.

- Виртуальные виртуальные технологии Azure находятся в [виртуальной сети Azure,](batch-virtual-network.md)и трафик заблокирован в ключевых портах.

- Виртуальные виртуальные технологии находятся в виртуальной сети, но исходящий трафик в хранилище Azure заблокирован.

- Виртуальные виртуальные технологии находятся в виртуальной сети с конфигурацией DNS клиента, а DNS-сервер не может решить проблему хранения Azure.

### <a name="node-agent-log-files"></a>Файлы журнала агента узла

Процесс агента пакета, который работает на каждом узеле пула, может предоставить файлы журнала, которые могут быть полезны, если вам нужно связаться с поддержкой по поводу проблемы узла пула. Файлы журнала для узла можно отправить с помощью портала Azure, Batch Explorer или [API](/rest/api/batchservice/computenode/uploadbatchservicelogs). Это полезно, когда нужно отправить и сохранить файлы журнала. После этого можно удалить узел или пул, чтобы сэкономить на стоимости работающих узлов.

### <a name="node-disk-full"></a>Узлы дискполный

Временный диск для узла пула VM используется пакетом для файлов задач, файлов задач и общих файлов.

- Файлы пакетов приложений
- Файлы ресурсов задач
- Файлы, в частности приложения, загруженные в одну из папок пакета
- Файлы Stdout и stderr для выполнения каждого приложения задачи
- Выходные файлы, связанные с применением

Некоторые из этих файлов записываются только один раз при создании узлов пула, таких как пакеты приложений пула или файлы ресурсов запуска пула. Даже если только один раз, когда узел создан, если эти файлы слишком велики, они могут заполнить временный диск.

Другие файлы выписываются для каждой задачи, которая работает на узеле, таких как stdout и stderr. Если большое количество задач выполняются на одном и том же узеле и/или файлы задач слишком велики, они могут заполнить временный диск.

Размер временного привода зависит от размера VM. Одним из соображений при выборе размера VM является обеспечение временного диска имеет достаточно места.

- На портале Azure при добавлении пула можно отобразить полный список размеров VM и столбец 'Размер ресурсного диска'.
- Статьи, описывающие все размеры VM, имеют таблицы с столбцей "Temp Storage"; [например, вычислительные оптимизированные размеры VM](/azure/virtual-machines/windows/sizes-compute)

Для файлов, выписанных каждой задачей, может быть указано время хранения для каждой задачи, определяющей, как долго хранятся файлы задач до автоматической очистки. Время хранения может быть сокращено, чтобы снизить требования к хранению.


Если временный диск иссякнет из пространства (или очень близок к выходу из космоса), узла переместится в [неприменяемое](/rest/api/batchservice/computenode/get#computenodestate) состояние, и будет сообщена ошибка узла, в которых говорится, что диск полон.

### <a name="what-to-do-when-a-disk-is-full"></a>Что делать, если диск полон

Определите, почему диск полон: Если вы не уверены, что занимает место на узеле, рекомендуется удаленно гонять за узел и исследовать вручную, где пространство прошло. Можно также использовать [API файлов пакетных списков](https://docs.microsoft.com/rest/api/batchservice/file/listfromcomputenode) для изучения файлов в управляемых пакетах (например, выходы задач). Обратите внимание, что этот API перечисляет только файлы в управляемых каталогах пакетов, и если ваши задачи создали файлы в другом месте, вы не увидите их.

Убедитесь, что все необходимые данные были извлечены из узла или загружены в прочный магазин. Все смягчение проблемы с диском включает в себя удаляние данных для высвобления места.

### <a name="recovering-the-node"></a>Восстановление узла

1. Если ваш пул является пулом [C.loudServiceConfiguration,](https://docs.microsoft.com/rest/api/batchservice/pool/add#cloudserviceconfiguration) вы можете повторно изображение узла через [API повторного изображения пакета.](https://docs.microsoft.com/rest/api/batchservice/computenode/reimage) Это позволит очистить весь диск. Повторное изображение в настоящее время не поддерживается для пулов [VirtualMachineConfiguration.](https://docs.microsoft.com/rest/api/batchservice/pool/add#virtualmachineconfiguration)

2. Если ваш пул является [VirtualMachineConfiguration,](https://docs.microsoft.com/rest/api/batchservice/pool/add#virtualmachineconfiguration)вы можете удалить узла из пула с помощью [API удаляемых узлов.](https://docs.microsoft.com/rest/api/batchservice/pool/removenodes) Затем, вы можете вырастить бассейн снова, чтобы заменить плохой узло на свежий.

3.  Удалите старые завершенные задания или старые завершенные задачи, данные о задачах которых все еще находятся в узлах. Для подсказки о том, какие данные о заданиях/задачах есть на узлах, которые вы можете посмотреть в [коллекции RecentTasks](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskinformation) на узеле или в [файлах на узеле.](https://docs.microsoft.com//rest/api/batchservice/file/listfromcomputenode) Удаление задания удалит все задачи в задании, а удаление задач в задании вызовет данные в каталогах задач на узле, которое будет удалено, тем самым высвободив пространство. После того как вы освободили достаточно места, перезагрузите узла, и он должен выйти из состояния "Unusable" и снова в "Idle".

## <a name="next-steps"></a>Дальнейшие действия

Убедитесь, что в вашем приложении реализована комплексная проверка ошибок, особенно для асинхронных операций. Очень важно своевременно обнаруживать и диагностировать неполадки.
