---
title: Проверка на наличие ошибок в пуле и узле с помощью пакетной службы Azure
description: Проверяемые ошибки и способы их избежания при создании пулов и узлов.
services: batch
ms.service: batch
author: mscurrell
ms.author: markscu
ms.date: 05/28/2019
ms.topic: conceptual
ms.openlocfilehash: b0a9d04fccce7ccbacb700f7af5126c6ae05140a
ms.sourcegitcommit: 8e76be591034b618f5c11f4e66668f48c090ddfd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/29/2019
ms.locfileid: "66357762"
---
# <a name="check-for-pool-and-node-errors"></a>Проверка на наличие ошибок в пуле и узле

При создании и управлении пулами пакетной службы Azure некоторые операции выполняются немедленно. Тем не менее некоторые операции являются асинхронными и выполняются в фоновом режиме. Это может занять несколько минут.

Процесс обнаружения ошибок для операций, которые выполняются немедленно, довольно прост, так как все ошибки сразу возвращаются через API, интерфейс командной строки или пользовательский интерфейс.

В этой статье рассматриваются фоновые операции, которые могут выполняться для пулов и узлов пулов. Здесь указано, каким образом можно их обнаружить и избежать сбоев.

## <a name="pool-errors"></a>Ошибки пула

### <a name="resize-timeout-or-failure"></a>Время ожидания изменения размера или сбой

При создании пула или изменении размера имеющегося пула вы указываете целевое количество узлов.  Операция завершается немедленно, но фактическое выделение новых узлов или удаление существующих узлов может занять несколько минут.  Время ожидания изменения размера указывается в API [создания](https://docs.microsoft.com/rest/api/batchservice/pool/add) или [изменения размера](https://docs.microsoft.com/rest/api/batchservice/pool/resize). Если пакетная служба не может получить целевое количество узлов во время ожидания изменения размера, она останавливает операцию. Пул переходит в устойчивое состояние и сообщает об ошибках изменения размера.

Свойство [ResizeError](https://docs.microsoft.com/rest/api/batchservice/pool/get#resizeerror) для самой последней оценки сообщает о времени ожидания изменения размера и перечисляет все возникшие ошибки.

К распространенным причинам истечения времени ожидания изменения размера относятся:

- Слишком короткое время ожидания изменения размера.
  - В большинстве случаев время ожидания по умолчанию в 15 минут достаточно для выделения или удаления узлов пула.
  - Если вы выделяете большое количество узлов, рекомендуется установить время ожидания изменения размера на 30 минут. Например, при изменении размера более 1000 узлов из образа Azure Marketplace или более 300 узлов из пользовательского образа виртуальной машины.
- Недостаточная квота ядер.
  - Учетная запись пакетной службы ограничена количеством ядер, которые можно выделить во всех пулах. После достижения данной квоты пакетная служба прекращает выделять узлы. Вы [можете увеличить](https://docs.microsoft.com/azure/batch/batch-quota-limit) квоту ядер, чтобы пакет мог выделить больше узлов.
- Недостаточно IP-адресов подсети, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - В подсети виртуальной сети должно быть достаточно неназначенных IP-адресов для выделения каждому запрошенному узлу пула. В противном случае узлы не могут быть созданы.
- Недостаточно ресурсов, когда [пул находится в виртуальной сети](https://docs.microsoft.com/azure/batch/batch-virtual-network).
  - Вы можете создавать ресурсы, такие как балансировщики нагрузки, общедоступные IP-адреса и группы безопасности сети, в той же подписке, что и учетная запись пакетной службы. Убедитесь, что квоты подписки достаточны для этих ресурсов.
- Большие пулы с пользовательскими образами виртуальных машин
  - Для выделения больших пулов, использующих пользовательские образы виртуальных машин, может потребоваться больше времени, из-за чего время ожидания может истечь.  Рекомендации по ограничениям и конфигурации см. в статье [Использование пользовательского образа для создания пула виртуальных машин](https://docs.microsoft.com/azure/batch/batch-custom-images).

### <a name="automatic-scaling-failures"></a>Сбои автоматического масштабирования

Вы также можете настроить пакетную службу Azure для автоматического масштабирования количества узлов в пуле. Вы определяете параметры для [формулы автоматического масштабирования для пула](https://docs.microsoft.com/azure/batch/batch-automatic-scaling). Пакетная служба использует формулу для периодической оценки количества узлов в пуле и установки нового целевого количества. Возможны следующие проблемы.

- Сбой оценки автоматического масштабирования.
- Итоговая операция изменения размера завершается ошибкой и истечением времени ожидания.
- Проблема с формулой автоматического масштабирования приводит к неверным целевым значениям узла. Изменение размера работает, или истекает время ожидания.

Сведения о последней оценке автоматического масштабирования можно получить с помощью свойства [autoScaleRun](https://docs.microsoft.com/rest/api/batchservice/pool/get#autoscalerun). Это свойство сообщает время оценки, значения и результат, а также все ошибки производительности.

Сведения обо всех оценках автоматически фиксируются в [событии завершения изменения размера пула](https://docs.microsoft.com/azure/batch/batch-pool-resize-complete-event).

### <a name="delete"></a>Delete (Удалить)

При удалении пула, содержащего узлы, первый пакет удаляет узлы. Затем он удаляет сам объект пула. Удаление узлов пула может занять несколько минут.

В процессе удаления в качестве [состояния пула](https://docs.microsoft.com/rest/api/batchservice/pool/get#poolstate) пакетная служба указывает значение **deleting** (Удаление). Вызывающее приложение может обнаружить слишком долгое время удаления пула на основе свойств **state** и **stateTransitionTime**.

## <a name="pool-compute-node-errors"></a>Ошибки вычислительных узлов в пуле

Даже когда пакетная служба успешно выделяет узлы в пуле, различные проблемы могут привести к тому, что некоторые узлы будут неработоспособны и непригодны. За эти узлы будет взиматься плата. Важно выявлять проблемы, чтобы не платить за непригодные узлы.

### <a name="start-task-failure"></a>Сбой задачи запуска

Возможно, вы захотите указать необязательную [задачу запуска](https://docs.microsoft.com/rest/api/batchservice/pool/add#starttask) для пула. Как и в любой задаче, вы можете использовать командную строку и файлы ресурсов для загрузки из хранилища. Задача запуска выполняется для каждого узла после его запуска. Свойство **waitForSuccess** указывает, будет ли пакетная служба ждать успешного завершения задачи запуска, прежде чем планировать какие-либо задачи для узла.

Что делать, если вы настроили узел на ожидание успешного завершения задачи запуска, но задача запуска завершилась сбоем? В этом случае узел непригоден, но плата по-прежнему взимается.

Сбои выполнения задачи запуска можно обнаружить с помощью свойств [result](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskexecutionresult) и [failureInfo](https://docs.microsoft.com/rest/api/batchservice/computenode/get#taskfailureinformation) свойства узла верхнего уровня [startTaskInfo](https://docs.microsoft.com/rest/api/batchservice/computenode/get#starttaskinformation).

Неудачное выполнение задачи запуска также приводит к тому, что пакетная служба устанавливает в качестве [состояния](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodestate) узла значение **starttaskfailed**, если для параметра **waitForSuccess** установлено значение **true**.

Как и в любой задаче, может быть множество причин сбоя задачи запуска.  Для устранения неполадок следует проверить файлы журнала stdout, stderr и другие файлы журнала для конкретных задач.

### <a name="application-package-download-failure"></a>Не удалось скачать пакет приложения

Вы можете указать один или несколько пакетов приложений для пула. Пакетная служба загружает указанные файлы пакета на каждый узел и распаковывает файлы после запуска узла, но до планирования задач. Обычно используется командная строка запуска задачи совместно с пакетами приложений. Например, чтобы скопировать файлы в другое место или запустить программу установки.

Сбой при скачивании и распаковке пакета приложения сообщается с помощью свойства узла [errors](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror). Пакетная служба устанавливает состояние узла **unusable** (Непригоден).

### <a name="container-download-failure"></a>Сбой загрузки контейнера

Можно указать одну или несколько ссылок контейнера в пуле. Пакет загружает указанные контейнеры к каждому узлу. Узел [ошибки](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) свойство сообщает об ошибке для загрузки контейнера и устанавливает состояние узла **непригодным для использования**.

### <a name="node-in-unusable-state"></a>Узел с состоянием unusable (Непригоден)

Пакетная служба Azure может установить [состояние узла](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodestate) на **unusable** (Непригоден) по многим причинам. Если состояние узла установлено на **unusable** (Непригоден), задачи для узла не могут быть запланированы, но плата по-прежнему взимается.

Узлы в **unsuable**, но без [ошибки](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) состояние означает, что пакет не удается установить связь с виртуальной Машиной. В этом случае пакет всегда пытается восстановить виртуальную Машину. Пакет не будет пытаться автоматически восстанавливать виртуальные машины, которые не удалось установить пакеты приложений или контейнеров, несмотря на то, что они состоянии **непригодным для использования**.

Если пакетная служба может определить причину, свойство узла [errors](https://docs.microsoft.com/rest/api/batchservice/computenode/get#computenodeerror) сообщает об этом.

Ниже приведены дополнительные примеры возможных причин возникновения состояния узлов **unusable** (Непригоден).

- Образ виртуальной машины является недопустимым. Например, образ подготовлено неправильно.

- Виртуальная машина перемещена из-за сбоя инфраструктуры или обновления нижнего уровня. Пакетная служба восстанавливает узел.

- Образ виртуальной Машины будет развернута на оборудовании, которые не поддерживают его. Например «» образ виртуальной Машины HPC под управлением на оборудовании, отличных от HPC. Например, при попытке запустить образ CentOS HPC [Standard_D1_v2](../virtual-machines/linux/sizes-general.md#dv2-series) виртуальной Машины.

- Виртуальные машины находятся в [виртуальной сети Azure](batch-virtual-network.md), и трафик заблокирован для ключевые порты.

### <a name="node-agent-log-files"></a>Файлы журнала агента узла

Процесс агента пакетной службы, который выполняется на каждом узле пула, может предоставить файлы журналов, которые могут быть полезны, если вам необходимо обратиться в службу поддержки по поводу проблемы с узлом пула. Файлы журнала для узла можно отправить с помощью портала Azure, Batch Explorer или [API](https://docs.microsoft.com/rest/api/batchservice/computenode/uploadbatchservicelogs). Это полезно, когда нужно отправить и сохранить файлы журнала. После этого можно удалить узел или пул, чтобы сэкономить на стоимости работающих узлов.

## <a name="next-steps"></a>Дальнейшие действия

Убедитесь, что в вашем приложении реализована комплексная проверка ошибок, особенно для асинхронных операций. Очень важно своевременно обнаруживать и диагностировать неполадки.
