---
title: Проверка на наличие ошибок в пуле и узле
description: В этой статье рассматриваются фоновые операции, которые могут выполняться, а также проверяемые ошибки и способы их избежания при создании пулов и узлов.
author: mscurrell
ms.author: markscu
ms.date: 08/23/2019
ms.topic: how-to
ms.openlocfilehash: 519b357e4e5fde30221f7dc804bb848ecec9704c
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "85979923"
---
# <a name="check-for-pool-and-node-errors"></a>Проверка на наличие ошибок в пуле и узле

При создании и управлении пулами пакетной службы Azure некоторые операции выполняются немедленно. Тем не менее некоторые операции являются асинхронными и выполняются в фоновом режиме, на что требуется несколько минут.

Процесс обнаружения ошибок для операций, которые выполняются немедленно, довольно прост, так как все ошибки сразу возвращаются через API, интерфейс командной строки или пользовательский интерфейс.

В этой статье рассматриваются фоновые операции, которые могут выполняться для пулов и узлов пулов. Здесь указано, каким образом можно их обнаружить и избежать сбоев.

## <a name="pool-errors"></a>Ошибки пула

### <a name="resize-timeout-or-failure"></a>Время ожидания изменения размера или сбой

При создании пула или изменении размера имеющегося пула вы указываете целевое количество узлов.  Операция создания или изменения размера завершается немедленно, но фактическое выделение новых узлов или удаление существующих может занять несколько минут.  Время ожидания изменения размера указывается в API [создания](/rest/api/batchservice/pool/add) или [изменения размера](/rest/api/batchservice/pool/resize). Если пакетная служба не может получить целевое количество узлов во время ожидания изменения размера, пул переходит в устойчивое состояние и сообщает об ошибках изменения размера.

Свойство [ResizeError](/rest/api/batchservice/pool/get#resizeerror) для самой последней оценки содержит список всех возникших ошибок.

К распространенным причинам ошибок изменения размера относятся следующие.

- Слишком короткое время ожидания изменения размера.
  - В большинстве случаев время ожидания по умолчанию в 15 минут достаточно для выделения или удаления узлов пула.
  - Если вы выделяете большое количество узлов, рекомендуется установить время ожидания изменения размера на 30 минут. Например, при изменении размера более 1000 узлов из образа Azure Marketplace или более 300 узлов из пользовательского образа виртуальной машины.
- Недостаточная квота ядер.
  - Учетная запись пакетной службы ограничена количеством ядер, которые можно выделить во всех пулах. После достижения данной квоты пакетная служба прекращает выделять узлы. Вы [можете увеличить](./batch-quota-limit.md) квоту ядер, чтобы пакет мог выделить больше узлов.
- Недостаточно IP-адресов подсети, когда [пул находится в виртуальной сети](./batch-virtual-network.md).
  - В подсети виртуальной сети должно быть достаточно неназначенных IP-адресов для выделения каждому запрошенному узлу пула. В противном случае узлы не могут быть созданы.
- Недостаточно ресурсов, когда [пул находится в виртуальной сети](./batch-virtual-network.md).
  - Вы можете создавать ресурсы, такие как балансировщики нагрузки, общедоступные IP-адреса и группы безопасности сети, в той же подписке, что и учетная запись пакетной службы. Убедитесь, что квоты подписки достаточны для этих ресурсов.
- Большие пулы с пользовательскими образами виртуальных машин
  - Для выделения больших пулов, использующих пользовательские образы виртуальных машин, может потребоваться больше времени, из-за чего время ожидания может истечь.  Рекомендации по ограничениям и конфигурации см. в статье [Создание пула с использованием службы "Общая коллекция образов"](batch-sig-images.md).

### <a name="automatic-scaling-failures"></a>Сбои автоматического масштабирования

Вы также можете настроить пакетную службу Azure для автоматического масштабирования количества узлов в пуле. Вы определяете параметры для [формулы автоматического масштабирования для пула](./batch-automatic-scaling.md). Пакетная служба использует формулу для периодической оценки количества узлов в пуле и установки нового целевого количества. Возможны следующие проблемы.

- Сбой оценки автоматического масштабирования.
- Итоговая операция изменения размера завершается ошибкой и истечением времени ожидания.
- Проблема с формулой автоматического масштабирования приводит к неверным целевым значениям узла. Изменение размера работает, или истекает время ожидания.

Сведения о последней оценке автоматического масштабирования можно получить с помощью свойства [autoScaleRun](/rest/api/batchservice/pool/get#autoscalerun). Это свойство сообщает время оценки, значения и результат, а также все ошибки производительности.

Сведения обо всех оценках автоматически фиксируются в [событии завершения изменения размера пула](./batch-pool-resize-complete-event.md).

### <a name="delete"></a>DELETE

При удалении пула, содержащего узлы, первый пакет удаляет узлы. Затем он удаляет сам объект пула. Удаление узлов пула может занять несколько минут.

В процессе удаления в качестве [состояния пула](/rest/api/batchservice/pool/get#poolstate) пакетная служба указывает значение **deleting** (Удаление). Вызывающее приложение может обнаружить слишком долгое время удаления пула на основе свойств **state** и **stateTransitionTime**.

## <a name="pool-compute-node-errors"></a>Ошибки вычислительных узлов в пуле

Даже когда пакетная служба успешно выделяет узлы в пуле, различные проблемы могут привести к тому, что некоторые узлы будут неработоспособны и не смогут выполнять задачи. За эти узлы по-прежнему взимается плата, поэтому важно выявлять проблемы, чтобы не платить за узлы, которые невозможно использовать. Помимо распространенных ошибок узлов, для устранения неполадок полезно знать текущее [состояние задания](/rest/api/batchservice/job/get#jobstate).

### <a name="start-task-failures"></a>Сбои задачи запуска

Возможно, вы захотите указать необязательную [задачу запуска](/rest/api/batchservice/pool/add#starttask) для пула. Как и в любой задаче, вы можете использовать командную строку и файлы ресурсов для загрузки из хранилища. Задача запуска выполняется для каждого узла после его запуска. Свойство **waitForSuccess** указывает, будет ли пакетная служба ждать успешного завершения задачи запуска, прежде чем планировать какие-либо задачи для узла.

Что делать, если вы настроили узел на ожидание успешного завершения задачи запуска, но задача запуска завершилась сбоем? В этом случае узел непригоден, но плата по-прежнему взимается.

Сбои выполнения задачи запуска можно обнаружить с помощью свойств [result](/rest/api/batchservice/computenode/get#taskexecutionresult) и [failureInfo](/rest/api/batchservice/computenode/get#taskfailureinformation) свойства узла верхнего уровня [startTaskInfo](/rest/api/batchservice/computenode/get#starttaskinformation).

Неудачное выполнение задачи запуска также приводит к тому, что пакетная служба устанавливает в качестве [состояния](/rest/api/batchservice/computenode/get#computenodestate) узла значение **starttaskfailed**, если для параметра **waitForSuccess** было задано значение **true**.

Как и в любой задаче, может быть множество причин сбоя задачи запуска.  Для устранения неполадок следует проверить файлы журнала stdout, stderr и другие файлы журнала для конкретных задач.

Задачи запуска должны быть повторяемыми, так как задача запуска может выполняться несколько раз на одном узле. Задача запуска выполняется при повторном создании образа узла или его перезагрузке. В редких случаях задача запуска выполняется после того, как событие привело к перезагрузке узла, причем для одной из операционных систем или одного из временных дисков образ был создан повторно, а для других нет. Так как задачи запуска пакетной службы (как и все ее задачи) выполняются с временного диска, обычно это не является проблемой. Однако в некоторых случаях, когда задача запуска устанавливает приложение на диск операционной системы, а другие данные сохраняет на временном диске, это может вызвать проблемы рассинхронизации. Если вы используете оба диска, защитите приложение соответствующим образом.

### <a name="application-package-download-failure"></a>Не удалось скачать пакет приложения

Вы можете указать один или несколько пакетов приложений для пула. Пакетная служба скачивает указанные файлы пакета на каждый узел и распаковывает файлы после запуска узла, но до планирования задач. Обычно используется командная строка запуска задачи совместно с пакетами приложений. Например, чтобы скопировать файлы в другое место или запустить программу установки.

Сбой при скачивании и распаковке пакета приложения сообщается с помощью свойства узла [errors](/rest/api/batchservice/computenode/get#computenodeerror). Узел переходит в состояние **unusable**.

### <a name="container-download-failure"></a>Сбой при скачивании контейнера

В пуле можно указать ссылки на один или несколько контейнеров. Пакетная служба скачивает указанные контейнеры в каждый узел. Сбой при скачивании контейнера сообщается с помощью свойства узла [errors](/rest/api/batchservice/computenode/get#computenodeerror). При этом узел переводится в состояние **unusable**.

### <a name="node-in-unusable-state"></a>Узел с состоянием unusable (Непригоден)

Пакетная служба Azure может установить [состояние узла](/rest/api/batchservice/computenode/get#computenodestate) на **unusable** (Непригоден) по многим причинам. Если состояние узла установлено на **unusable** (Непригоден), задачи для узла не могут быть запланированы, но плата по-прежнему взимается.

Если узел находится в состоянии **unusable**, но не имеет свойства [errors](/rest/api/batchservice/computenode/get#computenodeerror), значит, пакетная служба не может установить связь с виртуальной машиной. В этом случае пакетная служба всегда пытается восстановить виртуальную машину. Пакетная служба не будет автоматически пытаться восстановить виртуальные машины, на которых не удалось установить пакеты приложений или контейнеры, даже если они находятся в состоянии **unusable**.

Если пакетная служба может определить причину, свойство узла [errors](/rest/api/batchservice/computenode/get#computenodeerror) сообщает об этом.

Ниже приведены дополнительные примеры возможных причин возникновения состояния узлов **unusable** (Непригоден).

- Образ виртуальной машины является недопустимым. Например, образ подготовлено неправильно.

- Виртуальная машина перемещена из-за сбоя инфраструктуры или обновления нижнего уровня. Пакетная служба восстанавливает узел.

- Образ виртуальной машины был развернут на оборудовании, которое не поддерживает его. Например, была осуществлена попытка запустить образ CentOS HPC на виртуальной машине [Standard_D1_v2](../virtual-machines/dv2-dsv2-series.md).

- Виртуальные машины находятся в [виртуальной сети Azure](batch-virtual-network.md), и трафик на ключевые порты заблокирован.

- Виртуальные машины находятся в виртуальной сети, но исходящий трафик в службу хранилища Azure заблокирован.

- Виртуальные машины находятся в виртуальной сети с конфигурацией DNS клиента, и DNS-серверу не удается разрешить службу хранилища Azure.

### <a name="node-agent-log-files"></a>Файлы журнала агента узла

Процесс агента пакетной службы, выполняемый в каждом узле пула, может предоставлять файлы журналов, которые могут быть полезны при обращении в службу поддержки по поводу проблемы с узлом пула. Файлы журнала для узла можно отправить с помощью портала Azure, Batch Explorer или [API](/rest/api/batchservice/computenode/uploadbatchservicelogs). Это полезно, когда нужно отправить и сохранить файлы журнала. После этого можно удалить узел или пул, чтобы сэкономить на стоимости работающих узлов.

### <a name="node-disk-full"></a>Диск узла заполнен

Временный диск для виртуальной машины узла пула используется пакетной службой для хранения файлов заданий, файлов задач и общих файлов.

- Файлы пакетов приложений
- Файлы ресурсов задач
- Файлы для конкретных приложений, скачиваемые в одну из папок пакетной службы
- Файлы stdout и stderr для каждого выполнения приложения задачи
- Выходные файлы конкретных приложений

Некоторые из этих файлов, например пакеты приложений пула или файлы ресурсов задач запуска в пуле, записываются только один раз при создании узлов пула. Даже если эти файлы записываются только один раз при создании узла, они могут заполнить временный диск, если их размер слишком велик.

Другие файлы записываются для каждой задачи, выполняемой в узле, например stdout и stderr. Если в одном узле выполняется большое количество задач и файлы задач слишком велики, они могут заполнить временный диск.

Размер временного диска зависит от размера виртуальной машины. Одним из соображений при выборе размера виртуальной машины является обеспечение достаточного места на временном диске.

- При добавлении пула на портале Azure можно вывести полный список размеров виртуальных машин со столбцом "Размер диска ресурсов".
- В статьях, в которых описываются размеры виртуальных машин, есть таблицы со столбцом "Временное хранилище". Примером может служить статья [Размеры виртуальных машин, оптимизированных для вычислений](../virtual-machines/sizes-compute.md).

Для файлов, записываемых каждой задачей, можно указать время хранения для каждой задачи. Оно определяет, как долго хранятся файлы задач до автоматической очистки. Время хранения можно уменьшить, чтобы уменьшить требования к хранилищу.


Если на временном диске не хватает места (или место почти закончилось), узел переводится в состояние [Unusable](/rest/api/batchservice/computenode/get#computenodestate) и появляется сообщение об ошибке узла, связанной с заполнением диска.

### <a name="what-to-do-when-a-disk-is-full"></a>Действия при заполнении диска

Определите, почему заполнился диск. Если вы не уверены, что занимает место в узле, рекомендуется удаленно подключиться к нему и исследовать его вручную. Вы также можете использовать [API пакетной службы для вывода списка файлов](/rest/api/batchservice/file/listfromcomputenode), чтобы просмотреть файлы (например, выходные данные задач) в управляемых папках пакетной службы. Обратите внимание, что этот API выводит файлы только из управляемых каталогов пакетной службы. Если задачи создали файлы в других местах, они не будут отображаться.

Убедитесь в том, что все необходимые данные были получены из узла или переданы в постоянное хранилище. Все меры по устранению переполнения диска подразумевают удаление данных для освобождения места.

### <a name="recovering-the-node"></a>Восстановление узла

1. В пуле [C.loudServiceConfiguration](/rest/api/batchservice/pool/add#cloudserviceconfiguration) можно восстановить узел из образа с помощью [API пакетной службы для восстановления из образа](/rest/api/batchservice/computenode/reimage). В результате будет очищен весь диск. В настоящее время восстановление из образа не поддерживается для пулов [VirtualMachineConfiguration](/rest/api/batchservice/pool/add#virtualmachineconfiguration).

2. В пуле [VirtualMachineConfiguration](/rest/api/batchservice/pool/add#virtualmachineconfiguration) можно удалить узел из пула с помощью [API удаления узлов](/rest/api/batchservice/pool/removenodes). Затем можно снова увеличить пул, чтобы заменить неисправный узел на новый.

3.  Удалите давно завершенные задания или задачи, данные которых по-прежнему находятся в узлах. Чтобы узнать, данные каких заданий и задач находятся в узлах, можно обратиться к [коллекции RecentTasks](/rest/api/batchservice/computenode/get#taskinformation) в узле или к [файлам в узле](/rest/api/batchservice/file/listfromcomputenode). Удаление задания приведет к удалению всех его задач, а удаление задач задания приведет к удалению данных из каталогов задач в узле, благодаря чему будет освобождено место. Когда вы освободите достаточно места, перезагрузите узел, после чего он должен перейти из состояния "Непригоден к использованию" в состояние "Неактивен".

## <a name="next-steps"></a>Дальнейшие действия

Убедитесь, что в вашем приложении реализована комплексная проверка ошибок, особенно для асинхронных операций. Очень важно своевременно обнаруживать и диагностировать неполадки.
