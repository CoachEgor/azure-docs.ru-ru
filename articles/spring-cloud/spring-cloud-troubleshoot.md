---
title: Руководство по устранению неполадок для Azure Веснного облака | Документация Майкрософт
description: Руководство по устранению неполадок для Azure Веснного облака
author: jpconnock
ms.service: spring-cloud
ms.topic: troubleshooting
ms.date: 11/04/2019
ms.author: jeconnoc
ms.openlocfilehash: 9603f4a687b55f45be2875ccaa7b801c0c5589c9
ms.sourcegitcommit: c62a68ed80289d0daada860b837c31625b0fa0f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2019
ms.locfileid: "73607630"
---
# <a name="troubleshooting-guide-for-common-problems"></a>Руководство по устранению распространенных неполадок

В этой статье подробно описаны некоторые распространенные проблемы и действия по устранению неполадок для разработчиков, работающих в Azure Веснного облака. Мы также рекомендуем ознакомиться с нашей [статьей о часто задаваемых вопросах](spring-cloud-faq.md).

## <a name="availability-performance-and-application-issues"></a>Проблемы с доступностью, производительностью и приложениями

### <a name="my-application-cannot-start-for-example-the-endpoint-cannot-be-connected-or-returns-502-after-few-retries"></a>Не удается запустить приложение (например, не удается подключиться к конечной точке или возвращает 502 после нескольких попыток)

Экспортируйте журналы в _Azure log Analytics_. Таблица для журналов приложений с пружинами называется `AppPlatformLogsforSpring`. Дополнительные сведения см. в статье [Анализ журналов и метрик с помощью параметров диагностики](diagnostic-services.md) .

Поиск следующей ошибки в журналах указывает на одну из двух вероятных проблем:

`org.springframework.context.ApplicationContextException: Unable to start web server`

* Отсутствует один из конфет или одна из его зависимостей.
* Одно из свойств Bean отсутствует или недопустимо. В этом случае, вероятно, появится `java.lang.IllegalArgumentException`.

Привязки служб также могут вызвать сбои при запуске приложения. Используйте ключевые слова, связанные с привязанными службами, для запроса журналов.  Например, предположим, что приложение имеет привязку к экземпляру MySQL, для которой задано локальное системное время. Если приложение не запускается, в журнале может появиться следующая ошибка:

`java.sql.SQLException: The server time zone value 'Coordinated Universal Time' is unrecognized or represents more than one time zone.`

Чтобы устранить эту ошибку, перейдите в `server parameters` экземпляра MySql и измените `time_zone` с `SYSTEM` на `+0:00`.


### <a name="my-application-crashes-or-throws-an-unexpected-error"></a>Приложение аварийно завершает работу или вызывает непредвиденную ошибку

При отладке сбоев приложений Начните с проверки состояния выполнения и состояния обнаружения приложения. Перейдите в раздел _Управление приложениями_ в _портал Azure, чтобы_обеспечить _работу_ всех приложений.

* Если состояние " _работает_ ", но состояние обнаружения — "не включено _", перейдите_в раздел " [мое приложение" не может быть зарегистрировано](#my-application-cannot-be-registered).

* Если состояние обнаружения — " _работает", перейдите_к разделу _метрики_ , чтобы проверить работоспособность приложения. Проверьте следующие метрики:


  - `TomcatErrorCount` (_Tomcat. Global. Error_). здесь будут учитываться все исключения пружинных приложений. Если это число велико, перейдите в _log Analytics Azure_ , чтобы проверить журналы приложений.

  - `AppMemoryMax` (_виртуальной машины Java. Memory. Max_): максимальный объем памяти, доступный приложению. Он может быть не определен или изменен с течением времени, если он определен. Объем используемой и выделенной памяти всегда будет меньше или равен значению Max, если она определена. Однако выделение памяти может завершиться ошибкой с `OutOfMemoryError` если он пытается увеличить используемую память таким > образом, что при использовании < = Max все равно будет иметь значение true. В такой ситуации попробуйте увеличить максимальный размер кучи с помощью параметра `-Xmx`.

  - `AppMemoryUsed` (_виртуальной машины Java. Memory. used_): объем памяти в байтах, используемый приложением в данный момент. Для обычной загрузки приложения Java эта серия метрик преобразуется в шаблон "савтус", где использование памяти постоянно увеличивается и уменьшается с небольшим шагом, и этот шаблон повторяется. Это происходит из-за сборки мусора внутри виртуальной машины Java, где действия коллекции представляют собой падения на "савтис".
    Эта метрика важна для обнаружения проблем с памятью, например: * развертывание памяти в самом начале * выделение памяти всплеска для конкретного пути логики * постепенное утечки памяти

  Дополнительные сведения см. на странице [метрики](spring-cloud-concept-metrics.md).

Посетите [эту статью Приступая к работе](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) , чтобы приступить к работе с _Azure log Analytics_.

### <a name="my-application-experiences-high-cpu-usage-or-high-memory-usage"></a>В работе приложения высокая загрузка ЦП или высокая загрузка памяти

Если в приложении используется высокая загрузка ЦП или памяти, то выполняется одно из двух условий:
* Все экземпляры приложения имеют высокий уровень использования ЦП/памяти или
* В некоторых экземплярах приложений высокая загрузка ЦП и памяти.

Чтобы подтвердить ситуацию,

1. Перейдите в раздел _метрики_, выберите `Service CPU Usage Percentage` или `Service Memory Used`.
2. Добавьте фильтр `App=`, чтобы указать, какое приложение требуется отслеживать.
3. Разделите метрики на `Instance`.

Если все экземпляры испытывают большой объем ресурсов ЦП или памяти, необходимо либо увеличить масштаб приложения, либо увеличить объем ресурсов ЦП и памяти. Дополнительные сведения см. на странице [масштабирование приложений](spring-cloud-tutorial-scale-manual.md) .

Если некоторые экземпляры испытывают большой объем ресурсов ЦП или памяти, проверьте состояние экземпляра и состояние его обнаружения.

Дополнительные сведения см. на странице [метрики](spring-cloud-concept-metrics.md).

Если все экземпляры работают и работают, перейдите в _Azure log Analytics_ , чтобы запросить журналы приложений и просмотреть логику кода, чтобы определить, может ли любой из них повлиять на секционирование масштабирования. Дополнительные сведения см. в подокне [Анализ журналов и метрик с помощью параметров диагностики](diagnostic-services.md).

Посетите [эту статью Приступая к работе](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) , чтобы приступить к работе с _Azure log Analytics_. Запросите журналы с помощью [языка запросов Kusto](https://docs.microsoft.com/azure/kusto/query/).

### <a name="checklist-before-onboarding-your-spring-application-to-azure-spring-cloud"></a>Контрольный список перед подключением пружинного приложения к Azure Веснного облака

* Приложение может выполняться локально с указанной версией среды выполнения Java.
* Конфигурация среды (ЦП/ОЗУ/Instances) соответствует минимальным требованиям, заданным поставщиком приложения.
* Элементы конфигурации имеют ожидаемые значения. Дополнительные сведения см. в разделе [config Server](spring-cloud-tutorial-config-server.md).
* Переменные среды имеют ожидаемые значения.
* Параметры ВИРТУАЛЬНОЙ машины Java имеют ожидаемые значения.
* Мы рекомендуем отключить или удалить внедренный _сервер конфигурации_ и службу _реестра пружины Service_ из пакета приложения.
* Если какие бы то ни было ресурсы Azure должны быть привязаны через _привязку службы_, убедитесь, что целевые ресурсы работают.

## <a name="configuration-and-management"></a>Настройка и управление

### <a name="i-encountered-a-problem-creating-an-azure-spring-cloud-service-instance"></a>Возникла проблема при создании экземпляра облачной службы Azure весны

При попытке подготавливать экземпляр _облачной службы Azure весны_ с помощью портала Azure веснное облако будет выполнять проверку.

Однако если вы попытаетесь подготавливать экземпляр _облачной службы Azure весны_ с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli) или [шаблона диспетчер ресурсов](https://docs.microsoft.com/azure/azure-resource-manager/), проверьте следующее:

* Подписка активна.
* Это расположение [поддерживается](spring-cloud-faq.md) в _Azure веснного облака_.
* Группа ресурсов для экземпляра уже создана.
* Имя ресурса соответствует правилу именования. (Он может содержать только строчные буквы, цифры и дефисы. Первый символ должен быть буквой. Последний знак должен быть буквой или цифрой. Значение должно иметь длину от 2 до 32 символов.)

Если вы попытаетесь подготавливать экземпляр _облачной службы Azure весны_ через шаблон диспетчер ресурсов, перейдите на https://docs.microsoft.com/azure/azure-resource-manager/resource-group-authoring-templates, чтобы проверить синтаксис шаблона.

Имя экземпляра _облачной службы Azure весны_ будет использоваться для запроса имени поддомена в разделе `azureapps.io`, поэтому инициализация завершится ошибкой, если имя конфликтует с существующим. Дополнительные сведения можно найти в журналах действий.

### <a name="i-cannot-deploy-a-jar-package"></a>Не удается развернуть JAR-пакет

Невозможно передать пакет JAR/Source с помощью портала или шаблона диспетчер ресурсов.

При развертывании пакета приложения с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli)он периодически опрашивает ход развертывания и в итоге отобразит результат развертывания.

Если опрос прерван, вы по-прежнему можете использовать следующую команду для выборки журналов развертывания:

`az spring-cloud app show-deploy-log -n <app-name>`

Убедитесь, что приложение упаковано в правильный [исполняемый формат JAR](https://docs.spring.io/spring-boot/docs/current/reference/html/executable-jar.html). В противном случае отобразится сообщение об ошибке следующего вида:

`Error: Invalid or corrupt jarfile /jar/38bc8ea1-a6bb-4736-8e93-e8f3b52c8714`

### <a name="i-cannot-deploy-a-source-package"></a>Не удается развернуть исходный пакет

Невозможно передать пакет JAR/Source с помощью портала или шаблона диспетчер ресурсов.

При развертывании пакета приложения, продуманного [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli), он периодически опрашивает ход развертывания и в итоге отобразит результат развертывания.

Если опрос прерван, вы по-прежнему можете использовать следующую команду для выборки журналов сборки и развертывания:

`az spring-cloud app show-deploy-log -n <app-name>`

Однако обратите внимание, что один экземпляр _облачной службы Azure весны_ может одновременно запускать только одно задание сборки для одного исходного пакета. Дополнительные сведения см. в руководстве по [развертыванию приложения](spring-cloud-quickstart-launch-app-portal.md) и [промежуточной среды](spring-cloud-howto-staging-environment.md).

### <a name="my-application-cannot-be-registered"></a>Не удается зарегистрировать приложение

В большинстве случаев это происходит, когда необходимые зависимости/обнаружение служб неправильно настроены в файл POM. После настройки встроенная конечная точка сервера реестра службы будет внедрена в приложение в качестве переменной среды. Затем приложения регистрируются на сервере реестра службы и обнаруживают другие зависимые микрослужбы.

Подождите по крайней мере 2 минуты, прежде чем вновь зарегистрированный экземпляр начнет получать трафик.

Если вы переносите существующее облачное решение на основе весны в Azure, убедитесь, что экземпляры реестра и _сервера конфигурации_ нерегламентированных _служб_ удалены (или отключены), чтобы избежать конфликтов с управляемыми экземплярами, предоставляемыми _Azure веснным облаком._ .

Вы также можете проверить журналы клиента _реестра службы_ в _log Analytics Azure_. Дополнительные сведения см. в подокне [Анализ журналов и метрик с помощью параметров диагностики](diagnostic-services.md) .

Посетите [эту статью Приступая к работе](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) , чтобы приступить к работе с _Azure log Analytics_. Запросите журналы с помощью [языка запросов Kusto](https://docs.microsoft.com/azure/kusto/query/).

### <a name="i-want-to-inspect-my-applications-environment-variables"></a>Я хочу проверить переменные среды моего приложения

Переменные среды сообщают о предварительной облачной платформе Azure, гарантируя, что Azure распознает, где и как настроить службы, составляющие приложение.  Проверка правильности переменных среды является необходимым первым шагом при устранении потенциальных проблем.  Для просмотра переменных среды можно использовать конечную точку «Весна Boot».  

> [!WARNING]
> Эта процедура предоставляет переменные среды с помощью конечной точки теста.  Не продолжайте, если конечная точка теста является общедоступной или если приложению назначено доменное имя.

1. Перейдите по этому URL-адресу: `https://<your application test endpoint>/actuator/health`.  
    - Ответ, аналогичный `{"status":"UP"}` указывает, что конечная точка включена.
    - Если ответ отрицательный, включите следующую зависимость в `POM.xml`:

        ```xml
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-actuator</artifactId>
            </dependency>
        ```

1. Если конечная точка конечного загрузчика включена, перейдите в портал Azure и найдите страницу конфигурации приложения.  Добавьте переменную среды с именем `MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE` и значением `*`. 

1. Перезапустите приложение.

1. Перейдите к `https://<the test endpoint of your app>/actuator/env` и проверьте ответ.  Результат будет выглядеть так:

    ```json
    {
        "activeProfiles": [],
        "propertySources": {,
            "name": "server.ports",
            "properties": {
                "local.server.port": {
                    "value": 1025
                }
            }
        }
    }
    ```

Найдите дочерний узел с именем `systemEnvironment`.  Этот узел содержит переменные среды приложения.

> [!IMPORTANT]
> Не забывайте отменять раскрытие переменных среды перед тем, как сделать приложение доступным для общего доступа.  Перейдите в портал Azure, найдите страницу конфигурации приложения и удалите эту переменную среды: `MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE`.

### <a name="i-cannot-find-metrics-or-logs-for-my-application"></a>Не удается найти метрики или журналы моего приложения

Перейдите в раздел _Управление приложениями_ _, чтобы_убедиться, что приложение _работает_ .

Если вы видите метрики из _виртуальной машины Java_ , но не метрики из _Tomcat_, проверьте, включена ли зависимость`spring-boot-actuator` в пакете приложения и успешно загружается.

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

Если журналы приложения можно архивировать в учетную запись хранения, но не отправляются в _Azure log Analytics_, проверьте [правильность настройки рабочей области](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace). Если вы используете бесплатный уровень _log Analytics Azure_, обратите внимание, что [уровень "бесплатный" не обеспечивает соглашение об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/log-analytics/v1_3/).