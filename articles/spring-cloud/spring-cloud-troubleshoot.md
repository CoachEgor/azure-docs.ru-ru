---
title: Руководство по устранению неполадок для Azure Spring Cloud | Документация Майкрософт
description: Руководство по устранению неполадок для Azure Spring Cloud
services: spring-cloud
author: v-vasuke
manager: gwallace
editor: ''
ms.service: spring-cloud
ms.topic: quickstart
ms.date: 10/07/2019
ms.author: v-vasuke
ms.openlocfilehash: ebb960085691206b096090813636ef56366e6536
ms.sourcegitcommit: d773b5743cb54b8cbcfa5c5e4d21d5b45a58b081
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/08/2019
ms.locfileid: "72038363"
---
# <a name="troubleshooting-guide-for-common-problems"></a>Руководство по устранению распространенных проблем

В этой статье подробно описаны некоторые распространенные проблемы и шаги по устранению неполадок для разработчиков, работающих в Azure Spring Cloud. Мы также рекомендуем прочитать нашу [статью с часто задаваемыми вопросами](spring-cloud-faq.md).

## <a name="availability-performance-and-application-issues"></a>Проблемы с доступностью, производительностью и приложениями

### <a name="my-application-cannot-start-for-example-the-endpoint-cannot-be-connected-or-returns-502-after-few-retries"></a>Не удается запустить приложение (например, невозможно подключить конечную точку или после нескольких попыток возникает ошибка 502)

Экспортируйте журналы в _Azure Log Analytics_. Таблица для журналов приложений Spring называется `AppPlatformLogsforSpring`. Дополнительные сведения см. в статье [Analyze logs and metrics with Diagnostic settings](diagnostic-services.md) (Анализ журналов и метрик с помощью параметров диагностики).

Обнаружение следующей ошибки в ваших журналах указывает на одну из двух вероятных проблем:

`org.springframework.context.ApplicationContextException: Unable to start web server`

* отсутствует один из компонентов или одна из его зависимостей;
* одно из свойств компонента отсутствует или недопустимо. Скорее всего, в этом случае вы увидите `java.lang.IllegalArgumentException`.

Привязки служб также могут привести к сбоям при запуске приложения. Отправьте запрос к журналам, используя ключевые слова, связанные с привязанными службами.  Например, предположим, что приложение имеет привязку к экземпляру MySQL, для которого установлено локальное системное время. Если приложение не запускается, вы можете обнаружить следующую ошибку в журнале:

`java.sql.SQLException: The server time zone value 'Coordinated Universal Time' is unrecognized or represents more than one time zone.`

Чтобы исправить эту проблему, перейдите к `server parameters` экземпляра MySQL и измените значение `time_zone` с `SYSTEM` на `+0:00`.


### <a name="my-application-crashes-or-throws-an-unexpected-error"></a>В приложении происходит сбой или возникает непредвиденная ошибка

При сбое отладки приложения проверьте сначала состояние выполнения и статус обнаружения приложения. Перейдите к разделу _Управление приложениями_ на портале Azure, чтобы убедиться, что для всех приложений установлен статус _Выполняется_ и _Работает_.

* Если установлен статус _Выполняется_, но для статуса обнаружения не установлено значение _Работает_, перейдите к разделу [Не удается зарегистрировать приложение](#my-application-cannot-be-registered).

* Если для состояния обнаружения отображается значение _Работает_, перейдите к разделу _Метрики_ и просмотрите работоспособность приложения. Проверьте следующие метрики:


  - `TomcatErrorCount` (_tomcat.global.error_). Здесь будут перечислены все исключения приложения Spring. Если это число большое, перейдите в службу _Azure Log Analytics_ и проверьте журналы приложений.

  - `AppMemoryMax` (_jvm.memory.max_). Максимальный объем памяти, доступный приложению. Он может быть не определен, а определенное значение может измениться со временем. Объем используемой и выделенной памяти всегда будет меньше или равен максимальному значению, если оно определено. Однако, распределение памяти может завершиться сбоем с сообщением `OutOfMemoryError`, если были попытки увеличить используемую память, например, используемая память > зафиксированная, даже если использованная память <= максимальная. В таком случае попытайтесь увеличить максимальный размер кучи с помощью параметра `-Xmx`.

  - `AppMemoryUsed` (_jvm.memory.used_). Объем используемой приложением памяти в байтах. Для нормальной загрузки приложения Java этот ряд метрик преобразуется в "пилообразный" шаблон, в котором использование памяти постоянно увеличивается и уменьшается с небольшим приращением, а также резко падает, и этот шаблон повторяется. Это происходит из-за сборки мусора на виртуальной машине Java, где действия сборки представляют собой падения в "пилообразном" шаблоне.
    Эта метрика необходима для определения проблем с памятью, таких как: * увеличение памяти в начале; * увеличение распределения памяти для определенного пути логики; * постепенная утечка памяти.

  Дополнительные сведения см. в статье [Metrics for Azure Spring Cloud](spring-cloud-concept-metrics.md) (Метрики для Azure Spring Cloud).

Ознакомьтесь с [этой статьей по началу работы](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) с _Azure Log Analytics_.

### <a name="my-application-experiences-high-cpu-usage-or-high-memory-usage"></a>В приложении наблюдается высокая загрузка ЦП или интенсивное потребление памяти

Если в приложении наблюдается высокая загрузка ЦП или интенсивное потребление памяти, возникает одно из двух событий:
* все экземпляры приложения имеют высокий уровень загрузки ЦП и потребления памяти;
* в некоторых экземплярах приложений высокая загрузка ЦП или показатель потребления памяти.

Чтобы определить, что это за ситуация:

1. Перейдите в раздел _Метрики_ и выберите `Service CPU Usage Percentage` или `Service Memory Used`.
2. Добавьте фильтр `App=`, чтобы указать, какое приложение нужно отслеживать.
3. Разделите метрики по `Instance`.

Если все экземпляры имеют высокий уровень загрузки ЦП или потребления памяти, необходимо либо расширить приложение, либо увеличить объем памяти или ЦП. Дополнительные сведения см. в статье [Учебник по масштабированию приложения в Azure Spring Cloud](spring-cloud-tutorial-scale-manual.md).

Если некоторые из экземпляров имеют высокий уровень загрузки ЦП или потребления памяти, проверьте состояние экземпляра и состояние его обнаружения.

Дополнительные сведения см. в статье [Metrics for Azure Spring Cloud](spring-cloud-concept-metrics.md) (Метрики для Azure Spring Cloud).

Если все экземпляры работают, перейдите в _службу Azure Log Analytics_, запросите в ней журналы приложений и просмотрите логику кода, чтобы определить, влияет ли что-либо из этого на секционирование при масштабировании. Дополнительные сведения см. в статье [Analyze logs and metrics with Diagnostic settings](diagnostic-services.md) (Анализ журналов и метрик с помощью параметров диагностики).

Ознакомьтесь с [этой статьей по началу работы](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) с _Azure Log Analytics_. Выполните запрос к журналам, используя [язык запросов Kusto](https://docs.microsoft.com/azure/kusto/query/).

### <a name="checklist-before-onboarding-your-spring-application-to-azure-spring-cloud"></a>Контрольный список для подключения приложения Spring к Azure Spring Cloud

* Приложение можно запустить локально с указанной версией среды выполнения Java.
* Конфигурация среды (ЦП, ОЗУ и экземпляры) соответствует минимальному набору требований поставщика приложений.
* Для элементов конфигурации установлены ожидаемые значения. Дополнительные сведения см. в статье [Учебник по настройке сервера конфигурации Spring Cloud для вашей службы](spring-cloud-tutorial-config-server.md).
* Для переменных среды установлены ожидаемые значения.
* Для параметров виртуальной машины Java установлены ожидаемые значения.
* Советуем отключить или удалить внедренный _сервер конфигурации_ и службу _Spring Service Registry_ из пакета приложения.
* Если к любым ресурсам Azure нужно применить _привязку службы_, убедитесь, что целевые ресурсы работают.

## <a name="configuration-and-management"></a>Настройка и управление

### <a name="i-encountered-a-problem-creating-an-azure-spring-cloud-service-instance"></a>Возникла проблема при создании экземпляра службы Azure Spring Cloud

При попытке подготовить экземпляр службы _Azure Spring Cloud_ с помощью портала Azure Spring Cloud выполняет проверку.

Но если вы попытаетесь подготовить экземпляр службы _Azure Spring Cloud_ с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli) или [шаблона Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/), проверьте следующее:

* подписка активна;
* это расположение [поддерживается](spring-cloud-faq.md) в _Azure Spring Cloud_;
* группа ресурсов для экземпляра уже создана;
* имя ресурса соответствует правилу именования. (Оно может содержать только строчные буквы, цифры и дефисы. Первый символ должен быть буквой. Последний знак должен быть буквой или цифрой. Длина значения должна быть от 2 до 32 символов.)

Если вы попытаетесь подготовить экземпляр службы _Azure Spring Cloud_ с помощью шаблона Resource Manager, посетите страницу https://docs.microsoft.com/azure/azure-resource-manager/resource-group-authoring-templates, чтобы проверить синтаксис шаблона.

Имя экземпляра службы _Azure Spring Cloud_ будет использоваться для запроса имени дочернего домена в домене `azureapps.io`, поэтому если имя конфликтует с имеющимся, подготовка завершится ошибкой. Дополнительные сведения можно найти в журналах действий.

### <a name="i-cannot-deploy-a-jar-package"></a>Не удается развернуть JAR-пакет

Вы не можете отправить исходный или JAR-пакет с помощью портала или шаблона Resource Manager.

При развертывании пакета приложения с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli) будет выполняться периодический опрос с отображением результатов развертывания.

Если опрос будет прерван, вы сможете выполнить приведенную ниже команду для получения журналов развертывания.

`az spring-cloud app show-deploy-log -n <app-name>`

Убедитесь, что приложение упаковано в правильный [исполняемый JAR-формат](https://docs.spring.io/spring-boot/docs/current/reference/html/executable-jar.html). В противном случае отобразится сообщение об ошибке, подобное приведенному ниже.

`Error: Invalid or corrupt jarfile /jar/38bc8ea1-a6bb-4736-8e93-e8f3b52c8714`

### <a name="i-cannot-deploy-a-source-package"></a>Не удается развернуть пакет источника

Вы не можете отправить исходный или JAR-пакет с помощью портала или шаблона Resource Manager.

При развертывании пакета приложения с помощью [Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli) будет выполняться периодический опрос с отображением результатов развертывания.

Если опрос будет прерван, вы сможете выполнить приведенную ниже команду для получения сборки и журналов развертывания.

`az spring-cloud app show-deploy-log -n <app-name>`

Однако обратите внимание, что один экземпляр службы _Azure Spring Cloud_ может одновременно запускать только одно задание сборки для одного пакета источника. Дополнительные сведения см. в статье [Quickstart: Launch an Azure Spring Cloud application using the Azure portal](spring-cloud-quickstart-launch-app-portal.md) (Краткое руководство. Запуск приложения Azure Spring Cloud с помощью портала Azure) и в [руководстве по работе с промежуточной средой](spring-cloud-howto-staging-environment.md).

### <a name="my-application-cannot-be-registered"></a>Не удается зарегистрировать приложение

В большинстве случаев это происходит, когда необходимые зависимости или обнаружение служб неправильно настроены в файле POM. После настройки встроенная конечная точка сервера Service Registry будет внедрена в приложение в качестве переменной среды. После этого приложения смогут зарегистрироваться на сервере Service Registry и обнаружить другие зависимые микрослужбы.

Новый зарегистрированный экземпляр начнет принимать трафик как минимум через 2 минуты.

Если вы переносите имеющееся решение на основе Spring Cloud в Azure, убедитесь, что специализированные экземпляры _Service Registry_ и _сервера конфигурации_ удалены (или отключены), чтобы избежать конфликта с управляемыми экземплярами, предоставляемыми в _Azure Spring Cloud_.

Вы также можете проверить журналы клиента _Service Registry_ в _службе Azure Log Analytics_. Дополнительные сведения см. в статье [Analyze logs and metrics with Diagnostic settings](diagnostic-services.md) (Анализ журналов и метрик с помощью параметров диагностики).

Ознакомьтесь с [этой статьей по началу работы](https://docs.microsoft.com/azure/azure-monitor/log-query/get-started-portal) с _Azure Log Analytics_. Выполните запрос к журналам, используя [язык запросов Kusto](https://docs.microsoft.com/azure/kusto/query/).

### <a name="i-cannot-find-metrics-or-logs-for-my-application"></a>Не удается найти метрики или журналы для приложения

Перейдите к разделу _Управление приложениями_, чтобы убедиться, что для всех приложений установлен статус _Выполняется_ и _Работает_.

Если отображаются метрики с _виртуальной машины Java_, но нет метрик из _Tomcat_, проверьте, включена ли зависимость `spring-boot-actuator` в пакете приложения и успешно ли выполнена загрузка.

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

Если журналы приложения можно архивировать в учетную запись хранения, но нельзя отправить в _Azure Log Analytics_, проверьте, [правильно ли настроена рабочая область](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace). Если вы используете _Azure Log Analytics_ ценовой категории "Бесплатный", учитывайте, что в [этой категории не предоставляется Соглашение об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/log-analytics/v1_3/).