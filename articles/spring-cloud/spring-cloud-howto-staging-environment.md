---
title: Настройка промежуточной среды в Azure Spring Cloud | Документация Майкрософт
description: Узнайте, как использовать развертывание по методу Blue-Green с помощью Azure Spring Cloud
author: jpconnock
ms.service: spring-cloud
ms.topic: conceptual
ms.date: 10/31/2019
ms.author: jeconnoc
ms.openlocfilehash: cd1573a3d896f3d2d5cb53130d8fac86be43beb6
ms.sourcegitcommit: 5cfe977783f02cd045023a1645ac42b8d82223bd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2019
ms.locfileid: "74152087"
---
# <a name="set-up-a-staging-environment-in-azure-spring-cloud"></a>Настройка промежуточной среды в облаке Azure весны

В этой статье описывается настройка промежуточного развертывания с помощью шаблона развертывания "синий-зеленый" в Azure Веснного облака. Здесь также показано, как разместить промежуточное развертывание в рабочей среде, не изменяя рабочее развертывание напрямую.

## <a name="prerequisites"></a>предварительным требованиям

В этой статье предполагается, что вы уже развернули приложение Пиггиметрикс из нашего [руководства по запуску облачного приложения Azure весны](spring-cloud-quickstart-launch-app-portal.md). Пиггиметрикс состоит из трех приложений: "шлюз", "учетная запись-служба" и "auth-Service".  

Если вы хотите использовать другое приложение в этом примере, необходимо внести простое изменение в общедоступную часть приложения.  Это изменение отличает промежуточное развертывание от развертывания в рабочей среде.

>[!TIP]
> Azure Cloud Shell — это бесплатная интерактивная оболочка, которую можно использовать для выполнения инструкций, описанных в этой статье.  Он содержит общие, предварительно установленные инструменты Azure, включая последние версии Git, JDK, Maven и Azure CLI. Если вы вошли в подписку Azure, запустите [Azure Cloud Shell](https://shell.azure.com).  Дополнительные сведения см. в разделе [обзор Azure Cloud Shell](../cloud-shell/overview.md).

Чтобы настроить промежуточную среду в Azure Веснного облака, следуйте инструкциям в следующих разделах.

## <a name="install-the-azure-cli-extension"></a>Установка расширения Azure CLI

Установите расширение Azure Spring Cloud для Azure CLI с помощью следующей команды:

```azurecli
az extension add --name spring-cloud
```
    
## <a name="view-all-deployments"></a>Просмотр всех развертываний

Перейдите к экземпляру службы в портал Azure и выберите **Управление развертыванием** , чтобы просмотреть все развертывания. Для просмотра дополнительных сведений можно выбрать каждое развертывание.

## <a name="create-a-staging-deployment"></a>Создание промежуточного развертывания

1. В локальной среде разработки внесите небольшие изменения в приложение шлюза Пиггиметрикс. Например, измените цвет в файле *Gateway/src/Main/Resources/static/CSS/Launch. CSS* . Это позволяет легко различать два развертывания. Чтобы создать пакет JAR, выполните следующую команду: 

    ```azurecli
    mvn clean package
    ```

1. В Azure CLI создайте новое развертывание и присвойте ему имя промежуточного развертывания "Green".

    ```azurecli
    az spring-cloud app deployment create -g <resource-group-name> -s <service-instance-name> --app gateway -n green --jar-path gateway/target/gateway.jar
    ```

1. После успешного завершения развертывания откройте страницу шлюза на **панели мониторинга приложения**и просмотрите все экземпляры на вкладке **экземпляры приложения** слева.
  
> [!NOTE]
> Состояние обнаружения — *OUT_OF_SERVICE* , поэтому трафик не будет направляться в это развертывание до завершения проверки.

## <a name="verify-the-staging-deployment"></a>Проверка промежуточного развертывания

1. Вернитесь на страницу **Управление развертыванием** и выберите новое развертывание. Для состояния развертывания должно отображаться значение *Выполняется*. Кнопка **назначить или отменить назначение домена** должна отображаться серым цветом, так как среда является промежуточной.

1. В области **Обзор** вы увидите **конечную точку теста**. Скопируйте и вставьте его в новое окно браузера, после чего должна отобразиться новая страница Пиггиметрикс.

>[!TIP]
> * Убедитесь, что конечная точка теста заканчивается косой чертой (/), чтобы убедиться, что CSS-файл загружен правильно.  
> * Если в браузере для просмотра страницы требуется ввести учетные данные, используйте параметр [Декодировать в URL-адресе](https://www.urldecoder.org/) для декодирования тестовой конечной точки. При декодировании в URL-адресе возвращается URL-адрес в формате https://\<username>:\<password>@\<cluster-name>.test.azureapps.io/gateway/green.  Используйте эту форму для доступа к конечной точке.

>[!NOTE]    
> Параметры сервера конфигурации применяются как к промежуточной, так и рабочей среде. Например, если задать путь контекста (`server.servlet.context-path`) для шлюза приложений на сервере конфигурации как *сомепас*, путь к зеленому развертыванию изменится на "https://\<имя_пользователя >:\<пароль > @\<Cluster-Name >. Test. азуреаппс. IO/шлюз/Green/сомепас/...".
 
 Если на этом этапе посетить общедоступный шлюз приложений, вы увидите старую страницу без новых изменений.
    
## <a name="set-the-green-deployment-as-the-production-environment"></a>Установка зеленого развертывания в качестве рабочей среды

1. После проверки изменений в промежуточной среде ее можно отправить в рабочую среду. Вернитесь в окно **Управление развертыванием**и установите флажок Приложение **шлюза** .

2. Выберите **задать развертывание**.
3. В списке **рабочее развертывание** выберите **зеленый**и нажмите кнопку **Применить**.
4. Перейдите на страницу **Обзор** приложения шлюза. Если вы уже назначили домен для приложения шлюза, URL-адрес появится в области **Обзор** . Чтобы просмотреть измененную страницу Пиггиметрикс, выберите URL-адрес и перейдите на сайт.

>[!NOTE]
> После настройки зеленого развертывания в качестве рабочей среды, предыдущее развертывание станет промежуточным развертыванием.

## <a name="modify-the-staging-deployment"></a>Изменение промежуточного развертывания

Если вы не удовлетворены изменениями, вы можете изменить код приложения, создать новый пакет JAR и передать его в зеленое развертывание с помощью Azure CLI.

```azurecli
az spring-cloud app deploy  -g <resource-group-name> -s <service-instance-name> -n gateway -d green --jar-path gateway.jar
```

## <a name="delete-the-staging-deployment"></a>Удаление промежуточного развертывания

Чтобы удалить промежуточное развертывание из порта Azure, перейдите на страницу промежуточного развертывания, а затем нажмите кнопку **Удалить** .

Кроме того, можно удалить промежуточное развертывание из Azure CLI, выполнив следующую команду:

```azurecli
az spring-cloud app deployment delete -n <staging-deployment-name> -g <resource-group-name> -s <service-instance-name> --app gateway
```
