---
title: Настройка промежуточной среды в облаке Azure весны | Документация Майкрософт
description: Узнайте, как использовать развертывание с голубым зеленым цветом с помощью Azure Веснного облака.
author: jpconnock
ms.service: spring-cloud
ms.topic: conceptual
ms.date: 10/31/2019
ms.author: jeconnoc
ms.openlocfilehash: 24ce4dee04e4daf3eaee4144f8dc56de5867bbca
ms.sourcegitcommit: c62a68ed80289d0daada860b837c31625b0fa0f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2019
ms.locfileid: "73607207"
---
# <a name="how-to-set-up-a-staging-environment"></a>Настройка промежуточной среды

В этой статье показано, как использовать промежуточное развертывание с помощью шаблона развертывания "синий-зеленый" в Azure Веснного облака. Также будет показано, как разместить промежуточное развертывание в рабочей среде, не изменяя рабочее развертывание напрямую.

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы уже развернули приложение Пиггиметрикс из нашего [руководства по запуску приложения](spring-cloud-quickstart-launch-app-portal.md). Пиггиметрикс состоит из трех приложений: "шлюз", "Account-Service" и "auth-Service".  

Если у вас есть другое приложение, которое вы хотите использовать в этом примере, необходимо внести простое изменение в общедоступную часть приложения.  Это изменение отличает промежуточное развертывание от рабочей среды.

>[!TIP]
> Azure Cloud Shell — это бесплатная интерактивная оболочка, с помощью которой можно выполнять действия, описанные в этой статье.  Он содержит общие предварительно установленные инструменты Azure, включая последние версии Git, JDK, Maven и Azure CLI. Если вы выполнили вход в подписку Azure, запустите [Azure Cloud Shell](https://shell.azure.com) из Shell.Azure.com.  Дополнительные сведения о Azure Cloud Shell можно получить, [прочитав нашу документацию](../cloud-shell/overview.md)

Для выполнения этой статьи:


## <a name="install-the-azure-cli-extension"></a>Установка расширения Azure CLI

Установите расширение Azure Веснного облака для Azure CLI с помощью следующей команды.

```azurecli
az extension add --name spring-cloud
```
    
## <a name="view-all-deployments"></a>Просмотреть все развертывания

Перейдите к экземпляру службы в портал Azure и выберите **Управление развертыванием** , чтобы просмотреть все развертывания. Для получения дополнительных сведений можно выбрать каждое развертывание.

## <a name="create-a-staging-deployment"></a>Создание промежуточного развертывания

1. В локальной среде разработки внесите небольшие изменения в приложение шлюза свинка. Например, измените цвет в `gateway/src/main/resources/static/css/launch.css`. Это позволит легко различать два развертывания. Выполните следующую команду, чтобы выполнить сборку JAR-пакета: 

    ```azurecli
    mvn clean package
    ```

1. Создайте новое развертывание с Azure CLI, указав имя промежуточного развертывания "Green".

    ```azurecli
    az spring-cloud app deployment create -g <resource-group-name> -s <service-instance-name> --app gateway -n green --jar-path gateway/target/gateway.jar
    ```

1. После успешного завершения развертывания откройте страницу шлюза на **панели мониторинга приложения** и просмотрите все экземпляры на вкладке **экземпляры приложения** в левой части экрана.
  
> [!NOTE]
> Состояние обнаружения — "OUT_OF_SERVICE", поэтому трафик не будет направляться в это развертывание до завершения проверки.

## <a name="verify-the-staging-deployment"></a>Проверка промежуточного развертывания

1. Вернитесь на страницу **управления развертыванием** и выберите новое развертывание. В состоянии развертывания должно отображаться состояние **работает**. Кнопка "назначить или отменить назначение домена" будет отключена, так как это промежуточная среда.

1. На странице **Обзор** вы увидите **конечную точку теста**. Скопируйте и вставьте его на новую страницу браузера, после чего отобразится страница "новые метрики свинка".

>[!TIP]
> * Убедитесь, что конечная точка теста заканчивается на "/", чтобы обеспечить правильную загрузку CSS.  
> * Если в браузере требуется ввести учетные данные входа для просмотра страницы, используйте [декодирование URL-адреса](https://www.urldecoder.org/) для декодирования конечной точки теста. Декодирование URL-адреса возвращает URL-адрес в формате "https://\<имя_пользователя >:\<password > @\<кластер-name >. Test. азуреаппс. IO/шлюз/Green".  Используйте этот способ для доступа к конечной точке.

>[!NOTE]    
> Параметры сервера конфигурации применяются к промежуточной среде, а также рабочим средам. Например, если задать путь контекста (`server.servlet.context-path`) для шлюза приложений на сервере конфигурации в качестве *сомепас*, то путь к зеленому развертыванию изменится: "https://\<имя_пользователя >:\<пароль > @\<Cluster-Name >. test.azureapps.io/gateway/green/somepath/... "
 
 Если на этом этапе посетить общедоступный шлюз приложений, вы увидите старую страницу без внесенных изменений.
    
## <a name="set-the-green-as-production-deployment"></a>Задание зеленого в качестве рабочего развертывания

1. Проверив изменения в промежуточной среде, вы можете отправить ее в рабочую среду. Вернитесь в **Управление развертыванием** и установите флажок перед приложением "шлюз".
2. Выберите "задать развертывание".
3. Выберите "зеленый" в меню "рабочее развертывание" и нажмите кнопку " **Применить** ".
4. Перейдите на страницу **обзора** приложения шлюза. Если вы уже назначили домен для приложения шлюза, URL-адрес появится на странице **обзора** . Перейдите по URL-адресу, и вы увидите страницу измененные метрики свинка.

>[!NOTE]
> После настройки зеленого развертывания на рабочую среду предыдущее развертывание становится промежуточным развертыванием.

## <a name="modify-the-staging-deployment"></a>Изменение промежуточного развертывания

Если вы не удовлетворены изменениями, вы можете изменить код приложения, создать новый пакет JAR и передать его в зеленое развертывание с помощью Azure CLI.

```azurecli
az spring-cloud app deploy  -g <resource-group-name> -s <service-instance-name> -n gateway -d green --jar-path gateway.jar
```

## <a name="delete-a-staging-deployment"></a>Удаление промежуточного развертывания

Удалите промежуточное развертывание из порта Azure, перейдя на страницу промежуточного развертывания и нажав кнопку **Удалить** .

Кроме того, удалите промежуточное развертывание из Azure CLI с помощью следующей команды:

```azurecli
az spring-cloud app deployment delete -n <staging-deployment-name> -g <resource-group-name> -s <service-instance-name> --app gateway
```
