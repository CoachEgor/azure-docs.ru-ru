---
title: Настройка промежуточной среды в Azure Spring Cloud | Документация Майкрософт
description: Узнайте, как использовать развертывание по методу Blue-Green с помощью Azure Spring Cloud
services: spring-cloud
author: v-vasuke
manager: gwallace
editor: ''
ms.service: spring-cloud
ms.topic: quickstart
ms.date: 10/07/2019
ms.author: v-vasuke
ms.openlocfilehash: 454eeaa2568891ec35fe698cdb20c5448e10887e
ms.sourcegitcommit: d773b5743cb54b8cbcfa5c5e4d21d5b45a58b081
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/08/2019
ms.locfileid: "72038303"
---
# <a name="how-to-set-up-a-staging-environment"></a>Настройка промежуточной среды

В этой статье описано, как использовать промежуточное развертывание по шаблону развертывания Blue-Green в Azure Spring Cloud. Здесь также будет описано, как внедрить это промежуточное развертывание в производство без непосредственного изменения развертывания в рабочей среде.

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы уже развернули приложение PiggyMetrics из нашего [учебника по запуску приложения](spring-cloud-quickstart-launch-app-portal.md). PiggyMetrics включает три приложения: gateway, account-service и auth-service.  

Если у вас есть другое приложение, которое вы хотели бы использовать для этого примера, необходимо будет внести простые изменения в общедоступную часть приложения.  Это изменение отличает промежуточное развертывание от развертывания в рабочей среде.

>[!NOTE]
> Прежде чем приступить к работе с этим кратким руководством, убедитесь, что ваша подписка Azure имеет доступ к Azure Spring Cloud.  Так как служба находится на этапе предварительной версии, свяжитесь с нами, чтобы мы добавили вашу подписку в список разрешенных.  Если вы хотите изучить возможности Azure Spring Cloud, свяжитесь с нами по электронной почте: azure-spring-cloud@service.microsoft.com.

>[!TIP]
> Azure Cloud Shell — это бесплатная интерактивная оболочка, с помощью которой можно выполнять действия, описанные в этой статье.  Она содержит предварительно установленные общие инструменты Azure вместе с новейшими версиями Git, JDK, Maven и Azure CLI. Если вы вошли в подписку Azure, запустите [Azure Cloud Shell](https://shell.azure.com) на сайте shell.azure.com.  Дополнительные сведения об Azure Cloud Shell см. в [нашей документации](../cloud-shell/overview.md)

Для работы с этой статьей необходимо сделать следующее:

1. [установите Git](https://git-scm.com/);
1. [установите JDK версии 8](https://docs.microsoft.com/java/azure/jdk/?view=azure-java-stable);
1. [установите Maven 3.0 или более поздней версии](https://maven.apache.org/download.cgi);
1. [Установка Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest)
1. [зарегистрируйтесь для получения подписки Azure](https://azure.microsoft.com/free/).

## <a name="install-the-azure-cli-extension"></a>Установка расширения Azure CLI

Установите расширение Azure Spring Cloud для Azure CLI с помощью следующей команды:

```azurecli
az extension add -y --source https://azureclitemp.blob.core.windows.net/spring-cloud/spring_cloud-0.1.0-py2.py3-none-any.whl
```
    
## <a name="view-all-deployments"></a>Просмотр всех развертываний

Перейдите к экземпляру службы на портале Azure и выберите **Управление развертыванием**, чтобы просмотреть все развертывания. Для получения подробных сведений можно выбрать каждое развертывание отдельно.

## <a name="create-a-staging-deployment"></a>Создание промежуточного развертывания

1. В локальной среде разработки внесите небольшие изменения в приложение шлюза Piggy Metric. Например, измените цвет в `gateway/src/main/resources/static/css/launch.css`. Благодаря этому вы сможете легко различать два развертывания. Выполните следующую команду, чтобы собрать JAR-пакет: 

    ```azurecli
    mvn clean package
    ```

1. Создайте развертывание с помощью Azure CLI, присвоив ему имя промежуточного развертывания green.

    ```azurecli
    az spring-cloud app deployment create -g <resource-group-name> -s <service-instance-name> --app gateway -n green --jar-path gateway/target/gateway.jar
    ```

1. После успешного завершения развертывания перейдите на страницу шлюза со страницы **Панель мониторинга приложения** и просмотрите все свои экземпляры на вкладке **Экземпляры приложения** слева.
  
> [!NOTE]
> Для состояния обнаружения отображается значение OUT_OF_SERVICE, поэтому трафик не будет направляться в это развертывание до завершения проверки.

## <a name="verify-the-staging-deployment"></a>Проверка промежуточного развертывания

1. Вернитесь на страницу **Управления развертыванием** и выберите новое развертывание. Для состояния развертывания должно отображаться значение **Выполняется**. Кнопка Assign/Unassign domain (Назначить/Отменить назначение домена) будет отключена, так как это промежуточная среда.

1. На странице **Обзор** должен отображаться параметр **Test Endpoint** (Тестовая конечная точка). Скопируйте и вставьте его на новую страницу браузера. Должна открыться новая страница Piggy Metrics.

>[!TIP]
> * Убедитесь, что тестовая конечная точка заканчивается символом "/" для обеспечения правильной загрузки CSS.  
> * Если в браузере для просмотра страницы требуется ввести учетные данные, используйте параметр [Декодировать в URL-адресе](https://www.urldecoder.org/) для декодирования тестовой конечной точки. При декодировании в URL-адресе возвращается URL-адрес в формате https://\<username>:\<password>@\<cluster-name>.test.azureapps.io/gateway/green.  Используйте его для доступа к конечной точке.

>[!NOTE]    
> Параметры сервера конфигурации применяются к промежуточной и к рабочей среде. Например, если вы указали путь контекста (`server.servlet.context-path`) для шлюза приложения на сервере конфигурации как *somepath*, путь к развертыванию green изменится: https://\<username>:\<password>@\<cluster-name>.test.azureapps.io/gateway/green/somepath/...
 
 Если на этом этапе вы посетите общедоступный шлюз приложений, отобразится старая страница без внесенных изменений.
    
## <a name="set-the-green-as-production-deployment"></a>Установка развертывания green в качестве развертывания в рабочей среде

1. После проверки изменений в промежуточной среде вы можете переместить ее в рабочую среду. Вернитесь на страницу **Управление развертыванием** и установите флажок перед приложением gateway.
2. Выберите Set deployment (Задать развертывание).
3. Выберите Green в меню "Рабочее развертывание" и щелкните **Применить**.
4. Перейдите на страницу **Обзор** приложения шлюза. Если вы уже назначили домен для своего приложения шлюза, URL-адрес появится на странице **Обзор**. Перейдите по URL-адресу, чтобы увидеть измененную страницу Piggy Metrics.

>[!NOTE]
> Когда развертывание green будет установлено в рабочей среде, предыдущее развертывание станет промежуточным.

## <a name="modify-the-staging-deployment"></a>Изменение промежуточного развертывания

Если вас не устраивают изменения, вы можете изменить код приложения, создать JAR-пакет и отправить его в развертывание green с помощью Azure CLI.

```azurecli
az spring-cloud app deploy  -g <resource-group-name> -s <service-instance-name> -n gateway -d green --jar-path gateway.jar
```

## <a name="delete-a-staging-deployment"></a>Удаление промежуточного развертывания

Удалите промежуточное развертывание с порта Azure. Для этого перейдите на страницу промежуточного развертывания и нажмите кнопку **Удалить**.

Или удалите промежуточное развертывание из Azure CLI с помощью следующей команды:

```azurecli
az spring-cloud app deployment delete -n <staging-deployment-name> -g <resource-group-name> -s <service-instance-name> --app gateway
```
