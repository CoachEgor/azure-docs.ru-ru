---
title: Настройка промежуточной среды в Azure Spring Cloud | Документация Майкрософт
description: Узнайте, как использовать развертывание по методу Blue-Green с помощью Azure Spring Cloud
author: bmitchell287
ms.service: spring-cloud
ms.topic: conceptual
ms.date: 02/03/2020
ms.author: brendm
ms.openlocfilehash: 2e29f6a75b303518ac34ecf9b570bd7638cf0c3a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79471036"
---
# <a name="set-up-a-staging-environment-in-azure-spring-cloud"></a>Настройка среды постановки в облачности Azure Spring

В этой статье рассматриваются способы настройки развертывания с помощью сине-зеленого шаблона развертывания в облачном окне Azure Spring. Сине-зеленое развертывание — это шаблон непрерывной поставки Azure DevOps, который предполагает сохранение существующей (синей) версии при развертывании новой (зеленой). В этой статье показано, как утилиировать развертывание в производство без непосредственного изменения развертывания производства.

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы уже развернули приложение PiggyMetrics из нашего [учебника о запуске приложения Azure Spring Cloud.](spring-cloud-quickstart-launch-app-portal.md) PiggyMetrics состоит из трех приложений: "шлюз", "счет-сервис" и "аут-сервис".  

Если вы хотите использовать другое приложение для этого примера, вам нужно внести простое изменение в общедоступной части приложения.  Это изменение отличает промежуточное развертывание от развертывания в рабочей среде.

>[!TIP]
> Azure Cloud Shell — это бесплатная интерактивная оболочка, которую можно использовать для выполнения инструкций в этой статье.  Он имеет общие, предустановленные инструменты Azure, включая последние версии Git, JDK, Maven и Azure CLI. Если вы зарегистрировались в подписке Azure, запустите [облачную оболочку Azure.](https://shell.azure.com)  Чтобы узнать больше, смотрите [Обзор облачной оболочки Azure](../cloud-shell/overview.md).

Чтобы настроить среду постановки в облачности Azure Spring, следуйте инструкциям в следующих разделах.

## <a name="install-the-azure-cli-extension"></a>Установка расширения Azure CLI

Установите расширение Azure Spring Cloud для Azure CLI с помощью следующей команды:

```azurecli
az extension add --name spring-cloud
```
    
## <a name="view-all-deployments"></a>Просмотр всех развертываний

Перейдите в экземпляр службы на портале Azure и выберите **управление развертыванием** для просмотра всех развертываний. Чтобы просмотреть более подробную информацию, можно выбрать каждое развертывание.

## <a name="create-a-staging-deployment"></a>Создание промежуточного развертывания

1. В локальной среде разработки внося небольшую модификацию в приложение PiggyMetrics. Например, измените цвет в *файле шлюза/src/main/resources/static/css/launch.css.* Это позволяет легко дифференцировать два развертывания. Чтобы создать пакет банки, запустите следующую команду: 

    ```console
    mvn clean package
    ```

1. В Azure CLI создайте новое развертывание и придайте ему имя развертывания «зеленый».

    ```azurecli
    az spring-cloud app deployment create -g <resource-group-name> -s <service-instance-name> --app gateway -n green --jar-path gateway/target/gateway.jar
    ```

1. После успешного завершения развертывания получите доступ к странице шлюза из **панели мониторинга приложений**и просмотрите все экземпляры во вкладке **Приложения Instances** слева.
  
> [!NOTE]
> Состояние обнаружения *OUT_OF_SERVICE,* чтобы трафик не направлялся к этому развертыванию до завершения проверки.

## <a name="verify-the-staging-deployment"></a>Проверка промежуточного развертывания

1. Вернитесь на страницу **управления развертыванием** и выберите новое развертывание. Для состояния развертывания должно отображаться значение *Выполняется*. Кнопка **домена Assign/Unsign** должна выглядеть серой, так как среда является промежуточной средой.

1. В панели **обзора** следует увидеть **тестовую конечную точку.** Копировать и вставлять его в новое окно браузера, и новая страница PiggyMetrics должны быть отображены.

>[!TIP]
> * Подтвердите, что конечная точка теста заканчивается слэшом (/) для правильной загрузки файла CSS.  
> * Если в браузере для просмотра страницы требуется ввести учетные данные, используйте параметр [Декодировать в URL-адресе](https://www.urldecoder.org/) для декодирования тестовой конечной точки. При декодировании в URL-адресе возвращается URL-адрес в формате https://\<username>:\<password>@\<cluster-name>.test.azureapps.io/gateway/green.  Используйте эту форму для доступа к вашей конечной точке.

>[!NOTE]    
> Настройки сервера Config применяются как к вашей среде постановки, так и к производству. Например, если вы установите`server.servlet.context-path`путь контекста () для шлюза приложения в сервере конфигурации как *somepath,* путь к вашему зеленому развертыванию изменяется на "https://\<> имени пользователя:\<\<> кластера>">.test.azureapps.io/шлюз/зеленый/somepath/...".
 
 Если вы посещаете свой общедоступный шлюз приложения в этот момент, вы должны увидеть старую страницу без новых изменений.
    
## <a name="set-the-green-deployment-as-the-production-environment"></a>Установите зеленое развертывание в качестве производственной среды

1. После проверки изменений в среде постановки можно довести их до производства. Вернитесь к **управлению развертыванием**и выберите флажок для проверки приложения **шлюза.**

2. Выберите **развертывание набора.**
3. В списке **развертывания производства** выберите **зеленый**цвет, а затем выберите **Apply.**
4. Перейдите на страницу **Обзор** приложения шлюза. Если вы уже назначили домен для приложения шлюза, URL-адрес появится в панели **Обзора.** Чтобы просмотреть измененную страницу PiggyMetrics, выберите URL и перейдите на сайт.

>[!NOTE]
> После установки зеленого развертывания в качестве рабочей среды предыдущее развертывание становится плагиатом развертывания.

## <a name="modify-the-staging-deployment"></a>Изменение промежуточного развертывания

Если вас не устраивает изменение, вы можете изменить код приложения, создать новый пакет банки и загрузить его в зеленое развертывание с помощью Azure CLI.

```azurecli
az spring-cloud app deploy  -g <resource-group-name> -s <service-instance-name> -n gateway -d green --jar-path gateway.jar
```

## <a name="delete-the-staging-deployment"></a>Удаление постановки развертывания

Чтобы удалить развертывание из порта Azure, перейдите на страницу развертывания, а затем выберите кнопку **«Удалить».**

Кроме того, удалите развертывание из Azure CLI, запустив следующую команду:

```azurecli
az spring-cloud app deployment delete -n <staging-deployment-name> -g <resource-group-name> -s <service-instance-name> --app gateway
```
