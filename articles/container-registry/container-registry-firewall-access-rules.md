---
title: Правила доступа брандмауэра
description: Настройте правила для доступа к реестру контейнеров Azure из защищенного брандмауэра, разрешив доступ к ("список разрешений") REST API и доменным именам конечных точек данных или диапазонам IP-адресов, зависящим от службы.
ms.topic: article
ms.date: 05/07/2020
ms.openlocfilehash: b3560fe769a97c8d3a4e5a3580d42d7c0b3a3f08
ms.sourcegitcommit: 999ccaf74347605e32505cbcfd6121163560a4ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2020
ms.locfileid: "82978354"
---
# <a name="configure-rules-to-access-an-azure-container-registry-behind-a-firewall"></a>Настройка правил для доступа к реестру контейнеров Azure за брандмауэром

В этой статье объясняется, как настроить правила в брандмауэре, чтобы разрешить доступ к реестру контейнеров Azure. Например, для извлечения образа контейнера Azure IoT Edgeному устройству за брандмауэром или прокси-сервером может потребоваться доступ к реестру контейнеров. Или заблокированный сервер в локальной сети может потребовать доступа для отправки образа.

Если вместо этого вы хотите настроить входящий сетевой доступ к реестру контейнеров только в виртуальной сети Azure, см. статью [Настройка частного канала Azure для реестра контейнеров Azure](container-registry-private-link.md).

## <a name="about-registry-endpoints"></a>Сведения о конечных точках реестра

Чтобы извлечь или отправить образы или другие артефакты в реестр контейнеров Azure, клиент, например, управляющая программа DOCKER должна взаимодействовать по протоколу HTTPS с двумя разными конечными точками. Для клиентов, обращающихся к реестру в защищенном брандмауэре, необходимо настроить правила доступа для обеих конечных точек.

* **Реестр REST API конечная точка** . операции проверки подлинности и управления реестром обрабатываются через общедоступную конечную точку REST API реестра. Эта конечная точка является именем сервера входа в реестр. Пример: `myregistry.azurecr.io`

* **Конечная точка хранилища (Data)** . Azure [выделяет хранилище BLOB-объектов](container-registry-storage.md) в учетных записях хранения Azure от имени каждого реестра для управления данными для образов контейнеров и других артефактов. Когда клиент получает доступ к слоям изображений в реестре контейнеров Azure, он выполняет запросы с помощью конечной точки учетной записи хранения, предоставляемой реестром.

Если реестр является [географически реплицируемым](container-registry-geo-replication.md), клиенту может потребоваться взаимодействовать с конечной точкой данных в определенном регионе или в нескольких реплицируемых регионах.

## <a name="allow-access-to-rest-and-data-endpoints"></a>Разрешить доступ к ОСТАВШИМся и конечным точкам данных

* **Конечная точка RESTful** — разрешение доступа к полному имени `<registry-name>.azurecr.io`сервера входа в реестр или к диапазону IP-адресов.
* **Конечная точка хранилища (Data)** . Разрешите доступ ко всем учетным записям `*.blob.core.windows.net`хранилища BLOB-объектов Azure с помощью подстановочного знака или соответствующего диапазона IP-адресов.
> [!NOTE]
> Реестр контейнеров Azure представляет [выделенные конечные точки данных](#enable-dedicated-data-endpoints-preview) (Предварительная версия), позволяя жестко ограничить правила брандмауэра клиента для хранилища реестра. При необходимости включите конечные точки данных во всех регионах, где размещается или реплицируется реестр, `<registry-name>.<region>.data.azurecr.io`с помощью формы.

## <a name="allow-access-by-ip-address-range"></a>Разрешить доступ по диапазону IP-адресов

Если в Организации есть политики для разрешения доступа только к конкретным IP-адресам или диапазонам адресов, скачайте [диапазоны IP-адресов Azure и теги служб — общедоступное облако](https://www.microsoft.com/download/details.aspx?id=56519).

Чтобы найти диапазоны IP-адресов конечной точки записи контроля доступа, для которых необходимо разрешить доступ, выполните поиск **азуреконтаинеррегистри** в файле JSON.

> [!IMPORTANT]
> Диапазоны IP-адресов для служб Azure могут изменяться, а обновления публикуются еженедельно. Регулярно загружайте JSON и вносите необходимые обновления в правила доступа. Если в сценарии предполагается настройка правил группы безопасности сети в виртуальной сети Azure или используется брандмауэр Azure, используйте вместо него **AzureContainerRegistry** [тег службы](#allow-access-by-service-tag) азуреконтаинеррегистри.
>

### <a name="rest-ip-addresses-for-all-regions"></a>IP-адреса RESTFUL для всех регионов

```json
{
  "name": "AzureContainerRegistry",
  "id": "AzureContainerRegistry",
  "properties": {
    "changeNumber": 10,
    "region": "",
    "platform": "Azure",
    "systemService": "AzureContainerRegistry",
    "addressPrefixes": [
      "13.66.140.72/29",
    [...]
```

### <a name="rest-ip-addresses-for-a-specific-region"></a>IP-адреса RESTFUL для определенного региона

Выполните поиск по определенному региону, например **азуреконтаинеррегистри. AustraliaEast**.

```json
{
  "name": "AzureContainerRegistry.AustraliaEast",
  "id": "AzureContainerRegistry.AustraliaEast",
  "properties": {
    "changeNumber": 1,
    "region": "australiaeast",
    "platform": "Azure",
    "systemService": "AzureContainerRegistry",
    "addressPrefixes": [
      "13.70.72.136/29",
    [...]
```

### <a name="storage-ip-addresses-for-all-regions"></a>IP-адреса хранилища для всех регионов

```json
{
  "name": "Storage",
  "id": "Storage",
  "properties": {
    "changeNumber": 19,
    "region": "",
    "platform": "Azure",
    "systemService": "AzureStorage",
    "addressPrefixes": [
      "13.65.107.32/28",
    [...]
```

### <a name="storage-ip-addresses-for-specific-regions"></a>IP-адреса хранилища для конкретных регионов

Выполните поиск по определенному региону, например **Storage. аустралиацентрал**.

```json
{
  "name": "Storage.AustraliaCentral",
  "id": "Storage.AustraliaCentral",
  "properties": {
    "changeNumber": 1,
    "region": "australiacentral",
    "platform": "Azure",
    "systemService": "AzureStorage",
    "addressPrefixes": [
      "52.239.216.0/23"
    [...]
```

## <a name="allow-access-by-service-tag"></a>Разрешить доступ по тегу службы

В виртуальной сети Azure используйте правила сетевой безопасности для фильтрации трафика от ресурса, например виртуальной машины, в реестр контейнеров. Чтобы упростить создание правил сети Azure, используйте [тег службы](../virtual-network/security-overview.md#service-tags) **азуреконтаинеррегистри** . Тег службы представляет группу префиксов IP-адресов для глобального доступа к службе Azure или по всему региону Azure. Тег автоматически обновляется при изменении адресов. 

Например, создайте правило исходящей группы безопасности сети с назначением **азуреконтаинеррегистри** , чтобы разрешить трафик в реестр контейнеров Azure. Чтобы разрешить доступ к тегу службы только в определенном регионе, укажите регион в следующем формате: **азуреконтаинеррегистри**. [*имя региона*].

## <a name="enable-dedicated-data-endpoints-preview"></a>Включить выделенные конечные точки данных (Предварительная версия)

> [!WARNING]
> Если вы ранее настроили брандмауэр клиента для доступа `*.blob.core.windows.net` к существующим конечным точкам, переключение на выделенные конечные точки данных повлияет на подключение клиентов, что приведет к сбоям при вытягивание Чтобы обеспечить постоянный доступ клиентов, добавьте новые правила конечной точки данных в правила брандмауэра клиента. После завершения включите выделенные конечные точки данных для реестров с помощью Azure CLI или других средств.

Выделенные конечные точки данных являются необязательным компонентом уровня служб реестра **Premium** Container. Сведения об уровнях и ограничениях служб реестра см. в статье [уровни реестра контейнеров Azure](container-registry-skus.md). Чтобы включить конечные точки данных с помощью Azure CLI, используйте Azure CLI версии 2.4.0 или более поздней. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli).

Следующая команда [AZ записи контроля][az-acr-update] доступа позволяет включить выделенные конечные точки данных в реестре *myregistry*. Для демонстрационной цели Предположим, что реестр реплицируется в двух регионах:

```azurecli
az acr update --name myregistry --data-endpoint-enabled
```

Конечные точки данных используют региональный шаблон, `<registry-name>.<region>.data.azurecr.io`. Чтобы просмотреть конечные точки данных, выполните команду [AZ запись контроля доступа для конечных точек][az-acr-show-endpoints] :

```azurecli
az acr show-endpoints --name myregistry
```

Результат

```
{
    "loginServer": "myregistry.azurecr.io",
    "dataEndpoints": [
        {
            "region": "eastus",
            "endpoint": "myregistry.eastus.data.azurecr.io",
        },
        {
            "region": "westus",
            "endpoint": "myregistry.westus.data.azurecr.io",
        }
    ]
}
```

После настройки выделенных конечных точек данных для реестра можно включить правила доступа клиентского брандмауэра для конечных точек данных. Включить правила доступа к конечной точке данных для всех необходимых разделов реестра.

## <a name="configure-client-firewall-rules-for-mcr"></a>Настройка правил брандмауэра клиента для мкр

Если вам нужно получить доступ к реестру контейнеров Microsoft (мкр) из брандмауэра, см. Руководство по настройке [правил брандмауэра клиента мкр](https://github.com/microsoft/containerregistry/blob/master/client-firewall-rules.md). МКР — основной реестр для всех опубликованных корпорацией Майкрософт образов DOCKER, таких как образы Windows Server.

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте о [рекомендациях Azure по сетевой безопасности](../security/fundamentals/network-best-practices.md)

* Дополнительные сведения о [группах безопасности](/azure/virtual-network/security-overview) в виртуальной сети Azure

* Дополнительные сведения о [выделенных конечных точках данных](https://azure.microsoft.com/blog/azure-container-registry-mitigating-data-exfiltration-with-dedicated-data-endpoints/) для реестра контейнеров Azure



<!-- IMAGES -->

<!-- LINKS - External -->

<!-- LINKS - Internal -->

[az-acr-update]: /cli/azure/acr#az-acr-update
[az-acr-show-endpoints]: /cli/azure/acr#az-acr-show-endpoints

