---
title: Автоматизация создания и исправления образов контейнеров с помощью задач реестра контейнеров Azure (задачи записи контроля доступа)
description: Общие сведения о задачах записи контроля доступа — наборе функций в реестре контейнеров Azure, который обеспечивает безопасную автоматическую сборку, управление и исправление образов контейнеров в облаке.
services: container-registry
author: dlepow
manager: gwallace
ms.service: container-registry
ms.topic: article
ms.date: 06/12/2019
ms.author: danlep
ms.openlocfilehash: 2d7237c1d142e9f7bb5a47294d1375040be43ac3
ms.sourcegitcommit: f176e5bb926476ec8f9e2a2829bda48d510fbed7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/04/2019
ms.locfileid: "70308034"
---
# <a name="automate-container-image-builds-and-maintenance-with-acr-tasks"></a>Автоматизация сборки и обслуживание образов контейнеров с помощью задач контроля доступа

Контейнеры предоставляют новые уровни виртуализации, изолируя зависимости приложения и разработчиков от требований в отношении инфраструктуры и эксплуатации. Тем не менее, остается необходимость решить, как управление виртуализацией приложений будет осуществляться в течение жизненного цикла контейнера.

## <a name="what-is-acr-tasks"></a>Что такое "Задачи ACR"?

**Задачи ACR** — это набор компонентов в Реестре контейнеров Azure. Она позволяет создавать образы облачных контейнеров для Linux, Windows и ARM, а также автоматизировать применение [исправлений платформы и ОС](#automate-os-and-framework-patching) для ваших контейнеров Docker. Служба "Задачи ACR" не только расширяет "внутренний цикл" разработки до облака за счет сборки образов контейнера по требованию, но и обеспечивает автоматические сборки при фиксации исходного кода или при обновлении базового образа контейнера. С помощью триггеров, которые срабатывают при обновлении базового образа, можно автоматизировать рабочий процесс внесения исправлений ОС и платформы приложения, поддерживая безопасность в средах в соответствии с правилами неизменяемых контейнеров.

Создавайте и тестируйте образы контейнера с помощью службы "Задачи ACR" четырьмя способами:

* [Быстрая задача](#quick-task). Создавайте и отправляйте образы контейнера по требованию в Azure без необходимости в установке локального модуля Docker. Выполняйте `docker build` и `docker push` в облаке. Выполняйте сборку на основе локального исходного кода или репозитория Git.
* [Сборка при фиксации исходного кода](#automatic-build-on-source-code-commit). Автоматически активируйте сборку образов контейнеров при фиксации кода в репозиторий Git.
* [Сборка на основе обновления образа](#automate-os-and-framework-patching). Автоматически активируйте сборку образа контейнера при обновлении базового образа.
* [Многошаговые задачи](#multi-step-tasks): Определяйте многошаговые задачи, которые создают образы, выполняют контейнеры в качестве команд и отправляют образы в реестр. Эта возможность задач записи контроля доступа поддерживает выполнение задач по требованию и параллельную сборку, тестирование и принудительную обработку образа.

## <a name="quick-task"></a>Быстрая задача

Цикл разработки "внутреннего цикла" — это итеративный процесс написания кода, сборки и тестирования приложения перед фиксацией в системе управления версиями. Это лишь начало управления жизненным циклом контейнера.

Прежде чем зафиксировать первую строку кода, функция [Быстрая задача](container-registry-tutorial-quick-task.md) службы "Задачи ACR" может обеспечить интегрированный опыт разработки, разгружая сборки образов контейнера в Azure. С помощью быстрых задач можно проверить автоматические определения сборки и перехватывать потенциальные проблемы перед фиксацией кода.

Используя привычный `docker build` формат, команда [AZ запись контроля][az-acr-build] доступа в Azure CLI принимает [контекст](#context-locations) (набор файлов для сборки), отправляет задачи записи контроля доступа, а по умолчанию помещает созданный образ в реестр после завершения.

Общие сведения см. в кратком руководстве по [созданию и запуску образа контейнера](container-registry-quickstart-task-cli.md) в реестре контейнеров Azure.  

Служба "Задачи ACR" разработана как примитив жизненного цикла контейнеров. К примеру, интегрируйте службу "Задачи ACR" в решение CI/CD. Выполняя команду [AZ login][az-login] с [субъектом-службой][az-login-service-principal], решение CI/CD может выдавать команды [AZ контроля][az-acr-build] доступа для запуска сборок образа.

Узнайте, как использовать быстрые задачи из первого руководства по Задачам ACR: [Руководство. Создание образов контейнера в облаке с помощью службы "Задачи Реестра контейнеров Azure"](container-registry-tutorial-quick-task.md).

## <a name="automatic-build-on-source-code-commit"></a>Автоматическая сборка при фиксации исходного кода

Используйте задачи контроля доступа для автоматического запуска сборки образа контейнера при фиксации кода в репозитории Git в GitHub или Azure DevOps. Задачи сборки, настраиваемые с помощью команды Azure CLI [AZ контроля][az-acr-task]учетных записей, позволяют указать репозиторий Git и, при необходимости, ветвь и Dockerfile. Когда ваша команда фиксирует код в репозиторий, веб-перехватчик, созданный службой "Задачи ACR", активирует сборку образов контейнеров, определенную в репозитории.

> [!IMPORTANT]
> Если вы ранее создавали задачи в предварительной версии, используя команду `az acr build-task`, эти задачи необходимо повторно создать, используя команду [az acr task][az-acr-task].

Узнайте, как активировать сборку при фиксации исходного кода из второго руководства по службе "Задачи ACR": [Руководство. Автоматизация сборок образов контейнера с помощью службы "Задачи Реестра контейнеров Azure"](container-registry-tutorial-build-task.md).

## <a name="automate-os-and-framework-patching"></a>Автоматизация установки исправлений ОС и платформы

Возможность службы "Задачи ACR" значительно улучшать рабочий процесс сборки контейнера обуславливается ее способностью обнаруживать обновление базового образа. Когда обновленный базовый образ помещается в реестр или базовый образ обновляется в общедоступном репозитории, например в центре DOCKER, задачи записи контроля доступа могут автоматически создавать образы приложений на основе этого приложения.

Образы контейнеров можно классифицировать на *базовые* образы и образы *приложения*. К базовым образам, как правило, относятся операционная система и платформы приложений, на основе которых создано приложение, а также другие настройки. Эти базовые образы обычно создаются на основе открытых вышестоящих образов, например: [Alpine Linux][base-alpine], [Windows][base-windows], [.NET][base-dotnet]или [node. js][base-node]. Несколько образов вашего приложения могут совместно использовать общий базовый образ.

Когда вышестоящая программа обслуживания обновляет образ ОС или платформу приложения, к примеру, путем внесения критического исправления системы безопасности ОС, необходимо также внести его и в базовые образы. Затем необходимо повторно выполнить сборку каждого образа приложения, чтобы внести эти вышестоящие исправления, внесенные в базовый образ.

Так как при создании образа контейнера служба "Задачи ACR" динамически находит зависимости базовых образов, она может определить время обновления базового образа приложения. С помощью одной предварительно настроенной [задачи сборки](container-registry-tutorial-base-image-update.md#create-a-task) служба "Задачи ACR" **автоматически повторно выполняет сборку каждого образа приложения**. Благодаря такому автоматическому обнаружению и повторному выполнению сборок служба "Задачи ACR" экономит время и усилия, необходимые для того, чтобы вручную отслеживать и обновлять каждый образ приложения, ссылающийся на обновленный базовый образ.

Задача записи контроля доступа отслеживает базовое обновление образа, когда базовый образ находится в одном из следующих расположений:

* реестр контейнеров Azure, в котором выполняется задача;
* другой реестр контейнеров Azure в том же регионе; 
* общедоступный репозиторий в Docker Hub;
* общедоступный репозиторий в Реестре контейнеров Azure.

Дополнительные сведения об исправлениях операционных систем и платформ см. в разделе Руководство по задачам контроля доступа, [Автоматизация сборки образа в базовом обновлении образа с помощью задач реестра контейнеров Azure](container-registry-tutorial-base-image-update.md).

## <a name="multi-step-tasks"></a>Многошаговые задачи

Многоэтапные задачи обеспечивают определение и выполнение задач на основе шага для создания, тестирования и исправления образов контейнеров в облаке. Шаги задач определяют отдельный образ контейнера сборки и перемещения контейнеров. Они также могут определять выполнение одного или нескольких контейнеров, причем каждый шаг использует контейнер в качестве среды выполнения.

Например, можно создать многошаговую задачу, которая автоматизирует следующие операции:

1. Сборка образа веб-приложения.
1. Выполнение контейнера веб-приложения.
1. Сборка тестового образа веб-приложения.
1. Выполнение контейнера для тестирования веб-приложения, который выполняет тестирование работающего контейнера приложения.
1. Если тесты проходят успешно, создайте пакет архива диаграмм Helm.
1. Выполнение команды `helm upgrade` с использованием нового пакета архива диаграмм Helm.

Многошаговые задачи позволяют разделить создание, выполнение и тестирование образов на большее количество составных шагов с поддержкой зависимостей между шагами. Благодаря многошаговым задачам в службе "Задачи ACR" у вас есть более детальный контроль над рабочими процессами создания и тестирования образа, а также исправления платформы и ОС.

Дополнительные сведения о многошаговых задачах см. в статье [Выполнение многошаговых задач сборки, тестирования и исправления в службе "Задачи ACR"](container-registry-tasks-multi-step.md).

## <a name="context-locations"></a>Расположения контекста

В следующей таблице приведено несколько примеров поддерживаемых расположений контекста для Задач ACR:

| Расположение контекста | Описание | Пример |
| ---------------- | ----------- | ------- |
| Локальная файловая система | Файлы в каталоге в локальной файловой системе. | `/home/user/projects/myapp` |
| Главная ветвь GitHub | Файлы в главной ветви (или другой ветви по умолчанию) репозитория GitHub.  | `https://github.com/gituser/myapp-repo.git` |
| Ветвь GitHub | Определенная ветвь репозитория GitHub.| `https://github.com/gituser/myapp-repo.git#mybranch` |
| Вложенная папка GitHub | Файлы во вложенной папке в репозитории GitHub. В примере показано сочетание ветви и спецификации вложенных папок. | `https://github.com/gituser/myapp-repo.git#mybranch:myfolder` |
| Удаленный архив Tarball | Файлы в сжатом архиве на удаленном веб-сервере. | `http://remoteserver/myapp.tar.gz` |

## <a name="image-platforms"></a>Платформы изображений

По умолчанию задачи записи контроля доступа строят образы для ОС Linux и архитектуры AMD64. `--platform` Укажите тег для создания образов Windows или образов Linux для других архитектур. Укажите операционную систему и, при необходимости, поддерживаемую архитектуру в формате ОС/архитектуры `--platform Linux/arm`(например,). Для архитектур ARM можно дополнительно указать вариант в формате OS/Architecture/Variant (например, `--platform Linux/arm64/v8`):

| OS | Архитектура|
| --- | ------- | 
| Linux | AMD64<br/>активации<br/>arm64<br/>386 |
| Windows | AMD64 |

## <a name="view-task-logs"></a>Просмотр журналов задач

Каждое выполнение задачи создает выходные данные журнала, которые можно проверить, чтобы определить, успешно ли выполнялись шаги задачи. Если вы используете команду [AZ запись контроля](/cli/azure/acr#az-acr-build)доступа, AZ запись после [выполнения](/cli/azure/acr#az-acr-run)или [AZ контроля](/cli/azure/acr/task#az-acr-task-run) доступа для запуска задачи, выходные данные журнала для выполнения задачи передаются в консоль, а также сохраняются для последующего извлечения. Если задача запускается автоматически, например при фиксации исходного кода или обновлении базового образа, журналы задач сохраняются. Просмотрите журналы выполнения задачи в портал Azure или используйте команду [AZ контроля доступа к журналам задач](/cli/azure/acr/task#az-acr-task-logs) .

Начиная с июля 2019, данные и журналы для выполнения задач в реестре по умолчанию будут храниться в течение 30 дней, а затем автоматически очищены. Если требуется архивировать данные для выполнения задачи, включите архивацию с помощью команды [AZ контроля доступа Task Update-Run](/cli/azure/acr/task#az-acr-task-update-run) . В следующем примере включается Архивация для задачи Run *cf11* в реестре *myregistry*.

```azurecli
az acr task update-run --registry myregistry --run-id cf11 --no-archive false
```

## <a name="next-steps"></a>Следующие шаги

Когда вы будете готовы автоматизировать установку исправлений ОС и платформы, создав образы контейнеров в облаке, ознакомьтесь со статьей [руководство по задачам записи контроля доступа, сосвященному](container-registry-tutorial-quick-task.md)трем компонентам.

При необходимости установите [расширение Docker для Visual Studio Code](https://code.visualstudio.com/docs/azure/docker) и расширение [учетной записи Azure](https://marketplace.visualstudio.com/items?itemName=ms-vscode.azure-account) для работы со своими реестрами контейнеров Azure. Извлекайте и отправляйте образы в реестр контейнеров Azure или запускайте Задачи ACR в Visual Studio Code.

<!-- LINKS - External -->
[base-alpine]: https://hub.docker.com/_/alpine/
[base-dotnet]: https://hub.docker.com/r/microsoft/dotnet/
[base-node]: https://hub.docker.com/_/node/
[base-windows]: https://hub.docker.com/r/microsoft/nanoserver/
[sample-archive]: https://github.com/Azure-Samples/acr-build-helloworld-node/archive/master.zip
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[azure-cli]: /cli/azure/install-azure-cli
[az-acr-build]: /cli/azure/acr#az-acr-build
[az-acr-task]: /cli/azure/acr
[az-login]: /cli/azure/reference-index#az-login
[az-login-service-principal]: /cli/azure/authenticate-azure-cli

<!-- IMAGES -->
[quick-build-01-fork]: ./media/container-registry-tutorial-quick-build/quick-build-01-fork.png
[quick-build-02-browser]: ./media/container-registry-tutorial-quick-build/quick-build-02-browser.png
