---
title: Очистка тегов и манифестов
description: Используйте команду "очистить", чтобы удалить несколько тегов и манифестов из реестра контейнеров Azure на основе возраста и фильтра тегов, а также при необходимости запланировать операции очистки.
ms.topic: article
ms.date: 08/14/2019
ms.openlocfilehash: f9d86b628bdd0ce0db3067b02a47517d8aadcba3
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79087326"
---
# <a name="automatically-purge-images-from-an-azure-container-registry"></a>Автоматическая очистка образов из реестра контейнеров Azure

При использовании реестра контейнеров Azure в рамках рабочего процесса разработки реестр может быстро заполняться образами или другими артефактами, которые не нужны после короткого периода. Может потребоваться удалить все теги, которые старше определенной длительности или соответствуют указанному фильтру имен. Чтобы быстро удалить несколько артефактов, в этой статье `acr purge` описывается команда, которую можно запустить в качестве задачи контроля доступа по запросу или по [расписанию](container-registry-tasks-scheduled.md) . 

В `acr purge` настоящее время команда распространяется в общедоступном образе`mcr.microsoft.com/acr/acr-cli:0.1`контейнера (), созданном на основе исходного кода в репозитории записей [контроля доступа CLI](https://github.com/Azure/acr-cli) в GitHub.

Для выполнения примеров задач записи контроля доступа в этой статье можно использовать Azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.69 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install]. 

> [!IMPORTANT]
> Эта функция в настоящее время находится на стадии предварительной версии. Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> Использовать `acr purge` команду с осторожностью — удаленные данные изображения являются невосстанавливаемыми. При наличии систем, которые извлекают образы по дайджесту манифеста (в отличие от имени образа), не следует очищать образы без тегов. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо получения с помощью манифеста попробуйте внедрить схему *уникальных тегов*, которая [рекомендуется в качестве лучшей методики](container-registry-image-tag-version.md).

Если вы хотите удалить отдельные Теги изображения или манифесты с помощью команд Azure CLI, см. раздел [Удаление образов контейнеров в реестре контейнеров Azure](container-registry-delete.md).

## <a name="use-the-purge-command"></a>Использование команды "очистить"

Команда `acr purge` Container удаляет образы по тегу в репозитории, который соответствует фильтру имен и старше указанного времени. По умолчанию удаляются только ссылки на теги, а не базовые [манифесты](container-registry-concepts.md#manifest) и данные слоя. Команда также может удалять манифесты. 

> [!NOTE]
> `acr purge`не удаляет тег или репозиторий образа, в `write-enabled` `false`котором атрибуту присвоено значение. Дополнительные сведения см. [в разделе Блокировка образа контейнера в реестре контейнеров Azure](container-registry-image-lock.md).

`acr purge`предназначен для запуска в качестве команды контейнера в [задаче записи контроля](container-registry-tasks-overview.md)доступа, чтобы она автоматически выполняла проверку подлинности с реестром, в котором выполняется задача, и выполнять в ней действия. В примерах задач в этой статье вместо `acr purge` полного образа контейнера используется [псевдоним](container-registry-tasks-reference-yaml.md#aliases) команды.

Как минимум, при запуске `acr purge`необходимо указать следующее:

* `--filter`— Репозиторий и *регулярное выражение* для фильтрации тегов в репозитории. Примеры: `--filter "hello-world:.*"` соответствует всем тегам в `hello-world` репозитории и `--filter "hello-world:^1.*"` соответствует тегам, начинающимся `1`с. Передайте `--filter` несколько параметров для очистки нескольких репозиториев.
* `--ago`— [Строка длительности](https://golang.org/pkg/time/) в стиле Go для обозначения длительности, после которой удаляются изображения. Длительность состоит из последовательности из одного или нескольких десятичных чисел, каждый из которых имеет суффикс единицы. Допустимые единицы времени: "d" для дней, "h" для часов и "м" для минут. Например, `--ago 2d3h6m` выбирает все отфильтрованные изображения, которые были в последнее время изменены более 2 дней, 3 часов и 6 минут `--ago 1.5h` назад, и выбирает образы, которые были изменены в последний раз более 1,5 часов назад.

`acr purge`поддерживает несколько необязательных параметров. В примерах этой статьи используются следующие два примера.

* `--untagged`— Указывает, что не будут удалены манифесты, не имеющие связанных тегов (*манифесты без тегов*).
* `--dry-run`— Указывает, что никакие данные не удаляются, а выходные данные одинаковы, как если бы команда выполнялась без этого флага. Этот параметр полезен для тестирования команды очистки, чтобы убедиться, что она не удаляет непреднамеренно данные, которые нужно сохранить.

Для дополнительных параметров выполните команду `acr purge --help`. 

`acr purge`поддерживает другие функции команд задач контроля доступа, включая [переменные запуска](container-registry-tasks-reference-yaml.md#run-variables) и [журналы выполнения задач](container-registry-tasks-logs.md) , которые передаются в потоке, а также сохраняются для последующего извлечения.

### <a name="run-in-an-on-demand-task"></a>Запуск в задаче по требованию

В следующем примере используется команда [AZ запись контроля][az-acr-run] доступа для выполнения `acr purge` команды по запросу. В этом примере удаляются все теги и манифесты изображений `hello-world` в репозитории в *myregistry* , которые были изменены более 1 дня назад. Команда контейнера передается с помощью переменной среды. Задача выполняется без контекста источника.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --untagged --ago 1d"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

### <a name="run-in-a-scheduled-task"></a>Выполнение в запланированной задаче

В следующем примере используется команда [AZ контроля][az-acr-task-create] доступа для создания ежедневно [ЗАПЛАНИРОВАНной задачи контроля](container-registry-tasks-scheduled.md)доступа. Задача удаляет теги, `hello-world` измененные более 7 дней назад в репозитории. Команда контейнера передается с помощью переменной среды. Задача выполняется без контекста источника.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --ago 7d"

az acr task create --name purgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 0 * * *" \
  --registry myregistry \
  --context /dev/null
```

Выполните команду [AZ запись контроля][az-acr-task-show] доступа, чтобы увидеть, что триггер таймера настроен.

### <a name="purge-large-numbers-of-tags-and-manifests"></a>Очистка большого количества тегов и манифестов

Очистка большого количества тегов и манифестов может занять несколько минут или больше. Чтобы очистить тысячи тегов и манифестов, команде может потребоваться больше времени, чем время ожидания по умолчанию (600 секунд) для задачи по требованию или 3600 секунд для запланированной задачи. В случае превышения времени ожидания удаляются только подмножество тегов и манифестов. Чтобы обеспечить завершение крупномасштабной очистки, передайте `--timeout` параметр, чтобы увеличить значение. 

Например, следующая задача по запросу задает время ожидания 3600 секунд (1 час):

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --ago 1d --untagged"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  --timeout 3600 \
  /dev/null
```

## <a name="example-scheduled-purge-of-multiple-repositories-in-a-registry"></a>Пример. Запланированная очистка нескольких репозиториев в реестре

В этом примере рассматривается использование `acr purge` для периодической очистки нескольких репозиториев в реестре. Например, у вас может быть конвейер разработки, который передает изображения в репозитории `samples/devimage1` и `samples/devimage2` . Вы периодически импортируете образы разработки в рабочий репозиторий для развертываний, поэтому вам больше не нужны образы разработки. Еженедельно вы очищаете репозитории `samples/devimage1` и `samples/devimage2` в процессе подготовки к работе на ближайшие недели.

### <a name="preview-the-purge"></a>Предварительный просмотр очистки

Перед удалением данных рекомендуется выполнить задачу очистки по запросу с помощью `--dry-run` параметра. Этот параметр позволяет просматривать теги и манифесты, которые команда будет очищать, без удаления каких бы то ни было данных. 

В следующем примере фильтр в каждом репозитории выбирает все теги. `--ago 0d` Параметр соответствует изображениям всех возрастов в репозиториях, соответствующих фильтрам. Измените критерии выбора, если это необходимо для вашего сценария. `--untagged` Параметр указывает на удаление манифестов в дополнение к тегам. Команда "контейнер" передается в команду [AZ запись контроля][az-acr-run] доступа с помощью переменной среды.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged --dry-run"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

Просмотрите выходные данные команды, чтобы просмотреть теги и манифесты, соответствующие параметрам выбора. Поскольку команда выполняется с параметром `--dry-run`, данные не удаляются.

Образец вывода:

```console
[...]
Deleting tags for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1:232889b
myregistry.azurecr.io/samples/devimage1:a21776a
Deleting manifests for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1@sha256:81b6f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e788b
myregistry.azurecr.io/samples/devimage1@sha256:3ded859790e68bd02791a972ab0bae727231dc8746f233a7949e40f8ea90c8b3
Deleting tags for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2:5e788ba
myregistry.azurecr.io/samples/devimage2:f336b7c
Deleting manifests for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2@sha256:8d2527cde610e1715ad095cb12bc7ed169b60c495e5428eefdf336b7cb7c0371
myregistry.azurecr.io/samples/devimage2@sha256:ca86b078f89607bc03ded859790e68bd02791a972ab0bae727231dc8746f233a

Number of deleted tags: 4
Number of deleted manifests: 4
[...]
```

### <a name="schedule-the-purge"></a>Запланировать очистку

Убедившись в выполнении пробного выполнения, создайте запланированную задачу для автоматизации очистки. В следующем примере еженедельная задача запланируется в воскресенье в 1:00 UTC, чтобы выполнить предыдущую команду очистки:

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged"

az acr task create --name weeklyPurgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 1 * * Sun" \
  --registry myregistry \
  --context /dev/null
```

Выполните команду [AZ запись контроля][az-acr-task-show] доступа, чтобы увидеть, что триггер таймера настроен.

## <a name="next-steps"></a>Дальнейшие шаги

Узнайте о других вариантах [удаления данных образа](container-registry-delete.md) в реестре контейнеров Azure.

Дополнительные сведения о хранилище образов см. [в статье хранилище образов контейнеров в реестре контейнеров Azure](container-registry-storage.md).

<!-- LINKS - External -->

[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[azure-cli-install]: /cli/azure/install-azure-cli
[az-acr-run]: /cli/azure/acr#az-acr-run
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-acr-task-show]: /cli/azure/acr/task#az-acr-task-show

