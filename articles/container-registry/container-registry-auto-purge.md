---
title: Очистка теги и манифесты
description: Используйте команду очистки, чтобы удалить несколько тегов и манифестов из реестра контейнеров Azure на основе возраста и фильтра тегов, а также дополнительно запланировать операции по удалению.
ms.topic: article
ms.date: 08/14/2019
ms.openlocfilehash: f9d86b628bdd0ce0db3067b02a47517d8aadcba3
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79087326"
---
# <a name="automatically-purge-images-from-an-azure-container-registry"></a>Автоматики по очистке изображений из реестра контейнеров Azure

При использовании реестра контейнеров Azure в рамках рабочего процесса разработки реестр может быстро заполняться изображениями или другими артефактами, которые не нужны после короткого периода. Возможно, вы захотите удалить все теги, которые старше определенной продолжительности или соответствуют определенному фильтру имен. Чтобы быстро удалить несколько артефактов, `acr purge` в этой статье вводится команда, которую можно запустить в качестве задачи ACR по требованию или [запланировано.](container-registry-tasks-scheduled.md) 

Команда `acr purge` в настоящее время распространяется`mcr.microsoft.com/acr/acr-cli:0.1`в общедоступном изображении контейнера (), построенном из исходного кода в репо [acr-cli](https://github.com/Azure/acr-cli) в GitHub.

Для выполнения примеров задач ACR в этой статье можно использовать оболочку azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.69 или позже. Чтобы узнать версию, выполните команду `az --version`. Если вам нужно установить или обновить, [см.][azure-cli-install] 

> [!IMPORTANT]
> Эта функция в настоящее время находится на стадии предварительной версии. Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> Используйте `acr purge` команду с осторожностью - удаленные данные изображения UNRECOVERABLE. Если у вас есть системы, которые тянут изображения манифест дайджест (в отличие от названия изображения), вы не должны очищать непомеченные изображения. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо получения с помощью манифеста попробуйте внедрить схему *уникальных тегов*, которая [рекомендуется в качестве лучшей методики](container-registry-image-tag-version.md).

Если вы хотите удалить отдельные теги изображений или манифесты с помощью команд Azure CLI, [см.](container-registry-delete.md)

## <a name="use-the-purge-command"></a>Используйте команду очистки

Команда `acr purge` контейнера удаляет изображения по тегу в репозитории, которые соответствуют фильтру имен и которые старше указанной продолжительности. По умолчанию удаляются только ссылки на теги, а не базовые [манифесты](container-registry-concepts.md#manifest) и данные слоя. Команда имеет возможность также удалить манифесты. 

> [!NOTE]
> `acr purge`не удаляет тег изображения или репозиторий, в котором `write-enabled` настроен `false`атрибут. Для получения информации смотрите [заблокировать изображение контейнера в реестре контейнеров Azure.](container-registry-image-lock.md)

`acr purge`предназначен для выполнения в качестве команды контейнера в [ACR Task,](container-registry-tasks-overview.md)так что она автоматически проверяетподлинность с реестром, где выполняется задача и выполняет действия там. Примеры задач в этой `acr purge` статье используют [псевдоним](container-registry-tasks-reference-yaml.md#aliases) команды вместо полностью квалифицированной команды изображения контейнера.

Как минимум, укажите следующее `acr purge`при запуске:

* `--filter`- Репозиторий и *регулярное выражение* для фильтрации тегов в репозитории. Примеры: `--filter "hello-world:.*"` сопоставляет все `hello-world` теги в `--filter "hello-world:^1.*"` репозитории `1`и совпадает с тегами, начинающимися с . Пройдите `--filter` несколько параметров для очистки нескольких репозиторий.
* `--ago`- [Строка продолжительности](https://golang.org/pkg/time/) ВАЗа, обозначающая продолжительность, за пределами которой удаляются изображения. Продолжительность состоит из последовательности одного или нескольких десятичных чисел, каждый из которых имеет единый суффикс. Действительные временные блоки включают "d" в течение нескольких дней, "h" в течение нескольких часов и "м" в течение нескольких минут. Например, `--ago 2d3h6m` выбираетвсе отфильтрованные изображения, которые последние изменены более `--ago 1.5h` 2 дней, 3 часа и 6 минут назад, а также выбирает изображения, последние измененные более 1,5 часов назад.

`acr purge`поддерживает несколько дополнительных параметров. Следующие два используются в примерах в этой статье:

* `--untagged`- Указывает, что манифесты, которые не имеют связанных тегов *(непомеченные манифесты*) удаляются.
* `--dry-run`- Указывается, что данные не удаляются, но вывод такой же, как если бы команда была запущена без этого флага. Этот параметр полезен для тестирования команды очистки, чтобы убедиться, что он не случайно удаляет данные, которые вы собираетесь сохранить.

Для дополнительных параметров, запустить `acr purge --help`. 

`acr purge`поддерживает другие функции команд ACR Tasks, включая [переменные выполнения](container-registry-tasks-reference-yaml.md#run-variables) и [журналы выполнения задач,](container-registry-tasks-logs.md) которые передаются в потоковое и также сохраняются для последующего поиска.

### <a name="run-in-an-on-demand-task"></a>Выполнить в задаче по требованию

В следующем примере используется команда az `acr purge` [acr run][az-acr-run] для выполнения команды по требованию. Этот пример удаляет все теги изображений `hello-world` и манифестов в репозитории в *myregistry,* которые были изменены более 1 дня назад. Команда контейнера передается с помощью переменной среды. Задача выполняется без контекста источника.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --untagged --ago 1d"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

### <a name="run-in-a-scheduled-task"></a>Выполнить в запланированном задании

В следующем примере используется [задача az acr создать][az-acr-task-create] команду для создания [ежедневнозапланированной задачи ACR.](container-registry-tasks-scheduled.md) Теги задания, измененные более 7 дней `hello-world` назад в репозитории. Команда контейнера передается с помощью переменной среды. Задача выполняется без контекста источника.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --ago 7d"

az acr task create --name purgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 0 * * *" \
  --registry myregistry \
  --context /dev/null
```

Выполнить [команду шоу-задачи az acr,][az-acr-task-show] чтобы увидеть, что срабатывает триггер таймер.

### <a name="purge-large-numbers-of-tags-and-manifests"></a>Очистка большого количества тегов и манифестов

Очистка большого количества тегов и манифестов может занять несколько минут или дольше. Чтобы очистить тысячи тегов и манифестов, команде может потребоваться работать дольше времени тайм-аута по умолчанию 600 секунд для задачи по требованию или 3600 секунд для запланированной задачи. Если время тайм-аута превышено, удаляется только подмножество тегов и манифестов. Чтобы обеспечить завершение крупномасштабной чистки, передайте `--timeout` параметр для увеличения значения. 

Например, следующая задача по требованию устанавливает время тайм-аута 3600 секунд (1 час):

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --ago 1d --untagged"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  --timeout 3600 \
  /dev/null
```

## <a name="example-scheduled-purge-of-multiple-repositories-in-a-registry"></a>Пример: Запланированная чистка нескольких репозиторий в реестре

Этот пример проходит `acr purge` через использование периодически очистки нескольких репозиториев в реестре. Например, может быть конвейер разработки, который `samples/devimage1` `samples/devimage2` толкает изображения в репозитории. Вы периодически импортируете изображения разработки в производственный репозиторий для развертывания, поэтому изображения мнится в разработку. Еженедельно вы очищаете `samples/devimage1` `samples/devimage2` и хранилища, готовясь к работе на предстоящей неделе.

### <a name="preview-the-purge"></a>Предварительный просмотр чистки

Перед удалянием данных мы рекомендуем выпустить задачу очистки по требованию с использованием `--dry-run` параметра. Эта опция позволяет видеть теги и манифесты, которые команда будет очищать, не удаляя никаких данных. 

В следующем примере фильтр в каждом репозитории выбирает все теги. Параметр `--ago 0d` соответствует изображениям всех возрастов в репозиториях, которые соответствуют фильтрам. Изменяйте критерии отбора по мере необходимости для вашего сценария. Параметр `--untagged` указывает на удаление манифестов в дополнение к тегов. Команда контейнера передается команде [az acr run][az-acr-run] с использованием переменной среды.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged --dry-run"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

Просмотрите вывод команды, чтобы увидеть теги и манифесты, которые соответствуют параметрам выбора. Поскольку команда работает `--dry-run`с помощью, данные не удаляются.

Образец вывода:

```console
[...]
Deleting tags for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1:232889b
myregistry.azurecr.io/samples/devimage1:a21776a
Deleting manifests for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1@sha256:81b6f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e788b
myregistry.azurecr.io/samples/devimage1@sha256:3ded859790e68bd02791a972ab0bae727231dc8746f233a7949e40f8ea90c8b3
Deleting tags for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2:5e788ba
myregistry.azurecr.io/samples/devimage2:f336b7c
Deleting manifests for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2@sha256:8d2527cde610e1715ad095cb12bc7ed169b60c495e5428eefdf336b7cb7c0371
myregistry.azurecr.io/samples/devimage2@sha256:ca86b078f89607bc03ded859790e68bd02791a972ab0bae727231dc8746f233a

Number of deleted tags: 4
Number of deleted manifests: 4
[...]
```

### <a name="schedule-the-purge"></a>Расписание чистки

После проверки сухого запуска создайте запланированную задачу для автоматизации очистки. Следующий пример расписания еженедельной задачи в воскресенье в 1:00 UTC для запуска предыдущей команды очистки:

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged"

az acr task create --name weeklyPurgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 1 * * Sun" \
  --registry myregistry \
  --context /dev/null
```

Выполнить [команду шоу-задачи az acr,][az-acr-task-show] чтобы увидеть, что срабатывает триггер таймер.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте о других вариантах [удаления данных изображений](container-registry-delete.md) в реестре контейнеров Azure.

Для получения дополнительной информации о хранении изображений смотрите [хранилище изображений контейнеров контейнеров Azure.](container-registry-storage.md)

<!-- LINKS - External -->

[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[azure-cli-install]: /cli/azure/install-azure-cli
[az-acr-run]: /cli/azure/acr#az-acr-run
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-acr-task-show]: /cli/azure/acr/task#az-acr-task-show

