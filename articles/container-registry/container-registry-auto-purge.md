---
title: Автоматическое удаление ресурсов изображений в реестре контейнеров Azure
description: Используйте команду "очистить", чтобы удалить несколько тегов и манифестов из реестра контейнеров Azure на основе возраста и фильтра тегов, а также при необходимости запланировать операции очистки.
services: container-registry
author: dlepow
manager: gwallace
ms.service: container-registry
ms.topic: article
ms.date: 11/04/2019
ms.author: danlep
ms.openlocfilehash: 4fb9eb8a3ef937ce5ed222c7814a8f191e3874f2
ms.sourcegitcommit: ac56ef07d86328c40fed5b5792a6a02698926c2d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2019
ms.locfileid: "73803602"
---
# <a name="automatically-purge-images-from-an-azure-container-registry"></a>Автоматическая очистка образов из реестра контейнеров Azure

При использовании реестра контейнеров Azure в рамках рабочего процесса разработки реестр может быстро заполняться образами или другими артефактами, которые не нужны после короткого периода. Может потребоваться удалить все теги, которые старше определенной длительности или соответствуют указанному фильтру имен. Чтобы быстро удалить несколько артефактов, в этой статье описывается команда `acr purge`, которую можно запустить в качестве задачи контроля доступа по запросу или по [расписанию](container-registry-tasks-scheduled.md) . 

В настоящее время команда `acr purge` распространяется в общедоступном образе контейнера (`mcr.microsoft.com/acr/acr-cli:0.1`), созданного на основе исходного кода в репозитории записей [контроля доступа CLI](https://github.com/Azure/acr-cli) в GitHub. В задаче записи контроля доступа выполните команду, используя [псевдоним](container-registry-tasks-reference-yaml.md#aliases)`acr purge`.

Для выполнения примеров задач записи контроля доступа в этой статье можно использовать Azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.76 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install]. 

> [!IMPORTANT]
> Эта функция в настоящее время находится на стадии предварительной версии. Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> Использование команды `acr purge` с осторожностью — удаленные данные изображения являются невосстанавливаемыми. При наличии систем, которые извлекают образы по дайджесту манифеста (в отличие от имени образа), не следует очищать образы без тегов. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо того чтобы извлекать манифест, рекомендуется использовать *уникальную схему тегов* , [рекомендуемую рекомендацию](container-registry-image-tag-version.md).

Если вы хотите удалить отдельные Теги изображения или манифесты с помощью команд Azure CLI, см. раздел [Удаление образов контейнеров в реестре контейнеров Azure](container-registry-delete.md).

## <a name="use-the-purge-command"></a>Использование команды "очистить"

Команда контейнера `acr purge` удаляет образы по тегу в репозитории, который соответствует фильтру имен и старше указанного времени. По умолчанию удаляются только ссылки на теги, а не базовые [манифесты](container-registry-concepts.md#manifest) и данные слоя. Команда также может удалять манифесты. 

> [!NOTE]
> `acr purge` не удаляет тег образа или репозиторий, в котором для атрибута `write-enabled` задано значение `false`. Дополнительные сведения см. [в разделе Блокировка образа контейнера в реестре контейнеров Azure](container-registry-image-lock.md).

`acr purge` предназначен для выполнения в виде команды контейнера в [задаче записи контроля](container-registry-tasks-overview.md)доступа, поэтому она автоматически проходит проверку подлинности с реестром, в котором выполняется задача. 

Как минимум, при запуске `acr purge` необходимо указать следующее:

* `--registry` — реестр контейнеров Azure, в котором выполняется команда. 
* `--filter` — репозиторий и *регулярное выражение* для фильтрации тегов в репозитории. Примеры: `--filter "hello-world:.*"` соответствует всем тегам в репозитории `hello-world`, а `--filter "hello-world:^1.*"` соответствует тегам, начинающимся с `1`. Передайте несколько параметров `--filter` для очистки нескольких репозиториев.
* `--ago` — [Строка длительности](https://golang.org/pkg/time/) в стиле Go для обозначения длительности, после которой удаляются изображения. Длительность состоит из последовательности из одного или нескольких десятичных чисел, каждый из которых имеет суффикс единицы. Допустимые единицы времени: "d" для дней, "h" для часов и "м" для минут. Например, `--ago 2d3h6m` выбирает все отфильтрованные изображения, которые были в последнее время изменены более 2 дней, 3 часов и 6 минут назад, и `--ago 1.5h` выбирает образы, которые были изменены в последний раз более 1,5 часов назад.

`acr purge` поддерживает несколько необязательных параметров. В примерах этой статьи используются следующие два примера.

* `--untagged` — указывает, что не будут удалены манифесты, не имеющие связанных тегов (*манифесты без тегов*).
* `--dry-run` — указывает, что данные не удаляются, но выходные данные одинаковы, как если бы команда выполнялась без этого флага. Этот параметр полезен для тестирования команды очистки, чтобы убедиться, что она не удаляет непреднамеренно данные, которые нужно сохранить.

Для дополнительных параметров выполните `acr purge --help`. 

`acr purge` поддерживает другие функции команд задач контроля доступа, включая [переменные запуска](container-registry-tasks-reference-yaml.md#run-variables) и [журналы выполнения задач](container-registry-tasks-overview.md#view-task-logs) , которые передаются в потоке, а также сохраняются для последующего извлечения.

### <a name="run-in-an-on-demand-task"></a>Запуск в задаче по требованию

В следующем примере используется команда [AZ записи контроля][az-acr-run] доступа для выполнения команды `acr purge` по запросу. В этом примере удаляются все теги и манифесты изображений в репозитории `hello-world` в *myregistry* , которые были изменены более 1 дня назад. Команда контейнера передается с помощью переменной среды. Задача выполняется без контекста источника.

В этом и следующих примерах реестр, в котором выполняется команда `acr purge`, указывается с помощью псевдонима `$Registry`, который указывает на реестр, в котором выполняется задача.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --registry \$Registry \
  filter 'hello-world:.*' --untagged --ago 1d"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

### <a name="run-in-a-scheduled-task"></a>Выполнение в запланированной задаче

В следующем примере используется команда [AZ контроля][az-acr-task-create] доступа для создания ежедневно [ЗАПЛАНИРОВАНной задачи контроля](container-registry-tasks-scheduled.md)доступа. Задача удаляет теги, измененные более 7 дней назад, в репозитории `hello-world`. Команда контейнера передается с помощью переменной среды. Задача выполняется без контекста источника.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --registry \$Registry \
  --filter 'hello-world:.*' --ago 7d"

az acr task create --name purgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 0 * * *" \
  --registry myregistry \
  --context /dev/null
```

Выполните команду [AZ запись контроля][az-acr-task-show] доступа, чтобы увидеть, что триггер таймера настроен.

### <a name="purge-large-numbers-of-tags-and-manifests"></a>Очистка большого количества тегов и манифестов

Очистка большого количества тегов и манифестов может занять несколько минут или больше. Чтобы очистить тысячи тегов и манифестов, команде может потребоваться больше времени, чем время ожидания по умолчанию (600 секунд) для задачи по требованию или 3600 секунд для запланированной задачи. В случае превышения времени ожидания удаляются только подмножество тегов и манифестов. Чтобы обеспечить выполнение крупномасштабной очистки, передайте параметр `--timeout`, чтобы увеличить значение. 

Например, следующая задача по запросу задает время ожидания 3600 секунд (1 час):

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --registry \$Registry \
  --filter 'hello-world:.*' --ago 1d --untagged"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  --timeout 3600 \
  /dev/null
```

## <a name="example-scheduled-purge-of-multiple-repositories-in-a-registry"></a>Пример. Запланированная очистка нескольких репозиториев в реестре

В этом примере рассматривается использование `acr purge` для периодической очистки нескольких репозиториев в реестре. Например, у вас может быть конвейер разработки, который передает изображения в репозитории `samples/devimage1` и `samples/devimage2`. Вы периодически импортируете образы разработки в рабочий репозиторий для развертываний, поэтому вам больше не нужны образы разработки. Еженедельно вы очищаете `samples/devimage1` и `samples/devimage2` репозитории в процессе подготовки к работе на ближайшие недели.

### <a name="preview-the-purge"></a>Предварительный просмотр очистки

Перед удалением данных рекомендуется выполнить задачу очистки по запросу с помощью параметра `--dry-run`. Этот параметр позволяет просматривать теги и манифесты, которые команда будет очищать, без удаления каких бы то ни было данных. 

В следующем примере фильтр в каждом репозитории выбирает все теги. Параметр `--ago 0d` соответствует изображениям всех сбоев в репозиториях, соответствующих фильтрам. Измените критерии выбора, если это необходимо для вашего сценария. Параметр `--untagged` указывает на удаление манифестов в дополнение к тегам. Команда "контейнер" передается в команду [AZ запись контроля][az-acr-run] доступа с помощью переменной среды.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --registry \$Registry \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged --dry-run"

az acr run \
  --cmd  "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

Просмотрите выходные данные команды, чтобы просмотреть теги и манифесты, соответствующие параметрам выбора. Поскольку команда выполняется с `--dry-run`, данные не удаляются.

Пример выходных данных:

```console
[...]
Deleting tags for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1:232889b
myregistry.azurecr.io/samples/devimage1:a21776a
Deleting manifests for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1@sha256:81b6f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e788b
myregistry.azurecr.io/samples/devimage1@sha256:3ded859790e68bd02791a972ab0bae727231dc8746f233a7949e40f8ea90c8b3
Deleting tags for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2:5e788ba
myregistry.azurecr.io/samples/devimage2:f336b7c
Deleting manifests for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2@sha256:8d2527cde610e1715ad095cb12bc7ed169b60c495e5428eefdf336b7cb7c0371
myregistry.azurecr.io/samples/devimage2@sha256:ca86b078f89607bc03ded859790e68bd02791a972ab0bae727231dc8746f233a

Number of deleted tags: 4
Number of deleted manifests: 4
[...]
```

### <a name="schedule-the-purge"></a>Запланировать очистку

Убедившись в выполнении пробного выполнения, создайте запланированную задачу для автоматизации очистки. В следующем примере еженедельная задача запланируется в воскресенье в 1:00 UTC, чтобы выполнить предыдущую команду очистки:

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --registry $Registry \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged"

az acr task create --name weeklyPurgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 1 * * Sun" \
  --registry myregistry \
  --context /dev/null
```

Выполните команду [AZ запись контроля][az-acr-task-show] доступа, чтобы увидеть, что триггер таймера настроен.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте о других вариантах [удаления данных образа](container-registry-delete.md) в реестре контейнеров Azure.

Дополнительные сведения о хранилище образов см. [в статье хранилище образов контейнеров в реестре контейнеров Azure](container-registry-storage.md).

<!-- LINKS - External -->

[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[azure-cli-install]: /cli/azure/install-azure-cli
[az-acr-run]: /cli/azure/acr#az-acr-run
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-acr-task-show]: /cli/azure/acr/task#az-acr-task-show

