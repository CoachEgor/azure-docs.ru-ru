---
title: Аутентификация с помощью субъекта-службы
description: Предоставление доступа к образам, размещенным в закрытом реестре контейнеров, с помощью субъекта-службы Azure Active Directory.
ms.topic: article
ms.date: 10/04/2019
ms.openlocfilehash: 37da784c8e95a5f5b924532e4a019552924a1a3f
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74455407"
---
# <a name="azure-container-registry-authentication-with-service-principals"></a>Аутентификация в реестре контейнеров Azure с помощью субъектов-служб

С помощью субъекта-службы Azure Active Directory (Azure AD) вы можете предоставить образу контейнера доступ `docker push` и `pull` к реестру контейнеров. Субъект-служба позволяет предоставлять автоматический доступ к службам и приложениям.

## <a name="what-is-a-service-principal"></a>Что такое субъект-служба?

*Субъекты-службы* в Azure AD используются для доступа к ресурсам Azure в подписке. Вы можете думать о принципе службы как о личности пользователя службы, где "сервис" - это любое приложение, сервис или платформа, которая должна получить доступ к ресурсам. Субъекту-службе можно присвоить права доступа, ограниченные конкретными ресурсами. После этого вам останется лишь настроить применение этого субъекта-службы для доступа к ресурсам из приложения или службы.

В контексте реестра контейнеров Azure субъект-служба Azure AD может получать разрешения на получение, на передачу и получение или другие права для частного реестра в Azure. Полный список см. в статье, посвященной [ролям и разрешениям реестра контейнеров Azure](container-registry-roles.md).

## <a name="why-use-a-service-principal"></a>Почему именно субъект-служба?

Субъект-служба Azure AD позволяет предоставить ограниченный доступ к закрытому реестру контейнеров. Создайте различные принципы обслуживания для каждого из ваших приложений или служб, каждое из которых имеет индивидуальные права доступа в ваш реестр. Кроме того, вы сможете в любой момент легко изменить реквизиты или отменить доступ для каждого конкретного субъекта-службы, поскольку его учетные данные применяются только в одном приложении или службе.

Например, настроить веб-приложение, чтобы использовать принцип службы, который предоставляет ему только доступ к изображению, `pull` в то время как система сборки использует принцип службы, который предоставляет ему как `push` доступ, так и `pull` доступ. Если разработка приложения переходит из рук в руки, можно повернуть основные учетные данные службы, не влияя на систему сборки.

## <a name="when-to-use-a-service-principal"></a>Когда следует использовать субъект-службу

Субъект-службы следует очень удобны для предоставления доступа к реестру при работе со **сценариями с автоматическим доступом**. Это позволяет приложениям, службам и (или) скриптам передавать или получать образы контейнеров в полностью автоматическом режиме или без участия оператора. Пример:

  * *Вытяните:* Развертывание контейнеров из реестра в системы оркестровки, включая Kubernetes, DC/OS и Docker Swarm. Вы также можете выйти из реестров контейнеров в связанные службы Azure, такие как [служба Azure Kubernetes (AKS),](../aks/cluster-container-registry-integration.md) [Azure Container Instances,](container-registry-auth-aci.md) [Служба приложений,](../app-service/index.yml) [Пакет,](../batch/index.yml) [Сервисная ткань](/azure/service-fabric/)и другие.

  * *Нажмите:* Создайте изображения контейнеров и нажмите их в реестр, используя решения непрерывной интеграции и развертывания, такие как Azure Pipelines или Jenkins.

Для индивидуального доступа к реестру, например, когда вы вручную вытягиваете изображение контейнера на рабочую станцию разработки, мы рекомендуем использовать свой собственный [идолдля Azure AD](container-registry-authentication.md#individual-login-with-azure-ad) вместо доступа к реестру (например, с [помощью входа в журнал az acr).][az-acr-login]

[!INCLUDE [container-registry-service-principal](../../includes/container-registry-service-principal.md)]

### <a name="sample-scripts"></a>Примеры сценариев

Вы можете найти предыдущие примеры скриптов для Azure CLI на GitHub, а также версии для Azure PowerShell:

* [Лазурный CLI][acr-scripts-cli]
* [Лазурная силаШелл][acr-scripts-psh]

## <a name="authenticate-with-the-service-principal"></a>Authenticate с помощью директора службы

Если у вас есть директор службы, который вы предоставили доступ к реестру контейнеров, вы можете настроить его `docker login` учетные данные для доступа к "безголовым" службам и приложениям, или ввести их с помощью команды. Используйте следующие значения:

* **Имя пользователя** - идентификатор основного приложения службы (также называемый *идентификатор клиента)*
* **Пароль** - основной пароль службы (также называемый *секрет клиента)*

Каждое значение является GUID `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`формы. 

> [!TIP]
> Можно создать пароль субъекта-службы повторно, выполнив команду [az ad sp reset-credentials](/cli/azure/ad/sp/credential#az-ad-sp-credential-reset).
>

### <a name="use-credentials-with-azure-services"></a>Использование учетных данных с помощью служб Azure

Вы можете использовать основные учетные данные службы из любой службы Azure, которая проверяет подлинность в реестре контейнеров Azure.  Используйте основные учетные данные службы вместо учетных данных админоков регистра регистра для различных сценариев.

Например, используйте учетные данные для получения изображения из реестра контейнеров Azure в [экземпляры контейнеров Azure.](container-registry-auth-aci.md)

### <a name="use-with-docker-login"></a>Используйте с логином докера

Вы можете `docker login` запустить с помощью основного обслуживания. В следующем примере идентификатор основного `$SP_APP_ID`приложения службы передается `$SP_PASSWD`в переменной среды, а пароль — в переменной. Для наилучшей практики управления учетных [docker login](https://docs.docker.com/engine/reference/commandline/login/) данными Docker см.

```bash
# Log in to Docker with service principal credentials
docker login myregistry.azurecr.io --username $SP_APP_ID --password $SP_PASSWD
```

После входа в систему Docker кэширует учетные данные.

### <a name="use-with-certificate"></a>Использование с сертификатом

Если вы добавили сертификат в основной сервис, вы можете войти в Azure CLI с проверкой подлинности на основе сертификата, а затем использовать команду [входа в систему az acr][az-acr-login] для доступа к реестру. Использование сертификата в качестве секретного вместо пароля обеспечивает дополнительную безопасность при использовании CLI. 

При [создании основного](/cli/azure/create-an-azure-service-principal-azure-cli)сервиса можно создать сертификат самостоятельного подписания. Или добавьте один или несколько сертификатов в существующий принцип обслуживания. Например, если вы используете один из скриптов в этой статье для создания или обновления принципала службы с правами вытягивать или выталкивать изображения из реестра, добавьте сертификат, используя команду [сбросить учетные данные az ad sp.][az-ad-sp-credential-reset]

Чтобы воспользоваться принципом службы с сертификатом для [входного в Azure CLI,](/cli/azure/authenticate-azure-cli#sign-in-with-a-service-principal)сертификат должен быть в формате PEM и включать закрытый ключ. Если ваш сертификат не в требуемом формате, `openssl` используйте инструмент, например, для его преобразования. При запуске [az login][az-login] для входа в CLI с помощью основного сервиса, также предоставьте идентификатор приложения директора службы и идентификатор арендатора Active Directory. В следующем примере эти значения показаны как переменные среды:

```azurecli
az login --service-principal --username $SP_APP_ID --tenant $SP_TENANT_ID  --password /path/to/cert/pem/file
```

Затем запустите [журнал az acr для][az-acr-login] проверки подлинности в реестре:

```azurecli
az acr login --name myregistry
```

CLI использует маркер, созданный `az login` при проверке подлинности сеанса в реестре.

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь с [обзором аутентификации](container-registry-authentication.md) для других сценариев проверки подлинности с помощью реестра контейнеров Azure.

* Например, использование хранилища ключей Azure для хранения и извлечения основных учетных данных службы для реестра контейнеров см. [build and deploy a container image using ACR Tasks](container-registry-tutorial-quick-task.md)

<!-- LINKS - External -->
[acr-scripts-cli]: https://github.com/Azure/azure-docs-cli-python-samples/tree/master/container-registry
[acr-scripts-psh]: https://github.com/Azure/azure-docs-powershell-samples/tree/master/container-registry

<!-- LINKS - Internal -->
[az-acr-login]: /cli/azure/acr#az-acr-login
[az-login]: /cli/azure/reference-index#az-login
[az-ad-sp-credential-reset]: /cli/azure/ad/sp/credential#az-ad-sp-credential-reset
