---
title: Георепликация реестра контейнеров Azure
description: Приступите к созданию геореплицированных реестров контейнеров Azure и управлению ими.
services: container-registry
author: stevelas
manager: gwallace
ms.service: container-registry
ms.topic: article
ms.date: 08/16/2019
ms.author: stevelas
ms.openlocfilehash: f6d1987012cb401d7167896d9352ba7eae821a04
ms.sourcegitcommit: cf36df8406d94c7b7b78a3aabc8c0b163226e1bc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2019
ms.locfileid: "73887988"
---
# <a name="geo-replication-in-azure-container-registry"></a>Георепликация в реестре контейнеров Azure

Компании, которым необходимо местное присутствие или выполнять оперативное резервное копирование, запускают службы из нескольких регионов Azure. Мы советуем разместить реестр контейнеров в каждом регионе, в котором запускаются образы, чтобы выполнять операции, аналогичные сетевым, для быстрой и надежной передачи слоев образа. Георепликация позволяет реестру контейнеров Azure работать в качестве отдельного реестра и обслуживать несколько регионов с несколькими региональными реестрами. 

Геореплицированный реестр предоставляет следующие преимущества:

* отдельные имена реестра, образа и тега можно использовать в нескольких регионах;
* доступ к реестру, который находится ближе все к сети, из региональных развертываний;
* нет дополнительных исходящих затрат, так как образы извлекаются из локального, реплицируемого реестра в регионе, в котором расположен узел контейнера;
* единое управление реестром в нескольких регионах.

> [!NOTE]
> Если вам нужно хранить копии образов контейнеров в нескольких реестрах контейнеров Azure, Реестр контейнеров Azure также поддерживает [импорт образа](container-registry-import-images.md). Например, в рабочем процессе DevOps вы можете импортировать образы из реестра разработки в рабочий реестр без необходимости использовать команды Docker.
>

## <a name="example-use-case"></a>Примеры использования
Contoso запускает общедоступный веб-сайт, расположенный в США, Канаде и Европе. Чтобы предоставить этим рынкам локальное и аналогичное сетевому содержимое, Contoso запускает [Службу Azure Kubernetes](/azure/aks/) (AKS) в западной части США, восточной части США, Центральной Канаде и Западной Европе. Веб-приложение, развернутое в качестве образа Docker, использует тот же код и образ во всех регионах. Содержимое, локальное для этого региона, извлекается из базы данных, которая уникально подготавливается в каждом регионе. Каждое региональное развертывание имеет свою уникальную конфигурацию для ресурсов, например, для локальной базы данных.

Команда разработчиков находится в Сиэтле, штат Вашингтон, и использует центр обработки данных в западной части США.

![Отправка в несколько реестров](media/container-registry-geo-replication/before-geo-replicate.png)<br />*Отправка в несколько реестров*

Перед использованием функций георепликации Contoso использовал в западной части США реестр, который размещается в США, а также дополнительный реестр в Западной Европе. Для обслуживания этих разных регионов команда разработчиков отправила образы в два разных реестра.

```bash
docker push contoso.azurecr.io/public/products/web:1.2
docker push contosowesteu.azurecr.io/public/products/web:1.2
```
![Извлечение из нескольких реестров](media/container-registry-geo-replication/before-geo-replicate-pull.png)<br />*Извлечение из нескольких реестров*

К типичным сложностям нескольких реестров относятся:

* Все кластеры восточной части США, западной части США и Центральной Канады извлекаются из реестра в западной части США. При этом взимается дополнительная исходящая плата, так как каждый из этих удаленных узлов контейнера извлекает образ из центров обработки данных в западной части США.
* Команда разработчиков должна отправлять образы в реестры в западной части США и Западной Европе.
* Команде разработчиков необходимо настроить и поддерживать каждое региональное развертывание с именами образов, ссылающихся на локальный реестр.
* Для каждого региона, необходимо настроить доступ к реестру.

## <a name="benefits-of-geo-replication"></a>Преимущества георепликации

![Извлечение из геореплицированного реестра](media/container-registry-geo-replication/after-geo-replicate-pull.png)

С помощью функции георепликации реестра контейнеров Azure можно реализовать следующие преимущества:

* Управление одним реестром во всех регионах: `contoso.azurecr.io`.
* Управление одной конфигурацией развертываний образов, так как все регионы использовали одинаковый URL-адрес образа: `contoso.azurecr.io/public/products/web:1.2`.
* Отправляйте данные в отдельный реестр, а ACR будет управлять георепликацией. Можно настроить региональные [веб-перехватчики](container-registry-webhook.md), чтобы получать уведомления о событиях в определенных репликах.

## <a name="configure-geo-replication"></a>Настройка георепликации

Настроить георепликацию так же просто, как и выбрать регионы на карте. Можно также управлять георепликацией с помощью средств, включая команды [AZ запись контроля](/cli/azure/acr/replication) доступа в Azure CLI, или развернуть реестр, включенный для георепликации с [шаблоном Azure Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/101-container-registry-geo-replication).

Георепликация — это функция [реестров только уровня "Премиум"](container-registry-skus.md). Вы можете изменить уровень "Базовый" или "Стандартный" на "Премиум" (если у вас его еще нет) на [портале Azure](https://portal.azure.com).

![Переключение SKU на портале Azure](media/container-registry-skus/update-registry-sku.png)

Чтобы настроить георепликацию для реестра уровня "Премиум", войдите на портал Azure по адресу https://portal.azure.com.

Перейдите к реестру контейнеров Azure и выберите **Replications** (Репликации).

![Репликации в реестре контейнера пользовательского интерфейса на портале Azure](media/container-registry-geo-replication/registry-services.png)

Отобразится карта со всеми текущими регионами Azure:

 ![Карта регионов на портале Azure](media/container-registry-geo-replication/registry-geo-map.png)

* синие шестиугольники отображают текущие реплики;
* зеленые шестиугольники отображают возможные регионы реплик;
* серые шестиугольники отображают регионы Azure, которые еще недоступны для репликации.

Чтобы настроить реплику, выберите зеленый шестиугольник, а затем нажмите кнопку **Создать**.

 ![Создание пользовательского интерфейса репликации на портале Azure](media/container-registry-geo-replication/create-replication.png)

Чтобы настроить дополнительные реплики, выберите зеленые шестиугольники для других регионов, а затем нажмите кнопку **Создать**.

ACR начинает синхронизацию образов между настроенными репликами. После завершения на портале отобразится состояние *Готово*. Состояние реплики на портале не обновляется автоматически. Нажмите кнопку "Обновить", чтобы просмотреть обновленное состояние.

## <a name="considerations-for-using-a-geo-replicated-registry"></a>Рекомендации по использованию геореплицированного реестра

* Каждый регион в геореплицированном реестре является независимым после настройки. Соглашения об уровне обслуживания Реестра контейнеров Azure применяются к каждому геореплицированному региону.
* При отправке образов в геореплицированный реестр или извлечении их из него диспетчер трафика Azure в фоновом режиме отправляет запрос в реестр, расположенный в ближайшем к вам регионе.
* После отправки образа или тега обновления в ближайший регион потребуется некоторое время, чтобы Реестр контейнеров Azure реплицировал манифесты и слои в остальные регионы, которые вы выбрали. Чем больше образ, тем дольше он реплицируется. Образы и теги синхронизируются во всех регионах репликации в соответствии с моделью итоговой согласованности.
* Для управления рабочими процессами, которые зависят от обновлений для геореплицированной репликации, рекомендуется настроить [веб-перехватчики](container-registry-webhook.md) для реагирования на события push-уведомлений. Можно настроить региональные веб-перехватчики в геореплицированном реестре, чтобы отслеживать выполнение событий отправки во всех геореплицированных регионах.

## <a name="delete-a-replica"></a>Удаление реплики

После настройки реплики для реестра ее можно удалить в любое время, если она больше не нужна. Удалите реплику с помощью портал Azure или других средств, таких как [AZ запись контроля доступа Delete](/cli/azure/acr/replication#az-acr-replication-delete) в Azure CLI.

Чтобы удалить реплику в портал Azure, выполните следующие действия.

1. Перейдите к реестру контейнеров Azure и выберите **репликация**.
1. Выберите имя реплики и нажмите кнопку **Удалить**. Подтвердите, что вы хотите удалить реплику.

> [!NOTE]
> Вы не можете удалить реплику реестра в *основном регионе* реестра, то есть в том месте, где был создан реестр. Удалить реплику Home можно только путем удаления самого реестра.

## <a name="geo-replication-pricing"></a>Расходы, связанные с георепликацией

Георепликация — это функция [SKU уровня "Премиум"](container-registry-skus.md) реестра контейнеров Azure. При репликации реестра в необходимые регионы с вас взимается плата за реестры уровня "Премиум" для каждого региона.

В предыдущем примере Contoso объединил два реестра в один, добавив реплики в восточную часть США, Центральную Канаду и Западную Европу. Contoso будет платить за уровень "Премиум" четыре раза в месяц. Для этого не нужна дополнительная настройка и управление. Теперь каждый регион извлекает свои образы локально, повышая производительность и надежность, без дополнительной исходящей платы за сеть начиная от западной части США и заканчивая Канадой и восточной частью США.

## <a name="troubleshoot-push-operations-with-geo-replicated-registries"></a>Устранение неполадок с операциями отправки с использованием геореплицированных реестров
 
Клиент DOCKER, который передает образ в геореплицированный реестр, может отправить все слои образа и его манифест не в один реплицированный регион. Это может произойти из-за того, что диспетчер трафика Azure направляет запросы к реестру в ближайший к сети реплицированный реестр. Если *вблизи* реестра находятся два региона репликации, то слои образа и манифест могут быть распределены между ними, а операция отправки завершится ошибкой при проверке манифеста. Эта проблема возникает из-за того, что DNS-имя реестра разрешается на некоторых узлах Linux. Эта проблема не возникает в Windows, где предоставляется кэш DNS на стороне клиента.
 
В случае возникновения этой проблемы одним из решений является применение кэша DNS на стороне клиента, например `dnsmasq` на узле Linux. Это гарантирует согласованное разрешение имени реестра. Если вы используете виртуальную машину Linux в Azure для отправки в реестр, ознакомьтесь со статьей [Параметры разрешения DNS-имен для виртуальных машин Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/azure-dns).

Чтобы для разрешения DNS-имен при передаче образов использовалась ближайшая реплика, настройте геореплицированный реестр в том же регионе Azure, где находится источник операций отправки, или в ближайшем регионе при работе вне Azure.

## <a name="next-steps"></a>Дополнительная информация

Просмотрите руководство, состоящее из трех частей, [Подготовка геореплицированного реестра контейнеров Azure](container-registry-tutorial-prepare-registry.md). Рассмотрите создание геореплицированного реестра, создание контейнера, а затем его развертывание в несколько региональных экземпляров веб-приложений для контейнеров, выполнив единую команду `docker push`.

> [!div class="nextstepaction"]
> [Подготовка геореплицированного реестра контейнеров Azure](container-registry-tutorial-prepare-registry.md)
