---
title: Политика сохранения немаркированных манифестов
description: Узнайте, как включить политику удержания в реестре контейнеров Azure для автоматического удаления немаркированных манифестов после определенного периода.
ms.topic: article
ms.date: 10/02/2019
ms.openlocfilehash: 912616b6ab95cdff91e70477c7d6de476ccfdfa7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74454814"
---
# <a name="set-a-retention-policy-for-untagged-manifests"></a>Установка политики удержания для немаркированных манифестов

Реестр контейнеров Azure дает вам возможность установить *политику удержания* для сохраненных манифестов изображений, которые не имеют каких-либо связанных тегов *(неотмеченные манифесты).* При включении политики удержания немаркированные манифесты в реестре автоматически удаляются по исчисляемым нескольким днями. Эта функция предотвращает заполнение реестра артефактами, которые не нужны, и помогает сэкономить на расходах на хранение. Если `delete-enabled` атрибут немаркированного манифеста `false`установлен, манифест не может быть удален, а политика удержания не применяется.

Для выполнения примеров команд в этой статье можно использовать оболочку Azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.74 или позже. Чтобы узнать версию, выполните команду `az --version`. Если вам нужно установить или обновить, [см.][azure-cli]

> [!IMPORTANT]
> Сейчас эта функция доступна в предварительной версии, и применяются [некоторые ограничения](#preview-limitations). Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> Установите политику удержания с осторожностью - удаленные данные изображения UNRECOVERABLE. Если у вас есть системы, которые тянут изображения с помощью явного дайджеста (в отличие от имени изображения), не следует устанавливать политику удержания для немаркированных манифестов. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо получения с помощью манифеста попробуйте внедрить схему *уникальных тегов*, которая [рекомендуется в качестве лучшей методики](container-registry-image-tag-version.md).

## <a name="preview-limitations"></a>Ограничения предварительной версии

* Только реестр контейнеров **Premium** может быть настроен с политикой удержания. Для получения информации о уровнях обслуживания реестра, см [Azure контейнерных реестров SKUs](container-registry-skus.md).
* Можно установить политику удержания только для немаркированных манифестов.
* Политика удержания в настоящее время применяется только к манифестам, которые не отогнаны *после включения* политики. Существующие немаркированные манифесты в реестре не подпадают под действие политики. Чтобы удалить существующие немаркированные манифесты, см. примеры [изображений контейнеров Delete в реестре контейнеров Azure](container-registry-delete.md)Container Registry.

## <a name="about-the-retention-policy"></a>О политике удержания

Реестр контейнеров Azure имеет ссылку на кавыки в реестре. Когда манифест не маркирован, он проверяет политику удержания. При включении политики удержания в очередь выстраивается в очередь операция явного удаления с определенной датой в зависимости от количества дней, установленных в политике.

Отдельное задание управления очередями постоянно обрабатывает сообщения, масштабируя по мере необходимости. В качестве примера предположим, что вы не отметили два манифеста, с то номинала 1 час, в реестре с политикой удержания 30 дней. Два сообщения будут стоять в очереди. Затем, 30 дней спустя, примерно с 1 часом друг от друга, сообщения будут извлечены из очереди и обработаны, предполагая, что политика все еще действует.

## <a name="set-a-retention-policy---cli"></a>Установите политику удержания - CLI

В следующем примере показано, как использовать ClI Azure для установки политики удержания немаркированных манифестов в реестре.

### <a name="enable-a-retention-policy"></a>Включить политику удержания

По умолчанию в реестре контейнеров не устанавливается политика удержания. Чтобы настроить или обновить политику удержания, запустите команду [обновления удержания][az-acr-config-retention-update] az acr в Azure CLI. Вы можете указать количество дней между 0 и 365, чтобы сохранить неотмеченные манифесты. Если вы не указали количество дней, команда устанавливает по умолчанию 7 дней. После периода удержания все немаркированные манифесты в реестре автоматически удаляются.

Следующий пример устанавливает политику удержания 30 дней для untagged манифестов в *myregistry*регистратура регистра:

```azurecli
az acr config retention update --registry myregistry --status enabled --days 30 --type UntaggedManifests
```

В следующем примере устанавливается политика для удаления любого манифеста в реестре, как только он не имеет помечены. Создайте эту политику, установив период удержания 0 дней. 

```azurecli
az acr config retention update --registry myregistry --status enabled --days 0 --type UntaggedManifests
```

### <a name="validate-a-retention-policy"></a>Проверка политики удержания

Если вы включите предыдущую политику с периодом хранения 0 дней, вы можете быстро проверить, что неотмеченные манифесты удаляются:

1. Нажмите изображение `hello-world:latest` тестового изображения в свой реестр или замените другое тестовое изображение по вашему выбору.
1. Отметьте `hello-world:latest` изображение, например, используя команду [репозитория az acr untag.][az-acr-repository-untag] Непомеченный манифест остается в реестре.
    ```azurecli
    az acr repository untag --name myregistry --image hello-world:latest
    ```
1. В течение нескольких секунд непомеченный манифест удаляется. Вы можете проверить удаление, перечислив манифесты в репозитории, например, используя команду [шоу-явок репозитория az acr.][az-acr-repository-show-manifests] Если тестовое изображение было единственным в репозитории, само репозиторий удаляется.

### <a name="disable-a-retention-policy"></a>Отключить политику удержания

Чтобы увидеть политику удержания, установленную в реестре, запустите команду [шоу-шоу acr acr:][az-acr-config-retention-show]

```azurecli
az acr config retention show --registry myregistry
```

Чтобы отключить политику удержания в реестре, запустите команду [обновления удержания][az-acr-config-retention-update] az acr и установите: `--status disabled`

```azurecli
az acr config retention update --registry myregistry --status disabled --type UntaggedManifests
```

## <a name="set-a-retention-policy---portal"></a>Установка политики удержания - портал

Вы также можете установить политику удержания реестра на [портале Azure.](https://portal.azure.com) Ниже приводится следующий пример, как использовать портал для установки политики удержания для немаркированных манифестов в реестре.

### <a name="enable-a-retention-policy"></a>Включить политику удержания

1. Перейдите в реестр контейнеров Azure. В соответствии с **политиками**выберите **Сохранение** (Предварительный просмотр).
1. В **статусе**, выберите **Включено**.
1. Выберите несколько дней между 0 и 365, чтобы сохранить немаркированные манифесты. Нажмите кнопку **Сохранить**.

![Включить политику удержания на портале Azure](media/container-registry-retention-policy/container-registry-retention-policy01.png)

### <a name="disable-a-retention-policy"></a>Отключить политику удержания

1. Перейдите в реестр контейнеров Azure. В соответствии с **политиками**выберите **Сохранение** (Предварительный просмотр).
1. В **статусе**, выберите **инвалида**. Нажмите кнопку **Сохранить**.

## <a name="next-steps"></a>Дальнейшие действия

* Подробнее о вариантах [удаления изображений и репозиторий](container-registry-delete.md) в реестре контейнеров Azure

* Узнайте, как [автоматически очистить](container-registry-auto-purge.md) выбранные изображения и манифесты из реестра

* Подробнее о вариантах [блокировки изображений и манифестов](container-registry-image-lock.md) в реестре

<!-- LINKS - external -->
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/


<!-- LINKS - internal -->
[azure-cli]: /cli/azure/install-azure-cli
[az-acr-config-retention-update]: /cli/azure/acr/config/retention#az-acr-config-retention-update
[az-acr-config-retention-show]: /cli/azure/acr/config/retention#az-acr-config-retention-show
[az-acr-repository-untag]: /cli/azure/acr/repository#az-acr-repository-untag
[az-acr-repository-show-manifests]: /cli/azure/acr/repository#az-acr-repository-show-manifests
