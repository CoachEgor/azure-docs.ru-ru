---
title: Политика для удержания манифестов без тегов
description: Узнайте, как включить политику хранения в реестре контейнеров Azure для автоматического удаления манифестов без тегов после определенного периода.
ms.topic: article
ms.date: 10/02/2019
ms.openlocfilehash: 912616b6ab95cdff91e70477c7d6de476ccfdfa7
ms.sourcegitcommit: 12d902e78d6617f7e78c062bd9d47564b5ff2208
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/24/2019
ms.locfileid: "74454814"
---
# <a name="set-a-retention-policy-for-untagged-manifests"></a>Задание политики хранения для манифестов без тегов

Реестр контейнеров Azure позволяет задать *политику хранения* для сохраненных манифестов изображений, которые не имеют связанных*тегов (без тегов)* . Если включена политика хранения, манифесты без тегов в реестре автоматически удаляются по истечении заданного количества дней. Эта функция предотвращает заполнение реестра ненужными артефактами и помогает сэкономить на затратах на хранение. Если атрибут `delete-enabled` манифеста без тегов имеет значение `false`, манифест не может быть удален, а политика хранения не применяется.

Для выполнения примеров команд в этой статье можно использовать Azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.74 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli].

> [!IMPORTANT]
> Сейчас эта функция доступна в предварительной версии, и применяются [некоторые ограничения](#preview-limitations). Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> Задать политику хранения с осторожностью — удаленные данные образа являются невосстанавливаемыми. При наличии систем, которые извлекают образы по дайджесту манифеста (в отличие от имени образа), не следует задавать политику хранения для манифестов без тегов. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо того чтобы извлекать манифест, рекомендуется использовать *уникальную схему тегов* , [рекомендуемую рекомендацию](container-registry-image-tag-version.md).

## <a name="preview-limitations"></a>Ограничения предварительной версии

* С политикой хранения можно настроить только реестр контейнеров уровня " **премиум** ". Сведения о уровнях служб реестра см. в статье [номера SKU реестра контейнеров Azure](container-registry-skus.md).
* Политику хранения можно задать только для манифестов без тегов.
* Политика хранения в настоящее время применяется только к манифестам, которые не помечены *после* включения политики. Существующие манифесты без тегов в реестре не подчиняются политике. Чтобы удалить существующие манифесты без тегов, см. примеры в разделе [Удаление образов контейнеров в реестре контейнеров Azure](container-registry-delete.md).

## <a name="about-the-retention-policy"></a>О политике хранения

Реестр контейнеров Azure выполняет подсчет ссылок для манифестов в реестре. Если манифест не помечен, он проверяет политику хранения. Если политика хранения включена, операция удаления манифеста помещается в очередь с определенной датой в соответствии с числом дней, установленным в политике.

Отдельное задание управления очередями постоянно обрабатывает сообщения, масштабирование по мере необходимости. В качестве примера предположим, что вы разметили два манифеста (1 час) в реестре с политикой хранения в течение 30 дней. Два сообщения помещаются в очередь. Затем, через 30 дней позже, примерно через 1 час, сообщения извлекаются из очереди и обрабатываются, предполагая, что политика все еще действует.

## <a name="set-a-retention-policy---cli"></a>Настройка политики хранения-CLI

В следующем примере показано, как использовать Azure CLI, чтобы задать политику хранения для манифестов без тегов в реестре.

### <a name="enable-a-retention-policy"></a>Включение политики хранения

По умолчанию в реестре контейнеров не задана политика хранения. Чтобы задать или обновить политику хранения, выполните команду [AZ контроля доступа config retention Update][az-acr-config-retention-update] в Azure CLI. Можно указать число дней от 0 до 365, чтобы хранить манифесты без тегов. Если не указать число дней, команда задает значение по умолчанию 7 дней. По истечении срока хранения все манифесты без тегов в реестре автоматически удаляются.

В следующем примере задается политика хранения в течение 30 дней для манифестов без тегов в реестре *myregistry*:

```azurecli
az acr config retention update --registry myregistry --status enabled --days 30 --type UntaggedManifests
```

В следующем примере задается политика для удаления манифеста в реестре, как только он размечен. Создайте эту политику, задав срок хранения в 0 дней. 

```azurecli
az acr config retention update --registry myregistry --status enabled --days 0 --type UntaggedManifests
```

### <a name="validate-a-retention-policy"></a>Проверка политики хранения

При включении предыдущей политики с периодом хранения, равным 0 дням, можно быстро проверить удаление непомеченных манифестов:

1. Отправьте тестовое изображение `hello-world:latest` образ в реестр или замените еще одно тестовое изображение по своему усмотрению.
1. Удалить тег образ `hello-world:latest`, например, с помощью команды [AZ контроля репозиторий удалить тег][az-acr-repository-untag] . Манифест без тегов остается в реестре.
    ```azurecli
    az acr repository untag --name myregistry --image hello-world:latest
    ```
1. Через несколько секунд манифест без тегов удаляется. Чтобы проверить удаление, перечислите манифесты в репозитории, например, с помощью команды [AZ запись в репозитории "отобразить-манифесты][az-acr-repository-show-manifests] ". Если тестовый образ был единственным в репозитории, сам репозиторий удаляется.

### <a name="disable-a-retention-policy"></a>Отключение политики хранения

Чтобы просмотреть политику хранения, заданную в реестре, выполните команду [AZ контроля доступа config retention-Показать][az-acr-config-retention-show] :

```azurecli
az acr config retention show --registry myregistry
```

Чтобы отключить политику хранения в реестре, выполните команду [AZ контроля доступа конфигурации обновления retention][az-acr-config-retention-update] и задайте `--status disabled`:

```azurecli
az acr config retention update --registry myregistry --status disabled --type UntaggedManifests
```

## <a name="set-a-retention-policy---portal"></a>Настройка политики хранения — портал

Также можно задать политику хранения реестра в [портал Azure](https://portal.azure.com). В следующем примере показано, как с помощью портала задать политику хранения для манифестов без тегов в реестре.

### <a name="enable-a-retention-policy"></a>Включение политики хранения

1. Перейдите к реестру контейнеров Azure. В разделе **политики**выберите **срок хранения** (Предварительная версия).
1. В списке **состояние**выберите **включено**.
1. Выберите число дней от 0 до 365 для удержания манифестов без тегов. Щелкните **Сохранить**.

![Включение политики хранения в портал Azure](media/container-registry-retention-policy/container-registry-retention-policy01.png)

### <a name="disable-a-retention-policy"></a>Отключение политики хранения

1. Перейдите к реестру контейнеров Azure. В разделе **политики**выберите **срок хранения** (Предварительная версия).
1. В списке **состояние**выберите **отключено**. Щелкните **Сохранить**.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения о параметрах [удаления образов и репозиториев](container-registry-delete.md) в реестре контейнеров Azure

* Узнайте, как [автоматически очищать](container-registry-auto-purge.md) выбранные образы и манифесты из реестра

* Дополнительные сведения о параметрах [блокировки образов и манифестов](container-registry-image-lock.md) в реестре

<!-- LINKS - external -->
[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/


<!-- LINKS - internal -->
[azure-cli]: /cli/azure/install-azure-cli
[az-acr-config-retention-update]: /cli/azure/acr/config/retention#az-acr-config-retention-update
[az-acr-config-retention-show]: /cli/azure/acr/config/retention#az-acr-config-retention-show
[az-acr-repository-untag]: /cli/azure/acr/repository#az-acr-repository-untag
[az-acr-repository-show-manifests]: /cli/azure/acr/repository#az-acr-repository-show-manifests
