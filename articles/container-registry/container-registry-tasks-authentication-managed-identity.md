---
title: Использование управляемого удостоверения с задачами реестра контейнеров Azure
description: Включите управляемое удостоверение для ресурсов Azure в задаче реестра контейнеров Azure, чтобы разрешить этой задаче доступ к другим ресурсам Azure, включая другие закрытые реестры контейнеров.
services: container-registry
author: dlepow
manager: gwallace
ms.service: container-registry
ms.topic: article
ms.date: 07/11/2019
ms.author: danlep
ms.openlocfilehash: 9f7c083a079e42172a9e2865f90293fa4d6813d8
ms.sourcegitcommit: 3877b77e7daae26a5b367a5097b19934eb136350
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "68640411"
---
# <a name="use-an-azure-managed-identity-in-acr-tasks"></a>Использование удостоверения, управляемого Azure, в задачах контроля доступа 

Включите [управляемое удостоверение для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) в [задаче записи контроля](container-registry-tasks-overview.md)доступа, чтобы задача могла получить доступ к другим ресурсам Azure без необходимости предоставлять учетные данные или управлять ими. Например, можно использовать управляемое удостоверение, чтобы сделать шаг задачи запрашивать или отправлять образы контейнеров в другой реестр.

Из этой статьи вы узнаете, как использовать Azure CLI для включения управляемого удостоверения, назначенного пользователем или системой, в задаче записи контроля доступа. Можно использовать Azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.68 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

Сценарии для доступа к защищенным ресурсам из задачи контроля доступа с помощью управляемого удостоверения см. в следующих статьях:

* [Проверка подлинности между реестрами](container-registry-tasks-cross-registry-authentication.md)
* [Доступ к внешним ресурсам с помощью секретов, хранящихся в Azure Key Vault](container-registry-tasks-authentication-key-vault.md)

## <a name="why-use-a-managed-identity"></a>Для чего нужны управляемые удостоверения?

Управляемое удостоверение для ресурсов Azure предоставляет выбранные службы Azure с автоматически управляемым удостоверением в Azure Active Directory (Azure AD). Вы можете настроить задачу контроля учетных записей с помощью управляемого удостоверения, чтобы задача могла получать доступ к другим защищенным ресурсам Azure без передачи учетных данных в шагах задач.

Управляемые удостоверения бывают двух типов:

* *Назначенные пользователю удостоверения*, которые можно назначить нескольким ресурсам и сохранять в течение всего времени. Назначаемые пользователем удостоверения сейчас доступны в предварительной версии.

* *Назначенное системой удостоверение*, которое является уникальным для конкретного ресурса, например задачи записи контроля доступа и продолжается в течение времени существования этого ресурса.

В задаче контроля доступа можно включить один или оба типа удостоверений. Предоставьте удостоверению доступ к другому ресурсу, как и любому субъекту безопасности. При выполнении задачи она использует удостоверение для доступа к ресурсу во всех шагах задач, требующих доступа.

## <a name="steps-to-use-a-managed-identity"></a>Действия по использованию управляемого удостоверения

Выполните эти высокоуровневые действия, чтобы использовать управляемое удостоверение с задачей контроля доступа.

### <a name="1-optional-create-a-user-assigned-identity"></a>1. Используемых Создание назначенного пользователем удостоверения

Если вы планируете использовать назначенное пользователем удостоверение, можно использовать существующее удостоверение. Или создайте удостоверение с помощью Azure CLI или других средств Azure. Например, используйте команду [AZ Identity Create][az-identity-create] . 

Если вы планируете использовать только назначенное системой удостоверение, пропустите этот шаг. При создании задачи контроля учетных записей можно создать удостоверение, назначенное системой.

### <a name="2-enable-identity-on-an-acr-task"></a>2. Включить удостоверение для задачи записи контроля доступа

При создании задачи записи контроля доступа при необходимости можно включить пользовательское удостоверение, назначенное системой удостоверение или и то, и другое. Например, передайте `--assign-identity` параметр при выполнении команды [AZ контроля][az-acr-task-create] доступа на создание в Azure CLI.

Чтобы включить назначенное системой удостоверение, передайте `--assign-identity` без значения или. `assign-identity [system]` Следующая команда создает задачу Linux из общедоступного репозитория GitHub, который создает `hello-world` образ с триггером фиксации Git и с управляемым удостоверением, назначенным системой:

```azurecli
az acr task create \
    --image hello-world:{{.Run.ID}} \
    --name hello-world --registry MyRegistry \
    --context https://github.com/Azure-Samples/acr-build-helloworld-node.git \
    --file Dockerfile \
    --assign-identity
```

Чтобы включить назначенное пользователем удостоверение, передайте `--assign-identity` значение *идентификатора ресурса* удостоверения. Следующая команда создает задачу Linux из общедоступного репозитория GitHub, который создает `hello-world` образ с триггером фиксации Git и с управляемым удостоверением, назначаемым пользователем.

```azurecli
az acr task create \
    --image hello-world:{{.Run.ID}} \
    --name hello-world --registry MyRegistry \
    --context https://github.com/Azure-Samples/acr-build-helloworld-node.git \
    --file Dockerfile \
    --assign-identity <resourceID>
```

Идентификатор ресурса для удостоверения можно получить, выполнив команду [AZ Identity показывать][az-identity-show] . Идентификатор ресурса для идентификатора *мюсерассигнедидентити* в группе ресурсов *myResourceGroup* имеет форму. 

```
"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myUserAssignedIdentity"
```

### <a name="3-grant-the-identity-permissions-to-access-other-azure-resources"></a>3. Предоставление удостоверениям разрешения на доступ к другим ресурсам Azure

В зависимости от требований задачи предоставьте удостоверениям разрешения на доступ к другим ресурсам Azure. Примеры приведены ниже.

* Назначьте управляемому удостоверению роль с запросом на включение внесенных изменений, принудительную отправку и извлечение или другие разрешения для целевого реестра контейнеров в Azure. Полный список ролей реестра см. в статье [роли и разрешения реестра контейнеров Azure](container-registry-roles.md). 
* Назначьте управляемому удостоверению роль для чтения секретов в хранилище ключей Azure.

Используйте [Azure CLI](../role-based-access-control/role-assignments-cli.md) или другие инструменты Azure для управления доступом на основе ролей к ресурсам. Например, выполните команду [AZ Role назначение Create][az-role-assignment-create] , чтобы назначить удостоверение роли удостоверению. 

В следующем примере управляемому удостоверению присваивается разрешение на извлечение из реестра контейнеров. Команда задает *идентификатор субъекта-службы* удостоверения и *идентификатор ресурса* целевого реестра.


```azurecli
az role assignment create --assignee <servicePrincipalID> --scope <registryID> --role acrpull
```

### <a name="4-optional-add-credentials-to-the-task"></a>4. Используемых Добавление учетных данных в задачу

Если задача запрашивает или отправляет образы в другой реестр контейнеров Azure, добавьте в задачу учетные данные для проверки подлинности. Выполните команду [AZ запись контроля учетных данных][az-acr-task-credential-add] и передайте `--use-identity` параметр, чтобы добавить учетные данные удостоверения в задачу. 

Например, чтобы добавить учетные данные для назначенного системой удостоверения для проверки подлинностив реестре `use-identity [system]`таржетрегистри, передайте:

```azurecli
az acr task credential add \
    --name helloworld \
    --registry myregistry \
    --login-server targetregistry.azurecr.io \
    --use-identity [system]
```

Чтобы добавить учетные данные для назначенного пользователем удостоверения для проверки подлинности в реестре *таржетрегистри*, передайте `use-identity` значение *идентификатора клиента* удостоверения. Пример:

```azurecli
az acr task credential add \
    --name helloworld \
    --registry myregistry \
    --login-server targetregistry.azurecr.io \
    --use-identity <clientID>
```

Идентификатор клиента для удостоверения можно получить, выполнив команду [AZ Identity показывать][az-identity-show] . Идентификатор клиента является идентификатором GUID формы `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`.

## <a name="next-steps"></a>Следующие шаги

В этой статье вы узнали, как включить и использовать назначенное пользователем или управляемое системой удостоверение для задачи контроля учетных записей. Сценарии для доступа к защищенным ресурсам из задачи контроля доступа с помощью управляемого удостоверения см. в следующих статьях:

* [Проверка подлинности между реестрами](container-registry-tasks-cross-registry-authentication.md)
* [Доступ к внешним ресурсам с помощью секретов, хранящихся в Azure Key Vault](container-registry-tasks-authentication-key-vault.md)


<!-- LINKS - Internal -->
[az-role-assignment-create]: /cli/azure/role/assignment#az-role-assignment-create
[az-identity-create]: /cli/azure/identity#az-identity-create
[az-identity-show]: /cli/azure/identity#az-identity-show
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-acr-task-credential-add]: /cli/azure/acr/task/credential#az-acr-task-credential-add
[azure-cli-install]: /cli/azure/install-azure-cli
