---
title: Подключение к конечным точкам для Azure VMs&стандартных ILB в сценариях SAP HA
description: Общедоступное подключение конечных точек для виртуальных машин с использованием балансировора стандартной нагрузки Azure в сценариях высокой доступности SAP
services: virtual-machines-windows,virtual-network,storage,
documentationcenter: saponazure
author: rdeltcheva
manager: juergent
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-windows
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure-services
ms.date: 02/07/2020
ms.author: radeltch
ms.openlocfilehash: 4fd01764c183098a8bd78d502eea7ab173fa22cc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80293916"
---
# <a name="public-endpoint-connectivity-for-virtual-machines-using-azure-standard-load-balancer-in-sap-high-availability-scenarios"></a>Общедоступное подключение конечных точек для виртуальных машин с использованием балансировора стандартной нагрузки Azure в сценариях высокой доступности SAP

Область действия этой статьи заключается в описании конфигураций, которые позволят исходящим подключениям к общедоступной конечной точке(ы). Конфигурации в основном в контексте высокой доступности с Pacemaker для SUSE / RHEL.  

Если вы используете Pacemaker с агентом забора Azure в решении с высокой доступностью, то вс-ч должны иметь исходящие подключения к API управления Azure.  
В статье представлено несколько вариантов, позволяющих выбрать вариант, который лучше всего подходит для вашего сценария.  

## <a name="overview"></a>Обзор

При внедрении высокой доступности решений SAP с помощью кластеризации одним из необходимых компонентов является [Azure Load Balancer.](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview) Azure предлагает два балансировора нагрузки: стандартные и базовые.

Балансизатор нагрузки Standard Azure предлагает некоторые преимущества по сравнению с балансиватором основной нагрузки. Например, он работает в зонах доступности Azure, имеет лучшие возможности мониторинга и регистрации для более простой устранения неполадок, снижения задержки. Функция "HA ports" охватывает все порты, то есть больше нет необходимости перечислять все отдельные порты.  

Есть некоторые важные различия между базовым и стандартным Балансером нагрузки SKU Azure. Одним из них является обработка исходящего трафика до конечной точки. Для полного базового против стандартного sKU балансомер для сравнения нагрузки, [см.](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview)  
 
Когда ВМ без общедоступных IP-адресов помещаются в пул бэкэнда внутреннего (без публичного IP-адреса) балансируев нагрузки Standard Azure, исходящих подключений к конечным точкам общего пользования не существует, если не будет выполнена дополнительная конфигурация.  

Если VM присваивается общедоступный IP-адрес, или VM находится в бэкэндпуле балансоилира нагрузки с общедоступным IP-адресом, он будет иметь исходящий подключение к конечным точкам общего пользования.  

Системы SAP часто содержат конфиденциальные бизнес-данные. Для vMs-систем, худавиваемых систем sAP, редко бывает приемлемым иметь общедоступные IP-адреса. В то же время существуют сценарии, которые требуют исходящего подключения от VM до общедоступных конечных точек.  

Примерами сценариев, требующих доступа к конечной точке Azure, являются:  
- Использование Azure Fence Agent в качестве механизма ограждения в кластерах Pacemaker
- Azure Backup
- Azure Site Recovery  
- Использование общедоступного репозитория для исправления операционной системы
- Поток данных приложения SAP может потребовать исходящего подключения к общедоступной точке

Если развертывание SAP не требует исходящего подключения к конечным точкам общего пользования, не требуется реализовать дополнительную конфигурацию. Достаточно создать внутренний стандартный баланс омнитель загрузки SKU Azure для сценария высокой доступности, предполагая, что также нет необходимости в входящих подключениях из конечных точек общего пользования.  

> [!Note]
> Когда ВМ без общедоступных IP-адресов помещаются в пул бэкэнда внутреннего (без публичного IP-адреса) балансируев нагрузки Standard Azure, не будет исходящих подключений к Интернету, если не будет выполнена дополнительная конфигурация, позволяющая осуществлять реаутирование в конечные точки общего пользования.  
>Если у ВМ есть либо общедоступные IP-адреса, либо они уже находятся в пуле бэкэнда балансирутеля Azure Load с общедоступным IP-адресом, VM уже будет иметь исходящий подключение к конечным точкам общего пользования.


Сначала прочитайте следующие документы:

* Балансизатор стандартной нагрузки Azure
  * [Обзор баланса стандартных нагрузок Azure](https://docs.microsoft.com/azure/load-balancer/load-balancer-standard-overview) - всеобъемлющий обзор балансивизатора стандартной нагрузки Azure, важных принципов, концепций и учебников 
  * [Исходящие соединения в Azure](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-connections#scenarios) - сценарии, как достичь исходящего подключения в Azure
  * [Правила исходящего баланса нагрузки](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-rules-overview)- разъясняют понятия исходящих правил исходящего баланса нагрузки и как создавать исходящие правила
* Брандмауэр Azure
  * [Обзор брандмауэра Azure](https://docs.microsoft.com/azure/firewall/overview)- обзор брандмауэра Azure
  * [Учебник: Развертывание и настройка Брандмауэра Azure](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal) - инструкции по настройке брандмауэра Azure через портал Azure
* [Виртуальные сети - Пользовательские правила](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview#user-defined) - Концепции и правила разгрома Azure  
* [Теги службы безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) групп - как упростить группы сетевой безопасности и конфигурацию Firewall с помощью тегов служб

## <a name="additional-external-azure-standard-load-balancer-for-outbound-connections-to-internet"></a>Дополнительный внешний балансировка стандартной нагрузки Azure для исходящих подключений к интернету

Один из вариантов достижения исходящих подключений к общедоступным конечным точкам, не допуская входящих подключений к VM из публичной конечной точки, заключается в создании второго балансисатора нагрузки с публичным IP-адресом, добавления ВМ в пул бэкэнда второго балансодержателя нагрузки и определение только [исходящих правил.](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-rules-overview)  
Используйте [группы сетевой безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview) для управления общедоступными конечными точками, доступными для исходящих вызовов из VM.  
Для получения дополнительной информации см. Сценарий 2 в [документе Исходящие соединения](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-connections#scenarios).  
Конфигурация будет выглядеть следующим:  

![Управление подключением к конечным точкам с помощью групп сетевой безопасности](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-public.png)

### <a name="important-considerations"></a>Важные сведения

- Вы можете использовать один дополнительный балансер общественной нагрузки для нескольких VMs в той же подсети для достижения исходящего подключения к общедоступной конечной точке и оптимизации затрат  
- Используйте [группы сетевой безопасности](https://docs.microsoft.com/azure/virtual-network/security-overview) для контроля, какие общедоступные конечные точки доступны из VMs. Вы можете назначить группу сетевой безопасности либо в подсеть, либо на каждый VM. Там, где это возможно, используйте [теги службы,](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) чтобы уменьшить сложность правил безопасности.  
- Стандартный балансомер загрузки Azure с общедоступным IP-адресом и правилами исходящих обеспечивает прямой доступ к общедоступной конечной точке. Если у вас есть корпоративные требования безопасности, чтобы все исходящие трафика пройти через централизованное корпоративное решение для аудита и ведения журнала, вы не можете быть в состоянии выполнить требование с этим сценарием.  

>[!TIP]
>Там, где это возможно, используйте [теги службы,](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) чтобы уменьшить сложность группы сетевой безопасности. 

### <a name="deployment-steps"></a>Шаги по развертыванию

1. Создание балансировщика нагрузки  
   1. На [портале Azure](https://portal.azure.com) щелкните все ресурсы, добавьте, а затем **ищите балансер нагрузки**  
   1. Нажмите **Создать** 
   1. Название балансобаланса нагрузки **MyPublicILB**  
   1. Выберите **публику** как тип, **стандарт** как SKU  
   1. Выберите **Создать общественный IP-адрес** и указать как имя **MyPublicILBFrondEndIP**  
   1. Выберите **зону излишних** в качестве зоны доступности  
   1. Нажмите Просмотр и Создать, а затем нажмите Создать  
2. Создайте пул **Backend MyBackendPoolOfPublicILB** и добавьте VMs.  
   1. Выберите виртуальную сеть  
   1. Выберите VMs и их IP-адреса и добавьте их в пул бэкэнда  
3. [Создание исходящих правил.](https://docs.microsoft.com/azure/load-balancer/configure-load-balancer-outbound-cli#create-outbound-rule) В настоящее время невозможно создать исходящие правила с портала Azure. Вы можете создавать исходящие правила с [помощью Azure CLI.](https://docs.microsoft.com/azure/cloud-shell/overview?view=azure-cli-latest)  

   ```azurecli
    az network lb outbound-rule create --address-pool MyBackendPoolOfPublicILB --frontend-ip-configs MyPublicILBFrondEndIP --idle-timeout 30 --lb-name MyPublicILB --name MyOutBoundRules  --outbound-ports 10000 --enable-tcp-reset true --protocol All --resource-group MyResourceGroup
   ```

4. Создание правил группы сетевой безопасности для ограничения доступа к определенным конечным точкам. Если есть существующая группа сетевой безопасности, ее можно настроить. В приведенном ниже примере показано, как включить доступ к API управления Azure: 
   1. Перейдите к группе сетевой безопасности
   1. Нажмите на правила безопасности исходящих
   1. Добавьте правило, чтобы **запретить** все исходящие доступ к **Интернету**.
   1. Добавьте **правило, позволяющее разрешить** доступ к **AzureCloud,** с приоритетом ниже, чем приоритет правила, чтобы отказать во всем доступе в Интернет.


   Правила безопасности исходящих будут выглядеть следующим: 

   ![Исходящие соединения со балансом второй нагрузки с общественным IP](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-network-security-groups.png)

   Для получения дополнительной информации о [ ](https://docs.microsoft.com/azure/virtual-network/security-overview)группах безопасности сети Azure см. 

## <a name="azure-firewall-for-outbound-connections-to-internet"></a>Брандмауэр Azure для исходящих подключений к интернету

Другим вариантом достижения исходящего подключения к конечным точкам общего пользования без входящего подключения к VM из общедоступных конечных точек является Azure Firewall. Azure Firewall — это управляемая служба со встроенной высокой доступностью, которая может охватывать несколько зон доступности.  
Вам также нужно будет развернуть [пользовательский маршрут,](https://docs.microsoft.com/azure/virtual-network/virtual-networks-udr-overview#custom-routes)связанный с подсетью, где развернуты vMs и балансиватор нагрузки Azure, указывая на брандмауэр Azure, для маршрутизации трафика через брандмауэр Azure.  
Подробную информацию о развертывании брандмауэра Azure Firewall можно найти в [развертывании и настройке брандмауэра Azure Firewall.](https://docs.microsoft.com/azure/firewall/tutorial-firewall-deploy-portal)  

Архитектура выглядит следующим образом:

![Выходное соединение с брандмауэром Azure](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-firewall.png)

### <a name="important-considerations"></a>Важные сведения

- Брандмауэр Azure — это нативная служба облачных технологий со встроенным высокой доступностью и поддерживает зональные развертывания.
- Требуется дополнительная подсеть, которая должна называться AzureFirewallSubnet. 
- При передаче больших наборов данных, исходящих из виртуальной сети, где расположены SAP VMs, в VM в другой виртуальной сети или в конечную точку, это может быть не экономически эффективным решением. Одним из таких примеров является копирование больших резервных копий в виртуальных сетях. Для получения подробной информации см.  
- Если корпоративное решение Firewall не является Azure Firewall, и у вас есть требования к безопасности, чтобы все исходящие трафика проходят, хотя централизованное корпоративное решение, это решение может быть непрактичным.  

>[!TIP]
>Там, где это возможно, используйте [теги служб,](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags) чтобы уменьшить сложность правил Azure Firewall.  

### <a name="deployment-steps"></a>Шаги по развертыванию

1. Шаги развертывания предполагают, что у вас уже есть виртуальная сеть и подсеть, определенные для ваших виртуальных технологий.  
2. Создайте Subnet **AzureFirewallSubnet** в той же виртуальной сети, где развернуты VMS и балансер стандартной нагрузки.  
   1. На портале Azure перейдите в виртуальную сеть: нажмите на все ресурсы, ищите виртуальную сеть, нажмите на виртуальную сеть, выберите подсети.  
   1. Нажмите Добавить Subnet. Введите **AzureFirewallSubnet** в качестве имени. Введите соответствующий диапазон адресов. Щелкните Save (Сохранить).  
3. Создайте брандмауэр Azure Firewall.  
   1. На портале Azure выберите все ресурсы, нажмите Добавить, Брандмауэр, Создайте. Выберите группу ресурсов (выберите ту же группу ресурсов, где находится Виртуальная сеть).  
   1. Введите имя ресурса Azure Firewall. Например, **MyAzureFirewall**.  
   1. Выберите Регион и выберите по крайней мере две зоны доступности, согласованные с зонами доступности, где развернуты ваши ВМ.  
   1. Выберите виртуальную сеть, где развернуты SAP VMs и балансилер стандартной загрузки Azure.  
   1. Общественный IP-адрес: Нажмите создать и ввести имя. Например **MyFirewallPublicIP**.  
4. Создайте правило Azure Firewall, позволяющее исходящим подключениям к определенным конечным точкам общего пользования. На примере показано, как разрешить доступ к общедоступной конечной точке API управления Azure.  
   1. Выберите правила, сбор правил сети, а затем нажмите Добавить сетевой сбор правил.  
   1. Имя: **MyOutboundRule**, введите Приоритет, Выберите действие **Разрешить**.  
   1. Сервис: Название **ToAzureaPI**.  Протокол: Выберите **любой**. Адрес источника: введите диапазон для вашей подсети, где, например, развернуты VMs и Standard Load Balancer: **11.97.0.0.0/24**. Порты назначения: введите <b>*</b>.  
   1. Сохранять
   1. Поскольку вы все еще расположены на брандмауэре Azure, выберите обзор. Запишите частный IP-адрес брандмауэра Azure Firewall.  
5. Создание маршрута к брандмауэру Azure  
   1. На портале Azure выберите все ресурсы, а затем нажмите Добавить, Маршрут таблицы, Создать.  
   1. Введите имя MyRouteTable, выберите подписку, группу ресурсов и местоположение (соответствует местоположению вашей виртуальной сети и брандмауэра).  
   1. Сохранять  

   Правило брандмауэра будет ![выглядеть следующим: исходящие соединения с Брандмауэром Azure](./media/high-availability-guide-standard-load-balancer/high-availability-guide-standard-load-balancer-firewall-rule.png)

6. Создавайте пользовательский маршрут из подсети вашего ввоза на частный IP **MyAzureFirewall.**
   1. Как вы расположены на маршруте таблицы, нажмите Маршруты. Выберите "Добавить". 
   1. Название маршрута: ToMyAzureFirewall, адресная префикс: **0.0.0.0/0**. Следующий тип перехода: Выберите виртуальный прибор. Следующий адрес перехода: введите личный IP-адрес настроенного вами брандмауэра: **11.97.1.4**.  
   1. Сохранять

## <a name="using-proxy-for-pacemaker-calls-to-azure-management-api"></a>Использование прокси для вызовов Pacemaker на API управления Azure

Можно использовать прокси-сервер, чтобы разрешить вызовы Pacemaker в общедоступный конечный пункт Управления Управления Azure.  

### <a name="important-considerations"></a>Важные сведения

  - Если уже есть корпоративный прокси на месте, вы можете маршрут исходящих вызовов в открытых конечных точках через него. Исходящие вызовы в общедоступные конечные точки будут проходить через корпоративный контрольный пункт.  
  - Убедитесь, что конфигурация прокси позволяет подключение к API управления Azure:`https://management.azure.com`  
  - Убедитесь, что есть маршрут от VMs до прокси  
  - Прокси будет обрабатывать только http/HTTPS вызовов. При наличии дополнительной необходимости совершать исходящие вызовы в конечную точку по различным протоколам (например, RFC) потребуется альтернативное решение  
  - Прокси решение должно быть очень доступным, чтобы избежать нестабильности в кластере Pacemaker  
  - В зависимости от местоположения прокси может ввести дополнительную задержку в вызовах от агента забора Azure к API управления Azure. Если ваш корпоративный прокси все еще находится в помещении, в то время как ваш кластер Pacemaker находится в Azure, измерьте задержку и рассмотрите, подходит ли это решение  
  - Если уже нет высокодоступного корпоративного прокси на месте, мы не рекомендуем эту опцию, поскольку клиент будет нести дополнительные расходы и сложность. Тем не менее, если вы решите развернуть дополнительное решение прокси, с целью разрешить исходящие подключения от Pacemaker к открытому API управления Azure, убедитесь, что прокси очень доступен, а задержка от ВМ до прокси низка.  

### <a name="pacemaker-configuration-with-proxy"></a>Конфигурация Кардиостимулятора с прокси 

Есть много различных вариантов прокси в отрасли. Пошаговые инструкции для развертывания прокси-серверов выходят за рамки этого документа. В приведенном ниже примере мы предполагаем, что ваш прокси-сервер отвечает на **MyProxyService** и слушает порт **MyProxyPort.**  
Чтобы кардиостимулятор общался с API управления Azure, выполните следующие действия на всех кластерных узлах:  

1. Отобразите файл конфигурации кардиостимулятора /etc/sysconfig/pacemaker и добавьте следующие строки (все кластерные узлы):

   ```console
   sudo vi /etc/sysconfig/pacemaker
   # Add the following lines
   http_proxy=http://MyProxyService:MyProxyPort
   https_proxy=http://MyProxyService:MyProxyPort
   ```

2. Перезапустите службу кардиостимулятора на **всех** кластерных узлах.  
  - SUSE
 
     ```console
     # Place the cluster in maintenance mode
     sudo crm configure property maintenance-mode=true
     #Restart on all nodes
     sudo systemctl restart pacemaker
     # Take the cluster out of maintenance mode
     sudo crm configure property maintenance-mode=true
     ```

  - Red Hat  

     ```console
     # Place the cluster in maintenance mode
     sudo pcs property set maintenance-mode=true
     #Restart on all nodes
     sudo systemctl restart pacemaker
     # Take the cluster out of maintenance mode
     sudo pcs property set maintenance-mode=false
     ```

## <a name="next-steps"></a>Дальнейшие действия

* [Узнайте, как настроить Pacemaker на SUSE в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse-pacemaker)
* [Узнайте, как настроить Pacemaker на Red Hat в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-rhel-pacemaker)
