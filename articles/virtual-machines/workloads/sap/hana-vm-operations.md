---
title: Конфигурации инфраструктуры SAP HANA и работа с ней в Azure | Документация Майкрософт
description: Руководство по использованию систем SAP HANA, развернутых на виртуальных машинах Azure.
services: virtual-machines-linux,virtual-machines-windows
documentationcenter: ''
author: msjuergent
manager: bburns
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 10/01/2019
ms.author: juergent
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 7c4f3ec2727d06528eab788a2a24a6190fe26533
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81606147"
---
# <a name="sap-hana-infrastructure-configurations-and-operations-on-azure"></a>Конфигурации инфраструктуры SAP HANA и работа с ней в Azure
Этот документ содержит рекомендации по настройке архитектуры и работе с системами SAP HANA, развернутыми на виртуальных машинах Azure. Здесь также приведены сведения о настройке горизонтального масштабирования SAP HANA для номера SKU виртуальных машин M128s. Он не предназначен для замены стандартной документации SAP, к которой относятся следующие ресурсы:

- [Административное руководством SAP](https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.02/330e5550b09d4f0f8b6cceb14a64cd22.html)
- [Руководства по установке SAP](https://service.sap.com/instguides)
- [Примечания к SAP](https://service.sap.com/notes).

## <a name="prerequisites"></a>Предварительные условия
Чтобы воспользоваться приведенными в этом руководстве сведениями, необходимо иметь базовые знания об использовании следующих компонентов Azure:

- [Виртуальные машины Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-manage-vm)
- [Сети и виртуальные сети Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-virtual-network).
- [Хранилище Azure](https://docs.microsoft.com/azure/virtual-machines/linux/tutorial-manage-disks)

Дополнительные сведения по SAP NetWeaver и другим компонентам SAP на базе Azure см. в статье [Using Azure for hosting and running SAP workload scenarios](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/get-started) (Размещение и выполнение сценариев рабочей нагрузки SAP с помощью Azure) и [документации по Azure](https://docs.microsoft.com/azure/).

## <a name="basic-setup-considerations"></a>Рекомендации по основной настройке
В следующих разделах описаны рекомендации по основной настройке развертывания систем SAP HANA на виртуальных машинах Azure.

### <a name="connect-into-azure-virtual-machines"></a>Подключение к виртуальным машинам Azure
Как описано в статье [SAP NetWeaver на виртуальных машинах Windows. Руководство по планированию и внедрению](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/planning-guide), есть два основных метода подключения к виртуальным машинам Azure:

- Подключение через Интернет и общедоступные конечные точки на виртуальной машине перехода или виртуальной машине, работающей под управлением SAP HANA.
- Подключение через [VPN](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal) или Azure [ExpressRoute](https://azure.microsoft.com/services/expressroute/).

Подключение "сеть — сеть" через VPN или ExpressRoute необходимо для производственных сценариев. Этот тип подключения также необходим для нерабочих сценариев, связанных с производственными сценариями, в которых используется программное обеспечение SAP. Пример межсайтового подключения приведен на следующем рисунке:

![Межсайтовые подключения](media/virtual-machines-shared-sap-planning-guide/300-vpn-s2s.png)


### <a name="choose-azure-vm-types"></a>Выбор типов виртуальных машин Azure
Типы виртуальных машин Azure, которые можно использовать для производственных сценариев, можно найти [в документации SAP для IAAS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html). Для нерабочих сценариев доступен более широкий спектр собственных типов виртуальных машин Azure.

>[!NOTE]
> Используйте для этих сценариев типы виртуальных машин, которые указаны в [примечании к SAP № 1928533](https://launchpad.support.sap.com/#/notes/1928533). В рабочей среде можно использовать виртуальные машины Azure, сертифицированные для SAP HANA. Они указаны в опубликованном [списке сертифицированных платформ IaaS](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html#categories=Microsoft%20Azure) для SAP.

Разверните виртуальные машины в Azure с помощью:

- портала Azure;
- командлетов Azure PowerShell;
- Azure CLI.

Вы также можете развернуть полностью установленную платформу SAP HANA в службы виртуальных машин Azure через [облачную платформу SAP](https://cal.sap.com/). Сведения о процессе установки см. в статье [Развертывание SAP S/4HANA или BW/4HANA в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/cal-s4h), а сведения об автоматизации — на сайте [GitHub](https://github.com/AzureCAT-GSI/SAP-HANA-ARM).

>[!IMPORTANT]
> Чтобы использовать M208xx_v2 виртуальные машины, необходимо осторожно выбрать образ Linux из коллекции образов виртуальных машин Azure. Дополнительные сведения см. в статье [размеры виртуальных машин, оптимизированных для памяти](../../mv2-series.md).
> 


### <a name="storage-configuration-for-sap-hana"></a>Конфигурация хранилища для SAP HANA
Сведения о конфигурациях хранилища и типах хранилищ, используемых с SAP HANA в Azure, см. в документе [SAP HANA конфигурациях хранилища виртуальных машин Azure](./hana-vm-operations-storage.md) .


### <a name="set-up-azure-virtual-networks"></a>Настройка виртуальных сетей Azure
Если у вас есть подключение типа "сеть — сеть" в Azure через VPN или ExpressRoute, у вас должна быть как минимум одна виртуальная сеть Azure, которая подключается через виртуальный шлюз к сети VPN или ExpressRoute. В простых развертываниях виртуальный шлюз может быть развернут в подсети виртуальной сети Azure, в которой также размещаются экземпляры SAP HANA. Чтобы установить SAP HANA, необходимо создать две дополнительные подсети в виртуальной сети Azure. Одну подсеть, в которой размещаются виртуальные машины, на которых будут работать экземпляры SAP HANA, и другую подсеть, в которой будут работать виртуальная машина Jumpbox или виртуальная машина управления, для размещения SAP HANA Studio или другого программного обеспечения для управления или ПО приложения.

> [!IMPORTANT]
> Из соображений функциональности и, что более важно, из соображений производительности в пути взаимодействия между приложением SAP и уровнем СУБД SAP NetWeaver, системой SAP Hybris или S/4HANA не поддерживается настройка [виртуальных сетевых модулей Azure (NVA)](https://azure.microsoft.com/solutions/network-appliances/). Связь между прикладным уровнем SAP и уровнем СУБД должна быть прямой. Это ограничение не относится к [правилам групп безопасности приложений и сети в Azure](https://docs.microsoft.com/azure/virtual-network/security-overview), если эти правила разрешают прямую связь. Виртуальные сетевые модули также не поддерживаются в путях взаимодействия между виртуальными машинами Azure, представляющими узлы кластера Pacemaker в Linux, и устройствами SBD, как описано в статье [Руководство по обеспечению высокого уровня доступности виртуальных машин Azure для SAP NetWeaver на SUSE Linux Enterprise Server для приложений SAP](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse). Они также не поддерживаются в путях взаимодействия между виртуальными машинами Azure и Windows Server SOFS, настроенными, как описано в статье [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью файлового ресурса в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-high-availability-guide-wsfc-file-share). Виртуальные сетевые модули в путях взаимодействия могут легко удвоить задержку в сети между двумя партнерами по взаимодействию и ограничить пропускную способность в критических путях между уровнем приложений SAP и уровнем СУБД. В некоторых сценариях, наблюдаемых клиентами, виртуальные сетевые модули могут привести к сбоям кластеров Pacemaker Linux в случаях, когда узлы кластера Linux Pacemaker должны взаимодействовать с устройством SBD через эти модули.  
> 

> [!IMPORTANT]
> Еще одно **НЕПОДДЕРЖИВАЕМОЕ** решение – разделение прикладного уровня SAP и уровня СУБД на разные виртуальные сети Azure, не являющиеся [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview). Чтобы отделить прикладной уровень SAP от уровня СУБД, рекомендуем использовать подсети одной виртуальной сети Azure, а не разные виртуальные сети Azure. Если вы решите не следовать этой рекомендации, а разделить два уровня на разные виртуальные сети, то эти виртуальные сети должны быть [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview). Учтите, что за передачу трафика между двумя [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) виртуальными сетями Azure взимается плата. Обмен большими объемами данных, насчитывающими много терабайтов, между прикладным уровнем SAP и уровнем СУБД может повлечь за собой существенные затраты, если прикладной уровень SAP и уровень СУБД находятся в разных одноранговых виртуальных сетях Azure. 

При установке виртуальных машин для запуска SAP HANA они должны иметь следующее:

- Два виртуальных сетевых адаптера, один из которых подключается к подсети управления, а другой используется для подключения из локальной сети или других сетей к экземпляру SAP HANA на виртуальной машине Azure.
- Статические частные IP-адреса, развернутые для обоих виртуальных сетевых адаптеров.

> [!NOTE]
> Отдельным виртуальным сетевым адаптерам следует назначить статические IP-адреса с помощью Azure. Не следует назначать статические IP-адреса для виртуальных сетевых адаптеров в гостевой ОС. Некоторые службы Azure, такие как служба Azure Backup, полагаются на тот факт, что по крайней мере для основного виртуального сетевого адаптера используется DHCP, а не статические IP-адреса. См. дополнительные сведения в статье [Устранение неполадок при архивации виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#networking). Если виртуальной машине нужно присвоить несколько статических IP-адресов, ей также необходимо присвоить несколько виртуальных сетевых адаптеров.
>
>

Однако для долгосрочных развертываний вам необходимо создать сетевую архитектуру виртуального центра обработки данных в Azure. Эта архитектура рекомендует разделение шлюза виртуальной сети Azure, который подключается к локальной сети, в отдельную виртуальную сеть Azure. В этой отдельной виртуальной сети должен размещаться весь трафик, поступающий либо в локальную среду, либо в Интернет. Этот подход позволяет развернуть программное обеспечение для аудита и регистрации трафика, который входит в виртуальный центр обработки данных в Azure в этой отдельной центральной виртуальной сети. Таким образом, у вас есть одна виртуальная сеть, в которой размещается все программное обеспечение и конфигурации, относящиеся ко входящему и исходящему трафику развертывания Azure.

Статьи [Виртуальный центр обработки данных Microsoft Azure с точки зрения сети](https://docs.microsoft.com/azure/architecture/vdc/networking-virtual-datacenter) и [Виртуальный центр обработки данных Azure и плоскость управления предприятием](https://docs.microsoft.com/azure/architecture/vdc/) предоставляют дополнительные сведения о работе с виртуальным центром обработки данных и соответствующей структуре виртуальной сети Azure.


>[!NOTE]
>Трафик, который проходит между центральной и периферийной виртуальными сетями с использованием [пиринга виртуальных сетей Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview), [оплачивается](https://azure.microsoft.com/pricing/details/virtual-network/) отдельно. Исходя из этих затрат, может потребоваться рассмотреть возможность компромиссов между использованием строгой звездообразной топологии сети и запуском нескольких [шлюзов Azure ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-about-virtual-network-gateways), которые вы подключаете к периферийным зонам, чтобы обойти пиринг виртуальных сетей. Тем не менее использование шлюзов Azure ExpressRoute также сопровождается дополнительными [расходами](https://azure.microsoft.com/pricing/details/vpn-gateway/). Вы также можете столкнуться с дополнительными расходами на стороннее программное обеспечение, используемое для регистрации, аудита и мониторинга трафика. В зависимости от затрат на обмен данными с помощью пиринга виртуальных сетей с одной стороны и затрат, связанных с дополнительными шлюзами Azure ExpressRoute и дополнительными лицензиями на программное обеспечение, можно выполнить микросегментацию в пределах одной виртуальной сети, используя в качестве изолирующей единицы подсеть, а не виртуальную сеть.


Общие сведения о различных методах назначения IP-адресов см. в статье [Типы IP-адресов и методы распределения в Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm). 

Для виртуальных машин, работающих под управлением SAP HANA, необходимо назначить статические IP-адреса. Причиной является то, что некоторые атрибуты конфигурации для HANA ссылаются на IP-адреса.

С помощью [групп безопасности сети (NSG) Azure](https://docs.microsoft.com/azure/virtual-network/virtual-networks-nsg) можно перенаправить трафик, поступающий к экземпляру SAP HANA или Jumpbox. Группы безопасности сети и [группы безопасности приложений](https://docs.microsoft.com/azure/virtual-network/security-overview#application-security-groups) связаны с подсетью SAP HANA и подсетью управления.

На следующем рисунке представлен обзор приблизительной схемы развертывания SAP HANA со звездообразной архитектурой виртуальной сети:

![Приблизительная схема развертывания SAP HANA](media/hana-vm-operations/hana-simple-networking-dmz.png)

Чтобы развернуть SAP HANA в Azure без подключения типа "сеть — сеть", следует изолировать экземпляр SAP HANA от общедоступного Интернета и скрыть его за прокси-сервером. В этом стандартном сценарии для развертывания используются встроенные DNS-службы Azure для разрешения имен узлов. Встроенные DNS-службы Azure особо важны при более сложном развертывании, в котором используются общедоступные IP-адреса. Используйте группы безопасности сети Azure и [виртуальные сетевые модули Azure](https://azure.microsoft.com/solutions/network-appliances/) для контроля и отслеживания маршрутизации из Интернета в архитектуру виртуальной сети в Azure. На следующем рисунке показана примерная схема для развертывания SAP HANA без подключения типа "сеть — сеть" в звездообразной архитектуре виртуальной сети:
  
![Примерная схема развертывания SAP HANA без подключения "сеть — сеть"](media/hana-vm-operations/hana-simple-networking-dmz.png)
 

Еще одно описание того, как использовать виртуальные сетевые модули Azure для контроля и мониторинга доступа из Интернета без звездообразной архитектуры виртуальной сети, можно найти в статье [Развертывание высокодоступных виртуальных сетевых модулей](https://docs.microsoft.com/azure/architecture/reference-architectures/dmz/nva-ha).


## <a name="configuring-azure-infrastructure-for-sap-hana-scale-out"></a>Настройка инфраструктуры Azure для горизонтального масштабирования SAP HANA
Чтобы узнать о типах виртуальных машин Azure, сертифицированных для горизонтального масштабирования OLAP или масштаба S/4HANA, проверьте [каталог SAP HANA оборудования](https://www.sap.com/dmc/exp/2014-09-02-hana-hardware/enEN/iaas.html#categories=Microsoft%20Azure). Флажок в столбце "кластеризация" указывает на поддержку горизонтального масштабирования. Тип приложения указывает, поддерживается ли горизонтальное масштабирование OLAP или масштабирования S/4HANA. Дополнительные сведения о узлах, сертифицированных в масштабном масштабировании для каждой ВИРТУАЛЬНОЙ машины, см. в сведениях о записях в конкретном номере SKU, указанном в каталоге SAP HANA Hardware.

Минимальные выпуски ОС для развертывания конфигураций с горизонтальным масштабированием на виртуальных машинах Azure см. в сведениях о записях в конкретном номере SKU виртуальной машины, указанном в каталоге SAP HANA оборудования. В конфигурации горизонтального масштабирования OLAP с n узлами один узел работает как главный узел. Другие узлы вплоть до предела, установленного в качестве рабочего узла для действия сертификации. Дополнительные резервные узлы не учитываются в числе сертифицированных узлов

>[!NOTE]
> Масштабное развертывание виртуальной машины Azure SAP HANA с резервным узлом возможно только при использовании хранилища [Azure NetApp Files](https://azure.microsoft.com/services/netapp/) . Другие SAP HANA сертифицированные службы хранилища Azure не позволяют настраивать резервные узлы SAP HANA.
>

Для/Hana/Shared также рекомендуется использование [Azure NetApp Files](https://azure.microsoft.com/services/netapp/). 

Типичная базовая схема для одного узла в конфигурации с горизонтальным масштабированием будет выглядеть следующим образом:

![Основы горизонтального масштабирования одного узла](media/hana-vm-operations/scale-out-basics-anf-shared.PNG)

Базовая конфигурация узла виртуальной машины для горизонтального масштабирования SAP HANA выглядит так:

- Для **/Hana/Shared**используется собственная служба NFS, предоставляемая с помощью Azure NetApp Files. 
- Все остальные тома диска не являются общими для разных узлов и не основаны на NFS. Конфигурации установки и шаги для масштабного развертывания HANA с необщими **/Hana/Data** и **/Hana/log** приведены далее в этом документе. Сведения о сертифицированном хранилище HANA, которое можно использовать, см. в статье [SAP HANA конфигурациях хранилища виртуальных машин Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/hana-vm-operations-storage).


При изменении размера томов или дисков необходимо проверить документ [SAP HANA требования к хранилищу TDI](https://www.sap.com/documents/2015/03/74cdb554-5a7c-0010-82c7-eda71af511fa.html), требуемый размер зависит от количества рабочих узлов. Документ освобождает формулу, которую необходимо применить для получения требуемой емкости тома.

Другие критерии проектирования, отображаемые на графике конфигурации с одним узлом для горизонтального масштабирования SAP HANA виртуальной машине, — это виртуальная сеть или более высокая конфигурация подсети. SAP настоятельно рекомендует отделить трафик к клиенту или приложению от трафика между узлами HANA. Как показано на рисунке, эта цель достигается за счет наличия двух разных виртуальных сетевых адаптеров, подключенных к виртуальной машине. Оба адаптера находятся в разных подсетях и имеют два разных IP-адреса. Затем вы будете управлять потоком трафика с помощью правил маршрутизации с использованием групп безопасности сети или определенных пользователем маршрутов.

В частности, в Azure нет средств и методов для обеспечения качества обслуживания и квот для конкретных виртуальных сетевых адаптеров. В результате разделение обращений к клиенту или приложению и внутриузловой коммуникации не открывает никаких возможностей для определения приоритетности одного потока трафика над другим. Вместо этого разделение остается мерой безопасности, изолирующей внутриузловые связи конфигураций горизонтального масштабирования.  

>[!NOTE]
>SAP рекомендует разделять сетевой трафик на стороне клиента или приложения, а также трафик внутри узла, как описано в этом документе. Поэтому рекомендуется размещать архитектуру, как показано на последней графике. Также обратитесь к группе безопасности и соответствия требованиям, чтобы узнать о требованиях, отклоненных от рекомендаций. 
>

С точки зрения сети минимальная требуемая архитектура сети будет выглядеть так:

![Основы горизонтального масштабирования одного узла](media/hana-vm-operations/overview-scale-out-networking.png)



### <a name="installing-sap-hana-scale-out-n-azure"></a>Установка конфигурации горизонтального масштабирования SAP HANA в Azure
При установке конфигурации горизонтального масштабирования SAP вам необходимо выполнить приблизительно следующие шаги:

- Развертывание новой или адаптации существующей инфраструктуры виртуальной сети Azure
- Развертывание новых виртуальных машин с помощью управляемого хранилища Azure уровня "Премиум", "Ultra Disk Volumes" и (или) томов NFS на основе использовании
- - Адаптация сетевой маршрутизации, чтобы убедиться, что, например, внутриузловая связь между виртуальными машинами не маршрутизировалась через [виртуальный сетевой модуль](https://azure.microsoft.com/solutions/network-appliances/). 
- Установка главного узла SAP HANA.
- Адаптация параметров конфигурации главного узла SAP HANA.
- Продолжение установки рабочих узлов SAP HANA.

#### <a name="installation-of-sap-hana-in-scale-out-configuration"></a>Установка SAP HANA с конфигурацией горизонтального масштабирования
По мере развертывания инфраструктуры виртуальных машин Azure и выполнения всех других подготовительных работ вам необходимо установить конфигурации горизонтального масштабирования SAP HANA следующим образом:

- Установите главный узел SAP HANA в соответствии с документацией SAP.
- В случае использования хранилища Azure класса Premium или Ultra Storage с общими дисками/Hana/Data и/Hana/log необходимо изменить глобальный ini-файл и добавить параметр "basepath_shared = No" в глобальный ini-файл. Этот параметр позволяет SAP HANA выполняться в горизонтальном масштабе без общих томов **/Hana/Data** и **/Hana/log** между узлами. Дополнительные сведения см. в [примечании к SAP № 2080991](https://launchpad.support.sap.com/#/notes/2080991). Если вы используете тома NFS на основе использовании для/Hana/Data и/Hana/log, вам не нужно вносить это изменение
- После окончательного изменения параметра Global. ini перезапустите экземпляр SAP HANA
- Добавьте дополнительные рабочие узлы. Ознакомьтесь с командой <https://help.sap.com/viewer/6b94445c94ae495c83a19646e7c3fd56/2.0.00/en-US/0d9fe701e2214e98ad4f8721f6558c34.html>. Укажите внутреннюю сеть для межузлового обмена данными SAP HANA во время установки или позже, используя, к примеру, локальное средство hdblcm. Дополнительные сведения см. в [примечании к SAP № 2183363](https://launchpad.support.sap.com/#/notes/2183363). 

Сведения о настройке масштабируемой системы SAP HANA с резервным узлом в SUSE Linux подробно описаны в статье [развертывание SAP HANA горизонтальной системы с резервным узлом на виртуальных машинах Azure с помощью Azure NetApp Files на SUSE Linux Enterprise Server](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-scale-out-standby-netapp-files-suse). Эквивалентную документацию по Red Hat можно найти в статье [развертывание SAP HANA масштабируемых систем с резервным узлом на виртуальных машинах Azure с помощью Azure NetApp Files на Red Hat Enterprise Linux](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-scale-out-standby-netapp-files-rhel). 


## <a name="sap-hana-dynamic-tiering-20-for-azure-virtual-machines"></a>Использование SAP HANA Dynamic Tiering 2.0 для виртуальных машин Azure

Кроме сертификации SAP HANA на виртуальных машинах Azure серии M, в Microsoft Azure поддерживается решение SAP HANA Dynamic Tiering 2.0 (подробнее см. приведенную ниже ссылку на соответствующую документацию). Нет никакой разницы между установкой продукта и использованием его через, например, панель SAP HANA на виртуальной машине Azure. Но есть несколько важных аспектов, которые нужно обязательно соблюдать для включения официальной поддержки в Azure. Эти важные замечания описаны ниже. В этой статье вместо полного имени динамического уровня 2,0 будет использоваться сокращение "DT 2,0".

SAP HANA Dynamic Tiering 2.0 не поддерживается в SAP BW или S4HANA. Это решение сейчас используется в основном с собственными приложениями HANA.


### <a name="overview"></a>Обзор

На рисунке ниже представлены сведения о поддержке DT 2.0 на платформе Microsoft Azure. Есть набор обязательных требований, которые нужно соблюдать для официальной сертификации:

- DT 2.0 необходимо устанавливать на выделенной виртуальной машине Azure (нельзя запускать это решение на той же виртуальной машине, где выполняется SAP HANA);
- виртуальные машины для SAP HANA и 2.0 DT должны быть развернуты в одной и той же виртуальной сети Azure;
- виртуальные машины для SAP HANA и DT 2.0 должны развертываться с включенной функцией ускорения сети Azure;
- для виртуальных машин DT 2.0 нужно использовать хранилище Azure класса Premium;
- к виртуальной машине DT 2.0 нужно подключить несколько дисков Azure;
- необходимо настроить программный RAID-массив или чередование томов (с помощью диспетчера логических томов или средства mdadm), используя чередование на дисках Azure.

Дополнительные сведения будут описаны в следующих разделах.

![Обзор архитектуры SAP HANA DT 2.0](media/hana-vm-operations/hana-data-tiering.png)



### <a name="dedicated-azure-vm-for-sap-hana-dt-20"></a>Выделенная виртуальная машина Azure для SAP HANA DT 2.0

В системах IaaS Azure DT 2.0 поддерживается только на выделенной виртуальной машине. DT 2.0 нельзя выполнять на той же виртуальной машине Azure, где запущен экземпляр HANA. Изначально для запуска SAP HANA DT 2.0 можно использовать два типа виртуальных машин:

- M64-32ms 
- E32sv3 

См. [описание типов виртуальных машин](https://docs.microsoft.com/azure/virtual-machines/linux/sizes-memory).

Исходя из того, что основная задача DT 2.0 заключается в разгрузке "теплых" данных для снижения расходов, есть смысл всегда использовать правильные размеры виртуальных машин. Но для возможных сочетаний нет строгих правил и ограничений. Все зависит от конкретной рабочей нагрузки.

Мы рекомендуем использовать следующие конфигурации.

| Тип виртуальной машины для SAP HANA | Тип виртуальной машины для DT 2.0 |
| --- | --- | 
| M128ms | M64-32ms |
| M128s | M64-32ms |
| M64ms | E32sv3 |
| M64s | E32sv3 |


Поддерживаются любые сочетания виртуальных машин серии M, сертифицированных для SAP HANA, с поддерживаемыми для DT 2.0 типами виртуальных машин (M64-32ms и E32sv3).


### <a name="azure-networking-and-sap-hana-dt-20"></a>Сети Azure и SAP HANA DT 2.0

Для установки DT 2.0 на выделенной виртуальной машине требуется пропускная способность сети не менее 10 ГБ между виртуальными машинами для DT 2.0 и SAP HANA. Поэтому все виртуальные машины необходимо поместить в одну виртуальную сеть Azure, а также включить функцию ускорения сети Azure.

См. дополнительные сведения об [ускорении сети Azure](https://docs.microsoft.com/azure/virtual-network/create-vm-accelerated-networking-cli).

### <a name="vm-storage-for-sap-hana-dt-20"></a>Хранилище виртуальной машины для SAP HANA DT 2.0

В соответствии с рекомендациями для DT 2.0 на каждое физическое ядро следует выделить пропускную способность дискового ввода-вывода не менее 50 МБ/с. В спецификации для двух типов виртуальных машин Azure, поддерживаемых для DT 2,0, максимальное ограничение пропускной способности ввода-вывода на диск для виртуальной машины выглядит следующим образом:

- E32sv3: 768 МБ/c (без кэширования), то есть по 48 МБ/с на физическое ядро;
- M64-32ms: 1000 МБ/c (без кэширования), то есть по 62,5 МБ/с на физическое ядро.

Необходимо присоединить к виртуальной машине для DT 2.0 несколько дисков Azure и создать программный RAID-массив (с чередованием) на уровне операционной системы, чтобы достичь необходимого уровня пропускной способности дисков для этой виртуальной машины. Один диск Azure не может обеспечить пропускную способность, соответствующую максимальному ограничению для виртуальной машины. Для работы DT 2.0 необходимо использовать хранилище Azure класса Premium. 

- См. дополнительные сведения о [доступных типах дисков Azure](../../windows/disks-types.md).
- См. дополнительные сведения о [создании программного RAID-массива с помощью средства mdadm](https://docs.microsoft.com/azure/virtual-machines/linux/configure-raid).
- См. дополнительные сведения о [настройке диспетчера логических томов для создания чередующегося тома, позволяющего обеспечить максимальную пропускную способность](https://docs.microsoft.com/azure/virtual-machines/linux/configure-lvm).

В зависимости от требований к размеру есть несколько вариантов, позволяющих достичь максимальной пропускной способности для виртуальной машины. Ниже приведены возможные конфигурации дисков для томов данных по каждому типу виртуальной машины для DT 2.0, позволяющие достичь верхнего предела пропускной способности для виртуальной машины. Виртуальную машину E32sv3 следует рассматривать как начальный уровень, пригодный лишь для небольших рабочих нагрузок. Если будет очевидно, что ее скорости недостаточно, следует перейти на виртуальную машину размера M64-32ms.
M64-32ms имеет много памяти, поэтому нагрузка операций ввода-вывода может не достигать установленного предела, особенно для рабочих нагрузок с большой нагрузкой на чтение. В этом случае число дисков в чередующемся наборе можно уменьшить с учетом требований для конкретной рабочей нагрузки. Но если вы не хотите рисковать, используйте перечисленные ниже конфигурации дисков, обеспечивающие максимальную пропускную способность.


| SKU виртуальной машины | Конфигурация дисков 1 | Конфигурация дисков 2 | Конфигурация дисков 3 | Конфигурация дисков 4 | Конфигурация дисков 5 | 
| ---- | ---- | ---- | ---- | ---- | ---- | 
| M64-32ms | 4 x P50 -> 16 ТБ | 4 x P40 -> 8 ТБ | 5 x P30 -> 5 ТБ | 7 x P20 -> 3,5 ТБ | 8 x P15 -> 2 ТБ | 
| E32sv3 | 3 x P50 -> 12 ТБ | 3 x P40 -> 6 ТБ | 4 x P30 -> 4 ТБ | 5 x P20 -> 2,5 ТБ | 6 x P15 -> 1,5 ТБ | 


В некоторых случаях, особенно если рабочая нагрузка создает большую нагрузку на чтение, производительность операций ввода-вывода можно увеличить включением кэширования узла Azure в режиме "только для чтения", как рекомендуется для томов данных программного обеспечения для базы данных. В этом случае для дискового кэша журнала транзакций Azure следует выбрать значение none. 

Что касается размера тома для журнала, мы рекомендуем использовать примерно 15 % от размера данных. Чтобы создать том журнала, можно использовать другой тип дисков Azure с учетом ограничений по бюджету и требований к пропускной способности. Для объема журнала требуется высокая пропускная способность ввода-вывода.  В случае использования типа виртуальной машины M64-32ms обязательно включите [ускоритель записи](https://docs.microsoft.com/azure/virtual-machines/linux/how-to-enable-write-accelerator). Ускоритель записи Azure обеспечит оптимальное значение задержки для записи на диск журнала транзакций (доступно только для серии M). Но при этом нужно учитывать несколько важных аспектов, например максимальное число дисков для используемого типа виртуальной машины. Дополнительные сведения об Ускорителе записи см. [в этой статье](https://docs.microsoft.com/azure/virtual-machines/windows/how-to-enable-write-accelerator).


Вот несколько примеров, иллюстрирующих выбор размера для тома журнала:

| Размер тома данных и тип дисков | Конфигурация 1 для объема и типа диска для журнала | Конфигурация 2 для объема и типа диска для журнала |
| --- | --- | --- |
| 4 x P50 -> 16 ТБ | 5 x P20 -> 2,5 ТБ | 3 x P30 -> 3 ТБ |
| 6 x P15 -> 1,5 ТБ | 4 x P6 -> 256 ТБ | 1 x P15 -> 256 ТБ |


Как и для горизонтального масштабирования SAP HANA, каталог/hana/shared должен быть предоставлен в совместный доступ виртуальным машинам для SAP HANA и DT 2.0. Мы рекомендуем использовать ту же архитектуру, что и для горизонтального масштабирования SAP HANA, с выделенными виртуальными машинами, которые выполняют роль NFS-сервера с высоким уровнем доступности. Чтобы создать общий том для резервного копирования, можно использовать аналогичную схему. Клиенту следует самостоятельно решить, нужен ли ему высокий уровень доступности или в качестве сервера для резервного копирования можно использовать выделенную виртуальную машину с достаточной емкостью хранилища.



### <a name="links-to-dt-20-documentation"></a>Ссылки на документацию по DT 2.0 

- [SAP HANA Dynamic Tiering: Installation and Update Guide (Руководство по установке и обновлению SAP HANA Dynamic Tiering)](https://help.sap.com/viewer/88f82e0d010e4da1bc8963f18346f46e/2.0.03/en-US)
- [Official SAP HANA Dynamic Tiering tutorials and resources](https://help.sap.com/viewer/fb9c3779f9d1412b8de6dd0788fa167b/2.0.03/en-US) (Официальные руководства и ресурсы по SAP HANA Dynamic Tiering)
- [Подтверждение концепции для SAP HANA Dynamic Tiering](https://blogs.sap.com/2017/12/08/sap-hana-dynamic-tiering-delivering-on-low-tco-with-impressive-performance/)
- [SAP HANA 2.0 SPS 02 dynamic tiering enhancements](https://blogs.sap.com/2017/07/31/sap-hana-2.0-sps-02-dynamic-tiering-enhancements/) (Улучшения SAP HANA Dynamic Tiering SPS 02)




## <a name="operations-for-deploying-sap-hana-on-azure-vms"></a>Операции развертывания SAP HANA на виртуальных машинах Azure
В следующих разделах описаны некоторые операции, связанные с развертыванием систем SAP HANA на виртуальных машинах Azure.

### <a name="back-up-and-restore-operations-on-azure-vms"></a>Операции архивации и восстановления на виртуальных машинах Azure
Следующие документы содержат сведения об архивации и восстановлении развертывания SAP HANA:

- [Общие сведения о резервном копировании SAP HANA](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-backup-guide)
- [Резервное копирование SAP HANA на уровне файлов](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-backup-file-level)
- [Тест производительности моментальных снимков хранилища SAP HANA](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-backup-storage-snapshots)


### <a name="start-and-restart-vms-that-contain-sap-hana"></a>Запуск и перезапуск виртуальных машин с SAP HANA
Отличительной чертой общедоступного облака Azure является то, что плата взимается только за время вычисления. Например, при завершении работы виртуальной машины под управлением SAP HANA будет выставлен счет только за расходы на хранение за это время. Другая функция доступна при указании статических IP-адресов для виртуальных машин в начальном развертывании. Если перезагрузить виртуальную машину с SAP HANA, она перезапустится с предыдущим IP-адресом. 


### <a name="use-saprouter-for-sap-remote-support"></a>Удаленная поддержка SAP с помощью SAPRouter
Если вы установили подключение "сеть — сеть" между локальными расположениями и Azure и используете компоненты SAP, вероятно, у вас уже есть SAProuter. В этом случае выполните следующие действия для включения удаленной поддержки:

- Сохраните частный и статический IP-адрес виртуальной машины, на которой размещается SAP HANA, в конфигурации SAProuter.
- Настройте группу безопасности сети подсети, в которой размещена виртуальная машина HANA, чтобы разрешить трафик через порт TCP/IP 3299.

Если вы подключаетесь к Azure через Интернет и у вас нет маршрутизатора SAP для виртуальной машины с SAP HANA, необходимо установить компонент. Установите SAProuter на отдельной виртуальной машине в подсети управления. На следующем рисунке показана примерная схема для развертывания SAP HANA с SAProuter и без подключения "сеть — сеть":

![Примерная схема развертывания SAP HANA без подключения "сеть — сеть" и SAProuter](media/hana-vm-operations/hana-simple-networking-saprouter.png)

SAProuter следует установить на отдельной виртуальной машине, а не на виртуальной машине Jumpbox. Отдельная виртуальная машина должна иметь статический IP-адрес. Чтобы подключить ваш SAProuter к SAProuter, размещенный в SAP, обратитесь к SAP для получения IP-адреса. (SAProuter, размещенный SAP, является аналогом экземпляра SAProuter, установленного на виртуальной машине.) Используйте IP-адрес из SAP для настройки экземпляра SAProuter. В параметрах конфигурации требуется только TCP-порт 3299.

Дополнительные сведения о том, как настроить и поддерживать подключения удаленной поддержки через SAProuter, см. [в документации по SAP](https://support.sap.com/en/tools/connectivity-tools/remote-support.html).

### <a name="high-availability-with-sap-hana-on-azure-native-vms"></a>Высокий уровень доступности SAP HANA на собственных виртуальных машинах Azure
Если вы используете SUSE Linux Enterprise Server или Red Hat, вы можете установить кластер Pacemaker с устройствами STONITH. С помощью этих устройств можно настроить конфигурацию SAP HANA, которая использует синхронную репликацию с репликацией системы HANA и автоматическим переходом на другой ресурс. Для получения дополнительных сведений, перечисленных в разделе "дальнейшие действия".

## <a name="next-steps"></a>Дальнейшие шаги
Ознакомьтесь с статьями, приведенными в списке
- [Конфигурации хранилища виртуальных машин SAP HANA в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/hana-vm-operations-storage)
- [Развертывание SAP HANA масштабируемой системы с резервным узлом на виртуальных машинах Azure с помощью Azure NetApp Files на SUSE Linux Enterprise Server](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-scale-out-standby-netapp-files-suse)
- [Развертывание SAP HANA масштабируемой системы с резервным узлом на виртуальных машинах Azure с помощью Azure NetApp Files на Red Hat Enterprise Linux](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-scale-out-standby-netapp-files-rhel)
- [Обеспечение высокого уровня доступности SAP HANA на виртуальных машинах Azure в SUSE Linux Enterprise Server](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-high-availability)
- [Обеспечение высокого уровня доступности SAP HANA в виртуальных машинах Azure в Red Hat Enterprise Linux](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-hana-high-availability-rhel)

 

