---
title: Резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Узнайте, как выполнять резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры).
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: gwallace
editor: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 10/16/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 4384d29811d29f06422802abba5d3eb1ea5737e9
ms.sourcegitcommit: 77bfc067c8cdc856f0ee4bfde9f84437c73a6141
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72430076"
---
# <a name="backup-and-restore"></a>Резервное копирование и восстановление

>[!IMPORTANT]
>Эта статья не заменяет документацию по SAP HANA администрирования или примечания SAP. Мы надеемся, что у вас есть четкое понимание и опыт в SAP HANA администрировании и операциях, особенно для резервного копирования, восстановления, обеспечения высокой доступности и аварийного восстановления. В этой статье показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Очень важно выполнять шаги и процессы в собственной среде и собственных версиях и выпусках HANA. Некоторые процессы, описанные в этой статье, упрощены для более общего понимания. Они не предназначены для использования в качестве подробной инструкции по итоговым справочникам по операциям. Если вы хотите создать руководства по операциям для конфигураций, протестируйте и выполним процессы и задокументируйте процессы, связанные с конкретными конфигурациями. 

Одним из наиболее важных аспектов работы баз данных является защита их от разрушительных событий. Эти события могут возникать как в результате стихийных бедствий, так и из-за стандартных ошибок пользователей.

Резервное копирование базы данных с возможностью восстановления ее на любой момент времени, например до того, как кто-то удалил важные данные, обеспечивает восстановление до состояния, максимально близкого к тому, как это было возможно до прерывания.

Для обеспечения возможности восстановления необходимо выполнить два типа резервного копирования:

- резервное копирование баз данных — полные, добавочные или разностные резервные копии;
- резервное копирование журналов транзакций.

Кроме полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Моментальные снимки хранилища не заменяют резервные копии журналов транзакций. Резервные копии журналов транзакций по-прежнему важны при восстановлении базы данных до определенной точки во времени и очистке журналов от уже зафиксированных транзакций. Моментальные снимки хранилища могут ускорить восстановление, быстро предоставляя образ базы данных, наката. 

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- **Сделайте это самостоятельно (DIY).** Убедившись в наличии достаточного места на диске, выполните полное резервное копирование базы данных и журнала с помощью одного из следующих методов резервного копирования на диск. Резервное копирование можно выполнять непосредственно на томах, подключенных к единицам крупного экземпляра HANA, или к общим папкам NFS, настроенным на виртуальной машине Azure. В последнем случае клиенты настраивают виртуальную машину Linux в Azure, подключают к ней службу хранилища Azure и предоставляют общий доступ к хранилищу через настроенный NFS-сервер на этой виртуальной машине. Если вы выполняете резервное копирование на томах, которые непосредственно подключаются к единицам крупных экземпляров HANA, скопируйте резервные копии в учетную запись хранения Azure. Сделайте это после настройки виртуальной машины Azure, которая экспортирует общие папки NFS, основанные на службе хранилища Azure. Вы также можете использовать Azure Backupное хранилище или холодное хранилище Azure. 

   Другой вариант — использовать стороннее средство защиты данных для хранения резервных копий после их копирования в учетную запись хранения Azure. Параметр резервного копирования DIY также может потребоваться для данных, которые необходимо хранить в течение длительных периодов времени для обеспечения соответствия и аудита. Во всех случаях резервные копии копируются в общедоступные ресурсы NFS, представленные с помощью виртуальной машины и службы хранилища Azure.

- **Функции резервного копирования и восстановления инфраструктуры.** Вы также можете использовать функции резервного копирования и восстановления, предоставляемые базовой инфраструктурой SAP HANA в Azure (крупные экземпляры). Этот вариант удовлетворяет потребность в резервном копировании и быстром восстановлении. В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA. В этом разделе также рассматривается отношение, которое резервное копирование и восстановление имеют функции аварийного восстановления, предлагаемые крупными экземплярами HANA.

> [!NOTE]
>   Технология создания моментальных снимков, используемая базовой инфраструктурой крупных экземпляров HANA, зависит от SAP HANA моментальных снимков. На этом этапе SAP HANA моментальные снимки не работают вместе с несколькими клиентами SAP HANA контейнерами многоклиентской базы данных. Если развертывается только один клиент, SAP HANA моментальные снимки работают, и вы можете использовать этот метод.

## <a name="use-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища томов. Поддерживается резервное копирование и восстановление тома, но следует учитывать следующее.

- Вместо полных резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- При активации моментального снимка через/Hana/Data и/Hana/Shared, в том числе/usr/SAP, тома, технология моментальных снимков инициирует моментальный снимок SAP HANA перед запуском моментального снимка хранилища. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища. Для успешного создания моментального снимка HANA необходим активный экземпляр HANA. В сценарии HSR моментальный снимок хранилища не поддерживается на текущем вторичном узле, где невозможно выполнить моментальный снимок HANA.
- После успешного выполнения моментального снимка хранилища SAP HANA моментальный снимок удаляется.
- Резервные копии журналов транзакций создаются часто и хранятся на томе /hana/logbackups или в Azure. Вы можете активировать том /hana/logbackups, содержащий резервные копии журналов транзакций, для отдельного создания моментального снимка. В этом случае не нужно запускать моментальный снимок HANA.
- Если необходимо восстановить базу данных на определенный момент времени, в случае сбоя в рабочем окружении запросите Microsoft Azure поддержки или SAP HANA восстановления Azure в определенный моментальный снимок хранилища. Например, плановое восстановление системы типа "песочница" до исходного состояния.
- Моментальный снимок SAP HANA, включенный в моментальный снимок хранилища, является точкой смещения для применения резервных копий журналов транзакций, которые были запущены и сохранены после создания моментального снимка хранилища.
- Эти резервные копии журналов транзакций используются для восстановления базы данных до определенной точки во времени.

Вы можете создавать моментальные снимки хранилища, предназначенные для трех классов томов:

- Объединенный моментальный снимок по/Hana/Data и/Hana/Shared, который включает/usr/SAP. Для этого моментального снимка требуется создать моментальный снимок SAP HANA в качестве подготовки для моментального снимка хранилища. Моментальный снимок SAP HANA гарантирует, что база данных находится в стабильном состоянии с точки зрения хранилища. Для процесса восстановления это точка для настройки.
- Отдельный моментальный снимок тома /hana/logbackups.
- Раздел операционной системы.

Чтобы получить последние скрипты и документацию моментальных снимков, см. [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). При скачивании пакета скрипта моментальных снимков из [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md)вы получаете три файла. Один из файлов приведен в формате PDF для предоставляемой функциональности. После загрузки набора средств следуйте инструкциям в разделе "получение снимков".

## <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Моментальные снимки хранилища потребляют дисковое пространство, выделенное для единиц крупных экземпляров HANA. Учитывайте следующие аспекты планирования моментальных снимков хранилища и количества хранимых моментальных снимков хранилища. 

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Конкретный моментальный снимок хранилища на момент, когда он потребляет небольшое хранилище.
- При изменении содержимого данных и изменении содержимого SAP HANA файлов данных на томе хранилища моментальный снимок должен сохранить исходное содержимое блока и изменить данные.
- В результате размер моментального снимка хранилища увеличивается. в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. Создание моментальных снимков этих томов требует много пространства на томе. Для этого необходимо:

- Определите, когда следует запланировать моментальные снимки хранилища.
- Отслеживайте потребление места на диске для томов хранилища. 
- Управляйте количеством сохраненных моментальных снимков. 

Вы можете отключить создание моментальных снимков хранилища, если импортируются большие объемы данных, или внести другие важные изменения в базу данных HANA. 


В следующих разделах приводятся сведения о выполнении этих моментальных снимков и приведены общие рекомендации.

- Несмотря на то, что оборудование может поддерживать моментальные снимки 255 на том, вы должны оставаться под этим числом. Рекомендуемая рекомендация — 250 или меньше.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Вы можете уменьшить количество хранящихся моментальных снимков или расширить тома. Вы можете заказать дополнительное пространство в единицах по 1 ТБ.
- При выполнении таких действий, как перенос данных в SAP HANA с помощью средств переноса платформы SAP (R3load) или восстановление баз данных SAP HANA из резервных копий, необходимо отключить создание моментальных снимков хранилища для тома /hana/data. 
- При больших реорганизациях SAP HANAных таблиц Избегайте моментальных снимков хранилища, если это возможно.
- Моментальные снимки хранилища обеспечивают поддержку возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

## <a name="prerequisites-for-using-self-service-storage-snapshots"></a>Необходимые условия для использования самостоятельных моментальных снимков хранилища

Чтобы убедиться в успешном выполнении скрипта моментальных снимков, убедитесь, что Perl установлен в операционной системе Linux на сервере крупных экземпляров HANA. Perl устанавливается на единицу крупного экземпляра HANA. Чтобы проверить версию Perl, используйте следующую команду:

`perl -v`

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/perl_screen.png)


## <a name="set-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

Чтобы настроить моментальные снимки хранилища с крупными экземплярами HANA, выполните следующие действия.
1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
1. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
1. При необходимости создайте учетную запись пользователя резервного копирования SAP HANA на главном узле для каждого выполняемого экземпляра SAP HANA.
1. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
1. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
1. Скопируйте сценарии и файл конфигурации из [этого расположения GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md) в расположение **hdbsql** установленного экземпляра SAP HANA.
1. Измените файл *HANABackupDetails.txt* в соответствии с определенной спецификацией клиента.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md). Шаги, перечисленные выше, см. [в статье Microsoft snapshot Tools for SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

### <a name="consideration-for-mcod-scenarios"></a>Рекомендации для сценариев MCOD
Если вы запускаете [сценарий MCOD](https://launchpad.support.sap.com/#/notes/1681092) с несколькими экземплярами SAP HANA в одной единице крупных экземпляров Hana, у вас есть отдельные тома хранилища, подготовленные для каждого из экземпляров SAP HANA. Дополнительные сведения о MDC и других вопросах см. в разделе "важные вещи, которые следует запомнить" статьи [Microsoft snapshot Tools for SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).
 

### <a name="step-1-install-the-sap-hana-hdb-client"></a>Шаг 1. Установка клиента SAP HANA HDB

Операционная система Linux, установленная на SAP HANA в Azure (крупные экземпляры), включает папки и скрипты, необходимые для запуска SAP HANA моментальных снимков хранилища для резервного копирования и аварийного восстановления. Проверьте наличие последних выпусков на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md). 

Вы несете ответственность за установку SAP HANA клиента HDB на единицах крупных экземпляров HANA во время установки SAP HANA.

### <a name="step-2-change-the-etcsshssh_config"></a>Шаг 2. Изменение файла /etc/ssh/ssh\_config

Этот шаг описан в разделе "Включение связи с хранилищем" в [средствах моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).


### <a name="step-3-create-a-public-key"></a>Этап 3. Создание открытого ключа

Чтобы разрешить доступ к интерфейсам моментальных снимков хранилища вашего клиента крупных экземпляров HANA, установите процедуру входа с помощью открытого ключа. 

На первом SAP HANA сервере Azure (крупные экземпляры) в клиенте создайте открытый ключ для доступа к инфраструктуре хранилища. При использовании открытого ключа пароль не требуется для входа в интерфейсы моментальных снимков хранилища. Также не требуется сохранять учетные данные с открытым ключом. 

Сведения о создании открытого ключа см. в разделе "Включение связи с хранилищем" в [средствах моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).


### <a name="step-4-create-an-sap-hana-user-account"></a>Этап 4. Создание учетной записи пользователя SAP HANA

Чтобы начать создание моментальных снимков SAP HANA, создайте учетную запись пользователя в SAP HANA, которую могут использовать скрипты моментальных снимков хранилища. Для этих целей создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Пользователь должен быть создан в СИСТЕМДБ, а *не* в базе данных sid для MDC. В среде с одним контейнером пользователь создается в базе данных клиента. Эта учетная запись должна иметь права **администратора резервного копирования** и доступа к **каталогу** . 

Сведения о настройке и использовании учетной записи пользователя см. в разделе "Включение связи с SAP HANA" в [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).


### <a name="step-5-authorize-the-sap-hana-user-account"></a>Этап 5. Авторизация учетной записи пользователя SAP HANA

На этом шаге вы разрешаете учетную запись SAP HANA пользователя, созданную таким образом, чтобы скриптам не нужно было отправлять пароли во время выполнения. Команда SAP HANA `hdbuserstore` включает создание ключа пользователя SAP HANA. Ключ хранится на одном или нескольких узлах SAP HANA. и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания сценария не нужно заботиться об управлении паролями). Этот процесс написания сценариев описывается далее.

>[!IMPORTANT]
>Выполните эти команды конфигурации с тем же контекстом пользователя, в котором выполняются команды моментальных снимков. В противном случае команды моментального снимка будут работать неправильно.


### <a name="step-6-get-the-snapshot-scripts-configure-the-snapshots-and-test-the-configuration-and-connectivity"></a>Шаг 6. Получение сценариев создания моментальных снимков, настройка моментальных снимков, тестирование конфигурации и возможностей подключения

Скачайте последнюю версию сценариев на [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.1). Способ установки сценариев изменился с выпуском 4,1 сценариев. Дополнительные сведения см. в разделе "Включение связи с SAP HANA" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Точную последовательность команд см. в разделе «Простая установка средств создания моментальных снимков (по умолчанию)» в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). Рекомендуется использовать установку по умолчанию. 

Обновление с версии 3. x до 4,1 см. в разделе "Обновление существующей установки" статьи [Microsoft snapshot Tools for SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). Сведения об удалении набора средств 4,1 см. в разделе "Удаление средств создания моментальных снимков" раздела [Microsoft snapshot Tools for SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Не забудьте выполнить действия, описанные в разделе "Завершение установки средств моментальных снимков" раздела [Microsoft snapshot Tools for SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Назначение различных сценариев и файлов по мере их установки описывается в разделе "что такое средства создания моментальных снимков?". в [Microsoft snapshot Tools for SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Перед настройкой средств создания моментальных снимков убедитесь, что правильно настроены расположения и параметры для резервного копирования HANA. Дополнительные сведения см. в разделе "Конфигурация SAP HANA" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Конфигурация набора средств моментальных снимков описана в разделе "config file-HANABackupCustomerDetails. txt" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

#### <a name="test-connectivity-with-sap-hana"></a>Проверка подключения с помощью SAP HANA

Поместив все данные конфигурации в файл *HANABackupCustomerDetails.txt*, проверьте правильность конфигурации в отношении данных экземпляра HANA. Используйте сценарий `testHANAConnection`, который не зависит от конфигурации развертывания или масштабирования SAP HANA.

Дополнительные сведения см. в разделе "Проверка подключения с помощью SAP HANA-Тессанаконнектион" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

#### <a name="test-storage-connectivity"></a>Проверка подключения к хранилищу

Следующий шаг теста — проверка подключения к хранилищу на основе данных, помещаемых в файл конфигурации *HANABackupCustomerDetails. txt* . Затем запустите тестовый моментальный снимок. Перед выполнением команды `azure_hana_backup` необходимо выполнить этот тест. Последовательность команд для этого теста приведена в разделе "Проверка подключения с помощью Storage-Тестсторажеснапшотконнектион" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

После успешного входа в интерфейсы виртуальной машины хранилища этот сценарий перейдет к этапу 2 и создаст тестовый моментальный снимок. Выходные данные показаны здесь для горизонтальной конфигурации с тремя узлами SAP HANA.

Если тестовый моментальный снимок успешно запускается с помощью скрипта, можно запланировать фактические моментальные снимки хранилища. Если это не удается, проанализируйте проблемы перед переходом вперед. Тестовый моментальный снимок следует хранить, пока не будут созданы первые настоящие моментальные снимки.


### <a name="step-7-perform-snapshots"></a>Шаг 7. Создание моментальных снимков

После завершения подготовительных действий можно приступить к настройке и планированию фактических моментальных снимков хранилища. Сценарий, выполнение которого следует запланировать, работает с конфигурациями увеличения масштаба и развертывания SAP HANA. Для периодического и регулярного выполнения сценария резервного копирования запланируйте его с помощью служебной программы Cron. 

Точный синтаксис и функциональность команды см. в разделе "выполнение моментального снимка Backup-azure_hana_backup" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). 

При запуске скрипта `azure_hana_backup` создает моментальный снимок хранилища на следующих трех этапах:

1. Он запускает SAP HANAный моментальный снимок.
1. Он запускает моментальный снимок хранилища.
1. Он удаляет SAP HANA моментальный снимок, созданный до запуска моментального снимка хранилища.

Чтобы запустить скрипт, вызовите его из папки исполняемого файла HDB, в которую он был скопирован. 

Срок хранения управляется количеством моментальных снимков, отправляемых в качестве параметра при выполнении скрипта. Время, которое охватывает моментальные снимки хранилища, является функцией периода выполнения и количества моментальных снимков, отправленных в качестве параметра при выполнении скрипта. 

Если количество сохраняемых моментальных снимков превышает число, указанное в качестве параметра при вызове скрипта, то перед запуском нового моментального снимка удаляется самый старый моментальный снимок той же метки. Количество хранимых моментальных снимков можно задать в последнем параметре вызова. С этим числом вы также можете контролировать, косвенно, место на диске, используемое для моментальных снимков. 


## <a name="snapshot-strategies"></a>Стратегии моментальных снимков
Частота создания моментальных снимков для различных типов зависит от того, используются ли функции аварийного восстановления крупного экземпляра HANA. Эти функциональные возможности полагаются на моментальные снимки хранилища, в случае с которыми могут потребоваться некоторые специальные рекомендации с точки зрения частоты и продолжительности их создания. 

В приведенных ниже рекомендациях предполагается, что вы *не* используете функции аварийного восстановления, которые предлагают крупные экземпляры HANA. Предполагается, что вместо этого вы используете моментальные снимки хранилища в качестве средства резервного копирования и имеете возможность выполнить восстановление на определенный момент времени за последние 30 дней. Учитывая ограничения количества моментальных снимков и пространства, учитывайте следующие требования.

- время восстановления до восстановления на определенный момент времени;
- используемое пространство;
- требования к целевой точке восстановления и целевому времени восстановления в случае возможного аварийного восстановления.
- последующее выполнение полного резервного копирования базы данных HANA на диски (при выполнении полного резервного копирования базы данных на диски (или в интерфейс **backint**) создание моментальных снимков хранилища завершается сбоем; Если вы планируете выполнять полные резервные копии базы данных на основе моментальных снимков хранилища, убедитесь в том, что в этот момент выполнение моментальных снимков хранилища отключено.
- Количество моментальных снимков на том, которое ограничено 250.

<!-- backint is term for a SAP HANA interface and not a spelling error not spelling errors -->

Если вы не используете функции аварийного восстановления крупных экземпляров HANA, период моментального снимка будет менее частым. В таких случаях выполните Объединенные моментальные снимки в/Hana/Data и/Hana/Shared, которые включают/usr/SAP, в 12-часовом или 24-часовом периоде. Моментальные снимки следует синхронизировать в месяц. Это справедливо и для моментальных снимков тома резервных копий журналов. Выполнение SAP HANA резервных копий журналов транзакций на томе резервных копий журналов выполняется в течение 5 минут до 15 минут.

Плановое создание моментальных снимков хранилища лучше всего выполнять с помощью средства Cron. Используйте один и тот же сценарий для всех резервных копий и потребностей аварийного восстановления. Измените входные данные сценария в соответствии со временем резервного копирования. Все эти моментальные снимки по-разному планируются в cron в зависимости от времени их выполнения. Он может быть ежечасным, каждые 12 часов, ежедневно или еженедельно. 

В следующем примере показано расписание cron в/etc/crontab.:
```
00 1-23 * * * ./azure_hana_backup --type=hana --prefix=hourlyhana --frequency=15min --retention=46
10 00 * * *  ./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
00,05,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
22 12 * * *  ./azure_hana_backup --type=logs --prefix=dailylogback --frequncy=3min --retention=28
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeI --prefix=dailyboot --frequncy=15min --retention=28
```
В предыдущем примере моментальный снимок, почасовое объединение, охватывает тома, содержащие/Hana/Data и/Хана/Шаред/СИД, в том числе/usr/SAP, Locations. Моментальный снимок этого типа ускоряет восстановление на определенный момент времени в пределах двух дней. На этих томах также имеется ежедневный моментальный снимок. Итак, у вас есть два дня с почасовыми моментальными снимками и четырьмя неделями по ежедневному созданию моментальных снимков. Объем резервной копии журнала транзакций также архивируется ежедневно. Эти резервные копии хранятся в течение четырех недель. 

Как видно в третьей строке crontab, резервное копирование журнала транзакций HANA запланировано на каждые 5 минут. Время начала различных заданий cron, выполняющих моментальные снимки хранилища, размещаются в шахматном порядке. Таким образом, моментальные снимки не запускаются одновременно в определенный момент времени. 

В следующем примере выполняется комбинированный моментальный снимок, охватывающий тома, содержащие/Hana/Data и/Хана/Шаред/СИД, в том числе/usr/SAP, расположения на почасовой основе. Они хранятся в течение двух дней. Моментальные снимки томов резервных копий журналов транзакций выполняются на 5-минутном уровне и хранятся в течение четырех часов. Как и ранее, резервное копирование файла журнала транзакций HANA запланировано на каждые 5 минут. 

Моментальный снимок тома резервных копий журналов транзакций создается с задержкой в 2 минуты после начала резервного копирования журнала транзакций. В нормальных обстоятельствах резервная копия журнала транзакций SAP HANA завершается в течение этих 2 минут. Как и ранее, резервное копирование тома, содержащего загрузочный логический номер устройства, выполняется один раз в день: создается моментальный снимок хранилища, который хранится приблизительно четыре недели.

```
10 0-23 * * * ./azure_hana_backup --type=hana ==prefix=hourlyhana --frequency=15min --retention=48
0,5,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
2,7,12,17,22,27,32,37,42,47,52,57 * * * *  ./azure_hana_backup --type=logs --prefix=logback --frequency=3min --retention=48
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeII --prefix=dailyboot --frequency=15min --retention=28
```

На следующем рисунке показаны последовательности предыдущего примера. Загрузочный LUN исключен.

![Связь между резервными копиями и моментальными снимками](./media/hana-overview-high-availability-disaster-recovery/backup_snapshot_updated0921.PNG)

SAP HANA регулярно записывает данные на том /hana/log, чтобы регистрировать зафиксированные изменения в базе данных. SAP HANA регулярно записывает точку сохранения на том /hana/data. Как указано в crontab, резервная копия журнала транзакций SAP HANA выполняется каждые 5 минут. 

Вы также видите, что SAP HANA моментальный снимок выполняется каждый час в результате запуска комбинированного моментального снимка хранилища по томам/Hana/Data и/Хана/Шаред/СИД. После выполнения моментального снимка HANA выполняется Объединенный моментальный снимок хранилища. Как указано в crontab, моментальный снимок хранилища на томе/Hana/logbackup. выполняется каждые 5 минут после создания резервной копии журнала транзакций HANA около 2 минут.

> 

>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища имеет смысл, только если моментальные снимки создаются совместно с резервными копиями журналов транзакций SAP HANA. Эти резервные копии журналов транзакций должны охватывать временные периоды между моментальными снимками хранилища. 

Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- Получите доступ к Объединенному моментальному снимку хранилища по/Hana/Data и/Хана/Шаред/СИД, который старше 30 дней, в крайних случаях. 
- Связанные резервные копии журналов транзакций, охватывающие время между всеми объединенными моментальными снимками хранилища. Поэтому наиболее старому моментальному снимку тома резервных копий журналов транзакций должно быть 30 дней. Это не так, если вы копируете резервные копии журналов транзакций в другую общую папку NFS, расположенную в службе хранилища Azure. В этом случае можно получить старые резервные копии журналов транзакций из этого общедоступного ресурса NFS.

Чтобы получить преимущества от моментальных снимков хранилища и окончательной репликации резервных копий журналов транзакций, измените расположение, в которое SAP HANA записывает резервные копии журналов транзакций. Это можно сделать в HANA Studio. 

Хотя SAP HANA создает резервную копию полных сегментов журнала автоматически, укажите детерминированный интервал резервного копирования журнала. Это особенно справедливо при использовании варианта аварийного восстановления, поскольку обычно требуется выполнять резервное копирование журналов с детерминированным периодом. В следующем случае в качестве интервала резервного копирования журнала устанавливается 15 минут.

![Настройка расписания для создания резервных копий журналов SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Вы также можете выбрать резервные копии, которые выполняются чаще, чем каждые 15 минут. Такое более частое значение используется в сочетании с функциональной возможностью аварийного восстановления HANA (крупные экземпляры). Некоторые клиенты создают резервные копии журналов транзакций каждые 5 минут.

Если резервная копия базы данных еще не создавалась, то последний этап заключается в создании ее файловой резервной копии. Это позволит создать одну запись резервной копии, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не сможет инициировать указанные резервные копии журналов.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)


После выполнения первого успешного создания моментальных снимков хранилища удалите тестовый моментальный снимок, который выполнялся на шаге 6. Дополнительные сведения см. в разделе "Удаление тестовых моментальных снимков — Ремоветестсторажеснапшот" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). 


### <a name="monitor-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Отслеживание количества и размера моментальных снимков на томе диска

Количество моментальных снимков и занимаемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Команда Linux OS `du` отображает сведения об этих моментальных снимках хранилища, поскольку они хранятся на одних и тех же томах. Используйте команду со следующими параметрами:

- `du –sh .snapshot` — возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1` — выводит список всех моментальных снимков, сохраненных в папке **.snapshot**, и размер каждого моментального снимка.
- `du –hc` — возвращает общий размер всех моментальных снимков.

Используйте эти команды, чтобы убедиться, что созданные и сохраненные моментальные снимки не потребляют все хранилище на томах.

>[!NOTE]
>Моментальные снимки загрузочного LUN не отображаются с предыдущими командами.

### <a name="get-details-of-snapshots"></a>Получение сведений о моментальных снимках
Чтобы получить дополнительные сведения о моментальных снимках, используйте скрипт `azure_hana_snapshot_details`. Этот скрипт можно запустить в любом расположении, если в расположении аварийного восстановления имеется активный сервер. Этот сценарий предоставляет следующие выходные данные с разбивкой по томам, содержащим моментальные снимки: 
   * общий размер моментальных снимков на томе;
   * Для каждого снимка на этом томе указываются следующие сведения: 
      - имя моментального снимка; 
      - время создания снимка; 
      - размер снимка;
      - частота создания снимка;
      - идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).

Синтаксис команды и выходных данных см. в разделе "List snapshots-azure_hana_snapshot_details" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). 



### <a name="reduce-the-number-of-snapshots-on-a-server"></a>Уменьшение количества моментальных снимков на сервере

Как было сказано выше, можно уменьшить количество определенных меток моментальных снимков, которые вы храните. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
```

В предыдущем примере метка моментального снимка — **даилихана**. Число моментальных снимков с этой меткой не должно превышать **28**. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. Например, простой способ сократить число моментальных снимков до 15 — запустить сценарий с последним параметром, равным **15**:

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=15
```

Если запустить сценарий с этим параметром, число моментальных снимков, включая новый моментальный снимок хранилища, будет равно 15. Останутся 15 последних моментальных снимков, тогда как 15 более старых моментальных снимков будут удалены.

 >[!NOTE]
 > Этот сценарий сокращает количество моментальных снимков, только если моментальные снимки имеют более одного часа назад. Скрипт не удаляет моментальные снимки, которые были менее одного часа назад. Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если вы больше не хотите поддерживать набор моментальных снимков с префиксом резервной копии, **даилихана** в примерах синтаксиса, запустите сценарий с **0** в качестве номера хранения. Затем удаляются все моментальные снимки, соответствующие этой метке. Удаление всех моментальных снимков может повлиять на возможности функции аварийного восстановления в крупных экземплярах HANA.

Второй способ удалить определенные моментальные снимки — сценарий `azure_hana_snapshot_delete`. Этот сценарий предназначен для удаления моментального снимка или набора моментальных снимков с помощью идентификатора резервного копирования HANA, указанного в HANA Studio, или имени моментального снимка. В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам типа **hana**. Резервное копирование моментальных снимков **журналов** типов и **загрузки** не выполняет SAP HANA моментальный снимок, поэтому для этих моментальных снимков не найдено ни одного идентификатора резервного копирования. Если введено имя моментального снимка, то на разных томах будет выполнен поиск всех моментальных снимков, соответствующих этому имени. 

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->

Дополнительные сведения о скрипте см. в разделе "Удаление моментального снимка-azure_hana_snapshot_delete" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Запустите сценарий от имени **привилегированного**пользователя.

>[!IMPORTANT]
>Если имеются данные, которые существуют только в моментальном снимке, который планируется удалить, то после удаления моментального снимка данные теряются навсегда.


## <a name="file-level-restore-from-a-storage-snapshot"></a>Восстановление уровня файла из моментального снимка хранилища

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->
Моментальные снимки типов **hana** и **logs** дают возможность обращаться непосредственно к моментальным снимкам на томах в каталоге **.snapshot**. Существует подкаталог для каждого моментального снимка. Скопируйте каждый файл в том состоянии, в котором он находился в момент создания снимка из этого подкаталога в реальной структуре каталогов. 

В текущей версии скрипта для восстановления моментального снимка в качестве самообслуживания *не* указан скрипт восстановления. Восстановление моментальных снимков может выполняться в рамках сценариев аварийного восстановления самообслуживания на сайте аварийного восстановления во время отработки отказа. Чтобы восстановить нужный моментальный снимок из существующих доступных моментальных снимков, необходимо обратиться в службу Microsoft Operations, открыв запрос на обслуживание.

>[!NOTE]
>Восстановление одного файла не работает для моментальных снимков загрузочного LUN независимо от типа единиц крупных экземпляров HANA. Каталог **. snapshot** не отображается в загрузочном LUN. 
 

## <a name="recover-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В рабочем сценарии процесс восстановления из моментального снимка хранилища может быть запущен в качестве инцидента клиента с поддержкой Microsoft Azure. Это очень срочно, если данные были удалены в рабочей системе, и единственным способом их извлечения является восстановление рабочей базы данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться на несколько дней вперед. Вы можете запланировать восстановление с SAP HANA в Azure вместо создания флага с высоким приоритетом. Например, вы можете запланировать обновление программного обеспечения SAP, применив новый пакет расширения. Затем необходимо восстановить моментальный снимок с состоянием до обновления пакета расширений.

Прежде чем отправлять запрос, следует учесть некоторые моменты, После этого SAP HANA в группе Azure может выполнить запрос и предоставить восстановленные тома. после чего вы сможете восстановить базу данных HANA на основе моментальных снимков.

Сведения о возможностях получения моментального снимка, восстановленного с помощью нового набора инструментов, см. в разделе "восстановление моментального снимка" [руководства по восстановлению SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Чтобы подготовиться к запросу, выполните следующие действия.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data. 

1. Завершите работу экземпляра HANA.

   ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

1. Отключите тома данных на каждом узле базы данных HANA. Если тома данных все еще подключены к операционной системе, восстановление моментального снимка завершится ошибкой.

   ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

1. Откройте запрос в службу поддержки Azure и включите в него инструкции по восстановлению определенного моментального снимка:

   - Во время восстановления: SAP HANA в службе Azure может попросить посетить конференц-связь для координации, проверки и подтверждения восстановления правильного моментального снимка хранилища. 

   - После восстановления SAP HANA службы Azure уведомляет вас о восстановлении моментального снимка хранилища.

1. Когда процесс восстановления завершится, подключите все тома данных.

   ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)



Другой способ получения, например SAP HANA файлов данных, восстановленных из моментального снимка хранилища, описан в шаге 7 [руководства по восстановлению вручную для SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Сведения о восстановлении из резервной копии моментальных снимков см. в [руководстве по восстановлению SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). 

>[!Note]
>Если ваш моментальный снимок был восстановлен с помощью Microsoft Operations, шаг 7 выполнять не нужно.


### <a name="recover-to-another-point-in-time"></a>Восстановление до другой точки во времени
Чтобы выполнить восстановление до определенной точки во времени, см. раздел "восстановление базы данных до следующего момента времени" раздела [руководство по восстановлению вручную для SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). 


## <a name="next-steps"></a>Дальнейшие действия
- См. раздел [принципы аварийного восстановления и подготовка](hana-concept-preparation.md).
