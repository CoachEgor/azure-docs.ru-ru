---
title: Резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Узнайте, как выполнять резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры).
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: gwallace
editor: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 10/16/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 4384d29811d29f06422802abba5d3eb1ea5737e9
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "72430076"
---
# <a name="backup-and-restore"></a>Резервное копирование и восстановление

>[!IMPORTANT]
>Эта статья не является заменой административной документации SAP HANA или SAP Notes. Мы ожидаем, что у вас есть полное понимание и опыт в управлении и операциях SAP HANA, особенно для резервного копирования, восстановления, высокой доступности и аварийного восстановления. В этой статье показаны скриншоты из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Очень важно выполнять шаги и процессы в собственной среде и собственных версиях и выпусках HANA. Некоторые процессы, описанные в этой статье, упрощаются для лучшего общего понимания. Они не предназначены для использования в качестве подробных шагов для возможных справочников по эксплуатации. Если вы хотите создать руководства по эксплуатации для конфигураций, проверьте и осуществляйте процессы и задокументируйте процессы, связанные с определенными конфигурациями. 

Одним из наиболее важных аспектов работы баз данных является защита их от катастрофических событий. Эти события могут возникать как в результате стихийных бедствий, так и из-за стандартных ошибок пользователей.

Резервное копирование базы данных с возможностью ее восстановления в любой момент времени, например, до того, как кто-то удалил критически важные данные, позволяет восстановить состояние, максимально приближенное к тому, как это было до сбоя.

Для получения возможности восстановления необходимо выполнить два типа резервных копирования:

- резервное копирование баз данных — полные, добавочные или разностные резервные копии;
- резервное копирование журналов транзакций.

Кроме полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Снимки хранилища не заменяют резервные копии журнала транзакций. Резервные копии журналов транзакций по-прежнему важны при восстановлении базы данных до определенной точки во времени и очистке журналов от уже зафиксированных транзакций. Снимки хранения могут ускорить восстановление, быстро обеспечивая свернутое изображение базы данных. 

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- **Модель "Сделай сам".** После того, как вы убедитесь, что есть достаточно диска пространства, выполнить полную базу данных и резервного копирования журнала с помощью одного из следующих методов резервного копирования диска. Вы можете резервное копирование либо непосредственно на объемы, прикрепленные к подразделениям HANA Large Instance, либо к акциям NFS, настроенным в виртуальной машине Azure (VM). В последнем случае клиенты настраивают виртуальную машину Linux в Azure, подключают к ней службу хранилища Azure и предоставляют общий доступ к хранилищу через настроенный NFS-сервер на этой виртуальной машине. Если вы выполняете резервное копирование против томов, которые непосредственно прикрепляются к единицам HANA Large Instance, скопируйте резервные копии на учетную запись хранения Azure. Сделайте это после настройки Azure VM, который экспортирует акции NFS, основанные на Хранилище Azure. Вы также можете использовать хранилище резервного копирования Azure или холодное хранилище Azure. 

   Другим вариантом является использование стороннего инструмента защиты данных для хранения резервных копий после их скопирования в учетную запись хранения Azure. Опция резервного копирования DIY также может быть необходима для данных, которые необходимо хранить в течение более длительных периодов времени для целей соответствия и аудита. Во всех случаях резервные копии копируются в общедоступные ресурсы NFS, представленные с помощью виртуальной машины и службы хранилища Azure.

- **Функции резервного копирования и восстановления, предоставленные инфраструктурой.** Вы также можете использовать резервную и восстановитете функциональность, которую предоставляет базовая инфраструктура SAP HANA на Azure (Большие инстанции). Этот вариант удовлетворяет потребность в резервном копировании и быстром восстановлении. В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA. В этом разделе также рассматриваются взаимосвязи, которые резервное копирование и восстановление имеют к функциональности аварийного восстановления, предлагаемой HANA Large Instances.

> [!NOTE]
>   Технология моментального снимка, используемая базовой инфраструктурой HANA Large Instances, зависит от снимков SAP HANA. На данный момент снимки SAP HANA не работают в сочетании с несколькими арендаторами контейнеров с мультитенантной базой данных SAP HANA. Если развернут только один арендатор, снимки SAP HANA работают, и вы можете использовать этот метод.

## <a name="use-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Используйте снимки хранения SAP HANA на Azure (Большие инстанции)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища томов. Поддерживается резервное копирование и восстановление тома, но следует учитывать следующее.

- Вместо полных резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- Когда снимок срабатывает над /hana/data и /hana/shared, который включает /usr/sap, тома, технология снимка инициирует снимок SAP HANA перед запуском моментального снимка хранилища. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища. Для успешного снимка HANA требуется активный экземпляр HANA. В сценарии HSR моментальный снимок хранилища не поддерживается на текущем вторичном узло, где снимок HANA не может быть выполнен.
- После успешного запуска моментального снимка хранилища снимок SAP HANA удаляется.
- Резервные копии журналов транзакций создаются часто и хранятся на томе /hana/logbackups или в Azure. Вы можете активировать том /hana/logbackups, содержащий резервные копии журналов транзакций, для отдельного создания моментального снимка. В этом случае вам не нужно запускать снимок HANA.
- Если необходимо восстановить базу данных в определенный момент времени для сбоа в производстве, попросите службу поддержки Microsoft Azure или SAP HANA в Azure восстановить определенный момент хранения. Например, плановое восстановление системы типа "песочница" до исходного состояния.
- Снимок SAP HANA, включенный в моментальный снимок хранилища, является офсетной точкой для применения резервных копий журнала транзакций, которые бежали и хранились после того, как был сделан снимок хранилища.
- Эти резервные копии журналов транзакций используются для восстановления базы данных до определенной точки во времени.

Можно выполнять снимки хранилища, ориентированные на три класса томов:

- Комбинированный снимок над /hana/data и /hana/shared, который включает /usr/sap. Для этого моментального снимка требуется создать моментальный снимок SAP HANA в качестве подготовки для моментального снимка хранилища. Снимок SAP HANA гарантирует, что база данных находится в постоянном состоянии с точки зрения хранения. Для процесса восстановления это точка настройки.
- Отдельный моментальный снимок тома /hana/logbackups.
- Раздел операционной системы.

Чтобы получить последние сценарии и документацию, смотрите [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md). При загрузке пакета скриптов с момента снимка с [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md)вы получаете три файла. Один из файлов задокументирован в PDF для предоставляемой функциональности. После загрузки набора инструментов следуйте инструкциям в "Получить инструменты моментального снимка".

## <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Снимки хранения потребляют пространство для хранения, выделенное подразделениям HANA Large Instance. Рассмотрим следующие аспекты планирования моментальных снимков хранения и количество моментальных снимков хранилища. 

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Конкретный момент памяти в момент, когда он принимает потребляет мало хранения.
- По мере изменения содержимого данных и изменения содержимого файлов данных SAP HANA на объем еде, моментальный снимок должен хранить исходное содержимое блока и изменения данных.
- В результате размер моментального снимка хранилища увеличивается. в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. Создание моментальных снимков этих томов требует много пространства на томе. Для этого необходимо:

- Определите, когда следует запланировать моментальные снимки хранилища.
- Мониторинг емкости пространства объемов хранения. 
- Управление количеством моментальных снимков, которые вы храните. 

Вы можете отключить создание моментальных снимков хранилища, если импортируются большие объемы данных, или внести другие важные изменения в базу данных HANA. 


Следующие разделы содержат информацию для выполнения этих снимков и содержат общие рекомендации:

- Хотя аппаратное обеспечение может выдержать 255 снимков на объем, вы хотите оставаться значительно ниже этого числа. Рекомендация 250 или меньше.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Вы можете уменьшить количество хранящихся моментальных снимков или расширить тома. Вы можете заказать дополнительное пространство в единицах по 1 ТБ.
- При выполнении таких действий, как перенос данных в SAP HANA с помощью средств переноса платформы SAP (R3load) или восстановление баз данных SAP HANA из резервных копий, необходимо отключить создание моментальных снимков хранилища для тома /hana/data. 
- Во время больших реорганизаций таблиц SAP HANA избегайте, по возможности, моментальных снимков для хранения.
- Моментальные снимки хранилища обеспечивают поддержку возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

## <a name="prerequisites-for-using-self-service-storage-snapshots"></a>Необходимые условия для использования самостоятельных моментальных снимков хранилища

Чтобы убедиться, что скрипт моментального снимка работает успешно, убедитесь, что Perl установлен на операционной системе Linux на сервере HANA Large Instances. Perl предустановлен на вашем блоке HANA Large Instance. Чтобы проверить версию Perl, используйте следующую команду:

`perl -v`

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/perl_screen.png)


## <a name="set-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

Чтобы настроить моментальные снимки хранилища с помощью HANA Large Instances, выполните следующие действия.
1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
1. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
1. Создание учетной записи резервного пользователя SAP HANA на главном узлах для каждого экземпляра SAP HANA, если это применимо.
1. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
1. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
1. Скопируйте сценарии и файл конфигурации из [этого расположения GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md) в расположение **hdbsql** установленного экземпляра SAP HANA.
1. Измените файл *HANABackupDetails.txt* по мере необходимости для соответствующих спецификаций клиента.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md). Для перечисленных ранее [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)шагов см.

### <a name="consideration-for-mcod-scenarios"></a>Рекомендации для сценариев MCOD
Если вы выполняете [сценарий MCOD](https://launchpad.support.sap.com/#/notes/1681092) с несколькими экземплярами SAP HANA на одном блоке HANA Large Instance, у вас есть отдельные объемы хранения, подготовленные для каждого из экземпляров SAP HANA. Для получения дополнительной информации о MDC и других соображениях, см. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)
 

### <a name="step-1-install-the-sap-hana-hdb-client"></a>Шаг 1. Установка клиента SAP HANA HDB

Операционная система Linux, установленная на SAP HANA on Azure (Большие инстанции), включает папки и скрипты, необходимые для выполнения снимков хранения SAP HANA для резервного копирования и аварийного восстановления. Проверьте более поздние релизы в [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/release.md). 

Это ваша ответственность, чтобы установить SAP HANA HDB клиента на HANA Большой инстанции единиц при установке SAP HANA.

### <a name="step-2-change-the-etcsshssh_config"></a>Шаг 2. Изменение файла /etc/ssh/ssh\_config

Этот шаг описан в "Включить связь с хранилищем" в [инструментах microsoft snapshot для SAP HANA на Azure.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)


### <a name="step-3-create-a-public-key"></a>Этап 3. Создание открытого ключа

Чтобы обеспечить доступ к интерфейсам моментального хранения вашего клиента HANA Large Instance, установите процедуру вхластки через общедоступный ключ. 

На первом сервере SAP HANA на сервере Azure (Large Instances) в вашем арендаторе создайте общедоступный ключ для доступа к инфраструктуре хранения данных. С общедоступным ключом пароль не требуется для вхуштывого интерфейса для хранения моментальных данных. Вам также не нужно поддерживать учетные данные паролей с общедоступным ключом. 

Для создания общедоступного ключа см. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)


### <a name="step-4-create-an-sap-hana-user-account"></a>Этап 4. Создание учетной записи пользователя SAP HANA

Чтобы начать создание снимков SAP HANA, создайте учетную запись пользователя в SAP HANA, которую могут использовать скрипты моментального хранения. Для этих целей создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Пользователь должен быть создан в соответствии с SYSTEMDB, а *не* в базе данных SID для MDC. В среде одного контейнера пользователь создается в базе данных арендаторов. Эта учетная запись должна иметь привилегии **Backup Admin** и **Каталог Читать.** 

Для настройки и использования учетной записи пользователя см. [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)


### <a name="step-5-authorize-the-sap-hana-user-account"></a>Этап 5. Авторизация учетной записи пользователя SAP HANA

На этом этапе вы разрешаете создать созданную учетную запись пользователя SAP HANA, чтобы скриптам не нужно было отправлять пароли во время выполнения. Команда `hdbuserstore` SAP HANA позволяет создать ключ пользователя SAP HANA. Ключ хранится на одном или нескольких узлах SAP HANA. и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания сценария не нужно заботиться об управлении паролями). Этот процесс написания сценариев описывается далее.

>[!IMPORTANT]
>Выполнить эти команды конфигурации с тем же контекстом пользователя, в которых запускаются команды моментального снимка. В противном случае команды моментального снимка не будут работать должным образом.


### <a name="step-6-get-the-snapshot-scripts-configure-the-snapshots-and-test-the-configuration-and-connectivity"></a>Шаг 6. Получение сценариев создания моментальных снимков, настройка моментальных снимков, тестирование конфигурации и возможностей подключения

Скачайте последнюю версию сценариев на [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.1). Способ установки скриптов изменен с выпуском 4.1 скриптов. Для получения дополнительной информации см. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

Для точной последовательности команд см. "Легкая установка инструментов моментального снимка (по умолчанию)" в [инструментах microsoft snapshot для SAP HANA на Azure.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md) Мы рекомендуем использовать установку по умолчанию. 

Чтобы перейти от версии 3.x до 4.1, [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)см. Чтобы удалить набор инструментов 4.1, [см.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

Не забудьте запустить шаги, описанные в "Полная настройка моментальных инструментов" в [инструментах microsoft snapshot для SAP HANA на Azure.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

Цель различных скриптов и файлов по мере их установки описана в "Что это за инструменты моментального снимка?" в [инструментах microsoft snapshot для SAP HANA на Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Прежде чем настроить инструменты моментального снимка, убедитесь, что вы также правильно настроили места и настройки резервного копирования HANA. Для получения дополнительной информации см. "SAP HANA Configuration" в [инструменте Microsoft snapshot для SAP HANA на Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md).

Конфигурация набора инструментов моментального снимка описана в "Файле конфигурации - HANABackupCustomerDetails.txt" в [инструментах microsoft snapshot для SAP HANA на Azure.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

#### <a name="test-connectivity-with-sap-hana"></a>Тестподключение с SAP HANA

Поместив все данные конфигурации в файл *HANABackupCustomerDetails.txt*, проверьте правильность конфигурации в отношении данных экземпляра HANA. Используйте сценарий `testHANAConnection`, который не зависит от конфигурации развертывания или масштабирования SAP HANA.

Для получения дополнительной информации см. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

#### <a name="test-storage-connectivity"></a>Подключение к тестируемому хранению

Следующим этапом тестирования является проверка подключения к хранилищу на основе данных, которые вы вкладываете в файл конфигурации *HANABackupCustomers.txt.* Затем запустите тестовый снимок. Перед запуском `azure_hana_backup` команды необходимо выполнить этот тест. Для последовательности команд для этого теста см. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

После успешного входа в интерфейсы виртуальной машины хранилища этот сценарий перейдет к этапу 2 и создаст тестовый моментальный снимок. Выход отображается здесь для трехузловой конфигурации SAP HANA.

Если тестовый снимок успешно выполняется со сценарием, можно запланировать фактические моментальные моменты хранения. Если он не успешен, исследуйте проблемы, прежде чем двигаться вперед. Тестовый моментальный снимок следует хранить, пока не будут созданы первые настоящие моментальные снимки.


### <a name="step-7-perform-snapshots"></a>Шаг 7. Создание моментальных снимков

После завершения подготовительных шагов можно приступить к настройке и графику фактических моментктов хранения. Сценарий, выполнение которого следует запланировать, работает с конфигурациями увеличения масштаба и развертывания SAP HANA. Для периодического и регулярного выполнения сценария резервного копирования запланируйте его с помощью служебной программы Cron. 

Для точного синтаксиса и функциональности команды с azure_hana_backupм. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md) 

При запуске скрипта `azure_hana_backup` создается моментальный снимок хранилища в следующих трех фазах:

1. Он запускает снимок SAP HANA.
1. Он запускает моментальный снимок хранилища.
1. Он удаляет снимок SAP HANA, который был создан до того, как был опубликован моментальный снимок хранилища.

Чтобы запустить скрипт, позвоните ему из исполняемой папки HDB, к которой он был скопирован. 

Период удержания администрируется с числом моментальных снимков, которые представлены в качестве параметра при запуске скрипта. Время, охватываемое моментальными снимками хранилища, зависит от периода выполнения и количества моментальных снимков, представленных в качестве параметра при запуске скрипта. 

Если количество сохраненных моментальных снимков превышает число, названное в качестве параметра в вызове скрипта, самый старый снимок хранилища той же метки удаляется до запуска нового снимка. Количество хранимых моментальных снимков можно задать в последнем параметре вызова. С помощью этого числа вы также можете косвенно управлять дисковым пространством, которое используется для снимков. 


## <a name="snapshot-strategies"></a>Стратегии моментальных снимков
Частота создания моментальных снимков для различных типов зависит от того, используются ли функции аварийного восстановления крупного экземпляра HANA. Эти функциональные возможности полагаются на моментальные снимки хранилища, в случае с которыми могут потребоваться некоторые специальные рекомендации с точки зрения частоты и продолжительности их создания. 

В приведенных ниже рекомендациях предполагается, что вы *не* используете функции аварийного восстановления, которые предлагают крупные экземпляры HANA. Предполагается, что вместо этого вы используете моментальные снимки хранилища в качестве средства резервного копирования и имеете возможность выполнить восстановление на определенный момент времени за последние 30 дней. Учитывая ограниченность количества снимков и пространства, рассмотрим следующие требования:

- время восстановления до восстановления на определенный момент времени;
- используемое пространство;
- требования к целевой точке восстановления и целевому времени восстановления в случае возможного аварийного восстановления.
- последующее выполнение полного резервного копирования базы данных HANA на диски (при выполнении полного резервного копирования базы данных на диски (или в интерфейс **backint**) создание моментальных снимков хранилища завершается сбоем; Если вы планируете запускать резервные копии полной базы данных поверх моментальных снимков хранилища, убедитесь, что выполнение моментальных снимков хранилища отключено в течение этого времени.
- Количество снимков на объем, которое ограничено 250.

<!-- backint is term for a SAP HANA interface and not a spelling error not spelling errors -->

Если вы не используете функцию аварийного восстановления HANA Large Instances, период моментального снимка становится менее частым. В таких случаях выполняйте комбинированные снимки на /hana/data и /hana/shared, которые включают /usr/sap, в 12-часовые или 24-часовые периоды. Храните снимки в течение месяца. То же самое относится и к снимкам громкости резервного копирования журнала. Выполнение резервных копий журнала SAP HANA против объема резервного копирования журнала происходит в 5-минутных и 15-минутных периодах.

Плановое создание моментальных снимков хранилища лучше всего выполнять с помощью средства Cron. Используйте один и тот же скрипт для всех резервных и аварийных потребностей. Измените входные данные сценария в соответствии со временем резервного копирования. Все эти снимки планируются по-разному в cron в зависимости от времени выполнения. Это может быть ежечасно, каждые 12 часов, ежедневно или еженедельно. 

Следующий пример показывает график cron в /etc/crontab:
```
00 1-23 * * * ./azure_hana_backup --type=hana --prefix=hourlyhana --frequency=15min --retention=46
10 00 * * *  ./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
00,05,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
22 12 * * *  ./azure_hana_backup --type=logs --prefix=dailylogback --frequncy=3min --retention=28
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeI --prefix=dailyboot --frequncy=15min --retention=28
```
В предыдущем примере почасовой комбинированный снимок охватывает объемы, содержащие /hana/data и /hana/shared/SID, который включает в себя /usr/sap, местоположения. Моментальный снимок этого типа ускоряет восстановление на определенный момент времени в пределах двух дней. Там также ежедневный снимок на эти тома. Таким образом, у вас есть два дня покрытия почасовые снимки плюс четыре недели покрытия ежедневные снимки. Объем резервного копирования журнала транзакции также резервное копирование ежедневно. Эти резервные копирования хранятся в течение четырех недель. 

Как вы видите в третьей строке crontab, резервное копирование журнала транзакций HANA планируется запускать каждые 5 минут. Время начала различных заданий cron, запускаемых моментальными моментами хранения, пошатнулось. Таким образом, снимки не работают сразу в определенный момент времени. 

В следующем примере выполняется комбинированный снимок, который охватывает объемы, содержащие /hana/data и /hana/shared/SID, который включает /usr/sap, места на почасовой основе. Они хранятся в течение двух дней. Снимки объемов резервного копирования транзакции работают на 5-минутной основе и хранятся в течение четырех часов. Как и прежде, резервное копирование файла журнала транзакций HANA планируется запускать каждые 5 минут. 

Моментальный снимок тома резервных копий журналов транзакций создается с задержкой в 2 минуты после начала резервного копирования журнала транзакций. При обычных обстоятельствах резервное копирование журнала транзакций SAP HANA завершается в течение этих 2 минут. Как и ранее, резервное копирование тома, содержащего загрузочный логический номер устройства, выполняется один раз в день: создается моментальный снимок хранилища, который хранится приблизительно четыре недели.

```
10 0-23 * * * ./azure_hana_backup --type=hana ==prefix=hourlyhana --frequency=15min --retention=48
0,5,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
2,7,12,17,22,27,32,37,42,47,52,57 * * * *  ./azure_hana_backup --type=logs --prefix=logback --frequency=3min --retention=48
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeII --prefix=dailyboot --frequency=15min --retention=28
```

Следующий график иллюстрирует последовательности предыдущего примера. Загрузка LUN исключена.

![Связь между резервными копиями и моментальными снимками](./media/hana-overview-high-availability-disaster-recovery/backup_snapshot_updated0921.PNG)

SAP HANA регулярно записывает данные на том /hana/log, чтобы регистрировать зафиксированные изменения в базе данных. SAP HANA регулярно записывает точку сохранения на том /hana/data. Как указано в crontab, резервное копирование журнала транзакций SAP HANA выполняется каждые 5 минут. 

Вы также видите, что снимок SAP HANA выполняется каждый час в результате запуска комбинированного снимка хранилища по часам /hana/data и /hana/shared/SID томов. После успешного снимка HANA выполняется комбинированный моментальный снимок хранилища. По инструкции в crontab, снимок хранилища на /hana/logbackup объем работает каждые 5 минут, около 2 минут после резервного копирования журнала транзакции HANA.

> 

>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища имеет смысл, только если моментальные снимки создаются совместно с резервными копиями журналов транзакций SAP HANA. Эти резервные копии журналов транзакций должны охватывать временные периоды между моментальными снимками хранилища. 

Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- В крайних случаях получите доступ к комбинированному моментальному моментуму хранения по сравнению с /hana/data и /hana/shared/SID, которым 30 дней. 
- Связанные резервные копии журналов транзакций, охватывающие время между всеми объединенными моментальными снимками хранилища. Поэтому наиболее старому моментальному снимку тома резервных копий журналов транзакций должно быть 30 дней. Это не тот случай, если вы копируете резервные копии журнала транзакций на другую долю NFS, расположенную в хранилище Azure. В этом случае можно получить старые резервные копии журналов транзакций из этого общедоступного ресурса NFS.

Чтобы извлечь выгоду из моментальных снимков хранилища и возможного репликации резервных копий журнала транзакций, измените место, в которое SAP HANA записывает резервные копии журнала транзакций. Это можно сделать в HANA Studio. 

Хотя SAP HANA автоматически резервирует полные сегменты журналов, укажите интервал резервного копирования журнала, чтобы быть детерминированным. Это особенно верно при использовании опции аварийного восстановления, поскольку обычно требуется запустить резервные копии журнала с детерминированным периодом. В следующем случае 15 минут устанавливается в качестве интервала резервного копирования журнала.

![Настройка расписания для создания резервных копий журналов SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Вы также можете выбрать резервные копирования, которые являются более частыми, чем каждые 15 минут. Такое более частое значение используется в сочетании с функциональной возможностью аварийного восстановления HANA (крупные экземпляры). Некоторые клиенты создают резервные копии журналов транзакций каждые 5 минут.

Если резервная копия базы данных еще не создавалась, то последний этап заключается в создании ее файловой резервной копии. Это позволит создать одну запись резервной копии, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не может инициировать указанные резервные копии журнала.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)


После запуска первых успешных моментнок хранения удалите тестовый снимок, который был запущен в шаге 6. Для получения дополнительной информации см. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md) 


### <a name="monitor-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Мониторинг количества и размера снимков на томе диска

Количество моментальных снимков и занимаемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Команда `du` Linux OS показывает подробную информацию об этих моментальных снимках хранения, поскольку они хранятся в тех же томах. Используйте команду со следующими опциями:

- `du –sh .snapshot` — возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1` — выводит список всех моментальных снимков, сохраненных в папке **.snapshot**, и размер каждого моментального снимка.
- `du –hc` — возвращает общий размер всех моментальных снимков.

Используйте эти команды, чтобы убедиться, что снимки, которые берутся и хранятся, не потребляют все хранилища на томах.

>[!NOTE]
>Снимки загрузки LUN не видны с предыдущими командами.

### <a name="get-details-of-snapshots"></a>Получить подробную информацию о снимках
Чтобы получить более подробную информацию `azure_hana_snapshot_details`о снимках, используйте сценарий . Вы можете запустить этот скрипт в любом месте, если в месте восстановления аварийного положения есть активный сервер. Этот сценарий предоставляет следующие выходные данные с разбивкой по томам, содержащим моментальные снимки: 
   * общий размер моментальных снимков на томе;
   * Для каждого снимка на этом томе указываются следующие сведения: 
      - имя моментального снимка; 
      - время создания снимка; 
      - размер снимка;
      - частота создания снимка;
      - идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).

Для синтаксиса команд и выходов с azure_hana_snapshot_detailsм. [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md) 



### <a name="reduce-the-number-of-snapshots-on-a-server"></a>Уменьшите количество моментальных снимков на сервере

Как указывалось ранее, можно уменьшить количество определенных меток моментальных снимков, которые вы храните. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
```

В предыдущем примере метка моментального **снимка является dailyhana.** Количество снимков с этой этикеткой, которые будут сохранены **28**. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. Например, простой способ уменьшить количество снимков до 15 — запустить сценарий с последним параметром, установленным до **15:**

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=15
```

Если вы запустите сценарий с этой настройкой, количество снимков, включающих новый моментальный снимок хранилища, составляет 15. Останутся 15 последних моментальных снимков, тогда как 15 более старых моментальных снимков будут удалены.

 >[!NOTE]
 > Этот скрипт уменьшает количество снимков только при наличии снимков более одного часа. Скрипт не удаляет снимки, которым меньше часа. Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если вы больше не хотите поддерживать набор моментальных снимков с приставкой резервного **копирования dailyhana** в примерах синтаксиса, запустите сценарий с **0** в качестве номера удержания. Все снимки, совпадающие с меткой, затем удаляются. Удаление всех моментальных снимков может повлиять на возможности функциональности аварийного восстановления HANA Large Instances.

Второй способ удалить определенные моментальные снимки — сценарий `azure_hana_snapshot_delete`. Этот сценарий предназначен для удаления моментального снимка или набора моментальных снимков с помощью идентификатора резервного копирования HANA, указанного в HANA Studio, или имени моментального снимка. В настоящее время идентификатор резервного копирования привязан только к снимкам, созданным для типа **снимка Hana.** Моментальные резервные копии **журналов** типов и **загрузки** не выполняют снимок SAP HANA, поэтому для этих снимков нет идентификатора резервного копирования. Если введено имя моментального снимка, то на разных томах будет выполнен поиск всех моментальных снимков, соответствующих этому имени. 

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->

Для получения дополнительной информации о скрипте с [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)azure_hana_snapshot_deleteм.

Выполнить сценарий в качестве **корня**пользователя .

>[!IMPORTANT]
>Если есть данные, которые существуют только на моментальном снимке, который вы планируете удалить, после удаления снимка эти данные теряются навсегда.


## <a name="file-level-restore-from-a-storage-snapshot"></a>Восстановление уровня файла из моментального снимка хранилища

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->
Моментальные снимки типов **hana** и **logs** дают возможность обращаться непосредственно к моментальным снимкам на томах в каталоге **.snapshot**. Для каждого из снимков есть субдиректор. Копируйте каждый файл в состоянии, в которое он находился в момент снимка из этого субдиректора, в фактическую структуру каталога. 

В текущей версии скрипта *нет* сценария восстановления, предусмотренного для восстановления моментального снимка в качестве самообслуживания. Восстановление моментального снимка может быть выполнено как часть скриптов аварийного восстановления самообслуживания на месте аварийного восстановления во время сбоя. Чтобы восстановить желаемый моментальный снимок из существующих доступных моментальных снимков, необходимо связаться с командой операций Майкрософт, открыв запрос на обслуживание.

>[!NOTE]
>Восстановление одного файла не работает для снимков загрузки LUN независимо от типа блоков HANA Large Instance. Каталог **.snapshot** не разоблачается в загрузке LUN. 
 

## <a name="recover-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В сценарии сработка производства процесс восстановления после моментального снимка хранилища может быть запущен как инцидент с клиентом с поддержкой Microsoft Azure. Это вопрос высокой срочности, если данные были удалены в производственной системе, и единственный способ получить его является восстановление производственной базы данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться на несколько дней вперед. Вы можете спланировать это восстановление с помощью SAP HANA на Azure вместо поднятия флага высокого приоритета. Например, можно запланировать обновление программного обеспечения SAP, применяя новый пакет улучшений. Затем необходимо восстановить моментальный снимок с состоянием до обновления пакета расширений.

Прежде чем отправлять запрос, следует учесть некоторые моменты, Затем команда SAP HANA в Azure может обрабатывать запрос и предоставлять восстановленные тома. после чего вы сможете восстановить базу данных HANA на основе моментальных снимков.

Для возможности восстановления моментального снимка с помощью нового набора инструментов см. [Manual recovery guide for SAP HANA on Azure from a storage snapshot](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

Чтобы подготовиться к запросу, выполните следующие действия.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data. 

1. Завершите работу экземпляра HANA.

   ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

1. Отключите тома данных на каждом узле базы данных HANA. Если тома данных все еще подключены к операционной системе, восстановление моментального снимка завершится ошибкой.

   ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

1. Откройте запрос на поддержку Azure и включите инструкции по восстановлению конкретного снимка:

   - Во время восстановления: SAP HANA на службе Azure может попросить вас принять участие в конференции для координации, проверки и подтверждения того, что правильный снимок хранилища восстановлен. 

   - После восстановления: SAP HANA на службе Azure уведомляет вас о восстановлении моментального снимка хранилища.

1. Когда процесс восстановления завершится, подключите все тома данных.

   ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)



Еще одна возможность получения, например, файлов данных SAP HANA, извлеченных из моментального снимка хранилища, задокументирована в шаге 7 руководства [по восстановлению руководства sAP HANA на Azure из моментального снимка хранилища.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md)

Чтобы восстановить из резервного копирования моментального снимка, смотрите [руководство по восстановлению руководства для SAP HANA на Azure из моментального снимка хранилища.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md) 

>[!Note]
>Если снимок был восстановлен в сообщениях microsoft, вам не нужно делать шаг 7.


### <a name="recover-to-another-point-in-time"></a>Восстановление до другой точки во времени
Чтобы восстановить к определенному моменту времени, см. "Восстановить базу данных до следующего момента времени" в [руководстве по восстановлению руководства sAP HANA на Azure из моментального снимка хранилища.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/latest/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20Guide.md) 


## <a name="next-steps"></a>Дальнейшие действия
- Ознакомьтесь с [принципами восстановления и подготовки к стихийным бедствиям.](hana-concept-preparation.md)
