---
title: Резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Узнайте, как выполнять резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры).
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 04/22/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 7c03a7e5763f580bf1e17232a5850064710c8227
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64707264"
---
# <a name="backup-and-restore"></a>Архивация и восстановление

>[!IMPORTANT]
>Эта документация не заменяет документацию по администрированию SAP HANA или примечания SAP. Предполагается, что читатель хорошо понимает принципы администрирования и эксплуатации SAP HANA, особенно принципы резервного копирования, восстановления, обеспечения высокой доступности и аварийного восстановления. В этой документации показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Очень важно выполнять шаги и процессы в собственной среде и собственных версиях и выпусках HANA. Некоторые сведения, приведенные в этой документации, упрощены для более понятного общего представления и не предназначены для использования в качестве подробных действий для эксплуатационных справочников. Чтобы создать эксплуатационные справочники конкретной конфигурации, необходимо протестировать, выполнить и задокументировать процессы, связанные с ней. 

При работе с базами данных очень важно защитить их от различных событий, которые приводят к сбоям. Эти события могут возникать как в результате стихийных бедствий, так и из-за стандартных ошибок пользователей.

Резервное копирование базы данных с возможностью восстановления до любой точки во времени (например, перед удалением важных данных) обеспечивает восстановление базы данных до состояния, максимально приближенного к состоянию перед сбоем.

Резервные копии двух типов должны быть выполнены для достижения такой возможности для восстановления:

- резервное копирование баз данных — полные, добавочные или разностные резервные копии;
- резервное копирование журналов транзакций.

Кроме полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Эти снимки не заменяют резервные копии журналов транзакций. Резервные копии журналов транзакций по-прежнему важны при восстановлении базы данных до определенной точки во времени и очистке журналов от уже зафиксированных транзакций. Однако моментальные снимки хранилища могут ускорить восстановление, быстро предоставив образ наката для базы данных. 

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- Модель "Сделай сам". Убедившись, что имеется достаточно места, выполните полное резервное копирование базы данных и журнала с помощью одного из следующих методов резервного копирования диска. Вы можете выполнить резервное копирование напрямую на тома, подключенные к единицам крупных экземпляров HANA, или сетевые файловые ресурсы (NFS), настроенные на виртуальной машине Azure. В последнем случае клиенты настраивают виртуальную машину Linux в Azure, подключают к ней службу хранилища Azure и предоставляют общий доступ к хранилищу через настроенный NFS-сервер на этой виртуальной машине. При выполнении резервного копирования с использованием томов, подключенных непосредственно к единицам крупных экземпляров HANA, резервные копии должны быть скопированы в учетную запись хранения Azure (после того как вы настроите виртуальную машину Azure, которая экспортирует общедоступные ресурсы NFS на основе службы хранилища Azure). Кроме того, их можно скопировать в резервное хранилище Azure или в автономное неструктурированное защищенное хранилище Azure. 

   Для хранения резервных данных после их копирования в учетную запись хранения Azure можно также использовать стороннее средство защиты данных. Кроме того, может потребоваться самостоятельное решение для резервного копирования данных, которые нужно долго хранить для соблюдения нормативных требований и аудита. Во всех случаях резервные копии копируются в общедоступные ресурсы NFS, представленные с помощью виртуальной машины и службы хранилища Azure.

- Функции резервного копирования и восстановления, предоставленные инфраструктурой. Вы можете использовать функции резервного копирования и восстановления, предоставленные базовой инфраструктурой SAP HANA в Azure (крупные экземпляры). Этот вариант удовлетворяет потребность в резервном копировании и быстром восстановлении. В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA. В этом разделе также рассматривается связь резервного копирования и восстановления с возможностями аварийного восстановления, предоставляемыми крупными экземплярами HANA.

> [!NOTE]
>   Технология моментальных снимков, используемая в базовой инфраструктуре крупных экземпляров HANA, зависит от моментальных снимков SAP HANA. Сейчас моментальные снимки SAP HANA не работают в сочетании с несколькими клиентами контейнеров мультитенантных баз данных SAP HANA. Если развернут только один клиент, тогда эти снимки можно применить и этот метод можно использовать.

## <a name="using-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища томов. Поддерживается резервное копирование и восстановление тома, но следует учитывать следующее.

- Вместо полных резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- При активации создания моментальных снимков томов /hana/data и /hana/shared (включая /usr/sap) технология создания моментального снимка хранилища запускает создание моментального снимка SAP HANA, который создается перед моментальным снимком хранилища. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища. Моментальный снимок HANA было успешным вам потребуется активный экземпляр HANA.  В сценарии HSR создание моментальных снимков хранилища не поддерживается на текущем дополнительном узле, на котором невозможно создать моментальный снимок HANA.
- После успешного создания моментального снимка хранилища моментальный снимок SAP HANA удаляется.
- Резервные копии журналов транзакций создаются часто и хранятся на томе /hana/logbackups или в Azure. Вы можете активировать том /hana/logbackups, содержащий резервные копии журналов транзакций, для отдельного создания моментального снимка. В этом случае вам не нужно создавать моментальный снимок HANA.
- Если необходимо восстановить базу данных до определенной точки во времени, запросить этой поддержки Microsoft Azure (рабочий сбой) или SAP HANA в Azure восстановление до определенного моментального снимка хранилища. Например, плановое восстановление системы типа "песочница" до исходного состояния.
- Моментальный снимок SAP HANA, добавленный в моментальный снимок хранилища, используется в качестве точки смещения для применения резервных копий журнала транзакций, полученных и сохраненных после создания моментального снимка хранилища.
- Эти резервные копии журналов транзакций используются для восстановления базы данных до определенной точки во времени.

Вы можете создавать моментальные снимки хранилища, нацеленные на три класса томов.

- Объединенный моментальный снимок томов /hana/data и /hana/shared (включая /usr/sap). Для этого моментального снимка требуется создать моментальный снимок SAP HANA в качестве подготовки для моментального снимка хранилища. Благодаря моментальному снимку SAP HANA база данных будет находиться в согласованном состоянии с точки зрения хранилища, а для восстановления нужно настраивать именно этот компонент.
- Отдельный моментальный снимок тома /hana/logbackups.
- Раздел операционной системы.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). При загрузке пакета сценария моментального снимка из [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0), вы получаете три файла, один из которых является PDF документацию для функциональных возможностей. Убедитесь, что продолжить вдоль инструкции в разделе «Получение инструментов моментального снимка» при загрузке набора инструментов.

## <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Моментальные снимки хранилища используют дисковое пространство, которое было выделено для единиц крупных экземпляров HANA. Необходимо учитывать приведенные ниже аспекты с точки зрения планирования создания моментальных снимков хранилища и количества хранящихся моментальных снимков хранилища. 

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Определенный моментальный снимок хранилища (на определенный момент времени, когда он создан) занимает мало пространства в хранилище.
- На моментальном снимке должен храниться исходный набор данных и их изменения, так как данные и содержимое файлов данных в SAP HANA изменяются на томе хранилища.
- В результате размер моментального снимка хранилища увеличивается. в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. Создание моментальных снимков этих томов требует много пространства на томе. Необходимо определить, когда следует запланировать создание моментальных снимков хранилища. Необходимо также отслеживать потребление пространства томов хранилища и управлять количеством имеющихся моментальных снимков. Вы можете отключить создание моментальных снимков хранилища, если импортируются большие объемы данных, или внести другие важные изменения в базу данных HANA. 


В следующих разделах содержатся сведения о создании этих моментальных снимков, а также общие рекомендации.

- Хотя оборудование поддерживает 255 моментальных снимков на том, советуем хранить намного меньшее их количество. Рекомендуется использовать до 250 моментальных снимков.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Вы можете уменьшить количество хранящихся моментальных снимков или расширить тома. Вы можете заказать дополнительное пространство в единицах по 1 ТБ.
- При выполнении таких действий, как перенос данных в SAP HANA с помощью средств переноса платформы SAP (R3load) или восстановление баз данных SAP HANA из резервных копий, необходимо отключить создание моментальных снимков хранилища для тома /hana/data. 
- При более значительных реорганизациях таблиц SAP HANA по возможности не создавайте моментальные снимки хранилища.
- Моментальные снимки хранилища обеспечивают поддержку возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

## <a name="prerequisites-for-using-self-service-storage-snapshots"></a>Необходимые условия для использования самостоятельных моментальных снимков хранилища

Чтобы гарантировать успешное выполнение сценария моментального снимка, убедитесь, что Perl установлен в операционной системе Linux на сервере HANA (крупные экземпляры). Perl уже предварительно установлен в единице HANA (крупные экземпляры). Чтобы проверить версию Perl, используйте следующую команду:

`perl -v`

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/perl_screen.png)


## <a name="set-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

Чтобы настроить создание моментальных снимков хранилища с помощью крупных экземпляров HANA, выполните следующие действия:
1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
1. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
1. На главном узле создайте учетную запись резервного копирования SAP HANA для каждого запущенного экземпляра SAP HANA (если применимо).
1. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
1. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
1. Скопируйте сценарии и файл конфигурации из [этого расположения GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0) в расположение **hdbsql** установленного экземпляра SAP HANA.
1. Измените файл *HANABackupDetails.txt* в соответствии с определенной спецификацией клиента.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). Подробные инструкции, перечисленных выше, см. в разделе [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf)

### <a name="consideration-for-mcod-scenarios"></a>Рекомендации для сценариев MCOD
Если вы используете [сценарий MCOD](https://launchpad.support.sap.com/#/notes/1681092) с несколькими экземплярами SAP HANA в одном экземпляре HANA (крупные экземпляры), для каждого экземпляра SAP HANA подготавливается отдельный том хранения. Дополнительные сведения о MDC и другие вопросы, проверьте [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf) глава **«Важное»**.
 

### <a name="step-1-install-the-sap-hana-hdb-client"></a>Шаг 1. Установка клиента SAP HANA HDB

Операционная система Linux, установленная в решении "SAP HANA в Azure (крупные экземпляры)", содержит папки и сценарии, необходимые для создания моментальных снимков хранилища SAP HANA, используемых для резервного копирования и восстановления. Проверьте наличие последних выпусков на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). Самой последней версией выпуска сценариев является 4.0. В рамках основного номера версии различные сценарии могут иметь разные вспомогательные версии.

Во время установки SAP HANA вы должны самостоятельно установить клиент SAP HANA HDB для единиц крупных экземпляров HANA.

### <a name="step-2-change-the-etcsshsshconfig"></a>Шаг 2. Изменение конфигурации /etc/ssh/ssh\_config

Этот шаг описан подробно Проверьте наличие последних выпусков в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf) в главе **«Включить связь с хранилищем»**


### <a name="step-3-create-a-public-key"></a>Шаг 3. Создание открытого ключа

Чтобы обеспечить доступ к интерфейсам моментальных снимков хранилища клиента крупных экземпляров HANA, необходимо настроить вход с помощью открытого ключа. На первом сервере решения "SAP HANA в Azure (крупные экземпляры)" в своем клиенте создайте открытый ключ, с помощью которого будет осуществляться доступ к инфраструктуре хранилища. Этот ключ позволит входить в интерфейсы моментальных снимков хранилища без пароля, что устраняет необходимость в хранении учетных данных с паролями. Точные действия как создать открытый ключ описан в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf) в главе **«Включить связь с хранилищем»**


### <a name="step-4-create-an-sap-hana-user-account"></a>Шаг 4. Создание учетной записи пользователя SAP HANA

Чтобы инициировать создание моментальных снимков SAP HANA, необходимо создать учетную запись пользователя в SAP HANA, которую могут использовать сценарии создания моментальных снимков хранилища. Для этих целей создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Пользователя нужно создать в SYSTEMDB, а не с использованием идентификатора безопасности в базе данных для MDC. В среде одного контейнера пользователь создается в базе данных клиента. У этой учетной записи должны быть такие привилегии: **Backup Admin** (Администратор резервного копирования) и **Catalog Read** (Чтение каталогов). Конкретные шаги для настройки пользователя и с помощью пользователя. в статье [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0) в главе **«Включить связь с SAP HANA»**


### <a name="step-5-authorize-the-sap-hana-user-account"></a>Шаг 5. Авторизация учетной записи пользователя SAP HANA

На этом шаге необходимо авторизовать созданную учетную запись пользователя SAP HANA, чтобы сценариям не приходилось отправлять пароли во время выполнения. Команда SAP HANA `hdbuserstore` позволяет создать ключ пользователя SAP HANA, который хранится на одном или нескольких узлах SAP HANA, и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания сценария не нужно заботиться об управлении паролями). Этот процесс написания сценариев описывается далее.

>[!IMPORTANT]
>Выполните следующие команды для конфигурации с помощью того же контекста пользователя, выполнения команд создания моментального снимка в. В противном случае команд создания моментального снимка не может работать неправильно.


### <a name="step-6-get-the-snapshot-scripts-configure-the-snapshots-and-test-the-configuration-and-connectivity"></a>Шаг 6. Получение сценариев создания моментальных снимков, настройка моментальных снимков, тестирование конфигурации и возможностей подключения

Скачайте последнюю версию сценариев на [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). Способ скрипты будут устанавливаться majorly изменилось с версии 4.0 скриптов. Точные сведения в статье [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf) в главе **«Включить связь с SAP HANA»**

Точная последовательность команд, подробное **«Простая установка средств моментального снимка (по умолчанию)»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). Корпорация Майкрософт рекомендует использование установки по умолчанию. Если вы хотите обновить с версии 3.x в 4.0, обратитесь к разделу **«Обновление существующей установки»** из [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). Для удаления набора инструментов версии 4.0, следуйте инструкциям в **«Удаление моментальных снимков средств»** в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Не забудьте выполнить действия, описанные в **«Завершить установку средств моментального снимка»** из [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Назначение различных сценариев и файлов они получили установлены указан и подробно **«Каковы эти средства моментального снимка?»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Прежде чем настраивать средства моментального снимка, убедитесь, что также правильность расположения резервной копии HANA и параметров, описанных в **«Конфигурация SAP HANA»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Конфигурации набора инструментов моментального снимка описан подробно **«Файл Config - HANABackupCustomerDetails.txt»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

#### <a name="testing-connectivity-with-sap-hana"></a>Тестирование возможности подключения с помощью SAP HANA

Поместив все данные конфигурации в файл *HANABackupCustomerDetails.txt*, проверьте правильность конфигурации в отношении данных экземпляра HANA. Используйте сценарий `testHANAConnection`, который не зависит от конфигурации развертывания или масштабирования SAP HANA.

Дополнительные сведения см. **«Проверить возможность подключения к SAP HANA - testHANAConnection»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf)

#### <a name="testing-storage-connectivity"></a>Тестирование возможности подключения хранилища

Следующий шаг теста — проверка подключения к хранилищу на основе данных, помещенных в файл конфигурации *HANABackupCustomerDetails.txt*, и создание тестового моментального снимка. Перед выполнением `azure_hana_backup` команды, этот тест необходимо выполнить. Последовательность команд для этого теста отображается в **«Проверить связь с хранилищем - testStorageSnapshotConnection»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

После успешного входа в интерфейсы виртуальной машины хранилища этот сценарий перейдет к этапу 2 и создаст тестовый моментальный снимок. Ниже показаны выходные данные для конфигурации масштабирования трех узлов SAP HANA:

Если тестовый моментальный снимок еще выполнена успешно, с помощью скрипта, можно перейти к планирования действительных моментальных снимков хранилища. Если же нет, сначала необходимо устранить проблемы, а затем продолжить. Тестовый моментальный снимок следует хранить, пока не будут созданы первые настоящие моментальные снимки.


### <a name="step-7-perform-snapshots"></a>Шаг 7. Создание моментальных снимков

По завершении этапов подготовки можно сначала настроить и запланировать действительных моментальных снимков хранилища. Сценарий, выполнение которого следует запланировать, работает с конфигурациями увеличения масштаба и развертывания SAP HANA. Для периодического и регулярного выполнения сценария резервного копирования запланируйте его с помощью служебной программы Cron. 

Точный синтаксис команды и функции, в статье **«Выполнение резервного копирования моментальных снимков - azure_hana_backup»** документа [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).  

Создание моментальных снимков с помощью сценария `azure_hana_backup` состоит из следующих трех этапов:

1. создание моментального снимка SAP HANA;
1. создание моментального снимка хранилища;
1. удаление моментального снимка SAP HANA, созданного перед моментальным снимком хранилища.

Чтобы выполнить сценарий, вызовите его из выполняемой папки HDB, в которую он скопирован. 

Срок хранения регулируется количеством моментальных снимков. Это значение задается как параметр во время выполнения сценария. Поэтому срок хранения моментальных снимков хранилища — это функция периода выполнения и количества моментальных снимков, переданного в качестве параметра при выполнении сценария. Если число моментальных снимков превышает значение, заданное с помощью параметра при выполнении сценария, то перед созданием следующего моментального снимка удаляется самый старый моментальный снимок такой же меткой. Количество хранимых моментальных снимков можно задать в последнем параметре вызова. С его помощью можно также косвенно управлять дисковым пространством, используемым для моментальных снимков. 


## <a name="snapshot-strategies"></a>Стратегии моментальных снимков
Частота создания моментальных снимков для различных типов зависит от того, используются ли функции аварийного восстановления крупного экземпляра HANA. Эти функциональные возможности полагаются на моментальные снимки хранилища, в случае с которыми могут потребоваться некоторые специальные рекомендации с точки зрения частоты и продолжительности их создания. 

В приведенных ниже рекомендациях предполагается, что вы *не* используете функции аварийного восстановления, которые предлагают крупные экземпляры HANA. Предполагается, что вместо этого вы используете моментальные снимки хранилища в качестве средства резервного копирования и имеете возможность выполнить восстановление на определенный момент времени за последние 30 дней. Учитывая ограничения количества моментальных снимков и дискового пространства, клиенты учли следующие типы требований:

- время восстановления до восстановления на определенный момент времени;
- используемое пространство;
- требования к целевой точке восстановления и целевому времени восстановления в случае возможного аварийного восстановления.
- последующее выполнение полного резервного копирования базы данных HANA на диски (при выполнении полного резервного копирования базы данных на диски (или в интерфейс **backint**) создание моментальных снимков хранилища завершается сбоем; если вы хотите выполнить полное резервное копирование базы данных на основе моментальных снимков хранилища, отключите на это время создание этих моментальных снимков);
- количество моментальных снимков на том (не может превышать 250).

<!-- backint is term for a SAP HANA interface and not a spelling error not spelling errors -->

Для клиентов, которые не используют функции аварийного восстановления крупных экземпляров HANA, частота создания моментальных снимков ниже. В таких случаях клиенты создают объединенные моментальные снимки томов /hana/data и /hana/shared (включая /usr/sap) за 12- или 24-часовой период и сохраняют эти моментальные снимки, чтобы охватить весь месяц. То же самое относится к моментальным снимкам тома резервных копий журналов. Однако выполнение резервные копии журналов транзакций SAP HANA томе резервных копий журналов выполняется за 5 – 15 минут.

Плановое создание моментальных снимков хранилища лучше всего выполнять с помощью средства Cron. Используйте один сценарий для резервного копирования и аварийного восстановления. Измените входные данные сценария в соответствии со временем резервного копирования. Создание этих моментальных снимков планируется на разное время в Cron, в зависимости от параметров времени выполнения: каждый час, каждые 12 часов, каждый день или каждую неделю. 

Ниже приведен пример расписания cron в /etc/crontab.
```
00 1-23 * * * ./azure_hana_backup --type=hana --prefix=hourlyhana --frequency=15min --retention=46
10 00 * * *  ./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
00,05,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
22 12 * * *  ./azure_hana_backup --type=logs --prefix=dailylogback --frequncy=3min --retention=28
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeI --prefix=dailyboot --frequncy=15min --retention=28
```
В предыдущем примере имеется Ежечасный объединенный моментальный снимок, который охватывает тома, содержащие/hana/data и /hana/shared/SID (включая/usr/sap) расположений. Моментальный снимок этого типа ускоряет восстановление на определенный момент времени в пределах двух дней. Кроме того, предусмотрено создание ежедневного моментального снимка этих томов. Таким образом, вы охватили два дня ежечасными моментальными снимками и четыре недели — ежедневными моментальными снимками. Кроме того, ежедневно создается резервная копия тома резервных копий журналов транзакций. Эти резервные копии также хранятся четыре недели. Как видно в третьей строке crontab, резервное копирование журнала транзакций HANA запланировано с интервалом в 5 минут. Время запуска различных заданий Cron, которые создают моментальные снимки хранилища, заданы поочередно таким образом, чтобы эти моментальные снимки никогда не создавались одновременно. 

В следующем примере выполняются создается объединенный моментальный снимок, который охватывает тома, содержащие/hana/data и /hana/shared/SID (включая/usr/sap) расположений на почасовой основе. Они хранятся в течение двух дней. Моментальные снимки томов резервных копий журналов транзакций создаются каждые пять минут и хранятся в течение 4 часов. Как и прежде, создание резервной копии файла журнала транзакций HANA запланировано с интервалом в 5 минут. Моментальный снимок тома резервных копий журналов транзакций создается с задержкой в 2 минуты после начала резервного копирования журнала транзакций. В течение этих 2 минут в обычных условиях резервное копирование журнала транзакций SAP HANA завершается. Как и ранее, резервное копирование тома, содержащего загрузочный логический номер устройства, выполняется один раз в день: создается моментальный снимок хранилища, который хранится приблизительно четыре недели.

```
10 0-23 * * * ./azure_hana_backup --type=hana ==prefix=hourlyhana --frequency=15min --retention=48
0,5,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
2,7,12,17,22,27,32,37,42,47,52,57 * * * *  ./azure_hana_backup --type=logs --prefix=logback --frequency=3min --retention=48
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeII --prefix=dailyboot --frequency=15min --retention=28
```

На следующем рисунке показаны последовательности предыдущего примера, за исключением загрузочного логического номера устройства:

![Связь между резервными копиями и моментальными снимками](./media/hana-overview-high-availability-disaster-recovery/backup_snapshot_updated0921.PNG)

SAP HANA регулярно записывает данные на том /hana/log, чтобы регистрировать зафиксированные изменения в базе данных. SAP HANA регулярно записывает точку сохранения на том /hana/data. Как указано в crontab, резервная копия журналов транзакций SAP HANA создается каждые 5 минут. Вы также увидите, что из моментального снимка SAP HANA выполняется каждый час в результате активации моментального снимка объединенного хранилища для тома/hana/Data и /hana/shared/SID. После успешного создания моментального снимка HANA создается объединенный моментальный снимок хранилища. Как указано в crontab, каждые 5 минут, примерно через 2 минуты после резервного копирования журналов транзакций HANA, создается моментальный снимок хранилища тома /hana/logbackup.

> 

>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища имеет смысл, только если моментальные снимки создаются совместно с резервными копиями журналов транзакций SAP HANA. Эти резервные копии журналов транзакций должны охватывать временные периоды между моментальными снимками хранилища. 

Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- В исключительных случаях получить доступ к объединенному моментальному снимку/Data и /hana/shared/SID, 30 дней хранилища.
- Связанные резервные копии журналов транзакций, охватывающие время между всеми объединенными моментальными снимками хранилища. Поэтому наиболее старому моментальному снимку тома резервных копий журналов транзакций должно быть 30 дней. Если только к тому времени вы не скопировали резервные копии журналов транзакций на другой общедоступный ресурс NFS, расположенный в службе хранилища Azure. В этом случае можно получить старые резервные копии журналов транзакций из этого общедоступного ресурса NFS.

Чтобы иметь возможность использовать моментальные снимки хранилища и итоговую репликацию резервных копий журналов транзакций, необходимо изменить расположение, в которое SAP HANA записывает резервные копии журналов транзакций. Это можно сделать в HANA Studio. Хотя SAP HANA автоматически выполняет резервное копирование сегментов полного журнала, следует указать детерминированный интервал создания резервной копии журнала. Особенно это нужно при использовании аварийного восстановления, поскольку тогда, как правило, требуется создавать резервные копии журналов с детерминированным периодом. В случае, представленном ниже, указан интервал резервного копирования журналов, равный 15 минутам.

![Настройка расписания для создания резервных копий журналов SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Вы можете выполнять резервные копии намного чаще, чем каждые 15 минут. Такое более частое значение используется в сочетании с функциональной возможностью аварийного восстановления HANA (крупные экземпляры). Некоторые клиенты создают резервные копии журналов транзакций каждые 5 минут.  

Если резервная копия базы данных еще не создавалась, то последний этап заключается в создании ее файловой резервной копии. Это позволит создать одну запись резервной копии, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не может инициировать резервное копирование журнала.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)


После выполнения первых успешно моментальных снимков, необходимо удалить тестовый моментальный снимок, созданный на шаге 6. Чтение **«Удаление тестового моментальных снимков - removeTestStorageSnapshot»** в документе [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf) подробные сведения. 


### <a name="monitoring-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Мониторинг количества и размера моментальных снимков на томе диска

Количество моментальных снимков и занимаемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Тем не менее команда ОС Linux `du` демонстрирует сведения об этих моментальных снимках хранилища, так как они хранятся на одних и тех же томах. Для этой команды можно указать следующие параметры.

- `du –sh .snapshot`: Этот параметр возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1`: Этот параметр выводит список всех моментальных снимков, сохраненных в папке **.snapshot**, и размер каждого моментального снимка.
- `du –hc`: Этот параметр возвращает общий размер всех моментальных снимков.

Следующие команды предоставляют сведения о создании и хранении моментальных снимков, а также об используемом ими пространстве на томах.

>[!NOTE]
>Приведенные выше команды не отображают моментальные снимки загрузочного логического номера устройства.

### <a name="getting-details-of-snapshots"></a>Получение сведений о моментальных снимках
Чтобы получить дополнительные сведения о моментальных снимках, можно также использовать сценарий `azure_hana_snapshot_details`. Этот сценарий можно выполнять в любом расположении, если в расположении аварийного восстановления имеется активный сервер. Этот сценарий предоставляет следующие выходные данные с разбивкой по томам, содержащим моментальные снимки: 
   * общий размер моментальных снимков на томе;
   * Для каждого снимка на этом томе указываются следующие сведения: 
      - имя моментального снимка; 
      - время создания снимка; 
      - размер снимка;
      - частота создания снимка;
      - идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).

Синтаксис команды и выходные данные проверки **«Список моментальных снимков - azure_hana_snapshot_details»** в документе [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). 



### <a name="reducing-the-number-of-snapshots-on-a-server"></a>Уменьшение количества моментальных снимков на сервере

Как упоминалось ранее, количество моментальных снимков, создаваемых с определенным интервалом, можно уменьшить. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
```

В примере выше для моментальных снимков задана метка **dailyhana**, а количество моментальных снимков, которые должны храниться с этой меткой, равно **28**. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. Вы можете легко сократить количество моментальных снимков, например до 15, с помощью сценария ниже, указав для последнего параметра значение **15**:

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=15
```

Выполнение этого сценария позволяет уменьшить количество моментальных снимков с учетом нового моментального снимка хранилища до 15. Останутся 15 последних моментальных снимков, тогда как 15 более старых моментальных снимков будут удалены.

 >[!NOTE]
 > Этот сценарий уменьшает количество моментальных снимков, только если имеются моментальные снимки, созданные более часа назад. Он не удаляет моментальные снимки, созданные менее часа назад. Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если вы больше не хотите хранить набор моментальных снимков с помощью резервного копирования префикс **dailyhana** в примерах синтаксиса, можно выполнить сценарий, задав **0** периода удержания значение. Это позволяет удалить все моментальные снимки, соответствующие этой метке. Тем не менее удаление всех моментальных снимков может повлиять на функцию аварийного восстановления HANA (крупные экземпляры).

Второй способ удалить определенные моментальные снимки — сценарий `azure_hana_snapshot_delete`. Этот сценарий позволяет удалять моментальные снимки или их набор с помощью идентификатора резервного копирования HANA, указанного в HANA Studio, или имени моментального снимка. В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам типа **hana**. При резервном копировании моментальных снимков типа **logs** и **boot** моментальный снимок SAP HANA не создается. Поэтому идентификатор резервного копирования этих моментальных снимков отсутствует. Если введено имя моментального снимка, то на разных томах будет выполнен поиск всех моментальных снимков, соответствующих этому имени. 

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->

Сведения о скрипте см. в статье **«Удалить моментальный снимок - azure_hana_snapshot_delete»** в документе [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Выполните этот сценарий от имени **привилегированного** пользователя.

>[!IMPORTANT]
>Если в удаляемом моментальном снимке хранятся данные, которые больше нигде не существуют, то удаление приведет к безвозвратной потере этих данных.

  
## <a name="file-level-restore-from-a-storage-snapshot"></a>Восстановление уровня файла из моментального снимка хранилища

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->
Моментальные снимки типов **hana** и **logs** дают возможность обращаться непосредственно к моментальным снимкам на томах в каталоге **.snapshot**. Это подкаталог для каждого моментального снимка. Вы можете скопировать каждый файл, находящийся в состоянии на момент создания снимка, из этого подкаталога в действительную структуру каталогов. В текущую версию сценария **нет** восстановить сценарий, предоставленный для восстановления моментального снимка как самообслуживания (хотя восстановление моментального снимка может выполняться как часть процесса аварийного восстановления самообслуживания скриптов на сайте аварийного восстановления во время отработки отказа). Необходимо обратиться к рабочей группе Майкрософт, открыв запрос на обслуживание для восстановления требуемого моментального снимка с помощью доступных моментальных снимков.

>[!NOTE]
>Восстановление отдельных файлов не поддерживается для моментальных снимков загрузочного логического номера устройства, независимо от типа экземпляров HANA (крупные экземпляры). Каталог **.snapshot** не представляется в загрузочном логическом номере устройства. 
 

## <a name="recover-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В случае сбоя рабочей системы, обратившись в службу поддержки Microsoft Azure, вы можете инициировать процесс восстановления из моментального снимка хранилища в качестве инцидента клиента. Подобный непредвиденный сценарий требует срочного реагирования, если данные были удалены из рабочей системы, и единственный способ быстро вернуть их — восстановить рабочую базу данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться на несколько дней вперед. Можно спланировать восстановление SAP HANA в Azure, не поднимая флаг высоким приоритетом. Например, вы могли бы спланировать обновление программного обеспечения SAP, применив новую версию пакета расширений. Затем необходимо восстановить моментальный снимок с состоянием до обновления пакета расширений.

Прежде чем отправлять запрос, следует учесть некоторые моменты, Группа SAP HANA в Azure можно обрабатывать запрос и предоставить восстановленные тома. после чего вы сможете восстановить базу данных HANA на основе моментальных снимков.

В разделе описаны возможности, чтобы получить моментальный снимок восстанавливается с новым набором средств **«Как восстановить моментальный снимок»** документа [ручного восстановления руководство для SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf).

Ниже приведены действия по подготовке к запросу.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data. 

1. Завершите работу экземпляра HANA.

   ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

1. Отключите тома данных на каждом узле базы данных HANA. Если тома данных все еще подключены к операционной системе, восстановление моментального снимка завершится ошибкой.
   ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

1. Отправьте запрос в службу поддержки Azure и предоставьте указания по восстановлению определенного моментального снимка.

   - Во время восстановления: SAP HANA в Azure может попросить вас к конференции, для координации, проверки и подтверждения, что восстановления правильного моментального снимка хранилища. 

   - После восстановления: SAP HANA в службе Azure оповещает вас о восстановления моментального снимка хранилища.

1. Когда процесс восстановления завершится, подключите все тома данных.

   ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)



Другой вариант для получения, например, файлы данных SAP HANA, восстановить из моментального снимка хранилища описан на шаге 7 документа [ручного восстановления руководство для SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf).

Документ [ручного восстановления руководство для SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf) показана последовательность восстановления из резервной копии моментального снимка. Использование этой документации для выполнения восстановления. 

>[!Note]
>Шаг 7 необязателен для выполнения, если полученный моментальный снимок восстановлен с помощью Microsoft operations.


### <a name="recover-to-another-point-in-time"></a>Восстановление до другой точки во времени
Документ [ручного восстановления руководство для SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf) показана последовательность восстановления до определенной точки во времени в разделе **«Восстановить базу данных до следующей точки во времени»**. Использование этой документации для выполнения восстановления на определенный момент времени. 


## <a name="next-steps"></a>Дальнейшие действия
- См. в разделе [принципы аварийного восстановления и подготовки](hana-concept-preparation.md).
