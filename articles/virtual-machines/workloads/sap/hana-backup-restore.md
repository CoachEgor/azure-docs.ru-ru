---
title: Резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Узнайте, как выполнять резервное копирование и восстановление HANA на сервере SAP HANA в Azure (крупные экземпляры).
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: gwallace
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 04/22/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 4e64c243e38c43c5eb543c3e2ec96d7cf8413cb9
ms.sourcegitcommit: c105ccb7cfae6ee87f50f099a1c035623a2e239b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67709776"
---
# <a name="backup-and-restore"></a>Резервное копирование и восстановление

>[!IMPORTANT]
>В этой статье не заменяет документацию по администрированию SAP HANA или примечания к SAP. Мы ожидаем, что имеется глубокие знания и опыт администрирования и эксплуатации, особенно для резервного копирования, восстановления, высокой доступности и аварийное восстановление SAP HANA. В этой статье показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Очень важно выполнять шаги и процессы в собственной среде и собственных версиях и выпусках HANA. Некоторые процессы, описанные в этой статье, упрощены для более понятного общего. Они не предназначены для использования в качестве подробное описание действий для эксплуатационных справочников. Если вы хотите создать эксплуатационных справочников для конфигураций, протестировать выполнить и задокументировать процессы, связанные с конкретной. 

Одним из самых важных аспектов работе с базами данных является для защиты от катастрофических событий. Эти события могут возникать как в результате стихийных бедствий, так и из-за стандартных ошибок пользователей.

Резервное копирование базы данных, с возможностью восстановления до любой точки во времени, например, прежде чем кто-то удаленные критически важными данными, обеспечивает восстановление в состояние, как закройте максимально так, как они были до прерывания работы службы.

Резервные копии двух типов необходимо выполнить, чтобы обеспечить возможность восстановления:

- резервное копирование баз данных — полные, добавочные или разностные резервные копии;
- резервное копирование журналов транзакций.

Кроме полного резервного копирования базы данных на уровне приложений, вы также можете выполнить резервное копирование на основе моментальных снимков хранилища. Эти снимки не заменяют резервные копии журналов транзакций. Резервные копии журналов транзакций по-прежнему важны при восстановлении базы данных до определенной точки во времени и очистке журналов от уже зафиксированных транзакций. Моментальные снимки хранилища могут ускорить восстановление, быстро предоставив образ наката для базы данных. 

SAP HANA в Azure (крупные экземпляры) поддерживает следующие два варианта резервного копирования и восстановления.

- **Сделать это самостоятельно (с НУЛЯ).** После вы убедитесь, что имеется достаточно места, выполните всей базы данных и резервные копии журналов с помощью одного из следующих методов резервного копирования диска. Можно выполнять архивацию напрямую на тома, подключенные к единицам крупных экземпляров HANA, или для общих ресурсов NFS, которые были настроены в Azure виртуальной машины (VM). В последнем случае клиенты настраивают виртуальную машину Linux в Azure, подключают к ней службу хранилища Azure и предоставляют общий доступ к хранилищу через настроенный NFS-сервер на этой виртуальной машине. Если вы выполняете резервное копирование с использованием томов, подключенных непосредственно к единицам крупных экземпляров HANA, резервные копии на учетную запись хранилища Azure. Для этого после настройки виртуальной Машины Azure, которая экспортирует общедоступные ресурсы NFS, которые созданы на основе хранилища Azure. Можно также использовать Azure "холодное" хранилище или хранилище службы архивации Azure. 

   Другой вариант — использовать средство защиты сторонних производителей данных для хранения резервных данных после они будут скопированы в учетную запись хранилища Azure. DIY параметра резервного копирования также может потребоваться для данных, которые необходимо хранить в течение более длительного времени для соответствия и аудита. Во всех случаях резервные копии копируются в общедоступные ресурсы NFS, представленные с помощью виртуальной машины и службы хранилища Azure.

- **Инфраструктура архивации и восстановления.** Также можно использовать резервную копию и восстановить функциональные возможности, предоставленные базовой инфраструктурой SAP hana в Azure (крупные экземпляры). Этот вариант удовлетворяет потребность в резервном копировании и быстром восстановлении. В остальной части этого раздела описываются функции резервного копирования и восстановления, предоставляемые крупными экземплярами HANA. В этом разделе также рассматриваются связи, резервного копирования и восстановления для аварийного восстановления, предоставляемыми крупными экземплярами HANA.

> [!NOTE]
>   Технология моментальных снимков, который используется в базовой инфраструктуре крупных экземпляров HANA имеет зависимость от моментальных снимков SAP HANA. На этом этапе моментальные снимки SAP HANA не работают в сочетании с несколькими клиентами контейнеров мультитенантных баз данных SAP HANA. Если только один клиент будет развернут, ТОГДА эти снимки будут работать, и этот метод можно использовать.

## <a name="use-storage-snapshots-of-sap-hana-on-azure-large-instances"></a>Использование моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры)

Базовая инфраструктура хранилища SAP HANA в Azure (крупные экземпляры) поддерживает концепцию моментальных снимков хранилища томов. Поддерживается резервное копирование и восстановление тома, но следует учитывать следующее.

- Вместо полных резервных копий базы данных на регулярной основе создаются моментальные снимки тома хранилища.
- Моментальный снимок активируется через/hana/Data и/hana/Shared, включая/usr/SAP, тома, технология моментальных снимков инициирует SAP HANA, моментальный снимок перед запускается моментального снимка хранилища. Этот моментальный снимок SAP HANA является точкой настройки для восстановления журнала после восстановления моментального снимка хранилища. Для успешного выполнения моментального снимка HANA вам потребуется активный экземпляр HANA. В сценарии HSR моментальный снимок хранилища не поддерживается на текущей вторичном узле, когда не удается выполнить из моментального снимка HANA.
- После успешного выполнения моментального снимка хранилища моментальный снимок SAP HANA удаляется.
- Резервные копии журналов транзакций создаются часто и хранятся на томе /hana/logbackups или в Azure. Вы можете активировать том /hana/logbackups, содержащий резервные копии журналов транзакций, для отдельного создания моментального снимка. В этом случае не требуется для запуска из моментального снимка HANA.
- Если необходимо восстановить базу данных до определенной точки во времени, рабочий сбой, запрос, поддержки Microsoft Azure или SAP HANA в Azure восстановление до определенного моментального снимка хранилища. Например, плановое восстановление системы типа "песочница" до исходного состояния.
- Моментальный снимок SAP HANA, включенный в моментальный снимок хранилища находится в качестве точки смещения для применения резервных копий журналов транзакций, которые были выполнены и сохраненных после создания хранилища моментального снимка.
- Эти резервные копии журналов транзакций используются для восстановления базы данных до определенной точки во времени.

Вы можете выполнять моментальные снимки хранилища, предназначенных для три класса томов.

- Объединенный моментальный снимок томов/hana/data и/hana/shared, включая/usr/SAP. Для этого моментального снимка требуется создать моментальный снимок SAP HANA в качестве подготовки для моментального снимка хранилища. Моментальный снимок SAP HANA гарантирует, что база данных находится в согласованном состоянии с точки зрения хранилища. В процессе восстановления, который является точкой устанавливается в.
- Отдельный моментальный снимок тома /hana/logbackups.
- Раздел операционной системы.

Чтобы получить последние сценариев создания моментальных снимков и документации, см. в разделе [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). При загрузке пакета сценария моментального снимка из [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0), вы получаете три файла. Один из файлов описана в PDF-ФАЙЛ для функциональных возможностей. После загрузки набор средств, следуйте инструкциям в «получить средства моментальный снимок».

## <a name="storage-snapshot-considerations"></a>Факторы, которые необходимо учитывать при создании моментальных снимков хранилища

>[!NOTE]
>Моментальные снимки хранилища используют дисковое пространство, которое будет выделено для единиц крупных экземпляров HANA. Рассмотрим следующие аспекты планирования моментальных снимков хранилища и количества хранящихся моментальных снимков хранилища. 

Принцип действия моментальных снимков хранилища SAP HANA в Azure (крупные экземпляры) включает в себя следующие аспекты:

- Моментальный снимок хранилища, в момент времени, когда он берется использует мало пространства в хранилище.
- Как данные и содержимое в файлы изменяются на томе хранилища данных SAP HANA моментальном снимке должен храниться исходный и изменения данных.
- В результате размер моментального снимка хранилища увеличивается. в зависимости от срока его хранения.
- Чем больше изменений внесено на томе базы данных SAP HANA в течение жизненного цикла моментального снимка хранилища, тем больше места он занимает.

SAP HANA в Azure (крупные экземпляры) поставляется с фиксированными размерами томов для данных и журнального тома SAP HANA. Создание моментальных снимков этих томов требует много пространства на томе. Для этого необходимо:

- Определите, когда нужно запланировать создание моментальных снимков хранилища.
- Отслеживание потребления пространства томов хранилища. 
- Управление количество моментальных снимков, которые хранятся. 

Вы можете отключить создание моментальных снимков хранилища, если импортируются большие объемы данных, или внести другие важные изменения в базу данных HANA. 


В следующих разделах содержатся сведения о создании этих моментальных снимков и включают общие рекомендации:

- Несмотря на то, что оборудование может выдержать 255 моментальных снимков на том, требуется намного меньшее этого числа. Рекомендуется 250 или меньше.
- Прежде чем выполнять моментальные снимки хранилища, отслеживайте свободное пространство.
- В зависимости от свободного пространства количество моментальных снимков хранилища можно уменьшить. Вы можете уменьшить количество хранящихся моментальных снимков или расширить тома. Вы можете заказать дополнительное пространство в единицах по 1 ТБ.
- При выполнении таких действий, как перенос данных в SAP HANA с помощью средств переноса платформы SAP (R3load) или восстановление баз данных SAP HANA из резервных копий, необходимо отключить создание моментальных снимков хранилища для тома /hana/data. 
- Во время преобразования большего размера доменов таблиц SAP HANA по возможности избегайте моментальных снимков хранилища.
- Моментальные снимки хранилища обеспечивают поддержку возможностей аварийного восстановления SAP HANA в Azure (крупные экземпляры).

## <a name="prerequisites-for-using-self-service-storage-snapshots"></a>Необходимые условия для использования самостоятельных моментальных снимков хранилища

Чтобы убедиться в том, что скрипт создания моментальных снимков выполняется успешно, убедитесь, что Perl установлен в операционной системе Linux на сервере крупных экземпляров HANA. Perl предустановлен на единице крупного экземпляра HANA. Чтобы проверить версию Perl, используйте следующую команду:

`perl -v`

![Команда для копирования открытого ключа](./media/hana-overview-high-availability-disaster-recovery/perl_screen.png)


## <a name="set-up-storage-snapshots"></a>Настройка моментальных снимков хранилища

Чтобы настроить моментальных снимков хранилища с помощью крупных экземпляров HANA, выполните следующие действия.
1. Установите Perl в операционной системе Linux на сервере решения "Крупные экземпляры HANA".
1. Добавьте в файл /etc/ssh/ssh\_config строку _MACs hmac-sha1_.
1. Создайте учетную запись резервного копирования SAP HANA на главном узле для каждого экземпляра SAP HANA при запуске, если применимо.
1. Установите на всех серверах решения "Крупные экземпляры SAP HANA" клиент SAP HANA HDB.
1. На первом сервере решения "Крупные экземпляры SAP HANA" каждого региона создайте открытый ключ, используемый для доступа к базовой инфраструктуре хранилища, отвечающей за создание моментальных снимков.
1. Скопируйте сценарии и файл конфигурации из [этого расположения GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0) в расположение **hdbsql** установленного экземпляра SAP HANA.
1. Измените файл *HANABackupDetails.txt* в соответствии с определенной спецификацией клиента.

Последние сценарии создания моментальных снимков и документацию доступны на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). Действия, описанные ранее, см. в разделе [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

### <a name="consideration-for-mcod-scenarios"></a>Рекомендации для сценариев MCOD
При запуске [сценарий MCOD](https://launchpad.support.sap.com/#/notes/1681092) с несколькими экземплярами SAP HANA на единице крупного экземпляра HANA, у вас есть для каждого из экземпляров SAP HANA подготавливается отдельный том хранения. Дополнительные сведения о MDC и другие вопросы, см. в разделе «Важное» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).
 

### <a name="step-1-install-the-sap-hana-hdb-client"></a>Шаг 1. Установка клиента SAP HANA HDB

Операционная система Linux установлен на SAP HANA в Azure (крупные экземпляры) содержит папки и сценарии, необходимые для выполнения моментальных снимков хранилища SAP HANA для резервного копирования и аварийного восстановления. Проверьте наличие последних выпусков на сайте [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). Самой последней версией выпуска сценариев является 4.0. В рамках основного номера версии различные сценарии могут иметь разные вспомогательные версии.

Это самостоятельно установить клиент SAP HANA HDB для единиц крупных экземпляров HANA, во время установки SAP HANA.

### <a name="step-2-change-the-etcsshsshconfig"></a>Шаг 2. Изменение конфигурации /etc/ssh/ssh\_config

Этот шаг описан в «Включить связь с хранилищем» [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).


### <a name="step-3-create-a-public-key"></a>Шаг 3. Создание открытого ключа

Чтобы включить доступ к интерфейсам моментальных снимков хранилища клиента крупных экземпляров HANA, настроить процедуру входа в систему с помощью открытого ключа. 

На первом сервера SAP HANA в Azure (крупные экземпляры) в клиенте создайте открытый ключ для доступа к инфраструктуре хранилища. Открытый ключ пароль не обязательно должна входить интерфейсы моментальных снимков хранилища. Также не нужно хранить учетные данные пароля с помощью открытого ключа. 

Чтобы создать открытый ключ, см. в разделе «Включить связь с хранилищем» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).


### <a name="step-4-create-an-sap-hana-user-account"></a>Шаг 4. Создание учетной записи пользователя SAP HANA

Чтобы приступить к созданию моментальных снимков SAP HANA, создайте учетную запись пользователя в SAP HANA, можно использовать скрипты моментального снимка хранилища. Для этих целей создайте в SAP HANA Studio учетную запись пользователя SAP HANA. Пользователю необходимо создать в SYSTEMDB и *не* в базе данных SID для MDC. В среде одного контейнера пользователь создается в базе данных клиента. Эта учетная запись должна иметь **администратора резервного копирования** и **чтения каталога** привилегии. 

Чтобы настроить и использовать учетную запись пользователя, см. в разделе «Включить связь с SAP HANA» в [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0).


### <a name="step-5-authorize-the-sap-hana-user-account"></a>Шаг 5. Авторизация учетной записи пользователя SAP HANA

На этом шаге вы авторизуете учетной записи пользователя SAP HANA, созданный таким образом, чтобы сценариям не приходилось отправлять пароли во время выполнения. Команда SAP HANA `hdbuserstore` позволяет создавать ключ пользователя SAP HANA. Ключ хранится на одной или нескольких узлах SAP HANA. и предоставляет пользователю доступ к SAP HANA (при этом в процессе написания сценария не нужно заботиться об управлении паролями). Этот процесс написания сценариев описывается далее.

>[!IMPORTANT]
>Выполните следующие команды для конфигурации с помощью того же контекста пользователя, выполнения команд создания моментального снимка в. В противном случае не будет правильно работать команд создания моментального снимка.


### <a name="step-6-get-the-snapshot-scripts-configure-the-snapshots-and-test-the-configuration-and-connectivity"></a>Шаг 6. Получение сценариев создания моментальных снимков, настройка моментальных снимков, тестирование конфигурации и возможностей подключения

Скачайте последнюю версию сценариев на [GitHub](https://github.com/Azure/hana-large-instances-self-service-scripts/tree/master/snapshot_tools_v4.0). Способ установки скрипты изменения с версией 4.0 скрипты. Дополнительные сведения см. в разделе «Включить связь с SAP HANA» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Точная последовательность команд, см. в разделе «Простая установка средств моментального снимка (по умолчанию)» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). Мы рекомендуем использовать установки по умолчанию. 

Обновление версии 3.x в 4.0, см. в разделе «Обновление существующей установки» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). Чтобы удалить набор инструментов версии 4.0, см. в разделе «Удаление моментальных снимков средства» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Не забудьте выполнить действия, описанные в «Завершить установку средств моментальный снимок» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Назначение различных сценариев и файлов они получили установлены, описан в «Каковы эти средства моментального снимка?» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Прежде чем настраивать средства моментального снимка, убедитесь, что также настроить параметры и расположения резервного копирования HANA правильно. Дополнительные сведения см. в разделе «Конфигурация SAP HANA» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Конфигурации набора инструментов моментального снимка описан в разделе «Файла Config - HANABackupCustomerDetails.txt» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

#### <a name="test-connectivity-with-sap-hana"></a>Проверка подключения к SAP HANA

Поместив все данные конфигурации в файл *HANABackupCustomerDetails.txt*, проверьте правильность конфигурации в отношении данных экземпляра HANA. Используйте сценарий `testHANAConnection`, который не зависит от конфигурации развертывания или масштабирования SAP HANA.

Дополнительные сведения см. в разделе «Проверьте подключение с помощью SAP HANA - testHANAConnection» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

#### <a name="test-storage-connectivity"></a>Подключение к хранилищу тестов

Следующий шаг теста является проверка подключения к хранилищу на основе данных, помещенных в *HANABackupCustomerDetails.txt* файла конфигурации. Затем выполните тестовый моментальный снимок. Прежде чем выполнять `azure_hana_backup` команды, этот тест необходимо выполнить. Последовательность команд для этого теста, см. в разделе «Проверьте подключение с хранилищем - testStorageSnapshotConnection»» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

После успешного входа в интерфейсы виртуальной машины хранилища этот сценарий перейдет к этапу 2 и создаст тестовый моментальный снимок. Ниже показан результат для конфигурации масштабирования трех узлов SAP HANA.

Если тестовый моментальный снимок успешно запускается с помощью сценария, вы можете запланировать действительных моментальных снимков хранилища. Если оно завершилось сбоем, сначала необходимо устранить проблемы перед перемещением вперед. Тестовый моментальный снимок следует хранить, пока не будут созданы первые настоящие моментальные снимки.


### <a name="step-7-perform-snapshots"></a>Шаг 7. Создание моментальных снимков

По завершении этапов подготовки можно сначала настроить и запланировать действительных моментальных снимков хранилища. Сценарий, выполнение которого следует запланировать, работает с конфигурациями увеличения масштаба и развертывания SAP HANA. Для периодического и регулярного выполнения сценария резервного копирования запланируйте его с помощью служебной программы Cron. 

Точный синтаксис команды и функции, см. в разделе «Выполнение резервного копирования моментальных снимков - azure_hana_backup» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). 

Когда скрипт `azure_hana_backup` выполняется, его создание моментальных снимков в следующих трех этапов:

1. Он выполняется из моментального снимка SAP HANA.
1. Выполняется моментальный снимок хранилища.
1. Она удаляет моментальный снимок SAP HANA, который был создан до выполнения моментального снимка хранилища.

Чтобы запустить сценарий, вызовите его из выполняемой папки HDB к которому он был скопирован. 

Срок хранения администрируется с количеством моментальных снимков, которые передаются в качестве параметра при выполнении сценарий. Количество времени, которая рассматривается моментальных снимков хранилища — это функция периода выполнения и количества моментальных снимков, переданного в качестве параметра при запуске сценария. 

Если количество хранимых моментальных снимков превышает значение, заданное как параметр в вызове скрипта, удаляется самый старый моментальный снимок такой же меткой, перед запуском нового моментального снимка. Количество хранимых моментальных снимков можно задать в последнем параметре вызова. С этим номером также можно управлять, косвенно, место на диске, используемым для моментальных снимков. 


## <a name="snapshot-strategies"></a>Стратегии моментальных снимков
Частота создания моментальных снимков для различных типов зависит от того, используются ли функции аварийного восстановления крупного экземпляра HANA. Эти функциональные возможности полагаются на моментальные снимки хранилища, в случае с которыми могут потребоваться некоторые специальные рекомендации с точки зрения частоты и продолжительности их создания. 

В приведенных ниже рекомендациях предполагается, что вы *не* используете функции аварийного восстановления, которые предлагают крупные экземпляры HANA. Предполагается, что вместо этого вы используете моментальные снимки хранилища в качестве средства резервного копирования и имеете возможность выполнить восстановление на определенный момент времени за последние 30 дней. Учитывая ограничения количества моментальных снимков и пространства, рассмотрите следующие требования:

- время восстановления до восстановления на определенный момент времени;
- используемое пространство;
- требования к целевой точке восстановления и целевому времени восстановления в случае возможного аварийного восстановления.
- последующее выполнение полного резервного копирования базы данных HANA на диски (при выполнении полного резервного копирования базы данных на диски (или в интерфейс **backint**) создание моментальных снимков хранилища завершается сбоем; Если вы планируете выполнить резервное копирование базы данных full на основе моментальных снимков хранилища, убедитесь, что в это время отключения выполнения моментальных снимков хранилища.
- Количество моментальных снимков на томе, в котором ограничено 250.

<!-- backint is term for a SAP HANA interface and not a spelling error not spelling errors -->

Если вы не используете функции аварийного восстановления крупных экземпляров HANA, создания моментальных снимков не так часто. В таком случае выполните объединенные моментальные снимки на/hana/Data и/hana/Shared, включая/usr/SAP, в 12-часового или 24-часовой период. Снимки будут сохраняться в течение месяца. То же самое касается моментальных снимков тома резервных копий журналов. Выполнение резервного копирования журнала транзакций SAP HANA на тома резервных копий журналов выполняется за 5 минут 15 минут.

Плановое создание моментальных снимков хранилища лучше всего выполнять с помощью средства Cron. Использовать тот же сценарий для резервного копирования и аварийного восстановления. Измените входные данные сценария в соответствии со временем резервного копирования. Эти моментальные снимки запланировано по-разному в cron, в зависимости от времени их выполнения. Он может быть каждый час, каждые 12 часов, ежедневно или еженедельно. 

В следующем примере показано расписания cron в/etc/crontab:
```
00 1-23 * * * ./azure_hana_backup --type=hana --prefix=hourlyhana --frequency=15min --retention=46
10 00 * * *  ./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
00,05,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
22 12 * * *  ./azure_hana_backup --type=logs --prefix=dailylogback --frequncy=3min --retention=28
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeI --prefix=dailyboot --frequncy=15min --retention=28
```
В предыдущем примере Ежечасный объединенный моментальный снимок охватывает тома, содержащие/hana/Data и /hana/shared/SID, включая/usr/SAP, расположения. Моментальный снимок этого типа ускоряет восстановление на определенный момент времени в пределах двух дней. Имеется также снимок на этих томах. Таким образом у вас есть два дня ежечасными моментальными снимками и четыре недели — ежедневными моментальными снимками. Тома резервных копий журналов транзакций также ежедневное резервное копирование. Эти резервные копии хранятся в течение четырех недель. 

Как видно в третьей строке crontab, резервное копирование журнала транзакций HANA запланировано запускается каждые 5 минут. Время запуска различных заданий cron, работающих моментальных снимков хранилища выполняется периодически. В этом случае моментальные снимки не выполняются за один раз в определенной точке во времени. 

В следующем примере выполняется создается объединенный моментальный снимок, который охватывает тома, содержащие/hana/Data и /hana/shared/SID, включая/usr/SAP, расположения на почасовой основе. Они хранятся в течение двух дней. Моментальные снимки томов резервных копий журнала транзакции выполняются на 5-минутными интервалами и хранятся в течение четырех часов. Как ранее, резервное копирование журнала транзакций HANA запланировано запускается каждые 5 минут. 

Моментальный снимок тома резервных копий журналов транзакций создается с задержкой в 2 минуты после начала резервного копирования журнала транзакций. В обычных условиях резервное копирование журнала транзакций SAP HANA завершается в течение этих 2 минут. Как и ранее, резервное копирование тома, содержащего загрузочный логический номер устройства, выполняется один раз в день: создается моментальный снимок хранилища, который хранится приблизительно четыре недели.

```
10 0-23 * * * ./azure_hana_backup --type=hana ==prefix=hourlyhana --frequency=15min --retention=48
0,5,10,15,20,25,30,35,40,45,50,55 * * * * ./azure_hana_backup --type=logs --prefix=regularlogback --frequency=3min --retention=28
2,7,12,17,22,27,32,37,42,47,52,57 * * * *  ./azure_hana_backup --type=logs --prefix=logback --frequency=3min --retention=48
30 00 * * *  ./azure_hana_backup --type=boot --boottype=TypeII --prefix=dailyboot --frequency=15min --retention=28
```

Следующий рисунок иллюстрирует последовательностей в предыдущем примере. Исключается загрузочного логического номера устройства.

![Связь между резервными копиями и моментальными снимками](./media/hana-overview-high-availability-disaster-recovery/backup_snapshot_updated0921.PNG)

SAP HANA регулярно записывает данные на том /hana/log, чтобы регистрировать зафиксированные изменения в базе данных. SAP HANA регулярно записывает точку сохранения на том /hana/data. Как указано в crontab резервная копия журнала транзакций SAP HANA выполняется каждые 5 минут. 

Вы также увидите, что из моментального снимка SAP HANA выполняется каждый час в результате активации объединенному моментальному снимку для тома/hana/Data и /hana/shared/SID хранилища. После успешного создания моментального снимка HANA, объединенного хранения моментального снимка выполняется. Как указано в crontab, моментальный снимок хранилища тома/hana/logbackup выполняется каждые 5 минут, примерно через 2 минуты после резервного копирования журнала транзакций HANA.

> 

>[!IMPORTANT]
> Резервное копирование SAP HANA на основе моментальных снимков хранилища имеет смысл, только если моментальные снимки создаются совместно с резервными копиями журналов транзакций SAP HANA. Эти резервные копии журналов транзакций должны охватывать временные периоды между моментальными снимками хранилища. 

Если необходимо выполнить восстановление на определенный момент времени в пределах 30 дней, вам потребуются:

- Доступ к моментальный снимок хранилища, объединенный по/hana/Data и /hana/shared/SID, 30 дней, в исключительных случаях. 
- Связанные резервные копии журналов транзакций, охватывающие время между всеми объединенными моментальными снимками хранилища. Поэтому наиболее старому моментальному снимку тома резервных копий журналов транзакций должно быть 30 дней. Это не так, если скопировать резервные копии журналов транзакций на другой общедоступный ресурс NFS, расположенный в службе хранилища Azure. В этом случае можно получить старые резервные копии журналов транзакций из этого общедоступного ресурса NFS.

Чтобы извлечь пользу из моментальных снимков хранилища и итоговую репликацию резервных копий журнала транзакций, измените расположение, в котором SAP HANA записывает резервные копии журналов транзакций. Это можно сделать в HANA Studio. 

Хотя SAP HANA производит резервное копирование сегментов полного журнала автоматически, следует укажите детерминированный интервал резервного копирования журнала. Это особенно верно при использовании аварийного восстановления, так как обычно требуется создание резервных копий журналов с детерминированным периодом. В приведенном ниже примере 15 минут будет задан интервал резервного копирования журналов.

![Настройка расписания для создания резервных копий журналов SAP HANA в SAP HANA Studio.](./media/hana-overview-high-availability-disaster-recovery/image5-schedule-backup.png)

Вы также можете резервных копий, которые происходят значительно чаще, чем каждые 15 минут. Такое более частое значение используется в сочетании с функциональной возможностью аварийного восстановления HANA (крупные экземпляры). Некоторые клиенты создают резервные копии журналов транзакций каждые 5 минут.

Если резервная копия базы данных еще не создавалась, то последний этап заключается в создании ее файловой резервной копии. Это позволит создать одну запись резервной копии, которая должна находиться в каталоге резервных копий. В противном случае SAP HANA не может инициировать резервное копирование журнала.

![Создание файловой резервной копии для формирования единой записи о резервной копии](./media/hana-overview-high-availability-disaster-recovery/image6-make-backup.png)


После выполнения первых успешно моментальных снимков, удалите тестовый моментальный снимок, запущенных на шаге 6. Дополнительные сведения см. в разделе «Удаление тестового моментальных снимков - removeTestStorageSnapshot» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). 


### <a name="monitor-the-number-and-size-of-snapshots-on-the-disk-volume"></a>Отслеживать количество и размер моментальных снимков на томе диска

Количество моментальных снимков и занимаемое ими пространство на определенном томе хранилища можно отслеживать. Команда `ls` не возвращает сведения о каталоге или файлах моментальных снимков. Команда ОС Linux `du` представлены сведения об этих моментальных снимках хранилища, так как они хранятся на тех же томах. Используйте команду со следующими параметрами:

- `du –sh .snapshot`. Этот параметр возвращает общее число моментальных снимков в каталоге моментальных снимков.
- `du –sh --max-depth=1`. Этот параметр выводит список всех моментальных снимков, сохраненных в папке **.snapshot**, и размер каждого моментального снимка.
- `du –hc`. Этот параметр возвращает общий размер всех моментальных снимков.

Используйте следующие команды, чтобы убедиться в том, что моментальные снимки, которые создаются и хранятся не занимают все хранилища на томах.

>[!NOTE]
>Моментальные снимки загрузочного логического номера устройства не отображаются, приведенные выше команды.

### <a name="get-details-of-snapshots"></a>Получение сведений о моментальных снимках
Чтобы получить дополнительные сведения о моментальных снимках, используйте сценарий `azure_hana_snapshot_details`. Этот сценарий можно выполнять в любом расположении, если в расположении аварийного восстановления имеется активный сервер. Этот сценарий предоставляет следующие выходные данные с разбивкой по томам, содержащим моментальные снимки: 
   * общий размер моментальных снимков на томе;
   * Для каждого снимка на этом томе указываются следующие сведения: 
      - имя моментального снимка; 
      - время создания снимка; 
      - размер снимка;
      - частота создания снимка;
      - идентификатор резервного копирования HANA, связанный с этим моментальным снимком (если применимо).

Синтаксис команды и выходные данные, см. в разделе «Списка моментальных снимков - azure_hana_snapshot_details» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). 



### <a name="reduce-the-number-of-snapshots-on-a-server"></a>Уменьшить количество моментальных снимков на сервере

Как объяснялось выше можно уменьшить количество моментальных снимков, которые хранятся с определенным интервалом. Последние два параметра команды позволяют указать временную метку и количество хранимых моментальных снимков.

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=28
```

В предыдущем примере, моментальных снимков задана метка **dailyhana**. Количество моментальных снимков, которые храниться с этой меткой является **28**. За использование дискового пространства отвечаете вы, и поэтому вам может потребоваться уменьшить количество сохраненных моментальных снимков. — Это простой способ сократить количество моментальных снимков до 15, например, для запуска сценария с помощью последнего параметра значение **15**:

```
./azure_hana_backup --type=hana --prefix=dailyhana --frequency=15min --retention=15
```

Если запустить скрипт с помощью этого параметра, количество моментальных снимков, которая включает новый моментальный снимок хранилища, — 15. Останутся 15 последних моментальных снимков, тогда как 15 более старых моментальных снимков будут удалены.

 >[!NOTE]
 > Этот сценарий уменьшает количество моментальных снимков только в том случае, если существуют моментальные снимки более часа назад. Скрипт не удаляет моментальные снимки, созданные менее часа назад. Эти ограничения связаны с предоставленными необязательными функциями аварийного восстановления.

Если вы больше не хотите хранить набор моментальных снимков с помощью резервного копирования префикс **dailyhana** в примерах синтаксиса, запустите скрипт с **0** периода удержания значение. Затем удаляются все моментальные снимки, соответствующие этой метке. Удаление всех моментальных снимков может повлиять на возможности функции аварийного восстановления крупных экземпляров HANA.

Второй способ удалить определенные моментальные снимки — сценарий `azure_hana_snapshot_delete`. Этот сценарий предназначен для удаления моментального снимка или набора моментальных снимков с помощью идентификатора резервного копирования HANA, указанного в HANA Studio, или имени моментального снимка. В настоящее время идентификатор резервного копирования привязывается только к моментальным снимкам типа **hana**. Тип резервном копировании моментальных снимков **журналы** и **загрузки** не выполнения моментального снимка SAP HANA, поэтому идентификатор резервного копирования для этих моментальных снимков отсутствует. Если введено имя моментального снимка, то на разных томах будет выполнен поиск всех моментальных снимков, соответствующих этому имени. 

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->

Дополнительные сведения об этом скрипте см. в разделе «Удаление моментальных снимков - azure_hana_snapshot_delete» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).

Запустите скрипт с правами пользователя **корневой**.

>[!IMPORTANT]
>При наличии данных, которые существуют только на моментальный снимок, который планируется удалить, после удаления моментального снимка, что данные теряются навсегда.


## <a name="file-level-restore-from-a-storage-snapshot"></a>Восстановление уровня файла из моментального снимка хранилища

<!-- hana, logs and boot are no spelling errors as Acrolinx indicates, but terms of parameter values -->
Моментальные снимки типов **hana** и **logs** дают возможность обращаться непосредственно к моментальным снимкам на томах в каталоге **.snapshot**. Это подкаталог для каждого моментального снимка. Копирование каждого файла в состояние, в котором она находилась на момент создания снимка из этого подкаталога в действительную структуру каталогов. 

В текущей версии сценария имеется *не* сценарий, предоставленный для восстановления моментального снимка как самостоятельное восстановление. Восстановление моментального снимка можно выполнять в рамках сценариев самообслуживания аварийного восстановления на сайте аварийного восстановления во время отработки отказа. Чтобы восстановить требуемый моментальный снимок из доступных существующие моментальные снимки, свяжитесь с рабочая группа Майкрософт, открыв запрос на обслуживание.

>[!NOTE]
>Восстановление, отдельных файлов не поддерживается для моментальных снимков загрузочного логического номера устройства, не зависят от типа единиц крупных экземпляров HANA. **.Snapshot** directory не представляется в загрузочном LUN. 
 

## <a name="recover-to-the-most-recent-hana-snapshot"></a>Восстановление до последнего моментального снимка HANA

В случае сбоя рабочей можно запустить процесс восстановления из моментального снимка хранилища как пользовательский инцидент поддержки Microsoft Azure. Это предвидеть, если данные были удалены из рабочей системы и единственный способ получить его — восстановить рабочую базу данных.

С другой стороны, восстановление на определенный момент времени может быть не срочным и планироваться на несколько дней вперед. Можно спланировать восстановление SAP HANA в Azure, не поднимая флаг высоким приоритетом. Например планируется обновление программного обеспечения SAP, применив новую версию пакета расширений. Затем необходимо восстановить моментальный снимок с состоянием до обновления пакета расширений.

Прежде чем отправлять запрос, следует учесть некоторые моменты, Группа SAP HANA в Azure можно обрабатывать запрос и предоставить восстановленные тома. после чего вы сможете восстановить базу данных HANA на основе моментальных снимков.

Возможности для получения моментального снимка, восстанавливается с новым набором средств, см. в разделе «How to restore для моментального снимка» в [восстановление вручную руководство по SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf).

Чтобы подготовить для запроса, выполните следующие действия.

1. Выберите моментальный снимок, который нужно восстановить. Если не указано другое, будет восстановлен только том hana/data. 

1. Завершите работу экземпляра HANA.

   ![Завершение работы экземпляра HANA](./media/hana-overview-high-availability-disaster-recovery/image7-shutdown-hana.png)

1. Отключите тома данных на каждом узле базы данных HANA. Если тома данных все еще подключены к операционной системе, восстановление моментального снимка завершится ошибкой.

   ![Отключение томов данных на каждом узле базы данных HANA](./media/hana-overview-high-availability-disaster-recovery/image8-unmount-data-volumes.png)

1. Откройте запрос на поддержку Azure и содержит инструкции по восстановлению определенного моментального снимка:

   - Во время восстановления: SAP HANA в службе Azure может попросить вас к конференции, для координации, проверки и убедитесь, что восстановления правильного моментального снимка хранилища. 

   - После восстановления: SAP HANA в службе Azure оповещает вас о восстановлении моментального снимка хранилища.

1. Когда процесс восстановления завершится, подключите все тома данных.

   ![Подключение всех томов данных](./media/hana-overview-high-availability-disaster-recovery/image9-remount-data-volumes.png)



Другой вариант для получения, например, файлы данных SAP HANA, восстановить из моментального снимка хранилища, описанное на шаге 7 в [восстановление вручную руководство по SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf).

Чтобы восстановить из резервной копии моментального снимка, см. в разделе [восстановление вручную руководство по SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf). 

>[!Note]
>Если моментальный снимок был восстановлен Microsoft operations, не требуется выполнять шаги с 7.


### <a name="recover-to-another-point-in-time"></a>Восстановление до другой точки во времени
Чтобы восстановить до определенной точки во времени, см. в разделе «Восстановить базу данных до следующей точки во времени» в [восстановление вручную руководство по SAP HANA в Azure из моментального снимка хранилища](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/guides/Manual%20recovery%20of%20snapshot%20with%20HANA%20Studio.pdf). 


## <a name="next-steps"></a>Следующие шаги
- См. в разделе [принципы аварийного восстановления и подготовки](hana-concept-preparation.md).
