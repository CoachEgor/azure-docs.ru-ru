---
title: Процедура отказа HANA к месту бедствия для SAP HANA на Azure (Большие инстанции) Документы Майкрософт
description: Как выполнить сбой на место аварийного восстановления для SAP HANA на Azure (Большие инстанции)
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: juergent
editor: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 04/22/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 3fe3ee79318ab9fdc9f2c0e9585051439b76b5cf
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77617140"
---
# <a name="disaster-recovery-failover-procedure"></a>Процедура отработки отказа при аварийном восстановлении


>[!IMPORTANT]
>Эта статья не является заменой административной документации SAP HANA или SAP Notes. Мы ожидаем, что у вас есть полное понимание и опыт в управлении и операциях SAP HANA, особенно для резервного копирования, восстановления, высокой доступности и аварийного восстановления (DR). В этой статье показаны скриншоты из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Есть два случая, чтобы рассмотреть, когда вы не на сайт DR:

- Необходимо восстановить последнее состояние данных базы данных SAP HANA. В этом случае существует скрипт самообслуживания, с помощью которого можно выполнить сбой без необходимости связываться с корпорацией Майкрософт. Для отказа вам нужно работать с корпорацией Майкрософт.
- Требуется восстановить моментальный снимок хранилища, который не является последним реплицированным моментальным снимком. В этом случае следует обратиться в корпорацию Майкрософт. 

>[!NOTE]
>Следующие шаги должны быть сделаны на подразделении HANA Large Instance, которое представляет подразделение DR. 
 
Чтобы восстановить последние воспроизведенные моментальные снимки хранилища, выполните последующие действия в полном объеме DR failover - azure_hana_dr_failover" в инструментах Microsoft snapshot для [SAP HANA на Azure.](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.2/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.2.1.pdf) 

Если требуется, чтобы несколько экземпляров SAP HANA сработали, запустите azure_hana_dr_failover несколько раз. При запросе введите SAP HANA SID, который вы хотите выполнить, и восстановить. 


Вы можете проверить DR failover также без влияя на фактическое отношение репликации. Чтобы выполнить тест неудачу, выполните шаги в "Выполнение теста DR failover - azure_hana_test_dr_failover" в [microsoft моментальные инструменты для SAP HANA на Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.2/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.2.1.pdf). 

>[!IMPORTANT]
>Не *запускайте* производственные транзакции на примере, который вы создали на сайте DR в процессе **тестирования сбоя.** Команда azure_hana_test_dr_failover создает набор томов, которые не имеют никакого отношения к основному сайту. В результате синхронизация с основным сайтом *невозможна*. 

Если требуется протестировать несколько экземпляров SAP HANA, запустите сценарий несколько раз. При запросе введите SAP HANA SID экземпляра, который вы хотите проверить на случай неудачи. 

>[!NOTE]
>Если вам нужно не на месте DR, чтобы спасти некоторые данные, которые были удалены несколько часов назад, и необходимо, чтобы объемы DR были установлены на более ранний снимок, эта процедура применяется. 

1. Выключите непроизводственный экземпляр HANA на единице аварийного восстановления HANA Large Instances, который вы работаете. Предустановлен спящий производственный экземпляр HANA.
1. Остановите все процессы SAP HANA. Используйте следующую команду для этой проверки:

      `/usr/sap/hostctrl/exe/sapcontrol –nr <HANA instance number> - function GetProcessList`.

      Выход должен показать вам процесс **hdbdaemon** в остановленном состоянии и никакие другие процессы HANA в запущенном или запущенном состоянии.
1. Определите имя моментального снимка или идентификатор резервного копирования SAP HANA для восстановления на сайте аварийного восстановления. В реальных ситуациях аварийного восстановления, как правило, это последний моментальный снимок. Если необходимо восстановить потерянные данные, выберите более ранний снимок.
1. Обратитесь в службу поддержки Azure, отправив запрос на техническую поддержку с высоким приоритетом. Попросите восстановить этот снимок с именем и датой снимка или идентификатором резервного копирования HANA на сайте DR. Если этого не сделать, отдел эксплуатации восстановит только том /hana/data. Если вы хотите иметь /hana/logbackups томов тоже, вы должны конкретно заявить, что. *Не восстанавливайте том /hana/shared.* Вместо этого выберите определенные файлы, такие как global.ini из каталога **.snapshot** и его субдиректоров после того, как вы перенапрягнете /hana/общий том для PRD. 

   На стороне отдела эксплуатации произойдет следующее:

   а. Репликация моментальных снимков из рабочего тома на тома аварийного восстановления остановится. Такое прерывание уже могло произойти, если появилась необходимость выполнить аварийное восстановление из-за сбоя на рабочем сайте.
   
   b. На томах аварийного восстановления будет восстановлен выбранный моментальный снимок с идентификатором резервного копирования или моментальный снимок хранилища с указанным именем.
   
   c. После завершения восстановления данных тома аварийного восстановления становятся доступны для подключения к единицам крупных экземпляров HANA в регионе аварийного восстановления.
      
1. Подключите тома аварийного восстановления к единице крупного экземпляра HANA на сайте аварийного восстановления. 
1. Запустите неактивный рабочий экземпляр SAP HANA.
1. Если вы решили скопировать журналы резервного копирования транзакций, чтобы сократить время RPO, объедините резервные копии журнала транзакций в недавно установленный каталог DR /hana/logbackups. Не перезаписывайте имеющиеся резервные копии. Копирование новых резервных копий, которые не были воспроизведены с последней репликации моментального снимка хранилища.
1. Можно также восстановить отдельные файлы из моментальных снимков, которые не были воспроизведены в объем /hana/shared/PRD в регионе DR Azure.

Следующие шаги показывают, как восстановить экземпляр производства SAP HANA на основе восстановленного снимка хранилища и доступных резервных копий журнала транзакций.

1. С помощью SAP HANA Studio измените расположение резервной копии на расположение **/hana/logbackups**.

   ![Изменение расположения резервной копии для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/change_backup_location_dr1.png)

1. SAP HANA проверит расположения файлов резервных копий и предложит для восстановления самую последнюю резервную копию журналов транзакций. Сканирование может занять несколько минут, пока не появится экран, подобный следующему:

   ![Список резервных копий журнала транзакций для восстановления DR](./media/hana-overview-high-availability-disaster-recovery/backup_list_dr2.PNG)

1. Настройте некоторые параметры по умолчанию:

      - снимите флажок **Use Delta Backups** (Использовать разностные резервные копии);
      - установите флажок **Initialize Log Area** (Инициализировать область журнала).

   ![Выбор инициализации области журнала](./media/hana-overview-high-availability-disaster-recovery/initialize_log_dr3.PNG)

1. Нажмите кнопку **Готово**.

   ![Завершение аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/finish_dr4.PNG)

Должно появиться окно хода выполнения, как показано ниже. Помните, что в примере выполняется аварийное восстановление развернутой конфигурации SAP HANA с тремя узлами.

![Ход восстановления](./media/hana-overview-high-availability-disaster-recovery/restore_progress_dr5.PNG)

Если восстановление перестает отвечать на экране **готовой кончины** и не показывает экран хода, подтвердите, что все экземпляры SAP HANA на узлах рабочего значения работают. При необходимости запустите экземпляры SAP HANA вручную.


## <a name="failback-from-a-dr-to-a-production-site"></a>Восстановление размещения с сайта аварийного восстановления на рабочий сайт
Вы можете выполнить восстановление размещения с сайта аварийного восстановления на рабочий сайт. Рассмотрим сценарий, когда отработка отказа на сайт аварийного восстановления была вызвана проблемами в рабочем регионе Azure, а не вашей потребностью восстановить потерянные данные. 

Вы уже некоторое время работаете с рабочей нагрузкой SAP на месте аварийного восстановления. После устранения проблем на рабочем сайте можно выполнить восстановление размещения. Так как потеря данных недопустима, возвращение на рабочий сайт включает в себя несколько действий и тесное взаимодействие с рабочей группой SAP HANA в Azure. Вы должны связаться с рабочей группой, чтобы она инициировала синхронизацию на рабочий сайт после устранения проблем.

Выполните следующие действия.

1. Рабочая группа SAP HANA в Azure получает сигнал для синхронизации томов рабочего хранилища из томов хранилища аварийного восстановления, которые теперь представляют состояние рабочего сайта. В этом состоянии работа единицы крупного экземпляра HANA на рабочем сайте завершена.
1. Оперативная группа SAP HANA в Azure отслеживает репликацию и следит за тем, чтобы она была догнана до того, как она информирует вас.
1. Вам необходимо завершить работу приложений, которые используют рабочий экземпляр HANA на сайте аварийного восстановления. Затем вы создадите резервную копию журналов транзакций HANA. Далее вы остановите экземпляр HANA, работающий на единицах hanA Large Instance на месте аварийного восстановления.
1. После того, как экземпляр HANA, работающий в блоке HANA Large Instance в месте восстановления аварийного сообщения, снова выключается, команда операций вручную синхронизирует объемы диска.
1. Оперативная группа SAP HANA в Azure снова запускает подразделение HANA Large Instance на производственной площадке. Они передают его вам. Вы убедитесь, что экземпляр SAP HANA находится в состоянии выключения во время запуска подразделения HANA Large Instance.
1. Вы выполняете те же шаги восстановления базы данных, что и при ранее сбовом в доступе к месту аварийного восстановления.

## <a name="monitor-disaster-recovery-replication"></a>Мониторинг репликации для аварийного восстановления

Чтобы отслеживать состояние хода репликации хранилища, `azure_hana_replication_status`запустите сценарий. Эта команда должна выполняться от единицы, которая работает в месте восстановления аварийного бедствия, чтобы функционировать, как ожидалось. Команда работает независимо от того, активна ли репликация. Команда может быть запущена для каждого подразделения HANA Large Instance вашего клиента в месте аварийного восстановления. Он не может быть использован для получения подробной информации об объеме загрузки. 

Для получения дополнительной информации об команде и ее выходе с [Microsoft snapshot tools for SAP HANA on Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.2/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.2.1.pdf)azure_hana_replication_statusм.


## <a name="next-steps"></a>Дальнейшие действия
- Смотрите [монитор и устранение неполадок со стороны HANA](hana-monitor-troubleshoot.md).
