---
title: Процедура отработки отказа HANA на сайт аварийного восстановления для SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Как выполнить отработку отказа на сайт аварийного восстановления для SAP HANA в Azure (крупные экземпляры)
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: gwallace
editor: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 04/22/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: c2c8483948deae41edbe3922dc77361ba2c58a94
ms.sourcegitcommit: 44e85b95baf7dfb9e92fb38f03c2a1bc31765415
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70099868"
---
# <a name="disaster-recovery-failover-procedure"></a>Процедура отработки отказа при аварийном восстановлении


>[!IMPORTANT]
>Эта статья не заменяет документацию по SAP HANA администрирования или примечания SAP. Мы надеемся, что у вас есть четкое понимание и опыт в SAP HANA администрирования и эксплуатации, особенно для резервного копирования, восстановления, обеспечения высокой доступности и аварийного восстановления (DR). В этой статье показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

При отработки отказа на сайт аварийного восстановления следует учитывать два варианта:

- Необходимо восстановить последнее состояние данных базы данных SAP HANA. В этом случае существует сценарий самообслуживания, с помощью которого можно выполнить отработку отказа без необходимости обращения в корпорацию Майкрософт. Для восстановления размещения необходимо работать с корпорацией Майкрософт.
- Вы хотите восстановить моментальный снимок хранилища, не являющийся последним реплицируемым моментальным снимком. В этом случае следует обратиться в корпорацию Майкрософт. 

>[!NOTE]
>Следующие действия необходимо выполнить на единице крупных экземпляров HANA, которая представляет собой модуль аварийного восстановления. 
 
Чтобы восстановить последние реплицированные моментальные снимки хранилища, выполните действия, описанные в разделе "выполнение полной АВАРИЙной отработки отказа — azure_hana_dr_failover" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.1/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.1.pdf). 

Если требуется выполнить отработку отказа нескольких экземпляров SAP HANA, выполните команду azure_hana_dr_failover несколько раз. По запросу введите SAP HANA идентификатор безопасности, для которого требуется выполнить отработку отказа и восстановить. 


Можно проверить отработку отказа аварийного восстановления, не влияя на фактическое отношение репликации. Чтобы выполнить тестовую отработку отказа, выполните действия, описанные в разделе "выполнение тестового перехода по АВАРИЙному восстановлению с помощью azure_hana_test_dr_failover" в [Microsoft snapshot Tools для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.1/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.1.pdf). 

>[!IMPORTANT]
>*Не* запускайте рабочие транзакции в экземпляре, созданном на сайте аварийного восстановления, с помощью процесса **тестирования**отработки отказа. Команда azure_hana_test_dr_failover создает набор томов, которые не имеют связи с первичным сайтом. В результате синхронизация с основным сайтом *невозможна*. 

Если требуется несколько экземпляров SAP HANA для тестирования, запустите сценарий несколько раз. При запросе введите идентификатор безопасности SAP HANA экземпляра, который необходимо протестировать для отработки отказа. 

>[!NOTE]
>Если необходимо выполнить отработку отказа на сайт аварийного восстановления, чтобы спасти некоторые данные, удаленные ч назад и требующие, чтобы тома аварийного восстановления были настроены на более раннюю версию моментального снимка, применяется эта процедура. 

1. Завершите работу непроизводственных экземпляров HANA в единице аварийного восстановления для крупных экземпляров HANA, которые вы используете. Предварительно установлен неактивный производственный экземпляр HANA.
1. Остановите все процессы SAP HANA. Для этой проверки используйте следующую команду:

      `/usr/sap/hostctrl/exe/sapcontrol –nr <HANA instance number> - function GetProcessList`.

      В выходных данных должен быть указан остановленный процесс **hdbdaemon** и должны отсутствовать какие-либо другие работающие или запущенные процессы HANA.
1. Определите имя моментального снимка или идентификатор резервного копирования SAP HANA для восстановления на сайте аварийного восстановления. В реальных ситуациях аварийного восстановления, как правило, это последний моментальный снимок. Если необходимо восстановить потерянные данные, выберите более ранний снимок.
1. Обратитесь в службу поддержки Azure, отправив запрос на техническую поддержку с высоким приоритетом. Запросите восстановление этого моментального снимка, указав имя и дату моментального снимка или ИД резервной копии HANA на сайте аварийного восстановления. Если этого не сделать, отдел эксплуатации восстановит только том /hana/data. Если вы хотите, чтобы тома/Hana/LogBackups, необходимо специально указать это. *Не восстанавливайте том /hana/shared.* Вместо этого выберите определенные файлы, например Global. ini, из каталога **. snapshot** и его подкаталогов после повторного подключения тома/Hana/Shared для PRD. 

   На стороне отдела эксплуатации произойдет следующее:

   1\. Репликация моментальных снимков из рабочего тома на тома аварийного восстановления остановится. Такое прерывание уже могло произойти, если появилась необходимость выполнить аварийное восстановление из-за сбоя на рабочем сайте.
   
   2\. На томах аварийного восстановления будет восстановлен выбранный моментальный снимок с идентификатором резервного копирования или моментальный снимок хранилища с указанным именем.
   
   В. После завершения восстановления данных тома аварийного восстановления становятся доступны для подключения к единицам крупных экземпляров HANA в регионе аварийного восстановления.
      
1. Подключите тома аварийного восстановления к единице крупного экземпляра HANA на сайте аварийного восстановления. 
1. Запустите неактивный рабочий экземпляр SAP HANA.
1. Если вы решили скопировать журналы резервных копий журналов транзакций, чтобы сократить время RPO, объедините резервные копии журналов транзакций в вновь подключенный каталог аварийного восстановления/Hana/LogBackups. Не перезаписывайте имеющиеся резервные копии. Скопируйте более новые резервные копии, которые не были реплицированы с помощью последней репликации моментального снимка хранилища.
1. Кроме того, можно восстановить отдельные файлы из моментальных снимков, которые не были реплицированы на том/hana/shared/PRD в регионе аварийного восстановления Azure.

Следующие шаги показывают, как восстановить экземпляр SAP HANA Production на основе восстановленного моментального снимка хранилища и доступных резервных копий журнала транзакций.

1. С помощью SAP HANA Studio измените расположение резервной копии на расположение **/hana/logbackups**.

   ![Изменение расположения резервной копии для восстановления DR](./media/hana-overview-high-availability-disaster-recovery/change_backup_location_dr1.png)

1. SAP HANA проверит расположения файлов резервных копий и предложит для восстановления самую последнюю резервную копию журналов транзакций. Сканирование может занять несколько минут, пока не появится экран следующего вида:

   ![Список резервных копий журналов транзакций для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/backup_list_dr2.PNG)

1. Настройте некоторые параметры по умолчанию:

      - снимите флажок **Use Delta Backups** (Использовать разностные резервные копии);
      - установите флажок **Initialize Log Area** (Инициализировать область журнала).

   ![Выбор инициализации области журнала](./media/hana-overview-high-availability-disaster-recovery/initialize_log_dr3.PNG)

1. Выберите **Готово**.

   ![Завершение аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/finish_dr4.PNG)

Должно появиться окно хода выполнения, как показано ниже. Помните, что в примере выполняется аварийное восстановление развернутой конфигурации SAP HANA с тремя узлами.

![Ход восстановления](./media/hana-overview-high-availability-disaster-recovery/restore_progress_dr5.PNG)

Если восстановление перестает отвечать на экран **завершения** и не отображает экран хода выполнения, убедитесь, что все SAP HANA экземпляры на рабочих узлах работают. При необходимости запустите экземпляры SAP HANA вручную.


## <a name="failback-from-a-dr-to-a-production-site"></a>Восстановление размещения с сайта аварийного восстановления на рабочий сайт
Вы можете выполнить восстановление размещения с сайта аварийного восстановления на рабочий сайт. Рассмотрим сценарий, когда отработка отказа на сайт аварийного восстановления была вызвана проблемами в рабочем регионе Azure, а не вашей потребностью восстановить потерянные данные. 

Вы заработали рабочую нагрузку SAP в течение определенного места на сайте аварийного восстановления. После устранения проблем на рабочем сайте можно выполнить восстановление размещения. Так как потеря данных недопустима, возвращение на рабочий сайт включает в себя несколько действий и тесное взаимодействие с рабочей группой SAP HANA в Azure. Вы должны связаться с рабочей группой, чтобы она инициировала синхронизацию на рабочий сайт после устранения проблем.

Выполните следующие действия.

1. Рабочая группа SAP HANA в Azure получает сигнал для синхронизации томов рабочего хранилища из томов хранилища аварийного восстановления, которые теперь представляют состояние рабочего сайта. В этом состоянии работа единицы крупного экземпляра HANA на рабочем сайте завершена.
1. SAP HANA в группе эксплуатации Azure отслеживает репликацию и проверяет ее состояние до того, как она сообщит вам.
1. Вам необходимо завершить работу приложений, которые используют рабочий экземпляр HANA на сайте аварийного восстановления. Затем вы создадите резервную копию журналов транзакций HANA. Далее вы останавливаете экземпляр HANA, который выполняется в единицах крупных экземпляров HANA на сайте аварийного восстановления.
1. После завершения работы экземпляра HANA, работающего в единице крупного экземпляра HANA на сайте аварийного восстановления, Группа эксплуатации вручную синхронизирует тома дисков.
1. SAP HANA в группе эксплуатации Azure снова запускает единицу крупного экземпляра HANA на рабочем сайте. Они передаются вам. Убедитесь, что экземпляр SAP HANA находится в состоянии завершения работы во время запуска единицы крупного экземпляра HANA.
1. Вы выполняете те же действия по восстановлению базы данных, что и при выполнении ранее отработки отказа на сайт аварийного восстановления.

## <a name="monitor-disaster-recovery-replication"></a>Мониторинг репликации для аварийного восстановления

Чтобы отслеживать состояние процесса репликации хранилища, запустите сценарий `azure_hana_replication_status`. Эту команду следует запускать из блока, который выполняется в расположении аварийного восстановления, чтобы работать должным образом. Команда работает независимо от того, активна ли репликация. Команду можно выполнить для каждой единицы крупного экземпляра HANA вашего клиента в расположении аварийного восстановления. Его нельзя использовать для получения сведений о загрузочном томе. 

Дополнительные сведения о команде и ее выходных данных см. в разделе "получение состояния репликации DR-azure_hana_replication_status" в [средствах создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).


## <a name="next-steps"></a>Следующие шаги
- См. раздел [мониторинг и устранение неполадок на стороне Hana](hana-monitor-troubleshoot.md).
