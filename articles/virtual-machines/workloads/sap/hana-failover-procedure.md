---
title: HANA отработка отказа на сайт аварийного для SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Как выполнить отработку отказа на сайт аварийного восстановления SAP hana в Azure (крупные экземпляры)
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 04/22/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f7d4f6216b4a57796ab5c0296713316dd97c47a8
ms.sourcegitcommit: 60606c5e9a20b2906f6b6e3a3ddbcb6c826962d6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2019
ms.locfileid: "64987885"
---
# <a name="disaster-recovery-failover-procedure"></a>Процедура отработки отказа при аварийном восстановлении


>[!IMPORTANT]
>В этой статье не заменяет документацию по администрированию SAP HANA или примечания к SAP. Мы ожидаем, что имеется глубокие знания и опыт в SAP HANA администрирования и эксплуатации, особенно для резервного копирования, восстановления, высокой доступности и аварийного восстановления (DR). В этой статье показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Существует два сценария, которые следует учитывать при отработку отказа на сайт аварийного восстановления:

- Необходимо восстановить последнее состояние данных базы данных SAP HANA. В этом случае предлагается сценарий самообслуживания с помощью которого можно выполнить отработку отказа без необходимости обращения в корпорацию Майкрософт. Для восстановления размещения необходимо обратиться в корпорацию Майкрософт.
- Требуется выполнить восстановление до моментального снимка хранилища, который не является последним реплицированным моментальным снимком. В этом случае следует обратиться в корпорацию Майкрософт. 

>[!NOTE]
>Следующие действия необходимо выполнить на единице крупного экземпляра HANA, который представляет собой аварийного восстановления. 
 
Чтобы восстановить последнюю реплицированного моментального снимка, выполните действия, описанные в «Выполнение полная отработка отказа аварийного восстановления — azure_hana_dr_failover» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). 

Если вы хотите иметь несколько экземпляров SAP HANA выполнена отработка отказа, выполните команду azure_hana_dr_failover несколько раз. При запросе введите идентификатор безопасности SAP HANA, необходимо выполнить отработку отказа и восстановления. 


Можно также проверить отработку отказа аварийного восстановления без ущерба для фактической связи репликации. Чтобы выполнить тестовую отработку отказа, выполните действия, описанные в «Выполнение теста отработки отказа аварийного восстановления - azure_hana_test_dr_failover» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf). 

>[!IMPORTANT]
>Сделать *не* выполните рабочие транзакции на экземпляре, созданный на сайте аварийного восстановления, процесс **тестирования отработки отказа**. Команда azure_hana_test_dr_failover создает набор томов, не связанных с основным сайтом. В результате синхронизация с основным сайтом *невозможна*. 

Если вы хотите иметь несколько экземпляров SAP HANA, чтобы проверить, запустить сценарий несколько раз. При запросе введите идентификатор безопасности SAP HANA, для которого вы хотите протестировать для отработки отказа. 

>[!NOTE]
>Эта процедура применяется, если требуется выполнить отработку отказа на сайт аварийного восстановления, чтобы спасти некоторые данные, который был удален часов назад и вам будет присвоено более ранний снимок томов аварийного восстановления. 

1. Завершите работу нерабочей экземпляра HANA на единице аварийного восстановления крупных экземпляров HANA, который будет работать. Предустановлена неактивного рабочего экземпляра HANA.
1. Остановите все процессы SAP HANA. Для проверки, используйте следующую команду:

      `/usr/sap/hostctrl/exe/sapcontrol –nr <HANA instance number> - function GetProcessList`.

      В выходных данных должен быть указан остановленный процесс **hdbdaemon** и должны отсутствовать какие-либо другие работающие или запущенные процессы HANA.
1. Определите имя моментального снимка или идентификатор резервного копирования SAP HANA для восстановления на сайте аварийного восстановления. В реальных ситуациях аварийного восстановления, как правило, это последний моментальный снимок. Если необходимо восстановить потерянные данные, выберите более ранний снимок.
1. Обратитесь в службу поддержки Azure, отправив запрос на техническую поддержку с высоким приоритетом. Запросить восстановление этого моментального снимка с именем и дату создания моментального снимка или идентификатор резервного копирования HANA на сайте аварийного восстановления. Если этого не сделать, отдел эксплуатации восстановит только том /hana/data. Если вы хотите иметь слишком тома/hana/logbackups, необходимо специально указано, что. *Не восстанавливайте том /hana/shared.* Вместо этого выбрать определенные файлы, такие как global.ini, из **.snapshot** каталоге и его подкаталогах, после повторного подключения тома/hana/shared для PRD. 

   На стороне отдела эксплуатации произойдет следующее:

   a. Репликация моментальных снимков из рабочего тома на тома аварийного восстановления остановится. Такое прерывание уже могло произойти, если появилась необходимость выполнить аварийное восстановление из-за сбоя на рабочем сайте.
   
   2. На томах аварийного восстановления будет восстановлен выбранный моментальный снимок с идентификатором резервного копирования или моментальный снимок хранилища с указанным именем.
   
   c. После завершения восстановления данных тома аварийного восстановления становятся доступны для подключения к единицам крупных экземпляров HANA в регионе аварийного восстановления.
      
1. Подключите тома аварийного восстановления к единице крупного экземпляра HANA на сайте аварийного восстановления. 
1. Запустите неактивный рабочий экземпляр SAP HANA.
1. Если вы решили скопировать резервные копии журналов транзакций для сокращения времени RPO, объедините резервные копии журналов транзакций в каталоге только что подключенном аварийного восстановления/hana/logbackups. Не перезаписывайте имеющиеся резервные копии. Скопируйте новые резервные копии, которые не были реплицированы с помощью последней репликации моментального снимка хранилища.
1. Кроме того, можно восстановить отдельные файлы из моментальных снимков, которые не были реплицированы в том /hana/shared/PRD в регионе аварийного восстановления Azure.

Ниже показано, как выполнить восстановление рабочего экземпляра SAP HANA, на основе восстановленного моментального снимка хранилища и доступных резервных копий журнала транзакций.

1. С помощью SAP HANA Studio измените расположение резервной копии на расположение **/hana/logbackups**.

   ![Изменение расположения резервных копий для Аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/change_backup_location_dr1.png)

1. SAP HANA проверит расположения файлов резервных копий и предложит для восстановления самую последнюю резервную копию журналов транзакций. Проверка может занять несколько минут, после экран, как показано отображаются следующие сведения:

   ![Список резервных копий журналов транзакций для Аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/backup_list_dr2.PNG)

1. Настройте некоторые параметры по умолчанию:

      - снимите флажок **Use Delta Backups** (Использовать разностные резервные копии);
      - установите флажок **Initialize Log Area** (Инициализировать область журнала).

   ![Выбор инициализации области журнала](./media/hana-overview-high-availability-disaster-recovery/initialize_log_dr3.PNG)

1. Выберите **Готово**.

   ![Завершение аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/finish_dr4.PNG)

Должно появиться окно хода выполнения, как показано ниже. Помните, что в примере выполняется аварийное восстановление развернутой конфигурации SAP HANA с тремя узлами.

![Ход восстановления](./media/hana-overview-high-availability-disaster-recovery/restore_progress_dr5.PNG)

Если восстановление перестает отвечать на запросы в **Готово** и не отображается на экране хода выполнения Подтвердите, что все экземпляры SAP HANA на рабочих узлах выполняются. При необходимости запустите экземпляры SAP HANA вручную.


## <a name="failback-from-a-dr-to-a-production-site"></a>Восстановление размещения с сайта аварийного восстановления на рабочий сайт
Вы можете выполнить восстановление размещения с сайта аварийного восстановления на рабочий сайт. Рассмотрим сценарий, когда отработка отказа на сайт аварийного восстановления была вызвана проблемами в рабочем регионе Azure, а не вашей потребностью восстановить потерянные данные. 

Вы запустили рабочая нагрузка SAP некоторое время на сайте аварийного восстановления. После устранения проблем на рабочем сайте можно выполнить восстановление размещения. Так как потеря данных недопустима, возвращение на рабочий сайт включает в себя несколько действий и тесное взаимодействие с рабочей группой SAP HANA в Azure. Вы должны связаться с рабочей группой, чтобы она инициировала синхронизацию на рабочий сайт после устранения проблем.

Выполните следующие действия.

1. Рабочая группа SAP HANA в Azure получает сигнал для синхронизации томов рабочего хранилища из томов хранилища аварийного восстановления, которые теперь представляют состояние рабочего сайта. В этом состоянии работа единицы крупного экземпляра HANA на рабочем сайте завершена.
1. SAP HANA в рабочей группе Azure отслеживает репликацию и гарантирует, что оно перехватывается, прежде чем они информируют.
1. Вам необходимо завершить работу приложений, которые используют рабочий экземпляр HANA на сайте аварийного восстановления. Затем вы создадите резервную копию журналов транзакций HANA. Затем нужно остановить экземпляр HANA, который выполняется на единицах крупного экземпляра HANA на сайте аварийного восстановления.
1. После завершения работы экземпляра HANA, который работает в единице крупного экземпляра HANA на сайте аварийного восстановления, рабочая группа вручную синхронизирует тома дисков еще раз.
1. SAP HANA в рабочей группе Azure начнет работу у единицы крупного экземпляра HANA на рабочем сайте. Они передаст ее вам. Убедитесь, что в SAP hana находится в состоянии завершения работы во время запуска единицы крупного экземпляра HANA.
1. Вы выполните те же действия по восстановлению базы данных, которые вы использовали ранее отработке отказа на сайт аварийного восстановления.

## <a name="monitor-disaster-recovery-replication"></a>Мониторинг репликации для аварийного восстановления

Чтобы отслеживать состояние процесса репликации хранилища, запустите сценарий `azure_hana_replication_status`. Эта команда должна выполняться в единице, работающей в расположении аварийного восстановления, чтобы функционировать должным образом. Команда работает независимо от того, активна ли репликация. Команда может выполняться для каждой единицы крупного экземпляра HANA вашего клиента в расположении аварийного восстановления. Он не может использоваться для получения сведений о загрузочном томе. 

Дополнительные сведения о команде и его выходные данные, см. в разделе «Получить состояние репликации для аварийного восстановления — azure_hana_replication_status» в [снимок средства для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.0/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.0.pdf).


## <a name="next-steps"></a>Дальнейшие действия
- См. в разделе [мониторинг и устранение неполадок со стороны HANA](hana-monitor-troubleshoot.md).
