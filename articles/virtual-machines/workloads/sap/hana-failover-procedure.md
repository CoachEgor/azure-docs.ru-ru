---
title: Процедура отработки отказа HANA в расположение аварийного восстановления для SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Сведения о том, как выполнить отработку отказа в расположение аварийного восстановления для SAP HANA в Azure (крупные экземпляры)
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/10/2018
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: ca4d5912d75dd7b33737f61737a209284b7a5a47
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60338554"
---
# <a name="disaster-recovery-failover-procedure"></a>Процедура отработки отказа при аварийном восстановлении


>[!IMPORTANT]
>Эта документация не заменяет документацию по администрированию SAP HANA или примечания SAP. Предполагается, что читатель хорошо понимает принципы администрирования и эксплуатации SAP HANA, особенно принципы резервного копирования, восстановления, обеспечения высокой доступности и аварийного восстановления. В этой документации показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Существует два сценария при отработке отказа на сайт аварийного восстановления:

- Необходимо восстановить последнее состояние данных базы данных SAP HANA. В этом случае предлагается сценарий самообслуживания, который позволяет выполнять отработку отказа без необходимости обращения в корпорацию Майкрософт. Однако, чтобы восстановить размещение, все же нужно обратиться в корпорацию Майкрософт.
- Требуется выполнить восстановление на основе моментального снимка хранилища, который не является последним реплицированным моментальным снимком. В этом случае следует обратиться в корпорацию Майкрософт. 

>[!NOTE]
>Шаги ниже необходимо выполнить на экземпляре HANA (крупные экземпляры), который представляет собой экземпляр аварийного восстановления. 
 
Чтобы выполнить восстановление на основе последних реплицированных моментальных снимков, выполните следующие действия: 

1. Завершите работу нерабочего экземпляра HANA, запущенного на единице аварийного восстановления крупных экземпляров HANA. Предполагается наличие предварительно установленного неактивного рабочего экземпляра HANA.
1. Остановите все процессы SAP HANA. Для проверки используйте команду `/usr/sap/hostctrl/exe/sapcontrol –nr <HANA instance number> - function GetProcessList`. В выходных данных должен быть указан остановленный процесс **hdbdaemon** и должны отсутствовать какие-либо другие работающие или запущенные процессы HANA.
1. В экземпляре HANA (крупные экземпляры) на сайте аварийного восстановления выполните сценарий *azure_hana_dr_failover.pl*. Сценарий запросит восстановление идентификатора безопасности SAP HANA. При запросе введите один или единственный реплицированный идентификатор безопасности SAP HANA, сохраненный в файле *HANABackupCustomerDetails.txt* в экземпляре HANA (крупные экземпляры) на сайте аварийного восстановления. 

      Если вы хотите выполнить отработку отказа нескольких экземпляров SAP HANA, необходимо запустить сценарий несколько раз. По запросу введите идентификатор безопасности SAP HANA, для которого требуется выполнить отработку отказа и восстановление. По выполнении сценария появится список точек подключения томов, добавленных к единице HANA (крупные экземпляры). В этом списке также есть восстановленные тома аварийного восстановления.

1. Подключите восстановленные тома аварийного восстановления, выполнив команды операционной системы Linux, к экземпляру HANA (крупные экземпляры) на сайте аварийного восстановления. 
1. Запустите неактивный рабочий экземпляр SAP HANA.
1. Если вы решили скопировать резервные копии журналов транзакций, чтобы уменьшить значение целевой точки восстановления, необходимо объединить эти резервные копии в только что подключенном каталоге аварийного восстановления /hana/logbackups. Не перезаписывайте имеющиеся резервные копии. Скопируйте новые резервные копии, которые еще не были реплицированы.
1. Кроме того, можно восстановить отдельные файлы из моментальных снимков, реплицированных в том /hana/shared/PRD в регионе аварийного восстановления Azure. 

Кроме того, можно протестировать отработку отказа аварийного восстановления без ущерба для фактической связи репликации. Чтобы выполнить тестовую отработку отказа, выполните шаги 1 и 2, приведенные выше, а затем выполните приведенный ниже шаг 3.

>[!IMPORTANT]
>Не *запускайте* рабочие транзакции на экземпляре, созданном на сайте аварийного восстановления, в процессе **тестирования отработки отказа** со сценарием, представленным на шаге 3. Эта команда создает набор томов, не связанных с основным сайтом. В результате синхронизация с основным сайтом *невозможна*. 

Шаг 3 для проверки отработки отказа

В экземпляре HANA (крупные экземпляры) на сайте аварийного восстановления выполните сценарий **azure_hana_test_dr_failover.pl**. Этот сценарий *не* останавливает связь репликации между основным сайтом и сайтом аварийного восстановления. Вместо этого сценарий клонирует тома хранилища аварийного восстановления. После успешного клонирования клонированные тома восстанавливаются к состоянию последнего моментального снимка и подключаются к экземпляру аварийного восстановления. Сценарий запросит восстановление идентификатора безопасности SAP HANA. Введите один или единственный реплицированный идентификатор безопасности SAP HANA, сохраненный в файле *HANABackupCustomerDetails.txt* в экземпляре HANA (крупные экземпляры) на сайте аварийного восстановления. 

Если вы хотите проверить несколько экземпляров SAP HANA, необходимо запустить сценарий несколько раз. По запросу введите идентификатор безопасности SAP HANA, для которого требуется протестировать отработку отказа. По выполнении сценария появится список точек подключения томов, добавленных к единице HANA (крупные экземпляры). В этом списке также есть клонированные тома аварийного восстановления.

Перейдите к шагу 4.

   >[!NOTE]
   >Если вам нужно выполнить отработку отказа на сайт аварийного восстановления для восстановления данных, удаленных несколько часов назад, и задать для томов аварийного восстановления состояние более раннее, чем в последнем моментальном снимке, примените эту процедуру. 

1. Завершите работу нерабочего экземпляра HANA, запущенного на единице аварийного восстановления крупных экземпляров HANA. Предполагается наличие предварительно установленного неактивного рабочего экземпляра HANA.
1. Остановите все процессы SAP HANA. Для проверки используйте команду `/usr/sap/hostctrl/exe/sapcontrol –nr <HANA instance number> - function GetProcessList`. В выходных данных должен быть указан остановленный процесс **hdbdaemon** и должны отсутствовать какие-либо другие работающие или запущенные процессы HANA.
1. Определите имя моментального снимка или идентификатор резервного копирования SAP HANA для восстановления на сайте аварийного восстановления. В реальных ситуациях аварийного восстановления, как правило, это последний моментальный снимок. Если необходимо восстановить потерянные данные, выберите более ранний снимок.
1. Обратитесь в службу поддержки Azure, отправив запрос на техническую поддержку с высоким приоритетом. Запросите восстановление с помощью этого моментального снимка (имя и дата создания снимка) или идентификатора резервного копирования HANA на сайте аварийного восстановления. Если этого не сделать, отдел эксплуатации восстановит только том /hana/data. Если вы хотите восстановить тома /hana/logbackups, вам необходимо обозначить это в запросе. *Не восстанавливайте том /hana/shared.* Вместо этого после повторного подключения тома /hana/shared для PRD нужно выбрать определенные файлы, такие как global.ini, из каталога **.snapshot** и его подкаталогов. 

   На стороне отдела эксплуатации произойдет следующее:

   a. Репликация моментальных снимков из рабочего тома на тома аварийного восстановления остановится. Такое прерывание уже могло произойти, если появилась необходимость выполнить аварийное восстановление из-за сбоя на рабочем сайте.
   
   2. На томах аварийного восстановления будет восстановлен выбранный моментальный снимок с идентификатором резервного копирования или моментальный снимок хранилища с указанным именем.
   
   c. После завершения восстановления данных тома аварийного восстановления становятся доступны для подключения к единицам крупных экземпляров HANA в регионе аварийного восстановления.
      
1. Подключите тома аварийного восстановления к единице крупного экземпляра HANA на сайте аварийного восстановления. 
1. Запустите неактивный рабочий экземпляр SAP HANA.
1. Если вы решили скопировать резервные копии журналов транзакций, чтобы уменьшить значение целевой точки восстановления, необходимо объединить эти резервные копии в только что подключенном каталоге аварийного восстановления /hana/logbackups. Не перезаписывайте имеющиеся резервные копии. Скопируйте новые резервные копии, которые еще не были реплицированы.
1. Кроме того, можно восстановить отдельные файлы из моментальных снимков, реплицированных в том /hana/shared/PRD в регионе аварийного восстановления Azure.

Следующая последовательность действий включает в себя восстановление рабочего экземпляра SAP HANA на основе восстановленного моментального снимка хранилища и доступных резервных копий журналов транзакций.

1. С помощью SAP HANA Studio измените расположение резервной копии на расположение **/hana/logbackups**.
   ![Изменение расположения резервной копии для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/change_backup_location_dr1.png)

1. SAP HANA проверит расположения файлов резервных копий и предложит для восстановления самую последнюю резервную копию журналов транзакций. Проверка может занять несколько минут, после экран, как показано отображаются следующие сведения: ![Список резервных копий журналов транзакций для Аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/backup_list_dr2.PNG)

1. Настройте некоторые параметры по умолчанию:

      - снимите флажок **Use Delta Backups** (Использовать разностные резервные копии);
      - установите флажок **Initialize Log Area** (Инициализировать область журнала).

   ![Выбор инициализации области журнала](./media/hana-overview-high-availability-disaster-recovery/initialize_log_dr3.PNG)

1. Выберите **Готово**.

   ![Завершение аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/finish_dr4.PNG)

Должно появиться окно хода выполнения, как показано ниже. Помните, что в примере выполняется аварийное восстановление развернутой конфигурации SAP HANA с тремя узлами.

![Ход восстановления](./media/hana-overview-high-availability-disaster-recovery/restore_progress_dr5.PNG)

Если кажется, что восстановление может перестать отвечать на **Готово** экрана и не отображается на экране хода выполнения, убедитесь, что выполняются все экземпляры SAP HANA на рабочих узлах. При необходимости запустите экземпляры SAP HANA вручную.


## <a name="failback-from-a-dr-to-a-production-site"></a>Восстановление размещения с сайта аварийного восстановления на рабочий сайт
Вы можете выполнить восстановление размещения с сайта аварийного восстановления на рабочий сайт. Рассмотрим сценарий, когда отработка отказа на сайт аварийного восстановления была вызвана проблемами в рабочем регионе Azure, а не вашей потребностью восстановить потерянные данные. Некоторое время на сайте аварийного восстановления выполнялась рабочая нагрузка SAP. После устранения проблем на рабочем сайте можно выполнить восстановление размещения. Так как потеря данных недопустима, возвращение на рабочий сайт включает в себя несколько действий и тесное взаимодействие с рабочей группой SAP HANA в Azure. Вы должны связаться с рабочей группой, чтобы она инициировала синхронизацию на рабочий сайт после устранения проблем.

Последовательность действий при этом следующая:

1. Рабочая группа SAP HANA в Azure получает сигнал для синхронизации томов рабочего хранилища из томов хранилища аварийного восстановления, которые теперь представляют состояние рабочего сайта. В этом состоянии работа единицы крупного экземпляра HANA на рабочем сайте завершена.
1. Рабочая группа SAP HANA в Azure отслеживает репликацию и обеспечивает актуальность данных, а затем информирует клиентов.
1. Вам необходимо завершить работу приложений, которые используют рабочий экземпляр HANA на сайте аварийного восстановления. Затем вы создадите резервную копию журналов транзакций HANA. Затем нужно остановить экземпляр HANA, запущенный на единицах крупного экземпляра HANA на сайте аварийного восстановления.
1. После завершения работы экземпляра HANA, работавшего на единице крупного экземпляра HANA на сайте аварийного восстановления, рабочая группа вручную повторно синхронизирует тома дисков.
1. Она снова запустит единицу крупного экземпляра HANA на рабочем сайте и передаст ее вам. Убедитесь, что в момент запуска единицы крупного экземпляра HANA работа экземпляра SAP HANA завершена.
1. Вы выполните те же действия по восстановлению базы данных, которые вы выполняли ранее при отработке отказа на сайт аварийного восстановления.

## <a name="monitor-disaster-recovery-replication"></a>Мониторинг репликации для аварийного восстановления

Вы можете наблюдать за состоянием процесса репликации хранилища, выполнив сценарий `azure_hana_replication_status.pl`. Этот сценарий нужно выполнить в единице, работающей в расположении аварийного восстановления. В противном случае он не будет работать должным образом. Этот сценарий работает независимо от того, активна ли репликация. Этот сценарий может выполняться для каждой единицы крупного экземпляра HANA вашего клиента в расположении аварийного восстановления. С его помощью невозможно получить сведения о загрузочном томе.

Вызовите сценарий с помощью следующей команды:
```
./azure_hana_replication_status.pl
```

Выходные данные разбиты по томам на следующие разделы:  

- состояние канала;
- текущая операция репликации;
- последний реплицированный моментальный снимок; 
- размер последнего моментального снимка;
- текущий интервал задержки между моментальными снимками (между последней выполненной репликацией моментального снимка и текущим моментом).

Если канал между расположениями находится в работоспособном состоянии или в данный момент не выполняется отработка отказа, то отображается состояние канала **Активный**. Под операцией репликации подразумевается репликация каких-либо данных, которая выполняется сейчас либо неактивна, а также другие операции с каналом, выполняемые в данный момент. Последний реплицированный моментальный снимок должен отображаться только как `snapmirror…`. Затем отображается размер последнего моментального снимка. Наконец, отображается интервал задержки. Интервал задержки — это разница между временем завершения репликации и запланированным временем репликации. Интервал задержки может составлять больше часа для репликации данных, особенно при первоначальной репликации, даже если репликация запущена. Интервал задержки будет увеличиваться, пока не будет завершена текущая репликация.

Выходные данные могут выглядеть так:

```
hana_data_hm3_mnt00002_t020_dp
-------------------------------------------------
Link Status: Broken-Off
Current Replication Activity: Idle
Latest Snapshot Replicated: snapmirror.c169b434-75c0-11e6-9903-00a098a13ceb_2154095454.2017-04-21_051515
Size of Latest Snapshot Replicated: 244KB
Current Lag Time between snapshots: -   ***Less than 90 minutes is acceptable***
```

**Дальнейшие действия**
- См. статью о [мониторинге и устранении неполадок со стороны HANA](hana-monitor-troubleshoot.md).
