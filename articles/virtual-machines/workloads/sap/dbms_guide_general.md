---
title: Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure | Документы Майкрософт
description: Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure
services: virtual-machines-linux,virtual-machines-windows
documentationcenter: ''
author: msjuergent
manager: patfilot
editor: ''
tags: azure-resource-manager
keywords: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/04/2018
ms.author: juergent
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: a852ddc68a6f51e677e5ff2e641ada25f4bf0105
ms.sourcegitcommit: 44e85b95baf7dfb9e92fb38f03c2a1bc31765415
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70101362"
---
# <a name="considerations-for-azure-virtual-machines-dbms-deployment-for-sap-workload"></a>Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure
[1114181]: https://launchpad.support.sap.com/#/notes/1114181
[1409604]: https://launchpad.support.sap.com/#/notes/1409604
[1597355]: https://launchpad.support.sap.com/#/notes/1597355
[1928533]: https://launchpad.support.sap.com/#/notes/1928533
[1984787]: https://launchpad.support.sap.com/#/notes/1984787
[1999351]: https://launchpad.support.sap.com/#/notes/1999351
[2002167]: https://launchpad.support.sap.com/#/notes/2002167
[2015553]: https://launchpad.support.sap.com/#/notes/2015553
[2039619]: https://launchpad.support.sap.com/#/notes/2039619
[2069760]: https://launchpad.support.sap.com/#/notes/2069760
[2171857]: https://launchpad.support.sap.com/#/notes/2171857
[2178632]: https://launchpad.support.sap.com/#/notes/2178632
[2191498]: https://launchpad.support.sap.com/#/notes/2191498
[2233094]: https://launchpad.support.sap.com/#/notes/2233094
[2243692]: https://launchpad.support.sap.com/#/notes/2243692
[deployment-guide]:deployment-guide.md
[deployment-guide-3]:deployment-guide.md#b3253ee3-d63b-4d74-a49b-185e76c4088e
[planning-guide]:planning-guide.md

[Logo_Linux]:media/virtual-machines-shared-sap-shared/Linux.png
[Logo_Windows]:media/virtual-machines-shared-sap-shared/Windows.png


[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-rm-include.md)]

Это руководство является частью документации по внедрению и развертыванию программного обеспечения SAP на Microsoft Azure. Перед прочтением этого руководством ознакомьтесь с [руководством по планированию и внедрению][planning-guide]. В этом документе рассматриваются общие аспекты развертывания систем СУБД, связанных с SAP, на Microsoft Azure виртуальных машинах (ВМ) с помощью возможностей инфраструктуры Azure как услуги (IaaS).

Статья дополняет документацию по установке SAP и заметки SAP, которые представляют основные ресурсы для установки и развертывания программного обеспечения SAP на указанных платформах.

В этом документе рассматриваются вопросы запуска связанных с SAP систем СУБД на виртуальных машинах Azure. Также здесь приводятся ссылки на конкретные СУБД. Вместо этого в настоящем документе после этого документа будут обрабатываться определенные системы СУБД.

## <a name="definitions"></a>Определения
На протяжении всего документа используются следующие термины:

* **IaaS**: Инфраструктура как услуга.
* **PaaS**: Платформа как услуга.
* **SaaS**: Программное обеспечение как услуга.
* **Компонент SAP**: Отдельное приложение SAP, например "ERP Central" (ECC), Business Warehouse (BW), диспетчер решений или Enterprise Portal (EP). Компоненты SAP могут основываться на традиционных технологиях ABAP или Java или в приложении, не основанном на NetWeaver, например в бизнес-объектах.
* **Среда SAP**: Один или несколько компонентов SAP, логически сгруппированных для выполнения бизнес-функций, таких как разработка, контроль качества, обучение, аварийное восстановление или рабочая среда.
* **Ландшафт SAP**: этот термин обозначает все ресурсы SAP, доступные в клиентском ИТ-ландшафте. Альбом SAP включает все производственные и непроизводственные среды.
* **Система SAP**: Сочетание уровня СУБД и уровня приложения, например системы разработки SAP ERP, системы тестирования SAP Business Warehouse или рабочей системы SAP CRM. В развертываниях Azure разделение этих двух уровней между локальной средой и Azure не поддерживается. В результате система SAP либо развертывается локально, либо разворачивается в Azure. Вы можете развернуть разные системы SAP в Azure или в локальной среде. Например, можно развернуть системы разработки и тестирования SAP CRM в Azure, но развернуть рабочую систему SAP CRM в локальной среде.
* **Между организациями**: Описание сценария, в котором виртуальные машины развертываются в подписке Azure с подключением типа "сеть — сеть", несколькими сайтами или Azure ExpressRoute между локальными центрами обработки данных и Azure. В документации Azure развертывания такого рода также называются распределенными развертываниями. 

    Такое подключение используется для расширения в Azure локальных доменов, локальной службы Active Directory и локальной службы DNS. Локальная среда распространяется на ресурсы Azure, входящие в подписку. При таком расширении виртуальные машины могут быть частью локального домена. Пользователи домена локального домена могут получать доступ к серверам и запускать службы на этих виртуальных машинах, например службы СУБД. Возможно взаимодействие и разрешение имен между виртуальными машинами, развернутыми в локальной сети и Azure. Этот сценарий является наиболее распространенным сценарием, используемым для развертывания ресурсов SAP в Azure. Дополнительные сведения см. в разделе [Планирование и проектирование VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-plan-design).

> [!NOTE]
> Распределенные развертывания систем SAP — это место, где виртуальные машины Azure, на которых работают системы SAP, являются членами локального домена и поддерживаются в производственных системах SAP. Распределенная конфигурация предполагает развертывание в Azure полного ландшафта SAP или его частей. Даже при выполнении полной ландшафтной среды SAP в Azure эти виртуальные машины должны быть частью локального домена, а Active Directory/LDAP. 
>
> В предыдущих версиях документации были упомянуты гибридные сценарии. Понятие *гибридного* развертывания основано на том факте, что между локальной средой и Azure существует распределенное подключение. В этом случае гибридное также означает, что виртуальные машины в Azure являются частью локальной Active Directory.
>
>

В некоторых документах Майкрософт несколько локальных сценариев описаны по-разному, особенно для конфигураций с высоким уровнем доступности СУБД. В случае с документами, связанными с SAP, межорганизационный сценарий сводится к подключению типа "сеть — сеть" или частному каналу [ExpressRoute](https://azure.microsoft.com/services/expressroute/) , а также к альбому SAP, распределенному между локальной средой и Azure.

## <a name="resources"></a>Ресурсы
Существуют и другие статьи, доступные в рабочей нагрузке SAP в Azure. Начните с [рабочей нагрузки SAP в Azure: Начните работу](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/get-started) , а затем выберите интересующую вас область.

Следующие примечания SAP относятся к SAP в Azure в отношении области, описываемой в этом документе.

| Номер примечания | Заголовок |
| --- | --- |
| [1928533] |Приложения SAP в Azure: поддерживаемые продукты и типы виртуальных машин Azure |
| [2015553] |SAP в Microsoft Azure: необходимые компоненты для поддержки |
| [1999351] |Устранение неполадок, связанных с расширенным мониторингом Azure для SAP |
| [2178632] |Ключевые метрики мониторинга для SAP в Microsoft Azure |
| [1409604] |Виртуализация в Windows: расширенный мониторинг |
| [2191498] |SAP на платформе Linux в Azure: расширенный мониторинг |
| [2039619] |Приложения SAP в Microsoft Azure с использованием Oracle Database: поддерживаемые продукты и версии |
| [2233094] |DB6: Приложения SAP в Azure с использованием IBM DB2 для Linux, UNIX и Windows: Дополнительные сведения |
| [2243692] |Linux на виртуальной машине Microsoft Azure (IaaS): проблемы с лицензированием SAP |
| [1984787] |SUSE Linux Enterprise Server 12 Замечания по установке |
| [2002167] |Red Hat Enterprise Linux 7.x: Установка и обновление |
| [2069760] |Установка и обновление Oracle Linux 7.x SAP |
| [1597355] |Рекомендация по области буфера для Linux |
| [2171857] |Oracle Database 12c: Поддержка файловой системы в Linux |
| [1114181] |Oracle Database 11g: Поддержка файловой системы в Linux |


Сведения обо всех примечаниях SAP для Linux см. на [вики-сайте сообщества SAP](https://wiki.scn.sap.com/wiki/display/HOME/SAPonLinuxNotes).

Вам потребуются знания архитектуры Microsoft Azure и процесса развертывания и эксплуатации Microsoft Azure виртуальных машин. Дополнительные сведения см. в [документации по Azure](https://docs.microsoft.com/azure/).

Как правило, установка и настройка Windows, Linux и СУБД по сути являются такими же, как и для любой виртуальной машины или компьютера без операционной системы, установленного локально. Существуют решения по реализации архитектуры и управления системой, которые отличаются при использовании Azure IaaS. В этом документе объясняются конкретные различия в архитектуре и управлении системой, которые должны быть подготовлены при использовании Azure IaaS.


## <a name="65fa79d6-a85f-47ee-890b-22e794f51a64"></a>Структура хранилища виртуальной машины для развертываний RDBMS
Чтобы проследить эту главу, прочитайте и изучите информацию, представленную в [этой главе][deployment-guide-3] [руководств по развертыванию][deployment-guide]. Прежде чем читать эту главу, необходимо ознакомиться с различными сериями виртуальных машин и отличиями между хранилищем уровня "Стандартный" и "Премиум". 

Дополнительные сведения о службе хранилища Azure для виртуальных машин Azure см. в следующих статьях:

- [Общие сведения об управляемых дисках для виртуальных машин Windows в Azure](../../windows/managed-disks-overview.md).
- [Общие сведения об управляемых дисках для виртуальных машин Linux в Azure](../../linux/managed-disks-overview.md).

В базовой конфигурации обычно рекомендуется использовать структуру развертывания, в которой операционная система, СУБД и конечные двоичные файлы SAP отделены от файлов базы данных. Рекомендуется, чтобы системы SAP, работающие на виртуальных машинах Azure, имели базовый VHD или диск, установленный с операционной системой, исполняемыми файлами системы управления базами данных и исполняемыми файлами SAP. 

Файлы данных и журналов СУБД хранятся в хранилище класса "Стандартный" или "Премиум". Они хранятся на разных дисках и присоединяются в качестве логических дисков к исходной виртуальной машине образа операционной системы Azure. Для развертываний Linux документированы различные рекомендации, особенно для SAP HANA.

При планировании структуры диска найдите оптимальный баланс между этими элементами:

* Количество файлов данных.
* Число дисков, содержащих файлы.
* Количество операций ввода-вывода для одного диска.
* Пропускная способность каждого диска.
* Количество дополнительных доступных дисков в зависимости от размера виртуальной машины.
* Общая пропускная способность хранилища, которую может предоставить виртуальная машина.
* Задержка для различных типов хранилища Azure.
* Соглашения об уровне обслуживания виртуальной машины.

Azure обеспечивает квоту на количество операций ввода-вывода для каждого диска данных. Эти квоты отличаются для дисков, размещенных в хранилище уровня "Стандартный" и "Премиум". Задержка ввода-вывода для двух типов хранилищ также различается. Хранилище класса Premium обеспечивает лучшую задержку операций ввода-вывода. 

Каждый из различных типов виртуальных машин имеет ограниченное количество дисков данных, которые можно подключить. Еще одно ограничение заключается в том, что хранилище класса Premium может использоваться только определенными типами виртуальных машин. Как правило, вы решаете использовать определенный тип виртуальной машины на основе требований к ЦП и памяти. Вы также можете рассмотреть требования к операциям ввода-вывода, задержкам и пропускной способности диска, которые обычно масштабируются с учетом количества дисков или типа дисков хранилища класса Premium. Количество операций ввода-вывода и пропускная способность, которые должны быть достигнуты каждым диском, могут зависеть от размера диска, особенно с хранилищем класса Premium.

> [!NOTE]
> Для развертываний СУБД рекомендуется использовать хранилище класса Premium для любых данных, журналов транзакций или файлов повтора. Не имеет значения, следует ли развертывать производственные или непроизводственные системы.

> [!NOTE]
> Чтобы воспользоваться уникальным [соглашением об уровне обслуживания для отдельной виртуальной машины](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_8/)Azure, все подключенные диски должны иметь тип хранилища Premium, который включает базовый виртуальный жесткий диск.

> [!NOTE]
> Размещение основных файлов базы данных, таких как файлы данных и журналов, баз данных SAP на оборудовании хранилища, расположенном в совместно расположенных сторонних центрах обработки данных, расположенных рядом с центрами обработки данных Azure, не поддерживается. Для рабочих нагрузок SAP только хранилище, представленное как собственная служба Azure, поддерживается для файлов данных и журналов транзакций баз данных SAP.

Размещение файлов базы данных и файлов журнала и повтора, а также тип используемой службы хранилища Azure определяется в соответствии с требованиями к операциям ввода-вывода, задержкам и пропускной способности. Чтобы иметь достаточное количество операций ввода-вывода, возможно, придется использовать несколько дисков или диск хранилища класса Premium. При использовании нескольких дисков создайте программную полосу на дисках, содержащих файлы данных, а также файлы журнала и повторы. В таких случаях операции ввода-вывода и соглашения об уровне обслуживания для базовых дисков хранилища класса Premium или максимальных доступных операций ввода-вывода в секунду для дисков хранилища уровня "Стандартный" являются совокупными для результирующего набора томов.

Как уже отмечалось, если потребность в операциях ввода-вывода превышает то, что может предоставить один виртуальный жесткий диск, следует сбалансировать количество операций ввода/вывода, необходимое для файлов базы данных в ряде виртуальных жестких дисков. Самый простой способ распределить нагрузку операций ввода-вывода на диски — создать программную полосу на разных дисках. Затем поместите несколько файлов данных СУБД SAP в LUN, отрезать пространство из программной полосы. Количество дисков в чередующемся наборе данных зависит от требований операций ввода-вывода в секунду, требований к пропускной способности диска и требований тома.


---
> ![Windows][Logo_Windows] Windows
>
> Мы рекомендуем использовать дисковые пространства Windows для создания чередующихся наборов на нескольких виртуальных жестких дисках Azure. Используйте как минимум Windows Server 2012 R2 или Windows Server 2016.
>
> ![Linux][Logo_Linux] Linux
>
> Для создания программного RAID-массива в Linux поддерживаются только MDADM и Диспетчер логических томов (LVM). Дополнительные сведения можно найти в разделе
>
> - [Настройка программного RAID-массива в Linux](https://docs.microsoft.com/azure/virtual-machines/linux/configure-raid) с помощью MDADM
> - [Настройка диспетчера логических томов на виртуальной машине Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/configure-lvm) с помощью диспетчера логических томов
>
>

---

> [!NOTE]
> Так как служба хранилища Azure сохраняет три образа виртуальных жестких дисков, при чередовании не имеет смысла настраивать избыточность. Для распределения операций ввода-вывода по разным виртуальным жестким дискам необходимо настроить чередование.
>

### <a name="managed-or-nonmanaged-disks"></a>Управляемые или неуправляемые диски
Учетная запись хранения Azure — это административная конструкция, которая также является предметом ограничений. Ограничения различаются учетными записями хранения уровня "Стандартный" и "Премиум". Сведения о возможностях и ограничениях см. в статье [целевые показатели масштабируемости и производительности службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-scalability-targets).

Помните, что для хранилища уровня "Стандартный" существует ограничение на количество операций ввода-вывода в секунду на учетную запись хранения. См. строку, содержащую **общую частоту запросов** , в статье [целевые показатели масштабируемости и производительности службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-scalability-targets). Также имеется начальное ограничение на количество учетных записей хранения на одну подписку Azure. Выполняйте балансировку виртуальных жестких дисков для более крупной сети SAP в разных учетных записях хранения, чтобы избежать ограничения этих учетных записей хранения. Это утомительная работа, когда речь идет о нескольких сотнях виртуальных машин с более чем тысячами виртуальных жестких дисков.

Так как использовать хранилище уровня "Стандартный" для развертываний СУБД в сочетании с рабочей нагрузкой SAP не рекомендуется, ссылки и рекомендации для хранилища уровня "Стандартный" ограничиваются этой короткой [статьей](https://blogs.msdn.com/b/mast/archive/2014/10/14/configuring-azure-virtual-machines-for-optimal-storage-performance.aspx) .

Чтобы избежать административной работы по планированию и развертыванию виртуальных жестких дисков в разных учетных записях хранения Azure, корпорация Майкрософт предоставила [управляемые диски Azure](https://azure.microsoft.com/services/managed-disks/) в 2017. Управляемые диски доступны для хранилища класса "Стандартный" и "Премиум". Ниже перечислены основные преимущества управляемых дисков по сравнению с неуправляемыми дисками.

- Для управляемых дисков Azure автоматически распределяет разные виртуальные жесткие диски в разных учетных записях хранения во время развертывания. Таким образом, ограничения учетной записи хранения для объема данных, пропускной способности ввода-вывода и операций чтения не будут достигнуты.
- Используя управляемые диски, служба хранилища Azure учитывает концепции групп доступности Azure. Если виртуальная машина входит в группу доступности Azure, базовый VHD и подключенный диск виртуальной машины развертываются в разных доменах сбоя и обновления.


> [!IMPORTANT]
> Учитывая преимущества управляемых дисков Azure, мы рекомендуем использовать управляемые диски Azure для развертывания СУБД и развертываний SAP в целом.
>

Сведения о преобразовании из неуправляемых дисков в управляемые см. в следующих статьях:

- [Преобразование виртуальной машины Windows из неуправляемых дисков в управляемые диски](https://docs.microsoft.com/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks).
- [Преобразование виртуальной машины Linux с неуправляемых дисков на управляемые диски](https://docs.microsoft.com/azure/virtual-machines/linux/convert-unmanaged-to-managed-disks).


### <a name="c7abf1f0-c927-4a7c-9c1d-c7b5b3b7212f"></a>Кэширование для виртуальных машин и дисков данных
При подключении дисков к виртуальным машинам можно выбрать, будет ли кэшироваться трафик ввода-вывода между виртуальной машиной и дисками, расположенными в хранилище Azure. Хранилище уровня "Стандартный" и "Премиум" используют две различные технологии для этого типа кэша.

Следующие рекомендации предполагают, что эти характеристики ввода-вывода для стандартных СУБД:

- В основном это рабочая нагрузка для чтения файлов данных базы данных. Эти операции чтения являются критически важными для системы СУБД.
- Запись в файлы данных происходит в пакетах на основе контрольных точек или постоянного потока. В среднем за день число операций записи меньше, чем количество операций чтения. В отличие от операций чтения из файлов данных, эти операции записи являются асинхронными и не сохраняют никаких пользовательских транзакций.
- Вряд ли возникнут другие ситуации, когда понадобится чтение из журнала транзакций или файлов повторных операций. Исключения — это большие операции ввода-вывода при выполнении резервного копирования журнала транзакций.
- Записывается основная нагрузка на транзакции или файлы журнала повтора. В зависимости от природы рабочей нагрузки можно установить объем ввода-вывода в 4 КБ, а в других случаях — 1 МБ или больше.
- Все операции записи должны сохраняться на диске надежным способом.

Для хранилища уровня "Стандартный" возможны следующие типы кэша:

* Отсутствуют
* Чтение
* Чтение/запись

Чтобы получить постоянную и детерминированную производительность, установите кэширование для хранилища уровня "Стандартный" для всех дисков, содержащих файлы данных, связанные с СУБД, файлы журнала и повторяемости, а также табличное пространство, равное **None**. Для параметров кэширования основного виртуального жесткого диска можно оставить значения по умолчанию.

Для хранилища класса Premium существуют следующие параметры кэширования.

* Отсутствуют
* Чтение
* Чтение/запись
* Нет + Ускоритель записи, который предназначен только для виртуальных машин Azure серии M.
* Чтение и Ускоритель записи, которые доступны только для виртуальных машин Azure серии M.

Для хранилища класса Premium рекомендуется использовать **Кэширование чтения для файлов данных** базы данных SAP и выбрать **отсутствие кэширования для дисков с файлами журналов**.

Для развертываний серии M рекомендуется использовать Ускоритель записи Azure для развертывания СУБД. Дополнительные сведения, ограничения и развертывание Ускоритель записи Azure см. в разделе [включение ускоритель записи](https://docs.microsoft.com/azure/virtual-machines/windows/how-to-enable-write-accelerator).


### <a name="azure-nonpersistent-disks"></a>Непостоянные диски Azure
Виртуальные машины Azure предлагают непостоянные диски после развертывания виртуальной машины. В случае перезагрузки виртуальной машины все содержимое этих дисков уничтожается. Это то, что файлы данных и файлы журналов и повторов баз данных не должны располагаться на этих нематериализованных дисках. Могут возникнуть исключения для некоторых баз данных, где эти несохраняемые диски могут подойти для tempdb и временных табличных пространств. Избегайте использования этих дисков для виртуальных машин серии A, так как эти нематериализованные диски ограничены пропускной способностью с этим семейством виртуальных машин. 

Дополнительные сведения см. в статье сведения о [временном диске на виртуальных машинах Windows в Azure](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/).

---
> ![Windows][Logo_Windows] Windows
>
> Диск D в виртуальной машине Azure — это несохраняемый диск, который поддерживается некоторыми локальными дисками на кластерном узле Azure. При перезагрузке виртуальной машины все изменения, внесенные в содержимое диска D, будут потеряны из-за неустойчивых изменений. Изменения включают файлы, которые были сохранены, каталоги, которые были созданы, и установленные приложения.
>
> ![Linux][Logo_Linux] Linux
>
> Виртуальные машины Azure Linux автоматически подключаются к диску/mnt/Resource, который является несохраняемым диском, поддерживаемым локальными дисками на кластерном узле Azure. Так как она не сохранена, любые изменения, вносимые в содержимое в/mnt/Resource, теряются при перезагрузке виртуальной машины. Изменения включают файлы, которые были сохранены, каталоги, которые были созданы, и установленные приложения.
>
>

---



### <a name="10b041ef-c177-498a-93ed-44b3441ab152"></a>Устойчивость службы хранилища Microsoft Azure
Служба хранилища Microsoft Azure сохраняет базовый виртуальный жесткий диск с ОС и подключенными дисками или большими двоичными объектами по крайней мере на трех разных узлах хранилища. Этот тип хранилища называется локально избыточным хранилищем (LRS). LRS используется по умолчанию для всех типов хранилища в Azure.

Существуют и другие методы избыточности. Дополнительные сведения см. в статье [Репликация службы хранилища Azure](https://docs.microsoft.com/azure/storage/common/storage-redundancy?toc=%2fazure%2fstorage%2fqueues%2ftoc.json).

> [!NOTE]
>Хранилище класса Premium — это рекомендуемый тип хранилища для виртуальных машин и дисков СУБД, в которых хранятся файлы базы данных, журналы и повторы. Единственным доступным методом избыточности для хранилища класса Premium является LRS. В результате необходимо настроить методы базы данных, чтобы включить репликацию данных базы данных в другой регион Azure или зону доступности. К методам базы данных относятся SQL Server Always On, Oracle Data Guard и репликация системы HANA.


> [!NOTE]
> Для развертываний СУБД использование геоизбыточного хранилища (GRS) не рекомендуется для хранилища класса Standard. GRS серьезно влияет на производительность и не учитывает порядок записи на разных виртуальных жестких дисках, подключенных к виртуальной машине. Отсутствие учета порядка записи на разных виртуальных жестких дисках потенциально приводит к несогласованности баз данных на стороне цели репликации. Такая ситуация возникает, если файлы базы данных и журнала, а также повторы распределяются по нескольким виртуальным жестким дискам, как правило, на стороне исходной виртуальной машины.



## <a name="vm-node-resiliency"></a>Устойчивость узлов виртуальной машины
Azure предлагает несколько различных соглашений об уровне обслуживания для виртуальных машин. Дополнительные сведения см. в последнем выпуске [соглашения об уровне обслуживания для виртуальных машин](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_8/). Поскольку уровень СУБД обычно является критически важным для обеспечения доступности в системе SAP, необходимо понимать группы доступности, зоны доступности и события обслуживания. Дополнительные сведения об этих понятиях см. в статьях [Управление доступностью виртуальных машин Windows в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/manage-availability) и [Управление доступностью виртуальных машин Linux в Azure](https://docs.microsoft.com/azure/virtual-machines/linux/manage-availability).

Ниже приведена минимальная рекомендация для сценариев производственных СУБД с рабочей нагрузкой SAP.

- Разверните две виртуальные машины в отдельной группе доступности в одном регионе Azure.
- Запустите эти две виртуальные машины в одной виртуальной сети Azure и поработайте с адаптерами, подключенными к одной подсети.
- Используйте методы базы данных для сервера горячей замены на второй виртуальной машине. Можно использовать такие методы, как SQL Server AlwaysOn, Oracle Data Guard и репликация системы HANA.

Вы также можете развернуть третью виртуальную машину в другом регионе Azure и использовать те же методы базы данных для предоставления асинхронной реплики в другом регионе Azure.

Сведения о настройке групп доступности Azure см. в [этом руководстве](https://docs.microsoft.com/azure/virtual-machines/windows/tutorial-availability-sets).



## <a name="azure-network-considerations"></a>Рекомендации по сети Azure
В крупномасштабных развертываниях SAP используйте план [виртуального центра обработки данных Azure](https://docs.microsoft.com/azure/architecture/vdc/networking-virtual-datacenter). Используйте его для настройки виртуальной сети, а также разрешения и назначения ролей для различных частей Организации.

Эти рекомендации являются результатом сотен развертываний клиентов:

- Виртуальные сети, в которых развернуто приложение SAP, не имеют доступа к Интернету.
- Виртуальные машины базы данных работают в той же виртуальной сети, что и уровень приложения.
- Виртуальные машины в виртуальной сети имеют статическое выделение частного IP-адреса. Дополнительные сведения см. [в разделе Типы IP-адресов и методы распределения в Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm).
- Ограничения маршрутизации для виртуальных машин СУБД и из них *не* устанавливаются с брандмауэрами, установленными на локальных виртуальных машинах СУБД. Вместо этого маршрутизация трафика определяется с помощью [групп безопасности сети (группы безопасности сети)](https://docs.microsoft.com/azure/virtual-network/security-overview).
- Чтобы отделить и изолировать трафик к виртуальной машине СУБД, назначьте виртуальной машине разные сетевые карты. Каждый сетевой адаптер получает другой IP-адрес, и каждая сетевая карта назначается другой подсети виртуальной сети. Каждая подсеть имеет разные правила NSG. Изоляция или разделение сетевого трафика является мерой для маршрутизации. Он не используется для задания квот для пропускной способности сети.

> [!NOTE]
> Назначение статических IP-адресов с помощью Azure означает назначение их отдельным виртуальным сетевым адаптерам. Не присваивайте статические IP-адреса в гостевой ОС виртуальному сетевому адаптеру. Некоторые службы Azure, например Azure Backup, зависят от того факта, что по крайней мере основной виртуальный сетевой адаптер настроен на DHCP, а не на статические IP-адреса. Дополнительные сведения см. в статье [Устранение неполадок резервного копирования виртуальных машин Azure](https://docs.microsoft.com/azure/backup/backup-azure-vms-troubleshoot#networking). Чтобы назначить виртуальной машине несколько статических IP-адресов, назначьте виртуальной машине несколько виртуальных сетевых адаптеров.
>


> [!IMPORTANT]
> Настройка [сетевых виртуальных устройств](https://azure.microsoft.com/solutions/network-appliances/) в пути обмена данными между приложением SAP и уровнем СУБД SAP NetWeaver-, Hybris-или S/4HANA не поддерживается. Это ограничение обусловлено функциональностью и производительностью. Путь взаимодействия между уровнем приложений SAP и уровнем СУБД должен быть прямым. Ограничение не включает в себя [группы безопасности приложений (ASG) и правила NSG](https://docs.microsoft.com/azure/virtual-network/security-overview) , если эти правила ASG и NSG разрешают прямой путь взаимодействия. 
>
> Другие сценарии, в которых виртуальные сетевые устройства не поддерживаются:
>
> * Пути обмена данными между виртуальными машинами Azure, которые представляют узлы кластера Pacemaker и устройства SBD, как описано в статье [высокий уровень доступности SAP NetWeaver на виртуальных машинах Azure на SUSE Linux Enterprise Server для приложений SAP](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/high-availability-guide-suse).
> * Пути обмена данными между виртуальными машинами Azure и Windows Server масштабируемый файловый сервер (SOFS) настроены, как описано в разделе [кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью файлового ресурса в Azure](https://docs.microsoft.com/azure/virtual-machines/workloads/sap/sap-high-availability-guide-wsfc-file-share). 
>
> Сетевые виртуальные устройства в путях обмена данными могут легко удвоить задержку сети между двумя партнерами связи. Они также могут ограничить пропускную способность в критических путях между уровнем приложений SAP и уровнем СУБД. В некоторых сценариях клиентов сетевые виртуальные устройства могут привести к сбою кластеров Pacemaker Linux. Это случаи, когда обмен данными между узлами кластера Linux Pacemaker с устройством SBD через сетевой виртуальный модуль.
>

> [!IMPORTANT]
> Другой проект, который *не* поддерживается, — это разделение уровня приложений SAP и уровня СУБД в разные виртуальные сети Azure, которые [не связаны друг](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) с другом. Мы рекомендуем разделять уровень приложений и уровень СУБД SAP, используя подсети в виртуальной сети Azure, а не используя разные виртуальные сети Azure. 
>
> Если вы решили не следовать рекомендациям, а затем разделяйте два уровня на разные виртуальные сети, эти две виртуальные сети должны быть [равноправными](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview). 
>
> Учтите, что сетевой трафик между двумя [одноранговыми](https://docs.microsoft.com/azure/virtual-network/virtual-network-peering-overview) виртуальными сетями Azure подлежит передаче затрат. Большой объем данных, состоящий из множества терабайт, обменивается данными между уровнем приложений SAP и уровнем СУБД. Вы можете накапливать значительные затраты, если уровень приложений SAP и уровень СУБД разделяются между двумя одноранговыми виртуальными сетями Azure.

Используйте две виртуальные машины для развертывания производственных СУБД в группе доступности Azure. Кроме того, используйте отдельную маршрутизацию для уровня приложений SAP, а также трафик управления и эксплуатации на двух виртуальных машинах СУБД. См. следующее изображение:

![Схема двух виртуальных машин в двух подсетях](./media/virtual-machines-shared-sap-deployment-guide/general_two_dbms_two_subnets.PNG)


### <a name="use-azure-load-balancer-to-redirect-traffic"></a>Использование Azure Load Balancer для перенаправления трафика
Использование частных виртуальных IP-адресов, используемых в таких функциях, как SQL Server Always On или репликация системы HANA, требует настройки балансировщика нагрузки Azure. Балансировщик нагрузки использует порты пробы для определения активного узла СУБД и направляет трафик исключительно на активный узел базы данных. 

В случае отработки отказа узла базы данных приложение SAP не нуждается в перенастройке. Вместо этого наиболее распространенные архитектуры приложений SAP повторно подключаются к частному виртуальному IP-адресу. В то же время балансировщик нагрузки реагирует на отработку отказа узла, перенаправляя трафик на частный виртуальный IP-адрес на второй узел.

Azure предлагает два [номера SKU балансировщика нагрузки](https://docs.microsoft.com/azure/load-balancer/load-balancer-overview): базовый SKU и стандартный SKU. Если вы не хотите развертывать в разных зонах доступности Azure, SKU базовой подсистемы балансировки нагрузки прекрасно подойдет.

Будет ли трафик между виртуальными машинами СУБД и уровнем приложений SAP всегда направляться через подсистему балансировки нагрузки все время? Ответ зависит от того, как настроить подсистему балансировки нагрузки. 

В настоящее время входящий трафик на виртуальную машину СУБД всегда направляется через подсистему балансировки нагрузки. Исходящий трафик от виртуальной машины СУБД на виртуальную машину уровня приложения зависит от конфигурации балансировщика нагрузки. 

В подсистеме балансировки нагрузки можно установить значение параметра DirectServerReturn. Если этот параметр настроен, трафик, направленный с виртуальной машины СУБД на уровень приложений SAP, *не* направляется через балансировщик нагрузки. Вместо этого он переходит непосредственно на уровень приложения. Если DirectServerReturn не настроен, возвращаемый трафик на уровень приложений SAP направляется через подсистему балансировки нагрузки.

Рекомендуется настроить DirectServerReturn в сочетании с подсистемами балансировки нагрузки, расположенными между уровнем приложений SAP и уровнем СУБД. Такая конфигурация сокращает задержку в сети между двумя слоями.

Пример настройки этой конфигурации с помощью SQL Server Always On см. [в статье Настройка прослушивателя ilB для группы доступности Always On в Azure](https://docs.microsoft.com/azure/virtual-machines/windows/sqlclassic/virtual-machines-windows-classic-ps-sql-int-listener).

Если вы используете опубликованные шаблоны JSON GitHub в качестве справочника по развертыванию инфраструктуры SAP в Azure, изучите этот [шаблон для 3-уровневой системы SAP](https://github.com/Azure/azure-quickstart-templates/tree/4099ad9bee183ed39b88c62cd33f517ae4e25669/sap-3-tier-marketplace-image-converged-md). В этом шаблоне также можно увидеть правильные параметры для балансировщика нагрузки.

### <a name="azure-accelerated-networking"></a>Ускорение работы в сети Azure
Для дальнейшего снижения сетевой задержки между виртуальными машинами Azure рекомендуется выбрать [ускоренную сеть Azure](https://azure.microsoft.com/blog/maximize-your-vm-s-performance-with-accelerated-networking-now-generally-available-for-both-windows-and-linux/). Используйте его при развертывании виртуальных машин Azure для рабочей нагрузки SAP, особенно для уровня приложений SAP и уровня СУБД SAP.

> [!NOTE]
> Не все типы виртуальных машин поддерживают ускоренную сеть. В предыдущей статье перечислены типы виртуальных машин, поддерживающие ускоренную работу в сети.
>

---
> ![Windows][Logo_Windows] Windows
>
> Сведения о развертывании виртуальных машин с помощью ускоренной сети для Windows см. в статье [Создание виртуальной машины Windows с помощью ускоренной сети](https://docs.microsoft.com/azure/virtual-network/create-vm-accelerated-networking-powershell).
>
> ![Linux][Logo_Linux] Linux
>
> Дополнительные сведения о дистрибутиве Linux см. в статье [Создание виртуальной машины Linux с ускоренной сетью](https://docs.microsoft.com/azure/virtual-network/create-vm-accelerated-networking-cli).
>
>

---

> [!NOTE]
> Для SUSE, Red Hat и Oracle Linux функция ускорения сети поддерживается в новых версиях этих дистрибутивов. Более ранние выпуски, такие как SLES 12 SP2 или RHEL 7,2, не поддерживают ускоренную сеть в Azure.
>


## <a name="deployment-of-host-monitoring"></a>Развертывание мониторинга узла
Для использования приложений SAP на виртуальных машинах Azure в рабочей среде SAP требуется возможность получения данных мониторинга узла с физических узлов, на которых выполняются виртуальные машины Azure. Требуется определенный уровень исправлений SAP HostAgent, включающий эту возможность в SAPOSCOL и SAP HostAgent. Точное описание уровня исправлений указано в примечании к SAP [1409604].

Дополнительные сведения о развертывании компонентов, которые доставляют данные узла в SAPOSCOL и агенте SAP Host, а также об управлении жизненным циклом этих компонентов, см. в разделе [руководство по развертыванию][deployment-guide].


## <a name="next-steps"></a>Следующие шаги
Дополнительные сведения об определенной СУБД см. в следующих статьях:

- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД SQL Server](dbms_guide_sqlserver.md)
- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД Oracle](dbms_guide_oracle.md)
- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД IBM DB2](dbms_guide_ibm.md)
- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД SAP ASE](dbms_guide_sapase.md)
- [Развертывание SAP MaxDB, liveCache и сервера содержимого на виртуальных машинах Azure](dbms_guide_maxdb.md)
- [Руководство по использованию SAP HANA в Azure](hana-vm-operations.md)
- [Обеспечение высокого уровня доступности для SAP HANA на виртуальных машинах Azure](sap-hana-availability-overview.md)
- [Инструкции по резервному копированию для SAP HANA на виртуальных машинах Azure](sap-hana-backup-guide.md)

