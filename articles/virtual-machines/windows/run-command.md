---
title: Выполнение сценариев PowerShell на виртуальной машине Windows в Azure
description: В этом разделе описывается, как выполнять сценарии PowerShell на виртуальной машине Azure под управлением Windows с помощью функции "выполнить команду".
services: automation
ms.service: virtual-machines
author: bobbytreed
ms.author: robreed
ms.date: 04/26/2019
ms.topic: how-to
manager: carmonm
ms.openlocfilehash: f4e318281da5cd704d9fbf13c96cbec0a2d1b1b6
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82143776"
---
# <a name="run-powershell-scripts-in-your-windows-vm-by-using-run-command"></a>Выполнение сценариев PowerShell на виртуальной машине Windows с помощью команды Run

Функция "выполнить команду" использует агент виртуальной машины для выполнения скриптов PowerShell на виртуальной машине Azure под управлением Windows. Эти скрипты можно использовать для общего управления компьютерами или приложениями. Они могут помочь вам быстро диагностировать и исправлять проблемы доступа к виртуальной машине и сети, а также восстановить работоспособность виртуальной машины.

 

## <a name="benefits"></a>Преимущества

Доступ к виртуальным машинам можно получить несколькими способами. Команда Run позволяет удаленно запускать скрипты на виртуальных машинах с помощью агента виртуальной машины. Используйте команду Run, используя портал Azure, [REST API](/rest/api/compute/virtual%20machines%20run%20commands/runcommand)или [PowerShell](https://docs.microsoft.com/powershell/module/az.compute/invoke-azvmruncommand) для виртуальных машин Windows.

Эта возможность полезна во всех сценариях, где требуется выполнить сценарий на виртуальной машине. Это один из способов устранения неполадок и исправления виртуальной машины, на которой не открыт порт RDP или SSH из-за неправильной настройки сети или пользователя с правами администратора.

## <a name="restrictions"></a>Ограничения

При использовании команды Run действуют следующие ограничения.

* Выходные данные ограничены последними 4 096 байтами.
* Минимальное время выполнения сценария составляет примерно 20 секунд.
* Сценарии запускаются как системные в Windows.
* Может выполняться один сценарий одновременно.
* Скрипты, которые запрашивают сведения (в интерактивном режиме), не поддерживаются.
* Невозможно отменить выполняющийся сценарий.
* Максимальное время выполнения скрипта составляет 90 минут. После этого время ожидания истечет.
* Чтобы вернуть результаты скрипта, требуется разрешить исходящие подключения из виртуальной машины.

> [!NOTE]
> Для правильной работы для выполнения команды требуется подключение (порт 443) к общедоступным IP-адресам Azure. Если у расширения нет доступа к этим конечным точкам, скрипты могут выполняться успешно, но не будут возвращать результаты. Если вы блокируете трафик на виртуальной машине, вы можете использовать [теги службы](../../virtual-network/security-overview.md#service-tags) , чтобы разрешить трафик в общедоступные IP-адреса Azure `AzureCloud` с помощью тега.

## <a name="available-commands"></a>Доступные команды

В таблице ниже представлен список команд, доступных для виртуальных машин Windows. Для выполнения любого пользовательского скрипта можно использовать команду **рунповершеллскрипт** . При использовании Azure CLI или PowerShell для выполнения команды значение, указанное для параметра `--command-id` или `-CommandId` , должно быть одним из приведенных ниже значений. При указании значения, которое не является доступной командой, появляется следующее сообщение об ошибке:

```error
The entity was not found in this Azure location
```

|**Имя**|**Описание**|
|---|---|
|**RunPowerShellScript**|Запускает сценарий PowerShell.|
|**EnableRemotePS**|Настраивает компьютер для удаленного подключения к PowerShell.|
|**EnableAdminAccount**|Проверяет, отключена ли локальная учетная запись администратора, и, если да, включает ее.|
|**IPConfig**| Отображает подробные сведения об IP-адресе, маске подсети и шлюзе по умолчанию для каждого адаптера, привязанного к TCP/IP.|
|**RDPSettings**|Проверяет параметры реестра и параметры политики домена. Предлагает действия политики, если компьютер является частью домена, или изменяет параметры на значения по умолчанию.|
|**ResetRDPCert**|Удаляет сертификат TLS/SSL, привязанный к прослушивателю RDP, и восстанавливает защиту прослушивателя RDP по умолчанию. Используйте этот сценарий при появлении проблем с сертификатом.|
|**SetRDPPort**|Задает указанный по умолчанию или заданный пользователем номер порта для удаленный рабочий столных соединений. Включает правила брандмауэра для входящего доступа к порту.|

## <a name="azure-cli"></a>Azure CLI

В следующем примере используется команда [AZ VM Run-Command](/cli/azure/vm/run-command?view=azure-cli-latest#az-vm-run-command-invoke) для запуска сценария оболочки на виртуальной машине Windows в Azure.

```azurecli-interactive
# script.ps1
#   param(
#       [string]$arg1,
#       [string]$arg2
#   )
#   Write-Host This is a sample script with parameters $arg1 and $arg2

az vm run-command invoke  --command-id RunPowerShellScript --name win-vm -g my-resource-group \
    --scripts @script.ps1 --parameters "arg1=somefoo" "arg2=somebar"
```

## <a name="azure-portal"></a>Портал Azure

Перейдите к виртуальной машине в [портал Azure](https://portal.azure.com) и выберите **команду выполнить** в разделе **операции**. Отобразится список доступных команд для выполнения на виртуальной машине.

![Список команд](./media/run-command/run-command-list.png)

Выберите команду для запуска. Некоторые команды могут содержать необязательные или обязательные входные параметры. Для этих команд параметры представляются как текстовые поля для предоставления входных значений. Для каждой команды можно просмотреть скрипт, который выполняется путем развертывания **скрипта просмотра**. **Рунповершеллскрипт** отличается от других команд, так как позволяет предоставить собственный пользовательский скрипт.

> [!NOTE]
> Встроенные команды не редактируются.

После выбора команды выберите **выполнить** , чтобы запустить скрипт. После завершения скрипта он возвращает выходные данные и все ошибки в окне вывода. На следующем рисунке показан пример сообщения после запуска команды **RDPSettings**.

![Вывод сценария команды запуска](./media/run-command/run-command-script-output.png)

## <a name="powershell"></a>PowerShell

В следующем примере командлет [Invoke-азвмрункомманд](https://docs.microsoft.com/powershell/module/az.compute/invoke-azvmruncommand) используется для запуска сценария PowerShell на виртуальной машине Azure. Этот командлет ожидает, что скрипт, указанный в параметре `-ScriptPath`, расположен в локальной среде, в которой выполняется командлет.

```azurepowershell-interactive
Invoke-AzVMRunCommand -ResourceGroupName '<myResourceGroup>' -Name '<myVMName>' -CommandId 'RunPowerShellScript' -ScriptPath '<pathToScript>' -Parameter @{"arg1" = "var1";"arg2" = "var2"}
```

## <a name="limiting-access-to-run-command"></a>Ограничение доступа к команде запуска

Для получения списка команд выполнения или отображения сведений о команде требуется `Microsoft.Compute/locations/runCommands/read` разрешение на уровне подписки. Это разрешение имеет встроенную роль [читателя](../../role-based-access-control/built-in-roles.md#reader) и более высокие уровни.

Для выполнения команды требуется `Microsoft.Compute/virtualMachines/runCommand/action` разрешение на уровне подписки. Это разрешение имеют роль [участника виртуальной машины](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) и более высокие уровни.

Можно использовать одну из [встроенных ролей](../../role-based-access-control/built-in-roles.md) или создать [настраиваемую роль](../../role-based-access-control/custom-roles.md) для использования команды Run.

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о других способах удаленного выполнения сценариев и команд в виртуальной машине см. в статье [Запуск сценариев на виртуальной машине Windows](run-scripts-in-vm.md).
