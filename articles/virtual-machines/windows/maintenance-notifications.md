---
title: Обработка уведомлений по обслуживанию для виртуальных машин Windows в Azure | Документация Майкрософт
description: Просмотрите уведомления по обслуживанию для виртуальных машин Windows, запущенных в Azure, и запустите самостоятельное обслуживание.
services: virtual-machines-windows
documentationcenter: ''
author: shants123
editor: ''
tags: azure-service-management,azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.topic: article
ms.date: 04/30/2019
ms.author: shants
ms.openlocfilehash: 2e7f51ecb948764f6ac4c3e7a52dc14ef5d00741
ms.sourcegitcommit: 827248fa609243839aac3ff01ff40200c8c46966
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/07/2019
ms.locfileid: "73749367"
---
# <a name="handling-planned-maintenance-notifications-for-windows-virtual-machines"></a>Обработка плановых уведомлений по обслуживанию для виртуальных машин Windows

Azure периодически выполняет обновления, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов, в которой работают виртуальные машины. Обновления — это изменения, такие как исправление среды размещения или модернизация оборудования и вывод его из эксплуатации. Большинство этих обновлений не влияют на работу размещенных виртуальных машин. Но в некоторых случаях они все же оказывают определенное воздействие:

- Если обслуживание не требует перезагрузки, Azure с помощью миграции на месте приостанавливает работу виртуальной машины во время обновления узла. Эти операции обслуживания, не требующие перезагрузки, выполняются по доменам сбоя, и их выполнение будет прервано, если будет получено предупреждение о проблемах с работоспособностью. 

- Если для обслуживания требуется перезагрузка, вы получите уведомление во время планирования обслуживания. В таких случаях вам предоставляется период времени, который обычно составляет 35 дней, когда вы можете начать обслуживание самостоятельно, когда оно будет работать.


Плановое обслуживание, требующее перезагрузки, запланировано в волнах. Каждая волна имеет разную область (регионы).

- Волна начинается с уведомления клиентов. По умолчанию уведомление отправляется владельцу и совладельцам подписки. С помощью [оповещений журнала действий](../../azure-monitor/platform/activity-logs-overview.md) Azure вы можете добавить дополнительных получателей и методы доставки уведомлений, такие как электронная почта, текстовые сообщения или веб-перехватчики.  
- С момента создания уведомления начинается *период самообслуживания*. В этом окне, обычно 35 дней, вы можете узнать, какие виртуальные машины включены в эту волна, и заблаговременно начать обслуживание в соответствии с собственными потребностями планирования.
- После периода самообслуживания, начинается *период запланированного обслуживания*. В некоторый момент этого периода Azure назначает и применяет для вашей виртуальной машины необходимые операции обслуживания. 

Два периода нужны, чтобы у вас было достаточно времени для запуска обслуживания и перезагрузки виртуальной машины до того, как Azure начнет обслуживание автоматически.


Для запроса окон обслуживания для виртуальных машин и запуска самообслуживания можно использовать портал Azure, PowerShell, REST API и CLI.

  
## <a name="should-you-start-maintenance-during-the-self-service-window"></a>Нужно ли начинать обслуживание в период самообслуживания?  

Следующие рекомендации помогут решить, есть ли смысл использовать эту возможность для обслуживания по собственному графику.

> [!NOTE] 
> Самостоятельное обслуживание может оказаться недоступным для некоторых виртуальных машин. Чтобы определить, доступно ли упреждающее обслуживание для ваших виртуальных машин, проверьте наличие ссылки **Начать сейчас** в информации о состоянии обслуживания. Самообслуживание в настоящее время недоступно для облачных служб (веб-ролей и рабочих ролей) и Service Fabric.


Мы не рекомендуем применять самообслуживание для развертываний, использующих **наборы доступности**, поскольку для них соблюдаются высокие требования к доступности и любые обновления в любой момент времени могут затрагивать только один домен обновления. 
- Позвольте Azure управлять запуском обслуживания. При проведении обслуживания, требующего перезагрузки, следует помнить, что обслуживание выполняется по доменам обновления, домены обновления необязательно обслуживаются последовательно и между обслуживанием доменов обновлений происходит 30-минутная пауза. 
- Если для вас недопустима временная потеря мощности или пропускной способности (в объеме, обратно пропорциональном количеству доменов обновления), эту проблему можно легко устранить: добавьте на весь период обслуживания необходимое количество дополнительных экземпляров.
- Для обслуживания, не требующего перезагрузки, обновления применяются на уровне домена сбоя.
    
**Не применяйте** режим самообслуживания в следующих ситуациях. 
- Если вы часто завершаете работу виртуальных машин, вручную, с помощью DevTest Labs, автоматического завершения работы или по расписанию. Перезагрузка может сбросить текущее состояние обслуживания, что приведет к дополнительным простоям.
- Если вы используете виртуальные машины в течение короткого периода, то есть они наверняка будут удалены до завершения периода обслуживания. 
- Если вы используете рабочие нагрузки с большим объемом информации о состоянии, которая хранится на локальном (временном) диске и должна сохраняться после обновления. 
- Если вы часто изменяете размер виртуальной машины, поскольку это действие может привести к сбросу состояния обслуживания.
- Если вы настроили запланированные события, которые выполняют для рабочей нагрузки упреждающую отработку отказа или корректное завершение работы за 15 минут до завершения работы обслуживания

Обязательно **используйте** самообслуживание, если вы намерены использовать виртуальную машину без перерыва в течение всего периода запланированного обслуживания и ваша система не соответствует ни одному из "блокирующих" условий, которые перечислены выше. 

Режим самообслуживания лучше всего подходит для следующих ситуаций.

- Если вам нужно сообщить руководству или клиенту точное время обслуживания. 
- Если вам важно завершить обслуживание не позднее определенной даты. 
- Если вам важно соблюдать определенную последовательность обслуживания, например, чтобы гарантировать безопасное восстановление для многоуровневого приложения.
- Если вам нужна пауза более 30 минут для восстановления виртуальных машин между периодами обслуживания двух доменов обновления. Чтобы управлять длительностью пауз между обслуживанием доменов обновления, запускайте обслуживание виртуальных машин только для одного домена обновления.

 

[!INCLUDE [virtual-machines-common-maintenance-notifications](../../../includes/virtual-machines-common-maintenance-notifications.md)]

## <a name="check-maintenance-status-using-powershell"></a>Проверка состояния обслуживания с помощью PowerShell

Чтобы узнать, когда для виртуальных машин запланировано обслуживание, можно также использовать Azure PowerShell. Информацию о плановом обслуживании можно получить с помощью командлета [Get-AzVM](https://docs.microsoft.com/powershell/module/az.compute/get-azvm), используя параметр `-status`.
 
Сведения об обслуживании возвращаются, только если имеется запланированное обслуживание. Если нет запланированного обслуживания, влияющего на виртуальную машину, командлет не возвращает информацию об обслуживании. 

 

```powershell
Get-AzVM -ResourceGroupName rgName -Name vmName -Status
```

В разделе MaintenanceRedeployStatus возвращаются следующие свойства: 

| Значение | Description (Описание)   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на виртуальной машине |
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине |
| PreMaintenanceWindowEndTime           | Завершение периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине |
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. |
| MaintenanceWindowEndTime              | Завершение периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. |
| LastOperationResultCode               | Результат последней попытки инициирования обслуживания на виртуальной машине |



Вы также можете получить информацию о состоянии обслуживания всех виртуальных машин в группе ресурсов с помощью командлета [Get-AzVM](https://docs.microsoft.com/powershell/module/az.compute/get-azvm), не указывая виртуальную машину.
 
```powershell
Get-AzVM -ResourceGroupName rgName -Status
```

Следующая функция PowerShell принимает идентификатор подписки и выводит список виртуальных машин, запланированных для обслуживания.

```powershell

function MaintenanceIterator
{
    Select-AzSubscription -SubscriptionId $args[0]

    $rgList= Get-AzResourceGroup 

    for ($rgIdx=0; $rgIdx -lt $rgList.Length ; $rgIdx++)
    {
        $rg = $rgList[$rgIdx]        
    $vmList = Get-AzVM -ResourceGroupName $rg.ResourceGroupName 
        for ($vmIdx=0; $vmIdx -lt $vmList.Length ; $vmIdx++)
        {
            $vm = $vmList[$vmIdx]
            $vmDetails = Get-AzVM -ResourceGroupName $rg.ResourceGroupName -Name $vm.Name -Status
              if ($vmDetails.MaintenanceRedeployStatus )
            {
                Write-Output "VM: $($vmDetails.Name)  IsCustomerInitiatedMaintenanceAllowed: $($vmDetails.MaintenanceRedeployStatus.IsCustomerInitiatedMaintenanceAllowed) $($vmDetails.MaintenanceRedeployStatus.LastOperationMessage)"               
            }
          }
    }
}

```

### <a name="start-maintenance-on-your-vm-using-powershell"></a>Запуск обслуживания вашей виртуальной машины с помощью PowerShell

Используя информацию из функции в предыдущем разделе, следующая команда запускает обслуживание на виртуальной машине, если для свойства **IsCustomerInitiatedMaintenanceAllowed** задано значение true.

```powershell
Restart-AzVM -PerformMaintenance -name $vm.Name -ResourceGroupName $rg.ResourceGroupName 
```

## <a name="classic-deployments"></a>Классические развертывания

Если у вас все еще есть устаревшие виртуальные машины, развернутые с использованием классической модели развертывания, вы можете сделать запрос к ним и запустить их обслуживание с помощью PowerShell.

Чтобы узнать состояние обслуживания виртуальной машины, введите:

```
Get-AzureVM -ServiceName <Service name> -Name <VM name>
```

Чтобы начать обслуживание классической виртуальной машины, введите:

```
Restart-AzureVM -InitiateMaintenance -ServiceName <service name> -Name <VM name>
```


## <a name="faq"></a>Вопросы и ответы


**Вопрос. Зачем вам нужно перезагружать сейчас мою виртуальную машину?**

**Ответ.** Хотя обновления платформы Azure преимущественно не оказывают влияния на доступность виртуальных машин, иногда мы не можем избежать перезагрузки виртуальных машин, размещенных в Azure. Мы хотим внести несколько изменений, и для этого нам нужно перезапустить наши серверы. Это, в свою очередь, приведет к перезагрузке виртуальных машин.

**Вопрос. Безопасно ли выполнять рекомендации по обеспечению высокой доступности с помощью группы доступности?**

**Ответ.** Для виртуальных машин, развернутых в группе доступности или масштабируемом наборе виртуальных машин, применяется концепция доменов обновления. Во время обслуживания Azure учитывает ограничения доменов обновления и не выполняет перезагрузку виртуальных машин из разных доменов обновления (в пределах одной и той же группы доступности).  Azure также ожидает минимум 30 минут, прежде чем переходить к следующей группе виртуальных машин. 

Дополнительные сведения о высокой доступности см. [в статье доступность виртуальных машин в Azure](availability.MD).

**Вопрос. Как происходит информирование о плановом обслуживании?**

**Ответ.** Процедура планового обслуживания начинается с настройки расписания для одного или нескольких регионов Azure. Вскоре после этого владельцам подписки отправляется уведомление по электронной почте (одно сообщение для каждой подписки). Дополнительные каналы и получатели для этого уведомления можно настроить с помощью оповещений журнала действий. При развертывании виртуальной машины в регионе, в котором плановое обслуживание назначено по расписанию, вы не получите уведомление. Вам нужно будет проверить состояние обслуживания виртуальной машины.

**Вопрос. я не вижу указания о плановом обслуживании на портале, PowerShell или CLI. Что не так?**

**Ответ.** Сведения о плановом обслуживании доступны в ходе этой процедуры только для виртуальных машин, которые включены в плановое обслуживание. Другими словами, если данные не отображаются, это значит, что процедура обслуживания уже завершена (или не начата) или виртуальная машина уже размещена на обновленном сервере.

**Вопрос. Можно ли точно узнать, когда моя виртуальная машина будет затронута?**

**Ответ.** При планировании расписания мы определяем временное окно в несколько дней. Но точная последовательность серверов (и связанных виртуальных машин) в рамках этого окна неизвестна. Если клиенту нужно знать точное время обслуживания виртуальных машин, он может применить [запланированные события](scheduled-events.md) и запросы из виртуальных машин, чтобы получить уведомление за 15 минут до перезагрузки виртуальной машины.

**Вопрос. Как долго моя виртуальная машина будет перезагружаться?**

**Ответ.** Перезагрузка в течение периода самообслуживания может занять несколько минут в зависимости от размера виртуальной машины. Перезагрузка, инициированная Azure в период запланированного обслуживания, обычно занимает около 25 минут. Если вы используете облачные службы (рабочие роли и веб-роли), масштабируемые наборы виртуальных машин или группы доступности, то вы получите дополнительную паузу 30 минут между обновлением разных групп (доменов обновления) виртуальных машин в период запланированного обслуживания. 

**Вопрос. Как происходит обслуживание в случае с масштабируемыми наборами виртуальных машин?**

**Ответ.** Плановое обслуживание теперь доступно и для масштабируемых наборов виртуальных машин. Инструкции по запуску самостоятельного обслуживания см. в документе, посвященном [плановому обслуживанию для масштабируемых наборов виртуальных машин](../../virtual-machine-scale-sets/virtual-machine-scale-sets-maintenance-notifications.md).

**Вопрос. Как обслуживание повлияет на облачные службы (рабочие роли или веб-роли) и Service Fabric?**

**Ответ.** Так как эти платформы будут затронуты плановым обслуживанием, клиенты смогут их безопасно использовать, если в указанный момент времени будут затронуты только виртуальные машины в одном домене обновления. Самообслуживание в настоящее время недоступно для облачных служб (веб-ролей и рабочих ролей) и Service Fabric.

**Вопрос. я не вижу никаких сведений об обслуживании на моих виртуальных машинах. Что пошло не так?**

**Ответ.** Есть несколько причин, по которым вы можете не видеть информацию об обслуживании в виртуальных машинах:
1.  Вы используете подписку, отмеченную в Майкрософт как внутренняя.
2.  Для виртуальных машин не запланировано обслуживание. Процедура обслуживания завершена, отменена или изменена так, чтобы не влиять на виртуальные машины.
3.  В представлении списка виртуальных машин отсутствует столбец **Обслуживание**. Хотя мы добавили этот столбец в представление по умолчанию, клиенты, которые настроили отображение пользовательских столбцов, должны вручную добавить столбец **Обслуживание** в представление списка виртуальных машин.

**Вопрос. для моей виртуальной машины запланировано обслуживание второй раз. Важно?**

**Ответ.** Есть несколько ситуаций, когда для виртуальной машины может быть запланирована еще одна процедура после обслуживания с повторным развертыванием:
1.  Мы отменили процедуру обслуживания и перезапустили ее с другими полезными данными. Мы обнаружили неисправные полезные данные, и нам просто нужно развернуть дополнительные полезные данные.
2.  Виртуальная машина *восстановлена* на другой узел из-за сбоя оборудования.
3.  Вы решили остановить (отменить распределение) и перезапустить виртуальную машину
4.  Вы настроили **автоматическое завершение работы** для виртуальной машины.


## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как зарегистрироваться для событий обслуживания прямо из виртуальной машины с помощью функции [запланированных событий](scheduled-events.md).
