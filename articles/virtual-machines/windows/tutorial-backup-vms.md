---
title: Учебник. Резервное копирование виртуальных машин Windows на портале Azure
description: Из этого руководства вы узнаете, как защитить виртуальные машины Windows с помощью портала Azure и службы Azure Backup.
services: virtual-machines-windows
documentationcenter: virtual-machines
author: cynthn
manager: gwallace
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-windows
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 06/06/2019
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: e1fa85dc63bc23760888192f2118158e73320a86
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81456113"
---
# <a name="tutorial-back-up-and-restore-files-for-windows-virtual-machines-in-azure"></a>Руководство по резервному копированию и восстановлению файлов для виртуальных машин Windows в Azure

Для защиты данных можно создавать архивы с регулярным интервалом. Служба архивации Azure создает точки восстановления, которые хранятся в геоизбыточных хранилищах восстановления. Используя точку восстановления, можно восстановить всю виртуальную машину или определенные файлы. В этой статье описана процедура восстановления одного файла на виртуальной машине с Windows Server и IIS. Если у вас еще нет виртуальной машины, создайте ее, используя сведения, приведенные в статье [Быстрое создание виртуальной машины с ОС Windows](quick-create-portal.md). Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * Создание архива виртуальной машины
> * Планирование ежедневной архивации
> * Восстановление файла из архива

## <a name="backup-overview"></a>Обзор службы Azure Backup

Служба архивации Azure запускает задание архивации. При этом расширение архивации создает моментальный снимок. Служба Azure Backup использует [расширение VMSnapshot](https://docs.microsoft.com/azure/virtual-machines/extensions/vmsnapshot-windows). Расширение устанавливается во время первой архивации виртуальной машины, если виртуальная машина запущена. Если виртуальная машина не запущена, служба резервного копирования создает моментальный снимок базового хранилища (так как операции записи в приложении не выполняются, пока виртуальная машина остановлена).

Во время создания моментального снимка виртуальных машин Windows служба архивации координируется со службой теневого копирования томов (VSS), что позволяет создать согласованный моментальный снимок дисков виртуальной машины. После создания моментального снимка службой архивации Azure данные передаются в хранилище. Для повышения эффективности служба анализирует блоки данных и передает только те из них, которые были изменены с момента предыдущего резервного копирования.

После передачи данных служба удаляет моментальный снимок и создает точку восстановления.

## <a name="create-a-backup"></a>Создание резервной копии
Создайте простую операцию ежедневной архивации в хранилище служб восстановления. 

1. Войдите на [портал Azure](https://portal.azure.com/).
1. В меню слева выберите **Виртуальные машины**. 
1. В этом списке выберите нужную виртуальную машину для архивации.
1. В колонке виртуальной машины в разделе **Операции** щелкните **Архивация**. Откроется колонка **Включение архивации**.
1. В **хранилище служб восстановления** щелкните **Создать** и укажите имя нового хранилища. Новое хранилище создается в той же группе ресурсов и в том же расположении, что и виртуальная машина.
1. В разделе **Выбрать политику архивации** параметр **(New) DailyPolicy** (Новая ежедневная политика) оставьте заданным по умолчанию и щелкните **Включить резервное копирование**.
1. Для создания начальной точки восстановления в колонке **Архивация** щелкните **Создать архив**.
1. В колонке **Создать архив** щелкните значок календаря и с помощью элементов управления календарем укажите, как долго нужно сохранять эту точку восстановления, а затем нажмите кнопку **ОК**.
1. В колонке **Архивация** виртуальной машины вы увидите число созданных точек восстановления.


    ![Точки восстановления](./media/tutorial-backup-vms/backup-complete.png)
    
Первая архивация длится около 20 минут. После завершения архивации перейдите к следующей части этого руководства.

## <a name="recover-a-file"></a>восстановление файла;

Если вы случайно удалили файл или внесли в него ненужные изменения, его можно восстановить из резервного хранилища, используя функцию восстановления файлов. Восстановление файлов запускает скрипты на виртуальной машине, чтобы подключить точку восстановления в качестве локального диска. Эти диски остаются подключенными в течение 12 часов, чтобы вы могли скопировать файлы из точки восстановления и восстановить их на виртуальной машине.  

В этом примере показано, как восстановить файл изображения, которое используется на веб-странице IIS по умолчанию. 

1. Откройте браузер и введите IP-адрес виртуальной машины в адресной строке. Откроется веб-страница IIS по умолчанию.

    ![Веб-страница IIS по умолчанию](./media/tutorial-backup-vms/iis-working.png)

1. Подключитесь к виртуальной машине.
1. На виртуальной машине откройте **Проводник**, перейдите в папку \inetpub\wwwroot и удалите файл **iisstart.png**.
1. На локальном компьютере обновите окно браузера, чтобы убедиться, что изображение на веб-странице IIS по умолчанию отсутствует.

    ![Веб-страница IIS по умолчанию](./media/tutorial-backup-vms/iis-broken.png)

1. На локальном компьютере откройте новую вкладку и перейдите на [портал Azure](https://portal.azure.com).
1. В меню слева выберите **Виртуальные машины** и выберите виртуальную машину из списка.
1. В колонке виртуальной машины в разделе **Операции** щелкните **Архивация**. Откроется колонка **Архивация**. 
1. В меню в верхней части колонки выберите **Восстановление файлов**. Откроется колонка **Восстановление файлов**.
1. В разделе **Шаг 1. Выбор точки восстановления** выберите точку восстановления из раскрывающегося списка.
1. На **шаге 2 Скачивание скрипта для просмотра и восстановления файлов** нажмите кнопку **Скачать исполняемый файл**. Скопируйте пароль для файла и сохраните его в безопасном месте.
1. На локальном компьютере откройте **Проводник**, перейдите в папку **Загрузки** папку и скопируйте скачанный EXE-файл. В качестве префикса имени файла используется имя виртуальной машины. 
1. Вставьте EXE-файл на рабочий стол виртуальной машины (используя подключение RDP). 
1. Перейдите на рабочий стол виртуальной машины и дважды щелкните EXE-файл. Откроется окно командной строки. Программа подключит точку восстановления в качестве общей папки и предоставит вам доступ к ней. После создания общей папки введите **q**, чтобы закрыть командную строку.
1. В виртуальной машине откройте **Проводник** и затем откройте диск, который использовался для общей папки.
1. Перейдите в каталог \inetpub\wwwroot, скопируйте файл **iisstart.png** из общей папки и вставьте его в папку \inetpub\wwwroot. Например, скопируйте файл F:\inetpub\wwwroot\iisstart.png и вставьте его в папку C:\inetpub\wwwroot, чтобы восстановить этот файл.
1. На локальном компьютере откройте вкладку браузера с подключением к IP-адресу виртуальной машины, на которой открыта веб-страница IIS по умолчанию. Нажмите CTRL+F5, чтобы обновить страницу в браузере. Вы увидите, что изображение снова появилось.
1. На локальном компьютере вернитесь на вкладку браузера, в которой открыт портал Azure, и на этапе **Step 3: Unmount the disks after recovery** (Шаг 3. Отключение дисков после восстановления) нажмите кнопку **Unmount Disks** (Отключить диски). Если вы забудете сделать это, соединение с точкой подключения будет автоматически закрыто через 12 часов. После этих 12 часов для создания нового соединения с точкой подключения потребуется скачать новый скрипт.





## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание архива виртуальной машины
> * Планирование ежедневной архивации
> * Восстановление файла из архива

Перейдите к следующему руководству, чтобы узнать о мониторинге виртуальных машин.

> [!div class="nextstepaction"]
> [Управление виртуальными машинами](tutorial-govern-resources.md)









