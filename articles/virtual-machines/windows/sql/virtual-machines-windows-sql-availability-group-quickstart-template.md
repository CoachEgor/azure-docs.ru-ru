---
title: Настройка группы доступности (шаблон быстрого запуска Azure)
description: Используйте шаблоны быстрого запуска Azure для создания кластера Совбеза Windows, присоединяйтесь к вс-м веб-сервера к кластеру, создавайте слушателя и настраивайте балансирумы внутренней нагрузки в Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: craigg
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 01/04/2019
ms.author: mathoma
ms.reviewer: jroth
ms.custom: seo-lt-2019
ms.openlocfilehash: edf810dfc975eebaf261eac7b89106c9e29c759c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74022384"
---
# <a name="use-azure-quickstart-templates-to-configure-an-availability-group-for-sql-server-on-an-azure-vm"></a>Используйте шаблоны быстрого запуска Azure для настройки группы доступности для сервера S'L на VM Azure
В этой статье описывается, как использовать шаблоны быстрого запуска Azure для частичной автоматизации развертывания групповой конфигурации всегда на наличие для виртуальных машин сервера S'L Server в Azure. В этом процессе используются два шаблона быстрого запуска Azure: 

   | Шаблон | Описание |
   | --- | --- |
   | [101-sql-vm-ag-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) | Создает кластер сбоя Windows и присоединяется к всасыванным vMs-серверам S'L к нему. |
   | [101-sql-vm-aglistener-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) | Создает слушатель группы доступности и настраивает внутренний баланселизатор нагрузки. Этот шаблон может быть использован только в том случае, если кластер Windows failover был создан с **101-кв.м-аг-установки** шаблона. |
   | &nbsp; | &nbsp; |

Другие части конфигурации группы доступности должны быть выполнены вручную, например создание группы доступности и создание баланса внутренней нагрузки. В этой статье описана последовательность автоматизированных и выполняемых вручную действий.
 

## <a name="prerequisites"></a>Предварительные требования 
Чтобы автоматизировать настройку группы всегда на доступность с помощью шаблонов quickstart, вы должны иметь следующие предпосылки: 
- [Подписка Azure](https://azure.microsoft.com/free/).
- Группа ресурсов с контроллером домена. 
- Один или несколько конделений, объединенных к [домену, в Azure под управлением S'L Server 2016 (или позже) Enterprise Edition,](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision) которые находятся в одном и том же наборе доступности или зоне доступности и которые были [зарегистрированы в поставщике ресурсов S'L VM.](virtual-machines-windows-sql-register-with-resource-provider.md)  
- Два доступных (не используемых какой-либо сущностью) IP-адреса: один для внутреннего баланса нагрузки и один для слушателя группы доступности в той же подсети, что и группа доступности. При использовании существующего балансиста нагрузки нужен только один доступный IP-адрес.  

## <a name="permissions"></a>Разрешения
Для настройки группы всегда на доступности необходимы следующие разрешения с помощью шаблонов быстрого запуска Azure: 

- Существующая учетная запись пользователя домена, которая имеет разрешение **на создание компьютерного объекта** в домене.  Например, учетная запись domain Admin обычно account@domain.comимеет достаточное разрешение (например: ). _Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера._
- Учетная запись пользователя домена, которая управляет службой сервера S'L. 


## <a name="step-1-create-the-failover-cluster-and-join-sql-server-vms-to-the-cluster-by-using-a-quickstart-template"></a>Шаг 1: Создайте кластер failover и присоединитесь к VMs-серверам s'L'l к кластеру с помощью шаблона quickstart 
После того, как ваши виртуальные компании сервера S'L были зарегистрированы в поставщике ресурсов S'L VM, вы можете присоединиться к вашим VMs-серверам s'L в *SqlVirtualMachineGroups.* Этот ресурс определяет метаданные кластера Сбой Windows. Метаданные включают в себя версию, издание, полностью квалифицированное доменное имя, учетные записи Active Directory для управления кластером и сервисом S'L Server, а также учетную запись хранения в качестве облачного свидетеля. 

Добавление виртуальных машин SQL Server в группу ресурсов *SqlVirtualMachineGroups* запускает службу отказоустойчивого кластера Windows для создания кластера, а затем присоединяет эти виртуальные машины SQL Server к этому кластеру. Этот шаг автоматизирован с **101-кв.м-вм-аг-установки** быстрозапуска шаблона. Вы можете реализовать его, используя следующие шаги:

1. Перейдите к шаблону быстрого запуска [**101 кв.м.-вм-аг-установки.**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) Затем выберите **Развертывание в Azure,** чтобы открыть шаблон быстрого запуска на портале Azure.
1. Заполните необходимые поля для настройки метаданных для кластера сбоя Windows. Вы можете оставить дополнительные поля пустыми.

   В следующей таблице показаны необходимые значения для шаблона: 

   | **Поле** | Значение |
   | --- | --- |
   | **Подписка** |  Подписка, в которой находятся ваши виртуальные машины SQL Server. |
   |**Группа ресурсов** | Группа ресурсов, где находятся ваши виртуальные машины SQL Server. | 
   |**Failover Cluster Name** (Имя отказоустойчивого кластера) | Имя, которое требуется для нового кластера Сбоажа Windows. |
   | **Existing Vm List** (Список существующих виртуальных машин) | ВМ сервера S'L, которые вы хотите принять участие в группе доступности и стать частью этого нового кластера. Отделите эти значения с запятой и пространством (например, *S'LVM1, S'LVM2).* |
   | **Версия SQL Server** | Версия сервера S'L, внеся вашего VMs-сервера. Выберите его из списка выпадающих. В настоящее время поддерживаются только изображения S'L Server 2016 и S'L Server 2017. |
   | **Existing Fully Qualified Domain Name** (Существующее полное доменное имя) | Полное доменное имя существующего домена, в котором находятся виртуальные машины SQL Server. |
   | **Existing Domain Account** (Учетная запись существующего домена) | Существующая учетная запись пользователя домена, которая имеет разрешение **Computer Object** в домене по мере создания [CNO](/windows-server/failover-clustering/prestage-cluster-adds) во время развертывания шаблона. Например, учетная запись domain Admin обычно account@domain.comимеет достаточное разрешение (например: ). *Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера.*| 
   | **Domain Account Password** (Пароль к учетной записи домена) | Пароль для указанной выше учетной записи пользователя домена. | 
   | **Existing Sql Service Account** (Существующая учетная запись службы SQL Server) | Учетная запись пользователя домена, которая управляет [службой сервера S'L](/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions) во время развертывания группы доступности (например: account@domain.com). |
   | **Sql Service Password** (Пароль службы SQL) | Пароль для учетной записи пользователя домена, которая используется для управления службой SQL Server. |
   | **Имя облака-свидетеля** | Новая учетная запись хранения Данных Azure, которая будет создана и использована для забытого облака. Вы можете изменить это имя. |
   | **\_артефакты Расположение** | Это поле имеет значение по умолчанию, и его можно изменить. |
   | **\_артефакты Расположение Sas Токен** | Это поле намеренно оставлено пустым. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями, выберите **I Согласен с условиями, указанными выше** флажок. Затем выберите **Покупка,** чтобы завершить развертывание шаблона quickstart. 
1. Чтобы контролировать развертывание, выберите развертывание из значка **колокола уведомлений** в верхнем навигационном баннере или перейдите в **группу ресурсов** на портале Azure. Выберите **развертывания** в **настройках**и выберите развертывание **Microsoft.Template.** 

>[!NOTE]
> Учетные данные, предоставляемые при развертывании шаблонов, сохраняются только на протяжении всего развертывания. После завершения развертывания эти пароли удаляются. Вам будет предложено предоставить их снова, если вы добавите в кластер больше вм: VMs-сервера. 


## <a name="step-2-manually-create-the-availability-group"></a>Шаг 2: Вручную создать группу доступности 
Вручную создайте группу доступности, как обычно, с помощью [студии управления серверами S'L,](/sql/database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio) [PowerShell](/sql/database-engine/availability-groups/windows/create-an-availability-group-sql-server-powershell)или [Transact-S'L.](/sql/database-engine/availability-groups/windows/create-an-availability-group-transact-sql) 

>[!IMPORTANT]
> Не *создавайте* слушателя в это время, потому что **101-кв.м-вм-агдистер-установка** quickstart шаблон делает это автоматически в шаге 4. 

## <a name="step-3-manually-create-the-internal-load-balancer"></a>Шаг 3: Вручную создать внутренний балансер нагрузки
Слушателю группы всегда на наличие требуется внутренний экземпляр баланса загрузки Azure. Внутренний балансизатор нагрузки обеспечивает "плавающий" IP-адрес для слушателя группы доступности, что позволяет быстрее выводить из строя и воссоединения. Если ВМ сервера S'L в группе доступности являются частью одного и того же набора доступности, можно использовать балансера basic load. В противном случае необходимо использовать балансизатор стандартной нагрузки. 

> [!IMPORTANT]
> Внутренний балансосиватор нагрузки должен находиться в той же виртуальной сети, что и экземпляры S'L Server VM. 

Вам просто нужно создать внутренний балансер нагрузки. В шаге 4 шаблон **quickstart-seter 101-sql-vm-setset** обрабатывает остальную конфигурацию (например, пул бэкэнда, зонд здоровья и правила балансировки нагрузки). 

1. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. 
2. В группе ресурсов выберите **Добавить**.
3. Найдите **балансировщик нагрузки**. В результатах поиска выберите **Load Balancer**, который публикуется **корпорацией Майкрософт.**
4. На лезвии **балансора нагрузки** выберите **Создать**.
5. В диалоговом окне **Создание подсистемы балансировки нагрузки** настройте подсистему балансировки нагрузки, задав следующие параметры:

   | Параметр | Значение |
   | --- | --- |
   | **Название** |Введите имя текста, представляющее балансомер нагрузки. Например, введите **sqlLB**. |
   | **Тип** |**Внутренний.** Большинство реализаций используют внутреннюю подсистему балансировки нагрузки, которая позволяет приложениям, работающим в одной и той же виртуальной сети, подключаться к группе доступности.  </br> **Внешний**: Позволяет приложениям подключаться к группе доступности через общедоступное подключение к Интернету. |
   | **Виртуальная сеть** | Выберите виртуальную сеть, в которой расположены экземпляры SQL Server. |
   | **Подсети** | Выберите подсеть, в которой расположены экземпляры SQL Server. |
   | **Назначение IP-адресов** |**Статический** |
   | **Частный IP-адрес** | Укажите свободный IP-адрес из нужной подсети. |
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Обычно это та же подписка, что и все ресурсы для группы доступности. |
   | **Группа ресурсов** |Выберите группу ресурсов, в которой расположены экземпляры SQL Server. |
   | **Расположение** |Выберите расположение Azure, в котором расположены экземпляры SQL Server. |
   | &nbsp; | &nbsp; |

6. Выберите **Создать**. 


>[!IMPORTANT]
> Общедоступный ip-ресурс для каждого S'L Server VM должен иметь стандартный SKU, чтобы быть совместимым со балансиватором стандартной нагрузки. Чтобы определить SKU общедоступного IP-ресурса вашего VM, перейдите в **Группу ресурсов,** выберите ресурс **общественного IP-адреса** для S'L Server VM и найдите значение под **SKU** в панели **Обзора.** 

## <a name="step-4-create-the-availability-group-listener-and-configure-the-internal-load-balancer-by-using-the-quickstart-template"></a>Шаг 4: Создайте слушателя группы доступности и назначайте внутренний балансик нагрузки с помощью шаблона quickstart

Создайте слушатель группы доступности и автоматически настроили внутренний балансер нагрузки, используя шаблон быстрого запуска **101 кв.м.-aglistener-set.** Шаблон содержит ресурс Microsoft.SqlVirtualMachine/SqlVirtualMachine/SqlVirtualMachineGroups/AvailabilityGroupListener. Шаблон быстрого запуска **101-sql-vm-aglistener-setup** позволяет выполнить следующие действия через поставщик ресурсов виртуальной машины SQL:

- Создает новый ресурс протокола IP внешнего интерфейса (на основе значения IP-адреса, предоставленного во время развертывания) для прослушивателя. 
- Настраивает настройки сети для кластера и балансируза внутренней нагрузки. 
- Настраивает пул бэкэнда для внутреннего баланса нагрузки, зонда работоспособности и правил балансировки нагрузки.
- Создает слушатель группы доступности с данным IP-адресом и именем.
 
>[!NOTE]
> Вы можете использовать **101-кв.кв.м-аглистер-настройка** только в том случае, если кластер Windows failover был создан с **101-кв.м-вм-аг-установкой** шаблона.
   
   
Для настройки внутреннего балансивизатора нагрузки и создания группы слушателя доступности сделайте следующее:
1. Перейдите к шаблону [quickstart-seter 101 кв.м.,вм-агдистер и](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) выберите **шаблон Deploy to Azure,** чтобы запустить шаблон быстрого запуска на портале Azure.
1. Заполните необходимые поля для настройки внутреннего баланса нагрузки и создайте слушателя группы доступности. Вы можете оставить дополнительные поля пустыми. 

   В следующей таблице показаны необходимые значения для шаблона: 

   | **Поле** | Значение |
   | --- | --- |
   |**Группа ресурсов** | Группа ресурсов, в которой размещены виртуальные машины SQL Server и группа доступности. | 
   |**Existing Failover Cluster Name** (Имя существующего отказоустойчивого кластера) | Имя кластера, к которому присоединены виртуальные машины SQL Server. |
   | **Existing Sql Availability Group** (Существующая группа доступности SQL)| Имя группы доступности, в которую входят виртуальные машины SQL Server. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Имена виртуальных машин SQL Server, которые входят в указанную выше группу доступности. Отделите имена с запятой и пространством (например, *S'LVM1, S'LVM2).* |
   | **Прослушивателя** | Имя DNS, которое вы хотите назначить слушателю. По умолчанию этот шаблон определяет имя "aglistener", но вы можете изменить его. Имя не должно превышать 15 символов. |
   | **Прослушивающий порт** | Порт, который вы хотите, чтобы слушатель использовать. Как правило, этот порт должен быть по умолчанию 1433. Это номер порта, который определяет шаблон. Но если порт по умолчанию был изменен, порт слушателя должен использовать это значение. | 
   | **Прослушиватель IP-адреса** | IP-адрес, который вы хотите, чтобы слушатель использовать. Этот адрес будет создан во время развертывания шаблона, поэтому укажите тот, который еще не используется.  |
   | **Existing Subnet** (Существующая подсеть) | Название внутренней подсети вашего VMs-сервера S'L (например: *по умолчанию).* Вы можете определить это значение, перейдя в **Resource Group,** выбрав виртуальную сеть, выбрав **подсети** в панели **настроек** и скопируя значение под **name.** |
   | **Existing Internal Load Balancer** (Существующий внутренний ресурс Load Balancer) | Название внутреннего балансиста нагрузки, созданного в шаге 3. |
   | **Порт пробы:** | Порт зонда, который вы хотите использовать балансереру внутренней нагрузки. Шаблон использует 59999 по умолчанию, но вы можете изменить это значение. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями, выберите **I Согласен с условиями, указанными выше** флажок. Выберите **«Покупка»,** чтобы завершить развертывание шаблона quickstart. 
1. Чтобы контролировать развертывание, выберите развертывание из значка **колокола уведомлений** в верхнем навигационном баннере или перейдите в **группу ресурсов** на портале Azure. Выберите **развертывания** в **настройках**и выберите развертывание **Microsoft.Template.** 

>[!NOTE]
>Если развертывание не удается на полпути, вам нужно будет вручную [удалить вновь созданного слушателя](#remove-the-availability-group-listener) с помощью PowerShell, прежде чем передислоцировать **101-кв.кв.м-aglistener-настройка** quickstart шаблона. 

## <a name="remove-the-availability-group-listener"></a>Удалить слушателя группы доступности
Если позже необходимо удалить слушателя группы доступности, настроенного на шаблон, необходимо пройти через поставщика ресурсов S'L VM. Поскольку слушатель зарегистрирован через поставщика ресурсов S'L VM, простого удаляния его через студию управления серверами S'L недостаточно. 

Наилучшим методом является удаление его через поставщика ресурсов S'L VM, используя следующий фрагмент кода в PowerShell. Это удаляет метаданные группы слушателей доступности из поставщика ресурсов S'L VM. Он также физически удаляет слушателя из группы доступности. 

```PowerShell
# Remove the availability group listener
# example: Remove-AzResource -ResourceId '/subscriptions/a1a11a11-1a1a-aa11-aa11-1aa1a11aa11a/resourceGroups/SQLAG-RG/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/Cluster/availabilitygrouplisteners/aglistener' -Force
Remove-AzResource -ResourceId '/subscriptions/<SubscriptionID>/resourceGroups/<resource-group-name>/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/<cluster-name>/availabilitygrouplisteners/<listener-name>' -Force
```
 
## <a name="common-errors"></a>Распространенные ошибки
В этом разделе описаны некоторые известные проблемы и возможные способы их устранения. 

### <a name="availability-group-listener-for-availability-group-ag-name-already-exists"></a>Прослушиватель группы доступности для группы доступности "\<имя_группы_доступности>" уже существует
Выбранная группа доступности, используемая в шаблоне быстрого запуска Azure для слушателя группы доступности, уже содержит слушателя. Либо он физически входит в группу доступности, либо его метаданные остаются в пределах поставщика ресурсов S'L VM. Удалите слушателя с помощью [PowerShell](#remove-the-availability-group-listener) перед передислокацией шаблона быстрого запуска **101 кв.м.-вм-аглистер-установки.** 

### <a name="connection-only-works-from-primary-replica"></a>Подключение работает только из первичной реплики
Такое поведение, скорее всего, связано с неудавшимся развертыванием шаблона **101-sql-vm-aglistener-setup,** которое оставило конфигурацию баланса внутренней нагрузки в несогласованном состоянии. Убедитесь, что в серверном пуле отображается группа доступности, и что есть правила для зонда работоспособности и для балансировки нагрузки. Если чего-то не хватает, конфигурация баланса внутренней нагрузки является несовместимым состоянием. 

Чтобы разрешить это поведение, удалите слушателя с помощью [PowerShell,](#remove-the-availability-group-listener)удалите внутренний балансик нагрузки через портал Azure и начните снова с шага 3. 

### <a name="badrequest---only-sql-virtual-machine-list-can-be-updated"></a>Неправильный запрос — можно обновить только список виртуальных машин SQL
Эта ошибка может возникнуть при развертывании шаблона **101-sql-vm-aglistener-setup,** если слушатель был удален через s'L Server Management Studio (SSMS), но не был удален из поставщика ресурсов S'L VM. Удаление слушателя с помощью SSMS не удаляет метаданные слушателя из поставщика ресурсов S'L VM. Слушатель должен быть удален из поставщика ресурсов через [PowerShell](#remove-the-availability-group-listener). 

### <a name="domain-account-does-not-exist"></a>Несуществующая учетная запись домена
Эта ошибка может иметь две причины. Либо указанная учетная запись домена не существует, либо отсутствуют данные [основного имени пользователя (UPN).](/windows/desktop/ad/naming-properties#userprincipalname) **Шаблон установки 101 кв.м.-вм-аг-установки** ожидает, что *user@domain.com*учетная запись домена в форме UPN (т.е.), но некоторые учетные записи домена могут отсутствовать. Обычно это происходит, когда локальный пользователь был перенесен в первую учетную запись администратора домена, когда сервер был повышен до контроллера домена, или когда пользователь был создан через PowerShell. 

Убедитесь, что учетная запись существует. Если это так, вы можете быть запущены во второй ситуации. Чтобы решить эту проблему, сделайте следующее:

1. На контроллере домена откройте окно **Пользователи и компьютеры Active Directory** из параметра **Средства** в **Диспетчере серверов**. 
2. Перейдите к учетной записи, выбрав **пользователей** в левом стеле.
3. Нажмите справа на учетную запись и выберите **Свойства**.
4. Выберите вкладку **Счета.** Если поле **для имен входа пользователя** пусто, это является причиной ошибки. 

    ![Пустая учетная запись пользователя указывает на отсутствие UPN](media/virtual-machines-windows-sql-availability-group-quickstart-template/account-missing-upn.png)

5. Заполните поле **для входа пользователя** в поле для входа в систему пользователя, чтобы соответствовать имени пользователя, и выберите подходящий домен из списка выпадающих. 
6. Выберите **Применить**, чтобы сохранить изменения, и закройте диалоговое окно, выбрав **ОК**. 

После внесения этих изменений попробуйте еще раз развернуть шаблон быстрого запуска Azure. 



## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих статьях: 

* [Обзор VMs-серверов S'L](virtual-machines-windows-sql-server-iaas-overview.md)
* [Часто задаваемые вопросы для VMs-серверов S'L](virtual-machines-windows-sql-server-iaas-faq.md)
* [Руководство по ценообразованию для VMs-серверов S'L](virtual-machines-windows-sql-server-pricing-guidance.md)
* [Выпуск примечаний для VMs-сервера S'L](virtual-machines-windows-sql-server-iaas-release-notes.md)
* [Изменение модели лицензирования для виртуальной машины SQL Server](virtual-machines-windows-sql-ahb.md)



