---
title: Настройка группы доступности (шаблон быстрого запуска Azure)
description: Используйте шаблоны быстрого запуска Azure для создания отказоустойчивого кластера Windows, присоедините SQL Server виртуальные машины к кластеру, создайте прослушиватель и настройте внутреннюю подсистему балансировки нагрузки в Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: craigg
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 01/04/2019
ms.author: mathoma
ms.reviewer: jroth
ms.custom: seo-lt-2019
ms.openlocfilehash: edf810dfc975eebaf261eac7b89106c9e29c759c
ms.sourcegitcommit: 49cf9786d3134517727ff1e656c4d8531bbbd332
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/13/2019
ms.locfileid: "74022384"
---
# <a name="use-azure-quickstart-templates-to-configure-an-availability-group-for-sql-server-on-an-azure-vm"></a>Использование шаблонов быстрого запуска Azure для настройки группы доступности для SQL Server на виртуальной машине Azure
В этой статье описывается, как использовать шаблоны быстрого запуска Azure для частичной автоматизации развертывания Always On конфигурации группы доступности для SQL Server виртуальных машин в Azure. В этом процессе используются два шаблона быстрого запуска Azure: 

   | шаблона | ОПИСАНИЕ |
   | --- | --- |
   | [101-sql-vm-ag-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) | Создает отказоустойчивый кластер Windows и присоединяет к нему SQL Server виртуальные машины. |
   | [101-sql-vm-aglistener-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) | Создает прослушиватель группы доступности и настраивает внутренний балансировщик нагрузки. Этот шаблон можно использовать, только если отказоустойчивый кластер Windows был создан с помощью шаблона **101-SQL-VM-AG-Setup** . |
   | &nbsp; | &nbsp; |

Другие части конфигурации группы доступности должны выполняться вручную, например создать группу доступности и создать внутреннюю подсистему балансировки нагрузки. В этой статье описана последовательность автоматизированных и выполняемых вручную действий.
 

## <a name="prerequisites"></a>предварительным требованиям 
Чтобы автоматизировать настройку группы доступности Always On с помощью шаблонов быстрого запуска, необходимо выполнить следующие предварительные требования. 
- [Подписка Azure](https://azure.microsoft.com/free/).
- Группа ресурсов с контроллером домена. 
- Одна или несколько виртуальных машин, присоединенных к домену, [в Azure под управлением SQL Server 2016 (или более поздней версии) Enterprise Edition](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision) , которые находятся в одной группе доступности или зоне доступности и [зарегистрированы в ПОСТАВЩИКЕ ресурсов виртуальной машины SQL](virtual-machines-windows-sql-register-with-resource-provider.md).  
- Два доступных (не используемых в сущности) IP-адреса: один для внутреннего балансировщика нагрузки и один для прослушивателя группы доступности в той же подсети, что и группа доступности. Если используется имеющаяся подсистема балансировки нагрузки, вам нужен только один доступный IP-адрес.  

## <a name="permissions"></a>Разрешения
Для настройки группы доступности Always On с помощью шаблонов быстрого запуска Azure необходимы следующие разрешения. 

- Существующая учетная запись пользователя домена, имеющая разрешение на **Создание объекта Computer** в домене.  Например, учетная запись администратора домена обычно имеет достаточные разрешения (например, account@domain.com). _Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера._
- Учетная запись пользователя домена, управляющая службой SQL Server. 


## <a name="step-1-create-the-failover-cluster-and-join-sql-server-vms-to-the-cluster-by-using-a-quickstart-template"></a>Шаг 1. Создание отказоустойчивого кластера и присоединение SQL Server виртуальных машин к кластеру с помощью шаблона быстрого запуска 
После регистрации SQL Server виртуальных машин с помощью поставщика ресурсов виртуальной машины SQL можно присоединить SQL Server виртуальные машины к *склвиртуалмачинеграупс*. Этот ресурс определяет метаданные отказоустойчивого кластера Windows. Метаданные включают версию, выпуск, полное доменное имя, Active Directory учетные записи для управления кластером и службой SQL Server, а также учетную запись хранения в качестве облачного следящего сервера. 

Добавление виртуальных машин SQL Server в группу ресурсов *SqlVirtualMachineGroups* запускает службу отказоустойчивого кластера Windows для создания кластера, а затем присоединяет эти виртуальные машины SQL Server к этому кластеру. Этот шаг автоматизирован с помощью шаблона быстрого запуска **101-SQL-VM-AG-Setup** . Его можно реализовать, выполнив следующие действия.

1. Перейдите к шаблону быстрого запуска [**101-SQL-VM-AG-Setup**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) . Затем выберите **развернуть в Azure** , чтобы открыть шаблон быстрого запуска на портал Azure.
1. Заполните обязательные поля, чтобы настроить метаданные для отказоустойчивого кластера Windows. Необязательные поля можно оставить пустыми.

   В следующей таблице показаны необходимые значения для шаблона. 

   | **Поле** | Значение |
   | --- | --- |
   | **Подписка** |  Подписка, в которой находятся ваши виртуальные машины SQL Server. |
   |**Группа ресурсов** | Группа ресурсов, где находятся ваши виртуальные машины SQL Server. | 
   |**Failover Cluster Name** (Имя отказоустойчивого кластера) | Имя, которое требуется для нового отказоустойчивого кластера Windows. |
   | **Existing Vm List** (Список существующих виртуальных машин) | SQL Server виртуальные машины, которые вы хотите участвовать в группе доступности и являющиеся частью этого нового кластера. Разделяйте эти значения запятой и пробелом (например: *sqlvm1 именем, SQLVM2*). |
   | **Версия SQL Server** | SQL Server версию виртуальных машин SQL Server. Выберите его из раскрывающегося списка. В настоящее время поддерживаются только образы SQL Server 2016 и SQL Server 2017. |
   | **Existing Fully Qualified Domain Name** (Существующее полное доменное имя) | Полное доменное имя существующего домена, в котором находятся виртуальные машины SQL Server. |
   | **Existing Domain Account** (Учетная запись существующего домена) | Существующая учетная запись пользователя домена, имеющая разрешение на **Создание объекта Computer** в домене, что и [CNO](/windows-server/failover-clustering/prestage-cluster-adds) , создается во время развертывания шаблона. Например, учетная запись администратора домена обычно имеет достаточные разрешения (например, account@domain.com). *Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера.*| 
   | **Domain Account Password** (Пароль к учетной записи домена) | Пароль для указанной выше учетной записи пользователя домена. | 
   | **Existing Sql Service Account** (Существующая учетная запись службы SQL Server) | Учетная запись пользователя домена, управляющая [службой SQL Server](/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions) во время развертывания группы доступности (например, account@domain.com). |
   | **Sql Service Password** (Пароль службы SQL) | Пароль для учетной записи пользователя домена, которая используется для управления службой SQL Server. |
   | **Имя облака-свидетеля** | Новая учетная запись хранения Azure, которая будет создана и использована для облака-свидетеля. Это имя можно изменить. |
   | **Расположение \_артефактов** | Это поле имеет значение по умолчанию, и его можно изменить. |
   | **Маркер SAS расположения \_артефактов** | Это поле намеренно оставлено пустым. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями, установите флажок **я принимаю условия** , указанные выше. Затем выберите **приобрести** , чтобы завершить развертывание шаблона быстрого запуска. 
1. Чтобы отслеживать развертывание, выберите развертывание на значке колокольчика **уведомления** в верхнем баннере навигации или перейдите к **группе ресурсов** в портал Azure. Выберите **развертывания** в разделе **Параметры**и выберите развертывание **Microsoft. Template** . 

>[!NOTE]
> Учетные данные, указанные во время развертывания шаблона, сохраняются только в течение всего развертывания. После завершения развертывания эти пароли удаляются. Вам будет предложено предоставить их снова, если в кластер добавляются дополнительные SQL Server виртуальные машины. 


## <a name="step-2-manually-create-the-availability-group"></a>Шаг 2. Создание группы доступности вручную 
Вручную создайте группу доступности, как обычно, с помощью [SQL Server Management Studio](/sql/database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio), [PowerShell](/sql/database-engine/availability-groups/windows/create-an-availability-group-sql-server-powershell)или [Transact-SQL](/sql/database-engine/availability-groups/windows/create-an-availability-group-transact-sql). 

>[!IMPORTANT]
> *Не* создавайте прослушиватель в данный момент, так как шаблон быстрого запуска **101-SQL-VM-аглистенер-Setup** автоматически выполняет эту операцию на шаге 4. 

## <a name="step-3-manually-create-the-internal-load-balancer"></a>Шаг 3. создание внутренней подсистемы балансировки нагрузки вручную
Прослушивателю группы доступности Always On требуется внутренний экземпляр Azure Load Balancer. Внутренний балансировщик нагрузки предоставляет "плавающий" IP-адрес для прослушивателя группы доступности, который обеспечивает более быструю отработку отказа и повторное подключение. Если SQL Server виртуальные машины в группе доступности входят в одну группу доступности, можно использовать базовую подсистему балансировки нагрузки. В противном случае необходимо использовать стандартный балансировщик нагрузки. 

> [!IMPORTANT]
> Внутренняя подсистема балансировки нагрузки должна находиться в той же виртуальной сети, что и SQL Server экземпляры виртуальных машин. 

Вам нужно просто создать внутреннюю подсистему балансировки нагрузки. На шаге 4 шаблон быстрого запуска **101-SQL-VM-аглистенер-Setup** обрабатывает оставшуюся часть конфигурации (например, внутренний пул, проба работоспособности и правила балансировки нагрузки). 

1. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. 
2. В группе ресурсов выберите **Добавить**.
3. Найдите **балансировщик нагрузки**. В результатах поиска выберите **Load Balancer**, опубликованный **корпорацией Майкрософт**.
4. В колонке **Load Balancer** выберите **создать**.
5. В диалоговом окне **Создание подсистемы балансировки нагрузки** настройте подсистему балансировки нагрузки, задав следующие параметры:

   | Настройка | Значение |
   | --- | --- |
   | **имя** |Введите текстовое имя, представляющее подсистему балансировки нагрузки. Например, введите **sqlLB**. |
   | **Тип** |**Внутренний.** Большинство реализаций используют внутреннюю подсистему балансировки нагрузки, которая позволяет приложениям, работающим в одной и той же виртуальной сети, подключаться к группе доступности.  </br> **External**: позволяет приложениям подключаться к группе доступности через общедоступное подключение к Интернету. |
   | **Виртуальная сеть** | Выберите виртуальную сеть, в которой расположены экземпляры SQL Server. |
   | **Подсеть** | Выберите подсеть, в которой расположены экземпляры SQL Server. |
   | **Назначение IP-адресов** |**Статическое** |
   | **Частный IP-адрес** | Укажите свободный IP-адрес из нужной подсети. |
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Обычно это та же подписка, что и все ресурсы для группы доступности. |
   | **Группа ресурсов** |Выберите группу ресурсов, в которой расположены экземпляры SQL Server. |
   | **Местоположение.** |Выберите расположение Azure, в котором расположены экземпляры SQL Server. |
   | &nbsp; | &nbsp; |

6. Нажмите кнопку **Создать**. 


>[!IMPORTANT]
> Ресурс общедоступного IP-адреса для каждой SQL Server виртуальной машины должен иметь стандартный SKU, совместимый с подсистемой балансировки нагрузки уровня "Стандартный". Чтобы определить номер SKU ресурса общедоступных IP-адресов виртуальной машины, перейдите в раздел **Группа ресурсов**, выберите ресурс **общедоступного IP-адреса** для SQL Server виртуальной машины и найдите значение в разделе **SKU** в области **Обзор** . 

## <a name="step-4-create-the-availability-group-listener-and-configure-the-internal-load-balancer-by-using-the-quickstart-template"></a>Шаг 4. Создание прослушивателя группы доступности и Настройка внутреннего балансировщика нагрузки с помощью шаблона быстрого запуска

Создайте прослушиватель группы доступности и настройте внутренний балансировщик нагрузки автоматически с помощью шаблона быстрого запуска **101-SQL-VM-аглистенер-Setup** . Шаблон подготавливает ресурс Microsoft. Склвиртуалмачине/Склвиртуалмачинеграупс/Аваилабилитиграуплистенер. Шаблон быстрого запуска **101-sql-vm-aglistener-setup** позволяет выполнить следующие действия через поставщик ресурсов виртуальной машины SQL:

- Создает новый ресурс протокола IP внешнего интерфейса (на основе значения IP-адреса, предоставленного во время развертывания) для прослушивателя. 
- Настраивает параметры сети для кластера и внутренней подсистемы балансировки нагрузки. 
- Настраивает внутренний пул для внутреннего балансировщика нагрузки, проверки работоспособности и правил балансировки нагрузки.
- Создает прослушиватель группы доступности с заданным IP-адресом и именем.
 
>[!NOTE]
> Вы можете использовать **101-SQL-VM-аглистенер-Setup** , только если отказоустойчивый кластер Windows был создан с помощью шаблона **101-SQL-VM-AG-Setup** .
   
   
Чтобы настроить внутренний балансировщик нагрузки и создать прослушиватель группы доступности, выполните следующие действия.
1. Перейдите к шаблону быстрого запуска [101-SQL-VM-аглистенер-Setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) и выберите **развернуть в Azure** , чтобы запустить шаблон краткого руководства на портал Azure.
1. Заполните обязательные поля, чтобы настроить внутренний балансировщик нагрузки, и создайте прослушиватель группы доступности. Необязательные поля можно оставить пустыми. 

   В следующей таблице показаны необходимые значения для шаблона. 

   | **Поле** | Значение |
   | --- | --- |
   |**Группа ресурсов** | Группа ресурсов, в которой размещены виртуальные машины SQL Server и группа доступности. | 
   |**Existing Failover Cluster Name** (Имя существующего отказоустойчивого кластера) | Имя кластера, к которому присоединены виртуальные машины SQL Server. |
   | **Existing Sql Availability Group** (Существующая группа доступности SQL)| Имя группы доступности, в которую входят виртуальные машины SQL Server. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Имена виртуальных машин SQL Server, которые входят в указанную выше группу доступности. Разделяйте имена запятой и пробелом (например: *sqlvm1 именем, SQLVM2*). |
   | **Прослушиватель** | DNS-имя, которое необходимо назначить прослушивателю. По умолчанию этот шаблон задает имя «аглистенер», но его можно изменить. Имя не должно превышать 15 символов. |
   | **Listener Port** (Порт прослушивателя) | Порт, который должен использоваться прослушивателем. Как правило, этот порт должен быть значением по умолчанию 1433. Номер порта, который указывает шаблон. Но если порт по умолчанию был изменен, то порт прослушивателя должен использовать это значение. | 
   | **Прослушиватель IP-адреса** | IP-адрес, который должен использовать прослушиватель. Этот адрес будет создан во время развертывания шаблона, поэтому укажите, что он еще не используется.  |
   | **Existing Subnet** (Существующая подсеть) | Имя внутренней подсети SQL Server виртуальных машин (например: *по умолчанию*). Это значение можно определить, перейдя в **группу ресурсов**, выбрав виртуальную сеть, выбрав **подсети** в области **Параметры** и скопировав значение в поле **имя**. |
   | **Existing Internal Load Balancer** (Существующий внутренний ресурс Load Balancer) | Имя внутренней подсистемы балансировки нагрузки, созданной на шаге 3. |
   | **Порт пробы** | Порт пробы, который будет использоваться внутренней подсистемой балансировки нагрузки. В шаблоне по умолчанию используется 59999, но это значение можно изменить. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями, установите флажок **я принимаю условия** , указанные выше. Выберите **приобрести** , чтобы завершить развертывание шаблона быстрого запуска. 
1. Чтобы отслеживать развертывание, выберите развертывание на значке колокольчика **уведомления** в верхнем баннере навигации или перейдите к **группе ресурсов** в портал Azure. Выберите **развертывания** в разделе **Параметры**и выберите развертывание **Microsoft. Template** . 

>[!NOTE]
>Если развертывание завершается со сбоем на середине, необходимо вручную [удалить вновь созданный прослушиватель](#remove-the-availability-group-listener) с помощью PowerShell перед повторной развертыванием шаблона быстрого запуска **101-SQL-VM-аглистенер-Setup** . 

## <a name="remove-the-availability-group-listener"></a>Удаление прослушивателя группы доступности
Если позже потребуется удалить прослушиватель группы доступности, настроенный для этого шаблона, необходимо пройти по поставщику ресурсов виртуальной машины SQL. Так как прослушиватель зарегистрирован с помощью поставщика ресурсов виртуальной машины SQL, просто его удаление с помощью SQL Server Management Studio недостаточно. 

Лучший способ — удалить его с помощью поставщика ресурсов виртуальной машины SQL, используя следующий фрагмент кода в PowerShell. При этом удаляются метаданные прослушивателя группы доступности из поставщика ресурсов виртуальной машины SQL. Он также физически удаляет прослушиватель из группы доступности. 

```PowerShell
# Remove the availability group listener
# example: Remove-AzResource -ResourceId '/subscriptions/a1a11a11-1a1a-aa11-aa11-1aa1a11aa11a/resourceGroups/SQLAG-RG/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/Cluster/availabilitygrouplisteners/aglistener' -Force
Remove-AzResource -ResourceId '/subscriptions/<SubscriptionID>/resourceGroups/<resource-group-name>/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/<cluster-name>/availabilitygrouplisteners/<listener-name>' -Force
```
 
## <a name="common-errors"></a>Распространенные ошибки
В этом разделе описаны некоторые известные проблемы и возможные способы их устранения. 

### <a name="availability-group-listener-for-availability-group-ag-name-already-exists"></a>Прослушиватель группы доступности для группы доступности "\<имя_группы_доступности>" уже существует
Выбранная группа доступности, используемая в шаблоне быстрого запуска Azure для прослушивателя группы доступности, уже содержит прослушиватель. Либо он физически находится в группе доступности, либо его метаданные остаются в поставщике ресурсов виртуальной машины SQL. Удалите прослушиватель с помощью [PowerShell](#remove-the-availability-group-listener) , прежде чем повторно развернуть шаблон быстрого запуска **101-SQL-VM-аглистенер-Setup** . 

### <a name="connection-only-works-from-primary-replica"></a>Подключение работает только из первичной реплики
Это может быть вызвано сбоем развертывания шаблона **101-SQL-VM-аглистенер-** Configuration, которое оставляет конфигурацию внутренней подсистемы балансировки нагрузки в нестабильном состоянии. Убедитесь, что в серверном пуле отображается группа доступности, и что есть правила для зонда работоспособности и для балансировки нагрузки. Если что-либо отсутствует, конфигурация внутренней подсистемы балансировки нагрузки находится в нестабильном состоянии. 

Чтобы устранить эту проблему, удалите прослушиватель с помощью [PowerShell](#remove-the-availability-group-listener), удалите внутренний балансировщик нагрузки через портал Azure и снова запустите шаг 3. 

### <a name="badrequest---only-sql-virtual-machine-list-can-be-updated"></a>Неправильный запрос — можно обновить только список виртуальных машин SQL
Эта ошибка может возникать при развертывании шаблона **101-SQL-VM-аглистенер-Setup** , если прослушиватель был удален с помощью SQL Server Management Studio (SSMS), но он не был удален из поставщика ресурсов ВИРТУАЛЬНОЙ машины SQL. Удаление прослушивателя с помощью SSMS не приводит к удалению метаданных прослушивателя из поставщика ресурсов виртуальной машины SQL. Прослушиватель должен быть удален из поставщика ресурсов с помощью [PowerShell](#remove-the-availability-group-listener). 

### <a name="domain-account-does-not-exist"></a>Несуществующая учетная запись домена
Эта ошибка может быть вызвана двумя причинами. Либо указанная учетная запись домена не существует, либо отсутствуют данные [имени участника-пользователя (UPN)](/windows/desktop/ad/naming-properties#userprincipalname) . Для шаблона **101-SQL-VM-AG-Setup** требуется учетная запись домена в форме UPN (то есть *user@domain.com* ), но некоторые учетные записи домена могут отсутствовать. Обычно это происходит, когда локальный пользователь переносится в первую учетную запись администратора домена, когда сервер был повышен до контроллера домена, или когда пользователь был создан с помощью PowerShell. 

Убедитесь, что учетная запись существует. Если это так, возможно, вы работаете во второй ситуации. Чтобы устранить эту проблему, выполните следующие действия.

1. На контроллере домена откройте окно **Пользователи и компьютеры Active Directory** из параметра **Средства** в **Диспетчере серверов**. 
2. Перейдите к учетной записи, выбрав **пользователей** в левой области.
3. Щелкните учетную запись правой кнопкой мыши и выберите пункт **Свойства**.
4. Перейдите на вкладку **учетная запись** . Если поле **имя входа пользователя** пустое, это является причиной ошибки. 

    ![Пустая учетная запись пользователя указывает на отсутствие UPN](media/virtual-machines-windows-sql-availability-group-quickstart-template/account-missing-upn.png)

5. Заполните поле **имя входа пользователя** , чтобы оно соответствовало имени пользователя, и выберите нужный домен из раскрывающегося списка. 
6. Выберите **Применить**, чтобы сохранить изменения, и закройте диалоговое окно, выбрав **ОК**. 

После внесения этих изменений попробуйте развернуть шаблон быстрого запуска Azure еще раз. 



## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения см. в следующих статьях: 

* [Обзор SQL Server виртуальных машин](virtual-machines-windows-sql-server-iaas-overview.md)
* [Часто задаваемые вопросы о SQL Server виртуальных машинах](virtual-machines-windows-sql-server-iaas-faq.md)
* [Руководство по ценам для SQL Server виртуальных машин](virtual-machines-windows-sql-server-pricing-guidance.md)
* [Заметки о выпуске для SQL Server виртуальных машин](virtual-machines-windows-sql-server-iaas-release-notes.md)
* [Изменение модели лицензирования для виртуальной машины SQL Server](virtual-machines-windows-sql-ahb.md)



