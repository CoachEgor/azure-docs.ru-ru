---
title: Используйте шаблоны быстрого запуска Azure для настройки группы доступности AlwaysOn для SQL Server на виртуальной Машине Azure
description: Используйте шаблоны быстрого запуска Azure для создания Windows отказоустойчивого кластера, присоединения к кластеру виртуальных машин SQL Server, создайте прослушиватель и настройка внутренней подсистемы балансировки нагрузки в Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: craigg
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 01/04/2019
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 406bd11765e4b580849e8719939c3e11c19d99a8
ms.sourcegitcommit: f10ae7078e477531af5b61a7fe64ab0e389830e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/05/2019
ms.locfileid: "67604571"
---
# <a name="use-azure-quickstart-templates-to-configure-always-on-availability-group-for-sql-server-on-an-azure-vm"></a>Используйте шаблоны быстрого запуска Azure для настройки группы доступности AlwaysOn для SQL Server на виртуальной Машине Azure
В этой статье объясняется, как использовать шаблоны быстрого запуска Azure для частично автоматизированного развертывания в Azure конфигурации с группой доступности Always On для виртуальных машин SQL Server. В этом процессе используются два шаблона быстрого запуска Azure. 

   | Шаблон | Описание |
   | --- | --- |
   | [101-sql-vm-ag-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) | Позволяет создать отказоустойчивый кластер Windows и присоединить к нему виртуальные машины SQL Server. |
   | [101-sql-vm-aglistener-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) | Позволяет создать прослушиватель группы доступности и настроить внутренний ресурс Load Balancer. Этот шаблон можно использовать только в том случае, если отказоустойчивый кластер Windows был создан с шаблоном **101-sql-vm-ag-setup**. |
   | &nbsp; | &nbsp; |

Остальные действия по созданию конфигурации группы доступности, в том числе создание группы доступности и внутреннего ресурса Load Balancer, выполняются вручную. В этой статье описана последовательность автоматизированных и выполняемых вручную действий.
 

## <a name="prerequisites"></a>предварительные требования 
Чтобы автоматизировать настройку группы доступности Always On с помощью шаблонов быстрого запуска, требуется следующее: 
- [подписка Azure](https://azure.microsoft.com/free/);
- Группа ресурсов с контроллером домена. 
- одна или несколько присоединенных к домену [виртуальных машин Azure под управлением SQL Server Enterprise Edition 2016 (или более поздней версии)](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-portal-sql-server-provision), размещенных в той же группе или зоне доступности, которая [зарегистрирована в поставщике ресурсов виртуальной машины SQL](virtual-machines-windows-sql-register-with-resource-provider.md).  
- (Не используется для любой сущности) доступны два IP-адреса, один для внутренней подсистемы балансировки нагрузки и один для прослушивателя группы доступности в пределах той же подсети, что группы доступности. Если используется существующий балансировщик нагрузки, требуется только один доступный IP-адрес.  

## <a name="permissions"></a>Разрешения
Для настройки группы доступности AlwaysOn с помощью шаблонов быстрого запуска Azure необходимы следующие разрешения: 

- Существующей учетной записи домена, имеющую разрешение на «Создание объекта компьютера» в домене.  Например, учетная запись администратора домена обычно имеет соответствующие разрешения (например: account@domain.com). _Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера._
- Учетная запись пользователя домена, который управляет служба SQL Server. 


## <a name="step-1---create-the-wsfc-and-join-sql-server-vms-to-the-cluster-using-quickstart-template"></a>Шаг 1. Создание кластера WSFC и присоединение виртуальных машин SQL Server к этому кластеру с помощью шаблона быстрого запуска 
Когда вы завершите регистрацию виртуальных машин SQL Server в новом поставщике ресурсов виртуальной машины SQL, можно будет объединить эти виртуальные машины SQL Server в группе *SqlVirtualMachineGroup*. Этот ресурс определяет метаданные отказоустойчивого кластера Windows, в том числе версию, выпуск, полное доменное имя, учетные записи AD для управления кластером, службой SQL и учетной записью хранения для роли облака-свидетеля. Добавление виртуальных машин SQL Server в группу ресурсов *SqlVirtualMachineGroups* запускает службу отказоустойчивого кластера Windows для создания кластера, а затем присоединяет эти виртуальные машины SQL Server к этому кластеру. Этот этап автоматизируется с помощью шаблона быстрого запуска **101-sql-vm-ag-setup**. Для его реализации выполните указанные ниже действия.

1. На портале Azure перейдите к шаблону быстрого запуска [**101-sql-vm-ag-setup**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) и выберите действие **Развертывание в Azure**, чтобы запустить этот шаблон быстрого запуска.
1. Заполните все обязательные поля, чтобы настроить метаданные отказоустойчивого кластера Windows. Необязательные поля можно оставить пустыми.

    В приведенной ниже таблице представлены необходимые значения для этого шаблона. 

   | **Поле** | Значение |
   | --- | --- |
   | **Подписка** |  Подписка, в которой находятся ваши виртуальные машины SQL Server. |
   |**Группа ресурсов** | Группа ресурсов, где находятся ваши виртуальные машины SQL Server. | 
   |**Failover Cluster Name** (Имя отказоустойчивого кластера) | Имя, которое вы выбрали для нового отказоустойчивого кластера Windows. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Виртуальные машины SQL Server, которые вы хотите разместить в этой группе доступности, а значит, и в новом кластере. Разделите эти значения запятыми с пробелом (например, так: SQLVM1, SQLVM2). |
   | **Версия SQL Server** | Выберите в раскрывающемся списке версию SQL Server для виртуальных машин SQL Server. Сейчас поддерживаются только образы SQL 2016 и SQL 2017. |
   | **Existing Fully Qualified Domain Name** (Существующее полное доменное имя) | Полное доменное имя существующего домена, в котором находятся виртуальные машины SQL Server. |
   | **Existing Domain Account** (Учетная запись существующего домена) | Существующая учетная запись пользователя домена, у которой есть разрешение на "Создание объект-компьютера" в домене, похожее на [CNO](/windows-server/failover-clustering/prestage-cluster-adds), создается во время развертывания шаблона. Например, учетная запись администратора домена обычно имеет соответствующие разрешения (например: account@domain.com). *Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера.*| 
   | **Domain Account Password** (Пароль к учетной записи домена) | Пароль для указанной выше учетной записи пользователя домена. | 
   | **Existing Sql Service Account** (Существующая учетная запись службы SQL Server) | Учетная запись пользователя домена, которая контролирует [службу SQL Server](/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions) во время развертывания группы доступности (например: account@domain.com). |
   | **Sql Service Password** (Пароль службы SQL) | Пароль для учетной записи пользователя домена, которая используется для управления службой SQL Server. |
   | **Имя облака-свидетеля** | Это новая учетная запись хранения Azure, которая будет создана и использована для облака-свидетеля. Это имя можно изменить. |
   | **Расположение \_артефактов** | Это поле имеет значение по умолчанию, и его можно изменить. |
   | **Маркер SAS расположения \_артефактов** | Это поле остается пустым преднамеренно. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями использования, установите флажок рядом с полем **Я принимаю указанные выше условия** и щелкните **Приобрести**, чтобы завершить развертывание шаблона быстрого запуска. 
1. Чтобы контролировать ход развертывания, выберите это развертывание в списке, который открывается щелчком значка колокольчика (**Уведомления**) на панели навигации вверху, или найдите **группу ресурсов** на портале Azure и выберите элемент **Развертывания** в поле **Параметры**, а затем щелкните развертывание с именем Microsoft.Template. 

   >[!NOTE]
   > Учетные данные, предоставленные во время развертывания шаблона, хранятся только на время выполнения развертывания. После завершения развертывания эти пароли будут удалены, и если вы добавите дополнительные виртуальные машины SQL Server в кластер, вам будет предложено ввести их снова. 


## <a name="step-2---manually-create-the-availability-group"></a>Шаг 2. Создание группы доступности вручную 
Вручную создайте группу доступности, как обычно, с помощью [SQL Server Management Studio](/sql/database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio), [PowerShell](/sql/database-engine/availability-groups/windows/create-an-availability-group-sql-server-powershell), или [Transact-SQL](/sql/database-engine/availability-groups/windows/create-an-availability-group-transact-sql). 

  >[!IMPORTANT]
  > Но на этот раз **не** создавайте прослушиватель, так как это действие автоматизировано в шаблоне быстрого запуска **101-sql-vm-aglistener-setup**, который вы примените на шаге 4. 

## <a name="step-3---manually-create-the-internal-load-balancer-ilb"></a>Шаг 3. Создание внутреннего ресурса Load Balancer (ILB) вручную
Прослушиватель (AG) группы доступности Always On требуется внутренний балансировщик нагрузки Azure (ILB). ILB предоставляет "плавающий" IP-адрес прослушивателю группы доступности, что обеспечивает более быструю отработку отказа и восстановление подключения. Если виртуальные машины SQL Server в группе доступности входят в одну группу доступности, вы можете использовать Load Balancer ценовой категории "Базовый". Если нет, потребуется Load Balancer ценовой категории "Стандартный".  **Подсистема ILB должна находиться в той же виртуальной сети, что и экземпляры виртуальной машины SQL Server.** Вам осталось создать только ILB, а все остальные элементы конфигурации (серверный пул, зонд работоспособности и правила балансировки нагрузки) уже учтены в шаблоне быстрого запуска **101-sql-vm-aglistener-setup**, который вы примените на шаге 4. 

1. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. 
2. В колонке группы ресурсов щелкните **Добавить**.
3. Выполните поиск по запросу **подсистема балансировки нагрузки** и в результатах поиска выберите **Подсистема балансировки нагрузки**, опубликованную корпорацией **Майкрософт**.
4. В колонке **Балансировщик нагрузки** щелкните **Создать**.
5. В диалоговом окне **Создание подсистемы балансировки нагрузки** настройте подсистему балансировки нагрузки, задав следующие параметры:

   | Параметр | Значение |
   | --- | --- |
   | **Name** |Текст, представляющий имя балансировщика нагрузки. Например, **sqlLB**. |
   | **Тип** |**Внутренние**. В большинстве реализаций используется внутренняя подсистема балансировки нагрузки, которая позволяет приложениям в одной и той же виртуальной сети подключаться к группе доступности.  </br> **Внешние**. Позволяет устанавливать общедоступное интернет-подключение к группе доступности. |
   | **Виртуальная сеть** | Выберите виртуальную сеть, в которой расположены экземпляры SQL Server. |
   | **Подсеть** | Выберите подсеть, в которой расположены экземпляры SQL Server. |
   | **Назначение IP-адресов** |**Статические** |
   | **Частный IP-адрес** | Укажите свободный IP-адрес из нужной подсети. |
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Обычно это подписка, с которой связаны все ресурсы группы доступности. |
   | **Группа ресурсов** |Выберите группу ресурсов, в которой расположены экземпляры SQL Server. |
   | **Location** |Выберите расположение Azure, в котором расположены экземпляры SQL Server. |
   | &nbsp; | &nbsp; |

6. Нажмите кнопку **Создать**. 


  >[!IMPORTANT]
  > Ресурс общедоступного IP-адреса для каждой виртуальной машины SQL Server должен иметь номер SKU "Стандартный", чтобы обеспечить совместимость с Load Balancer ценовой категории "Стандартный". Чтобы определить номер SKU для ресурса общедоступного IP-адреса виртуальной машины, найдите **группу ресурсов** и выберите ресурс **Общедоступный IP-адрес** для требуемой виртуальной машины SQL Server, а затем найдите для него значение параметра **Номер SKU** на панели **Обзор**. 

## <a name="step-4---create-the-ag-listener-and-configure-the-ilb-with-the-quickstart-template"></a>Шаг 4. Создание прослушивателя группы доступности и настройка ILB с помощью шаблона быстрого запуска

Создайте прослушиватель группы доступности и настройте внутренний ресурс Load Balancer (ILB) с помощью автоматизированного шаблона быстрого запуска **101-sql-vm-aglistener-setup**, который подготавливает ресурс Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/AvailabilityGroupListener. Шаблон быстрого запуска **101-sql-vm-aglistener-setup** позволяет выполнить следующие действия через поставщик ресурсов виртуальной машины SQL:

 - Создает новый ресурс протокола IP внешнего интерфейса (на основе значения IP-адреса, предоставленного во время развертывания) для прослушивателя. 
 - Настройка параметров сети для кластера и ILB. 
 - Настройка серверного пула ILB, зонда работоспособности и правил балансировки нагрузки.
 - Создание прослушивателя группы доступности с указанными IP-адресом и именем.
 
   >[!NOTE]
   > **101-sql-vm-aglistener-setup** можно использовать только в том случае, если отказоустойчивый кластер Windows был создан с шаблоном **101-sql-vm-ag-setup**.
   
   
Чтобы настроить ILB и прослушиватель группы доступности, выполните описанные ниже действия.
1. На портале Azure перейдите к шаблону быстрого запуска [**101-sql-vm-aglistener-setup**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) и выберите действие **Развертывание в Azure**, чтобы запустить этот шаблон быстрого запуска.
1. Заполните обязательные поля для настройки ILB и создайте прослушиватель группы доступности. Необязательные поля можно оставить пустыми. 

    В приведенной ниже таблице представлены необходимые значения для этого шаблона. 

   | **Поле** | Значение |
   | --- | --- |
   |**Группа ресурсов** | Группа ресурсов, в которой размещены виртуальные машины SQL Server и группа доступности. | 
   |**Existing Failover Cluster Name** (Имя существующего отказоустойчивого кластера) | Имя кластера, к которому присоединены виртуальные машины SQL Server. |
   | **Existing Sql Availability Group** (Существующая группа доступности SQL)| Имя группы доступности, в которую входят виртуальные машины SQL Server. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Имена виртуальных машин SQL Server, которые входят в указанную выше группу доступности. Имена следует разделять запятой с пробелом (например, так: SQLVM1, SQLVM2). |
   | **Прослушиватель** | DNS-имя, которое нужно назначить прослушивателю. По умолчанию в шаблоне указано имя "aglistener", но его можно изменить. Имя не должно превышать 15 символов. |
   | **Listener Port** (Порт прослушивателя) | Порт, который будет использовать прослушиватель. Обычно это стандартный порт 1433, поэтому именно этот номер порта указан в шаблоне. Но если вы изменили порт по умолчанию, то и порт прослушивателя следует изменить аналогичным образом. | 
   | **Прослушиватель IP-адреса** | IP-адрес, который будет использовать прослушиватель.  Этот IP-адрес будет создан во время развертывания шаблона, поэтому укажите IP-адрес, который еще не используется.  |
   | **Existing Subnet** (Существующая подсеть) | *Имя* внутренней подсети, в которой размещена виртуальная машина SQL Server (например, default). Чтобы выяснить это значение, перейдите к элементу **группы ресурсов**, выберите используемую **виртуальную сеть** и **подсеть** на панели **Параметры**, а затем скопируйте значение параметра **Имя**. |
   | **Existing Internal Load Balancer** (Существующий внутренний ресурс Load Balancer) | Имя ресурса ILB, который вы создали на шаге 3. |
   | **Порт пробы** | Порт зонда, который будет использовать ILB. В этом шаблоне указано стандартное значение 59999, но его можно изменить. |
   | &nbsp; | &nbsp; |

1. Если вы согласны с условиями использования, установите флажок рядом с полем **Я принимаю указанные выше условия** и щелкните **Приобрести**, чтобы завершить развертывание шаблона быстрого запуска. 
1. Чтобы контролировать ход развертывания, выберите это развертывание в списке, который открывается щелчком значка колокольчика (**Уведомления**) на панели навигации вверху, или найдите **группу ресурсов** на портале Azure и выберите элемент **Развертывания** в поле **Параметры**, а затем щелкните развертывание с именем Microsoft.Template. 

   >[!NOTE]
   >Если развертывание завершается сбоем в середине процесса, следует вручную [удалить только что созданный прослушиватель](#remove-availability-group-listener) с помощью PowerShell, а затем попытаться повторно развернуть шаблон быстрого запуска **101-sql-vm-aglistener-setup**. 

## <a name="remove-availability-group-listener"></a>Удаление прослушивателя группы доступности
Если вам потребуется удалить прослушиватель группы доступности, настроенный с помощью шаблона, это нужно делать через поставщик ресурсов виртуальной машины SQL. Так как прослушиватель зарегистрирован в поставщике ресурсов виртуальной машины SQL, недостаточно просто удалить его с помощью SQL Server Management Studio. Его нужно удалить еще и в поставщике ресурсов виртуальной машины SQL с помощью команд PowerShell. Таким образом из поставщика ресурсов виртуальной машины SQL удаляются метаданные прослушивателя группы доступности и из группы доступности физически удаляется прослушиватель. 

Следующий фрагмент кода позволяет удалить прослушиватель группы доступности SQL из поставщика ресурсов SQL и из группы доступности: 

```powershell
# Remove the AG listener
# example: Remove-AzResource -ResourceId '/subscriptions/a1a11a11-1a1a-aa11-aa11-1aa1a11aa11a/resourceGroups/SQLAG-RG/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/Cluster/availabilitygrouplisteners/aglistener' -Force
Remove-AzResource -ResourceId '/subscriptions/<SubscriptionID>/resourceGroups/<resource-group-name>/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/<cluster-name>/availabilitygrouplisteners/<listener-name>' -Force
```
 
## <a name="common-errors"></a>Распространенные ошибки
В этом разделе описаны некоторые известные проблемы и возможные способы их устранения. 

### <a name="availability-group-listener-for-availability-group-ag-name-already-exists"></a>Прослушиватель группы доступности для группы доступности "\<имя_группы_доступности>" уже существует
Группа доступности, которая выбрана для прослушивателя группы доступности в шаблоне быстрого запуска, уже содержит прослушиватель. Это может быть физический прослушиватель в группе доступности или метаданные, зарегистрированные в поставщике ресурсов виртуальной машины SQL.  Удалите прослушиватель с помощью [PowerShell](#remove-availability-group-listener), а затем заново разверните шаблон быстрого запуска **101-sql-vm-aglistener-setup**. 

### <a name="connection-only-works-from-primary-replica"></a>Подключение работает только из первичной реплики
Такое поведение чаще всего связано с неудачным развертыванием шаблона **101-sql-vm-aglistener-setup**, которое привело к несогласованности конфигурации ILB. Убедитесь, что в серверном пуле отображается группа доступности, и что есть правила для зонда работоспособности и для балансировки нагрузки. Если что-либо из этого отсутствует, значит, конфигурация ILB находится в несогласованном состоянии. 

Чтобы решить эту проблему, удалите прослушиватель с помощью [PowerShell](#remove-availability-group-listener), затем удалите внутренний ресурс Load Balancer на портале Azure и повторите процесс, начиная с шага 3. 

### <a name="badrequest---only-sql-virtual-machine-list-can-be-updated"></a>Неправильный запрос — можно обновить только список виртуальных машин SQL
Такая ошибка может возникать при развертывании шаблона **101-sql-vm-aglistener-setup**, если прослушиватель был удален с помощью SQL Server Management Studio (SSMS), но не был удален из поставщика ресурсов виртуальной машины SQL. При удалении прослушивателя через SSMS метаданные прослушивателя не удаляются из поставщика ресурсов виртуальной машины SQL. Для их удаления следует использовать [PowerShell](#remove-availability-group-listener). 

### <a name="domain-account-does-not-exist"></a>Несуществующая учетная запись домена
Эта ошибка может возникать по одной из двух причин. Либо указанная учетная запись домена действительно не существует, либо отсутствуют данные [имени участника-пользователя (UPN)](/windows/desktop/ad/naming-properties#userprincipalname). Шаблон **101-sql-vm-ag-setup** ожидает учетную запись домена в форме UPN (т. е. user@domain.com), но некоторые учетные записи домена могут ее пропустить. Как правило, это может происходить, когда локальный пользователь был перенесен в первую учетную запись администратора домена, когда сервер был повышен до контроллера домена или когда пользователь был создан с помощью PowerShell. 

 Убедитесь, что учетная запись действительно существует. Если она существует, вы можете столкнуться со второй ситуацией. Чтобы решить эту проблему, выполните следующие действия.

1. На контроллере домена откройте окно **Пользователи и компьютеры Active Directory** из параметра **Средства** в **Диспетчере серверов**. 
2. Перейдите к учетной записи, выбрав на левой панели раздел **Пользователи**.
3. Щелкните правой кнопкой мыши необходимую учетную запись и выберите **Свойства**.
4. Выберите **Учетную запись** и убедитесь, что поле **Имя входа пользователя** является пустым. Если это так, это и есть причина ошибки. 

    ![Пустая учетная запись пользователя указывает на отсутствие UPN](media/virtual-machines-windows-sql-availability-group-quickstart-template/account-missing-upn.png)

5. Заполните **имя входа пользователя** в соответствии с именем пользователя и выберите соответствующий домен из раскрывающегося списка. 
6. Выберите **Применить**, чтобы сохранить изменения, и закройте диалоговое окно, выбрав **ОК**. 

   После внесения этих изменений попытайтесь развернуть шаблон быстрого запуска Azure еще раз. 



## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения см. в следующих статьях: 

* [Общие сведения о виртуальной машине SQL Server](virtual-machines-windows-sql-server-iaas-overview.md)
* [Часто задаваемые вопросы о виртуальных машинах SQL Server](virtual-machines-windows-sql-server-iaas-faq.md)
* [Руководство по выбору ценовой категории для виртуальных машин SQL Server](virtual-machines-windows-sql-server-pricing-guidance.md)
* [Виртуальная машина SQL Server: заметки о выпуске](virtual-machines-windows-sql-server-iaas-release-notes.md)
* [Изменение модели лицензирования для виртуальной машины SQL Server](virtual-machines-windows-sql-ahb.md)



