---
title: Экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure | Документация Майкрософт
description: В этой статье объясняется, как создать экземпляр кластера сотказа сервера S'L Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MikeRayMSFT
manager: craigg
editor: monicar
tags: azure-service-management
ms.assetid: 9fc761b1-21ad-4d79-bebc-a2f094ec214d
ms.service: virtual-machines-sql
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/11/2018
ms.author: mikeray
ms.openlocfilehash: 20c231e4f3052797eac79a3c97a3d8148690b8c5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79249806"
---
# <a name="configure-a-sql-server-failover-cluster-instance-on-azure-virtual-machines"></a>Наверсвыше нанастройки кластера s'L Server на виртуальных машинах Azure

В этой статье объясняется, как создать экземпляр кластера сотказа сервера S'L Server (FCI) на виртуальных машинах Azure в модели Менеджера ресурсов Azure. Это решение использует [Windows Server 2016 Издание Datacenter Storage Spaces Direct](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview) в качестве программного обеспечения на основе виртуального SAN, который синхронизирует хранилище (диски данных) между узлами (Azure VMs) в кластере Windows. Пространства для хранения данных Direct были новыми в Windows Server 2016.

На следующей схеме показано полное решение на виртуальных машинах Azure.

![Полное решение](./media/virtual-machines-windows-portal-sql-create-failover-cluster/00-sql-fci-s2d-complete-solution.png)

На этой диаграмме показано:

- Два виртуальных компьютера Azure в кластере Windows Server Failover. Когда виртуальная машина находится в кластере failover, она также называется *кластерным узлом* или *узлом.*
- В каждой виртуальной машине есть два или больше дисков данных.
- Storage Spaces Direct синхронизирует данные на дисках данных и представляет синхронизированное хранилище как пул хранения.
- Пул хранения представляет кластерный общий объем (CSV) кластеру failover.
- Роль экземпляра кластера SQL Server FCI использует CSV для дисков данных.
- Azure Load Balancer для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.
- В группе доступности Azure хранятся все ресурсы.

>[!NOTE]
>Все ресурсы Azure на диаграмме находятся в одной и той же группе ресурсов.

Для получения подробной информации о пространствах хранения Direct см. [Windows Server 2016 Издание Datacenter Storage Spaces Direct](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview).

Storage Spaces Direct поддерживает два типа архитектур: конвергентные и гиперконвергентные. В этом документе используется гиперконвергентная архитектура. Гиперконвергентная инфраструктура размещает хранилище на тех же серверах, на которых размещено кластеризованное приложение. В этой архитектуре хранилище находится на каждом узле экземпляра отказоустойчивого кластера SQL Server.

## <a name="licensing-and-pricing"></a>Лицензирование и цены

На виртуальных машинах Azure вы можете лицензировать S'L Server с помощью изображений VM с оплатой по мере использования (PAYG) или приносить собственные лицензии (BYOL). Тип изображения, который вы выбираете, влияет на то, как с вас взимается плата.

При лицензировании с оплатой по мере выполнения, экземпляр кластера с отказом (FCI) сервера S'L на виртуальных машинах Azure берет плату за все узлы FCI, включая пассивные узлы. Дополнительные сведения см. на странице [Цены на виртуальные машины SQL Server Enterprise](https://azure.microsoft.com/pricing/details/virtual-machines/sql-server-enterprise/).

Если у вас есть Корпоративное соглашение с Software Assurance, вы можете использовать один бесплатный пассивный узлы FCI для каждого активного узла. Чтобы воспользоваться преимуществами в Azure, используйте изображения BYOL VM и используйте одну и ту же лицензию как на активных, так и на пассивных узлах FCI. Дополнительные сведения см. в статье о [Соглашении Enterprise](https://www.microsoft.com/Licensing/licensing-programs/enterprise.aspx).

Для сравнения с оплатой по мере работы и лицензированием BYOL для сервера S'L на виртуальных машинах Azure [см.](virtual-machines-windows-sql-server-iaas-overview.md#get-started-with-sql-vms)

Полные сведения о лицензировании SQL Server см. [на странице с ценами](https://www.microsoft.com/sql-server/sql-server-2017-pricing).

### <a name="example-azure-template"></a>Пример шаблона Azure

Вы можете создать все это решение в Azure из шаблона. Пример шаблона доступен в [шаблонах быстрого запуска Azure](https://github.com/MSBrett/azure-quickstart-templates/tree/master/sql-server-2016-fci-existing-vnet-and-ad) на GitHub. Этот пример не разработан и не протестирован для какой-либо конкретной рабочей нагрузки. Вы можете запустить шаблон для создания сервера FCI с пространством для хранения данных Direct хранилища, подключенным к вашему домену. Вы можете оценить шаблон и изменить его для ваших целей.

## <a name="before-you-begin"></a>Перед началом

Есть несколько вещей, которые вы должны знать и иметь на месте, прежде чем начать.

### <a name="what-to-know"></a>Необходимые знания
Вы должны иметь оперативное понимание этих технологий:

- [технологии кластера под управлением Windows](https://docs.microsoft.com/windows-server/failover-clustering/failover-clustering-overview);
- [Кластерные инстанции сервера S'L](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

Одна вещь, чтобы быть в курсе, что на Azure IaaS гостевый кластер неудачу, мы рекомендуем один NIC на сервер (кластерный узел) и один подсети. Сеть Azure имеет физическую избыточность, что делает ненужными дополнительные NICs и подсети в гостевом кластере Azure IaaS VM. Отчет о проверке кластера предупредит вас о том, что узлы доступны только в одной сети. Вы можете проигнорировать это предупреждение в кластерах гостя Azure IaaS VM.

Вы также должны иметь общее понимание этих технологий:

- [Гиперконвергентные решения, которые используют пробелы в хранении Direct в Windows Server 2016](https://docs.microsoft.com/windows-server/storage/storage-spaces/storage-spaces-direct-overview)
- [Группы ресурсов Azure](../../../azure-resource-manager/management/manage-resource-groups-portal.md)

> [!IMPORTANT]
> В настоящее время случаи сбоя в кластере S'L Server на виртуальных машинах Azure поддерживаются только в [легком режиме управления](virtual-machines-windows-sql-register-with-resource-provider.md#management-modes) [расширением агента IaaS.](virtual-machines-windows-sql-server-agent-extension.md) Чтобы перейти от полного режима расширения к легкому, удалите ресурс **виртуальной машины S'L** для соответствующих виртуальных технологий, а затем зарегистрируйте их у поставщика ресурсов S'L VM в легком режиме. При удалянии ресурса **виртуальной машины СЗЛ** с помощью портала Azure **очистите флажок рядом с правильной виртуальной машиной.** Полное расширение поддерживает такие функции, как автоматическое резервное копирование, исправление и расширенное управление порталом. Эти функции не будут работать для VMs-серверов после того, как агент будет переустановлен в легком режиме управления.

### <a name="what-to-have"></a>Необходимые компоненты

Прежде чем выполнить шаги в этой статье, вы должны уже иметь:

- подписка Microsoft Azure;
- домен Windows на виртуальных машинах Azure;
- Учетная запись с разрешениями на создание объектов как на виртуальных машинах Azure, так и в Active Directory.
- Виртуальная сеть и подсеть Azure с достаточным пространством для IP-адресов для следующих компонентов:
   - обе виртуальные машины;
   - IP-адрес отказоустойчивого кластера;
   - IP-адрес для каждого экземпляра отказоустойчивого кластера;
- DNS настроен в сети Azure, указывая на контроллеры домена.

С этими предпосылками на месте, вы можете начать строить свой кластер неудач. Сначала нужно создать виртуальные машины.

## <a name="step-1-create-the-virtual-machines"></a>Шаг 1: Создание виртуальных машин

1. Вопийте на [порталaz](https://portal.azure.com) с подпиской.

1. [Создайте группу доступности Azure](../tutorial-availability-sets.md).

   Группа доступности группирует виртуальные машины в доменах сбоя и доменах обновления. Это гарантирует, что ваше приложение не зависит от одной точки сбоя, как сетевой коммутатор или блок питания стойки серверов.

   Если вы еще не создали группу ресурсов для виртуальных машин, сделайте это при создании набора доступности Azure. Если вы используете портал Azure для создания набора доступности, приложите следующие меры:

   1. На портале Azure выберите **создать ресурс** для открытия Azure Marketplace. Найдите **Группа доступности**.
   1. Выберите **набор доступности**.
   1. Выберите **Создать**.
   1. В **наборе доступности Create**укажите следующие значения:
      - **Имя.** Имя группы доступности.
      - **Подписка**: Подписка На Azure.
      - **Группа ресурсов**: Если вы хотите использовать существующую группу, нажмите **Выберите существующую** группу, а затем выберите группу из списка. В противном случае выберите **Создать новое** и введите имя для группы.
      - **Расположение.** Задайте расположение, в котором вы планируете создать виртуальные машины.
      - **Разлом доменов**: Используйте по умолчанию (**3**).
      - **Обновление доменов**: Используйте по умолчанию (**5**).
   1. Выберите **Создать** для создания набора доступности.

1. Создайте виртуальные машины в группе доступности.

   Подготовьте две виртуальные машины SQL Server в группе доступности Azure. Инструкции см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](virtual-machines-windows-portal-sql-server-provision.md).

   Разместите обе виртуальные машины:

   - В той же группе ресурсов Azure, что и набор доступности.
   - в той же сети, что и контроллер домена;
   - В подсети, которая имеет достаточно места ДЛЯ IP-адреса как для виртуальных машин, так и для всех FCIs, которые в конечном итоге можно использовать в кластере.
   - в группе доступности Azure.

      >[!IMPORTANT]
      >Вы не можете установить или изменить набор доступности после создания виртуальной машины.

   Выберите изображение из Azure Marketplace. Вы можете использовать изображение Azure Marketplace, которое включает Windows Server и Сервер S'L, или использовать изображение, которое включает только Windows Server. Для получения [подробной информации](virtual-machines-windows-sql-server-iaas-overview.md)см.

   Официальные изображения сервера S'L в галерее Azure включают в себя установленный экземпляр сервера S'L, программное обеспечение для установки сервера S'L и необходимый ключ.

   Выберите правильное изображение, основанное на том, как вы хотите оплатить лицензию S'L Server:

   - **Лицензирование с оплатой за использование**. Посекундная оплата этих образов доступна в таких лицензиях SQL Server:
      - **Предприятие S'L Server 2016 на Windows Server 2016 Центр обработки данных**
      - **Стандарт сервера S'L 2016 на Windows Server 2016 Центр обработки данных**
      - **Разработчик сервера S'L 2016 на Windows Server 2016 Центр обработки данных**

   - **Принесите свою собственную лицензию (BYOL)**

      - **(БАЙОЛ) Я НЕ ДОЛ) Предприятие S'L Server 2016 на Windows Server 2016 Центр обработки данных**
      - **(БАЙОЛ) Я НЕ ДОЛ) Стандарт сервера S'L 2016 на Windows Server 2016 Центр обработки данных**

   >[!IMPORTANT]
   >После создания виртуальной машины удалите предварительно установленный автономный экземпляр SQL Server. Вы будете использовать предустановленное медиа-носителю сервера S'L для создания FCI сервера S'L после настройки кластера failover и непосредственного пространства для хранения данных.

   Кроме того, можно использовать изображения Azure Marketplace, содержащие только операционную систему. Выберите изображение **Центра обработки данных Windows Server 2016** и установите FCI сервера S'L после настройки кластера сбоев и непосредственного пространства для хранения данных. Это изображение не содержит носителей установки сервера S'L Server. Разместите среду установки сервера s'L в месте, где можно запустить его для каждого сервера.

1. После того, как Azure создает ваши виртуальные машины, подключитесь к каждому из них с помощью RDP.

   При первом подключении к виртуальной машине с помощью RDP, запрос спрашивает вас, если вы хотите, чтобы компьютер был обнаружен в сети. Нажмите кнопку **Да**.

1. Если вы используете одно из виртуальных машинных изображений на базе сервера s'L Server, удалите экземпляр s'L Server.

   1. В **программах и функциях**, правой кнопкой мыши **Microsoft S'L Server 2016 (64-разрядный)** и выберите **Uninstall/Change**.
   1. Выберите **Удалить**.
   1. Выберите экземпляр по умолчанию.
   1. Удалите все компоненты в разделе **Службы ядра СУБД**. Не удаляйте **общие функции.** Вы увидите что-то вроде следующего скриншота:

      ![Выбор компонентов](./media/virtual-machines-windows-portal-sql-create-failover-cluster/03-remove-features.png)

   1. Выберите **далее,** а затем выберите **Удалить**.

1. <a name="ports"></a>Откройте порты брандмауэра.

   На каждой виртуальной машине откройте эти порты на брандмауэре Windows:

   | Назначение | TCP-порт | Примечания
   | ------ | ------ | ------
   | SQL Server | 1433 | Обычный порт для экземпляров SQL Server по умолчанию. Если используется образ из коллекции, этот порт будет автоматически открыт.
   | Проверка работоспособности | 59999 | Любой открытый TCP-порт. Позже настройте [проверку работоспособности](#probe) балансировщика нагрузки и кластер для использования этого порта.  

1. Добавьте хранилище в виртуальную машину. Дополнительные сведения см. в статье [Хранилище класса "Премиум": высокопроизводительная служба хранилища для рабочих нагрузок виртуальных машин Azure](../disks-types.md).

   Для обеих виртуальных машин необходимо по крайней мере два диска данных.

   Прикрепите необработанные диски, а не ntFS-форматированные диски.
      >[!NOTE]
      >При подключении дисков с форматом NTFS можно включить пространство для хранения только без проверки права на диск.  

   Подключите как минимум два SSD (цен. категория "Премиум") к каждой виртуальной машине. Мы рекомендуем по крайней мере P30 (1-ТБ) диски.

   Для кэширования узла задайте значение **Только для чтения**.

   Емкость хранилища, используемого в рабочих средах, зависит от рабочей нагрузки. Значения, описанные в этой статье, предназначены для демонстрации и тестирования.

1. [Добавьте виртуальные машины в имеющийся домен](virtual-machines-windows-portal-sql-availability-group-prereq.md#joinDomain).

После создания и настройки виртуальных машин можно настроить кластер failover.

## <a name="step-2-configure-the-windows-server-failover-cluster-with-storage-spaces-direct"></a>Шаг 2: Настройка кластера Windows Server Failover с помощью непосредственного пространства для хранения данных

Следующим шагом является настройка кластера failover с помощью хранилищ Direct. На этом этапе вы заполните следующие подшаги:

1. Добавьте функцию кластеризации Windows Server Failover.
1. Проверка кластера.
1. Создайте кластер failover.
1. Создайте свидетель облака.
1. Добавить хранилище.

### <a name="add-windows-server-failover-clustering"></a>Добавление кластеризации Windows Server Failover

1. Подключитесь к первой виртуальной машине с RDP с помощью учетной записи домена, которая является членом локальных администраторов и имеет разрешение на создание объектов в Active Directory. Используйте эту учетную запись для остальной части конфигурации.

1. [Добавьте Failover Кластеризация к каждой виртуальной машине.](virtual-machines-windows-portal-sql-availability-group-prereq.md#add-failover-clustering-features-to-both-sql-server-vms)

   Чтобы установить Кластеризирование Failover из uI, выполняйте следующие шаги на обоих виртуальных машинах:
   1. В **менеджере серверов**выберите **Управление,** а затем выберите **Добавить роли и функции.**
   1. В **Add Роли и функции мастера**, выберите **Далее,** пока вы не получите, чтобы **выбрать функции.**
   1. В **select Features**выберите **кластеризация Failover.** Включите все необходимые компоненты и средства управления. Выберите **функции добавления.**
   1. Выберите **следующий**, а затем выберите **отделку** для установки функций.

   Чтобы установить кластерирование Failover с помощью PowerShell, запустите следующий скрипт от сеанса администратора PowerShell на одном из виртуальных машин:

   ```powershell
   $nodes = ("<node1>","<node2>")
   Invoke-Command  $nodes {Install-WindowsFeature Failover-Clustering -IncludeAllSubFeature -IncludeManagementTools}
   ```

Для получения дополнительной справки о следующих шагах [Hyper-converged solution using Storage Spaces Direct in Windows Server 2016](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-3-configure-storage-spaces-direct)см.

### <a name="validate-the-cluster"></a>Проверка кластера

Проверка кластера в uI или с помощью PowerShell.

Чтобы проверить кластер с помощью единого матегов, выполняйте следующие шаги на одной из виртуальных машин:

1. Под **серверным менеджером**выберите **Инструменты,** а затем выберите **Failover Кластерный менеджер.**
1. При **менеджере кластера Failover**выберите **Action,** а затем выберите **конфигурацию проверки.**
1. Нажмите кнопку **Далее**.
1. В **рамках Select Servers или кластера**введите названия обеих виртуальных машин.
1. В **вариантах тестирования**выберите **выполнить только тесты, которые я выбираю.** Нажмите кнопку **Далее**.
1. При **тестовом отборе**выберите все тесты, кроме **хранилища,** как показано здесь:

   ![Выберите тесты проверки кластера](./media/virtual-machines-windows-portal-sql-create-failover-cluster/10-validate-cluster-test.png)

1. Нажмите кнопку **Далее**.
1. Под **подтверждением,** выберите **Следующий**.

Мастер проверки конфигурации выполняет проверочные тесты.

Чтобы проверить кластер с помощью PowerShell, запустите следующий скрипт от сеанса администратора PowerShell на одной из виртуальных машин:

   ```powershell
   Test-Cluster –Node ("<node1>","<node2>") –Include "Storage Spaces Direct", "Inventory", "Network", "System Configuration"
   ```

После проверки кластера создайте отказоустойчивый кластер.

### <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера.

Для создания отказоустойчивого кластера требуется следующее.
- Названия виртуальных машин, которые станут кластерными узлами.
- Имя отказоустойчивого кластера.
- IP-адрес отказоустойчивого кластера. Можно использовать IP-адрес, который не используется в той же виртуальной сети и подсети Azure в качестве кластерных узлов.

#### <a name="windows-server-2008-through-windows-server-2016"></a>Windows Server 2008 через Windows Server 2016

Следующий скрипт PowerShell создает кластер сбоя для Windows Server 2008 через Windows Server 2016. Обновите скрипт именами узлов (имена виртуальных машин) и доступным IP-адресом виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage
```   

#### <a name="windows-server-2019"></a>Windows Server 2019

Следующий скрипт PowerShell создает кластер неудач для Windows Server 2019. Для получения дополнительной информации [см. кластер Failover: Объект кластерной сети](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97). Обновите скрипт именами узлов (имена виртуальных машин) и доступным IP-адресом виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage -ManagementPointNetworkType Singleton 
```


### <a name="create-a-cloud-witness"></a>Создание облака-свидетеля

Cloud Witness — это новый тип свидетельского кворума кластера, который хранится в капле хранения Azure. Это устраняет необходимость в отдельном VM, в котором размещается доля свидетелей.

1. [Создайте облако-свидетель для отказоустойчивого кластера](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness).

1. Создайте контейнер больших двоичных объектов.

1. Сохраните ключи доступа и URL-адрес контейнера.

1. Настройте свидетель кворума отказоустойчивого кластера. [См. Наверстать диаграмму свидетеля кворума в пользовательском интерфейсе.](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness#to-configure-cloud-witness-as-a-quorum-witness)

### <a name="add-storage"></a>Добавление хранилища

Диски для хранилищ Direct должны быть пустыми. Они не могут содержать разделы или другие данные. Чтобы очистить диски, следуйте [шагам в этом руководстве.](https://docs.microsoft.com/windows-server/storage/storage-spaces/deploy-storage-spaces-direct?redirectedfrom=MSDN#step-31-clean-drives)

1. [Включить пространство магазина Прямая](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-35-enable-storage-spaces-direct).

   Следующий скрипт PowerShell позволяет пространствам для хранения direct:  

   ```powershell
   Enable-ClusterS2D
   ```

   В **диспетчере отказоустойчивости кластеров** теперь отображается пул носителей.

1. [Создайте том.](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-36-create-volumes)

   Storage Spaces Direct автоматически создает пул хранения при его включении. Теперь вы готовы создать том. Смдлет `New-Volume` PowerShell автоматизирует процесс создания громкости. Этот процесс включает в себя форматирование, добавление объема в кластер и создание совместного объема кластера (CSV). Этот пример создает CSV с 800 гигабайтами (ГБ):

   ```powershell
   New-Volume -StoragePoolFriendlyName S2D* -FriendlyName VDisk01 -FileSystem CSVFS_REFS -Size 800GB
   ```   

   После завершения этой команды в качестве кластерного ресурса устанавливается объем 800 ГБ. Том находится в папке `C:\ClusterStorage\Volume1\`.

   На этом скриншоте показан кластерный общий объем с пробелами Direct:

   ![Общий том кластера](./media/virtual-machines-windows-portal-sql-create-failover-cluster/15-cluster-shared-volume.png)

## <a name="step-3-test-failover-cluster-failover"></a>Шаг 3. Тестирование отработки отказа отказоустойчивого кластера

В **Failover Cluster Manager**убедитесь, что ресурс хранилища можно переместить в другой кластерный узлы. Если вы можете подключиться к кластеру failover с помощью **Failover кластера manager** и переместить хранилище из одного узла в другой, вы готовы настроить FCI.

## <a name="step-4-create-the-sql-server-fci"></a>Шаг 4: Создание FCI сервера S'L

После настройки кластера failover и всех компонентов кластера, включая хранение, можно создать FCI сервера S'L.

1. Подключитесь к первой виртуальной машине с помощью RDP.

1. В **Failover кластера менеджер**, убедитесь, что все основные ресурсы кластера на первой виртуальной машине. При необходимости переместите все ресурсы в эту виртуальную машину.

1. Найдите установочный носитель. Если на виртуальной машине используется один из образов Azure Marketplace, носитель находится в папке `C:\SQLServer_<version number>_Full`. Выберите **Установить**.

1. В **Центре установки серверов S'L**выберите **Установку.**

1. Выберите **новую установку кластера сервера S'L Server.** Следуйте указаниям мастера, чтобы установить экземпляр отказоустойчивого кластера SQL Server.

   Каталоги данных экземпляра отказоустойчивого кластера должны находиться в кластеризованном хранилище. С Storage Spaces Direct это не общий диск, а точка крепления к громкости на каждом сервере. Пространства хранения Direct синхронизируют громкость между обоими узлами. Объем представлен кластеру как общий объем кластера. Используйте точки подключения CSV для каталогов данных.

   ![Каталоги данных](./media/virtual-machines-windows-portal-sql-create-failover-cluster/20-data-dicrectories.png)

1. После завершения инструкций в мастере, настройка установит fcI сервера S'L на первом узле.

1. После установки FCI на первый узла подключитесь ко второму узлам с помощью RDP.

1. Откройте диалоговое окно **Центр установки SQL Server**. Выберите **Установку**.

1. Выберите **узл «Добавить» в кластер сбоя сервера S'L.** Следуйте инструкциям мастера, чтобы установить сервер S'L и добавить сервер в FCI.

   >[!NOTE]
   >Если вы использовали изображение галереи Azure Marketplace, содержащее сервер S'L, инструменты S'L Server были включены в изображение. Если вы не использовали одно из этих изображений, установите инструменты s'L Server отдельно. См. сведения в статье [Скачивание SQL Server Management Studio (SSMS)](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="step-5-create-the-azure-load-balancer"></a>Шаг 5: Создание балансиста нагрузки Azure

На виртуальных машинах Azure кластеры используют балансировщик нагрузки для хранения IP-адреса, который должен находиться на одном узле кластера в определенный момент времени. В этом решении балансировщик нагрузки используется для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.

Для получения дополнительной информации [см. Создать и настроить балансирумы нагрузки Azure.](virtual-machines-windows-portal-sql-availability-group-tutorial.md#configure-internal-load-balancer)

### <a name="create-the-load-balancer-in-the-azure-portal"></a>Создание балансировщика нагрузки на портале Azure

Создание балансировщика нагрузки

1. На портале Azure перейдите к группе ресурсов, содержащей виртуальные машины.

1. Нажмите кнопку **Добавить**. Поиск в Azure Marketplace для **балансораза нагрузки.** Выберите **балансер нагрузки.**

1. Выберите **Создать**.

1. Настройте для балансировщика нагрузки следующие параметры.

   - **Подписка**: Подписка На Azure.
   - **Группа ресурсов**: Группа ресурсов, содержащая ваши виртуальные машины.
   - **Имя.** Имя, определяющее балансировщик нагрузки.
   - **Область**: Расположение Azure, содержащее ваши виртуальные машины.
   - **Тип**: Либо государственный, либо частный. Частный балансоровостом нагрузки можно получить доступ из виртуальной сети. Большинство приложений Azure могут использовать закрытый балансировщик нагрузки. Если вашему приложению необходим доступ к серверу S'L, непосредственно через Интернет, используйте общественный баланс.
   - **SKU**: Стандарт.
   - **Виртуальная сеть:** Та же сеть, что и виртуальные машины.
   - **Назначение IP-адреса**: Статическое. 
   - **Частный IP-адрес**: IP-адрес, назначенный на ресурс кластера S'L Server FCI.

 На следующем скриншоте показан uI **балансироворовки нагрузки Create:**

   ![Настройка балансобаланса нагрузки](./media/virtual-machines-windows-portal-sql-create-failover-cluster/30-load-balancer-create.png)

### <a name="configure-the-load-balancer-backend-pool"></a>Настройка серверного пула балансировщика нагрузки

1. Вернитесь в группу ресурсов Azure, которая содержит виртуальные машины, и найдите новый балансик. Возможно, потребуется обновить представление в группе ресурсов. Выберите подсистему балансировки нагрузки.

1. Выберите **пулы Backend,** а затем выберите **Добавить**.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В **рамках ip-конфигураций Target Network**выберите VIRTUAL **MACHINE** и выберите виртуальные машины, которые будут участвовать в качестве кластерных узлов. Не забудьте включить все виртуальные машины, на которых будут размещаться FCI.

1. Выберите **OK** для создания пула бэкэнда.

### <a name="configure-a-load-balancer-health-probe"></a>Настройка пробы работоспособности балансировщика нагрузки

1. На лезвии балансоровы нагрузки выберите **зонды здоровья.**

1. Нажмите кнопку **Добавить**.

1. На лезвии <a name="probe"> </a> **зонда Добавить здоровья** установите параметры зонда работоспособности.

   - **Имя.** Имя для проверки работоспособности.
   - **Протокол**: TCP.
   - **Порт**: Установите в порт, созданный в брандмауэре для зонда работоспособности на [этом этапе.](#ports) В этой статье пример использует `59999`порт TCP.
   - **Интервал.** 5 секунд.
   - **Порог состояния неработоспособности.** 2 последовательных сбоя.

1. Нажмите кнопку **ОК**.

### <a name="set-load-balancing-rules"></a>Задание правил балансировки нагрузки

1. На лезвии балансоостатка нагрузки выберите **правила балансировки нагрузки.**

1. Нажмите кнопку **Добавить**.

1. Установите параметры балансировки нагрузки:

   - **Имя.** Имя для правил балансировки нагрузки.
   - **IP-адрес Frontend**: IP-адрес для кластерного сетевого ресурса S'L Server FCI.
   - **Порт**: Порт S'L Server FCI TCP. Порт экземпляра по умолчанию — 1433.
   - **Порт бэкэнда**: использует тот же порт, что и значение **Port,** когда вы **включите плавающий IP (прямой возврат сервера).**
   - **Backend пул**: название пула бэкэнда, которое вы настроили ранее.
   - **Зонд здоровья**: Зонд здоровья, который вы настроили ранее.
   - **Сохранение сеанса.** Нет.
   - **Время ожидания простоя (в минутах)**: 4.
   - **Плавающий IP (прямой возврат сервера)**: Включено.

1. Нажмите кнопку **ОК**.

## <a name="step-6-configure-the-cluster-for-the-probe"></a>Шаг 6: Настройка кластера для зонда

Задайте параметр порта проверки кластера в PowerShell.

Чтобы установить параметр порта кластерного зонда, обновите переменные в следующем скрипте со значениями из среды. Удалите угловые `>`скобки (и`<` ) из сценария.

   ```powershell
   $ClusterNetworkName = "<Cluster Network Name>"
   $IPResourceName = "<SQL Server FCI IP Address Resource Name>" 
   $ILBIP = "<n.n.n.n>" 
   [int]$ProbePort = <nnnnn>

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

В следующем списке описаны значения, которые необходимо обновить:

   - `<Cluster Network Name>`: Название кластера Windows Server Failover для сети. В **Failover кластерменеджер** > **сетей**, право нажмите на сеть и выберите **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<SQL Server FCI IP Address Resource Name>`: Имя ресурса IP-адреса СЕРВЕРа FCI. В роли >  **менеджера кластера Failover****,** в роли S'L Server FCI, под **названием сервера,** право-нажмите ресурс IP-адреса и выберите **Свойства.** Правильное значение указано в поле **Имя** на вкладке **Общие**. 

   - `<ILBIP>`: IP-адрес внутренней подсистемы балансировки нагрузки. Этот адрес настраивается на портале Azure в качестве интерфейсного адреса внутренней подсистемы балансировки нагрузки. Это также IP-адрес экземпляра отказоустойчивого кластера SQL Server. Его можно найти в окне **Диспетчер отказоустойчивости кластеров** на той же странице свойств, где указано значение `<SQL Server FCI IP Address Resource Name>`.  

   - `<nnnnn>`: Порт зонда, настроенный в зонде здоровья баланса нагрузки. Допускается любой неиспользуемый TCP-порт.

>[!IMPORTANT]
>Маска подсети для параметра кластера должна быть широковещательным адресом TCP IP: `255.255.255.255`.

После установки кластерного зонда можно увидеть все параметры кластера в PowerShell. Выполните следующий сценарий:

   ```powershell
   Get-ClusterResource $IPResourceName | Get-ClusterParameter 
  ```

## <a name="step-7-test-fci-failover"></a>Шаг 7. Проверка отработки отказа экземпляра отказоустойчивого кластера

Проверьте отработку отказа экземпляра отказоустойчивого кластера, чтобы проверить функциональные возможности кластера. Сделайте следующее:

1. Подключитесь к одному из кластерных узлов S'L Server FCI с помощью RDP.

1. Открытый **менеджер кластера Failover**. Выберите **Роли**. Обратите внимание, какой узел является владельцем роли SQL Server FCI.

1. Щелкните правой кнопкой мыши роль SQL Server FCI.

1. Выберите **Переместить,** а затем выберите **лучший возможный узлы**.

**Менеджер кластера Failover** показывает роль, и его ресурсы переходят в автономный режим. Затем ресурсы переместятся и станут доступными на другом узле.

### <a name="test-connectivity"></a>Проверка подключения

Чтобы протестировать подключение, вопием на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к экземпляру отказоустойчивого кластера SQL Server.

>[!NOTE]
>Если вам это необходимо, вы можете [скачать студию управления серверами S'L.](https://msdn.microsoft.com/library/mt238290.aspx)

## <a name="limitations"></a>Ограничения

Виртуальные машины Azure поддерживают координатора распределенных транзакций Майкрософт (MSDTC) на Windows Server 2019 с хранением на кластерных общих объемах (CSV) и [стандартным балансом нагрузки.](../../../load-balancer/load-balancer-standard-overview.md)

На виртуальных машинах Azure MSDTC не поддерживается на Windows Server 2016 или раньше, потому что:

- Кластерный ресурс MSDTC не может быть настроен для использования общего хранилища. На Windows Server 2016, если вы создаете ресурс MSDTC, он не будет отображать общее хранилище, доступное для использования, даже если хранилище доступно. Эта проблема устранена в Windows Server 2019.
- Основной балансизатор нагрузки не обрабатывает порты RPC.

## <a name="see-also"></a>См. также

[Настройка хранилищ Direct с помощью удаленного рабочего стола (Azure)](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/rds-storage-spaces-direct-deployment)

[Гиперконвергентное решение с пробелами в хранении Direct](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct)

[Обзор локальных дисковых пространств](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview)

[Поддержка сервера S'L для хранилищ Direct](https://blogs.technet.microsoft.com/dataplatforminsider/2016/09/27/sql-server-2016-now-supports-windows-server-2016-storage-spaces-direct/)
