---
title: Рекомендации по оптимизации производительности SQL Server в Azure | Документация Майкрософт
description: Содержит рекомендации по оптимизации производительности SQL Server в виртуальных машинах Microsoft Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: craigg
editor: ''
tags: azure-service-management
ms.assetid: a0c85092-2113-4982-b73a-4e80160bac36
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 10/18/2019
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 880f1c601cf4132fdec9e5d25b1bf1f2ff175ab7
ms.sourcegitcommit: 96dc60c7eb4f210cacc78de88c9527f302f141a9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2020
ms.locfileid: "77650543"
---
# <a name="performance-guidelines-for-sql-server-in-azure-virtual-machines"></a>Рекомендации по оптимизации производительности SQL Server на виртуальных машинах Azure

## <a name="overview"></a>Обзор

В этой статье приведены советы по оптимизации производительности SQL Server на виртуальной машине Microsoft Azure. При выполнении SQL Server в виртуальных машинах Azure рекомендуется продолжать использование тех же средств настройки производительности базы данных, которые применяются для SQL Server в локальной серверной среде. Однако производительность реляционной базы данных в общедоступном облаке зависит от многих факторов, таких как размер виртуальной машины и конфигурации дисков с данными.

[Образы SQL Server, подготовленные на портале Azure](quickstart-sql-vm-create-portal.md), соответствуют общим рекомендациям по конфигурации хранилища. Дополнительные сведения о настройке хранилища см. в статье [Настройка хранилища для виртуальных машин SQL Server](virtual-machines-windows-sql-server-storage-configuration.md). Завершив подготовку обдумайте, нужно ли применить другие виды оптимизации, описанные в этой статье. При принятии решений учитывайте характер рабочих нагрузок, а затем проверьте выбор путем тестирования.

> [!TIP]
> Как правило, существует компромисс между оптимизацией затрат и оптимизацией производительности. Этот документ содержит инструкции по достижению *оптимальной* производительности SQL Server на виртуальных машинах Azure. Если рабочая нагрузка не так велика, могут потребоваться не все перечисленные ниже оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности, затраты и характер рабочих нагрузок.

## <a name="quick-check-list"></a>Краткий контрольный список

Ниже приведен краткий контрольный список по обеспечению оптимальной производительности SQL Server на виртуальных машинах Azure.

| Область | Оптимизация |
| --- | --- |
| [Размер виртуальной машины](#vm-size-guidance) | — Используйте размеры виртуальных машин с 4 или более виртуальных ЦП, например [E4S_v3](../../ev3-esv3-series.md) или выше, или [DS12_v2](../../dv2-dsv2-series-memory.md) или более поздней версии.<br/><br/> [серии - ES, EAS, DS и Das](../../sizes-general.md) обеспечивают оптимальное соотношение памяти и виртуальных ЦП, необходимое для производительности рабочей нагрузки OLTP. <br/><br/> - [серии M](../../m-series.md) обеспечивает максимальный объем памяти для виртуальных ЦП, необходимый для обеспечения критической производительности и идеально подходит для рабочих нагрузок хранилища данных. <br/><br/> — Собирайте требования к времени выполнения [операций ввода-вывода](../premium-storage-performance.md#iops), [пропускной способности](../premium-storage-performance.md#throughput) и [задержки](../premium-storage-performance.md#latency) целевой рабочей нагрузки в пиковое время, следуя [контрольному списку требований к производительности приложения](../premium-storage-performance.md#application-performance-requirements-checklist) , а затем выберите [Размер виртуальной машины](../sizes-general.md) , который может масштабироваться по требованиям к производительности рабочей нагрузки.|
| [Память](#storage-guidance) | — Для подробного тестирования производительности SQL Server на виртуальных машинах Azure с помощью TPC-E и TPC_C тесты производительности см. в блоге [оптимизировать производительность OLTP](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794). <br/><br/> — Используйте [твердотельные накопители](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794) уровня "Премиум", чтобы получить лучшие преимущества цены и производительности. Настройка [кэширования только для чтения](../premium-storage-performance.md#disk-caching) для файлов данных и без кэша для файла журнала. <br/><br/> — Используйте [Ultra Disks](../disks-types.md#ultra-disk) , если Рабочая нагрузка требует меньше задержек на использование хранилища MS. <br/><br/> — Соберите требования к задержке хранилища для файлов данных SQL Server, журналов и временных баз данных, [отслеживая приложение](../premium-storage-performance.md#application-performance-requirements-checklist) перед выбором типа диска. Если требуется < задержки хранилища 1 мс, используйте Ultra Disks, в противном случае используйте SSD уровня "Премиум". Если низкие задержки требуются только для файла журнала, а не для файлов данных, [подготавливает диск Ultra](../disks-enable-ultra-ssd.md) с требуемыми операциями ввода-вывода и пропускной способностью только для файла журнала. <br/><br/> -  общие [файловые ресурсы](virtual-machines-windows-portal-sql-create-failover-cluster-premium-file-share.md) уровня "Премиум" рекомендуется использовать в качестве общего хранилища для экземпляра отказоустойчивого кластера SQL Server. Файловые ресурсы уровня "Премиум" не поддерживают кэширование и обеспечивают ограниченную производительность по сравнению с дисками SSD уровня "Премиум". Выберите диски, управляемые твердотельным накопителем уровня "Премиум", через общие файловые ресурсы для автономных экземпляров SQL. но используйте файловые ресурсы уровня "Премиум" для общего хранилища экземпляров отказоустойчивого кластера для простоты обслуживания и гибкой масштабируемости. <br/><br/> — Хранилище уровня "Стандартный" рекомендуется только для целей разработки и тестирования, а также для файлов резервных копий и не должно использоваться для рабочих нагрузок. <br/><br/> Храните [учетную запись хранения](../../../storage/common/storage-create-storage-account.md) и виртуальную машину SQL Server в одном и том же регионе.<br/><br/> — Отключить [геоизбыточное хранилище](../../../storage/common/storage-redundancy.md) Azure (георепликацию) в учетной записи хранения.  |
| [диски;](#disks-guidance) | — Используйте не менее 2 [дисков SSD](../disks-types.md#premium-ssd) уровня "Премиум" (1 для файла журнала и 1 для файлов данных). <br/><br/> — Для рабочих нагрузок, которые требуют < 1 мс задержки ввода-вывода, включите ускоритель записи для серии M и рассмотрите возможность использования SSD (цен. категория "Ультра") дисков для ES и серии DS. <br/><br/> — Включить [кэширование только для чтения](../premium-storage-performance.md#disk-caching) на дисках, где размещаются файлы данных.<br/><br/> — Добавьте дополнительные 20% операций ввода-вывода или пропускной способности уровня "Премиум", чем требуется рабочей нагрузки при [настройке хранилища для файлов данных, журналов и TempDB SQL Server](virtual-machines-windows-sql-server-storage-configuration.md) <br/><br/> Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br/><br/> Не включайте кэширование на дисках, где находится файл журнала.  **Важно!** при изменении параметров кэша для диска виртуальной машины Azure необходимо отключить службу SQL Server.<br/><br/> — Чередование нескольких дисков данных Azure для повышения пропускной способности хранилища.<br/><br/> Выполняйте форматирование с использованием задокументированных размеров кластеров. <br/><br/> -Размещать базу данных TempDB на локальном диске `D:\` SSD для критически важных SQL Server рабочих нагрузок (после выбора правильного размера виртуальной машины). Если вы создаете виртуальную машину из портал Azure или шаблонов быстрого запуска Azure и [размещаете временную базу данных на локальном диске](https://techcommunity.microsoft.com/t5/SQL-Server/Announcing-Performance-Optimized-Storage-Configuration-for-SQL/ba-p/891583) , дальнейшие действия не требуются. во всех остальных случаях выполните действия в блоге, чтобы [использовать SSDS для хранения базы данных tempdb](https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/) , чтобы предотвратить сбои после перезагрузки. Если емкость локального диска не достаточна для размера временной базы данных, поместите временную базу данных в пул носителей, [очищенный](../premium-storage-performance.md) на дисках SSD уровня "Премиум" с [кэшированием только для чтения](../premium-storage-performance.md#disk-caching). |
| [ВВОД-ВЫВОД](#io-guidance) |Включите сжатие страниц базы данных.<br/><br/> Включите быструю инициализацию для файлов данных.<br/><br/> Ограничьте авторасширение базы данных.<br/><br/> Отключите автосжатие базы данных.<br/><br/> Переместите все базы данных на диски с данными, включая системные базы данных.<br/><br/> Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски данных.<br/><br/> — Настройка расположения файлов базы данных и резервного копирования по умолчанию.<br/><br/> - [включить заблокированные страницы в памяти](/sql/database-engine/configure-windows/enable-the-lock-pages-in-memory-option-windows?view=sql-server-2017).<br/><br/> Примените исправления производительности SQL Server. |
| [Характерные особенности компонента](#feature-specific-guidance) | Используйте резервное копирование напрямую в хранилище BLOB-объектов.<br/><br/>— Использовать [резервные копии моментальных снимков файлов](/sql/relational-databases/backup-restore/file-snapshot-backups-for-database-files-in-azure) для баз данных размером более 12 ТБ. <br/><br/>— Используйте несколько файлов временной базы данных, 1 файл на ядро, до 8 файлов.<br/><br/>— Установите максимальный объем памяти сервера в 90% или до 50 ГБ слева для операционной системы. <br/><br/>— Включение программной архитектуры NUMA. |

Дополнительные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в подробных сведениях и руководствах, предоставленных в следующих разделах.

## <a name="vm-size-guidance"></a>Рекомендации по выбору размеров виртуальных машин

Начните с сбора требований ЦП, памяти и пропускной способности хранилища рабочей нагрузки в пиковое время. Счетчики производительности "\Логикалдиск\диск чтений/с" и "\Логикалдиск\диск операций записи в секунду" можно использовать для получения сведений о требованиях к [пропускной способности](../premium-storage-performance.md#disk-caching) для операций чтения и записи, а также счетчика \логикалдиск\диск bytes/sec. После определения требований к скорости выполнения операций ввода-вывода и пропускной способности в пиковой мощности Оценка размеров виртуальных машин обеспечивает эту емкость. Например, если для рабочей нагрузки требуется 20 КБ операций ввода-вывода и 10000 операций ввода-вывода в пиковое время, можно выбрать E16s_v3 (с 32 КБ кэшированных и 25600 некэшированных операций ввода-вывода) или M16_s (с 2 P30 до 20 КБ кэшированных и 10000 некэшированных операций ввода-вывода). Убедитесь, что вы понимаете требования к пропускной способности и операциям ввода-вывода для рабочей нагрузки, так как виртуальные машины имеют разные ограничения масштабирования для операций ввода-вывода и<br/><br/>Серии [DSv_3](../../dv3-dsv3-series.md) и [Es_v3](../../ev3-esv3-series.md) размещаются на оборудовании общего назначения с процессорами Intel Haswell или Broadwell. [Серия M](../../m-series.md) предлагает наибольшее число виртуальных ЦП и память для самых больших SQL Server рабочих нагрузок и размещается на оборудовании, оптимизированном для памяти, с семейством процессоров Skylake. Эта серия виртуальных машин поддерживает хранилище класса Premium, которое рекомендуется для наилучшей производительности с кэшем чтения уровня узла. Как Es_v3, так и серии M также доступны в [ограниченном размере ядра](../../windows/constrained-vcpu.md), что экономит деньги на рабочих нагрузках с более низкими требованиями к объему вычислений и высокой емкости хранилища. 

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Подробное тестирование производительности SQL Server на виртуальных машинах Azure с помощью TPC-E и TPC_Cных тестов см. в блоге [Оптимизация производительности OLTP](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794). 

Для всех рабочих нагрузок рекомендуется использовать кэш BLOB-объектов Azure с расширенными твердотельными накопителями. 

> [!WARNING]
> HDD и SSD (цен. категория "Стандартный") характеризуются различными задержками и пропускной способностью и рекомендуется только для рабочих нагрузок по разработке и тестированию. Для производственных рабочих нагрузок необходимо использовать SSD (цен. категория "Премиум").

Кроме того, рекомендуется создать свою учетную запись хранения Azure в одном центре обработки данных с виртуальными машинами SQL Server для уменьшения задержек при передаче данных. При создании учетной записи хранения отключите георепликацию, поскольку согласованный порядок записи на несколько дисков не гарантируется. Вместо этого рекомендуется реализовать средства аварийного восстановления SQL Server между двумя центрами обработки данных Azure. Дополнительные сведения см. в статье о [высокой доступности и аварийном восстановлении для SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-high-availability-dr.md).

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

Виртуальная машина Azure поддерживает три основных типа дисков:

* **Диск ОС**: при создании виртуальной машины Azure платформа подключает к ней по меньшей мере один диск (обозначенный буквой **C**), используемый в качестве диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.
* **Временный диск**: виртуальные машины Azure содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.
* **Диски данных**: к виртуальной машине можно подключить дополнительные диски данных, которые будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой, данный диск имеет метку **C:** .

По умолчанию для диска операционной системы применяется политика кэширования **Чтение и запись**. Для приложений, чувствительных к уровню производительности, рекомендуется использовать диски данных вместо диска операционной системы. См. подраздел "Диски данных" ниже.

### <a name="temporary-disk"></a>Временный диск

Временный диск хранилища, помеченный как диск **D** , не сохраняется в хранилище BLOB-объектов Azure. Не храните файлы пользовательской базы данных или файлы журнала транзакций пользователя на диске **D**.

Разместите базу данных TempDB на локальном диске `D:\` SSD для критически важных SQL Server рабочих нагрузок (после выбора правильного размера виртуальной машины). Если вы создаете виртуальную машину на основе портал Azure или шаблонов быстрого запуска Azure и [размещаете временную базу данных на локальном диске](https://techcommunity.microsoft.com/t5/SQL-Server/Announcing-Performance-Optimized-Storage-Configuration-for-SQL/ba-p/891583), дальнейшие действия не требуются. во всех остальных случаях выполните действия в блоге, чтобы [использовать SSDS для хранения базы данных tempdb](https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/) , чтобы предотвратить сбои после перезагрузки. Если емкость локального диска не достаточна для размера временной базы данных, поместите временную базу данных в пул носителей, [очищенный](../premium-storage-performance.md) на дисках SSD уровня "Премиум" с [кэшированием только для чтения](../premium-storage-performance.md#disk-caching).

Для виртуальных машин, поддерживающих твердотельные накопители уровня "Премиум", можно также хранить базу данных TempDB на диске, поддерживающем Premium SSD с включенным кэшированием чтения.


### <a name="data-disks"></a>Диски данных

* Используйте накопители SSD уровня " **Премиум" для файлов данных и журналов**. Если чередование дисков не используется, используйте два диска SSD уровня "Премиум", где один диск содержит файл журнала, а другой — данные. Каждый SSD уровня "Премиум" предоставляет несколько операций ввода-вывода и пропускной способности (МБ/с) в зависимости от размера, как показано в статье, [выберите тип диска](../disks-types.md). При использовании метода чередования дисков, например дискового пространства, можно достичь оптимальной производительности, имея два пула: один для файлов журнала, а другой для файлов данных. Однако если планируется использовать SQL Server экземпляры отказоустойчивого кластера (FCI), необходимо настроить один пул или использовать [Общие файловые ресурсы](virtual-machines-windows-portal-sql-create-failover-cluster-premium-file-share.md) уровня "Премиум".

   > [!TIP]
   > - Результаты теста в различных конфигурациях диска и рабочей нагрузки см. в записи блога, посвященной [рекомендациям по конфигурации хранилища для SQL Server на виртуальной машине Azure](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2018/09/25/storage-configuration-guidelines-for-sql-server-on-azure-vm/).
   > - Чтобы обеспечить надежную работу критически важных серверов SQL Server, для которых требуется порядка 50 000 операций ввода-вывода в секунду, рассмотрите возможность замены дисков P10–P30 дисками SSD (цен. категория "Ультра"). Дополнительные сведения см. в следующей записи блога: [критически важная производительность с SSD (цен. Категория "ультра")](https://azure.microsoft.com/blog/mission-critical-performance-with-ultra-ssd-for-sql-server-on-azure-vm/).

   > [!NOTE]
   > При подготовке виртуальной машины SQL Server на портале у вас есть возможность изменить конфигурацию хранилища. В зависимости от конфигурации Azure настраивает один или несколько дисков. Несколько дисков объединяются в единый пул хранилищ с чередованием. Файлы данных и журналов совместно размещаются в этой конфигурации. Дополнительные сведения см. в статье [Настройка хранилища для виртуальных машин SQL Server](virtual-machines-windows-sql-server-storage-configuration.md).

* **Чередование дисков**: для повышения пропускной способности можно добавить дополнительные диски данных и использовать чередование дисков. Чтобы определить количество дисков данных, необходимо проанализировать количество операций ввода-вывода в секунду и пропускную способность, необходимые для ваших файлов журналов, файлов данных и tempdb. Обратите внимание, что разные размеры виртуальной машины накладывают разные ограничения на количество операций ввода-вывода в секунду и пропускную способность. Ознакомьтесь с таблицами зависимости количества операций ввода-вывода в секунду от [размера виртуальной машины](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Придерживайтесь приведенных ниже рекомендаций.

  * Для Windows 8 и Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://technet.microsoft.com/library/hh831739.aspx), придерживаясь приведенных ниже рекомендаций.

      1. Установите чередование (размер блока чередования) в 64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262 144 байт) для рабочих нагрузок хранилища данных, чтобы избежать влияния на производительность из-за неправильного выравнивания разделов. Это следует сделать в PowerShell.
      2. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более 8 дисков. 

    Например, следующая команда PowerShell создает пул носителей с размером чередования 64 КБ и числом столбцов, равным 2:

    ```powershell
    $PoolCount = Get-PhysicalDisk -CanPool $True
    $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}

    New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" -PhysicalDisks $PhysicalDisks | New-VirtualDisk -FriendlyName "DataFiles" -Interleave 65536 -NumberOfColumns 2 -ResiliencySettingName simple –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" -AllocationUnitSize 65536 -Confirm:$false 
    ```

  * Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы), при этом размер чередования всегда составляет 64 КБ. Этот параметр является устаревшим в Windows 8 или Windows Server 2012. Дополнительные сведения см. в заявлении о поддержке в статье [Virtual Disk Service is transitioning to Windows Storage Management API](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx) (Служба виртуальных дисков переходит на API управления хранилищами Windows).

  * Если вы используете [локальные дисковые пространства (S2D)](/windows-server/storage/storage-spaces/storage-spaces-direct-in-vm) с [экземплярами отказоустойчивого кластера SQL Server](virtual-machines-windows-portal-sql-create-failover-cluster.md), вам нужно настроить единый пул. Несмотря на то, что в одном пуле можно создавать разные тома, все они будут иметь одинаковые характеристики, такие как одна и та же политика кэширования.

  * Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в статье [Размеры виртуальных машин в Azure](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

  * Если SSD (цен. категория "Премиум") не применяется (сценарии разработки и тестирования), то рекомендуется добавить максимальное количество дисков данных, поддерживаемое для вашего [размера виртуальной машины](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) и использовать чередование дисков.

* **Политика кэширования**: изучите предложенные ниже рекомендации по выбору политики кеширования в зависимости от конфигурации хранилища.

  * Если вы используете отдельные диски для файлов данных и файлов журналов, включите кэширование операций чтения только на дисках с файлами данных и файлами TempDB. Это позволит существенно повысить производительность. Не включайте кэширование для диска, где хранятся файлы журналов, так как это немного снижает производительность.

  * Если вы используете чередование дисков в едином пуле хранилища, для большинства рабочих нагрузок кэширование операций чтения повысит производительность. Если у вас есть отдельные пулы хранения для файлов журнала и данных, включите кэширование чтения только в пуле хранения для файлов данных. Для некоторых рабочих нагрузок с операциями записи большого объема данных можно повысить производительность, отключив кэширование. Точные данные можно получить только путем тестирования.

  * Все описанные выше рекомендации относятся к SSD (цен. категория "Премиум"). Если SSD (цен. категория "Премиум") не используется, не включайте кэширование ни для каких дисков данных.

  * Инструкции по настройке кэширования дисков см. в указанных ниже статьях. Сведения о классической модели развертывания (ASM) см. в статьях [Set-AzureOSDisk](https://msdn.microsoft.com/library/azure/jj152847) и [Set-AzureDataDisk](https://msdn.microsoft.com/library/azure/jj152851.aspx). Сведения о модели развертывания Azure Resource Manager см. в разделе: [Set-азосдиск](https://docs.microsoft.com/powershell/module/az.compute/set-azvmosdisk) и [Set-азвмдатадиск](https://docs.microsoft.com/powershell/module/az.compute/set-azvmdatadisk).

     > [!WARNING]
     > Остановите службу SQL Server при настройке кэширования дисков виртуальной машины Azure, чтобы избежать возможного повреждения баз данных.

* **Размер кластера NTFS**: при форматировании диска данных рекомендуется использовать размер кластера 64 КБ для файлов данных и журналов, а также базы данных TempDB. Если база данных TempDB размещена на временном диске (D:\ ) производительность, достигаемая за счет использования этого диска, перевешивает необходимость в размере единицы распределения 64 КБ. 

* **Рекомендации по управлению дисками**: при удалении диска данных или изменении его типа кэша остановите службу SQL Server. При изменении параметров кэширования диска ОС Azure останавливает виртуальную машину, изменяет тип кэша и перезапускает виртуальную машину. При изменении параметров кэша диска данных виртуальная машина не останавливается. Диск данных отключается от нее на время внесения изменений, а затем снова подключается к виртуальной машине.

  > [!WARNING]
  > Если не останавливать службу SQL Server на время таких операций, это может привести к повреждению базы данных.


## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

* Наилучшие результаты работы с SSD (цен. категория "Премиум") достигаются при параллелизации приложений и запросов. SSD (цен. категория "Премиум") предназначено для сценариев, где глубина очереди ввода-вывода больше 1, поэтому прирост производительности для однопоточных последовательных запросов почти не ощущается (даже если они направляются в хранилище в большом объеме). Например, это может негативно повлиять на результаты однопоточного тестирования в средствах анализа производительности, таких как SQLIO.

* Рекомендуется использовать [сжатие страниц базы данных](https://msdn.microsoft.com/library/cc280449.aspx) , так как это позволяет повысить производительность рабочих нагрузок с большим объемом операций ввода-вывода. Однако сжатие данных может повысить потребление ресурсов ЦП на сервере базы данных.

* Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте SE_MANAGE_VOLUME_NAME учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, то учетная запись службы по умолчанию (NT Service\MSSQLSERVER) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в разделе [Инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).

* **Авторасширение** считается лишь предупредительной мерой на случай непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании авторасширения предварительно увеличьте размер файла с помощью параметра размера.

* Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.

* Переместите все базы данных на диски с данными, включая системные базы данных. Дополнительные сведения см. в статье [Перемещение системных баз данных](https://msdn.microsoft.com/library/ms345408.aspx).

* Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными. Для этого в диспетчере конфигурации SQL Server щелкните правой кнопкой мыши свой экземпляр SQL Server и выберите пункт "Свойства". Параметры журнала ошибок и файла трассировки можно изменить на вкладке **Параметры запуска** . Каталог дампа указывается на вкладке **Дополнительно** . На следующем снимке экрана показано, где искать параметр запуска журнала ошибок.

    ![Снимок экрана SQL ErrorLog](./media/virtual-machines-windows-sql-performance/sql_server_error_log_location.png)

* Настройка расположений по умолчанию для файлов резервных копий и базы данных. Следуйте рекомендациям в этой статье и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журнала (среда SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). На следующем снимке экрана показано, где нужно внести необходимые изменения.

    ![Файлы журнала данных SQL и резервных копий](./media/virtual-machines-windows-sql-performance/sql_server_default_data_log_backup_locations.png)
* Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра «Блокировка страниц в памяти» (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

* Если вы используете SQL Server 2012, установите накопительный пакет обновления 10 для пакета обновления 1. Это обновление содержит исправление для низкой производительности ввода-вывода при выполнении оператора выборки во временную таблицу в SQL Server 2012. Дополнительные сведения см. в этой [статье базы знаний](https://support.microsoft.com/kb/2958012).

* Рекомендуется сжимать файлы данных при их передаче в среду Azure и из нее.

## <a name="feature-specific-guidance"></a>Обзор конкретных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

### <a name="back-up-to-azure-storage"></a>Резервное копирование в службу хранилища Azure
при выполнении резервного копирования данных SQL Server, запущенного на виртуальных машинах Azure, можно использовать [резервное копирование в SQL Server по URL-адресу](https://msdn.microsoft.com/library/dn435916.aspx). Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных. При выполнении архивации или восстановления с использованием службы хранилища Azure следуйте рекомендациям из раздела [Рекомендации по архивации SQL Server на URL-адрес, устранению неполадок и восстановлению из резервных копий в службе хранилища Azure](https://msdn.microsoft.com/library/jj919149.aspx). Кроме того, можно автоматизировать эти процессы архивации с помощью [автоматической архивации SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-automated-backup.md).

В выпусках, предшествующих SQL Server 2012, можно использовать [инструмент архивации SQL Server в Azure](https://www.microsoft.com/download/details.aspx?id=40740). Это средство может помочь повысить пропускную способность при архивации благодаря использованию нескольких чередующихся целей архивации.

### <a name="sql-server-data-files-in-azure"></a>SQL Server файлы данных в Azure

эта новая функция, [Файлы данных SQL Server в Microsoft Azure](https://msdn.microsoft.com/library/dn385720.aspx), доступна, начиная с SQL Server 2014. Выполнение SQL Server с файлами данных в Azure демонстрирует уровень производительности, сравнимый с использованием дисков данных Azure.

### <a name="failover-cluster-instance-and-storage-spaces"></a>Экземпляр отказоустойчивого кластера и дисковые пространства

Если вы используете дисковые пространства, при добавлении узлов в кластер на странице **подтверждения** снимите флажок **Добавить все подходящие хранилища в кластер**. 

![Снять флажок с подходящего хранилища](media/virtual-machines-windows-sql-performance/uncheck-eligible-cluster-storage.png)

Если вы используете дисковые пространства и не сняли флажок **Добавление всех допустимых хранилищ в кластер**, то Windows отключит виртуальные диски во время процесса кластеризации. Как следствие, они не отобразятся в диспетчере дисков или Explorer, пока дисковые пространства не будут удалены из кластера и повторно подключены с помощью PowerShell. Дисковые пространства группируют несколько дисков в пулы носителей. Дополнительные сведения см. в статье [Обзор дисковых пространств](/windows-server/storage/storage-spaces/overview).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о хранилище и производительности см. в записи блога, посвященной [рекомендациям по конфигурации хранилища для SQL Server на виртуальной машине Azure](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2018/09/25/storage-configuration-guidelines-for-sql-server-on-azure-vm/).

Рекомендации по безопасности см. в статье [Вопросы безопасности SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-security.md).

Ознакомьтесь с другими статьями, посвященными виртуальным машинам SQL Server, используя руководство с [обзором SQL Server на виртуальных машинах с Windows](virtual-machines-windows-sql-server-iaas-overview.md). Если у вас есть вопросы по виртуальным машинам SQL Server, см. раздел [часто задаваемых вопросов](virtual-machines-windows-sql-server-iaas-faq.md).
