---
title: Перемещение SQL Server виртуальной машины в другой регион в Azure с помощью Azure Site Recovery Services | Документация Майкрософт
description: Узнайте, как можно перенести виртуальную машину SQL Server из одного региона в другой в Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: jroth
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 07/30/2019
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 063876316c92780d061388283a55c7f50dd3d78a
ms.sourcegitcommit: 44e85b95baf7dfb9e92fb38f03c2a1bc31765415
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70100525"
---
# <a name="move-sql-server-vm-to-another-region-within-azure-with-azure-site-recovery-services"></a>Перемещение SQL Server виртуальной машины в другой регион в Azure с помощью служб Azure Site Recovery

В этой статье рассказывается, как использовать Azure Site Recovery для переноса виртуальной машины SQL Server из одного региона в другой в Azure. 

Перемещение SQL Server виртуальной машины в другой регион требует выполнения следующих действий.
1. [**Идет подготовка**](#prepare-to-move): Убедитесь, что исходная SQL Server виртуальной машине и целевом регионе достаточно подготовлена для перемещения. 
1. [**Настройка**](#configure-azure-site-recovery-vault): Для перемещения виртуальной машины SQL Server требуется, чтобы он был реплицированным объектом в хранилище Azure Site Recovery. Необходимо добавить SQL Server виртуальную машину в хранилище Azure Site Recovery. 
1. [**Тестирование**](#test-move-process): Перенос виртуальной машины SQL Server требует от нее отработки отказа из исходного региона в реплицированный целевой регион. Чтобы убедиться, что процесс перемещения завершится успешно, необходимо сначала убедиться, что SQL Server виртуальную машину можно успешно отработка отказа в целевой регион. Это поможет устранить проблемы и избежать их при выполнении фактического перемещения. 
1. Идет [**Перемещение**](#move-the-sql-server-vm): После того как тест отработки отказа пройден и вы уверены, что вы можете переносить SQL Server виртуальную машину, можно выполнить перемещение виртуальной машины в целевой регион. 
1. [**Очистка**](#clean-up-source-resources): Чтобы избежать расходов на выставление счетов, удалите SQL Serverную виртуальную машину из хранилища и все ненужные ресурсы, которые остались в группе ресурсов. 

## <a name="verify-prerequisites"></a>проверка предварительных требований; 

- Убедитесь, что переход из исходного региона в целевой регион [поддерживается](../../../site-recovery/azure-to-azure-support-matrix.md#region-support).  
- Изучите [архитектуру и компоненты сценария](../../../site-recovery/azure-to-azure-architecture.md) , а также [ограничения и требования к поддержке](../../../site-recovery/azure-to-azure-support-matrix.md). 
- Проверьте разрешения для учетной записи. Если вы создали бесплатную учетную запись Azure, вы являетесь администратором этой подписки. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения. Чтобы включить репликацию для виртуальной машины и скопировать данные с помощью Azure Site Recovery, необходимо иметь следующее: 
    - Разрешения на создание виртуальной машины. Встроенная роль *Участник виртуальных машин* обладает следующими разрешениями: 
        - Разрешения на создание виртуальной машины в выбранной группе ресурсов. 
        - Разрешения на создание виртуальной машины в выбранной виртуальной сети. 
        - Разрешения на запись в выбранную учетную запись хранения. 
      - Разрешения на управление операциями Azure Site Recovery. Роль *участник Site Recovery* имеет все разрешения, необходимые для управления операциями Site Recovery в хранилище служб восстановления.  

## <a name="prepare-to-move"></a>Подготовка к перемещению
Подготовьте исходную SQL Serverную виртуальную машину и целевой регион для перемещения. 

### <a name="prepare-the-source-sql-server-vm"></a>Подготовка исходной SQL Server виртуальной машины

- Убедитесь, что все последние корневые сертификаты находятся на SQL Server виртуальной машине, которую требуется переместить. Если в системе отсутствуют последние корневые сертификаты, то ограничения безопасности будут препятствовать копированию данных в целевой регион. 
- Для виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы все доверенные корневые сертификаты направляются на компьютер. В отключенной среде следуйте стандартному процессу обновления Windows и сертификата для вашей организации. 
- На виртуальных машинах Linux выполните инструкции, предоставленные распространителем Linux, чтобы установить все свежие доверенные корневые сертификаты и список отзыва сертификатов. 
- Убедитесь, что вы не используете прокси-сервер проверки подлинности для управления сетевыми подключениями для виртуальных машин, которые требуется переместить. 
- Если виртуальная машина, которую вы пытаетесь переместить, не имеет доступа к Интернету или использует прокси-сервер брандмауэра для управления исходящим доступом, проверьте требования. 
- Определите структуру сети в исходном регионе и все ресурсы, которые вы сейчас используете. Сюда могут входить, среди прочего, подсистемы балансировки нагрузки, группы безопасности сети и общедоступные IP-адреса. 

### <a name="prepare-the-target-region"></a>Подготовка целевого региона

- Убедитесь, что используемая подписка Azure позволяет создавать виртуальные машины в целевом регионе, который настроен для аварийного восстановления. Свяжитесь со службой поддержки, чтобы включить необходимые квоты. 
- Убедитесь, что у вашей подписки достаточно ресурсов для поддержки виртуальных машин с размером, соответствующим исходным виртуальным машинам. Если вы используете Site Recovery для копирования данных в целевой объект, Site Recovery выбирает тот же размер или ближайший возможный размер для целевой виртуальной машины. 
- Убедитесь, что вы создали в целевом регионе аналог каждого компонента, который вы обнаружили ранее в структуре сети исходного региона. Это важно для того, чтобы после перехода в целевой регион виртуальные машины сохранили все функции и возможности виртуальных машин в исходном регионе. 
    - При включении репликации для исходной виртуальной машины служба Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть. Вы также можете предварительно создать сеть и назначить ее виртуальной машине в потоке пользователя, чтобы включить репликацию. Необходимо вручную создать любые другие ресурсы в целевом регионе.
- Сведения о создании наиболее часто используемых сетевых ресурсов на основе конфигурации исходной виртуальной машины см. в следующих документах. 
    - [Группы безопасности сети](../../../virtual-network/tutorial-filter-network-traffic.md) 
    - [Подсистема балансировки нагрузки](../../../load-balancer/tutorial-load-balancer-basic-internal-portal.md)
    - [Общедоступный IP-адрес](../../../virtual-network/virtual-network-public-ip-address.md)
    - Дополнительные сетевые компоненты см. в документации по [сети](../../../virtual-network/virtual-networks-overview.md).
- Вручную создайте непроизводственную сеть в целевом регионе, если вы хотите протестировать конфигурацию перед выполнением окончательного перехода в целевой регион. Мы рекомендуем не пропускать этот шаг, так как он позволит минимизировать влияние на рабочую сеть. 

## <a name="configure-azure-site-recovery-vault"></a>Настройка хранилища Azure Site Recovery

Использование Azure Site Recovery для копирования данных в целевой регион, описано в действиях, приведенных далее. Создайте хранилище служб восстановления в любом регионе, отличном от исходного. 

1. Войдите на [портал Azure](https://portal.azure.com). 
1. Выберите **Создание ресурса** в левом верхнем углу панели навигации. 
1. Выберите **& средства управления** , а затем выберите **резервное копирование и Site Recovery**. 
1. На вкладке **основы** в разделе **сведения о проекте**либо создайте новую группу ресурсов в целевом регионе, либо выберите существующую группу ресурсов в целевом регионе. 
1. В разделе **сведения об экземпляре**укажите имя хранилища, а затем выберите целевой **регион** из раскрывающегося списка. 
1. Выберите **проверить и создать** , чтобы создать хранилище служб восстановления. 
1. Выберите **все службы** в левом верхнем углу панели навигации и в поле `recovery services`поиска. 
1. При необходимости Выберите звездочку рядом с **хранилищем служб восстановления** , чтобы добавить ее на панель быстрого перехода. 
1. Выберите **хранилища служб восстановления** , а затем выберите созданное хранилище служб восстановления. 
1. В области **Обзор** выберите репликация. 

   ![Настройка репликации](media/virtual-machines-windows-sql-move-to-new-region/configure-replication.png)

1. Выберите **источник** , а затем в качестве источника выберите **Azure** . Выберите соответствующие значения для других раскрывающихся полей, например расположение исходных виртуальных машин. В поле **Исходная группа ресурсов** будут отображаться только группы ресурсов, расположенные в регионе **исходного расположения** . 
1. Выберите **виртуальные машины** , а затем выберите виртуальные машины, которые требуется перенести. Нажмите кнопку **ОК** , чтобы сохранить выбор виртуальной машины. 
1. Выберите **Параметры**, а затем выберите **целевое расположение** из раскрывающегося списка. Это должна быть подготовленная ранее группа ресурсов. 
1. После настройки репликации выберите **создать целевые ресурсы** , чтобы создать ресурсы в новом расположении. 
1. После завершения создания ресурса выберите **включить репликацию** , чтобы запустить репликацию SQL Server виртуальной машины из источника в целевой регион.
1. Состояние репликации можно проверить, перейдя в хранилище восстановления, выбрав пункт **реплицированные элементы** и просмотрев **состояние** виртуальной машины SQL Server. Состояние **protected** означает, что репликация завершена. 

   ![Проверка состояния репликации](media/virtual-machines-windows-sql-move-to-new-region/check-replication-status.png)

## <a name="test-move-process"></a>Процесс перемещения теста
Ниже описано, как использовать Azure Site Recovery для проверки процесса перемещения. 

1. Перейдите к **хранилищу служб восстановления** в [портал Azure](https://portal.azure.com) и выберите **реплицированные элементы**. 
1. Выберите SQL Server виртуальную машину, которую нужно переместить, убедитесь, что **работоспособность репликации** отображается как работоспособная, а затем выберите тестовая отработка **отказа**. 

   ![Тестовая отработка отказа для виртуальной машины](media/virtual-machines-windows-sql-move-to-new-region/test-failover-of-replicated-vm.png)

1. На странице **Тестовая** отработка отказа выберите последнюю точку восстановления, согласованную с **приложениями** , которая будет использоваться для отработки отказа, так как это единственный тип моментального снимка, который может гарантировать SQL Server согласованности данных. 
1. Выберите виртуальную сеть в разделе **Виртуальная сеть Azure** и нажмите кнопку **ОК** , чтобы протестировать отработку отказа. 
   
   >[!IMPORTANT]
   > Для теста отработки отказа рекомендуется использовать отдельную сеть виртуальной машины Azure. Не используйте для этого рабочую сеть, которая была настроена при включении репликации, то есть в которую вы намерены переместить виртуальные машины. 

1. Чтобы отслеживать ход выполнения, перейдите в хранилище, выберите **Site Recovery задания** в разделе **мониторинг**, а затем выберите выполняемое задание тестовой отработки **отказа** .

   ![Отслеживание хода выполнения теста отработки отказа](media/virtual-machines-windows-sql-move-to-new-region/monitor-failover-test-job.png)

1. После завершения теста перейдите к разделу **виртуальные машины** на портале и просмотрите только что созданную виртуальную машину. Убедитесь, что SQL Server виртуальная машина запущена, имеет соответствующий размер и подключен к соответствующей сети. 
1. Удалите виртуальную машину, созданную в ходе тестирования, так как параметр отработки отказа будет неактивен, пока не будут очищены тестовые ресурсы для отработки отказа. Вернитесь к хранилищу, выберите **реплицированные элементы**, выберите виртуальную машину SQL Server, а затем нажмите кнопку **очистить тестовую отработку отказа**. Запишите и сохраните все наблюдения, связанные с тестом, в разделе **Примечания** и установите флажок рядом **с пунктом тестирование завершено. Удаление виртуальных машин**тестовой отработки отказа. Нажмите кнопку **ОК** , чтобы очистить ресурсы после выполнения теста. 

   ![Очистка элементов после выполнения теста отработки отказа](media/virtual-machines-windows-sql-move-to-new-region/cleanup-test-items.png)

## <a name="move-the-sql-server-vm"></a>Перемещение SQL Server виртуальной машины 
Ниже описано, как переместить виртуальную машину SQL Server из исходного региона в целевой. 

1. Перейдите к хранилищу **служб восстановления** , выберите **реплицированные элементы**, выберите виртуальную машину, а затем щелкните отработка **отказа**. 

   ![Запустить отработку отказа](media/virtual-machines-windows-sql-move-to-new-region/initiate-failover.png)

1. Выберите последнюю последовательное обновление **с учетом приложений** в разделе **точка восстановления**. 
1. Установите флажок рядом с **завершением работы компьютера перед**отработкой отказа. Site Recovery попытается завершить работу исходной виртуальной машины перед активацией отработки отказа. Отработка отказа продолжится, даже если завершить работу не удастся. 
1. Нажмите кнопку **ОК** , чтобы начать отработку отказа.
1. Вы можете отслеживать процесс отработки отказа с той же страницы **Site Recovery задания** , которую вы просматриваете при наблюдении за тестом отработки отказа в предыдущем разделе. 
1. После завершения задания убедитесь, что SQL Server виртуальная машина отображается в целевом регионе, как ожидалось. 
1. Вернитесь к хранилищу, выберите **реплицированные элементы**, выберите виртуальную машину SQL Server и нажмите кнопку **Commit (применить** ), чтобы завершить процесс перемещения в целевой регион. Дождитесь, пока завершится задание фиксации. 
1. Зарегистрируйте ВИРТУАЛЬную машину SQL Server с помощью поставщика ресурсов виртуальной машины SQL, чтобы обеспечить управляемость **виртуальных машин SQL** в портал Azure и компонентах, связанных с поставщиком ресурсов. Дополнительные сведения см. в статье [регистрация SQL Server виртуальной машины с помощью поставщика ресурсов виртуальной машины SQL](virtual-machines-windows-sql-register-with-rp.md). 

  > [!WARNING]
  > SQL Server согласованность данных гарантируется только с помощью моментальных снимков, согласованных с приложениями. **Последний обработанный** моментальный снимок нельзя использовать для SQL Server отработки отказа, так как моментальный снимок аварийного восстановления не может гарантировать SQL Server согласованности данных. 

## <a name="clean-up-source-resources"></a>Очистка исходных ресурсов
Чтобы избежать расходов на выставление счетов, удалите SQL Serverную виртуальную машину из хранилища и удалите все ненужные связанные ресурсы. 

1. Вернитесь к хранилищу **Site Recovery** , выберите **реплицированные элементы**и выберите виртуальную машину SQL Server. 
1. Щелкните **Отключить репликацию**. Выберите причину отключения защиты, а затем нажмите кнопку **ОК** , чтобы отключить репликацию. 

   >[!IMPORTANT]
   > Важно выполнить этот шаг, чтобы избежать оплаты за Azure Site Recoveryную репликацию. 

1. Если вы не планируете повторно использовать какие бы то ни было ресурсы в исходном регионе, удалите все соответствующие сетевые ресурсы и соответствующие учетные записи хранения. 


## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения см. в следующих статьях: 

* [Обзор SQL Server на виртуальных машинах Windows](virtual-machines-windows-sql-server-iaas-overview.md).
* [Вопросы и ответы по SQL Server на виртуальных машинах Windows](virtual-machines-windows-sql-server-iaas-faq.md).
* [Руководство по выбору ценовой категории для виртуальных машин SQL Server в Azure](virtual-machines-windows-sql-server-pricing-guidance.md)
* [Заметки о выпуске SQL Server на виртуальных машинах Windows](virtual-machines-windows-sql-server-iaas-release-notes.md).


