---
title: Перемещение виртуальной машины в другой регион (Восстановление сайта Azure)
description: Узнайте, как можно перенести виртуальную машину s'L Server из одного региона в другой в Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: jroth
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 07/30/2019
ms.author: mathoma
ms.reviewer: jroth
ms.custom: seo-lt-2019
ms.openlocfilehash: 3b84119cdcc1bb7e8603de64e3d23c69dac70cc3
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74022290"
---
# <a name="move-sql-server-vm-to-another-region-within-azure-with-azure-site-recovery-services"></a>Переместите VM-сервер S'L в другой регион в Azure с помощью служб восстановления сайтов Azure

В этой статье рассказывается о том, как использовать восстановление сайта Azure для переноса виртуальной машины (VM) из одного региона в другой в Azure. 

Перемещение VM сервера S'L в другой регион требует выполнения следующих вопросов:
1. [**Подготовка**](#prepare-to-move): Подтвердите, что как ваш источник S'L Server VM, так и целевая область должным образом подготовлены к переезду. 
1. [**Настройка**](#configure-azure-site-recovery-vault): Перемещение VM сервера S'L требует, чтобы он был реплицированным объектом в хранилище восстановления сайта Azure. Необходимо добавить VM сервера S'L в хранилище восстановления сайта Azure. 
1. [**Тестирование:**](#test-move-process)Миграция VM сервера S'L требует сбоя из исходного региона в реплицированный целевой регион. Чтобы убедиться в успехе процесса перемещения, необходимо сначала проверить, что ваш S'L Server VM может успешно выйти из строя в целевой регион. Это поможет разоблачить любые проблемы и избежать их при выполнении фактического перемещения. 
1. [**Перемещение:**](#move-the-sql-server-vm)После сбоя теста, и вы знаете, что вы в безопасности, чтобы перенести ваш S'L Server VM, вы можете выполнить перемещение VM в целевой области. 
1. [**Очистка:**](#clean-up-source-resources)Во избежание платежей удалите VM сервера S'L из хранилища и любые ненужные ресурсы, оставшиеся в группе ресурсов. 

## <a name="verify-prerequisites"></a>проверка предварительных требований; 

- Подтвердите поддержку перехода из исходного региона в [целевой](../../../site-recovery/azure-to-azure-support-matrix.md#region-support)регион.  
- Просмотрите [архитектуру и компоненты](../../../site-recovery/azure-to-azure-architecture.md) сценариев, а также [ограничения и требования поддержки.](../../../site-recovery/azure-to-azure-support-matrix.md) 
- Проверьте разрешения для учетной записи. Если вы создали бесплатную учетную запись Azure, вы являетесь администратором этой подписки. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения. Для включения репликации для VM и копирования данных с помощью Azure Site Recovery необходимо: 
    - Разрешения на создание VM. *Виртуальная машина Вкладчик* встроенный роль имеет эти разрешения, которые включают в себя: 
        - Разрешения на создание VM в выбранной группе ресурсов. 
        - Разрешения на создание VM в выбранной виртуальной сети. 
        - Разрешение на запись в выбранную учетную запись хранилища. 
      - Разрешения на управление операциями Azure Site Recovery. Роль *вкладчика восстановления сайта* имеет все разрешения, необходимые для управления операциями восстановления сайта в хранилище служб восстановления.  

## <a name="prepare-to-move"></a>Подготовка к переезду
Подготовьте для перемещения как исходный сервер VM, так и целевой регион. 

### <a name="prepare-the-source-sql-server-vm"></a>Подготовьте источник VM сервера S'L

- Убедитесь, что все последние корневые сертификаты находятся на VM сервера S'L, который вы хотите переместить. Если последних корневых сертификатов нет, ограничения безопасности предотвратят копирование данных в целевой регион. 
- Для Windows VMs установите все последние обновления Windows на VM, так что все доверенные корневые сертификаты находятся на машине. В отключенной среде следуйте стандартному процессу обновления Windows UPdate и обновлению сертификатов для организации. 
- На виртуальных машинах Linux выполните инструкции, предоставленные распространителем Linux, чтобы установить все свежие доверенные корневые сертификаты и список отзыва сертификатов. 
- Убедитесь, что вы не используете прокси-сервер проверки подлинности для управления подключением к сети для вс-кей, которые вы хотите переместить. 
- Если виртуальная машина, которую вы пытаетесь переместить, не имеет доступа к Интернету и (или) использует прокси-сервер брандмауэра для управления исходящим доступом, проверьте соответствующие требования. 
- Определите структуру сети в исходном регионе и все ресурсы, которые вы сейчас используете. Сюда могут входить, среди прочего, подсистемы балансировки нагрузки, группы безопасности сети и общедоступные IP-адреса. 

### <a name="prepare-the-target-region"></a>Подготовка целевого региона

- Убедитесь, что используемая подписка Azure позволяет создавать виртуальные машины в целевом регионе, который настроен для аварийного восстановления. Свяжитесь со службой поддержки, чтобы включить необходимые квоты. 
- Убедитесь, что ваша подписка имеет достаточно ресурсов для поддержки VMs с размером, который соответствует вашим источникам VMs. Если вы используете Восстановление сайта для копирования данных в цель, восстановление сайта выбирает тот же размер или ближайший возможный размер для целевого VM. 
- Убедитесь, что вы создали в целевом регионе аналог каждого компонента, который вы обнаружили ранее в структуре сети исходного региона. Это важно для того, чтобы после перехода в целевой регион виртуальные машины сохранили все функции и возможности виртуальных машин в исходном регионе. 
    - При включении репликации для исходной виртуальной машины служба Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть. Вы также можете предварительно создать сеть и назначить ее VM в потоке пользователя для включения репликации. Вам необходимо вручную создавать любые другие ресурсы в целевом регионе.
- Сведения о создании наиболее часто используемых сетевых ресурсов на основе конфигурации исходной виртуальной машины см. в следующих документах. 
    - [Группы сетевой безопасности](../../../virtual-network/tutorial-filter-network-traffic.md) 
    - [Балансизатор нагрузки](../../../load-balancer/tutorial-load-balancer-basic-internal-portal.md)
    - [Общественный IP-адрес](../../../virtual-network/virtual-network-public-ip-address.md)
    - Для любых дополнительных сетевых компонентов [см.](../../../virtual-network/virtual-networks-overview.md)
- Вручную создайте непроизводственную сеть в целевом регионе, если вы хотите проверить конфигурацию перед окончательным переходом в целевой регион. Мы рекомендуем не пропускать этот шаг, так как он позволит минимизировать влияние на рабочую сеть. 

## <a name="configure-azure-site-recovery-vault"></a>Настройка хранилища восстановления сайта Azure

Использование Azure Site Recovery для копирования данных в целевой регион, описано в действиях, приведенных далее. Создание хранилища служб восстановления в любом регионе, кроме исходного региона. 

1. Войти на [портал Azure](https://portal.azure.com). 
1. Выберите **для создания ресурса** из верхнего левого угла навигационной панели. 
1. Выберите **инструменты управления ИТ-&,** а затем выберите **резервное копирование и восстановление сайта.** 
1. На **вкладке «Основы»** под **деталями проекта**либо создайте новую группу ресурсов в целевом регионе, либо выберите существующую группу ресурсов в целевом регионе. 
1. В соответствии с сведениями о **экземпляре,** укажите имя для хранилища, а затем выберите свой целевой **регион** из выпадения. 
1. Выберите **Обзор и Создайте** для создания хранилища служб восстановления. 
1. Выберите **все услуги** из верхнего левого угла навигационного стекла `recovery services`и в типе окна поиска. 
1. (По желанию) Выберите звезду рядом со **хранилищами служб восстановления,** чтобы добавить ее в панель быстрой навигации. 
1. Выберите **хранилища служб восстановления,** а затем выберите созданное вами хранилище служб восстановления. 
1. На панели **обзора** выберите **Replicate**. 

   ![Настройка репликации](media/virtual-machines-windows-sql-move-to-new-region/configure-replication.png)

1. Выберите **Источник,** а затем выберите **Azure** в качестве источника. Выберите соответствующие значения для других полей выпадения, таких как расположение исходных VMs. Только группы ресурсов, расположенные в регионе **расположения Исходного источника,** будут видны в поле **группы ресурсов Source.** 
1. Выберите **виртуальные машины,** а затем выберите виртуальные машины, которые вы хотите перенести. Выберите **OK,** чтобы сохранить выбор VM. 
1. Выберите **настройки,** а затем выберите **место мишени** из выпадения вниз. Это должна быть группа ресурсов, подготовленная ранее. 
1. После настройки репликации выберите **Создать целевые ресурсы** для создания ресурсов в новом местоположении. 
1. После завершения создания ресурса выберите **репликацию Включить,** чтобы начать репликацию вашего VM сервера S'L из исходного кода в целевой регион.
1. Вы можете проверить состояние репликации, перемещаясь в хранилище восстановления, выбирая **реплицированные элементы** и просматривая **состояние** вашего Сервера VM. Статус **Защищенного** указывает на завершение репликации. 

   ![Проверка состояния репликации](media/virtual-machines-windows-sql-move-to-new-region/check-replication-status.png)

## <a name="test-move-process"></a>Процесс перемещения теста
Следующие шаги показывают, как использовать восстановление сайта Azure для тестирования процесса перемещения. 

1. Перейдите в **хранилище служб восстановления** на [портале Azure](https://portal.azure.com) и выберите **элементы Replicated.** 
1. Выберите VM сервера S'L, который вы хотели бы переместить, убедитесь, что **здоровье репликации** отображается как **Здоровый,** а затем выберите **Test Failover.** 

   ![Тест неудача для вашего VM](media/virtual-machines-windows-sql-move-to-new-region/test-failover-of-replicated-vm.png)

1. На странице **Test Failover** выберите последнюю точку восстановления **приложения,** которая будет использоваться для сбоя, так как это единственный тип моментального снимка, который может гарантировать согласованность данных сервера S'L. 
1. Выберите виртуальную сеть в **виртуальной сети Azure,** а затем выберите **OK** для тестирования сбоя. 
   
   >[!IMPORTANT]
   > Мы рекомендуем использовать отдельную vM-сеть Azure для тестирования на отказ. Не используйте для этого рабочую сеть, которая была настроена при включении репликации, то есть в которую вы намерены переместить виртуальные машины. 

1. Чтобы следить за прогрессом, перейдите к хранилищу, выберите **задания восстановления сайта** под **мониторингом,** а затем выберите работу по **отказу теста,** которая продолжается.

   ![Мониторинг хода тестирования на сбой](media/virtual-machines-windows-sql-move-to-new-region/monitor-failover-test-job.png)

1. После завершения теста перейдите на **виртуальные машины** на портале и просмотрите недавно созданную виртуальную машину. Убедитесь, что ВМ сервера S'L работает, имеет соответствующий размер и подключен к соответствующей сети. 
1. Удалите VM, который был создан в рамках теста, так как параметр **Failover** будет поседен до тех пор, пока ресурсы тестирования failover не будут очищены. Перейдите назад в хранилище, выберите **Реплицированные элементы,** выберите S'L Server VM, а затем выберите **тест очистки failover.** Запись и сохранение любых наблюдений, связанных с тестом в разделе **Заметки,** и выберите флажок рядом с **тестированием завершена. Удалить тест failover виртуальных машин**. Выберите **OK** для очистки ресурсов после тестирования. 

   ![очистка элементов после теста на сбой](media/virtual-machines-windows-sql-move-to-new-region/cleanup-test-items.png)

## <a name="move-the-sql-server-vm"></a>Перемещение Сервера VM 
Следующие шаги показывают, как переместить VM сервера S'L из исходного региона в целевой регион. 

1. Перейдите в хранилище **служб восстановления,** выберите **реплицированные элементы,** выберите VM, а затем выберите **Failover.** 

   ![Инициировать сбой](media/virtual-machines-windows-sql-move-to-new-region/initiate-failover.png)

1. Выберите **последнюю** точку восстановления приложения под **точкой восстановления.** 
1. Выберите флажок рядом с **выключить машину до начала неудачи.** Восстановление сайта попытается закрыть источник VM перед запуском сбоя. Failover будет продолжаться, даже если выключится не удается. 
1. Выберите **OK,** чтобы начать неудачу.
1. Вы можете контролировать процесс сбоя с той же страницы **заданий восстановления сайта,** который просматривали при мониторинге теста на неудачу в предыдущем разделе. 
1. После завершения задания убедитесь, что VM сервера S'L отображается в целевом регионе, как и ожидалось. 
1. Перейдите назад в хранилище, выберите **Replicated Элементы,** выберите VM сервера S'L и выберите **Commit,** чтобы закончить процесс перемещения в целевой регион. Дождитесь, пока завершится задание фиксации. 
1. Зарегистрируйте свой S'L Server VM с помощью поставщика ресурсов S'L VM, чтобы обеспечить управляемость **виртуальной машины на** портале Azure и функции, связанные с поставщиком ресурсов. Для получения более подробной информации [см.](virtual-machines-windows-sql-register-with-rp.md) 

  > [!WARNING]
  > Согласованность данных сервера S'L гарантируется только с помощью последовательных моментальных снимков приложения. **Последний обработанный** снимок не может быть использован для сбоя сервера S'L Server, так как моментальный снимок восстановления сбоя не может гарантировать согласованность данных сервера S'L Server. 

## <a name="clean-up-source-resources"></a>Очистка исходных ресурсов
Во избежание платежей удалите VM сервера S'L из хранилища и удалите ненужные связанные ресурсы. 

1. Перейдите назад в хранилище **восстановления сайта,** выберите **реплицированные элементы**и выберите VM сервера S'L. 
1. Щелкните **Отключить репликацию**. Выберите причину отключения защиты, а затем выберите **OK,** чтобы отключить репликацию. 

   >[!IMPORTANT]
   > Важно выполнить этот шаг, чтобы избежать взимания платы за репликацию сайта Azure. 

1. Если у вас нет планов повторного использования каких-либо ресурсов в регионе исходного кода, удалите все соответствующие сетевые ресурсы и соответствующие учетные записи хранения. 


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих статьях: 

* [Обзор сервера S'L на Windows VM](virtual-machines-windows-sql-server-iaas-overview.md)
* [Вопросы и ответы по SQL Server на виртуальных машинах Windows](virtual-machines-windows-sql-server-iaas-faq.md).
* [Сервер S'L на руководстве по ценообразованию Windows VM](virtual-machines-windows-sql-server-pricing-guidance.md)
* [Заметки о выпуске SQL Server на виртуальных машинах Windows](virtual-machines-windows-sql-server-iaas-release-notes.md).


