---
title: Настройка хранилища для виртуальных машин SQL Server | Документация Майкрософт
description: В этой статье описывается процесс настройки хранилища для виртуальных машин SQL Server на портале Azure во время подготовки (модель развертывания с помощью Resource Manager). Здесь также описывается настройка хранилища для имеющихся виртуальных машин SQL Server.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: jroth
tags: azure-resource-manager
ms.assetid: 169fc765-3269-48fa-83f1-9fe3e4e40947
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 12/05/2017
ms.author: mathoma
ms.openlocfilehash: 57a325dd297955296a94db134b6a2a6d58a37f03
ms.sourcegitcommit: 7c2dba9bd9ef700b1ea4799260f0ad7ee919ff3b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/02/2019
ms.locfileid: "71828608"
---
# <a name="storage-configuration-for-sql-server-vms"></a>Настройка хранилища для виртуальных машин SQL Server

При настройке образа виртуальной машины SQL Server на портале Azure некоторые процессы конфигурации хранилища выполняются автоматически. К этим процессам относится подключение хранилища к виртуальной машине, предоставление SQL Server доступа к нему и настройка параметров, которые позволяют оптимизировать производительность хранилища.

В этой статье описывается процесс настройки хранилища для подготавливаемых и уже имеющихся виртуальных машин SQL Server на портале Azure. Эта конфигурация основана на [рекомендациях по оптимизации производительности](virtual-machines-windows-sql-performance.md) для виртуальных машин Azure с SQL Server.

[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-rm-include.md)]

## <a name="prerequisites"></a>Предварительные требования

Для поддержки параметров автоматической настройки хранилища виртуальная машина должна:

* быть подготовлена с помощью [коллекции образов SQL Server](virtual-machines-windows-sql-server-iaas-overview.md#payasyougo);
* использовать [модель развертывания с помощью Resource Manager](../../../azure-resource-manager/resource-manager-deployment-model.md);
* использовать [твердотельные накопители класса Premium](../disks-types.md).

## <a name="new-vms"></a>Новые виртуальные машины

В следующих разделах описаны действия по настройке хранилища для новых виртуальных машин SQL Server.

### <a name="azure-portal"></a>портала Azure

При подготовке виртуальной машины Azure с помощью образа коллекции SQL Server выберите **изменить конфигурацию** на вкладке **параметры SQL Server** , чтобы открыть страницу конфигурации с хранилищем, оптимизированным для производительности. Можно либо оставить значения по умолчанию, либо изменить тип конфигурации диска, которая лучше соответствует вашим потребностям в зависимости от рабочей нагрузки. 

![Настройка хранилища для виртуальной машины SQL Server во время подготовки](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-provisioning.png)

В разделе **Оптимизация хранилища**выберите тип рабочей нагрузки, которую вы развертываете SQL Server. Параметр **общей** оптимизации по умолчанию будет иметь один диск данных с 5000 максимум операций ввода-вывода в секунду, и этот же диск будет использоваться для данных, журнала транзакций и хранилища tempdb. При выборе **транзакционная обработка** (OLTP) или **хранилища данных** создается отдельный диск для данных, отдельный диск для журнала транзакций и используется локальный SSD для tempdb. Между **транзакционной обработкой** и **хранением данных**нет различий в хранении, но она изменяет [конфигурацию stripe и флаги трассировки](#workload-optimization-settings). Если выбрать хранилище класса Premium, кэширование будет *доступно только для чтения* для диска *данных и не подходит для* диска журнала, как в [SQL Server рекомендации по производительности виртуальных машин](virtual-machines-windows-sql-performance.md). 

![Настройка хранилища для виртуальной машины SQL Server во время подготовки](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration.png)

Конфигурация диска полностью настраиваема, поэтому вы можете настроить топологию хранилища, тип диска и число операций ввода-вывода для рабочей нагрузки SQL Server виртуальной машины. Вы также можете использовать Ултрассд (Предварительная версия) в качестве варианта для **типа диска** , если SQL Server виртуальная машина находится в одном из поддерживаемых регионов (Восточная часть США 2, Юго-Восточная Азия и Северная Европа) и вы включили [в подписку Ultra Disks](/azure/virtual-machines/windows/disks-enable-ultra-ssd).  

Кроме того, вы можете задать кэширование для дисков. В виртуальных машинах Azure используется многоуровневая технология кэширования [BLOB-объектов](/azure/virtual-machines/windows/premium-storage-performance#disk-caching) при использовании с [дисками](/azure/virtual-machines/windows/disks-types#premium-ssd)уровня "Премиум". Кэш BLOB-объектов использует сочетание ОЗУ виртуальной машины и локального SSD для кэширования. 

Кэширование диска для SSD (цен. категория "Премиум") может иметь значение *ReadOnly*, *ReadWrite* или *None*. 

- Кэширование *только для чтения* очень полезно для SQL Server файлов данных, которые хранятся в хранилище класса Premium. Кэширование *только для* чтения обеспечивает низкую задержку при чтении, высокую скорость операций чтения и пропускную способность, так как операции чтения выполняются из кэша, операционной системы в памяти виртуальной машины и локального SSD. Эти операции чтения выполняются гораздо быстрее, чем чтение с диска данных, который находится в хранилище BLOB-объектов Azure. Хранилище класса Premium не учитывает операции чтения из кэша в сторону операций ввода-вывода и пропускной способности диска. Таким образом, вы можете добиться большей общей пропускной способности Ant операций ввода-вывода. 
- Не следует использовать *конфигурацию кэша для* дисков, на которых размещен файл журнала SQL Server, так как файл журнала записывается последовательно и не является преимуществом кэширования *только для чтения* . 
- Кэширование *ReadWrite* не следует использовать для размещения файлов SQL Server, так как SQL Server не поддерживает согласованность данных с кэшем *ReadWrite* . Записывает неиспользуемую емкость кэша больших двоичных объектов *только для чтения* и задержки немного увеличиваются, если записи проходят через уровни кэша BLOB-объектов *ReadOnly* . 


   > [!TIP]
   > Убедитесь, что конфигурация хранилища соответствует ограничениям, накладываемым выбранным размером виртуальной машины. Выбор параметров хранилища, превышающих ограничение производительности для размера виртуальной машины, приведет к ошибке: `The desired performance might not be reached due to the maximum virtual machine disk performance cap.`. Либо Сократите число операций ввода-вывода, изменив тип диска, либо увеличьте ограничение производительности, увеличив размер виртуальной машины. 


После создания виртуальной машины в зависимости от вашего выбора Azure выполняет следующие задачи по настройке хранилища:

* создает и присоединяет к виртуальной машине твердотельные накопители класса Premium;
* настраивает доступность дисков данных для SQL Server;
* настраивает диски данных в пуле носителей в зависимости от указанных требований к размеру и производительности (операции ввода-вывода в секунду и пропускная способность);
* связывает пул носителей с новым диском на виртуальной машине;
* оптимизирует этот диск в зависимости от указанного типа рабочей нагрузки ("Хранилище данных", "Обработка транзакций" или "Общая").

Дополнительные сведения о настройке параметров хранилища в Azure см. в разделе [Конфигурация хранилища](#storage-configuration). Полное пошаговое руководство по созданию SQL Server виртуальной машины в портал Azure см. [в руководстве по подготовке](virtual-machines-windows-portal-sql-server-provision.md).

### <a name="resource-manage-templates"></a>Шаблоны Resource Manager

При использовании следующих шаблонов Resource Manager по умолчанию к виртуальной машине присоединяются два диска данных класса Premium. В этом случае пул носителей не настраивается. Однако эти шаблоны можно настроить, чтобы изменить количество дисков данных класса Premium, присоединенных к виртуальной машине.

* [Создание виртуальной машины с поддержкой автоматической архивации](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autobackup)
* [Создание виртуальной машины с автоматической установкой исправлений](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autopatching)
* [Создание виртуальной машины с интеграцией AKV](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-keyvault)

### <a name="quickstart-template"></a>Шаблон быстрого запуска

Для развертывания SQL Server виртуальной машины с помощью оптимизации хранилища можно использовать следующий шаблон быстрого запуска. 

* [Создание виртуальной машины с оптимизацией хранилища](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-new-storage/)
* [Создание виртуальной машины с помощью Ултрассд](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-new-storage-ultrassd)

## <a name="existing-vms"></a>Существующие виртуальные машины

[!INCLUDE [windows-virtual-machines-sql-use-new-management-blade](../../../../includes/windows-virtual-machines-sql-new-resource.md)]

Для имеющихся виртуальных машин SQL Server на портале Azure можно изменить некоторые параметры хранилища. Откройте [ресурс виртуальных машин SQL](virtual-machines-windows-sql-manage-portal.md#access-the-sql-virtual-machines-resource)и выберите **Обзор**. На странице Обзор SQL Server показано текущее использование хранилища виртуальной машины. На этой диаграмме отображаются все диски, подключенные к виртуальной машине. Дисковое пространство для каждого диска разбито на 4 раздела:

* данные SQL;
* журнал SQL;
* прочее (не хранилище SQL);
* Доступно

Чтобы изменить параметры хранилища, выберите **Настройка** в разделе **Параметры**. 

![Настройка хранилища для имеющейся виртуальной машины SQL Server](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-existing.png)

Вы можете изменить параметры диска для дисков, которые были настроены во время процесса создания виртуальной машины SQL Server. При выборе **расширения диска** открывается страница Изменение диска, позволяющая изменить тип диска, а также добавить дополнительные диски. 

![Настройка хранилища для имеющейся виртуальной машины SQL Server](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-extend-drive.png)



## <a name="storage-configuration"></a>Конфигурация хранилища

В этом разделе содержится ссылка на изменения конфигурации хранилища, которые Azure автоматически выполняет во время подготовки или настройки виртуальной машины SQL в портал Azure.

* Azure настраивает пул носителей из хранилища, выбранного на виртуальной машине. В следующем разделе этой статьи приводятся сведения о конфигурации пула носителей.
* При автоматической настройке хранилища всегда используются диски данных P30 [на базе твердотельных накопителей класса Premium](../disks-types.md). Следовательно, между выбранным числом терабайт и количеством дисков, прикрепленных к виртуальной машине, существует полноценное сопоставление.

Сведения о ценах см. на странице [Цены на хранилища Azure](https://azure.microsoft.com/pricing/details/storage) на вкладке **Хранилище дисков**.

### <a name="creation-of-the-storage-pool"></a>Создание пула носителей

Для создания пула носителей на виртуальных машинах SQL Server Azure использует следующие параметры.

| Параметр | Значение |
| --- | --- |
| Размер полосы |256 КБ (хранение данных), 64 КБ (обработка транзакций) |
| Размеры диска |1 ТБ каждый |
| Кэш |прочтены |
| Размер выделения |Размер единицы выделения NTFS — 64 КБ |
| Мгновенная инициализация файлов |Enabled |
| Блокировка страниц в памяти |Enabled |
| Восстановление |Простая модель восстановления (без устойчивости) |
| Количество столбцов |Количество дисков данных<sup>1</sup> |
| Расположение временной базы данных |Хранится на дисках данных<sup>2</sup> |

<sup>1</sup> После создания пула носителей вы не сможете изменить в нем количество столбцов.

<sup>2</sup> Этот параметр применяется только для первого диска, созданного с помощью функции конфигурации хранилища.

## <a name="workload-optimization-settings"></a>Параметры оптимизации рабочей нагрузки

В следующей таблице описаны три доступных типа рабочей нагрузки и соответствующие оптимизации для каждого из них.

| Тип рабочей нагрузки | Описание | Оптимизация |
| --- | --- | --- |
| **Общие сведения** |Значение по умолчанию, поддерживающее большинство рабочих нагрузок |Отсутствуют |
| **Обработка транзакций** |Оптимизирует хранилище для рабочих нагрузок OLTP в традиционных базах данных |Флаг трассировки 1117<br/>Флаг трассировки 1118 |
| **Хранение данных** |Оптимизирует хранилище для рабочих нагрузок аналитики и отчетов |Флаг трассировки 610<br/>Флаг трассировки 1117 |

> [!NOTE]
> Тип рабочей нагрузки можно указать только во время подготовки виртуальной машины SQL на этапе настройки хранилища.

## <a name="next-steps"></a>Следующие шаги

Другие темы, связанные с запуском SQL Server на виртуальных машинах Azure, рассматриваются в статье [SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).
