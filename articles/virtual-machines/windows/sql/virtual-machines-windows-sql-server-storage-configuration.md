---
title: Настройка хранилища для виртуальных машин SQL Server | Документация Майкрософт
description: В этой статье описывается процесс настройки хранилища для виртуальных машин SQL Server на портале Azure во время подготовки (модель развертывания с помощью Resource Manager). Здесь также описывается настройка хранилища для имеющихся виртуальных машин SQL Server.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: jroth
tags: azure-resource-manager
ms.assetid: 169fc765-3269-48fa-83f1-9fe3e4e40947
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 12/26/2019
ms.author: mathoma
ms.openlocfilehash: 93f01b3c23e08e7f432841d8a77cbe3602bff1c5
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81482139"
---
# <a name="storage-configuration-for-sql-server-vms"></a>Настройка хранилища для виртуальных машин SQL Server

При настройке образа виртуальной машины SQL Server на портале Azure некоторые процессы конфигурации хранилища выполняются автоматически. К этим процессам относится подключение хранилища к виртуальной машине, предоставление SQL Server доступа к нему и настройка параметров, которые позволяют оптимизировать производительность хранилища.

В этой статье описывается процесс настройки хранилища для подготавливаемых и уже имеющихся виртуальных машин SQL Server на портале Azure. Эта конфигурация основана на [рекомендациях по оптимизации производительности](virtual-machines-windows-sql-performance.md) для виртуальных машин Azure с SQL Server.

[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-rm-include.md)]

## <a name="prerequisites"></a>Предварительные требования

Для поддержки параметров автоматической настройки хранилища виртуальная машина должна:

* быть подготовлена с помощью [коллекции образов SQL Server](virtual-machines-windows-sql-server-iaas-overview.md#payasyougo);
* использовать [модель развертывания с помощью Resource Manager](../../../azure-resource-manager/management/deployment-models.md);
* использовать [твердотельные накопители класса Premium](../disks-types.md).

## <a name="new-vms"></a>Новые виртуальные машины

В следующих разделах описаны действия по настройке хранилища для новых виртуальных машин SQL Server.

### <a name="azure-portal"></a>Портал Azure

При подготовке Azure VM с помощью изображения галереи сервера S'L Server выберите **конфигурацию изменения** на вкладке **«Настройки сервера»** для открытия страницы конфигурации оптимизированной системы хранения данных. Вы можете либо оставить значения по умолчанию, либо изменить тип конфигурации диска, который наилучшим образом соответствует вашим потребностям в зависимости от рабочей нагрузки. 

![Настройка хранилища для виртуальной машины SQL Server во время подготовки](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-provisioning.png)

Выберите тип рабочей нагрузки, для развертывания сервера S'L, для **оптимизации хранилища.** С опцией **общей** оптимизации по умолчанию у вас будет один диск данных с 5000 max IOPS, и вы будете использовать этот же диск для ваших данных, журнала транзакций и хранения TempDB. Выбор **либо транзакционной обработки** (OLTP) или **складирования данных** создаст отдельный диск для данных, отдельный диск для журнала транзакций и использовать локальный SSD для TempDB. Нет различий в хранении между **транзакционной обработкой** и **складированием данных,** но это меняет [конфигурацию полосы и флаги трассировки.](#workload-optimization-settings) Выбор премиум-хранилища устанавливает кэширование *для ReadOnly* для диска данных, и *ни одного* для диска журнала в качестве [наилучшей производительности сервера S'L Server VM.](virtual-machines-windows-sql-performance.md) 

![Настройка хранилища для виртуальной машины SQL Server во время подготовки](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration.png)

Конфигурация диска полностью настраивается, так что вы можете настроить топологию хранения, тип диска и IOPs, необходимые для вашей рабочей нагрузки сервера VM. У вас также есть возможность использовать UltraSSD (предварительный просмотр) в качестве опции для **типа диска,** если ваш S'L Server VM находится в одном из поддерживаемых регионов (Восточная ЧАСТЬ США 2, юго-восточная Азия и Северная Европа), и вы включили [ультрадиски для подписки.](/azure/virtual-machines/windows/disks-enable-ultra-ssd)  

Кроме того, у вас есть возможность установить кэширование для дисков. Вазум VMs имеют многоуровневую технологию кэширования под названием [Blob Cache](/azure/virtual-machines/windows/premium-storage-performance#disk-caching) при использовании с [Premium Disks.](/azure/virtual-machines/windows/disks-types#premium-ssd) Blob Cache использует комбинацию оперативной памяти виртуальной машины и локального SSD для кэширования. 

Кэширование диска для Premium SSD может быть *readOnly,* *ReadWrite* или *Нет*. 

- *Кэширование ReadOnly* очень полезно для файлов данных сервера S'L Server, которые хранятся на Premium Storage. *ReadOnly* кэширование приносит низкую задержку чтения, высокое чтение IOPS, и пропускную готовность, как, читает выполняются из кэша, который находится в памяти VM и локального SSD. Эти считываний гораздо быстрее, чем считываемые данные с диска данных, который находится в хранилище Azure blob. Премиум-хранилище не учитывает считываемые данные от кэша к диску IOPS и пропускной. Таким образом, применимое ваше может достичь более высокой общей IOPS и пропускной платы. 
- *Ни одна* конфигурация кэша не должна использоваться для дисков, хранящих файл журнала S'L Server Log, поскольку файл журнала записывается последовательно и не выигрывает от кэширования *ReadOnly.* 
- Кэширование *ReadWrite* не должно использоваться для размещения файлов сервера S'L, так как сервер S'L не поддерживает согласованность данных с кэшем *ReadWrite.* Записывает емкость отходов Кэша И запотывательных куата *ReadOnly,* а запоздалые немного увеличиваются, если записывается через слои кэша *ReadOnly* blob. 


   > [!TIP]
   > Убедитесь, что конфигурация хранилища соответствует ограничениям, налагаемым выбранным размером VM. Выбор параметров хранения, превышаюющих предельную производительность размера `The desired performance might not be reached due to the maximum virtual machine disk performance cap.`VM, приведет к ошибке: . Либо уменьшить IOPs, изменив тип диска, или увеличить ограничение производительности, увеличив размер VM. 


После создания виртуальной машины в зависимости от вашего выбора Azure выполняет следующие задачи по настройке хранилища:

* создает и присоединяет к виртуальной машине твердотельные накопители класса Premium;
* настраивает доступность дисков данных для SQL Server;
* настраивает диски данных в пуле носителей в зависимости от указанных требований к размеру и производительности (операции ввода-вывода в секунду и пропускная способность);
* связывает пул носителей с новым диском на виртуальной машине;
* оптимизирует этот диск в зависимости от указанного типа рабочей нагрузки ("Хранилище данных", "Обработка транзакций" или "Общая").

Дополнительные сведения о настройке параметров хранилища в Azure см. в разделе [Конфигурация хранилища](#storage-configuration). Полное представление о том, как создать VM сервера S'L, можно на портале Azure, [см.](virtual-machines-windows-portal-sql-server-provision.md)

### <a name="resource-manage-templates"></a>Шаблоны Resource Manager

При использовании следующих шаблонов Resource Manager по умолчанию к виртуальной машине присоединяются два диска данных класса Premium. В этом случае пул носителей не настраивается. Однако эти шаблоны можно настроить, чтобы изменить количество дисков данных класса Premium, присоединенных к виртуальной машине.

* [Создание виртуальной машины с поддержкой автоматической архивации](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autobackup)
* [Создание виртуальной машины с автоматической установкой исправлений](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autopatching)
* [Создание виртуальной машины с интеграцией AKV](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-keyvault)

### <a name="quickstart-template"></a>Шаблон быстрого запуска

Вы можете использовать следующий шаблон быстрого запуска для развертывания VM сервера S'L с помощью оптимизации хранилища. 

* [Создание VM с оптимизацией хранилища](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-new-storage/)
* [Создание VM с помощью ultraSSD](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-new-storage-ultrassd)

## <a name="existing-vms"></a>Существующие виртуальные машины

[!INCLUDE [windows-virtual-machines-sql-use-new-management-blade](../../../../includes/windows-virtual-machines-sql-new-resource.md)]

Для имеющихся виртуальных машин SQL Server на портале Azure можно изменить некоторые параметры хранилища. Откройте [ресурс виртуальных машин s'L](virtual-machines-windows-sql-manage-portal.md#access-the-sql-virtual-machines-resource)и выберите **Обзор.** Страница Обзор сервера S'L показывает текущее использование хранилища вашего VM. На этой диаграмме отображаются все диски, подключенные к виртуальной машине. Дисковое пространство для каждого диска разбито на 4 раздела:

* SQL-данные
* журнал SQL;
* прочее (не хранилище SQL);
* Доступно

Чтобы изменить настройки хранилища, выберите **настройку** под **настройками.** 

![Настройка хранилища для имеющейся виртуальной машины SQL Server](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-existing.png)

Настройки диска можно модифицировать для дисков, настроенных в процессе создания VM сервера S'L. Выбор **диска Extend** открывает страницу модификации диска, что позволяет изменить тип диска, а также добавить дополнительные диски. 

![Настройка хранилища для имеющейся виртуальной машины SQL Server](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-extend-drive.png)


## <a name="storage-configuration"></a>Конфигурация хранилища

В этом разделе содержится ссылка на изменения конфигурации хранилища, которые Azure автоматически выполняет во время подготовки или конфигурации ВМ на портале Azure.

* Azure настраивает пул хранения из хранилища, выбранного из вашего VM. В следующем разделе этой темы представлены подробные сведения о конфигурации пула хранения данных.
* При автоматической настройке хранилища всегда используются диски данных P30 [на базе твердотельных накопителей класса Premium](../disks-types.md). Следовательно, между выбранным числом терабайт и количеством дисков, прикрепленных к виртуальной машине, существует полноценное сопоставление.

Сведения о ценах см. на странице [Цены на хранилища Azure](https://azure.microsoft.com/pricing/details/storage) на вкладке **Хранилище дисков**.

### <a name="creation-of-the-storage-pool"></a>Создание пула носителей

Для создания пула носителей на виртуальных машинах SQL Server Azure использует следующие параметры.

| Параметр | Значение |
| --- | --- |
| Размер полосы |256 КБ (хранение данных), 64 КБ (обработка транзакций) |
| Размеры диска |1 ТБ каждый |
| Кэш |Чтение |
| Размер выделения |Размер единицы выделения NTFS — 64 КБ |
| Восстановление | Простая модель восстановления (без устойчивости) |
| Number of columns |Количество дисков данных до 8<sup>1</sup> |


<sup>1</sup> После создания пула носителей вы не сможете изменить в нем количество столбцов.


## <a name="workload-optimization-settings"></a>Параметры оптимизации рабочей нагрузки

В следующей таблице описаны три доступных типа рабочей нагрузки и соответствующие оптимизации для каждого из них.

| Тип рабочей нагрузки | Описание | Оптимизация |
| --- | --- | --- |
| **Общие сведения** |Значение по умолчанию, поддерживающее большинство рабочих нагрузок |None |
| **Обработка транзакций** |Оптимизирует хранилище для рабочих нагрузок OLTP в традиционных базах данных |Флаг трассировки 1117<br/>Флаг трассировки 1118 |
| **Хранение данных** |Оптимизирует хранилище для рабочих нагрузок аналитики и отчетов |Флаг трассировки 610<br/>Флаг трассировки 1117 |

> [!NOTE]
> Тип рабочей нагрузки можно указать только во время подготовки виртуальной машины SQL на этапе настройки хранилища.

## <a name="next-steps"></a>Следующие шаги

Другие темы, связанные с запуском SQL Server на виртуальных машинах Azure, рассматриваются в статье [SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).
