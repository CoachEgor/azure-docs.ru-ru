---
title: Мониторинг запланированных мероприятий для вневых компьютеров Windows в Azure
description: Узнайте, как следить за виртуальными машинами Azure для запланированных событий.
services: virtual-machines-windows
documentationcenter: ''
author: mysarn
manager: gwallace
ms.service: virtual-machines-windows
ms.tgt_pltfrm: vm-windows
ms.date: 08/20/2019
ms.author: sarn
ms.topic: conceptual
ms.openlocfilehash: 1cda07c18e4f5ef2a8c00b6a275f22ecc0935751
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74073316"
---
# <a name="monitoring-scheduled-events"></a>Мониторинг запланированных мероприятий

Обновления применяются в различных частях Azure каждый день, чтобы обеспечить безопасность и обновление служб. В дополнение к запланированным обновлениям могут также происходить незапланированные события. Например, при обнаружении какой-либо аппаратной деградации или неисправности службам Azure может потребоваться незапланированное техническое обслуживание. Используя живую миграцию, сохраняя обновления памяти и, как правило, сохраняя строгую планку на влияние обновлений, в большинстве случаев эти события почти прозрачны для клиентов, и они не имеют никакого влияния или в лучшем случае вызывают несколько секунд замораживания виртуальной машины. Тем не менее, для некоторых приложений, даже несколько секунд виртуального замораживания машины может привести к воздействию. Знание заранее о предстоящем обслуживании Azure важно, чтобы обеспечить лучший опыт для этих приложений. [Служба scheduled Events](scheduled-events.md) предоставляет вам программный интерфейс, который будет уведомлен о предстоящем обслуживании, и позволяет изящно обрабатывать техническое обслуживание. 

В этой статье мы покажем, как можно использовать запланированные события для уведомления о событиях технического обслуживания, которые могут повлиять на ваши ВМ, и создадим некоторые основные автоматизации, которые могут помочь в мониторинге и анализе.


## <a name="routing-scheduled-events-to-log-analytics"></a>Перехивание запланированных событий в Log Analytics

Запланированные события доступны в рамках [службы метаданных экземпляров Azure,](instance-metadata-service.md)которая доступна на каждой виртуальной машине Azure. Клиенты могут писать автоматизацию для запроса конечной точки своих виртуальных машин, чтобы найти уведомления о регулярном обслуживании и выполнить смягчение последствий, таких как сохранение состояния и снятие виртуальной машины из ротации. Мы рекомендуем автоматизацию зданий для записи запланированных событий, чтобы вы могли иметь журнал аудита событий обслуживания Azure. 

В этой статье мы поймем вам, как захватить расписание событий технического обслуживания для анализа журналов. Затем мы инициизуем некоторые основные действия уведомления, такие как отправка электронной почты вашей команде и получение исторического представления обо всех событиях, которые повлияли на ваши виртуальные машины. Для агрегирования и автоматизации событий мы будем использовать [Log Analytics,](/azure/azure-monitor/learn/quick-create-workspace)но вы можете использовать любое решение мониторинга для сбора этих журналов и автоматизации триггера.

![Диаграмма, показывающая жизненный цикл события](./media/notifications/events.png)

## <a name="prerequisites"></a>Предварительные требования

В этом примере необходимо создать [виртуальную машину Windows в наборе доступности.](tutorial-availability-sets.md) Запланированные события предоставляют уведомления об изменениях, которые могут повлиять на любой из виртуальных машин в наборе доступности, облачном сервисе, виртуальном наборе масштабов машин или автономных виртуальных виртуальных сот. Мы будем запускать [службу,](https://github.com/microsoft/AzureScheduledEventsService) которая проводит опросы для запланированных событий на одном из вс-мазанков, которые будут выступать в качестве коллектора, чтобы получить события для всех других ВМ в наборе доступности.    

Не удаляйте группу ресурсов группы в конце урока.

Вам также необходимо [создать рабочее пространство Log Analytics,](/azure/azure-monitor/learn/quick-create-workspace) которое мы будем использовать для агрегирования информации от вс-чатов в наборе доступности.

## <a name="set-up-the-environment"></a>Настройка среды

Теперь в наборе доступности должно быть 2 исходных ВМ. Теперь нам нужно создать третий VM, называемый myCollectorVM, в том же наборе доступности. 

```azurepowershell-interactive
New-AzVm `
   -ResourceGroupName "myResourceGroupAvailability" `
   -Name "myCollectorVM" `
   -Location "East US" `
   -VirtualNetworkName "myVnet" `
   -SubnetName "mySubnet" `
   -SecurityGroupName "myNetworkSecurityGroup" `
   -OpenPorts 3389 `
   -PublicIpAddressName "myPublicIpAddress3" `
   -AvailabilitySetName "myAvailabilitySet" `
   -Credential $cred
```
 

Скачать файл установки .zip проекта с [GitHub](https://github.com/microsoft/AzureScheduledEventsService/archive/master.zip).

Подключитесь к **myCollectorVM** и скопируйте файл .zip на виртуальную машину и извлеките все файлы. На вашем VM откройте подсказку PowerShell. Переместите запрос в `SchService.ps1`папку, `PS C:\Users\azureuser\AzureScheduledEventsService-master\AzureScheduledEventsService-master\Powershell>`содержащую, например: и настройте службу.

```powershell
.\SchService.ps1 -Setup
```

Запускает службу.

```powershell
.\SchService.ps1 -Start
```

Служба теперь будет начинать опрос каждые 10 секунд для любых запланированных событий и утвердить события для ускорения обслуживания.  Замораживание, перезагрузка, перераспределение и preempt — это события, зафиксированные событиями Расписания.   Обратите внимание, что можно расширить скрипт, чтобы вызвать некоторые смягчения до утверждения события.

Проверка состояния службы и убедитесь, что он работает.

```powershell
.\SchService.ps1 -status  
```

Это должно `Running`вернуться .

Служба теперь будет начинать опрос каждые 10 секунд для любых запланированных событий и утвердить события для ускорения обслуживания.  Замораживание, перезагрузка, перераспределение и preempt являются события, захваченные события расписания. Можно расширить скрипт, чтобы вызвать некоторые меры по смягчению последствий до утверждения события.

When any of the above events are captured by Schedule Event service, it will get logged in the Application Event Log Event Status, Event Type, Resources (Virtual machine names) and NotBefore (minimum notice period). Вы можете найти события с ID 1234 в журнале событий приложения.

После настройки и запуска службы он будет регистрировать события в журналах приложений Windows.   Чтобы проверить это, перезапустите одну из виртуальных машин в наборе доступности, и вы должны увидеть событие, вносивемые в журнал "Событие" в журнале Windows Logs > журнал приложений, показывающий перезапуск VM. 

![Скриншот зрителя события.](./media/notifications/event-viewer.png)

Когда события фиксируются службой События Расписания, они регистрируются в приложении даже в журнале с статусом событий, типом событий, ресурсами (имя VM) и NotBefore (минимальный период уведомления). Вы можете найти события с ID 1234 в журнале событий приложения.

> [!NOTE] 
> В этом примере виртуальные машины находятся в наборе доступности, что позволило нам обозначить одну виртуальную машину в качестве коллектора для прослушивания и маршрутзапланированных событий в наше пространство работ по анализу журналов. Если у вас есть автономные виртуальные машины, вы можете запустить службу на каждой виртуальной машине, а затем подключить их индивидуально к вашему рабочему пространству аналитики журнала.
>
> Для нашей настройки мы выбрали Windows, но вы можете создать аналогичное решение на Linux.

В любой момент вы можете остановить/удалить службу `–stop` `–remove`запланированных событий с помощью коммутаторов и .

## <a name="connect-to-the-workspace"></a>Подключение к рабочему пространству


Теперь мы хотим подключить рабочее пространство аналитики журнала к коллектору VM. Рабочее пространство Log Analytics выступает в качестве репозитория, и мы настроим коллекцию журналов событий для захвата журналов приложений от коллектора VM. 

 Чтобы направить запланированные события в журнал событий, который будет сохранен в качестве журнала приложений нашей службой, необходимо подключить виртуальную машину к рабочему пространству Log Analytics.  
 
1. Откройте страницу для созданного рабочего пространства.
1. Под **подключением к источнику данных** выберите **виртуальные машины Azure (VM).**

    ![Подключение к VM в качестве источника данных](./media/notifications/connect-to-data-source.png)

1. Поиск и выберите **myCollectorVM**. 
1. На новой странице для **myCollectorVM**, выберите **Connect**.

Это позволит установить [агент мониторинга Microsoft](/azure/virtual-machines/extensions/oms-windows) в вашей виртуальной машине. Подключение VM к рабочему пространству и установка расширения займет несколько минут. 

## <a name="configure-the-workspace"></a>Настройка рабочего пространства

1. Откройте страницу для рабочего пространства и выберите **Расширенные настройки.**
1. Выберите **данные** из левого меню, а затем выберите **журналы событий Windows.**
1. В **Collect from the following event logs**начните вводить *приложение,* а затем выберите **Приложение** из списка.

    ![Выберите Расширенные настройки](./media/notifications/advanced.png)

1. Оставьте **ERROR**, **ВНИМАНИЕ**, и **ИНФОРМАЦИЯ** выбран, а затем выбрать **Сохранить,** чтобы сохранить настройки.


> [!NOTE]
> Там будет некоторая задержка, и это может занять до 10 минут, прежде чем журнал доступен. 


## <a name="creating-an-alert-rule-with-azure-monitor"></a>Создание правила оповещения с помощью Azure Monitor 


После того, как события будут перенесены в Log Analytics, можно запустить следующий [запрос](/azure/azure-monitor/log-query/get-started-portal) для поиска событий расписания.

1. В верхней части страницы выберите **журналы** и вставьте следующие в текстовое поле:

    ```
    Event
    | where EventLog == "Application" and Source contains "AzureScheduledEvents" and RenderedDescription contains "Scheduled" and RenderedDescription contains "EventStatus" 
    | project TimeGenerated, RenderedDescription
    | extend ReqJson= parse_json(RenderedDescription)
    | extend EventId = ReqJson["EventId"]
    ,EventStatus = ReqJson["EventStatus"]
    ,EventType = ReqJson["EventType"]
    ,NotBefore = ReqJson["NotBefore"]
    ,ResourceType = ReqJson["ResourceType"]
    ,Resources = ReqJson["Resources"]
    | project-away RenderedDescription,ReqJson
    ```

1. Выберите **Сохранить,** а затем *введите журнал для* имени, оставьте **запрос** в качестве типа, введите *VMLogs* как **категорию,** а затем выберите **Сохранить.** 

    ![Сохранение запроса](./media/notifications/save-query.png)

1. Выберите **Новое правило генерации оповещений**. 
1. На странице **правила «Создание»** оставьте `collectorworkspace` **ресурс.**
1. В соответствии с **условием,** выберите запись * <login undefined>всякий раз, когда поиск журнала клиента *. Откроется страница **логики сигнала Настройка.**
1. Под **значением Порога**введите *0,* а затем выберите **Done.**
1. В **соответствии**с действиями выберите **Создать группу действий.** Откроется страница **группы действий Добавить.**
1. В **названии группы action**, введите *myActionGroup*.
1. **В короткое имя**, введите **myActionGroup**.
1. В **группе ресурсов**выберите **myResourceGroupAvailability**.
1. В соответствии с действиями, в **ACTION NAME** типа **email**, а затем выберите Email **/ SMS / Push / Голос**. Откроется страница **Email/SMS/Push/Voice.**
1. Выберите **электронную почту,** введите свой адрес электронной почты, а затем выберите **OK**.
1. На странице **группы действий Добавить** выберите **OK**. 
1. На странице **правила Create** под **ALERT DETAILS**введите *myAlert* для **названия правила оповещения,** а затем введите *правило оповещения по электронной почте* для **описания.**
1. Когда вы закончите, выберите **Правило оповещения.**
1. Перезапустите один из ВМ в наборе доступности. В течение нескольких минут вы должны получить электронное письмо о том, что оповещение было срабатывано.

Чтобы управлять правилами оповещения, перейдите в группу ресурсов, выберите **оповещения** из левого меню, а затем выберите **правила управления оповещениями** в верхней части страницы.

     
## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать больше, смотрите страницу [службы запланированных событий](https://github.com/microsoft/AzureScheduledEventsService) на GitHub.
