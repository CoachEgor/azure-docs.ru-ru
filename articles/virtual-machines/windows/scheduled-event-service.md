---
title: Мониторинг запланированных событий для виртуальных машин Windows в Azure | Документация Майкрософт
description: Узнайте, как отслеживать запланированные события на виртуальных машинах Azure.
services: virtual-machines-windows
documentationcenter: ''
author: mysarn
manager: gwallace
ms.service: virtual-machines-windows
ms.tgt_pltfrm: vm-windows
ms.date: 08/20/2019
ms.author: sarn
ms.topic: conceptual
ms.openlocfilehash: d090fb52beb266f006e69688c09f66412f1fe8c2
ms.sourcegitcommit: 0576bcb894031eb9e7ddb919e241e2e3c42f291d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2019
ms.locfileid: "72376197"
---
# <a name="monitoring-scheduled-events"></a>Мониторинг Запланированные события

Обновления применяются к разным частям Azure каждый день, чтобы обеспечить безопасность и актуальность работающих служб. Помимо запланированных обновлений могут также возникать незапланированные события. Например, при обнаружении аппаратного снижения или сбоя службам Azure может потребоваться выполнить незапланированное обслуживание. В большинстве случаев эти события почти прозрачны для клиентов с помощью динамической миграции и, как правило, хранятся в определенном порядке, что приводит к тому, что они практически незаметны для пользователей, и они не влияют на несколько секунд и не могут заморозить виртуальную машину. Однако для некоторых приложений даже несколько секунд замораживания виртуальной машины может привести к появлению эффекта. Чтобы обеспечить оптимальную работу для этих приложений, важно заранее знать о предстоящем обслуживании Azure. [Служба запланированные события](scheduled-events.md) предоставляет программный интерфейс для уведомления о предстоящем обслуживании и позволяет корректно обрабатывать обслуживание. 

В этой статье мы покажем, как можно использовать запланированные события, чтобы получать уведомления о событиях обслуживания, которые могут повлиять на виртуальные машины, и создать простую автоматизацию, которая может помочь при мониторинге и анализе.


## <a name="routing-scheduled-events-to-log-analytics"></a>Маршрутизация запланированных событий в Log Analytics

Запланированные события доступен в составе [службы метаданных экземпляров Azure](instance-metadata-service.md), которая доступна на каждой виртуальной машине Azure. Клиенты могут написать автоматизацию для запроса конечных точек виртуальных машин, чтобы найти запланированные уведомления об обслуживании и выполнить меры по их устранению, например сохранить состояние и извлечь виртуальную машину из режима вращения. Рекомендуется создавать службы автоматизации для записи Запланированные события, чтобы можно было вести журнал аудита событий обслуживания Azure. 

В этой статье мы рассмотрим, как записать Запланированные события обслуживания в Log Analytics. Затем мы активируем некоторые основные действия по уведомлению, такие как отправка сообщения электронной почты команде и получение исторического представления обо всех событиях, которые затронули ваши виртуальные машины. Для агрегирования событий и автоматизации мы будем использовать [log Analytics](/azure/azure-monitor/learn/quick-create-workspace), но вы можете использовать любое решение мониторинга для сбора этих журналов и запуска автоматизации.

![Схема, показывающая жизненный цикл событий](./media/notifications/events.png)

## <a name="prerequisites"></a>Технические условия

В этом примере необходимо создать [виртуальную машину Windows в группе доступности](tutorial-availability-sets.md). Запланированные события предоставлять уведомления об изменениях, которые могут повлиять на любые виртуальные машины в группе доступности, облачной службе, масштабируемом наборе виртуальных машин или отдельных виртуальных машинах. Мы будем использовать [службу](https://github.com/microsoft/AzureScheduledEventsService) , которая опрашивает запланированные события на одной из виртуальных машин, которые будут действовать в качестве сборщика, чтобы получать события для всех остальных виртуальных машин в группе доступности.    

Не удаляйте группу ресурсов группы в конце этого руководства.

Вам также потребуется [создать рабочую область log Analytics](/azure/azure-monitor/learn/quick-create-workspace) , которая будет использоваться для агрегирования информации из виртуальных машин в группе доступности.

## <a name="set-up-the-environment"></a>Настройка среды

Теперь в группе доступности должно быть 2 начальных виртуальных машин. Теперь необходимо создать третью виртуальную машину с именем Миколлекторвм в той же группе доступности. 

```azurepowershell-interactive
New-AzVm `
   -ResourceGroupName "myResourceGroupAvailability" `
   -Name "myCollectorVM" `
   -Location "East US" `
   -VirtualNetworkName "myVnet" `
   -SubnetName "mySubnet" `
   -SecurityGroupName "myNetworkSecurityGroup" `
   -OpenPorts 3389 `
   -PublicIpAddressName "myPublicIpAddress3" `
   -AvailabilitySetName "myAvailabilitySet" `
   -Credential $cred
```
 

Скачайте ZIP-файл установки проекта из [GitHub](https://github.com/microsoft/AzureScheduledEventsService/archive/master.zip).

Подключитесь к **миколлекторвм** и скопируйте ZIP-файл на виртуальную машину и извлеките все файлы. На виртуальной машине откройте командную строку PowerShell. Переместите запрос в папку, содержащую `SchService.ps1`, например: `PS C:\Users\azureuser\AzureScheduledEventsService-master\AzureScheduledEventsService-master\Powershell>`, и настройте службу.

```powershell
.\SchService.ps1 -Setup
```

Запустите службу.

```powershell
.\SchService.ps1 -Start
```

Теперь служба будет выполнять опрос каждые 10 секунд для всех запланированных событий и утверждать события для ускорения обслуживания.  Закрепление, перезагрузка, повторное развертывание и приоритетное прерывание — это события, зафиксированные в расписании событий.   Обратите внимание, что можно расширить скрипт, чтобы активировать некоторые способы устранения рисков до утверждения события.

Проверьте состояние службы и убедитесь, что она запущена.

```powershell
.\SchService.ps1 -status  
```

Он должен возвращать `Running`.

Теперь служба будет выполнять опрос каждые 10 секунд для всех запланированных событий и утверждать события для ускорения обслуживания.  Закрепление, перезагрузка, повторное развертывание и приоритетное прерывание — это события, зафиксированные в расписании событий. Можно расширить скрипт, чтобы активировать некоторые способы устранения рисков до утверждения события.

Если любое из указанных выше событий захватывается службой событий Schedule, оно будет зарегистрировано в журнале событий приложений состояние событий, тип события, ресурсы (имена виртуальных машин) и NotBefore (минимальный период уведомления). События с ИДЕНТИФИКАТОРом 1234 можно узнать в журнале событий приложений.

После настройки и запуска службы она регистрирует события в журналах приложений Windows.   Чтобы убедиться, что это работает, перезапустите одну из виртуальных машин в группе доступности, и вы увидите событие, регистрируемое в журнале событий Windows, > журнал приложений, в котором отображается перезапущенная виртуальная машина. 

![Снимок экрана средства просмотра событий.](./media/notifications/event-viewer.png)

Когда служба событий записывает события в расписание, она регистрируется в приложении даже в журнале с состоянием события, типом события, ресурсами (имя виртуальной машины) и NotBefore (минимальный период уведомления). События с ИДЕНТИФИКАТОРом 1234 можно узнать в журнале событий приложений.

> [!NOTE] 
> В этом примере виртуальные машины находятся в группе доступности, что позволило назначить одну виртуальную машину в качестве сборщика для прослушивания и маршрутизации запланированных событий в пространство Works log Analytics. При наличии автономных виртуальных машин можно запустить службу на каждой виртуальной машине, а затем подключить их по отдельности к рабочей области log Analytics.
>
> Для нашей настройки мы выбрали Windows, но вы можете разработать аналогичное решение в Linux.

В любой момент можно отключить или удалить запланированную службу событий с помощью параметров `–stop` и `–remove`.

## <a name="connect-to-the-workspace"></a>Подключение к рабочей области


Теперь необходимо подключить рабочую область Log Analytics к виртуальной машине сборщика. Рабочая область Log Analytics выступает в качестве репозитория, и мы настроим сбор журналов событий для сбора журналов приложений с виртуальной машины сборщика. 

 Чтобы направить Запланированные события в журнал событий, который будет сохранен в качестве журнала приложений нашей службой, необходимо подключить виртуальную машину к рабочей области Log Analytics.  
 
1. Откройте страницу созданной рабочей области.
1. В разделе **Подключение к источнику данных** выберите **виртуальные машины Azure**.

    ![Подключение к виртуальной машине в качестве источника данных](./media/notifications/connect-to-data-source.png)

1. Найдите и выберите **миколлекторвм**. 
1. На новой странице для **миколлекторвм**выберите **подключить**.

На виртуальной машине будет установлен [Microsoft Monitoring Agent](/azure/virtual-machines/extensions/oms-windows) . Подключение виртуальной машины к рабочей области и установка расширения займет несколько минут. 

## <a name="configure-the-workspace"></a>Настройка рабочей области

1. Откройте страницу рабочей области и выберите **Дополнительные параметры**.
1. Выберите **данные** в меню слева, а затем выберите **журналы событий Windows**.
1. В поле **собираются из следующих журналов событий**Начните вводить *приложение* , а затем выберите **приложение** из списка.

    ![Выбор дополнительных параметров](./media/notifications/advanced.png)

1. Оставьте выбранным значение **Ошибка**, **предупреждение**и **сведения** , а затем нажмите кнопку **сохранить** , чтобы сохранить параметры.


> [!NOTE]
> Это приведет к некоторой задержке, и до появления журнала может пройти до 10 минут. 


## <a name="creating-an-alert-rule-with-azure-monitor"></a>Создание правила генерации оповещений с Azure Monitor 


После отправки событий в Log Analytics можно выполнить следующий [запрос](/azure/azure-monitor/log-query/get-started-portal) , чтобы найти события расписания.

1. В верхней части страницы выберите **журналы** и вставьте в текстовое поле следующий текст:

    ```
    Event
    | where EventLog == "Application" and Source contains "AzureScheduledEvents" and RenderedDescription contains "Scheduled" and RenderedDescription contains "EventStatus" 
    | project TimeGenerated, RenderedDescription
    | extend ReqJson= parse_json(RenderedDescription)
    | extend EventId = ReqJson["EventId"]
    ,EventStatus = ReqJson["EventStatus"]
    ,EventType = ReqJson["EventType"]
    ,NotBefore = ReqJson["NotBefore"]
    ,ResourceType = ReqJson["ResourceType"]
    ,Resources = ReqJson["Resources"]
    | project-away RenderedDescription,ReqJson
    ```

1. Выберите **сохранить**, а затем введите *logQuery* в поле имя, оставьте **запрос** как тип, введите *Вмлогс* в качестве **категории**и нажмите кнопку **сохранить**. 

    ![Сохранение запроса](./media/notifications/save-query.png)

1. Выберите **новое правило генерации оповещений**. 
1. На странице **Создание правила** оставьте `collectorworkspace` в качестве **ресурса**.
1. В разделе **условие**выберите запись *при каждом поиске по журналу клиента <login undefined>* . Откроется страница **Настройка логики сигнала** .
1. В разделе **пороговое значение**введите *0* и нажмите кнопку **Готово**.
1. В разделе **действия**выберите **создать группу действий**. Откроется страница **Добавление группы действий** .
1. В списке **имя группы действий**введите *мяктионграуп*.
1. В качестве **краткого имени**введите **мяктионграуп**.
1. В **группе ресурсов**выберите **myResourceGroupAvailability**.
1. В разделе действия в поле **имя действия** введите **адрес электронной почты**, а затем выберите **Электронная почта, SMS, Push/Voice**. Откроется страница **Электронная почта, SMS, Push/Voice** .
1. Выберите **Электронная почта**, введите адрес электронной почты, а затем нажмите кнопку **ОК**.
1. На странице **Добавление группы действий** нажмите кнопку **ОК**. 
1. На странице **Создание правила** в разделе **сведения о предупреждении**введите *Мялерт* в поле **имя правила оповещения**, а затем введите *правило оповещения по электронной почте* для **описания**.
1. По завершении нажмите кнопку **создать правило генерации оповещений**.
1. Перезапустите одну из виртуальных машин в группе доступности. В течение нескольких минут следует получить сообщение электронной почты о том, что оповещение активировано.

Чтобы управлять правилами генерации оповещений, перейдите к группе ресурсов, в меню слева выберите **оповещения** , а затем в верхней части страницы выберите **Управление правилами оповещений** .

     
## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. на странице [службы запланированных событий](https://github.com/microsoft/AzureScheduledEventsService) на сайте GitHub.
