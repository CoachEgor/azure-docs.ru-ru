---
title: Пользовательские данные и виртуальные машины Azure
description: Сведения об использовании пользовательских данных и Cloud-init на виртуальных машинах Azure
services: virtual-machines
author: mimckitt
ms.service: virtual-machines
ms.topic: article
ms.date: 03/06/2020
ms.author: mimckitt
ms.openlocfilehash: 9497e665d024b583c261ade3e6fb5393a9322ce0
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81759137"
---
# <a name="custom-data-and-cloud-init-on-azure-virtual-machines"></a>Пользовательские данные и Cloud-init на виртуальных машинах Azure

## <a name="what-is-custom-data"></a>Что такое пользовательские данные?

Клиенты часто запрашивают, как они могут внедрить скрипт или другие метаданные в Microsoft Azure виртуальную машину во время предоставления.  В других облаках эта концепция часто называется данными пользователя.  В Microsoft Azure у нас есть подобная функция, называемая пользовательскими данными. 

Пользовательские данные становятся доступными для виртуальной машины во время первой загрузки или начальной настройки, поэтому мы вызываем эту подготовку. Подготовка — это процесс, в ходе которого ВИРТУАЛЬная машина создает параметры (например, имя узла, имя пользователя, пароль, сертификаты, пользовательские данные, ключи и т. д.), которые будут доступны виртуальной машине, а агент подготовки обрабатывает их, такие как [Агент Linux](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux) и [Cloud-init](https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init#troubleshooting-cloud-init). 


## <a name="passing-custom-data-to-the-vm"></a>Передача пользовательских данных в виртуальную машину
Чтобы использовать пользовательские данные, перед передачей данных в API необходимо сначала закодировать содержимое, если вы не используете средство CLI, которое выполняет преобразование, например AZ CLI. Размер не может превышать 64 КБ.

В интерфейсе командной строки можно передать пользовательские данные в виде файла, и они будут преобразованы в Base64.
```bash
az vm create \
  --resource-group myResourceGroup \
  --name centos74 \
  --image OpenLogic:CentOS-CI:7-CI:latest \
  --custom-data cloud-init.txt \
  --generate-ssh-keys
```

В Azure Resource Manager (ARM) имеется [функция Base64](https://docs.microsoft.com/azure/azure-resource-manager/templates/template-functions-string#base64).

```json
"name": "[parameters('virtualMachineName')]",
"type": "Microsoft.Compute/virtualMachines",
"apiVersion": "2019-07-01",
"location": "[parameters('location')]",
"dependsOn": [
..],
"variables": {
        "customDataBase64": "[base64(parameters('stringData'))]"
    },
"properties": {
..
    "osProfile": {
        "computerName": "[parameters('virtualMachineName')]",
        "adminUsername": "[parameters('adminUsername')]",
        "adminPassword": "[parameters('adminPassword')]",
        "customData": "[variables('customDataBase64')]"
        },
```

## <a name="processing-custom-data"></a>Обработка пользовательских данных
Агенты подготовки, установленные на виртуальных машинах, осуществляют взаимодействие с платформой и помещают ее в файловую систему. 

### <a name="windows"></a>Windows
Пользовательские данные помещаются в *%системдриве%\азуредата\кустомдата.бин* в виде двоичного файла, но не обрабатываются. Если вы хотите обработать этот файл, вам потребуется создать пользовательский образ и написать код для обработки CustomData. bin.

### <a name="linux"></a>Linux  
В ОС Linux пользовательские данные передаются в виртуальную машину через файл овф-ЕНВ. XML, который копируется в каталог */var/lib/waagent* во время подготовки.  Новые версии агента Microsoft Azure Linux также будут копировать данные в кодировке Base64 в */Вар/либ/ваажент/кустомдата* , а также для удобства.

Сейчас Azure поддерживает два агента подготовки:
* Агент Linux — по умолчанию агент не будет обрабатывать пользовательские данные, необходимо будет создать пользовательский образ с включенным. Соответствующие параметры в соответствии с [документацией](https://github.com/Azure/WALinuxAgent#configuration) :
    * Provisioning.DecodeCustomData
    * Provisioning.ExecuteCustomData

Когда вы включаете пользовательские данные и выполняете сценарий, он задерживает подготовленные отчеты о готовности виртуальной машины или эта подготовка была выполнена успешно, пока сценарий не будет завершен. Если скрипт превышает общую квоту на время подготовки виртуальной машины в 40 мин, то создание виртуальной машины завершится ошибкой. Обратите внимание, что если сценарий не удается выполнить или во время выполнения произошли ошибки, это не повлечет неустранимый сбой подготовки, необходимо создать путь уведомления для оповещения о состоянии завершения скрипта.

Для устранения неполадок с пользовательским выполнением данных ознакомьтесь с */Вар/лог/ваажент.лог*

* Cloud-init-по умолчанию будет обрабатывать пользовательские данные по умолчанию. Cloud-init принимает [несколько форматов](https://cloudinit.readthedocs.io/en/latest/topics/format.html) пользовательских данных, таких как конфигурация Cloud-init, сценарии и т. д. Аналогично агенту Linux, когда Cloud-init обрабатывает пользовательские данные. Если во время выполнения процесса настройки или сценариев возникли ошибки, это не повлечет неустранимый сбой подготовки, и необходимо будет создать путь уведомления для оповещения о состоянии завершения скрипта. Однако в отличие от агента Linux, Cloud-init не ждет завершения настраиваемых пользовательских конфигураций данных, прежде чем сообщить платформе о готовности виртуальной машины. Дополнительные сведения о Cloud-init в Azure см. в [документации](https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init).


Чтобы устранить неполадки с пользовательским выполнением данных, ознакомьтесь с [документацией](https://docs.microsoft.com/azure/virtual-machines/linux/using-cloud-init#troubleshooting-cloud-init)по устранению неполадок.


## <a name="faq"></a>часто задаваемые вопросы
### <a name="can-i-update-custom-data-after-the-vm-has-been-created"></a>Можно ли обновить пользовательские данные после создания виртуальной машины?
Для отдельных виртуальных машин пользовательские данные в модели виртуальной машины не могут быть обновлены, но для VMSS можно обновить пользовательские данные VMSS с помощью REST API (неприменимо для клиентов PS или AZ CLI). При обновлении пользовательских данных в модели VMSS:
* Существующие экземпляры в VMSS не получат обновленные пользовательские данные только до тех пор, пока они не будут добавлены в образ.
* Существующие экземпляры в обновляемых VMSS не будут получать обновленные пользовательские данные.
* Новые экземпляры получат новые пользовательские данные.

### <a name="can-i-place-sensitive-values-in-custom-data"></a>Можно ли поместить конфиденциальные значения в пользовательские данные?
Мы советуем **не** хранить конфиденциальные данные в пользовательских данных. Дополнительные сведения см. в статье рекомендации по [обеспечению безопасности и шифрованию Azure](https://docs.microsoft.com/azure/security/fundamentals/data-encryption-best-practices).


### <a name="is-custom-data-made-available-in-imds"></a>Доступны ли пользовательские данные в IMDS?
Нет, эта функция в настоящее время недоступна.
