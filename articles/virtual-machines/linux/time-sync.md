---
title: Синхронизация времени для виртуальных машин Linux в Azure | Документы Майкрософт
description: Синхронизация времени для виртуальных машин Linux.
services: virtual-machines-linux
documentationcenter: ''
author: cynthn
manager: gwallace
editor: tysonn
tags: azure-resource-manager
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 09/17/2018
ms.author: cynthn
ms.openlocfilehash: 3271804a80ededae650c3b6ad34fdb7f9f1e5b18
ms.sourcegitcommit: c105ccb7cfae6ee87f50f099a1c035623a2e239b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67708619"
---
# <a name="time-sync-for-linux-vms-in-azure"></a>Синхронизация времени для виртуальных машин Linux в Azure

Синхронизация времени важна для безопасности и корреляции событий. Иногда она применяется для реализации распределенных транзакций. Точность времени в нескольких компьютерных системах достигается за счет синхронизации. На синхронизацию может влиять ряд факторов, включая перезагрузки и сетевой трафик между источником времени и получающим сведения о времени компьютером. 

Платформа Azure основана на инфраструктуре, работающей под управлением Windows Server 2016. В Windows Server 2016 реализованы улучшенные алгоритмы коррекции времени и синхронизации локальных часов с временем в формате UTC.  Функция "Точное время" в Windows Server 2016 значительно улучшила работу службы VMICTimeSync, которая регулирует точность времени в виртуальных машинах и на сервере. К числу улучшений относится более точное исходное время при запуске или восстановлении виртуальной машины, а также коррекция задержки при прерывании. 

>[!NOTE]
>Краткий обзор службы времени в Windows можно получить в [этом видео](https://aka.ms/WS2016TimeVideo).
>
> Дополнительные сведения см. в статье [Точное время в Windows Server 2016](https://docs.microsoft.com/windows-server/networking/windows-time-service/accurate-time). 

## <a name="overview"></a>Обзор

Точность часов компьютера оценивается по тому, насколько близки их показания к стандартному времени в формате UTC. Время UTC устанавливается по точным атомным часам, отклонение которых не превышает одной секунды за 300 лет. Однако для считывания времени UTC напрямую требуется специальное оборудование. Вместо этого со временем UTC синхронизируются серверы времени, к которым затем обращаются другие компьютеры. Таким образом достигается масштабируемость и надежность. На каждом компьютере выполняется служба синхронизации времени, которая знает, какие серверы времени следует использовать, и регулярно проверяет необходимость коррекции часов компьютера, при необходимости корректируя время. 

Узлы Azure синхронизированы с внутренними серверами времени Майкрософт, которые получают время от принадлежащих Майкрософт устройств Stratum 1 с антеннами GPS. Виртуальные машины Azure могут получать точное время от узла (*время узла*) непосредственно с сервера времени или использовать эти способы в сочетании. 

На автономном оборудовании операционная система Linux считывает показания аппаратных часов узла только при загрузке. После этого время отсчитывается с помощью таймера прерываний в ядре Linux. В такой конфигурации в показаниях часов со временем будут возникать отклонения. В более новых дистрибутивах Linux в Azure виртуальные машины могут использовать поставщик VMICTimeSync, входящий в состав служб интеграции Linux (LIS), чтобы чаще запрашивать актуальное время от узла.

Взаимодействие виртуальной машины с узлом также может влиять на показания часов. Во время [обслуживания с сохранением памяти](maintenance-and-updates.md#maintenance-that-doesnt-require-a-reboot) виртуальные машины приостанавливаются на срок до 30 секунд. Например, до начала обслуживания часы виртуальной машины показывают 10:00:00, и приостановка длится 28 секунд. Когда виртуальная машина возобновляет работу, ее часы по-прежнему показывают 10:00:00, то есть отстают на 28 секунд. Чтобы скорректировать это отклонение, служба VMICTimeSync отслеживает происходящее в узле и запрашивает внесение изменений в виртуальные машины.

При отсутствии синхронизации времени на часах виртуальной машины накапливались бы ошибки. При наличии только одной виртуальной машины последствия могут быть незначительными, если только рабочая нагрузка не требует очень точного отсчета времени. Но в большинстве случаев имеется несколько взаимосвязанных виртуальных машин, которые используют время для отслеживания транзакций, поэтому оно должно быть согласовано в масштабе всего развертывания. Если время в виртуальных машинах различается, могут иметь место указанные ниже последствия.

- Проверка подлинности будет завершаться сбоем. Протоколы безопасности, такие как Kerberos, или технологии, зависящие от сертификатов, требуют согласования времени в системах.
- Очень трудно понять, что случилось в системе, если журналы (или другие данные) рассогласованы по времени. Одно и то же событие будет представляться как произошедшее в разное время, что усложняет корреляцию.
- Если часы идут неверно, могут происходить ошибки при выставлении счетов.



## <a name="configuration-options"></a>Варианты настройки

В целом есть три способа настроить синхронизацию времени для виртуальных машин Linux, размещенных в Azure:

- конфигурация по умолчанию для образов из Azure Marketplace, в которой используется как время NTP, так и время узла VMICTimeSync; 
- получение времени только от узла с помощью VMICTimeSync;
- использование другого внешнего сервера времени с применением или без применения времени узла VMICTimeSync.


### <a name="use-the-default"></a>Конфигурация по умолчанию

По умолчанию большинство образов Linux из Azure Marketplace настроено для синхронизации из двух источников: 

- Основным источником является NTP; время получается с NTP-сервера. Например, образы Ubuntu 16.04 LTS из Marketplace используют сервер **ntp.ubuntu.com**.
- Дополнительным источником является служба VMICTimeSync, которая служит для передачи времени узла виртуальным машинам и корректировки после приостановки виртуальных машин для обслуживания. Для поддержания точного времени узлы Azure используют принадлежащие Майкрософт устройства Stratum 1.

В более новых дистрибутивах Linux служба VMICTimeSync использует протокол PTP, однако в более ранних дистрибутивах он может не поддерживаться, и для получения времени от узла применяется NTP.

Чтобы проверить правильность синхронизации NTP, выполните команду `ntpq -p`.

### <a name="host-only"></a>Только от узла 

Так как NTP-серверы, такие как time.windows.com и ntp.ubuntu.com, являются общедоступными, синхронизация времени с ними требует передачи трафика через Интернет. Задержки пакетов могут отрицательно сказываться на качестве синхронизации времени. Отказ от NTP и переход на синхронизацию только с узлом порой может улучшить результаты.

Переход на синхронизацию времени только с узлом имеет смысл, если возникают проблемы при использовании конфигурации синхронизации по умолчанию. Попробуйте использовать синхронизацию только с узлом и посмотрите, улучшится ли синхронизация времени в виртуальной машине. 

### <a name="external-time-server"></a>Внешний сервер времени

Если предъявляются особые требования к синхронизации времени, можно также воспользоваться внешними серверами времени. Внешние серверы времени могут предоставлять определенное время, что может быть полезно для тестирования, обеспечения одинаковости времени в машинах, размещенных в центрах обработки данных, не принадлежащих Майкрософт, или обработки корректировочных секунд особым образом.

Внешний сервер времени можно использовать в сочетании со службой VMICTimeSync, что позволяет получить результаты, сходные с конфигурацией по умолчанию. Сочетание внешнего сервера времени и службы VMICTimeSync — оптимальный способ решения проблем, которые могут возникать при приостановке виртуальных машин для обслуживания. 

## <a name="tools-and-resources"></a>Средства и ресурсы

Есть ряд основных команд, позволяющих проверить конфигурацию синхронизации времени. Подробные сведения об оптимальных способах настройки синхронизации времени для определенного дистрибутива Linux можно найти в документации к нему.

### <a name="integration-services"></a>Службы интеграции

Проверьте, загружена ли служба интеграции (hv_utils).

```bash
lsmod | grep hv_utils
```
Должно отображаться примерно следующее:

```
hv_utils               24418  0
hv_vmbus              397185  7 hv_balloon,hyperv_keyboard,hv_netvsc,hid_hyperv,hv_utils,hyperv_fb,hv_storvsc
```

Проверьте, запущена ли управляющая программа служб интеграции Hyper-V.

```bash
ps -ef | grep hv
```

Должно отображаться примерно следующее:

```
root        229      2  0 17:52 ?        00:00:00 [hv_vmbus_con]
root        391      2  0 17:52 ?        00:00:00 [hv_balloon]
```


### <a name="check-for-ptp"></a>Проверка PTP

В более новых версиях Linux в рамках поставщика VMICTimeSync доступен источник времени PTP. В более ранних версиях Red Hat Enterprise Linux или CentOS 7.x можно скачать [службы интеграции Linux](https://github.com/LIS/lis-next) и использовать их для установки обновленного драйвера. При использовании PTP устройство Linux имеет формат /dev/ptp*x*. 

Проверьте доступные источники времени PTP.

```bash
ls /sys/class/ptp
```

В этом примере возвращается значение *ptp0*. Мы используем его для проверки имени часов. Чтобы проверить устройство, определите имя часов.

```bash
cat /sys/class/ptp/ptp0/clock_name
```

Должно быть возвращено значение **hyperv**.

### <a name="chrony"></a>chrony

В Red Hat Enterprise Linux и CentOS 7.x средство [chrony](https://chrony.tuxfamily.org/) настроено для использования источника времени PTP. Управляющая программа NTP (ntpd) не поддерживает источники PTP, поэтому рекомендуется использовать **chronyd**. Чтобы включить PTP, обновите файл **chrony.conf**.

```bash
refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0
```

Дополнительные сведения о Red Hat и NTP см. в статье [Настройка NTP](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/s1-configure_ntp). 

Дополнительные сведения о chrony см. в статье [Использование chrony](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/sect-using_chrony).

Если одновременно включены источники chrony и TimeSync, один из них можно пометить как **предпочтительный**. Другой при этом помечается как резервный. Так как службы NTP корректируют часы через большие периоды времени, служба VMICTimeSync восстанавливает показания часов после приостановки виртуальных машин гораздо быстрее, чем средства на основе NTP, используемые отдельно.


### <a name="systemd"></a>systemd 

В Ubuntu и SUSE синхронизация времени настраивается с помощью [systemd](https://www.freedesktop.org/wiki/Software/systemd/). Дополнительные сведения об Ubuntu см. в статье о [синхронизации времени](https://help.ubuntu.com/lts/serverguide/NTP.html). Дополнительные сведения о SUSE см. в разделе 4.5.8 [заметок о выпуске SUSE Linux Enterprise Server 12 с пакетом обновления 3 (SP3)](https://www.suse.com/releasenotes/x86_64/SUSE-SLES/12-SP3/#InfraPackArch.ArchIndependent.SystemsManagement).



## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения см. в статье [Точное время в Windows Server 2016](https://docs.microsoft.com/windows-server/networking/windows-time-service/accurate-time).


