---
title: Предварительные требования для OpenShift в Azure | Документация Майкрософт
description: Необходимые условия для развертывания OpenShift в Azure.
services: virtual-machines-linux
documentationcenter: virtual-machines
author: haroldwongms
manager: mdotson
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 06/14/2019
ms.author: haroldw
ms.openlocfilehash: ab8814f1620cc019a0bee872c7b8f42cbb427365
ms.sourcegitcommit: 44e85b95baf7dfb9e92fb38f03c2a1bc31765415
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2019
ms.locfileid: "70091743"
---
# <a name="common-prerequisites-for-deploying-openshift-in-azure"></a>Общие предварительные требования для развертывания OpenShift в Azure

В этой статье описаны общие предварительные требования для развертывания OKD или платформы контейнеров OpenShift в Azure.

При установке OpenShift используются модули playbook Ansible. Чтобы выполнить действия по установке, Ansible использует Secure Shell (SSH) для подключения ко всем узлам кластера.

Когда ansible устанавливает SSH-подключение к удаленным узлам, он не может ввести пароль. Поэтому развертывание завершится сбоем, если с закрытым ключом связана парольная фраза.

Так как все виртуальные машины развертываются с помощью шаблонов Azure Resource Manager, для доступа к ним используется один открытый ключ. Соответствующий закрытый ключ должен находиться на виртуальной машине, которая также выполняет все модули PlayBook. Для безопасного выполнения этого действия хранилище ключей Azure используется для передачи закрытого ключа в виртуальную машину.

Если контейнерам требуется постоянное хранилище, вам понадобятся постоянные тома. OpenShift поддерживает виртуальные жесткие диски Azure (VHD) для постоянных томов, но сначала необходимо настроить Azure в качестве поставщика облачных служб.

В этой модели OpenShift выполняет следующие действия:

- Создает объект виртуального жесткого диска в учетной записи хранения Azure или управляемом диске.
- Подключает виртуальный жесткий диск к виртуальной машине и форматирует том.
- Подключает том к модулю.

Чтобы эта конфигурация работала, OpenShift нужны разрешения на выполнение указанных выше задач в Azure. Для этой цели используется субъект-служба. Субъект-служба — это учетная запись безопасности в Azure Active Directory, которой предоставляются разрешения на доступ к ресурсам.

Субъект-служба должна иметь доступ к учетным записям хранения и виртуальным машинам, входящим в состав кластера. При развертывании всех ресурсов кластера OpenShift в одной группе ресурсов субъект-служба может получить разрешения на доступ к этой группе ресурсов.

В этом руководстве описывается создание артефактов, связанных с необходимыми компонентами.

> [!div class="checklist"]
> * Создайте хранилище ключей, чтобы управлять ключами SSH для кластера OpenShift.
> * Создайте субъект-службу, которую будет использовать поставщик облачных служб Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="sign-in-to-azure"></a>Войдите в Azure 
Войдите в подписку Azure с помощью команды [az login](/cli/azure/reference-index) и следуйте инструкциям на экране или щелкните **Попробовать**, чтобы использовать Cloud Shell.

```azurecli 
az login
```
## <a name="create-a-resource-group"></a>Создать группу ресурсов

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group). Группа ресурсов Azure является логическим контейнером, в котором происходит развертывание ресурсов Azure и управление ими. Для размещения хранилища ключей следует использовать выделенную группу ресурсов. Эта группа отделена от группы ресурсов, в которой развертываются ресурсы кластера OpenShift.

В следующем примере создается группа ресурсов с именем *keyvaultrg* в расположении *eastus*:

```azurecli 
az group create --name keyvaultrg --location eastus
```

## <a name="create-a-key-vault"></a>Создайте хранилище ключей.
Создайте хранилище ключей, где будут храниться ключи SSH для кластера, с помощью команды [az keyvault create](/cli/azure/keyvault). Имя хранилища ключей должно быть глобально уникальным и должно быть включено для развертывания шаблона, иначе развертывание завершится ошибкой "Кэйваултпараметерреференцесекретретриевефаилед".

В следующем примере создается хранилище ключей с именем *keyvault* в группе ресурсов *keyvaultrg*:

```azurecli 
az keyvault create --resource-group keyvaultrg --name keyvault \
       --enabled-for-template-deployment true \
       --location eastus
```

## <a name="create-an-ssh-key"></a>Создание ключа SSH 
Ключ SSH необходим для защиты доступа к кластеру OpenShift. Создайте пару ключей SSH с помощью команды `ssh-keygen` (в Linux или macOS):
 
 ```bash
ssh-keygen -f ~/.ssh/openshift_rsa -t rsa -N ''
```

> [!NOTE]
> Паре ключей SSH нельзя присвоить пароль или парольную фразу.

Дополнительные сведения о ключах SSH в Windows см. в статье [Использование ключей SSH с Windows в Azure](/azure/virtual-machines/linux/ssh-from-windows). Закрытый ключ нужно экспортировать в формате OpenSSH.

## <a name="store-the-ssh-private-key-in-azure-key-vault"></a>Сохранение закрытого ключа SSH в Azure Key Vault
Развертывание OpenShift использует созданный ключ SSH, чтобы защитить доступ к основному кластеру OpenShift. Чтобы обеспечить для развертывания безопасное извлечение ключа SSH, сохраните ключ в Key Vault с помощью следующей команды:

```azurecli
az keyvault secret set --vault-name keyvault --name keysecret --file ~/.ssh/openshift_rsa
```

## <a name="create-a-service-principal"></a>Создание субъекта-службы 
OpenShift взаимодействует с Azure, используя имя пользователя и пароль или субъект-службу. Субъект-служба Azure является удостоверением безопасности, которое можно использовать с приложениями, службами и инструментами автоматизации, такими как OpenShift. Вы можете определять разрешения на то, какие операции может выполнять субъект-служба в Azure, и управлять ими. Рекомендуется ограничить разрешения субъекта-службы конкретными группами ресурсов, а не всей подпиской.

Создайте субъект-службу с помощью команды [az ad sp create-for-rbac](/cli/azure/ad/sp) и выведите учетные данные, необходимые для OpenShift:

В следующем примере создается субъект-служба, а группе ресурсов с именем openshiftrg назначаются разрешения участника.

Прежде всего создайте группу ресурсов с именем openshiftrg:

```azurecli
az group create -l eastus -n openshiftrg
```

Создайте субъект-службу:

```azurecli
scope=`az group show --name openshiftrg --query id`
az ad sp create-for-rbac --name openshiftsp \
      --role Contributor --password {Strong Password} \
      --scopes $scope
```
Если вы используете Windows, выполните ```az group show --name openshiftrg --query id``` и используйте полученные выходные данные вместо $scope.

Запишите свойство appId, возвращенное из команды:
```json
{
  "appId": "11111111-abcd-1234-efgh-111111111111",
  "displayName": "openshiftsp",
  "name": "http://openshiftsp",
  "password": {Strong Password},
  "tenant": "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
}
```
 > [!WARNING] 
 > Обязательно создайте надежный пароль. Следуйте руководству по [правилам и ограничениям для паролей Azure AD](/azure/active-directory/active-directory-passwords-policy).

Дополнительные сведения о субъектах-службах см. в статье [Создание субъекта-службы Azure с помощью Azure CLI](https://docs.microsoft.com/cli/azure/create-an-azure-service-principal-azure-cli?view=azure-cli-latest).

## <a name="prerequisites-applicable-only-to-resource-manager-template"></a>Предварительные требования применимы только к шаблону диспетчер ресурсов

Секреты должны быть созданы для закрытого ключа SSH (**сшприватекэй**), секрета клиента Azure AD (**aadClientSecret**), пароля администратора OpenShift (**Опеншифтпассворд**) и пароля диспетчера подписки Red Hat или ключа активации ( **Рхсмпассвордорактиватионкэй**).  Кроме того, если используются пользовательские SSL-сертификаты, необходимо создать шесть дополнительных секретов — **раутингкафиле**, **раутингцертфиле**, **раутингкэйфиле**, **мастеркафиле**, **мастерцертфиле**и  **мастеркэйфиле**.  Эти параметры будут более подробно описаны.

Шаблон ссылается на конкретные имена секретов, поэтому **необходимо** использовать указанные выше имена (с учетом регистра).

### <a name="custom-certificates"></a>Пользовательские сертификаты

По умолчанию шаблон будет развертывать кластер OpenShift с помощью самозаверяющих сертификатов для веб-консоли OpenShift и домена маршрутизации. Если вы хотите использовать пользовательские SSL-сертификаты, задайте для "Раутингцерттипе" значение "Custom", а для "Мастерцерттипе" — "Custom".  Для сертификатов потребуются файлы ЦС, сертификаты и ключи в формате PEM.  Можно использовать пользовательские сертификаты для одного, но не для другого.

Эти файлы потребуется хранить в Key Vault секреты.  Используйте те же Key Vault, что и для закрытого ключа.  Вместо того чтобы требовать 6 дополнительных входных данных для имен секретов, шаблон жестко запрограммирован на использование конкретных имен секретов для каждого из файлов SSL-сертификатов.  Сохраните данные сертификата, используя сведения из следующей таблицы.

| Имя секрета      | Файл сертификата   |
|------------------|--------------------|
| мастеркафиле     | Главный файл ЦС     |
| мастерцертфиле   | файл главного сертификата   |
| мастеркэйфиле    | файл главного ключа    |
| раутингкафиле    | файл ЦС маршрутизации    |
| раутингцертфиле  | файл сертификата маршрутизации  |
| раутингкэйфиле   | файл ключа маршрутизации   |

Создайте секреты с помощью Azure CLI. Ниже приведен пример.

```bash
az keyvault secret set --vault-name KeyVaultName -n mastercafile --file ~/certificates/masterca.pem
```

## <a name="next-steps"></a>Следующие шаги

В этой статье рассматриваются следующие темы:
> [!div class="checklist"]
> * Создайте хранилище ключей, чтобы управлять ключами SSH для кластера OpenShift.
> * Создайте субъект-службу для поставщика облачных решений Azure.

Теперь разверните кластер OpenShift:

- [Развертывание платформы контейнеров OpenShift в Azure](./openshift-container-platform.md)
- [Развертывание самостоятельно управляемой платформы контейнера OpenShift предложение Marketplace](./openshift-marketplace-self-managed.md)