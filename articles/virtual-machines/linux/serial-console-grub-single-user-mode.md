---
title: Последовательная консоль Azure для GRUB и однопользовательский режим
description: Использование последовательной консоли Azure для GRUB на виртуальных машинах Azure.
services: virtual-machines-linux
author: asinn826
ms.service: virtual-machines-linux
ms.topic: article
ms.workload: infrastructure-services
ms.date: 08/14/2018
ms.author: alsin
ms.openlocfilehash: 2aa7110ab4e52fdc5c3804bd27be5f41081fb435
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "81758504"
---
# <a name="use-serial-console-to-access-grub-and-single-user-mode"></a>Использование последовательной консоли для доступа к GRUB и однопользовательскому режиму
GRUB — это универсальный загрузчик с титулом GRand. GRUB, помимо всего прочего, дает возможность изменить конфигурацию для загрузки в однопользовательский режим.

Однопользовательский режим — это упрощенная среда с минимальным набором функций. Он может быть полезен для изучения проблем с загрузкой, файловой системой или сетью. В фоновом режиме может выполняться меньше служб, а (в зависимости от уровня запуска) файловая система может даже не подключаться автоматически.

Однопользовательский режим также полезен в ситуациях, когда ваша виртуальная машина может быть настроена для выполнения входа только с использованием ключей SSH. В этом случае вы можете использовать однопользовательский режим для создания учетной записи с проверкой пароля.

Чтобы войти в однопользовательский режим, вам нужно ввести GRUB при загрузке виртуальной машины и изменить конфигурацию загрузки в GRUB. Это можно сделать с помощью последовательной консоли виртуальной машины.

## <a name="general-grub-access"></a>Общий доступ к GRUB
Чтобы получить доступ к GRUB, вам необходимо перезагрузить виртуальную машину, оставив колонку последовательной консоли открытой. Некоторые дистрибутивы требуют ввода с клавиатуры для отображения GRUB, в то время как другие автоматически отображают GRUB в течение нескольких секунд и дают возможность пользователю вводить с клавиатуры для отмены времени ожидания. 

Чтобы получить доступ к однопользовательскому режиму, на виртуальной машине необходимо включить GRUB. В зависимости от выбранного дистрибутива для включения GRUB может потребоваться дополнительная настройка. Ниже приводится подробная информация о дистрибутивах.

### <a name="reboot-your-vm-to-access-grub-in-serial-console"></a>Перезагрузка виртуальной машины для доступа к GRUB в последовательной консоли
Перезагрузка вашей виртуальной машины с помощью открытой колонки последовательной консоли может быть выполнена с помощью команды `'b'`, если [SysRq](./serial-console-nmi-sysrq.md) включена, или нажатием кнопки "Перезагрузка" в обзоре колонки (откройте виртуальную машину на новой вкладке браузера, чтобы перезагрузить без закрытия колонки последовательной консоли). Следуйте инструкциям для конкретного дистрибутива ниже, чтобы узнать, чего ожидать от GRUB при перезагрузке.

## <a name="general-single-user-mode-access"></a>Общий доступ к однопользовательскому режиму
В ситуациях, где вы не настроили учетную запись с помощью проверки пароля, будет требоваться доступ вручную в однопользовательский режим. Необходимо изменить конфигурацию GRUB, чтобы перейти в однопользовательский режим вручную. После этого ознакомьтесь с разделом "Использование однопользовательского режима сброса или добавление пароля", чтобы получить дальнейшие инструкции.

Если виртуальная машина не может выполнить загрузку, некоторые дистрибутивы автоматически переводят пользователя в однопользовательский или аварийный режим. В других системах для автоматического перехода в однопользовательский или аварийный режим требуется дополнительная настройка (например, настройка пароля привилегированного пользователя).

### <a name="use-single-user-mode-to-reset-or-add-a-password"></a>Использование однопользовательского режима для сброса или добавления пароля
После входа в однопользовательский режим выполните следующие действия для добавления нового пользователя с привилегиями sudo.
1. Запустите `useradd <username>`, чтобы добавить пользователя.
1. Запустите `sudo usermod -a -G sudo <username>` для предоставления привилегированных разрешений новому пользователю.
1. Используйте `passwd <username>`, чтобы задать пароль для нового пользователя. Затем вы сможете войти в систему как новый пользователь.

## <a name="access-for-red-hat-enterprise-linux-rhel"></a>Доступ в Red Hat Enterprise Linux (RHEL)
RHEL автоматически переводит пользователя в однопользовательский режим, если не может нормально загрузиться. Но если не вы настроили доступ с правами root для однопользовательского режима, у вас не будет пароля для привилегированного пользователя и вы не сможете выполнить вход. Эту проблему можно решить (см. раздел "Вход в однопользовательский режим вручную" ниже), но мы рекомендуем заранее настроить права доступа root.

### <a name="grub-access-in-rhel"></a>Доступ к GRUB в RHEL
В RHEL GRUB всегда включается по умолчанию. Чтобы попасть в GRUB, перезагрузите виртуальную машину с помощью `sudo reboot` и нажмите любую клавишу. Вы увидите экран GRUB.

> Примечание. В документации Red Hat можно найти инструкции для загрузки в режиме спасения, аварийном режиме, режиме отладки и для сброса пароля привилегированного пользователя. Щелкните [здесь](https://aka.ms/rhel7grubterminal), чтобы просмотреть эти инструкции.

### <a name="set-up-root-access-for-single-user-mode-in-rhel"></a>Настройка доступа для привилегированного пользователя в однопользовательском режиме в RHEL
Чтобы использовать однопользовательский режим в RHEL, должен быть включен привилегированный пользователь (с правами доступа root). По умолчанию такой доступ отключен. Если требуется включить однопользовательский режим, используйте следующие инструкции:

1. Войдите в систему RedHat через SSH.
1. Переключитесь на привилегированного пользователя
1. Включите пароль для привилегированного пользователя. 
    * `passwd root` (установите надежный пароль привилегированного пользователя).
1. Убедитесь, что привилегированный пользователь может войти только через ttyS0.
    * `edit /etc/ssh/sshd_config` и убедитесь, что для параметра PermitRootLog задано значение No.
    * `edit /etc/securetty file`, чтобы разрешить вход только через ttyS0. 

Теперь, когда система переходит в однопользовательский режим, вы можете войти в систему, используя пароль привилегированного пользователя.

В качестве альтернативы для RHEL 7.4+ или 6.9+ можно включить однопользовательский режим в запросах GRUB. Ознакомьтесь с инструкциями [здесь](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/installation_guide/s1-rescuemode-booting-single).

### <a name="manually-enter-single-user-mode-in-rhel"></a>Переход в однопользовательский режим вручную в RHEL
Если вы настроили GRUB и доступ привилегированного пользователя, как описано выше, для перехода в однопользовательский режим сделайте следующее:

1. Нажмите клавишу ESC при перезапуске виртуальной машины, чтобы войти в GRUB.
1. В GRUB нажмите клавишу E, чтобы изменить выбранную ОС, которая будет загружена (обычно это первая строка).
1. Найдите строку ядра — в Azure она начинается с `linux16`.
1. Нажмите клавиши CTRL+E, чтобы перейти к концу строки.
1. Добавьте следующий код в конец строки: `systemd.unit=rescue.target`.
    * Теперь вы будете загружаться в однопользовательском режиме. Если вы хотите использовать аварийный режим, добавьте в конец строки `systemd.unit=emergency.target` вместо `systemd.unit=rescue.target`.
1. Нажмите клавиши CTRL+X, чтобы закрыть GRUB и загрузиться с новыми настройками.
1. Перед входом в однопользовательский режим вам будет предложено ввести пароль администратора, который вы создали согласно инструкциям выше.    

    ![](../media/virtual-machines-serial-console/virtual-machine-linux-serial-console-rhel-enter-emergency-shell.gif)

### <a name="enter-single-user-mode-without-root-account-enabled-in-rhel"></a>Вход в однопользовательский режим в RHEL без включенного доступа привилегированного пользователя
Если вы не выполняли описанные выше действия для включения привилегированного пользователя, вы все равно можете сбросить пароль для привилегированного пользователя. Для этого сделайте следующее:

> Примечание. Если вы используете SELinux, при сбросе пароля для привилегированного пользователя обязательно выполните дополнительные действия, описанные в [документации](https://aka.ms/rhel7grubterminal) по Red Hat.

1. Нажмите клавишу ESC при перезапуске виртуальной машины, чтобы войти в GRUB.
1. В GRUB нажмите клавишу E, чтобы изменить выбранную ОС, которая будет загружена (обычно это первая строка).
1. Найдите строку ядра — в Azure она начинается с `linux16`.
1. Добавьте `rd.break` в конец строки, оставив пробел перед `rd.break` (см. пример ниже).
    - Теперь процесс загрузки будет прерываться перед переходом управления от `initramfs` к `systemd`, как описано в [документации](https://aka.ms/rhel7rootpassword) по Red Hat.
1. Нажмите клавиши CTRL+X, чтобы закрыть GRUB и загрузиться с новыми настройками.
1. При загрузке виртуальная машина перейдет в аварийный режим с файловой системой, подключенной только для чтения. Введите в оболочке команду `mount -o remount,rw /sysroot`, чтобы заново подключить корневую файловую систему с разрешениями на чтение и запись.
1. После загрузки в однопользовательском режиме введите `chroot /sysroot`, чтобы переключиться в режим `sysroot`.
1. Теперь вы получили права привилегированного пользователя. Осталось только сбросить пароль для привилегированного пользователя с помощью `passwd` и перейти в однопользовательский режим согласно описанным выше инструкциям. Когда все будет готово, введите `reboot -f` для перезагрузки.

![](../media/virtual-machines-serial-console/virtual-machine-linux-serial-console-rhel-emergency-mount-no-root.gif)

> Примечание. Выполнение описанных выше инструкций приведет к переключению в аварийную оболочку, в которой можно выполнять такие задачи, как редактирование `fstab`. Но стандартная рекомендация для этой процедуры — ограничиться сбросом пароля для привилегированного пользователя, а затем с его помощью переключиться в однопользовательский режим. 


## <a name="access-for-centos"></a>Доступ для CentOS
Как и в Red Hat Enterprise Linux, однопользовательский режим в CentOS требует включения GRUB и привилегированного пользователя. 

### <a name="grub-access-in-centos"></a>Доступ к GRUB в CentOS
В CentOS GRUB всегда включается по умолчанию. Чтобы попасть в GRUB, перезагрузите виртуальную машину с помощью `sudo reboot` и нажмите любую клавишу. Вы увидите экран GRUB.

### <a name="single-user-mode-in-centos"></a>Однопользовательский режим в CentOS
Чтобы включить однопользовательский режим в CentOS, выполните предложенные выше инструкции для RHEL.

## <a name="access-for-ubuntu"></a>Доступ для Ubuntu 
В образах Ubuntu пароль для привилегированного пользователя не требуется. Когда система переходит в однопользовательский режим, вы можете работать без ввода дополнительных учетных данных. 

### <a name="grub-access-in-ubuntu"></a>Доступ к GRUB в Ubuntu
Чтобы получить доступ к GRUB, нажмите и удерживайте клавишу ESC при загрузке виртуальной машины. 

По умолчанию образы Ubuntu не будут автоматически отображать экран GRUB. Это можно изменить, выполнив следующие инструкции:
1. Откройте `/etc/default/grub.d/50-cloudimg-settings.cfg` в текстовом редакторе по своему усмотрению.
1. Измените значение `GRUB_TIMEOUT` на ненулевое.
1. Откройте `/etc/default/grub` в текстовом редакторе по своему усмотрению.
1. Закомментируйте строку `GRUB_HIDDEN_TIMEOUT=1`.
1. Выполнить `sudo update-grub`

### <a name="single-user-mode-in-ubuntu"></a>Однопользовательский режим в Ubuntu
Ubuntu автоматически переводит пользователя в однопользовательский режим, если не может нормально загрузиться. Чтобы перейти в однопользовательский режим вручную, сделайте следующее:

1. В GRUB нажмите клавишу E, чтобы изменить запись загрузки (которая указывает на Ubuntu).
1. Найдите строку, начинающуюся с `linux`, а затем найдите `ro`.
1. Добавьте `single` после `ro`, оставив пробелы до и после `single`.
1. Нажмите клавиши CTRL+X, чтобы перезагрузить виртуальную машину с новыми параметрами и перейти в однопользовательский режим.

## <a name="access-for-coreos"></a>Доступ для CoreOS
Чтобы использовать однопользовательский режим в CoreOS, нужно включить GRUB. 

### <a name="grub-access-in-coreos"></a>Доступ к GRUB в CoreOS
Чтобы получить доступ к GRUB, нажмите любую клавишу при загрузке виртуальной машины.

### <a name="single-user-mode-in-coreos"></a>Однопользовательский режим в CoreOS
CoreOS автоматически переводит пользователя в однопользовательский режим, если не может нормально загрузиться. Чтобы перейти в однопользовательский режим вручную, сделайте следующее:
1. В GRUB нажмите клавишу E, чтобы изменить запись загрузки.
1. Найдите строку, которая начинается с `linux$`. Должно быть две таких строки, разнесенных в разные ветви предложения if/else.
1. Добавьте `coreos.autologin=ttyS0` в конец обеих строк `linux$`.
1. Нажмите клавиши CTRL+X, чтобы перезагрузить виртуальную машину с новыми параметрами и перейти в однопользовательский режим.

## <a name="access-for-suse-sles"></a>Доступ для SUSE SLES
Новые образы SLES 12 SP3+ предоставляют доступ через последовательную консоль, когда система загружается в аварийном режиме. 

### <a name="grub-access-in-suse-sles"></a>Доступ к GRUB в SUSE SLES
Для доступа к GRUB в SLES нужно настроить загрузчик с помощью YaST. Для этого сделайте следующее:

1. Подключитесь через SSH к виртуальной машине SLES и выполните команду `sudo yast bootloader`. Используйте клавиши `tab`, `enter` и клавиши со стрелками для перемещения по меню. 
1. Перейдите к элементу `Kernel Parameters` и установите флажок `Use serial console`. 
1. Добавьте `serial --unit=0 --speed=9600 --parity=no` к аргументам консоли.

1. Нажмите клавишу F10, чтобы сохранить настройки и закрыть окно.
1. Чтобы войти в GRUB, перезагрузите виртуальную машину и нажмите любую клавишу во время загрузки. Экран GRUB останется включенным.
    - По умолчанию GRUB ожидает нажатия клавиш в течение 1 секунды. Это значение настраивается в переменной `GRUB_TIMEOUT` в `/etc/default/grub`.

![](../media/virtual-machines-serial-console/virtual-machine-linux-serial-console-sles-yast-grub-config.gif)

### <a name="single-user-mode-in-suse-sles"></a>Однопользовательский режим в SUSE SLES
SLES автоматически переключается в аварийную оболочку, если не может нормально загрузиться. Чтобы перейти в аварийную оболочку вручную, сделайте следующее:

1. В GRUB нажмите клавишу E, чтобы изменить запись загрузки (которая указывает на SLES).
1. Найдите строку ядра, которая начинается с `linux`.
1. Добавьте `systemd.unit=emergency.target` в конец этой строки.
1. Нажмите клавиши CTRL+X, чтобы перезагрузить виртуальную машину с новыми параметрами и перейти в аварийную оболочку.
   > Обратите внимание, что при загрузке аварийной оболочки файловая система подключается в режиме _только для чтения_. Если вы хотите внести изменения в один или несколько файлов, повторно подключите файловую систему с разрешениями на чтение и запись. Для этого введите в оболочку команду `mount -o remount,rw /`.

## <a name="access-for-oracle-linux"></a>Доступ для Oracle Linux
Как и в Red Hat Enterprise Linux, однопользовательский режим в Oracle Linux требует включения GRUB и привилегированного пользователя. 

### <a name="grub-access-in-oracle-linux"></a>Доступ к GRUB в Oracle Linux
В Oracle Linux GRUB всегда включается по умолчанию. Чтобы попасть в GRUB, перезагрузите виртуальную машину с помощью `sudo reboot` и нажмите клавишу ESC. Вы увидите экран GRUB.

### <a name="single-user-mode-in-oracle-linux"></a>Однопользовательский режим в Oracle Linux
Чтобы включить однопользовательский режим в Oracle Linux, выполните предложенные выше инструкции для RHEL.

## <a name="next-steps"></a>Дальнейшие шаги
* Основная страница документации по последовательной консоли для Linux находится [здесь](serial-console.md).
* Используйте последовательную консоль для [вызовов SysRq и NMI](serial-console-nmi-sysrq.md).
* Последовательная консоль также доступна для виртуальных машин [Windows](../windows/serial-console.md).
* Дополнительные сведения о [диагностике загрузки](boot-diagnostics.md)
