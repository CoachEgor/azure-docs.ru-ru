---
title: Обзор поддержки Cloud-init для виртуальных машин Linux в Azure
description: Обзор возможностей Cloud-init для настройки виртуальной машины во время подготовки в Azure.
services: virtual-machines-linux
documentationcenter: ''
author: danielsollondon
manager: gwallace
editor: ''
tags: azure-resource-manager
ms.assetid: 195c22cd-4629-4582-9ee3-9749493f1d72
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: azurecli
ms.topic: article
ms.date: 01/23/2019
ms.author: danis
ms.openlocfilehash: 0309d9a794a978c736ffc4689c46565ee8fb5b00
ms.sourcegitcommit: 390cfe85629171241e9e81869c926fc6768940a4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2020
ms.locfileid: "78226701"
---
# <a name="cloud-init-support-for-virtual-machines-in-azure"></a>Поддержка Cloud-init для виртуальных машин в Azure
В этой статье описывается поддержка, которая существует в [Cloud-init](https://cloudinit.readthedocs.io) для настройки виртуальной машины или масштабируемых наборов виртуальных машин во время подготовки в Azure. Эти конфигурации Cloud-init выполняются при первой загрузке после подготовки ресурсов в Azure.  

Подготовка виртуальной машины — это процесс, в котором Azure будет передавать значения параметров, такие как имя узла, имя пользователя, пароль и т. д., и сделать их доступными для виртуальной машины при загрузке. "Агент подготовки" будет использовать эти значения, настроить виртуальную машину и отправить отчет обратно после завершения. 

Azure поддерживает два агента подготовки [Cloud-init](https://cloudinit.readthedocs.io)и [Агент Linux для Azure (WALA)](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux).

## <a name="cloud-init-overview"></a>Обзор Cloud-init
[Cloud-init](https://cloudinit.readthedocs.io) — широко используемый подход к настройке виртуальной машины Linux при первой загрузке. Вы можете использовать cloud-init для установки пакетов, записи файлов или настройки пользователей и параметров безопасности. Так как cloud-init вызывается при начальной загрузке, к вашей конфигурации не нужно применять какие-либо дополнительные действия или агентов.  Дополнительные сведения о том, как правильно форматировать файлы `#cloud-config` или другие входные данные, см. на [сайте документации по Cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/format.html#cloud-config-data).  Файлы `#cloud-config` — это текстовые файлы, закодированные в формате base64.

Cloud-init также работает в разных дистрибутивах. Например, для установки пакета не используется **apt-get install** или **yum install**. Вместо этого можно определить список пакетов для установки. Cloud-init автоматически использует собственное средство управления пакетами для выбранного дистрибутив.

Мы активно сотрудничаем с нашими утвержденными партнерами, работающими над дистрибутивами Linux, чтобы образы с поддержкой cloud-init стали доступными в Azure Marketplace. Эти образы обеспечивают бесперебойную работу развертываний и конфигураций cloud-init с виртуальными машинами и масштабируемыми наборами виртуальных машин. Сначала мы работаем с подтвержденными партнерами Linux дистрибутив и вышестоящим, чтобы обеспечить функции Cloud-init с ОС в Azure, после чего пакеты обновляются и становятся общедоступными в репозиториях пакетов дистрибутив. 

Существует два этапа сделать Cloud-init доступным для операционной системы Linux дистрибутив OS в Azure, поддержки пакетов и поддержки образов:
* "Поддержка пакетов Cloud-init в Azure", в которой поддерживаются пакеты Cloud-init, или в предварительной версии, поэтому эти пакеты можно использовать вместе с ОС в пользовательском образе.
* Если образ уже настроен для использования Cloud-init, то документы "Image Cloud-init готовы".


### <a name="canonical"></a>Canonical
| Издатель/версия| ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Облако образов — готово к инициализации | Поддержка пакетов Cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|Каноническая 18,04 |UbuntuServer |18.04-LTS |последняя |да | да |
|Каноническая 16,04|UbuntuServer |16.04-LTS |последняя |да | да |
|Каноническая 14,04|UbuntuServer |14.04.5-LTS |последняя |да | да |

### <a name="rhel"></a>RHEL
| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Облако образов — готово к инициализации | Поддержка пакетов Cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|RedHat 7.6 |RHEL |7-RAW-CI |7.6.2019072418 |да | Да — поддержка из версии пакета: *18.2-1. el7_6.2*|
|RedHat 7.7 |RHEL |7-RAW-CI |7.7.2019081601 | Да (Обратите внимание, что это изображение предварительного просмотра, и, как только все образы RHEL 7,7 поддерживают Cloud-init, оно будет удалено с посредним 2020, будет указано уведомление). | Да — поддержка из версии пакета: *18.5 -3. el7*|
|RedHat 7.7 |RHEL |7-RAW | Недоступно| обновления без образа для запуска февраля 2020| Да — поддержка из версии пакета: *18.5 -3. el7*|
|RedHat 7.7 |RHEL |7-LVM | Недоступно| обновления без образа для запуска февраля 2020| Да — поддержка из версии пакета: *18.5 -3. el7*|
|RedHat 7.7 |RHEL |7,7 | Недоступно| обновления без образа для запуска февраля 2020 | Да — поддержка из версии пакета: *18.5 -3. el7*|
|RedHat 7.7 |RHEL — BYOS | RHEL — lvm77 | Недоступно|обновления без образа для запуска февраля 2020  | Да — поддержка из версии пакета: *18.5 -3. el7*|

### <a name="centos"></a>CentOS

| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Облако образов — готово к инициализации | Поддержка пакетов Cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|OpenLogic 7,7 |CentOS |7-CI |7.7.20190920 |Да (Обратите внимание, что это изображение предварительного просмотра, и, как только все образы CentOS 7,7 поддерживают Cloud-init, оно будет удалено с посредним 2020, будет указано уведомление). | Да — поддержка из версии пакета: *18.5 -3. el7. CentOS*|

* Образы CentOS 7,7, которые будут включены в Cloud-init, будут обновлены в Фев 2020. 

### <a name="oracle"></a>Oracle;

| Издатель/версия | ПРЕДЛОЖЕНИЕ | номер SKU | Версия | Облако образов — готово к инициализации | Поддержка пакетов Cloud-init в Azure|
|:--- |:--- |:--- |:--- |:--- |:--- |
|Oracle 7,7 |Oracle-Linux |77 — CI |7.7.01| изображение предварительного просмотра (Обратите внимание, что это изображение предварительного просмотра, а все образы Oracle 7,7 поддерживают Cloud-init, это будет удалено в среднем 2020, уведомление будет получено). | нет, в предварительной версии пакет имеет вид: *18.5-3.0.1. el7*

### <a name="debian--suse-sles"></a>Debian & SuSE SLES
Сейчас мы работаем над поддержкой предварительной версии, предполагаюи обновления в феврале и 2020 марта.

В настоящее время Azure Stack будет поддерживать подготовку образов с поддержкой Cloud-init.


## <a name="what-is-the-difference-between-cloud-init-and-the-linux-agent-wala"></a>Разница между cloud-init и агентом Linux (WALA)
WALA — это агент, зависящий от платформы Azure, используемый для инициализации и настройки виртуальных машин и обработки [расширений Azure](https://docs.microsoft.com/azure/virtual-machines/extensions/features-linux). 

Мы улучшаем задачу настройки виртуальных машин для использования Cloud-init вместо агента Linux, чтобы позволить существующим клиентам Cloud-init использовать текущие сценарии Cloud-init или новые клиенты, чтобы воспользоваться богатыми возможностями настройки Cloud-init. Если у вас есть инвестиции в скрипты Cloud-init для настройки систем Linux, **Дополнительные параметры, необходимые** для выполнения процесса Cloud-init, не требуются. 

Cloud-init не может обрабатывать расширения Azure, поэтому WALA по-прежнему требуется в образе для обработки расширений, но вам потребуется отключить его код подготовки. для подтвержденных образов дистрибутивов Linux, которые преобразуются для подготовки в Cloud-init, они будут иметь WALA установлен и правильно настроен.

Если при создании виртуальной машины не включить Azure CLI `--custom-data` коммутатора во время подготовки, Cloud-init или WALA принимает минимальные параметры подготовки виртуальной машины, необходимые для подготовки виртуальной машины и завершения развертывания с параметрами по умолчанию.  Если вы ссылаетесь на конфигурацию Cloud-init с параметром `--custom-data`, все данные, содержащиеся в пользовательских данных, будут доступны для Cloud-init при загрузке виртуальной машины.

конфигурации Cloud-init, применяемые к виртуальным машинам, не имеют ограничений по времени и не приведут к сбою развертывания по истечении времени ожидания. Это неверно для WALA. Если изменить значение WALA по умолчанию на обработка пользовательских данных, оно не сможет превышать общую квоту времени подготовки виртуальной машины в 40mins, если это так, то создание виртуальной машины завершится ошибкой.

## <a name="deploying-a-cloud-init-enabled-virtual-machine"></a>Развертывание виртуальной машины с поддержкой cloud-init
Развертывать виртуальную машину с включенным cloud-init так же просто, как и ссылаться на распределение с включенным cloud-init во время развертывания.  Распространители дистрибутивов Linux должны включать и интегрировать cloud-init в свои базовые опубликование образы Azure. Убедившись, что в образе, который нужно развернуть, включен cloud-init, вы можете использовать Azure CLI для его развертывания. 

Первым шагом при развертывании образа является создание группы ресурсов с использованием команды [az group create](/cli/azure/group). Группа ресурсов Azure является логическим контейнером, в котором происходит развертывание ресурсов Azure и управление ими. 

В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *eastus*.

```azurecli-interactive 
az group create --name myResourceGroup --location eastus
```
Следующим действием является создание файла *cloud-init.txt* в текущей оболочке и вставка следующей конфигурации. Для этого примера создайте файл в Cloud Shell (не на локальном компьютере). Вы можете использовать любой редактор. Введите `sensible-editor cloud-init.txt`, чтобы создать файл и просмотреть список доступных редакторов. Выберите первый пункт, чтобы использовать редактор **nano**. Убедитесь, что весь файл cloud-init скопирован правильно, особенно первая строка:

```yaml
#cloud-config
package_upgrade: true
packages:
  - httpd
```
Нажмите клавиши `ctrl-X`, чтобы выйти из файла, введите `y`, чтобы сохранить изменения в файле, а затем нажмите клавишу `enter`, чтобы подтвердить имя файла при выходе.

Последним шагом является создание виртуальной машины с использованием команды [az vm create](/cli/azure/vm). 

В следующем примере создаются виртуальная машина *centos74* и ключи SSH, если они не существуют в расположении ключей по умолчанию. Чтобы использовать определенный набор ключей, используйте параметр `--ssh-key-value`.  Используйте параметр `--custom-data`, чтобы передать файл конфигурации cloud-init. Укажите полный путь к конфигурации *cloud-init.txt*, если этот файл сохранен вне текущего рабочего каталога. В следующем примере создается виртуальная машина с именем *centos74*.

```azurecli-interactive 
az vm create \
  --resource-group myResourceGroup \
  --name centos74 \
  --image OpenLogic:CentOS-CI:7-CI:latest \
  --custom-data cloud-init.txt \
  --generate-ssh-keys 
```

После создания виртуальной машины в Azure CLI появятся сведения о вашем развертывании. Запишите значение `publicIpAddress`. Этот адрес используется для доступа к виртуальной машине.  На создание виртуальной машины, установку пакетов и запуск приложения может потребоваться некоторое время. Некоторые фоновые задачи продолжают работу после возврата к командной строке в Azure CLI. Вы можете подключиться к виртуальной машине по протоколу SSH и выполнить шаги, описанные в разделе "Устранение неполадок", чтобы просмотреть журналы cloud-init. 

## <a name="troubleshooting-cloud-init"></a>Устранение неполадок cloud-init
После подготовки виртуальной машины cloud-init запустит все модули и скрипты, заданные в параметре `--custom-data`, для ее настройки.  Если вам необходимо устранить ошибки или пропуски в конфигурации, найдите имя модуля (`disk_setup` или `runcmd`, к примеру) в журнале cloud-init, который находится в файле **/var/log/cloud-init.log**.

> [!NOTE]
> Не каждый сбой модуля приводит к неустранимому сбою всей конфигурации cloud-init. Например, если используется модуль `runcmd`, при сбое скрипта cloud-init все еще будет отображать сообщение об успешной подготовке, так как выполнен модуль runcmd.

Дополнительные сведения о журнале cloud-init см. в [документации по cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/logging.html) 

## <a name="next-steps"></a>Следующие шаги
Примеры изменения конфигураций с помощью cloud-init см. в следующих документах:
 
- [Добавление пользователя Linux к виртуальной машине](cloudinit-add-user.md)
- [Запуск диспетчера пакетов для обновления существующих пакетов при первой загрузке](cloudinit-update-vm.md)
- [Изменение имени локального узла виртуальной машины](cloudinit-update-vm-hostname.md) 
- [Установка пакета приложения, обновление файлов конфигурации и внедрение ключей](tutorial-automate-vm-deployment.md)
 
