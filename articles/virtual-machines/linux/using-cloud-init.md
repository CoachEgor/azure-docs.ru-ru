---
title: Общие сведения о поддержке Cloud-init для виртуальных машин Linux в Azure
description: Общие сведения о возможностях cloud-init в Microsoft Azure
services: virtual-machines-linux
documentationcenter: ''
author: danielsollondon
manager: gwallace
editor: ''
tags: azure-resource-manager
ms.assetid: 195c22cd-4629-4582-9ee3-9749493f1d72
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: azurecli
ms.topic: article
ms.date: 10/11/2019
ms.author: danis
ms.openlocfilehash: 6c522af44be51eb89ee9f64bae2dc4e9e7b24123
ms.sourcegitcommit: 9405aad7e39efbd8fef6d0a3c8988c6bf8de94eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "74873953"
---
# <a name="cloud-init-support-for-virtual-machines-in-azure"></a>Поддержка cloud-init для виртуальных машин в Azure
В этой статье описывается поддержка, которая существует в [Cloud-init](https://cloudinit.readthedocs.io) для настройки виртуальной машины или масштабируемых наборов виртуальных машин во время подготовки в Azure. Эти скрипты cloud-init выполняются при первой загрузке, если в Azure подготовлены все нужные ресурсы.  

## <a name="cloud-init-overview"></a>Обзор cloud-Init
[Пакет cloud-init](https://cloudinit.readthedocs.io) — широко используемое средство, используемое для настройки виртуальной машины Linux при ее первой загрузке. Вы можете использовать cloud-init для установки пакетов, записи файлов или настройки пользователей и параметров безопасности. Так как cloud-init вызывается при начальной загрузке, к вашей конфигурации не нужно применять какие-либо дополнительные действия или агентов.  Дополнительные сведения о том, как правильно отформатировать файлы, `#cloud-config`, см. на [сайте документации по cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/format.html#cloud-config-data).  Файлы `#cloud-config` — это текстовые файлы, закодированные в формате base64.

Кроме того, cloud-init работает с разными дистрибутивами. Например, для установки пакета не используется **apt-get install** или **yum install**. Вместо этого можно определить список пакетов для установки. Файл cloud-init автоматически использует собственный инструмент управления пакетами из выбранного дистрибутива.

Мы активно сотрудничаем с нашими утвержденными партнерами, работающими над дистрибутивами Linux, чтобы образы с поддержкой cloud-init стали доступными в Azure Marketplace. Эти образы сделают развертывания и конфигурации Cloud-init без проблем с виртуальными машинами и масштабируемыми наборами виртуальных машин. В следующей таблице приведены сведения о текущей доступности образов с поддержкой cloud-init на платформе Azure:

| ИЗДАТЕЛЬ | Предложение | SKU | Версия | готовность к использованию cloud-init |
|:--- |:--- |:--- |:--- |:--- |
|Canonical |UbuntuServer |18.04-LTS |latest |Да | 
|Canonical |UbuntuServer |16.04-LTS |latest |Да | 
|Canonical |UbuntuServer |14.04.5-LTS |latest |Да |
|CoreOS |CoreOS |Stable |latest |Да |
|OpenLogic 7,7 |CentOS |7-CI |7.7.20190920 |предварительная версия |
|Oracle 7,7 |Oracle-Linux |77 — CI |7.7.01|предварительная версия |
|RedHat 7.6 |RHEL |7-RAW-CI |7.6.2019072418 |Да |
|RedHat 7.7 |RHEL |7-RAW-CI |7.7.2019081601 |предварительная версия |
    
В настоящее время Azure Stack не поддерживает подготовку RHEL 7. x и CentOS 7. x с помощью Cloud-init.

* Для пакета RHEL 7,6, поддерживаемого пакетом Cloud-init, поддерживается: *18.2-1. el7_6.2* 
* Для RHEL 7,7 (Предварительная версия) пакет Cloud-init предварительной версии — *18.5 -3. el7*
* Для CentOS 7,7 (Предварительная версия) пакет Cloud-init предварительной версии — *18.5 -3. el7. CentOS*
* Для версии Oracle 7,7 (Предварительная версия) пакет Cloud-init имеет предварительную версию: *18.5-3.0.1. el7*

## <a name="what-is-the-difference-between-cloud-init-and-the-linux-agent-wala"></a>Разница между cloud-init и агентом Linux (WALA)
WALA — это уникальный агент платформы Azure, использующийся для подготовки и настройки виртуальных машин и обработки расширений Azure. Мы улучшили задачу настройки виртуальных машин для использования cloud-init вместо агента Linux таким образом, чтобы имеющиеся пользователи cloud-init смогли применять свои текущие скрипты cloud-init.  Если у вас уже есть скрипты cloud-init для настройки систем Linux, то для их включения **дополнительные параметры не требуются**. 

Если не указать параметр AzureCLI `--custom-data` во время подготовки, WALA принимает минимальные необходимые параметры подготовки для виртуальной машины и выполняет развертывание с параметрами по умолчанию.  При ссылке на параметр cloud-init `--custom-data` сведения, содержащиеся в пользовательских данных (отдельные параметры или весь скрипт), переопределят значения WALA по умолчанию. 

Конфигурации WALA для виртуальных машин ограничены максимальным временем подготовки виртуальных машин.  Конфигурация cloud-init применяется к виртуальным машинам без временных ограничений, которые не приведут к сбою развертывания по времени. 

## <a name="deploying-a-cloud-init-enabled-virtual-machine"></a>Развертывание виртуальной машины с поддержкой cloud-init
Развертывать виртуальную машину с включенным cloud-init так же просто, как и ссылаться на распределение с включенным cloud-init во время развертывания.  Распространители дистрибутивов Linux должны включать и интегрировать cloud-init в свои базовые опубликование образы Azure. Убедившись, что в образе, который нужно развернуть, включен cloud-init, вы можете использовать Azure CLI для его развертывания. 

Первым шагом при развертывании образа является создание группы ресурсов с использованием команды [az group create](/cli/azure/group). Группа ресурсов Azure является логическим контейнером, в котором происходит развертывание ресурсов Azure и управление ими. 

В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *eastus*.

```azurecli-interactive 
az group create --name myResourceGroup --location eastus
```
Следующим действием является создание файла *cloud-init.txt* в текущей оболочке и вставка следующей конфигурации. Для этого примера создайте файл в Cloud Shell (не на локальном компьютере). Вы можете использовать любой редактор. Введите `sensible-editor cloud-init.txt`, чтобы создать файл и просмотреть список доступных редакторов. Выберите первый пункт, чтобы использовать редактор **nano**. Убедитесь, что весь файл cloud-init скопирован правильно, особенно первая строка:

```yaml
#cloud-config
package_upgrade: true
packages:
  - httpd
```
Нажмите клавиши `ctrl-X`, чтобы выйти из файла, введите `y`, чтобы сохранить изменения в файле, а затем нажмите клавишу `enter`, чтобы подтвердить имя файла при выходе.

Последним шагом является создание виртуальной машины с использованием команды [az vm create](/cli/azure/vm). 

В следующем примере создаются виртуальная машина *centos74* и ключи SSH, если они не существуют в расположении ключей по умолчанию. Чтобы использовать определенный набор ключей, используйте параметр `--ssh-key-value`.  Используйте параметр `--custom-data`, чтобы передать файл конфигурации cloud-init. Укажите полный путь к конфигурации *cloud-init.txt*, если этот файл сохранен вне текущего рабочего каталога. В следующем примере создается виртуальная машина с именем *centos74*.

```azurecli-interactive 
az vm create \
  --resource-group myResourceGroup \
  --name centos74 \
  --image OpenLogic:CentOS-CI:7-CI:latest \
  --custom-data cloud-init.txt \
  --generate-ssh-keys 
```

После создания виртуальной машины в Azure CLI появятся сведения о вашем развертывании. Запишите значение `publicIpAddress`. Этот адрес используется для доступа к виртуальной машине.  На создание виртуальной машины, установку пакетов и запуск приложения может потребоваться некоторое время. Некоторые фоновые задачи продолжают работу после возврата к командной строке в Azure CLI. Вы можете подключиться к виртуальной машине по протоколу SSH и выполнить шаги, описанные в разделе "Устранение неполадок", чтобы просмотреть журналы cloud-init. 

## <a name="troubleshooting-cloud-init"></a>Устранение неполадок cloud-init
После подготовки виртуальной машины cloud-init запустит все модули и скрипты, заданные в параметре `--custom-data`, для ее настройки.  Если вам необходимо устранить ошибки или пропуски в конфигурации, найдите имя модуля (`disk_setup` или `runcmd`, к примеру) в журнале cloud-init, который находится в файле **/var/log/cloud-init.log**.

> [!NOTE]
> Не каждый сбой модуля приводит к неустранимому сбою всей конфигурации cloud-init. Например, если используется модуль `runcmd`, при сбое скрипта cloud-init все еще будет отображать сообщение об успешной подготовке, так как выполнен модуль runcmd.

Дополнительные сведения о журнале cloud-init см. в [документации по cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/logging.html) 

## <a name="next-steps"></a>Дальнейшие действия
Примеры изменения конфигураций с помощью cloud-init см. в следующих документах:
 
- [Добавление пользователя Linux к виртуальной машине](cloudinit-add-user.md)
- [Запуск диспетчера пакетов для обновления существующих пакетов при первой загрузке](cloudinit-update-vm.md)
- [Изменение имени локального узла виртуальной машины](cloudinit-update-vm-hostname.md) 
- [Установка пакета приложения, обновление файлов конфигурации и внедрение ключей](tutorial-automate-vm-deployment.md)
