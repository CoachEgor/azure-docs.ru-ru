---
title: Неприятное шифрование azure disk для Linux VMs
description: В этой статье содержатся советы по устранению неполадок для шифрования дисков Microsoft Azure для Linux VMs.
author: msmbaldwin
ms.service: virtual-machines-linux
ms.subservice: security
ms.topic: article
ms.author: mbaldwin
ms.date: 08/06/2019
ms.custom: seodec18
ms.openlocfilehash: eeacea9e3305865881747801100dc17770b7df63
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78970490"
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a>Руководство по устранению неполадок шифрования дисков Azure

Это руководство предназначено для ИТ-специалистов, аналитиков в сфере информационной безопасности и администраторов облака, организации которых используют шифрование дисков Azure. Здесь также содержатся рекомендации по устранению неполадок, связанных с шифрованием дисков.

Прежде чем сделать любой из приведенных ниже шагов, сначала убедитесь, что ВМ, которые вы пытаетесь шифровать, относятся к [поддерживаемым размерам VM и операционным системам,](disk-encryption-overview.md#supported-vms-and-operating-systems)и что вы выполнили все предпосылки:

- [Дополнительные требования к ВМ](disk-encryption-overview.md#supported-vms-and-operating-systems)
- [Требования к сети](disk-encryption-overview.md#networking-requirements)
- [Требования к хранению ключей шифрования](disk-encryption-overview.md#encryption-key-storage-requirements)

 

## <a name="troubleshooting-linux-os-disk-encryption"></a>Устранение неполадок шифрования диска ОС Linux

Для шифрования диска операционной системы Linux нужно отключить диск операционной системы перед запуском процесса полного шифрования. Если это невозможно, вероятно, отобразится сообщение об ошибке.

Эта ошибка может произойти при попытке шифрования диска ОС на VM с средой, которая была изменена с поддерживаемого изображения галереи акций. Отклонения от поддерживаемого образа могут мешать предоставляемой расширением возможности отключать диск ОС. Примеры отклонений могут включать в себя следующее:
- Настроенные образы, несоответствующие поддерживаемой файловой системе или схеме секционирования.
- Большие приложения, такие как SAP, MongoDB, Apache Cassandra или Docker, не поддерживаются, если они устанавливаются и выполняются в ОС перед шифрованием. Служба шифрования дисков Azure не может безопасно завершить эти процессы (это необходимо сделать при подготовке диска ОС к шифрованию). Если на диске ОС останутся активные процессы, не позволяющие закрыть дескрипторы файлов, диск ОС будет невозможно отключить, что, в свою очередь, приведет к сбою шифрования этого диска. 
- Настраиваемые скрипты, выполняющиеся практически одновременно с включением шифрования или при внесении каких-либо других изменений на виртуальной машине во время процесса шифрования. Это может произойти, если шаблон Azure Resource Manager определяет несколько расширений для одновременного выполнения, или когда настраиваемое расширение скрипта или другое действие выполняются одновременно с шифрованием диска. Сериализация и изоляция таких шагов может помочь решить проблему.
- Если модуль Security Enhanced Linux (SELinux) не был отключен перед включением шифрования, отключение диска завершается ошибкой. SELinux можно будет снова включить после завершения шифрования.
- Диск операционной системы использует схему диспетчера логических томов. При этом доступна ограниченная поддержка диска данных диспетчера логических томов, но диск операционной системы диспетчера логических томов не поддерживается.
- Минимальные требования к памяти не выполняются (для шифрования диска операционной системы рекомендуется 7 ГБ памяти).
- Диски данных рекурсивно подключены в каталоге /mnt/ или любом другом (например, /mnt/data1, /mnt/data2, /data3 + /data3/data4).

## <a name="update-the-default-kernel-for-ubuntu-1404-lts"></a> Обновление ядра по умолчанию для Ubuntu 14.04 LTS

Образ Ubuntu 14.04 LTS поставляется с версией ядра 4.4 по умолчанию. В этой версии ядра существует известная проблема, в которой компонент, призванный решать проблему недостатка памяти, неправильно завершает команду dd во время процесса шифрования ОС. Эта ошибка исправлена в самой последней версии настроенного ядра Linux Azure. Чтобы избежать этой ошибки, перед включением шифрования в образе обновите настройки ядра до версии [Azure 4.15](https://packages.ubuntu.com/trusty/linux-azure) или более поздней с помощью следующих команд.

```
sudo apt-get update
sudo apt-get install linux-azure
sudo reboot
```

После перезапуска виртуальной машины в новое ядро новую версию ядра можете подтвердить с помощью следующей команды.

```
uname -a
```

## <a name="update-the-azure-virtual-machine-agent-and-extension-versions"></a>Обновление виртуального машинного агента Azure и версий расширения

Операции по шифрованию дисков Azure могут вывести из строя виртуальные изображения машин с использованием неподдерживаемых версий виртуального машинного агента Azure. Linux изображения с агентом версии раньше, чем 2.2.38 должны быть обновлены до включения шифрования. Для получения дополнительной информации [см. Как обновить Azure Linux Agent на VM](../extensions/update-linux-agent.md) и [минимальная поддержка версии для виртуальных агентов машины в Azure](https://support.microsoft.com/en-us/help/4049215/extensions-and-virtual-machine-agent-minimum-version-support).

Также требуется правильная версия расширения гостевого агента Microsoft.Azure.Security.AzureDisk Encryption или Microsoft.Azure.Security.AzureDiskEncryptionForLinux. Версии расширения поддерживаются и обновляются платформой, когда предпосылки агента Azure Virtual Machine удовлетворяются и используется поддерживаемая версия виртуального машинного агента.

Расширение Microsoft.OSTCExtensions.AzureDiskEncryptionForLinux было обезврежено и больше не поддерживается.  

## <a name="unable-to-encrypt-linux-disks"></a>Сбой шифрования дисков Linux

В некоторых случаях шифрование диска зависает на этапе "OS disk encryption started" (Начато шифрование диска ОС) и SSH отключается. При выполнении в готовом образе из коллекции этот процесс может занять от 3 до 16 часов. Если добавляется диск данных объемом в несколько терабайт, процесс может занять несколько дней.

Последовательность шифрования диска операционной системы Linux временно отключает диск операционной системы. Затем выполняется блочное шифрование всего диска операционной системы перед его повторным подключением в зашифрованном состоянии. Linux Disk Encryption не позволяет одновременно использовать VM во время шифрования. Характеристики производительности виртуальной машины могут существенно повлиять на время, необходимое для завершения шифрования. К таким характеристикам относится размер диска и класс учетной записи хранения ("Стандартный" или "Премиум" (SSD)).

Чтобы проверить состояние шифрования, ознакомьтесь с полем **ProgressMessage,** возвращенным из команды [Get-AzVmDiskEncryptionStatus.](/powershell/module/az.compute/get-azvmdiskencryptionstatus) Во время шифрования диска ОС виртуальная машина входит в состояние обслуживания, а также отключается SSH, чтобы предотвратить нарушение текущего процесса. В процессе шифрования часто появляется сообщение **EncryptionInProgress**. Через несколько часов появляется сообщение **VMRestartPending**, в котором вам будет предложено перезагрузить виртуальную машину. Пример:


```azurepowershell
PS > Get-AzVMDiskEncryptionStatus -ResourceGroupName "MyVirtualMachineResourceGroup" -VMName "VirtualMachineName"
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzVMDiskEncryptionStatus -ResourceGroupName "MyVirtualMachineResourceGroup" -VMName "VirtualMachineName"
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

Для выполнения заключительных действий на целевом объекте необходимо перезагрузить виртуальную машину и подождать 2–3 минуты до завершения перезагрузки. После завершения шифрования сообщение о состоянии изменится. Когда это сообщение появится, предполагается, что зашифрованный диск ОС и виртуальная машина готовы к использованию.

Мы рекомендуем восстановить виртуальную машину с помощью моментального снимка или резервной копии, созданными непосредственно перед шифрованием, в следующих случаях:
   - Если не происходит описанная ранее последовательность перезагрузки.
   - Если в сведениях о загрузке, сообщении о ходе выполнения или других индикаторах ошибки указывается, что во время шифрования ОС произошел сбой. Примером такого сообщения является ошибка сбоя отключения, описанная в этом руководстве.

До следующей попытки необходимо повторно вычислить характеристики виртуальной машины и убедиться, что выполнены все необходимые предварительные требования.

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a>Устранение неполадок шифрования диска Azure в связи с брандмауэром

Посмотреть [шифрование дисков в изолированной сети](disk-encryption-isolated-network.md)

## <a name="troubleshooting-encryption-status"></a>Устранение неполадок с состоянием шифрования 

Портал может отображать диск в зашифрованном виде даже после того, как он был незашифрован в Пределах VM.  Это может произойти, когда команды низкого уровня используются для прямого расшифровки диска из VM, вместо того, чтобы использовать команды управления шифрованием azure Disk более высокого уровня.  Команды более высокого уровня не только не шифруют диск из VM, но и за пределами VM, но и обновляют важные настройки шифрования уровня платформы и настройки расширения, связанные с VM.  Если они не будут согласованы, платформа не сможет сообщить о состоянии шифрования или предоставить VM должным образом.   

Чтобы отключить шифрование azure Disk с помощью PowerShell, используйте [Disable-AzVMDiskEncryption,](/powershell/module/az.compute/disable-azvmdiskencryption) за которым следует [Удалить-AzVMDiskEncryptionExtension.](/powershell/module/az.compute/remove-azvmdiskencryptionextension) Запуск Remove-AzVMDiskEncryptionExtension до отключения шифрования не удастся.

Чтобы отключить шифрование Azure Disk с помощью CLI, используйте [az vm шифрование отключите.](/cli/azure/vm/encryption) 

## <a name="next-steps"></a>Дальнейшие действия

В этом документе вы узнали о некоторых распространенных проблемах в шифровании дисков Azure и их устранении. Дополнительные сведения об этой службе и ее возможностях см. в статьях:

- [Шифрование диска в центре безопасности Azure](../../security-center/security-center-apply-disk-encryption.md)
- [Шифрование неактивных данных в Azure](../../security/fundamentals/encryption-atrest.md)
