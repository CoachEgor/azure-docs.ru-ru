---
title: Оптимизация виртуальной машины Linux в Azure
description: В этой статье приводятся советы по оптимизации, которые помогут вам настроить виртуальную машину Linux так, чтобы обеспечить ее оптимальную производительность в Azure.
keywords: виртуальная машина linux,linux виртуальная машина,виртуальная машина ubuntu
services: virtual-machines-linux
documentationcenter: ''
author: rickstercdn
manager: gwallace
tags: azure-resource-manager
ms.assetid: 8baa30c8-d40e-41ac-93d0-74e96fe18d4c
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.topic: article
ms.date: 09/06/2016
ms.author: rclaus
ms.subservice: disks
ms.openlocfilehash: 0ff901e7d53e0814ab064867be6185709e9b6a20
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81452355"
---
# <a name="optimize-your-linux-vm-on-azure"></a>Оптимизация виртуальной машины Linux в Azure
Вы можете легко создать виртуальную машину (VM) Linux с помощью портала или командной строки. В этом руководстве показано, как при помощи настроек оптимизировать производительность VM на платформе Microsoft Azure. В этой статье описывается виртуальная машина Ubuntu Server, но вы можете также создавать виртуальные машины Linux, используя [собственные образы в качестве шаблонов](create-upload-generic.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).  

## <a name="prerequisites"></a>Предварительные требования
В этой статье предполагается, что у вас уже есть действующая подписка Azure ([бесплатная пробная подписка](https://azure.microsoft.com/pricing/free-trial/)), в которой подготовлена виртуальная машина. Прежде чем [создавать виртуальную машину](quick-create-cli.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json), установите последнюю версию [Azure CLI](/cli/azure/install-az-cli2) и войдите в учетную запись Azure, выполнив команду [az login](/cli/azure/reference-index).

## <a name="azure-os-disk"></a>Диск ОС в Azure
У созданной в Azure виртуальной машины Linux будет два диска: **/dev/sda** ваш диск OS, **/dev/sdb** ваш временный диск.  Не используйте основной диск ОС (**/dev/sda**) для чего-либо, кроме операционной системы, так как он оптимизирован для быстрой загрузки виртуальной машины и не обеспечивает высокую производительность при рабочих нагрузках. К виртуальной машине можно подключить один или несколько дисков, чтобы создать постоянное оптимизированное хранилище данных. 

## <a name="adding-disks-for-size-and-performance-targets"></a>Добавление дисков для увеличения размера и производительности
Основываясь на размере VM, вы можете прикрепить до 16 дополнительных дисков на A-Series, 32 диска на D-серии и 64 диска на машине G-Series - каждый до 32 ТБ в размерах. Дополнительные диски добавляются по мере необходимости в зависимости от требований к пространству и количеству операций ввода-вывода. Каждый диск имеет цель производительности 500 IOpдляв для стандартного хранения и до 20 000 IOp на диск для премиум-хранилища.

Для достижения самых высоких IOp s на дисках Premium Storage, где их настройки кэша были установлены либо **readOnly** или **No,** вы должны отключить **барьеры** при монтаже файловой системы в Linux. Барьеры не нужны, так как записи на диски в хранилище класса Premium для этих параметров кэширования являются долговременными.

* Если вы используете систему **reiserFS**, отключите барьеры, используя параметр подключения `barrier=none` (для включения барьеров используйте параметр `barrier=flush`).
* Если вы используете систему **ext3/ext4**, отключите барьеры, используя параметр подключения `barrier=0` (для их включения используйте параметр `barrier=1`).
* Если вы используете систему **XFS**, отключите барьеры, используя параметр подключения `nobarrier` (для их включения используйте параметр `barrier`).

## <a name="unmanaged-storage-account-considerations"></a>Рекомендации по неуправляемой учетной записи хранения
По умолчанию виртуальная машина, созданная с помощью Azure CLI, использует Управляемые диски Azure.  Эти диски полностью контролируются платформой Azure и не требуют никакой подготовки или хранилища.  Для неуправляемых дисков, требующих учетную запись хранения, имеются некоторые дополнительные рекомендации по производительности.  Для получения дополнительной информации об управляемых дисках смотрите [обзор управляемых дисков Azure](../windows/managed-disks-overview.md).  В следующем разделе описываются рекомендации по производительности при использовании неуправляемых дисков.  По умолчанию в качестве решения хранилища мы рекомендуем использовать управляемые диски.

При создании виртуальной машины на базе неуправляемых дисков необходимо подключить диски из учетных записей хранения, находящихся в одном регионе с вашей виртуальной машиной, чтобы обеспечить максимальную близость расположения и свести к минимуму задержки в сети.  Для каждой учетной записи хранилища класса "Стандартный" предусмотрено максимум 20 тысяч операций ввода-вывода и размер до 500 ТБ.  Это соответствует примерно 40 интенсивно используемым дискам, включая диск операционной системы и все созданные диски данных. Для учетных записей хранилища класса Premium нет ограничения на количество операций ввода-вывода, но существует ограничение на размер — 32 ТБ. 

Если вы работаете с большим количеством операций ввода-вывода и выбрали для дисков хранилище уровня "Стандартный", то вам, возможно, потребуется разбить диски на несколько учетных записей хранения, чтобы не достичь ограничения в 20 000 операций ввода-вывода для учетных записей хранения уровня "Стандартный". Виртуальная машина может содержать диски из разных учетных записей хранения различных типов, что позволяет достичь оптимальной конфигурации.
 

## <a name="your-vm-temporary-drive"></a>Временный диск на виртуальной машине
По умолчанию при создании виртуальной машины в Azure предоставляется диск операционной системы (**/dev/sda**) и временный диск (**/dev/sdb**).  Все дополнительные диски, которые вы добавляете, отображаются как **/dev/sdc,** **/dev/sdd,** **/dev/sde** и так далее. Все данные на вашем временном диске **(/dev/sdb)** не долговечны и могут быть потеряны, если конкретные события, такие как VM, повторная, передислокация или техническое обслуживание сил перезагрузки вашего VM.  Размер и тип временного диска зависят от размера виртуальной машины, выбранного во время развертывания. С любой из виртуальных машин уровня "Премиум" (серии DS, G и DS_V2) для временного диска предусмотрен резервный локальный твердотельный накопитель, обеспечивающий дополнительную производительность — до 48 тысяч операций ввода-вывода в секунду. 

## <a name="linux-swap-partition"></a>Раздел Linux Swap
Если виртуальная машина Azure создана из образа Ubuntu или CoreOS, то с помощью CustomData вы можете отправить файл cloud-config в пакет cloud-init. Если вы [передали пользовательский образ Linux](upload-vhd.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json), использующий cloud-init, разделы подкачки также нужно настраивать с помощью cloud-init.

В облачных образах Ubuntu разделы подкачки настраиваются только с помощью cloud-init. Дополнительные сведения см. в статье [AzureSwapPartitions](https://wiki.ubuntu.com/AzureSwapPartitions).

Образы виртуальных машин, которые развернуты из каталога Azure Marketplace и в которых cloud-init не поддерживается, содержат интегрированный в ОС агент виртуальных машин Linux. Этот агент позволяет виртуальной машине взаимодействовать с различными службами Azure. Предположим, что вы развернули стандартный образ из Azure Marketplace. Теперь вам необходимо выполнить указанные ниже действия, чтобы правильно настроить параметры файла подкачки Linux.

Найдите и измените две записи в файле **/etc/waagent.conf** . От них зависит наличие и размер специального файла подкачки. Параметры, которые необходимо проверить, `ResourceDisk.EnableSwap` являются и`ResourceDisk.SwapSizeMB` 

Для включения правильно включенного диска и установленного файла своп убедитесь, что параметры имеют следующие настройки:

* ResourceDisk.EnableSwap=Y
* ResourceDisk.SwapSizeMB={требуемый размер в МБ} 

После внесения изменений необходимо перезапустить waagent или виртуальную машину Linux для отображения этих изменений.  Вы можете убедиться в том, что изменения внесены, а файл подкачки создан, при помощи команды `free` для просмотра свободного пространства. В следующем примере файл подкачки размером 512 МБ создан в результате изменения файла **waagent.conf**.

```bash
azuseruser@myVM:~$ free
            total       used       free     shared    buffers     cached
Mem:       3525156     804168    2720988        408       8428     633192
-/+ buffers/cache:     162548    3362608
Swap:       524284          0     524284
```

## <a name="io-scheduling-algorithm-for-premium-storage"></a>Алгоритм планирования операций ввода-вывода для хранилища класса Premium
С появлением ядра Linux 2.6.18 стандартный алгоритм планирования операций ввода-вывода был изменен с Deadline на CFQ (алгоритм организации полностью равноправных очередей). Если речь идет о моделях операций ввода-вывода с произвольным доступом, между алгоритмами CFQ и Deadline существуют минимальные различия в производительности.  В случае с дисками на основе SSD, в которых модель операций ввода-вывода является преимущественно последовательной, переход обратно на алгоритм NOOP или Deadline позволяет добиться повышения производительности операций ввода-вывода.

### <a name="view-the-current-io-scheduler"></a>Просмотр текущего планировщика операций ввода-вывода
Используйте следующую команду:  

```bash
cat /sys/block/sda/queue/scheduler
```

Вы увидите следующий результат, который указывает тип текущего планировщика.  

```bash
noop [deadline] cfq
```

### <a name="change-the-current-device-devsda-of-io-scheduling-algorithm"></a>Изменение текущего устройства (/dev/sda) алгоритма планирования операций ввода-вывода
Используйте следующие команды:  

```bash
azureuser@myVM:~$ sudo su -
root@myVM:~# echo "noop" >/sys/block/sda/queue/scheduler
root@myVM:~# sed -i 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash elevator=noop"/g' /etc/default/grub
root@myVM:~# update-grub
```

> [!NOTE]
> Применять алгоритм только для устройства **/dev/sda** бесполезно. Задайте его для всех дисков данных, где в модели операций ввода-вывода преобладают последовательные операции.  

Вы должны увидеть следующий вывод, указывающий на то, что **grub.cfg** был успешно перестроен и что планировщик по умолчанию был обновлен до NOOP.  

```bash
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.13.0-34-generic
Found initrd image: /boot/initrd.img-3.13.0-34-generic
Found linux image: /boot/vmlinuz-3.13.0-32-generic
Found initrd image: /boot/initrd.img-3.13.0-32-generic
Found memtest86+ image: /memtest86+.elf
Found memtest86+ image: /memtest86+.bin
done
```

Для семейства дистрибутивов Red Hat необходимо выполнить только приведенную ниже команду.   

```bash
echo 'echo noop >/sys/block/sda/queue/scheduler' >> /etc/rc.local
```

## <a name="using-software-raid-to-achieve-higher-iops"></a>Использование программной конфигурации RAID для увеличения количества операций ввода-вывода
Если для рабочих нагрузок требуется больше операций ввода-вывода, чем может обеспечить один диск, то необходимо использовать программную конфигурацию RAID для нескольких дисков. Поскольку Azure уже выполняет функцию устойчивости диска на уровне локальной структуры, вы можете достичь максимальной производительности, используя конфигурацию с чередованием дисков RAID-0.  Подготовьте и создайте диски в среде Azure, а также подключите их к виртуальной машине Linux до секционирования, форматирования и подключения дисков.  Дополнительные сведения о настройке программного RAID-массива в виртуальной машине Linux в Azure см. в статье **[Настройка программного RAID-массива в Linux](configure-raid.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)**.

В качестве альтернативы традиционной конфигурации RAID можно также установить Logical Volume Manager (LVM), чтобы настроить несколько физических дисков в единый полосатый логический объем хранилища. В этой конфигурации чтения и записи распространяются на несколько дисков, содержащихся в группе громкости (по аналогии с RAID0). Для повышения производительности вам потребуется чередовать логические тома. Это позволит выполнять операции чтения и записи на всех подключенных дисках с данными.  Более подробную информацию о настройке полосатого логического тома на Linux VM в Azure можно найти в **[конфигурации LVM на Linux VM в](configure-lvm.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)** документе Azure.

## <a name="next-steps"></a>Next Steps
Как и при любой оптимизации, до и после каждого изменения необходимо выполнить тесты, чтобы оценить влияние этого изменения.  Оптимизация — это пошаговый процесс, и результаты его будут разными на различных компьютерах в одной и той же среде.  То, что эффективно для одной конфигурации, может не работать в другой.

Полезные ссылки на дополнительные ресурсы:

* [Руководство пользователя агента Linux для Azure](../extensions/agent-linux.md)
* [Настройка программного обеспечения RAID на Linux](configure-raid.md)
