---
title: Запланированные события для виртуальных машин Linux в Azure | Документация Майкрософт
description: Запланируйте события с помощью службы метаданных Azure, для виртуальных машин Linux.
services: virtual-machines-windows, virtual-machines-linux, cloud-services
documentationcenter: ''
author: ericrad
manager: jeconnoc
editor: ''
tags: ''
ms.assetid: ''
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/22/2018
ms.author: ericrad
ms.openlocfilehash: 0831f08eaa3e8e6f6a0d3f68bc50cd927167b7ba
ms.sourcegitcommit: 8fc5f676285020379304e3869f01de0653e39466
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/09/2019
ms.locfileid: "65507928"
---
# <a name="azure-metadata-service-scheduled-events-for-linux-vms"></a>Служба метаданных Azure: подслужба "Запланированные события" для виртуальных машин Linux

Запланированные события — это служба метаданных Azure, которая дает время вашему приложению для подготовки к обслуживанию виртуальной машины. Эта служба предоставляет сведения о предстоящем событии обслуживания (например, о перезагрузке), чтобы приложение могло подготовиться к ним и ограничить перебои в работе. Она доступна для всех типов виртуальных машин Azure, включая PaaS и IaaS (как для Windows, так и для Linux). 

Сведения о запланированных событиях, назначенные в Windows, см. в статье [Служба метаданных Azure. Запланированные события (предварительная версия) для виртуальных машин Windows](../windows/scheduled-events.md).

> [!Note] 
> Служба "Запланированные события" общедоступна во всех регионах Azure. В разделе [Доступность версий в регионах](#version-and-region-availability) вы найдете сведения о последних выпусках.

## <a name="why-use-scheduled-events"></a>Почему необходимо использовать запланированные события?

Во многих приложениях время на подготовку к обслуживанию виртуальной машины может положительно повлиять на их работу. Его можно использовать для выполнения конкретных задач по повышению доступности, надежности и удобства обслуживания: 

- создание контрольных точек и восстановление;
- фильтрация подключений;
- отработка отказа первичной реплики;
- удаление из пула подсистемы балансировки нагрузки;
- ведение журнала событий;
- нормальное завершение работы.

Используя запланированные события, приложение может учесть время, когда будет выполняться техническое обслуживание, и запустить задачи для ограничения его влияния.  

Запланированные события предусматривают события в следующих случаях:

- [Обслуживание, инициированное платформой](https://docs.microsoft.com/azure/virtual-machines/linux/maintenance-and-updates) (например, виртуальной Машины перезагрузка, динамической миграции или обновлений для узла с сохранением содержимого памяти)
- Снижение оборудования
- обслуживание, инициированное пользователем (например, пользователь перезагружает или повторно развертывает виртуальную машину).
- [Вытеснение виртуальных Машин с низким приоритетом](https://azure.microsoft.com/blog/low-priority-scale-sets) на шкале задает

## <a name="the-basics"></a>Основы  

  Служба метаданных предоставляет сведения о работающих виртуальных машинах с помощью конечной точки REST, которая доступна из виртуальной машины. Эта информация предоставляется через немаршрутизируемый IP-адрес, то есть она недоступна вне виртуальной машины.

### <a name="scope"></a>`Scope`
Запланированные события доставляются:

- Автономные виртуальные машины.
- всем виртуальным машинам в облачной службе;
- всем виртуальным машинам в группе доступности;
- всем виртуальным машинам в группе размещения масштабируемого набора. 

Поэтому проверьте поле `Resources` в событии, чтобы определить, какие виртуальные машины затронуты.

### <a name="endpoint-discovery"></a>Обнаружение конечной точки
Для виртуальных машин с поддержкой виртуальной сети служба метаданных доступна со статического немаршрутизируемого IP-адреса, `169.254.169.254`. Полная конечная точка для последней версии службы "Запланированные события" выглядит так: 

 > `http://169.254.169.254/metadata/scheduledevents?api-version=2017-11-01`

Если виртуальная машина не создается в виртуальной сети, что является стандартным сценарием для облачных служб и классических виртуальных машин, для обнаружения используемого IP-адреса требуется дополнительная логика. Чтобы узнать, как [выполнить обнаружение конечной точки узла](https://github.com/azure-samples/virtual-machines-python-scheduled-events-discover-endpoint-for-non-vnet-vm), просмотрите этот пример.

### <a name="version-and-region-availability"></a>Доступность версий в регионах
Служба запланированных событий имеет версии. Версии являются обязательными. Сейчас используется версия от `2017-11-01`.

| Version | Тип выпуска | регионы | Заметки о выпуске | 
| - | - | - | - | 
| 2017-11-01 | Общедоступная версия | Все | <li> Добавлена поддержка для виртуальной Машины с низким приоритетом вытеснения EventType «Preempt»<br> | 
| 2017-08-01 | Общедоступная версия | Все | <li> Удалено подчеркивание перед именами ресурсов для виртуальных машин IaaS.<br><li>Требование заголовка метаданных принудительно применяется для всех запросов. | 
| 2017-03-01 | Предварительный просмотр | Все | <li>Первый выпуск


> [!NOTE] 
> В предыдущих выпусках предварительной версии в качестве версии API поддерживалось значение {latest}. Этот формат больше не поддерживается и в дальнейшем будет считаться устаревшим.

### <a name="enabling-and-disabling-scheduled-events"></a>Включение и выключение службы "Запланированные события"
Служба "Запланированные события" включается для вашей службы, когда вы впервые запрашиваете события. При первом вызове возможна задержка ответа до двух минут.

Служба "Запланированные события" выключается для вашей службы, если она не отправляет запросы в течение 24 часов.

### <a name="user-initiated-maintenance"></a>Обслуживание, инициированное пользователем
Обслуживание виртуальных машин, инициированное пользователем на портале Azure, в API, Azure CLI или PowerShell, приведет к созданию запланированных событий. Затем можно протестировать логику подготовки обслуживания в вашем приложении, а также его можно подготовить к обслуживанию, инициированному пользователем.

При перезагрузке виртуальной машины событие с типом `Reboot` добавляется в расписание. При повторном развертывании виртуальной машины событие с типом `Redeploy` добавляется в расписание.

## <a name="use-the-api"></a>Использование API

### <a name="headers"></a>Заголовки
При запросе службы метаданных необходимо указать заголовок `Metadata:true`, чтобы удостовериться, что он не был случайно перенаправлен. Заголовок `Metadata:true` является обязательным для всех запросов запланированных событий. Невозможность включить заголовок в запрос приведет к ответу службы метаданных "Ошибка запроса".

### <a name="query-for-events"></a>Запрос сведений о событиях
Чтобы получить сведения о запланированных событиях, выполните следующий вызов.

#### <a name="bash"></a>Bash
```
curl -H Metadata:true http://169.254.169.254/metadata/scheduledevents?api-version=2017-08-01
```

Ответ содержит массив запланированных событий. Пустой массив означает, что сейчас запланированных событий нет.
Если передаются запланированные события, массив событий в ответе выглядит так: 
```
{
    "DocumentIncarnation": {IncarnationID},
    "Events": [
        {
            "EventId": {eventID},
            "EventType": "Reboot" | "Redeploy" | "Freeze" | "Preempt",
            "ResourceType": "VirtualMachine",
            "Resources": [{resourceName}],
            "EventStatus": "Scheduled" | "Started",
            "NotBefore": {timeInUTC},              
        }
    ]
}
```

### <a name="event-properties"></a>Свойства события
|Свойство  |  Описание |
| - | - |
| EventId | Глобальный уникальный идентификатор этого события. <br><br> Пример: <br><ul><li>602d9444-d2cd-49c7-8624-8643e7171297  |
| EventType | Влияние, которое оказывает это событие. <br><br> Значения: <br><ul><li> `Freeze`: Виртуальная машина будет приостановлена на несколько секунд. ЦП и подключения к сети может быть приостановлен, но это действие не повлияет на память и открытых файлов.<li>`Reboot`: планирование перезагрузки виртуальной машины (временная память будет потеряна). <li>`Redeploy`: виртуальная машина будет перемещена на другой узел с потерей данных на временных дисках. <li>`Preempt`: Низкоприоритетная виртуальная машина удаляется (временные диски будут утрачены).|
| ResourceType | Тип ресурса, который затрагивает это событие. <br><br> Значения: <ul><li>`VirtualMachine`|
| Ресурсы| Список ресурсов, на которые влияет это событие. Список обязательно будет содержать виртуальные машины максимум из одного [домена обновления](manage-availability.md), но в нем не могут содержаться все машины из такого домена. <br><br> Пример: <br><ul><li> ["FrontEnd_IN_0", "BackEnd_IN_0"] |
| EventStatus | Состояние этого события. <br><br> Значения: <ul><li>`Scheduled`: это запланированное событие состоится по истечении времени, указанного в свойстве `NotBefore`.<li>`Started`: это событие запущено.</ul> Состояние `Completed` (или аналогичное) никогда не предоставляется. После завершения событие не повторяется.
| NotBefore| Время, после которого это событие может состояться. <br><br> Пример: <br><ul><li> Пн, 19 сентября 2016 г., 18:29:47 (GMT)  |

### <a name="event-scheduling"></a>Планирование события
В зависимости от типа каждое будущее событие будет выполняться минимальное количество времени. Это время отражается в свойстве события `NotBefore`. 

|EventType  | Минимальное время уведомления |
| - | - |
| Freeze| 15 минут |
| Перезагрузить | 15 минут |
| Повторить развертывание | 10 минут |
| Прерывание | 30 секунд |

### <a name="start-an-event"></a>Запуск события 

После того, как вы узнали о предстоящем событии и завершили все действия для корректного завершения работы, вы можете утвердить ожидающее событие, выполнив вызов `POST` к службе метаданных Azure с помощью `EventId`. Этот вызов указывает службе Azure, что она может сократить минимальное время уведомления (если возможно). 

Следующий пример кода JSON ожидается в тексте запроса `POST`. Запрос должен содержать список `StartRequests`. Каждый `StartRequest` содержит `EventId` для события, которое нужно ускорить:
```
{
    "StartRequests" : [
        {
            "EventId": {EventId}
        }
    ]
}
```

#### <a name="bash-sample"></a>Пример Bash
```
curl -H Metadata:true -X POST -d '{"StartRequests": [{"EventId": "f020ba2e-3bc0-4c40-a10b-86575a9eabd5"}]}' http://169.254.169.254/metadata/scheduledevents?api-version=2017-11-01
```

> [!NOTE] 
> Подтверждение событий позволяет выполнить событие для всех ресурсов `Resources` в событии, а не только для виртуальной машины, которая подтверждает событие. Таким образом, можно выбрать "лидера" для координации подтверждения, например первую виртуальную машину в поле `Resources`.

## <a name="python-sample"></a>Пример на языке Python 

В следующем примере выполняется запрос запланированных событий в службе метаданных, а затем утверждение каждого ожидающего события.

```python
#!/usr/bin/python

import json
import urllib2
import socket
import sys

metadata_url = "http://169.254.169.254/metadata/scheduledevents?api-version=2017-11-01"
headers = "{Metadata:true}"
this_host = socket.gethostname()

def get_scheduled_events():
   req = urllib2.Request(metadata_url)
   req.add_header('Metadata', 'true')
   resp = urllib2.urlopen(req)
   data = json.loads(resp.read())
   return data

def handle_scheduled_events(data):
    for evt in data['Events']:
        eventid = evt['EventId']
        status = evt['EventStatus']
        resources = evt['Resources']
        eventtype = evt['EventType']
        resourcetype = evt['ResourceType']
        notbefore = evt['NotBefore'].replace(" ","_")
        if this_host in resources:
            print "+ Scheduled Event. This host " + this_host + " is scheduled for " + eventtype + " not before " + notbefore
            # Add logic for handling events here


def main():
   data = get_scheduled_events()
   handle_scheduled_events(data)

if __name__ == '__main__':
  main()
  sys.exit(0)
```

## <a name="next-steps"></a>Дальнейшие действия 
- Смотрите демонстрационную версию службы "Запланированные события" в серии [Пятница с Azure](https://channel9.msdn.com/Shows/Azure-Friday/Using-Azure-Scheduled-Events-to-Prepare-for-VM-Maintenance). 
- Просмотрите примеры кода запланированных событий в статье [Azure Metadata Service: Scheduled Events Samples](https://github.com/Azure-Samples/virtual-machines-scheduled-events-discover-endpoint-for-non-vnet-vm) (Служба метаданных Azure: примеры запланированных событий).
- Дополнительные сведения об API, доступных в [службе метаданных экземпляра](instance-metadata-service.md).
- Подробнее о [плановом обслуживании виртуальных машин Linux в Azure](planned-maintenance.md).
