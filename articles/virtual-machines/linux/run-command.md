---
title: Выполнение сценариев оболочки на виртуальной машине Linux в Azure
description: В этом разделе описывается, как выполнять скрипты в виртуальной машине Azure под управлением Linux с помощью функции "выполнить команду".
services: automation
ms.service: virtual-machines
author: bobbytreed
ms.author: robreed
ms.date: 04/26/2019
ms.topic: article
manager: carmonm
ms.openlocfilehash: 80fc33a93d4d83dad1e687b176b39728fc7e8807
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81758602"
---
# <a name="run-shell-scripts-in-your-linux-vm-by-using-run-command"></a>Выполнение сценариев оболочки на виртуальной машине Linux с помощью команды Run

Функция "выполнить команду" использует агент виртуальной машины для выполнения сценариев оболочки на виртуальной машине Azure под управлением Linux. Эти скрипты можно использовать для общего управления компьютерами или приложениями. Они могут помочь вам быстро диагностировать и исправлять проблемы доступа к виртуальной машине и сети, а также восстановить работоспособность виртуальной машины.

## <a name="benefits"></a>Преимущества

Доступ к виртуальным машинам можно получить несколькими способами. Команда Run позволяет удаленно запускать скрипты на виртуальных машинах с помощью агента виртуальной машины. Выполните команду Run с помощью портал Azure, [REST API](/rest/api/compute/virtual%20machines%20run%20commands/runcommand)или [Azure CLI](/cli/azure/vm/run-command?view=azure-cli-latest#az-vm-run-command-invoke) для виртуальных машин Linux.

Эта возможность полезна во всех сценариях, где требуется выполнить сценарий на виртуальной машине. Это один из способов устранения неполадок и исправления виртуальной машины, на которой не открыт порт RDP или SSH из-за неправильной настройки сети или пользователя с правами администратора.

## <a name="restrictions"></a>Ограничения

При использовании команды Run действуют следующие ограничения.

* Выходные данные ограничены последними 4 096 байтами.
* Минимальное время выполнения сценария составляет примерно 20 секунд.
* Скрипты запускаются по умолчанию в качестве привилегированного пользователя в Linux.
* Можно запустить один сценарий за раз.
* Скрипты, которые запрашивают сведения (в интерактивном режиме), не поддерживаются.
* Невозможно отменить выполняющийся сценарий.
* Максимальное время выполнения скрипта составляет 90 минут. После этого время ожидания скрипта истечет.
* Чтобы вернуть результаты скрипта, требуется разрешить исходящие подключения из виртуальной машины.

> [!NOTE]
> Для правильной работы для выполнения команды требуется подключение (порт 443) к общедоступным IP-адресам Azure. Если у расширения нет доступа к этим конечным точкам, скрипты могут выполняться успешно, но не будут возвращать результаты. Если вы блокируете трафик на виртуальной машине, вы можете использовать [теги службы](../../virtual-network/security-overview.md#service-tags) , чтобы разрешить трафик в общедоступные IP-адреса Azure `AzureCloud` с помощью тега.

## <a name="available-commands"></a>Доступные команды

В этой таблице представлен список команд, доступных для виртуальных машин Linux. Для выполнения любого пользовательского скрипта можно использовать команду **руншеллскрипт** . При использовании Azure CLI или PowerShell для выполнения команды значение, указанное для параметра `--command-id` или `-CommandId` , должно быть одним из приведенных ниже значений. При указании значения, которое не является доступной командой, появляется следующее сообщение об ошибке:

```error
The entity was not found in this Azure location
```

|**Имя**|**Описание**|
|---|---|
|**RunShellScript**|Запускает сценарий оболочки Linux.|
|**ifconfig**| Возвращает конфигурацию всех сетевых интерфейсов.|

## <a name="azure-cli"></a>Azure CLI

В следующем примере используется команда [AZ VM Run-Command](/cli/azure/vm/run-command?view=azure-cli-latest#az-vm-run-command-invoke) для запуска сценария оболочки на виртуальной машине Linux в Azure.

```azurecli-interactive
az vm run-command invoke -g myResourceGroup -n myVm --command-id RunShellScript --scripts "sudo apt-get update && sudo apt-get install -y nginx"
```

> [!NOTE]
> Чтобы выполнить команды от имени другого пользователя, введите `sudo -u` , чтобы указать учетную запись пользователя.

## <a name="azure-portal"></a>Портал Azure

Перейдите к виртуальной машине в [портал Azure](https://portal.azure.com) и выберите **команду выполнить** в разделе **операции**. Отобразится список доступных команд для выполнения на виртуальной машине.

![Список команд](./media/run-command/run-command-list.png)

Выберите команду для запуска. Некоторые команды могут содержать необязательные или обязательные входные параметры. Для этих команд параметры представляются как текстовые поля для предоставления входных значений. Для каждой команды можно просмотреть скрипт, который выполняется путем развертывания **скрипта просмотра**. **Руншеллскрипт** отличается от других команд, так как позволяет предоставить собственный пользовательский скрипт.

> [!NOTE]
> Встроенные команды не редактируются.

После выбора команды выберите **выполнить** , чтобы запустить скрипт. После завершения скрипта он возвращает выходные данные и все ошибки в окне вывода. На следующем снимке экрана показан пример вывода команды запуска **ifconfig**.

![Вывод сценария команды запуска](./media/run-command/run-command-script-output.png)

### <a name="powershell"></a>PowerShell

В следующем примере командлет [Invoke-азвмрункомманд](https://docs.microsoft.com/powershell/module/az.compute/invoke-azvmruncommand) используется для запуска сценария PowerShell на виртуальной машине Azure. Этот командлет ожидает, что скрипт, указанный в параметре `-ScriptPath`, расположен в локальной среде, в которой выполняется командлет.

```powershell-interactive
Invoke-AzVMRunCommand -ResourceGroupName '<myResourceGroup>' -Name '<myVMName>' -CommandId 'RunPowerShellScript' -ScriptPath '<pathToScript>' -Parameter @{"arg1" = "var1";"arg2" = "var2"}
```

## <a name="limiting-access-to-run-command"></a>Ограничение доступа к команде запуска

Для получения списка команд выполнения или отображения сведений о команде требуется `Microsoft.Compute/locations/runCommands/read` разрешение на уровне подписки. Это разрешение имеет встроенную роль [читателя](../../role-based-access-control/built-in-roles.md#reader) и более высокие уровни.

Для выполнения команды требуется `Microsoft.Compute/virtualMachines/runCommand/action` разрешение на уровне подписки. Это разрешение имеют роль [участника виртуальной машины](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) и более высокие уровни.

Можно использовать одну из [встроенных ролей](../../role-based-access-control/built-in-roles.md) или создать [настраиваемую роль](../../role-based-access-control/custom-roles.md) для использования команды Run.

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о других способах удаленного выполнения сценариев и команд в виртуальной машине см. в статье [Запуск сценариев на виртуальной машине Linux](run-scripts-in-vm.md).
