---
title: Руководство по мониторингу и обновлению виртуальных машин Linux в Azure | Документация Майкрософт
description: В этом руководство описано, как выполнять мониторинг диагностических данных загрузки, метрик производительности и администрирование пакетных обновлений на виртуальных машинах Linux.
services: virtual-machines-linux
documentationcenter: virtual-machines
author: cynthn
manager: gwallace
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 01/26/2019
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: 1c83cd869142967b358aa5d234d7d487b3c54b4c
ms.sourcegitcommit: 6cff17b02b65388ac90ef3757bf04c6d8ed3db03
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2019
ms.locfileid: "68607986"
---
# <a name="tutorial-monitor-and-update-a-linux-virtual-machine-in-azure"></a>Руководство по Мониторинг и обновление виртуальных машин Linux в Azure

Чтобы убедиться в правильной работе виртуальных машин в Azure, можно просмотреть диагностические данные загрузки, метрики производительности и управлять пакетами обновлений. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине.
> * Просмотр диагностики загрузки
> * Просмотр метрик узла.
> * Включение расширения системы диагностики на виртуальной машине.
> * Просмотр метрик виртуальной машины.
> * Создание оповещений на основе метрик диагностики.
> * Управление пакетами обновлений
> * Мониторинг изменений и инвентаризация
> * Настройка расширенного мониторинга

[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать интерфейс командной строки локально, то для работы с этим руководством вам понадобится Azure CLI 2.0.30 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli).

## <a name="create-vm"></a>Создание виртуальной машины

Чтобы увидеть данные диагностики и метрики в действии, необходима виртуальная машина. Сначала создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az-group-create). В следующем примере создается группа ресурсов с именем *myResourceGroupMonitor* в расположении *eastus*.

```azurecli-interactive
az group create --name myResourceGroupMonitor --location eastus
```

Теперь создайте виртуальную машину командой [az vm create](/cli/azure/vm#az-vm-create). В следующем примере создаются виртуальная машина с именем *myVM* и ключи SSH, если они не существуют в каталоге *~/.ssh/* .

```azurecli-interactive
az vm create \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

## <a name="enable-boot-diagnostics"></a>Включение диагностики загрузки

Во время загрузки виртуальных машин Linux расширение системы диагностики записывает выходные данные загрузки и сохраняет их в хранилище Azure. Эти данные можно использовать для устранения неполадок загрузки виртуальной машины. При создании виртуальной машины Linux с помощью Azure CLI диагностика загрузки не включается автоматически.

Перед включением диагностики загрузки необходимо создать учетную запись хранения для хранения журналов загрузки. Имена учетных записей хранения должны быть глобально уникальными, иметь длину от 3 до 24 символов и содержать только цифры и буквы в нижнем регистре. Создайте учетную запись хранения с помощью команды [az storage account create](/cli/azure/storage/account#az-storage-account-create). В этом примере для создания уникального имени учетной записи хранения используется случайная строка.

```azurecli-interactive
storageacct=mydiagdata$RANDOM

az storage account create \
  --resource-group myResourceGroupMonitor \
  --name $storageacct \
  --sku Standard_LRS \
  --location eastus
```

При включении диагностики загрузки необходим URI контейнера хранилища BLOB-объектов. Следующая команда запрашивает URI учетной записи хранения. Значение URI хранится в именах переменных *bloburi*, которые используются на следующем шаге.

```azurecli-interactive
bloburi=$(az storage account show --resource-group myResourceGroupMonitor --name $storageacct --query 'primaryEndpoints.blob' -o tsv)
```

Включите диагностику загрузки с помощью команды [az vm boot-diagnostics enable](https://docs.microsoft.com/cli/azure/vm/boot-diagnostics#az-vm-boot-diagnostics-enable). Значение `--storage` — это URI BLOB-объекта, полученный на предыдущем шаге.

```azurecli-interactive
az vm boot-diagnostics enable \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --storage $bloburi
```

## <a name="view-boot-diagnostics"></a>Просмотр диагностики загрузки

Если включена диагностика загрузки, каждый раз при остановке и запуске виртуальной машины сведения о процессе загрузки записываются в файл журнала. В этом примере сначала освободите виртуальную машину с помощью команды [az vm deallocate](/cli/azure/vm#az-vm-deallocate) следующим образом:

```azurecli-interactive
az vm deallocate --resource-group myResourceGroupMonitor --name myVM
```

Теперь запустите виртуальную машину с помощью команды [az vm start]( /cli/azure/vm#az-vm-stop) следующим образом:

```azurecli-interactive
az vm start --resource-group myResourceGroupMonitor --name myVM
```

Данные диагностики загрузки для *myVM* можно получить с помощью команды [az vm boot-diagnostics get-boot-log](https://docs.microsoft.com/cli/azure/vm/boot-diagnostics#az-vm-boot-diagnostics-get-boot-log) следующим образом:

```azurecli-interactive
az vm boot-diagnostics get-boot-log --resource-group myResourceGroupMonitor --name myVM
```

## <a name="view-host-metrics"></a>Просмотр метрик узла

Виртуальная машина Linux имеет выделенный узел в Azure, с которым она взаимодействует. Метрики узла собираются автоматически и их можно просмотреть на портале Azure следующим образом:

1. На портале Azure выберите **Группы ресурсов**, щелкните **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
1. Чтобы увидеть, как работает узел виртуальной машины, в окне виртуальной машины выберите **Метрики**, а затем щелкните любую метрику узла *[Host]* в группе **Доступные метрики**.

    ![Просмотр метрик узла.](./media/tutorial-monitoring/monitor-host-metrics.png)

## <a name="install-diagnostics-extension"></a>Установка расширения диагностики

По умолчанию доступны основные метрики узла. Чтобы просмотреть более детальные метрики определенной виртуальной машины, на ней нужно установить расширение системы диагностики Azure, Расширение Диагностики Azure позволяет получать дополнительные данные мониторинга и диагностики виртуальной машины. С помощью этих метрик производительности можно создать уведомления с учетом работы виртуальной машины. Расширение системы диагностики устанавливается на портале Azure следующим образом:

1. На портале Azure последовательно выберите **Группы ресурсов**, **myResourceGroupMonitor** и **myVM** в списке ресурсов.
1. Щелкните **Параметры диагностики**. В раскрывающемся меню *выбора учетной записи хранения* выберите созданную в предыдущем разделе учетную запись *mydiagdata[1234]* , если она еще не выбрана.
1. Нажмите кнопку **Включить мониторинг на гостевом уровне**.

    ![Просмотр метрик диагностики](./media/tutorial-monitoring/enable-diagnostics-extension.png)

## <a name="view-vm-metrics"></a>Просмотр метрик виртуальной машины.

Метрики виртуальной машины можно просмотреть аналогично метрикам узла виртуальной машины:

1. На портале Azure последовательно выберите **Группы ресурсов**, **myResourceGroupMonitor** и **myVM** в списке ресурсов.
1. Чтобы увидеть, как работает виртуальная машина, в окне виртуальной машины выберите **Метрики**, а затем выберите любую метрику диагностики *[Guest]* в группе **Доступные метрики**.

    ![Просмотр метрик виртуальной машины.](./media/tutorial-monitoring/monitor-vm-metrics.png)

## <a name="create-alerts"></a>Создание оповещений

На основе метрик производительности можно создавать оповещения. Например, оповещения можно использовать для уведомления о том, что средняя загрузка ЦП превышает пороговое значение или свободное место на диске ниже определенного значения. Оповещения отображаются на портале Azure или могут быть отправлены по электронной почте. Вы также можете активировать модули Runbook службы автоматизации Azure или Azure Logic Apps в ответ на создаваемые оповещения.

В следующем примере создается предупреждение на основе среднего показателя использования ЦП.

1. На портале Azure последовательно выберите **Группы ресурсов**, **myResourceGroupMonitor**, а затем **myVM** в списке ресурсов.
2. Выберите **Оповещения (классические)** , а затем щелкните **Добавить оповещение метрики (классическое)** в верхней части окна оповещений.
3. Укажите **имя** оповещения, например *myAlertRule*.
4. Для активации оповещения о превышении процента использования ЦП на 1.0 в течение пяти минут оставьте все настройки по умолчанию.
5. При необходимости установите флажок возле параметра *Участники, читатели и владельцы электронной почты* для отправки уведомлений по электронной почте. Действие по умолчанию — предоставлять уведомления на портале.
6. Нажмите кнопку **ОК**.

## <a name="manage-software-updates"></a>Управление обновлениями программного обеспечения

Управление обновлениями позволяет управлять обновлениями и исправлениями виртуальных машин Azure на базе Linux.
Напрямую из виртуальной машины можно быстро оценить состояние доступных обновлений, назначить время установки необходимых обновлений и проверить результаты развертывания, чтобы убедиться, что обновления на виртуальной машине были успешно применены.

Сведения о ценах см. на странице [цены на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

### <a name="enable-update-management"></a>Включение управления обновлениями

Включение управления обновлениями для виртуальной машины:

1. В левой части экрана выберите **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На экране виртуальной машины в разделе **Операции** выберите **Управление обновлениями**. Откроется экран **Enable Update management** (Включение управления обновлениями).

Проверка выполняется, чтобы определить, включено ли управление обновлениями для этой виртуальной машины.
При этом проверяется рабочая область Log Analytics и связанная учетная запись службы автоматизации, а также наличие решения в рабочей области.

Рабочая область [Log Analytics](../../log-analytics/log-analytics-overview.md) используется для сбора данных, созданных компонентами и службами, такими как "Управление обновлениями".
Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.
Для выполнения дополнительных действий на виртуальных машинах, требующих обновления, служба автоматизации Azure позволяет выполнять runbook на виртуальных машинах, например для скачивания и применения обновлений.

В процессе проверки также определяется, была ли виртуальная машина подготовлена с помощью агента Log Analytics и гибридной рабочей роли службы автоматизации. Агент позволяет взаимодействовать с виртуальной машиной и получать сведения о состоянии обновления.

Чтобы включить решение, выберите рабочую область Log Analytics и учетную запись службы автоматизации, а затем щелкните **Включить**. Процесс включения решения может занять до 15 минут.

Если во время подключения обнаружится, что отсутствует один из следующих компонентов, он будет автоматически добавлен.

* [Рабочая область Log Analytics](../../log-analytics/log-analytics-overview.md).
* [Учетная запись службы автоматизации](../../automation/automation-offering-get-started.md)
* [Гибридная рабочая роль runbook](../../automation/automation-hybrid-runbook-worker.md) включена на виртуальной машине.

Откроется экран **Управление обновлениями**. Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем щелкните **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации.

![Включение решения по управлению обновлениями](./media/tutorial-monitoring/manage-updates-update-enable.png)

Включение решения может занять до 15 минут. В это время не закрывайте окно браузера. После того как решение включено, сведения об отсутствующих обновлениях на виртуальной машине передаются в журналы Azure Monitor. На получение данных для анализа может уйти от 30 минут до 6 часов.

### <a name="view-update-assessment"></a>Просмотр оценок обновления

После включения решения **Управление обновлениями** отобразится экран **Управление обновлениями**. После оценки обновлений вы увидите список отсутствующих обновлений на вкладке **Отсутствующие обновления**.

 ![Просмотр состояния обновления](./media/tutorial-monitoring/manage-updates-view-status-linux.png)

### <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

Чтобы установить обновления, составьте план развертывания в рамках графика выпуска и периода обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

Новое развертывание обновления для виртуальной машины можно запланировать, щелкнув **Schedule update deployment** (Планирование развертывания обновления) в верхней части экрана **Update management** (Управление обновлениями). На экране **New update deployment** (Новое развертывание обновлений) укажите следующие сведения:

Чтобы создать развертывание обновления, выберите **Запланировать развертывание обновлений**. Откроется панель **Новое развертывание обновления**. Введите значения для свойств, описанных в следующей таблице и нажмите **Создать**:

| Свойство | Описание |
| --- | --- |
| ИМЯ |Уникальное имя для идентификации развертывания обновлений. |
|Операционная система| Windows или Linux|
| Группы для обновления |Для виртуальных машин Azure определите запрос на основе сочетания подписки, группы ресурсов, расположения и тегов, чтобы создать динамическую группу виртуальных машин Azure и добавить их в развертывание. </br></br>Для других виртуальных машин выберите сохраненный поисковый запрос, чтобы выбрать такие виртуальные машины и добавить их в развертывание. </br></br>Дополнительные сведения см. в статье [о динамических группах](../../automation/automation-update-management.md#using-dynamic-groups).|
| Компьютеры, на которые нужно установить обновления |Щелкните "Сохраненные условия поиска", "Импортировать группу" или выберите "Компьютер" в раскрывающемся списке и выберите нужные компьютеры. Если выберете **Компьютеры**, готовность к обновлению будет показана в столбце **Готовность к обновлению агента**.</br> Дополнительные сведения о различных способах создания групп компьютеров в журналах Azure Monitor см. в статье [Группы компьютеров в запросах к журналам Azure Monitor](../../azure-monitor/platform/computer-groups.md). |
|Классификации обновлений|Выберите все необходимые категории обновления.|
|Включение или исключение обновлений|Позволяет открыть страницу **Включить или исключить**. Обновления, которые можно включить или исключить, находятся на отдельных вкладках. Дополнительные сведения об обработке исключений см. в разделе о [поведении включения](../../automation/automation-update-management.md#inclusion-behavior). |
|Параметры расписания|Выберите время запуска, а затем — однократное применение или повторяющееся.|
| Сценарии предварительного и последующего выполнения|Выберите сценарии, которые будут выполняться до и после развертывания|
| Период обслуживания |Количество минут, установленное для обновлений. Значение должно составлять не менее 30 минут, но не более 6 часов |
| Перезагрузка элемента управления| Определяет, как следует выполнять перезагрузку. Доступные параметры:</br>Перезагрузка при необходимости (по умолчанию)</br>Всегда выполнять перезагрузку</br>Никогда не перезагружать</br>Только перезагрузка без установки обновлений.|

Развертывания обновлений также можно создать программно. Чтобы узнать, как создать развертывание обновлений с помощью REST API, ознакомьтесь со статьей [Software Update Configurations — Create](/rest/api/automation/softwareupdateconfigurations/create) (Конфигурации обновления программного обеспечения. Создание). Кроме того, имеется пример модуля runbook, который можно использовать для создания развертывания еженедельного обновления. Дополнительные сведения об этом модуле runbook см. в статье [Create a weekly update deployment for one or more VMs in a resource group](https://gallery.technet.microsoft.com/scriptcenter/Create-a-weekly-update-2ad359a1) (Создание развертывания еженедельного обновления для одной или нескольких виртуальных машин в группе ресурсов).

Завершив настройку расписания, нажмите кнопку **Создать** и вернитесь к панели мониторинга состояния.
Обратите внимание, что таблица **Запланирован** показывает созданное расписание развертываний.

### <a name="view-results-of-an-update-deployment"></a>Просмотр результатов развертывания обновлений

После запуска запланированного развертывания вы можете контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**.
Если оно выполняется в данный момент, отображается состояние **Выполнение**. При успешном завершении появится состояние **Выполнено**.
В случае сбоя одного или нескольких обновлений в развертывании для состояния будет установлено значение **Частичный сбой**.
Выберите завершенное развертывание обновлений, чтобы просмотреть панель мониторинга для него.

![Панель мониторинга состояния развертывания обновлений конкретного развертывания](./media/tutorial-monitoring/manage-updates-view-results.png)

Плитка **Update results** (Результаты обновления) является сводкой общего количества обновлений и результатов развертывания на виртуальной машине.
В таблице справа представлен подробный разбор каждого обновления и результатов установки, которые могут принимать одно из следующих значений:

* **Not attempted** (Попытка не предпринималась). Обновление не установлено из-за недостатка времени в связи с заданной длительностью окна обслуживания.
* **Выполнено.** Обновление было успешно выполнено.
* **Сбой.** Обновление не удалось выполнить.

Чтобы просмотреть все записи журнала, созданные при этом развертывании, щелкните **Все журналы**.

Щелкните плитку **Вывод**, чтобы просмотреть поток заданий для модуля runbook, который управляет развертыванием обновления на целевой виртуальной машине.

Чтобы просмотреть подробные сведения об ошибках развертывания, выберите **Ошибки**.

## <a name="monitor-changes-and-inventory"></a>Мониторинг изменений и инвентаризация

Вы можете собирать и просматривать сведения об установленных на компьютерах программном обеспечении, файлах, управляющих программах, службах и разделах реестра Windows. Отслеживание конфигураций поможет вам локализовать операционные проблемы в любом сегменте среды и получить сведения о текущем состоянии компьютеров.

### <a name="enable-change-and-inventory-management"></a>Включение управления изменениями и инвентаризацией

Включите управление изменениями и инвентаризацией для виртуальной машины следующим образом:

1. В левой части экрана выберите **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На экране виртуальной машины в разделе **Операции** выберите **Инвентаризация** или **Отслеживание изменений**. Откроется экран **Отслеживание изменений и инвентаризация**.

Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем щелкните **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации. Эти решения представлены в меню отдельно, но по сути являются одним решением. Включение любого из них активирует для виртуальной машины оба решения.

![Включение отслеживания для изменений и инвентаризации](./media/tutorial-monitoring/manage-inventory-enable.png)

После включения потребуется некоторое время, пока будут собраны и отображены данные инвентаризации для виртуальной машины.

### <a name="track-changes"></a>Отслеживание изменений

На виртуальной машине в разделе **Операции** выберите **Отслеживание изменений**. Щелкните **Изменение параметров**, чтобы открыть страницу **Отслеживание изменений**. Выберите тип настроек, которые вы намерены отслеживать, и щелкните **+ Добавить** для настройки параметров. Для Linux доступен параметр **Файлы Linux**.

Подробные сведения об отслеживании изменений см. в статье [Устранение неполадок при изменениях в среде](../../automation/automation-tutorial-troubleshoot-changes.md).

### <a name="view-inventory"></a>Просмотр данных инвентаризации

На виртуальной машине в разделе **Операции** выберите **Учет**. На вкладке **Программное обеспечение** вы найдете таблицу со списком обнаруженного программного обеспечения. В таблице предоставляются обобщенные сведения о каждой строке с информацией о программном обеспечении. Здесь для программного обеспечения указываются: имя, версия, издатель, время последнего обновления.

![Просмотр данных инвентаризации](./media/tutorial-monitoring/inventory-view-results.png)

### <a name="monitor-activity-logs-and-changes"></a>Мониторинг журналов действий и изменений

На странице **Отслеживание изменений** на виртуальной машине выберите **Управление подключением журнала действий**. Эта операция открывает страницу **Журнал действий Azure**. Выберите **Подключить**, чтобы подключить журнал действий Azure для виртуальной машины к службе отслеживания изменений.

Включив этот параметр, перейдите к странице **Обзор** для виртуальной машины и выберите действие **Остановить**, чтобы остановить виртуальную машину. Подтвердите остановку, выбрав **Да** при появлении соответствующего запроса. Когда освобождение виртуальной машины завершится, выберите **Запустить**, чтобы снова запустить ее.

Остановка и запуск виртуальной машины регистрируются как события в журнале действий. Вернитесь к странице **Отслеживание изменений**. Выберите вкладку **События** в нижней части страницы. Через некоторое время события отобразятся на диаграмме и в таблице. Вы можете выбрать любое из этих событий, чтобы просмотреть подробные сведения о нем.

![Просмотр изменений в журнале действий](./media/tutorial-monitoring/manage-activitylog-view-results.png)

Здесь отображаются изменения, произошедшие за определенное время. Когда вы добавите соединение с журналом действий, график в верхней части отобразит события из журнала действий Azure. Каждая строка гистограммы соответствует определенному типу отслеживаемых изменений. К этим типам относятся управляющие программы Linux, файлы и программное обеспечение. Вкладка "Изменения" отображает сведения об изменениях, отсортированные по времени в обратном порядке (первыми показаны самые последние).

## <a name="advanced-monitoring"></a>Расширенный мониторинг

Вы можете использовать функции расширенного мониторинга виртуальных машин, предоставляемые такими решениями, как [Azure Monitor для виртуальных машин](../../azure-monitor/insights/vminsights-overview.md). Это решение отслеживает виртуальные машины Azure (Windows и Linux) в нужном масштабе, анализируя их производительность и работоспособность, а также оценивая разные процессы и взаимосвязанные зависимости от других ресурсов и внешних процессов. Управление конфигурацией виртуальных машин Azure можно осуществлять с помощью решения для отслеживания изменений и инвентаризации [службы автоматизации Azure](../../automation/automation-intro.md), чтобы быстро обнаруживать изменения в вашем окружении. Управление поддержкой обновлений осуществляется с помощью решения для управления обновлениями службы автоматизации Azure.   

Из рабочей области Log Analytics, к которой подключена виртуальная машина, можно также получать, объединять и анализировать собранные данные с помощью [полнофункционального языка запросов](../../azure-monitor/log-query/log-query-overview.md). 

![Рабочая область Log Analytics](./media/tutorial-monitoring/tutorial-monitor-oms.png)

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве рассматривались настройка и проверка обновлений виртуальной машины, а также управление ими. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине.
> * Просмотр диагностики загрузки
> * Просмотр метрик узла.
> * Включение расширения системы диагностики на виртуальной машине.
> * Просмотр метрик виртуальной машины.
> * Создание оповещений на основе метрик диагностики.
> * Управление пакетами обновлений
> * Мониторинг изменений и инвентаризация
> * Настройка расширенного мониторинга

Перейдите к следующему руководству, чтобы узнать о центре безопасности Azure.

> [!div class="nextstepaction"]
> [Мониторинг защиты виртуальных машин с помощью центра безопасности Azure](../../security/fundamentals/overview.md)
