---
title: Последовательная консоль Azure для вызовов Сисрк и NMI
description: Использование последовательной консоли для вызовов SysRq и NMI на виртуальных машинах Azure.
author: asinn826
ms.service: virtual-machines-linux
ms.topic: article
ms.workload: infrastructure-services
ms.date: 08/14/2018
ms.author: alsin
ms.openlocfilehash: 5541dec748f31818a0e9485fc0c56b7926ccaae7
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "81758486"
---
# <a name="use-serial-console-for-sysrq-and-nmi-calls"></a>Использование последовательной консоли для вызовов SysRq и NMI

## <a name="system-request-sysrq"></a>Системный запрос (SysRq)
SysRq — это последовательность клавиш, понятная ядру операционной системы Linux, которая может инициировать набор предопределенных действий. Эти команды часто используются при устранении неполадок или восстановлении виртуальных машин с помощью традиционных средств администрирования (например, если виртуальная машина не отвечает). Использование функции SysRq в последовательной консоли Azure будет имитировать нажатие клавиши SysRq и ввод символов на физической клавиатуре.

Как только последовательность SysRq будет запущена, конфигурация ядра будет контролировать реакцию системы. Сведения о включении и отключении SysRq см. в *руководстве администратора SysRq* [в разделах с текстом](https://aka.ms/kernelorgsysreqdoc) | [разметкой](https://aka.ms/linuxsysrq).  

Последовательную консоль Azure можно использовать для отправки SysRq на виртуальную машину Azure с использованием значка клавиатуры в показанной ниже командной строке.

![](../media/virtual-machines-serial-console/virtual-machine-serial-console-command-menu.jpg)

При выборе команды Send SysRq Command (Отправить команду SysRq) откроется диалоговое окно, которое предоставит общие параметры SysRq или примет последовательность команд SysRq, введенных в диалоговое окно.  Это позволяет сериям SysRq выполнять высокоуровневую операцию, такую ​​как безопасная перезагрузка с использованием: `REISUB`.

![](../media/virtual-machines-serial-console/virtual-machine-serial-console-sysreq_UI.png)

Команда SysRq не может использоваться на остановленных виртуальных машинах или на таких, ядро которых ​​находится в неотвечающем состоянии (например, критическое состояние ядра).

### <a name="enable-sysrq"></a>Включение SysRq 
Как описано в упомянутом выше *руководстве администратора SysRq*, SysRq можно настроить таким образом, чтобы были доступны все или только определенные команды. Вы можете включить все команды SysRq, используя следующий шаг, но эта настройка не сохранится в случае перезагрузки:
```
echo "1" >/proc/sys/kernel/sysrq
```
Конфигурацию SysReq можно сделать постоянной. Включите все команды следующим образом.
1. Добавьте эту строку в */etc/sysctl.conf*. <br>
    `kernel.sysrq = 1`
1. Перезагрузите или обновите sysctl, выполнив: <br>
    `sysctl -p`

### <a name="command-keys"></a>Клавиши команд 
Как указано в упомянутом выше руководстве администратора SysRq:

|Команда| Функция
| ------| ----------- |
|``b``  |   Немедленно инициирует перезагрузку системы без синхронизации или отключение дисков.
|``c``  |   Выполняет сбой системы с помощью разыменования пустого указателя. Если настроено, будет создан аварийный дамп.
|``d``  |   Показывает все удерживаемые блокировки.
|``e``  |   Отправляет SIGTERM всем процессам, за исключением init.
|``f``  |   Вызывает завершение зависшего процесса, чтобы устранить нехватку памяти, но не переживайте, если процесс не завершается.
|``g``  |   Используется kgdb (отладчик ядра).
|``h``  |   Отображает справку (любая другая клавиша, кроме перечисленных здесь, также отобразит справку, но ``h`` легко запомнить).
|``i``  |    Отправляет SIGKILL всем процессам, за исключением init.
|``j``  |    Принудительно "размораживает" файловые системы, остановленные с помощью FIFREEZE ioctl.
|``k``  |    Защищенная клавиша доступа (SAK) завершает все программы в текущей виртуальной консоли. Примечание. Важные комментарии см. в разделе об SAK ниже.
|``l``  |    Отображает обратную трассировку стека для всех активных ЦП.
|``m``  |    Передает текущую информацию о памяти в консоль.
|``n``  |    Используется для упрощения работы с задачами RT.
|``o``  |    Завершает работу системы (если эта клавиша настроена и поддерживается).
|``p``  |    Передает текущие регистры и флаги в консоль.
|``q``  |    Будет передавать списки всех установленных hrtimers (но не обычных таймеров timer_list) для каждого ЦП и подробную информацию обо всех устройствах clockevent.
|``r``  |    Отключает режим RAW клавиатуры и устанавливает для нее параметр XLATE.
|``s``  |    Будет пытаться синхронизировать все подключенные файловые системы.
|``t``  |    Передаст список текущих задач и информацию о них в консоль.
|``u``  |    Будет пытаться повторно подключить все подключенные файловые системы только для чтения.
|``v``  |    Принудительно восстанавливает консоль framebuffer.
|``v``  |    Вызывает дамп буфера ETM [относящийся к ARM].
|``w``  |    Создает дамп задач, которые находятся в непрерываемом (заблокированном) состоянии.
|``x``  |    Используется интерфейсом xmon на платформах ppc/powerpc. Отображает глобальные регистры PMU в sparc64. Создает дамп всех записей TLB в MIPS.
|``y``  |    Отображает глобальные регистры ЦП [относящиеся к SPARC-64].
|``z``  |    Создает дамп буфера ftrace.
|``0``-``9`` | Устанавливает уровень журналирования консоли, контролирующий, какие сообщения ядра будут отображаться в консоли. (``0``, например, сделает так, чтобы только сообщения о чрезвычайной ситуации, такие как PANIC или OOPS, могли попасть в вашу консоль.)

### <a name="distribution-specific-documentation"></a>Документация для конкретного дистрибутива ###
Документация по SysRq для конкретного дистрибутива и шаги по настройке Linux для создания аварийного дампа при получении команды Crash SysRq доступны по ссылкам ниже.

#### <a name="ubuntu"></a>Ubuntu ####
 - [Аварийный дамп ядра](https://help.ubuntu.com/lts/serverguide/kernel-crash-dump.html)

#### <a name="red-hat"></a>Red Hat ####
- [Что такое средство SysRq и как его использовать?](https://access.redhat.com/articles/231663)
- [Как использовать средство SysRq для сбора информации с сервера RHEL?](https://access.redhat.com/solutions/2023)

#### <a name="suse"></a>SUSE ####
- [Настройка записи дампа ядра](https://www.suse.com/support/kb/doc/?id=3374462)

#### <a name="coreos"></a>CoreOS ####
- [Сбор журналов сбоев](https://coreos.com/os/docs/latest/collecting-crash-logs.html)

## <a name="non-maskable-interrupt-nmi"></a>Немаскируемое прерывание (NMI) 
Немаскируемое прерывание (NMI) предназначено для создания сигнала, который программное обеспечение на виртуальной машине не будет игнорировать. Раньше немаскируемые прерывания использовались для мониторинга аппаратных проблем в системах, требующих определенного времени отклика.  Сегодня программисты и системные администраторы часто используют Node Managed Identity в качестве механизма для отладки или устранения неполадок в неотвечающих системах.

Последовательную консоль можно использовать для отправки немаскируемого прерывания на виртуальную машину Azure с помощью значка клавиатуры, показанного ниже в командной строке. Как только немаскируемое прерывание будет запущено, конфигурация виртуальной машины будет контролировать реакцию системы.  Операционные системы Linux можно настроить для аварийного завершения и создания дампа памяти, когда операционная система получает немаскируемое прерывание.

![](../media/virtual-machines-serial-console/virtual-machine-serial-console-command-menu.jpg) <br>

Для систем Linux, которые поддерживают sysctl для настройки параметров ядра, можно включить аварийный сигнал при получении этого немаскируемого прерывания, выполнив следующее:
1. Добавьте эту строку в */etc/sysctl.conf*. <br>
    `kernel.panic_on_unrecovered_nmi=1`
1. Перезагрузите или обновите sysctl, выполнив: <br>
    `sysctl -p`

Дополнительные сведения о конфигурации ядра Linux, включая `unknown_nmi_panic`, `panic_on_io_nmi` и `panic_on_unrecovered_nmi`, см. в разделе [документации по /proc/sys/kernel/*](https://www.kernel.org/doc/Documentation/sysctl/kernel.txt). Документацию по немаскируемому прерыванию для конкретного дистрибутива и шаги по настройке Linux для создания аварийного дампа при получении немаскируемого прерывания см. по ссылкам ниже.
 
### <a name="ubuntu"></a>Ubuntu 
 - [Аварийный дамп ядра](https://help.ubuntu.com/lts/serverguide/kernel-crash-dump.html)

### <a name="red-hat"></a>Red Hat 
 - [Что такое немаскируемое прерывание и для чего его можно использовать?](https://access.redhat.com/solutions/4127)
 - [Как я могу настроить свою систему на сбой при передаче немаскируемого прерывания?](https://access.redhat.com/solutions/125103)
 - [Руководство администратора по выполнению аварийного дампа](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/pdf/kernel_crash_dump_guide/kernel-crash-dump-guide.pdf)

### <a name="suse"></a>SUSE 
- [Настройка записи дампа ядра](https://www.suse.com/support/kb/doc/?id=3374462)

### <a name="coreos"></a>CoreOS 
- [Сбор журналов сбоев](https://coreos.com/os/docs/latest/collecting-crash-logs.html)

## <a name="next-steps"></a>Дальнейшие шаги
* См. страницу документации по работе с [последовательной консолью Linux](serial-console.md).
* Используйте последовательную консоль для [перехода в режим GRUB и однопользовательский режим](serial-console-grub-single-user-mode.md).
* Последовательная консоль также доступна для виртуальных машин [Windows](../windows/serial-console.md).
* Дополнительные сведения о [диагностике загрузки](boot-diagnostics.md)