---
title: Руководство. Создание пользовательских образов виртуальных машин с помощью Azure CLI | Документы Майкрософт
description: В этом руководстве описано, как с помощью Azure CLI создать пользовательский образ виртуальной машины Linux в Azure.
services: virtual-machines-linux
documentationcenter: virtual-machines
author: cynthn
manager: gwallace
editor: tysonn
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 12/13/2017
ms.author: cynthn
ms.custom: mvc
ms.openlocfilehash: ee88eee7c4618306f86b4338a94f81c1403e3120
ms.sourcegitcommit: 8b44498b922f7d7d34e4de7189b3ad5a9ba1488b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/13/2019
ms.locfileid: "72299357"
---
# <a name="tutorial-create-a-custom-image-of-an-azure-vm-with-the-azure-cli"></a>Руководство по Создание пользовательского образа виртуальной машины Azure с помощью Azure CLI

Пользовательские образы похожи на образы магазина, однако их можно создавать самостоятельно. Пользовательские образы можно использовать для начальной загрузки конфигураций, например при предварительной загрузке приложений, конфигураций приложений и других конфигураций операционной системы. В рамках этого руководства вы создадите собственный пользовательский образ виртуальной машины Azure. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * отменить подготовку виртуальных машин и подготовить их к использованию;
> * создавать пользовательский образ;
> * Создание виртуальной машины из пользовательского образа
> * Получение списка всех образов в подписке
> * удалять образ.

При работе с этим руководством используется интерфейс командной строки (CLI) в [Azure Cloud Shell](https://docs.microsoft.com/azure/cloud-shell/overview), который всегда обновлен до последней версии. Чтобы открыть Cloud Shell, выберите **Попробовать** в верхнем углу любого блока кода.

Если вы решили установить и использовать интерфейс командной строки локально, то для работы с этим руководством вам понадобится Azure CLI 2.0.30 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli).

## <a name="before-you-begin"></a>Перед началом работы

Ниже подробно описано, как преобразовать существующую виртуальную машину в многократно используемый пользовательский образ, на основе которого можно создавать экземпляры виртуальной машины.

Для выполнения примера в этом руководстве требуется виртуальная машина. Этот [пример сценария](../scripts/virtual-machines-linux-cli-sample-create-vm-nginx.md) позволяет создать ее при необходимости. При работе с примером по мере необходимости заменяйте имена групп ресурсов и виртуальных машин.

## <a name="create-a-custom-image"></a>Создание пользовательского образа

Чтобы создать образ виртуальной машины, нужно подготовить виртуальную машину, выполнив отзыв, отменив выделение и пометив исходную виртуальную машину как обобщенную. После подготовки виртуальной машины вы можете создать образ.

### <a name="deprovision-the-vm"></a>Отзыв виртуальной машины 

Отзыв обобщает виртуальную машину, удаляя относящиеся к ней сведения. Такое обобщение позволяет развернуть множество виртуальных машин из одного образа. Во время отзыва имя узла сбрасывается и принимает значение *localhost.localdomain*. Ключи узла SSH, конфигурации сервера доменных имен, пароль учетной записи root и кэшированные аренды DHCP также удаляются.

> [!WARNING]
> Если для виртуальной машины отменена подготовка, а сама она отмечена как универсальная, исходную виртуальную машину нельзя будет использовать и перезапустить. 

Чтобы отозвать виртуальную машину, используйте агент виртуальной машины Azure (waagent). Агент виртуальной машины Azure устанавливается на виртуальной машине и управляет подготовкой и взаимодействием с контроллером структуры Azure. Дополнительные сведения см. в [руководстве пользователя агента Linux Azure](../extensions/agent-linux.md).

Подключитесь к виртуальной машине с помощью SSH и выполните команду для ее отзыва. При указании аргумента `+user` также удаляется последняя подготовленная учетная запись пользователя вместе со связанными данными. Замените IP-адрес в примере общедоступным IP-адресом виртуальной машины.

Подключитесь к виртуальной машине по протоколу SSH.
```bash
ssh azureuser@52.174.34.95
```
Отзовите виртуальную машину.

```bash
sudo waagent -deprovision+user -force
```
Закройте сеанс SSH.

```bash
exit
```

### <a name="deallocate-and-mark-the-vm-as-generalized"></a>Отмена выделения и пометка виртуальной машины как обобщенной

Чтобы создать образ, нужно отменить выделение виртуальной машины. Отмените выделение виртуальной машины с помощью команды [az vm deallocate](/cli//azure/vm). 
   
```azurecli-interactive 
az vm deallocate --resource-group myResourceGroup --name myVM
```

Наконец, сообщите платформе Azure, что виртуальная машина подготовлена к использованию, выполнив команду [az vm generalize](/cli//azure/vm). Создать образ можно только из подготовленной виртуальной машины.
   
```azurecli-interactive 
az vm generalize --resource-group myResourceGroup --name myVM
```

### <a name="create-the-image"></a>Создание образа

Теперь можно создать образ виртуальной машины с помощью команды [az image create](/cli//azure/image). В следующем примере создается образ *myImage* из виртуальной машины *myVM*.
   
```azurecli-interactive 
az image create \
    --resource-group myResourceGroup \
    --name myImage \
    --source myVM
```
 
## <a name="create-vms-from-the-image"></a>Создание виртуальных машин из образа

Теперь, когда образ готов, из него можно создать одну или несколько виртуальных машин с помощью команды [az vm create](/cli/azure/vm). В следующем примере создается виртуальная машина *myVMfromImage* из образа *myImage*.

```azurecli-interactive 
az vm create \
    --resource-group myResourceGroup \
    --name myVMfromImage \
    --image myImage \
    --admin-username azureuser \
    --generate-ssh-keys
```

Рекомендуем ограничить число параллельных развертываний из одного образа до 20 виртуальных машин. Если вы планируете крупномасштабное параллельное развертывание более 20 виртуальных машин из одного и того же пользовательского образа, следует использовать службу [Общая коллекция образов](shared-image-galleries.md) с несколькими репликами образов. 

## <a name="image-management"></a>Управление образами 

Ниже приведены некоторые примеры распространенных задач управления образами, а также способы их настройки с помощью Azure CLI.

Получение списка всех образов по имени в формате таблицы.

```azurecli-interactive 
az image list \
    --resource-group myResourceGroup
```

Удаление образа. В этом примере из *myResourceGroup* удаляется образ с именем *myOldImage*.

```azurecli-interactive 
az image delete \
    --name myOldImage \
    --resource-group myResourceGroup
```

## <a name="next-steps"></a>Дополнительная информация

В рамках этого руководства вы создали пользовательский образ виртуальной машины. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * отменять подготовку виртуальных машин и подготавливать их к использованию;
> * создавать пользовательский образ;
> * Создание виртуальной машины из пользовательского образа
> * Получение списка всех образов в подписке
> * удалять образ.

Перейдите к следующему руководству, чтобы узнать о высокодоступных виртуальных машинах.

> [!div class="nextstepaction"]
> [Создание высокодоступных виртуальных машин](tutorial-availability-sets.md)

