---
title: Восстановление виртуальных машин Linux с помощью чрут, где используется LVM (Диспетчер логических томов) — виртуальные машины Azure
description: Восстановление виртуальных машин Linux с помощью Лвмс.
services: virtual-machines-linux
documentationcenter: ''
author: vilibert
manager: spogge
editor: ''
tags: Linux chroot LVM
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 11/24/2019
ms.author: vilibert
ms.openlocfilehash: 0dd07b3394e385b3931e01867d467af7559b4f8b
ms.sourcegitcommit: 57eb9acf6507d746289efa317a1a5210bd32ca2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/01/2019
ms.locfileid: "74664171"
---
# <a name="troubleshooting-a-linux-vm-when-there-is-no-access-to-the-azure-serial-console-and-the-disk-layout-is-using-lvm-logical-volume-manager"></a>Устранение неполадок в виртуальной машине Linux при отсутствии доступа к последовательной консоли Azure и разметке диска с использованием LVM (Диспетчер логических томов)

Это руководство по устранению неполадок является преимуществом для сценариев, в которых виртуальная машина Linux не загружается, протокол SSH невозможен, а базовая структура файловой системы настроена с помощью LVM (Диспетчер логических томов).

## <a name="take-snapshot-of-the-failing-vm"></a>Создание моментального снимка непройденной виртуальной машины

Создание моментального снимка затронутой виртуальной машины. 

Затем моментальный снимок будет подключен **к виртуальной машине** . Следуйте инструкциям в [разделе](https://docs.microsoft.com/azure/virtual-machines/linux/snapshot-copy-managed-disk#use-azure-portal) создание **моментального снимка**.

## <a name="create-a-rescue-vm"></a>Создание виртуальной машины для аварийного создания
Обычно рекомендуется использовать виртуальную машину с такой же или аналогичной версией операционной системы. Используйте тот же **регион** и **группу ресурсов** затронутой виртуальной машины.

## <a name="connect-to-the-rescue-vm"></a>Подключение к виртуальной машине "помощь"
Подключитесь по протоколу SSH к виртуальной машине " **помощь** ". Повышение привилегий и станьте привилегированным пользователем с помощью

`sudo su -`

## <a name="attach-the-disk"></a>Подключение диска
Подключите диск **к виртуальной машине** , созданной ранее из моментального снимка.

Портал Azure-> выберите диски **виртуальной машины** , > 

![Создание диска](./media/chroot-logical-volume-manager/create-disk-from-snap.png)

Заполните поля. Назначьте имя новому диску, выберите ту же группу ресурсов, что и моментальный снимок, затронутая виртуальная машина и виртуальная машина.

**Тип источника** — **snapshot** .
**Исходный моментальный снимок** — это имя ранее созданного **моментального снимка** .

![Создание диска 2](./media/chroot-logical-volume-manager/create-disk-from-snap-2.png)

Создайте точку подключения для подключенного диска.

`mkdir /rescue`

Выполните команду **fdisk-l** , чтобы убедиться, что диск моментального снимка подключен, и перечислите все доступные устройства и разделы.

`fdisk -l`

В большинстве случаев подключенный диск моментальных снимков будет отображаться как **/Dev/SDC** , отображающий два раздела **/dev/sdc1** и **/dev/sdc2**

![Fdisk](./media/chroot-logical-volume-manager/fdisk-output-sdc.png)

**\*** указывает загрузочный раздел, оба раздела будут подключены.

Выполните команду **лсблк** , чтобы просмотреть лвмс затронутой виртуальной машины.

`lsblk`

![Запустить лсблк](./media/chroot-logical-volume-manager/lsblk-output-mounted.png)


Проверьте, отображаются ли Лвмс на затронутой виртуальной машине.
В противном случае используйте приведенные ниже команды, чтобы включить их и перезапустить **лсблк**.
Перед продолжением убедитесь, что на подключенном диске отображается Лвмс.

```
vgscan --mknodes
vgchange -ay
lvscan
mount –a
lsblk
```

Чтобы подключить логический том, содержащий раздел/(корневой), необходимо указать путь к нему. Он содержит файлы конфигурации, такие как/etc/default/grub

В этом примере получение выходных данных из предыдущей **лсблк** команды **рутвг-рутлв** является правильным **корневым** параметром lv для подключения и может использоваться в следующей команде.

В выходных данных следующей команды будет показан путь для подключения к **корневой** странице lv.

`pvdisplay -m | grep -i rootlv`

![рутлв](./media/chroot-logical-volume-manager/locate-rootlv.png)

Перейдите к подключению этого устройства к каталогу/Рескуе

`mount /dev/rootvg/rootlv /rescue`

Подключите секцию, для которой установлен **флаг загрузки** , в/Рескуе/Бут

`
mount /dev/sdc1 /rescue/boot
`

Убедитесь, что файловые системы подключенного диска правильно подключены с помощью команды **лсблк**

![Запустить лсблк](./media/chroot-logical-volume-manager/lsblk-output-1.png)

или **DF-ой** команды

![DF](./media/chroot-logical-volume-manager/df-output.png)

## <a name="gaining-chroot-access"></a>Получение доступа к чрут

Получите доступ к **чрут** , который позволит выполнять различные исправления. для каждого дистрибутива Linux существуют небольшие варианты.

```
 cd /rescue
 mount -t proc proc proc
 mount -t sysfs sys sys/
 mount -o bind /dev dev/
 mount -o bind /dev/pts dev/pts/
 chroot /rescue
```

Если возникла ошибка, например:

**чрут: не удалось выполнить команду "Отличное/bin/bash": нет такого файла или каталога**

попытка подключения логического тома **usr**

`
mount  /dev/mapper/rootvg-usrlv /rescue/usr
`

> [!TIP]
> При выполнении команд в среде **чрут** Обратите внимание, что они выполняются с подключенным ДИСКом ОС, а не с **локальной виртуальной машиной** . 

Команды можно использовать для установки, удаления и обновления программного обеспечения. Устраните неполадки виртуальных машин, чтобы устранить ошибки.


Выполните команду лсблк, и/Рескуе сейчас/и/Рескуе/Бут —/Boot ![Чрутед](./media/chroot-logical-volume-manager/chrooted.png)

## <a name="perform-fixes"></a>Выполнение исправлений

### <a name="example-1---configure-the-vm-to-boot-from-a-different-kernel"></a>Пример 1. Настройка виртуальной машины для загрузки с другого ядра

Распространенный сценарий — принудительная загрузка виртуальной машины из предыдущего ядра, так как текущий установленный ядро может быть поврежден, или обновление завершилось некорректно.


```
cd /boot/grub2

grep -i linux grub.cfg

grub2-editenv list

grub2-set-default "CentOS Linux (3.10.0-1062.1.1.el7.x86_64) 7 (Core)"

grub2-editenv list

grub2-mkconfig -o /boot/grub2/grub.cfg
```

*walkthrough*

Команда **grep** перечисляет ядра, о которых имеет значение **GRUB. cfg** .
![ядра](./media/chroot-logical-volume-manager/kernels.png)

в **списке grub2-едитенв** указывается, какой ядро будет загружаться при следующей загрузке ![ядро по умолчанию](./media/chroot-logical-volume-manager/kernel-default.png)

**grub2-Set-Default** используется для переключения на другой набор grub2 ![ядра](./media/chroot-logical-volume-manager/grub2-set-default.png)

в списке **grub2-едитенв** указывается, какой ядро будет загружаться при следующей загрузке ![нового ядра](./media/chroot-logical-volume-manager/kernel-new.png)

**grub2-mkconfig** перестраивает GRUB. cfg с использованием версий, необходимых ![grub2 mkconfig](./media/chroot-logical-volume-manager/grub2-mkconfig.png)



### <a name="example-2---upgrade-packages"></a>Пример 2. Обновление пакетов

Сбой обновления ядра может привести к невозможности загрузки виртуальной машины.
Подключите все логические тома, чтобы разрешить удаление или переустановку пакетов.

Выполните команду **LVS** , чтобы проверить, какие **LVS** доступны для подключения, каждая виртуальная машина, которая была перенесена или получена от другого поставщика облачных служб, будет зависеть от конфигурации.

Выйдите из среды **чрут** и подключите требуемую **LV**

![Расширенная](./media/chroot-logical-volume-manager/advanced.png)

Теперь снова получите доступ к среде **чрут** , выполнив

`chroot /rescue`

Все LVs должны быть видимыми в виде подключенных секций.

![Расширенная](./media/chroot-logical-volume-manager/chroot-all-mounts.png)

Запрос установленного **ядра**

![Расширенная](./media/chroot-logical-volume-manager/rpm-kernel.png)

При необходимости удалите или обновите **ядро**
![Advanced](./media/chroot-logical-volume-manager/rpm-remove-kernel.png)


### <a name="example-3---enable-serial-console"></a>Пример 3. Включение последовательной консоли
Если доступ к последовательной консоли Azure невозможен, проверьте параметры конфигурации GRUB для виртуальной машины Linux и исправьте их. Подробные сведения можно найти [в этом документе](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/serial-console-grub-proactive-configuration) .


## <a name="exit-chroot-and-swap-the-os-disk"></a>Выход из чрут и замена диска ОС

После устранения этой проблемы перейдите к отсоединению и отсоедините диск от виртуальной машины, позволяющей переключиться на затронутый диск ОС виртуальной машины.

```
exit
cd /
umount /rescue/proc/
umount /rescue/sys/
umount /rescue/dev/pts
umount /rescue/dev/
umount /rescue/boot
umount /rescue
```

Отключите диск от виртуальной машины и выполните переключение диска.

Выберите виртуальную машину на **дисках** портала и выберите **отсоединить**
![отсоединить диск](./media/chroot-logical-volume-manager/detach-disk.png) 

Сохраните изменения ![сохранить отсоединение](./media/chroot-logical-volume-manager/save-detach.png) 

Теперь диск станет доступным и будет заменен исходным диском ОС затронутой виртуальной машины.

Перейдите в портал Azure к виртуальной машине, на которой выполняется сбой, и выберите **диски** -> **переключить диск ОС**
![диск подкачки](./media/chroot-logical-volume-manager/swap-disk.png) 

Заполните поля **выберите диск** — это диск моментальных снимков, который просто отсоединился на предыдущем шаге. Также требуется имя виртуальной машины затронутой виртуальной машины, а затем нажмите кнопку **ОК** .

![Новый диск ОС](./media/chroot-logical-volume-manager/new-osdisk.png) 

Если виртуальная машина работает, диск будет выключен, Перезагрузите виртуальную машину после завершения операции переключения диска.


## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о [последовательной консоли Azure]( https://docs.microsoft.com/azure/virtual-machines/troubleshooting/serial-console-linux)
