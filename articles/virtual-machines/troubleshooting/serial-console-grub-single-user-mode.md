---
title: Последовательная консоль Azure для GRUB и однопользовательский режим | Документация Майкрософт
description: В этой статье описывается, как использовать последовательную консоль для GRUB на виртуальных машинах Azure.
services: virtual-machines-linux
documentationcenter: ''
author: asinn826
manager: gwallace
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-linux
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 08/06/2019
ms.author: alsin
ms.openlocfilehash: 06cb3fe5d551ddfc95fcbd37cd9620adebd825c5
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "70883928"
---
# <a name="use-serial-console-to-access-grub-and-single-user-mode"></a>Использование последовательной консоли для доступа к GRUB и однопользовательским режимам
Общий единый загрузчик (GRUB), скорее всего, является первым, что вы видите при загрузке виртуальной машины (ВМ). Так как она отображается до запуска операционной системы, GRUB недоступен через SSH. В GRUB можно изменить конфигурацию загрузки для загрузки в однопользовательский режим, помимо прочего.

Однопользовательский режим — это минимальная среда с минимальными функциональными возможностями. Он может быть полезен для изучения проблем загрузки, проблем с файловой системой или проблем с сетью. В фоновом режиме может выполняться меньше служб, и в зависимости от runlevel файловая система может быть даже не смонтирована автоматически.

Однопользовательский режим также полезен в ситуациях, когда виртуальная машина может быть настроена на прием только ключей SSH для входа. В этом случае вы можете использовать однопользовательский режим для создания учетной записи с проверкой подлинности по паролю. 

> [!NOTE]
> Служба последовательной консоли позволяет получить доступ к последовательной консоли виртуальной машины только пользователям с разрешениями уровня *участника* или выше.

Чтобы войти в однопользовательский режим, введите GRUB при загрузке виртуальной машины и измените конфигурацию загрузки в GRUB. Подробные инструкции по вводу GRUB см. в следующем разделе. Как правило, если виртуальная машина настроена для показа GRUB, можно использовать кнопку Перезапустить в последовательной консоли виртуальной машины, чтобы перезапустить виртуальную машину и отобразить GRUB.

![Кнопка перезапуска последовательной консоли Linux](./media/virtual-machines-serial-console/virtual-machine-serial-console-restart-button-bar.png)

## <a name="general-grub-access"></a>Общий доступ к GRUB
Чтобы получить доступ к GRUB, Перезагрузите виртуальную машину, пока открыта панель последовательной консоли. Для некоторых дистрибутивов требуется ввод с клавиатуры для отображения GRUB, а другие автоматически отображают GRUB в течение нескольких секунд, чтобы разрешить ввод с клавиатуры пользователя для отмены времени ожидания.

Чтобы иметь возможность доступа к однопользовательскому режиму, необходимо убедиться, что на виртуальной машине включен GRUB. В зависимости от распределения может потребоваться выполнить некоторые настройки, чтобы убедиться в том, что GRUB включен. Сведения о конкретном распространении см. в следующем разделе и нашей [поддержке для Linux на странице Azure](https://blogs.msdn.microsoft.com/linuxonazure/2018/10/23/why-proactively-ensuring-you-have-access-to-grub-and-sysrq-in-your-linux-vm-could-save-you-lots-of-down-time/) .

### <a name="restart-your-vm-to-access-grub-in-serial-console"></a>Перезагрузка виртуальной машины для доступа к GRUB в последовательной консоли
Вы можете перезапустить виртуальную машину в последовательной консоли, наведя указатель мыши на кнопку **перезапуска** и выбрав **restart VM (перезапуск виртуальной машины**). В нижней части панели отображается уведомление о перезапуске.

Вы также можете перезапустить виртуальную машину, выполнив команду Сисрк "b", если включен параметр [сисрк](./serial-console-nmi-sysrq.md) . Чтобы узнать, что должно происходить из GRUB при перезагрузке, ознакомьтесь с инструкциями по распространению в следующих разделах.

![Перезапуск последовательной консоли Linux](./media/virtual-machines-serial-console/virtual-machine-serial-console-restart-button-ubuntu.gif)

## <a name="general-single-user-mode-access"></a>Общий доступ в режиме одного пользователя
Если учетная запись с проверкой пароля не настроена, может потребоваться доступ к однопользовательскому режиму вручную. Измените конфигурацию GRUB, чтобы вручную войти в однопользовательский режим. После этого ознакомьтесь с дополнительными инструкциями в разделе "использование однопользовательского режима для сброса или добавления пароля".

Если виртуальная машина не может загружаться, распространенные дистрибутивы часто автоматически перезапускаются в однопользовательский или аварийный режим. Для других дистрибутивов, однако, требуется дополнительная настройка, например Настройка пароля root, прежде чем они смогут автоматически перетаскиваться в однопользовательский или аварийный режим.

### <a name="use-single-user-mode-to-reset-or-add-a-password"></a>Использование однопользовательского режима для сброса или добавления пароля
Когда Вы находитесь в однопользовательском режиме, добавьте нового пользователя с привилегиями sudo, выполнив следующие действия.
1. Выполните `useradd <username>` команду, чтобы добавить пользователя.
1. Выполните `sudo usermod -a -G sudo <username>` команду, чтобы предоставить привилегии нового корневого пользователя.
1. Используйте `passwd <username>`, чтобы задать пароль для нового пользователя. Затем можно выполнить вход от имени нового пользователя.


## <a name="access-for-red-hat-enterprise-linux-rhel"></a>Доступ в Red Hat Enterprise Linux (RHEL)
Если RHEL не удается загрузить в обычном режиме, он автоматически перейдет в однопользовательский режим. Однако если вы еще не настроили корневой доступ для однопользовательского режима, у вас нет корневого пароля и войти в систему. Существует обходной путь (см. раздел "ручное ввод однопользовательского режима в RHEL"), но мы рекомендуем сначала настроить корневой доступ.

### <a name="grub-access-in-rhel"></a>Доступ к GRUB в RHEL
В RHEL GRUB всегда включается по умолчанию. Чтобы войти в GRUB, Перезагрузите виртуальную `sudo reboot`машину, выполнив команду, а затем нажмите любую клавишу. Должна отобразиться панель GRUB. Если это не так, убедитесь, что в файле GRUB (`/etc/default/grub`) имеются следующие строки:

**Для RHEL 8**

```
GRUB_TIMEOUT=5
GRUB_TERMINAL="serial console"
GRUB_CMDLINE_LINUX="console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300"
```

**Для RHEL 7**

```
GRUB_TIMEOUT=5
GRUB_TERMINAL_OUTPUT="serial console"
GRUB_CMDLINE_LINUX="console=tty1 console=ttyS0,115200n8 earlyprintk=ttyS0,115200 rootdelay=300 net.ifnames=0"
```

> [!NOTE]
> Кроме того, Red Hat предоставляет документацию для загрузки в режим "помощь", "аварийный режим" или "режим отладки", а также для сброса пароля root. Инструкции см. в разделе [изменение меню терминала во время загрузки](https://aka.ms/rhel7grubterminal).

### <a name="set-up-root-access-for-single-user-mode-in-rhel"></a>Настройка корневого доступа для однопользовательского режима в RHEL
По умолчанию корневой пользователь отключен. Для однопользовательского режима в RHEL требуется включить привилегированного пользователя. Если необходимо включить однопользовательский режим, выполните следующие действия.

1. Войдите в систему Red Hat по протоколу SSH.
1. Переключитесь на корневую папку.
1. Включите пароль для привилегированного пользователя, выполнив следующие действия.
    * Запустите `passwd root` (Задайте надежный пароль root).
1. Убедитесь, что корневой пользователь может войти только через ttyS0, выполнив следующие действия.  
    а. Выполните `edit /etc/ssh/sshd_config`команду и убедитесь, что для `no`пермитрутлогин задано значение.  
    b. Выполните `edit /etc/securetty file` команду, чтобы разрешить вход только через ttyS0.

Теперь, если система загружается в однопользовательский режим, вы можете войти с помощью пароля root.

Кроме того, для RHEL 7.4 + или 6,9 +, чтобы включить однопользовательский режим в запросах GRUB, см. раздел [Загрузка в однопользовательский режим](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/installation_guide/s1-rescuemode-booting-single).

### <a name="manually-enter-single-user-mode-in-rhel"></a>Ручной ввод однопользовательского режима в RHEL
Если вы настроили GRUB и корневой доступ с помощью приведенных выше инструкций, можно войти в однопользовательский режим, выполнив следующие действия.

1. Чтобы ввести GRUB, нажмите клавишу ESC при перезапуске виртуальной машины.
1. В GRUB нажмите клавишу E, чтобы изменить операционную систему, в которую требуется выполнить загрузку. Операционная система обычно указывается в первой строке.
1. Найдите строку ядра. В Azure он начинается с *linux16*.
1. Нажмите клавиши CTRL + E, чтобы вернуться в конец строки.
1. В конце строки добавьте *Systemed. Unit = спасти. Target*.
    
    Это действие загружается в однопользовательский режим. Если вы хотите использовать аварийный режим, добавьте *Systemed. Unit = неотлож. Target* в конец строки (вместо *Systemed. Unit = спасти. Target*).

1. Нажмите клавиши CTRL + X для выхода и перезагрузки с применением примененных параметров.

   Перед переходом в однопользовательский режим вам будет предложено ввести пароль администратора. Это пароль, созданный в предыдущих инструкциях.

    ![](../media/virtual-machines-serial-console/virtual-machine-linux-serial-console-rhel-enter-emergency-shell.gif)

### <a name="enter-single-user-mode-without-root-account-enabled-in-rhel"></a>Переход в однопользовательский режим без включенной учетной записи root в RHEL
Если вы не включили привилегированного пользователя, следуя приведенным выше инструкциям, вы по-прежнему можете сбросить корневой пароль, выполнив следующие действия.

> [!NOTE]
> Если вы используете SELinux, при сбросе пароля root обязательно выполните дополнительные действия, описанные в [документации по Red Hat](https://aka.ms/rhel7grubterminal).

1. Чтобы ввести GRUB, нажмите клавишу ESC при перезапуске виртуальной машины.

1. В GRUB нажмите клавишу E, чтобы изменить операционную систему, в которую требуется выполнить загрузку. Операционная система обычно указывается в первой строке.
1. Найдите строку ядра. В Azure он начинается с *linux16*.
1. В конце строки добавьте *Rd. Break* в конец строки. Оставьте пробел между строкой ядра и *Rd. Break*.

    Это действие прерывает процесс загрузки до передачи управления из `initramfs` в `systemd`, как описано в документации по [Red Hat](https://aka.ms/rhel7rootpassword).
1. Нажмите клавиши CTRL + X для выхода и перезагрузки с применением примененных параметров.

   После перезагрузки вы перейдете в аварийный режим с файловой системой только для чтения. 
   
1. В оболочке введите `mount -o remount,rw /sysroot` , чтобы повторно подключить корневую файловую систему с разрешениями на чтение и запись.
1. После загрузки в однопользовательский режим введите `chroot /sysroot` , чтобы переключиться в `sysroot` со снятой защитой.
1. Теперь у вас есть корень. Вы можете сбросить пароль, введя `passwd` , а затем используя приведенные выше инструкции для входа в однопользовательский режим. 
1. Когда все будет готово, введите `reboot -f` для перезагрузки.

![](../media/virtual-machines-serial-console/virtual-machine-linux-serial-console-rhel-emergency-mount-no-root.gif)

> [!NOTE]
> Выполнение описанных выше инструкций приведет к аварийной оболочке, что позволяет выполнять такие задачи, как редактирование `fstab`. Однако мы рекомендуем сбрасывать корневой пароль и использовать его для входа в однопользовательский режим.

## <a name="access-for-centos"></a>Доступ для CentOS
Подобно Red Hat Enterprise Linux, однопользовательский режим в CentOS требует, чтобы был включен GRUB и привилегированный пользователь.

### <a name="grub-access-in-centos"></a>Доступ к GRUB в CentOS
В CentOS GRUB всегда включается по умолчанию. Чтобы войти в GRUB, Перезагрузите виртуальную `sudo reboot`машину, введя, а затем нажмите любую клавишу. Это действие отображает панель GRUB.

### <a name="single-user-mode-in-centos"></a>Однопользовательский режим в CentOS
Чтобы включить однопользовательский режим в CentOS, следуйте приведенным выше инструкциям по RHEL.

## <a name="access-for-ubuntu"></a>Доступ для Ubuntu
Для образов Ubuntu не требуется пароль root. Если система загружается в однопользовательский режим, ее можно использовать без дополнительных учетных данных.

### <a name="grub-access-in-ubuntu"></a>Доступ к GRUB в Ubuntu
Чтобы получить доступ к GRUB, нажмите и удерживайте клавишу ESC, пока виртуальная машина загружается.

По умолчанию образы Ubuntu могут не отображать панель GRUB автоматически. Этот параметр можно изменить, выполнив следующие действия.
1. В текстовом редакторе откройте файл */etc/default/grub.d/50-cloudimg-Settings.cfg* .

1. Измените `GRUB_TIMEOUT` значение на ненулевое значение.
1. В текстовом редакторе откройте */etc/default/grub*.
1. Закомментируйте `GRUB_HIDDEN_TIMEOUT=1` строку.
1. Убедитесь, что есть `GRUB_TIMEOUT_STYLE=menu` строка.
1. Выполните команду `sudo update-grub`.

### <a name="single-user-mode-in-ubuntu"></a>Однопользовательский режим в Ubuntu
Если Ubuntu не может загрузиться в обычном режиме, она автоматически перейдет в однопользовательский режим. Чтобы войти в однопользовательский режим вручную, выполните следующие действия.

1. В GRUB нажмите клавишу E, чтобы изменить загрузочную запись (запись Ubuntu).
1. Найдите строку, которая начинается с *Linux*, и найдите *ro*.
1. Добавьте *Single* после *ro*, убедившись в наличии пробелов до и после *Single*.
1. Нажмите клавиши CTRL + X для перезагрузки с этими параметрами и войдите в однопользовательский режим.

### <a name="use-grub-to-invoke-bash-in-ubuntu"></a>Использование GRUB для вызова Bash в Ubuntu
После выполнения описанных выше инструкций может возникнуть ситуация (например, забытый пароль root), в которой по-прежнему не удается получить доступ к однопользовательскому режиму на виртуальной машине Ubuntu. Можно также сообщить ядру, что ядро запускается `/bin/bash` как init, а не как инициализация системы. Это действие предоставляет оболочку Bash и обеспечивает обслуживание системы. Для этого сделайте следующее:

1. В GRUB нажмите клавишу E, чтобы изменить загрузочную запись (запись Ubuntu).

1. Найдите строку, которая начинается с *Linux*, и найдите *ro*.
1. Замените *ro* на *RW init = отличное/bin/bash*.

    Это действие подключает файловую систему для чтения и записи и использует `/bin/bash` его в качестве процесса инициализации.
1. Нажмите клавиши CTRL + X для перезагрузки с этими параметрами.

## <a name="access-for-coreos"></a>Доступ для CoreOS
Однопользовательский режим в CoreOS требует включения GRUB.

### <a name="grub-access-in-coreos"></a>Доступ к GRUB в CoreOS
Чтобы получить доступ к GRUB, нажмите любую клавишу, пока виртуальная машина загружается.

### <a name="single-user-mode-in-coreos"></a>Однопользовательский режим в CoreOS
Если CoreOS не удается загрузить в обычном режиме, он автоматически перейдет в однопользовательский режим. Чтобы войти в однопользовательский режим вручную, выполните следующие действия.

1. В GRUB нажмите клавишу E, чтобы изменить загрузочную запись.

1. Найдите строку, которая начинается с *Linux $*. Должно быть два экземпляра строки, каждая из которых инкапсулирована в другой *If... else* , предложение.
1. Добавьте *CoreOS. автовход = ttyS0* в конец каждой строки *Linux $* .
1. Нажмите клавиши CTRL + X для перезагрузки с этими параметрами и войдите в однопользовательский режим.

## <a name="access-for-suse-sles"></a>Доступ для SUSE SLES
Новые образы SLES 12 SP3 + разрешают доступ через последовательную консоль, если система загружается в аварийный режим.

### <a name="grub-access-in-suse-sles"></a>Доступ к GRUB в SUSE SLES
Для доступа к GRUB в SLES требуется конфигурация загрузчика через YaST. Чтобы создать конфигурацию, выполните следующие действия.

1. Используйте SSH для входа на виртуальную машину SLES и запустите `sudo yast bootloader`. Нажмите клавишу TAB, нажмите клавишу ВВОД, а затем используйте клавиши со стрелками для перемещения по меню.

1. Перейдите к **параметрам ядра**и установите флажок **использовать последовательную консоль** .
1. Добавьте `serial --unit=0 --speed=9600 --parity=no` в аргументы **консоли** .
1. Нажмите клавишу F10, чтобы сохранить параметры и выйти.
1. Чтобы ввести GRUB, Перезагрузите виртуальную машину и нажмите любую клавишу во время последовательности загрузки, чтобы отобразить панель GRUB.

    Время ожидания по умолчанию для GRUB равно **1**единице. Этот параметр можно изменить, изменив `GRUB_TIMEOUT` переменную в файле */etc/default/grub* .

![Инициализация конфигурации загрузчика](../media/virtual-machines-serial-console/virtual-machine-linux-serial-console-sles-yast-grub-config.gif)

### <a name="single-user-mode-in-suse-sles"></a>Однопользовательский режим в SUSE SLES
Если SLES не удается загрузить в обычном режиме, вы автоматически переноситесь в аварийную оболочку. Чтобы ввести аварийную оболочку вручную, выполните следующие действия.

1. В GRUB нажмите клавишу E, чтобы изменить загрузочную запись (запись SLES).

1. Найдите строку ядра, которая начинается с *Linux*.
1. Добавить *Systemed. Unit = неотлож. Target* в конец строки ядра.
1. Нажмите клавиши CTRL + X для перезагрузки с этими параметрами и введите аварийную оболочку.

   > [!NOTE]
   > Это действие перейдет в аварийную оболочку с файловой системой только для чтения. Чтобы изменить какие-либо файлы, повторно подключите файловую систему с разрешениями на чтение и запись. Для этого введите `mount -o remount,rw /` в оболочке.

## <a name="access-for-oracle-linux"></a>Доступ для Oracle Linux
Подобно Red Hat Enterprise Linux, однопользовательский режим в Oracle Linux требует включения GRUB и корневого пользователя.

### <a name="grub-access-in-oracle-linux"></a>Доступ к GRUB в Oracle Linux
В Oracle Linux GRUB всегда включается по умолчанию. Чтобы войти в GRUB, Перезагрузите виртуальную `sudo reboot`машину, выполнив команду, и нажмите клавишу ESC. Это действие отображает панель GRUB. Если панель GRUB не отображается, убедитесь, что значение в `GRUB_TERMINAL` строке содержит *последовательную консоль* (то есть `GRUB_TERMINAL="serial console"`). Перестройте GRUB `grub2-mkconfig -o /boot/grub/grub.cfg`с помощью.

### <a name="single-user-mode-in-oracle-linux"></a>Однопользовательский режим в Oracle Linux
Чтобы включить однопользовательский режим в Oracle Linux, выполните предыдущие инструкции для RHEL.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о последовательной консоли см. в следующих статьях:
* [Документация по последовательной консоли Linux](serial-console-linux.md)
* [Использование последовательной консоли для включения GRUB в различных дистрибутивах](https://blogs.msdn.microsoft.com/linuxonazure/2018/10/23/why-proactively-ensuring-you-have-access-to-grub-and-sysrq-in-your-linux-vm-could-save-you-lots-of-down-time/)
* [Использование последовательной консоли для вызовов NMI и Сисрк](serial-console-nmi-sysrq.md)
* [Последовательная консоль для виртуальных машин Windows](serial-console-windows.md)
* [Диагностика загрузки](boot-diagnostics.md)
