---
title: Использование виртуальной машины Windows для устранения неполадок с помощью портала Azure | Документация Майкрософт
description: Узнайте, как устранять неполадки с виртуальными машинами Windows в Azure, подключив диск операционной системы к виртуальной машине восстановления с помощью портала Azure.
services: virtual-machines-windows
documentationCenter: ''
author: genlin
manager: dcscontentpm
editor: ''
ms.service: virtual-machines-windows
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 08/19/2018
ms.author: genli
ms.openlocfilehash: e76fc2da8da2325a8bb0cda47c4405c9eb03c8f4
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79250001"
---
# <a name="troubleshoot-a-windows-vm-by-attaching-the-os-disk-to-a-recovery-vm-using-the-azure-portal"></a>Устранение неполадок с виртуальной машиной Windows при подключении диска операционной системы к виртуальной машине восстановления с помощью портала Azure
Если возникает проблема с загрузкой или диском на виртуальной машине Windows в Azure, возможно, вам нужно устранить неполадки, связанные с самим виртуальным жестким диском. Например, такая ситуация может возникнуть из-за сбоя обновления приложения, который мешает успешно загрузить виртуальную машину. В этой статье подробно описано, как с помощью портала Azure подключить виртуальный жесткий диск к другой виртуальной машине Windows для устранения ошибок, а затем восстановить исходную виртуальную машину. 

## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Остановите затронутую виртуальную машину.
1. Создайте моментальный снимок для диска ОС виртуальной машины.
1. Создайте виртуальный жесткий диск из моментального снимка.
1. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине Windows для устранения неполадок.
1. Подключитесь к этой виртуальной машине. Измените файлы или запустите средства, которые нужны для устранения неполадок на исходном виртуальном жестком диске.
1. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
1. Замените диск операционной системы виртуальной машины.

> [!NOTE]
> Эта статья не относится к виртуальной машине с неуправляемым диском.

## <a name="take-a-snapshot-of-the-os-disk"></a>Создание моментального снимка диска ОС
Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Рекомендуется аккуратно завершить работу виртуальной машины перед созданием моментального снимка, чтобы очистить все выполняющиеся процессы. Чтобы создать моментальный снимок диска операционной системы, выполните следующие действия.

1. Перейдите на [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** на боковой панели, а затем выберите виртуальную машину с проблемой.
1. На левой панели выберите **диски**, а затем выберите имя диска операционной системы.
    ![Изображение с именем диска ОС](./media/troubleshoot-recovery-disks-portal-windows/select-osdisk.png)
1. На странице **Обзор** диска операционной системы, а затем выберите **создать моментальный снимок**.
1. Создайте моментальный снимок в том же расположении, что и диск операционной системы.

## <a name="create-a-disk-from-the-snapshot"></a>Создание диска из моментального снимка
Чтобы создать диск на основе моментального снимка, выполните следующие действия.

1. Выберите **Cloud Shell** из портал Azure.

    ![Изображение об открытии Cloud Shell](./media/troubleshoot-recovery-disks-portal-windows/cloud-shell.png)
1. Выполните следующие команды PowerShell, чтобы создать управляемый диск из моментального снимка. Эти имена примеров следует заменить соответствующими именами.

    ```powershell
    #Provide the name of your resource group
    $resourceGroupName ='myResourceGroup'
    
    #Provide the name of the snapshot that will be used to create Managed Disks
    $snapshotName = 'mySnapshot' 
    
    #Provide the name of theManaged Disk
    $diskName = 'newOSDisk'
    
    #Provide the size of the disks in GB. It should be greater than the VHD file size. In this sample, the size of the snapshot is 127 GB. So we set the disk size to 128 GB.
    $diskSize = '128'
    
    #Provide the storage type for Managed Disk.  Premium_LRS or Standard_LRS.
    $storageType = 'Standard_LRS'
    
    #Provide the Azure region (e.g. westus) where Managed Disks will be located.
    #This location should be same as the snapshot location
    #Get all the Azure location using command below:
    #Get-AzLocation
    $location = 'westus'
    
    $snapshot = Get-AzSnapshot -ResourceGroupName $resourceGroupName -SnapshotName $snapshotName 
     
    $diskConfig = New-AzDiskConfig -AccountType $storageType -Location $location -CreateOption Copy -SourceResourceId $snapshot.Id
     
    New-AzDisk -Disk $diskConfig -ResourceGroupName $resourceGroupName -DiskName $diskName
    ```
3. Если команды выполняются успешно, вы увидите новый диск в указанной группе ресурсов.

## <a name="attach-the-disk-to-another-vm"></a>Подключение диска к другой виртуальной машине
В следующих нескольких шагах описывается использование другой виртуальной машины для устранения неполадок. После подключения диска к виртуальной машине для устранения неполадок можно просмотреть и изменить содержимое диска. Этот процесс позволяет исправлять любые ошибки конфигурации или просматривать дополнительные файлы журналов приложений или систем. Чтобы подключить диск к другой виртуальной машине, выполните следующие действия.

1. Выберите на портале группу ресурсов и виртуальную машину для устранения неполадок. Выберите **диски**, выберите **изменить**, а затем щелкните **Добавить диск данных**:

    ![Присоединение существующего диска на портале](./media/troubleshoot-recovery-disks-portal-windows/attach-existing-disk.png)

2. В списке **диски данных** выберите диск операционной системы виртуальной машины, которую вы определили. Если диск операционной системы не отображается, убедитесь, что устранение неполадок виртуальной машины и диска ОС находятся в том же регионе (расположении). 
3. Нажмите кнопку **сохранить** , чтобы применить изменения.

## <a name="mount-the-attached-data-disk-to-the-vm"></a>Подключение подключенного диска данных к виртуальной машине

1. Откройте удаленный рабочий стол подключение к виртуальной машине для устранения неполадок. 
2. На виртуальной машине устранение неполадок откройте **Диспетчер сервера**, а затем выберите **службы файлов и хранилища**. 

    ![Выбор параметра "Файловые службы и службы хранилища" в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-select-storage.png)

3. Диск данных будет автоматически обнаружен и подключен. Для просмотра списка подключенных дисков выберите **Диски**. Можно выбрать диск данных, чтобы просмотреть сведения о томах, включая букву диска. В следующем примере показан подключенный диск данных **F**.

    ![Подключенный диск и сведения о томах в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-disk-attached.png)

## <a name="fix-issues-on-original-virtual-hard-disk"></a>Устранение неполадок на исходном виртуальном жестком диске
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по обслуживанию и (или) устранению неполадок. После устранения проблем выполните следующие действия.

## <a name="unmount-and-detach-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
После устранения ошибок отсоедините существующий виртуальный жесткий диск от виртуальной машины, которую использовали для устранения неполадок. Виртуальный жесткий диск нельзя использовать с другой виртуальной машиной, пока вы не отмените аренду, присоединяющую виртуальный жесткий диск к виртуальной машине для устранения неполадок.

1. В сеансе подключения к удаленному рабочему столу своей виртуальной машины откройте **диспетчер сервера** и выберите **Файловые службы и службы хранилища**.

    ![Выбор параметра "Файловые службы и службы хранилища" в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-select-storage.png)

2. Щелкните **Диски** и выберите свой диск данных. Щелкните его правой кнопкой мыши и выберите **Отключить**.

    ![Отключение диска данных в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-set-disk-offline.png)

3. Теперь отсоедините виртуальный жесткий диск от виртуальной машины. Выберите на портале Azure виртуальную машину и щелкните **Диски**. 
4. Выберите **изменить**, выберите подключенный диск ОС и нажмите кнопку **отсоединить**:

    ![Отсоединение существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal-windows/detach-disk.png)

    Подождите, пока виртуальная машина успешно отсоединит диск данных, прежде чем продолжать процесс.

## <a name="swap-the-os-disk-for-the-vm"></a>Переключение диска операционной системы для виртуальной машины

Портал Azure теперь поддерживает изменение диска операционной системы виртуальной машины. Для этого выполните следующие действия.

1. Перейдите на [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** на боковой панели, а затем выберите виртуальную машину с проблемой.
1. На левой панели выберите **диски**, а затем выберите вариант **переключить диск ОС**.
        ![Образ, посвященный замене диска ОС в портал Azure](./media/troubleshoot-recovery-disks-portal-windows/swap-os-ui.png)

1. Выберите новый диск, который вы восстановили, а затем введите имя виртуальной машины, чтобы подтвердить изменение. Если диск не отображается в списке, подождите 10 ~ 15 минут после отключения диска от виртуальной машины для устранения неполадок. Также убедитесь, что диск находится в том же расположении, что и виртуальная машина.
1. Нажмите кнопку "ОК".

## <a name="next-steps"></a>Дальнейшие шаги
При возникновении проблем с подключением к виртуальной машине ознакомьтесь со статьей [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md). Для устранения проблем с доступом к приложениям, выполняющимся на виртуальной машине, прочитайте статью [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](troubleshoot-app-connection.md).

Дополнительные сведения об использовании Resource Manager вы найдете в статье [Общие сведения об Azure Resource Manager](../../azure-resource-manager/management/overview.md).


