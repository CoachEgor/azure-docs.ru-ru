---
title: Устранение неполадок виртуальной машины Windows в портал Azure | Документация Майкрософт
description: Узнайте, как устранять неполадки виртуальных машин Windows в Azure, подключив диск операционной системы к виртуальной машине восстановления с помощью портал Azure.
services: virtual-machines-windows
documentationCenter: ''
author: genlin
manager: dcscontentpm
editor: ''
ms.service: virtual-machines-windows
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 08/19/2018
ms.author: genli
ms.openlocfilehash: 04adf3903cd925f4507e94347251c762a576ff93
ms.sourcegitcommit: c2dd51aeaec24cd18f2e4e77d268de5bcc89e4a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94735234"
---
# <a name="troubleshoot-a-windows-vm-by-attaching-the-os-disk-to-a-recovery-vm-through-the-azure-portal"></a>Устранение неполадок виртуальной машины Windows путем подключения диска ОС к виртуальной машине восстановления с помощью портал Azure
Если в виртуальной машине Windows в Azure возникает ошибка запуска или диска, может потребоваться выполнить действия по устранению неполадок на виртуальном жестком диске (VHD). Распространенным примером является неудачное обновление приложения, препятствующее успешному запуску виртуальной машины. В этой статье описано, как использовать портал Azure для подключения виртуального жесткого диска к другой виртуальной машине Windows, чтобы устранить ошибки, а затем повторно создать исходную виртуальную машину. 

## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Остановите затронутую виртуальную машину.
1. Создайте моментальный снимок диска ОС виртуальной машины.
1. Создайте виртуальный жесткий диск из моментального снимка.
1. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине Windows для устранения неполадок.
1. Подключитесь к этой виртуальной машине. Измените файлы или запустите инструменты, чтобы устранить проблемы на исходном виртуальном жестком диске.
1. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
1. Замените диск операционной системы виртуальной машины.

> [!NOTE]
> Эта статья не относится к виртуальным машинам с неуправляемыми дисками.

## <a name="take-a-snapshot-of-the-os-disk"></a>Создание моментального снимка диска операционной системы
Моментальный снимок — это полная копия виртуального жесткого диска, предназначенная только для чтения. Рекомендуется аккуратно завершить работу виртуальной машины перед созданием моментального снимка, чтобы очистить все выполняющиеся процессы. Чтобы создать моментальный снимок диска операционной системы, выполните следующие действия.

1. Перейдите на [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** на боковой панели, а затем выберите виртуальную машину, на которой возникла проблема.
1. На левой панели выберите **диски**, а затем выберите имя диска операционной системы.
    ![Снимок экрана, на котором показано имя диска ОС в параметрах диска.](./media/troubleshoot-recovery-disks-portal-windows/select-osdisk.png)
1. На странице **Обзор** диска ОС выберите **создать моментальный снимок**.
1. Создайте моментальный снимок в том же расположении, что и диск операционной системы.

## <a name="create-a-disk-from-the-snapshot"></a>Создание диска из моментального снимка
Чтобы создать диск на основе моментального снимка, выполните следующие действия.

1. Выберите **Cloud Shell** из портал Azure.

    ![Снимок экрана, на котором показана кнопка для открытия Azure Cloud Shell.](./media/troubleshoot-recovery-disks-portal-windows/cloud-shell.png)
1. Выполните следующие команды PowerShell, чтобы создать управляемый диск из моментального снимка. Замените имена примеров соответствующими именами.

    ```powershell
    #Provide the name of your resource group.
    $resourceGroupName ='myResourceGroup'
    
    #Provide the name of the snapshot that will be used to create managed disks.
    $snapshotName = 'mySnapshot' 
    
    #Provide the name of the managed disk.
    $diskName = 'newOSDisk'
    
    #Provide the size of the disks in gigabytes. It should be greater than the VHD file size. In this example, the size of the snapshot is 127 GB. So we set the disk size to 128 GB.
    $diskSize = '128'
    
    #Provide the storage type for the managed disk: Premium_LRS or Standard_LRS.
    $storageType = 'Standard_LRS'
    
    #Provide the Azure region (for example, westus) where the managed disks will be located.
    #This location should be the same as the snapshot location.
    #Get all the Azure locations by using this command:
    #Get-AzLocation
    $location = 'westus'
    
    $snapshot = Get-AzSnapshot -ResourceGroupName $resourceGroupName -SnapshotName $snapshotName 
     
    $diskConfig = New-AzDiskConfig -AccountType $storageType -Location $location -CreateOption Copy -SourceResourceId $snapshot.Id
     
    New-AzDisk -Disk $diskConfig -ResourceGroupName $resourceGroupName -DiskName $diskName
    ```
3. Если команды выполняются успешно, вы увидите новый диск в указанной группе ресурсов.

## <a name="attach-the-disk-to-another-vm"></a>Подключение диска к другой виртуальной машине
В следующих нескольких шагах описывается использование другой виртуальной машины для устранения неполадок. После подключения диска к виртуальной машине для устранения неполадок можно просмотреть и изменить содержимое диска. Этот процесс позволяет исправлять любые ошибки конфигурации или просматривать дополнительные файлы журналов приложений или систем. Чтобы подключить диск к другой виртуальной машине, выполните следующие действия.

1. Выберите группу ресурсов на портале, а затем выберите виртуальную машину для устранения неполадок. Выберите **диски**  >  **изменить**  >  **Добавить диск данных**.

    ![Снимок экрана, на котором показаны параметры для присоединения существующего диска на портале.](./media/troubleshoot-recovery-disks-portal-windows/attach-existing-disk.png)

2. В списке **диски данных** выберите диск операционной системы виртуальной машины, которую вы определили. Если диск операционной системы не отображается, убедитесь, что виртуальная машина для устранения неполадок и диск операционной системы находятся в одном регионе (расположение). 
3. Нажмите кнопку **сохранить** , чтобы применить изменения.

## <a name="mount-the-attached-data-disk-to-the-vm"></a>Подключение подключенного диска данных к виртуальной машине

1. Откройте удаленный рабочий стол подключение к виртуальной машине для устранения неполадок. 
2. На виртуальной машине для устранения неполадок откройте **Диспетчер сервера** и выберите **службы файлов и хранилища**. 

    ![Снимок экрана, на котором показано, как выбрать файл и службы хранилища в диспетчер сервера.](./media/troubleshoot-recovery-disks-portal-windows/server-manager-select-storage.png)

3. Диск данных будет автоматически обнаружен и подключен. Для просмотра списка подключенных дисков выберите **Диски**. Можно выбрать диск данных, чтобы просмотреть сведения о томах, включая букву диска. В следующем примере показан подключенный диск данных и использование диска **F**.

    ![Снимок экрана, на котором показаны подключенные сведения о диске и томе в диспетчер сервера.](./media/troubleshoot-recovery-disks-portal-windows/server-manager-disk-attached.png)

## <a name="fix-problems-on-the-original-virtual-hard-disk"></a>Устранение проблем с исходным виртуальным жестким диском
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по обслуживанию и (или) устранению неполадок. После устранения всех ошибок выполните следующие действия.

## <a name="unmount-and-detach-the-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
Отсоедините существующий виртуальный жесткий диск от виртуальной машины для устранения неполадок. Виртуальный жесткий диск нельзя использовать с любой другой виртуальной машиной, пока не будет выпущена Аренда, которая прикрепляет виртуальный жесткий диск к виртуальной машине для устранения неполадок.

1. В удаленный рабочий стол сеансе на виртуальной машине откройте **Диспетчер сервера** и выберите **службы файлов и хранилища**.

    ![Снимок экрана, на котором показано, как выбрать файл и службы хранилища в диспетчер сервера.](./media/troubleshoot-recovery-disks-portal-windows/server-manager-select-storage.png)

2. Выберите **диски**, щелкните правой кнопкой мыши диск данных и выберите перевести в **режим «вне сети**».

    ![Снимок экрана, показывающий установку диска данных в автономном режиме в диспетчер сервера.](./media/troubleshoot-recovery-disks-portal-windows/server-manager-set-disk-offline.png)

3. Отсоедините виртуальный жесткий диск от виртуальной машины. Выберите виртуальную машину в портал Azure, а затем выберите **диски**. 
4. Выберите **изменить**, выберите подключенный диск ОС и нажмите кнопку **Удалить**.

    ![Снимок экрана, на котором показаны варианты отсоединения существующего виртуального жесткого диска.](./media/troubleshoot-recovery-disks-portal-windows/detach-disk.png)

    Прежде чем продолжить, подождите, пока диск данных не будет успешно удален на виртуальной машине.

## <a name="swap-the-os-disk-for-the-vm"></a>Переключение диска операционной системы для виртуальной машины

Портал Azure теперь поддерживает изменение диска операционной системы виртуальной машины. Для этого выполните следующие действия.

1. Перейдите на [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** на боковой панели, а затем выберите виртуальную машину, на которой возникла проблема.
1. На левой панели выберите **диски**, а затем выберите вариант **переключить диск ОС**.
   
    ![Снимок экрана, на котором показана кнопка для замены диска ОС в портал Azure.](./media/troubleshoot-recovery-disks-portal-windows/swap-os-ui.png)

1. Выберите новый диск, который вы восстановили, а затем введите имя виртуальной машины, чтобы подтвердить изменение. Если диск не отображается в списке, подождите 10 – 15 минут после отключения диска от виртуальной машины для устранения неполадок. Также убедитесь, что диск находится в том же расположении, что и виртуальная машина.
1. Нажмите кнопку **ОК**.

## <a name="next-steps"></a>Дальнейшие действия
При возникновении проблем с подключением к виртуальной машине см. статью [Устранение неполадок удаленный рабочий стол подключения к виртуальной машине Azure](troubleshoot-rdp-connection.md). Сведения о проблемах с доступом к приложениям, выполняемым на виртуальной машине, см. [в статье Устранение неполадок с подключением к приложениям на виртуальной машине Windows](troubleshoot-app-connection.md).

Дополнительные сведения об использовании Azure Resource Manager см. в разделе [обзор Azure Resource Manager](../../azure-resource-manager/management/overview.md).


