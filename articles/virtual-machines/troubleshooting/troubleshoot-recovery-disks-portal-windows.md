---
title: Использование виртуальной машины Windows для устранения неполадок с помощью портала Azure | Документация Майкрософт
description: Узнайте, как устранять неполадки с виртуальными машинами Windows в Azure, подключив диск операционной системы к виртуальной машине восстановления с помощью портала Azure.
services: virtual-machines-windows
documentationCenter: ''
author: genlin
manager: dcscontentpm
editor: ''
ms.service: virtual-machines-windows
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 08/19/2018
ms.author: genli
ms.openlocfilehash: e76fc2da8da2325a8bb0cda47c4405c9eb03c8f4
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79250001"
---
# <a name="troubleshoot-a-windows-vm-by-attaching-the-os-disk-to-a-recovery-vm-using-the-azure-portal"></a>Устранение неполадок с виртуальной машиной Windows при подключении диска операционной системы к виртуальной машине восстановления с помощью портала Azure
Если возникает проблема с загрузкой или диском на виртуальной машине Windows в Azure, возможно, вам нужно устранить неполадки, связанные с самим виртуальным жестким диском. Например, такая ситуация может возникнуть из-за сбоя обновления приложения, который мешает успешно загрузить виртуальную машину. В этой статье подробно описано, как с помощью портала Azure подключить виртуальный жесткий диск к другой виртуальной машине Windows для устранения ошибок, а затем восстановить исходную виртуальную машину. 

## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Остановите затронутую виртуальную машину.
1. Создайте снимок для диска ОС VM.
1. Создайте виртуальный жесткий диск из снимка.
1. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине Windows для устранения неполадок.
1. Подключитесь к этой виртуальной машине. Измените файлы или запустите средства, которые нужны для устранения неполадок на исходном виртуальном жестком диске.
1. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
1. Поменяйте диск ОС на VM.

> [!NOTE]
> Эта статья не распространяется на VM с неуправляемым диском.

## <a name="take-a-snapshot-of-the-os-disk"></a>Сделать снимок диска ОС
Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Мы рекомендуем вам чисто выключить VM, прежде чем сделать снимок, чтобы очистить все процессы, которые находятся в процессе. Чтобы сделать снимок диска ОС, выполните следующие действия:

1. Перейдите на [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** из боковой панели, а затем выберите VM, который имеет проблемы.
1. На левой панели, выберите **диски**, а затем выбрать имя диска ОС.
    ![Изображение о названии диска ОС](./media/troubleshoot-recovery-disks-portal-windows/select-osdisk.png)
1. На странице **Обзор** диска ОС, а затем выберите **Создать снимок**.
1. Создайте моментальный снимок в том же месте, что и диск ОС.

## <a name="create-a-disk-from-the-snapshot"></a>Создание диска из моментального снимка
Чтобы создать диск из снимка, выполните следующие действия:

1. Выберите **облачную оболочку** на портале Azure.

    ![Изображение о открытой облачной оболочке](./media/troubleshoot-recovery-disks-portal-windows/cloud-shell.png)
1. Выполнить следующие команды PowerShell для создания управляемого диска из снимка. Эти имена образцов должны заменить соответствующие имена.

    ```powershell
    #Provide the name of your resource group
    $resourceGroupName ='myResourceGroup'
    
    #Provide the name of the snapshot that will be used to create Managed Disks
    $snapshotName = 'mySnapshot' 
    
    #Provide the name of theManaged Disk
    $diskName = 'newOSDisk'
    
    #Provide the size of the disks in GB. It should be greater than the VHD file size. In this sample, the size of the snapshot is 127 GB. So we set the disk size to 128 GB.
    $diskSize = '128'
    
    #Provide the storage type for Managed Disk.  Premium_LRS or Standard_LRS.
    $storageType = 'Standard_LRS'
    
    #Provide the Azure region (e.g. westus) where Managed Disks will be located.
    #This location should be same as the snapshot location
    #Get all the Azure location using command below:
    #Get-AzLocation
    $location = 'westus'
    
    $snapshot = Get-AzSnapshot -ResourceGroupName $resourceGroupName -SnapshotName $snapshotName 
     
    $diskConfig = New-AzDiskConfig -AccountType $storageType -Location $location -CreateOption Copy -SourceResourceId $snapshot.Id
     
    New-AzDisk -Disk $diskConfig -ResourceGroupName $resourceGroupName -DiskName $diskName
    ```
3. Если команды успешно работают, новый диск будет представлен в группе ресурсов, которую вы предоставили.

## <a name="attach-the-disk-to-another-vm"></a>Прикрепите диск к другому VM
В следующих нескольких шагах описывается использование другой виртуальной машины для устранения неполадок. После присоединения диска к устранению неполадок VM можно просматривать и отстранять содержимое диска. Этот процесс позволяет исправить любые ошибки конфигурации или просмотреть дополнительные файлы приложения или системного журнала. Чтобы прикрепить диск к другому VM, выполните следующие действия:

1. Выберите на портале группу ресурсов и виртуальную машину для устранения неполадок. Выберите **диски,** выберите **Отменить,** а затем нажмите **Добавить диск данных:**

    ![Присоединение существующего диска на портале](./media/troubleshoot-recovery-disks-portal-windows/attach-existing-disk.png)

2. В списке **дисков данных** выберите идентифицированный диск ОС VM. Если вы не видите диск ОС, убедитесь, что устранение неполадок VM и диск АС находится в одном регионе (местоположении). 
3. Выберите **Сохранить** для применения изменений.

## <a name="mount-the-attached-data-disk-to-the-vm"></a>Установите прикрепленный диск данных к VM

1. Откройте удаленное соединение рабочего стола для устранения неполадок VM. 
2. В устранении неполадок VM, Open **Server Manager**, затем выберите **службы файла и хранения.** 

    ![Выбор параметра "Файловые службы и службы хранилища" в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-select-storage.png)

3. Диск данных будет автоматически обнаружен и подключен. Для просмотра списка подключенных дисков выберите **Диски**. Можно выбрать диск данных, чтобы просмотреть сведения о томах, включая букву диска. В следующем примере показан подключенный диск данных **F**.

    ![Подключенный диск и сведения о томах в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-disk-attached.png)

## <a name="fix-issues-on-original-virtual-hard-disk"></a>Устранение неполадок на исходном виртуальном жестком диске
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по обслуживанию и (или) устранению неполадок. После устранения проблем выполните следующие действия.

## <a name="unmount-and-detach-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
После устранения ошибок отсоедините существующий виртуальный жесткий диск от виртуальной машины, которую использовали для устранения неполадок. Виртуальный жесткий диск нельзя использовать с другой виртуальной машиной, пока вы не отмените аренду, присоединяющую виртуальный жесткий диск к виртуальной машине для устранения неполадок.

1. В сеансе подключения к удаленному рабочему столу своей виртуальной машины откройте **диспетчер сервера** и выберите **Файловые службы и службы хранилища**.

    ![Выбор параметра "Файловые службы и службы хранилища" в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-select-storage.png)

2. Щелкните **Диски** и выберите свой диск данных. Щелкните его правой кнопкой мыши и выберите **Отключить**.

    ![Отключение диска данных в диспетчере сервера](./media/troubleshoot-recovery-disks-portal-windows/server-manager-set-disk-offline.png)

3. Теперь отсоедините виртуальный жесткий диск от виртуальной машины. Выберите на портале Azure виртуальную машину и щелкните **Диски**. 
4. Выберите **Edit,** выберите прилагаемый вами диск ОС, а затем нажмите **Detach:**

    ![Отсоединение существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal-windows/detach-disk.png)

    Подождите, пока виртуальная машина успешно отсоединит диск данных, прежде чем продолжать процесс.

## <a name="swap-the-os-disk-for-the-vm"></a>Поменяйте диск ОС на VM

Портал Azure теперь поддерживает изменение диска ОС VM. Для этого выполните следующие действия.

1. Перейдите на [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** из боковой панели, а затем выберите VM, который имеет проблемы.
1. На левой панели, выберите **диски**, а затем выберите **диск Swap OS**.
        ![Изображение диска Swap OS на портале Azure](./media/troubleshoot-recovery-disks-portal-windows/swap-os-ui.png)

1. Выберите новый диск, который вы отремонтировали, а затем введите имя VM, чтобы подтвердить изменение. Если вы не видите диск в списке, подождите 10 и 15 минут после того, как отсоедините диск от устранения неполадок VM. Также убедитесь, что диск находится в том же месте, что и VM.
1. Нажмите кнопку "ОК".

## <a name="next-steps"></a>Дальнейшие действия
При возникновении проблем с подключением к виртуальной машине ознакомьтесь со статьей [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md). Для устранения проблем с доступом к приложениям, выполняющимся на виртуальной машине, прочитайте статью [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](troubleshoot-app-connection.md).

Дополнительные сведения об использовании Resource Manager вы найдете в статье [Общие сведения об Azure Resource Manager](../../azure-resource-manager/management/overview.md).


