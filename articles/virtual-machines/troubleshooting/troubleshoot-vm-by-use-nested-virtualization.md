---
title: Устранение неполадок с неисправными виртуальными машинами Azure с помощью вложенной виртуализации в Azure | Документация Майкрософт
description: Узнайте, как устранить проблемы на виртуальной машине Azure с помощью вложенной виртуализации в Azure
services: virtual-machines-windows
documentationcenter: ''
author: glimoli
manager: dcscontentpm
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.topic: article
ms.date: 11/19/2019
ms.author: genli
ms.openlocfilehash: f950cb63b5083a85ab5420434abdd9a720115b1a
ms.sourcegitcommit: c2dd51aeaec24cd18f2e4e77d268de5bcc89e4a7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94734554"
---
# <a name="troubleshoot-a-faulty-azure-vm-by-using-nested-virtualization-in-azure"></a>Устранение неполадок с неисправными виртуальными машинами Azure с помощью вложенной виртуализации в Azure

В этой статье показано, как создать вложенную среду виртуализации в Microsoft Azure, чтобы можно было подключить диск с неисправными виртуальными машинами на узле Hyper-V (виртуальная машина аварийного тестирования) для устранения неполадок.

## <a name="prerequisites"></a>Предварительные требования

Чтобы подключить неисправный виртуальный компьютер, ВИРТУАЛЬная машина службы "помощь" должна использовать тот же тип учетной записи хранения ("Стандартный" или "Премиум"), что и у неисправных виртуальных машин.

## <a name="step-1-create-a-rescue-vm-and-install-hyper-v-role"></a>Шаг 1. Создание виртуальной машины спасения и настройка роли Hyper-V

1.  Создайте новую виртуальную машину спасения:

    -  С операционной системой Windows Server 2016 Datacenter.

    -  Любого размера из серии V3 как минимум с двумя ядрами, поддерживающими вложенную виртуализацию. Дополнительные сведения см. в записи блога, посвященной [обзору новых размеров виртуальных машин Dv3 и Ev3](https://azure.microsoft.com/blog/introducing-the-new-dv3-and-ev3-vm-sizes/).

    -  То же расположение, учетная запись хранения и группа ресурсов, что и у неисправных виртуальных машин.

    -  Выберите тот же тип хранилища, что и для неисправных виртуальных машин ("Стандартный" или "Премиум").

2.  После создания виртуальной машины спасения установите к ней подключение удаленного рабочего стола.

3.  В Диспетчер сервера выберите **Управление**  >  **Добавить роли и компоненты**.

4.  В разделе **Тип установки** выберите **Установка ролей или компонентов**.

5.  В разделе **Выбор целевого сервера** выберите виртуальную машину спасения.

6.  Выберите **роль Hyper-V**  >  **Добавить компоненты**.

7.  Нажмите кнопку **Далее** в разделе **Компоненты**.

8.  Если доступен виртуальный коммутатор, выберите его. В противном случае нажмите кнопку **Далее**.

9.  В разделе **Миграция** нажмите кнопку **Далее**.

10. В разделе **Хранилища по умолчанию** нажмите кнопку **Далее**.

11. Установите флажок, чтобы при необходимости автоматически перезапустить сервер.

12. Выберите пункт **Установить**.

13. Сервер установит роль Hyper-V. Это займет несколько минут, после чего он автоматически перезагрузится.

## <a name="step-2-create-the-faulty-vm-on-the-rescue-vms-hyper-v-server"></a>Шаг 2. Создание неисправной виртуальной машины на сервере Hyper-V виртуальной машины

1.  [Создайте диск моментальных снимков](troubleshoot-recovery-disks-portal-windows.md#take-a-snapshot-of-the-os-disk) для диска ОС виртуальной машины, на котором возникла проблема, а затем подключите диск моментальных снимков к виртуальной машине рекусе.

2.  Удаленный рабочий стол для виртуальной машины.

3.  Откройте управление дисками (diskmgmt.msc). Убедитесь, что на диске неисправной виртуальной машины установлен режим " **вне сети**".

4.  Откройте диспетчер Hyper-V. В **диспетчере сервера** выберите **роль Hyper-V**. Щелкните сервер правой кнопкой мыши, а затем выберите **Диспетчер Hyper-V**.

5.  В диспетчере Hyper-V щелкните правой кнопкой мыши виртуальную машину "помощь", а затем выберите **создать**  >  **виртуальную машину**  >  **Далее**.

6.  Введите имя виртуальной машины, а затем нажмите кнопку **Далее**.

7.  Выберите **Поколение 1**.

8.  Для параметра "Память при запуске" задайте значение от 1024 МБ.

9. Выберите созданный сетевой коммутатор Hyper-V, если это возможно. В противном случае перейдите к следующей странице.

10. Выберите **Подключить виртуальный жесткий диск позднее**.

    ![рисунок выбора параметра "Подключить виртуальный жесткий диск позднее"](media/troubleshoot-vm-by-use-nested-virtualization/attach-disk-later.png)

11. После создания виртуальной машины нажмите кнопку **Готово**.

12. Щелкните правой кнопкой мыши созданную виртуальную машину, а затем выберите **Параметры**.

13. Выберите **Контроллер 0 IDE**, **Жесткий диск**, а затем нажмите кнопку **Добавить**.

    ![рисунок добавления нового жесткого диска](media/troubleshoot-vm-by-use-nested-virtualization/create-new-drive.png)    

14. В поле **физический жесткий диск** выберите диск неисправной виртуальной машины, подключенной к виртуальной машине Azure. Если диски в списке отсутствуют, с помощью параметра "Управление дисками" проверьте заданное состояние для диска ("Отключен").

    ![рисунок с параметрами подключения диска](media/troubleshoot-vm-by-use-nested-virtualization/mount-disk.png)  


15. Нажмите кнопку **Применить**, а затем кнопку **ОК**.

16. Дважды щелкните виртуальную машину, а затем запустите ее.

17. Теперь вы можете работать на этой виртуальной машине как на локальной и выполнить необходимые действия по устранению неполадок.

## <a name="step-3-replace-the-os-disk-used-by-the-faulty-vm"></a>Шаг 3. Замена диска ОС, используемого неисправным виртуальным машинам

1.  После возвращения виртуальной машины в оперативный режим завершите ее работу в диспетчере Hyper-V.

2.  [Отключите и отсоедините исправленный диск операционной системы](troubleshoot-recovery-disks-portal-windows.md#unmount-and-detach-the-original-virtual-hard-disk
).
3.  [Замените диск ОС, используемый виртуальной машиной, исправленным диском ОС](troubleshoot-recovery-disks-portal-windows.md#swap-the-os-disk-for-the-vm
).

## <a name="next-steps"></a>Дальнейшие действия

При возникновении проблем с подключением к виртуальной машине ознакомьтесь со статьей [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md). Для устранения проблем с доступом к приложениям, выполняющимся на виртуальной машине, прочитайте статью [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](troubleshoot-app-connection.md).
