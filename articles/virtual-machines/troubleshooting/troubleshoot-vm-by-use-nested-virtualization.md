---
title: Устранение проблем на виртуальной машине Azure с помощью вложенной виртуализации в Azure | Документация Майкрософт
description: Узнайте, как устранить проблемы на виртуальной машине Azure с помощью вложенной виртуализации в Azure
services: virtual-machines-windows
documentationcenter: ''
author: glimoli
manager: dcscontentpm
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.topic: article
ms.date: 11/19/2019
ms.author: genli
ms.openlocfilehash: 87faea5385f5b0fd2c481c6aa7c45a9867b34163
ms.sourcegitcommit: b5106424cd7531c7084a4ac6657c4d67a05f7068
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75942182"
---
# <a name="troubleshoot-a-problem-azure-vm-by-using-nested-virtualization-in-azure"></a>Устранение проблем на виртуальной машине Azure с помощью вложенной виртуализации в Azure

В этой статье описывается, как создать среду вложенной виртуализации в Microsoft Azure, чтобы можно было подключить диск виртуальной машины с неполадками на узле Hyper-V (виртуальная машина спасение) для устранения неполадок.

## <a name="prerequisites"></a>Технические условия

Чтобы подключить виртуальную машину, на которой имеются неполадки, виртуальная машина спасения должна отвечать следующим требованиям:

-   виртуальная машина спасения должна находиться в том же расположении, что и виртуальная машина, на которой нужно устранить проблемы;

-   для виртуальной машины спасения должен использоваться тот же тип учетной записи хранения (уровня "Стандартный" или "Премиум"), что и для виртуальной машины, на которой нужно устранить проблемы.

## <a name="step-1-create-a-rescue-vm-and-install-hyper-v-role"></a>Шаг 1. Создание виртуальной машины спасения и настройка роли Hyper-V

1.  Создайте новую виртуальную машину спасения:

    -  С операционной системой Windows Server 2016 Datacenter.

    -  Любого размера из серии V3 как минимум с двумя ядрами, поддерживающими вложенную виртуализацию. Дополнительные сведения см. в записи блога, посвященной [обзору новых размеров виртуальных машин Dv3 и Ev3](https://azure.microsoft.com/blog/introducing-the-new-dv3-and-ev3-vm-sizes/).

    -  В том же расположении, что и виртуальная машина, на которой нужно устранить проблемы, а также в той же учетной записи хранения и группе ресурсов.

    -  Выберите тот же тип хранилища, что и у виртуальной машины, на которой нужно устранить проблемы (хранилище класса Standard или Premium).

2.  После создания виртуальной машины спасения установите к ней подключение удаленного рабочего стола.

3.  В диспетчере сервера выберите **Управление** > **Добавить роли и компоненты**.

4.  В разделе **Тип установки** выберите **Установка ролей или компонентов**.

5.  В разделе **Выбор целевого сервера** выберите виртуальную машину спасения.

6.  Выберите **Роль Hyper-V** > **Добавить компоненты**.

7.  Нажмите кнопку **Далее** в разделе **Компоненты**.

8.  Если доступен виртуальный коммутатор, выберите его. В противном случае нажмите кнопку **Далее**.

9.  В разделе **Миграция** нажмите кнопку **Далее**.

10. В разделе **Хранилища по умолчанию** нажмите кнопку **Далее**.

11. Установите флажок, чтобы при необходимости автоматически перезапустить сервер.

12. Выберите пункт **Установить**.

13. Сервер установит роль Hyper-V. Это займет несколько минут, после чего он автоматически перезагрузится.

## <a name="step-2-create-the-problem-vm-on-the-rescue-vms-hyper-v-server"></a>Шаг 2. Создание виртуальной машины, на которой имеются проблемы, на сервере Hyper-V виртуальной машины спасения

1.  [Создайте диск моментальных снимков](troubleshoot-recovery-disks-portal-windows.md#take-a-snapshot-of-the-os-disk) для диска ОС виртуальной машины, на котором возникла проблема, а затем подключите диск моментальных снимков к виртуальной машине рекусе.

2.  Удаленный рабочий стол для виртуальной машины.

3.  Откройте управление дисками (diskmgmt.msc). Задайте для диска проблемной виртуальной машины значение **Отключен**.

4.  Откройте диспетчер Hyper-V. В **диспетчере сервера** выберите **роль Hyper-V**. Щелкните сервер правой кнопкой мыши, а затем выберите **Диспетчер Hyper-V**.

5.  В диспетчере Hyper-V щелкните правой кнопкой мыши виртуальную машину спасения, а затем выберите **Создать** > **Виртуальная машина** > **Далее**.

6.  Введите имя виртуальной машины, а затем нажмите кнопку **Далее**.

7.  Выберите **Поколение 1**.

8.  Для параметра "Память при запуске" задайте значение от 1024 МБ.

9. Выберите созданный сетевой коммутатор Hyper-V, если это возможно. В противном случае перейдите к следующей странице.

10. Выберите **Подключить виртуальный жесткий диск позднее**.

    ![рисунок выбора параметра "Подключить виртуальный жесткий диск позднее"](media/troubleshoot-vm-by-use-nested-virtualization/attach-disk-later.png)

11. После создания виртуальной машины нажмите кнопку **Готово**.

12. Щелкните правой кнопкой мыши созданную виртуальную машину, а затем выберите **Параметры**.

13. Выберите **Контроллер 0 IDE**, **Жесткий диск**, а затем нажмите кнопку **Добавить**.

    ![рисунок добавления нового жесткого диска](media/troubleshoot-vm-by-use-nested-virtualization/create-new-drive.png)    

14. В разделе **Физический жесткий диск** выберите диск проблемной виртуальной машины, подключенный к виртуальной машине Azure. Если диски в списке отсутствуют, с помощью параметра "Управление дисками" проверьте заданное состояние для диска ("Отключен").

    ![рисунок с параметрами подключения диска](media/troubleshoot-vm-by-use-nested-virtualization/mount-disk.png)  


15. Нажмите кнопку **Apply** (Применить), а затем нажмите кнопку **ОК**.

16. Дважды щелкните виртуальную машину, а затем запустите ее.

17. Теперь вы можете работать на этой виртуальной машине как на локальной и выполнить необходимые действия по устранению неполадок.

## <a name="step-3-replace-the-os-disk-used-by-the-problem-vm"></a>Шаг 3. Замена диска ОС, используемого проблемной виртуальной машиной

1.  После возвращения виртуальной машины в оперативный режим завершите ее работу в диспетчере Hyper-V.

2.  [Отключите и отсоедините исправленный диск операционной системы](troubleshoot-recovery-disks-portal-windows.md#unmount-and-detach-original-virtual-hard-disk
).
3.  [Замените диск ОС, используемый виртуальной машиной, исправленным диском ОС](troubleshoot-recovery-disks-portal-windows.md#swap-the-os-disk-for-the-vm
).

## <a name="next-steps"></a>Дальнейшие действия

При возникновении проблем с подключением к виртуальной машине ознакомьтесь со статьей [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md). Для устранения проблем с доступом к приложениям, выполняющимся на виртуальной машине, прочитайте статью [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](troubleshoot-app-connection.md).
