---
title: Устранение проблем в виртуальной машине Azure на Linux или Windows
description: В этой статье описывается общая устранение неполадок виртуальной машины (VM) с помощью мониторинга и наблюдения за узкими местами и обеспечивается возможное устранение возможных проблем, которые могут возникнуть.
services: virtual-machines-windows, azure-resource-manager
documentationcenter: ''
author: v-miegge
manager: dcscontentpm
editor: ''
tags: top-support-issue, azure-resource-manager
ms.service: virtual-machines-windows
ms.workload: na
ms.tgt_pltfrm: vm-windows
ms.topic: troubleshooting
ms.date: 09/18/2019
ms.author: v-miegge
ms.openlocfilehash: 176b0634fe2c7ee2f47162e439c4ea16bde77a8a
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75772624"
---
# <a name="troubleshoot-azure-virtual-machine-performance-on-linux-or-windows"></a>Устранение проблем в виртуальной машине Azure на Linux или Windows

В этой статье описывается общая устранение неполадок виртуальной машины (VM) с помощью мониторинга и наблюдения за узкими местами и обеспечивается возможное устранение возможных проблем, которые могут возникнуть. Помимо мониторинга, вы также можете использовать Perfinsights, которые могут предоставить отчет с рекомендациями передового опыта и ключевыми узкими местами вокруг IO/CPU/Memory. Perfinsights доступен как для [Windows,](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfInsights) так и для [Linux](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfinsights-linux) VM в Azure.

Эта статья будет проходить через с помощью мониторинга для диагностики узких мест производительности.

## <a name="enabling-monitoring"></a>Включение мониторинга

### <a name="azure-iaas-virtual-machine-monitoring"></a>Мониторинг виртуальных машин Azure IAAS

Чтобы следить за Гостевой VM, используйте мониторинг Azure VM, который предупредит вас о определенных условиях ресурсов высокого уровня. Чтобы проверить, включена ли диагностика VM, смотрите [обзор журналов ресурсов Azure.](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-resource-logs) Если вы видите следующее, то вы, скорее всего, не имеют диагностики включен:

![Мониторинг не включен](media/troubleshoot-performance-virtual-machine-linux-windows/1-virtual-machines-monitoring-not-enabled.png)
 
### <a name="enable-vm-diagnostics-through-microsoft-azure-portal"></a>Включить диагностику VM через портал Microsoft Azure

Для обеспечения внедрарной диагностики:

1. Перейти к VM
2. Нажмите **Настройки Диагностики**
3. Выберите учетную запись хранения и нажмите **Enable гостевой мониторинг уровня**.

   ![Нажмите Настройки, а затем диагностика](media/troubleshoot-performance-virtual-machine-linux-windows/2-virtual-machines-diagnostics.png)

Вы можете проверить учетную запись хранения, используемую для настройки диагностики, из вкладки **Agent** в **настройках диагностики.**

![Проверка учетной записи хранилища](media/troubleshoot-performance-virtual-machine-linux-windows/3-check-storage-account.png)

### <a name="enable-storage-account-diagnostics-through-azure-portal"></a>Включить диагностику учетной записи хранилища через портал Azure

Хранение — это очень важный уровень, когда мы намерены анализировать производительность истогов для виртуальной машины в Azure. Для хранения связанных метрик нам необходимо включить диагностику в качестве дополнительного шага. Это также может быть включено, если мы хотим только проанализировать счетчики, связанные с хранением.

1. Определите, какую учетную запись (или учетные записи) использует ваш VM, выбрав VM. Нажмите **Настройки,** а затем нажмите **диски:**

   ![Нажмите Настройки, а затем диски](media/troubleshoot-performance-virtual-machine-linux-windows/4-storage-disks-disks-selection.png)

2. На портале перейдите на учетную запись (или учетные записи) для VM и проработаете следующие шаги:

   1. Нажмите обзор для учетной записи хранения, найденной выше.
   2. Будут отображаться метрики по умолчанию. 

    ![Метрики по умолчанию](media/troubleshoot-performance-virtual-machine-linux-windows/5-default-metrics.png)

3. Нажмите на любой из метрик, который покажет другой лезвие с большим количеством вариантов для настройки и добавления метрик.

   ![Добавить метрики](media/troubleshoot-performance-virtual-machine-linux-windows/6-add-metrics.png)

Для настройки следующих параметров:

1.  Выберите **метрики**.
2.  Выберите **Ресурс** (учетная запись хранения).
3.  Выберите **пространство имен**
4.  Выберите **метрику**.
5.  Выберите тип **агрегации**
6.  Вы можете закрепить это представление на приборной панели.

## <a name="observing-bottlenecks"></a>Наблюдение за узкими местами

Как только мы проработаем начальный процесс настройки необходимых метрик и пост, позволяющий проводить диагностику для VM и связанную с ней учетную запись Хранения, мы можем перейти к фазе анализа.

### <a name="accessing-the-monitoring"></a>Доступ к мониторингу

Выберите Azure VM, который вы хотите исследовать, и выберите **Мониторинг.**

![Выбрать Мониторинг](media/troubleshoot-performance-virtual-machine-linux-windows/7-select-monitoring.png)
 
### <a name="timelines-of-observation"></a>Сроки наблюдения

Чтобы определить, есть ли у вас какие-либо узкие места в ресурсах, просмотрите свои данные. Если вы обнаружите, что ваша машина работает нормально, но было сообщено, что производительность недавно деградировала, просмотрите временной диапазон данных, который охватывает данные метрики производительности до того, как было сообщено, изменено, во время и после проблемы.

### <a name="check-for-cpu-bottleneck"></a>Проверка на наличие узкого места процессора

![Проверка на наличие узких мест для процессора](media/troubleshoot-performance-virtual-machine-linux-windows/8-cpu-bottleneck-time-range.png)

1. Отсваивай график.
2. Установите диапазон времени.
3. Затем необходимо добавить в счетчик: CPU Процент Гостевой ОС
4. Щелкните Save (Сохранить).

### <a name="cpu-observe-trends"></a>ЦП наблюдает за тенденциями

При взгляде на проблемы производительности, быть в курсе тенденций и понять, если они влияют на вас. В следующих разделах мы будем использовать графики мониторинга с портала, чтобы показать тенденции. Они также могут быть полезны для перекрестного поведения ресурсов с разницей в запросах в тот же период времени. Чтобы настроить графики, нажмите [на платформу данных Azure Monitor.](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform)

Spiking - Spiking может быть связан с запланированным заданием/известным событием. Если можно определить задачу, определите, выполняется ли задача на требуемом уровне производительности. Если производительность приемлема, возможно, вам не потребуется увеличивать ресурсы.

Спайк вверх и константа - Часто указывает на новую рабочую нагрузку. Если это не признанная рабочая нагрузка, включите мониторинг в VM, чтобы выяснить, какой процесс (или процессы) вызывает поведение. Как только процесс распознается, определите, вызвано ли увеличение потребления неэффективным кодом или нормальным потреблением. Если нормальное потребление, решите, работает ли процесс на требуемом уровне производительности.

Постоянный - Определите, всегда ли ваш VM работал на этом уровне, или если он работает только на этом уровне, так как диагностика была включена. Если да, определите процесс (или процессы), вызывающие проблему, и подумайте о добавлении большего количества этого ресурса.

Устойчиво растущее - постоянное увеличение потребления часто является либо неэффективным кодом, либо процессом, принимающим большую нагрузку пользователя.

### <a name="high-cpu-utilization-remediation"></a>Высокая рекультивация использования процессора

Если приложение или процесс не работает на правильном уровне производительности, и вы видите 95% констант использования процессора, вы можете выполнить одну из следующих задач:

* Для немедленного облегчения - Увеличьте размер VM до размера с большим количеством ядер
* Поймите проблему - найдите приложение/процесс и устраните неполадки соответственно.

Если вы увеличили VM, а процессор по-прежнему работает 95%, определите, предлагает ли эта настройка более высокую производительность или более высокую пропускную способность приложения до приемлемого уровня. Если нет, то устранение неполадок, что индивидуальное приложение процесса.

Вы можете использовать Perfinsights для [Windows](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfInsights) или [Linux](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfinsights-linux) для анализа того, какой процесс является движущей силой потребления процессора. 

## <a name="check-for-memory-bottleneck"></a>Проверка на наличие узких мест в памяти

Для просмотра метрик:

1. Добавить раздел.
2. Добавьте плитку.
3. Откройте галерею.
4. Выберите использование памяти и перетащите. Когда плитка пристыкована, нажмите правой кнопкой мыши и выберите **6x4**.

### <a name="memory-observe-trends"></a>Память наблюдает за тенденциями

Использование памяти показывает, сколько памяти потребляется с помощью VM. Поймите тенденцию и отображает ли она время, когда вы видите проблемы. Вы всегда должны иметь более 100 МБ доступной памяти.

Spike и Constant/Constant Steady Consumption - Высокое использование памяти не может быть причиной плохой производительности, так как некоторые приложения, такие как реляционные двигатели базы данных, выделяют большое количество памяти, и это использование может оказаться незначительным. Однако, если есть несколько приложений, жаждущих памяти, вы можете увидеть плохую производительность от утверждения памяти, вызывая обрезку и paging/swapping на диск. Эта низкая производительность часто является заметной причиной влияния на производительность приложения.

Устойчиво едящ увеличивая потребление - по возможности применение 'разогревает', это потребление общее среди двигателей базы данных запуская вверх. Однако это также может быть знаком утечки памяти в приложении. Определите приложение и поймите, ожидается ли поведение.

Использование файлов страницы или своп - Проверьте, используете\) ли вы файл Windows `/dev/sdb`Paging (находится на D: или Linux Swap file (расположен на) в настоящее время широко используются. Если у вас нет ничего на эти тома, кроме этих файлов, проверьте высокий Чтение / Записи на этих дисках. Этот вопрос свидетельствует о низких условиях памяти.

### <a name="high-memory-utilization-remediation"></a>Исправление использования высокой памяти

Для решения проблемы высокого использования памяти выполните любую из следующих задач:

* Для немедленного облегчения или Страница или Своп использования файлов - Увеличить размер VM до одного с большей памятью, а затем контролировать.
* Понять проблему - найти приложения / процесс и устранение неполадок для выявления высокопотребляющих приложений памяти.
* Если вы знаете приложение, посмотреть, если распределение памяти может быть ограничено.

Если после обновления до большего VM, вы обнаружите, что у вас все еще есть постоянное постоянное увеличение до 100%, определить приложение / процесс и устранение неполадок.

Для анализа того, какой процесс является движущей силой потребления памяти, можно использовать Perfinsights для [Windows](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfInsights) или [Linux.](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfinsights-linux) 

## <a name="check-for-disk-bottleneck"></a>Проверка на наличие узкого места диска

Чтобы проверить подсистему хранения для VM, проверьте диагностику на уровне Azure VM, используя счетчики в VM Diagnostics, а также диагностику учетной записи хранилища.

Для VM конкретных устранения неполадок, вы можете использовать Perfinsights для [Windows](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfInsights) или [Linux](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/how-to-use-perfinsights-linux), которые могли бы помочь проанализировать, какой процесс является движущей IO. 

Обратите внимание, что у нас нет счетчиков для резервных и премиум-аккаунтов хранения. Для вопросов, связанных с этими счетчиками, поднимите пример поддержки.

### <a name="viewing-storage-account-diagnostics-in-monitoring"></a>Просмотр диагностики учетной записи хранения в мониторинге

Для работы над нижеприведенными предметами перейдите на счет хранения для ВМ на портале:

![Просмотр диагностики учетной записи хранения в мониторинге](media/troubleshoot-performance-virtual-machine-linux-windows/9-virtual-machine-storage-account.png)

1. Отсваивай график мониторинга.
2. Установите временной диапазон.
3. Добавьте счетчики, описанные в приведенных ниже шагах.
4. Сохраните изменения.

### <a name="disk-observe-trends-standard-storage-only"></a>Диск наблюдает за тенденциями (только стандартное хранилище)

Чтобы определить проблемы с хранением, посмотрите на показатели производительности из диагностики учетной записи хранения и VM Диагностика.

Для каждой проверки ниже, посмотрите на ключевые тенденции, когда проблемы возникают в пределах временного диапазона проблемы.

#### <a name="check-azure-storage-availability--add-the-storage-account-metric-availability"></a>Проверка доступности хранилища Azure - Добавить метрику учетной записи хранилища: доступность

Если вы видите снижение доступности, может возникнуть проблема с платформой, проверьте [статус Azure](https://azure.microsoft.com/status/). Если там нет проблемы, выдвинете новый запрос на поддержку.

#### <a name="check-for-azure-storage-timeout---add-the-storage-account-metrics"></a>Проверьте тайм-аут хранилища Azure - Добавьте метрики учетной записи хранилища:

* ClientTimeOutОшибка
* ServerTimeOutОшибка
* AverageE2ELatency
* AverageServerLatency
* TotalRequests

Значения в метриках «TimeOutError» указывают на то, что операция io-времени заняла слишком много времени и приурочена. Работа над следующими шагами поможет выявить потенциальные причины.

Среднее увеличениезасерверной латыни в то же время на TimeOutErrors может быть проблемой платформы. В этой ситуации выдыхайте новый запрос на поддержку.

AverageE2ELatency представляет задержку клиента. Проверьте, как IOPS выполняется приложением. Ищите увеличение или постоянно высокий показатель TotalRequests. Этот показатель представляет IOPS. Если вы начинаете хит пределы учетной записи хранения или одного VHD, задержка может быть связана с регулированием.

#### <a name="check-for-azure-storage-throttling---add-the-storage-account-metrics-throttlingerror"></a>Проверка на наличие регулирования хранилища Azure - Добавьте метрики учетной записи хранилища: ThrottlingError

Значения для регулирования указывают на то, что вы задушены на уровне учетной записи хранилища, что означает, что вы нажимаете предел IOPS учетной записи. Вы можете определить, достигаешь ли вы порога IOP, проверяя метрику **TotalRequests.**

Обратите внимание, что каждый VHD имеет лимит 500 IOPS или 60 MBits, но связан совокупным лимитом 20000 IOPS на учетную запись хранения.

С помощью этой метрики, вы не можете сказать, какие капли вызывает регулирование и которые зависят от него. Тем не менее, вы либо нажимаете ioPS или Ingress /Egress пределы учетной записи хранения.

Чтобы определить, если вы нападаете на лимит IOPS, перейдите в диагностику учетной записи хранения и проверьте TotalRequests, чтобы узнать, приближаетесь ли вы к 20 тысячам TotalRequests. Определите либо изменение шаблона, видите ли вы лимит в первый раз, или же этот предел происходит в определенное время.

При новых дисковых предложениях под стандартным хранилищем лимиты IOPS и пропускной связи могут отличаться, но совокупный лимит стандартной учетной записи хранилища составляет 20000 IOPS (Премиум-хранилище имеет различные ограничения на уровне счета или диска). Узнайте больше о различных стандартных предложениях накопителя хищных дисков и ограничениях на диск:

* [Цели масштабируемости и производительности для VM-дисков на Windows.](https://docs.microsoft.com/azure/virtual-machines/windows/disk-scalability-targets)

#### <a name="references"></a>Ссылки

* [Цели масштабируемости и производительности для учетных записей хранения капля премиум-страниц](../../storage/blobs/scalability-targets-premium-page-blobs.md)

Пропускная способность учетной записи хранилища измеряется по метрике учетной записи хранилища: TotalIngress и TotalEgress. У вас есть разные пороги пропускной способности в зависимости от типа избыточности и регионов.

* [Целевые показатели масштабируемости и производительности для учетных записей хранения ценовой категории "Стандартный"](../../storage/common/scalability-targets-standard-account.md)

Проверьте TotalIngress и TotalEgress в отношении лимитов Ingress и Egress для типа избыточности и региона избыточности учетной записи хранения.

Проверьте пределы пропускной проса ввода в эксплуатацию VHD, присоединенных к VM. Добавьте VM Metrics Disk Читать и писать.

Новые дисковые предложения под стандартным хранилищем имеют различные ioPS и ограничения пропускной памяти (IOPS не подвергаются воздействию на VHD). Посмотрите на данные, чтобы увидеть, если вы удара пределы комбинированной пропускной записи МБ VHD (ы) на уровне VM с помощью диска Читать и писать, а затем оптимизировать конфигурацию хранения VM для масштабирования прошлых отдельных пределов VHD. Узнайте больше о различных стандартных предложениях накопителя хищных дисков и ограничениях на диск:

* [Цели масштабируемости и производительности для VM-дисков на Windows.](https://docs.microsoft.com/azure/virtual-machines/windows/disk-scalability-targets)

### <a name="high-disk-utilizationlatency-remediation"></a>Высокая загрузка/задержка в использовании дисков

Снижение задержки клиентской задержки и оптимизация VM IO для масштабирования прошлых пределов VHD

* [Оптимизация истогодля для Windows в Azure](https://azure.microsoft.com/documentation/articles/virtual-machines-sql-server-performance-best-practices/)

* [Оптимизация io-кодов для Linux в Azure](https://blogs.msdn.microsoft.com/igorpag/2014/10/23/azure-storage-secrets-and-linux-io-optimizations/)

#### <a name="reduce-throttling"></a>Снижение регулирования

При ударе по верхним границам счетов хранения, повторно балансируйте VHD между учетными записями хранения. Ссылайтесь на [цели масштабирования и производительности хранилища Azure.](https://azure.microsoft.com/documentation/articles/storage-scalability-targets/)

### <a name="increase-throughput-and-reduce-latency"></a>Увеличение пропускной выхадостойки и снижение задержки

Если у вас есть приложение с информацией о задержке и вам требуется высокая пропускная память, переносите VHD в хранилище Azure Premium с помощью VM серии DS и GS.

В этих статьях обсуждаются конкретные сценарии:

* [Перенос в хранилище Azure класса Premium](https://azure.microsoft.com/documentation/articles/storage-migration-to-premium-storage/)

* [Используйте премиум-хранилище Azure с помощью сервера S'L](https://azure.microsoft.com/documentation/articles/virtual-machines-sql-server-use-premium-storage/)

## <a name="next-steps"></a>Дальнейшие действия

Если вам нужна дополнительная помощь в какой-либо момент этой статьи, обратитесь к экспертам Azure на [форумах MSDN Azure и Stack Overflow.](https://azure.microsoft.com/support/forums/)

Кроме того, подайте в файл инцидента с поддержкой Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите **«Получите поддержку».**
