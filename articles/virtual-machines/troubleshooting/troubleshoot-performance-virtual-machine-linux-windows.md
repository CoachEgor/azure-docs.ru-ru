---
title: Устранение общей производительности для виртуальной машины Azure под управлением Linux или Windows
description: В этой статье описывается универсальная диагностика производительности виртуальных машин с помощью мониторинга и наблюдения за узкими места, а также возможное исправление проблем, которые могут возникнуть.
services: virtual-machines-windows, azure-resource-manager
documentationcenter: ''
author: v-miegge
manager: dcscontentpm
editor: ''
tags: top-support-issue, azure-resource-manager
ms.service: virtual-machines-windows
ms.workload: na
ms.tgt_pltfrm: vm-windows
ms.topic: troubleshooting
ms.date: 09/18/2019
ms.author: v-miegge
ms.openlocfilehash: fc8cc4834997033203376cd33670cc907e2911e7
ms.sourcegitcommit: aef6040b1321881a7eb21348b4fd5cd6a5a1e8d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2019
ms.locfileid: "72170293"
---
# <a name="generic-performance-troubleshooting-for-azure-virtual-machine-running-linux-or-windows"></a>Устранение распространенных проблем с производительностью для виртуальной машины Azure под управлением Linux или Windows

В этой статье описывается универсальная диагностика производительности виртуальных машин с помощью мониторинга и наблюдения за узкими места, а также возможное исправление проблем, которые могут возникнуть.

## <a name="enabling-monitoring"></a>Включение мониторинга

### <a name="azure-iaas-virtual-machine-monitoring"></a>Мониторинг виртуальных машин IAAS Azure

Для мониторинга гостевой виртуальной машины используйте наблюдение за виртуальными машинами Azure, которое предупреждает вас о некоторых условиях высокого уровня ресурсов. Чтобы проверить, включена ли диагностика виртуальной машины, ознакомьтесь с [обзором журналов ресурсов Azure](https://docs.microsoft.com/azure/azure-monitor/platform/resource-logs-overview#collecting-resource-logs). Если вы видите следующее, скорее всего, диагностика не включена.

![Мониторинг не включен](media/troubleshoot-performance-virtual-machine-linux-windows/1-virtual-machines-monitoring-not-enabled.png)
 
### <a name="enable-vm-diagnostics-through-microsoft-azure-portal"></a>Включение диагностики виртуальных машин с помощью Microsoft портал Azure

Чтобы включить диагностику виртуальной машины, перейдите на виртуальную машину, щелкните **Параметры**, а затем щелкните **Диагностика**.

![Щелкните Параметры, а затем — диагностика.](media/troubleshoot-performance-virtual-machine-linux-windows/2-virtual-machines-diagnostics.png)
 
### <a name="enable-storage-account-diagnostics-through-azure-portal"></a>Включение диагностики учетной записи хранения с помощью портал Azure

Сначала выясните, какая учетная запись хранения (или учетные записи) использует виртуальная машина, выбрав виртуальную машину. Щелкните **Параметры**, а затем — **диски**:

![Щелкните Параметры, а затем — диски.](media/troubleshoot-performance-virtual-machine-linux-windows/3-storage-disks-disks-selection.png)

На портале перейдите к учетной записи хранения (или учетным записям) для виртуальной машины и выполните следующие действия.

![Выбор метрик больших двоичных объектов](media/troubleshoot-performance-virtual-machine-linux-windows/4-select-blob-metrics.png)
 
1. Выберите **все параметры**.
2. Включите диагностику.
3. Выберите *метрики *больших двоичных объектов** * и задайте срок хранения в **30** дней.
4. Сохраните изменения.

## <a name="observing-bottlenecks"></a>Наблюдение за узкими места

### <a name="accessing-the-monitoring"></a>Доступ к мониторингу

Выберите виртуальную машину Azure, которую необходимо исследовать, и выберите **мониторинг**.

![Выбор мониторинга](media/troubleshoot-performance-virtual-machine-linux-windows/5-observe-monitoring.png)
 
### <a name="timelines-of-observation"></a>Временные шкалы наблюдения

Чтобы выяснить, имеются ли узкие места в ресурсах, проверьте данные. Если вы обнаружите, что ваш компьютер работает нормально, но сообщил о том, что производительность в последнее время снижена, проверьте временной диапазон данных, охватывающий данные метрик производительности до изменения отчета, во время и после возникновения проблемы.

### <a name="check-for-cpu-bottleneck"></a>Проверка узкого места ЦП

![Проверка узкого места ЦП](media/troubleshoot-performance-virtual-machine-linux-windows/6-cpu-bottleneck-time-range.png)

1. Измените граф.
2. Задайте диапазон времени.
3. Затем необходимо добавить в счетчик: Гостевая ОС в процентах ЦП
4. Щелкните Save (Сохранить).

### <a name="cpu-observe-trends"></a>Тенденции использования ЦП

При рассмотрении проблем с производительностью учитывайте тенденции и выясните, повлияли ли они на вас. В следующих разделах мы будем использовать графы мониторинга с портала для отображения тенденций. Они также могут быть полезны при перекрестных ссылках на поведение ресурсов за тот же период времени. Чтобы настроить диаграммы, щелкните [Azure Monitor платформа данных](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform).

Перегруженный — перегруженный может быть связан с запланированной задачей или известным событием. Если вы можете определить задачу, определите, выполняется ли задача с требуемым уровнем производительности. Если производительность приемлема, вам может не потребоваться увеличивать ресурсы.

Пиковая и постоянная — часто указывает на новую рабочую нагрузку. Если это не известная Рабочая нагрузка, включите наблюдение на виртуальной машине, чтобы узнать, какой процесс (или процессы) вызывает поведение. После распознавания процесса определите, вызвано ли увеличение потребления неэффективным кодом или нормальным потреблением. При нормальном потреблении решите, работает ли процесс на требуемом уровне производительности.

Константа — определите, будет ли виртуальная машина всегда выполняться на этом уровне, или если она запущена только на этом уровне, так как диагностика включена. Если да, определите процесс (или процессы), вызвавший эту неполадку, и попробуйте добавить дополнительные ресурсы.

Непрерывное увеличение — постоянное увеличение потребления часто является либо неэффективным кодом, либо процессом, принимающим больше пользовательской рабочей нагрузки.

### <a name="high-cpu-utilization-remediation"></a>Интенсивное исправление использования ЦП

Если приложение или процесс не выполняется на правильном уровне производительности и вы видите 95% + константа использования ЦП, можно выполнить одну из следующих задач.

* Для немедленного сброса — увеличьте размер виртуальной машины до размера с дополнительными ядрами.
* Понимание проблемы — поиск приложения/процесса и устранение неполадок соответствующим образом.

Если вы увеличили виртуальную машину, и ЦП все еще работает на 95%, определите, обеспечивает ли этот параметр лучшую производительность или более высокую пропускную способность приложений на приемлемом уровне. В противном случае устраните неполадки отдельного аппликатион\процесс.

## <a name="check-for-memory-bottleneck"></a>Проверка узкого места в памяти

Чтобы просмотреть метрики, сделайте следующее:

1. Добавьте раздел.
2. Добавьте плитку.
3. Откройте коллекцию.
4. Выберите использование памяти и перетащите. Когда плитка закреплена, щелкните ее правой кнопкой мыши и выберите **6x4**.

### <a name="memory-observe-trends"></a>Тенденции наблюдения за памятью

Использование памяти показывает, сколько памяти потребляет виртуальная машина. Изучите тенденцию и сопоставляется ли она со временем возникновения проблем. Следует всегда иметь более 100 МБ доступной памяти.

Пиковое и постоянное/постоянное энергопотребление — высокий уровень использования памяти может не быть причиной плохой производительности, так как некоторые приложения, такие как ядра реляционной базы данных, распределяют большой объем памяти, и это использование может быть незначительным. Однако при наличии нескольких ресурсоемких приложений может снизиться производительность при состязании за память, что приводит к усечению и разбиению на диск. Такая низкая производительность часто является заметной причиной влияния на производительность приложения.

Стабильное увеличение потребления — возможно, это потребление является общим для запуска ядер СУБД. Однако это также может быть знаком утечки памяти в приложении. Определить приложение и понять, ожидается ли поведение.

Использование файла страницы или подкачки. Проверьте, используется ли файл подкачки Windows (расположенный на диске D: \) или Linux (расположенный в `/dev/sdb`). Если на этих томах нет ничего, Кроме этих файлов, проверьте наличие высокой доступности для чтения и записи на этих дисках. Эта проблема говорит о нехватке памяти.

### <a name="high-memory-utilization-remediation"></a>Интенсивное исправление использования памяти

Для разрешения высокого уровня использования памяти выполните следующие задачи.

* Для немедленного уменьшения или использования файла страницы или подкачки увеличьте размер виртуальной машины до одной памяти, а затем выполните мониторинг.
* Понимание проблемы. Поиск приложений и процессов и устранение неполадок для выявления ресурсоемких приложений памяти.
* Если приложение известно, проверьте, можно ли выделить память.

Если после обновления до более крупной виртуальной машины вы обнаружите постоянное стабильное увеличение до 100%, определите приложение/процесс и устраните неполадки.

## <a name="check-for-disk-bottleneck"></a>Проверка на наличие узких мест диска

Чтобы проверить подсистему хранения для виртуальной машины, проверьте диагностику на уровне виртуальной машины Azure, используя счетчики в консоли диагностики виртуальных машин, а также диагностику учетной записи хранения.

Обратите внимание, что у нас нет счетчиков для учетных записей хранения, избыточных в зонах и Premium. Для проблем, связанных с этими счетчиками, создайте обращение в службу поддержки.

### <a name="viewing-storage-account-diagnostics-in-monitoring"></a>Просмотр диагностики учетной записи хранения в мониторинге

Чтобы работать с приведенными ниже элементами, перейдите в учетную запись хранения для виртуальной машины на портале.

![Просмотр диагностики учетной записи хранения в мониторинге](media/troubleshoot-performance-virtual-machine-linux-windows/7-virtual-machine-storage-account.png)

1. Измените диаграмму мониторинга.
2. Задайте диапазон времени.
3. Добавьте счетчики, описанные в следующих шагах.
4. Сохраните изменения.

### <a name="disk-observe-trends-standard-storage-only"></a>Тенденции наблюдения за дисками (только хранилище уровня "Стандартный")

Чтобы определить проблемы с хранилищем, просмотрите метрики производительности от диагностики учетной записи хранения и диагностики виртуальных машин.

Для каждой проверки ниже найдите ключевые тенденции, возникающие при возникновении проблем в пределах временного диапазона проблемы.

#### <a name="check-azure-storage-availability--add-the-storage-account-metric-availability"></a>Проверка доступности хранилища Azure — Добавление метрики учетной записи хранения: доступность

Если вы видите возможность сброса доступности, возможно, возникла ошибка платформы, проверьте [состояние Azure](https://azure.microsoft.com/status/). Если проблем нет, порождает новый запрос в службу поддержки.

#### <a name="check-for-azure-storage-timeout---add-the-storage-account-metrics"></a>Проверьте время ожидания службы хранилища Azure. Добавьте метрики учетной записи хранения:

* ClientTimeOutError
* ServerTimeOutError
* AverageE2ELatency
* AverageServerLatency
* TotalRequests

Значения в метриках * Тимеаутеррор указывают, что операция ввода-вывода заняла слишком много времени и время ожидания истекло. Работа с дальнейшими шагами поможет определить потенциальные причины.

Значения averageserverlatency увеличивается в то же время на Тимеаутеррорс, но может быть проблемой платформы. Порождает новый запрос в службу поддержки в этой ситуации.

AverageE2ELatency представляет задержку клиента. Проверьте выполнение приложением операций ввода-вывода в секунду. Найдите более высокий или постоянный показатель TotalRequests. Эта метрика представляет операции ввода-вывода. Если вы начинаете использовать ограничения учетной записи хранения или одного виртуального жесткого диска, задержка может быть связана с регулированием.

#### <a name="check-for-azure-storage-throttling---add-the-storage-account-metrics-throttlingerror"></a>Проверка регулирования хранилища Azure. Добавьте метрики учетной записи хранения: ThrottlingError

Значения регулирования указывают, что вы регулируете на уровне учетной записи хранения, что означает, что вы используете ограничение на количество операций ввода-вывода для учетной записи. Вы можете определить, достигается ли порог операций ввода-вывода в секунду, проверив метрику **TotalRequests**.

Обратите внимание, что каждый виртуальный жесткий диск имеет ограничение в 500 операций ввода-вывода в секунду или 60 Мбит, но ограничивается совокупным ограничением в 20000 операций ввода-вывода на учетную запись хранения

С помощью этой метрики вы не можете определить, какой большой двоичный объект вызывает регулирование, и какие из них затрагиваются. Тем не менее, вы можете приступать к ограничениям операций ввода-вывода или исходящих данных учетной записи хранения.

Чтобы определить, достигается ли предельное число операций ввода-вывода в секунду, перейдите в раздел диагностика учетной записи хранения и проверьте значение TotalRequests, чтобы увидеть, приближается ли вы к 20000 TotalRequests. Укажите либо изменение в шаблоне, либо то, что вы видите в первый раз, либо это ограничение происходит в определенное время.

#### <a name="references"></a>Справочники

* [Целевые показатели масштабируемости для дисков виртуальных машин](https://azure.microsoft.com/documentation/articles/storage-scalability-targets/#scalability-targets-for-virtual-machine-disks)

Пропускная способность учетной записи хранения измеряется метриками учетной записи хранения: TotalIngress и TotalEgress. У вас есть разные пороговые значения для пропускной способности в зависимости от типа избыточности и регионов.

* [Целевые показатели масштабируемости для больших двоичных объектов, очередей, таблиц и файлов](https://azure.microsoft.com/documentation/articles/storage-scalability-targets/#scalability-targets-for-blobs-queues-tables-and-files)

Проверьте TotalIngress и TotalEgress в соответствии с ограничениями входящего и исходящего трафика для типа и региона учетной записи хранения.

Проверьте ограничения пропускной способности виртуальных жестких дисков, подключенных к виртуальной машине. Добавьте диск метрик виртуальной машины чтение и запись.

Каждый виртуальный жесткий диск может поддерживать до 60 МБ/с (операций ввода-вывода для каждого виртуального жесткого диска не предоставляется). Взгляните на данные, чтобы узнать, не превышают ли вы ограничения общей пропускной способности МБ виртуальных жестких дисков на уровне виртуальной машины, используя чтение и запись с диска, а затем Оптимизируйте конфигурацию хранилища виртуальных машин, чтобы масштабировать последние ограничения для одного виртуального жесткого диска.

### <a name="high-disk-utilizationlatency-remediation"></a>Высокая степень использования диска/исправление задержки

Сократите задержку клиента и оптимизируйте операции ввода-вывода виртуальной машины, чтобы масштабировать предыдущие ограничения VHD.

* [Оптимизация операций ввода-вывода для Windows в Azure](https://azure.microsoft.com/documentation/articles/virtual-machines-sql-server-performance-best-practices/)

* [Оптимизация операций ввода-вывода для Linux в Azure](https://blogs.msdn.microsoft.com/igorpag/2014/10/23/azure-storage-secrets-and-linux-io-optimizations/)

#### <a name="reduce-throttling"></a>Уменьшение регулирования

Если у вас есть верхние пределы учетных записей хранения, необходимо повторно сбалансировать виртуальные жесткие диски между учетными записями хранения. См. [целевые показатели масштабируемости и производительности службы хранилища Azure](https://azure.microsoft.com/documentation/articles/storage-scalability-targets/).

### <a name="increase-throughput-and-reduce-latency"></a>Увеличение пропускной способности и сокращение задержки

Если у вас есть приложение с учетом задержки и требуется высокая пропускная способность, перенесите виртуальные жесткие диски в хранилище Azure класса Premium с помощью виртуальной машины серии DS и GS.

В этих статьях обсуждаются конкретные сценарии.

* [Перенос в хранилище Azure Premium](https://azure.microsoft.com/documentation/articles/storage-migration-to-premium-storage/)

* [Использование хранилища Azure класса Premium с SQL Server](https://azure.microsoft.com/documentation/articles/virtual-machines-sql-server-use-premium-storage/)

## <a name="next-steps"></a>Следующие шаги

Если вам нужна дополнительная помощь в любой момент в этой статье, обратитесь к экспертам по Azure на [форумах MSDN Azure и Stack overflow](https://azure.microsoft.com/support/forums/).

Кроме того, можно зафайлировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**.
