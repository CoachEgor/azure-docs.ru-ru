---
title: Устранение ошибок выделения ресурсов для виртуальных машин в Azure | Документация Майкрософт
description: Устраните ошибки выделения ресурсов при создании, перезагрузке или изменении размера виртуальных машин в Azure
services: virtual-machines
documentationcenter: ''
author: DavidCBerry13
manager: felixwu
editor: ''
tags: top-support-issue,azure-resource-manager,azure-service-management
ms.assetid: 1ef41144-6dd6-4a56-b180-9d8b3d05eae7
ms.service: virtual-machines
ms.topic: troubleshooting
ms.date: 04/13/2018
ms.author: daberry
ms.openlocfilehash: fdbf07fa51adf8151e80d230734ebe53d36b5390
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "83124794"
---
# <a name="troubleshoot-allocation-failures-when-you-create-restart-or-resize-vms-in-azure"></a>Устранение ошибок выделения ресурсов при создании, перезагрузке или изменении размера виртуальных машин в Azure

При создании виртуальной машины или изменении ее размера, а также при перезагрузке остановленных (освобожденных) виртуальных машин Microsoft Azure выделяет вычислительные ресурсы для вашей подписки. Мы непрерывно изучаем дополнительные компоненты инфраструктуры и функции, чтобы всегда предоставлять клиентам требуемые типы виртуальных машин. Однако ввиду беспрецедентного роста спроса на службы Azure в определенных регионах могут происходить сбои при выделении ресурсов. Эта проблема может возникнуть при попытке создания или запуска виртуальных машин в регионе. При этом на виртуальных машинах отображается приведенное ниже сообщение об ошибке и ее код.

**Код ошибки**: AllocationFailed или ZonalAllocationFailed.

**Сообщение об ошибке**: "Сбой выделения. В этом регионе недостаточно емкости для запрошенного размера виртуальной машины. Узнайте больше о том, как повысить вероятность успеха при выделении по протоколу HTTPS: \/ /AKA.MS/Allocation-Guidance.

В этой статье объясняются причины возникновения некоторых распространенных ошибок выделения, а также представлены возможные способы их устранения.

Если проблема с Azure не устранена в этой статье, посетите [форумы Azure на веб-сайте MSDN и Stack overflow](https://azure.microsoft.com/support/forums/). Проблему можно разместить на этих форумах или отправить по адресу @AzureSupport в Twitter. Кроме того, можно отправить запрос в службу поддержки Azure, выбрав "Получить поддержку" на сайте [службы поддержки Azure](https://azure.microsoft.com/support/options/).

Пока предпочитаемый размер виртуальной машины недоступен в выбранном вами регионе, мы советуем клиентам, столкнувшимся с проблемами при развертывании, изучить рекомендации, приведенные в таблице ниже, в качестве временного решения. 

Определите сценарий, который лучше всего подходит для вашего случая, и повторите запрос на выделение, воспользовавшись предложенным решением, чтобы повысить вероятность успешного выделения ресурсов. В любом случае вы сможете повторить попытку позже. К тому моменту в кластере, регионе или зоне может освободиться достаточно ресурсов для выполнения вашего запроса. 


## <a name="resize-a-vm-or-add-vms-to-an-existing-availability-set"></a>Изменение размера виртуальной машины или добавление виртуальных машин в существующую группу доступности

### <a name="cause"></a>Причина:

Попытка выполнить запрос на изменение размера виртуальной машины или ее добавление в существующую группу доступности должна осуществляться в исходном кластере, в котором размещена существующая группа доступности. Запрошенный размер виртуальной машины поддерживается кластером, но сейчас в кластере недостаточно емкости. 

### <a name="workaround"></a>Обходной путь

Если виртуальная машина может быть частью другой группы доступности, создайте виртуальную машину в другой группе доступности (в том же регионе). Затем новую виртуальную машину можно добавить в ту же виртуальную сеть.

Остановите или освободите все виртуальные машины в пределах одной группы доступности, а затем перезапустите каждую из них.
Остановка: выберите "Группы ресурсов" > имя группы ресурсов > "Ресурсы" > имя группы доступности > "Виртуальные машины" > имя виртуальной машины > "Остановить".
После остановки всех виртуальных машин выберите первую из них и щелкните "Запустить".
Это обеспечит выполнение новой попытки выделения и возможность выбора нового кластера с доступной емкостью.

## <a name="restart-partially-stopped-deallocated-vms"></a>Перезапустите частично остановленные (освобожденные) виртуальные машины

### <a name="cause"></a>Причина:

Частичное освобождение означает, что в группе доступности будут остановлены (освобождены) одна или несколько виртуальных машин, но не все. При освобождении виртуальной машины происходит освобождение связанных с ней ресурсов. Перезапуск виртуальных машин в частично освобожденной группе доступности эквивалентен добавлению виртуальных машин к существующей группе доступности. Следовательно, попытки запроса на выделение должны выполняться на исходном кластере, на котором размещена группа доступности с недостаточной емкостью.

### <a name="workaround"></a>Обходной путь

Остановите или освободите все виртуальные машины в пределах одной группы доступности, а затем перезапустите каждую из них.
Остановка: выберите "Группы ресурсов" > имя группы ресурсов > "Ресурсы" > имя группы доступности > "Виртуальные машины" > имя виртуальной машины > "Остановить".
После остановки всех виртуальных машин выберите первую из них и щелкните "Запустить".
Это обеспечит выполнение новой попытки выделения и возможность выбора нового кластера с достаточной емкостью.

## <a name="restart-fully-stopped-deallocated-vms"></a>Перезапустите полностью остановленные (освобожденные) виртуальные машины

### <a name="cause"></a>Причина:

Полное освобождение означает, что в группе доступности остановлены (освобождены) все виртуальные машины. Запрос на выделение ресурсов для перезагрузки этих виртуальных машин будет нацелен на все кластеры, которые поддерживают нужный размер в регионе или зоне. Измените запрос на выделение согласно рекомендациям и повторите попытку выполнить его, чтобы повысить вероятность успешного выделения. 

### <a name="workaround"></a>Обходной путь

Если в используете серии или размеры виртуальных машин прежних версий, например Dv1, DSv1, Av1, D15v2 или DS15v2, рассмотрите возможность перехода на более новые версии. Ниже приведены рекомендации для определенных размеров виртуальных машин.
Если у вас нет возможности использовать другой размер виртуальной машины, попробуйте выполнить развертывание в другом регионе в пределах того же геообъекта. Дополнительные сведения о доступных размерах виртуальных машин в каждом регионе доступны по адресу https://aka.ms/azure-regions.

Если вы используете зоны доступности, попробуйте выбрать другую зону в регионе, в которой может быть достаточно емкости для запрошенного размера виртуальной машины.

Если вы выполняете большой запрос на выделение (содержащий более 500 ядер), ознакомьтесь с рекомендациями в приведенных ниже разделах, чтобы разделить этот запрос на развертывания меньшего размера.

Попробуйте [повторно развернуть виртуальную машину](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/redeploy-to-new-node-windows). При повторном развертывании виртуальная машина выделяется в новом кластере в регионе.

## <a name="allocation-failures-for-older-vm-sizes-av1-dv1-dsv1-d15v2-ds15v2-etc"></a>Сбои при выделении ресурсов для размеров виртуальных машин прежних версий (Av1, Dv1, DSv1, D15v2, DS15v2 и т. д.)

По мере расширения инфраструктуры Azure мы развертываем оборудование нового поколения, предназначенное для виртуальных машин последних типов. Некоторые виртуальные машины устаревших серий не работают в нашей инфраструктуре последнего поколения. По этой причине клиенты могут время от времени сталкиваться со сбоями при выделении ресурсов для этих устаревших номеров SKU. Чтобы избежать этой проблемы, мы рекомендуем клиентам, использующим виртуальные машины устаревших серий, рассмотреть возможность перехода на эквивалентные новые виртуальные машины согласно приведенным ниже рекомендациям. Эти виртуальные машины оптимизированы для новейшего оборудования и позволяют получить преимущества за счет более низких затрат и более высокой производительности. 

|Устаревшая серия или размер виртуальной машины|Рекомендуемая серия или размер виртуальной машины|Дополнительные сведения|
|----------------------|----------------------------|--------------------|
|Серия Av1|[Серия Av2](../av2-series.md)|https://azure.microsoft.com/blog/new-av2-series-vm-sizes/
|Серия Dv1 или DSv1 (с D1 по D5)|[Серия Dv3 или DSv3](../dv3-dsv3-series.md)|https://azure.microsoft.com/blog/introducing-the-new-dv3-and-ev3-vm-sizes/
|Серия Dv1 или DSv1 (с D11 по D14)|[Серия Ev3 или ESv3](../ev3-esv3-series.md)|
|Серия D15v2 или DS15v2|Если вы используете модель развертывания с помощью Resource Manager, чтобы использовать преимущества более крупных размеров виртуальных машин, рассмотрите возможность перехода на серию D16v3, DS16v3, D32v3 или DS32v3. Они предназначены для оборудования последнего поколения. Если вы используете модель развертывания с помощью Resource Manager, чтобы изолировать экземпляр виртуальной машины, выполняя его на оборудовании, выделенном для отдельного клиента, рассмотрите возможность перехода на новый размер изолированной виртуальной машины, E64i_v3 или E64is_v3. Они предназначены для оборудования последнего поколения. |https://azure.microsoft.com/blog/new-isolated-vm-sizes-now-available/

## <a name="allocation-failures-for-large-deployments-more-than-500-cores"></a>Сбои при выделении ресурсов для больших развертываний (более 500 ядер)

Уменьшите число экземпляров виртуальных машин запрошенного размера, после чего повторите операцию развертывания. Кроме того, для больших развертываний вы можете рассмотреть использование [масштабируемых наборов виртуальных машин Azure](https://docs.microsoft.com/azure/virtual-machine-scale-sets/). Число экземпляров виртуальных машин может автоматически изменяться в соответствии с потребностями или определенным расписанием. При этом вероятность успешного развертывания достаточно велика, так как развертывания распределены между несколькими кластерами. 

## <a name="background-information"></a>Справочная информация
### <a name="how-allocation-works"></a>Как выделяются ресурсы
Серверы в центрах обработки данных Azure разделены на кластеры. Как правило, попытка выполнить запрос на выделение ресурсов происходит в нескольких кластерах. Однако возможен вариант, когда при наличии определенных ограничений в запросах на выделение на платформе Azure произойдет принудительная попытка выполнения запроса только в одном кластере. В этой статье мы будем называть этот процесс прикреплением к кластеру. На схеме 1 ниже показан случай обычного выделения при попытке выполнения в нескольких кластерах. На схеме 2 показано выделение ресурсов, прикрепленных к кластеру 2, так как в нем размещена имеющаяся облачная служба CS_1 или группа доступности.
![Схема выделения ресурсов](./media/virtual-machines-common-allocation-failure/Allocation1.png)

### <a name="why-allocation-failures-happen"></a>Причины возникновения ошибок выделения ресурсов
Если запрос на выделение прикреплен к одному кластеру, возрастает вероятность того, что не удастся найти свободные ресурсы, так как пул доступных ресурсов имеет меньший размер. Кроме того, если запрос на выделение прикреплен к одному кластеру, а тип запрошенного ресурса не поддерживается, запрос завершится ошибкой, даже если в кластере есть свободные ресурсы. На схеме 3 ниже показан случай, когда ошибка выделения закрепленных ресурсов произошла из-за отсутствия свободных ресурсов в единственном подходящем кластере. На схеме 4 показан случай, когда ошибка выделения прикрепленных ресурсов произошла потому, что единственный подходящий кластер не поддерживает запрошенный размер виртуальной машины, несмотря на наличие свободных ресурсов в кластере.

![Ошибка выделения прикрепленных ресурсов](./media/virtual-machines-common-allocation-failure/Allocation2.png)


