---
title: Брандмауэр гостевой ОС виртуальной машины Azure настроен неправильно | Документация Майкрософт
description: Узнайте, как использовать последовательную консоль или метод Offline для диагностики и исправления неправильно настроенного брандмауэра гостевой операционной системы на удаленной виртуальной машине Azure.
services: virtual-machines-windows
documentationcenter: ''
author: Deland-Han
manager: dcscontentpm
editor: ''
tags: ''
ms.service: virtual-machines
ms.topic: troubleshooting
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: azurecli
ms.date: 11/22/2018
ms.author: delhan
ms.openlocfilehash: e6f42bdf462ac5261f77bc05c62e50500345fe37
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "80422535"
---
# <a name="azure-vm-guest-os-firewall-is-misconfigured"></a>Брандмауэр гостевой ОС виртуальной машины Azure настроен неправильно

В этой статье представлены способы устранения неправильной настройки брандмауэра гостевой ОС на виртуальной машине Azure.

## <a name="symptoms"></a>Симптомы

1.  На экране приветствия виртуальной машины показано, что виртуальная машина полностью загружена.

2.  В зависимости от настройки гостевой ОС часть сетевого трафика или весь сетевой трафик может не поступать в виртуальную машину.

## <a name="cause"></a>Причина:

Из-за неправильной настройки брандмауэр гостевой системы может блокировать некоторые или все виды сетевого трафика в виртуальную машину.

## <a name="solution"></a>Решение

Прежде чем выполнять какие-либо действия, сделайте моментальный снимок диска системы затронутой виртуальной машины в качестве резервной копии. Дополнительные сведения см. в статье [Создание моментального снимка](../windows/snapshot-copy-managed-disk.md).

Чтобы устранить эту проблему, воспользуйтесь последовательной консолью или [восстановите виртуальную машину в автономном режиме](troubleshoot-rdp-internal-error.md#repair-the-vm-offline), присоединив ее системный диск к виртуальной машине для восстановления.

## <a name="online-mitigations"></a>Устранение рисков в сети

Подключитесь к [последовательной консоли и откройте экземпляр PowerShell](serial-console-windows.md#use-cmd-or-powershell-in-serial-console). Если последовательная консоль не включена на виртуальной машине, перейдите к разделу "Автономное восстановление виртуальной машины" следующей статьи Azure:

 [Внутренняя ошибка при попытке подключения к виртуальной машине Azure через удаленный рабочий стол](troubleshoot-rdp-internal-error.md#repair-the-vm-offline)

Следующие правила можно изменить, чтобы разрешить доступ к виртуальной машине (через RDP) или упростить возможности устранения неполадок:

*   Удаленный рабочий стол (TCP — входящий трафик): это стандартное правило, предоставляющее к виртуальной машине основной доступ за счет разрешения трафика RDP в Azure.

*   Служба удаленного управления Windows (HTTP — входящий трафик): это правило позволяет подключиться к виртуальной машине с использованием PowerShell. В Azure с таким видом доступа можно использовать скрипты удаленного написания скриптов и устранения неполадок.

*   Совместный доступ к файлам и принтерам (SMB — входящий трафик): это правило активирует доступ к сетевой папке в качестве средства устранения неполадок.

*   Совместный доступ к файлам и принтерам (запрос проверки связи — ICMPv4 — входящий трафик): это правило позволяет проверить связь с виртуальной машиной.

В экземпляре доступа к последовательной консоли можно запрашивать сведения о текущем состоянии правила брандмауэра.

*   Запрос с использованием отображаемого имени в качестве параметра:

    ```cmd
    netsh advfirewall firewall show rule dir=in name=all | select-string -pattern "(DisplayName.*<FIREWALL RULE NAME>)" -context 9,4 | more
    ```

*   Запрос с использованием локального порта, применяемого приложением:

    ```cmd
    netsh advfirewall firewall show rule dir=in name=all | select-string -pattern "(LocalPort.*<APPLICATION PORT>)" -context 9,4 | more
    ```

*   Запрос с использованием локального IP-адреса, применяемого приложением:

    ```cmd
    netsh advfirewall firewall show rule dir=in name=all | select-string -pattern "(LocalIP.*<CUSTOM IP>)" -context 9,4 | more
    ```

*   Если вы видите, что правило отключено, его можно включить, выполнив следующую команду:

    ```cmd
    netsh advfirewall firewall set rule name="<RULE NAME>" new enable=yes
    ```

*   Для устранения неполадок можно отключить профили брандмауэра:

    ```cmd
    netsh advfirewall set allprofiles state off
    ```

    Если вы сделаете это для правильной установки брандмауэра, повторно включите его после завершения устранения неполадок.

    > [!Note]
    > Чтобы применить это изменение, не нужно перезапускать виртуальную машину.

*   Повторите попытку подключения к виртуальной машине по протоколу RDP.

### <a name="offline-mitigations"></a>Автономные способы решения

1.  Чтобы включить или отключить правила брандмауэра, см. статью [Включение или отключение правила брандмауэра в гостевой ОС виртуальной машины Azure](enable-disable-firewall-rule-guest-os.md).

2.  Проверьте, не [блокирует ли брандмауэр гостевой ОС входящий трафик](guest-os-firewall-blocking-inbound-traffic.md).

3.  Если по-прежнему не уверены, блокирует ли брандмауэр доступ, обратитесь к разделу [Disable the guest OS Firewall in Azure VM](disable-guest-os-firewall-windows.md) (Отключение брандмауэра гостевой ОС на виртуальной машине Azure), а затем повторно включите брандмауэр гостевой системы, используя правильные правила.

