---
title: Виртуальная машина не отвечает при применении политики "групповая политика локальные пользователи & группы"
description: В этой статье приведены инструкции по устранению проблем, в которых экран загрузки зависает при применении политики во время загрузки виртуальной машины Azure.
services: virtual-machines-windows
documentationcenter: ''
author: v-miegge
manager: dcscontentpm
editor: ''
tags: azure-resource-manager
ms.assetid: ff113268-f5bf-4e6a-986e-63b9b0ceff20
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.topic: troubleshooting
ms.date: 04/02/2020
ms.author: v-mibufo
ms.openlocfilehash: 085880122e9a80e976cfe59686748b58aeba1922
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80620861"
---
# <a name="virtual-machine-is-unresponsive-while-applying-group-policy-local-users--groups-policy"></a>Виртуальная машина не отвечает при применении политики "групповая политика локальные пользователи & группы"

В этой статье приведены инструкции по устранению проблем, в которых экран загрузки зависает при применении политики во время загрузки на виртуальной машине Azure.

## <a name="symptom"></a>Симптом

При использовании [диагностики загрузки](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/boot-diagnostics) для просмотра снимка экрана виртуальной машины вы увидите, что экран зависает при загрузке с сообщением: *применение групповая политика политики "Локальные пользователи и группы*".

![Замещающий текст: экран, показывающий применение групповая политика локальным пользователям и группам Загрузка политики (Windows Server 2012).](media/troubleshoot-vm-unresponsive-group-policy-local-users/1.png)

Windows Server 2012

![Замещающий текст: экран, показывающий применение групповая политика локальным пользователям и группам Загрузка политики (Windows Server 2012 R2).](media/troubleshoot-vm-unresponsive-group-policy-local-users/2.png)

Windows Server 2012 R2

## <a name="cause"></a>Причина

Симптомы этого зависания вызваны дефектом кода в библиотеке динамической компоновки службы профилей Windows (*профсвк. dll*).

> [!NOTE]
> Этот дефект относится только к Windows Server 2012 и Windows Server 2012 R2.

### <a name="the-policy-in-question"></a>Рассматриваемая политика

Применяемая политика не завершает свои процессы:

* *Шаблоны конфигурации компьютера \ Системный/пользователь Профилес\делете профили пользователей старше указанного числа дней при перезапуске системы*

Эта политика зависает, только если выполняются следующие шесть условий:

* Параметр " *удалять профили пользователей старше указанного числа дней" в политике перезапуска системы* включен.
* У вас есть профили, которые удовлетворяют требованиям к возрасту, чтобы требовать очистки.
* У вас есть компоненты, зарегистрированные для уведомлений об удалении профилей.
* Компоненты выполняют вызовы (прямые или косвенные), которые должны получать данные от компонентов диспетчера управления службами (SCM) Windows, например запуск, остановку или запрос сведений о службе.
* У вас есть служба, настроенная для *автоматического*запуска.
* Эта служба настроена для запуска в контексте учетной записи домена (в отличие от использования встроенной учетной записи, такой как локальная система).

### <a name="the-code-defect"></a>Дефект кода

Ошибка в коде связана с тем, что диспетчер управления службами (SCM) и службы профиля пытаются применить блокировки друг к другу одновременно. Существуют блокировки, предотвращающие одновременное внесение изменений несколькими службами в одни и те же данные, что приведет к повреждению. Как правило, несколько запросов на блокировку не вызывают проблемы. Однако поскольку это происходит во время загрузки, ни одна из служб не может завершить свои процессы, так как они задерживаются в ожидании друг друга.

### <a name="os-bug-5880648---service-control-manager-deadlocks-with-the-delete-user-profiles-on-restart-policy"></a>Ошибка ОС 5880648 — диспетчер управления службами взаимоблокировки с политикой "Удаление профилей пользователей при перезапуске"

Существует два действия, которые перекрываются, чтобы:

* Действие 1 получает блокировку профиля, но еще не получила блокировку SCM.

  **ПЕРЕТАСКИВАНИ**

* Действие 2 получает блокировку SCM, но еще не получила блокировку профиля.

После возникновения такой взаимоблокировки попытка получить вторую требуемую блокировку зависает.

### <a name="action-1---old-profile-deletion-notification-has-profile-lock-needs-scm-lock"></a>Действие 1. устаревшее уведомление об удалении профиля (имеет **блокировку профиля**, требуется **Блокировка SCM**)

1. Во первых, политика, настроенная на удаление старых профилей, получает блокировку внутренней службы профилей.

   * Эта блокировка позволяет предотвратить взаимодействие двух потоков с профилями во время выполнения *операции удаления* .

2. Политика находит профили, которые достаточно старые для удаления.
3. В ходе удаления профиля компонент, зарегистрированный для уведомлений об удалении профиля, пытается **запустить службу**.
4. Перед запуском службы диспетчеру управления службами (SCM) необходимо получить **внутреннюю БЛОКИРОВКУ SCM** , удерживаемую потоками в **действии 2**.

### <a name="action-2---profile-loadcreation-for-user-specific-data-has-scm-lock-needs-profile-lock"></a>Действие 2. Профилирование загрузки или создания данных для конкретного пользователя (с **блокировкой SCM**, требуется **Блокировка профиля**)

1. Во время загрузки SCM должен упорядочить все службы *автозапуска* по группе, а также к любым службам, от которых зависят эти службы.

2. **SCM Получает внутреннюю БЛОКИРОВКУ SCM** , используемую для управления доступом к запуску, остановке или настройке служб по мере того, как она упорядочивает службы.

3. После того, как службы упорядочены, SCM просматривает каждую службу и запускает ее.

4. Если служба выполняется в контексте учетной записи домена, профиль должен быть либо загружен, либо создан для учетной записи домена, чтобы он мог хранить данные, относящиеся к пользователю.

5. Этот запрос отправляется в **службу профиля**.

6. Службе профиля требуется доступ к **внутренней блокировке** , полученной в **действии 1**.

## <a name="solution"></a>Решение

### <a name="process-overview"></a>Обзор процесса

1. Создание виртуальной машины для восстановления и доступ к ней
2. Включение сбора последовательной консоли и дампа памяти
3. Перестроение виртуальной машины
4. Получение файла дампа памяти

   > [!NOTE]
   > При возникновении этой ошибки загрузки гостевая ОС не работает. Для устранения этой проблемы вы будете устранять неполадки в автономном режиме.

### <a name="create-and-access-a-repair-vm"></a>Создание виртуальной машины для восстановления и доступ к ней

1. Выполните [шаги 1-3 команды восстановления виртуальной машины](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/repair-windows-vm-using-azure-virtual-machine-repair-commands#repair-process-example) , чтобы подготовить виртуальную машину восстановления.
2. С помощью подключение к удаленному рабочему столу подключитесь к виртуальной машине восстановления.

### <a name="enable-serial-console-and-memory-dump-collection"></a>Включение сбора последовательной консоли и дампа памяти

Чтобы включить сбор дампов памяти и последовательную консоль, выполните приведенный ниже сценарий.

1. Откройте сеанс командной строки с повышенными привилегиями (Запуск от имени администратора).
2. Выполните следующие команды:

   * Включить последовательную консоль:

     `bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /ems {<BOOT LOADER IDENTIFIER>} ON`

     `bcdedit /store <VOLUME LETTER WHERE THE BCD FOLDER IS>:\boot\bcd /emssettings EMSPORT:1 EMSBAUDRATE:115200`

3. Убедитесь, что объем свободного места на диске ОС совпадает с объемом памяти (ОЗУ) виртуальной машины.

   * Если на диске операционной системы недостаточно места, следует изменить расположение файла дампа памяти и сослаться на любой диск данных, подключенный к виртуальной машине, имеющей достаточно свободного места. Чтобы изменить расположение, замените `%SystemRoot%` буквой диска (например, "F:") диска данных в приведенных ниже командах.

#### <a name="suggested-configuration-to-enable-os-dump"></a>Рекомендуемая конфигурация для включения дампа ОС

**Загрузка неработающего диска ОС:**

`REG LOAD HKLM\BROKENSYSTEM <VOLUME LETTER OF BROKEN OS DISK>:\windows\system32\config\SYSTEM`

**Включить в ControlSet001:**

`REG ADD "HKLM\BROKENSYSTEM\ControlSet001\Control\CrashControl" /v CrashDumpEnabled /t REG_DWORD /d 1 /f`

`REG ADD "HKLM\BROKENSYSTEM\ControlSet001\Control\CrashControl" /v DumpFile /t REG_EXPAND_SZ /d "%SystemRoot%\MEMORY.DMP" /f`

`REG ADD "HKLM\BROKENSYSTEM\ControlSet001\Control\CrashControl" /v NMICrashDump /t REG_DWORD /d 1 /f`

**Включить в ControlSet002:**

`REG ADD "HKLM\BROKENSYSTEM\ControlSet002\Control\CrashControl" /v CrashDumpEnabled /t REG_DWORD /d 1 /f`

`REG ADD "HKLM\BROKENSYSTEM\ControlSet002\Control\CrashControl" /v DumpFile /t REG_EXPAND_SZ /d "%SystemRoot%\MEMORY.DMP" /f`

`REG ADD "HKLM\BROKENSYSTEM\ControlSet002\Control\CrashControl" /v NMICrashDump /t REG_DWORD /d 1 /f`

### <a name="rebuild-the-vm"></a>Перестроение виртуальной машины

Чтобы заново собрать виртуальную машину, используйте [Шаг 5 команд восстановления виртуальной машины](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/repair-windows-vm-using-azure-virtual-machine-repair-commands#repair-process-example) .

### <a name="collect-the-memory-dump-file"></a>Получение файла дампа памяти

Чтобы устранить эту проблему, необходимо сначала собрать файл дампа памяти для аварийного восстановления и обратиться в службу поддержки с файлом дампа памяти. Чтобы получить файл дампа, выполните следующие действия.

#### <a name="attach-the-os-disk-to-a-new-repair-vm"></a>Подключение диска ОС к новой виртуальной машине восстановления

1. Выполните шаги [1-3 команды восстановления виртуальной машины](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/repair-windows-vm-using-azure-virtual-machine-repair-commands#repair-process-example) , чтобы ПОДГОТОВИТЬ новую виртуальную машину для восстановления.

2. С помощью подключение к удаленному рабочему столу подключитесь к виртуальной машине восстановления.

#### <a name="locate-the-dump-file-and-submit-a-support-ticket"></a>Размещение файла дампа и отправка запроса в службу поддержки

1. На виртуальной машине восстановления перейдите в папку Windows на подключенном диске ОС. Если подключенному диску ОС присвоена буква F, то необходимо перейти в F:\Windows.

2. Найдите файл Memory. dmp и отправьте запрос в [службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade) с файлом дампа памяти.

3. Если при поиске файла Memory. dmp возникают проблемы, можно использовать [вызовы прерываний (NMI) в последовательной консоли](https://docs.microsoft.com/azure/virtual-machines/troubleshooting/serial-console-windows#use-the-serial-console-for-nmi-calls) . Вы можете следовать инструкциям по [созданию ядра или полному](https://docs.microsoft.com/windows/client-management/generate-kernel-or-complete-crash-dump) файлу аварийного дампа с помощью вызовов NMI.
