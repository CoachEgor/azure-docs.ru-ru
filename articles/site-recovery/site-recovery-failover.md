---
title: Выполнить сбой во время аварийного восстановления с восстановлением сайта Azure
description: Как выйти из строя на серверах VMs/физических серверов в Azure с помощью восстановления сайта Azure.
ms.service: site-recovery
ms.topic: article
ms.date: 12/10/2019
ms.openlocfilehash: 99a197e8f5ebac8a3b0be1b567ee41b43a2c4476
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79471274"
---
# <a name="run-a-failover-from-on-premises-to-azure"></a>Выполнение отработки отказа из локальной среды в Azure

В этой статье описывается, как выйти из строя на непредподанных машинах для Azure в [восстановлении сайта Azure](site-recovery-overview.md)

## <a name="before-you-start"></a>Перед началом работы

- [Узнайте](failover-failback-overview.md) о процессе сбоя в аварийном восстановлении.
- Если вы хотите потерпеть неудачу в нескольких машинах, [узнайте,](recovery-plan-overview.md) как собрать машины вместе в плане восстановления.
- Прежде чем вы сделаете полный сбой, запустите [аварийное восстановление упражнения,](site-recovery-test-failover-to-azure.md) чтобы убедиться, что все работает, как ожидалось.

## <a name="prepare-to-connect-after-failover"></a>Подготовка к подключению после сбоя

Чтобы убедиться, что вы можете подключиться к VMs Azure, которые создаются после неудачи, вот ряд вещей, которые необходимо сделать на месте до неудачи.


### <a name="prepare-on-premises-to-connect-after-failover"></a>Подготовка к подключению к помещению после сбоя

Если вы хотите подключиться к MMs-м вммисажут azure с помощью RDP/SSH после сбоя, есть несколько вещей, которые необходимо сделать на месте до неудачи.

**После неудачи** | **Расположение** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | Локальный компьютер до отработки отказа | Чтобы получить доступ к виртуальной машине Azure через Интернет, включите протокол RDP и проверьте, добавлены ли правила TCP и UDP в разделе **Общее** и разрешен ли протокол RDP в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.<br/><br/> Чтобы получить доступ к VM Azure через подключение к сайту, включите RDP на машине и убедитесь, что RDP разрешено в **Windows Firewall** -> **Разрешенные приложения и функции,** для **доменов и частных** сетей.<br/><br/> <br/><br/> Удалите все статические постоянные маршруты и прокси WinHTTP. Задайте для политики сети SAN операционной системы значение **OnlineAll**. Ознакомьтесь с [дополнительными сведениями](https://support.microsoft.com/kb/3031135).<br/><br/> Прежде чем активировать отработку отказа, убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows. Когда вы начнете отработку отказа, может начаться обновление Windows. В этом случае вы не сможете войти на виртуальную машину до завершения обновления.
**Виртуальная машина Azure под управлением Linux** | Локальный компьютер до отработки отказа | Настройте автоматический запуск службы SSH на виртуальной машине при загрузке системы (если он еще не настроен).<br/><br/> Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.


## <a name="run-a-failover"></a>Запуск отработки отказа

В этой процедуре описывается, как запустить отработку отказа для [плана восстановления](site-recovery-create-recovery-plans.md). Если вы хотите запустить сбой для одного VM, следуйте инструкциям для [VMware VM](vmware-azure-tutorial-failover-failback.md), [физический сервер,](physical-to-azure-failover-failback.md)или [Hyper-V VM](hyper-v-azure-failover-failback-tutorial.md).


Выполнить план восстановления неудачу следующим образом:

1. В хранилище восстановления сайта выберите **планы** > восстановления*recoveryplan_name.*
2. Щелкните **Отработка отказа**.

    ![Отработка отказа](./media/site-recovery-failover/Failover.png)

3. В направлении **Failover** > **Failover**оставьте значение по умолчанию, если вы воспроизводите в Azure.
4. В **Failover**выберите **точку восстановления,** к которой не удастся.

    - **Последние**: Используйте последнюю точку. Это обрабатывает все данные, отправленные в службу восстановления сайта, и создает точку восстановления для каждой машины. Эта опция обеспечивает самую низкую RPO (Цель точки восстановления), потому что VM, созданный после сбоя, имеет все данные, которые были воспроизведены в восстановлении сайта, когда срабатывал сбой.
   - **Последние обработанные**: Используйте эту опцию, чтобы потерпеть неудачу над VMs до последней точки восстановления, уже обработанной Восстановлением сайта. Вы можете увидеть последнюю точку восстановления обработанной обработки в **точках восстановления**VM latest Recovery Points. Эта опция обеспечивает низкий RTO, так как время не тратится на обработку необработанных данных
   - **Последние приложения последовательной**: Используйте эту опцию, чтобы не VMs к последнему приложению последовательной точки восстановления, которая была обработана восстановление сайта.
   - **Последние мульти-VM обработаны**: С этой опцией VMs, которые являются частью группы репликации failover к последней общей мульти-VM последовательной точки восстановления. Другие виртуальные машины не справляются со своей последней точкой восстановления. Эта опция предназначена только для планов восстановления, в которых есть по крайней мере один VM с включенной мульти-VM последовательности.
   - **Последние мульти-VM приложение-последовательно:** С этой опцией VMs, которые являются частью группы репликации не до конца последней общей мульти-VM-приложение последовательной точки восстановления. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением. Только для планов восстановления, которые имеют по крайней мере один VM с включенным мульти-VM согласованности.
   - **Пользовательские**: Недоступны для планов восстановления. Эта опция предназначена только для отказа отдельных ВМ.

5. Выберите **выключенную машину перед началом неудачи,** если вы хотите, чтобы восстановление сайта выключите исходные вымотворные вымотки перед запуском сбоя. Отработка отказа продолжится, даже если их не удастся отключить.  

    > [!NOTE]
    > Если вы не справляетесь с Hyper-V VM, выключение пытается синхронизировать и воспроизвести данные, которые еще не были отправлены в службу, прежде чем запустить сбой. 

6. Следите за ходом сбоя на странице **Вакансии.** Даже если ошибки возникают, план восстановления выполняется до тех пор, пока он не будет завершен.
7. После неудачи, вопить в VM, чтобы проверить его. 
8. Если требуется переключиться на другую точку восстановления для использования для сбоя, используйте **точку восстановления изменения.**
9. Когда вы будете готовы, вы можете совершить сбой. Действие **Commit** удаляет все точки восстановления, доступные службе. Опция **точки восстановления изменений** больше не будет доступна.

## <a name="run-a-planned-failover-hyper-v"></a>Выполнить запланированный сбой (Hyper-V)

Вы можете запустить запланированный сбой для Hyper-V VMs.

- Запланированный отказ — это нулевой вариант потери данных.
- Когда выполняется плановая отработка отказа, сначала завершается работа исходных виртуальных машин, затем синхронизируются последние данные, и лишь затем запускается отработка отказа.
- Вы запустите запланированный сбой, используя опцию **Planned failover.** Он работает таким же образом, чтобы регулярно failover.
 
## <a name="track-failovers"></a>Сбой треков

Существует ряд заданий, связанных с сбой.

![Отработка отказа](./media/site-recovery-failover/FailoverJob.png)

- **Проверка предпосылок**: Гарантирует, что все условия, необходимые для сбоя, выполнены.
- **Failover**: Обрабатывает данные таким образом, чтобы из него можно было создать VM Azure. Если вы выбрали **последнюю** точку восстановления, из данных, отправленных в службу, создается точка восстановления.
- **Запуск:** Создает VM Azure с использованием данных, обработанных на предыдущем этапе.

> [!WARNING]
> **Не отменяйте сбой в процессе:** Перед началом сбоя репликация s остановлена для VM. Если вы отмените незавершенное задание, отказ останавливается, но VM не начнет реплицироваться. Репликация не может быть запущена снова.


### <a name="extra-failover-time"></a>Дополнительное время сбоя

В некоторых случаях, VM failover требует промежуточного шага, который обычно занимает около восьми до 10 минут, чтобы завершить. Это машины, которые зависят от этого дополнительного шага / времени:

* Виртуальные машины VMware под управлением версии службы Mobility старше 9.8.
* Физические серверы и визы Hyper-V защищены как физические серверы.
* виртуальные машины Linux VMware;
* VMware VMs, на которых эти драйверы не присутствуют в качестве драйверов загрузки:
    * storvsc;
    * vmbus;
    * storflt;
    * intelide;
    * atapi;
* VM VMw, в которых нет включена DHCP, независимо от того, используют ли они DHCP или статические IP-адреса.


## <a name="automate-actions-during-failover"></a>Автоматизировать действия во время сбоя

Возможно, вы захотите автоматизировать действия во время сбоя. Для этого можно использовать скрипты или запуски автоматизации Azure в планах восстановления.

- [Узнайте](site-recovery-create-recovery-plans.md) о создании и настройке планов восстановления, включая добавление скриптов.
- [Узнайте](site-recovery-runbook-automation.md) о добавлении runbooks Azure Automation в планы восстановления.


## <a name="configure-settings-after-failover"></a>Настройка настроек после сбоя

### <a name="retain-drive-letters-after-failover"></a>Сохранить дисковые буквы после сбоя

Восстановление сайта обрабатывает удержание дисковых букв. Если вы исключаете диски во время репликации VM, [просмотрите пример](exclude-disks-replication.md#example-1-exclude-the-sql-server-tempdb-disk) того, как это работает.

### <a name="prepare-in-azure-to-connect-after-failover"></a>Подготовка к подключению в Azure после сбоя

Если требуется подключиться к MMs-мизантам Azure, которые создаются после сбоя с помощью RDP или SSH, следуйте требованиям, обобщенным в таблице.

**Отказоустойчивого** | **Расположение** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | Виртуальная машина Azure после отработки отказа |  [Добавьте общедоступный IP-адрес](https://aka.ms/addpublicip) для виртуальной машины.<br/><br/> Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту RDP.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/> Если вы не можете подключиться, убедитесь, что VM работает, и просмотрите эти [советы по устранению неполадок.](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx)
**Виртуальная машина Azure под управлением Linux** | Виртуальная машина Azure после отработки отказа | Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.<br/><br/> [Добавьте общедоступный IP-адрес](https://aka.ms/addpublicip) для виртуальной машины.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/>

Для устранения проблем с подключением после отработки отказа выполните шаги, описанные [здесь](site-recovery-failover-to-azure-troubleshoot.md).

## <a name="set-up-ip-addressing"></a>Настройка IP-адреса

- **Внутренние IP-адреса**: Чтобы установить внутренний IP-адрес Azure VM после сбоя, у вас есть несколько вариантов:
    - Сохранить тот же IP-адрес: Вы можете использовать тот же IP-адрес на Azure VM, что и тот, который выделен для внепредки.
    - Используйте другой IP-адрес: Вы можете использовать другой IP-адрес для Azure VM.
    - [Подробнее](concepts-on-premises-to-azure-networking.md#assign-an-internal-address) о настройке внутренних IP-адресов.
- **Внешние IP-адреса**: Вы можете сохранить общедоступные IP-адреса при сбоях. Им. Azure, созданным в рамках процесса сбоя, должен быть присвоен общедоступный IP-адрес Azure, доступный в регионе Azure. Вы можете назначить общедоступный IP-адрес либо вручную, либо автоматизируя процесс с помощью плана восстановления. Ознакомьтесь с [дополнительными сведениями](concepts-public-ip-address-with-site-recovery.md).


## <a name="next-steps"></a>Дальнейшие действия

После того, как вы не смогли переукходить, необходимо повторно защитить, чтобы начать воспроизведение VMs Azure обратно на сайт. После того, как репликация запущена и запущена, вы можете выполнить неудачу, когда вы будете готовы.

- [Узнайте больше](failover-failback-overview.md#reprotectionfailback) о резащите и отказе.
- [Приготовьтесь к](vmware-azure-reprotect.md) повторной защите и отказу VMware.
- [Отказ назад](hyper-v-azure-failback.md) Гипер-V VMs.
- [Узнайте о](physical-to-azure-failover-failback.md) процессе сбоя и отказа для физических серверов.

