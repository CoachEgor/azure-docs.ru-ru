---
title: Подключение к виртуальным машинам Azure после отработки отказа из локальной среды в Azure с помощью Azure Site Recovery
description: В этой статье описывается, как подключиться к виртуальным машинам Azure после отработки отказа из локальной среды в Azure с помощью Azure Site Recovery
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 10/03/2019
ms.author: mayg
ms.openlocfilehash: 182c93ea0b887242d142eda5aeb44b2749c7ac66
ms.sourcegitcommit: f2d9d5133ec616857fb5adfb223df01ff0c96d0a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2019
ms.locfileid: "71937557"
---
# <a name="connect-to-azure-vms-after-failover-from-on-premises"></a>Подключение к виртуальным машинам Azure после отработки отказа из локальной среды 


В этой статье описывается, как настроить подключение, чтобы можно было успешно подключиться к виртуальным машинам Azure после отработки отказа.

При настройке аварийного восстановления локальных виртуальных машин и физических серверов в Azure [Azure Site Recovery](site-recovery-overview.md) начинает репликацию компьютеров в Azure. Затем при возникновении сбоев можно выполнить отработку отказа в Azure с локального сайта. В случае отработки отказа Site Recovery создает виртуальные машины Azure, используя реплицированные локальные данные. В рамках планирования аварийного восстановления необходимо выяснить, как подключиться к приложениям, работающим на этих виртуальных машинах Azure, после отработки отказа.

В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Подготовка локальных компьютеров перед отработкой отказа.
> * Подготовка виртуальных машин Azure после отработки отказа. 
> * Сохраняйте IP-адреса на виртуальных машинах Azure после отработки отказа.
> * Назначение новых IP-адресов виртуальным машинам Azure после отработки отказа.

## <a name="prepare-on-premises-machines"></a>Подготовка локальных компьютеров

Чтобы обеспечить подключение к виртуальным машинам Azure, перед отработкой отказа Подготовьте локальные компьютеры.

### <a name="prepare-windows-machines"></a>Подготовка компьютеров Windows

На локальных компьютерах под управлением Windows выполните следующие действия.

1. Настройка параметров Windows. К ним относятся удаление статических постоянных маршрутов или прокси-серверов WinHTTP, а также установка для политики SAN диска значения **OnlineAll**. [Выполните](../virtual-machines/windows/prepare-for-upload-vhd-image.md#set-windows-configurations-for-azure) эти инструкции.

2. Убедитесь, что [эти службы](../virtual-machines/windows/prepare-for-upload-vhd-image.md#check-the-windows-services) работают.

3. Включите удаленный рабочий стол (RDP), чтобы разрешить удаленные подключения к локальному компьютеру. [Узнайте, как](../virtual-machines/windows/prepare-for-upload-vhd-image.md#update-remote-desktop-registry-settings) включить RDP с помощью PowerShell.

4. Чтобы получить доступ к виртуальной машине Azure через Интернет после отработки отказа, в брандмауэре Windows на локальном компьютере разрешите протоколы TCP и UDP в общедоступном профиле и настройте RDP как разрешенное приложение для всех профилей.

5. Если вы хотите получить доступ к виртуальной машине Azure через VPN-подключение типа "сеть — сеть" после отработки отказа, в брандмауэре Windows на локальном компьютере разрешите RDP для домена и частных профилей. [Узнайте](../virtual-machines/windows/prepare-for-upload-vhd-image.md#configure-windows-firewall-rules) , как разрешить трафик RDP.
6. Убедитесь, что на локальной виртуальной машине нет ожидающих обновлений Windows при активации отработки отказа. Если это так, обновления могут начать установку на виртуальной машине Azure после отработки отказа, и вы не сможете войти на виртуальную машину до завершения обновления.

### <a name="prepare-linux-machines"></a>Подготовка компьютеров Linux

На локальных компьютерах Linux выполните следующие действия.

1. Убедитесь, что служба Secure Shell настроена на автоматический запуск при загрузке системы.
2. Убедитесь, что правила брандмауэра разрешают SSH-подключение.


## <a name="configure-azure-vms-after-failover"></a>Настройка виртуальных машин Azure после отработки отказа

После отработки отказа выполните следующие действия на создаваемых виртуальных машинах Azure.

1. Чтобы подключиться к виртуальной машине через Интернет, назначьте виртуальной машине общедоступный IP-адрес. Нельзя использовать один и тот же общедоступный IP-адрес для виртуальной машины Azure, которая использовалась для локального компьютера. [Подробнее](../virtual-network/virtual-network-public-ip-address.md)
2. Убедитесь, что правила группы безопасности сети (NSG) на виртуальной машине разрешают входящие подключения к порту RDP или SSH.
3. Проверьте [диагностику загрузки](../virtual-machines/troubleshooting/boot-diagnostics.md#enable-boot-diagnostics-on-existing-virtual-machine) , чтобы просмотреть виртуальную машину.


> [!NOTE]
> Служба Azure бастиона предлагает частные подключения по протоколу RDP и SSH к виртуальным машинам Azure. Дополнительные [сведения](../bastion/bastion-overview.md) об этой службе.

## <a name="set-a-public-ip-address"></a>Установка общедоступного IP-адреса

В качестве альтернативы назначению общедоступного IP-адреса виртуальной машине Azure вручную можно назначить адрес во время отработки отказа с помощью скрипта или модуля Runbook службы автоматизации Azure в Site Recovery [плане восстановления](site-recovery-create-recovery-plans.md)или настроить маршрутизацию на уровне DNS с помощью диспетчера трафика Azure. Дополнительные [сведения](concepts-public-ip-address-with-site-recovery.md) о настройке общедоступного адреса.


## <a name="assign-an-internal-address"></a>Назначение внутреннего адреса

Чтобы задать внутренний IP-адрес виртуальной машины Azure после отработки отказа, можно использовать несколько вариантов:

- **Использование того же IP-адреса**. На ВИРТУАЛЬНОЙ машине Azure можно использовать тот же IP-адрес, который был выделен для локального компьютера.
- **Использование другого IP-адреса.** Для виртуальной машины Azure можно использовать другой IP-адрес.


## <a name="retain-ip-addresses"></a>Использование тех же IP-адресов

Site Recovery позволяет хранить одни и те же IP-адреса при отработки отказа в Azure. При хранении одного и того же IP-адреса можно избежать возможных проблем с сетью после отработки отказа, но при этом возникают сложности.

- Если целевая виртуальная машина Azure использует тот же IP-адрес или подсеть, что и ваш локальный сайт, вы не сможете подключиться между ними, используя VPN-подключение типа "сеть — сеть" или ExpressRoute, из-за перекрытия адреса. Подсети должны быть уникальными.
- После отработки отказа вам потребуется подключение из локальной среды в Azure, чтобы приложения были доступны на виртуальных машинах Azure. Azure не поддерживает растянутые виртуальные ЛС, поэтому, если вы хотите хранить IP-адреса, необходимо перевести IP-пространство в Azure путем отработки отказа всей подсети в дополнение к локальному компьютеру.
- Отработка отказа подсети гарантирует, что конкретная подсеть недоступна одновременно в локальной среде и в Azure.

Для удержания IP-адресов необходимо выполнить следующие действия.

- В свойствах локального компьютера задайте для параметра сеть и IP-адресация целевой виртуальной машины Azure зеркальное отображение локальной настройки.
- Подсети должны управляться как часть процесса аварийного восстановления. Виртуальная сеть Azure должна соответствовать локальной сети, и после этого необходимо изменить сетевые маршруты отработки отказа, чтобы они отражали, что подсеть перемещена в Azure, и новые расположения IP-адресов.  

### <a name="failover-example"></a>Пример отработки отказа

Давайте рассмотрим пример.

- Вымышленная организация Woodgrove Bank размещает свои бизнес-приложения в локальной среде, где они размещаются в Azure.
- Они подключаются из локальной среды в Azure через VPN типа "сеть — сеть". 
- Woodgrove использует Site Recovery для репликации локальных компьютеров в Azure.
- Локальные приложения используют жестко запрограммированные IP-адреса, поэтому им нужно хранить одни и те же IP-адреса в Azure.
- Локальные компьютеры, на которых работают приложения, работают в трех подсетях:
    - 192.168.1.0/24.
    - 192.168.2.0/24
    - 192.168.3.0/24
- Приложения, работающие в Azure, находятся в **сети** Azure VNet в двух подсетях:
- 172.16.1.0/24
- 172.16.2.0/24.

Для того, чтобы хранить адреса, выполните следующие действия.

1. При включении репликации они указывают, что компьютеры должны реплицироваться в **сеть Azure**.
2. Они создают **сеть восстановления** в Azure. Эта виртуальная сеть дублирует подсеть 192.168.1.0/24 в своей локальной сети.
3. Компания Woodgrove настраивает [Подключение](../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md) между виртуальными сетями между ними. 

    > [!NOTE]
    > В зависимости от требований приложения, подключение между виртуальными сетями можно настроить до отработки отказа, как выполняемый вручную шаг/сценарий или модуль Runbook службы автоматизации Azure в Site Recovery [плане восстановления](site-recovery-create-recovery-plans.md)или после завершения отработки отказа.

4. Перед отработкой отказа в свойствах компьютера в Site Recovery они задают целевому IP-адресу адрес локального компьютера, как описано в следующей процедуре.
5. После отработки отказа создаются виртуальные машины Azure с одним и тем же IP-адресом. Woodgrove подключается из **сети Azure** к сетевой виртуальной сети **восстановления** с помощью 
6. В локальной среде Woodgrove необходимо вносить изменения в сеть, включая изменение маршрутов для отражения того, что 192.168.1.0/24 был перемещен в Azure.  

**Инфраструктура до отработки отказа**

![Перед выполнением отработки отказа подсети](./media/site-recovery-network-design/network-design7.png)


**Инфраструктура после отработки отказа**

![После выполнения отработки отказа подсети](./media/site-recovery-network-design/network-design9.png)


### <a name="set-target-network-settings"></a>Задать параметры целевой сети

Перед отработкой отказа укажите параметры сети и IP-адрес целевой виртуальной машины Azure.

1.  В хранилище служб восстановления — > **реплицированные элементы**, выберите локальный компьютер.
2. На странице " **Вычисление и сеть** " для компьютера нажмите кнопку " **изменить**", чтобы настроить параметры сети и адаптера для целевой виртуальной машины Azure.
3. В окне **Свойства сети**выберите целевую сеть, в которой будет РАЗМЕЩЕНа виртуальная машина Azure при ее создании после отработки отказа.
4. В окне **Сетевые интерфейсы**настройте сетевые адаптеры в целевой сети. По умолчанию Site Recovery отображает все обнаруженные сетевые карты на локальном компьютере.
    - В поле **целевой тип сетевого интерфейса** для каждого сетевого адаптера можно задать значение **первичная**, **вторичная**или **не создавать** , если в целевой сети не нужна конкретная сетевая карта. Один сетевой адаптер должен быть установлен в качестве основного для отработки отказа. Обратите внимание, что изменение целевой сети влияет на все сетевые карты для виртуальной машины Azure.
    - Щелкните имя сетевой карты, чтобы указать подсеть, в которой будет развернута виртуальная машина Azure.
    - Перепишите **dynamic** с частным IP-адресом, который вы хотите назначить целевой виртуальной машине Azure. Если IP-адрес не указан, Site Recovery присвоит сетевому адаптеру при отработке отказа следующий доступный IP-адрес в подсети.
    - [Узнайте больше](site-recovery-manage-network-interfaces-on-premises-to-azure.md) об управлении сетевыми картами для локальной отработки отказа в Azure.


## <a name="get-new-ip-addresses"></a>Получить новые IP-адреса

В этом сценарии виртуальная машина Azure получает новый IP-адрес после отработки отказа. Обновление DNS для обновления записей для компьютеров, для которых выполнена отработка отказа, чтобы указать IP-адрес виртуальной машины Azure.



## <a name="next-steps"></a>Следующие шаги
[Узнайте, как](site-recovery-active-directory.md) выполнять репликацию локальных Active Directory и DNS в Azure.


