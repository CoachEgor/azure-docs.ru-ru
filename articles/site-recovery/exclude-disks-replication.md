---
title: Исключение дисков из репликации с помощью Azure Site Recovery
description: Как исключить диски из репликации в Azure с помощью Azure Site Recovery.
ms.topic: conceptual
ms.date: 12/17/2019
ms.openlocfilehash: 57bf06f0fde85714530c06cbd008db08de7460d2
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79281851"
---
# <a name="exclude-disks-from-disaster-recovery"></a>Исключение дисков из аварийного восстановления

В этой статье описывается, как исключить диски из репликации во время аварийного восстановления из локальной среды в Azure с помощью [Azure Site Recovery](site-recovery-overview.md). Вы можете исключить диски из репликации по ряду причин:

- Так что неважные данные, обработанные на исключенном диске, не реплицируются.
- Для оптимизации использования пропускной способности репликации или ресурсов на стороне целевого объекта.
- Чтобы сохранить ресурсы хранилища и сети, не реплицируются данные, которые вам не нужны.
- На виртуальных машинах Azure достигнут Site Recovery пределов репликации.


## <a name="supported-scenarios"></a>Поддерживаемые сценарии

Вы можете исключить диски из репликации, как показано в таблице.

**Из Azure в Azure** | **VMware в VMware** | **Hyper-V в Azure** 
--- | --- | ---
Да (с помощью PowerShell) | Да | Да 

## <a name="exclude-limitations"></a>Исключить ограничения

**Ограничения** | **Виртуальные машины Azure** | **Виртуальные машины VMware** | **Виртуальные машины Hyper-V**
--- | --- | ---
**Типы дисков** | Вы можете исключить базовые диски из репликации.<br/><br/> Нельзя исключить диски операционной системы или динамические диски. Временные диски исключаются по умолчанию. | Вы можете исключить базовые диски из репликации.<br/><br/> Нельзя исключить диски операционной системы или динамические диски. | Вы можете исключить базовые диски из репликации.<br/><br/> Вы не можете исключать диски операционной системы. Мы не рекомендуем исключать динамические диски. Site Recovery не может выяснить, какой ВХС является базовым или динамическим в гостевой виртуальной машине. Если все зависимые динамические диски не исключены, защищенный динамический диск становится неисправным диском на отказоустойчивой виртуальной машине, а данные на этом диске недоступны.
**Репликация диска** | Невозможно исключить диск, который реплицируется.<br/><br/> Отключите и повторно включите репликацию для виртуальной машины. |  Невозможно исключить диск, который реплицируется. |  Невозможно исключить диск, который реплицируется.
**Служба Mobility Service (VMware)** | Несущественно | Вы можете исключить диски только на виртуальных машинах, на которых установлена служба Mobility Service.<br/><br/> Это означает, что необходимо вручную установить службу Mobility Service на виртуальных машинах, для которых требуется исключить диски. Механизм принудительной установки нельзя использовать, так как он устанавливает службу Mobility Service только после включения репликации. | Не относится.
**Добавить или удалить** | Вы можете добавлять и удалять диски на виртуальных машинах Azure с управляемыми дисками. | Вы не можете добавлять или удалять диски после включения репликации. Отключите и снова включите репликацию, чтобы добавить диск. | Вы не можете добавлять или удалять диски после включения репликации. Отключите и снова включите репликацию.
**Тип отработки отказа** | Если приложению требуется исключаемый диск, после отработки отказа необходимо создать диск вручную, чтобы можно было запустить Реплицируемое приложение.<br/><br/> Кроме того, вы можете создать диск во время отработки отказа виртуальной машины, интегрируя службу автоматизации Azure в план восстановления. | Если вы исключите диск, который требуется приложению, создайте его вручную в Azure после отработки отказа. | Если вы исключите диск, который требуется приложению, создайте его вручную в Azure после отработки отказа.
**Локальное восстановление размещения — диски, созданные вручную** | Несущественно | **Виртуальные машины Windows**. диски, созданные вручную в Azure, не прошли откат. Например, если вы отработка отказа на три диска и создаете два диска непосредственно на виртуальной машине Azure, произойдет сбой при восстановлении из строя только трех дисков, на которых выполнена отработка отказа.<br/><br/> **Виртуальные машины Linux**. диски, созданные вручную в Azure, не возвращаются. Например, при отработки отказа на три диска и создании двух дисков на виртуальной машине Azure произойдет сбой отката всех пяти. Диски, созданные вручную при восстановлении расположения, исключать нельзя. | Диски, созданные вручную в Azure, не прошли откат. Например, если вы отработка отказа на три диска и создаете два диска непосредственно на виртуальной машине Azure, будут восстановлены только три диска, для которых была выполнена отработка отказа.
**Локальное восстановление размещения — Исключенные диски** | Несущественно | При восстановлении размещения на исходном компьютере в конфигурации диска виртуальной машины восстановления не будут включаться Исключенные диски. Диски, которые были исключены из VMware в репликацию Azure, недоступны на виртуальной машине восстановления размещения. | Когда восстановление размещения происходит в исходное расположение Hyper-V, конфигурация диска восстановления размещения виртуальной машины остается такой же, как и на исходном диске исходной виртуальной машины. Диски, которые были исключены из сайта Hyper-V в репликацию Azure, доступны на виртуальной машине восстановления размещения.



## <a name="typical-scenarios"></a>Типичные сценарии

Примеры обработки данных, которые являются хорошим кандидатом для исключения, включают запись в файл подкачки (pagefile. sys) и запись в файл tempdb Microsoft SQL Server. В зависимости от рабочей нагрузки и подсистемы хранения файлы подкачки и базы данных tempdb могут регистрировать значительный объем изменений. Репликация этого типа данных в Azure требует больших ресурсов.

- Чтобы оптимизировать репликацию для виртуальной машины с одним виртуальным диском, включающим как операционную систему, так и файл подкачки, можно:
    1. Разделите один виртуальный диск на два диска. Один виртуальный диск будет содержать операционную систему, а второй — файл подкачки.
    2. Исключите диск с файлом подкачки из репликации.

- Чтобы оптимизировать репликацию для диска, который содержит файл Microsoft SQL Server tempdb и файл системной базы данных, можно:
    1. Файл системной базы данных и файл tempdb Microsoft SQL Server должны находиться на разных дисках.
    2. Исключите диск с файлом tempdb из репликации.

## <a name="example-1-exclude-the-sql-server-tempdb-disk"></a>Пример 1. Исключение диска с файлом tempdb SQL Server

Рассмотрим процесс обработки исключений дисков, отработки отказа и отработки отказа для исходной SQL Server виртуальной машины Windows — * * SalesDB * * *, для которой мы хотим исключить базу данных tempdb. 

### <a name="exclude-disks-from-replication"></a>Исключение дисков из репликации

Эти диски находятся на исходной виртуальной машине Windows SalesDB.

**Имя диска** | **Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Disk0 | C:\ | Диск операционной системы.
DB-Disk1| Диск 1 | D:\ | Системная база данных SQL и пользователь Database1.
DB-Disk 2 (исключенный из репликации) | Диск 2 | E:\ | Временные файлы.
DB-Disk 3 (исключенный из репликации) | Диск 3 | F:\ | База данных tempdb SQL.<br/><br/> Путь к папке — Ф:\мсскл\дата\. Запишите путь к папке перед отработкой отказа.
DB-Disk4 | Диск 4 |G:\ | База данных пользователя Database2

1. Мы включили репликацию для виртуальной машины SalesDB.
2. Мы исключаем диски 2 и 3 из репликации, поскольку данные на этих дисках являются временными. 


### <a name="handle-disks-during-failover"></a>Обработку дисков во время отработки отказа

Так как диски не реплицируются, при отработке отказа в Azure эти диски отсутствуют на виртуальной машине Azure, созданной после отработки отказа. В этой таблице приведены диски виртуальной машины Azure.

**Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Disk0 | C:\ | Диск операционной системы.
Диск 1 | E:\ | Временное хранилище<br/><br/>Azure добавляет этот диск. Так как диски 2 и 3 исключены из репликации, E: — это первая буква диска из доступного списка. Azure назначает "E:" тому временного хранилища. Другие буквы дисков для реплицированных дисков остаются неизменными.
Диск 2 | D:\ | Системная база данных SQL и база данных пользователя Database1
Диск 3 | G:\ | База данных пользователя Database2

В нашем примере, так как 3, диск tempdb SQL был исключен из репликации и недоступен на виртуальной машине Azure, служба SQL находится в остановленном состоянии, и ей требуется путь F:\MSSQL\Data. Этот путь можно создать несколькими способами. 

- Добавьте новый диск после отработки отказа и назначьте путь к папке tempdb.
- Используйте существующий диск временного хранилища для пути к папке tempdb.

#### <a name="add-a-new-disk-after-failover"></a>Добавление нового диска после отработки отказа

1. Запишите пути к файлам tempdb.mdf и tempdb.ldf для базы данных SQL перед отработкой отказа.
2. На портал Azure добавьте новый диск в виртуальную машину отработки отказа Azure. Диск должен иметь тот же размер (или больше), что и исходный диск базы данных tempdb SQL (3).
3. Войдите на виртуальную машину Azure.
4. В консоли управления (diskmgmt.msc) диском выполните инициализацию и форматирование добавленного диска.
5. Назначьте ту же букву диска, которая использовалась на диске базы данных tempdb SQL (F:)
6. Создайте папку tempdb в томе "F:" (F:\MSSQL\Data).
7. Запустите службу SQL из консоли службы.

#### <a name="use-an-existing-temporary-storage-disk"></a>Использование существующего временного диска хранилища 

1. Откройте командную строку.
2. Запустите SQL Server в режиме восстановления из командной строки.

        Net start MSSQLSERVER /f / T3608

3. Запустите следующую команду sqlcmd, чтобы изменить путь к tempdb на новый.

        sqlcmd -A -S SalesDB        **Use your SQL DBname**
        USE master;     
        GO      
        ALTER DATABASE tempdb       
        MODIFY FILE (NAME = tempdev, FILENAME = 'E:\MSSQL\tempdata\tempdb.mdf');
        GO      
        ALTER DATABASE tempdb       
        MODIFY FILE (NAME = templog, FILENAME = 'E:\MSSQL\tempdata\templog.ldf');       
        GO


4. Остановите службу Microsoft SQL Server.

        Net stop MSSQLSERVER
5. Запустите службу Microsoft SQL Server.

        Net start MSSQLSERVER



### <a name="vmware-vms-disks-during-failback-to-original-location"></a>Виртуальные машины VMware: диски во время восстановления размещения в исходном расположении

Теперь давайте посмотрим, как работать с дисками на виртуальных машинах VMware при восстановлении размещения в исходное локальное расположение.

- **Диски, созданные в Azure**. Поскольку в нашем примере используется виртуальная машина Windows, диски, созданные вручную в Azure, не реплицируются обратно на сайт при восстановлении размещения или повторной защите виртуальной машины.
- **Диск временного хранилища в Azure**: временный диск хранилища не реплицируется обратно на локальные узлы.
- **Исключенные диски**. диски, которые были исключены из VMware в репликацию Azure, недоступны на локальной виртуальной машине после восстановления размещения.

Прежде чем восстановить размещение виртуальных машин VMware в исходном расположении, можно выполнить следующие параметры диска виртуальной машины Azure.

**Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Disk0 | C:\ | Диск операционной системы.
Диск 1 | E:\ | Временное хранилище.
Диск 2 | D:\ | Системная база данных SQL и пользователь Database1.
Диск 3 | G:\ | Пользователь Database2.

После восстановления размещения виртуальная машина VMware в исходном расположении содержит диски, приведенные в таблице.

**Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Disk0 | C:\ | Диск операционной системы.
Диск 1 | D:\ | Системная база данных SQL и пользователь Database1.
Диск 2 | G:\ | Пользователь Database2.


### <a name="hyper-v-vms-disks-during-failback-to-original-location"></a>Виртуальные машины Hyper-V: диски при восстановлении размещения в исходном расположении

Теперь давайте посмотрим, как работать с дисками на виртуальных машинах Hyper-V при восстановлении размещения в исходное локальное расположение.

- **Диски, созданные в Azure**. диски, создаваемые вручную в Azure, не реплицируются обратно на сайт при восстановлении или повторной защите виртуальной машины.
- **Диск временного хранилища в Azure**: временный диск хранилища не реплицируется обратно на локальные узлы.
- **Исключенные диски**: после восстановления размещения конфигурация диска виртуальной машины совпадает с конфигурацией диска исходной виртуальной машины. Диски, которые были исключены из репликации из Hyper-V в Azure, доступны на виртуальной машине восстановления размещения.

Прежде чем восстановить размещение виртуальных машин Hyper-V в исходное расположение, можно выполнить следующие параметры диска виртуальной машины Azure.

**Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Disk0 | C:\ | Диск операционной системы.
Диск 1 | E:\ | Временное хранилище.
Диск 2 | D:\ | Системная база данных SQL и пользователь Database1.
Диск 3 | G:\ | Пользователь Database2.

После плановой отработки отказа (восстановления размещения) из Azure в локальную службу Hyper-V в виртуальной машине Hyper-V в исходном расположении имеются диски, представленные в таблице.

**Имя диска** | **№ диска гостевой ОС** | **Буква диска** | **Тип данных диска**
 --- | --- | --- | ---
DB-Disk0-OS | Disk0 |   C:\ | Диск операционной системы.
DB-Disk1 | Диск 1 | D:\ | Системная база данных SQL и пользователь Database1.
DB-Disk2 (исключенный из репликации) | Диск 2 | E:\ | Временные файлы.
DB-Disk3 (исключенный из репликации) | Диск 3 | F:\ | База данных SQL tempdb<br/><br/> Путь к папке (F:\MSSQL\Data\).
DB-Disk4 | Диск 4 | G:\ | База данных пользователя Database2


## <a name="example-2-exclude-the-paging-file-disk"></a>Пример 2. исключение диска с файлом подкачки

Рассмотрим процесс обработки исключений дисков, отработки отказа и отработки отказа для исходной виртуальной машины Windows, для которой требуется исключить диск с файлом pagefile. sys на диске D и на альтернативный диск.


### <a name="paging-file-on-the-d-drive"></a>Файл подкачки на диске D

На исходной виртуальной машине имеются эти диски.

**Имя диска** | **Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Disk0 | C:\ | Диск операционной системы
DB-disk1 (исключение из репликации) | Диск 1 | D:\ | pagefile.sys
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Ниже приведены параметры файла подкачки на исходной виртуальной машине.

![Параметры файла подкачки на исходной виртуальной машине](./media/exclude-disks-replication/pagefile-d-drive-source-vm.png)

1. Мы включили репликацию для виртуальной машины.
2. Мы исключаем DB-disk1 из репликации.

#### <a name="disks-after-failover"></a>Диски после отработки отказа

После отработки отказа виртуальная машина Azure содержит диски, приведенные в таблице.

**Имя диска** | **№ диска операционной системы на виртуальной машине** | **Буква диска** | **Тип данных на диске**
--- | --- | --- | ---
DB-Disk0-OS | Disk0 | C:\ | Диск операционной системы
DB-Disk1 | Диск 1 | D:\ | Временное хранилище или файл подкачки. sys <br/><br/> Так как DB-disk1 (D:) исключено, D: является первой буквой диска из доступного списка.<br/><br/> Azure назначает "D:" тому временного хранилища.<br/><br/> Так как D: доступен, параметр файла подкачки виртуальной машины остается неизменным.
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Ниже приведены параметры файла подкачки на виртуальной машине Azure.

![Параметры файла подкачки на виртуальной машине Azure](./media/exclude-disks-replication/pagefile-azure-vm-after-failover.png)

### <a name="paging-file-on-another-drive-not-d"></a>Файл подкачки на другом диске (не D:)

Рассмотрим пример, в котором файл подкачки находится не на диске D.  

На исходной виртуальной машине имеются эти диски.

**Имя диска** | **Диск гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Disk0 | C:\ | Диск операционной системы
DB-disk1 (исключение из репликации) | Диск 1 | G:\ | pagefile.sys
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Параметры файла подкачки на локальной виртуальной машине приведены ниже.

![Параметры файла подкачки на локальной виртуальной машине](./media/exclude-disks-replication/pagefile-g-drive-source-vm.png)

1. Мы включили репликацию для виртуальной машины.
2. Мы исключаем DB-disk1 из репликации.

#### <a name="disks-after-failover"></a>Диски после отработки отказа

После отработки отказа виртуальная машина Azure содержит диски, приведенные в таблице.

**Имя диска** | **№ диска гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Disk0  |C:\ | Диск операционной системы
DB-Disk1 | Диск 1 | D:\ | Временное хранилище<br/><br/> Так как "D:" является первой доступной буквой диска в списке, Azure назначит ее тому временного хранилища.<br/><br/> Для всех реплицированных дисков буква диска не изменится.<br/><br/> Так как диск G: недоступен, система будет использовать диск C: для файла подкачки.
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Ниже приведены параметры файла подкачки на виртуальной машине Azure.

![Параметры файла подкачки на виртуальной машине Azure](./media/exclude-disks-replication/pagefile-azure-vm-after-failover-2.png)


## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о рекомендациях для временного диска хранилища:
    - [Сведения об](https://blogs.technet.microsoft.com/dataplatforminsider/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/) использовании твердотельных накопителей на виртуальных машинах Azure для хранения SQL Server tempdb и расширений буферного пула
    - [Ознакомьтесь](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-performance) с рекомендациями по повышению производительности SQL Server на виртуальных машинах Azure.
- Настроив и запустив развертывание, вы можете ознакомиться с [дополнительными сведениями](failover-failback-overview.md) о различных типах обработки отказа.

