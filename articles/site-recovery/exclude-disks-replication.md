---
title: Исключить диски из репликации с помощью восстановления сайта Azure
description: Как исключить диски из репликации в Azure с помощью восстановления сайта Azure.
ms.topic: conceptual
ms.date: 12/17/2019
ms.openlocfilehash: 57bf06f0fde85714530c06cbd008db08de7460d2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79281851"
---
# <a name="exclude-disks-from-disaster-recovery"></a>Исключить диски из аварийного восстановления

В этой статье описывается, как исключить диски из репликации во время аварийного восстановления из находиные места в Azure с [Azure Site Recovery.](site-recovery-overview.md) Вы можете исключить диски из репликации по ряду причин:

- Так что неважные данные, вспененные на исключенном диске, не реплицируются.
- Оптимизация потребляемой пропускной способности репликации или целевых ресурсов.
- Сохранение ресурсов хранения данных и сетевых ресурсов, не реплицируя данные, которые вам не нужны.
- VMs Azure достигли пределов репликации сайта.


## <a name="supported-scenarios"></a>Поддерживаемые сценарии

Можно исключить диски из репликации, как обобщено в таблице.

**Из Azure в Azure** | **VMware в Лазурный** | **Hyper-V в Azure** 
--- | --- | ---
Да (с помощью PowerShell) | Да | Да 

## <a name="exclude-limitations"></a>Исключить ограничения

**Ограничение** | **Виртуальные машины Azure** | **Виртуальные машины VMware** | **Виртуальные машины Hyper-V**
--- | --- | ---
**Типы дисков** | Можно исключить из репликации основные диски.<br/><br/> Нельзя исключать операционные системные диски или динамические диски. Временные диски исключены по умолчанию. | Можно исключить из репликации основные диски.<br/><br/> Нельзя исключать операционные системные диски или динамические диски. | Можно исключить из репликации основные диски.<br/><br/> Вы не можете исключать диски операционной системы. Мы не рекомендуем исключать динамические диски. Восстановление сайта не может определить, какой VHS является основным или динамичным в гостевом VM. Если не исключаются все зависимые динамические объемные диски, защищенный динамический диск становится неисправным диском на сбой VM, и данные на этом диске недоступны.
**Репликация диска** | Нельзя исключать репликацию диска.<br/><br/> Отключите и пополнение репликации для VM. |  Нельзя исключать репликацию диска. |  Нельзя исключать репликацию диска.
**Мобильный сервис (VMware)** | Не используется | Исключить диски можно только на вс-да, с установленными службой Mobility.<br/><br/> Это означает, что вы должны вручную установить услугу Мобильности на vMs, для которых вы хотите исключить диски. Вы не можете использовать механизм установки push, поскольку он устанавливает службу Мобильности только после включения репликации. | Не имеет значения.
**Добавление или удаление** | Вы можете добавлять и удалять диски на вазовских вс-в.с управляемыми дисками. | Вы не можете добавить или удалить диски после включения репликации. Отключите, а затем повторное репликацию для добавления диска. | Вы не можете добавить или удалить диски после включения репликации. Отключить, а затем пополнение репликации.
**Отказоустойчивого** | Если приложению нужен диск, который вы исключили, после сбоя необходимо создать диск вручную, чтобы реплицируемое приложение было запущено.<br/><br/> Кроме того, можно создать диск во время сбоя VM, интегрируя автоматизацию Azure в план восстановления. | Если вы исключаете диск, который необходим приложению, создайте его вручную в Azure после сбоя. | Если вы исключаете диск, который необходим приложению, создайте его вручную в Azure после сбоя.
**На-предпосылки отказ-диски, созданные вручную** | Не используется | **Windows VMs**: Диски, созданные вручную в Azure, не отоходят назад. Например, если вы не сможете выполнить три диска и создать два диска непосредственно на VM Azure, только три диска, которые были не сбой, затем не обратно.<br/><br/> **Linux VMs**: Диски, созданные вручную в Azure, не возвращаются назад. Например, если вы не сможете выполнить три диска и создать два диска на Azure VM, все пять из них будут возвращены. Диски, созданные вручную при восстановлении расположения, исключать нельзя. | Диски, созданные вручную в Azure, не отошворны. Например, если вы не сможете выполнить три диска и создать два диска непосредственно на Azure VM, только три диска, которые были не сбой будет не удалось обратно.
**На-предпосылки отказ-исключенные диски** | Не используется | Если вы не вернулись к исходной машине, конфигурация диска VM не включает исключенные диски. Диски, исключенные из репликации VMware в Azure, недоступны на VM.м. | При отказе от первоначального местоположения Hyper-V конфигурация диска VM остается такой же, как и у исходного vM-диска. Диски, которые были исключены из сайта Hyper-V в репликацию Azure, доступны на отказов VM.



## <a name="typical-scenarios"></a>Типичные сценарии

Примеры оттока данных, которые являются отличными кандидатами на исключение, включают записи в файл paging (pagefile.sys) и записывает в файл tempdb microsoft S'L Server. В зависимости от рабочей нагрузки и подсистемы хранения, файлы paging и tempdb могут регистрировать значительное количество оттока. Репликация данных в Azure является ресурсоемкой.

- Для оптимизации репликации для VM с одним виртуальным диском, который включает в себя как операционную систему, так и файл paging, можно:
    1. Разделите один виртуальный диск на два диска. Один виртуальный диск будет содержать операционную систему, а второй — файл подкачки.
    2. Исключите диск с файлом подкачки из репликации.

- Для оптимизации репликации для диска, который включает в себя как файл tempdb сервера Microsoft s'L, так и файл базы данных системы, можно:
    1. Файл системной базы данных и файл tempdb Microsoft SQL Server должны находиться на разных дисках.
    2. Исключите диск с файлом tempdb из репликации.

## <a name="example-1-exclude-the-sql-server-tempdb-disk"></a>Пример 1. Исключение диска с файлом tempdb SQL Server

Давайте посмотрим, как обрабатывать исключение диска, отказ, и отказ для источника S'L Сервер Windows VM - «SalesDB», для которого мы хотим исключить tempdb. 

### <a name="exclude-disks-from-replication"></a>Исключение дисков из репликации

У нас есть эти диски на источнике Windows VM SalesDB.

**Имя диска** | **Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Диск0 | C:\ | Операционный системный диск.
DB-Disk1| Диск 1 | D:\ | База данных системы S'L и База данных пользователей1.
DB-Disk 2 (исключенный из репликации) | Диск 2 | E:\ | Файлы температуры.
DB-Disk 3 (исключенный из репликации) | Диск 3 | F:\ | База данных s'L tempdb.<br/><br/> Фолдер-путь - F:-MSS-Л.. Сделайте примечание пути папки перед неудачей.
DB-Disk4 | Диск 4 |G:\ | База данных пользователя Database2

1. Мы позволяем репликацию для SalesDB VM.
2. Мы исключаем Disk2 и Disk3 из репликации, поскольку отток данных на этих дисках является временным. 


### <a name="handle-disks-during-failover"></a>Обработка дисков во время сбоя

Поскольку диски не реплицируются, при сбою в Azure эти диски не присутствуют на Azure VM, созданном после сбоя. В таблице Azure VM приведены краткое резюме дисков.

**Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Диск0 | C:\ | Операционный системный диск.
Диск 1 | E:\ | Временное хранилище<br/><br/>Azure добавляет этот диск. Поскольку Disk2 и Disk3 были исключены из репликации, E: это первая буква диска из доступного списка. Azure назначает "E:" тому временного хранилища. Другие дисковые буквы для реплицированных дисков остаются прежними.
Диск 2 | D:\ | Системная база данных SQL и база данных пользователя Database1
Диск 3 | G:\ | База данных пользователя Database2

В нашем примере, поскольку диск S'L tempdb Disk был исключен из репликации и недоступен на Azure VM, служба S'L находится в остановленном состоянии, и ей нужен путь F: Вы можете создать этот путь несколькими способами: 

- Добавьте новый диск после неудачи и назначайте путь папки tempdb.
- Используйте существующий диск временного хранилища для пути к папке tempdb.

#### <a name="add-a-new-disk-after-failover"></a>Добавление нового диска после сбоя

1. Запишите пути к файлам tempdb.mdf и tempdb.ldf для базы данных SQL перед отработкой отказа.
2. С портала Azure добавьте новый диск в failover Azure VM. Диск должен быть того же размера (или больше), что и исходный диск S'L tempdb (Disk3).
3. Войти на Azure VM.
4. В консоли управления (diskmgmt.msc) диском выполните инициализацию и форматирование добавленного диска.
5. Назначайте ту же букву диска, которая использовалась на диске s'L tempdb (F:)
6. Создайте папку tempdb в томе "F:" (F:\MSSQL\Data).
7. Запустите службу SQL из консоли службы.

#### <a name="use-an-existing-temporary-storage-disk"></a>Использование существующего диска временного хранения 

1. Откройте командную строку.
2. Запустите SQL Server в режиме восстановления из командной строки.

        Net start MSSQLSERVER /f / T3608

3. Запустите следующую команду sqlcmd, чтобы изменить путь к tempdb на новый.

        sqlcmd -A -S SalesDB        **Use your SQL DBname**
        USE master;     
        GO      
        ALTER DATABASE tempdb       
        MODIFY FILE (NAME = tempdev, FILENAME = 'E:\MSSQL\tempdata\tempdb.mdf');
        GO      
        ALTER DATABASE tempdb       
        MODIFY FILE (NAME = templog, FILENAME = 'E:\MSSQL\tempdata\templog.ldf');       
        GO


4. Остановите службу Microsoft SQL Server.

        Net stop MSSQLSERVER
5. Запустите службу Microsoft SQL Server.

        Net start MSSQLSERVER



### <a name="vmware-vms-disks-during-failback-to-original-location"></a>VMware VMs: Диски во время возврата к исходной локации

Теперь давайте посмотрим, как обрабатывать диски на VMware VMs, когда вы не вернуться к исходной месту.

- **Диски, созданные в Azure:** Поскольку в нашем примере используется Windows VM, диски, которые вы создаете вручную в Azure, не реплицируются обратно на ваш сайт, когда вы не назад или повторно защищаете VM.
- **Временный диск хранения в Azure**: Временный диск хранения не реплицируется обратно в места хранения.
- **Исключенные диски**: Диски, которые были исключены из репликации VMware в Azure, недоступны на предварительном VM после сбоя.

Перед тем, как вы свести на нет VMware VMs в исходное местоположение, настройки диска Azure VM следующие.

**Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Диск0 | C:\ | Операционный системный диск.
Диск 1 | E:\ | Временное хранение.
Диск 2 | D:\ | База данных системы S'L и База данных пользователей1.
Диск 3 | G:\ | База данных пользователей2.

После сбоя VMware VM в исходном месте имеет диски, обобщенные в таблице.

**Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Диск0 | C:\ | Операционный системный диск.
Диск 1 | D:\ | База данных системы S'L и База данных пользователей1.
Диск 2 | G:\ | База данных пользователей2.


### <a name="hyper-v-vms-disks-during-failback-to-original-location"></a>Hyper-V VMs: Диски во время возврата к исходной локации

Теперь давайте посмотрим, как обрабатывать диски на Hyper-V VMs, когда вы не вернуться к исходной месту.

- **Диски, созданные в Azure:** Диски, которые создаются вручную в Azure, не реплицируются обратно на ваш сайт при отказе назад или повторной защите VM.
- **Временный диск хранения в Azure**: Временный диск хранения не реплицируется обратно в места хранения.
- **Исключенные диски**: После отказа конфигурация диска VM такая же, как и оригинальная конфигурация диска VM. Диски, исключенные из репликации из Hyper-V в Azure, доступны на vM-подсобном доступе.

Перед тем, как вы свести на нет возможности вернуть ВМ Hyper-V в исходное место, настройки диска Azure VM следующие.

**Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | ---
Диск0 | C:\ | Операционный системный диск.
Диск 1 | E:\ | Временное хранение.
Диск 2 | D:\ | База данных системы S'L и База данных пользователей1.
Диск 3 | G:\ | База данных пользователей2.

После запланированного сбоя (неудачи) из Azure в локальный Hyper-V, Hyper-V в исходном месте имеет диски, обобщенные в таблице.

**Имя диска** | **№ диска гостевой ОС** | **Буква диска** | **Тип данных диска**
 --- | --- | --- | ---
DB-Disk0-OS | Диск0 |   C:\ | Операционный системный диск.
DB-Disk1 | Диск 1 | D:\ | База данных системы S'L и База данных пользователей1.
DB-Disk2 (исключенный из репликации) | Диск 2 | E:\ | Файлы температуры.
DB-Disk3 (исключенный из репликации) | Диск 3 | F:\ | База данных s'L tempdb<br/><br/> Путь Фолдера (F:-MSS-Л.Данные\).
DB-Disk4 | Диск 4 | G:\ | База данных пользователя Database2


## <a name="example-2-exclude-the-paging-file-disk"></a>Пример 2: Исключить диск файла paging

Давайте посмотрим, как обрабатывать исключение диска, отказ и сбой для источника Windows VM, для которого мы хотим исключить файловый диск pagefile.sys как на диске D, так и на альтернативном диске.


### <a name="paging-file-on-the-d-drive"></a>Файл paging на диске D

У нас есть эти диски на источнике VM.

**Имя диска** | **Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Диск0 | C:\ | Диск операционной системы
DB-Disk1 (Исключить из репликации) | Диск 1 | D:\ | pagefile.sys
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Наши настройки файла paging на источнике VM следующие:

![Параметры файла подкачки на исходной виртуальной машине](./media/exclude-disks-replication/pagefile-d-drive-source-vm.png)

1. Мы позволяем репликации для VM.
2. Мы исключаем DB-Disk1 из репликации.

#### <a name="disks-after-failover"></a>Диски после сбоя

После неудачи в Azure VM в таблице обобщены диски.

**Имя диска** | **№ диска операционной системы на виртуальной машине** | **Буква диска** | **Тип данных на диске**
--- | --- | --- | ---
DB-Disk0-OS | Диск0 | C:\ | Диск операционной системы
DB-Disk1 | Диск 1 | D:\ | Временное хранение/pagefile.sys <br/><br/> Потому что DB-Disk1 (D:) был исключен, D: это первое письмо диска из доступного списка.<br/><br/> Azure назначает "D:" тому временного хранилища.<br/><br/> Поскольку D: доступен параметр файла VM paging, остается прежним).
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Наши настройки файлов на Azure VM следующие:

![Параметры файла подкачки на виртуальной машине Azure](./media/exclude-disks-replication/pagefile-azure-vm-after-failover.png)

### <a name="paging-file-on-another-drive-not-d"></a>Файл paging на другом диске (не D:)

Рассмотрим пример, в котором файл paging не на диске D.  

У нас есть эти диски на источнике VM.

**Имя диска** | **Диск Гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Диск0 | C:\ | Диск операционной системы
DB-Disk1 (Исключить из репликации) | Диск 1 | G:\ | pagefile.sys
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Наши настройки файла paging на предприимживающей ВМ следующие:

![Параметры файла подкачки на локальной виртуальной машине](./media/exclude-disks-replication/pagefile-g-drive-source-vm.png)

1. Мы позволяем репликации для VM.
2. Мы исключаем DB-Disk1 из репликации.

#### <a name="disks-after-failover"></a>Диски после сбоя

После неудачи в Azure VM в таблице обобщены диски.

**Имя диска** | **№ диска гостевой ОС** | **Буква диска** | **Тип данных диска**
--- | --- | --- | ---
DB-Disk0-OS | Диск0  |C:\ | Диск операционной системы
DB-Disk1 | Диск 1 | D:\ | Временное хранилище<br/><br/> Так как "D:" является первой доступной буквой диска в списке, Azure назначит ее тому временного хранилища.<br/><br/> Для всех реплицированных дисков буква диска не изменится.<br/><br/> Поскольку диск G: недоступен, система будет использовать C: диск для файла paging.
DB-Disk2 | Диск 2 | E:\ | Пользовательские данные 1
DB-Disk3 | Диск 3 | F:\ | Пользовательские данные 2

Наши настройки файлов на Azure VM следующие:

![Параметры файла подкачки на виртуальной машине Azure](./media/exclude-disks-replication/pagefile-azure-vm-after-failover-2.png)


## <a name="next-steps"></a>Дальнейшие действия

- Подробнее о рекомендациях для диска временного хранения:
    - [Узнайте об](https://blogs.technet.microsoft.com/dataplatforminsider/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/) использовании SSD-навистых сотовых данных в MMs Azure для хранения расширений сервера S'L TempDB и буферного пула
    - [Просмотрите](https://docs.microsoft.com/azure/virtual-machines/windows/sql/virtual-machines-windows-sql-performance) рекомендации по производительности для сервера S'L в Azure VMs.
- Настроив и запустив развертывание, вы можете ознакомиться с [дополнительными сведениями](failover-failback-overview.md) о различных типах обработки отказа.

