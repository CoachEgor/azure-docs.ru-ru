---
title: Устранение проблем сервера процесса восстановления сайта Azure
description: В этой статье описывается, как устранить проблемы с сервером процесса восстановления сайта Azure
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: troubleshooting
ms.date: 09/09/2019
ms.author: raynew
ms.openlocfilehash: 812cd0293f9627b7438e9870d8985e71dae1d147
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79256865"
---
# <a name="troubleshoot-the-process-server"></a>Устранение проблем сервера процесса

Сервер процесса [восстановления сайта](site-recovery-overview.md) используется при настройке аварийного восстановления в Azure для внутренних VM-м и физических серверов VMw. В этой статье описывается, как устранить проблемы с сервером процесса, включая репликацию и проблемы с подключением.

[Подробнее](vmware-physical-azure-config-process-server-overview.md) о сервере процесса.

## <a name="before-you-start"></a>Перед началом работы

Перед тем, как приступить к устранению неполадок:

1. Убедитесь, что вы понимаете, как [контролировать процесс серверов.](vmware-physical-azure-monitor-process-server.md)
2. Ознакомьте лучшие практики ниже.
3. Убедитесь, что вы следите за [соображениями емкости](site-recovery-plan-capacity-vmware.md#capacity-considerations)и используете руководство по размеру для [сервера конфигурации](site-recovery-plan-capacity-vmware.md#size-recommendations-for-the-configuration-server-and-inbuilt-process-server) или [автономных серверов процессов.](site-recovery-plan-capacity-vmware.md#size-recommendations-for-the-process-server)

## <a name="best-practices-for-process-server-deployment"></a>Рекомендации по развертыванию сервера процессов

Для оптимальной производительности серверов процессов мы обобщили ряд общих рекомендаций.

**Рекомендации** | **Подробно**
--- |---
**Использования** | Убедитесь, что сервер конфигурации/сервер автономных процессов используется только по назначению. Не запускайте ничего другого на машине.
**IP-адрес** | Убедитесь, что сервер процесса имеет статический адрес IPv4 и не настроен на NAT.
**Управление памятью/использованием процессора** |Держите процессор и использование памяти под 70%.
**Обеспечить свободное пространство** | Свободное пространство относится к пространству диска кэша на сервере процесса. Данные репликации хранятся в кэше перед их загрузкой в Azure.<br/><br/> Держите свободное пространство выше 25%. Если она опускается ниже 20%, репликация задушена для реплицированных машин, связанных с сервером процесса.

## <a name="check-process-server-health"></a>Проверка работоспособности сервера процесса

Первым шагом в устранении неполадок является проверка работоспособности и состояния сервера процесса. Для этого просмотрите все оповещения, проверьте, что необходимые службы работают, и убедитесь, что есть сердцебиение от сервера процесса. Эти шаги обобщены в следующем графике, а затем процедуры, которые помогут вам выполнить шаги.

![Работоспособность процесса устранения неполадок](./media/vmware-physical-azure-troubleshoot-process-server/troubleshoot-process-server-health.png)

## <a name="step-1-troubleshoot-process-server-health-alerts"></a>Шаг 1: Устранение проблем процесс оповещения о работоспособности сервера

Сервер процесса генерирует ряд оповещений о работоспособности. Эти предупреждения и рекомендуемые действия суммируются в следующей таблице.

**Тип оповещения** | **Ошибка** | **Устранение неполадок**
--- | --- | --- 
![Healthy][green] | None  | Процесс серверподключен и работоспособен.
![Предупреждение][yellow] | Определенные службы не работают. | 1. Проверьте, что службы работают.<br/> 2. Если службы работают, как ожидалось, следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)
![Предупреждение][yellow]  | Использование процессора > 80% за последние 15 минут. | 1. Не добавляйте новые машины.<br/>2. Проверьте, что количество вм с помощью сервера процесса выравнивается до [определенных пределов,](site-recovery-plan-capacity-vmware.md#capacity-considerations)и рассмотреть вопрос о настройке [дополнительного сервера процесса.](vmware-azure-set-up-process-server-scale.md)<br/>3. Следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)
![Critical][red] |  Использование процессора > 95% за последние 15 минут. | 1. Не добавляйте новые машины.<br/>2. Проверьте, что количество вм с помощью сервера процесса выравнивается до [определенных пределов,](site-recovery-plan-capacity-vmware.md#capacity-considerations)и рассмотреть вопрос о настройке [дополнительного сервера процесса.](vmware-azure-set-up-process-server-scale.md)<br/>3. Следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)<br/> 4. Если проблема сохраняется, запустите [планировщик развертывания](https://aka.ms/asr-v2a-deployment-planner) для репликации VMware/физического сервера.
![Предупреждение][yellow] | Использование памяти > 80% за последние 15 минут. |  1. Не добавляйте новые машины.<br/>2. Проверьте, что количество вм с помощью сервера процесса выравнивается до [определенных пределов,](site-recovery-plan-capacity-vmware.md#capacity-considerations)и рассмотреть вопрос о настройке [дополнительного сервера процесса.](vmware-azure-set-up-process-server-scale.md)<br/>3. Следуйте любым инструкциям, связанным с предупреждением.<br/> 4. Если проблема сохраняется, следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)
![Critical][red] | Использование памяти > 95% за последние 15 минут. | 1. Не добавляйте новые машины, и рассматривает возможность создания [дополнительного сервера процесса.](vmware-azure-set-up-process-server-scale.md)<br/> 2. Следуйте любым инструкциям, связанным с предупреждением.<br/> 3. 4. Если проблема продолжается, следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)<br/> 4. Если проблема сохраняется, запустите [планировщик развертывания](https://aka.ms/asr-v2a-deployment-planner) для vMware/физических проблем репликации сервера.
![Предупреждение][yellow] | Кэш папки свободного пространства < 30% за последние 15 минут. | 1. Не добавляйте новые машины и рассмотрите возможность создания [дополнительного сервера процесса.](vmware-azure-set-up-process-server-scale.md)<br/>2. Убедитесь, что количество вм с помощью сервера процесса соответствует [руководящим принципам.](site-recovery-plan-capacity-vmware.md#capacity-considerations)<br/> 3. Следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)
![Critical][red] |  Свободное пространство < 25% за последние 15 минут | 1. Следуйте инструкциям, связанным с предупреждением по этой проблеме.<br/> 2. 3. Следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)<br/> 3. Если проблема сохраняется, запустите [планировщик развертывания](https://aka.ms/asr-v2a-deployment-planner) для репликации VMware/физического сервера.
![Critical][red] | Нет сердцебиения от процесса сервера в течение 15 минут или более. Служба tmansvs не общается с сервером конфигурации. | 1) Убедитесь, что сервер процесса запущен и запущен.<br/> 2. Убедитесь, что tmassvc работает на сервере процесса.<br/> 3. Следуйте инструкциям ниже, чтобы [устранить проблемы подключения и репликации.](#check-connectivity-and-replication)


![Ключ таблицы](./media/vmware-physical-azure-troubleshoot-process-server/table-key.png)


## <a name="step-2-check-process-server-services"></a>Шаг 2: Проверка обслуживания сервера процессов

Службы, которые должны работать на сервере процесса, обобщены в следующей таблице. Существуют небольшие различия в службах, в зависимости от того, как развертывается сервер процесса. 

Для всех служб, кроме агента служб восстановления Microsoft Azure (obengine), проверьте, что StartType настроен на **автоматический** или **автоматический (Задержка начала).**
 
**Развертывание** | **Запуск служб**
--- | ---
**Обработка сервера на сервере конфигурации** | ProcessServer; ПроцессServerMonitor; cxprocessserver; InMage PushInstall; Служба загрузки журналов (LogUpload); Служба применения InMage Scout; Агент служб восстановления Microsoft Azure (obengine); InMage Scout VX Agent-Sentinel/Outpost (свагенты); tmansvc; Всемирная веб-служба (W3SVC); MyS'L; Служба восстановления сайтов Microsoft Azure (dra)
**Обработка сервера, работаемого как автономный сервер** | ProcessServer; ПроцессServerMonitor; cxprocessserver; InMage PushInstall; Служба загрузки журналов (LogUpload); Служба применения InMage Scout; Агент служб восстановления Microsoft Azure (obengine); InMage Scout VX Agent-Sentinel/Outpost (свагенты); tmansvc.
**Обработка сервера, развернутого в Azure для сбоя** | ProcessServer; ПроцессServerMonitor; cxprocessserver; InMage PushInstall; Служба загрузки журнала (LogUpload)


## <a name="step-3-check-the-process-server-heartbeat"></a>Шаг 3: Проверьте сердцебиение сервера процесса

Если нет сердцебиения от сервера процесса (код ошибки 806), сделайте следующее:

1. Убедитесь, что сервер процесса VM запущен и запущен.
2. Проверьте эти журналы на наличие ошибок.

    C:'ProgramData-ASR-home-svsystems-eventmanager *.log C-ProgramData-ASR-home-svsystems-monitor_protection*.log

## <a name="check-connectivity-and-replication"></a>Проверка подключения и репликации

 Первоначальные и текущие сбои репликации часто вызваны проблемами подключения между исходными машинами и сервером процесса или между сервером процесса и Azure. Эти шаги обобщены в следующем графике, а затем процедуры, которые помогут вам выполнить шаги.

![Подключение и репликация проблем](./media/vmware-physical-azure-troubleshoot-process-server/troubleshoot-connectivity-replication.png)


## <a name="step-4-verify-time-sync-on-source-machine"></a>Шаг 4: Проверка синхронизации времени на исходной машине

Убедитесь, что дата/время воспроизведения системы синхронизированы. [Узнать больше](https://docs.microsoft.com/windows-server/networking/windows-time-service/accurate-time)

## <a name="step-5-check-anti-virus-software-on-source-machine"></a>Шаг 5: Проверьте антивирусное программное обеспечение на исходной машине

Убедитесь, что никакое антивирусное программное обеспечение на реплицируемой машине не блокирует восстановление сайта. Если вам нужно исключить восстановление сайта из антивирусных программ, просмотрите [эту статью](vmware-azure-set-up-source.md#azure-site-recovery-folder-exclusions-from-antivirus-program).

## <a name="step-6-check-connectivity-from-source-machine"></a>Шаг 6: Проверка подключения от исходной машины


1. Установите [клиент Telnet](https://technet.microsoft.com/library/cc771275(v=WS.10).aspx) на исходную машину, если это необходимо. Не используй пинг.
2. Из исходной машины, пинг процесс сервера на порт HTTPS с Telnet. По умолчанию 9443 является портом HTTPS для трафика репликации.

    `telnet <process server IP address> <port>`

3. Проверьте, является ли соединение успешным.


**Подключения** | **Подробно** | **Действие**
--- | --- | ---
**Успешной** | Telnet показывает пустой экран, и процесс сервера довечимы. | Никаких дальнейших действий не требуется.
**Неудачных** | Вы не можете подключиться | Убедитесь, что входящий порт 9443 разрешен на сервере процесса. Например, если у вас есть сеть периметра или экранированная подсеть. Снова проверьте подключение.
**Частично успешный** | Вы можете подключиться, но исходная машина сообщает, что сервер процесса не может быть достигнут. | Продолжить следующую процедуру устранения неполадок.

## <a name="step-7-troubleshoot-an-unreachable-process-server"></a>Шаг 7: Устранение недосягаемого сервера процесса

Если сервер процесса не дотягивается до исходной машины, будет отображаться ошибка 78186. Если эта проблема не будет решена, то это приведет как к тому, что точки восстановления приложения будут соответствовать согласованным, так и краш-согласованным точкам восстановления, которые не будут созданы, как ожидалось.

Устранение неполадок, проверяя, может ли исходная машина достичь IP-адреса сервера процесса и запустить инструмент cxpsclient на исходной машине, чтобы проверить сквозное соединение.


### <a name="check-the-ip-connection-on-the-process-server"></a>Проверка IP-соединения на сервере процесса

Если telnet успешен, но исходная машина сообщает, что сервер процесса не может быть достигнут, проверьте, можно ли достичь IP-адреса сервера процесса.

1. В веб-браузере, попробуйте достичь IP-адреса https://<PS_IP>:<PS_Data_Port>/.
2. Если эта проверка показывает ошибку сертификата HTTPS, это нормально. Если вы игнорируете ошибку, вы должны увидеть 400 - Bad Request. Это означает, что сервер не может обслуживать запрос браузера, и что стандартное соединение HTTPS в порядке.
3. Если эта проверка не работает, обратите внимание на сообщение об ошибке браузера. Например, ошибка 407 укажет проблему с проверкой подлинности прокси.

### <a name="check-the-connection-with-cxpsclient"></a>Проверьте связь с cxpsclient

Кроме того, можно запустить инструмент cxpsclient для проверки сквозного соединения.

1. Запустите средство следующим образом.

    ```
    <install folder>\cxpsclient.exe -i <PS_IP> -l <PS_Data_Port> -y <timeout_in_secs:recommended 300>
    ```

2. На сервере процесса проверьте генерируемые журналы в этих папках:

    C:-ProgramData-ASR-home-svsystems-transport-log-cxps.err C:



### <a name="check-source-vm-logs-for-upload-failures-error-78028"></a>Проверьте источник VM журналы для загрузки сбоев (ошибка 78028)

Проблема с загрузкой данных, заблокированной от исходных машин в службу процесса, может привести как к сбою, так и к согласованным точкам восстановления приложений. 

1. Чтобы устранить сбои загрузки сети, вы можете искать ошибки в этом журнале:

    C:«Файлы программы (x86)»Microsoft Azure Site Recovery 

2. Использование остальных процедур в этой статье может помочь вам решить проблемы загрузки данных.



## <a name="step-8-check-whether-the-process-server-is-pushing-data"></a>Шаг 8: Проверьте, продвигает ли сервер процесса данные

Проверьте, отправляет ли сервер обработки данные в Azure.

  1. Откройте диспетчер задач на сервере обработки (нажмите клавиши CTRL+SHIFT+ESC).
  2. Выберите вкладку **«Производительность»** > **open Resource Monitor.**
  3. На странице **«Монитор ресурсов»** выберите вкладку **Сети.** В **рамках процессов с сетевой активностью**проверьте, активно ли cbengine.exe отправляет большой объем данных.

       ![Объемы в процессах с сетевой активностью](./media/vmware-physical-azure-troubleshoot-process-server/cbengine.png)

  Если файл cbengine.exe не отправляет большие объемы данных, выполните действия, указанные в следующих разделах.

## <a name="step-9-check-the-process-server-connection-to-azure-blob-storage"></a>Шаг 9: Проверьте подключение сервера процесса к хранению Azure blob

1. В ресурсном мониторе выберите **cbengine.exe**.
2. Под **TCP Connections**проверьте наличие подключения с сервера процесса в хранилище Azure.

  ![Связь между cbengine.exe и URL-адресом хранения Azure Blob](./media/vmware-physical-azure-troubleshoot-process-server/rmonitor.png)

### <a name="check-services"></a>Проверка услуг

Если нет подключения с сервера процесса к URL-адресу хранения azure blob, проверьте, что службы работают.

1. В панели управления выберите **Услуги**.
2. Убедитесь, что работают следующие службы:

    - cxprocessserver;
    - InMage Scout VX Agent – Sentinel/Outpost;
    - агент служб восстановления Microsoft Azure.
    - служба Microsoft Azure Site Recovery;
    - tmansvc.

3. Запустите или перезапустите службы, которые не запущены.
4. Убедитесь, что сервер процесса подключен и довис. 

## <a name="step-10-check-the-process-server-connection-to-azure-public-ip-address"></a>Шаг 10: проверить подключение сервера процесса к общественному IP-адресу Azure

1. На сервере процесса, в **%programfiles% -" Microsoft Azure Recovery Services Agent-Temp**, откройте последний файл CBEngineCurr.errlog.
2. В файле поиск **443**, или для попытки соединения строки **не удалось.**

  ![Ошибки журналов в папке Temp](./media/vmware-physical-azure-troubleshoot-process-server/logdetails1.png)

3. Если вы видите проблемы, разместите свой общедоступный IP-адрес Azure в файле CBEngineCurr.currLog с помощью порта 443:

  `telnet <your Azure Public IP address as seen in CBEngineCurr.errlog>  443`

5. На командной строке на сервере процесса используйте Telnet для проверки вашего общедоступного IP-адреса Azure.
6. Если вы не можете подключиться, следуйте следующей процедуре.

## <a name="step-11-check-process-server-firewall-settings"></a>Шаг 11: Проверьте настройки брандмауэра сервера. 

Проверьте, блокирует ли брандмауэр на сервере, основанном на IP-адресах, доступ.

1. Для правил брандмауэра на основе IP-адресов:

    а) Загрузите полный список [IP-диапазонов Центра обработки данных Microsoft Azure.](https://www.microsoft.com/download/details.aspx?id=41653)

    б) Добавьте диапазоны IP-адресов в конфигурацию брандмауэра, чтобы гарантировать, что брандмауэр позволяет общаться с Azure (и к порту HTTPS по умолчанию, 443).

    в) Разрешить диапазонЫ IP-адресов для региона Azure вашей подписки и для региона Azure West US (используется для управления доступом и идентификационным запросом).

2. Для брандмауэров на основе URL добавьте URL-адреса, перечисленные в следующей таблице, к конфигурации брандмауэра.

    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]  


## <a name="step-12-verify-process-server-proxy-settings"></a>Шаг 12: Проверить настройки прокси-сервера процесса 

1. Если вы используете прокси-сервер, убедитесь, что его имя разрешается DNS-сервером. Проверьте значение, которое вы предоставили при настройке сервера конфигурации в ключе реестра **HKEY_LOCAL_MACHINE »SOFTWARE»Microsoft-Microsoft-Azure Восстановление сайта»ProxySettings.**
2. Убедитесь, что одни и те же параметры используются агентом восстановления сайта Azure для отправки данных.

    а) Поиск **резервного копирования Microsoft Azure**.

    б) Откройте **резервное копирование Microsoft Azure**и выберите**свойства изменения** **действий.** > 

    в) На вкладке **конфигурации прокси** прокси-адрес должен быть таким же, как и прокси-адрес, указанный в настройках реестра. В противном случае измените его на тот адрес.

## <a name="step-13-check-bandwidth"></a>Шаг 13: Проверьте пропускную способность

Увеличьте пропускную способность между сервером процесса и Azure, а затем проверьте, возникает ли проблема.


## <a name="next-steps"></a>Дальнейшие действия

Если вам нужна дополнительная помощь, задайте свой вопрос на [форуме Azure Site Recovery](https://social.msdn.microsoft.com/Forums/azure/home?forum=hypervrecovmgr). 

[green]: ./media/vmware-physical-azure-troubleshoot-process-server/green.png
[yellow]: ./media/vmware-physical-azure-troubleshoot-process-server/yellow.png
[red]: ./media/vmware-physical-azure-troubleshoot-process-server/red.png
