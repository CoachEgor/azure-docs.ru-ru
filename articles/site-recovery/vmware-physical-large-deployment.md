---
title: МасштабИрование VMware/восстановление физической аварии с восстановлением сайта Azure
description: Узнайте, как настроить аварийное восстановление в Azure для большого количества находинных VM VMware или физических серверов с помощью Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 11/14/2019
ms.author: raynew
ms.openlocfilehash: 36cc63721fe003934aabfb3ae2a03a4113937ca4
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79256943"
---
# <a name="set-up-disaster-recovery-at-scale-for-vmware-vmsphysical-servers"></a>Настройка аварийного восстановления в масштабе для VMware VMs/физических серверов

В этой статье описывается, как настроить аварийное восстановление в Azure для больших чисел (> 1000) наемных VM VMware или физических серверов в производственной среде с помощью службы [восстановления сайта Azure.](site-recovery-overview.md)


## <a name="define-your-bcdr-strategy"></a>Определите стратегию BCDR

В рамках стратегии непрерывности бизнеса и аварийного восстановления (BCDR) вы определяете цели точек восстановления (RPOs) и задачи времени восстановления (RTOs) для бизнес-приложений и рабочих нагрузок. RTO измеряет продолжительность времени и уровень обслуживания, в течение которого бизнес-приложение или процесс должны быть восстановлены и доступны, чтобы избежать проблем непрерывности.
- Восстановление сайта обеспечивает непрерывное воспроизведение vMwи и физических серверов VMware, а также [SLA](https://azure.microsoft.com/support/legal/sla/site-recovery/v1_2/) для RTO.
- При планировании крупномасштабных аварийных решений для VMware и определении необходимых ресурсов Azure можно указать значение RTO, которое будет использоваться для расчетов емкости.


## <a name="best-practices"></a>Рекомендации

Некоторые общие рекомендации по крупномасштабному аварийному восстановлению. Эти рекомендации более подробно обсуждаются в следующих разделах документа.

- **Определите целевые требования**: Оцените потребности в емкости и ресурсах в Azure перед настройкой аварийного восстановления.
- **Планируйте компоненты восстановления сайта:** выясните, какие компоненты восстановления сайта (сервер конфигурации, серверы процессов) необходимо для удовлетворения расчетной емкости.
- **Навлайте один или несколько серверов масштабирования:** Не используйте сервер процесса, который работает по умолчанию на сервере конфигурации. 
- **Выполнить последние обновления**: Команда восстановления сайта выпускает новые версии компонентов восстановления сайта на регулярной основе, и вы должны убедиться, что вы работаете последние версии. Чтобы помочь в этом, [отслеживать, что нового](site-recovery-whats-new.md) для обновлений, а также [включить и установить обновления](service-updates-how-to.md) по мере их выпуска.
- **Проработайте упреждающий**режим: При запуске аварийного восстановления следует активно следить за состоянием и работоспособностью реплицированных машин и ресурсов инфраструктуры.
- **Аварийные упражнения восстановления:** Вы должны запустить аварийного восстановления учений на регулярной основе. Они не влияют на рабочую среду, но помогают гарантировать, что сбой в работе Azure будет работать в случае необходимости.



## <a name="gather-capacity-planning-information"></a>Сбор информации о планировании емкости

Соберите информацию о вашей среде, чтобы помочь оценить и оценить ваши целевые (Azure) потребности в емкости.
- Для этого для VMware запустите планировщик развертывания для VMware VMs.
- Для физических серверов соберите информацию вручную.

### <a name="run-the-deployment-planner-for-vmware-vms"></a>Выполнить планировщик развертывания для VMware VMs

Планировщик развертывания помогает вам собирать информацию о вашей среде VMware.

- Запустите планировщик развертывания в период, представляющий типичный отток для ввоза вашего итога. Это позволит получить более точные оценки и рекомендации.
- Мы рекомендуем запустить планировщик развертывания на серверной машине конфигурации, так как Планировщик вычисляет пропускную пропускную вычисляемую с сервера, на котором он работает. [Узнайте больше](site-recovery-vmware-deployment-planner-run.md#get-throughput) об измерении пропускной вылимы.
- Если у вас еще нет настройки сервера конфигурации:
    - [Получите обзор](vmware-physical-azure-config-process-server-overview.md) компонентов восстановления сайта.
    - [Навлажай сервер конфигурации,](vmware-azure-deploy-configuration-server.md)чтобы запустить планировщик развертывания.

Затем запустите Planner следующим образом:

1. [Узнайте о](site-recovery-deployment-planner.md) планировщике развертывания. Вы можете скачать последнюю версию с портала, или [скачать его напрямую](https://aka.ms/asr-deployment-planner).
2. Просмотрите [предпосылки](site-recovery-deployment-planner.md#prerequisites) и [последние обновления](site-recovery-deployment-planner-history.md) для планировщика развертывания, [а также загрузите и извлеките](site-recovery-deployment-planner.md#download-and-extract-the-deployment-planner-tool) инструмент.
3. [Запустите планировщик развертывания](site-recovery-vmware-deployment-planner-run.md) на сервере конфигурации.
4. [Создание отчета](site-recovery-vmware-deployment-planner-run.md#generate-report) для обобщения оценок и рекомендаций.
5. Проанализируйте [рекомендации отчета](site-recovery-vmware-deployment-planner-analyze-report.md) и [оценки затрат.](site-recovery-vmware-deployment-planner-cost-estimation.md)

>[!NOTE]
> По умолчанию инструмент настроен для профиля и генерирует отчет до 1000 вм. Вы можете изменить этот лимит, увеличив ключевую стоимость MaxVMsSupported в файле ASRDeploymentPlanner.exe.config.

## <a name="plan-target-azure-requirements-and-capacity"></a>Требования и емкость целевого плана (Azure)

Используя собранные оценки и рекомендации, вы можете планировать целевые ресурсы и емкость. Если вы запустили планировщик развертывания для VMware VMs, вы можете использовать ряд [рекомендаций отчета,](site-recovery-vmware-deployment-planner-analyze-report.md#recommendations) чтобы помочь вам.

- **Совместимые всхожья:** Используйте это число для определения числа вс-м вс-миноносца, готовых к аварийному восстановлению в Azure. Рекомендации по пропускной способности сети и ядрам Azure основаны на этом количестве.
- **Требуемая пропускная способность сети:** Обратите внимание на пропускную способность, необходимую для репликации совместимых VMs-изображок. 
    - При запуске Planner вы указываете желаемое RPO в считанные минуты. Рекомендации показывают, что пропускная способность, необходимая для удовлетворения, что RPO 100% и 90% времени. 
    - Рекомендации по пропускной способности сети учитывают пропускную способность, необходимую для общего числа серверов конфигурации и серверов процессов, рекомендованных в Планировщике.
- **Требуемые ядра Azure:** Обратите внимание на количество ядер, необходимых в целевом регионе Azure, в зависимости от количества совместимых VMs. Если у вас недостаточно ядер, при восстановлении сайта сотказ омрачить не удастся создать необходимые MMs Azure.
- **Рекомендуемый размер партии VM**: Рекомендуемый размер партии основан на возможности завершения первоначальной репликации для партии в течение 72 часов по умолчанию, при выполнении RPO 100%. Значение часа может быть изменено.

Эти рекомендации можно использовать для планирования ресурсов Azure, пропускной способности сети и vM-пакетирования.

## <a name="plan-azure-subscriptions-and-quotas"></a>ПланИруйте подписки и квоты Azure

Мы хотим убедиться, что доступные квоты в целевой подписке достаточны для обработки сбоев.

**Задача** | **Подробно** | **Действие**
--- | --- | ---
**Проверка ядер** | Если ядра в доступной квоте не равны или превышают общее целевое количество на момент сбоя, отказы потерпят неудачу. | Для VMware VMs проверьте наличие достаточного количества ядер в целевой подписке, чтобы соответствовать рекомендации планировщика развертывания.<br/><br/> Для физических серверов проверьте, соответствуют ли ядра Azure вашим ручным оценкам.<br/><br/> Чтобы проверить квоты, на портале Azure > **подписки**нажмите **«Использование» и квоты**.<br/><br/> [Подробнее](https://docs.microsoft.com/azure/azure-portal/supportability/resource-manager-core-quotas-request) об увеличении квот.
**Проверка пределов сбоя** | Количество отказов не должно превышать пределов сбоя восстановления сайта. |  Если сбой превышает пределы, можно добавить подписку и не перейти к нескольким подпискам или увеличить квоту для подписки. 


### <a name="failover-limits"></a>Ограничения failover

Ограничения указывают количество отказов, которые поддерживаются восстановлением сайта в течение одного часа, предполагая, что три диска на машину.

Что означает соблюдение? Для запуска Azure VM Azure требует, чтобы некоторые драйверы были в состоянии запуска загрузки, а службы, такие как DHCP, запускались автоматически.
- Машины, которые соответствуют, уже будут иметь эти настройки на месте.
- Для машин, работающих под управлением Windows, можно проактивно проверять соответствие требованиям и при необходимости выполнять их. Ознакомьтесь с [дополнительными сведениями](site-recovery-failover-to-azure-troubleshoot.md#failover-failed-with-error-id-170010).
- Linux машины приведены в соответствие только во время сбоя.

**Машина соответствует Azure?** | **Ограничения Azure VM (управляемый диск failover)**
--- | --- 
Да | 2000
нет | 1000

- Ограничения предполагают, что в целевом регионе для подписки выполняется минимальное количество других заданий.
- Некоторые области Azure меньше и могут иметь несколько более низкие пределы.

## <a name="plan-infrastructure-and-vm-connectivity"></a>Планирование инфраструктуры и подключения VM

После сбоя в Azure необходимо, чтобы рабочие нагрузки работали так же, как и на месте, и чтобы пользователи могли получать доступ к рабочим нагрузкам, работающим на M-технологий Azure.

- [Подробнее](site-recovery-active-directory.md#test-failover-considerations) о сбое в инфраструктуре Active Directory или DNS в Azure узнайте больше о сбое в инфраструктуре Active Directory или DNS.
- [Подробнее](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover) о подготовке к подключению к MMs-вМ-подъ-звена Azure после сбоя.



## <a name="plan-for-source-capacity-and-requirements"></a>План для исходной емкости и потребностей

Важно, чтобы у вас было достаточно серверов конфигурации и серверов масштабирования процессов для удовлетворения требований к емкости. При запуске крупномасштабного развертывания начните с одного сервера конфигурации и одного сервера процесса масштабирования. По мере того как вы достигаете предписанных пределов, добавьте дополнительные серверы.

>[!NOTE]
> Для VMware VMs планировщик развертывания дает некоторые рекомендации относительно необходимых серверов конфигурации и процесса. Мы рекомендуем использовать таблицы, включенные в следующие процедуры, вместо того, чтобы следовать рекомендации планировщика развертывания. 


## <a name="set-up-a-configuration-server"></a>Настройка сервера конфигурации
 
Емкость сервера конфигурации зависит от количества репликационных машин, а не от скорости оттока данных. Чтобы выяснить, нужны ли вам дополнительные серверы конфигурации, используйте эти определенные лимиты VM.

**Процессора** | **Память** | **Диск кэша** | **Повторяется ограничение машины**
 --- | --- | --- | ---
8 виртуальных ЦП<br> 2 розетки no 4 ядра 2,5 ГГц | 16 ГБ | 600 ГБ | До 550 машин<br> Предполагает, что каждая машина имеет три диска по 100 ГБ каждый.

- Эти ограничения основаны на сервере конфигурации, настроенном с использованием шаблона OVF.
- Ограничения предполагают, что вы не используете сервер процесса, который работает по умолчанию на сервере конфигурации.

Если вам нужно добавить новый сервер конфигурации, следуйте следующим инструкциям:

- [Навлажь сервер конфигурации](vmware-azure-deploy-configuration-server.md) для аварийного восстановления VMware VM с помощью шаблона OVF.
- [Направляйте сервер конфигурации](physical-azure-set-up-source.md) вручную для физических серверов или для развертывания VMware, которые не могут использовать шаблон OVF.

При настройке сервера конфигурации обратите внимание, что:

- При настройке сервера конфигурации важно учитывать подписку и хранилище, в котором он находится, так как они не должны быть изменены после настройки. Если вам нужно изменить хранилище, необходимо отсоединить сервер конфигурации от хранилища и перерегистрировать его. Это останавливает репликацию vMs в хранилище.
- Если требуется настроить сервер конфигурации с несколькими сетевыми адаптерами, это следует сделать во время настройки. Вы не можете сделать это после регистрации сервера конфигурации в хранилище.

## <a name="set-up-a-process-server"></a>Настройка сервера процессов

Емкость сервера процесса зависит от коэффициентов оттока данных, а не количества машин, включенных для репликации.

- Для больших развертываний всегда должен быть по крайней мере один сервер процесса масштабирования.
- Чтобы выяснить, нужны ли вам дополнительные серверы, используйте следующую таблицу.
- Мы рекомендуем добавить сервер с самой высокой спецификацией. 


**Процессора** | **Память** | **Диск кэша** | **Коэффициент оттока**
 --- | --- | --- | --- 
12 виртуальных ЦП<br> 2 ядра розетки No6 2,5 ГГц | 24 ГБ | 1 ГБ | До 2 ТБ в день

Настройка сервера процесса следующим образом:

1. Ознакомьтесь с [предварительными требованиями.](vmware-azure-set-up-process-server-scale.md#prerequisites)
2. Установите сервер на [портале](vmware-azure-set-up-process-server-scale.md#install-from-the-ui)или с [командной строки.](vmware-azure-set-up-process-server-scale.md#install-from-the-command-line)
3. Налаживать реплицированные машины для использования нового сервера. Если у вас уже есть машины репликации:
    - Можно [переместить](vmware-azure-manage-process-server.md#switch-an-entire-workload-to-another-process-server) всю рабочую нагрузку сервера процесса на новый сервер процесса.
    - Кроме того, можно [переместить](vmware-azure-manage-process-server.md#move-vms-to-balance-the-process-server-load) определенные вдыхать на новый сервер процесса.



## <a name="enable-large-scale-replication"></a>Включить крупномасштабную репликацию

После планирования емкости и развертывания необходимых компонентов и инфраструктуры, возможность репликации для большого количества ВМ.

1. Сортировать машины на партии. Вы позволяете репликации для VMs в пакете, а затем переходите к следующей партии.

    - Для VMware VMs можно использовать [рекомендуемый размер партии VM](site-recovery-vmware-deployment-planner-analyze-report.md#recommended-vm-batch-size-for-initial-replication) в отчете Планировщик развертывания.
    - Для физических машин мы рекомендуем вам определить пакеты на основе машин, которые имеют одинаковый размер и объем данных, а также на доступной пропускной связи сети. Цель состоит в том, чтобы пакет машин, которые, вероятно, закончить их первоначальное репликации примерно в то же количество времени.
    
2. Если отток диска для машины высок или превышает ограничения в развертывании thePlanner, можно переместить некритические файлы, которые не нужно реплицировать (например, свалы журналов или временные файлы) с машины. Для VMware VMs можно переместить эти файлы на отдельный диск, а затем [исключить этот диск](vmware-azure-exclude-disk.md) из репликации.
3. Перед включением репликации проверьте соответствие машин [требованиям репликации.](vmware-physical-azure-support-matrix.md#replicated-machines)
4. Настройка политики репликации для [VMware VMs](vmware-azure-set-up-replication.md#create-a-policy) или [физических серверов.](physical-azure-disaster-recovery.md#create-a-replication-policy)
5. Включить репликацию для [VMware VMs](vmware-azure-enable-replication.md) или [физических серверов.](physical-azure-disaster-recovery.md#enable-replication) Это стартует первоначальное репликацию для выбранных машин.

## <a name="monitor-your-deployment"></a>Мониторинг развертывания

После начала репликации для первой партии ВМ начните мониторинг развертывания следующим образом:  

1. Назначьте администратору аварийного восстановления для мониторинга состояния работоспособности реплицированных машин.
2. [Мониторинг событий](site-recovery-monitor-and-troubleshoot.md) для реплицированных элементов и инфраструктуры.
3. [Мониторинг работоспособности](vmware-physical-azure-monitor-process-server.md) серверов масштабирования.
4. Зарегистрируйтесь, чтобы получать [уведомления по электронной почте](https://docs.microsoft.com/azure/site-recovery/site-recovery-monitor-and-troubleshoot#subscribe-to-email-notifications) для событий, для облегчения мониторинга.
5. Проводите регулярные [учения по аварийному восстановлению,](site-recovery-test-failover-to-azure.md)чтобы убедиться, что все работает как ожидалось.


## <a name="plan-for-large-scale-failovers"></a>План крупномасштабных неудач

В случае аварии может потребоваться сбой из-за большого количества машин/рабочих нагрузок в Azure. Подготовка к этому типу событий следующим образом.

Вы можете заранее подготовиться к неудаче следующим образом:

- [Подготовьте инфраструктуру и вм- связи](#plan-infrastructure-and-vm-connectivity) так, чтобы рабочие нагрузки были доступны после сбоя, и чтобы пользователи могли получить доступ к M M Azure.
- Обратите внимание на [ограничения по отказу](#failover-limits) ранее в этом документе. Убедитесь, что ваши неудачи будут подпадать под эти пределы.
- Запуск [регулярных учений аварийного восстановления](site-recovery-test-failover-to-azure.md). Дрели помогают:
    - Найдите пробелы в развертывании до сбоя.
    - Оцените сквозной RTO для ваших приложений.
    - Оцените сквозную RPO для рабочих нагрузок.
    - Выявление конфликтов в диапазоне IP-адресов.
    - При запуске сверла мы рекомендуем не использовать производственные сети для сверла, избегать использования одних и тех же названий подсетей в производственных и испытательных сетях и очищать тестовые совок после каждого сверла.

Для крупномасштабного сбоя мы рекомендуем следующее:

1. Создание планов восстановления для выполнения работы.
    - Каждый план восстановления может вызвать сбой до 50 машин.
    - [Узнайте подробнее](recovery-plan-overview.md) о планах восстановления.
2. Добавьте скрипты runbook Azure Automation в планы восстановления, чтобы автоматизировать любые ручные задачи в Azure. Типичные задачи включают настройку балансеров нагрузки, обновление DNS и т.д. [Дополнительные сведения](site-recovery-runbook-automation.md)
2. Перед неудачей подготовьте компьютеры Windows так, чтобы они соответствовали среде Azure. [Ограничения failover](#plan-azure-subscriptions-and-quotas) выше для машин, которые соответствуют. [Узнайте больше](site-recovery-failover-to-azure-troubleshoot.md#failover-failed-with-error-id-170010) о runbooks.
4.  Триггер неудачи с [стартом-AzRecoveryServicesrPlannedFailoverJob](https://docs.microsoft.com/powershell/module/az.recoveryservices/start-azrecoveryservicesasrplannedfailoverjob?view=azps-2.0.0&viewFallbackFrom=azps-1.1.0) PowerShell cmdlet, вместе с планом восстановления.



## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Мониторинг Site Recovery](site-recovery-monitor-and-troubleshoot.md)
