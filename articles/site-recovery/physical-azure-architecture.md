---
title: Архитектура аварийного восстановления физического сервера в Azure Site Recovery
description: В этой статье представлен обзор компонентов и архитектуры, используемых при аварийном восстановлении физических серверов из локальной среды в Azure с помощью службы Azure Site Recovery.
ms.topic: conceptual
ms.date: 02/11/2020
ms.openlocfilehash: 089d981284986a2b6eb0ee7f1dbd401fc7ce4fcd
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "77162843"
---
# <a name="physical-server-to-azure-disaster-recovery-architecture"></a>Архитектура для аварийного восстановления физических серверов в Azure

Эта статья описывает архитектуру и процессы, используемые при репликации, отработке отказа и восстановлении физических серверов Windows и Linux между локальным сайтом и Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

## <a name="architectural-components"></a>Компоненты архитектуры

В следующей таблице и рисунке представлено высокоуровневое представление компонентов, используемых для репликации физического сервера в Azure.

| **Компонент** | **Требование** | **Сведения** |
| --- | --- | --- |
| **Azure** | Подписка Azure и сеть Azure. | Реплицированные данные из локальных физических компьютеров хранятся на управляемых дисках Azure. Виртуальные машины Azure создаются с использованием реплицированных данных при запуске отработки отказа из локальной среды в Azure. При создании виртуальные машины Azure подключаются к виртуальной сети Azure. |
| **Сервер обработки** | По умолчанию устанавливается вместе с сервером конфигурации. | Выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.<br/><br/> Сервер обработки также устанавливает службу Mobility Service на серверах, которые требуется реплицировать.<br/><br/> По мере увеличения масштаба развертывания вы можете добавлять дополнительные отдельные серверы для обработки растущего объема данных репликации. |
| **Главный целевой сервер** | По умолчанию устанавливается вместе с сервером конфигурации. | Обрабатывает данные репликации при восстановлении после сбоя из Azure.<br/><br/> Для крупных развертываний вы можете добавить отдельный главный целевой сервер для восстановления размещения. |
| **Реплицированные серверы** | Служба Mobility Service устанавливается на каждом реплицируемом сервере. | Рекомендуем разрешить автоматическую установку с сервера обработки. Вы также можете установить службу вручную или использовать метод автоматического развертывания, например Configuration Manager. |

**Архитектура: репликация физических компьютеров в Azure**

![Компоненты](./media/physical-azure-architecture/arch-enhanced.png)

## <a name="replication-process"></a>Процесс репликации

1. Необходимо настроить развертывание, в том числе локальные компоненты и компоненты Azure. В хранилище служб восстановления нужно указать источник и целевой объект репликации, настроить сервер конфигурации, создать политику репликации и включить репликацию.
1. Компьютеры реплицируются с помощью политики репликации, а начальная копия данных сервера реплицируется в службу хранилища Azure.
1. После завершения начальной репликации начинается репликация разностных изменений в Azure. Записанные изменения для компьютера хранятся в файле с расширением _HRL_ .
   - Компьютеры обмениваются данными с сервером конфигурации по протоколу HTTPS 443 Inbound для управления репликацией.
   - Компьютеры отправляют данные репликации на сервер обработки по HTTPS-порту 9443 Inbound (можно изменить).
   - Сервер конфигурации управляет управлением репликацией с помощью Azure через HTTPS порт 443 исходящего трафика.
   - Сервер обработки получает данные с исходных компьютеров, оптимизирует и шифрует их и отправляет в службу хранилища Azure через HTTPS порт 443 исходящий трафик.
   - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Эту функция используется, если вы объединяете несколько компьютеров в группы репликации, и они совместно используют отказоустойчивые и согласованные точки восстановления после отработки отказа. Эти группы полезны, если компьютеры работают под одной и той же рабочей нагрузкой и должны быть единообразными.
1. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать [общедоступный пиринг](../expressroute/about-public-peering.md)Azure ExpressRoute.

   > [!NOTE]
   > Репликация не поддерживается через VPN-подключение типа "сеть — сеть" с локального сайта или [частного пиринга](concepts-expressroute-with-site-recovery.md#on-premises-to-azure-replication-with-expressroute)Azure ExpressRoute.

**Процедура репликации физических компонентов в Azure**

![Процесс репликации](./media/physical-azure-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

После настройки репликации можно запустить переход на аварийное восстановление (тестовую отработку отказа), чтобы убедиться, что все работает правильно. После этого можно выполнить отработку отказа и восстановить работоспособность при необходимости. Рекомендуются следующие действия.

- Плановая отработка отказа не поддерживается.
- Резервное копирование на локальную виртуальную машину VMware является обязательным. Необходима локальная инфраструктура VMware, даже если вы реплицируете локальные физические серверы в Azure.
- Выполните отработку отказа одного компьютера или создайте планы восстановления, чтобы выполнить отработку отказа нескольких компьютеров.
- При выполнении отработки отказа из реплицированных данных создаются виртуальные машины Azure в службе хранилища Azure.
- После запуска начальной отработки отказа вы зафиксируете ее, чтобы начать доступ к рабочей нагрузке из виртуальной машины Azure.
- Когда основной локальный сайт снова станет доступным, вы сможете выполнить восстановление размещения.
- Настройте инфраструктуру восстановления размещения, которая включает в себя:
  - **Временный сервер обработки в Azure**. Чтобы восстановить размещение из Azure, настройте виртуальную машину Azure как сервер обработки. Это позволит выполнять репликацию из Azure. Эту виртуальную машину можно удалить после завершения отработки отказа.
  - **VPN-подключение**. Для восстановления размещения нужно настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
  - **Отдельный главный целевой сервер**. по умолчанию при восстановлении после сбоя обрабатывается главный целевой сервер, который был установлен с сервером конфигурации на локальной виртуальной машине VMware. Если необходимо выполнить резервное копирование больших объемов трафика, следует настроить отдельный локальный главный целевой сервер.
  - **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Политика была автоматически создана при создании политики репликации из локальной среды в Azure.
  - **Инфраструктура VMware**. для возврата к отказу необходима инфраструктура VMware. Восстанавливать размещение на физический сервер нельзя.
- После того как компоненты будут установлены, при восстановлении размещения произойдет три этапа:
  - **Этап 1**. повторно включите защиту виртуальных машин Azure, чтобы они реплицировались из Azure обратно на локальные виртуальные машины VMware.
  - **Этап 2**. выполнение отработки отказа на локальном сайте.
  - **Этап 3**. После отработки отказа рабочих нагрузок повторно включите репликацию.

**Восстановление размещения VMware с переносом из Azure**

![Восстановление размещения](./media/physical-azure-architecture/enhanced-failback.png)

## <a name="next-steps"></a>Дальнейшие шаги

[Инструкции](physical-azure-disaster-recovery.md)по настройке аварийного восстановления для физических серверов в Azure см. в этом разделе.
