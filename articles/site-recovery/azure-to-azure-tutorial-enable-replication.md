---
title: Настройка аварийного восстановления виртуальных машин Azure в дополнительный регион Azure с помощью службы Azure Site Recovery
description: Сведения о настройке аварийного восстановления виртуальных машин Azure в другой регион Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 04/16/2019
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 588fe452473ddc2434d92f90afbf8a0e1bc8c275
ms.sourcegitcommit: 36c50860e75d86f0d0e2be9e3213ffa9a06f4150
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2019
ms.locfileid: "65795762"
---
# <a name="set-up-disaster-recovery-for-azure-vms"></a>Настройка аварийного восстановления для виртуальных машин Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

В этом руководстве содержатся сведения о настройке аварийного восстановления виртуальных машин Azure посредством их репликации из одного региона Azure в другой. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание хранилища служб восстановления
> * Проверка параметров целевых ресурсов
> * Настройка исходящих сетевых подключений для виртуальных машин
> * Включение репликации для виртуальных машин.

> [!NOTE]
> В этой статье приводятся инструкции по развертыванию аварийного восстановления с простейшими параметрами. Если вас интересуют настраиваемые параметры, см. [практические рекомендации](azure-to-azure-how-to-enable-replication.md).

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством:

- Вам должны быть понятны [архитектура и компоненты сценария](concepts-azure-to-azure-architecture.md).
- Перед началом работы ознакомьтесь с [требованиями поддержки](site-recovery-support-matrix-azure-to-azure.md).

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления

Создайте хранилище в любом регионе, за исключением исходного.

1. Войдите на [портал Azure](https://portal.azure.com) > **Службы восстановления**.
2. Щелкните **Создать ресурс** > **Средства управления** > **Backup and Site Recovery**.
3. В поле **Имя**укажите понятное имя для идентификации хранилища. Если у вас есть несколько подписок, выберите нужную.
4. Создайте группу ресурсов или выберите существующую. Укажите регион Azure. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [цен на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
5. Для быстрого доступа к хранилищу из панели мониторинга щелкните **Закрепить на панели мониторинга**, а затем — **Создать**.

   ![Новое хранилище](./media/azure-to-azure-tutorial-enable-replication/new-vault-settings.png)

   Новое хранилище появится в колонке **Панель мониторинга** в разделе **Все ресурсы** и на основной странице **Хранилища служб восстановления**.

## <a name="verify-target-resource-settings"></a>Проверка параметров целевых ресурсов

1. Убедитесь, что подписка Azure позволяет создавать виртуальные машины в целевом регионе. Свяжитесь со службой поддержки, чтобы включить необходимые квоты.
2. Убедитесь, что подписка располагает достаточными ресурсами, чтобы обеспечить поддержку виртуальных машин таких же размеров, как и у исходных виртуальных машин. Служба Site Recovery выбирает для целевой виртуальной машины такой же или наиболее подходящий размер.

## <a name="set-up-outbound-network-connectivity-for-vms"></a>Настройка исходящих сетевых подключений для виртуальных машин

Чтобы служба Site Recovery работала должным образом, необходимо внести некоторые изменения в исходящее сетевое подключение из виртуальных машин, которые требуется реплицировать.

> [!NOTE]
> Site Recovery не поддерживает использование прокси-сервер проверки подлинности для управления сетевым подключением.


### <a name="outbound-connectivity-for-urls"></a>Исходящие подключения для URL-адресов

При использовании прокси-сервера или брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих URL-адресов.

| **URL-адрес** | **Дополнительные сведения** |
| ------- | ----------- |
| *.blob.core.windows.net | Разрешает записывать данные из виртуальной машины в учетную запись хранения кэша в исходном регионе. |
| login.microsoftonline.com | Предоставляет авторизацию и проверку подлинности URL-адресов службы Site Recovery. |
| *.hypervrecoverymanager.windowsazure.com | Разрешает виртуальной машине взаимодействовать со службой Site Recovery. |
| *.servicebus.windows.net | Разрешает виртуальной машине записывать данные мониторинга и диагностики службы Site Recovery. |

### <a name="outbound-connectivity-for-ip-address-ranges"></a>Исходящие подключения для диапазонов IP-адресов

Для управления исходящими подключениями по IP-адресу вместо URL-адреса разрешите эти адреса в брандмауэре или прокси-сервере на основе IP-адресов, либо в правилах группы безопасности сети.

  - [Диапазоны IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653)
  - [Диапазоны IP-адресов центра обработки данных Microsoft Azure в Германии](https://www.microsoft.com/download/details.aspx?id=54770)
  - [Диапазоны IP-адресов центра обработки данных Microsoft Azure в Китае](https://www.microsoft.com/download/details.aspx?id=42064)
  - [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2#bkmk_identity)
  - [IP-адреса конечных точек службы Site Recovery](https://aka.ms/site-recovery-public-ips)

Если вы используете группу безопасности сети (NSG), то можете создать правила NSG с тегом службы хранилища для исходного региона. [Узнайте больше](azure-to-azure-about-networking.md#outbound-connectivity-for-ip-address-ranges).

## <a name="verify-azure-vm-certificates"></a>Проверка сертификатов виртуальной машины Azure

Убедитесь, что у виртуальных машин, которые необходимо реплицировать, есть новейшие корневые сертификаты. Если таких сертификатов нет, виртуальную машину нельзя зарегистрировать в Site Recovery из-за ограничений безопасности.

- При использовании виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы гарантировать присутствие всех доверенных корневых сертификатов. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификатам в вашей организации.
- На виртуальных машинах Linux выполните инструкции распространителя Linux, чтобы установить на виртуальные машины все свежие доверенные корневые сертификаты и список отзыва сертификатов.

## <a name="set-permissions-on-the-account"></a>Установка разрешений для учетной записи

Служба Azure Site Recovery предоставляет три встроенные роли для контроля операций управления Site Recovery.

- **Участник Site Recovery**. Эта роль имеет все разрешения, необходимые для управления операциями Azure Site Recovery в хранилище служб восстановления. Пользователь с этой ролью, тем не менее, не может создать или удалить хранилище служб восстановления или назначить права доступа другим пользователям. Эта роль лучше всего подходит для администраторов аварийного восстановления, которые могут включить аварийное восстановление и управлять им для приложений или всей организации.

- **Оператор Site Recovery**. Эта роль имеет разрешения на выполнение операций отработки отказа и восстановления размещения и управление ими. Пользователь с этой ролью не может включить или отключить репликацию, создать или удалить хранилище, зарегистрировать новую инфраструктуру или назначить права доступа другим пользователям. Эта роль лучше всего подходит для оператора аварийного восстановления, который может выполнять отработку отказа виртуальных машин или приложений по указанию владельцев приложений и ИТ-администраторов. После устранения аварии оператор аварийного восстановления может повторно применить защиту и восстановить размещение виртуальных машин.

- **Читатель Site Recovery**. Эта роль имеет разрешения на просмотр всех операций управления Site Recovery. Она лучше всего подходит для специалиста по контролю ИТ, который может отслеживать текущее состояние защиты и отправлять запросы в службу поддержки.

См. дополнительные сведения о [встроенных ролях RBAC Azure](../role-based-access-control/built-in-roles.md).

## <a name="enable-replication-for-a-vm"></a>Включение репликации для виртуальных машин.

### <a name="select-the-source"></a>Выбор источника

1. В хранилище служб восстановления щелкните имя хранилища и выберите **Реплицировать**.
2. В поле **Источник** выберите **Azure**.
3. В поле **Исходное расположение** выберите исходный регион Azure, в котором сейчас запущены виртуальные машины.
4. Выберите **исходную подписку**, в которой работают виртуальные машины. Это может быть любая подписка в одном клиенте Azure Active Directory, где существует хранилище служб восстановления.
5. Выберите **Исходная группа ресурсов** и нажмите **OK**, чтобы сохранить настройки.

    ![Настройка источника](./media/azure-to-azure-tutorial-enable-replication/source.png)

### <a name="select-the-vms"></a>Выбор виртуальных машин

Site Recovery получает список виртуальных машин, связанных с подпиской и группой ресурсов или облачной службой.

1. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
2. Последовательно выберите **ОК**.

### <a name="configure-replication-settings"></a>Настройка параметров репликации

Site Recovery создает параметры по умолчанию и политику репликации для целевого региона. Эти параметры можно изменить при необходимости.

1. Чтобы просмотреть целевой объект и параметры репликации, выберите **Параметры**.
2. Чтобы переопределить параметры по умолчанию для целевых объектов, щелкните ссылку **Customize** (Настроить) рядом с заголовком **Resource group, Network, Storage and Availability Sets** (Группа ресурсов, сеть, хранилище и группы доступности).

   ![Настройка параметров](./media/azure-to-azure-tutorial-enable-replication/settings.png)


3. Настройте целевые параметры, как описано в таблице.

    **Параметр** | **Дополнительные сведения**
    --- | ---
    **Целевая подписка** | По умолчанию целевая подписка совпадает с исходной подпиской. Щелкните "Настроить", чтобы выбрать другую целевую подписку в том же клиенте Azure Active Directory.
    **Целевое расположение** | Целевой регион, используемый для аварийного восстановления.<br/><br/> Мы рекомендуем, чтобы целевое расположение соответствовало расположению хранилища Site Recovery.
    **Целевая группа ресурсов** | Группа ресурсов в целевом регионе, в которую входят виртуальные машины Azure после отработки отказа.<br/><br/> По умолчанию Site Recovery создает группу ресурсов в целевом регионе с суффиксом asr. Целевая группа ресурсов может располагаться в любом регионе, за исключением того, в котором размещены ваши исходные виртуальные машины.
    **Целевая виртуальная сеть** | Сеть в целевом регионе, в которой размещаются виртуальные машины Azure после отработки отказа.<br/><br/> По умолчанию Site Recovery создает виртуальную сеть (и подсети) в целевом регионе с суффиксом asr.
    **Учетная запись хранения** | Site Recovery использует учетную запись хранения в исходном регионе. Изменения в исходных виртуальных машинах отправляются в эту учетную запись перед репликацией в целевое расположение.<br/><br/> Если в учетной записи хранения кэша включен брандмауэр, убедитесь, что вы задали параметр **Разрешить доверенные службы Майкрософт**. [Подробнее.](https://docs.microsoft.com/azure/storage/common/storage-network-security#exceptions)
    **Целевые учетные записи хранения (исходная виртуальная машина использует неуправляемые диски)** | Site Recovery по умолчанию создает новую учетную запись хранения в целевом регионе, которая отражает учетную запись хранения исходной виртуальной машины.<br/><br/> Включите **Разрешить доверенные службы Майкрософт**, если в учетной записи хранения кэша включен брандмауэр.
    **Управляемые диски реплики (если исходная виртуальная машина использует управляемые диски)** | Site Recovery по умолчанию создает управляемые диски реплики в целевом регионе, которые отражают управляемые диски исходной виртуальной машины с тем же типом хранилища (категории "Стандартный" или "Премиум"), что и на управляемом диске исходной виртуальной машины. Вы можете настроить только тип диска 
    **Целевая группа доступности** | По умолчанию Azure Site Recovery создает в целевом регионе группу доступности, добавляя к ее имени суффикс "asr" для определения виртуальных машин, входящих в эту группу доступности. Если группа доступности, создаваемая Azure Site Recovery, уже существует, она будет использована повторно.
    **Целевые зоны доступности** | По умолчанию Site Recovery назначает в целевом регионе тот же номер зоны, что и в исходном регионе, если целевой регион поддерживает зоны доступности.<br/><br/> Если целевой регион не поддерживает зоны доступности, целевые виртуальные машины настраиваются как отдельные экземпляры по умолчанию.<br/><br/> Нажмите **Настроить**, чтобы настроить виртуальные машины как часть группы доступности в целевом регионе.<br/><br/> После включения репликации изменить тип доступности (один экземпляр), группу доступности или зону доступности нельзя. Чтобы изменить тип доступности, необходимо отключить и повторно включить репликацию.

4. Чтобы настроить параметры политики репликации, нажмите **Настроить** рядом с полем **Политика репликации** и при необходимости измените параметры.

    **Параметр** | **Дополнительные сведения**
    --- | ---
    **Имя политики репликации** | Имя политики.
    **Хранение точки восстановления** | По умолчанию Site Recovery хранит точки восстановления 24 часа. Вы можете задать значение от 1 до 72 часов.
    **Периодичность создания моментальных снимков с согласованием приложений** | По умолчанию Site Recovery выполняет моментальные снимки с согласованием приложений каждые 4 часа. Вы можете задать значение от 1 до 12 часов.<br/><br/> Моментальный снимок с согласованием приложений представляет собой созданный на определенный момент времени снимок данных приложения в виртуальной машине. Служба теневого копирования томов (VSS) обеспечивает согласованное состояние приложения в виртуальной машине при создании моментального снимка.
    **Группа репликации** | Если приложению требуется согласованность между несколькими виртуальными машинами, вы можете создать для них группу репликации. По умолчанию выбранные виртуальные машины не входят ни в одну группу репликации.

5. Для параметра **Настроить** выберите **Да** для согласованности нескольких виртуальных машин, если вы хотите добавить виртуальные машины в новую или существующую группу репликации, Нажмите кнопку **ОК**. 

    >[!NOTE]
    >- На всех компьютерах в группе репликации имеются общие отказоустойчивые и согласованные точки восстановления после отработки отказа.
    >- Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки (это интенсивно использующие ЦП). Поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно несколько компьютеров.
    >- В группе репликации не может быть более 16 виртуальных машин.
    >- Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Убедитесь в том, что брандмауэр не блокирует внутренний обмен данными между виртуальными машинами через этот порт.
    >- Для виртуальных машин Linux в группе репликации убедитесь в том, что исходящий через порт 20004 трафик открыт вручную согласно указаниям для конкретной версии Linux.



### <a name="configure-encryption-settings"></a>Настройка параметров шифрования

Если на исходной виртуальной машине включено шифрование диска Azure (ADE), проверьте параметры.

1. Проверьте параметры:
    - **Хранилища ключей для шифрования дисков**. По умолчанию Site Recovery создает новое хранилище ключей на исходных ключах шифрования диска виртуальной машины с суффиксом "asr". Если хранилище ключей уже существует, оно используется повторно.
    - **Хранилища ключей для шифрования ключей**. По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. Имя имеет суффикс "asr" и основано на ключах шифрования исходной виртуальной машины. Если хранилище ключей, создаваемое Site Recovery, уже существует, оно будет использоваться повторно.

2. Щелкните **Настроить**, чтобы выбрать пользовательские хранилища ключей.

>[!NOTE]
>Azure Site Recovery сейчас поддерживает только виртуальные машины Azure под управлением Windows, в которых [включено шифрование с помощью приложения Azure AD](https://aka.ms/ade-aad-app).
>

### <a name="track-replication-status"></a>Отслеживание состояния репликации

1. В разделе **Параметры** щелкните **Обновить**, чтобы вывести актуальное состояние.
2. Отслеживайте ход выполнения и состояние следующим образом:
    - Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**.
    - Выберите **Параметры** > **Реплицированные элементы**, чтобы просмотреть состояние виртуальных машин и ход выполнения начальной репликации. Выберите виртуальную машину, чтобы просмотреть ее параметры.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы настроили аварийное восстановление для виртуальной машины Azure. Теперь вы можете инициировать аварийное восстановление, чтобы проверить, что отработка отказа работает правильно.

> [!div class="nextstepaction"]
> [Run a disaster recovery drill to Azure](azure-to-azure-tutorial-dr-drill.md) (Выполнение отработки аварийного восстановления в Azure)
