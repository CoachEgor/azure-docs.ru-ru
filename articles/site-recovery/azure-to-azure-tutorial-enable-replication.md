---
title: Настройка аварийного восстановления виртуальной машины Azure с помощью Azure Site Recovery
description: Сведения о том, как настроить аварийное восстановление виртуальных машин Azure в другой регион Azure с помощью службы Azure Site Recovery.
ms.topic: tutorial
ms.date: 1/24/2020
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: a3cec6cb009e3d83d22f3f2a4140afe16db180a8
ms.sourcegitcommit: f353fe5acd9698aa31631f38dd32790d889b4dbb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2020
ms.locfileid: "87372932"
---
# <a name="set-up-disaster-recovery-for-azure-vms"></a>Настройка аварийного восстановления для виртуальных машин Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

В этом руководстве показано, как настроить аварийное восстановление виртуальных машин Azure путем их репликации из одного региона Azure в другой. В этом руководстве описано следующее.

> [!div class="checklist"]
> * Создание хранилища Служб восстановления
> * Проверка параметров целевых ресурсов
> * Настройка исходящих сетевых подключений для виртуальных машин
> * Включение репликации для виртуальных машин

> [!NOTE]
> В этой статье приводятся инструкции по развертыванию аварийного восстановления с простейшими параметрами. Если вас интересуют настраиваемые параметры, перейдите к [практическим рекомендациям](azure-to-azure-how-to-enable-replication.md).

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством сделайте следующее:

- Ознакомьтесь с [архитектурой и компонентами сценария](./azure-to-azure-architecture.md).
- Перед началом работы ознакомьтесь с [требованиями поддержки](./azure-to-azure-support-matrix.md).

## <a name="create-a-recovery-services-vault"></a>Создание хранилища Служб восстановления

Создайте хранилище в любом регионе кроме исходного.

1. Войдите на [портал Azure](https://portal.azure.com).
1. На **домашней странице** или в меню портала Azure выберите **Создать ресурс**. Затем выберите **ИТ и средства управления** > **Backup и Site Recovery**.
1. В поле **Имя** укажите понятное имя для идентификации хранилища. Если у вас есть несколько подписок, выберите нужную.
1. Создайте группу ресурсов или выберите существующую. Укажите регион Azure. Сведения о поддерживаемых регионах см. в разделе о доступности по регионам на странице [Цены на Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
1. Для доступа к новому хранилищу с панели мониторинга выберите **Закрепить на панели мониторинга** и щелкните **Создать**.

   ![Новое хранилище](./media/azure-to-azure-tutorial-enable-replication/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** в разделе **Все ресурсы** и на основной странице **Хранилища Служб восстановления**.

## <a name="verify-target-resource-settings"></a>Проверка параметров целевых ресурсов

Проверьте подписку Azure для целевого региона.

- Убедитесь, что подписка Azure позволяет создавать виртуальные машины в целевом регионе. Свяжитесь со службой поддержки, чтобы включить необходимые квоты.
- Убедитесь, что подписка располагает достаточными ресурсами, чтобы обеспечить поддержку виртуальных машин таких же размеров, как и у исходных виртуальных машин. Служба Site Recovery выбирает для целевой виртуальной машины такой же или наиболее подходящий размер.

## <a name="set-up-outbound-network-connectivity-for-vms"></a>Настройка исходящих сетевых подключений для виртуальных машин

Чтобы служба Site Recovery работала должным образом, необходимо внести некоторые изменения в исходящее сетевое подключение из виртуальных машин, которые требуется реплицировать.

> [!NOTE]
> Site Recovery не поддерживает использование прокси-сервер проверки подлинности для управления сетевым подключением.

### <a name="outbound-connectivity-for-urls"></a>Исходящие подключения для URL-адресов

При использовании прокси-сервера или брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих URL-адресов:

| **URL-адрес** | **Сведения** |
| ------- | ----------- |
| `*.blob.core.windows.net` | Позволяет записывать данные из виртуальной машины в учетную запись хранения кэша в исходном регионе. |
| `login.microsoftonline.com` | Обеспечивает авторизацию и проверку подлинности URL-адресов службы Site Recovery. |
| `*.hypervrecoverymanager.windowsazure.com` | Позволяет виртуальной машине взаимодействовать со службой Site Recovery. |
| `*.servicebus.windows.net` | Позволяет виртуальной машине записывать данные мониторинга и диагностики службы Site Recovery. |

### <a name="outbound-connectivity-for-ip-address-ranges"></a>Исходящие подключения для диапазонов IP-адресов

Если вы используете группу безопасности сети (NSG), создайте правила NSG с тегом службы для доступа к службе хранилища Azure, Azure Active Directory, службе Site Recovery и ее данным мониторинга. [Подробнее](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags).

## <a name="verify-azure-vm-certificates"></a>Проверка сертификатов виртуальной машины Azure

Убедитесь, что у виртуальных машин, которые необходимо реплицировать, есть новейшие корневые сертификаты. Если таких сертификатов нет, виртуальную машину нельзя зарегистрировать в Site Recovery из-за ограничений безопасности.

- При использовании виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы гарантировать наличие всех доверенных корневых сертификатов. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификатам в вашей организации.
- На виртуальных машинах Linux выполните инструкции распространителя Linux, чтобы установить на виртуальные машины все последние доверенные корневые сертификаты и список отзыва сертификатов.

## <a name="set-permissions-on-the-account"></a>Установка разрешений для учетной записи

Служба Azure Site Recovery предоставляет три встроенные роли для контроля операций управления Site Recovery.

- **Участник Site Recovery**. Эта роль имеет все разрешения, необходимые для управления операциями Azure Site Recovery в хранилище служб восстановления. Но пользователь с этой ролью не может создать или удалить хранилище Служб восстановления или назначить права доступа другим пользователям. Эта роль лучше всего подходит для администраторов аварийного восстановления, которые могут включить аварийное восстановление и управлять им для приложений или всей организации.

- **Оператор Site Recovery**. Эта роль имеет разрешения на выполнение операций отработки отказа и восстановления размещения и управление ими. Пользователь с этой ролью не может включить или отключить репликацию, создать или удалить хранилище, зарегистрировать новую инфраструктуру или назначить права доступа другим пользователям. Эта роль лучше всего подходит для оператора аварийного восстановления, который может выполнять отработку отказа виртуальных машин или приложений по указанию владельцев приложений и ИТ-администраторов. После устранения аварии оператор аварийного восстановления может повторно применить защиту и восстановить размещение виртуальных машин.

- **Читатель Site Recovery**. Эта роль имеет разрешения на просмотр всех операций управления Site Recovery. Она лучше всего подходит для специалиста по контролю ИТ, который может отслеживать текущее состояние защиты и отправлять запросы в службу поддержки.

См. дополнительные сведения о [встроенных ролях Azure](../role-based-access-control/built-in-roles.md).

## <a name="enable-replication-for-a-vm"></a>Включение репликации для виртуальных машин

В разделах ниже описано, как включить репликацию.

### <a name="select-the-source"></a>Выбор источника

При настройке репликации сначала выберите источник, в котором работают виртуальные машины Azure.

1. Перейдите в раздел **Хранилища служб восстановления**, выберите имя хранилища, а затем щелкните **+ Реплицировать**.
1. В поле **Источник** выберите пункт **Azure**.
1. В поле **Исходное расположение** выберите исходный регион Azure, в котором сейчас запущены виртуальные машины.
1. Выберите **исходную подписку**, в которой работают виртуальные машины. Это может быть любая подписка в одном клиенте Azure Active Directory, где существует хранилище служб восстановления.
1. Щелкните **Исходная группа ресурсов** и нажмите кнопку **ОК**, чтобы сохранить настройки.

   ![Настройка источника](./media/azure-to-azure-tutorial-enable-replication/source.png)

### <a name="select-the-vms"></a>Выбор виртуальных машин

Site Recovery получает список виртуальных машин, связанных с подпиской и группой ресурсов или облачной службой.

1. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.
1. Щелкните **ОК**.

### <a name="configure-replication-settings"></a>Настройка параметров репликации

Site Recovery создает параметры по умолчанию и политику репликации для целевого региона. Эти параметры можно изменить при необходимости.

1. Чтобы просмотреть целевой объект и параметры репликации, щелкните **Параметры**.

1. Чтобы переопределить параметры по умолчанию для целевых объектов, щелкните ссылку **Настроить** рядом с заголовком **Группа ресурсов, сеть, хранилище и доступность**.

   ![Настройка параметров](./media/azure-to-azure-tutorial-enable-replication/settings.png)

1. Настройте целевые параметры, как описано в таблице.

   | **Параметр** | **Сведения** |
   | --- | --- |
   | **Целевая подписка** | По умолчанию целевая подписка совпадает с исходной подпиской. Щелкните ссылку **Настроить**, чтобы выбрать другую целевую подписку в том же клиенте Azure Active Directory. |
   | **Целевое расположение** | Целевой регион, используемый для аварийного восстановления.<br/><br/> Мы рекомендуем, чтобы целевое расположение соответствовало расположению хранилища Site Recovery. |
   | **Целевая группа ресурсов** | Группа ресурсов в целевом регионе, в которую входят виртуальные машины Azure после отработки отказа.<br/><br/> По умолчанию Site Recovery создает группу ресурсов в целевом регионе с суффиксом `asr`. Целевая группа ресурсов может располагаться в любом регионе кроме того, в котором размещены ваши исходные виртуальные машины. |
   | **Целевая виртуальная сеть** | Сеть в целевом регионе, в которой размещаются виртуальные машины Azure после отработки отказа.<br/><br/> По умолчанию Site Recovery создает виртуальную сеть (и подсети) в целевом регионе с суффиксом `asr`. |
   | **Учетная запись хранения** | Site Recovery использует учетную запись хранения в исходном регионе. Изменения в исходных виртуальных машинах отправляются в эту учетную запись перед репликацией в целевое расположение.<br/><br/> Если в учетной записи хранения кэша включен брандмауэр, убедитесь, что вы задали параметр **Разрешить доверенные службы Майкрософт**. [Подробнее](../storage/common/storage-network-security.md#exceptions). Кроме того, убедитесь, что разрешен доступ по меньшей мере к одной подсети исходной виртуальной сети. |
   | **Целевые учетные записи хранения (исходная виртуальная машина использует неуправляемые диски)** | Site Recovery по умолчанию создает новую учетную запись хранения в целевом регионе, которая отражает учетную запись хранения исходной виртуальной машины.<br/><br/> Включите **Разрешить доверенные службы Майкрософт**, если в учетной записи хранения кэша включен брандмауэр. |
   | **Управляемые диски реплики (если исходная виртуальная машина использует управляемые диски)** | Site Recovery по умолчанию создает управляемые диски реплики в целевом регионе, которые соответствуют управляемым дискам исходной виртуальной машины с тем же типом хранилища (категории "Стандартный" или "Премиум"), что и на управляемом диске исходной виртуальной машины. Вы можете настроить только тип диска. |
   | **Целевая группа доступности** | По умолчанию Azure Site Recovery создает в целевом регионе группу доступности, добавляя к ее имени суффикс `asr` для определения виртуальных машин, входящих в эту группу доступности. Если группа доступности, создаваемая Azure Site Recovery, уже существует, она будет использована повторно. |
   | **Целевые зоны доступности** | По умолчанию Site Recovery назначает в целевом регионе тот же номер зоны, что и в исходном регионе, если целевой регион поддерживает зоны доступности.<br/><br/> Если целевой регион не поддерживает зоны доступности, целевые виртуальные машины настраиваются как отдельные экземпляры по умолчанию.<br/><br/> Щелкните **Настроить**, чтобы настроить виртуальные машины как часть группы доступности в целевом регионе.<br/><br/> После включения репликации нельзя изменить тип доступности (один экземпляр, группу доступности или зону доступности). Чтобы изменить тип доступности, необходимо отключить и повторно включить репликацию. |

1. Чтобы настроить параметры политики репликации, щелкните ссылку **Настроить** рядом с полем **Политика репликации** и измените необходимые параметры.

   | **Параметр** | **Сведения** |
   | --- | --- |
   | **Имя политики репликации** | Имя политики. |
   | **Хранение точки восстановления** | По умолчанию Site Recovery хранит точки восстановления 24 часа. Вы можете задать значение от 1 до 72 часов. |
   | **Периодичность создания моментальных снимков с согласованием приложений** | По умолчанию Site Recovery выполняет моментальные снимки с согласованием приложений каждые 4 часа. Вы можете задать значение от 1 до 12 часов.<br/><br/> Моментальный снимок с согласованием приложений представляет собой созданный на определенный момент времени снимок данных приложения в виртуальной машине. Служба теневого копирования томов (VSS) обеспечивает согласованное состояние приложения в виртуальной машине при создании моментального снимка. |
   | **Группа репликации** | Если приложению требуется согласованность между несколькими виртуальными машинами, вы можете создать для них группу репликации. По умолчанию выбранные виртуальные машины не входят ни в одну группу репликации. |

1. Для параметра **Настроить** выберите **Да** для согласованности нескольких виртуальных машин, если вы хотите добавить виртуальные машины в новую или существующую группу репликации. Нажмите кнопку **ОК**.

   > [!NOTE]
   > - На всех компьютерах в группе репликации имеются общие отказоустойчивые и согласованные точки восстановления после отработки отказа.
   > - Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки (приведет к высокой загрузке ЦП). Поэтому ее необходимо использовать, только если компьютеры выполняют одну и ту же рабочую нагрузку и должны действовать согласованно несколько компьютеров.
   > - В группе репликации не может быть более 16 виртуальных машин.
   > - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Убедитесь в том, что брандмауэр не блокирует внутренний обмен данными между виртуальными машинами через этот порт.
   > - Для виртуальных машин Linux в группе репликации убедитесь в том, что исходящий через порт 20004 трафик открыт вручную согласно указаниям для конкретной версии Linux.

### <a name="configure-encryption-settings"></a>Настройка параметров шифрования

Если на исходной виртуальной машине включено шифрование диска Azure (ADE), проверьте параметры.

1. Проверьте параметры:
   1. **Хранилища ключей для шифрования дисков**. По умолчанию Site Recovery создает хранилище ключей на исходных ключах шифрования диска виртуальной машины с суффиксом `asr`. Если хранилище ключей уже существует, оно используется повторно.
   1. **Хранилища ключей для шифрования ключей**. По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. В имени используется суффикс `asr`, и оно основано на ключах шифрования исходной виртуальной машины. Если хранилище ключей, создаваемое Site Recovery, уже существует, оно будет использоваться повторно.
1. Щелкните **Настроить**, чтобы выбрать пользовательские хранилища ключей.

>[!NOTE]
> Сейчас Site Recovery поддерживает ADE с и без Azure Active Directory (AAD) для виртуальных машин под управлением операционных систем Windows. Для операционных систем Linux поддерживается только ADE без AAD. Кроме того, виртуальные машины, на которых выполняется ADE 1.1 (без AAD), должны использовать управляемые диски. Виртуальные машины с неуправляемыми дисками не поддерживаются. При переходе с ADE 0.1 (с AAD) на ADE 1.1 нужно отключить репликацию и включить репликацию для виртуальной машины после включения ADE 1.1.

### <a name="track-replication-status"></a>Отслеживание состояния репликации

После включения репликации можно отслеживать состояние задания.

1. В разделе **Параметры** выберите **Обновить**, чтобы узнать актуальное состояние.
1. Отслеживайте ход выполнения и состояние следующим образом:
   1. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**.
   1. Выберите **Параметры** > **Реплицированные элементы**, чтобы просмотреть состояние виртуальных машин и ход выполнения начальной репликации. Выберите виртуальную машину, чтобы просмотреть ее параметры.

## <a name="next-steps"></a>Дальнейшие действия

В рамках этого руководства вы настроили аварийное восстановление для виртуальной машины Azure. Теперь вы можете выполнить аварийное восстановление, чтобы убедиться, что отработка отказа работает правильно.

> [!div class="nextstepaction"]
> [Выполнение отработки аварийного восстановления](azure-to-azure-tutorial-dr-drill.md)
