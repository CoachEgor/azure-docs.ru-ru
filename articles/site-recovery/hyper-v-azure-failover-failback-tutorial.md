---
title: Отработка отказа и восстановление размещения виртуальных машин Hyper-V при их аварийном восстановлении в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Узнайте, как выполнить отработку отказа и восстановление размещения виртуальных машин Hyper-V при их аварийном восстановлении в Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 05/30/2019
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: a4889d82ac1c837581771860f2aba86faf7650ee
ms.sourcegitcommit: d89032fee8571a683d6584ea87997519f6b5abeb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/30/2019
ms.locfileid: "66399438"
---
# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-azure"></a>Отработка отказа и восстановление размещения виртуальных машин Hyper-V, реплицированных в Azure

В этом руководстве содержатся сведения об отработке отказа виртуальных машин Hyper-V в Azure. Восстановление размещения на локальном сайте после отработки отказа происходит в тех ситуациях, когда это возможно. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Проверка соответствия свойств виртуальной машины Hyper-V требованиям Azure
> * Отработка отказа в Azure
> * Восстановление размещения из Azure в локальную среду
> * Включение обратной репликации локальных виртуальных машин для запуска повторной репликации в Azure

Это пятое руководство в серии. В нем предполагается, что вы уже выполнили задачи из предыдущих руководств.    

1. [Подготовка Azure](tutorial-prepare-azure.md).
2. [Подготовка локальных серверов Hyper-V](tutorial-prepare-on-premises-hyper-v.md)
3. Настройка аварийного восстановления [виртуальных машин Hyper-V](tutorial-hyper-v-to-azure.md) или [виртуальных машин Hyper-V, управляемых в облаках VMM System Center](tutorial-hyper-v-vmm-to-azure.md).
4. [Run a disaster recovery drill to Azure](tutorial-dr-drill-azure.md) (Выполнение отработки аварийного восстановления в Azure)

## <a name="prepare-for-failover-and-failback"></a>Подготовка к отработке отказа и восстановлению размещения

Убедитесь, что на виртуальной машине нет моментальных снимков и что при восстановлении размещения локальная виртуальная машина отключена. Так вы обеспечите согласованность данных во время репликации. Не включайте локальную виртуальную машину при восстановлении размещения. 

Отработка отказа и восстановление размещения происходит в три этапа:

1. **Отработка отказа в Azure**. Отработка отказа с переносом виртуальных машин Hyper-V из локального расположения в Azure.
2. **Отработка отказа в локальном расположении.** Отработка отказа виртуальных машин Azure в локальном расположении, если оно доступно. Запускается синхронизация данных из Azure с локальным сайтом, а после синхронизации виртуальные машины переносятся в локальное расположение.  
3. **Обратная репликация локальных виртуальных машин.** После переноса в локальное расположение включите обратную репликацию локальных виртуальных машин, чтобы начать их репликацию в Azure.

## <a name="verify-vm-properties"></a>Проверка свойств виртуальной машины

Перед отработкой отказа проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](hyper-v-azure-support-matrix.md#replicated-vms).

В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.

1. В области **Реплицированный элемент** находятся сводные данные о виртуальной машине, включая состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.

1. В области **Вычисления и сеть** можно изменить имя Azure, группу ресурсов, целевой размер, [группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) и параметры управляемого диска.

1. Можно просмотреть или изменить параметры сети, включая сеть (или подсеть), в которой будет размещаться виртуальная машина Azure после отработки отказа, и IP-адрес, который будет ей назначен.

1. В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.

## <a name="failover-to-azure"></a>Отработка отказа в Azure

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **последнюю** точку восстановления. 
3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается завершить работу исходных виртуальных машин перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.
4. После проверки **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> **Не отменяйте отработку отказа в процессе выполнения.** Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.

## <a name="failback-azure-vm-to-on-premises-and-reverse-replicate-the-on-premises-vm"></a>Восстановление размещения виртуальной машины Azure на локальный сайт и обратная репликация локальной виртуальной машины

По сути, восстановление размещения — это отработка отказа из Azure на локальный сайт. А обратная репликация — это повторная репликация виртуальных машин с локального сайта в Azure.

1. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Плановая отработка отказа**.
2. В разделе **Подтвердить плановую отработку отказа** проверьте направление отработки отказа (из Azure) и выберите исходное и целевое расположение.
3. Выберите **Синхронизация данных до отработки отказа (синхронизация только изменений)** . Этот параметр сокращает время простоя виртуальной машины, так как синхронизация выполняется без выключения виртуальной машины.
4. Запустите отработку отказа. На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
5. Когда вы будете готовы завершить работу виртуальных машин Azure после изначальной синхронизации данных, выберите **Задания**, имя задания плановой отработки отказа и **Завершение отработки отказа**. Эта команда завершит работу виртуальной машины Azure, передаст последние изменения в локальную среду и запустит локальную виртуальную машину.
6. Войдите в локальную виртуальную машину, чтобы проверить, доступна ли она, как и ожидалось.
7. Теперь локальная виртуальная машина находится в состоянии **ожидания фиксации**. Нажмите кнопку **Зафиксировать**. Эта команда удаляет виртуальные машины Azure и их диски, а также подготавливает локальную виртуальную машину к обратной репликации.
Чтобы запустить репликацию локальной виртуальной машины в Azure, включите **обратную репликацию**. Это активирует репликацию изменений, произошедших с момента выключения виртуальной машины Azure.  
