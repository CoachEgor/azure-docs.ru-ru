---
title: Репликация виртуальных машин Azure, работающих Локальные дисковые пространства, с Azure Site Recovery
description: Узнайте, как реплицировать виртуальные машины Azure, на которых выполняется Локальные дисковые пространства, с помощью Azure Site Recovery.
author: sideeksh
manager: rochakm
ms.topic: how-to
ms.date: 01/29/2019
ms.openlocfilehash: 9f394fa8d618c97d74a47ff6e42a002f177cf7d9
ms.sourcegitcommit: 3dc1a23a7570552f0d1cc2ffdfb915ea871e257c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/15/2020
ms.locfileid: "75973665"
---
# <a name="replicate-azure-vms-running-storage-spaces-direct-to-another-region"></a>Репликация виртуальных машин Azure, работающих Локальные дисковые пространства, в другой регион

В этой статье описывается, как включить аварийное восстановление виртуальных машин Azure, на которых используются локальные дисковые пространства.

>[!NOTE]
>Для кластеров локальных дисковых пространств поддерживаются только отказоустойчивые точки восстановления.
>

[Локальные дисковые пространства (S2D)](https://docs.microsoft.com/windows-server/storage/storage-spaces/deploy-storage-spaces-direct) — это программно-определяемое хранилище, которое предоставляет способ создания [гостевых кластеров](https://blogs.msdn.microsoft.com/clustering/2017/02/14/deploying-an-iaas-vm-guest-clusters-in-microsoft-azure) в Azure.  Гостевой кластер в Microsoft Azure — это отказоустойчивый кластер, состоящий из виртуальных машин IaaS. Она позволяет рабочим нагрузкам размещенных виртуальных машин выполнять отработку отказа в гостевых кластерах, обеспечивая высокий уровень доступности для приложений, чем одна виртуальная машина Azure. Это полезно в сценариях, где виртуальная машина содержит критическое приложение, например SQL или Масштабируемый файловый сервер.

## <a name="disaster-recovery-with-storage-spaces-direct"></a>Аварийное восстановление с помощью локальных дисковых пространств

В типичном сценарии у вас может быть гостевой кластер виртуальных машин в Azure для более высокой отказоустойчивости вашего приложения, например масштабируемый файловый сервер. Хотя это может обеспечить более высокую доступность вашего приложения, вы хотите защитить эти приложения с помощью Site Recovery от любых сбоев на региональном уровне. Site Recovery реплицирует данные из одного региона в другой регион Azure и вызывает кластер в регионе аварийного восстановления в случае сбоя.

На схеме ниже показан отказоустойчивый кластер с двумя узлами для виртуальной машины Azure с использованием локальных дисковых пространств.

![storagespacesdirect](./media/azure-to-azure-how-to-enable-replication-s2d-vms/storagespacedirect.png)


- Две виртуальные машины Azure в отказоустойчивом кластере Windows и каждая виртуальная машина имеют два или более дисков с данными.
- S2D синхронизирует данные на диске данных и представляет синхронизированное хранилище в качестве пула носителей.
- Пул носителей представляет общий том кластера (CSV) для отказоустойчивого кластера.
- Отказоустойчивый кластер использует CSV для дисков данных.

**Рекомендации по аварийному восстановлению**

1. При настройке [облака-свидетеля](https://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness#CloudWitnessSetUp) для кластера сохраните свидетеля в регионе аварийного восстановления.
2. Если вы собираетесь выполнить отработку отказа виртуальных машин в подсети в регионе аварийного восстановления, которая отличается от исходного региона, то IP-адрес кластера необходимо изменить после отработки отказа.  Чтобы изменить IP-адрес кластера, необходимо использовать [сценарий плана восстановления Site Recovery.](https://docs.microsoft.com/azure/site-recovery/site-recovery-runbook-automation)</br>
[Пример сценария](https://github.com/krnese/azure-quickstart-templates/blob/master/asr-automation-recovery/scripts/ASR-Wordpress-ChangeMysqlConfig.ps1) для выполнения команды внутри виртуальной машины с помощью расширения пользовательских сценариев 

### <a name="enabling-site-recovery-for-s2d-cluster"></a>Включение Site Recovery для кластера локальных дисковых пространств

1. В хранилище служб восстановления щелкните "+replicate" (+Репликация).
1. Выберите все узлы в кластере и сделайте их частью [группы согласованности нескольких виртуальных машин](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-common-questions#multi-vm-consistency).
1. Выберите политику репликации с отключенной согласованностью приложения (доступна только поддержка согласованности при сбое).
1. Включите репликацию.

   ![Защита storagespacesdirect](./media/azure-to-azure-how-to-enable-replication-s2d-vms/multivmgroup.png)

2. Перейдите к реплицированным элементам и вы увидите состояние виртуальной машины.
3. Обе виртуальные машины становятся защищенными и также отображаются как часть группы согласованности нескольких виртуальных машин.

   ![Защита storagespacesdirect](./media/azure-to-azure-how-to-enable-replication-s2d-vms/storagespacesdirectgroup.PNG)

## <a name="creating-a-recovery-plan"></a>Создание плана восстановления
План восстановления позволяет воссоздать последовательность различных уровней в многоуровневом приложении во время отработки отказа. Благодаря этому обеспечивается целостность на уровне приложения. При создании плана восстановления для многоуровневого веб-приложения выполните действия, описанные в [этой статье](site-recovery-create-recovery-plans.md).

### <a name="adding-virtual-machines-to-failover-groups"></a>Добавление виртуальных машин в группы отработки отказа

1.  Создайте план восстановления, добавив виртуальные машины.
2.  Щелкните "Настроить", чтобы сгруппировать виртуальные машины. По умолчанию все виртуальные машины входят в группу 1.


### <a name="add-scripts-to-the-recovery-plan"></a>Добавление сценариев в план восстановления
Чтобы настроить правильную работу приложений, вам может потребоваться выполнить некоторые операции после отработки отказа виртуальных машин Azure или во время тестовой отработки отказа. Вы можете настроить автоматическое выполнение некоторых операций после отработки отказа. Например, здесь мы подключим подсистему балансировки нагрузки и изменяющиме IP-адрес кластера.


### <a name="failover-of-the-virtual-machines"></a>Отработка отказа виртуальных машин 
Необходимо выполнить отработку отказа для узлов виртуальных машин с помощью [плана восстановления](https://docs.microsoft.com/azure/site-recovery/site-recovery-create-recovery-plans) Site Recovery 

![Защита storagespacesdirect](./media/azure-to-azure-how-to-enable-replication-s2d-vms/recoveryplan.PNG)

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
1.  На портале Azure выберите хранилище служб восстановления.
2.  Выберите созданный план восстановления.
3.  Выберите **Тестовая отработка отказа**.
4.  Чтобы запустить тестовую отработку отказа, выберите точку восстановления и виртуальную сеть Azure.
5.  После запуска вторичной среды можно выполнить проверку.
6.  После завершения проверки выберите **Очистить тестовую отработку отказа**, чтобы очистить среду отработки отказа.

Дополнительные сведения см. в статье [Тестовая отработка отказа в Azure с помощью Site Recovery](site-recovery-test-failover-to-azure.md).

## <a name="run-a-failover"></a>Запуск отработки отказа

1.  На портале Azure выберите хранилище служб восстановления.
2.  Выберите план восстановления, созданный для приложений SAP.
3.  Выберите **Отработка отказа**.
4.  Чтобы запустить отработку отказа, выберите точку восстановления.

Дополнительные сведения см. в статье [Отработка отказа в Site Recovery](site-recovery-failover.md).
## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о выполнении отработки отказа см. [здесь](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-tutorial-failover-failback).
