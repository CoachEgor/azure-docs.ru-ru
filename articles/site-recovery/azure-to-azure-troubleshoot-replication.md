---
title: Устранение текущих проблем с репликацией из Azure в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Устранение проблем и ошибок при репликации виртуальных машин Azure для аварийного восстановления.
services: site-recovery
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: troubleshooting
ms.date: 11/27/2018
ms.author: asgang
ms.openlocfilehash: 9ff756270c368d39b7ef78d7c1046f7c91169668
ms.sourcegitcommit: 61c8de2e95011c094af18fdf679d5efe5069197b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62103752"
---
# <a name="troubleshoot-ongoing-problems-in-azure-to-azure-vm-replication"></a>Устранение текущих проблем с репликацией виртуальных машин из Azure в Azure

В этой статье рассматриваются распространенные проблемы с Azure Site Recovery, возникающие при репликации и восстановлении виртуальных машин Azure из одного региона в другой. Кроме того, в этой статье объясняется, как их устранять. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

Azure Site Recovery постоянно реплицирует данные из исходного региона в регион аварийного восстановления и создает отказоустойчивые точки восстановления каждые 5 минут. Если службе Site Recovery не удается создать точки восстановления в течение 60 минут, она уведомляет об этом:

Сообщение об ошибке: "No crash consistent recovery point available for the VM in the last 60 minutes" (Для виртуальной машины нет соответствующей точки восстановления за последние 60 минут).</br>
Идентификатор ошибки: 153007 </br>

В следующих разделах описаны причины и способы устранения неполадок.

## <a name="high-data-change-rate-on-the-source-virtal-machine"></a>Высокая частота изменения данных на исходной виртуальной машине
Azure Site Recovery запускает событие, если скорость изменения данных на исходной виртуальной машине превышает поддерживаемые ограничения. Чтобы проверить, связана ли проблема с высокой частотой обновления данных, выберите **Реплицированные элементы** > **Виртуальная машина** > **События. Последние 72 часа**.
Отобразится событие "Скорость изменения данных превышает поддерживаемые пределы".

![data_change_rate_high](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event.png)

Если выбрать это событие, вы увидите точные сведения о диске.

![data_change_rate_event](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event2.png)


### <a name="azure-site-recovery-limits"></a>Ограничения Azure Site Recovery
В таблице ниже приведены ограничения Azure Site Recovery. Эти ограничения получены на основе наших проверок, но они не охватывают все возможные сочетания операций ввода-вывода в приложении. Фактические результаты зависят от сочетания операций ввода-вывода приложения. 

Следует учесть два ограничения: частоту обновления данных на диск и частоту обновления данных на виртуальную машину. Например, рассмотрим диск P20 (цен. категория "Премиум") в таблице ниже. Site Recovery может обрабатывать до 5 МБ/с обновляемых данных на диск, а одна виртуальная машина может содержать до пяти таких дисков из-за общего ограничения в 25 МБ/с обновляемых данных на виртуальную машину.

**Целевое хранилище репликации** | **Среднее число операций ввода-вывода для исходного диска** |**Средняя частота обновления данных для исходного диска** | **Общая частота обновления данных в день для исходного диска данных**
---|---|---|---
Хранилище уровня "Стандартный" | 8 КБ | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 8 КБ  | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 16 КБ | 4 МБ/с |  336 ГБ на диск
Диск P10 или P15 класса Premium | 32 КБ или выше | 8 МБ/с | 672 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 8 КБ    | 5 МБ/с | 421 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 16 КБ или выше |10 МБ/с | 842 ГБ на диск

### <a name="solution"></a>Решение
В Azure Site Recovery действуют ограничения частоты изменения данных, зависящие от типа диска. Чтобы узнать, является ли эта проблема повторяющейся или кратковременной, нужно определить частоту изменения данных затронутой виртуальной машины. Выберите исходную виртуальную машину, найдите метрики в разделе **Мониторинг** и добавьте метрики, как показано на снимке экрана ниже.

![Три шага для нахождения частоты изменения данных](./media/site-recovery-azure-to-azure-troubleshoot/churn.png)

1. Выберите **Добавить метрику**, а затем добавьте **Скорость записи на диск ОС (байт/с)** и **Скорость записи на диск данных (байт/с)**.
2. Отслеживайте пики, как показано на снимке экрана.
3. Просмотрите общее количество операций записи на дисках ОС и на всех дисках данных. Эти метрики могут не содержать сведения на уровне отдельных дисков, но они указывают общий шаблон частоты обновления данных.

Если же всплеск частоты — это эпизодический случай, и частота изменения данных только на некоторое время превышает 10 Мбит/с (для ценовой категории "Премиум") и 2 Мбит/с (для ценовой категории "Стандартный"), то репликация завершится вовремя. Однако, если частота обновления сильно превышает поддерживаемое ограничение большую часть времени, то следует рассмотреть один из следующих возможных вариантов:

* **Исключите диск, вызывающий высокую частоту изменения данных**. Вы можете исключить диск с помощью [PowerShell](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-powershell#replicate-azure-virtual-machine).
* **Измените уровень диска хранилища аварийного восстановления**. Этот вариант возможен, только если частота обновления данных диска менее 10 МБ/с. Допустим, на виртуальной машине с диском P10 частота обновления данных составляет от 8 до 10 МБ/с. Если клиент может использовать диск P30 для целевого хранилища во время защиты, эту проблему можно устранить.

## <a name="Network-connectivity-problem"></a>Проблемы с сетью

### <a name="network-latency-to-a-cache-storage-account"></a>Задержка в сети при обращении к учетной записи хранения кэша
Site Recovery отправляет реплицированные данные в учетную запись хранения кэша. Может наблюдаться задержки в сети, если передача данных из виртуальной машины в учетную запись хранения кэша выполняется медленнее, чем 4 МБ за 3 секунды. 

Чтобы проверить наличие проблемы с задержкой, с помощью [azcopy](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy) передайте данные из виртуальной машины в учетную запись хранения кэша. Если задержка большая, проверьте, используются ли сетевые виртуальные модули (NVA) для управления исходящим сетевым трафиком виртуальных машин. Если весь трафик репликации проходит через сетевой виртуальный модуль, к модулю может применяться регулирование. 

Мы рекомендуем создать конечную точку службы сети в виртуальной сети для хранилища, чтобы трафик репликации не передавался в виртуальный сетевой модуль. Дополнительные сведения можно найти в разделе [Настройка виртуального сетевого модуля](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#network-virtual-appliance-configuration).

### <a name="network-connectivity"></a>Сетевое подключение
Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина защищена брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, может возникнуть одна из описанных проблем. Сведения о том, как убедиться, что все URL-адреса подключены, см. в разделе [Исходящие подключения для диапазонов IP-адресов](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#outbound-connectivity-for-ip-address-ranges). 