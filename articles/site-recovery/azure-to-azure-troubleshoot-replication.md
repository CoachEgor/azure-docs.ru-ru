---
title: Устранение неполадок репликации виртуальных машин Azure с помощью Azure Site Recovery
description: Устранение неполадок репликации в аварийном восстановлении виртуальной машины Azure с помощью Azure Site Recovery
author: sideeksh
manager: rochakm
ms.topic: troubleshooting
ms.date: 8/2/2019
ms.openlocfilehash: b8afdd0f2dd98260a628116fa7402e05cd39e06b
ms.sourcegitcommit: 3dc1a23a7570552f0d1cc2ffdfb915ea871e257c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/15/2020
ms.locfileid: "75965855"
---
# <a name="troubleshoot-replication-in-azure-vm-disaster-recovery"></a>Устранение неполадок репликации в аварийном восстановлении виртуальной машины Azure

В этой статье рассматриваются распространенные проблемы с Azure Site Recovery, возникающие при репликации и восстановлении виртуальных машин Azure из одного региона в другой. Кроме того, в этой статье объясняется, как их устранять. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

Azure Site Recovery постоянно реплицирует данные из исходного региона в регион аварийного восстановления и создает отказоустойчивые точки восстановления каждые 5 минут. Если службе Site Recovery не удается создать точки восстановления в течение 60 минут, она уведомляет об этом:

Сообщение об ошибке: "нет доступной отказоустойчивой точки восстановления для виртуальной машины за последние 60 минут".</br>
Идентификатор ошибки: 153007 </br>

В следующих разделах описаны причины и способы устранения неполадок.

## <a name="high-data-change-rate-on-the-source-virtal-machine"></a>Высокая частота изменения данных на исходной виртуальной машине
Azure Site Recovery запускает событие, если скорость изменения данных на исходной виртуальной машине превышает поддерживаемые ограничения. Чтобы проверить, связана ли проблема с высокой частотой обновления данных, выберите **Реплицированные элементы** > **Виртуальная машина** > **События. Последние 72 часа**.
Отобразится событие "Скорость изменения данных превышает поддерживаемые пределы".

![data_change_rate_high](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event.png)

Если выбрать это событие, вы увидите точные сведения о диске.

![data_change_rate_event](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event2.png)


### <a name="azure-site-recovery-limits"></a>Ограничения Azure Site Recovery
В таблице ниже приведены ограничения Azure Site Recovery. Эти ограничения получены на основе наших проверок, но они не охватывают все возможные сочетания операций ввода-вывода в приложении. Фактические результаты зависят от сочетания операций ввода-вывода приложения.

Следует учесть два ограничения: частоту обновления данных на диск и частоту обновления данных на виртуальную машину. Например, рассмотрим диск P20 (цен. категория "Премиум") в таблице ниже. Site Recovery может обрабатывать до 5 МБ/с обновляемых данных на диск, а одна виртуальная машина может содержать до пяти таких дисков из-за общего ограничения в 25 МБ/с обновляемых данных на виртуальную машину.

**Целевое хранилище репликации** | **Среднее число операций ввода-вывода для исходного диска** |**Средняя частота обновления данных для исходного диска** | **Общая частота обновления данных в день для исходного диска данных**
---|---|---|---
Хранилище уровня "Стандартный" | 8 КБ | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 8 КБ  | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 16 КБ | 4 МБ/с |  336 ГБ на диск
Диск P10 или P15 класса Premium | 32 КБ или выше | 8 МБ/с | 672 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 8 КБ    | 5 МБ/с | 421 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 16 КБ или выше |10 МБ/с | 842 ГБ на диск

### <a name="solution"></a>Решение
В Azure Site Recovery действуют ограничения частоты изменения данных, зависящие от типа диска. Чтобы узнать, является ли эта проблема повторяющейся или кратковременной, нужно определить частоту изменения данных затронутой виртуальной машины. Выберите исходную виртуальную машину, найдите метрики в разделе **Мониторинг** и добавьте метрики, как показано на снимке экрана ниже.

![Три шага для нахождения частоты изменения данных](./media/site-recovery-azure-to-azure-troubleshoot/churn.png)

1. Выберите **Добавить метрику**, а затем добавьте **Скорость записи на диск ОС (байт/с)** и **Скорость записи на диск данных (байт/с)** .
2. Отслеживайте пики, как показано на снимке экрана.
3. Просмотрите общее количество операций записи на дисках ОС и на всех дисках данных. Эти метрики могут не содержать сведения на уровне отдельных дисков, но они указывают общий шаблон частоты обновления данных.

Если же всплеск частоты — это эпизодический случай, и частота изменения данных только на некоторое время превышает 10 Мбит/с (для ценовой категории "Премиум") и 2 Мбит/с (для ценовой категории "Стандартный"), то репликация завершится вовремя. Однако, если частота обновления сильно превышает поддерживаемое ограничение большую часть времени, то следует рассмотреть один из следующих возможных вариантов:

* **Исключите диск, который приводит к высокой частоте изменения данных**. Вы можете исключить диск с помощью [PowerShell](./azure-to-azure-exclude-disks.md). Чтобы исключить диск, сначала необходимо отключить репликацию.
* **Изменение уровня диска хранилища аварийного восстановления**. Этот вариант возможен только в том случае, если объем данных диска не ПРЕВЫШАЕТ 20 МБ/с. Допустим, на виртуальной машине с диском P10 частота обновления данных составляет от 8 до 10 МБ/с. Если клиент может использовать диск P30 для целевого хранилища во время защиты, эту проблему можно устранить. Обратите внимание, что это решение возможно только для компьютеров, использующих управляемые диски уровня "Премиум". Сделайте следующее:
    - Перейдите в колонку диски затронутой реплицированной машины и скопируйте имя диска реплики.
    - Перейдите к этому управляемому диску реплики
    - В колонке "Обзор" может появиться баннер с сообщением о том, что URL-адрес SAS создан. Щелкните этот баннер и отмените экспорт. Пропустите этот шаг, если баннер не отображается.
    - Как только URL-адрес SAS будет отозван, перейдите в колонку конфигурация управляемого диска и увеличьте размер, чтобы Site Recovery поддерживала отслеживаемую частоту обновлений на исходном диске.

## <a name="Network-connectivity-problem"></a>Проблемы с сетью

### <a name="network-latency-to-a-cache-storage-account"></a>Задержка в сети при обращении к учетной записи хранения кэша
Site Recovery отправляет реплицированные данные в учетную запись хранения кэша. Может наблюдаться задержки в сети, если передача данных из виртуальной машины в учетную запись хранения кэша выполняется медленнее, чем 4 МБ за 3 секунды.

Чтобы проверить наличие проблемы с задержкой, с помощью [azcopy](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy) передайте данные из виртуальной машины в учетную запись хранения кэша. Если задержка большая, проверьте, используются ли сетевые виртуальные модули (NVA) для управления исходящим сетевым трафиком виртуальных машин. Если весь трафик репликации проходит через сетевой виртуальный модуль, к модулю может применяться регулирование.

Мы рекомендуем создать конечную точку службы сети в виртуальной сети для хранилища, чтобы трафик репликации не передавался в виртуальный сетевой модуль. Дополнительные сведения можно найти в разделе [Настройка виртуального сетевого модуля](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#network-virtual-appliance-configuration).

### <a name="network-connectivity"></a>Сетевое подключение
Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина защищена брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, может возникнуть одна из описанных проблем. Сведения о том, как убедиться, что все URL-адреса подключены, см. в разделе [Исходящие подключения для диапазонов IP-адресов](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#outbound-connectivity-for-ip-address-ranges).

## <a name="error-id-153006---no-app-consistent-recovery-point-available-for-the-vm-in-the-last-xxx-minutes"></a>Идентификатор ошибки 153006-нет доступной для виртуальной машины точки восстановления с постоянными приложениями за последние "XXX" мин.

Ниже перечислены некоторые из наиболее распространенных проблем.

#### <a name="cause-1-known-issue-in-sql-server-20082008-r2"></a>Причина 1. известная неполадка в SQL Server 2008/2008 R2
**Как исправить** : существует известная проблема с SQL Server 2008/2008 R2. Ознакомьтесь с этой статьей [в базе знаний Azure Site Recovery агент или другая некомпонентная резервная копия VSS для сервера, на котором размещена SQL Server 2008 R2](https://support.microsoft.com/help/4504103/non-component-vss-backup-fails-for-server-hosting-sql-server-2008-r2)

#### <a name="cause-2-azure-site-recovery-jobs-fail-on-servers-hosting-any-version-of-sql-server-instances-with-auto_close-dbs"></a>Причина 2. сбой заданий Azure Site Recovery на серверах, где размещается любая версия SQL Server экземпляров с AUTO_CLOSE баз данных
**Как исправить** : см. [статью](https://support.microsoft.com/help/4504104/non-component-vss-backups-such-as-azure-site-recovery-jobs-fail-on-ser) в базе знаний


#### <a name="cause-3-known-issue-in-sql-server-2016-and-2017"></a>Причина 3. известная неполадка в SQL Server 2016 и 2017
**Как исправить** : см. [статью](https://support.microsoft.com/help/4493364/fix-error-occurs-when-you-back-up-a-virtual-machine-with-non-component) в базе знаний

#### <a name="cause-4-you-are-using-storage-spaces-direct-configuration"></a>Причина 4. используется конфигурация локальных дисковых пространств
**Как исправить** : Azure Site Recovery не удается создать точку восстановления с единообразным применением для конфигурации локальных дисковых пространств. Чтобы правильно [настроить политику репликации,](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-how-to-enable-replication-s2d-vms) обратитесь к статье.

### <a name="more-causes-due-to-vss-related-issues"></a>Другие причины из-за проблем, связанных с VSS:

Для дальнейшего устранения неполадок проверьте файлы на исходном компьютере, чтобы получить точный код ошибки для ошибки:

    C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\Application Data\ApplicationPolicyLogs\vacp.log

Как разместить ошибки в файле?
Выполните поиск строки "Вакперрор", открыв файл vacp. log в редакторе.

    Ex: vacpError:220#Following disks are in FilteringStopped state [\\.\PHYSICALDRIVE1=5, ]#220|^|224#FAILED: CheckWriterStatus().#2147754994|^|226#FAILED to revoke tags.FAILED: CheckWriterStatus().#2147754994|^|

В приведенном выше примере **2147754994** — это код ошибки, который сообщает о сбое, как показано ниже.

#### <a name="vss-writer-is-not-installed---error-2147221164"></a>Модуль записи VSS не установлен — ошибка 2147221164

*Как исправить*: для создания тега согласованности приложений Azure Site Recovery использует службу теневого копирования ТОМОВ (VSS) Майкрософт. Он устанавливает поставщик VSS для работы, чтобы получить моментальные снимки согласованности приложений. Этот поставщик VSS устанавливается как служба. Если служба поставщика VSS не установлена, создание моментального снимка согласованности приложений завершается ошибкой с ИДЕНТИФИКАТОРом ошибки 0x80040154 "класс не зарегистрирован". </br>
См. [статью об устранении неполадок при установке модуля записи VSS](https://docs.microsoft.com/azure/site-recovery/vmware-azure-troubleshoot-push-install#vss-installation-failures) 

#### <a name="vss-writer-is-disabled---error-2147943458"></a>Модуль записи VSS отключен — ошибка 2147943458

**Как исправить**: для создания тега согласованности приложений Azure Site Recovery использует службу теневого копирования ТОМОВ (VSS) Майкрософт. Он устанавливает поставщик VSS для работы, чтобы получить моментальные снимки согласованности приложений. Этот поставщик VSS устанавливается как служба. Если служба поставщика VSS отключена, создание моментального снимка согласованности приложений завершается сбоем с ИДЕНТИФИКАТОРом ошибки "указанная служба отключена и не может быть запущена (0x80070422)". </br>

- Если служба VSS отключена,
    - Убедитесь, что для параметра Тип запуска службы поставщика VSS задано значение **автоматически**.
    - Перезапустите следующие службы:
        - Служба VSS
        - поставщик VSS Azure Site Recovery.
        - Служба VDS

####  <a name="vss-provider-not_registered---error-2147754756"></a>Поставщик VSS NOT_REGISTERED-ошибка 2147754756

**Как исправить**: для создания тега согласованности приложений Azure Site Recovery использует службу теневого копирования ТОМОВ (VSS) Майкрософт.
Проверьте, установлена ли служба поставщика Azure Site Recovery VSS. </br>

- Повторите установку поставщика с помощью следующих команд:
- Удаление существующего поставщика: C:\Program Files (x86) \Microsoft Azure site Рековери\ажент\ InMageVSSProvider_Uninstall. cmd
- REINSTALL: C:\Program Files (x86) \Microsoft Azure site Рековери\ажент\ InMageVSSProvider_Install. cmd

Убедитесь, что для параметра Тип запуска службы поставщика VSS задано значение **автоматически**.
    - Перезапустите следующие службы:
        - Служба VSS
        - поставщик VSS Azure Site Recovery.
        - Служба VDS
