---
title: Устранение текущих проблем с репликацией из Azure в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Устранение проблем и ошибок при репликации виртуальных машин Azure для аварийного восстановления.
services: site-recovery
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: troubleshooting
ms.date: 11/27/2018
ms.author: asgang
ms.openlocfilehash: bf24b2d1395e128dc73361670ea93ac938574146
ms.sourcegitcommit: 25a60179840b30706429c397991157f27de9e886
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/28/2019
ms.locfileid: "66258785"
---
# <a name="troubleshoot-ongoing-problems-in-azure-to-azure-vm-replication"></a>Устранение текущих проблем с репликацией виртуальных машин из Azure в Azure

В этой статье рассматриваются распространенные проблемы с Azure Site Recovery, возникающие при репликации и восстановлении виртуальных машин Azure из одного региона в другой. Кроме того, в этой статье объясняется, как их устранять. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

Azure Site Recovery постоянно реплицирует данные из исходного региона в регион аварийного восстановления и создает отказоустойчивые точки восстановления каждые 5 минут. Если службе Site Recovery не удается создать точки восстановления в течение 60 минут, она уведомляет об этом:

Сообщение об ошибке: "No crash consistent recovery point available for the VM in the last 60 minutes" (Для виртуальной машины нет соответствующей точки восстановления за последние 60 минут).</br>
Идентификатор ошибки: 153007 </br>

В следующих разделах описаны причины и способы устранения неполадок.

## <a name="high-data-change-rate-on-the-source-virtal-machine"></a>Высокая частота изменения данных на исходной виртуальной машине
Azure Site Recovery запускает событие, если скорость изменения данных на исходной виртуальной машине превышает поддерживаемые ограничения. Чтобы проверить, связана ли проблема с высокой частотой обновления данных, выберите **Реплицированные элементы** > **Виртуальная машина** > **События. Последние 72 часа**.
Отобразится событие "Скорость изменения данных превышает поддерживаемые пределы".

![data_change_rate_high](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event.png)

Если выбрать это событие, вы увидите точные сведения о диске.

![data_change_rate_event](./media/site-recovery-azure-to-azure-troubleshoot/data_change_event2.png)


### <a name="azure-site-recovery-limits"></a>Ограничения Azure Site Recovery
В таблице ниже приведены ограничения Azure Site Recovery. Эти ограничения получены на основе наших проверок, но они не охватывают все возможные сочетания операций ввода-вывода в приложении. Фактические результаты зависят от сочетания операций ввода-вывода приложения. 

Следует учесть два ограничения: частоту обновления данных на диск и частоту обновления данных на виртуальную машину. Например, рассмотрим диск P20 (цен. категория "Премиум") в таблице ниже. Site Recovery может обрабатывать до 5 МБ/с обновляемых данных на диск, а одна виртуальная машина может содержать до пяти таких дисков из-за общего ограничения в 25 МБ/с обновляемых данных на виртуальную машину.

**Целевое хранилище репликации** | **Среднее число операций ввода-вывода для исходного диска** |**Средняя частота обновления данных для исходного диска** | **Общая частота обновления данных в день для исходного диска данных**
---|---|---|---
Хранилище уровня "Стандартный" | 8 КБ | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 8 КБ  | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 16 КБ | 4 МБ/с |  336 ГБ на диск
Диск P10 или P15 класса Premium | 32 КБ или выше | 8 МБ/с | 672 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 8 КБ    | 5 МБ/с | 421 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 16 КБ или выше |10 МБ/с | 842 ГБ на диск

### <a name="solution"></a>Решение
В Azure Site Recovery действуют ограничения частоты изменения данных, зависящие от типа диска. Чтобы узнать, является ли эта проблема повторяющейся или кратковременной, нужно определить частоту изменения данных затронутой виртуальной машины. Выберите исходную виртуальную машину, найдите метрики в разделе **Мониторинг** и добавьте метрики, как показано на снимке экрана ниже.

![Три шага для нахождения частоты изменения данных](./media/site-recovery-azure-to-azure-troubleshoot/churn.png)

1. Выберите **Добавить метрику**, а затем добавьте **Скорость записи на диск ОС (байт/с)** и **Скорость записи на диск данных (байт/с)** .
2. Отслеживайте пики, как показано на снимке экрана.
3. Просмотрите общее количество операций записи на дисках ОС и на всех дисках данных. Эти метрики могут не содержать сведения на уровне отдельных дисков, но они указывают общий шаблон частоты обновления данных.

Если же всплеск частоты — это эпизодический случай, и частота изменения данных только на некоторое время превышает 10 Мбит/с (для ценовой категории "Премиум") и 2 Мбит/с (для ценовой категории "Стандартный"), то репликация завершится вовремя. Однако, если частота обновления сильно превышает поддерживаемое ограничение большую часть времени, то следует рассмотреть один из следующих возможных вариантов:

* **Исключите диск, вызывающий высокую частоту изменения данных**. Вы можете исключить диск с помощью [PowerShell](./azure-to-azure-exclude-disks.md). Чтобы исключить диск, необходимо сначала отключить репликацию. 
* **Измените уровень диска хранилища аварийного восстановления**. Этот вариант возможен, только если частота обновления данных диска менее 10 МБ/с. Допустим, на виртуальной машине с диском P10 частота обновления данных составляет от 8 до 10 МБ/с. Если клиент может использовать диск P30 для целевого хранилища во время защиты, эту проблему можно устранить.

## <a name="Network-connectivity-problem"></a>Проблемы с сетью

### <a name="network-latency-to-a-cache-storage-account"></a>Задержка в сети при обращении к учетной записи хранения кэша
Site Recovery отправляет реплицированные данные в учетную запись хранения кэша. Может наблюдаться задержки в сети, если передача данных из виртуальной машины в учетную запись хранения кэша выполняется медленнее, чем 4 МБ за 3 секунды. 

Чтобы проверить наличие проблемы с задержкой, с помощью [azcopy](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy) передайте данные из виртуальной машины в учетную запись хранения кэша. Если задержка большая, проверьте, используются ли сетевые виртуальные модули (NVA) для управления исходящим сетевым трафиком виртуальных машин. Если весь трафик репликации проходит через сетевой виртуальный модуль, к модулю может применяться регулирование. 

Мы рекомендуем создать конечную точку службы сети в виртуальной сети для хранилища, чтобы трафик репликации не передавался в виртуальный сетевой модуль. Дополнительные сведения можно найти в разделе [Настройка виртуального сетевого модуля](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#network-virtual-appliance-configuration).

### <a name="network-connectivity"></a>Сетевое подключение
Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина защищена брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, может возникнуть одна из описанных проблем. Сведения о том, как убедиться, что все URL-адреса подключены, см. в разделе [Исходящие подключения для диапазонов IP-адресов](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#outbound-connectivity-for-ip-address-ranges). 

## <a name="error-id-153006---no-app-consistent-recovery-point-available-for-the-vm-in-the-last-xxx-minutes"></a>Идентификатор ошибки 153006 - нет доступных для виртуальной Машины в течение минут 'XXX' точек восстановления с согласованием приложений

Ниже перечислены некоторые из наиболее распространенных проблем

#### <a name="cause-1-known-issue-in-sql-server-20082008-r2"></a>Причина 1. Известная проблема в SQL server 2008/2008 R2 
**Способы устранения** : Имеется известная проблема с SQL server 2008/2008 R2. См. в статье базы Знаний [агент Azure Site Recovery и другие, не являющегося компонентом VSS, резервное копирование завершается ошибкой для сервера размещения SQL Server 2008 R2](https://support.microsoft.com/help/4504103/non-component-vss-backup-fails-for-server-hosting-sql-server-2008-r2)

#### <a name="cause-2-azure-site-recovery-jobs-fail-on-servers-hosting-any-version-of-sql-server-instances-with-autoclose-dbs"></a>Причина 2. Сбой задания Azure Site Recovery на серверах размещения всех версий экземпляров SQL Server с помощью баз данных параметр AUTO_CLOSE 
**Способы устранения** : См. КБ [статьи](https://support.microsoft.com/help/4504104/non-component-vss-backups-such-as-azure-site-recovery-jobs-fail-on-ser) 


#### <a name="cause-3-known-issue-in-sql-server-2016-and-2017"></a>Причина 3. Известная проблема в SQL Server 2016 и 2017
**Способы устранения** : См. КБ [статьи](https://support.microsoft.com/help/4493364/fix-error-occurs-when-you-back-up-a-virtual-machine-with-non-component) 

#### <a name="cause-4-you-are-using-storage-spaces-direct-configuration"></a>Причина 4. При использовании прямого конфигурации дисковых пространств
**Способы устранения** : Azure Site Recovery не удается создать согласованную точку восстановления приложения для прямой конфигурации дисковых пространств. См. статью, чтобы правильно [Настройка политики репликации](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-how-to-enable-replication-s2d-vms)

### <a name="more-causes-due-to-vss-related-issues"></a>Дополнительные причины, из-за VSS проблемы, связанные с:

Выполнить дополнительную диагностику, проверьте файлы на исходном компьютере, чтобы получить точный код ошибки для сбоя:
    
    C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\Application Data\ApplicationPolicyLogs\vacp.log

Как найти ошибки в файле?
Выполните поиск строки «vacpError», открыв файл vacp.log в редакторе
        
    Ex: vacpError:220#Following disks are in FilteringStopped state [\\.\PHYSICALDRIVE1=5, ]#220|^|224#FAILED: CheckWriterStatus().#2147754994|^|226#FAILED to revoke tags.FAILED: CheckWriterStatus().#2147754994|^|

В приведенном выше примере **2147754994** является кодом ошибки, информирующее о причине сбоя, как показано ниже

#### <a name="vss-writer-is-not-installed---error-2147221164"></a>Модуль записи VSS не установлена — ошибка 2147221164 

*Способы устранения*: Чтобы создать тег согласованности приложения, Azure Site Recovery использует Microsoft теневого копирования томов (VSS) службы. Он устанавливает поставщик VSS, для его работы для создания моментальных снимков согласованности приложений. Этот поставщик VSS устанавливается как служба. В случае, если не установлена служба поставщика VSS, создания приложения согласованность моментального снимка завершается сбоем с кодом ошибки 0x80040154 «Класс не зарегистрирован». </br>
См. [статьи по устранению неполадок установки модуля записи VSS](https://docs.microsoft.com/azure/site-recovery/vmware-azure-troubleshoot-push-install#vss-installation-failures) 

#### <a name="vss-writer-is-disabled---error-2147943458"></a>Модуль записи VSS отключено — ошибка 2147943458

**Способы устранения**: Чтобы создать тег согласованности приложения, Azure Site Recovery использует Microsoft теневого копирования томов (VSS) службы. Он устанавливает поставщик VSS, для его работы для создания моментальных снимков согласованности приложений. Этот поставщик VSS устанавливается как служба. В случае, если поставщик VSS служба отключена, создания моментального снимка согласованности приложения завершается сбоем с кодом ошибки «указанная служба отключена и не может быть started(0x80070422)». </br>

- При отключении VSS
    - Убедитесь, что тип запуска службы поставщика VSS **автоматического**.
    - Перезапустите следующие службы:
        - Служба VSS
        - поставщик VSS Azure Site Recovery.
        - САМУ службу

####  <a name="vss-provider-notregistered---error-2147754756"></a>NOT_REGISTERED поставщик VSS - ошибка 2147754756

**Способы устранения**: Чтобы создать тег согласованности приложения, Azure Site Recovery использует Microsoft теневого копирования томов (VSS) службы. Проверьте, установлены ли службы VSS поставщик Azure Site Recovery или нет. </br>

- Повторная установка поставщика, используя следующие команды.
- Удаление существующего поставщика: C:\Program файлы (x86) \Microsoft Azure Site Recovery\agent\InMageVSSProvider_Uninstall.cmd
- Переустановите: C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\InMageVSSProvider_Install.cmd
 
Убедитесь, что тип запуска службы поставщика VSS **автоматического**.
    - Перезапустите следующие службы:
        - Служба VSS
        - поставщик VSS Azure Site Recovery.
        - САМУ службу
