---
title: Репликация возмутительных средств azure VMs с восстановлением сайта Azure
description: Репликация проблем в восстановлении аварийной аварии Azure VM с восстановлением сайта Azure
author: sideeksh
manager: rochakm
ms.topic: troubleshooting
ms.date: 04/03/2020
ms.openlocfilehash: 8cba02d3c7d1e649853570b199b646b1c4dcce2d
ms.sourcegitcommit: 67addb783644bafce5713e3ed10b7599a1d5c151
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2020
ms.locfileid: "80667413"
---
# <a name="troubleshoot-replication-in-azure-vm-disaster-recovery"></a>Репликация проблем в восстановлении аварийной аварии Azure VM

В этой статье описаны общие проблемы в восстановлении сайта Azure при воспроизведении и восстановлении виртуальных машин Azure (VM) из одного региона в другой. В нем также объясняется, как устранить общие проблемы. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

Восстановление сайта Azure последовательно реплицирует данные из региона исходного кода в область аварийного восстановления. Он также создает аварийную точку восстановления каждые 5 минут. Если службе Site Recovery не удается создать точки восстановления в течение 60 минут, она уведомляет об этом:

```plaintext
Error message: "No crash consistent recovery point available for the VM in the last 60 minutes."

Error ID: 153007
```

В следующих разделах описаны причины и способы устранения неполадок.

## <a name="high-data-change-rate-on-the-source-virtual-machine"></a>Высокая скорость изменения данных на исходной виртуальной машине

Восстановление сайта Azure создает событие, если скорость изменения данных на исходной виртуальной машине выше поддерживаемых лимитов. Чтобы узнать, является ли проблема из-за высокого оттока, перейдите на **Replicated элементы** > **VM** > **События - последние 72 часа.**
Вы должны увидеть скорость изменения данных события **за пределами поддерживаемых пределов:**

:::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/data_change_event.png" alt-text="Страница восстановления сайта Azure, на которую отображается слишком высокая скорость изменения данных.":::

Если выбрать это событие, вы увидите точные сведения о диске.

:::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/data_change_event2.png" alt-text="Страница, отображая детали события события изменения данных.":::

### <a name="azure-site-recovery-limits"></a>Ограничения Azure Site Recovery

В таблице ниже приведены ограничения Azure Site Recovery. Эти ограничения основаны на наших тестах, но они не могут охватывать все возможные комбинации ввода-вывода приложений (I/O). Фактические результаты зависят от сочетания операций ввода-вывода приложения.

Есть два ограничения для рассмотрения: отток данных на диск и отток данных на виртуальную машину. Рассмотрим диск Premium P20 в следующей таблице для примера. Для одного VM, Восстановление сайта может обрабатывать 5 МБ /с оттока на диск с максимум пятью такими дисками. Восстановление сайта имеет предел 25 МБ/с от общего объема оттока на VM.

**Цель хранения репликации** | **Среднее число операций ввода-вывода для исходного диска** |**Средняя частота обновления данных для исходного диска** | **Общая частота обновления данных в день для исходного диска данных**
---|---|---|---
Хранилище уровня "Стандартный" | 8 КБ    | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 8 КБ    | 2 МБ/с | 168 ГБ на диск
Диск P10 или P15 класса Premium | 16 КБ | 4 МБ/с |    336 ГБ на диск
Диск P10 или P15 класса Premium | 32 КБ или выше | 8 МБ/с | 672 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 8 КБ    | 5 МБ/с | 421 ГБ на диск
Диск P20, P30, P40 или P50 класса Premium | 16 КБ или выше |20 МБ/с | 1684 ГБ на диск

### <a name="solution"></a>Решение

Восстановление сайта Azure имеет ограничения на скорость изменения данных, в зависимости от типа диска. Чтобы увидеть, повторяется ли эта проблема или носит временный характер, найдите скорость изменения данных пострадавшей виртуальной машины. Выберите исходную виртуальную машину, найдите метрики в разделе **Мониторинг** и добавьте метрики, как показано на снимке экрана ниже.

:::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/churn.png" alt-text="Страница, отображая трехступенчатый процесс поиска скорости изменения данных.":::

1. Выберите **Добавить метрику**, а затем добавьте **Скорость записи на диск ОС (байт/с)** и **Скорость записи на диск данных (байт/с)**.
1. Отслеживайте пики, как показано на снимке экрана.
1. Просмотрите общее количество операций записи на дисках ОС и на всех дисках данных. Эти метрики могут не содержать сведения на уровне отдельных дисков, но они указывают общий шаблон частоты обновления данных.

Резкий скачок скорости изменения данных может произойь из-за случайного всплеска данных. Если скорость изменения данных превышает 10 МБ/с (для Premium) или 2 МБ/с (для Стандарта) и спускается, репликация догонит. Если отток последовательно выходит за пределы поддерживаемого предела, рассмотрим один из этих вариантов:

- Исключите диск, вызывающий высокую скорость изменения данных: Во-первых, отключить репликацию. Затем вы можете исключить диск с помощью [PowerShell](azure-to-azure-exclude-disks.md).
- Изменение уровня диска аварийного восстановления: Эта опция возможна только в том случае, если отток данных диска составляет менее 20 МБ/с. Например, VM с диском P10 имеет отток данных более 8 МБ/с, но менее 10 МБ/с. Если клиент может использовать диск P30 для целевого хранилища во время защиты, эту проблему можно устранить. Это решение возможно только для машин, использующих диски премиум-управления. Выполните следующие действия.

  1. Перейдите на **диски** пострадавшей реплицированной машины и скопируйте имя диска реплики.
  1. Перейдите к этой реплике управляемого диска.
  1. В **обзоре** может быть спровиден баннер, в который говорится о сгенерирован URL SAS. Выберите этот баннер и отмените экспорт. Игнорируйте этот шаг, если вы не видите баннер.
  1. Как только URL SAS будет отозван, перейдите в **Configuration** для управляемого диска. Увеличьте размер, чтобы Восстановление сайта поддерживало наблюдаемую скорость оттока на исходном диске.

## <a name="network-connectivity-problems"></a>Проблемы с сетью

### <a name="network-latency-to-a-cache-storage-account"></a>Задержка в сети при обращении к учетной записи хранения кэша

Site Recovery отправляет реплицированные данные в учетную запись хранения кэша. Вы можете испытывать задержку сети, если загрузка данных из виртуальной машины в учетную запись хранения кэша медленнее, чем 4 МБ за 3 секунды.

Чтобы проверить наличие проблемы, связанной с задержкой, используйте [AzCopy](/azure/storage/common/storage-use-azcopy). Эту утилиту командной строки можно использовать для загрузки данных с виртуальной машины в учетную запись хранения кэша. Если задержка высока, проверьте, используете ли вы сетевой виртуальный прибор (NVA) для управления исходящим сетевым трафиком с виртуальных технологий. Если весь трафик репликации проходит через сетевой виртуальный модуль, к модулю может применяться регулирование.

Мы рекомендуем создать конечную точку службы сети в виртуальной сети для хранилища, чтобы трафик репликации не передавался в виртуальный сетевой модуль. Дополнительные сведения можно найти в разделе [Настройка виртуального сетевого модуля](azure-to-azure-about-networking.md#network-virtual-appliance-configuration).

### <a name="network-connectivity"></a>Сетевое подключение

Для того чтобы репликация восстановления сайта работала, ему необходимо, чтобы VM обеспечивал исходящие подключения к определенным URL-адресам или диапазонам IP. Возможно, ваш VM стоит за брандмауэром или использовать правила группы сетевой безопасности (NSG) для управления исходящим подключением. Если это так, вы можете возникнуть проблемы. Чтобы убедиться, что все URL-адреса подключены, [см. Исходящие подключения для URL-адресов.](azure-to-azure-about-networking.md#outbound-connectivity-for-urls)

## <a name="error-id-153006---no-app-consistent-recovery-point-available-for-the-vm-in-the-past-x-minutes"></a>Id ошибки 153006 - Нет приложения последовательной точки восстановления доступны для VM в последние "X" минут

Ниже приведены некоторые из наиболее распространенных вопросов.

### <a name="known-issue-in-sql-server-20082008-r2"></a>Известная проблема на сервере S'L 2008/2008 R2

**Как исправить:** Существует известная проблема с сервером S'L 2008/2008 R2. Ссылайтесь на статью [Azure Site Recovery Agent или на другой некомпонентный резервный отсутс в объеме некомпонентного резервного копирования VSS для сервера, хозяйнивого S'L Server 2008 R2](https://support.microsoft.com/help/4504103/non-component-vss-backup-fails-for-server-hosting-sql-server-2008-r2).

### <a name="azure-site-recovery-jobs-fail-on-servers-hosting-any-version-of-sql-server-instances-with-auto_close-dbs"></a>Задания по восстановлению сайта Azure не сбой на серверах, где размещается любая версия экземпляров S'L Server с AUTO_CLOSE DB

**Как исправить:** Ссылайтесь на статью [Некомпонентные резервные копирования VSS, такие как задания по восстановлению сайта Azure, не удается на серверах, худивакоторых экземпляров S'L Server с AUTO_CLOSE DB.](https://support.microsoft.com/help/4504104/non-component-vss-backups-such-as-azure-site-recovery-jobs-fail-on-ser)

### <a name="known-issue-in-sql-server-2016-and-2017"></a>Известная проблема в SQL Server 2016 и 2017

**Как исправить**: Обратитесь к статье [Кумулятивное обновление 16 для Сервера S'L 2017](https://support.microsoft.com/help/4508218/cumulative-update-16-for-sql-server-2017).

### <a name="youre-using-azure-storage-spaces-direct-configuration"></a>Вы используете прямую конфигурацию пространства хранения Azure

**Как исправить:** Восстановление сайта Azure не может создать последовательную точку восстановления приложений для непосредственной конфигурации пространства хранения. [Настройка политики репликации.](azure-to-azure-how-to-enable-replication-s2d-vms.md)

### <a name="more-causes-because-of-vss-related-issues"></a>Больше причин из-за проблем, связанных с VSS:

Чтобы устранить неполадки далее, проверьте файлы на исходной машине, чтобы получить точный код ошибки для сбоя:

`C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\Application Data\ApplicationPolicyLogs\vacp.log`

Чтобы найти ошибки, откройте файл _vacp.log_ в поиске текстового редактора для строки **vacpError.**

```plaintext
Ex: vacpError:220#Following disks are in FilteringStopped state [\\.\PHYSICALDRIVE1=5, ]#220|^|224#FAILED: CheckWriterStatus().#2147754994|^|226#FAILED to revoke tags.FAILED: CheckWriterStatus().#2147754994|^|
```

В предыдущем примере **2147754994** — это код ошибки, который сообщает вам о сбое после этого предложения.

#### <a name="vss-writer-is-not-installed---error-2147221164"></a>Писатель VSS не установлен - Огонек No 2147221164

**Как исправить**: Для создания тега согласованности приложений, Azure Site Recovery использует службу копирования теней тома (VSS). Восстановление сайта устанавливает провайдера VSS для его работы, чтобы сделать снимки согласованности приложений. Восстановление сайта Azure устанавливает этот поставщик VSS в качестве службы. Если vsS Provider не установлен, создание моментального снимка согласованности приложения завершается неудачей. Он показывает **идентификатор ошибки 0x80040154 Класс не зарегистрирован.** Ссылка на статью для [VSS писатель установки устранения неполадок](vmware-azure-troubleshoot-push-install.md#vss-installation-failures).

#### <a name="vss-writer-is-disabled---error-2147943458"></a>Писатель VSS отключен - Огонек No 2147943458

**Как исправить**: Для создания тега согласованности приложения восстановление сайта Azure использует VSS. Восстановление сайта устанавливает провайдера VSS для его работы, чтобы сделать снимки согласованности приложений. Этот поставщик VSS устанавливается как услуга. Если у вас нет включена услуга VSS Provider, создание моментального снимка согласованности приложения завершается неудачей. Он показывает ошибку: **указанная услуга отключена и не может быть запущена (0x80070422).**

Если VSS отключен:

- Убедитесь, что тип запуска службы VSS Provider настроен на **автоматическое.**
- Перезапустите следующие службы:
  - Услуга VSS.
  - Поставщик восстановления сайта Azure VSS.
  - Сервис VDS.

#### <a name="vss-provider-not_registered---error-2147754756"></a>VSS PROVIDER NOT_REGISTERED - Ошибка 2147754756

**Как исправить**: Для создания тега согласованности приложения восстановление сайта Azure использует VSS. Проверьте, установлена ли услуга Azure Site Recovery VSS Provider.

Используйте следующие команды для переустановки VSS Provider:

1. Удаление существующего поставщика:

   `"C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\InMageVSSProvider_Uninstall.cmd"`

1. Переустановка VSS-провайдера:

   `"C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\InMageVSSProvider_Install.cmd"`

Убедитесь, что тип запуска службы VSS Provider настроен на **автоматическое.**

Перезапустите следующие службы:

- Услуга VSS.
- Поставщик восстановления сайта Azure VSS.
- Сервис VDS.
