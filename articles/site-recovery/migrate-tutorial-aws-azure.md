---
title: Перенос виртуальных машин AWS в Azure с помощью службы Azure Site Recovery | Документация Майкрософт
description: В этой статье описано, как перенести виртуальные машины Windows, запущенные в Amazon Web Services (AWS), в Azure с помощью Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 05/30/2019
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 6d2b9c8dd8fb89e201cff5155b1dec0857204752
ms.sourcegitcommit: d89032fee8571a683d6584ea87997519f6b5abeb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/30/2019
ms.locfileid: "66400053"
---
# <a name="migrate-amazon-web-services-aws-vms-to-azure"></a>Перенос виртуальных машин Amazon Web Services (AWS) в Azure

Из этого руководства вы узнаете, как с помощью Azure Site Recovery перенести виртуальные машины Amazon Web Services (AWS) в виртуальные машины Azure. При переносе экземпляров AWS EC2 в Azure эти виртуальные машины обрабатываются как физические локальные компьютеры. Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * проверка предварительных требований;
> * Подготовка ресурсов Azure
> * подготовка экземпляров EC2 AWS к переносу;
> * Развертывание сервера конфигурации.
> * Включение репликации для виртуальных машин.
> * Выполнение тестовой отработки отказа, чтобы убедиться в надлежащей работе всех компонентов.
> * выполнение однократной отработки отказа в Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования
- Убедитесь, что виртуальные машины, которые нужно перенести, работают под управлением поддерживаемой версии ОС. К таким версиям относятся: 
  - Windows Server 2016 
  - Windows Server 2012 R2
  - Windows Server 2012 
  - 64-разрядная версия Windows Server 2008 R2 с пакетом обновления 1 (SP1) или выше.
  - Red Hat Enterprise Linux версий 6.4–6.10, 7.1–7.6 (только виртуализированные экземпляры HVM). *Экземпляры, работающие с драйверами RedHat PV, не поддерживаются.*
  - CentOS версий 6.4–6.10, 7.1–7.6 (только виртуализированные экземпляры HVM).
 
- Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую вы хотите реплицировать. 

    > [!IMPORTANT]
    > Site Recovery устанавливает эту службу автоматически при включении репликации для виртуальной машины. Для автоматической установки следует подготовить учетную запись на экземплярах EC2, которые Site Recovery будет использовать для доступа к виртуальной машине. Вы можете использовать доменную или локальную учетную запись. 
    > - Для виртуальных машин Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux. 
    > - Для виртуальных машин Windows, если учетная запись домена не используется, отключите контроль удаленного доступа пользователей на локальном компьютере:
    >
    >      В разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и установите для нее значение **1**.

- Отдельный экземпляр EC2, который можно использовать в качестве сервера конфигурации Site Recovery. Он должен работать под управлением Windows Server 2012 R2.

## <a name="prepare-azure-resources"></a>Подготовка ресурсов Azure

Для перенесенных экземпляров EC2 следует подготовить в Azure несколько ресурсов, такие как учетная запись хранения, хранилище и виртуальная сеть.

### <a name="create-a-storage-account"></a>Создание учетной записи хранения

Образы реплицированных компьютеров хранятся в службе хранилища Azure. Виртуальные машины Azure создаются из хранилища при отработке отказа с переходом из локальной среды в Azure.

1. В меню слева на [портале Azure](https://portal.azure.com) выберите **Создать ресурс** > **Хранилище** > **Учетная запись хранения**.
2. Выберите имя для своей учетной записи хранения. В этих руководствах мы используем имя **awsmigrated2017**. Это имя должно иметь следующие характеристики:
    - уникальное в пределах Azure;
    - длиной от 3 до 24 символов;
    - содержать только строчные буквы, цифры и дефисы.
3. Сохраните значения по умолчанию для параметров **Модель развертывания**, **Тип учетной записи**, **Производительность** и **Требуется безопасное перемещение**.
5. В разделе **Репликация** выберите значение по умолчанию для параметра **RA-GRS**.
6. Выберите подписку, которую нужно использовать при работе с этим руководством.
7. Для параметра **Группа ресурсов** выберите **Создать**. В этом примере мы используем имя **migrationRG** для группы ресурсов.
8. В разделе **Расположение** выберите **Западная Европа**.
9. Щелкните **Create** (Создать), чтобы создать учетную запись хранения.

### <a name="create-a-vault"></a>Создание хранилища

1. На [портале Azure](https://portal.azure.com) выберите **Все службы**. Выполните поиск по строке **Хранилища служб восстановления** и выберите соответствующий элемент.
2. На странице хранилищ служб восстановления выберите действие **Добавить**.
3. Для параметра **Имя** введите значение **myVault**.
4. В поле **Подписка** выберите подписку, которую вы хотите использовать.
4. В разделе **Группа ресурсов** установите флажок **Использовать существующую**, а затем выберите вариант **migrationRG**.
5. В разделе **Расположение** выберите **Западная Европа**.
5. Выберите **Закрепить на панели мониторинга**, чтобы получить возможность быстрого доступа к новому хранилищу с панели мониторинга.
7. Когда все будет готово, выберите **Создать**.

Чтобы просмотреть новое хранилище, откройте **Панель мониторинга** > **Все ресурсы**. Новое хранилище появится на основной странице **Хранилища служб восстановления**.

### <a name="set-up-an-azure-network"></a>Настроить сеть

Созданные после миграции (или отработки отказа) виртуальные машины Azure присоединятся к этой сети.

1. На [портале Azure](https://portal.azure.com) последовательно выберите **Создать ресурс** > **Сети** >
    **Виртуальная сеть**
3. В поле **Имя** введите **myMigrationNetwork**.
4. Оставьте значение по умолчанию для параметра **Адресное пространство**.
5. В поле **Подписка** выберите подписку, которую вы хотите использовать.
6. В разделе **Группа ресурсов** установите флажок **Использовать существующую**, а затем выберите вариант **migrationRG**.
7. В разделе **Расположение** выберите **Западная Европа**.
8. В разделе **Подсеть** сохраните значения по умолчанию для параметров **Имя** и **Диапазон IP-адресов**.
9. Оставьте отключенным параметры **Конечные точки службы**.
10. Когда все будет готово, выберите **Создать**.

## <a name="prepare-the-infrastructure"></a>Подготовка инфраструктуры

На странице хранилища на портале Azure откройте раздел **Начало работы**, выберите **Site Recovery** и **Подготовка инфраструктуры**. Выполните следующие шаги.

### <a name="1-protection-goal"></a>1: Цель защиты

На странице **Цель защиты** укажите следующие значения:

|    |  |
|---------|-----------|
| Где находятся компьютеры? |Выберите **Локально**.|
| Куда следует реплицировать компьютеры? |Выберите **В Azure**.|
| Виртуализированы ли ваши компьютеры? |Выберите **Не виртуализированы/Другое**.|

Когда все будет готово, щелкните **ОК**, чтобы перейти к следующему разделу.

### <a name="2-select-deployment-planning"></a>2. Выбор параметров планирования развертывания

В разделе **Вы спланировали развертывание?** выберите **Я сделаю это позже** и нажмите кнопку **ОК**.

### <a name="3-prepare-source"></a>3: Подготовка источника

На странице **Подготовка исходного объекта** щелкните **+Сервер конфигурации**.

1. Выберите экземпляр EC2 под управлением Windows Server 2012 R2 для создания сервера конфигурации и зарегистрируйте его в хранилище восстановления.
2. Настройте прокси-сервер на виртуальной машине экземпляра EC2, используемой в качестве сервера конфигурации, чтобы она смогла получать доступ к [URL-адресам службы](site-recovery-support-matrix-to-azure.md).
3. Скачайте программу [единой установки Microsoft Azure Site Recovery](https://aka.ms/unifiedinstaller_wus). Ее можно скачать на локальный компьютер и скопировать на виртуальную машину, используемую в качестве сервера конфигурации.
4. Выберите **Скачать**, чтобы получить ключ регистрации хранилища. Скопируйте скачанный файл на виртуальную машину, которую вы используете как сервер конфигурации.
5. На виртуальной машине щелкните правой кнопкой мыши установщик, скачанный для программы единой установки Microsoft Azure Site Recovery, и выберите **Запуск от имени администратора**.

    1. На вкладке **Перед началом работы** выберите **Установить сервер конфигурации и сервер обработки** и щелкните **Далее**.
    2. В разделе **Лицензия на программное обеспечение стороннего поставщика** выберите **Я принимаю условия лицензионного соглашения стороннего поставщика**, а затем щелкните **Далее**.
    3. В разделе **Регистрация** выберите **Обзор** и перейдите к расположению, в котором находится файл ключа регистрации хранилища. Щелкните **Далее**.
    4. В разделе **Параметры браузера** выберите **Подключаться к Azure Site Recovery без прокси-сервера**, а затем щелкните **Далее**.
    5. На странице **Проверка предварительных требований** будет выполнена проверка нескольких элементов. По завершении проверки нажмите кнопку **Далее**.
    6. В разделе **Конфигурация MySQL** предоставьте необходимые пароли и щелкните **Далее**.
    7. На странице **Сведения о среде** выберите **Нет**. Защита для машин VMware не требуется. Затем нажмите кнопку **Далее**.
    8. В разделе **Расположение установки** щелкните **Далее**, чтобы принять значения по умолчанию.
    9. В разделе **Выбор сети** щелкните **Далее**, чтобы принять значения по умолчанию.
    10. На странице **Сводка** щелкните **Установить**.
    11. На странице **Ход выполнения установки** отображается информация о процессе установки. Когда этот процесс завершится, выберите **Далее**. Появится окно с предупреждением о перезагрузке. Нажмите кнопку **ОК**. Следующее окно выводит сообщение о парольной фразе для подключения к серверу конфигурации. Скопируйте парольную фразу в буфер обмена и сохраните ее в безопасном месте.
6. На виртуальной машине запустите файл cspsconfigtool.exe, чтобы создать одну или несколько учетных записей управления на сервере конфигурации. Убедитесь, что учетным записям управления назначены разрешения администратора для экземпляров EC2, которые требуется перенести.

Настроив сервер конфигурации, вернитесь на портал и выберите сервер, созданный в качестве **сервера конфигурации**. Нажмите кнопку **ОК**, чтобы перейти к шагу 3 — подготовке целевых объектов.

### <a name="4-prepare-target"></a>4: Подготовка цели

В этом разделе описано, как ввести сведения о ресурсах, созданных ранее в разделе [Подготовка ресурсов Azure](#prepare-azure-resources) этого руководства.

1. В разделе **Подписка** выберите подписку Azure, использованную при работе с руководством [Подготовка ресурсов Azure к репликации локального компьютера](tutorial-prepare-azure.md).
2. Выберите **Resource Manager** в качестве модели развертывания.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure. Именно эти ресурсы вы создавали ранее в разделе [Подготовка ресурсов Azure](#prepare-azure-resources) этого руководства.
4. Закончив, нажмите кнопку **OK**.

### <a name="5-prepare-replication-settings"></a>5. Подготовка параметров репликации

Прежде чем включить репликацию, необходимо создать политику репликации.

1. Щелкните **Репликация и связь**.
2. В поле **Имя** введите **myReplicationPolicy**.
3. Для остальных параметров сохраните значения по умолчанию и нажмите кнопку **ОК** для создания политики. Созданная политика автоматически сопоставляется с сервером конфигурации.

Завершив настройку всех пяти разделов в списке **Подготовка инфраструктуры**, нажмите кнопку **ОК**.

## <a name="enable-replication"></a>Включение репликации

Включите репликацию для всех виртуальных машин, которые вы хотите перенести. Когда вы включите репликацию, Site Recovery автоматически установит службу Mobility Service.

1. Перейдите на [портал Azure](https://portal.azure.com).
1. На странице хранилища в разделе **Начало работы** выберите **Site Recovery**.
2. В разделе **Для локальных компьютеров и виртуальных машин Azure** выберите **Шаг 1. Репликация приложения**. Заполните страницы мастера следующими данными: Когда вы введете все данные, нажмите кнопку **ОК** на каждой странице:
   - 1: Настройка источника

     |  |  |
     |-----|-----|
     | Источник: | Выберите вариант **Локальный**.|
     | Исходное расположение:| Введите имя экземпляра сервера конфигурации EC2.|
     |Тип компьютера: | Выберите вариант **Физические компьютеры**.|
     | Сервер обработки: | Выберите сервер конфигурации в раскрывающемся списке.|

   - 2. Настройка целевого объекта

     |  |  |
     |-----|-----|
     | Цель: | Оставьте значение по умолчанию.|
     | Подписка: | Выберите используемую подписку.|
     | Группа ресурсов, которая будет использоваться после отработки отказа:| Используйте группу ресурсов, которую вы создали в разделе [Подготовка ресурсов Azure](#prepare-azure-resources).|
     | Модель развертывания, которая будет использоваться после отработки отказа: | Выберите **Диспетчер ресурсов**.|
     | Учетная запись хранения: | Выберите учетную запись хранения, которую вы создали в разделе [Подготовка ресурсов Azure](#prepare-azure-resources).|
     | Сеть Azure: | Выберите **Настроить сейчас для выбранных компьютеров**.|
     | Сеть Azure, которая будет использоваться после отработки отказа: | Выберите сеть, которую вы создали в разделе [Подготовка ресурсов Azure](#prepare-azure-resources).|
     | Подсеть: | Выберите **По умолчанию** в раскрывающемся списке.|

   - 3. Выбор физических компьютеров

     Щелкните **+Физический компьютер**, а затем введите **Имя**, **IP-адрес** и **Тип ОС** для экземпляра EC2, который вы хотите перенести. Нажмите кнопку **ОК**.

   - 4. Настройка свойств

     В раскрывающемся списке выберите учетную запись, которую вы создали на сервере конфигурации, и нажмите кнопку **ОК**.

   - 5. Настройка параметров репликации

     Убедитесь, что в раскрывающемся списке выбрана политика репликации **myReplicationPolicy**, и нажмите кнопку **ОК**.

3. Когда работа мастера завершится, щелкните **Включить репликацию**.

Чтобы отслеживать ход выполнения задания **Включение защиты**, последовательно выберите **Мониторинг и отчеты** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.        

После включения репликации для виртуальной машины может пройти более 15 минут, прежде чем изменения вступят в силу и отобразятся на портале.

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

При запуске тестовой отработки отказа происходит следующее:

- выполняется проверка всех необходимых условий для отработки отказа;
- обрабатываются данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе этих данных создается точка восстановления;
- создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

На портале запустите тестовую отработку отказа, сделав следующее:

1. На странице хранилища выберите **Защищенные элементы** > **Реплицированные элементы**. Щелкните нужную виртуальную машину и выберите **Тестовая отработка отказа**.
2. Выберите точку восстановления для отработки отказа:
    - **Последняя обработанная**. Отработка отказа виртуальной машины выполняется до последней точки восстановления, которая была обработана Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
    - **Последняя с согласованием приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
    - **Настраиваемая**. Вы можете выбрать любую точку восстановления.

3. На странице **Тестовая отработка отказа** выберите целевую сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа. Это должна быть сеть, созданная в разделе [Подготовка ресурсов Azure](#prepare-azure-resources).
4. Нажмите кнопку **ОК**, чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину. Вы также можете выбрать задание **Тестовая отработка отказа** на странице хранилища. Чтобы сделать это, выберите **Мониторинг и отчеты** > **Задания** >  **Задания Site Recovery**.
5. Когда отработка отказа завершится, на портале Azure появится реплика виртуальной машины. Чтобы просмотреть виртуальную машину, выберите **Виртуальные машины**. Проверьте, что виртуальная машина имеет правильный размер, а также что она подключена к соответствующей сети и запущена.
6. Теперь вы можете подключиться к реплицированной виртуальной машине в Azure.
7. Чтобы удалить виртуальные машины Azure, созданные во время тестовой отработки отказа, выберите **Очистить тестовую отработку отказа** в плане восстановления. В разделе **Примечания** можно записать и сохранить любые замечания, связанные с тестовой отработкой отказа.

В некоторых сценариях отработка отказа требует дополнительной обработки данных. Обработка занимает от 8 до 10 минут.

## <a name="migrate-to-azure"></a>Миграция в Azure

Запустите фактическую отработку отказа для экземпляров EC2, чтобы перенести их на виртуальные машины Azure.

1. В разделе **Защищенные элементы** > **Реплицированные элементы** выберите экземпляры AWS и щелкните **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **точку восстановления**, до которой будет выполнена отработка отказа. Выберите последнюю точку восстановления и запустите отработку отказа. На странице **Задания** можно следить за ходом выполнения отработки отказа.
1. Проверьте, что виртуальная машина отображается в разделе **Реплицированные элементы**.
2. Щелкните каждую виртуальную машину правой кнопкой мыши и выберите **Завершить перенос**. Таким образом вы сделаете следующее:

   - Таким образом вы завершите миграцию, прекратите репликацию для виртуальной машины AWS и остановите выставление счетов Site Recovery для виртуальной машины.
   - Удалите данные репликации. Перенесенные виртуальные машины при этом не будут удалены. 

     ![Завершение миграции](./media/migrate-tutorial-aws-azure/complete-migration.png)

> [!WARNING]
> *Не отменяйте отработку отказа во время ее выполнения*. Перед началом отработки отказа репликация виртуальной машины останавливается. Если вы отмените выполняющуюся отработку отказа, операция остановится, но виртуальная машина больше нельзя будет реплицировать.  


## <a name="next-steps"></a>Дополнительная информация

Из этой статьи вы узнали, как перенести экземпляры EC2 AWS в виртуальные машины Azure. Дополнительные сведения о виртуальных машинах Azure см. в руководствах для виртуальных машин Windows.

> [!div class="nextstepaction"]
> [Создание виртуальных машин Windows и управление ими с помощью модуля Azure PowerShell](../virtual-machines/windows/tutorial-manage-vm.md)
