---
title: Настройка сбоя и сбоя для физических серверов с восстановлением сайта
description: Узнайте, как выполнить отработку отказа физических серверов в Azure и восстановить размещение на локальном сайте для аварийного восстановления с помощью Azure Site Recovery
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 12/17/2019
ms.author: raynew
ms.openlocfilehash: ea5893f45962d67f4b6f3e9a261c65aa0ec926bf
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75497855"
---
# <a name="fail-over-and-fail-back-physical-servers-replicated-to-azure"></a>Отработка отказа и восстановление размещения физических серверов, реплицированных в Azure

В этом уроке описывается, как сбой в отношении нахлопных физических серверов, которые реплицируются в Azure с [помощью восстановления сайта Azure.](site-recovery-overview.md) После того, как вы не справились с этой работами, вы не сможете вернуться из Azure на свой сайт, когда он доступен.

## <a name="before-you-start"></a>Перед началом работы

- [Узнайте](failover-failback-overview.md) о процессе сбоя в аварийном восстановлении.
- Если вы хотите потерпеть неудачу в нескольких машинах, [узнайте,](recovery-plan-overview.md) как собрать машины вместе в плане восстановления.
- Прежде чем вы сделаете полный сбой, запустите [аварийное восстановление упражнения,](site-recovery-test-failover-to-azure.md) чтобы убедиться, что все работает, как ожидалось.
- Следуйте [этим инструкциям,](site-recovery-failover.md#prepare-to-connect-after-failover) чтобы подготовиться к подключению к MMs Azure после сбоя.



## <a name="run-a-failover"></a>Запуск отработки отказа

### <a name="verify-server-properties"></a>Проверка свойств сервера

Проверьте свойства сервера и убедитесь, что он соответствует [требованиям Azure](vmware-physical-azure-support-matrix.md#replicated-machines) к виртуальным машинам Azure.

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.
2. В области **Реплицированный элемент** находятся сводные данные о компьютере, в том числе состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.
3. В **компании Compute and Network**можно изменить имя Azure, группу ресурсов, размер цели, набор [доступности](../virtual-machines/windows/tutorial-availability-sets.md)и управляемые настройки диска
4. Можно просмотреть или изменить параметры сети, включая сеть (или подсеть), в которой будет размещаться виртуальная машина Azure после отработки отказа, и IP-адрес, который будет ей назначен.
5. В разделе **Диски** отображаются сведения об операционной системе и дисках данных на компьютере.

### <a name="fail-over-to-azure"></a>Отработка отказа с переходом в Azure

1. В **настройках** > **Реплицированные элементы** щелкают машиной > **Failover.**
2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
   - **Последние**. В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина Azure, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
   - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления компьютера, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
   - **Последняя точка во времени согласованности приложений.** Отработка отказа компьютера выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery.
   - **Настраиваемая.** Следует указать точку восстановления.

3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа.**, чтобы служба Site Recovery попыталась выключить исходный компьютер, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. Вы можете следить за ходом сбоя на странице **Вакансии.**
4. Если вы готовы подключиться к виртуальной машине Azure, сделайте это, чтобы проверить ее после отработки отказа.
5. После проверки **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> Не отменяйте отработку отказа в процессе выполнения. Перед началом отработки отказа репликация компьютера останавливается. Если отменить отработку отказа, она останавливается, но компьютер не будет реплицироваться повторно.
> Дополнительная отработка отказа физических серверов может длиться 8–10 минут.

## <a name="automate-actions-during-failover"></a>Автоматизировать действия во время сбоя

Возможно, вы захотите автоматизировать действия во время сбоя. Для этого можно использовать скрипты или запуски автоматизации Azure в планах восстановления.

- [Узнайте](site-recovery-create-recovery-plans.md) о создании и настройке планов восстановления, включая добавление скриптов.
- [Узнайте,](site-recovery-runbook-automation.md) что добавление runbooks Azure Automation в планы восстановления.

## <a name="configure-settings-after-failover"></a>Настройка настроек после сбоя

После сбоя необходимо [настроить настройки Azure](site-recovery-failover.md#prepare-in-azure-to-connect-after-failover) для подключения к реплицированным MMs Azure. Кроме того, создать [внутренние и общественные](site-recovery-failover.md#set-up-ip-addressing) IP-адреса.

## <a name="prepare-for-reprotection-and-failback"></a>Подготовка к повторной защите и отказу

После сбоя в Azure вы повторно защитите вм-технологии Azure, реплицируя их на сайте. Затем, после их репликации, вы можете вывести их из строя обратно в помещения, запустив сбой из Azure на свой сайт.

1. Размещение физических серверов, реплицированных в Azure, можно восстановить только на виртуальных машинах VMware. Для этого вам требуется локальная инфраструктура VMware. Выполните последующие действия в [этой статье,](vmware-azure-prepare-failback.md) чтобы подготовиться к повторной защите и отказу, включая настройку сервера процессов в Azure и внутреннего основного целевого сервера, а также настройку VPN-сайта, или private peering ExpressRoute, для сбоя.
2. Убедитесь, что сервер конфигурации в ней работает и подключен к Azure. Во время сбоя в Azure сайт может быть недоступен, а сервер конфигурации может быть недоступен или закрыт. Во время сбоя VM должен существовать в базе данных серверов конфигурации. В противном случае восстановление размещения завершается сбоем.
3. Удалите все снимки на главном целевом сервере. Резащита не будет работать, если есть снимки.  Снимки на VM автоматически объединяются во время повторной защиты задания.
4. Если вы повторно защищаете ВМ, собранные в группу репликации для последовательности мульти-VM, убедитесь, что все они имеют одинаковую операционную систему (Windows или Linux) и убедитесь, что основной целевой сервер, который вы развертываете, имеет тот же тип операционной системы. Все ввожжа в группу репликации должны использовать один и тот же основной целевой сервер.
5. Откройте [необходимые порты](vmware-azure-prepare-failback.md#ports-for-reprotectionfailback) для сбоя.
6. Убедитесь, что vCenter Server подключен до сбоя. В противном случае отключение дисков и их присоединение к виртуальной машине завершится сбоем.
7. Если сервер vCenter управляет vMs, на которые вы сведете с себя сбой, убедитесь, что у вас есть необходимые разрешения. Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция настройки защиты завершится успешно и отработка отказа будет работать. Однако во время повторной защиты сбой сбой, поскольку хранилища данных не могут быть обнаружены, и не перечислены во время повторной защиты. Чтобы решить эту проблему, вы можете обновить учетные данные vCenter с [соответствующей учетной записью / разрешения,](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery)а затем повторить работу. 
8. Если вы использовали шаблон для создания виртуальных машин, убедитесь, что каждый VM имеет свой собственный UUID для дисков. Если в непредпомещении VM UUID стычки с UUID главного целевого сервера, поскольку оба были созданы из одного шаблона, резащита завершается неудачей. Развертывание из другого шаблона.
9. Если вы не сможете вернуться к альтернативному vCenter Server, убедитесь, что новый vCenter Server и главный целевой сервер обнаружены. Обычно, если они не являются хранилищами данных, недоступны или не видны в **Reprotect.**
10. Проверьте следующие сценарии, в которых вы не можете выполнить обратный отыкнется:
    - Если вы используете либо ESXi 5.5 бесплатное издание или vSphere 6 Hypervisor бесплатное издание. Обновление до другой версии.
    - Если у вас есть Windows Server 2008 R2 SP1 физического сервера.
    - VMs, которые [были мигрировали](migrate-overview.md#what-do-we-mean-by-migration).
    - VM, который был перемещен в другую группу ресурсов.
    - Реплика Azure VM, которая была удалена.
    - Реплика Azure VM, которая не защищена (реплицировать сярприза на сайт.
10. [Просмотрите типы сбой,](concepts-types-of-failback.md) который вы можете использовать - первоначальное восстановление местоположения и альтернативное восстановление местоположения.


## <a name="reprotect-azure-vms-to-an-alternate-location"></a>Reprotect Azure VMs в альтернативном месте

Эта процедура предполагает, что на месте VM не имеется.

1. В хранилище > **Настройки** > **Реплицированные элементы**, право нажмите кнопку машины, которая была неудавшейся в течение > **Re-Protect**.
2. В окне **Повторная защита** выберите **Из Azure в локальную среду**.
3. Укажите локальный главный целевой сервер и сервер обработки.
4. В поле **Хранилище данных** выберите главное целевое хранилище данных, для которого нужно восстановить диски локальной среды.
       - Используйте эту опцию, если в ней был удален или не существует в ней, и вам необходимо создать новые диски.
       - Эта настройка игнорируется, если диски уже существуют, но необходимо указать значение.
5. Выберите главный целевой диск для хранения. Политика восстановления размещения выбирается автоматически.
6. Нажмите кнопку **ОК**, чтобы начать процесс повторной защиты. Задание начинает реплицировать Azure VM на место. Ход выполнения операции можно отслеживать на вкладке **Задания** .

> [!NOTE]
> Если вы хотите восстановить виртуальную машину Azure в существующую локальную виртуальную машину, подключите ее хранилище данных локальной виртуальной машины с доступом на чтение и запись к узлу ESXi главного целевого сервера.


## <a name="fail-back-from-azure"></a>Восстановление размещения из Azure

Выполните отработку отказа следующим образом:

1. На странице **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину и выберите пункт **Внеплановая отработка отказа**.
2. На странице **Подтверждение отработки отказа** должно быть указано направление отработки отказа "Из Azure".
3.Выберите точку восстановления, которую вы хотите использовать для неудачи.
    - Мы рекомендуем использовать **последнюю** точку восстановления. Последовательная точка приложения отстает от последней точки времени и приводит к потере некоторых данных.
    - **Последний** является аварийно-последовательной точки восстановления.
    - При отработке отказа служба Site Recovery отключает виртуальные машины Azure и загружает локальную виртуальную машину. Чтобы исключить время простоя, выберите подходящий момент.
4. Щелкните машину правой кнопкой мыши, а затем выберите пункт **Зафиксировать**. Будет запущено задание по удалению виртуальных машин Azure.
5. Убедитесь, что работа виртуальной машины Azure была завершена должным образом.


## <a name="reprotect-on-premises-machines-to-azure"></a>Повторное включение защиты локальных машин в Azure

Теперь данные будут снова находиться на локальном сайте, но они не реплицируются в Azure. Чтобы еще раз выполнить репликацию в Azure, сделайте следующее.

1. В разделе "Хранилище" > **Параметры** >**Реплицированные элементы** выберите виртуальные машины, для которых выполнено восстановление размещения, и щелкните **Защитить повторно**.
2. Выберите сервер обработки, который используется для отправки реплицированных данных в Azure, и нажмите кнопку **ОК**.


## <a name="next-steps"></a>Дальнейшие действия

После завершения задания повторной защиты предплещный VM реплицируется в Azure. При необходимости можно [запустить еще один сбой](site-recovery-failover.md) в Azure.
