---
title: Устранение ошибок и проблем с репликацией из Azure в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Устранение неполадок и ошибок при репликации виртуальных машин Azure для аварийного восстановления
services: site-recovery
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 04/08/2019
ms.author: asgang
ms.openlocfilehash: 4d8ba44cdd5161a1a5ff108837cb57af4cd98835
ms.sourcegitcommit: 18061d0ea18ce2c2ac10652685323c6728fe8d5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/15/2019
ms.locfileid: "69034798"
---
# <a name="troubleshoot-azure-to-azure-vm-replication-issues"></a>Устранение неполадок репликации виртуальных машин из Azure в Azure

В этой статье описаны распространенные проблемы в Azure Site Recovery, которые возникают при репликации и восстановлении виртуальных машин Azure из одного региона в другой, и способы их устранения. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

## <a name="list-of-errors"></a>Список ошибок
- **[Проблемы с квотами ресурсов Azure (код ошибки 150097)](#azure-resource-quota-issues-error-code-150097)**
- **[Доверенные корневые сертификаты (код ошибки 151066)](#trusted-root-certificates-error-code-151066)**
- **[Исходящие подключения для Site Recovery (код ошибки 151195)](#issue-1-failed-to-register-azure-virtual-machine-with-site-recovery-151195-br)**

## <a name="azure-resource-quota-issues-error-code-150097"></a>Проблемы с квотами ресурсов Azure (код ошибки 150097)
Чтобы создать виртуальные машины Azure в целевой области, которую планируется использовать в качестве региона аварийного восстановления, необходимо настроить подписку. Кроме того, подписка должна иметь достаточную квоту для создания виртуальных машин определенного размера. По умолчанию Site Recovery выбирает тот же размер для целевой виртуальной машины, что и для исходной. Если соответствующий размер не поддерживается, автоматически выбирается ближайший возможный. Если подходящий размер, поддерживающий конфигурацию исходной виртуальной машины, отсутствует, появится следующее сообщение об ошибке:

**Код ошибки** | **Возможные причины** | **Рекомендации**
--- | --- | ---
150097<br></br>**Сообщение**. Не удалось включить репликацию для виртуальной машины "Имя ВМ". | — Создание виртуальных машин в расположении целевой области может быть запрещено в идентификаторе подписки.</br></br>— Создание виртуальных машин определенных размеров в расположении целевой области может быть запрещено или не иметь достаточную квоту в идентификаторе подписки.</br></br>— Подходящий размер целевой виртуальной машины, соответствующий количеству сетевых адаптеров исходной виртуальной машины (2), не удалось найти для идентификатора подписки в расположении целевой области.| Сведения о том, как в подписке разрешить создание виртуальных машин необходимых размеров в целевом расположении, см. в статье [Запросы на увеличение квоты ядер Resource Manager](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request). После включения повторите неудавшуюся операцию.

### <a name="fix-the-problem"></a>Устранение проблемы
Чтобы разрешить в подписке создание виртуальных машин необходимых размеров в целевом расположении, можно обратиться [в службу выставления счетов в Azure](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request).

Если целевое расположение имеет ограничение емкости, отключите репликацию и включите его в другом расположении, где подписка имеет достаточную квоту, чтобы создать виртуальные машины нужного размера.

## <a name="trusted-root-certificates-error-code-151066"></a>Доверенные корневые сертификаты (код ошибки 151066)

Если на виртуальной машине отсутствуют новейшие доверенные корневые сертификаты, включение репликации может завершиться ошибкой. Без сертификатов проверка подлинности и авторизация вызовов службы Site Recovery из виртуальной машины завершатся сбоем. Появится сообщение об ошибке для невыполненного задания включения репликации Site Recovery.

**Код ошибки** | **Возможная причина** | **рекомендации**;
--- | --- | ---
151066<br></br>**Сообщение**. Сбой при выполнении настройки Site Recovery. | Необходимые доверенные корневые сертификаты, используемые для авторизации и проверки подлинности, отсутствуют на компьютере. | — На виртуальной машине под управлением Windows должны быть доверенные корневые сертификаты. Дополнительные сведения см. в статье [Настройка доверенных корневых сертификатов и запрещенных сертификатов](https://technet.microsoft.com/library/dn265983.aspx).<br></br>— Для виртуальных машин под управлением Linux следуйте указаниям по доверенным корневым сертификатам, опубликованным распространителем версий операционной системы Linux.

### <a name="fix-the-problem"></a>Устранение проблемы
**Windows**

Установите все последние обновления Windows на виртуальной машине, чтобы на компьютере присутствовали все доверенные корневые сертификаты. При работе в отключенной среде следуйте стандартной процедуре обновления Windows в вашей организации, чтобы получить сертификаты. Если необходимые сертификаты отсутствуют на виртуальной машине, вызовы к службе Site Recovery завершатся ошибкой по соображениям безопасности.

Выполните стандартный для вашей организации процесс управления обновлениями Windows или обновлениями сертификатов, чтобы получить последние корневые сертификаты и обновленный список отзыва сертификатов на виртуальных машинах.

Чтобы убедиться, что проблема устранена, перейдите на веб-сайт login.microsoftonline.com из браузера на виртуальной машине.

**Linux**

Следуйте инструкциям вашего распространителя Linux, чтобы получить последние доверенные корневые сертификаты и обновленный список отзыва сертификатов на виртуальной машине.

Так как SuSE Linux использует символические ссылки, чтобы получить список сертификатов, сделайте следующее.

1.  Войдите как привилегированный пользователь.

2.  Запустите эту команду, чтобы изменить каталог.

      ``# cd /etc/ssl/certs``

1. Проверьте, есть ли на компьютере сертификат, выпущенный корневым центром сертификации Symantec.

      ``# ls VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem``

2. Если такой сертификат не найден, чтобы скачать его, выполните следующую команду. Проверьте его на наличие ошибок, а затем выполните рекомендуемые действия для устранения сетевых сбоев.

      ``# wget https://www.symantec.com/content/dam/symantec/docs/other-resources/verisign-class-3-public-primary-certification-authority-g5-en.pem -O VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem``

3. Проверьте, есть ли на компьютере сертификат, выпущенный корневым центром сертификации Baltimore.

      ``# ls Baltimore_CyberTrust_Root.pem``

4. Если такой сертификат не найден, скачайте его.  

    ``# wget https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt.pem -O Baltimore_CyberTrust_Root.pem``

5. Проверьте, есть ли на компьютере сертификат DigiCert_Global_Root_CA.

    ``# ls DigiCert_Global_Root_CA.pem``

6. Если он не найден, выполните следующую команду, чтобы скачать его.

    ``# wget http://www.digicert.com/CACerts/DigiCertGlobalRootCA.crt``

    ``# openssl x509 -in DigiCertGlobalRootCA.crt -inform der -outform pem -out DigiCert_Global_Root_CA.pem``

7. Чтобы заменить хэши субъектов сертификата для скачанных сертификатов, запустите сценарий смены хэша.

    ``# c_rehash``

8.  Проверьте, были ли созданы для сертификатов хэши субъектов в виде символических ссылок.

    - Command

      ``# ls -l | grep Baltimore``

    - Вывод

      ``lrwxrwxrwx 1 root root   29 Jan  8 09:48 3ad48a91.0 -> Baltimore_CyberTrust_Root.pem
      -rw-r--r-- 1 root root 1303 Jun  5  2014 Baltimore_CyberTrust_Root.pem``

    - Command

      ``# ls -l | grep VeriSign_Class_3_Public_Primary_Certification_Authority_G5``

    - Вывод

      ``-rw-r--r-- 1 root root 1774 Jun  5  2014 VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem
      lrwxrwxrwx 1 root root   62 Jan  8 09:48 facacbc6.0 -> VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem``

    - Command

      ``# ls -l | grep DigiCert_Global_Root``

    - Вывод

      ``lrwxrwxrwx 1 root root   27 Jan  8 09:48 399e7759.0 -> DigiCert_Global_Root_CA.pem
      -rw-r--r-- 1 root root 1380 Jun  5  2014 DigiCert_Global_Root_CA.pem``

9.  Создайте копию файла VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem и замените ее имя на b204d74a.0

    ``# cp VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem b204d74a.0``

10. Создайте копию файла Baltimore_CyberTrust_Root.pem и замените ее имя на 653b494a.0

    ``# cp Baltimore_CyberTrust_Root.pem 653b494a.0``

13. Создайте копию файла DigiCert_Global_Root_CA.pem и замените ее имя на 3513523f.0

    ``# cp DigiCert_Global_Root_CA.pem 3513523f.0``  


14. Убедитесь в наличии файлов.  

    - Command

      ``# ls -l 653b494a.0 b204d74a.0 3513523f.0``

    - Вывод

      ``-rw-r--r-- 1 root root 1774 Jan  8 09:52 3513523f.0
      -rw-r--r-- 1 root root 1303 Jan  8 09:52 653b494a.0
      -rw-r--r-- 1 root root 1774 Jan  8 09:52 b204d74a.0``


## <a name="outbound-connectivity-for-site-recovery-urls-or-ip-ranges-error-code-151037-or-151072"></a>Исходящие подключения для URL-адресов Site Recovery или IP-диапазонов (код ошибки 151037 или 151072)

Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина находится за брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, могут возникнуть следующие проблемы.

### <a name="issue-1-failed-to-register-azure-virtual-machine-with-site-recovery-151195-br"></a>Проблема 1. Не удалось зарегистрировать виртуальную машину Azure в Site Recovery (151195) </br>
- **Возможная причина** </br>
  - Не удается установить подключение к Site Recovery конечным точкам из-за сбоя разрешения DNS.
  - Это чаще наблюдается во время повторной защиты, когда вы выполнили отработку отказа виртуальной машины, но DNS-сервер недоступен из региона аварийного восстановления.

- **Способы устранения:**
   - Если вы используете настраиваемый DNS-сервер, обеспечьте его доступность из региона аварийного восстановления. Чтобы проверить, есть ли у вас настраиваемый DNS-сервер, выберите "Виртуальная машина", затем щелкните сеть аварийного восстановления и выберите "DNS-серверы". Попробуйте получить доступ к DNS-серверу с виртуальной машины. Если он недоступен, обеспечьте его доступность, выполнив отработку отказа DNS-сервера или обеспечив видимость между сетью аварийного восстановления и DNS-сервером.

    ![com-error](./media/azure-to-azure-troubleshoot-errors/custom_dns.png)


### <a name="issue-2-site-recovery-configuration-failed-151196"></a>Проблема 2. Сбой при выполнении настройки Site Recovery (151196)
- **Возможная причина** </br>
  - Не удается подключиться к конечным точкам IP4 удостоверения и проверки подлинности Office 365.

- **Способы устранения:**
  - Обеспечьте доступ Azure Site Recovery для выполнения проверки подлинности диапазонов IP-адресов Office 365.
    Если вы используете правила группы безопасности сети Azure (NSG) или прокси-сервер брандмауэра для управления исходящим сетевым подключением на виртуальной машине, разрешите обмен данными с диапазонами IP-адресов Office 365. Создайте [тег службы AAD](../virtual-network/security-overview.md#service-tags) на основе правила NSG, чтобы разрешить доступ ко всем IP-адресам, соответствующим AAD.
      - При добавлении новых адресов в AAD необходимо создать новые правила NSG.

> [!NOTE]
> Если виртуальные машины находятся за **стандартным** внутренним подсистемой балансировки нагрузки, у нее не будет доступа к IP-адресам O365, т. е. login.microsoftonline.com по умолчанию. Либо измените его на **базовый** тип внутренней подсистемы балансировки нагрузки, либо создайте доступ с ограниченным доступом, как описано в [статье](https://aka.ms/lboutboundrulescli).

### <a name="issue-3-site-recovery-configuration-failed-151197"></a>Проблема 3. Сбой при выполнении настройки Site Recovery (151197)
- **Возможная причина** </br>
  - Не удается подключиться к конечным точкам службы Azure Site Recovery.

- **Способы устранения:**
  - Обеспечение доступа Azure Site Recovery к [диапазонам IP-адресов Site Recovery](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#outbound-connectivity-for-ip-address-ranges) зависит от региона. Обеспечьте доступ к нужным диапазонам IP-адресов с виртуальной машины.


### <a name="issue-4-a2a-replication-failed-when-the-network-traffic-goes-through-on-premises-proxy-server-151072"></a>Проблема 4. Не удалось выполнить репликацию A2A, если сетевой трафик проходит через локальный прокси-сервер (151072)
- **Возможная причина** </br>
  - Недопустимые параметры настраиваемого прокси-сервера, Azure Site Recovery агент службы мобильности не обнаружил параметры прокси-сервера в IE автоматически


- **Способы устранения:**
  1. Агент службы Mobility Service обнаруживает настройки прокси-сервера из Internet Explorer в ОС Windows и в каталоге /etc/environment в ОС Linux.
  2. Если вы предпочитаете настроить прокси-сервер только для Azure Site Recovery службы Mobility Service, вы можете указать сведения о прокси-сервере в файле Проксинфо. conf, расположенном по адресу:</br>
     - ``/usr/local/InMage/config/`` в ***Linux***
     - ``C:\ProgramData\Microsoft Azure Site Recovery\Config`` в ***Windows***
  3. Файл ProxyInfo.conf должен содержать параметры прокси-сервера в таком формате INI.</br>
                *[proxy]*</br>
                *Address=http://1.2.3.4*</br>
                *Port=567*</br>
  4. Azure Site Recovery агент службы Mobility Service поддерживает только ***прокси-серверы без проверки***подлинности.


### <a name="fix-the-problem"></a>Устранение проблемы
Чтобы разрешить [необходимые URL-адреса](azure-to-azure-about-networking.md#outbound-connectivity-for-urls) или [диапазоны IP-](azure-to-azure-about-networking.md#outbound-connectivity-for-ip-address-ranges)адресов, выполните действия, описанные в [документе Руководство](site-recovery-azure-to-azure-networking-guidance.md)по работе с сетями.

## <a name="disk-not-found-in-the-machine-error-code-150039"></a>На компьютере не найден диск (код ошибки 150039)

Необходимо инициализировать новый диск, подключенный к виртуальной машине.

**Код ошибки** | **Возможные причины** | **рекомендации**;
--- | --- | ---
150039<br></br>**Сообщение**. Диск данных Azure (имя_диска) (URI_диска) с логическим номером устройства (LUN) (значение_LUN) не был сопоставлен с соответствующим диском из виртуальной машины, о котором сообщается, что он имеет то же значение LUN. | Новый диск с данными был подключен к виртуальной машине, но не был инициализирован.</br></br>Диск с данными в виртуальной машине неправильно сообщает значение LUN, с использованием которого он был подключен к виртуальной машине.| Убедитесь, что диски с данными инициализированы, а затем повторите операцию.</br></br>Для Windows: [Подключение управляемого диска данных к виртуальной машине Windows с помощью портала Azure](https://docs.microsoft.com/azure/virtual-machines/windows/attach-managed-disk-portal).</br></br>Для Linux: [Добавление диска к виртуальной машине Linux](https://docs.microsoft.com/azure/virtual-machines/linux/add-disk).

### <a name="fix-the-problem"></a>Устранение проблемы
Убедитесь, что диски с данными инициализированы, а затем повторите операцию.

- Для Windows: [Подключение управляемого диска данных к виртуальной машине Windows с помощью портала Azure](https://docs.microsoft.com/azure/virtual-machines/windows/attach-managed-disk-portal).
- Для Linux: [добавьте новый диск данных в Linux](https://docs.microsoft.com/azure/virtual-machines/linux/add-disk).

Если проблема не исчезнет, обратитесь в службу поддержки.

## <a name="one-or-more-disks-are-available-for-protectionerror-code-153039"></a>Один или несколько дисков доступны для защиты (код ошибки 153039).
- **Возможная причина** </br>
  - Если один или несколько дисков были недавно добавлены на виртуальную машину после защиты. 
  - Если один или несколько дисков были инициализированы позже после защиты виртуальной машины.

### <a name="fix-the-problem"></a>Устранение проблемы
Можно либо выбрать защиту дисков, либо пропустить предупреждение, чтобы снова сделать состояние репликации виртуальной машины работоспособным.</br>
1. Для защиты дисков. Перейдите к разделу реплицированные элементы > диски > виртуальных машин > щелкните незащищенный диск > включить репликацию.
 ![add_disks](./media/azure-to-azure-troubleshoot-errors/add-disk.png)
2. , Чтобы закрыть предупреждение. Перейдите в раздел реплицированные элементы > виртуальной машины > нажмите кнопку Закрыть оповещение в разделе Обзор.
![dismiss_warning](./media/azure-to-azure-troubleshoot-errors/dismiss-warning.png)


## <a name="remove-the-virtual-machine-from-the-vault-completed-with-information--error-code-150225"></a>Удаление виртуальной машины из хранилища завершена со сведениями (код ошибки 150225)
Во время защиты виртуальной машины Azure Site Recovery создает несколько ссылок на исходную виртуальную машину. При удалении защиты или отключении репликации Azure Site Recovery удалить эти ссылки как часть задания очистки. Если виртуальная машина имеет блокировку ресурсов, задание завершается с помощью сведений. Это говорит о том, что виртуальная машина была удалена из хранилища служб восстановления, но не удалось очистить некоторые устаревшие связи с исходного компьютера.

Это предупреждение можно проигнорировать, если вы никогда не планируете защищать эту виртуальную машину в будущем. Тем не менее, если вы хотите защитить эту виртуальную машину позже, необходимо удалить ссылки, как описано в следующих шагах. 

**Если вы не выполняете очистку, сделайте следующее:**

1.  Во время включения репликации с помощью хранилища служб восстановления виртуальная машина не будет отображаться в списке. 
2.  Если вы попытаетесь защитить ВИРТУАЛЬную машину с помощью **параметров > виртуальной машины > аварийное восстановление** , это приведет к ошибке "*не удается включить репликацию из-за имеющихся устаревших ссылок на виртуальную машину*".


### <a name="fix-the-problem"></a>Устранение проблемы

>[!NOTE]
>
>Azure Site Recovery не удаляет исходную виртуальную машину или повлияет на нее каким бы то ни было при выполнении действий ниже.
>

1. Удалите блокировку виртуальной машины или группы ресурсов виртуальной машины. Пример: Имя виртуальной машины "Моведемо" содержит блокировку ресурса, которую необходимо удалить.

   ![Network_Selection_greyed_out](./media/site-recovery-azure-to-azure-troubleshoot/vm-locks.png)
2. Скачать скрипт [Удалить устаревшую конфигурацию Azure Site Recovery](https://github.com/AsrOneSdk/published-scripts/blob/master/Cleanup-Stale-ASR-Config-Azure-VM.ps1).
3. Выполните скрипт *клеануп-стале-АСР-конфиг-Азуре-ВМ. ps1*.
4. Укажите идентификатор подписки, группу ресурсов виртуальной машины и имя виртуальной машины в качестве параметра.
5. При запросе учетных данных Azure укажите это и убедитесь, что сценарий выполняется без сбоев. 


## <a name="replication-cannot-be-enabled-because-of-the-existing-stale-resource-links-on-the-vm-error-code-150226"></a>Невозможно включить репликацию из-за наличия устаревших ссылок на ресурсы на виртуальной машине (код ошибки 150226).

**Причина. Конфигурация виртуальной машины устарела после предыдущей защиты Site Recovery**

Устаревшая конфигурация может остаться на виртуальной машине Azure в следующих случаях:

- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем отключите репликацию, но **исходная виртуальная машина была заблокирована ресурсом**.
- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем удалили хранилище Site Recovery без явного отключения репликации на виртуальной машине.
- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем удалили группу ресурсов, содержащую хранилище Site Recovery, без явного отключения репликации на виртуальной машине.

### <a name="fix-the-problem"></a>Устранение проблемы

>[!NOTE]
>
>Azure Site Recovery не удаляет исходную виртуальную машину или повлияет на нее каким бы то ни было при выполнении действий ниже.


1. Удалите блокировку виртуальной машины или группы ресурсов виртуальной машины, если она есть. *Например:* Имя виртуальной машины "Моведемо" содержит блокировку ресурса, которую необходимо удалить.
   
   ![Network_Selection_greyed_out](./media/site-recovery-azure-to-azure-troubleshoot/vm-locks.png)
2. Скачать скрипт [Удалить устаревшую конфигурацию Azure Site Recovery](https://github.com/AsrOneSdk/published-scripts/blob/master/Cleanup-Stale-ASR-Config-Azure-VM.ps1).
3. Выполните скрипт *клеануп-стале-АСР-конфиг-Азуре-ВМ. ps1*.
4. Укажите идентификатор подписки, группу ресурсов виртуальной машины и имя виртуальной машины в качестве параметра.
5. При запросе учетных данных Azure укажите это и убедитесь, что сценарий выполняется без сбоев.  

## <a name="unable-to-see-the-azure-vm-or-resource-group--for-selection-in-enable-replication"></a>Не удается просмотреть виртуальную машину или группу ресурсов Azure для выбора в разделе "включить репликацию".

 **Причина 1.  Группа ресурсов и исходная виртуальная машина находятся в разных расположениях**
 
Azure Site Recovery в настоящее время требует, чтобы группа ресурсов исходного региона и виртуальные машины находящегося в одном расположении. Если это не так, вы не сможете найти виртуальную машину или группу ресурсов во время защиты. 

В **качестве обходного решения**можно включить репликацию из виртуальной машины, а не из хранилища служб восстановления. Перейдите в раздел исходные виртуальные машины > Свойства > аварийное восстановление и включите репликацию.

**Причина 2. Группа ресурсов не находится в выбранной подписке**

Вы не сможете найти группу ресурсов во время применения защиты, если она не является частью данной подписки. Убедитесь, что группе ресурсов входит в выбранную подписку.

 **Причина 3. Устаревшая конфигурация**
 
Причиной того, что виртуальная машина, которую нужно включить для репликации, не отображается, может быть устаревшая конфигурация Site Recovery на виртуальной машине Azure. Устаревшая конфигурация может остаться на виртуальной машине Azure в следующих случаях:

- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем удалили хранилище Site Recovery без явного отключения репликации на виртуальной машине.
- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем удалили группу ресурсов, содержащую хранилище Site Recovery, без явного отключения репликации на виртуальной машине.

- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем отключите репликацию, но исходная виртуальная машина была заблокирована ресурсом.

### <a name="fix-the-problem"></a>Устранение проблемы

> [!NOTE]
>
> Обновите модуль AzureRM.Resources перед использованием упомянутого ниже скрипта. Azure Site Recovery не удаляет исходную виртуальную машину или повлияет на нее каким бы то ни было при выполнении действий ниже.
>

1. Удалите блокировку виртуальной машины или группы ресурсов виртуальной машины, если она есть. *Например:* Имя виртуальной машины "Моведемо" содержит блокировку ресурса, которую необходимо удалить.

   ![Network_Selection_greyed_out](./media/site-recovery-azure-to-azure-troubleshoot/vm-locks.png)
2. Скачать скрипт [Удалить устаревшую конфигурацию](https://github.com/AsrOneSdk/published-scripts/blob/master/Cleanup-Stale-ASR-Config-Azure-VM.ps1).
3. Выполните скрипт *клеануп-стале-АСР-конфиг-Азуре-ВМ. ps1*.
4. Укажите идентификатор подписки, группу ресурсов виртуальной машины и имя виртуальной машины в качестве параметра.
5. При запросе учетных данных Azure укажите это и убедитесь, что сценарий выполняется без сбоев.

## <a name="unable-to-select-virtual-machine-for-protection"></a>Не удалось выбрать виртуальную машину для защиты
 **Причина 1.  На виртуальной машине установлены расширения, в которых произошел сбой или которые не отвечают на запросы** <br>
 Выберите "Виртуальные машины" > "Параметры" > "Расширения" и проверьте наличие расширений в состоянии сбоя. Удалите расширение в состоянии сбоя и повторите попытку применить защиту к виртуальной машине.<br>
 **Причина 2.  [Недопустимое состояние подготовки виртуальной машины](#vms-provisioning-state-is-not-valid-error-code-150019)**

## <a name="vms-provisioning-state-is-not-valid-error-code-150019"></a>Недопустимое состояние подготовки виртуальной машины (код ошибки 150019)

Чтобы включить репликацию на виртуальной машине, должно отображаться состояние подготовки **Успешно**. Чтобы проверить состояние виртуальной машины, выполните следующие действия.

1.  На портале Azure в разделе **Все службы** выберите **Обозреватель ресурсов**.
2.  Разверните список **Подписки** и выберите нужную подписку.
3.  Разверните список **ResourceGroups** и выберите группу ресурсов, к которой относится виртуальная машина.
4.  Разверните список **ресурсов** и выберите виртуальную машину.
5.  Проверьте значение в поле **provisioningState** в представлении экземпляра справа.

### <a name="fix-the-problem"></a>Устранение проблемы

- Если в поле **provisioningState** отображается значение **Сбой**, обратитесь в службу поддержки и предоставьте необходимые сведения для устранения проблемы.
- Если в поле **provisioningState** отображается значение **Обновление**, возможно, началось развертывание другого расширения. Проверьте, выполняются ли на виртуальной машине какие-либо операции, дождитесь их завершения и еще раз попытайтесь выполнить задание **Включить репликацию**.

## <a name="unable-to-select-target-virtual-network---network-selection-tab-is-grayed-out"></a>Невозможно выбрать целевую виртуальную сеть. Вкладка выбора сети неактивна.

**Причина 1. Если виртуальная машина подключена к сети, которая уже сопоставлена с целевой сетью.**
- Если исходная виртуальная машина является частью виртуальной сети, а другая виртуальная машина из той же виртуальной сети уже сопоставлена с сетью в целевой группе ресурсов, то выбор сети из раскрывающегося списка будет отключен по умолчанию.

![Network_Selection_greyed_out](./media/site-recovery-azure-to-azure-troubleshoot/unabletoselectnw.png)

**Причина 2. Если в виртуальной машине, которая ранее была защищена с помощью Azure Site Recovery, была отключена репликация.**
 - При отключении репликации виртуальной машины сетевое сопоставление не удаляется. Его необходимо удалить из хранилища службы восстановления, где находилась защищенная виртуальная машина. </br>
 Перейдите в Хранилище служб восстановления > Инфраструктура Site Recovery > Сетевое сопоставление. </br>
 ![Delete_NW_Mapping](./media/site-recovery-azure-to-azure-troubleshoot/delete_nw_mapping.png)
 - Целевая сеть, настроенная во время установки аварийного восстановления, может быть изменена после первоначальной настройки защиты виртуальной машины. </br>
 ![Modify_NW_mapping](./media/site-recovery-azure-to-azure-troubleshoot/modify_nw_mapping.png)
 - Обратите внимание, что изменение сетевого отображения влияет на все защищенные виртуальные машины, которые используют указанное сетевое сопоставление.


## <a name="comvolume-shadow-copy-service-error-error-code-151025"></a>Ошибка модели COM+ или службы теневого копирования томов (код ошибки — 151025)

**Код ошибки** | **Возможные причины** | **рекомендации**;
--- | --- | ---
151025<br></br>**Сообщение**. Не удалось установить расширение Site Recovery | - Служба системных приложений COM+ отключена.</br></br>- Отключена служба теневого копирования томов (VSS).| Настройте службу системных приложений COM+ и службу теневого копирования томов для автоматического режима запуска или запуска вручную.

### <a name="fix-the-problem"></a>Устранение проблемы

Вы можете открыть консоль "Службы" и проверить, не задано ли для типа запуска службы системных приложений COM+ и службы теневого копирования томов значение "Отключено".
  ![com-error](./media/azure-to-azure-troubleshoot-errors/com-error.png)

## <a name="unsupported-managed-disk-size-error-code-150172"></a>Неподдерживаемый размер управляемого диска (код ошибки 150172)


**Код ошибки** | **Возможные причины** | **рекомендации**;
--- | --- | ---
150172<br></br>**Сообщение**. Не удалось включить защиту для виртуальной машины, так как ее диск (имя_диска) имеет размер (размер_диска), который меньше минимального поддерживаемого размера, равного 1024 МБ. | Размер диска меньше поддерживаемого размера, равного 1024 МБ| Убедитесь, что размеры дисков находятся в диапазоне поддерживаемых размеров, и повторите операцию.

## <a name="enable-protection-failed-as-device-name-mentioned-in-the-grub-configuration-instead-of-uuid-error-code-151126"></a>Включение защити завершилось сбоем, поскольку имя устройства, указанное в конфигурации GRUB вместо UUID (код ошибки 151126)

**Возможная причина:** </br>
Файлы конфигурации GRUB ("/boot/grub/menu.lst", "/boot/grub/grub.cfg", "/boot/grub2/grub.cfg" или "/ etc / default / grub") могут содержать значение для параметров **root** и **resume** в качестве фактических имен устройств вместо UUID. Site Recovery требует наличие подхода UUID, поскольку имя устройства может меняться при перезагрузке виртуальной машины, а виртуальная машина может не выдавать одно и то же имя при сбое, что приводит к ошибкам. Пример: </br>


- Следующая строка из файла GRUB **/boot/grub2/grub.cfg**. <br>
  *linux   /boot/vmlinuz-3.12.49-11-default **root=/dev/sda2**  ${extra_cmdline} **resume=/dev/sda1** splash=silent quiet showopts*


- Следующая строка из файла GRUB **/boot/grub/menu.lst**
  *kernel /boot/vmlinuz-3.0.101-63-default **root=/dev/sda2** **resume=/dev/sda1** splash=silent crashkernel=256M-:128M showopts vga=0x314*

Если вы заметили строки, выделенные полужирным шрифтом, GRUB содержит фактические имена устройств для параметров "root" и "resume" вместо UUID.

**Как исправить:**<br>
Имена устройств должны быть заменены на соответствующий UUID.<br>


1. Найдите UUID устройства, выполнив команду "blkid \<Device Name >". Пример:<br>
   ```
   blkid /dev/sda1
   ```<br>
   ```/dev/sda1: UUID="6f614b44-433b-431b-9ca1-4dd2f6f74f6b" TYPE="swap" ```<br>
   ```blkid /dev/sda2```<br>
   ```/dev/sda2: UUID="62927e85-f7ba-40bc-9993-cc1feeb191e4" TYPE="ext3"
   ```<br>
   ```



1. Теперь замените имя устройства UUID в формате "root = UUID =\<UUID >". Например, если заменить имя устройства на UUID для параметров "root" и "resume" в файле "/boot/grub2/grub.cfg", "/boot/grub2/grub.cfg" или "/etc/default/grub, строки в файлах будут выглядеть следующим образом. <br>
   *kernel /boot/vmlinuz-3.0.101-63-default **root=UUID=62927e85-f7ba-40bc-9993-cc1feeb191e4** **resume=UUID=6f614b44-433b-431b-9ca1-4dd2f6f74f6b** splash=silent crashkernel=256M-:128M showopts vga=0x314*
1. Перезапустите службу защиты еще раз.

## <a name="enable-protection-failed-as-device-mentioned-in-the-grub-configuration-doesnt-existerror-code-151124"></a>Не удалось включить защиту, так как устройство, указанное в конфигурации GRUB, не существует (код ошибки 151124)
**Возможная причина:** </br>
Файлы конфигурации GRUB ("/Boot/GRUB/menu.lst", "/Бут/груб/груб.КФГ", "/Boot/grub2/GRUB.cfg" или "/etc/default/grub") могут содержать параметры "rd.lvm.lv" или "rd_LVM_LV", указывающие на устройство LVM, которое должно быть обнаружено во время загрузки. Если эти устройства LVM не существуют, то защищенная система не загрузится и не будет зависнуть в процессе загрузки. Эта виртуальная машина отработки отказа будет рассматриваться даже одинаково. Ниже приведены некоторые примеры.

Несколько примеров: </br>

1. Следующая строка находится в файле GRUB **"/Boot/grub2/GRUB.cfg"** на RHEL7. </br>
   *linux16/vmlinuz-3.10.0-957.el7.x86_64 root =/dev/Mapper/rhel_mup--rhel7u6-root ro crashkernel = 128M\@64M **Rd. LVM. Латвия = рутвг/root Rd. LVM. Латвия = рутвг/swap** рхгб quiet lang = en_US. UTF-8*</br>
   В этой области показано, что GRUB должен обнаружить два LVM устройства с именами **"root"** и **"Swap"** из группы томов "рутвг".
1. Следующая строка находится в файле GRUB **"/etc/default/grub"** на RHEL7 </br>
   *GRUB_CMDLINE_LINUX = "crashkernel = автоматический **Rd. LVM. lv = рутвг/корневой Rd. LVM. Латвия = рутвг/swap** рхгб quiet"*</br>
   В этой области показано, что GRUB должен обнаружить два LVM устройства с именами **"root"** и **"Swap"** из группы томов "рутвг".
1. Следующая строка находится в файле GRUB **"/Boot/GRUB/menu.lst"** на RHEL6 </br>
   *ядро/vmlinuz-2.6.32-754.el6.x86_64 ro root = UUID = 36dd8b45-e90d-40d6-81ac-ad0d0725d69e rd_NO_LUKS LANG = en_US. UTF-8 rd_NO_MD СИСФОНТ = латарцирхеб-sun16 crashkernel = Auto rd_LVM_LV = рутвг/lv_root КЭЙБОАРДТИПЕ = PC КЭЙТАБЛЕ = US rd_LVM_LV = рутвг/lv_swap rd_NO_DM рхгб quiet* </br>
   В этой области показано, что GRUB должен обнаружить два LVM устройства с именами **"root"** и **"Swap"** из группы томов "рутвг".<br>

**Как исправить:**<br>

Если устройство LVM не существует, исправьте его, создав его или удалив параметр для того же файла конфигурации GRUB, а затем повторите попытку включить защиту. </br>

## <a name="site-recovery-mobility-service-update-completed-with-warnings--error-code-151083"></a>Обновление Site Recovery Mobility Service завершено с предупреждениями (код ошибки 151083)
Служба мобильности Site Recovery состоит из множества компонентов, один из которых — драйвер-фильтр. Драйвер-фильтр загружаться в системную память только во время перезагрузки системы. При наличии Site Recovery обновлений службы Mobility Service с изменениями драйверов фильтров мы обновляем компьютер, но при этом выдается предупреждение о том, что некоторые исправления нуждаются в перезагрузке. Это означает, что исправления драйвера фильтра могут быть реализованы только при загрузке нового драйвера фильтра, который может происходить только во время перезагрузки системы.<br>
**Обратите внимание** , что это просто предупреждение, и существующая репликация продолжает работать даже после нового обновления агента. Вы можете перезагрузить систему в любое время, когда необходимо воспользоваться преимуществами нового драйвер-фильтра. Но если не перезагрузить систему, продолжит работать старый драйвер-фильтр. Помимо драйвера фильтра, **преимущества любых других усовершенствований и исправлений в службе Mobility Service реализованы без перезагрузки при обновлении агента.**  


## <a name="protection-couldnt-be-enabled-as-replica-managed-disk-diskname-replica-already-exists-without-expected-tags-in-the-target-resource-group-error-code-150161"></a>Не удалось включить защиту, так как управляемый диск реплики "diskname-Replica" уже существует без ожидаемых тегов в Целевой группе ресурсов (код ошибки 150161

**Причина.** Это может произойти, если виртуальная машина была защищена ранее в прошлом и во время отключения репликации диск реплики не был очищен по какой-либо причине.</br>
**Как исправить:** Удалите упомянутый диск реплики в сообщении об ошибке и снова перезапустите задание защиты от сбоев.

## <a name="next-steps"></a>Следующие шаги
[Репликация виртуальных машин Azure](site-recovery-replicate-azure-to-azure.md)
