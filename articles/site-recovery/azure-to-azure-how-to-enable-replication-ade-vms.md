---
title: Включить репликацию для зашифрованных VMs Azure в восстановлении сайта Azure
description: В этой статье описывается, как настроить репликацию для использующих шифрование дисков Azure с поддержкой VMs из одного региона Azure в другой с помощью восстановления сайта.
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 08/08/2019
ms.author: sutalasi
ms.openlocfilehash: 2bbb02df782439d934e96e7c16f28b9c11cc01fe
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81408635"
---
# <a name="replicate-azure-disk-encryption-enabled-virtual-machines-to-another-azure-region"></a>Повторите виртуальные компьютеры с поддержкой azure Disk с поддержкой другого региона Azure

В этой статье описывается, как воспроизвести MMS Azure с включенным шифрованием azure Disk (ADE) из одного региона Azure в другой.

>[!NOTE]
> Восстановление сайта в настоящее время поддерживает ADE, с и без Azure Active Directory (AAD) для vMs под управлением операционных систем Windows. Для операционных систем Linux мы поддерживаем ADE только без AAD. Кроме того, для машин под управлением ADE 1.1 (без AAD) vMs должны использовать управляемые диски. VMs с неуправляемыми дисками не поддерживаются. При переключении с ADE 0.1 (с AAD) на 1.1 необходимо отключить репликацию и включить репликацию для VM после включения 1.1.


## <a name="required-user-permissions"></a><a id="required-user-permissions"></a>Необходимые разрешения пользователя
Восстановление сайта требует от пользователя иметь разрешения на создание хранилища ключей в целевом регионе и копирование ключей из хранилища ключей региона исходного кода в хранилище ключей целевого региона.

Для воспроизведения vMs-технологий с поддержкой шифрования дисков с портала Azure пользователю нужны следующие разрешения как в **области исходного кода,** так и в хранилищах ключей целевого региона.

- Разрешения по отношению к хранилищу ключей:
    - Перечислите, создайте и получите
    
- Разрешения по отношению к секретам хранилища ключей:
    - Секретные операции по управлению
        - Получить, перечислить и установить
    
- Разрешения ключей хранилища ключей (требуется только в том случае, если вдыхают ключ шифрования ключей для шифрования ключей шифрования диска)
    - Ключевые операции по управлению
        - Получить, перечислить и создать
    - Криптографические операции
        - Расшифровка и шифрование

Чтобы управлять разрешениями, перейдите на ресурс хранилища ключей на портале. Добавьте необходимые разрешения для пользователя. В следующем примере показано, как включить разрешения на хранилище ключей *ContosoWeb2Keyvault,* которое находится в исходной области.

1. Перейти к **Главная** > **Keyvaults** > **ContosoWeb2KeyVault > политики доступа.**

   ![Окно разрешений хранилища ключей](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)

2. Вы можете видеть, что нет никаких разрешений пользователя. Нажмите кнопку **Добавить**. Введите информацию о пользователе и разрешениях.

   ![Разрешения Keyvault](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

Если пользователь, разместивший аварийное восстановление (DR), не имеет разрешений на копирование ключей, администратор безопасности, имеющий соответствующие разрешения, может использовать следующий скрипт для копирования секретов шифрования и ключей в целевой регион.

Чтобы устранить неполадки, обратитесь к [вопросам разрешения хранилища ключей](#trusted-root-certificates-error-code-151066) позже в этой статье.

>[!NOTE]
>Для воспроизведения vMs-проектов с поддержкой дискового шифрования с портала необходимо, по крайней мере, разрешения "Список" на хранилищах, секретах и ключах ключей.

## <a name="copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script"></a>Копирование ключей шифрования диска в регионе DR с помощью скрипта PowerShell

1. [Откройте необработанный скриптовый код "CopyKeys".](https://aka.ms/ade-asr-copy-keys-code)
2. Копируйте скрипт в файл и назовите его **Copy-keys.ps1**.
3. Откройте приложение Windows PowerShell и перейдите в папку, где вы сохранили файл.
4. Выполнить Copy-keys.ps1.
5. Предоставьте учетные данные Azure для входинийной системы.
6. Выберите **подписку Azure**, к которой относятся виртуальные машины.
7. Подождите загрузку групп ресурсов, а затем выберите **группу ресурсов** ваших вс-президентов.
8. Выберите vMs из отображаемого списка. В списке только всасываемые для шифрования дисков только vMs.
9. Выберите **месторасположение цели.**

    - **Хранилища ключей шифрования дисков**
    - **Хранилища ключей шифрования**

   По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. Название хранилища имеет суффикс "asr", основанный на исходных клавишах шифрования диска VM. Если хранилище ключей уже существует, созданное восстановлением сайта, оно используется повторно. При необходимости выберите другое хранилище ключей из списка.

## <a name="enable-replication"></a>Включение репликации

В этом примере основным регионом Лазурного региона является Восточная Азия, а вторичным регионом — юго-восточная Азия.

1. В хранилище выберите **«Replicate**.
2. Обратите внимание на следующие поля.
    - **Источник** — источник происхождения виртуальных машин, в этом случае это **Azure**.
    - **Месторасположено исходное местоположение**: Область Azure, где требуется защитить свои виртуальные машины. Для этого примера местои исходное местоположение — «Восточная Азия».
    - **Модель развертывания**: Модель развертывания Azure исходных машин.
    - **Исходная подписка**: подписка, к которой принадлежат исходные виртуальные машины. Это может быть любая подписка, которая в том же клиенте Active Directory Azure, что и хранилище служб восстановления.
    - **Группа ресурсов** — группа ресурсов, к которой принадлежат исходные виртуальные машины. Все ВМ в выбранной группе ресурсов перечислены для защиты на следующем этапе.

3. В **виртуальных машинах** > **Выберите виртуальные машины,** выберите каждый VM, который вы хотите воспроизвести. Можно выбрать только те компьютеры, для которых можно включить репликацию. Затем выберите **OK**.

4. В **настройках**можно настроить следующие настройки целевого сайта.

    - **Целевое местоположение**: Местоположение, где ваши исходные виртуальные данные машины будут реплицироваться. Восстановление сайта предоставляет список подходящих целевых регионов на основе местоположения выбранной машины. Мы рекомендуем использовать то же место, что и местоположение хранилища служб восстановления.
    - **Целевая подписка**: Целевая подписка, используемая для аварийного восстановления. По умолчанию целевая подписка совпадает с исходной подпиской.
    - **Целевая группа ресурсов**. Группа ресурсов, в которой будут находиться все реплицированные виртуальные машины. По умолчанию восстановление сайта создает новую группу ресурсов в целевом регионе. Название получает суффикс "аср". Если группа ресурсов уже существует, созданная восстановлением сайта Azure, она используется повторно. Вы также можете настроить его, как показано в следующем разделе. Местоположение целевой группы ресурсов может быть любым регионом Azure, за исключением региона, где размещаются виртуальные машины-источники.
    - **Целевая виртуальная сеть:** По умолчанию восстановление сайта создает новую виртуальную сеть в целевом регионе. Название получает суффикс "аср". Он отображается в исходной сети и используется для любой защиты в будущем. [Узнайте больше](site-recovery-network-mapping-azure-to-azure.md) о сетевом сопоставлении.
    - **Учетные записи целевых хранилищ (если ваш источник VM не использует управляемые диски)**: По умолчанию Восстановление сайта создает новую учетную запись целевого хранилища, имитируя вашу конфигурацию хранения VM источника. Если учетная запись хранилища уже существует, она используется повторно.
    - **Реплика управляемых дисков (если ваш источник VM использует управляемые диски)**: Восстановление сайта создает новые диски, управляемые репликами в целевой области, чтобы отразить управляемые диски источника VM того же типа хранилища (стандартный или премиум) в качестве исходного vM управляемых дисков.
    - **Учетные записи хранения кэша:** Восстановление сайта нуждается в дополнительной учетной записи хранения, называемой *хранилищем кэша* в исходной области. Все изменения на исходных ВМ отслеживаются и отправляются в учетную запись хранения кэша. Затем они реплицируются в целевое место.
    - **Набор доступности**: По умолчанию восстановление сайта создает новый набор доступности в целевом регионе. Название имеет суффикс "asr". Если набор доступности, созданный восстановлением сайта, уже существует, он используется повторно.
    - **Хранилища ключей шифрования диска:** По умолчанию восстановление сайта создает новое хранилище ключей в целевом регионе. Он имеет суффикс "asr", который основан на исходных клавишх шифрования диска VM. Если хранилище ключей, созданное восстановлением сайта Azure, уже существует, оно используется повторно.
    - **Хранилища ключей для шифрования ключей**. По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. Название имеет суффикс "asr", основанный на исходных ключах шифрования ключей VM. Если хранилище ключей, созданное восстановлением сайта Azure, уже существует, оно используется повторно.
    - **Политика репликации**: Определяет настройки истории хранения моментов восстановления и частоту моментального снимка, согласованную с приложением. По умолчанию восстановление сайта создает новую политику репликации с настройками *24 часов* для удержания точки восстановления и *60 минут* для частоты снимка приложения.

## <a name="customize-target-resources"></a>Настройка целевых ресурсов

Выполните следующие действия, чтобы изменить параметры целевого этапа восстановления сайта по умолчанию.

1. Выберите **настроить** рядом с "Целевой подпиской", чтобы изменить целевую подписку по умолчанию. Выберите подписку из списка подписок, доступных в агоне Азуре.

2. Выберите **настроить** рядом с "Ресурсная группа, сеть, хранение и доступность наборы", чтобы изменить следующие настройки по умолчанию:
    - Для **целевой группы ресурсов**выберите группу ресурсов из списка групп ресурсов в целевом местоположении подписки.
    - Для **целевой виртуальной сети**выберите сеть из списка виртуальных сетей в целевом местоположении.
    - Для **набора доступности**можно добавить настройки набора доступности в VM, если они являются частью набора доступности в регионе исходного кода.
    - Для **учетных записей целевого хранения**выберите учетную запись для использования.

2. Выберите **настроить** рядом с "Настройками шифрования", чтобы изменить следующие настройки по умолчанию:
   - Для **хранилища ключей шифрования диска Target**, выберите хранилище ключей шифрования диска-цели из списка сводов ключей в целевом месте подписки.
   - Для **хранилища ключей шифрования key Target**выберите хранилище ключей шифрования целевого ключа из списка хранилищ ключей в целевом месте подписки.

3. Выберите **Создание целевого ресурса** > **Включить репликацию.**
4. После включения в систему репликации ВМ можно проверить состояние работоспособности вс-миноностов под **реплицированными элементами.**

>[!NOTE]
>При первоначальном репликации обновление состояния может занять некоторое время без видимого прогресса. Нажмите **Refresh,** чтобы получить последний статус.

## <a name="update-target-vm-encryption-settings"></a>Обновление параметров шифрования целевой виртуальной машины
В следующих сценариях необходимо обновить настройки целевого шифрования VM:
  - Вы включили репликацию восстановления сайта на VM. Позже вы включили шифрование диска на источнике VM.
  - Вы включили репликацию восстановления сайта на VM. Позже вы изменили ключ шифрования диска или ключ шифрования на источнике VM.

Скрипт [a script](#copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script) можно использовать для копирования ключей шифрования в целевой области, а затем обновить настройки целевого шифрования в **хранилище** > услуг восстановления*реплицированных элементов* > **Properties** > **Compute и Network.**

![Обновление окна диалогов ADE](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a name="troubleshoot-key-vault-permission-issues-during--azure-to-azure-vm-replication"></a><a id="trusted-root-certificates-error-code-151066"></a>Проблема разрешения хранилища проблем с устранением проблем с ключом во время репликации VM Azure-to-Azure

Восстановление сайта Azure требует, по крайней мере, считывания разрешения на хранилище ключей области Исходного кода и записи разрешения на хранилище ключей целевого региона для чтения секрета и копирования в хранилище ключей целевого региона. 

**Причина 1:** У вас нет разрешения "GET" на **хранилище ключей исходного региона** для чтения ключей. </br>
**Как исправить:** Независимо от того, являетесь ли вы админ-амин подписки или нет, важно, чтобы у вас было разрешение на хранилище ключей.

1. Перейдите к исходной области Ключевое хранилище, которое в данном примере является "ContososourceKeyvault" > **политикдоступа** 
2. Под **Select Principal** добавить имяdradmin@contoso.comпользователя, например: "
3. При **ключевых разрешениях** выберите GET 
4. Под **секретным разрешением** выберите GET 
5. Сохранение политики доступа

**Причина 2:** Для записи ключей в **области целевого** значения у вас нет необходимого разрешения. </br>

*Например:* Вы пытаетесь воспроизвести VM, который имеет хранилище ключей *ContososourceKeyvault* на исходной области.
У вас есть все разрешения на хранилище ключей исходного региона. Но во время защиты вы выбираете уже созданный свод ключей ContosotargetKeyvault, который не имеет разрешений. Происходит ошибка.

Разрешение, необходимое для [хранилища ключей-целей](#required-user-permissions)

**Как исправить:** Перейдите **к** > **домашним политикам доступа** **Keyvaults** > **ContosotargetKeyvault** > Access и добавьте соответствующие разрешения.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о выполнении тестовой отработки отказа см. в [этой статье](site-recovery-test-failover-to-azure.md).
