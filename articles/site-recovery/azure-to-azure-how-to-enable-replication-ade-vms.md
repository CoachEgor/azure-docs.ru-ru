---
title: Настройка репликации для виртуальных машин с поддержкой шифрования дисков Azure в Azure Site Recovery | Документация Майкрософт
description: В этой статье описывается, как настроить репликацию для шифрования дисков Azure с поддержкой виртуальных машин из одного региона Azure в другой с помощью Site Recovery.
services: site-recovery
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 04/08/2019
ms.author: sutalasi
ms.openlocfilehash: b2e9bf7fbe7d5940b517d97dcc15d21c30835001
ms.sourcegitcommit: f56b267b11f23ac8f6284bb662b38c7a8336e99b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/28/2019
ms.locfileid: "67449219"
---
# <a name="replicate-azure-disk-encryption-enabled-virtual-machines-to-another-azure-region"></a>Репликация виртуальных машин с поддержкой шифрования дисков Azure в другой регион Azure

В этой статье описывается репликация виртуальных машин с поддержкой шифрования дисков Azure из одного региона Azure в другой.

>[!NOTE]
>Azure Site Recovery в настоящее время поддерживает только виртуальные машины Azure под управлением ОС Windows, которые [шифрование с помощью Azure Active Directory (Azure AD)](https://aka.ms/ade-aad-app).

## <a id="required-user-permissions"></a> Разрешения пользователя
Site Recovery требуется пользователь должен иметь разрешения на создание хранилища ключей в целевой области и копирование ключей в регионе.

Чтобы включить репликацию виртуальных машин с поддержкой шифрования дисков на портале Azure, необходимые пользователю следующие разрешения:

- Разрешения по отношению к хранилищу ключей:
    - List
    - Создание
    - Получить

-   Разрешения по отношению к секретам хранилища ключей:
    - List
    - Создание
    - Получить

- Разрешения для ключа хранилища ключей (требуется только в том случае, если виртуальные машины используют ключ шифрования ключей для шифрования ключей шифрования диска)
    - List
    - Получить
    - Создание
    - Шифрование
    - расшифровка;

Для управления разрешениями, перейдите к ресурсу хранилища ключей на портале. Добавьте нужные разрешения для пользователя. В следующем примере показано, как включение разрешений в хранилище ключей *ContosoWeb2Keyvault*, который находится в исходном регионе.

1. Перейдите к **Главная** > **Keyvaults** > **ContosoWeb2KeyVault > политики доступа**.

   ![Окно разрешений хранилища ключей](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)

2. Вы увидите, что отсутствуют необходимые разрешения пользователя. Нажмите кнопку **Добавить**. Введите данные пользователя и разрешения.

   ![разрешения хранилища ключей](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

Если пользователь, который используется, чтобы предоставить аварийного восстановления (DR) не имеет разрешений для копирования ключей, администратора безопасности, который имеет соответствующие разрешения можно использовать следующий сценарий для копирования шифрования секретов и ключей к целевой области.

Устранение неполадок с разрешениями, см. в статье [ключа проблем с разрешениями хранилища](#trusted-root-certificates-error-code-151066) далее в этой статье.

>[!NOTE]
>Чтобы включить репликацию виртуальных машин с поддержкой шифрования дисков на портале, вы должны по крайней мере «List» разрешения для хранилищ ключей, секретов и ключей.

## <a name="copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script"></a>Копирование ключей шифрования дисков в регионе аварийного восстановления с помощью сценария PowerShell

1. [Откройте код необработанный скрипт «CopyKeys»](https://aka.ms/ade-asr-copy-keys-code).
2. Скопируйте сценарий в файл и назовите его **keys.ps1 копирования**.
3. Откройте приложение Windows PowerShell и перейдите в папку, где был сохранен файл.
4. Выполнение keys.ps1 копирования.
5. Укажите учетные данные Azure для входа.
6. Выберите **подписку Azure**, к которой относятся виртуальные машины.
7. Ожидания для групп ресурсов для загрузки, а затем выберите **группы ресурсов** виртуальных машин.
8. Выберите виртуальные машины в списке, который отображается. Только виртуальные машины, которые включены для шифрования дисков входят в список.
9. Выберите **целевое расположение**.

    - **Хранилища ключей шифрования диска**
    - **Хранилища ключей для шифрования ключа**

   По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. Имя хранилища имеет суффикс «asr», основанный на ключами шифрования дисков исходной виртуальной Машины. Если уже существует хранилища ключей, который был создан с помощью Site Recovery, она используется повторно. Выберите другое хранилище ключей в списке, при необходимости.

## <a name="enable-replication"></a>Включение репликации

В этом примере основной регион Azure — Восточная Азия, а дополнительный — Юго-Восточная Азия.

1. В хранилище, выберите **+ реплицировать**.
2. Обратите внимание на следующие поля.
    - **Источник.** Источник происхождения виртуальных машин, в нашем примере это **Azure**.
    - **Расположение источника**. Регион Azure, где вы хотите защитить виртуальные машины. В этом примере исходным расположением является «Восточная Азия».
    - **Модель развертывания**. Модель развертывания Azure исходных компьютеров.
    - **Исходная подписка**. Подписка, к которой принадлежат исходные виртуальные машины. Это может быть любой подписки, который находится в том же клиенте Azure Active Directory хранилище служб восстановления.
    - **Группа ресурсов**. Группа ресурсов, к которой принадлежат исходные виртуальные машины. Для защиты в следующем шаге, перечислены все виртуальные машины в выбранной группе ресурсов.

3. В **виртуальных машин** > **выбор виртуальных машин**, выберите все виртуальные Машины, которые требуется реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

4. В **параметры**, можно настроить следующие параметры целевого сайта.

    - **Целевое расположение**. Расположение, в которое будут реплицированы данные исходных виртуальных машин. Site Recovery предоставляет список подходящих целевых регионов, в зависимости от расположения выбранной машины. Мы рекомендуем использовать то же расположение как расположение в хранилище служб восстановления.
    - **Целевая подписка**. Целевая подписка, которая используется для аварийного восстановления. По умолчанию целевая подписка совпадает с исходной подпиской.
    - **Целевая группа ресурсов**. Группа ресурсов, в которой будут находиться все реплицированные виртуальные машины. По умолчанию Site Recovery создает группу ресурсов в целевом регионе. Имя получает суффикс «asr». Если группа ресурсов уже существует, который был создан с помощью Azure Site Recovery, она используется повторно. Также можно настроить его, как показано в следующем разделе. Целевая группа ресурсов может находиться любой регион Azure, за исключением региона, где размещаются исходные виртуальные машины.
    - **Целевая виртуальная сеть**. По умолчанию Site Recovery создает виртуальную сеть в целевом регионе. Имя получает суффикс «asr». Он сопоставляется с исходной сетью и используется для защиты в будущем. [Узнайте больше](site-recovery-network-mapping-azure-to-azure.md) о сетевом сопоставлении.
    - **Целевые учетные записи хранения (если источник, виртуальная машина не использует управляемые диски)** : По умолчанию Site Recovery создает учетную запись хранения целевой, копируя конфигурацию хранилища исходной виртуальной Машины. Если учетная запись хранения уже существует, она используется повторно.
    - **Управляемые диски реплики (если исходная виртуальная машина использует управляемые диски)** : Site Recovery создает управляемые диски реплики в целевом регионе, которые отражают управляемые диски исходной Виртуальной машины одного типа хранилища (класса standard или premium) как управляемые диски исходной Виртуальной машины.
    - **Учетные записи хранения кэша**. Site Recovery требуется учетная запись дополнительного места на диске, с именем *кэшировать хранилища* в исходном регионе. Все изменения в исходных виртуальных машинах отслеживаются и отправляются в учетную запись хранения кэша. Они затем реплицируются в целевое расположение.
    - **Группа доступности**. По умолчанию Site Recovery создает группу доступности в целевом регионе. Имя имеет суффикс «asr». Если группа доступности, которая была создана с помощью Site Recovery, уже существует, она используется повторно.
    - **Хранилища ключей для шифрования дисков**. По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. Он имеет суффикс «asr», основанный на ключами шифрования дисков исходной виртуальной Машины. Если хранилище ключей, который был создан с помощью Azure Site Recovery, уже существует, она используется повторно.
    - **Хранилища ключей для шифрования ключей**. По умолчанию Site Recovery создает новое хранилище ключей в целевом регионе. Имя имеет суффикс «asr», основанный на исходной виртуальной Машины ключа шифрования ключей. Если хранилище ключей, создаваемая Azure Site Recovery, уже существует, она используется повторно.
    - **Политика репликации**. Определяет параметры для журнала хранения точки восстановления и периодичность моментальных снимков с согласованием приложений. По умолчанию Site Recovery создает политику репликации с параметрами по умолчанию *24 часа* временем хранения точки восстановления и *60 минут* для периодичность моментальных снимков с согласованием приложений.

## <a name="customize-target-resources"></a>Настройка целевых ресурсов

Выполните следующие действия, чтобы изменить параметры целевого объекта по умолчанию Site Recovery.

1. Выберите **Настройка** рядом с «Целевую подписку» изменить целевую подписку по умолчанию. Выберите подписку из списка подписок, доступные в клиенте Azure AD.

2. Выберите **Настройка** рядом с полем «Группа ресурсов, сети, хранилища и группах доступности» изменить следующие параметры по умолчанию:
    - Для **целевая группа ресурсов**, выберите группу ресурсов из списка групп ресурсов в целевом расположении подписки.
    - Для **целевой виртуальной сети**, выберите сеть из списка виртуальных сетей в целевом расположении.
    - Для **доступности**, можно добавить параметры группы доступности для виртуальной Машины, если они являются частью группы доступности в исходном регионе.
    - Для **учетные записи хранения целевого**, выберите учетную запись для использования.

2. Выберите **Настройка** рядом с «Параметры шифрования» изменить следующие параметры по умолчанию:
   - Для **хранилища ключей для шифрования диска целевой**, выберите хранилище ключей шифрования целевой диск из списка хранилищ ключей в целевом расположении подписки.
   - Для **хранилища ключей для шифрования ключа целевой**, выберите хранилище ключей, ключей шифрования целевой объект из списка хранилищ ключей в целевом расположении подписки.

3. Выберите **создать целевой ресурс** > **включения репликации**.
4. После включения репликации, виртуальные машины, можно проверить состояние работоспособности виртуальных машин в группе **реплицированные элементы**.

>[!NOTE]
>Во время начальной репликации состояния может занять некоторое время для обновления без явной хода выполнения. Нажмите кнопку **обновить** Чтобы вывести актуальное состояние.

## <a name="update-target-vm-encryption-settings"></a>Обновление параметров шифрования целевой виртуальной машины
В следующих сценариях вы будете вынуждены обновить целевые параметры шифрования виртуальной Машины:
  - Вы включили репликацию Site Recovery на виртуальной Машине. Позже вы включили шифрование дисков на исходной виртуальной Машины.
  - Вы включили репликацию Site Recovery на виртуальной Машине. Позже изменить ключ шифрования диска или ключа шифрования ключей на исходной виртуальной Машины.

Можно использовать [сценарий](#copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script) для копирования ключей шифрования в целевой регион, а затем обновите целевых параметров шифрования в **хранилище служб восстановления** > *реплицированный элемент*  >  **Свойства** > **вычисления и сеть**.

![Обновить окно диалогового окна параметров шифрования дисков AZURE](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a id="trusted-root-certificates-error-code-151066"></a>Устранение неполадок разрешений хранилища ключей во время репликации виртуальных Машин Azure в Azure

Azure Site Recovery требуется по крайней мере чтения разрешение на исходный регион Key vault и разрешение на запись на целевой регион хранилища ключей для чтения секрета и скопируйте его в хранилище ключей целевой регион. 

**Причина 1**. У вас нет разрешения «Получить» **исходный регион Key vault** могло читать их. </br>
**Как исправить:** Независимо от того, являетесь ли вы являетесь администратором подписки или нет очень важно, что имеется разрешение get хранилища ключей.

1. Перейдите в исходный регион Key vault, который в данном примере — «ContososourceKeyvault» > **политики доступа** 
2. В разделе **Выбор субъекта** введите свое имя пользователя, например: "dradmin@contoso.com"
3. В разделе **разрешения ключей** выберите "получить" 
4. В разделе **разрешение секрет** выберите "получить" 
5. Сохранить политику доступа

**Причина 2.** У вас нет необходимых разрешений **целевой регион Key vault** для записи ключей. </br>

*Пример*. При попытке реплицировать виртуальную Машину, которая содержит хранилище ключей *ContososourceKeyvault* в исходном регионе.
Имеет все права на хранилище ключей исходного региона. Но во время защиты, выберите хранилище ключей уже созданного ContosotargetKeyvault, который не имеет разрешений. Произошла ошибка.

Разрешение, необходимое на [целевой Key vault](#required-user-permissions)

**Как исправить:** Перейдите к **Главная** > **Keyvaults** > **ContosotargetKeyvault** > **политики доступа** и добавьте соответствующие разрешения.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о выполнении тестовой отработки отказа см. в [этой статье](site-recovery-test-failover-to-azure.md).
