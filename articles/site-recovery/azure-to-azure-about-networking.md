---
title: О сетевом восстановлении аварийного взаимодействия Azure VM с восстановлением сайта Azure
description: Содержит общие сведения о сети для репликации виртуальных машин Azure с помощью Azure Site Recovery.
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 3/13/2020
ms.author: sutalasi
ms.openlocfilehash: 58348c9aed14a5cc9126be780fe01817274a0b47
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80283265"
---
# <a name="about-networking-in-azure-vm-disaster-recovery"></a>О сетевом восстановлении аварийного спасения Azure VM



В этой статье предоставлены указания по организации сети при репликации и восстановлении виртуальных машин Azure из одного региона в другой с помощью [Azure Site Recovery](site-recovery-overview.md).

## <a name="before-you-start"></a>Перед началом работы

Узнайте, как Site Recovery обеспечивает аварийное восстановление для [этого сценария](azure-to-azure-architecture.md).

## <a name="typical-network-infrastructure"></a>Обычная сетевая инфраструктура

На следующей схеме показана типичная среда Azure для приложения, работающего на виртуальных машинах Azure:

![customer-environment](./media/site-recovery-azure-to-azure-architecture/source-environment.png)

Если вы используете Azure ExpressRoute или VPN-подключение из локальной сети в Azure, среда выглядит следующим образом.

![customer-environment](./media/site-recovery-azure-to-azure-architecture/source-environment-expressroute.png)

Как правило, сети защищаются с помощью брандмауэров или групп безопасности сети (NSG). Брандмауэры используют утвержденный список на основе URL или IP-адресов для контроля подключения к сети. NSG предоставляет правила, использующие диапазоны IP-адресов для управления сетевым подключением.

>[!IMPORTANT]
> Если для управления сетевым подключением используется прокси-сервер, прошедший аутентификацию, эта функция не поддерживается Site Recovery, а репликацию включить невозможно.


## <a name="outbound-connectivity-for-urls"></a>Исходящие подключения для URL-адресов

При использовании прокси-сервера брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих URL-адресов в Site Recovery:


**URL-адрес** | **Подробно**
--- | ---
*.blob.core.windows.net | Это необходимо, чтобы данные можно было записать в учетную запись хранения кэша в исходном регионе из виртуальной машины. Если вы знаете все учетные записи хранилища кэша для вашего ввока, вы можете разрешить доступ к определенным URL-адресам учетной записи хранения данных (Ex: cache1.blob.core.windows.net и cache2.blob.core.windows.net) вместо q.blob.core.windows.net
login.microsoftonline.com | Требуется для авторизации и проверки подлинности URL-адресов службы Site Recovery.
*.hypervrecoverymanager.windowsazure.com | Требуется для обмена данными между службой Site Recovery и виртуальной машиной.
*.servicebus.windows.net | Необходимые для записи данные наблюдения и диагностики Site Recovery из виртуальной машины.
*.vault.azure.net | Позволяет получить доступ для репликации для виртуальных машин с поддержкой ADE через портал
В.automation.ext.azure.com | Позволяет автоматическое обновление мобильного агента для реплицируемого элемента через портал

## <a name="outbound-connectivity-using-service-tags"></a>Выходное подключение с помощью тегов служб

Если вы используете NSG для управления исходящим подключением, эти теги службы должны быть разрешены.

- Для учетных записей хранилища в регионе исходных данных:
    - Создайте правило NSG на основе [тега службы хранилища](../virtual-network/security-overview.md#service-tags) для исходного региона.
    - Разрешите эти адреса, чтобы данные можно было записать в учетную запись хранения кэша с виртуальной машины.
- Создайте [тег службы Azure Active Directory (AAD)](../virtual-network/security-overview.md#service-tags) на основе правила NSG, чтобы разрешить доступ ко всем IP-адресам, соответствующим AAD.
- Создайте на основе правила NSG службы EventsHub для целевого региона, что позволяет получить доступ к мониторингу восстановления сайта.
- Создайте на основе правила NSG службы обслуживания AzureSiteRecovery, чтобы разрешить доступ к службе восстановления сайта в любом регионе.
- Создайте правило NSG с тегом службы AzureKeyVault. Это необходимо только для включения репликации виртуальных машин с поддержкой ADE через портал.
- Создайте сервисный тег GuestAndHybridManagement на основе правила NSG. Это необходимо только для автоматического обновления мобильного агента для реплицируемого элемента через портал.
- Мы советуем создать необходимые правила NSG в тестовой группе безопасности сети и проверить наличие проблем, прежде чем создавать правила для рабочей группы безопасности.

## <a name="example-nsg-configuration"></a>Конфигурация примера группы безопасности сети

В этом примере показано, как настроить правила NSG для репликации виртуальной машины.

- При использовании правил NSG для управления исходящими подключениями используйте правило "Разрешить исходящие подключения по HTTPS" через порт 443 для всех необходимых диапазонов IP-адресов.
- В этом примере предполагается, что исходное расположение виртуальной машины — "Восточная часть США", а конечное — "Центральная часть США".

### <a name="nsg-rules---east-us"></a>Правила NSG. Восточная часть США

1. Создайте правило безопасности исходящих подключений HTTPS (443) для Storage.EastUS в NSG, как показано на снимке экрана ниже.

      ![storage-tag](./media/azure-to-azure-about-networking/storage-tag.png)

2. Создайте правило безопасности исходящих подключений HTTPS (443) для AzureActiveDirectory в NSG, как показано на снимке экрана ниже.

      ![Тег aad](./media/azure-to-azure-about-networking/aad-tag.png)

3. Подобно вышеуказанным правилам безопасности, создайте исходящие правила безопасности HTTPS (443) для "EventHub.CentralUS" на NSG, которые соответствуют целевому местоположению. Это позволяет получить доступ к мониторингу восстановления сайта.

4. Создайте исходящие правила безопасности HTTPS (443) для "AzureSiteRecovery" в NSG. Это позволяет получить доступ к службе восстановления сайта в любом регионе.

### <a name="nsg-rules---central-us"></a>Правила NSG. Центральная часть США

Эти правила необходимы, чтобы включить репликацию из целевого в исходный регион после отработки отказа:

1. Создайте правило безопасности исходящих подключений HTTPS (443) для Storage.CentralUS в NSG.

2. Создайте правило безопасности исходящих подключений HTTPS (443) для AzureActiveDirectory в NSG.

3. Подобно вышеуказанным правилам безопасности, создайте исходящие правила безопасности HTTPS (443) для "EventHub.EastUS" на NSG, которые соответствуют местоположению источника. Это позволяет получить доступ к мониторингу восстановления сайта.

4. Создайте исходящие правила безопасности HTTPS (443) для "AzureSiteRecovery" в NSG. Это позволяет получить доступ к службе восстановления сайта в любом регионе.

## <a name="network-virtual-appliance-configuration"></a>Настройка виртуального сетевого модуля

При использовании виртуальных сетевых модулей для управления исходящим сетевым трафиком виртуальных машин устройство может выполнить регулирование, если весь трафик репликации проходит через этот модуль. Мы рекомендуем создать конечную точку службы сети в виртуальной сети для хранилища, чтобы трафик репликации не передавался на виртуальный сетевой модуль.

### <a name="create-network-service-endpoint-for-storage"></a>Создание конечной точки сетевой службы для хранилища
Вы можете создать конечную точку сетевой службы в виртуальной сети для хранилища, чтобы трафик репликации не покидал границ Azure.

- Выберите виртуальную сеть Azure и щелкните "Конечные точки службы".

    ![storage-endpoint](./media/azure-to-azure-about-networking/storage-service-endpoint.png)

- Нажмите кнопку "Добавить", и откроется вкладка "Добавить конечные точки службы".
- Выберите Microsoft.Storage в разделе "Служба" и соответствующие подсети в поле "Подсети", а потом нажмите кнопку "Добавить".

>[!NOTE]
>Не ограничивайте доступ к виртуальной сети для учетных записей хранения, используемых для ASR. Следует разрешить доступ из всех сетей.

### <a name="forced-tunneling"></a>Принудительное туннелирование

Вы можете переопределить системный маршрут Azure по умолчанию для префикса адреса 0.0.0.0/0, указав [настраиваемый маршрут](../virtual-network/virtual-networks-udr-overview.md#custom-routes), и перенаправить трафик виртуальных машин на локальный сетевой виртуальный модуль (NVA), но такая конфигурация не рекомендуется для репликации Site Recovery. При использовании настраиваемых маршрутов рекомендуется создать в виртуальной сети для хранилища [конечную точку службы для виртуальной сети](azure-to-azure-about-networking.md#create-network-service-endpoint-for-storage), чтобы трафик репликации не покидал границ Azure.

## <a name="next-steps"></a>Дальнейшие действия
- Включите защиту рабочих нагрузок, [выполнив репликацию виртуальных машин Azure](site-recovery-azure-to-azure.md).
- Узнайте больше о [сохранении IP-адресов](site-recovery-retain-ip-azure-vm-failover.md) при отработке отказа виртуальных машин Azure.
- Узнайте больше о аварийном восстановлении [виртуальных машин Azure с помощью ExpressRoute.](azure-vm-disaster-recovery-with-expressroute.md)
