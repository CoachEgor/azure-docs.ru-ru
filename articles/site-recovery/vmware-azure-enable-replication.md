---
title: Включите виртуальные машины VMware для аварийного восстановления с помощью Azure Site Recovery
description: В этой статье описывается, как включить репликацию виртуальной машины VMware для аварийного восстановления с помощью службы Azure Site Recovery.
author: Rajeswari-Mamilla
ms.service: site-recovery
ms.date: 06/28/2019
ms.topic: conceptual
ms.author: ramamill
ms.openlocfilehash: 10b3e572ec61d1eff342f24a6a5a7bcba6276983
ms.sourcegitcommit: f0dfcdd6e9de64d5513adf3dd4fe62b26db15e8b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/26/2019
ms.locfileid: "75495375"
---
# <a name="enable-replication-to-azure-for-vmware-vms"></a>Включение репликации в Azure для виртуальных машин VMware

В этой статье описано, как включить репликацию локальных виртуальных машин VMware в Azure.

## <a name="resolve-common-issues"></a>Устранение распространенных проблем

* Размер каждого диска не должен превышать 4 ТБ.
* Диск операционной системы должен быть базовым, а не динамическим диском.
* Для виртуальных машин с поддержкой версии 2 и UEFI семейство операционных систем должно быть Windows, а загрузочный диск должен быть меньше 300 ГБ.

## <a name="prerequisites"></a>Технические условия

В этой статье предполагается, что вы:

- [Настройте локальную исходную среду](vmware-azure-set-up-source.md).
- [Настройте целевую среду в Azure](vmware-azure-set-up-target.md).
- Прежде чем начать, [Проверьте требования и предварительные](vmware-physical-azure-support-matrix.md) требования. Важно отметить следующее:
    - [Поддерживаемые операционные системы](vmware-physical-azure-support-matrix.md#replicated-machines) для реплицированных компьютеров.
    - Поддержка [хранилища и диска](vmware-physical-azure-support-matrix.md#storage) .
    - [Требования Azure](vmware-physical-azure-support-matrix.md#azure-vm-requirements) , с которыми должны соответствовать локальные компьютеры.


## <a name="before-you-start"></a>Перед началом работы
При репликации виртуальных машин VMware следует учитывать следующие сведения:

* Учетная запись пользователя Azure должна содержать определенные [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines) для включения репликации новой виртуальной машины в Azure.
* Виртуальные машины VMware обнаруживаются каждые 15 минут. Чтобы виртуальные машины отображались в портал Azure после обнаружения, может потребоваться 15 минут или более. Аналогично, при добавлении нового сервера vCenter или узла vSphere обнаружение может занять 15 минут или больше.
* Для изменения среды на виртуальной машине (например, при установке средств VMware) на портале может потребоваться 15 минут или более.
* Вы можете проверить время последнего обнаружения виртуальных машин VMware: см. Последнее поле **контакта** в на странице " **серверы конфигурации** " для узла vCenter Server/vSphere.
* Чтобы добавить виртуальные машины для репликации, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (но не щелкайте его) и выберите **Обновить**.
* Если при включении репликации виртуальная машина подготовлена, сервер обработки автоматически устанавливает на нем службу Azure Site Recovery Mobility Service.

## <a name="enable-replication"></a>Включение репликации

Прежде чем выполнять действия, описанные в этом разделе, обратите внимание на следующие сведения.
* Azure Site Recovery теперь реплицируется непосредственно на управляемые диски для всех новых репликаций. Сервер обработки записывает журналы репликации в учетную запись хранения кэша в целевом регионе. Эти журналы используются для создания точек восстановления в управляемых дисках реплики с соглашением об именовании асрсиддиск.
* Поддержка PowerShell для репликации на управляемые диски доступна через [AZ. RecoveryServices Module версии 2.0.0](https://www.powershellgallery.com/packages/Az.RecoveryServices/2.0.0-preview) 
* Во время отработки отказа Выбранная точка восстановления используется для создания диска, управляемого целевым объектом.
* Виртуальные машины, которые ранее были настроены для репликации в целевые учетные записи хранения, не затрагиваются.
* Репликация в учетные записи хранения для новой виртуальной машины доступна только через API-интерфейсы передачи данных о состоянии (RESTFUL) и PowerShell. Используйте Azure REST API версии 2016-08-10 или 2018-01-10 для репликации в учетные записи хранения.

Выполните следующие действия, чтобы включить репликацию.
1. Перейдите к разделу **Шаг 2. репликация** **источника** > приложения. Включив репликацию в первый раз, выберите **+ реплицировать** в хранилище, чтобы включить репликацию для дополнительных виртуальных машин.
2. На странице **Источник** щелкните **Источник** и выберите нужный сервер конфигурации.
3. В качестве **типа компьютера**выберите **виртуальные машины** или **физические компьютеры**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел. Этот параметр не имеет значения, если выполняется репликация физических компьютеров.
5. Выберите сервер обработки. Если дополнительные серверы обработки не созданы, в раскрывающемся списке будет доступен встроенный сервер обработки сервера конфигурации. Состояние работоспособности каждого сервера обработки указывается с учетом рекомендуемых ограничений и других параметров. Выберите работоспособный сервер обработки. Объект сервер обработки [критически важных операций](vmware-physical-azure-monitor-process-server.md#process-server-alerts) выбрать нельзя. Вы можете [устранить неполадки и ошибки](vmware-physical-azure-troubleshoot-process-server.md)**или**[настроить сервер обработки масштабирования](vmware-azure-set-up-process-server-scale.md).
    ![включить окно источника репликации](media/vmware-azure-enable-replication/ps-selection.png)

> [!NOTE]
> В [версии 9,24](service-updates-how-to.md#links-to-currently-supported-update-rollups)добавлены дополнительные оповещения для улучшения работоспособности сервера обработки. Обновите компоненты Site Recovery до версии 9,24 или более поздней, чтобы создать все оповещения.

6. В поле **целевой объект**выберите подписку и группу ресурсов, в которых вы хотите создать виртуальные машины, для которых выполнена отработка отказа. Выберите модель развертывания, которая будет использоваться в Azure для виртуальных машин, для которых выполнена отработка отказа.
2. Выберите сеть и подсеть Azure, к которым будут подключаться виртуальные машины Azure после отработки отказа. Сеть должна находиться в том же регионе, что и Site Recovery хранилище служб.

   Выберите **настроить сейчас для выбранных компьютеров** , чтобы применить параметр сети ко всем виртуальным машинам, выбранным для защиты. Щелкните **настроить позже** , чтобы выбрать сеть Azure для каждой виртуальной машины. Если у вас нет сети, ее необходимо создать. Чтобы создать сеть с помощью Azure Resource Manager, выберите **создать**. Выберите подсеть, если это применимо, а затем нажмите кнопку **ОК**.
   
   ![Включить целевое окно репликации](./media/vmware-azure-enable-replication/enable-rep3.png)

1. Для **виртуальных машин** > **выберите виртуальные**машины, а затем выберите каждую виртуальную машину, которую требуется реплицировать. Можно выбрать только виртуальные машины, для которых можно включить репликацию. Нажмите кнопку **ОК**. Если вы не видите или не можете выбрать какую бы то ни было конкретную виртуальную машину, см. раздел [Исходный компьютер не указан в портал Azure](https://aka.ms/doc-plugin-VM-not-showing) для решения проблемы.

    ![Включение репликации — окно "выбор виртуальных машин"](./media/vmware-azure-enable-replication/enable-replication5.png)

1. Для **свойств** > **настроить свойства**выберите учетную запись, которую сервер обработки использует для автоматической установки службы Mobility Service Site Recovery на виртуальной машине. Кроме того, выберите тип целевого управляемого диска для репликации в зависимости от шаблонов обработки данных.
10. По умолчанию реплицируются все диски исходной виртуальной машины. Чтобы исключить диски из репликации, снимите флажок **включить** для всех дисков, которые не нужно реплицировать. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства. Дополнительные сведения об [исключении дисков](vmware-azure-exclude-disk.md).

    ![Включить настройку окна "свойства репликации"](./media/vmware-azure-enable-replication/enable-replication6.png)

1. В **параметрах репликации** > **настроить параметры репликации**, убедитесь, что выбрана правильная политика репликации. Параметры политики репликации можно изменить в **параметрах** > **политики репликации** > ***имя политики*** > **изменить параметры**. Изменения, применяемые к политике, также применяются к репликации и новым виртуальным машинам.
1. Включите **согласованность нескольких виртуальных машин** , если требуется собрать виртуальные машины в группу репликации. Укажите имя группы и нажмите кнопку **ОК**.

    > [!NOTE]
    >    * Виртуальные машины в группе репликации реплицируются вместе и имеют общую отказоустойчивость и точки восстановления, совместимые с приложениями, при отработки отказа.
    >    * Объедините виртуальные машины и физические сервера, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки, Сделайте это только в том случае, если на виртуальных машинах выполняется одна и та же Рабочая нагрузка и требуется согласованность.

    ![Включить окно репликации](./media/vmware-azure-enable-replication/enable-replication7.png)
    
1. Выберите **Включить репликацию**. Ход выполнения задания **включить защиту** можно отслеживать с помощью **параметров** > **задания** > **задания Site Recovery**. Когда завершится задание **финализации защиты**, виртуальная машина будет готова к отработке отказа.

## <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими

Затем проверьте свойства исходной виртуальной машины. Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure после отработки отказа](vmware-physical-azure-support-matrix.md#replicated-machines).

1. Перейдите в раздел **параметры** > **реплицированные элементы**, а затем выберите виртуальную машину. На странице **основные компоненты** отображаются сведения о параметрах и состоянии виртуальной машины.
1. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.
1. В окне **Вычисление и сеть** > **Свойства вычислений**можно изменить несколько свойств виртуальной машины. 

    ![Окно "Свойства вычислений и сети"](./media/vmware-azure-enable-replication/vmproperties.png)

    * Имя виртуальной машины Azure. при необходимости измените имя, чтобы оно соответствовало требованиям Azure.
    * Размер целевой виртуальной машины или тип виртуальной машины. размер ВИРТУАЛЬНОЙ машины по умолчанию выбирается на основе нескольких параметров, включающих число дисков, число сетевых адаптеров, число ядер ЦП, память и доступные размеры виртуальных машин в целевом регионе Azure. Azure Site Recovery выбирает первый доступный размер виртуальной машины, удовлетворяющий всем критериям. Вы можете выбрать другой размер виртуальной машины в зависимости от ваших потребностей в любое время перед отработкой отказа. Обратите внимание, что размер диска виртуальной машины также зависит от размера исходного диска и может быть изменен только после отработки отказа. Дополнительные сведения о размерах дисков и скорости операций ввода-вывода см. в статье [целевые показатели масштабируемости и производительности для дисков виртуальных машин в Windows](../virtual-machines/windows/disk-scalability-targets.md).

    *  Группа ресурсов. Вы можете выбрать [группу ресурсов](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-resource-groups-guidelines), из которой виртуальная машина станет частью процедуры после отработки отказа. Этот параметр можно изменить в любое время перед отработкой отказа. Если после отработки отказа виртуальная машина переносится в другую группу ресурсов, параметры защиты этой виртуальной машины будут нарушены.
    * Группа доступности. Вы можете выбрать группу [доступности](https://docs.microsoft.com/azure/virtual-machines/windows/infrastructure-availability-sets-guidelines) , если ваша виртуальная машина должна входить в состав после отработки отказа. При выборе группы доступности учитывайте следующие сведения:

        * Отображаются только группы доступности, принадлежащие к указанной группе ресурсов.  
        * Виртуальные машины, наявляющиеся в разных виртуальных сетях, не могут входить в одну группу доступности.
        * В одну группу доступности могут входить только виртуальные машины одинакового размера.
1. Вы также можете добавить сведения о целевой сети, подсети и IP-адресе, назначенном виртуальной машине Azure.
2. На странице **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине, для которой будет выполняться репликация.

### <a name="configure-networks-and-ip-addresses"></a>Настройка сетей и IP-адресов

Вы можете задать целевой IP-адрес. Если адрес не предоставлен, виртуальная машина, для которой была выполнена отработка отказа, использует DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Если адрес доступен в сети тестовой отработки отказа, можно использовать тот же целевой IP-адрес для тестовой отработки отказа.

Число сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины следующим образом.

- Если количество сетевых адаптеров на исходной виртуальной машине меньше или равно числу адаптеров, разрешенных для размера целевой виртуальной машины, то количество адаптеров в целевом объекте совпадает с числом источников.
- Если число адаптеров для исходной виртуальной машины превышает число, допустимое для размера целевой виртуальной машины, используется максимальный размер целевого объекта. Например, если исходная виртуальная машина имеет два сетевых адаптера и размер целевой виртуальной машины поддерживает четыре, Целевая виртуальная машина имеет два адаптера. Если исходная виртуальная машина имеет два адаптера, но целевой размер поддерживает только один, Целевая виртуальная машина имеет только один адаптер.
- Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети. Кроме того, первый адаптер, показанный в списке, станет сетевым адаптером *по умолчанию* на виртуальной машине Azure. 

### <a name="azure-hybrid-benefit"></a>Преимущество гибридного использования Azure

Клиенты Microsoft Software Assurance могут использовать Преимущество гибридного использования Azure, чтобы сэкономить на стоимости лицензирования для компьютеров Windows Server, перенесенных в Azure. Преимущество также относится к аварийному восстановлению Azure. Если вы имеете право, вы можете назначить преимущество виртуальной машине, которую Site Recovery создает при отработке отказа. Для этого выполните следующие действия:
1. Перейдите к **свойствам компьютер и сеть** реплицированной виртуальной машины.
2. Ответьте на вопрос, если у вас есть лицензия Windows Server, которая дает вам право на Преимущество гибридного использования Azure.
3. Убедитесь, что у вас есть соответствующая лицензия Windows Server с Software Assurance, которую можно использовать для применения преимуществ к виртуальной машине, которая будет создана при отработке отказа.
4. Сохраните параметры для реплицированной виртуальной машины.

См. дополнительные сведения о программе [преимуществ гибридного использования Azure](https://aka.ms/azure-hybrid-benefit-pricing).



## <a name="next-steps"></a>Дальнейшие действия

После того как виртуальная машина достигнет защищенного состояния, попробуйте [отработку отказа](site-recovery-failover.md) , чтобы проверить, отображается ли ваше приложение в Azure.

* Чтобы отключить репликацию, см. сведения в статье [Удаление серверов и отключение защиты](site-recovery-manage-registration-and-protection.md).
* Узнайте, как [автоматизировать репликацию виртуальных машин с помощью PowerShell](vmware-azure-disaster-recovery-powershell.md).
