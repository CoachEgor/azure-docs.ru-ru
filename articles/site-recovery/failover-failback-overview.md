---
title: О сбоях и сбой в восстановлении сайта Azure
description: Узнайте о сбоях и сбоях в восстановлении сайта Azure.
ms.topic: conceptual
ms.date: 12/24/2019
ms.openlocfilehash: d9b54f3c452212e12419a5ffd67b116c8660308d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79281812"
---
# <a name="about-on-premises-disaster-recovery-failoverfailback"></a>О локте в аварийном восстановлении

В этой статье приводится обзор сбоя и сбоя при аварийном восстановлении наместах в Azure с [azure Site Recovery.](site-recovery-overview.md)

## <a name="recovery-stages"></a>Этапы восстановления

Failover и failback в восстановлении сайта имеет четыре этапа:

- **Этап 1: Fail из наместах**: После настройки репликации в Azure для наемных машин, когда ваш на территории сайта выходит из строя, вы не эти машины к Azure. После выполнения отработки отказа из реплицированных данных создаются виртуальные машины Azure.
- **Этап 2: Reprotect Azure VMs:** В Azure вы повторно защищаете VMs Azure, чтобы они начали реплицироваться обратно на сайт. При наличии в помещениях VM (при наличии имеется) он выключен во время повторной защиты, чтобы обеспечить согласованность данных.
- **Этап 3: Fail over от Azure**: Когда ваш на-предпосылки сайт работает как обычно снова, вы запустите другой failover, на этот раз, чтобы не вернуть Azure VMs на ваш сайт. Вы можете не вернуться в исходное место, из которого вы не смогли, или в другое место.
- **Этап 4: Reprotect на месте машины**: После отказа назад, снова включить репликацию предприимчивых машин в Azure.

## <a name="failover"></a>Отработка отказа

Вы выполняете неудачу в рамках стратегии непрерывности бизнеса и восстановления в случае стихийных бедствий (BCDR).

- В качестве первого шага в стратегии BCDR вы постоянно воспроизводите свои штатные машины в Azure. Пользователи получают доступ к рабочим нагрузкам и приложениям, работающим на исходных машинах.
- Если возникает необходимость, например, если происходит сбой в помещении, вы не сможете выполнить возможность копирования машин в Azure. Им. Azure создаются с использованием реплицированных данных.
- Для обеспечения непрерывности бизнеса пользователи могут продолжать доступ к приложениям на M-ми-ми Azure.

Failover – это двухэтапное действие:

- **Failover**: Неудача, которая создает и воспитывает Azure VM с помощью выбранной точки восстановления.
- **Коммит**: После сбоя вы проверяете VM в Azure:
    - Затем можно совершить сбой в выбранной точке восстановления или выбрать другую точку для коммита.
    - После совершения сбоя точка восстановления не может быть изменена.


## <a name="connect-to-azure-after-failover"></a>Подключение к Azure после сбоя

Для подключения к VMs Azure, созданным после сбоя с помощью RDP/SSH, существует ряд требований.

**Отказоустойчивого** | **Расположение** | **Действия**
--- | --- | ---
**Azure VM (Windows)** | На внепредкийтой машине перед failover | **Доступ через Интернет**: Включить RDP. Убедитесь, что правила TCP и UDP добавляются для **общественности,** и что RDP допускается для всех профилей в **Windows Firewall** > **Разрешенные приложения.**<br/><br/> **Доступ через VPN от сайта к сайту:** Включить RDP на машине. Убедитесь, что RDP разрешен опускаемых**приложениях и функциях** **Windows Firewall** -> для **доменов и частных** сетей.<br/><br/>  Задайте для политики сети SAN операционной системы значение **OnlineAll**. Ознакомьтесь с [дополнительными сведениями](https://support.microsoft.com/kb/3031135).<br/><br/> Прежде чем активировать отработку отказа, убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows. Обновление Windows может начаться, когда вы не закончите, и вы не сможете войти в VM, пока обновления не будут сделаны.
**Виртуальная машина Azure под управлением Windows** | На Azure VM после неудачи |  [Добавьте общедоступный IP-адрес](https://aka.ms/addpublicip) для виртуальной машины.<br/><br/> Правила группы сетевой безопасности о сбое в VM (и подсети Azure, к которой она подключена) должны допускать входящие соединения в порт RDP.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**. Если вы не можете подключиться, убедитесь, что VM работает, и просмотрите [советы по устранению неполадок.](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx)
**Виртуальная машина Azure под управлением Linux** | На внепредкийтой машине перед failover | Настройте автоматический запуск службы SSH на виртуальной машине при загрузке системы (если он еще не настроен).<br/><br/> Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.
**Виртуальная машина Azure под управлением Linux** | На Azure VM после неудачи | Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.<br/><br/> [Добавьте общедоступный IP-адрес](https://aka.ms/addpublicip) для виртуальной машины.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/>

## <a name="types-of-failover"></a>Типы отработки отказа

Восстановление сайта предоставляет различные варианты неудачи.

**Отказоустойчивого** | **Подробно** | **Восстановления** | **Рабочий процесс**
--- | --- | --- | ---
**Сбой теста** | Используется для запуска сверла, которое проверяет вашу стратегию BCDR, без потери данных или простоя.| Создает копию VM в Azure, без влияния на текущую репликацию или на среду производства. | 1. Выполнить тест failover на одном VM, или на нескольких ВМ в плане восстановления.<br/><br/> 2. Выберите точку восстановления для использования для сбоя теста.<br/><br/> 3. Выберите сеть Azure, в которой будет находиться VM Azure, когда она будет создана после сбоя. Сеть используется только для тестирования неудачи.<br/><br/> 4. Убедитесь, что бур сработал в том виде, в каком ожидалось. Восстановление сайта автоматически очищает всхожие, созданные в Azure во время сверла.
**Запланированный сбой-Гипер-V**  | Обычно используется для запланированного простоя.<br/><br/> Исходные ночни выключаются. Последние данные синхронизируются перед началом сбоя. | Нулевой потери данных для запланированного рабочего процесса. | 1. Запланируйте окно обслуживания времени и уведомите пользователей.<br/><br/> 2. Перевключите приложения, стоящие перед пользователями, в автономном режиме.<br/><br/> 3. Инициировать запланированный сбой с последней точкой восстановления. Сбой не работает, если машина не выключена, или если ошибки встречаются.<br/><br/> 4. После сбоя убедитесь, что реплика Azure VM активна в Azure.<br/><br/> 5. Совершите неудачу, чтобы закончить. Действие коммитора удаляет все точки восстановления.
**Failover-Hyper-V** | Обычно работает, если происходит незапланированное отключение или основной участок недоступен.<br/><br/> Опционально выключите VM и синхронизируйте окончательные изменения, прежде чем приступить к сбою.  | Минимальная потеря данных для приложений. | 1. Инициировать ваш план BCDR. <br/><br/> 2. Инициировать неудачу. Укажите, следует ли закрыть VM и синхронизировать/повторить последние изменения перед запуском сбоя.<br/><br/> 3. Вы можете не перейти к ряду вариантов точки восстановления, обобщенные в таблице ниже.<br/><br/> Если вы не включите опцию для выключения VM, или если восстановление сайта не может закрыть его, используется последняя точка восстановления.<br/>Сбой работает, даже если машина не может быть выключена.<br/><br/> 4. После неудачи вы убедитесь, что реплика Azure VM активна в Azure.<br/> При необходимости можно выбрать другую точку восстановления из окна удержания в течение 24 часов.<br/><br/> 5. Совершите неудачу, чтобы закончить. Действие коммитов удаляет все доступные точки восстановления.
**Failover-VMware** | Обычно работает, если происходит незапланированное отключение или основной участок недоступен.<br/><br/> Дополнительно укажите, что восстановление сайта должно попытаться вызвать отключение VM, а также синхронизировать и воспроизвести окончательные изменения, прежде чем инициировать сбой.  | Минимальная потеря данных для приложений. | 1. Инициировать ваш план BCDR. <br/><br/> 2. Инициировать сбой от восстановления сайта. Укажите, следует ли попытаться вызвать выключение VM и синхронизировать его перед запуском сбоя.<br/> Сбой работает, даже если машины не могут быть выключены.<br/><br/> 3. После сбоя убедитесь, что реплика Azure VM активна в Azure. <br/>При необходимости можно выбрать другую точку восстановления из окна удержания в 72 часа.<br/><br/> 5. Совершите неудачу, чтобы закончить. Действие коммитора удаляет все точки восстановления.<br/> Для Windows VMs восстановление сайта отсутсвие vMware во время сбоя.

## <a name="failover-processing"></a>Обработка failover

В некоторых сценариях требуется дополнительная обработка отработки отказа, которая длится около 8–10 минут. Тестовая отработка отказа может занимать больше времени для следующих систем:

* виртуальные машины VMware, использующие Службу мобильности версии ниже 9.8;
* физические серверы;
* виртуальные машины Linux VMware;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware без включенной службы DHCP;
* виртуальные машины VMware без загрузочных драйверов storvsc, vmbus, storflt, intelide, atapi.

## <a name="recovery-point-options"></a>Параметры точки восстановления

Во время сбоя можно выбрать несколько вариантов точки восстановления.

**Параметр** | **Подробно**
--- | ---
**Последние (самые низкие RPO)** | Эта опция обеспечивает самую низкую цель точки восстановления (RPO). Сначала он обрабатывает все данные, которые были отправлены в службу восстановления сайта, чтобы создать точку восстановления для каждого VM, прежде чем не к нему. Эта точка восстановления имеет все данные, реплицированные на восстановление сайта, когда срабатывание было срабатывает.
**Последние обработанные**  | Эта опция не справляется с вводелами до последней точки восстановления, обрабатываемой Восстановлением сайта. Чтобы увидеть последнюю точку восстановления для конкретного VM, проверьте **последние точки восстановления** в настройках VM. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
**Последнее приложение-согласованное** |  Эта опция не справляется с вводелами в последнюю точку восстановления, обрабатываемую восстановлением сайта, если включены согласованные точки восстановления приложения. Проверьте последнюю точку восстановления в настройках VM.
**Последние мульти-VM обработаны** | Этот параметр доступен для планов восстановления, которые содержат одну или больше виртуальных машин с согласованностью состояний. Виртуальные машины с этим параметром выполняют отработку отказа до последней согласованной точки восстановления, общей для нескольких виртуальных машин. Любые другие ВМ в плане не доводят до последней точки восстановления обработанной обработки.
**Последние мульти-VM-приложение-согласованное** |  Этот параметр доступен для планов восстановления, которые содержат одну или больше виртуальных машин с согласованностью состояний. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной с приложением точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением.
**Пользовательские** | Используйте эту опцию, чтобы потерпеть неудачу над определенным VM в определенной точке восстановления во времени. Эта опция недоступна для планов восстановления.

> [!NOTE]
> Точки восстановления не могут быть перенесены в другое хранилище служб восстановления.

## <a name="reprotectionfailback"></a>Репротектора/неудача

После сбоя в Azure реплицированные VMs Azure находятся в незащищенном состоянии.

- В качестве первого шага к отказу от вашего сайта, вам нужно начать репликацию VMs Azure в наместах. Процесс резащиты зависит от типа машин, которые вы не смогли.
- После того, как машины воспроизводятся из Azure в локоте, вы можете запустить сбой из Azure на свой сайт.
- После повторного запуска машин можно включить репликацию, чтобы они реплицировались в Azure для аварийного восстановления.

Failback работает следующим образом:

- Чтобы сбой назад, VM необходимо по крайней мере одну точку восстановления для того, чтобы выйти из строя. В плане восстановления всем вм-реже в плане требуется по крайней мере одна точка восстановления.
- Мы рекомендуем использовать **последнюю** точку восстановления, чтобы сбой назад (это краш-согласованной точки).
    - Существует параметр точки восстановления, согласоваемый с приложением. В этом случае один VM восстанавливается до последней доступной точки восстановления, согласованной с приложением. Для плана восстановления с группой репликации каждая группа репликации восстанавливается в общей доступной точке восстановления.
    - Последовательная точка восстановления приложений может отставать во времени, и могут быть потери в данных.
- Во время сбоя из Azure в закрытый сайт восстановление сайта отключает VMs Azure. При фиксации сбоя восстановление сайта удаляет неудавшийся доступ к всасыванным визтам Azure.


## <a name="vmwarephysical-reprotectionfailback"></a>VMware/физическая резащита/отказ

Для повторной защиты и отказа от vMware машин и физических серверов от Azure до локти, вам нужна инфраструктура отказов, и существует ряд требований.

- **Временный сервер процесса в Azure:** Чтобы выйти из Azure, вы настроили VM Azure, чтобы выступать в качестве сервера процесса для обработки репликации из Azure. После восстановления размещения эту виртуальную машину можно удалить.
- **VPN-подключение.** Для восстановления размещения нужно настроить VPN-подключение (или ExpressRoute) между сетью Azure и локальным сайтом.
- **Отдельный основной целевой сервер:** По умолчанию, главный целевой сервер, который был установлен с сервером конфигурации на предприимчном VMware VM ручки failback. Чтобы восстановить размещение больших объемов трафика,отдельно настройте локальный главный целевой сервер.
- **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Эта политика создается автоматически при создании политики репликации из локальной среды в Azure.
    - Эта политика автоматически связана с сервером конфигурации.
    - Вы не можете отсеить эту политику.
    - Значения политики: порог RPO - 15 минут; Удержание точки восстановления - 24 часа; Частота снимков - 60 минут.

Узнайте больше о VMware/физической резащите и отказе:
- [Просмотрите дополнительные](vmware-azure-reprotect.md#before-you-begin) требования к резащите и отказу.
- [Развертывание](vmware-azure-prepare-failback.md#deploy-a-process-server-in-azure) сервера процессов в Azure.
- [Развертывание](vmware-azure-prepare-failback.md#deploy-a-separate-master-target-server) отдельного основного целевого сервера.

При повторной защите ВМ Azure в локальные, можно указать, что вы хотите вернуться в исходное местоположение или в другое местоположение.

- **Исходное восстановление местоположения**: Это не удается вернуться из Azure в тот же источник локальных машин, если она существует. В этом сценарии только изменения реплицируются обратно в локоте.
- **Альтернативное восстановление местоположения:** Если локальный аппарат не существует, вы можете выйти из Azure в другое место. При повторной защите Azure VM в помещение создается автомат. Полная репликация данных происходит от Azure к наместере. - - [Просмотрите](concepts-types-of-failback.md) требования и ограничения для возврата местоположения.



## <a name="hyper-v-reprotectionfailback"></a>Hyper-V репротекция/неудача

Для повторной защиты и отказа от Hyper-V VM из Azure в помещение:

- Вы можете выполнить только отказ от hyper-V VMs репликации с помощью учетной записи хранения. Failback Hyper-V V M, которые реплицируются с помощью управляемых дисков, не поддерживается.
- В поле расположения Hyper-V (или System Center VMM при использовании) следует подключить к Azure.
- Вы запустите запланированный сбой из Azure в локотон.
- Для возврата Hyper-V VM не требуется настраивать конкретные компоненты.
- Во время запланированного сбоя можно выбрать параметры для синхронизации данных до сбоя:
    - **Синхронизация данных до сбоя:** Эта опция сводит к минимуму время простоя для виртуальных машин, поскольку она синхронизирует машины, не выключая их.
        - Фаза 1: Делает снимок VM Azure и копирует его на место второго раза. Машина продолжит работать в Azure.
        - Фаза 2: Выключает Azure VM, чтобы там не произошло никаких новых изменений. Окончательный набор дельта-изменений передается на сервер и запускается на месте VM.
    - **Синхронизация данных только во время сбоя:** Эта опция быстрее, потому что мы ожидаем, что большая часть диска изменилась, и, таким образом, не выполняют расчеты чеков. Выполняется скачивание диска. Мы рекомендуем использовать эту опцию, если VM работает в Azure некоторое время (месяц или более) или если в помещении VM был удален.

[Узнайте больше](hyper-v-azure-failback.md) о резащите Hyper-V и отказе.

При повторной защите ВМ Azure в локальные, можно указать, что вы хотите вернуться в исходное местоположение или в другое местоположение.

- **Исходное восстановление местоположения**: Это не удается вернуться из Azure в тот же источник локальных машин, если она существует. В этом сценарии выберите один из вариантов синхронизации, описанных в предыдущей процедуре.
- **Альтернативное восстановление местоположения:** Если локальный аппарат не существует, вы можете выйти из Azure в другое место. При повторной защите Azure VM в помещение создается автомат. С помощью этой опции мы рекомендуем выбрать опцию синхронизации данных до сбоя
- [Просмотрите](hyper-v-azure-failback.md) требования и ограничения для возврата местоположения.


После сбоя на месте, вы позволяете **Reverse Replicate** начать репликацию VM в Azure, завершив цикл.




## <a name="next-steps"></a>Дальнейшие действия
- Fail над [конкретными VMware VMs](vmware-azure-tutorial-failover-failback.md)
- Fail над [конкретными Hyper-V VMs](hyper-v-azure-failover-failback-tutorial.md).
- [Создайте](site-recovery-create-recovery-plans.md) план восстановления.
- Fail над [VMs в плане восстановления](site-recovery-failover.md).
- [Подготовка к](vmware-azure-failback.md) VMware резащиты и отказов.
- Fail назад [Hyper-V VMs](hyper-v-azure-failback.md).

