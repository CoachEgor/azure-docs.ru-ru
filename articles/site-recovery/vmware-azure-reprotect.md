---
title: Повторное включение защиты виртуальных машин из Azure на локальный сайт во время аварийного восстановления виртуальных машин VMware и физических серверов | Документация Майкрософт
description: После отработки отказа в Azure во время аварийного восстановления виртуальных машин VMware и физических серверов узнайте от том, как восстановить размещение из Azure на локальный сайт.
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 10/22/2019
ms.author: mayg
ms.openlocfilehash: cf1ccdf953781ca9b9bd17152f2cf32677997d12
ms.sourcegitcommit: b050c7e5133badd131e46cab144dd5860ae8a98e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/23/2019
ms.locfileid: "72791806"
---
# <a name="reprotect-and-fail-back-machines-to-an-on-premises-site-after-failover-to-azure"></a>Повторное включение защиты и восстановление размещения машин на локальном сайте после отработки отказа в Azure

После [отработки отказа](site-recovery-failover.md) локальных виртуальных машин VMware или физических серверов в Azure, чтобы восстановить размещение на локальном сайте, сначала нужно повторно защитить виртуальные машины Azure, созданные во время отработки отказа. Из этой статьи вы узнаете, как это сделать. 

Просмотрите видео ниже, чтобы получить общее представление о том, как выполнить отработку отказа из Azure на локальный сайт.<br /><br />
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="before-you-begin"></a>Перед началом работы

Если виртуальные машины созданы с помощью шаблона, убедитесь в том, что диски каждой виртуальной машины имеют UUID. При возникновении конфликта UUID локальной виртуальной машины и UUID главного целевого сервера из-за того, что оба компонента созданы на основе одного шаблона, происходит сбой повторного включения защиты. В таком случае разверните другой главный целевой сервер, созданный на основе другого шаблона. Обратите внимание на следующие сведения:
- Если вы пытаетесь восстановить размещение на альтернативном сервере vCenter, убедитесь в том, что новый сервер vCenter и главный целевой сервер обнаружены. Характерный симптом: хранилища недоступны и отсутствуют в диалоговом окне **Повторная защита**.
- Для репликации данных обратно в локальную среду требуется политика восстановления размещения. Она создается автоматически, когда вы создаете политику направления переадресации. Обратите внимание на следующие сведения:
    - Эта политика автоматически связывается с сервером конфигурации во время ее создания.
    - Она не подлежит редактированию.
    - Для этой политики используются следующие значения параметров: пороговое значение RPO — 15 минут, хранение точки восстановления — 24 часа, периодичность моментальных снимков согласования приложений — 60 минут.
- Во время повторной защиты и восстановления размещения локальный сервер конфигурации должен быть запущен и корректно подключен.
- Если управление виртуальными машинами, в которые необходимо выполнить восстановление размещения, осуществляется с помощью сервера vCenter Server, убедитесь в наличии [требуемых разрешений](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery) для обнаружения виртуальных машин на серверах vCenter Server.
- Перед включением повторной защиты удалите моментальные снимки на главном целевом сервере. Если на локальном главном целевом сервере или виртуальной машине есть моментальные снимки, повторное включение защиты завершится сбоем. Во время выполнения задания повторного включения защиты моментальные снимки на виртуальной машине автоматически объединяются.
- Все виртуальные машины группы репликации должны иметь одинаковый тип операционной системы (Windows или Linux). Группа репликации с несколькими операционными системами сейчас не поддерживается для повторного включения защиты и восстановления размещения в локальной среде. Причина в том, что главный целевой объект должен иметь ту же операционную систему, что и виртуальная машина. Все виртуальные машины группы репликации должны иметь одинаковый главный целевой объект. 
- На главном целевом компьютере должна быть установлена та же или более поздняя версия ОС, чем в версиях ОС реплицированных элементов.
- При восстановлении размещения в локальной среде должен быть сервер конфигурации. Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации. В противном случае восстановление размещения завершается сбоем. Не забывайте регулярно создавать плановые резервные копии конфигурации сервера. В случае аварии восстановите сервер с тем же IP-адресом, чтобы обеспечить восстановление размещения. 
- Для репликации данных в целях повторного включения и восстановления размещения требуется частный пиринг VPN типа "сеть — сеть" (S2S). Предоставьте сеть, через которую виртуальные машины в Azure, перенесенные при отработке отказа, смогут связываться (проверять связь) с локальным сервером конфигурации. Необходимо развернуть сервер обработки в сети Azure виртуальных машин, для которых выполнена отработка отказа. Этот сервер обработки также должен иметь возможность взаимодействия с локальным сервером конфигурации и главным целевым сервером.
- Если IP-адреса реплицированных элементов были сохранены при отработке отказа, необходимо установить подключение S2S или ExpressRoute между виртуальными машинами Azure и сетевым адаптером восстановления размещения сервера конфигурации. Обратите внимание, что для хранения IP-адресов требуется, чтобы сервер конфигурации имел два сетевых адаптера — один для подключения к исходным компьютерам и один для подключения восстановления размещения Azure. Это позволяет избежать перекрытия диапазонов адресов подсети источника и отработки отказа виртуальных машин.
- Обязательно откройте указанные ниже порты для отработки отказа и восстановления размещения.

    ![Порты для отработки отказа и восстановления размещения](./media/vmware-azure-reprotect/failover-failback.png)

- Прочтите все [предварительные требования к портам и URL-адресам, которые нужно добавить в список разрешений](vmware-azure-deploy-configuration-server.md#prerequisites).

## <a name="deploy-a-process-server-in-azure"></a>Развертывание сервера обработки в Azure

Перед отработкой отказа на локальный сайт требуется сервер обработки в Azure:

- Сервер обработки получает данные с защищенных виртуальных машин в Azure, а затем отправляет данные на локальный сайт.
- Между сервером обработки и защищенной виртуальной машиной должна быть настроена сеть с низкой задержкой. Поэтому рекомендуется развернуть сервер обработки в Azure. Производительность репликации повышается, если сервер обработки расположен ближе к реплицируемой виртуальной машине (в Azure — к компьютеру, для которого выполняется отработка отказа). 
- Для эксперимента можно использовать локальный сервер обработки и ExpressRoute с частным пирингом.

Чтобы развернуть сервер обработки в Azure:

1. Дополнительные сведения о развертывании см. в статье [Настройка сервера обработки в Azure для восстановления размещения](vmware-azure-set-up-process-server-azure.md).
2. Виртуальные машины Azure будут отправлять данные репликации на сервер обработки. Настройте сети, чтобы виртуальные машины Azure могли подключиться к серверу обработки.
3. Помните, что репликация из Azure в локальную среду может осуществляться только через VPN-подключение "сеть — сеть" или частный пиринг сети ExpressRoute. Убедитесь, что этот сетевой канал обеспечивает достаточную пропускную способность.

## <a name="deploy-a-separate-master-target-server"></a>Развертывание главного целевого сервера

Главный целевой сервер принимает данные восстановления размещения. По умолчанию главный целевой сервер работает на локальном сервере конфигурации. Но в зависимости от объема трафика восстановления размещения для него может потребоваться создать отдельный главный целевой сервер. Вот как это сделать:

* [Создайте главный целевой сервер Linux](vmware-azure-install-linux-master-target.md) для восстановления размещения виртуальных машин Linux. Это обязательный шаг. Обратите внимание, что главный целевой сервер на диспетчере логических томов не поддерживается.
* При необходимости создайте отдельный главный целевой сервер для восстановления размещения виртуальных машин Windows. Для этого снова запустите унифицированную установку и выберите создание главного целевого сервера. [Узнайте больше](site-recovery-plan-capacity-vmware.md#deploy-additional-master-target-servers). 

После создания главного целевого сервера выполните следующие задачи:

- Если виртуальная машина размещена локально на сервере vCenter Server, то главному целевому серверу требуется доступ к VMDK-файлу этой локальной виртуальной машины. Это необходимо для записи реплицированных данных на диски виртуальной машины. Убедитесь, что хранилище данных локальной виртуальной машины подключено к узлу главного целевого сервера с доступом на чтение и запись.
- Если виртуальная машина не размещена локально на сервере vCenter Server, то во время повторного включения защиты службе Site Recovery требуется создать виртуальную машину. Она создается на узле ESX, на котором создан главный целевой сервер. Выбирайте узел ESX внимательно, чтобы виртуальная машина для восстановления размещения была создана на нужном узле.
- На главном целевом сервере нельзя использовать технологию Storage vMotion. Использование хранилища vMotion для главного целевого сервера может привести к сбою восстановления размещения. Виртуальная машина не может запуститься, так как для нее нет доступных дисков. Чтобы избежать этой проблемы, исключите главные целевые серверы из списка vMotion.
- Если на главном целевом сервере после повторного включения защиты выполняется задача Storage vMotion, диски защищенных виртуальных машин, подключенные к главному целевому серверу, переносятся на целевой сервер задачи vMotion. Если после этого попытаться восстановить размещение, отключение диска завершается неудачей, так как диски не найдены. После этого найти диски в учетных записях хранения становится трудно. Их необходимо найти вручную и подключить к виртуальной машине. После этого можно загрузить локальную виртуальную машину.
- Добавьте на имеющийся главный целевой сервер Windows диск хранения. Добавьте новый диск и отформатируйте его. Диск хранения используется для остановки точек во времени при репликации виртуальной машины обратно на локальный сайт. Ниже перечислены некоторые критерии для диска хранения. Если они не выполнены, то диск не появится на главном целевом сервере:
    - Том не используется ни для какой иной цели, к примеру, как цель репликации.
    - Том не находится в режиме блокировки.
    - Том не является томом кэша. На томе не должен присутствовать установленный экземпляр главного целевого сервера. Пользовательский том установки сервера обработки и главного целевого сервера не может использоваться как том хранения. Если на этом томе установлен сервер обработки и главный целевой сервер, он используется в качестве тома кэша главного целевого сервера.
    - Типом файловой системы тома не является FAT или FAT32.
    - Размер тома не равен нулю.
    - Том хранения по умолчанию для Windows — это том R.
    - Том хранения по умолчанию для Linux — /mnt/retention.
- Если вы используете существующий компьютер с сервером конфигурации и сервером обработки или компьютер с сервером обработки и главным целевым сервером, нужно добавить новый диск. Этот диск должен удовлетворять перечисленным выше требованиям. Если диск хранения отсутствует, он не отображается в раскрывающемся списке на портале. После добавления диска на локальный главный целевой сервер для его появления на портале может потребоваться до 15 минут. Если через 15 минут диск так и не появился, вы также можете обновить сервер конфигурации.
- Установите инструменты VMware или open-vm-tools на главном целевом сервере. Без этих инструментов не удастся обнаружить хранилища данных на узле ESXi главного целевого сервера.
- В конфигурации главной целевой виртуальной машины в VMware задайте параметр `disk.EnableUUID=true`. Если этой строки нет, добавьте ее. Этот параметр необходим для обеспечения согласованного UUID для правильного подключения VMDK.
- К узлу ESX, в котором создается главный целевой объект, нужно подключить как минимум одно хранилище данных VMFS. Если таких хранилищ нет, сведения о **хранилище данных** на странице повторного включения защиты отображаться не будут и вы не сможете продолжить работу.
- На дисках главного целевого сервера не должно быть моментальных снимков. В противном случае при повторном включении защиты или восстановлении размещения происходит сбой.
- На главном целевом сервере не может находиться контроллер Paravirtual SCSI. На нем может быть только контроллер LSI Logic. Если контроллер LSI Logic отсутствует, при повторном включении защиты происходит сбой.
- В любом заданном экземпляре главный целевой сервер может иметь не более 60 подключенных дисков. Если несколько виртуальных машин, которые защищены повторно в локальном главном целевом сервере, имеют больше 60 дисков, то включение защиты в главном целевом сервере будет завершаться сбоем. Убедитесь, что у вас есть достаточно слотов для дисков главного целевого сервера или разверните дополнительные главные целевые серверы.
    

## <a name="enable-reprotection"></a>Включение повторной защиты

После загрузки виртуальной машины в Azure требуется некоторое время для повторной регистрации агента на сервере конфигурации (не более 15 минут). В течение этого времени нельзя включать повторную защиту. На экране отобразится сообщение о том, что агент не установлен. Если это произошло, подождите несколько минут, а затем включите повторную защиту еще раз.


1. Щелкните **Хранилище** > **Реплицированные элементы**. Щелкните виртуальную машину, для которой проводилась отработка отказа, правой кнопкой мыши и выберите **Защитить повторно**. Вы также можете щелкнуть компьютер и выбрать параметр **Защитить повторно**, используя кнопки управления.
2. Убедитесь, что в качестве направления защиты выбрано **Из Azure на локальный компьютер**.
3. В полях **Главный целевой сервер** и **Сервер обработки** выберите локальный главный целевой сервер и сервер обработки.  
4. В поле **Хранилище данных** выберите хранилище данных, для которого нужно восстановить диски локальной среды. Используйте этот параметр, если локальная виртуальная машина была удалена и вам нужно создать диски. Этот параметр не учитывается, если диски уже существуют. Необходимо указать значение.
5. Выберите диск хранения.
6. Политика восстановления размещения выбирается автоматически.
7. Нажмите кнопку **ОК**, чтобы начать процесс повторной защиты. Задание начнет реплицировать виртуальную машину из Azure на локальный сайт. Ход выполнения можно отслеживать на вкладке **задания** . После завершения повторного включения защиты виртуальная машина переходит в защищенное состояние.

Обратите внимание на следующие сведения:
- Если необходимо выполнить восстановление в альтернативное расположение (если локальная виртуальная машина удалена), выберите диск хранения и хранилище данных, настроенные для главного целевого сервера. При восстановлении размещения на локальном сайте виртуальные машины VMware в плане защиты восстановления размещения используют то же хранилище данных, что и главный целевой сервер. В vCenter создается виртуальная машина.
- Если вы хотите восстановить виртуальную машину Azure в имеющуюся локальную виртуальную машину, подключите хранилища данных локальной виртуальной машины с доступом на чтение и запись к узлу ESXi главного целевого сервера.

    ![Диалоговое окно "Повторная защита"](./media/vmware-azure-reprotect/reprotectinputs.png)

- Защиту можно также включить повторно на уровне плана восстановления. Группу репликации можно повторно защитить только с помощью плана восстановления. В этом случае необходимо предоставить значения для каждой защищенной машины.
- Для повторной защиты группы репликации используйте тот же главный целевой сервер. При выборе другого главного целевого сервера он не сможет предоставить общую точку во времени.
- Во время повторного включения защиты локальная виртуальная машина отключается. Это позволяет обеспечить согласованность данных во время репликации. Не включайте виртуальную машину после завершения повторного включения защиты.



## <a name="common-issues"></a>Типичные проблемы

- Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция настройки защиты завершится успешно и отработка отказа будет работать. Во время повторного включения защиты происходит сбой отработки отказа, так как невозможно обнаружить хранилища данных. Признаком этой ситуации является отсутствие списка хранилищ данных при повторном включении защиты. Для устранения этой проблемы можно обновить учетные данные vCenter, указав учетную запись с соответствующими разрешениями, и повторить задание. 
- При восстановлении размещения виртуальной машины Linux и ее последующем запуске в локальной среде вы видите, что с этой виртуальной машины удален пакет диспетчера сети. Это вызвано тем, что при восстановлении виртуальной машины в Azure пакет диспетчера сети удаляется.
- Если отработка отказа виртуальной машины Linux со статическим IP-адресом выполняется в Azure, IP-адрес предоставляется из DHCP. При восстановлении размещения в локальной среде виртуальная машина также будет получать IP-адрес из DHCP. Вручную войдите на виртуальную машину и снова настройте статический IP-адрес, если это необходимо. Виртуальная машина Windows может получать статический IP-адрес повторно.
- Если вы используете бесплатный выпуск ESXi версии 5.5 или vSphere Hypervisor версии 6, отработка отказа будет выполнена успешно, но восстановление размещения завершится сбоем. Чтобы включить восстановления размещения, необходимо выполнить обновление до любой из версий с ознакомительной лицензией.
- Если сервер конфигурации недоступен с сервера обработки, проверьте возможность подключения к серверу конфигурации по протоколу Telnet через порт 443. Вы также можете проверить связь с сервером конфигурации из сервера обработки. Сервер обработки должен также отвечать на пульс, когда он подключен к серверу конфигурации.
- Сервер Windows Server 2008 R2 с пакетом обновления 1 (SP1), защищенный как физический локальный сервер, не может быть восстановлен из Azure на локальный сайт.
- Восстановить размещение не удается в следующих случаях:
    - Машины перенесены в Azure. [Узнайте больше](migrate-overview.md#what-do-we-mean-by-migration).
    - Вы переместили виртуальную машину в другую группу ресурсов.
    - Вы удалили виртуальную машину Azure.
    - Вы отключили защиту виртуальной машины.
    - Вы вручную создали виртуальную машину в Azure. Компьютер должен быть изначально защищен локально и выполнить отработку отказа в Azure, прежде чем включить повторную защиту.
    - Можно восстановить размещение только на узле ESXi. Нельзя восстановить размещение виртуальных машин VMware или физических серверов в узлах Hyper-V, на физических компьютерах или рабочих станциях VMware.


## <a name="next-steps"></a>Дальнейшие действия

После того как виртуальная машина перейдет в защищенное состояние, можно [инициировать восстановление размещения](vmware-azure-failback.md). При этом будет завершена работа виртуальной машины в Azure и загружена локальная виртуальная машина. В работе приложения будет незначительный простой. Выберите для восстановления размещения период, когда простой приложения допустим.


