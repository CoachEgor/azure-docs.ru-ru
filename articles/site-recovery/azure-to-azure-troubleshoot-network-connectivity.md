---
title: Устранение неполадок подключения к аварийному восстановлению Azure в Azure с помощью Azure Site Recovery
description: Устранение неполадок подключения в аварийном восстановлении виртуальной машины Azure
author: sideeksh
manager: rochakm
ms.topic: how-to
ms.date: 04/06/2020
ms.openlocfilehash: d2cc4133e52e7cab812413d23948da6ac2660e77
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80884874"
---
# <a name="troubleshoot-azure-to-azure-vm-network-connectivity-issues"></a>Устранение неполадок с сетевым подключением Azure к виртуальной машине Azure

В этой статье описываются распространенные проблемы, связанные с сетевым подключением при репликации и восстановлении виртуальных машин Azure из одного региона в другой. Дополнительные сведения о требованиях к сети см. в статье [требования к подключению для репликации виртуальных машин Azure](azure-to-azure-about-networking.md).

Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина находится за брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, могут возникнуть следующие проблемы.

| URL-адрес | Сведения |
|---|---|
| `*.blob.core.windows.net` | Это необходимо, чтобы данные можно было записать в учетную запись хранения кэша в исходном регионе из виртуальной машины. Если вы знакомы со всеми учетными записями хранения кэша для виртуальных машин, вы можете использовать список разрешений для конкретных URL-адресов учетных записей хранения. Например, `cache1.blob.core.windows.net` и `cache2.blob.core.windows.net` вместо. `*.blob.core.windows.net` |
| `login.microsoftonline.com` | Требуется для авторизации и проверки подлинности URL-адресов службы Site Recovery. |
| `*.hypervrecoverymanager.windowsazure.com` | Требуется для обмена данными между службой Site Recovery и виртуальной машиной. Можно использовать соответствующий _IP-адрес Site Recovery_ , если прокси-сервер брандмауэра поддерживает IP. |
| `*.servicebus.windows.net` | Необходимые для записи данные наблюдения и диагностики Site Recovery из виртуальной машины. Можно использовать соответствующий _IP-адрес мониторинга Site Recovery_ , если прокси-сервер брандмауэра поддерживает IP. |

## <a name="outbound-connectivity-for-site-recovery-urls-or-ip-ranges-error-code-151037-or-151072"></a>Исходящие подключения для URL-адресов Site Recovery или IP-диапазонов (код ошибки 151037 или 151072)

### <a name="issue-1-failed-to-register-azure-virtual-machine-with-site-recovery-151195"></a>Проблема 1. Не удалось зарегистрировать виртуальную машину Azure в Site Recovery (151195)

#### <a name="possible-cause"></a>Возможная причина

Невозможно установить подключение к Site Recovery конечным точкам из-за сбоя разрешения системы доменных имен (DNS). Эта проблема наиболее распространена при повторном включении защиты виртуальной машины, но DNS-сервер недоступен из региона аварийного восстановления (DR).

#### <a name="resolution"></a>Решение

Если вы используете настраиваемую службу DNS, убедитесь, что DNS-сервер доступен из региона аварийного восстановления.

Чтобы проверить, использует ли виртуальная машина настраиваемый параметр DNS, выполните следующие действия.

1. Откройте **виртуальные машины** и выберите виртуальную машину.
1. Перейдите к **параметрам** виртуальных машин и выберите **сети**.
1. В области **Виртуальная сеть или подсеть**щелкните ссылку, чтобы открыть страницу ресурсов виртуальной сети.
1. Перейдите в раздел **Параметры** и выберите **DNS-серверы**.

Попытайтесь получить доступ к DNS-серверу с виртуальной машины. Если DNS-сервер недоступен, сделайте его доступным, выполнив отработку отказа DNS-сервера или создав линию сайта между сетью аварийного восстановления и DNS.

  :::image type="content" source="./media/azure-to-azure-troubleshoot-errors/custom_dns.png" alt-text="com-error":::

### <a name="issue-2-site-recovery-configuration-failed-151196"></a>Проблема 2. Сбой при выполнении настройки Site Recovery (151196)

> [!NOTE]
> Если виртуальные машины находятся за **стандартным** внутренним подсистемой балансировки нагрузки, по умолчанию он не будет иметь доступ к IP `login.microsoftonline.com`-адресам Office 365, таким как. Либо измените его на **базовый** тип внутренней подсистемы балансировки нагрузки, либо создайте исходящий доступ, как упоминалось в статье [Настройка балансировки нагрузки и правил исходящего трафика в Load Balancer (цен. категория "Стандартный") с помощью Azure CLI](/azure/load-balancer/configure-load-balancer-outbound-cli).

#### <a name="possible-cause"></a>Возможная причина

Не удается установить подключение к конечным точкам проверки подлинности и IP4-удостоверений Office 365.

#### <a name="resolution"></a>Решение

- Azure Site Recovery требуется доступ к диапазонам IP-адресов Office 365 для проверки подлинности.
- Если вы используете правила и прокси-сервер брандмауэра Azure Network Security Group (NSG) для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что вы разрешите подключение к диапазонам IP-адресов Office 365. Создайте правило NSG на основе [тега службы Azure Active Directory (Azure AD)](/azure/virtual-network/security-overview#service-tags) , которое разрешает доступ ко всем IP-адресам, СООТВЕТСТВУЮЩИМ Azure AD.
- Если в будущем в Azure AD добавляются новые адреса, необходимо создать новые правила NSG.

### <a name="example-nsg-configuration"></a>Конфигурация примера группы безопасности сети

В этом примере показано, как настроить правила NSG для репликации виртуальной машины.

- Если вы используете правила NSG для управления исходящими подключениями, используйте правила **исходящего трафика HTTPS** для порта 443 для всех необходимых диапазонов IP-адресов.
- В примере предполагается, что исходное расположение виртуальной машины — **Восточная часть** США, а целевое расположение — **Центральная часть США**.

#### <a name="nsg-rules---east-us"></a>Правила NSG. Восточная часть США

1. Создайте правило безопасности для исходящего трафика HTTPS для NSG, как показано на следующем снимке экрана. В этом примере используется **тег целевой службы**: _Storage. EastUS_ и **диапазоны портов назначения**: _443_.

     :::image type="content" source="./media/azure-to-azure-about-networking/storage-tag.png" alt-text="storage-tag":::

1. Создайте правило безопасности для исходящего трафика HTTPS для NSG, как показано на следующем снимке экрана. В этом примере используется **тег целевой службы**: _AzureActiveDirectory_ и **диапазоны портов назначения**: _443_.

     :::image type="content" source="./media/azure-to-azure-about-networking/aad-tag.png" alt-text="Тег aad":::

1. Создайте правила для исходящего трафика HTTPS-порта 443 для Site Recovery IP-адресов, соответствующих целевому расположению:

   | Расположение | IP-адрес Site Recovery | IP-адрес мониторинга Site Recovery |
   | --- | --- | --- |
   | Центральная часть США | 40.69.144.231 | 52.165.34.144 |

#### <a name="nsg-rules---central-us"></a>Правила NSG. Центральная часть США

В этом примере эти правила NSG необходимы, чтобы можно было включить репликацию из целевого региона в исходную, после отработки отказа:

1. Создайте правило безопасности для исходящего трафика HTTPS для _Storage. CentralUS_:

   - **Тег целевой службы**: _Storage. CentralUS_
   - **Диапазоны портов назначения**: _443_

1. Создайте правило безопасности для исходящего трафика HTTPS для _AzureActiveDirectory_.

   - **Тег целевой службы**: _AzureActiveDirectory_
   - **Диапазоны портов назначения**: _443_

1. Создайте правила для исходящего трафика HTTPS-порта 443 для Site Recovery IP-адресов, соответствующих расположению источника:

   | Расположение | IP-адрес Site Recovery | IP-адрес мониторинга Site Recovery |
   | --- | --- | --- |
   | Восточная часть США | 13.82.88.226 | 104.45.147.24 |

### <a name="issue-3-site-recovery-configuration-failed-151197"></a>Проблема 3. Сбой при выполнении настройки Site Recovery (151197)

#### <a name="possible-cause"></a>Возможная причина

Не удается установить подключение для Azure Site Recovery конечных точек службы.

#### <a name="resolution"></a>Решение

Обеспечение доступа Azure Site Recovery к [диапазонам IP-адресов Site Recovery](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags) зависит от региона. Убедитесь, что необходимые диапазоны IP-адресов доступны с виртуальной машины.

### <a name="issue-4-azure-to-azure-replication-failed-when-the-network-traffic-goes-through-on-premises-proxy-server-151072"></a>Причина 4. сбой репликации из Azure в Azure, если сетевой трафик проходит через локальный прокси-сервер (151072)

#### <a name="possible-cause"></a>Возможная причина

Недопустимые параметры настраиваемого прокси-сервера, так как агент службы Azure Site Recovery Mobility Service не обнаружил параметры прокси-сервера в Internet Explorer (IE).

#### <a name="resolution"></a>Решение

1. Агент службы Mobility Service обнаруживает параметры прокси-сервера из IE в Windows `/etc/environment` и Linux.
1. Если вы предпочитаете настроить прокси-сервер только для Azure Site Recovery службы Mobility Service, вы можете указать сведения о прокси-сервере в файле _проксинфо. conf_ , расположенном по адресу:

   - **Linux**:`/usr/local/InMage/config/`
   - **Windows**:`C:\ProgramData\Microsoft Azure Site Recovery\Config`

1. _Проксинфо. conf_ должен иметь параметры прокси-сервера в следующем формате _ini_ :

   ```plaintext
   [proxy]
   Address=http://1.2.3.4
   Port=567
   ```

> [!NOTE]
> Azure Site Recovery агент службы Mobility Service поддерживает только **прокси-серверы без проверки подлинности**.

### <a name="fix-the-problem"></a>Устранение проблемы

Чтобы разрешить [необходимые URL-адреса](azure-to-azure-about-networking.md#outbound-connectivity-for-urls) или [диапазоны IP-](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags)адресов, выполните действия, описанные в [документе Руководство](site-recovery-azure-to-azure-networking-guidance.md)по работе с сетями.

## <a name="next-steps"></a>Дальнейшие шаги

[Репликация виртуальных машин Azure в другой регион Azure](azure-to-azure-how-to-enable-replication.md)
