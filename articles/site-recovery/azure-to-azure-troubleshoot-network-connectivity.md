---
title: Устранение неполадок подключения к аварийному восстановлению Azure в Azure с помощью Azure Site Recovery
description: Устранение неполадок подключения в аварийном восстановлении виртуальной машины Azure
author: sideeksh
manager: rochakm
ms.topic: how-to
ms.date: 08/05/2019
ms.openlocfilehash: d55f06669a538c2f26f3a1d2da0d96a73529f76e
ms.sourcegitcommit: b5106424cd7531c7084a4ac6657c4d67a05f7068
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75941471"
---
# <a name="troubleshoot-azure-to-azure-vm-network-connectivity-issues"></a>Устранение неполадок с сетевым подключением Azure к виртуальной машине Azure

В этой статье описаны распространенные проблемы, связанные с сетевым подключением при репликации и восстановлении виртуальных машин Azure из одного региона в другой. Дополнительные сведения о требованиях к сети см. в статье [требования к подключению для репликации виртуальных машин Azure](azure-to-azure-about-networking.md).

Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина находится за брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, могут возникнуть следующие проблемы.

**URL-адрес** | **Сведения**  
--- | ---
*.blob.core.windows.net | Это необходимо, чтобы данные можно было записать в учетную запись хранения кэша в исходном регионе из виртуальной машины. Если вы знакомы со всеми учетными записями хранения кэша для виртуальных машин, вы можете разрешить-перечислить определенные URL-адреса учетных записей хранения (например, cache1.blob.core.windows.net и cache2.blob.core.windows.net) вместо *. blob.core.windows.net
login.microsoftonline.com | Требуется для авторизации и проверки подлинности URL-адресов службы Site Recovery.
*.hypervrecoverymanager.windowsazure.com | Требуется для обмена данными между службой Site Recovery и виртуальной машиной. Можно использовать соответствующий "Site Recovery IP", если прокси-сервер брандмауэра поддерживает IP.
*.servicebus.windows.net | Необходимые для записи данные наблюдения и диагностики Site Recovery из виртуальной машины. Можно использовать соответствующий IP-адрес мониторинга Site Recovery, если прокси-сервер брандмауэра поддерживает IP.

## <a name="outbound-connectivity-for-site-recovery-urls-or-ip-ranges-error-code-151037-or-151072"></a>Исходящие подключения для URL-адресов Site Recovery или IP-диапазонов (код ошибки 151037 или 151072)

## <a name="issue-1-failed-to-register-azure-virtual-machine-with-site-recovery-151195-br"></a>Ошибка 1. не удалось зарегистрировать виртуальную машину Azure с Site Recovery (151195) </br>
- **Возможная причина** </br>
  - Не удается установить подключение к Site Recovery конечным точкам из-за сбоя разрешения DNS.
  - Это чаще наблюдается во время повторной защиты, когда вы выполнили отработку отказа виртуальной машины, но DNS-сервер недоступен из региона аварийного восстановления.

- **Способы устранения:**
   - Если вы используете настраиваемую службу DNS, убедитесь, что DNS-сервер доступен из региона аварийного восстановления. Чтобы проверить, есть ли у вас настраиваемый DNS-сервер, выберите "Виртуальная машина", затем щелкните сеть аварийного восстановления и выберите "DNS-серверы". Попробуйте получить доступ к DNS-серверу с виртуальной машины. Если она недоступна, сделайте ее доступной, выполнив отработку отказа DNS-сервера или создав линию сайта между сетью аварийного восстановления и DNS.

    ![com-error](./media/azure-to-azure-troubleshoot-errors/custom_dns.png)


## <a name="issue-2-site-recovery-configuration-failed-151196"></a>Проблема 2. Сбой при выполнении настройки Site Recovery (151196)

> [!NOTE]
> Если виртуальные машины находятся за **стандартным** внутренним подсистемой балансировки нагрузки, по умолчанию он не имел доступа к IP-адресам O365 (то есть Login.microsoftonline.com). Либо измените его на **базовый** тип внутренней подсистемы балансировки нагрузки, либо создайте исходящий доступ, как упоминалось в [статье](https://aka.ms/lboutboundrulescli).

- **Возможная причина** </br>
  - Не удается подключиться к конечным точкам IP4 удостоверения и проверки подлинности Office 365.

- **Способы устранения:**
  - Обеспечьте доступ Azure Site Recovery для выполнения проверки подлинности диапазонов IP-адресов Office 365.
    Если вы используете правила группы безопасности сети Azure (NSG) или прокси-сервер брандмауэра для управления исходящим сетевым подключением на виртуальной машине, разрешите обмен данными с диапазонами IP-адресов Office 365. Создание правила NSG на основе [тега службы Azure Active Directory (Azure AD)](../virtual-network/security-overview.md#service-tags) для разрешения доступа ко всем IP-адресам, СООТВЕТСТВУЮЩИМ Azure AD
      - Если в будущем в Azure AD добавляются новые адреса, необходимо создать новые правила NSG.

### <a name="example-nsg-configuration"></a>Конфигурация примера группы безопасности сети

В этом примере показано, как настроить правила NSG для репликации виртуальной машины.

- При использовании правил NSG для управления исходящими подключениями используйте правило "Разрешить исходящие подключения по HTTPS" через порт 443 для всех необходимых диапазонов IP-адресов.
- В этом примере предполагается, что исходное расположение виртуальной машины — "Восточная часть США", а конечное — "Центральная часть США".

### <a name="nsg-rules---east-us"></a>Правила NSG. Восточная часть США

1. Создайте правило безопасности исходящих подключений HTTPS (443) для Storage.EastUS в NSG, как показано на снимке экрана ниже.

      ![storage-tag](./media/azure-to-azure-about-networking/storage-tag.png)

2. Создайте правило безопасности исходящих подключений HTTPS (443) для AzureActiveDirectory в NSG, как показано на снимке экрана ниже.

      ![Тег aad](./media/azure-to-azure-about-networking/aad-tag.png)

3. Создайте правила исходящих подключений HTTPS (443) для IP-адресов Site Recovery, соответствующих целевому расположению:

   **Местоположение** | **IP-адрес Site Recovery** |  **IP-адрес мониторинга Site Recovery**
    --- | --- | ---
   Центральная часть США | 40.69.144.231 | 52.165.34.144

### <a name="nsg-rules---central-us"></a>Правила NSG. Центральная часть США

Эти правила необходимы, чтобы включить репликацию из целевого в исходный регион после отработки отказа:

1. Создайте правило безопасности исходящих подключений HTTPS (443) для Storage.CentralUS в NSG.

2. Создайте правило безопасности исходящих подключений HTTPS (443) для AzureActiveDirectory в NSG.

3. Создайте правила исходящих подключений HTTPS (443) для IP-адресов Site Recovery, соответствующих исходному расположению:

   **Местоположение** | **IP-адрес Site Recovery** |  **IP-адрес мониторинга Site Recovery**
    --- | --- | ---
   Центральная часть США | 13.82.88.226 | 104.45.147.24
## <a name="issue-3-site-recovery-configuration-failed-151197"></a>Проблема 3. Сбой при выполнении настройки Site Recovery (151197)
- **Возможная причина** </br>
  - Не удается подключиться к конечным точкам службы Azure Site Recovery.

- **Способы устранения:**
  - Обеспечение доступа Azure Site Recovery к [диапазонам IP-адресов Site Recovery](https://docs.microsoft.com/azure/site-recovery/azure-to-azure-about-networking#outbound-connectivity-for-ip-address-ranges) зависит от региона. Обеспечьте доступ к нужным диапазонам IP-адресов с виртуальной машины.


## <a name="issue-4-a2a-replication-failed-when-the-network-traffic-goes-through-on-premises-proxy-server-151072"></a>Причина 4. не удалось выполнить репликацию A2A, если сетевой трафик проходит через локальный прокси-сервер (151072)
- **Возможная причина** </br>
  - Недопустимые параметры настраиваемого прокси-сервера, Azure Site Recovery агент службы мобильности не обнаружил параметры прокси-сервера в IE автоматически


- **Способы устранения:**
  1. Агент службы Mobility Service обнаруживает настройки прокси-сервера из Internet Explorer в ОС Windows и в каталоге /etc/environment в ОС Linux.
  2. Если вы предпочитаете настроить прокси-сервер только для Azure Site Recovery службы Mobility Service, вы можете указать сведения о прокси-сервере в файле Проксинфо. conf, расположенном по адресу:</br>
     - ``/usr/local/InMage/config/`` в ***Linux***
     - ``C:\ProgramData\Microsoft Azure Site Recovery\Config`` в ***Windows***
  3. Файл ProxyInfo.conf должен содержать параметры прокси-сервера в таком формате INI.</br>
                *[proxy]*</br>
                *Address=http://1.2.3.4*</br>
                *Port=567*</br>
  4. Azure Site Recovery агент службы Mobility Service поддерживает только ***прокси-серверы без проверки подлинности***.

### <a name="fix-the-problem"></a>Устранение проблемы
Чтобы разрешить [необходимые URL-адреса](azure-to-azure-about-networking.md#outbound-connectivity-for-urls) или [диапазоны IP-](azure-to-azure-about-networking.md#outbound-connectivity-for-ip-address-ranges)адресов, выполните действия, описанные в [документе Руководство](site-recovery-azure-to-azure-networking-guidance.md)по работе с сетями.


## <a name="next-steps"></a>Дальнейшие действия
[Репликация виртуальных машин Azure](site-recovery-replicate-azure-to-azure.md)
