---
title: Отработка отказа и обратное переключение виртуальных машин VMware и физических серверов во время аварийного восстановления в Azure с помощью Site Recovery | Документация Майкрософт
description: Сведения об отработке отказа виртуальных машин VMware и физических серверов в Azure и обратное переключение на локальную среду во время аварийного восстановления в Azure с помощью Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
services: site-recovery
ms.topic: tutorial
ms.date: 04/08/2019
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 7a089b3e4d7b8a38f2bf88c8ccf6e269331589be
ms.sourcegitcommit: e9a46b4d22113655181a3e219d16397367e8492d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2019
ms.locfileid: "65966283"
---
# <a name="fail-over-and-fail-back-vmware-vms"></a>Отработка отказа и восстановление размещения виртуальных машин VMware

В этой статье описан процесс отработки отказа локальной виртуальной машины VMware в [Azure Site Recovery](site-recovery-overview.md).

Это пятый учебник в серии, в которой показано, как настроить аварийное восстановление для локальных компьютеров в Azure.

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Проверка соответствия свойств виртуальной машины VMware требованиям Azure.
> * Отработка отказа в Azure.

> [!NOTE]
> В учебниках описан самый простой способ развертывания для определенного сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Дополнительные сведения об отработке отказа см. в статье [Fail over VMs and physical servers](site-recovery-failover.md) (Отработка отказа виртуальных машин и физических серверов).

## <a name="before-you-start"></a>Перед началом работы

Выполните инструкции, приведенные в предыдущих учебниках:

1. [Настройте Azure](tutorial-prepare-azure.md) для локального аварийного восстановления виртуальных машин VMware, Hyper-V и физических компьютеров в Azure.
2. Подготовьте локальную среду [VMware](vmware-azure-tutorial-prepare-on-premises.md) или [Hyper-V](hyper-v-prepare-on-premises-tutorial.md) для аварийного восстановления. Если вы настраиваете аварийное восстановление для физических серверов, ознакомьтесь с [матрицей поддержки](vmware-physical-secondary-support-matrix.md).
3. Настройте аварийное восстановление для [виртуальных машин VMware](vmware-azure-tutorial.md), [виртуальных машин Hyper-V](hyper-v-azure-tutorial.md) или [физических компьютеров](physical-azure-disaster-recovery.md).
4. Запустите [тренировку аварийного восстановления](tutorial-dr-drill-azure.md), чтобы убедиться, что все работает как положено.

## <a name="failover-and-failback"></a>Отработка отказа и восстановление размещения

Отработка отказа и восстановление размещения выполняются в четыре этапа.

1. **Отработка отказа с переходом в Azure.** Если локальный основной сайт стал недоступным, выполните отработку отказа компьютеров в Azure. После выполнения отработки отказа из реплицированных данных создаются виртуальные машины Azure.
2. **Повторное включение защиты виртуальных машин Azure.** В Azure повторно включите защиту виртуальных машин Azure, чтобы начать их репликацию в виртуальные машины VMware, запущенные на локальном сайте. Во время повторного включения защиты локальная виртуальная машина отключается, что обеспечивает согласованность данных.
3. **Отработка отказа с переходом на другой ресурс в локальной среде.** Если ваш локальный сайт запущен и работает, выполните отработку отказа, чтобы затем выполнить восстановление размещения из Azure.
4. **Повторное включение защиты локальных виртуальных машин.** После восстановления данных повторно включите защиту виртуальных машин, запущенных на локальном сайте, на которые выполнено восстановление размещения, чтобы начать их репликацию в Azure.

## <a name="verify-vm-properties"></a>Проверка свойств виртуальной машины

Перед запуском отработки отказа проверьте свойства виртуальной машины и убедитесь, что виртуальная машина соответствует [требованиям Azure](vmware-physical-azure-support-matrix.md#replicated-machines).

Укажите следующие свойства.

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы**, а затем выберите виртуальную машину, которую необходимо проверить.

2. В области **Реплицированный элемент** находятся сводные данные о виртуальной машине, включая состояние работоспособности и последние доступные точки восстановления. Выберите **Свойства**, чтобы просмотреть дополнительные сведения.

3. В разделе **Вычисления и сеть** при необходимости вы можете изменить эти свойства:
    * имя Azure;
    * Группа ресурсов
    * целевой размер;
    * [группа доступности;](../virtual-machines/windows/tutorial-availability-sets.md)
    * параметры управляемого диска.

4. Вы можете просмотреть и изменить параметры сети, включая:

    * сеть и подсеть, в которых будет размещена виртуальная машина Azure после отработки отказа;
    * IP-адрес, который будет ей назначен.

5. В разделе **Диски** отображаются сведения о дисках операционной системы и дисках данных на виртуальной машине.

## <a name="run-a-failover-to-azure"></a>Отработка отказа в Azure

1. Щелкните **Параметры** > **Реплицированные элементы**, выберите виртуальную машину для отработки отказа, а затем — **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
   * **Последняя**. В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение целевой точки восстановления (RPO), так как виртуальная машина Azure, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
   * **Последняя обработанная**. Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
   * **Последняя с согласованием приложений**. Отработка отказа виртуальной машины выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery.
   * **Настраиваемая**. Этот параметр позволяет указать точку восстановления.

3. Выберите **Shut down machine before beginning failover** (Завершение работы виртуальной машины перед началом отработки отказа), чтобы попытаться выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.

В некоторых сценариях требуется дополнительная обработка отработки отказа, которая длится около 8–10 минут. Тестовая отработка отказа может занимать больше времени для следующих систем:

* виртуальные машины VMware, использующие Службу мобильности версии ниже 9.8;
* физические серверы;
* виртуальные машины Linux VMware;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware без включенной службы DHCP;
* виртуальные машины VMware без загрузочных драйверов storvsc, vmbus, storflt, intelide, atapi.

> [!WARNING]
> Не отменяйте отработку отказа в процессе выполнения. Перед началом отработки отказа репликация виртуальной машины останавливается. Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.

## <a name="connect-to-failed-over-vm"></a>Подключение к виртуальной машине, на которой выполнялась отработка отказа

1. Если после отработки отказа вы хотите подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола (RDP) и Secure Shell (SSH), [убедитесь, что выполнены требования](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover).
2. После отработки отказа перейдите к виртуальной машине и проверьте [подключение](../virtual-machines/windows/connect-logon.md) к ней.
3. Используйте параметр **Изменить точку восстановления** при необходимости выбрать другую точку восстановления после отработки отказа. После фиксации отработки отказа на следующем шаге этот параметр будет недоступным.
4. После проверки выберите **Зафиксировать**, чтобы завершить подготовку точки восстановления виртуальной машины после отработки отказа.
5. После этого все остальные доступные точки восстановления будут удалены. На этом шаге отработка отказа будет завершена.

>[!TIP]
> Если после отработки отказа с подключением возникли проблемы, выполните шаги, описанные в руководстве по [устранению неполадок](site-recovery-failover-to-azure-troubleshoot.md).

## <a name="next-steps"></a>Дополнительная информация

Выполнив отработку отказа, повторно включите защиту виртуальных машин Azure в локальной среде. После включения защиты виртуальных машин и репликации их на локальный сайт, выполните восстановление размещения из Azure.

> [!div class="nextstepaction"]
> [Reprotect and fail back machines to an on-premises site after failover to Azure](vmware-azure-reprotect.md)(Повторное включение защиты виртуальных машин и восстановление их размещения на локальный сайт после отработки отказа в Azure)
> [Восстановление размещения виртуальных машин VMware и физических серверов из Azure на локальный сайт](vmware-azure-failback.md)
