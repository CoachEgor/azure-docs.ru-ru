---
title: Настройка репликации для виртуальных машин Azure в Azure Site Recovery | Документация Майкрософт
description: В этой статье описывается, как настроить репликацию для виртуальных машин Azure между регионами Azure с помощью Site Recovery.
services: site-recovery
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 04/29/2018
ms.author: asgang
ms.openlocfilehash: 86bd41d518006b0601a5c9d18e5429f76d5a4fc5
ms.sourcegitcommit: 2028fc790f1d265dc96cf12d1ee9f1437955ad87
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/30/2019
ms.locfileid: "64926622"
---
# <a name="replicate-azure-vms-to-another-azure-region"></a>Репликация виртуальных машин Azure в другой регион Azure


В этой статье описывается, как включить репликацию виртуальных машин Azure между регионами Azure.

## <a name="before-you-start"></a>Перед началом работы

В этой статье предполагается, что после подготовки к развертыванию Site Recovery, как описано в разделе [руководстве Azure в Azure аварийного восстановления](azure-to-azure-tutorial-enable-replication.md).

Предварительные требования должны быть выполнены, и необходимо создать хранилище служб восстановления.


## <a name="enable-replication"></a>Включение репликации

Включите репликацию. Предполагается, что основной регион Azure — это "Восточная Азия", а дополнительный — "Юго-Восточная Азия".

1. В хранилище щелкните **+Replicate** (+Репликация).
2. Обратите внимание на следующие поля:
   - **Источник**. Источник происхождения виртуальных машин, в нашем примере это **Azure**.
   - **Расположение источника**. Регион Azure, где требуется защита виртуальных машин. В этом примере исходным расположением является "Восточная Азия".
   - **Модель развертывания**. Модель развертывания Azure для исходных компьютеров.
   - **Исходная подписка**. Подписка, к которой принадлежат исходные виртуальные машины. Это может быть любая подписка в одном клиенте Azure Active Directory, где существует хранилище служб восстановления.
   - **Группа ресурсов**. Группа ресурсов, к которой принадлежат исходные виртуальные машины. Для защиты на следующем шаге будут перечислены все виртуальные машины в выбранной группе ресурсов.

     ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/enabledrwizard1.png)

3. В разделе **Виртуальные машины > Выбор виртуальных машин** выберите все виртуальные машины, которые нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.
    ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/virtualmachine_selection.png)

4. В разделе **Параметры** можно при необходимости настроить параметры целевого веб-сайта:

   - **Целевое расположение**. Расположение, в которое будут реплицированы данные исходных виртуальных машин. В зависимости от расположения выбранной машины Site Recovery предоставит список подходящих целевых регионов. Мы рекомендуем сохранить такое же целевое расположение, что и расположение хранилищ служб восстановления.
   - **Целевая подписка**. Целевая подписка, которая используется для аварийного восстановления. По умолчанию целевая подписка будет совпадать с исходной подпиской.
   - **Целевая группа ресурсов**. Группа ресурсов, в которой будут находиться все реплицированные виртуальные машины.
       - По умолчанию Site Recovery создает группу ресурсов в целевом регионе с суффиксом «asr» в имени.
       - Если группа ресурсов, созданные Site Recovery, уже существует, она используется повторно.
       - Можно настроить параметры группы ресурсов.
       - Расположение целевой группы ресурсов может быть любым регионом Azure, за исключением региона, в котором размещаются исходные виртуальные машины.
   - **Целевая виртуальная сеть**. По умолчанию Site Recovery создает виртуальную сеть в целевом регионе с суффиксом «asr» в имени. Она будет сопоставлена с исходной сетью и будет использоваться для защиты в будущем. [Узнайте больше](site-recovery-network-mapping-azure-to-azure.md) о сетевом сопоставлении.
   - **Целевые учетные записи хранения (исходная виртуальная машина не использует управляемые диски)**: По умолчанию Site Recovery создает целевую учетную запись хранения, копируя конфигурацию хранилища с исходной виртуальной машины. В случае, если учетная запись хранения уже существует, она используется повторно.
   - **Реплика управляемых дисков (исходная виртуальная машина использует управляемые диски)**: Site Recovery создает новые диски, управляемые реплики в целевом регионе, которые отражают управляемые диски исходной Виртуальной машины с тем же типом хранилища ("стандартный" или "премиум"), что и у исходной виртуальной Машины в управляемый диск.
   - **Учетные записи хранения кэша**. Для Site Recovery в исходном регионе должна существовать дополнительная учетная запись хранения, называемая учетной записью хранения кэша. Все изменения, происходящие на исходных виртуальных машинах, отслеживаются и отправляются учетной записи хранения кэша перед репликацией в целевое расположение.
   - **Целевые группы доступности**. По умолчанию Site Recovery создает группу доступности в целевом регионе с суффиксом «asr» в имени, для виртуальных машин, которые являются частью группы доступности в исходном регионе. Если группа доступности, создаваемая Site Recovery, уже существует, она используется повторно.
   - **Целевые зоны доступности**. По умолчанию Site Recovery назначает в целевом регионе тот же номер зоны, что и в исходном регионе, если целевой регион поддерживает зоны доступности.

     Если целевой регион не поддерживает зоны доступности, целевые виртуальные машины настраиваются как отдельные экземпляры по умолчанию. При необходимости можно включить такие виртуальные машины в группы доступности в целевом регионе. Для этого нажмите кнопку "Настроить".

     >[!NOTE]
     >После включения репликации изменить тип доступности (один экземпляр), группу доступности или зону доступности нельзя. Чтобы изменить тип доступности, необходимо отключить и повторно включить репликацию.
     >
    
   - **Политика репликации**. Определяет параметры для журнала хранения точки восстановления и периодичность создания моментальных снимков, совместимых на уровне приложений. По умолчанию Azure Site Recovery создает политику репликации с параметрами по умолчанию "24 часа" для хранения точки восстановления и "60 минут" — для периодичности создания моментальных снимков с согласованием приложений.

     ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/enabledrwizard3.PNG)

### <a name="enable-replication-for-added-disks"></a>Включение репликации для добавленных дисков

При добавлении дисков к виртуальной Машине Azure, для которой включена репликация, происходит следующее:
-   Работоспособность репликации для виртуальной Машины отображает предупреждение и Примечание информирует о том, что один или дополнительные диски доступны для защиты.
-   Если включить защиту для всех добавленных дисков, предупреждение исчезнет после начальной репликации диска.
-   Если вы не захотите включить репликацию для диска, можно выбрать, чтобы отклонить предупреждение.

    
    ![Добавлен новый диск](./media/azure-to-azure-how-to-enable-replication/newdisk.png)

Чтобы включить репликацию для добавленного диска, сделайте следующее:

1.  В хранилище > **реплицированные элементы**, щелкните виртуальную Машину, к которому вы добавили диск.
2.  Нажмите кнопку **диски**, а затем выберите диск данных, для которого вы хотите включить репликацию (эти диски имеют **не защищен** состояния).
3.  В **сведения о дисках**, нажмите кнопку **включить репликацию**.

    ![Включение репликации для добавленного диска](./media/azure-to-azure-how-to-enable-replication/enabled-added.png)

После выполнения задания репликации enable и завершения первоначальной репликации предупреждение о работоспособности репликации для проблемы диск удаляется.


  
## <a name="customize-target-resources"></a>Настройка целевых ресурсов

Можно изменить целевые параметры по умолчанию, используемые Site Recovery.

1. Нажмите кнопку **Настройка** рядом с пунктом "Целевая подписка", чтобы изменить целевую подписку по умолчанию. Выберите подписку из списка подписок, доступных в одном клиенте Azure Active Directory (AAD).

2. Щелкните **Настроить**, чтобы изменить параметры по умолчанию:
    - **Целевая группа ресурсов**. Выберите группу ресурсов из списка групп ресурсов в целевом расположении подписки.
    - **Target Virtual Network** (Целевая виртуальная сеть). Выберите сеть из списка всех виртуальных сетей в целевой локации.
    - **Группа доступности**. Здесь можно добавить параметры группы доступности для виртуальной машины, если она является частью группы доступности исходного региона.
    - **Target Storage accounts** (Целевые учетные записи хранения). Выберите учетную запись хранения, которую нужно использовать.

        ![Включение репликации](./media/site-recovery-replicate-azure-to-azure/customize.PNG)
3. Щелкните **Настроить**, чтобы изменить настройки репликации.
4. В **согласованности нескольких виртуальных Машин**, выберите виртуальные машины, которые требуется реплицировать друг с другом.
    - На всех компьютерах в группе репликации будут общие отказоустойчивые и согласованные точки восстановления после отработки отказа.
    - Включение согласованности нескольких виртуальных Машин может повлиять на производительность рабочей нагрузки (так как это интенсивное использование ресурсов ЦП). Он должен включаться только в том случае, если компьютеры выполняют ту же рабочую нагрузку и должны действовать согласованно между несколькими компьютерами.
    - Например если приложение имеет две виртуальные машины SQL Server и два веб-сервера, то необходимо добавить только ВМ SQL Server в группу репликации.
    - Вы можете иметь не более 16 виртуальных машин в группе репликации.
    - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004.
    - Убедитесь, брандмауэр не блокирует внутренний обмен данными между виртуальными машинами через порт 20004.
    - Если требуется, чтобы виртуальные машины Linux входит в группу репликации, убедитесь, что вручную открыть исходящий трафик через порт 20004 согласно рекомендации для конкретной версии Linux.
![Включение репликации](./media/site-recovery-replicate-azure-to-azure/multivmsettings.PNG)
    
5. Щелкните **Create target resource** (Создать целевой ресурс) > **Включить репликацию**.
6. После включения репликации виртуальных машин можно проверить их состояние работоспособности в разделе **Реплицированные элементы**.

>[!NOTE]
>Во время начальной репликации обновление состояния может занять некоторое время (без видимого прогресса). Щелкните **Обновить**, чтобы получить последние сведения о состоянии задания.
>

# <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о выполнении тестовой отработки отказа см. в [этой статье](site-recovery-test-failover-to-azure.md).
