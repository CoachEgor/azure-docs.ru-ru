---
title: Архитектура аварийного восстановления VMware VM в восстановлении сайта Azure
description: В этой статье представлен обзор компонентов и архитектуры, используемых при настройке аварийного восстановления виртуальных машин VMware из локальной среды в Azure с помощью Azure Site Recovery.
author: rayne-wiselman
ms.service: site-recovery
services: site-recovery
ms.topic: conceptual
ms.date: 11/06/2019
ms.author: raynew
ms.openlocfilehash: 77b4dd4c0efbe6d03e64865f18c2c87614aaecb5
ms.sourcegitcommit: d597800237783fc384875123ba47aab5671ceb88
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2020
ms.locfileid: "80632523"
---
# <a name="vmware-to-azure-disaster-recovery-architecture"></a>Архитектура аварийного восстановления из VMware в Azure

В этой статье описаны архитектура и процессы, используемые при развертывании репликации для аварийного восстановления, отработки отказов и восстановления виртуальных машин VMware между локальным сайтом VMware и Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).


## <a name="architectural-components"></a>Компоненты архитектуры

Приведенные ниже таблица и рисунки позволяют получить общее представление о компонентах, используемых для аварийного восстановления VMware в Azure.

**Компонент** | **Требование** | **Сведения**
--- | --- | ---
**Azure** | Подписка Azure, учетная запись хранилища Azure для кэша, управляемого диска и сети Azure. | Реплицированные данные с локальной всасывайки хранятся в хранилище Azure. Виртуальные машины Azure создаются с использованием реплицированных данных при запуске отработки отказа из локальной среды в Azure. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Компьютер сервера конфигурации** | Отдельный локальный компьютер. Мы рекомендуем использовать виртуальную машину VMware, которую можно развернуть с помощью скачанного шаблона в формате OVF.<br/><br/> На этой машине выполняются все локальные компоненты Site Recovery, включая сервер конфигурации, сервер обработки и главный целевой сервер. | **Сервер конфигурации** используется для управления обменом данными между локальной средой и Azure, а также репликацией данных.<br/><br/> **Сервер обработки** по умолчанию устанавливается на сервере конфигурации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Сервер обработки также устанавливает службу Mobility Service Azure Site Recovery на виртуальные машины, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных компьютеров. По мере увеличения масштаба развертывания вы можете добавлять дополнительные отдельные серверы для обработки растущего объема данных репликации.<br/><br/> **Главный целевой сервер** по умолчанию устанавливается на сервере конфигурации. Он обрабатывает данные репликации при восстановлении размещения из Azure. Для крупных развертываний вы можете добавить отдельный главный целевой сервер для восстановления размещения.
**Серверы VMware** | Виртуальные машины VMware размещаются на локальных серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter. | При развертывании Site Recovery добавьте серверы VMware в хранилище служб восстановления.
**Реплицируемые компьютеры** | Служба Mobility Service устанавливается на каждой реплицируемой виртуальной машине VMware. | Рекомендуем разрешить автоматическую установку с сервера обработки. Кроме того, можно установить службу вручную или использовать автоматизированный метод развертывания, например configuration Manager.

**Архитектура: VMware — Azure**

![Компоненты](./media/vmware-azure-architecture/arch-enhanced.png)


## <a name="replication-process"></a>Процесс репликации

1. При включении репликации для виртуальной машины начинается начальная репликация в службу хранилища Azure с помощью указанной политики репликации. Следует отметить следующее.
    - Для виртуальных машин VMware репликации осуществляются на уровне блока почти непрерывно с помощью агента Mobility Service на виртуальной машине.
    - Параметры политики репликации применяются к следующим элементам:
        - **Пороговое значение RPO**. Этот параметр не влияет на репликацию. Он помогает с мониторингом. Будет создано событие, возможно, с отправкой сообщения электронной почты, если текущее значение RPO превышает заданное вами пороговое значение.
        - **Удержание точки восстановления**. Этот параметр указывает, на какой период в прошлом вы хотите вернуться в случае нарушения работы. Максимальный срок хранения в хранилище класса "Премиум" — 24 часа. В хранилище категории "Стандартный" — 72 часа. 
        - **Согласованные с приложением моментальные снимки**. Снимок приложения может быть сделан каждые 1–12 часов, в зависимости от потребностей приложения. Это стандартные моментальные снимки BLOB-объектов Azure. Агент службы Mobility, запущенный на виртуальной машине, запрашивает моментальный снимок VSS в соответствии с этим параметром и отмечает этот момент времени как точку согласованности приложения в потоке репликации.

2. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, вы можете использовать Azure ExpressRoute с [помощью пиринга Майкрософт.](../expressroute/expressroute-circuit-peerings.md#microsoftpeering) Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.
3. Первоначальная операция репликации гарантирует, что все данные на машине во время репликации включить будут отправлены в Azure. После завершения начальной репликации начинается репликация разностных изменений в Azure. Отслеживаемые изменения для машины отправляются на сервер обработки.
4. Обмен данными происходит следующим образом.

    - Виртуальные машины обмениваются данными с локальным сервером конфигурации через HTTPS-порт 443 для входящих подключений, чтобы управлять репликацией.
    - Сервер конфигурации выполняет оркестрацию репликации в Azure через HTTPS-порт 443 для исходящих подключений.
    - Виртуальные машины отправляют данные репликации на сервер обработки (запущенный на компьютере сервера конфигурации) через HTTPS-порт 9443 для входящих подключений. Этот порт можно изменить.
    - Сервер процесса получает данные репликации, оптимизирует и шифрует их и отправляет в хранилище Azure через исходящий порт 443.
5. Данные репликации сначала приземляются в учетную запись хранения кэша в Azure. Эти журналы обрабатываются, и данные хранятся в управляемом диске Azure (называемом диском семян asr). Точки восстановления создаются на этом диске.

**Процедура репликации VMware в Azure**

![Процесс репликации](./media/vmware-azure-architecture/v2a-architecture-henry.png)

## <a name="resynchronization-process"></a>Процедура повторной синхронизации

1. Иногда во время первоначальной репликации или при переносе дельта-износов могут возникать проблемы с подключением к сети между исходной машиной для обработки сервера или между сервером процесса в Azure. Любой из них может привести к сбоям в передаче данных в Azure на мгновение.
2. Чтобы избежать проблем с целостностью данных и минимизировать затраты на передачу данных, восстановление сайта означает машину для ресинхронизации.
3. Машина также может быть помечена для ресинхронизации в таких ситуациях, как следующие для поддержания согласованности между машиной исходного кода и данными, хранящимися в Azure
    - Если машина подвергается принудительному отключению
    - Если машина подвергается изменениям конфигурации, таким как изменение размера диска (изменение размера диска от 2 ТБ до 4 ТБ)
4. Ресинхронизация отправляет в Azure только данные дельты. Передача данных между локальной и Azure путем минимизации путем вычисления чеков данных между машиной исходного кода и данными, хранящимися в Azure.
5. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Если вы не хотите ждать времени повторной синхронизации по умолчанию, то можете повторно синхронизировать виртуальную машину вручную. Для этого перейдите на портал Azure, выберите VM > **Resynchronize.**
6. Если ресинхронизация по умолчанию не удается в нерабочее время и требуется ручное вмешательство, то на конкретной машине портала Azure создается ошибка. Можно устранить ошибку и вызвать ресинхронизацию вручную.
7. После завершения ресинхронизации, репликация дельта изменения возобновятся.

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

Настроив репликацию и выполнив отработку аварийного восстановления (тестовую отработку отказа), чтобы проверить правильность работы всех компонентов, вы можете запускать отработку отказа и восстановление размещения по мере необходимости.

1. Можно выполнять отработку отказа отдельных компьютеров или создать планы восстановления, чтобы выполнять отработку отказа сразу нескольких виртуальных машин. План восстановления имеет следующие преимущества перед отработкой отказа отельных компьютеров:
    - Можно моделировать зависимости приложений, включив все виртуальные машины для приложения в один план восстановления.
    - Можно добавить сценарии, модули runbook Azure и паузу для действий, выполняемых вручную.
2. После активации начальной отработки отказа выполняется ее фиксация для получения доступа к рабочей нагрузке из виртуальной машины Azure.
3. Когда основной локальный сайт снова станет доступным, можно будет подготовить среду к восстановлению размещения. Для восстановления размещения следует настроить инфраструктуру восстановления размещения, включая следующее:

    * **Временный сервер процесса в Azure:** Чтобы выйти из Azure, вы настроили VM Azure, чтобы выступать в качестве сервера процесса для обработки репликации из Azure. После восстановления размещения эту виртуальную машину можно удалить.
    * **VPN-подключение.** Для восстановления размещения нужно настроить VPN-подключение (или ExpressRoute) между сетью Azure и локальным сайтом.
    * **Отдельный основной целевой сервер:** По умолчанию, главный целевой сервер, который был установлен с сервером конфигурации на предприимчном VMware VM ручки failback. Чтобы восстановить размещение больших объемов трафика,отдельно настройте локальный главный целевой сервер.
    * **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Эта политика создается автоматически при создании политики репликации из локальной среды в Azure.
4. После готовности всех компонентов восстановление размещения выполняется в три этапа:

    - Этап 1. Повторно включите защиту виртуальных машин Azure, чтобы обеспечить их репликацию из Azure в локальные виртуальные машины VMware.
    -  Этап 2. Запустите отработку отказа на локальном сайте.
    - Этап 3. После восстановления размещения рабочих нагрузок повторно включите репликацию для локальных виртуальных машин.
    
 
**Восстановление размещения VMware с переносом из Azure**

![Восстановление размещения](./media/vmware-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с [этим учебником](vmware-azure-tutorial.md), чтобы включить репликацию из VMware в Azure.
