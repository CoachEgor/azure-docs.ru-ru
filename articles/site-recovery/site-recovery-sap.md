---
title: Настройка аварийного восстановления для многоуровневого развертывания приложения SAP NetWeaver с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье описывается, как настроить аварийное восстановление для развернутых приложений SAP NetWeaver с помощью Azure Site Recovery.
author: asgang
manager: rochakm
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.topic: conceptual
ms.date: 11/27/2018
ms.author: asgang
ms.openlocfilehash: 68efc039c5de5d7f61b7ce34e74c6c2cf4bad027
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61471601"
---
# <a name="set-up-disaster-recovery-for-a-multi-tier-sap-netweaver-app-deployment"></a>Настройка аварийного восстановления для многоуровневого развертывания приложения SAP NetWeaver

Для большинства развертываний большого и среднего размера SAP используется какая-либо разновидность решения аварийного восстановления. По мере переноса все большего числа ключевых бизнес-процессов в такие приложения, как SAP, повысилась важность надежных и тестируемых решений аварийного восстановления. Azure Site Recovery был протестирован и интегрирован с приложениями SAP. Служба Site Recovery превышает возможности большинства локальных решений аварийного восстановления. При этом ее совокупная стоимость владения (TCO) меньше, чем у конкурирующих решений.

Служба Site Recovery предоставляет следующие возможности:
* **защита рабочих приложений SAP NetWeaver и других приложений, запущенных в локальной среде**, с помощью репликации компонентов в Azure;
* **защита рабочих приложений SAP NetWeaver и других приложений, запущенных в Azure**, с помощью репликации компонентов в другой центр обработки данных Azure;
* **упрощение миграции в облако** благодаря использованию Site Recovery для переноса развертывания SAP в Azure;
* **упрощение обновления, тестирования и создания прототипов проектов SAP** путем создания рабочего клона по запросу для тестирования приложений SAP.

В этой статье описывается, как защитить развернутые приложения SAP NetWeaver с помощью [Azure Site Recovery](site-recovery-overview.md). В статье описаны рекомендации по защите трехуровневого развертывания SAP NetWeaver в Azure путем репликации в другой центр обработки данных Azure с помощью Site Recovery. Здесь описываются поддерживаемые сценарии, конфигурации и способы выполнения тестовой отработки отказа (тестового аварийного восстановления), а также фактическая отработка отказа.

## <a name="prerequisites"></a>Технические условия
Прежде чем начать, необходимо знать, как выполнять следующие задачи:

* [Репликация виртуальной машины в Azure](azure-to-azure-walkthrough-enable-replication.md).
* [Проектирование сети для аварийного восстановления](site-recovery-azure-to-azure-networking-guidance.md).
* [Выполнение тестовой отработки отказа в Azure](azure-to-azure-walkthrough-test-failover.md).
* [Выполнение отработки отказа в Azure](site-recovery-failover.md).
* [Репликация контроллера домена](site-recovery-active-directory.md).
* [Репликация SQL Server](site-recovery-sql.md)

## <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.
С помощью Site Recovery можно реализовать решение аварийного восстановления для приведенных ниже сценариев:
* Системы SAP, работающие в одном центре обработки данных Azure, реплицируются в другой центр обработки данных Azure (аварийное восстановление из Azure в Azure). Дополнительные сведения см. в статье [Azure to Azure replication architecture](https://aka.ms/asr-a2a-architecture) (Архитектура репликации из Azure в Azure).
* Системы SAP, выполняемые на локальных физических серверах или серверах VMware, которые реплицируются на сайт аварийного восстановления в центр обработки данных Azure (аварийное восстановление из VMware в Azure). Данному сценарию требуются некоторые дополнительные компоненты. Дополнительные сведения см. в статье [Архитектура репликации из VMware в Azure](https://aka.ms/asr-v2a-architecture).
* Системы SAP, выполняемые в локальных Hyper-V, которые реплицируются на сайт аварийного восстановления в центр обработки данных Azure (аварийное восстановление из VMware в Azure). Данному сценарию требуются некоторые дополнительные компоненты. Дополнительные сведения см. в статье [Архитектура репликации из Hyper-V в Azure](https://aka.ms/asr-h2a-architecture).

В этой статье используется сценарий аварийного восстановления **из Azure в Azure**, чтобы показать возможности аварийного восстановления SAP Site Recovery. Так как репликация Site Recovery не относится к приложению, описанный процесс применим к другим сценариям.

### <a name="required-foundation-services"></a>Требуемые основные службы
В сценарии, описанном в этой статье, развертываются следующие основные службы:
* Azure ExpressRoute или VPN-шлюз Azure;
* по крайней мере один контроллер домена Active Directory и DNS-сервер, работающий в Azure.

Рекомендуем развернуть эту инфраструктуру перед развертыванием Site Recovery.

## <a name="reference-sap-application-deployment"></a>Развертывание эталонного приложения SAP

Эта эталонная архитектура демонстрирует запуск SAP NetWeaver в высокодоступной среде Windows в Azure.  Эта архитектура развертывается с конкретными размерами виртуальных машин, которые можно изменить в соответствии с потребностями вашей организации.

![Схема обычного шаблона развертывания SAP](./media/site-recovery-sap/sap-netweaver_latest.png)

## <a name="disaster-recovery-considerations"></a>Рекомендации по аварийному восстановлению

Для аварийного восстановления необходимо выполнить отработку отказа в дополнительный регион. Каждый уровень использует разную стратегию обеспечения защиты посредством аварийного восстановления.

#### <a name="vms-running-sap-web-dispatcher-pool"></a>Виртуальные машины, на которых запущен пул Диспетчера SAP Web 
Компонент "веб-диспетчер" используется как подсистема балансировки нагрузки для трафика SAP между серверами приложений SAP. Чтобы обеспечить высокую доступность компонента Диспетчера SAP Web, Azure Load Balancer реализует параллельную настройку Диспетчера SAP Web в циклической конфигурации для распределения трафика HTTP/HTTPS среди доступных экземпляров Диспетчера SAP Web в пуле балансировщика. Он будет реплицирован с помощью Azure Site Recovery, а сценарии автоматизации будут использоваться для настройки подсистемы балансировки нагрузки в области аварийного восстановления. 

#### <a name="vms-running-application-servers-pool"></a>Виртуальные машины, на которых запущен пул серверов приложений
Для управления группами входа для серверов приложений ABAP используется транзакция SMLG. Она использует функцию балансировки нагрузки на сервере сообщений центральных служб для распределения рабочей нагрузки между пулом серверов приложений SAP для трафика SAPGUI и RFC. Она будет реплицирована с помощью Azure Site Recovery 

#### <a name="vms-running-sap-central-services-cluster"></a>Виртуальные машины, на которых запущен кластер центральных служб SAP
Эта эталонная архитектура запускает центральные службы на виртуальных машинах на уровне приложений. Центральные службы представляют собой потенциальную единую точку отказа (SPOF) при развертывании в одну виртуальную машину. Это обычное развертывание, при котором высокий уровень доступности не требуется.<br>

Чтобы реализовать решение высокого уровня доступности, можно использовать общий диск кластера или общий файл ресурса кластера. Для настройки виртуальных машин для кластеров общих дисков используйте отказоустойчивый кластер Windows Server. Рекомендуем использовать облако-свидетель в качестве свидетеля кворума. 
 > [!NOTE]
 > Azure Site Recovery не реплицирует облако-свидетель, так как рекомендуется развернуть облако-свидетель в регионе аварийного восстановления.

Чтобы поддержать среду отказоустойчивого кластера, [SIOS DataKeeper Cluster Edition](https://azuremarketplace.microsoft.com/marketplace/apps/sios_datakeeper.sios-datakeeper-8) выполняет функции общего тома кластера, реплицируя независимые диски, принадлежащие узлам кластера. Azure изначально не поддерживает общие диски и поэтому необходимы решения, предоставленные SIOS. 

Еще один способ использования кластеризации — реализовать кластер файловых ресурсов. В [SAP](https://blogs.sap.com/2018/03/19/migration-from-a-shared-disk-cluster-to-a-file-share-cluster) недавно изменили шаблон развертывания центральных служб для доступа к глобальным каталогам /sapmnt через UNC-путь. Однако мы по-прежнему рекомендуем убедиться, что общий ресурс /sapmnt (UNC) высокодоступен. Это можно сделать в экземпляре центральных служб с помощью отказоустойчивого кластера Windows Server с функцией масштабируемого файлового сервера (SOFS) и локальных дисковых пространств (S2D) в Windows Server 2016. 
 > [!NOTE]
 > В настоящее время поддержки Azure Site Recovery только о сбоях непротиворечивой точке репликации виртуальных машин с помощью хранилища пробелы прямых и пассивный узел SIOS Datakeeper


## <a name="disaster-recovery-considerations"></a>Рекомендации по аварийному восстановлению

Azure Site Recovery можно использовать, чтобы выполнить отработку отказа для всей среды SAP во всех регионах Azure.
Ниже перечислены шаги настройки аварийного восстановления 

1. Репликация виртуальных машин 
2. Проектирование сети для аварийного восстановления
3.  Репликация контроллера домена
4.  Репликация уровня базы данных 
5.  Выполнение тестовой отработки отказа 
6.  Выполнение отработки отказа 

Ниже приведена рекомендация для аварийного восстановления на каждом уровне, используемом в этом примере. 

 **Уровни SAP** | **Рекомендация**
 --- | ---
**Пул Диспетчера SAP Web** |  Репликация с помощью Site Recovery 
**Пул серверов приложений SAP** |  Репликация с помощью Site Recovery 
**Кластер центральных служб SAP** |  Репликация с помощью Site Recovery 
**Виртуальные машины Active Directory** |  Репликация Active Directory 
**Серверы баз данных SQL** |  Постоянная репликация SQL

## <a name="replicate-virtual-machines"></a>Репликация виртуальных машин

Чтобы начать, репликацию всех виртуальных машин приложений SAP в центре обработки данных аварийного восстановления Azure, следуйте указаниям в статье о [репликации виртуальных машин в Azure](azure-to-azure-walkthrough-enable-replication.md).


* Рекомендации по защите Active Directory и DNS см. в [соответствующем документе](site-recovery-active-directory.md).

* Рекомендации по защите уровня базы данных на сервере SQL Server см. в документе, посвященном [защите SQL Server](site-recovery-active-directory.md).

## <a name="networking-configuration"></a>Конфигурация сети

Если используется статический IP-адрес, вы можете указать нужный IP-адрес для виртуальной машины. Чтобы задать IP-адрес, откройте раздел **Compute and Network settings** (Параметры вычисления и сети) > **Network interface card** (Сетевой адаптер).

![Снимок экрана, показывающий, как установить частный IP-адрес в области карты сетевого интерфейса Site Recovery](./media/site-recovery-sap/sap-static-ip.png)


## <a name="creating-a-recovery-plan"></a>Создание плана восстановления
План восстановления позволяет воссоздать последовательность различных уровней в многоуровневом приложении во время отработки отказа. Благодаря этому обеспечивается целостность на уровне приложения. При создании плана восстановления для многоуровневого веб-приложения выполните действия, описанные в [этой статье](site-recovery-create-recovery-plans.md).

### <a name="adding-virtual-machines-to-failover-groups"></a>Добавление виртуальных машин в группы отработки отказа

1.  Создайте план восстановления, добавив сервер приложений, Диспетчер SAP Web и виртуальные машины центральных служб SAP.
2.  Щелкните "Настроить", чтобы сгруппировать виртуальные машины. По умолчанию все виртуальные машины входят в группу 1.



### <a name="add-scripts-to-the-recovery-plan"></a>Добавление сценариев в план восстановления
Чтобы настроить правильную работу приложений, вам может потребоваться выполнить некоторые операции после отработки отказа виртуальных машин Azure или во время тестовой отработки отказа. Вы можете настроить автоматическое выполнение некоторых операций после отработки отказа. Например, можно обновить записи DNS, изменить привязку сайта и подключение, добавив соответствующие сценарии в план восстановления.


Наиболее часто используемые сценарии Azure Site Recovery можно развернуть в учетной записи автоматизации, нажав кнопку "Развертывание в Azure" ниже. При использовании любого опубликованного сценария необходимо выполнять указанные в нем инструкции.

[![Развертывание в Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)

1. Добавьте сценарий предварительного действия в группу 1 для отработки отказа группы доступности SQL. Используйте сценарий ASR-SQL-FailoverAG, опубликованный в примерах сценариев. Обязательно выполните инструкции, предусмотренные сценарием, и внесите необходимые изменения в сценарий соответствующим образом.
2. Добавьте сценарий завершающего действия для подключения подсистемы балансировки нагрузки на восстановленных после отказа виртуальных машинах уровня Web (группа 1). Используйте сценарий ASR-AddSingleLoadBalancer, опубликованный в примерах сценариев. Обязательно выполните инструкции, предусмотренные сценарием, и внесите необходимые изменения в сценарий соответствующим образом.

![План восстановления SAP](./media/site-recovery-sap/sap_recovery_plan.png)


## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

1.  На портале Azure выберите хранилище служб восстановления.
2.  Выберите план восстановления, созданный для приложений SAP.
3.  Выберите **Тестовая отработка отказа**.
4.  Чтобы запустить тестовую отработку отказа, выберите точку восстановления и виртуальную сеть Azure.
5.  После запуска вторичной среды можно выполнить проверку.
6.  После завершения проверки выберите **Очистить тестовую отработку отказа**, чтобы очистить среду отработки отказа.

Дополнительные сведения см. в статье [Тестовая отработка отказа в Azure с помощью Site Recovery](site-recovery-test-failover-to-azure.md).

## <a name="run-a-failover"></a>Запуск отработки отказа

1.  На портале Azure выберите хранилище служб восстановления.
2.  Выберите план восстановления, созданный для приложений SAP.
3.  Выберите **Отработка отказа**.
4.  Чтобы запустить отработку отказа, выберите точку восстановления.

Дополнительные сведения см. в статье [Отработка отказа в Site Recovery](site-recovery-failover.md).

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о создании решения аварийного восстановления для развертываний SAP NetWeaver с помощью Site Recovery см. в скачиваемом техническом документе [SAP NetWeaver: Building a Disaster Recovery Solution with Azure Site Recovery](https://aka.ms/asr-sap) (SAP NetWeaver. Создание решения аварийного восстановления с помощью Azure Site Recovery). В этом техническом документе рассматриваются рекомендации для разных архитектур SAP, приводятся поддерживаемые приложения и типы виртуальных машин для SAP в Azure, а также описываются планы тестирования для решения аварийного восстановления.
* Узнайте больше о [репликации других рабочих нагрузок](site-recovery-workload.md) с помощью Site Recovery.
