---
title: Восстановление размещения при аварийном выполнении виртуальных машин Hyper-V из Azure в локальное пространство | Документация Майкрософт
description: Узнайте, как выполнить восстановление размещения виртуальных машин Hyper-V при их аварийном восстановлении в Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 09/12/2019
ms.author: rajanaki
ms.openlocfilehash: 07ecc8547ab155600bccfd1ad8f1ecbb58a18fa3
ms.sourcegitcommit: f3f4ec75b74124c2b4e827c29b49ae6b94adbbb7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2019
ms.locfileid: "70931841"
---
# <a name="run-a-failback-for-hyper-v-vms"></a>Восстановление размещения для виртуальных машин Hyper-V

В этой статье описывается восстановление размещения виртуальных машин Hyper-V, защищенных службой Site Recovery.

## <a name="prerequisites"></a>Предварительные требования

- Обязательно прочтите подробные сведения о [различных видах восстановления размещения](concepts-types-of-failback.md) и соответствующие предупреждения.
- Убедитесь, что сервер основного сайта VMM или сервер узла Hyper-V подключен к Azure.
- На виртуальной машине выполните **фиксацию**.
- Убедитесь, что вы используете учетную запись хранения для репликации, а не для управляемых дисков. Восстановление размещения виртуальных машин Hyper-V, реплицированных с помощью управления дисками, не поддерживается.

## <a name="perform-failback"></a>Восстановление размещения
После отработки отказа из основного расположения в дополнительное реплицированные виртуальные машины не будут защищены службой Site Recovery, а дополнительное расположение станет активным. Чтобы восстановить размещение виртуальных машин в рамках плана восстановления, запустите плановую отработку отказа с дополнительного сайта на основной следующим образом. 
1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Последовательно выберите пункты **Тип отработки отказа** > **Planned Тип отработки отказа**.
2. На странице **Подтвердить плановую отработку отказа** выберите исходное и целевое расположения. Запомните направление отработки отказа. Если отработка отказа с переносом из основного расположения выполнена правильно и все виртуальные машины находятся в дополнительном расположении, то эти данные будут носить исключительно информационный характер.
3. Если вы восстанавливаете размещение, выполняя перенос из Azure, выберите необходимые параметры в разделе **Синхронизация данных**.
    - **Синхронизация данных до отработки отказа (синхронизация только разностных изменений)** . Этот параметр сводит к минимуму время простоя виртуальных машин, так как синхронизация выполняется без завершения их работы. Он выполняет следующее:
        - Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V. Машина продолжит работать в Azure.
        - Этап 2. Завершение работы виртуальной машины в Azure для предотвращения изменений в ней. Последний набор разностных изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.

    - **Синхронизация данных только во время отработки отказа (полное скачивание)** . Этот параметр обеспечивает более быстрое выполнение.
        - Этот параметр обеспечивает более быстрое выполнение, так как предполагает изменение большей части диска и исключает затраты времени на вычисление контрольной суммы. Выполняется скачивание диска. Это также удобно, если локальная виртуальная машина была удалена.
        - Мы рекомендуем использовать этот параметр, если вы использовали Azure какое-то время (месяц или дольше) или локальная виртуальная машина была удалена. Этот параметр не выполняет вычисления контрольной суммы.


4. Если включена функция шифрования данных для облака, в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика на VMM-сервер вы включили функцию шифрования данных.
5. Запустите отработку отказа. На вкладке **Задания** можно следить за ходом выполнения отработки отказа.
6. Если вы выбрали параметр, при котором синхронизация данных выполняется до отработки отказа, то после завершения начальной синхронизация данных и когда вы будете готовы завершить работу виртуальных машин в Azure, последовательно выберите пункты **Задания** > название задания > **Полная отработка отказа**. Эта команда завершит работу машины Azure, передаст последние изменения на локальную виртуальную машину и запустит ее.
7. После этого вы сможете выполнить вход в виртуальную машину, чтобы проверить ее доступность.
8. Виртуальная машина будет находиться в состоянии ожидания фиксации. Для фиксации отработки отказа выберите команду **Зафиксировать** .
9. Теперь для восстановления размещения выберите пункт **Обратная репликация**, чтобы включить защиту виртуальной машины на основном сайте.


Выполните указанные ниже процедуры, чтобы восстановить размещение на исходном основном сайте. В этой процедуре рассказывается, как запустить плановую тестовую отработку отказа для плана восстановления. В качестве альтернативы на вкладке **Виртуальные машины** можно запустить отработку отказа для одной виртуальной машины.


## <a name="failback-to-an-alternate-location-in-hyper-v-environment"></a>Восстановление размещения в альтернативном расположении в среде Hyper-V
Если вы развернули защиту между [сайтом Hyper-V и Azure](site-recovery-hyper-v-site-to-azure.md) , то можно восстановить размещение, выполнив перенос из Azure в альтернативное локальное расположение. Это удобно, если необходимо настроить новое оборудование в локальной системе. Вот как это сделать.

1. При настройке нового оборудования установите на сервере Windows Server 2012 R2 и роль Hyper-V.
2. Создайте коммутатор виртуальной сети с тем же именем, что и на исходном сервере.
3. Выберите **защищенные элементы** ->  \<**Группа** -> защиты\<протектионграупнаме >-> VirtualMachineName > необходимо выполнить откат и выберите **плановая отработка отказа**.
4. При необходимости в разделе **Подтвердить плановую отработку отказа** select **Создать локальную виртуальную машину, если ее не существует**.
5. В разделе Имя узла** выберите новый сервер узла Hyper-V, на котором требуется разместить виртуальную машину.
6. В разделе "Синхронизация данных" мы рекомендуем выбрать параметр "Синхронизировать данные до отработки отказа". Это сведет к минимуму простой виртуальных машин, так как синхронизация будет выполнена без завершения их работы. Он выполняет следующие действия:

    - Этап 1. Создание снимка виртуальной машины в Azure и копирование его на локальный узел Hyper-V. Машина продолжит работать в Azure.
    - Этап 2. Завершение работы виртуальной машины в Azure для предотвращения изменений в ней. Последний набор изменений передается на локальный сервер, после чего запускается локальная виртуальная машина.
    
7. Установите этот флажок, чтобы начать отработку отказа (восстановление размещения).
8. После завершения начальной синхронизации и готовности к завершению работы виртуальной машины в **Azure щелкните** > \<задания плановая отработка отказа > > **завершить отработку отказа**. Эта команда завершит работу машины Azure, передаст последние изменения на локальную виртуальную машину, которая после этого будет запущена.
9. Вы можете выполнить вход в локальную виртуальную машину, чтобы проверить, что все работает правильно. Затем нажмите кнопку **Зафиксировать** , чтобы завершить отработку отказа. Фиксация удаляет виртуальную машину Azure и ее диски и подготавливает виртуальную машину к защите.
10. Выберите пункт **Обратная репликация** , чтобы включить защиту локальной виртуальной машины.

    > [!NOTE]
    > Если отменить задание восстановления размещения на этапе синхронизации данных, локальная виртуальная машина будет в поврежденном состоянии. Это связано с тем, что при синхронизации данных последние данные с дисков виртуальной машины Azure копируются на локальные диски данных, и пока синхронизация не завершится, диски данных могут находиться в несогласованном состоянии. Если отменить синхронизацию данных и попытаться загрузить локальную виртуальную машину, она может не загрузиться. Повторно активируйте отработку отказа, чтобы завершить синхронизацию данных.


## <a name="why-is-there-no-button-called-failback"></a>Почему нет кнопки, которая называется "Восстановить размещение"?
На портале нет явной команды, которая называется "восстановить размещение". Восстановление размещения — это этап, на котором вы можете вернуться на первичный сайт. Согласно определению восстановление размещения — это отработка отказа виртуальных машин с сайта восстановления на первичный сайт.

При запуске отработки отказа в соответствующей колонке указывается направление, в котором будут перемещены виртуальные машины. Если они перемещаются из Azure в локальную среду, это восстановление размещения.

## <a name="why-is-there-only-a-planned-failover-gesture-to-failback"></a>Почему существует только плановая команда для восстановления размещения?
Azure — это среда с высокой доступностью, в которой ваши виртуальные машины всегда доступны. Восстановление размещения является планируемой операцией, для выполнения которой образуется небольшой простой, чтобы рабочие нагрузки снова можно было запустить локально. Эта операция выполняется без потери данных. Поэтому доступна только плановая команда для восстановления размещения, которая выключает виртуальные машины в Azure, загружает последние изменения и гарантирует сохранность данных.

## <a name="do-i-need-a-process-server-in-azure-to-failback-to-hyper-v"></a>Нужно ли использовать сервер обработки в Azure для восстановления размещения в Hyper-V?
Нет, сервер обработки требуется только в том случае, если вы защищаете виртуальные машины VMware. Для защиты или восстановления размещения виртуальных машин Hyper-V развертывать дополнительные компоненты не требуется.


## <a name="time-taken-to-failback"></a>Время для восстановления размещения
Время, затрачиваемое на завершение синхронизации данных и загрузку виртуальной машины, зависит от различных факторов. Чтобы дать представление о времени, мы поясним, что происходит во время синхронизации данных.

При синхронизации данных создается моментальный снимок дисков виртуальной машины, затем начинается проверка блоков и вычисляются их контрольные суммы. Вычисленная контрольная сумма отправляется в локальную среду для сравнения с локальной контрольной суммой того же блока. В случае, если контрольные суммы совпадают, блок данных не переносится. Если же они не совпадают, блок данных переносится в локальную среду. Время передачи зависит от доступной полосы пропускания. Скорость передачи контрольной суммы составляет несколько гигабайтов в минуту. 

Можно ускорить скачивание данных, настроив агент MARS для использования большего числа потоков, чтобы распараллелить скачивание. Ознакомьтесь с [этим документом](https://support.microsoft.com/en-us/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage), чтобы узнать, как изменить число потоков скачивания в агенте.


## <a name="next-steps"></a>Следующие шаги

После **фиксации** можно запустить *обратную репликацию*. Будет запущена репликация виртуальной машины из локальной среды обратно в Azure. Эта операция реплицирует изменения только с момента выключения виртуальной машины в Azure и отправляет только разностные изменения.
