---
title: Настройка аварийного восстановления для SQL Server с помощью SQL Server и Azure Site Recovery | Документация Майкрософт
description: В этой статье описано, как настроить аварийное восстановление для SQL Server с использованием SQL Server и Azure Site Recovery.
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 06/30/2019
ms.author: sutalasi
ms.openlocfilehash: 1c44b10b54a5f58dff1aecf36c3633cc8ffbd8f0
ms.sourcegitcommit: ac1cfe497341429cf62eb934e87f3b5f3c79948e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2019
ms.locfileid: "67491781"
---
# <a name="set-up-disaster-recovery-for-sql-server"></a>Настройка аварийного восстановления для SQL Server

В этой статье описывается способ организации защиты серверной части SQL Server приложения с помощью сочетания технологий непрерывности бизнес-процессов и аварийного восстановления (BCDR) SQL Server и [Azure Site Recovery](site-recovery-overview.md).

Перед началом работы убедитесь, что вы понимаете, что SQL Server возможности аварийного восстановления, включая отказоустойчивая кластеризация, группы доступности AlwaysOn, зеркального отображения, доставка журналов, активной георепликации и групп автоматической отработки отказа.

## <a name="dr-recommendation-for-integration-of-sql-server-bcdr-technologies-with-site-recovery"></a>Рекомендации по аварийному Восстановлению для интеграции технологий SQL Server BCDR, с помощью Site Recovery

Выбор технологии BCDR на серверы восстановления SQL Server должно быть основано на потребности RTO и RPO, как указано в следующей таблице. После этого выбора, Site Recovery может интегрироваться с операцию отработки отказа этой технологии организовать Восстановление всего приложения.

**Тип развертывания** | **Технология BCDR** | **Ожидаемое значение RTO для SQL** | **Ожидаемый целевая точка восстановления для SQL** |
--- | --- | --- | ---
SQL Server на виртуальной Машине Azure IaaS или в локальной| **[Группа доступности AlwaysOn](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server?view=sql-server-2017)** | Эквивалентно время, затраченное на сделать вторичную реплику как основной | Репликация выполняется асинхронно на вторичную реплику, следовательно, потеря данных.
SQL Server на виртуальной Машине Azure IaaS или в локальной| **[Отказоустойчивая кластеризация (AlwaysOn FCI)](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server?view=sql-server-2017)** | Эквивалентно время, необходимое для отработки отказа между узлами | Она использует общее хранилище, поэтому одинаковое представление экземпляра хранилища доступен при отработке отказа.
SQL Server на виртуальной Машине Azure IaaS или в локальной| **[База данных зеркального отображения (режим высокой производительности)](https://docs.microsoft.com/sql/database-engine/database-mirroring/database-mirroring-sql-server?view=sql-server-2017)** | Эквивалент время, затраченное на принудительное обслуживание, которое зеркальный сервер используется в качестве сервера «горячего» резервирования. | Репликация выполняется асинхронно. Зеркальная база данных может отставать от основной базы данных. Разрыв обычно мала, howvever, может стать существенным, если система основного или зеркального сервера в условиях большой нагрузки.<br></br>Доставка журналов может дополнять зеркальное отображение базы данных и является подходящей альтернативой для асинхронного зеркального отображения
SQL как PaaS в Azure<br></br>(Эластичных пулов, серверов баз данных SQL) | **Активная георепликация** | 30 секунд, после ее запуска<br></br>При активации отработки отказа в одной из баз данных-получателей все прочие получатели автоматически связываются с новой базой данных-источником. | Значение RPO составляет 5 секунд<br></br>Активная георепликация использует технологию Always On SQL Server для асинхронной репликации зафиксированных транзакций базы данных-источника в базу данных-получатель с помощью изоляции моментального снимка. <br></br>Вспомогательные данные гарантированно никогда не будет частично выполненных транзакций.
SQL, как настроить активную георепликацию в Azure PaaS<br></br>(SQL управляемый экземпляр базы данных, эластичных пулов серверов баз данных SQL) | **Группы автоматической отработки отказа** | RTO составляет 1 час | Значение RPO составляет 5 секунд<br></br>Группы автоматической отработки отказа обеспечивают групповую семантику на основе активной георепликации, однако используется тот же механизм асинхронной репликации.
SQL Server на виртуальной Машине Azure IaaS или в локальной| **Репликация с помощью Azure Site Recovery** | Обычно не превышает 15 минут. [Дополнительные сведения](https://azure.microsoft.com/support/legal/sla/site-recovery/v1_2/) Дополнительные сведения о RTO соглашение об уровне ОБСЛУЖИВАНИЯ, предоставляемую Azure Site Recovery. | 1 час для обеспечения согласованности приложений и 5 минут для отказоустойчивость. 

> [!NOTE]
> Ряд важных моментов при защите рабочих нагрузок SQL с помощью Azure Site Recovery:
> * Azure Site Recovery зависит от приложения, и таким образом, любая версия SQL server, который развертывается в поддерживаемой операционной системе может быть защищен Azure Site Recovery. [Узнайте больше](vmware-physical-azure-support-matrix.md#replicated-machines).
> * Вы можете использовать для любого развертывания в Azure, Hyper-V, VMware или физическая инфраструктура Site Recovery. Следуйте [рекомендации](site-recovery-sql.md#how-to-protect-a-sql-server-cluster-standard-editionsql-server-2008-r2) в конце документа о том, как защитить кластер SQL Server с помощью Azure Site Recovery.
> * Убедитесь, что частота (запись байт / с), наблюдаемых на компьютере, изменения данных находится в пределах [ограничений Site Recovery](vmware-physical-azure-support-matrix.md#churn-limits). Для компьютеров windows их можно просмотреть на вкладке производительности диспетчера задач. Просмотрите записи скорость для каждого диска.
> * Azure Site Recovery поддерживает репликацию экземпляров отказоустойчивых кластеров на дисковых пространств. [Узнайте больше](azure-to-azure-how-to-enable-replication-s2d-vms.md).
 

## <a name="disaster-recovery-of-application"></a>Аварийное восстановление приложения

**Azure Site Recovery организует тестовой отработки отказа и отработку отказа всего приложения с помощью планов восстановления.** 

Существуют некоторые предварительные требования, чтобы убедиться, что план восстановления полностью настраивается в соответствии с потребностями. Все развертывания SQL Server обычно требуется Active Directory. Он также требуется подключение для вашего уровня приложения.

### <a name="step-1-set-up-active-directory"></a>Шаг 1. настроить Active Directory;

Для правильной работы SQL Server на дополнительном сайте восстановления вам потребуется настроить службу Active Directory.

* **Для малых предприятий.** Если у вас имеется небольшое количество приложений и один контроллер домена для локального сайта, то для выполнения отработки отказа всего сайта мы рекомендуем использовать репликацию Site Recovery для репликации контроллера домена в дополнительный центр обработки данных или в Azure.
* **Для средних и крупных предприятий**. Если у вас имеется большое количество приложений и лес Active Directory, то для выполнения отработки отказа для каждого отдельного приложения или рабочей нагрузки мы рекомендуем настроить дополнительный контроллер домена в дополнительном центре обработки данных или в Azure. При использовании групп доступности AlwaysOn для восстановления удаленного сайта мы рекомендуем настроить другой дополнительный контроллер домена на дополнительном сайте или в Azure, который будет использоваться для восстановленного экземпляра SQL Server.

При выполнении инструкций, описанных в этой статье, предполагается, что в дополнительном расположении доступен контроллер домена. [Узнайте больше](site-recovery-active-directory.md) о защите Active Directory с помощью Site Recovery.

### <a name="step-2-ensure-connectivity-with-other-application-tiers-and-web-tier"></a>Шаг 2. Обеспечьте подключение с других уровней приложения и веб-уровня

Убедитесь, что когда на уровне базы данных будет запущен и работает в целевом регионе Azure, подключение с приложениями и веб-уровня. Необходимые действия, способным заранее проверить подключение с помощью тестовой отработки отказа.

Основные сведения о том, как разработать приложения для подключения к вопросы, связанные с несколько примеров.
* [Создание приложения для аварийного восстановления облака](../sql-database/sql-database-designing-cloud-solutions-for-disaster-recovery.md)
* [Стратегии аварийного восстановления эластичного пула](../sql-database/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)

### <a name="step-3-integrate-with-always-on-active-geo-replication-or-auto-failover-groups-for-application-failover"></a>Шаг 3. Интеграция с AlwaysOn, активной георепликации и групп автоматической отработки отказа для отработки отказа приложения

Технологиями BCDR Always On, активный географической репликацией и автоматической отработки отказа группы имеют вторичных реплик SQL Server, работающий в целевом регионе Azure. Таким образом первым шагом для отработки отказа приложения является сделать эту реплику основной (при условии, что контроллер домена уже есть в дополнительных). Этот шаг не может потребоваться в том случае, если вы решите сделать автоматической отработки отказа. Только после завершения отработки отказа базы данных отработки отказа следует уровней архитектуры или веб-приложении.

> [!NOTE] 
> Если вы защитили машины SQL с помощью Azure Site Recovery, необходимо просто создать группу восстановления из этих компьютеров и добавление их отработки отказа в плане восстановления.

[Создайте план восстановления](site-recovery-create-recovery-plans.md) с приложением и виртуальной машины веб-уровня. Выполните следующие действия, чтобы добавить на другой ресурс для уровня базы данных:

1. Импортировать скрипты в учетную запись службы автоматизации Azure. Содержит скрипты для перехода на другой ресурс группы доступности SQL в [виртуальной машине Resource Manager](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAG.ps1) и [классической виртуальной машине](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAGClassic.ps1).

    [![Развертывание в Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)


1. Добавьте ASR SQL-FailoverAG как предварительное действие первой группы плана восстановления.

1. Следуйте инструкциям в скрипте для создания переменной автоматизации, чтобы предоставить имя группы доступности.

### <a name="step-4-conduct-a-test-failover"></a>Шаг 4. Тестовую отработку отказа

Некоторые технологии BCDR, такие как SQL AlwaysOn не встроенной поддержки тестовой отработки отказа. Таким образом, рекомендуется следующий подход **только в том случае, если интеграция с помощью таких технологий**:

1. Установите [службу архивации Azure](../backup/backup-azure-arm-vms.md) на виртуальной машине, где размещена реплика группы доступности в Azure.

1. Прежде чем активировать тестовую отработку отказа для плана восстановления, восстановите виртуальную машину из резервной копии, полученной на предыдущем шаге.

    ![Восстановление из службы архивации Azure](./media/site-recovery-sql/restore-from-backup.png)

1. [Создайте принудительный кворум](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum#PowerShellProcedure) на виртуальной машине, восстановленной из резервной копии.

1. Обновите IP-адрес прослушивателя до IP-адреса в сети тестовой отработки отказа.

    ![Обновление IP-адреса прослушивателя](./media/site-recovery-sql/update-listener-ip.png)

1. Подключите прослушиватель.

    ![Подключение прослушивателя](./media/site-recovery-sql/bring-listener-online.png)

1. Создайте балансировщик нагрузки с одним IP-адресом, созданным во внешнем пуле IP-адресов, соответствующим каждому прослушивателю группы доступности, и с виртуальной машиной SQL, добавленной в серверный пул.

     ![Создание балансировщика нагрузки — внешний пул IP-адресов](./media/site-recovery-sql/create-load-balancer1.png)

    ![Создание балансировщика нагрузки — серверный пул IP-адресов](./media/site-recovery-sql/create-load-balancer2.png)

1. Добавьте отказоустойчивости на уровне приложения, следуют веб-уровня в этом плане восстановления в группы для последующего восстановления. 
1. Выполните тестовую отработку отказа плана восстановления для тестовой отработки отказа end-to-end приложения.

## <a name="steps-to-do-a-failover"></a>Действия по отработке отказа

После добавления скрипта в план восстановления на шаге 3 и проверить его, выполнив тестовую отработку отказа с помощью специализированных средств на шаге 4, можно выполнить отработку отказа плана восстановления, созданный на шаге 3.

Обратите внимание на то, что шаги отработки отказа для приложения и веб-уровня должны быть одинаковыми в тестовой отработки отказа и отработки отказа планов восстановления.

## <a name="how-to-protect-a-sql-server-cluster-standard-editionsql-server-2008-r2"></a>Как защитить кластер SQL Server (standard edition или SQL Server 2008 R2)

Для кластера под управлением выпуска SQL Server Standard или SQL Server 2008 R2 рекомендуется использовать репликацию Site Recovery для защиты SQL Server.

### <a name="azure-to-azure-and-on-premises-to-azure"></a>Azure в Azure и на локальной среды в Azure

Site Recovery не предоставляет гостевой кластер поддержки, при репликации в регионе Azure. SQL Server также не предоставляет экономичное решение для аварийного восстановления для выпуска Standard. В этом случае рекомендуется защитить кластер SQL Server в автономный сервер SQL Server в основном расположении и восстановить его в базу данных-получатель.

1. Настройте дополнительный автономный экземпляр SQL Server, основной регион Azure, и на локальный сайт.
1. Настройте этот экземпляр в качестве зеркальной копии баз данных, которые требуется защитить. Настройте зеркальное отображение в режиме высокого уровня безопасности.
1. Настройте Site Recovery на первичном сайте ([Azure](azure-to-azure-tutorial-enable-replication.md), [Hyper-V](site-recovery-hyper-v-site-to-azure.md) или [виртуальных машин VMware или физических серверов)](site-recovery-vmware-to-azure-classic.md).
1. Используйте репликацию Site Recovery для репликации нового экземпляра SQL Server для вторичного сайта. Так как это зеркальная копия с высоким уровнем безопасности, она будет синхронизирована с основным кластером, но она будет реплицирована с помощью репликации Site Recovery.


![Стандартный кластер](./media/site-recovery-sql/standalone-cluster-local.png)

### <a name="failback-considerations"></a>Рекомендации относительно восстановления размещения

В случае стандартных кластеров SQL Server восстановление размещения после внеплановой отработки отказа требует выполнения резервного копирования SQL Server и его восстановления из экземпляра зеркала в исходный кластер с повторной установкой зеркала.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="how-does-sql-get-licensed-when-protected-with-azure-site-recovery"></a>Как SQL получить лицензии при защите с помощью Azure Site Recovery?
Репликация Azure Site Recovery для SQL Server входит в преимущество аварийного восстановления в рамках программы Software Assurance и охватывает все возможные сценарии Azure Site Recovery (аварийное восстановление из локальной среды в Azure или аварийное восстановление Azure IaaS между регионами). [Дополнительные сведения](https://azure.microsoft.com/pricing/details/site-recovery/)

### <a name="will-azure-site-recovery-support-my-sql-version"></a>Будет ли Azure Site Recovery поддерживает моей версии SQL?
Azure Site Recovery зависит от приложения. Таким образом любая версия SQL server, который развертывается в поддерживаемой операционной системе может быть защищен Azure Site Recovery. [Подробнее](vmware-physical-azure-support-matrix.md#replicated-machines)

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения об архитектуре Site Recovery см. [здесь](site-recovery-components.md).
* Для серверов SQL Server в Azure, Узнайте больше о [решения высокого уровня доступности](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md#azure-only-high-availability-solutions) для восстановления в дополнительный регион Azure.
* Для базы данных SQL Azure, Узнайте больше о [непрерывности бизнес-процессов](../sql-database/sql-database-business-continuity.md) и [высокий уровень доступности](../sql-database/sql-database-high-availability.md) возможности восстановления в дополнительный регион Azure.
* Для машин SQL server в локальной [Подробнее](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md#hybrid-it-disaster-recovery-solutions) о параметрах высокого уровня доступности для восстановления на виртуальных машинах Azure.
