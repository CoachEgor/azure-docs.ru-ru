---
title: Настройка аварийного восстановления для сервера S'L с восстановлением сайта Azure
description: В этой статье описывается, как настроить аварийное восстановление для сервера S'L, используя S'L Server и восстановление сайта Azure.
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 08/02/2019
ms.author: sutalasi
ms.openlocfilehash: 429f46156da728bbc24108090eac8c04f68da71c
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74084739"
---
# <a name="set-up-disaster-recovery-for-sql-server"></a>Настройка аварийного восстановления для SQL Server

В этой статье описывается, как помочь защитить задний конец приложения сервера S'L Server. Вы делаете это, используя комбинацию технологий непрерывности бизнеса s'L Server и аварийного восстановления (BCDR) и [восстановления сайта Azure.](site-recovery-overview.md)

Перед запуском убедитесь, что вы понимаете возможности аварийного восстановления сервера S'L Server. К этим возможностям относятся следующие:

* Отказоустойчивая кластеризация
* Группы доступности AlwaysOn
* Зеркальное отображение базы данных
* доставка журналов;
* Активная георепликация
* Группы автоматической отработки отказа

## <a name="combining-bcdr-technologies-with-site-recovery"></a>Объединение технологий BCDR с восстановлением сайта

Ваш выбор технологии BCDR для восстановления экземпляров S'L Server должен основываться на вашей цели времени восстановления (RTO) и потребностях точки восстановления (RPO), как описано в следующей таблице. Объедините восстановление сайта с отказом от выбранной вами технологии, чтобы организовать восстановление всего приложения.

Тип развертывания | Технология BCDR | Ожидаемый RTO для сервера S'L | Ожидаемое RPO для сервера S'L |
--- | --- | --- | ---
Сервер S'L на инфраструктуре Azure как виртуальной машине (VM) или в помещении.| [Группы доступности AlwaysOn](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server?view=sql-server-2017) | Время, заехаваемые на то, чтобы сделать вторичную реплику в качестве основного. | Поскольку репликация вторичной реплики является асинхронной, происходит потеря данных.
Сервер S'L на Azure IaaS VM или в помещении.| [Отказоустойчивая кластеризация (AlwaysOn FCI)](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server?view=sql-server-2017) | Время, задеваемые, чтобы потерпеть неудачу между узлами. | Поскольку Always On FCI использует совместное хранилище, одно и то же представление экземпляра хранилища доступно на сбой.
Сервер S'L на Azure IaaS VM или в помещении.| [Зеркальное отражение базы данных (режим высокой производительности)](https://docs.microsoft.com/sql/database-engine/database-mirroring/database-mirroring-sql-server?view=sql-server-2017) | Время, зашедшее на принудительное обслуживание, которое использует зеркальный сервер в качестве теплого резервного сервера. | Репликация выполняется асинхронно. Зеркальная база данных может несколько отставать от основной базы данных. Отставание, как правило, небольшое. Но он может стать большим, если система основного или зеркального сервера находится под большой нагрузкой.<br/><br/>Доставка журнала может быть дополнением к зеркальным отражениям базы данных. Это благоприятная альтернатива асинхронной базе данных зеркального отражения.
СЗЛ как платформа как услуга (PaaS) на Azure.<br/><br/>Этот тип развертывания включает в себя эластичные пулы и серверы базы данных Azure S'L. | Активная георепликация | Через 30 секунд после срабатывания срабатывает.<br/><br/>При активации сбоя для одной из вторичных баз данных все остальные второстепенные данные автоматически подключаются к новой первичной базе данных. | RPO пять секунд.<br/><br/>Активная георепликация использует технологию Always On Сервера S'L. Он асинхронно реплицирует совершенные транзакции в основной базе данных на вторичную базу данных с помощью изоляции моментального снимка.<br/><br/>Вторичные данные гарантированно никогда не будут иметь частичных транзакций.
СЗЛ как PaaS настроен с активной георепликацией на Azure.<br/><br/>Этот тип развертывания включает в себя управляемый экземпляр базы данных S'L, эластичные пулы и серверы базы данных S'L. | Группы автоматической отработки отказа | RTO одного часа. | RPO пять секунд.<br/><br/>Группы автоматического отказа обеспечивают семантику группы поверх активной георепликации. Но используется тот же механизм асинхронной репликации.
Сервер S'L на Azure IaaS VM или в помещении.| Репликация с восстановлением сайта Azure | RTO обычно составляет менее 15 минут. Чтобы узнать больше, прочитайте [RTO SLA, предоставленную Сайтом Recovery](https://azure.microsoft.com/support/legal/sla/site-recovery/v1_2/). | Один час для согласованности приложения и пять минут для согласованности сбоев. Если вы ищете более низкий RPO, используйте другие технологии BCDR.

> [!NOTE]
> Несколько важных соображений, когда вы помогаете защитить рабочие нагрузки СЗЛ при восстановлении сайта:
> * Восстановление сайта является агностиком приложений. Восстановление сайта может помочь защитить любую версию сервера S'L, которая развернута на поддерживаемой операционной системе. Чтобы узнать больше, смотрите [матрицу поддержки для восстановления](vmware-physical-azure-support-matrix.md#replicated-machines) реплицированных машин.
> * Вы можете использовать восстановление сайта для любого развертывания в Azure, Hyper-V, VMware или физической инфраструктуре. Пожалуйста, следуйте инструкциям в конце этой статьи о [том, как защитить кластер сервера S'L](#how-to-help-protect-a-sql-server-cluster) с восстановлением сайта.
> * Убедитесь, что скорость изменения данных, наблюдаемая на машине, находится в [пределах восстановления сайта.](vmware-physical-azure-support-matrix.md#churn-limits) Скорость изменения измеряется в написания байтов в секунду. Для машин с Windows можно просмотреть этот показатель изменения, выбрав вкладку **«Производительность»** в task Manager. Наблюдайте скорость записи для каждого диска.
> * Восстановление сайта поддерживает репликацию кластерных экземпляров Failover на пространстве хранения Direct. Чтобы узнать больше, посмотрите, [как включить прямую репликацию хранилищ.](azure-to-azure-how-to-enable-replication-s2d-vms.md)

## <a name="disaster-recovery-of-an-application"></a>Аварийное восстановление приложения

Восстановление сайта организует тест failover и неудачу всего приложения с помощью планов восстановления.

Есть некоторые предпосылки для обеспечения вашего плана восстановления полностью настроены в соответствии с вашими потребностями. Любое развертывание сервера S'L, как правило, требует развертывания Active Directory. Он также нуждается в подключении для вашего уровня приложения.

### <a name="step-1-set-up-active-directory"></a>Шаг 1: Настройка активного каталога

Настройка Active Directory на вторичном сайте восстановления для правильного выполнения сервера S'L Server.

* **Небольшое предприятие**: У вас есть небольшое количество приложений и один контроллер домена для сайта на территории. Если вы хотите потерпеть неудачу на протяжении всего сайта, используйте репликацию восстановления сайта. Эта служба реплицирует контроллер домена во вторичный центр обработки данных или в Azure.
* **Средний для крупного предприятия**: Возможно, потребуется настроить дополнительные контроллеры домена.
  - Если у вас есть большое количество приложений, у вас есть active Directory forest, и вы хотите сбой в работе приложения или рабочей нагрузки, навяжните другой контроллер домена во вторичном центре обработки данных или в Azure.
  -  Если вы используете группы всегда на наличие для восстановления удаленного сайта, настройте другой контроллер домена на вторичном сайте или в Azure. Этот контроллер домена используется для восстановленного экземпляра сервера S'L.

Инструкции в этой статье предполагают, что контроллер домена доступен во вторичном месте. Чтобы узнать больше, смотрите процедуры, [помогающие защитить Active Directory с помощью восстановления сайта.](site-recovery-active-directory.md)

### <a name="step-2-ensure-connectivity-with-other-tiers"></a>Шаг 2: Обеспечить связь с другими уровнями

После запуска уровня базы данных в целевом регионе Azure убедитесь, что у вас есть подключение к приложению и веб-уровням. Заранее предпримите необходимые шаги для проверки подключения к тесту.

Чтобы понять, как можно проектировать приложения для соображений подключения, см.

* [Разработка приложения для аварийного восстановления облака](../sql-database/sql-database-designing-cloud-solutions-for-disaster-recovery.md)
* [Стратегии восстановления упругой пули по ликвидации последствий стихийных](../sql-database/sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)

### <a name="step-3-interoperate-with-always-on-active-geo-replication-and-auto-failover-groups"></a>Шаг 3: Взаимодействие с всегда на, активная георепликация, и автоматической неудачи групп

Технологии BCDR всегда, активная георепликация и группы автоматического отказа имеют вторичные реплики сервера S'L, работающего в целевом регионе Azure. Первым шагом для отказа приложения является указание этой реплики в качестве основного. Этот шаг предполагает, что у вас уже есть контроллер домена во вторичном. Шаг может не быть необходимым, если вы решите сделать автоматическое сбой. Сбой в веб-уровнях и уровнях приложений только после завершения сбоя базы данных.

> [!NOTE]
> Если вы помогли защитить машины СЗЛ с помощью восстановления сайта, вам просто нужно создать группу восстановления этих машин и добавить их сбой в план восстановления.

[Создайте план восстановления](site-recovery-create-recovery-plans.md) с помощью виртуальных машин с помощью приложений и веб-уровней. Следующие шаги показывают, как добавить сбой уровня базы данных:

1. Импортскрипты скриптов для сбоя в группе доступности S'L как в [виртуальной машине Resource Manager,](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAG.ps1) так и в [классической виртуальной машине.](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAGClassic.ps1) Импортируйте скрипты в учетную запись Автоматизации Azure.

    [![Изображение логотипа «Развертывание в Azure»](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)

1. Добавьте сценарий ASR-S'L-FailoverAG в качестве предварительного действия первой группы плана восстановления.

1. Следуйте инструкциям, доступным в скрипте, чтобы создать переменную автоматизации. Эта переменная предоставляет название групп доступности.

### <a name="step-4-conduct-a-test-failover"></a>Шаг 4: Провести тест неудачу

Некоторые технологии BCDR, такие как S'L Always On, не поддерживают тест-неудачу. Мы рекомендуем следующий подход *только при использовании таких технологий.*

1. Навлажь [резервное копирование Azure](../backup/backup-azure-arm-vms.md) на VM, где размещается реплика группы доступности в Azure.

1. Перед запуском теста неудача плана восстановления, восстановить VM из резервного копирования, принятых в предыдущем шаге.

    ![Скриншот, показывающий окно для восстановления конфигурации из резервного копирования Azure](./media/site-recovery-sql/restore-from-backup.png)

1. [Принудить кворум](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum#PowerShellProcedure) в VM, который был восстановлен из резервного копирования.

1. Обновление IP-адреса слушателя, чтобы быть адресом, доступным в сети тестового отказа.

    ![Скриншот окна правил и диалог свойств свойств IP-адресов](./media/site-recovery-sql/update-listener-ip.png)

1. Перевод прослушивателя в режим «в сети».

    ![Скриншот окна с пометкой Content_AG с указанием имен и статусов серверов](./media/site-recovery-sql/bring-listener-online.png)

1. Убедитесь, что балансонер нагрузки в сети сбоя имеет один IP-адрес, из пула IP-адресов, соответствующих каждому слушателю группы доступности, и с S'L Server VM в пуле бэк-энда.

     ![Скриншот окна под названием "S'L-AlwaysOn-LB - Frontend IP бассейн](./media/site-recovery-sql/create-load-balancer1.png)

    ![Скриншот окна под названием "S'L-AlwaysOn-LB - Backend IP бассейн](./media/site-recovery-sql/create-load-balancer2.png)

1. В более поздних группах восстановления добавьте сбой уровня приложения, за которым следует ваш веб-уровень для этого плана восстановления.

1. Сделайте тест-неудачу плана восстановления, чтобы проверить сквозной отказ вашего приложения.

## <a name="steps-to-do-a-failover"></a>Действия по отработке отказа

После добавления скрипта в шаг 3 и проверки его в шаге 4 можно сделать неудачу плана восстановления, созданного в шаге 3.

Неудачные шаги для приложений и веб-уровней должны быть одинаковыми как в планах восстановления теста, так и в планах восстановления.

## <a name="how-to-help-protect-a-sql-server-cluster"></a>Как защитить кластер сервера S'L

Для кластера, работающего в стандартном издании S'L Server Standard или S'L Server 2008 R2, мы рекомендуем вам использовать репликацию восстановления сайта для защиты сервера S'L.

### <a name="azure-to-azure-and-on-premises-to-azure"></a>Лазурный в Лазурный и на-посевных до Лазурного

Восстановление сайта не обеспечивает поддержку кластера гостей при репликации в область Azure. Издание S'L Server Standard также не предоставляет недорогое решение для аварийного восстановления. В этом случае мы рекомендуем защитить кластер Сервера S'L в отдельном экземпляре сервера S'L в основном месте и восстановить его во вторичном.

1. Настройте дополнительный автономный экземпляр S'L Server в основной области Azure или на месте.

1. Назначайте экземпляр в качестве зеркала для баз данных, которые вы хотите защитить. Настройка зеркального отражения в режиме высокой безопасности.

1. Настройте восстановление сайта на основной площадке для [Azure,](azure-to-azure-tutorial-enable-replication.md) [Hyper-V,](site-recovery-hyper-v-site-to-azure.md)или [VMware VMs и физических серверов.](site-recovery-vmware-to-azure-classic.md)

1. Используйте репликацию восстановления сайта для воспроизведения нового экземпляра сервера S'L на вторичном сайте. Поскольку это зеркальная копия с высокой безопасностью, она будет синхронизирована с первичным кластером, но реплицирована с помощью репликации восстановления сайта.

   ![Изображение стандартного кластера, отображая связь и поток между основным сайтом, Восстановление сайта и Azure](./media/site-recovery-sql/standalone-cluster-local.png)

### <a name="failback-considerations"></a>Рекомендации относительно восстановления размещения

Для кластеров стандартного сервера S'L Server, отказ после незапланированного сбоя требует резервного копирования и восстановления сервера S'L Server. Эта операция выполняется от зеркального экземпляра до исходного кластера с восстановлением зеркала.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="how-does-sql-server-get-licensed-when-used-with-site-recovery"></a>Каким образом сервер S'L Server получает лицензию при использовании при восстановлении сайта?

Репликация восстановления сайта для сервера S'L покрывается в рамках преимущества восстановления аварийности Software Assurance. Это покрытие распространяется на все сценарии восстановления сайта: на местах для аварийного восстановления Azure и межрегиональные аварийные восстановления Azure IaaS. Дополнительные [цены на восстановление сайта Azure](https://azure.microsoft.com/pricing/details/site-recovery/) для получения дополнительной информации.

### <a name="will-site-recovery-support-my-sql-server-version"></a>Поддерживает ли восстановление сайта мою версию сервера S'L?

Восстановление сайта является агностиком приложений. Восстановление сайта может помочь защитить любую версию сервера S'L, которая развернута на поддерживаемой операционной системе. Для получения дополнительной [информации](vmware-physical-azure-support-matrix.md#replicated-machines) см.

## <a name="next-steps"></a>Дальнейшие действия

* Подробнее об [архитектуре восстановления сайта.](site-recovery-components.md)
* Подробнее о решениях для восстановления в вторичном регионе Azure можно узнать больше о решениях с [высокой доступностью для восстановления.](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md#azure-only-high-availability-solutions)
* Подробнее о непрерывности бизнеса и вариантах высокой доступности для восстановления во вторичном регионе Azure можно узнать больше о [непрерывности бизнеса](../sql-database/sql-database-business-continuity.md) и [возможностях высокой доступности.](../sql-database/sql-database-high-availability.md)
* Подробнее о вариантах восстановления в виртуальных машинах Azure можно узнать больше о [вариантах восстановления](../virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md#hybrid-it-disaster-recovery-solutions) Azure.
