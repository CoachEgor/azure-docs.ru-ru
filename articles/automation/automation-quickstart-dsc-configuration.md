---
title: Быстрое начало работы с Azure — настройка DSC на виртуальной машине | Документация Майкрософт
description: Создание стека LAMP на виртуальной машине Linux с настройкой требуемого состояния
services: automation
ms.subservice: dsc
keywords: dsc, configuration, automation
ms.date: 11/06/2018
ms.topic: quickstart
ms.custom: mvc
ms.openlocfilehash: 1a146ab7c05d200b71a33a72fa6362c3cf62629a
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81457524"
---
# <a name="configure-a-virtual-machine-with-desired-state-configuration"></a>Настройка Desired State Configuration на виртуальной машине Linux

Включив службу State Configuration (служба автоматизации Azure), вы сможете контролировать и отслеживать конфигурации серверов Windows и Linux с помощью платформы Desired State Configuration (DSC). Она позволяет выявлять или автоматически исправлять конфигурации, которые отличаются от требуемой конфигурации. Это руководство описывает процедуру подключения виртуальной машины Linux и развертывания стека LAMP с поддержкой DSC.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим кратким руководством вам понадобится:

* Подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/).
* Учетная запись службы автоматизации Azure. Указания по созданию учетной записи запуска от имени пользователя для службы автоматизации Azure см. в статье [Проверка подлинности модулей Runbook в Azure с помощью учетной записи запуска от имени](automation-sec-configure-azure-runas-account.md).
* Виртуальная машина Azure Resource Manager (не классическая) под управлением Red Hat Enterprise Linux, CentOS или Oracle Linux. Инструкции по созданию виртуальной машины см. в статье [Создание первой виртуальной машины Linux на портале Azure](../virtual-machines/linux/quick-create-portal.md).

## <a name="sign-in-to-azure"></a>Вход в Azure
Войдите в Azure по адресу https://portal.azure.com.

## <a name="onboard-a-virtual-machine"></a>Подключение виртуальной машины

Подключить компьютер и активировать DSC можно разными способами. В этом руководстве мы рассматриваем подключение с помощью учетной записи службы автоматизации. Сведения о других методах подключения компьютеров к службе State Configuration см. в [этой статье](https://docs.microsoft.com/azure/automation/automation-dsc-onboarding).

1. В области слева на портале Azure выберите **Учетные записи службы автоматизации**. Если в этой области нет такого элемента, щелкните **Все службы** и найдите его в этом представлении.
1. Выберите из списка учетную запись службы автоматизации.
1. На странице учетной записи службы автоматизации в области слева выберите **Настройка состояния (DSC)** .
2. Чтобы открыть страницу для выбора виртуальной машины, нажмите кнопку **Добавить**.
3. Найдите виртуальную машину, для которой необходимо включить DSC. Для поиска конкретной виртуальной машины можно применить поле поиска и фильтры.
4. Выберите виртуальную машину и нажмите кнопку **Подключить**.
5. Выберите настройки DSC для этой виртуальной машины. Если у вас есть уже готовая конфигурация, укажите ее для параметра `Node Configuration Name`. Также вы можете задать [режим конфигурации](https://docs.microsoft.com/powershell/scripting/dsc/managing-nodes/metaConfig), который определяет правила применения настройки для виртуальной машины.
6. Нажмите кнопку **ОК**. При развертывании расширения DSC на виртуальной машине отображается состояние `Connecting`.

![Подключение виртуальной машины Azure к DSC](./media/automation-quickstart-dsc-configuration/dsc-onboard-azure-vm.png)

## <a name="import-modules"></a>Импорт модулей

Модули содержат ресурсы DSC. Множество разных модулей вы найдете в [коллекции PowerShell](https://www.powershellgallery.com). Все ресурсы, используемые в конфигурациях, нужно перед компиляцией импортировать в учетную запись службы автоматизации. В этом руководстве используется модуль с именем **nx**.

1. На странице учетной записи службы автоматизации в области слева выберите **Коллекция модулей** (в разделе **Общие ресурсы**).
1. Найдите модуль, который вы хотите импортировать. Для этого введите часть его имени: `nx`.
1. Выберите модуль, который нужно импортировать.
1. Щелкните **Импорт**.

![Импорт модуля DSC](./media/automation-quickstart-dsc-configuration/dsc-import-module-nx.png)

## <a name="import-the-configuration"></a>Импорт конфигурации

В этом руководстве используется конфигурация DSC, которая настраивает на компьютере HTTP-сервер Apache, PHP и MySQL. См. статью [Конфигурации DSC](https://docs.microsoft.com/powershell/scripting/dsc/configurations/configurations).

В текстовом редакторе введите следующий код и сохраните его локально в виде файла **AMPServer.ps1**.

```powershell-interactive
configuration LAMPServer {
   Import-DSCResource -module "nx"

   Node localhost {

        $requiredPackages = @("httpd","mod_ssl","php","php-mysql","mariadb","mariadb-server")
        $enabledServices = @("httpd","mariadb")

        #Ensure packages are installed
        ForEach ($package in $requiredPackages){
            nxPackage $Package{
                Ensure = "Present"
                Name = $Package
                PackageManager = "yum"
            }
        }

        #Ensure daemons are enabled
        ForEach ($service in $enabledServices){
            nxService $service{
                Enabled = $true
                Name = $service
                Controller = "SystemD"
                State = "running"
            }
        }
   }
}
```

Процесс импорта конфигурации.

1. На странице учетной записи службы автоматизации в области слева выберите **Настройка состояния (DSC)** , а затем щелкните вкладку **Конфигурации**.
2. Щелкните **+ Добавить**.
3. Выберите файл конфигурации, который вы сохранили на предыдущем этапе.
4. Нажмите кнопку **ОК**.

## <a name="compile-a-configuration"></a>Компиляция конфигурации

Прежде чем назначать конфигурацию DSC узлу, ее нужно скомпилировать в конфигурации узла (MOF-документ). В процессе компиляции проходит проверка конфигурации и предоставляется возможность ввести значения параметров. Дополнительные сведения о компиляции конфигурации см. в статье [Компиляция конфигураций в службе State Configuration](automation-dsc-compile.md).

1. На странице учетной записи службы автоматизации в области слева выберите **Настройка состояния (DSC)** , а затем щелкните вкладку **Конфигурации**.
1. Выберите конфигурацию `LAMPServer`.
1. Выберите в меню пункт **Компиляция** и нажмите кнопку **Да**.
1. Откроется представление "Конфигурация", где вы увидите размещенное в очереди новое задание компиляции. Когда это задание успешно завершится, можете переходить к следующему шагу. Если же при выполнении возникнут ошибки, щелкните это задание компиляции для просмотра сведений о нем.

## <a name="assign-a-node-configuration"></a>Назначение конфигурации узлу

Скомпилированную конфигурацию узла можно назначить любому узлу DSC. Назначенная конфигурация применяется к компьютеру и отслеживает или автоматически исправляет на нем любые отклонения от заданных настроек.

1. На странице учетной записи службы автоматизации в области слева выберите **State Configuration (DSC)** , а затем откройте вкладку **Узлы**.
1. Выберите узел, которому вы хотите назначить конфигурацию.
1. Щелкните **Назначение конфигурации узлу**.
1. Выберите конфигурацию узла `LAMPServer.localhost` и нажмите кнопку **ОК**. Служба State Configuration теперь назначит скомпилированную конфигурацию этому узлу, и его состояние изменится на `Pending`. При следующей периодической проверке этот узел получит назначенную конфигурацию, применит ее и сообщит об изменении состояния. Получение конфигурации может занять до 30 минут в зависимости от настроек узла. 
1. Чтобы принудительно выполнить немедленную проверку данных, запустите следующую команду на виртуальной машине Linux: `sudo /opt/microsoft/dsc/Scripts/PerformRequiredConfigurationChecks.py`

![Назначение конфигурации узлу](./media/automation-quickstart-dsc-configuration/dsc-assign-node-configuration.png)

## <a name="view-node-status"></a>Просмотр данных о состоянии узла

Вы можете просмотреть состояние всех узлов, управляемых службой State Configuration, в учетной записи службы автоматизации. Чтобы просмотреть сведения, выберите **State Configuration (DSC)** и щелкните **Узлы**. Этот список можно отфильтровать по состоянию, конфигурации узла или шаблону имени.

![Состояние узла DSC](./media/automation-quickstart-dsc-configuration/dsc-node-status.png)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как подключить виртуальную машину Linux к службе State Configuration, создали конфигурацию для стека LAMP и развернули ее на виртуальной машине. Дополнительные сведения о применении службы State Configuration (служба автоматизации Azure) для непрерывного развертывания вы найдете в следующей статье:

> [!div class="nextstepaction"]
> [Пример использования. Непрерывное развертывание на виртуальных машинах с помощью Automation DSC и Chocolatey](./automation-dsc-cd-chocolatey.md)

* Дополнительные сведения о DSC для PowerShell см. в статье [Общие сведения о службе настройки требуемого состояния Windows PowerShell](https://docs.microsoft.com/powershell/scripting/dsc/overview/overview).
* Дополнительные сведения об управлении службой State Configuration из PowerShell см. в документации по [Azure PowerShell](https://docs.microsoft.com/powershell/module/azurerm.automation/).
* Чтобы научиться пересылать отчеты DSC в журналы Azure Monitor для создания отчетов и оповещений, изучите [эту статью](automation-dsc-diagnostics.md).