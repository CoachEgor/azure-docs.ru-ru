---
title: Управление решением для отслеживания изменений и инвентаризации в службе автоматизации Azure
description: В этой статье рассказывается, как использовать решение для отслеживания изменений и инвентаризации, чтобы отслеживать изменения программного обеспечения и служб Майкрософт в вашей среде.
services: automation
ms.subservice: change-inventory-management
ms.date: 06/15/2020
ms.topic: conceptual
ms.openlocfilehash: eab509e389c074232526aa93fcebb72f3bc986c0
ms.sourcegitcommit: ec682dcc0a67eabe4bfe242fce4a7019f0a8c405
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86185608"
---
# <a name="manage-change-tracking-and-inventory"></a>Управление решением для отслеживания изменений и инвентаризации

При добавлении нового файла или раздела реестра для отслеживания служба автоматизации Azure включает ее для [Отслеживание изменений и инвентаризации](change-tracking.md). В этой статье описывается настройка отслеживания, проверка результатов отслеживания и обработку предупреждений при обнаружении изменений.

Перед использованием процедур, описанных в этой статье, убедитесь, что вы включили Отслеживание изменений и инвентаризацию на виртуальных машинах с помощью одного из следующих методов:

* [Включение Отслеживания изменений и инвентаризации в учетной записи службы автоматизации](automation-enable-changes-from-auto-acct.md)
* [Включение Отслеживание изменений и инвентаризации путем обзора портал Azure](automation-enable-changes-from-browse.md)
* [Включение Отслеживания изменений и инвентаризации в последовательности runbook](automation-enable-changes-from-runbook.md)
* [Включение Отслеживания изменений и инвентаризации на виртуальной машине Azure](automation-enable-changes-from-vm.md)

## <a name="limit-the-scope-for-the-deployment"></a><a name="scope-configuration"></a>Ограничение области развертывания

Отслеживание изменений и инвентаризация использует конфигурацию области в пределах рабочей области, чтобы определить целевые компьютеры для приема изменений. Дополнительные сведения см. в разделе [Limit отслеживание изменений и Inventory Deployment Scope](automation-scope-configurations-change-tracking.md).

## <a name="track-files"></a>Отслеживание изменений в файлах

С помощью Отслеживание изменений и инвентаризации можно отслеживание изменений в файлах и папках или каталогах. В этом разделе описывается настройка отслеживания файлов в Windows и в Linux.

### <a name="configure-file-tracking-on-windows"></a>Настройка отслеживания изменений в файлах Windows

Чтобы настроить отслеживание изменений в файлах на компьютере с Windows:

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**. 
2. Щелкните **Изменить параметры** (символ шестеренки).
3. На странице "Конфигурация рабочей области" выберите **Файлы Windows** и нажмите кнопку **+ Добавить**, чтобы добавить новый файл для отслеживания.
4. В области добавить файл Windows для Отслеживание изменений введите сведения о файле или папке для трассировки и нажмите кнопку **сохранить**. В следующей таблице указаны свойства, которые можно использовать для получения сведений.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Значение true, если параметр применен, и false, если нет.        |
    |Имя элемента     | Понятное имя файла для отслеживания.        |
    |Группа     | Имя группы для логического группирования файлов.        |
    |Укажите путь     | Путь для проверки наличия файла, например, **c:\temp\\\*.txt**. Вы также можете использовать переменные среды, такие как `%winDir%\System32\\\*.*`.       |
    |Тип пути     | Тип пути. Возможные значения: File и Folder.        |    
    |Рекурсия     | Значение true, если используется рекурсия при поиске отслеживаемого элемента, или false, если нет.        |    
    |Отправка содержимого файла | Значение true, если нужно отправлять содержимое файла при отслеживании изменений, и false, если нет.|

5. Укажите значение true для параметра **Отправка содержимого файла**. Этот параметр включает отслеживание содержимого файла для указанного пути к файлу.

### <a name="configure-file-tracking-on-linux"></a>Настройка отслеживания изменений в файлах Linux

Чтобы настроить отслеживание файла на компьютере с Linux, сделайте следующее:

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**. 
2. Щелкните **Изменить параметры** (символ шестеренки).
3. На странице "Конфигурация рабочей области" выберите **Файлы Linux** и нажмите кнопку **+ Добавить**, чтобы добавить новый файл для отслеживания.
4. В области "Добавление файла Linux для отслеживания изменений" введите сведения о файле или папке, для которых необходимо включить отслеживание, и щелкните **Сохранить**. В следующей таблице указаны свойства, которые можно использовать для получения сведений.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Значение true, если параметр применен, и false, если нет.        |
    |Имя элемента     | Понятное имя файла для отслеживания.        |
    |Группа     | Имя группы для логического группирования файлов.        |
    |Укажите путь     | Путь для проверки наличия файла, например **/etc/*.conf**.       |
    |Тип пути     | Тип пути. Допускаются значения "Файл" и "Каталог".        |
    |Рекурсия     | Значение true, если используется рекурсия при поиске отслеживаемого элемента, или false, если нет.        |
    |Использовать sudo     | Значение true, чтобы использовать sudo при проверке наличия элемента, или false, если использовать sudo не нужно.         |
    |Ссылки     | Параметр, определяющий обработку символических ссылок при обзоре каталогов. Возможны следующие значения:<br> Пропустить — игнорирование символических ссылок без включения ссылочных файлов и каталогов.<br>Переходить — переход по символическим ссылкам во время рекурсий и включение ссылочных файлов и каталогов.<br>Управление — следует символической ссылкой и позволяет изменять возвращаемое содержимое.<br>**Примечание.** Параметр Manage не рекомендуется, так как он не поддерживает извлечение содержимого файлов.    |
    |Отправка содержимого файла | Значение true, если нужно отправлять содержимое файла при отслеживании изменений, и false, если нет. |

5. Укажите значение true для параметра **Отправка содержимого файла**. Этот параметр включает отслеживание содержимого файла для указанного пути к файлу.

   ![Добавление файла Linux](./media/change-tracking-file-contents/add-linux-file.png)

## <a name="track-file-contents"></a>Отслеживание содержимого файла

Отслеживание содержимого файла позволяет просматривать содержимое файла до и после отслеживаемого изменения. Эта функция сохраняет содержимое файла в [учетной записи хранения](../storage/common/storage-account-overview.md) после каждого изменения. Ниже приведены некоторые правила, которые необходимо выполнить для отслеживания содержимого файла.

* Для хранения содержимого файла требуется стандартная учетная запись хранения с моделью развертывания Resource Manager. 
* Не используйте учетные записи хранения классической модели развертывания и модели "Премиум". См. статью об [учетных записях службы хранилища Azure](../storage/common/storage-account-create.md).
* Учетную запись хранения можно подключить только к одной учетной записи службы автоматизации.
* [Отслеживание изменений и инвентаризации](change-tracking.md) должны быть включены в учетной записи службы автоматизации.

### <a name="enable-tracking-for-file-content-changes"></a>Включение отслеживания изменений для содержимого файлов

Чтобы включить отслеживание изменений в содержимом файла, выполните следующие действия.

1. На портале Azure откройте учетную запись службы автоматизации и выберите **Отслеживание изменений** в разделе **Управление конфигурацией**.
2. Щелкните **Изменить параметры** (символ шестеренки).
3. Выберите **Содержимое файла** и нажмите **Ссылка**. Откроется область "Добавление расположения содержимого для отслеживания изменений".

   ![Добавить расположение содержимого](./media/change-tracking-file-contents/enable.png)

4. Выберите подписку и учетную запись хранения для хранения содержимого файла. 

5. Если вы хотите включить отслеживание содержимого файла для всех существующих отслеживаемых файлов, выберите **Вкл.** для пункта **Отправка содержимого файла для всех параметров**. Позже вы сможете изменить этот параметр для каждого пути к файлу.

   ![Настройка учетной записи хранения](./media/change-tracking-file-contents/storage-account.png)

6. Решение для отслеживания изменений и инвентаризации отображает учетную запись хранения и URI подписанного URL-адреса (SAS), когда включает отслеживание изменений для содержимого файлов. Срок действия подписей истекает через 365 дней. Их можно создать повторно, щелкнув **Создать повторно**.

   ![Вывод ключей учетной записи](./media/change-tracking-file-contents/account-keys.png)

### <a name="view-the-contents-of-a-tracked-file"></a>Просмотр содержимого отслеживаемого файла

После того как решение для отслеживания изменений и инвентаризации обнаруживает изменение отслеживаемого файла, содержимое файла можно просмотреть на панели "Сведения об изменениях".  

![Список изменений](./media/change-tracking-file-contents/change-list.png)

1. На портале Azure откройте учетную запись службы автоматизации и выберите **Отслеживание изменений** в разделе **Управление конфигурацией**.

2. Выберите файл из списка изменений и выберите **Просмотр изменений содержимого файлов**, чтобы просмотреть содержимое файла. В области сведения об изменении отображаются стандартные сведения о файле до и после каждого свойства.

   ![Сведения об изменении](./media/change-tracking-file-contents/change-details.png)

3. В двух столбцах отображается содержимое файла до и после изменений. Вы можете выбрать **Встроенный**, чтобы просмотреть встроенное представление изменений.

## <a name="track-registry-keys"></a>Отслеживание разделов реестра

Чтобы настроить разделы реестра для отслеживания на компьютерах с Windows, сделайте следующее:

1. На портале Azure откройте учетную запись службы автоматизации и выберите **Отслеживание изменений** в разделе **Управление конфигурацией**. 
2. Щелкните **Изменить параметры** (символ шестеренки).
3. На странице "Конфигурация рабочей области" выберите **Реестр Windows**.
4. Щелкните **+ Добавить**, чтобы добавить раздел реестра, изменения в котором нужно отслеживать.
5. В области "Добавление реестра Windows для отслеживания изменений" введите сведения о разделе, для которого необходимо включить отслеживание, и щелкните **Сохранить**. В следующей таблице указаны свойства, которые можно использовать для получения сведений.

    |Свойство  |Описание:  |
    |---------|---------|
    |Активировано     | Значение true, если параметр применен, и false, если нет.        |
    |Имя элемента     | Понятное имя раздела реестра, который нужно отслеживать.        |
    |Группа     | Имя группы для логического группирования разделов реестра.        |
    |Раздел реестра Windows   | Имя ключа с путем, например `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders\Common Startup` .      |

## <a name="search-logs-for-change-records"></a>Поиск записей об изменениях в журналах

Вы можете искать различные записи об изменениях с помощью поисковых запросов к журналам Azure Monitor. Откройте страницу "Отслеживание изменений" и щелкните **Log Analytics**. Откроется страница "Журналы". Следующая таблица содержит примеры запросов поиска по журналам для получения записей об изменениях.

|Запрос  |Описание  |
|---------|---------|
|`ConfigurationData`<br> &#124; `where ConfigDataType == "WindowsServices" and SvcStartupType == "Auto"`<br> &#124; `where SvcState == "Stopped"`<br> &#124; `summarize arg_max(TimeGenerated, *) by SoftwareName, Computer`         | Показывает самые последние записи инвентаризации для служб Майкрософт, для которых установлено значение "Автоматический" и которые были остановлены. Результаты ограничены самой последней записью для указанного имени программного обеспечения и компьютера.    |
|`ConfigurationChange`<br> &#124; `where ConfigChangeType == "Software" and ChangeCategory == "Removed"`<br> &#124; `order by TimeGenerated desc`|Показывает записи об изменениях для удаленного программного обеспечения.|

## <a name="create-alerts-on-changes"></a>Создание оповещений об изменениях

В следующем примере показано, что файл **c:\windows\system32\drivers\etc\hosts** был изменен на компьютере. Этот файл важен, так как Windows использует его для разрешения имен узлов в IP-адреса. Эта операция имеет приоритет над DNS и может привести к проблемам с подключением. Она также может привести к перенаправлению трафика на вредоносные или другие опасные веб-сайты.

![Диаграмма, показывающая изменение файла hosts](./media/change-tracking-file-contents/changes.png)

Рассмотрим этот пример, чтобы обсудить шаги по созданию оповещений об изменении.

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**, а затем выберите **Log Analytics**. 
2. В интерфейсе поиска по журналам найдите изменения содержимого в файле **hosts** с помощью запроса `ConfigurationChange | where FieldsChanged contains "FileContentChecksum" and FileSystemPath contains "hosts"`. Этот запрос ищет изменения содержимого для файлов с полными именами путей, содержащими слово `hosts` . Вы также можете запросить конкретный файл, изменив путь на абсолютный, например с помощью `FileSystemPath == "c:\windows\system32\drivers\etc\hosts"`.

3. После того как запрос вернет результаты, щелкните **создать правило генерации оповещений** в поиске по журналам, чтобы открыть страницу создания предупреждения. Вы также можете перейти к этой странице с помощью **Azure Monitor** на портале Azure. 

4. Снова проверьте запрос и измените логику оповещения. В этом случае вы хотите, чтобы оповещение активировалось, если на всех машинах среды обнаружено хотя бы одно изменение.

    ![Изменение запроса для отслеживания изменений в файле hosts](./media/change-tracking-file-contents/change-query.png)

5. После установки логики оповещения назначьте группам действий выполнение действий в ответ на срабатывание предупреждения. В этом случае мы настраиваем отправление сообщений электронной почты и создание билета управления ИТ-услугами (ITSM). 

    ![Настройка группы действий для оповещения об изменении](./media/change-tracking/action-groups.png)

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о конфигурациях областей см. в разделе [Limit отслеживание изменений и Inventory Deployment Scope](automation-scope-configurations-change-tracking.md).
* Если необходимо выполнить поиск по журналам, хранящимся в рабочей области Log Analytics, см. статью [Поиск по журналам Azure Monitor](../azure-monitor/log-query/log-query-overview.md).
* Если вы завершили развертывание, см. раздел [Отмена связи рабочей области с учетной записью службы автоматизации для отслеживание изменений и инвентаризации](automation-unlink-workspace-change-tracking.md).
* Сведения об удалении виртуальных машин из Отслеживание изменений и инвентаризации см. в статье [Удаление виртуальных машин из отслеживание изменений и инвентаризации](automation-remove-vms-from-change-tracking.md).
* Сведения об устранении ошибок функции см. в статье [Устранение неполадок с решением для отслеживания изменений и инвентаризации](troubleshoot/change-tracking.md).
