---
title: Управление решением для отслеживания изменений и инвентаризации в службе автоматизации Azure
description: В этой статье рассказывается, как использовать решение для отслеживания изменений и инвентаризации, чтобы отслеживать изменения программного обеспечения и служб Майкрософт в вашей среде.
services: automation
ms.subservice: change-inventory-management
ms.date: 07/03/2018
ms.topic: conceptual
ms.openlocfilehash: 4b8bf6a3f583e4c17f61e0a46911990ac5cc827c
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83830486"
---
# <a name="manage-change-tracking-and-inventory"></a>Управление решением для отслеживания изменений и инвентаризации

Служба автоматизации Azure включает решение [Отслеживание изменений и инвентаризация](change-tracking.md) для компьютеров в вашей среде. С его помощью можно отслеживать изменения в разделах реестра, файлах, содержимом и т. д. В этой статье описаны процедуры для работы с этим решением.

## <a name="enable-the-full-change-tracking-and-inventory-feature"></a>Включение решения для отслеживания изменений и инвентаризации

Если вы включили [мониторинг целостности файлов (FIM) Центра безопасности Azure](https://docs.microsoft.com/azure/security-center/security-center-file-integrity-monitoring), вы можете использовать решение для отслеживания изменений и инвентаризации для компьютеров, как описано ниже. Этот процесс не приведет к удалению ваших параметров.

> [!NOTE]
> Включение решения для отслеживания изменений и инвентаризации может привести к дополнительным расходам. См. страницу [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

1. Чтобы удалить установленное решение для мониторинга, найдите его в [списке установленных решений](../azure-monitor/insights/solutions.md#list-installed-monitoring-solutions).
2. Щелкните имя решения, чтобы открыть страницу сводки, и выберите **Удалить**, как описано в разделе [Удаление решения для мониторинга](../azure-monitor/insights/solutions.md#remove-a-monitoring-solution).
3. Чтобы повторно включить решение для отслеживания изменений и инвентаризации, перейдите к учетной записи службы автоматизации и выберите **Отслеживание изменений** или  **Инвентаризация** в разделе **Управление конфигурацией**.
4. Выберите рабочую область Log Analytics и учетную запись службы автоматизации, подтвердите параметры рабочей области, а затем щелкните **Включить**.

## <a name="enable-machines-for-change-tracking-and-inventory"></a><a name="onboard"></a>Включение отслеживания изменений и инвентаризации на компьютерах

Чтобы начать отслеживание изменений, включите решение для отслеживания изменений и инвентаризации в службе автоматизации Azure. Ниже приведены рекомендуемые и поддерживаемые способы включения этой функции для компьютеров: 

* [включение на одной виртуальной машине;](automation-onboard-solutions-from-vm.md)
* [включение на нескольких виртуальных машинах;](automation-onboard-solutions-from-browse.md)
* [включение в учетной записи службы автоматизации;](automation-onboard-solutions-from-automation-account.md)
* [включение с помощью последовательности runbook службы автоматизации Azure.](automation-onboard-solutions.md)

## <a name="track-files"></a>Отслеживание изменений в файлах

### <a name="configure-file-tracking-on-windows"></a>Настройка отслеживания изменений в файлах Windows

Чтобы настроить отслеживание изменений в файлах на компьютере с Windows:

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**. 
2. Щелкните **Изменить параметры** (символ шестеренки).
3. На странице "Конфигурация рабочей области" выберите **Файлы Windows** и нажмите кнопку **+ Добавить**, чтобы добавить новый файл для отслеживания.
4. В области "Добавление файла Windows для отслеживания изменений" введите сведения о файле, для которого необходимо включить отслеживание, и щелкните **Сохранить**. В следующей таблице указаны свойства, которые можно использовать для получения сведений.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Значение true, если параметр применен, и false, если нет.        |
    |Имя элемента     | Понятное имя файла для отслеживания.        |
    |Группа     | Имя группы для логического группирования файлов.        |
    |Укажите путь     | Путь для проверки наличия файла, например, **c:\temp\\\*.txt**. Вы также можете использовать переменные среды, такие как `%winDir%\System32\\\*.*`.       |
    |Тип пути     | Тип пути. Допускаются значения "Файл" и "Каталог".        |    
    |Рекурсия     | Значение true, если используется рекурсия при поиске отслеживаемого элемента, или false, если нет.        |    
    |Отправка содержимого файла | Значение true, если нужно отправлять содержимое файла при отслеживании изменений, и false, если нет.|

5. Укажите значение true для параметра **Отправка содержимого файла**. Этот параметр включает отслеживание содержимого файла для указанного пути к файлу.

### <a name="configure-file-tracking-on-linux"></a>Настройка отслеживания изменений в файлах Linux

Чтобы настроить отслеживание файла на компьютере с Linux, сделайте следующее:

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**. 
2. Щелкните **Изменить параметры** (символ шестеренки).
3. На странице "Конфигурация рабочей области" выберите **Файлы Linux** и нажмите кнопку **+ Добавить**, чтобы добавить новый файл для отслеживания.
4. В области "Добавление файла Linux для отслеживания изменений" введите сведения о файле или папке, для которых необходимо включить отслеживание, и щелкните **Сохранить**. В следующей таблице указаны свойства, которые можно использовать для получения сведений.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Значение true, если параметр применен, и false, если нет.        |
    |Имя элемента     | Понятное имя файла для отслеживания.        |
    |Группа     | Имя группы для логического группирования файлов.        |
    |Укажите путь     | Путь для проверки наличия файла, например **/etc/*.conf**.       |
    |Тип пути     | Тип пути. Допускаются значения "Файл" и "Каталог".        |
    |Рекурсия     | Значение true, если используется рекурсия при поиске отслеживаемого элемента, или false, если нет.        |
    |Использовать sudo     | Значение true, чтобы использовать sudo при проверке наличия элемента, или false, если использовать sudo не нужно.         |
    |Ссылки     | Параметр, определяющий обработку символических ссылок при обзоре каталогов. Возможны следующие значения:<br> Пропустить — игнорирование символических ссылок без включения ссылочных файлов и каталогов.<br>Переходить — переход по символическим ссылкам во время рекурсий и включение ссылочных файлов и каталогов.<br>Управлять — переход по символическим ссылкам и разрешение изменения полученного содержимого. **Примечание.** Этот вариант не рекомендуется, так как он не поддерживает извлечение содержимого файлов.    |
    |Отправка содержимого файла | Значение true, если нужно отправлять содержимое файла при отслеживании изменений, и false, если нет. |

5. Укажите значение true для параметра **Отправка содержимого файла**. Этот параметр включает отслеживание содержимого файла для указанного пути к файлу.

   ![Добавление файла Linux](./media/change-tracking-file-contents/add-linux-file.png)

## <a name="track-file-contents"></a>Отслеживание содержимого файла

Отслеживание содержимого файла позволяет просматривать содержимое файла до и после отслеживаемого изменения. Эта функция сохраняет содержимое файла в учетную запись хранения после каждого изменения. Ниже приведены некоторые правила, которые необходимо выполнить для отслеживания содержимого файла.

* Для хранения содержимого файла требуется стандартная учетная запись хранения с моделью развертывания Resource Manager. 

* Не используйте учетные записи хранения классической модели развертывания и модели "Премиум". См. статью об [учетных записях службы хранилища Azure](../storage/common/storage-create-storage-account.md).

* Используемая учетная запись хранения может быть подключена только к одной учетной записи службы автоматизации.

* Решение [Отслеживание изменений и инвентаризация](change-tracking.md) включено в учетной записи службы автоматизации.

### <a name="enable-tracking-for-file-content-changes"></a>Включение отслеживания изменений для содержимого файлов

1. На портале Azure откройте учетную запись службы автоматизации и выберите **Отслеживание изменений** в разделе **Управление конфигурацией**.
2. Щелкните **Изменить параметры** (символ шестеренки).
3. Выберите **Содержимое файла** и нажмите **Ссылка**. Откроется область "Добавление расположения содержимого для отслеживания изменений".

   ![Включение расположения содержимого](./media/change-tracking-file-contents/enable.png)

4. Выберите подписку и учетную запись хранения для хранения содержимого файла. 

5. Если вы хотите включить отслеживание содержимого файла для всех существующих отслеживаемых файлов, выберите **Вкл.** для пункта **Отправка содержимого файла для всех параметров**. Позже вы сможете изменить этот параметр для каждого пути к файлу.

   ![Настройка учетной записи хранения](./media/change-tracking-file-contents/storage-account.png)

6. Решение для отслеживания изменений и инвентаризации отображает учетную запись хранения и URI подписанного URL-адреса (SAS), когда включает отслеживание изменений для содержимого файлов. Срок действия подписей истекает через 365 дней. Их можно создать повторно, щелкнув **Создать повторно**.

   ![Вывод ключей учетной записи](./media/change-tracking-file-contents/account-keys.png)

### <a name="view-the-contents-of-a-tracked-file"></a>Просмотр содержимого отслеживаемого файла

После того как решение для отслеживания изменений и инвентаризации обнаруживает изменение отслеживаемого файла, содержимое файла можно просмотреть на панели "Сведения об изменениях".  

![Список изменений](./media/change-tracking-file-contents/change-list.png)

1. На портале Azure откройте учетную запись службы автоматизации и выберите **Отслеживание изменений** в разделе **Управление конфигурацией**.

2. Выберите файл из списка изменений и выберите **Просмотр изменений содержимого файлов**, чтобы просмотреть содержимое файла. В области "Сведения об изменениях" отображаются стандартные сведения о файле до и после изменений.

   ![Сведения об изменении](./media/change-tracking-file-contents/change-details.png)

3. В двух столбцах отображается содержимое файла до и после изменений. Вы можете выбрать **Встроенный**, чтобы просмотреть встроенное представление изменений.

## <a name="track-registry-keys"></a>Отслеживание разделов реестра

Чтобы настроить разделы реестра для отслеживания на компьютерах с Windows, сделайте следующее:

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**. 
2. Щелкните **Изменить параметры** (символ шестеренки).
3. На странице "Конфигурация рабочей области" выберите **Реестр Windows**.
4. Щелкните **+ Добавить**, чтобы добавить раздел реестра, изменения в котором нужно отслеживать.
5. В области "Добавление реестра Windows для отслеживания изменений" введите сведения о разделе, для которого необходимо включить отслеживание, и щелкните **Сохранить**. В следующей таблице указаны свойства, которые можно использовать для получения сведений.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Значение true, если параметр применен, и false, если нет.        |
    |Имя элемента     | Понятное имя раздела реестра, который нужно отслеживать.        |
    |Группа     | Имя группы для логического группирования разделов реестра.        |
    |Раздел реестра Windows   | Имя раздела с полным путем, например **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders\Common Startup**.      |

## <a name="search-logs-for-change-records"></a>Поиск записей об изменениях в журналах

Вы можете искать различные записи об изменениях с помощью поисковых запросов к журналам Azure Monitor. Откройте страницу "Отслеживание изменений" и щелкните **Log Analytics**. Откроется страница "Журналы". Следующая таблица содержит примеры запросов поиска по журналам для получения записей об изменениях.

|Запрос  |Описание  |
|---------|---------|
|ConfigurationData<br>&#124; where   ConfigDataType == "Microsoft services" and SvcStartupType == "Auto"<br>&#124; where SvcState == "Stopped"<br>&#124; summarize arg_max(TimeGenerated, *) by SoftwareName, Computer         | Показывает самые последние записи инвентаризации для служб Майкрософт, для которых установлено значение "Автоматический" и которые были остановлены. Результаты ограничены самой последней записью для указанного имени программного обеспечения и компьютера.    |
|ConfigurationChange<br>&#124; where ConfigChangeType == "Software" and ChangeCategory == "Removed"<br>&#124; order by TimeGenerated desc|Показывает записи об изменениях для удаленного программного обеспечения.|

## <a name="create-alerts-on-changes"></a>Создание оповещений об изменениях

В следующем примере показано, что файл **C:\windows\system32\drivers\etc\hosts** был изменен на компьютере. Этот файл важен, так как Windows использует его для разрешения имен узлов в IP-адреса. Эта операция имеет приоритет над DNS и может привести к проблемам с подключением. Она также может привести к перенаправлению трафика на вредоносные или другие опасные веб-сайты.

![Диаграмма, отображающая изменение файла hosts](./media/change-tracking-file-contents/changes.png)

Рассмотрим этот пример, чтобы обсудить шаги по созданию оповещений об изменении.

1. В учетной записи службы автоматизации в разделе **Управление конфигурацией** выберите **Отслеживание изменений**, а затем выберите **Log Analytics**. 
2. В интерфейсе поиска по журналам найдите изменения содержимого в файле **hosts** с помощью запроса `ConfigurationChange | where FieldsChanged contains "FileContentChecksum" and FileSystemPath contains "hosts"`. Этот запрос ищет изменение содержимого для файлов с абсолютным путем, содержащим слово "hosts". Вы также можете запросить конкретный файл, изменив путь на абсолютный, например с помощью `FileSystemPath == "c:\windows\system32\drivers\etc\hosts"`.

3. После того как запрос вернет желаемые результаты, щелкните **Новое правило генерации оповещений** в поиске по журналам, чтобы открыть страницу создания оповещения. Вы также можете перейти к этой странице с помощью **Azure Monitor** на портале Azure. 

4. Снова проверьте запрос и измените логику оповещения. В этом случае вы хотите, чтобы оповещение активировалось, если на всех машинах среды обнаружено хотя бы одно изменение.

    ![Изменение запроса для отслеживания изменений в файле hosts](./media/change-tracking-file-contents/change-query.png)

5. После установки логики оповещения назначьте группы действий для выполнения действий в ответ на срабатывание оповещения. В этом случае мы настраиваем отправление сообщений электронной почты и создание билета управления ИТ-услугами (ITSM). 

    ![Настройка группы действий для оповещения об изменении](./media/change-tracking/action-groups.png)

## <a name="next-steps"></a>Дальнейшие действия

* Если необходимо выполнить поиск по журналам, хранящимся в рабочей области Log Analytics, см. статью [Поиск по журналам Azure Monitor](../log-analytics/log-analytics-log-searches.md).
* Сведения об устранении ошибок функции см. в статье [Устранение неполадок с решением для отслеживания изменений и инвентаризации](troubleshoot/change-tracking.md).