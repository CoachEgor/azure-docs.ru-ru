---
title: Устранение неполадок при изменениях на виртуальной машине Azure | Документация Майкрософт
description: Использование Отслеживания изменений для устранения неполадок при изменениях на виртуальной машине Azure.
services: automation
ms.subservice: change-inventory-management
keywords: change, tracking, automation
ms.date: 12/05/2018
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: 60ca1ef3d5c14a0f3dea5b662fc5c95184e6574d
ms.sourcegitcommit: 0947111b263015136bca0e6ec5a8c570b3f700ff
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "75420639"
---
# <a name="troubleshoot-changes-in-your-environment"></a>Устранение неполадок при изменениях в среде

Из этого руководства вы узнаете, как устранять неполадки, возникающие при изменениях на виртуальной машине Azure. Включив функцию отслеживания изменений, вы сможете контролировать изменения в программном обеспечении, файлах, управляющих программах, службах и разделах реестра Windows на компьютере.
Контроль таких изменений поможет вам точно определять причину проблем с работоспособностью в сетевой среде.

Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * подключить виртуальную машину к решениям для отслеживания изменений и инвентаризации;
> * Поиск остановленных служб в журналах изменений
> * Настройка функции отслеживания изменений
> * Настройка подключения к журналу действий
> * Активация события
> * Просмотр изменений
> * Настройка оповещений

## <a name="prerequisites"></a>предварительные требования

Для работы с этим учебником необходимы указанные ниже компоненты.

* Подписка Azure. Если у вас ее нет, [активируйте преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрируйте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации](automation-offering-get-started.md) для хранения runbook наблюдателя, runbook действия и задачи наблюдателя.
* [Виртуальная машина](../virtual-machines/windows/quick-create-portal.md) для подключения.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="enable-change-tracking-and-inventory"></a>Включение службы отслеживания изменений и инвентаризации

Чтобы выполнить задачи в сначала нужно настроить для виртуальной машины службу отслеживания изменений и инвентаризации. Если вы ранее настроили для этой виртуальной машины другую систему автоматизации, этот шаг можно пропустить.

1. В меню слева выберите **Виртуальные машины**, а затем выберите виртуальную машину в списке.
1. В меню слева в разделе **Operations** (Операции) выберите **Inventory** (Инвентаризация). Откроется страница **Change tracking** (Отслеживание изменений).

![Включение отслеживания изменений](./media/automation-tutorial-troubleshoot-changes/enableinventory.png) Откроется экран **Change Tracking** (Отслеживание изменений). Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем нажмите кнопку **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации.

Рабочая область [Log Analytics](../log-analytics/log-analytics-overview.md?toc=%2fazure%2fautomation%2ftoc.json) используется для сбора данных, созданных такими компонентами и службами, как "Инвентаризация".
Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.

При подключении также выполняется подготовка виртуальной машины с помощью Microsoft Monitoring Agent (MMA) и гибридной рабочей роли.
Этот агент позволяет взаимодействовать с виртуальной машиной и получать сведения об установленном программном обеспечении.

Включение решения может занять до 15 минут. В это время не закрывайте окно браузера.
Когда решение будет включено, сведения об установленном программном обеспечении и изменениях на виртуальной машине начнут передаваться в журналы Azure Monitor.
На получение данных для анализа может уйти от 30 минут до 6 часов.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="using-change-tracking-in-azure-monitor-logs"></a>Отслеживание изменений в журналах Azure Monitor

Функция отслеживания изменений создает данные журнала, которые отправляются в журналы Azure Monitor.
Чтобы найти журналы с помощью запросов, выберите **Log Analytics** в верхней части окна **Отслеживание изменений**.
Данные об отслеживании изменений хранятся в типе **ConfigurationChange**.
Следующий пример запроса к службе Log Analytics возвращает все остановленные службы Windows.

```loganalytics
ConfigurationChange
| where ConfigChangeType == "WindowsServices" and SvcState == "Stopped"
```

Дополнительные сведения о поиске по файлам журналов в журналах Azure Monitor см. в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/log-query/log-query-overview.md).

## <a name="configure-change-tracking"></a>Настройка отслеживания изменений

Отслеживание изменений позволяет контролировать изменения конфигурации на виртуальной машине. Следующие действия позволяют настроить отслеживание для файлов и разделов реестра.

Чтобы выбрать, какие файлы и разделы реестра нужно собирать и отслеживать, выберите действие **Изменение параметров** в верхней части страницы **Отслеживание изменений**.

> [!NOTE]
> Инвентаризация и Отслеживание изменений используют одни и те же параметры сбора настроек, которые настраиваются на уровне рабочей области.

В окне **Конфигурация рабочей области** добавьте разделы реестра Windows, файлы Windows или файлы Linux, которые нужно отслеживать, как описано в следующих трех разделах.

### <a name="add-a-windows-registry-key"></a>Добавление раздела реестра Windows

1. На вкладке **Реестр Windows** выберите **Добавить**.
    Откроется окно **Добавление реестра Windows для отслеживания изменений**.

1. В окне **Добавление реестра Windows для отслеживания изменений** введите сведения о ключе, для которого необходимо выполнить отслеживание, и щелкните **Save** (Сохранить).

|Свойство  |Description  |
|---------|---------|
|Активировано     | Определяет, применяется ли параметр        |
|Имя элемента     | Понятное имя файла для отслеживания        |
|Группа     | Имя группы для логического группирования файлов        |
|Раздел реестра Windows   | Путь для проверки наличия файла. Например, HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders\Common Startup.      |

### <a name="add-a-windows-file"></a>Добавление файлов Windows

1. На вкладке **Файлы Windows** выберите **Добавить**. Откроется окно **Добавление файла Windows для отслеживания изменений**.

1. В окне **Добавление файла Windows для отслеживания изменений** введите сведения о файле или папке, для которых необходимо выполнить отслеживание, и щелкните **Save** (Сохранить).

|Свойство  |Description  |
|---------|---------|
|Активировано     | Определяет, применяется ли параметр        |
|Имя элемента     | Понятное имя файла для отслеживания        |
|Группа     | Имя группы для логического группирования файлов        |
|Укажите путь     | Путь для проверки наличия файла. Например, c:\temp\\\\*.txt.<br>Вы также можете использовать переменные среды, такие как %winDir%\System32\\\*.*         |
|Рекурсия     | Определяет, используется ли рекурсия при поиске отслеживаемого элемента.        |
|Отправка содержимого файла для всех параметров| Включение или отключение отправки содержимого файла для отслеженных изменений. Доступные параметры: **True** или **False**.|

### <a name="add-a-linux-file"></a>Добавление файла Linux

1. На вкладке **Файлы Linux** выберите **Добавить**. Откроется окно **Добавление файла Linux для отслеживания изменений**.

1. В окне **Добавление файла Linux для отслеживания изменений** введите сведения о файле или папке, для которых необходимо выполнить отслеживание, и щелкните **Save** (Сохранить).

|Свойство  |Description  |
|---------|---------|
|Активировано     | Определяет, применяется ли параметр        |
|Имя элемента     | Понятное имя файла для отслеживания        |
|Группа     | Имя группы для логического группирования файлов        |
|Укажите путь     | Путь для проверки наличия файла. Например, /etc/*.conf.       |
|Тип пути     | Тип элемента для отслеживания (возможными значениями могут быть "Файл" и "Каталог")        |
|Рекурсия     | Определяет, используется ли рекурсия при поиске отслеживаемого элемента.        |
|Использовать sudo     | Этот параметр определяет, используется ли sudo для проверки наличия элемента.         |
|Ссылки     | Этот параметр определяет работу символических ссылок при обзоре каталогов.<br> **Ignore** (Игнорировать) — игнорирование символических ссылок без включения ссылочных файлов и каталогов.<br>**Follow** (Переходить) — переход по символическим ссылкам во время рекурсий и включение ссылочных файлов и каталогов.<br>**Manage** (Управлять) — переход по символическим ссылкам и изменение способа обработки полученного содержимого.      |
|Отправка содержимого файла для всех параметров| Включение или отключение отправки содержимого файла для отслеженных изменений. Доступные параметры: **True** или **False**.|

   > [!NOTE]
   > Однако использовать ссылку "Управлять" не рекомендуется. Получение содержимого файлов не поддерживается.

## <a name="enable-activity-log-connection"></a>Настройка подключения к журналу действий

На странице **Отслеживание изменений** на виртуальной машине выберите **Управление подключением журнала действий**. Эта операция открывает страницу **Журнал действий Azure**. Выберите **Подключить**, чтобы подключить журнал действий Azure для виртуальной машины к службе отслеживания изменений.

Включив этот параметр, перейдите к странице **Обзор** для виртуальной машины и выберите действие **Остановить**, чтобы остановить виртуальную машину. Подтвердите остановку, выбрав **Да** при появлении соответствующего запроса. Когда освобождение виртуальной машины завершится, выберите **Запустить**, чтобы снова запустить ее.

Остановка и запуск виртуальной машины регистрируются как события в журнале действий. Вернитесь к странице **Отслеживание изменений**. Выберите вкладку **События** в нижней части страницы. Через некоторое время события отобразятся на диаграмме и в таблице. Как и на предыдущем шаге, вы можете выбрать любое из этих событий, чтобы просмотреть подробные сведения о нем.

![Просмотр сведений об изменениях на портале](./media/automation-tutorial-troubleshoot-changes/viewevents.png)

## <a name="view-changes"></a>Просмотр изменений

После того, как вы включите службу отслеживания изменений и инвентаризации, вы сможете увидеть собранные результаты на странице **Отслеживание изменений**.

На виртуальной машине выберите элемент **Отслеживание изменений** в разделе **Операции**.

![Снимок экрана, на котором показан список изменений виртуальной машины](./media/automation-tutorial-troubleshoot-changes/change-tracking-list.png)

Здесь отображаются изменения, произошедшие за определенное время.
Когда вы добавите соединение с журналом действий, график в верхней части отобразит события из журнала действий Azure.
Каждая строка гистограммы соответствует определенному типу отслеживаемых изменений.
К этим типам относятся управляющие программы Linux, файлы, разделы реестра Windows, программное обеспечение и службы Windows.
Вкладка "Изменения" отображает сведения об изменениях, отсортированные по времени в обратном порядке (первыми показаны самые последние).
На вкладке **События** представлена таблица с событиями подключенных журналов событий и сведениями о них, начиная с самых последних.

В этом примере результатов вы можете заметить, что в систему внесено несколько изменений, в том числе относящихся к службам и программному обеспечению. Фильтры в верхней части страницы позволяют выбрать результаты по **типу изменений** или диапазону времени.

Выберите строку изменения **WindowsServices**, чтобы открыть окно **Сведения об изменении**. В окне сведений об изменении представлена информация о конкретном изменении, а также соответствующие значения до и после изменения. Этот пример сообщает об остановке службы защиты программного обеспечения.

![Просмотр сведений об изменениях на портале](./media/automation-tutorial-troubleshoot-changes/change-details.png)

## <a name="configure-alerts"></a>Настройка оповещений

Просмотр изменений на портале Azure может быть полезным, но удобнее просто получать оповещения при внесении изменений, таких как остановка службы.

Чтобы добавить оповещение об остановке службы, на портале Azure откройте **Монитор**. В разделе **Общие службы** выберите **Оповещения** и нажмите кнопку **+Создать правило генерации оповещений**.

Нажмите кнопку **Выбрать**, чтобы выбрать ресурс. На странице **Выберите ресурс** выберите **Log Analytics** из раскрывающегося списка **Фильтр по типу ресурсов**. Выберите рабочую область Log Analytics, а затем выберите **Готово**.

![Выбор ресурса](./media/automation-tutorial-troubleshoot-changes/select-a-resource.png)

На странице **Настроить логику сигналов** щелкните **Добавить условие** и в таблице выберите **Custom log search** (Поиск в пользовательских журналах). В текстовое поле "Поисковый запрос" введите следующий запрос:

```loganalytics
ConfigurationChange | where ConfigChangeType == "WindowsServices" and SvcName == "W3SVC" and SvcState == "Stopped" | summarize by Computer
```

Этот запрос возвращает сведения о компьютерах с остановленной службой W3SVC в рамках указанного интервала времени.

В разделе **Логика оповещений** в поле **Порог** введите **0**. По завершении нажмите кнопку **Готово**.

![Настройка логики сигналов](./media/automation-tutorial-troubleshoot-changes/configure-signal-logic.png)

В разделе **Группы действий** выберите **Создать**. Группа действий содержит действия, которые можно использовать для нескольких оповещений. Эти действия могут включать в себя уведомления электронной почты, модули Runbook, веб-перехватчики и многое другое, но не ограничиваются ими. Дополнительные сведения о группах действий см. в разделе [Создание групп действий и управление ими на портале Azure](../azure-monitor/platform/action-groups.md).

В разделе **Подробности об оповещении** введите имя и описание для оповещения. Задайте для параметра **Серьезность** значения **Информация (уровень серьезности 2)** , **Предупреждение (уровень серьезности 1)** или **Критический (уровень серьезности 0)** .

В поле **Имя группы действий** введите имя для оповещения и короткое имя. Короткое имя используется вместо полного имени группы действий при отправке уведомлений с помощью этой группы.

В разделе **Действия** введите имя действия, например **Администраторы электронной почты**. В разделе **Тип действия** выберите **Email/SMS/Push/Voice**. В разделе **Сведения** выберите **Изменить сведения**.

![Добавление группы действий](./media/automation-tutorial-troubleshoot-changes/add-action-group.png)

На панели **Email/SMS/Push/Voice** введите имя. Установите флажок **Электронная почта**, а затем введите допустимый адрес электронной почты. Нажмите кнопку **ОК** на странице **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовой вызов), чтобы закрыть ее, и еще раз нажмите кнопку **ОК**, чтобы закрыть страницу **Добавление группы действий**.

Чтобы настроить тему оповещения по электронной почте, выберите **Создать правило**, **Настройка действий** и **Тема сообщения**. Когда закончите, выберите **Создать правило оповещения**. Это оповещение уведомляет об успешном завершении развертывания обновления и предоставляет сведения о том, на каких компьютерах выполнялось развертывание.

На следующем рисунке представлен пример сообщения, полученный при остановке службы W3SVC.

![email](./media/automation-tutorial-troubleshoot-changes/email.png)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * подключить виртуальную машину к решениям для отслеживания изменений и инвентаризации;
> * Поиск остановленных служб в журналах изменений
> * Настройка функции отслеживания изменений
> * Настройка подключения к журналу действий
> * Активация события
> * Просмотр изменений
> * Настройка оповещений

См. дополнительные сведения о решении для отслеживания изменений и инвентаризации, чтобы получить дополнительные сведения.

> [!div class="nextstepaction"]
> [Change management and Inventory solution](automation-change-tracking.md) (Решение для управления изменениями и инвентаризации)

