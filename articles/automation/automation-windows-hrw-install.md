---
title: Развертывание гибридной рабочей роли Runbook в службе автоматизации Azure
description: В этой статье описывается развертывание гибридной рабочей роли Runbook, которая позволяет запускать последовательности runbook на компьютерах под управлением Windows в локальном центре обработки данных или облачной среде.
services: automation
ms.subservice: process-automation
ms.date: 12/10/2019
ms.topic: conceptual
ms.openlocfilehash: e4b8bcf2b6ed5ab9c1160df49b1a6082aaf02f65
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83830469"
---
# <a name="deploy-a-windows-hybrid-runbook-worker"></a>Развертывание гибридной рабочей роли Runbook для Windows

Гибридную рабочую роль Runbook службы автоматизации Azure можно использовать для выполнения модулей runbook непосредственно на компьютере, размещающем роль, для работы с ресурсами в среде, что позволяет управлять этими локальными ресурсами. Служба автоматизации Azure хранит runbook и управляет ими, а затем передает их на один или несколько выделенных компьютеров. В этой статье описано, как развернуть гибридную рабочую роль Runbook на компьютере Windows.

После успешного развертывания рабочей роли Runbook ознакомьтесь с [запуском модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md), чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="windows-hybrid-runbook-worker-installation-and-configuration"></a>Установка и настройка гибридной рабочей роли Runbook для Windows

Ниже описаны методы установки и настройки гибридной рабочей роли Runbook для Windows.

* Для виртуальных машин Azure установите агент Log Analytics для Windows с помощью [расширения виртуальной машины для Windows](../virtual-machines/extensions/oms-windows.md). Это расширение устанавливает агент Log Analytics на виртуальных машинах Azure и регистрирует виртуальные машины в существующей рабочей области Log Analytics с помощью шаблона Azure Resource Manager или PowerShell. После установки агента виртуальную машину можно добавить в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации. См. шаги 3 и 4 в разделе [Развертывание вручную](#manual-deployment).

* Используйте runbook службы автоматизации для полной автоматизации процесса настройки компьютера Windows. Мы рекомендуем этот способ для компьютеров в центре обработки данных или в другой облачной среде.

* Выполните пошаговую процедуру, чтобы вручную установить и настроить гибридную рабочую роль Runbook на виртуальной машине, размещенной не в Azure.

> [!NOTE]
> Чтобы управлять конфигурацией серверов, поддерживающих гибридную рабочую роль Runbook и DSC (Desired State Configuration), добавьте такие серверы в качестве узлов DSC.

### <a name="minimum-requirements-for-windows-hybrid-runbook-worker"></a>Минимальные требования для гибридной рабочей роли Runbook для Windows

Ниже приведены минимальные требования для гибридной рабочей роли Runbook Windows.

* Windows Server 2012 или более поздней версии;
* Windows PowerShell версии 5.1 или более поздней ([скачать WMF 5.1](https://www.microsoft.com/download/details.aspx?id=54616));
* .NET Framework 4.6.2 или более поздней версии.
* два ядра;
* 4 ГБ ОЗУ;
* Порт 443 (исходящий).

### <a name="network-configuration"></a>Конфигурация сети

Дополнительные требования к сети для гибридной рабочей роли Runbook см. в разделе [Настройка сети](automation-hybrid-runbook-worker.md#network-planning).

### <a name="enabling-servers-for-management-with-azure-automation-state-configuration"></a>Настройка серверов для управления из State Configuration службы автоматизации Azure

Сведения о включении управления серверами с помощью State Configuration службы автоматизации Azure см. в [этой статье](automation-dsc-onboarding.md).

При включении компонента [Управление обновлениями](automation-update-management.md) службы автоматизации Azure любой компьютер Windows, подключенный к рабочей области Log Analytics, автоматически настраивается в качестве гибридной рабочей роли Runbook для поддержки обновлений runbook. Но эта рабочая роль не регистрируется в группах гибридных рабочих ролей Runbook, которые уже определены в учетной записи службы автоматизации.

### <a name="addition-of-the-computer-to-a-hybrid-runbook-worker-group"></a>Добавление компьютера в группу гибридных рабочих ролей Runbook

Вы можете добавить компьютер рабочей роли в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации. Обратите внимание, что вам нужно обеспечить поддержку runbook службы автоматизации, если одна учетная запись одновременно используется для службы автоматизации Azure и принадлежит к группе гибридных рабочих ролей Runbook. Эта функция добавлена в версии 7.2.12024.0 гибридной рабочей роли Runbook.

## <a name="automated-deployment"></a>Автоматизированное развертывание

Выполните на целевом компьютере следующие действия для автоматизации установки и настройки гибридной рабочей роли для Windows.

### <a name="step-1---download-the-powershell-script"></a>Шаг 1. Скачайте скрипт PowerShell

Скачайте скрипт **New-OnPremiseHybridWorker.ps1** из [коллекции PowerShell](https://www.powershellgallery.com/packages/New-OnPremiseHybridWorker). Скачивать можно с того же компьютера, на котором запущена гибридная рабочая роль Runbook, или с другого компьютера в локальной среде. Скопируйте скачанный скрипт в рабочую роль. Скрипт **New-OnPremiseHybridWorker.ps1** во время выполнения использует следующие параметры.

| Параметр | Состояние | Описание |
| --------- | ------ | ----------- |
| `AAResourceGroupName` | Обязательный | имя группы ресурсов, связанной с вашей учетной записью службы автоматизации. |
| `AutomationAccountName` | Обязательный | имя учетной записи службы автоматизации.
| `Credential` | Необязательно | Учетные данные для входа в среду Azure. |
| `HybridGroupName` | Обязательный | имя группы гибридных рабочих ролей Runbook, которую вы указываете в качестве целевой для модулей runbook, поддерживающих этот сценарий. |
| `OMSResourceGroupName` | Необязательно | имя группы ресурсов для рабочей области Log Analytics. Если эта группа ресурсов не указана, используется значение `AAResourceGroupName`. |
| `SubscriptionID` | Обязательный | Идентификатор подписки Azure, которая связана с учетной записью службы автоматизации. |
| `TenantID` | Необязательно | Идентификатор организации клиента, которая связана с учетной записью службы автоматизации. |
| `WorkspaceName` | Необязательно | Имя рабочей области Log Analytics. Если у вас нет рабочей области Log Analytics, сценарий создаст и настроит ее. |

> [!NOTE]
> При включении возможностей служба автоматизации Azure поддерживает связывание рабочей области Log Analytics и учетной записи службы автоматизации только в определенных регионах. Список поддерживаемых пар сопоставлений см. в статье о [сопоставлении региона для учетной записи службы автоматизации и рабочей области Log Analytics](how-to/region-mappings.md).

### <a name="step-2---open-windows-powershell-command-line-shell"></a>Шаг 2. Откройте оболочку командной строки Windows PowerShell

Откройте **Windows PowerShell** на **начальном экране** в режиме администратора.

### <a name="step-3---run-the-powershell-script"></a>Шаг 3. Выполните скрипт PowerShell

В оболочке командной строки PowerShell перейдите в папку, которая содержит скачанный ранее скрипт. Измените значения параметров `AutomationAccountName`, `AAResourceGroupName`, `OMSResourceGroupName`, `HybridGroupName`, `SubscriptionID` и `WorkspaceName`. Затем выполните сценарий.

После выполнения сценария вы увидите запрос на аутентификацию в Azure. Для входа нужно использовать учетную запись, которая является участником роли администраторов подписки и соадминистратором подписки.

```powershell-interactive
.\New-OnPremiseHybridWorker.ps1 -AutomationAccountName <NameofAutomationAccount> -AAResourceGroupName <NameofResourceGroup>`
-OMSResourceGroupName <NameofOResourceGroup> -HybridGroupName <NameofHRWGroup> `
-SubscriptionID <AzureSubscriptionId> -WorkspaceName <NameOfLogAnalyticsWorkspace>
```

### <a name="step-4---install-nuget"></a>Шаг 4. Установите NuGet

Вы получите предложение подтвердить установку пакета NuGet и указать учетные данные Azure для аутентификации. Если у вас нет последней версии NuGet, ее можно получить на странице [доступных версий дистрибутивов NuGet](https://www.nuget.org/downloads).

### <a name="step-5---verify-the-deployment"></a>Шаг 5. Проверьте развертывание

После выполнения сценария на странице "Группы гибридных рабочих ролей" появится новая группа с указанием количества ее членов. Если указать имеющуюся группу, количество элементов в ней увеличивается. Вы можете выбрать группу из списка на странице "Группы гибридных рабочих ролей" и щелкнуть плитку **Гибридные рабочие роли**. На странице "Гибридные рабочие роли" отображается полный список членов группы.

## <a name="manual-deployment"></a>Развертывание вручную

На целевом компьютере единожды выполните первые два шага для среды автоматизации. Затем единожды выполните оставшиеся действия для каждого компьютера рабочей роли.

### <a name="step-1---create-a-log-analytics-workspace"></a>Шаг 1. Создайте рабочую область Log Analytics

Если у вас еще нет рабочей области Log Analytics, создайте ее, предварительно ознакомившись с [руководством по проектированию в журналах Azure Monitor](../azure-monitor/platform/design-logs-deployment.md).

### <a name="step-2---add-an-azure-automation-feature-to-the-log-analytics-workspace"></a>Шаг 2. Добавьте возможность службы автоматизации Azure в рабочую область Log Analytics

Возможность службы автоматизации расширяет функциональность службы автоматизации Azure, в том числе обеспечивая поддержку гибридных рабочих ролей Runbook. При включении возможности службы автоматизации Azure в рабочей области Log Analytics на компьютер агента автоматически отправляются компоненты рабочей роли.

Чтобы добавить в рабочую область возможность службы автоматизации Azure, например "Управление обновлениями", выполните следующий командлет PowerShell:

```powershell-interactive
Set-AzOperationalInsightsIntelligencePack -ResourceGroupName <logAnalyticsResourceGroup> -WorkspaceName <LogAnalyticsWorkspaceName> -IntelligencePackName "AzureAutomation" -Enabled $true -DefaultProfile <IAzureContextContainer>
```

### <a name="step-3---install-the-log-analytics-agent-for-windows"></a>Шаг 3. Установите агент Log Analytics для Windows

Агент Log Analytics для Windows подключает компьютеры к рабочей области Log Analytics в Azure Monitor. Когда агент устанавливается на компьютер и подключается к рабочей области, он автоматически скачивает обязательные компоненты для гибридной рабочей роли Runbook.

Чтобы установить агент на компьютер, следуйте инструкциям в статье [Подключение компьютеров Windows к журналам Azure Monitor](../log-analytics/log-analytics-windows-agent.md). Выполните эту процедуру на нескольких компьютерах, чтобы добавить в среду несколько компонентов Worker.

Подключение агента к рабочей области Log Analytics занимает несколько минут, и после этого вы можете выполнить следующий запрос и убедиться, что он отправляет данные пульса в рабочую область.

```kusto
Heartbeat 
| where Category == "Direct Agent" 
| where TimeGenerated > ago(30m)
```

В результатах поиска должны отображаться записи пульса для компьютера, подтверждающие, что агент успешно подключен и отправляет отчеты в службу. По умолчанию каждый агент перенаправляет запись пульса в назначенную ему рабочую область. Выполните следующие шаги, чтобы завершить установку и настройку агента.

1. Включите возможность, чтобы добавить компьютер агента. Подробные сведения см. в статье [Включение Управления обновлениями в учетной записи службы автоматизации](https://docs.microsoft.com/azure/automation/automation-onboard-solutions-from-automation-account#onboard-machines-in-the-workspace).
2. Убедитесь, что агент правильно скачал возможность службы автоматизации Azure. 
3. Чтобы проверить версию гибридной рабочей роли Runbook, откройте папку **C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation** и найдите вложенную папку с номером **версии**.

### <a name="step-4---install-the-runbook-environment-and-connect-to-azure-automation"></a>Шаг 4. Установите среду runbook и подключитесь к службе автоматизации Azure

Когда вы настраиваете в агенте отправку данных в рабочую область Log Analytics, возможность службы автоматизации Azure отправляет на агент модуль PowerShell `HybridRegistration`, который содержит командлет `Add-HybridRunbookWorker`. Примените этот командлет для установки среды runbook на компьютере и ее регистрации в службе автоматизации Azure.

Откройте сеанс PowerShell с правами администратора и импортируйте модуль, выполнив указанные ниже команды.

```powershell-interactive
cd "C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\<version>\HybridRegistration"
Import-Module .\HybridRegistration.psd1
```

Теперь выполните командлет `Add-HybridRunbookWorker`, используя следующий синтаксис.

```powershell-interactive
Add-HybridRunbookWorker –GroupName <String> -EndPoint <Url> -Token <String>
```

Необходимые данные для этого командлета можно найти на странице "Управление ключами" на портале Azure. Чтобы открыть эту страницу, щелкните **Ключи** на странице "Параметры" для учетной записи службы автоматизации.

![Страница "Управление ключами"](media/automation-hybrid-runbook-worker/elements-panel-keys.png)

* Для параметра `GroupName` укажите имя группы гибридных рабочих ролей Runbook. Если эта группа уже существует в учетной записи службы автоматизации, то к ней добавляется текущий компьютер. Если эта группа не существует, она добавляется.
* Для параметра `EndPoint` используйте запись **URL-адрес** со страницы "Управление ключами".
* Для параметра `Token` используйте запись **Первичный ключ доступа** со страницы "Управление ключами".
* При необходимости задайте параметр `Verbose`, чтобы получить сведения об установке.

### <a name="step-5----install-powershell-modules"></a>Шаг 5. Установите модули PowerShell

Модули Runbook могут использовать любые из действий и командлетов, которые определены в модулях, установленных в вашей среде службы автоматизации Azure. Эти модули не развертываются на локальных компьютерах автоматически, поэтому их придется устанавливать вручную. Исключением является модуль Azure. Этот модуль устанавливается по умолчанию и предоставляет доступ к командлетам для всех служб и действий службы автоматизации Azure.

Так как главной целью гибридной рабочей роли Runbook является управление локальными ресурсами, вам с большой вероятностью потребуются модули, которые поддерживают эти ресурсы (в частности, модуль `PowerShellGet`). Сведения об установке модулей Windows PowerShell см. в [этой статье](https://docs.microsoft.com/powershell/scripting/developer/windows-powershell).

Устанавливаемые модули должны находиться в расположении, указанном в переменной среды `PSModulePath`, чтобы гибридная рабочая роль автоматически импортировала их. Дополнительные сведения см. в разделе [Установка модулей в PSModulePath](https://docs.microsoft.com/powershell/scripting/developer/module/installing-a-powershell-module?view=powershell-7).

## <a name="remove-the-hybrid-runbook-worker-from-an-on-premises-windows-computer"></a><a name="remove-windows-hybrid-runbook-worker"></a>Удаление гибридной рабочей роли Runbook с локального компьютера Windows

1. На портале Azure перейдите в свою учетную запись в службе автоматизации.
2. В разделе **Параметры учетной записи** выберите **Ключи** и запишите значения **URL-адреса** и **первичного ключа доступа**.

3. Откройте сеанс PowerShell в режиме администратора и выполните следующую команду, указав значения URL-адреса и первичного ключа доступа. Используйте параметр `Verbose`, чтобы получить подробный журнал процесса удаления. Чтобы удалить устаревшие машины из группы гибридной рабочей роли, используйте необязательный параметр `machineName`.

```powershell-interactive
Remove-HybridRunbookWorker -url <URL> -key <PrimaryAccessKey> -machineName <ComputerName>
```

## <a name="remove-a-hybrid-worker-group"></a>Удаление группы гибридных рабочих ролей

Чтобы удалить группу гибридных рабочих ролей Runbook, сначала удалите гибридную рабочую роль Runbook с каждого компьютера, который является членом этой группы. Затем выполните указанные ниже действия для удаления группы:

1. На портале Azure откройте учетную запись службы автоматизации.
2. В разделе **Автоматизация процессов** выберите **Группы гибридных рабочих ролей**. Выберите группу, которую нужно удалить. Откроется страница свойств этой группы.

   ![Страница свойств](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-group-properties.png)

3. На странице свойств выбранной группы выберите **Удалить**. Появится сообщение с запросом на подтверждение этого действия. Выберите **Да**, если хотите продолжить.

   ![Сообщение с подтверждением](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-confirm-delete.png)

   Для завершения процесса может потребоваться несколько секунд. Ход создания можно просмотреть в разделе **Уведомления** в меню.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде, см. статью [Запуск модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md).
* Дополнительные сведения см. в статье [Устранение неполадок с гибридными рабочими ролями Runbook](troubleshoot/hybrid-runbook-worker.md#general).