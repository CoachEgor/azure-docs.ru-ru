---
title: Развертывание гибридной рабочей роли Runbook в службе автоматизации Azure
description: В этой статье рассказывается, как развернуть гибридную рабочую роль Runbook, которую можно использовать для запуска модулей Runbook на компьютерах под управлением Windows в локальном центре обработки данных или в облачной среде.
services: automation
ms.subservice: process-automation
ms.date: 06/24/2020
ms.topic: conceptual
ms.openlocfilehash: e1262aedda95f3feb7cf5604644d938bf4d00a53
ms.sourcegitcommit: 9b5c20fb5e904684dc6dd9059d62429b52cb39bc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85854917"
---
# <a name="deploy-a-windows-hybrid-runbook-worker"></a>Развертывание гибридной рабочей роли Runbook для Windows

Вы можете использовать функцию гибридной рабочей роли Runbook в службе автоматизации Azure для запуска модулей Runbook непосредственно на компьютере, на котором размещается роль, и для ресурсов в среде, чтобы управлять этими локальными ресурсами. Служба автоматизации Azure хранит и управляет модулями Runbook, а затем доставляет их на один или несколько определенных компьютеров. В этой статье описывается развертывание гибридной рабочей роли Runbook на компьютере Windows, удаление рабочей роли и удаление группы гибридных рабочих ролей Runbook.

После успешного развертывания рабочей роли Runbook ознакомьтесь с [запуском модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md), чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде.

## <a name="prerequisites"></a>Предварительные условия

Прежде чем начать, убедитесь, что у вас есть следующее.

### <a name="a-log-analytics-workspace"></a>Рабочая область Log Analytics

Гибридная Рабочая роль Runbook зависит от Azure Monitor Log Analytics рабочей области для установки и настройки роли. Его можно создать с помощью [Azure Resource Manager](../azure-monitor/samples/resource-manager-workspace.md#create-a-log-analytics-workspace), с помощью [PowerShell](../azure-monitor/scripts/powershell-sample-create-workspace.md?toc=/powershell/module/toc.json)или в [портал Azure](../azure-monitor/learn/quick-create-workspace.md).

Если у вас нет рабочей области Log Analytics Azure Monitor, ознакомьтесь с [руководством по проектированию журналов Azure Monitor](../azure-monitor/platform/design-logs-deployment.md) перед созданием рабочей области.

Если у вас есть рабочая область, но она не связана с учетной записью службы автоматизации, включение функции автоматизации расширяет возможности службы автоматизации Azure, включая поддержку гибридной рабочей роли Runbook. При включении одной из функций службы автоматизации Azure в рабочей области Log Analytics, в частности [Управление обновлениями](automation-update-management.md) или [Отслеживание изменений и инвентаризации](change-tracking.md), рабочие компоненты автоматически отправляются на компьютер агента.

   Чтобы добавить компонент Управление обновлениями в рабочую область, выполните следующий командлет PowerShell:

```powershell-interactive
   Set-AzOperationalInsightsIntelligencePack -ResourceGroupName <logAnalyticsResourceGroup> -WorkspaceName <logAnalyticsWorkspaceName> -IntelligencePackName "Updates" -Enabled $true
```

   Чтобы добавить функцию Отслеживание изменений и инвентаризации в рабочую область, выполните следующий командлет PowerShell:

```powershell-interactive
   Set-AzOperationalInsightsIntelligencePack -ResourceGroupName <logAnalyticsResourceGroup> -WorkspaceName <logAnalyticsWorkspaceName> -IntelligencePackName "ChangeTracking" -Enabled $true
```

### <a name="log-analytics-agent"></a>Агент Log Analytics

Для работы гибридной рабочей роли Runbook требуется [агент log Analytics](../azure-monitor/platform/log-analytics-agent.md) для поддерживаемой операционной системы Windows.

### <a name="supported-windows-operating-system"></a>Поддерживаемая операционная система Windows

Следующие версии операционной системы Windows официально поддерживаются для гибридной рабочей роли Runbook Windows:

* Windows Server 2019
* Windows Server 2016, версии 1709 и 1803
* Windows Server 2012, 2012 R2
* Windows Server 2008 (x64) с пакетом обновления 2 (SP2), 2008 R2
* Все устройства с Windows 10 Корпоративная (с несколькими сеансами), и Профессиональная
* Windows 8 Корпоративная и Профессиональная
* Windows 7 с пакетом обновления 1 (SP1)

### <a name="minimum-requirements"></a>Минимальные требования

Ниже приведены минимальные требования для гибридной рабочей роли Runbook Windows.

* Windows PowerShell версии 5.1 или более поздней ([скачать WMF 5.1](https://www.microsoft.com/download/details.aspx?id=54616));
* .NET Framework 4.6.2 или более поздней версии.
* два ядра;
* 4 ГБ ОЗУ;
* Порт 443 (исходящий).

### <a name="network-configuration"></a>Конфигурация сети

Дополнительные требования к сети для гибридной рабочей роли Runbook см. в разделе [Настройка сети](automation-hybrid-runbook-worker.md#network-planning).

### <a name="adding-a-machine-to-a-hybrid-runbook-worker-group"></a>Добавление компьютера в группу гибридных рабочих ролей Runbook

Рабочий компьютер можно добавить в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации. Обратите внимание, что вам нужно обеспечить поддержку runbook службы автоматизации, если одна учетная запись одновременно используется для службы автоматизации Azure и принадлежит к группе гибридных рабочих ролей Runbook. Эта функция добавлена в версии 7.2.12024.0 гибридной рабочей роли Runbook.

>[!NOTE]
>Включение службы автоматизации Azure [Управление обновлениями](automation-update-management.md) автоматически настраивает любой компьютер Windows, подключенный к рабочей области log Analytics, как гибридную рабочую роль Runbook для поддержки управления обновлениями операционной системы. Но эта рабочая роль не регистрируется в группах гибридных рабочих ролей Runbook, которые уже определены в учетной записи службы автоматизации.

## <a name="enabling-machines-for-management-with-azure-automation-state-configuration"></a>Включение компьютеров для управления с помощью конфигурации состояния службы автоматизации Azure

Дополнительные сведения о включении компьютеров для управления с помощью конфигурации состояния службы автоматизации Azure см. в статье [Включение управления с помощью конфигурации состояния службы автоматизации Azure на компьютерах](automation-dsc-onboarding.md).

> [!NOTE]
> Для управления конфигурацией компьютеров, поддерживающих гибридную рабочую роль Runbook с настройкой требуемого состояния (DSC), необходимо добавить компьютеры в качестве узлов DSC.

## <a name="windows-hybrid-runbook-worker-installation-options"></a>Параметры установки гибридной рабочей роли Runbook Windows

Ниже описаны методы установки и настройки гибридной рабочей роли Runbook для Windows.

* Для виртуальных машин Azure установите агент Log Analytics для Windows с помощью [расширения виртуальной машины для Windows](../virtual-machines/extensions/oms-windows.md). Это расширение устанавливает агент Log Analytics на виртуальных машинах Azure и регистрирует виртуальные машины в существующей рабочей области Log Analytics с помощью шаблона Azure Resource Manager или PowerShell. После установки агента виртуальную машину можно добавить в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации.

* Для виртуальных машин, не относящихся к Azure, установите агент Log Analytics для Windows, используя параметры развертывания, описанные в статье [Подключение компьютеров Windows к Azure Monitor](../azure-monitor/platform/agent-windows.md) . Этот процесс можно повторить для нескольких компьютеров, чтобы добавить в среду несколько рабочих ролей. После установки агента виртуальные машины можно добавить в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации.

* Используйте предоставленный сценарий PowerShell, чтобы полностью [автоматизировать](#automated-deployment) процесс настройки одного или нескольких компьютеров с ОС Windows. Мы рекомендуем этот способ для компьютеров в центре обработки данных или в другой облачной среде.

## <a name="automated-deployment"></a>Автоматизированное развертывание

На целевом компьютере выполните следующие действия, чтобы автоматизировать установку и настройку роли гибридного рабочего процесса Windows с помощью скрипта PowerShell **New-OnPremiseHybridWorker.ps1**. Скрипт выполняет следующие задачи:

* Устанавливает необходимые модули
* Вход с использованием учетной записи Azure
* Проверка существования указанной группы ресурсов и учетной записи службы автоматизации
* Создает ссылки на атрибуты учетной записи службы автоматизации
* Создает рабочую область Log Analytics Azure Monitor, если не указано
* Включение решения службы автоматизации Azure в рабочей области
* Скачивание и установка агента Log Analytics для Windows
* Регистрация компьютера в качестве гибридной рабочей роли Runbook

### <a name="step-1---download-the-powershell-script"></a>Шаг 1. Скачайте скрипт PowerShell

Скачайте скрипт **New-OnPremiseHybridWorker.ps1** из [коллекции PowerShell](https://www.powershellgallery.com/packages/New-OnPremiseHybridWorker). После скачивания скрипта скопируйте или запустите его на целевом компьютере. Скрипт **New-OnPremiseHybridWorker.ps1** во время выполнения использует следующие параметры.

| Параметр | Состояние | Описание |
| --------- | ------ | ----------- |
| `AAResourceGroupName` | Обязательный | имя группы ресурсов, связанной с вашей учетной записью службы автоматизации. |
| `AutomationAccountName` | Обязательный | имя учетной записи службы автоматизации.
| `Credential` | Необязательно | Учетные данные для входа в среду Azure. |
| `HybridGroupName` | Обязательный | имя группы гибридных рабочих ролей Runbook, которую вы указываете в качестве целевой для модулей runbook, поддерживающих этот сценарий. |
| `OMSResourceGroupName` | Необязательно | имя группы ресурсов для рабочей области Log Analytics. Если эта группа ресурсов не указана, используется значение `AAResourceGroupName`. |
| `SubscriptionID` | Обязательный | Идентификатор подписки Azure, которая связана с учетной записью службы автоматизации. |
| `TenantID` | Необязательно | Идентификатор организации клиента, которая связана с учетной записью службы автоматизации. |
| `WorkspaceName` | Необязательно | Имя рабочей области Log Analytics. Если у вас нет рабочей области Log Analytics, сценарий создаст и настроит ее. |

> [!NOTE]
> При включении возможностей служба автоматизации Azure поддерживает связывание рабочей области Log Analytics и учетной записи службы автоматизации только в определенных регионах. Список поддерживаемых пар сопоставлений см. в статье о [сопоставлении региона для учетной записи службы автоматизации и рабочей области Log Analytics](how-to/region-mappings.md).

### <a name="step-2---open-windows-powershell-command-line-shell"></a>Шаг 2. Откройте оболочку командной строки Windows PowerShell

В **меню "Пуск** " выберите команду " **Пуск**", введите **PowerShell**, щелкните правой кнопкой мыши **Windows PowerShell**и выберите команду " **Запуск от имени администратора**".

### <a name="step-3---run-the-powershell-script"></a>Шаг 3. Выполните скрипт PowerShell

В оболочке командной строки PowerShell перейдите в папку, которая содержит скачанный ранее скрипт. Измените значения параметров `AutomationAccountName`, `AAResourceGroupName`, `OMSResourceGroupName`, `HybridGroupName`, `SubscriptionID` и `WorkspaceName`. Затем выполните сценарий.

После выполнения сценария вы увидите запрос на аутентификацию в Azure. Для входа нужно использовать учетную запись, которая является участником роли администраторов подписки и соадминистратором подписки.

```powershell-interactive
.\New-OnPremiseHybridWorker.ps1 -AutomationAccountName <nameOfAutomationAccount> -AAResourceGroupName <nameOfResourceGroup>`
-OMSResourceGroupName <nameOfOResourceGroup> -HybridGroupName <nameOfHRWGroup> `
-SubscriptionID <subscriptionId> -WorkspaceName <nameOfLogAnalyticsWorkspace>
```

### <a name="step-4---install-nuget"></a>Шаг 4. Установите NuGet

Вы получите предложение подтвердить установку пакета NuGet и указать учетные данные Azure для аутентификации. Если у вас нет последней версии NuGet, ее можно скачать из [доступных версий распространения NuGet](https://www.nuget.org/downloads).

### <a name="step-5---verify-the-deployment"></a>Шаг 5. Проверьте развертывание

После завершения скрипта на странице группы гибридных рабочих ролей в учетной записи службы автоматизации отобразится новая группа и число членов. Если указать имеющуюся группу, количество элементов в ней увеличивается. Вы можете выбрать группу из списка на странице "Группы гибридных рабочих ролей" и щелкнуть плитку **Гибридные рабочие роли**. На странице "Гибридные рабочие роли" отображается полный список членов группы.

## <a name="manual-deployment"></a>Развертывание вручную

Чтобы установить и настроить гибридную рабочую роль Runbook Windows, выполните следующие действия.

### <a name="step-1---verify-agent-is-reporting-to-workspace"></a>Шаг 1. Проверка того, что агент сообщает о рабочей области

Агент Log Analytics для Windows подключает компьютеры к рабочей области Log Analytics Azure Monitor. При установке агента на компьютере и подключении его к рабочей области автоматически загружаются компоненты, необходимые для работы гибридного рабочего процесса Runbook.

Подключение агента к рабочей области Log Analytics занимает несколько минут, и после этого вы можете выполнить следующий запрос и убедиться, что он отправляет данные пульса в рабочую область.

```kusto
Heartbeat 
| where Category == "Direct Agent"
| where TimeGenerated > ago(30m)
```

В результатах поиска должны отобразиться записи пульса для компьютера, указывающие, что он подключен и сообщает службе. По умолчанию каждый агент перенаправляет запись пульса в назначенную ему рабочую область. Выполните следующие шаги, чтобы завершить установку и настройку агента.

1. Включите возможность, чтобы добавить компьютер агента. Сведения о Управление обновлениями и виртуальных машинах Azure см. [в](automation-onboard-solutions-from-automation-account.md#enable-machines-in-the-workspace)разделе Включение [виртуальных машин Azure](automation-onboard-solutions-from-automation-account.md#enable-azure-vms)и для виртуальных машин, не относящихся к Azure. Сведения о Отслеживание изменений и виртуальных машинах Azure см. [в](automation-enable-changes-from-auto-acct.md#enable-machines-in-the-workspace)разделе Включение [виртуальных машин Azure](automation-enable-changes-from-auto-acct.md#enable-azure-vms)и для виртуальных машин, не относящихся к Azure.

2. Чтобы подтвердить версию гибридной рабочей роли Runbook, перейдите к `C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\` вложенной папке **версии** и запишите ее.

### <a name="step-3---install-the-runbook-environment-and-connect-to-azure-automation"></a>Шаг 3. Установка среды Runbook и подключение к службе автоматизации Azure

Когда вы настраиваете в агенте отправку данных в рабочую область Log Analytics, возможность службы автоматизации Azure отправляет на агент модуль PowerShell `HybridRegistration`, который содержит командлет `Add-HybridRunbookWorker`. Используйте этот командлет для установки среды Runbook на компьютере и его регистрации в службе автоматизации Azure.

Откройте сеанс PowerShell с правами администратора и импортируйте модуль, выполнив указанные ниже команды.

```powershell-interactive
cd "C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\<version>\HybridRegistration"
Import-Module .\HybridRegistration.psd1
```

Теперь выполните командлет `Add-HybridRunbookWorker`, используя следующий синтаксис.

```powershell-interactive
Add-HybridRunbookWorker –GroupName <String> -Url <Url> -Key <String>
```

Сведения, необходимые для параметров, можно получить на `Url` `Key` странице **ключи** в учетной записи службы автоматизации. Выберите **ключи** в разделе **Параметры учетной записи** в левой части страницы.

![Страница "Управление ключами"](media/automation-hybrid-runbook-worker/elements-panel-keys.png)

* Для `Url` параметра скопируйте значение для **URL-адреса**.

* Для `Key` параметра скопируйте значение для **первичного ключа доступа**.

* Для параметра `GroupName` укажите имя группы гибридных рабочих ролей Runbook. Если эта группа уже существует в учетной записи службы автоматизации, в нее добавляется текущий компьютер. Если эта группа не существует, она добавляется.

* При необходимости задайте параметр `Verbose`, чтобы получить сведения об установке.

### <a name="step-4----install-powershell-modules"></a>Шаг 4. Установка модулей PowerShell

Модули Runbook могут использовать любые из действий и командлетов, которые определены в модулях, установленных в вашей среде службы автоматизации Azure. Так как эти модули не развертываются автоматически на локальных компьютерах, их необходимо установить вручную. Исключением является модуль Azure. Этот модуль устанавливается по умолчанию и предоставляет доступ к командлетам для всех служб и действий службы автоматизации Azure.

Так как главной целью гибридной рабочей роли Runbook является управление локальными ресурсами, вам с большой вероятностью потребуются модули, которые поддерживают эти ресурсы (в частности, модуль `PowerShellGet`). Сведения об установке модулей Windows PowerShell см. в [этой статье](https://docs.microsoft.com/powershell/scripting/developer/windows-powershell).

Устанавливаемые модули должны находиться в расположении, указанном в переменной среды `PSModulePath`, чтобы гибридная рабочая роль автоматически импортировала их. Дополнительные сведения см. в разделе [Установка модулей в PSModulePath](https://docs.microsoft.com/powershell/scripting/developer/module/installing-a-powershell-module?view=powershell-7).

## <a name="remove-the-hybrid-runbook-worker-from-an-on-premises-windows-machine"></a><a name="remove-windows-hybrid-runbook-worker"></a>Удаление гибридной рабочей роли Runbook с локального компьютера Windows

1. На портале Azure перейдите в свою учетную запись в службе автоматизации.

2. В разделе **Параметры учетной записи** выберите **Ключи** и запишите значения **URL-адреса** и **первичного ключа доступа**.

3. Откройте сеанс PowerShell в режиме администратора и выполните следующую команду, указав значения URL-адреса и первичного ключа доступа. Используйте параметр `Verbose`, чтобы получить подробный журнал процесса удаления. Чтобы удалить устаревшие машины из группы гибридной рабочей роли, используйте необязательный параметр `machineName`.

```powershell-interactive
Remove-HybridRunbookWorker -Url <URL> -Key <primaryAccessKey> -MachineName <computerName>
```

## <a name="remove-a-hybrid-worker-group"></a>Удаление группы гибридных рабочих ролей

Чтобы удалить группу гибридных рабочих ролей Runbook, сначала необходимо удалить гибридную рабочую роль Runbook с каждого компьютера, который является членом группы. Затем выполните указанные ниже действия для удаления группы:

1. На портале Azure откройте учетную запись службы автоматизации.

2. В разделе **Автоматизация процессов** выберите **Группы гибридных рабочих ролей**. Выберите группу, которую нужно удалить. Откроется страница свойств этой группы.

   ![Страница свойств](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-group-properties.png)

3. На странице свойств выбранной группы выберите **Удалить**. Появится сообщение с запросом на подтверждение этого действия. Выберите **Да**, если хотите продолжить.

   ![Сообщение с подтверждением](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-confirm-delete.png)

   Для завершения процесса может потребоваться несколько секунд. Ход создания можно просмотреть в разделе **Уведомления** в меню.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде, см. статью [Запуск модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md).

* Дополнительные сведения см. в статье [Устранение неполадок с гибридными рабочими ролями Runbook](troubleshoot/hybrid-runbook-worker.md#general).
