---
title: Выходные данные и сообщения Runbook в службе автоматизации Azure
description: Описывает создание и извлечение выходных данных и сообщений об ошибках из модулей Runbook в службе автоматизации Azure.
services: automation
ms.subservice: process-automation
ms.date: 12/04/2018
ms.topic: conceptual
ms.openlocfilehash: 457b2d2211ea1ba5fa36cec4b7e9a214f5bcad77
ms.sourcegitcommit: 512d4d56660f37d5d4c896b2e9666ddcdbaf0c35
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2020
ms.locfileid: "79367097"
---
# <a name="runbook-output-and-messages-in-azure-automation"></a>Выходные данные и сообщения Runbook в службе автоматизации Azure

В большинстве модулей runbook в службе автоматизации Azure используются выходные данные определенного типа. Этим выходом может быть сообщение об ошибке для пользователя или сложный объект, предназначенный для использования с другим модулем Runbook. Windows PowerShell предоставляет [несколько потоков](/powershell/module/microsoft.powershell.core/about/about_redirection) для отправки выходных данных из сценария или рабочего процесса. Служба автоматизации Azure работает с каждым из этих потоков по-разному. При создании модуля Runbook следует следовать рекомендациям по использованию потоков.

В следующей таблице приводится краткое описание каждого потока с его поведением в портал Azure для опубликованных модулей Runbook и во время [тестирования модуля Runbook](automation-testing-runbook.md). Поток вывода — это основной поток, используемый для обмена данными между модулями Runbook. Другие потоки классифицируются как потоки сообщений, предназначенные для передачи информации пользователю. 

| STREAM | Description | Опубликован | Тест |
|:--- |:--- |:--- |:--- |
| Ошибка |Сообщение об ошибке, предназначенное для пользователя. В отличие от исключения, модуль Runbook по умолчанию продолжит выполнение после сообщения об ошибке. |Записано в журнал заданий |Отображается в области вывода теста |
| Отладка |Сообщения, предназначенные для интерактивного пользователя. Не следует использовать в модулях runbook. |Не записано в журнал заданий |Не отображается в области вывода теста |
| Выходные данные |Объекты, предназначенные для использования другими Runbook. |Записано в журнал заданий |Отображается в области вывода теста |
| Ход выполнения |До и после каждого действия в Runbook автоматически создаются записи. Модуль Runbook не должен пытаться создать собственные записи о ходе выполнения, так как они предназначены для интерактивного пользователя. |Записывается в журнал заданий только в том случае, если включено ведение журнала хода выполнения для модуля Runbook |Не отображается в области вывода теста |
| Подробный |Сообщения, содержащие общую или отладочную информацию. |Записывается в журнал заданий только в том случае, если для модуля Runbook включено подробное ведение журнала |Отображается в тестовой области вывода только в том случае, если для переменной `VerbosePreference` задано значение continue в Runbook |
| Предупреждение |Предупреждающее сообщение, предназначенное для пользователя. |Записано в журнал заданий |Отображается в области вывода теста |

>[!NOTE]
>Эта статья была изменена и теперь содержит сведения о новом модуле Az для Azure PowerShell. Вы по-прежнему можете использовать модуль AzureRM, исправления ошибок для которого будут продолжать выпускаться как минимум до декабря 2020 г. Дополнительные сведения о совместимости модуля Az с AzureRM см. в статье [Introducing the new Azure PowerShell Az module](https://docs.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-3.5.0) (Знакомство с новым модулем Az для Azure PowerShell). Инструкции по установке AZ Module в гибридной рабочей роли Runbook см. в статье [Установка модуля Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps?view=azps-3.5.0). Для учетной записи службы автоматизации можно обновить модули до последней версии, используя [обновление модулей Azure PowerShell в службе автоматизации Azure](automation-update-azure-modules.md).

## <a name="output-stream"></a>Поток вывода

Поток вывода используется для вывода объектов, созданных скриптом или рабочим процессом, когда он выполняется правильно. Служба автоматизации Azure в основном использует этот поток для использования объектами в родительских модулях Runbook, вызывающих [текущий модуль Runbook](automation-child-runbooks.md). Когда родительский объект [вызывает встроенную функцию модуля Runbook](automation-child-runbooks.md#invoking-a-child-runbook-using-inline-execution), дочерний элемент возвращает данные из выходного потока в родительский. 

Модуль Runbook использует поток вывода для передачи общих сведений клиенту, только если он никогда не вызывается другим модулем Runbook. Однако в большинстве случаев для обмена общими сведениями с пользователем модули Runbook обычно используют [подробный поток](#verbose-stream) .

Запишите данные Runbook в поток вывода с помощью [Write-Output](https://technet.microsoft.com/library/hh849921.aspx). Кроме того, можно разместить объект в отдельной строке скрипта.

```powershell
#The following lines both write an object to the output stream.
Write-Output –InputObject $object
$object
```

### <a name="handling-output-from-a-function"></a>Обработка выходных данных функции

Когда функция Runbook выполняет запись в поток вывода, выходные данные передаются обратно в модуль Runbook. Если модуль Runbook назначает выходные данные переменной, выходные данные не записываются в поток вывода. Запись в любые другие потоки из функции сопровождается записью в соответствующий поток для runbook. Рассмотрим следующий пример модуля Runbook рабочего процесса PowerShell.

```powershell
Workflow Test-Runbook
{
  Write-Verbose "Verbose outside of function" -Verbose
  Write-Output "Output outside of function"
  $functionOutput = Test-Function
  $functionOutput

  Function Test-Function
  {
    Write-Verbose "Verbose inside of function" -Verbose
    Write-Output "Output inside of function"
  }
}
```

Поток вывода для задания Runbook:

```output
Output inside of function
Output outside of function
```

Подробный поток для задания Runbook:

```output
Verbose outside of function
Verbose inside of function
```

После публикации модуля Runbook и перед его запуском необходимо также включить подробное ведение журнала в параметрах модуля Runbook, чтобы получить подробный поток вывода.

### <a name="declaring-output-data-type"></a>Объявление типа выходных данных

Ниже приведены примеры типов выходных данных.

* `System.String`
* `System.Int32`
* `System.Collections.Hashtable`
* `Microsoft.Azure.Commands.Compute.Models.PSVirtualMachine`

#### <a name="declare-output-data-type-in-a-workflow"></a>Объявление типа выходных данных в рабочем процессе

Рабочий процесс указывает тип выходных данных с помощью [атрибута OutputType](https://technet.microsoft.com/library/hh847785.aspx). Этот атрибут не оказывает влияния во время выполнения, но он предоставляет указание во время разработки ожидаемых выходных данных модуля Runbook. Так как набор средств для модулей Runbook продолжит развиваться, важность объявления типов выходных данных во время разработки увеличится. Поэтому рекомендуется включать это объявление во все создаваемые модули Runbook.

Следующий пример Runbook выводит строковый объект и включает в себя объявление типа выходных данных. Если Runbook выводит массив определенного типа, все равно следует указать его тип, а не массив типа.

```powershell
Workflow Test-Runbook
{
  [OutputType([string])]

  $output = "This is some string output."
  Write-Output $output
}
 ```

#### <a name="declare-output-data-type-in-a-graphical-runbook"></a>Объявление типа выходных данных в графическом модуле Runbook

Чтобы объявить выходной тип в графическом или графическом модуле Runbook рабочего процесса PowerShell, можно выбрать параметр меню **входы и выход** и ввести тип выхода. Рекомендуется использовать полное имя класса .NET, чтобы сделать тип легко идентифицируемым, когда родительский модуль Runbook ссылается на него. Использование полного имени предоставляет всем свойствам класса значение DataBus в модуле Runbook и повышает гибкость, когда свойства используются для условной логики, ведения журнала и ссылок в качестве значений для других действий Runbook.<br> ![Runbook: раздел "Входные и выходные данные"](media/automation-runbook-output-and-messages/runbook-menu-input-and-output-option.png)

>[!NOTE]
>После ввода значения в поле **тип выходных данных** в области Свойства входов и выходов обязательно щелкните за пределами элемента управления, чтобы он распознал вашу запись.

В следующем примере показаны два графических модуля Runbook для демонстрации функции ввода и вывода. Применяя модульную модель проектирования Runbook, у вас есть один модуль Runbook в качестве шаблона аутентификации Runbook, управляющий проверкой подлинности в Azure с помощью учетной записи запуска Второй модуль Runbook, который обычно выполняет базовую логику для автоматизации данного сценария, в этом случае выполняет шаблон проверки подлинности Runbook. Результаты отображаются в области выходных данных теста. В обычных условиях этот модуль runbook выполнял бы определенные действия в отношении ресурса, используя выходные данные дочернего модуля runbook.

Ниже представлена основная логика модуля Runbook **AuthenticateTo-Azure**.<br> ![Runbook: пример шаблона аутентификации](media/automation-runbook-output-and-messages/runbook-authentication-template.png).

Модуль Runbook включает тип выходных данных `Microsoft.Azure.Commands.Profile.Models.PSAzureContext`, который возвращает свойства профиля проверки подлинности.<br> ![Runbook: пример типа выходных данных](media/automation-runbook-output-and-messages/runbook-input-and-output-add-blade.png)

Хотя этот модуль Runbook достаточно прост, для его вызова существует один элемент конфигурации. Последнее действие выполняет командлет `Write-Output` для записи данных профиля в переменную с помощью выражения PowerShell для параметра `Inputobject`. Этот параметр является обязательным для `Write-Output`.

Второй модуль Runbook в этом примере с именем **Test-childoutputtype)** просто определяет два действия.<br> ![Runbook: пример типа выходных данных дочернего модуля](media/automation-runbook-output-and-messages/runbook-display-authentication-results-example.png)

Первое действие вызывает модуль Runbook **AuthenticateTo-Azure** . Второе действие запускает командлет `Write-Verbose` с **источником данных** , для которого заданы **выходные данные действия**. Кроме того, **путь к полю** устанавливается в **контекст. Subscription. SubscriptionName**, выходные данные контекста из модуля Runbook **AuthenticateTo-Azure** .<br> ![](media/automation-runbook-output-and-messages/runbook-write-verbose-parameters-config.png) источника данных параметра командлета Write-Verbose

Результат — имя подписки.<br> ![Runbook: результаты командлета Test-ChildOutputType](media/automation-runbook-output-and-messages/runbook-test-childoutputtype-results.png)

## <a name="message-streams"></a>Потоки сообщений

В отличие от потока вывода, потоки сообщений обмениваются данными с пользователем. Существует несколько потоков сообщений для различных типов данных, и служба автоматизации Azure обрабатывает каждый поток по-разному.

### <a name="warning-and-error-streams"></a>Потоки предупреждений и ошибок

Предупреждения и ошибки переводят в журнал проблемы, возникающие в модуле Runbook. Служба автоматизации Azure записывает эти потоки в журнал заданий при выполнении модуля Runbook. Автоматизация включает потоки в тестовую область вывода в портал Azure при тестировании модуля Runbook. 

По умолчанию модуль Runbook продолжит выполнение после предупреждения или ошибки. Вы можете указать, что модуль Runbook должен приостановиться в случае предупреждения или ошибки, установив [переменную предпочтения](#preference-variables) перед созданием сообщения. Например, чтобы остановить выполнение модуля Runbook при возникновении ошибки, как это происходит при возникновении исключения, задайте для переменной `ErrorActionPreference` значение остановка.

Создайте предупреждение или сообщение об ошибке с помощью командлета [Write-Warning](https://technet.microsoft.com/library/hh849931.aspx) или [Write-Error](https://technet.microsoft.com/library/hh849962.aspx). Действия также могут записывать в потоки предупреждений и ошибок.

```powershell
#The following lines create a warning message and then an error message that will suspend the runbook.

$ErrorActionPreference = "Stop"
Write-Warning –Message "This is a warning message."
Write-Error –Message "This is an error message that will stop the runbook because of the preference variable."
```

### <a name="debug-stream"></a>Поток отладки

Служба автоматизации Azure использует поток сообщений отладки для интерактивных пользователей. Его не следует использовать в модулях Runbook.

### <a name="verbose-stream"></a>Подробный поток

Поток подробных сообщений поддерживает общие сведения об операциях Runbook. Поскольку поток отладки недоступен для модуля Runbook, модуль Runbook должен использовать подробные сообщения для отладочной информации. 

По умолчанию в журнале заданий не хранятся подробные сообщения от опубликованных модулей Runbook по соображениям производительности. Чтобы хранить подробные сообщения, используйте вкладку **настройка** портал Azure с параметром **подробные записи журнала** , чтобы настроить опубликованные модули Runbook для записи подробных сообщений в журнал. Включайте этот параметр только для устранения неполадок и отладки Runbook. В большинстве случаев следует использовать параметр по умолчанию не вести журнал подробных записей.

При [тестировании модуля runbook](automation-testing-runbook.md) подробные сообщения не отображаются, даже если для runbook настроено добавление подробных записей в журнал. Чтобы отобразить подробные сообщения при [тестировании модуля Runbook](automation-testing-runbook.md), необходимо задать для переменной `VerbosePreference` значение Continue. Если эта переменная задана, подробные сообщения отображаются в области вывода теста портал Azure.

Следующий код создает подробное сообщение с помощью командлета [Write-Verbose](https://technet.microsoft.com/library/hh849951.aspx) .

```powershell
#The following line creates a verbose message.

Write-Verbose –Message "This is a verbose message."
```

## <a name="progress-records"></a>Записи о ходе выполнения

Можно использовать вкладку **настройка** портал Azure, чтобы настроить Runbook для ведения журнала хода выполнения. Значение по умолчанию — не записывать записи в журнал, чтобы повысить производительность. В большинстве случаев следует использовать параметр по умолчанию. Включайте этот параметр только для устранения неполадок и отладки Runbook. 

Если включить ведение журнала записи о ходе выполнения, модуль Runbook записывает запись в журнал заданий до и после выполнения каждого действия. Тестирование модуля Runbook не отображает сообщения о ходе выполнения, даже если в модуле Runbook настроено ведение журнала записей о ходе выполнения.

>[!NOTE]
>Командлет [Write-Progress](https://technet.microsoft.com/library/hh849902.aspx) недействителен в runbook, так как предназначен для использования интерактивным пользователем.

## <a name="preference-variables"></a>Привилегированные переменные

Вы можете задать определенные [переменные предпочтений](https://technet.microsoft.com/library/hh847796.aspx) Windows PowerShell в модулях Runbook, чтобы управлять ответами на данные, отправляемые в различные выходные потоки. В следующей таблице перечислены привилегированные переменные, которые можно использовать в модулях Runbook с их значениями по умолчанию и допустимыми. Дополнительные значения для привилегированных переменных доступны при использовании в Windows PowerShell за пределами службы автоматизации Azure.

| Переменная | Значение по умолчанию | Допустимые значения |
|:--- |:--- |:--- |
| `WarningPreference` |Continue |Остановить<br>Continue<br>SilentlyContinue |
| `ErrorActionPreference` |Continue |Остановить<br>Continue<br>SilentlyContinue |
| `VerbosePreference` |SilentlyContinue |Остановить<br>Continue<br>SilentlyContinue |

В следующей таблице приводится описание поведения для значений привилегированных переменных, допустимых в модулях Runbook.

| Значение | Поведение |
|:--- |:--- |
| Continue |Записывает сообщение в журнал и продолжает выполнение Runbook. |
| SilentlyContinue |Продолжает выполнение Runbook без добавления сообщения в журнал. При таком значении сообщение игнорируется. |
| Остановить |Записывает сообщение в журнал и приостанавливает выполнение Runbook. |

## <a name="runbook-output"></a>Извлечение выходных данных и сообщений runbook

### <a name="retrieve-runbook-output-and-messages-in-azure-portal"></a>Получение выходных данных и сообщений Runbook в портал Azure

Сведения о задании Runbook можно просмотреть в портал Azure с помощью вкладки **задания** для модуля Runbook. В сводке задания отображаются входные параметры и [выходной поток](#output-stream), а также общие сведения о задании и произошедших исключениях. Журнал заданий включает сообщения из потока вывода, а также [потоки предупреждений и ошибок](#warning-and-error-streams). Он также включает сообщения из [подробного потока](#verbose-stream) и [записи о ходе выполнения](#progress-records) , если в модуле Runbook настроено ведение журнала подробных записей и сведений о ходе выполнения.

### <a name="retrieve-runbook-output-and-messages-in-windows-powershell"></a>Получение выходных данных и сообщений Runbook в Windows PowerShell

В Windows PowerShell можно получить выходные данные и сообщения из модуля Runbook с помощью командлета [Get-азаутоматионжобаутпут](https://docs.microsoft.com/powershell/module/Az.Automation/Get-AzAutomationJobOutput?view=azps-3.5.0) . Этот командлет требует идентификатор задания и имеет параметр с именем `Stream`, в котором указывается получаемый поток. Можно указать значение Any для этого параметра, чтобы получить все потоки для задания.

В следующем примере запускается пример Runbook и ожидается его завершение. После завершения выполнения модуля Runbook сценарий собирает выходной поток Runbook из задания.

```powershell
$job = Start-AzAutomationRunbook -ResourceGroupName "ResourceGroup01" `
  –AutomationAccountName "MyAutomationAccount" –Name "Test-Runbook"

$doLoop = $true
While ($doLoop) {
  $job = Get-AzAutomationJob -ResourceGroupName "ResourceGroup01" `
    –AutomationAccountName "MyAutomationAccount" -Id $job.JobId
  $status = $job.Status
  $doLoop = (($status -ne "Completed") -and ($status -ne "Failed") -and ($status -ne "Suspended") -and ($status -ne "Stopped"))
}

Get-AzAutomationJobOutput -ResourceGroupName "ResourceGroup01" `
  –AutomationAccountName "MyAutomationAccount" -Id $job.JobId –Stream Output

# For more detailed job output, pipe the output of Get-AzAutomationJobOutput to Get-AzAutomationJobOutputRecord
Get-AzAutomationJobOutput -ResourceGroupName "ResourceGroup01" `
  –AutomationAccountName "MyAutomationAccount" -Id $job.JobId –Stream Any | Get-AzAutomationJobOutputRecord
```

### <a name="retrieve-runbook-output-and-messages-in-graphical-runbooks"></a>Получение выходных данных и сообщений Runbook в графических модулях Runbook

Для графических модулей Runbook дополнительные журналы вывода и сообщений доступны в форме трассировки на уровне действий. Существует два уровня трассировки: базовая и подробная. Базовая Трассировка отображает время начала и окончания для каждого действия в модуле Runbook, а также сведения, связанные с повторными попытками. Некоторые примеры — количество попыток и время начала действия. Подробная трассировка включает основные функции трассировки, а также ведение журнала входных и выходных данных для каждого действия. 

В настоящее время трассировка на уровне действий записывает записи с помощью подробного потока. Поэтому при включении трассировки необходимо включить подробное ведение журнала. Для графических модулей runbook с включенной трассировкой вести записи о ходе выполнения не требуется. Базовая трассировка не только решает эту задачу, но и является более информативной.

![Представление потоков заданий графической разработки](media/automation-runbook-output-and-messages/job-streams-view-blade.png)

Из образа, который включает подробное ведение журнала и трассировку для графических модулей Runbook, можно получить гораздо больше информации, доступной в представлении **потоков рабочего задания** . Эти дополнительные сведения могут быть необходимы для устранения проблем с рабочими модулями Runbook. 

Однако, если эти сведения не требуются для отслеживания хода выполнения модуля Runbook для устранения неполадок, может потребоваться отключить трассировку как правило. Записи трассировки могут быть особенно многочисленными. С помощью графической трассировки Runbook можно получить от двух до четырех записей на действие в зависимости от конфигурации базовой или подробной трассировки.

**Чтобы включить трассировку на уровне действий, выполните следующие действия.**

1. На портале Azure выберите свою учетную запись службы автоматизации.
2. Выберите **модули Runbook** в разделе **Автоматизация процессов** , чтобы открыть список модулей Runbook.
3. На странице модули Runbook выберите графический модуль Runbook из списка модулей Runbook.
4. В разделе **Параметры** щелкните **Ведение журналов и трассировка**.
5. На странице Ведение журнала и трассировка в разделе запись **подробных сведений в журнал**щелкните **вкл** ., чтобы включить запись подробных сведений в журнал.
6. В разделе **Трассировка на уровне действия**измените уровень трассировки на **базовый** или **подробный**в зависимости от требуемого уровня трассировки.<br>

   ![Страница ведения журналов и трассировки графической разработки](media/automation-runbook-output-and-messages/logging-and-tracing-settings-blade.png)

### <a name="retrieve-runbook-output-and-messages-in-microsoft-azure-monitor-logs"></a>Получение выходных данных и сообщений Runbook в журналах Microsoft Azure монитора

Служба автоматизации Azure может передавать состояние задания Runbook и потоки заданий в рабочую область Log Analytics. Azure Monitor поддерживает журналы, которые позволяют:

* получить информацию о заданиях службы автоматизации;
* Активируйте сообщение электронной почты или оповещение на основе состояния задания Runbook, например "сбой" или "приостановлено".
* Создание расширенных запросов между потоками заданий.
* коррелировать задания и учетные записи службы автоматизации;
* Визуализировать журнал заданий.

Дополнительные сведения о настройке интеграции с журналами Azure Monitor для получения, сопоставления и работы с данными заданий см. в разделе [Пересылка состояния задания и потоков заданий из службы автоматизации в журналы Azure Monitor](automation-manage-send-joblogs-log-analytics.md).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о выполнении модулей Runbook, наблюдении за заданиями Runbook и другие технические сведения см. в разделе [Отслеживание задания Runbook](automation-runbook-execution.md).
* Сведения о проектировании и использовании дочерних модулей Runbook см. [в разделе дочерние модули Runbook в службе автоматизации Azure](automation-child-runbooks.md).
* Дополнительные сведения о PowerShell, включая Справочник по языку и обучающие модули, см. в документации по [PowerShell](/powershell/scripting/overview).
