---
title: Непрерывное развертывание состояния Azure Automation State с помощью Chocolatey
description: Описывает непрерывное развертывание DevOps с помощью конфигурации состояния Azure Automation с помощью менеджера пакетов Chocolatey. Включает в себя пример с полным шаблоном менеджера ресурсов JSON и источником PowerShell.
services: automation
ms.subservice: dsc
ms.date: 08/08/2018
ms.topic: conceptual
ms.openlocfilehash: 79eaac74fd4475a613c0309476a12292e400dbaa
ms.sourcegitcommit: ae3d707f1fe68ba5d7d206be1ca82958f12751e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/10/2020
ms.locfileid: "81010976"
---
# <a name="provide-continuous-deployment-to-virtual-machines-using-automation-state-configuration-and-chocolatey"></a>Обеспечить непрерывное развертывание виртуальных машин с использованием конфигурации состояния автоматизации и шоколадной

В мире DevOps существует множество инструментов для оказания помощи различным точкам непрерывной интеграции. [Конфигурация состояния](automation-dsc-overview.md) автоматизации Azure — это новое дополнение к опциям, которые могут использовать команды DevOps. 

Azure Automation — это управляемая служба microsoft Azure, которая позволяет автоматизировать различные задачи с помощью runbooks, узлов и общих ресурсов, таких как учетные данные, расписание и глобальные переменные. Конфигурация состояния автоматизации Azure расширяет эту возможность автоматизации, включив в нее инструменты PowerShell Desired State Configuration (DSC). Вот прекрасный [обзор](automation-dsc-overview.md) на эту тему.

В этой статье показано, как настроить непрерывное развертывание (CD) для компьютера Windows. Вы можете легко расширить технику, чтобы включить как можно больше компьютеров Windows, как это необходимо в роли, например, веб-сайт, и перейти оттуда к дополнительным ролям.

![Непрерывное развертывание для виртуальных машин IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

>[!NOTE]
>Эта статья была изменена и теперь содержит сведения о новом модуле Az для Azure PowerShell. Вы по-прежнему можете использовать модуль AzureRM, исправления ошибок для которого будут продолжать выпускаться как минимум до декабря 2020 г. Дополнительные сведения о совместимости модуля Az с AzureRM см. в статье [Introducing the new Azure PowerShell Az module](https://docs.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-3.5.0) (Знакомство с новым модулем Az для Azure PowerShell). Для инструкций по установке модуля Az на гибридном Runbook Worker [см.](https://docs.microsoft.com/powershell/azure/install-az-ps?view=azps-3.5.0) Для учетной записи Автоматизация вы можете обновить свои модули до последней версии, используя [как обновить модули Azure PowerShell в Azure Automation.](automation-update-azure-modules.md)

## <a name="at-a-high-level"></a>На высоком уровне

Там довольно много происходит здесь, но, к счастью, он может быть разбит на два основных процесса:

- написание и тестирование кода, после чего следуют создание и публикация пакетов установки для основной и вспомогательной версий системы;
- Создание и управление ввозами, которые устанавливают и выполняют код в пакетах.  

После того, как оба этих основных процесса на месте, легко автоматически обновлять пакет на ваших VMs по мере создания и развертывания новых версий.

## <a name="component-overview"></a>Обзор компонентов

Менеджеры пакетов, такие как [apt-get,](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) хорошо известны в мире Linux, но не так много в мире Windows.
[Chocolatey](https://chocolatey.org/) такая вещь, и Скотт Hanselman [в блоге](https://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) на эту тему является большим введением. В двух словах, Chocolatey позволяет использовать командную строку для установки пакетов из центрального репозитория на операционную систему Windows. Вы можете создать собственный репозиторий и управлять им, а Chocolatey будет устанавливать пакеты из любого указанного вами количества репозиториев.

[PowerShell DSC](/powershell/scripting/dsc/overview/overview)) это инструмент PowerShell, который позволяет объявить конфигурацию, которую вы хотите для машины. Например, если вы хотите, чтобы Шоколадная установка, IIS установлен, порт 80 открыт, и версия 1.0.0 вашего веб-сайта установлен, DSC Локальный менеджер конфигурации (LCM) реализует эту конфигурацию. Сервер DSC pull содержит репозиторий конфигураций для ваших машин. Локальный диспетчер конфигураций на каждом компьютере периодически проверяет, совпадает ли его конфигурация с сохраненной конфигурацией. Он либо сообщает о состоянии, либо пытается привести компьютер в соответствие с сохраненной конфигурацией. Сохраненную конфигурацию на опрашивающем сервере можно изменить, чтобы привести компьютер или набор компьютеров в соответствие с измененной конфигурацией.

Ресурс DSC — это модуль кода с определенными возможностями, такими как управление сетью, Active Directory или Сервер S'L. Ресурс DSC Chocolatey может получать доступ к серверу NuGet, загружать и устанавливать пакеты и т. д. Имеется также множество других ресурсов DSC, доступных в [коллекции PowerShell](https://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).
Эти модули установлены на опрашивающем сервере "Настройка состояния службы автоматизации Azure" (вручную), поэтому их можно использовать в ваших конфигурациях.

Шаблоны Resource Manager обеспечивают декларативный способ генерации инфраструктуры, например, сетей, подсетей, сетевой безопасности и реукторов, балансеров нагрузки, NICs, VMs и так далее. Вот [статья,](../azure-resource-manager/management/deployment-models.md) которая сравнивает модель развертывания диспетчера ресурсов (декларативная) с моделью управления службой Azure (ASM или классическая) модель развертывания (императив). Эта статья включает в себя обсуждение основных поставщиков ресурсов: вычисления, хранения и сети.

Одной из ключевых особенностей шаблона Resource Manager является его способность устанавливать расширение VM в VM по мере его подготовки. Расширение VM имеет определенные возможности, такие как запуск пользовательского скрипта, установка антивирусного программного обеспечения и запуск сценария конфигурации DSC. Существует много других типов расширений VM.

## <a name="quick-trip-around-the-diagram"></a>Краткий обзор схемы

Начиная с самого верха, вы пишете свой код, строите его, тестируете его, а затем создаете пакет установки. Chocolatey может обрабатывать пакеты установки различных типов, например MSI, MSU и ZIP. И у вас есть полная мощность PowerShell, чтобы сделать фактическую установку, если родные возможности Chocolatey не до него. Поместите пакет в какое-то место, достижимое - хранилище пакетов. Он может располагаться где угодно. Например, в этом примере используется общая папка в учетной записи хранилища больших двоичных объектов Azure. Chocolatey работает непосредственно с серверами NuGet и некоторыми другими серверами в рамках управления метаданными пакета. Возможные варианты описаны в [этой статье](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed). В этом примере используется NuGet. Nuspec — это метаданные о пакетах. Nuspec 'являются "компилированы" в NuPkg и хранятся в сервере NuGet. Когда конфигурация запрашивает пакет по имени и ссылается на сервер NuGet, ресурс Chocolatey DSC на VM захватывает пакет и устанавливает его для вас. Можно также запросить определенную версию пакета.

В левом нижнем углу изображения есть шаблон управления ресурсами Azure. В этом примере использования расширение VM регистрирует VM с сервером Azure Automation State Configuration в качестве узла. Конфигурация хранится на опрашивающем сервере.
На самом деле, он хранится дважды: один раз, как простой текст и один раз компилируется как файл MOF. На портале Azure MOF является «конфигурацией узлов» (в отличие от просто «конфигурации»). Это артефакт, связанный с узлам, чтобы узла знала его конфигурацию. Ниже объясняется, как назначить узлу конфигурацию узла.

Создание nuspec, компиляция и хранение на сервере NuGet — это мелочь. Кроме того, вы уже управляете виртуальными машинами. 

Для непрерывного развертывания требуется один раз настройка сервера вытягивания, регистрация узлов с ним (один раз) и создание и хранение первоначальной конфигурации. Затем, когда пакеты обновляются и развертываются в репозитории, необходимо обновить только конфигурацию и конфигурацию узлов на сервере притяжения по мере необходимости. 

Если вы не начинаете с шаблона «Менеджер ресурсов», это нормально. Есть PowerShell, чтобы помочь вам зарегистрировать ваши VMs с тянучить сервер и все остальное. Для получения дополнительной информации смотрите эту статью: [Бортовые машины для управления Azure Automation State Configuration](automation-dsc-onboarding.md).

## <a name="about-the-usage-example"></a>О примере использования

Пример использования в этой статье начинается с VM из общего изображения Windows Server 2012 R2 из галереи Azure. Ее можно запустить из любого сохраненного образа, а затем настроить, используя конфигурацию DSC.
Однако изменение конфигурации, встроенной в образ, требует гораздо больше усилий, чем динамическое обновление конфигурации с помощью DSC.

Для использования этого метода на виртуальных машинах не обязательно использовать шаблон Resource Manager и расширение VM. Кроме того, виртуальные машины, на которых должно выполняться непрерывное развертывание, не обязательно должны размещаться в Azure. На виртуальной машине достаточно установить Chocolatey и настроить локальный диспетчер конфигураций, чтобы указать для нее расположение опрашивающего сервера.

При обновлении пакета на VM, который находится в производстве, необходимо принять, что VM из вращения в то время как обновление установлено. Это можно сделать разными способами. Например, на виртуальной машине, которая находится под контролем балансировщика нагрузки Azure, можно добавить настраиваемый зонд. При обновлении виртуальной машины конечная точка зонда должна возвращать значение 400. Настройка, необходимая для этого изменения, может содержаться в вашей конфигурации, и после завершения обновления вы сможете снова переключиться на возвращение значения 200.

Полный исходный код для этого примера хранится в [этом проекте Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) на сайте GitHub.

## <a name="step-1-set-up-the-pull-server-and-automation-account"></a>Шаг 1: Настройка сервера вытягивания и учетная запись автоматизации

В командной строке PowerShell с аутентификацией (`Connect-AzAccount`) выполните следующую команду (настройка опрашивающего сервера может занять несколько минут).

```azurepowershell-interactive
New-AzResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
New-AzAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT
```

Вы можете поместить свой аккаунт автоматизации в любой из следующих регионов (также известный как места): Восточная ЧАСТЬ США 2, южная центральная часть США, США Gov Вирджиния, Западная Европа, юго-восточная Азия, Япония Восток, Центральная Индия и Австралия юго-восток, Канада Центральной, Северной Европы.

## <a name="step-2-make-vm-extension-tweaks-to-the-resource-manager-template"></a>Шаг 2: Сделать VM расширение настроек для шаблона менеджер ресурсов

Сведения о регистрации виртуальных машин (с помощью расширения VM PowerShell DSC) можно найти в этом [кратком руководстве по шаблонам Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).
На этом шаге новая виртуальная машина регистрируется на опрашивающем сервере в списке узлов State Configuration. В рамках этой регистрации указывается конфигурация узла, применяемая к узлу. Эта конфигурация узла еще не должна существовать на сервере вытягивания, так что это хорошо, что шаг 4, где это делается в первый раз. Однако на данном шаге 2 нужно принять решение об имени узла и имени конфигурации. В этом примере использования узел называется isvbox, а конфигурация — ISVBoxConfig. Поэтому имя конфигурации узла (указываемое в DeploymentTemplate.json) имеет значение ISVBoxConfig.isvbox.

## <a name="step-3-add-required-dsc-resources-to-the-pull-server"></a>Шаг 3: Добавление необходимых ресурсов DSC на сервер pull

Коллекция PowerShell содержит средства для установки ресурсов DSC в учетной записи службы автоматизации Azure.
Перейдите к нужному ресурсу и нажмите кнопку «Развертывание в Azure Automation».

![Пример из коллекции PowerShell](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

Другой метод, недавно добавленный на портал Azure, позволяет использовать новые модули или обновлять существующие модули. Нажмите на ресурс учетной записи Automation, плитку активов и, наконец, плитку модулей. Значок Browse Gallery позволяет увидеть список модулей в галерее, просверлить детали и в конечном итоге импортировать в свой аккаунт Автоматизации. Это отличный способ периодически обновлять модули. Кроме того, во время импорта проверяется наличие зависимостей от других модулей, чтобы обеспечить полную синхронизацию.

Вы также можете сделать это вручную. Структура папок модуля интеграции PowerShell для компьютеров Windows немного отличается от структуры папок, ожидаемой службой автоматизации Azure.
Некоторые параметры вам придется настроить самостоятельно. Но это не трудно, и это делается только один раз на ресурс (если вы не хотите обновить его в будущем.) Для получения дополнительной информации об авторстве интеграционных модулей PowerShell см. [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)

- Установите модуль, необходимый на рабочей станции, следующим образом:
  - Установите [Windows Management Framework 5](https://aka.ms/wmf5latest) (не требуется для Windows 10).
  - `Install-Module –Name MODULE-NAME` <— извлекает модуль из коллекции PowerShell.
- Скопируйте папку модуля из `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` во временную папку.
- Удалите примеры и документацию из основной папки.
- Упакуйте основную папку, присвоив ZIP-файлу такое же имя, как у папки. 
- Поместите ZIP-файл в легкодоступное расположение HTTP, например хранилище BLOB-объектов в учетной записи службы хранилища Azure.
- Выполните эту команду PowerShell:

  ```powershell
  New-AzAutomationModule `
    -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -Name MODULE-NAME –ContentLink 'https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip'
  ```

Включенный пример реализует эти шаги для cChoco и xNetworking. 

## <a name="step-4-add-the-node-configuration-to-the-pull-server"></a>Шаг 4: Добавьте конфигурацию узла на сервер вытягивания

В первоначальном импорте конфигурации на опрашивающий сервер и ее компиляции нет ничего особенного. Все более поздние импорты или компиляции одной и той же конфигурации выглядят точно так же. Каждый раз, когда вам нужно обновить пакет и передать его в рабочую среду, выполняйте этот шаг, предварительно проверив правильность файла конфигурации (включая новую версию пакета). Вот файл конфигурации и команда PowerShell:

ISVBoxConfig.ps1:

```powershell
Configuration ISVBoxConfig
{
    Import-DscResource -ModuleName cChoco
    Import-DscResource -ModuleName xNetworking

    Node 'isvbox' {

        cChocoInstaller installChoco
        {
            InstallDir = 'C:\choco'
        }

        WindowsFeature installIIS
        {
            Ensure = 'Present'
            Name   = 'Web-Server'
        }

        xFirewall WebFirewallRule
        {
            Direction    = 'Inbound'
            Name         = 'Web-Server-TCP-In'
            DisplayName  = 'Web Server (TCP-In)'
            Description  = 'IIS allow incoming web site traffic.'
            Enabled       = 'True'
            Action       = 'Allow'
            Protocol     = 'TCP'
            LocalPort    = '80'
            Ensure       = 'Present'
        }

        cChocoPackageInstaller trivialWeb
        {
            Name      = 'trivialweb'
            Version   = '1.0.0'
            Source    = 'MY-NUGET-V2-SERVER-ADDRESS'
            DependsOn = '[cChocoInstaller]installChoco','[WindowsFeature]installIIS'
        }
    }
}
```

New-ConfigurationScript.ps1 (изменен для использования модуля Az):

```powershell
Import-AzAutomationDscConfiguration `
    -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 `
    -Published –Force

$jobData = Start-AzAutomationDscCompilationJob `
    -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -ConfigurationName ISVBoxConfig

$compilationJobId = $jobData.Id

Get-AzAutomationDscCompilationJob `
    -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -Id $compilationJobId
```

Эти шаги приводят к тому, что на сервере притяжения помещается новая конфигурация узлов под названием "ISVBoxConfig.isvbox". Имя конфигурации узла построено как "configurationName.nodeName".

## <a name="step-5-create-and-maintain-package-metadata"></a>Шаг 5: Создание и обслуживание метаданных пакетов

Для описания каждого пакета, который помещается в репозиторий пакетов, необходимы метаданные Nuspec.
Эти метаданные Nuspec следует компилировать и хранить на сервере NuGet. Этот процесс описан [здесь](https://docs.nuget.org/create/creating-and-publishing-a-package). В качестве сервера NuGet можно использовать сайт MyGet.org. Это платная служба, но начальные единицы хранения предоставляются бесплатно. В NuGet.org вы найдете инструкции по установке собственного сервера NuGet для ваших частных пакетов.

## <a name="step-6-tie-it-all-together"></a>Шаг 6: Свяжите все это вместе

Каждый раз, когда версия проходит qA и утверждается для развертывания, пакет создается, и nuspec и nupkg обновляются и развертываются на сервере NuGet. Конфигурация (Шаг 4 выше) также должна быть обновлена, чтобы согласиться с новым номером версии. Затем он должен быть отправлен на сервер вытягивания и компилирован.

С этого момента именно виртуальные машины, зависящие от этой конфигурации, отвечают за получение обновления и его установку. Каждое из этих обновлений просто - просто линия или два PowerShell. Для Azure DevOps некоторые из них инкапсулированы в задачах сборки, которые могут быть прикованы друг к другу в сборке. Дополнительные сведения см. в [этой статье](https://www.visualstudio.com/docs/alm-devops-feature-index#continuous-delivery). Это [репо GitHub](https://github.com/Microsoft/vso-agent-tasks) детализирует доступные задачи сборки.

## <a name="related-articles"></a>Связанные статьи
* [Обзор DSC службы автоматизации Azure](automation-dsc-overview.md)
* [Командлеты Automation DSC Azure](https://docs.microsoft.com/powershell/module/azurerm.automation#automation)
* [Подключение компьютеров для управления с помощью Azure Automation DSC](automation-dsc-onboarding.md)

## <a name="next-steps"></a>Следующие шаги

- Общие сведения см. в статье с [обзором "Настройка состояния службы автоматизации Azure"](automation-dsc-overview.md).
- Чтобы приступить к работе со службой "Настройка состояния службы автоматизации Azure", см. сведения в [этой статье](automation-dsc-getting-started.md).
- Сведения о компилировании конфигураций DSC, которые затем можно назначить целевым узлам, см. в статье [Компилирование конфигураций в Azure Automation DSC](automation-dsc-compile.md).
- Справочник по командлетам PowerShell для службы "Настройка состояния службы автоматизации Azure" см. в [этой статье](/powershell/module/azurerm.automation/#automation).
- Сведения о ценах см. на странице [с ценами на службу "Настройка состояния службы автоматизации Azure"](https://azure.microsoft.com/pricing/details/automation/).
- Пример использования службы "Настройка состояния службы автоматизации Azure" и Chocolatey в конвейере непрерывного развертывания см. в [этой статье](automation-dsc-cd-chocolatey.md).
