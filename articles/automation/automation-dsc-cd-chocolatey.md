---
title: Непрерывное развертывание конфигурации состояния службы автоматизации Azure с шоколадным
description: Описывает непрерывное развертывание DevOps с помощью конфигурации состояния службы автоматизации Azure с помощью диспетчера пакетов шоколадного развертывания. Содержит пример с полным шаблоном диспетчер ресурсов JSON и исходным кодом PowerShell.
services: automation
ms.subservice: dsc
ms.date: 08/08/2018
ms.topic: conceptual
ms.openlocfilehash: 278c6ee05fdf78cbfa8653381b65233fbb513593
ms.sourcegitcommit: 309a9d26f94ab775673fd4c9a0ffc6caa571f598
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/09/2020
ms.locfileid: "82996127"
---
# <a name="provide-continuous-deployment-to-virtual-machines-using-automation-state-configuration-and-chocolatey"></a>Обеспечение непрерывного развертывания на виртуальных машинах с помощью настройки состояния автоматизации и шоколадного

В DevOps мире существует множество средств для помощи в различных точках конвейера непрерывной интеграции. [Настройка состояния](automation-dsc-overview.md) службы автоматизации Azure — это новое дополнение к параметрам, которые могут быть DevOps командами. 

Служба автоматизации Azure представляет собой управляемую службу в Microsoft Azure, которая позволяет автоматизировать различные задачи с помощью модулей Runbook, узлов и общих ресурсов, таких как учетные данные, расписания и глобальные переменные. Конфигурация состояния службы автоматизации Azure расширяет возможности автоматизации, включая средства настройки требуемого состояния PowerShell (DSC). Вот прекрасный [обзор](automation-dsc-overview.md) на эту тему.

В этой статье показано, как настроить непрерывное развертывание (CD) для компьютера Windows. Можно легко расширить прием, включив в роль столько компьютеров Windows, сколько необходимо для роли, например веб-сайта, и перейдем к дополнительным ролям.

![Непрерывное развертывание для виртуальных машин IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## <a name="at-a-high-level"></a>На высоком уровне

Здесь происходит довольно много, но, к счастью, можно разбить на два основных процесса:

- написание и тестирование кода, после чего следуют создание и публикация пакетов установки для основной и вспомогательной версий системы;
- Создание виртуальных машин и управление ими, которые устанавливают и выполняют код в пакетах.  

После того как выполняются оба этих основных процесса, можно легко автоматически обновить пакет на виртуальных машинах по мере создания и развертывания новых версий.

## <a name="component-overview"></a>Обзор компонентов

Диспетчеры пакетов, такие как [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) , хорошо известны в мире Linux, но не настолько много в мире Windows.
[Это очень](https://chocolatey.org/) интересно, а [блог](https://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) Скотта Hanselman, посвященный теме, представляет собой отличное введение. В двух словах, шоколад позволяет использовать командную строку для установки пакетов из центрального репозитория в операционную систему Windows. Вы можете создать собственный репозиторий и управлять им, а Chocolatey будет устанавливать пакеты из любого указанного вами количества репозиториев.

[POWERSHELL DSC](/powershell/scripting/dsc/overview/overview) — это средство PowerShell, которое позволяет объявить нужную конфигурацию для компьютера. Например, если требуется установить шоколад, установить службы IIS, открыть порт 80 и версию 1.0.0 установленного веб-сайта, локальная Configuration Manager DSC (LCM) реализует эту конфигурацию. Опрашивающий сервер DSC содержит репозиторий конфигураций для ваших компьютеров. Локальный диспетчер конфигураций на каждом компьютере периодически проверяет, совпадает ли его конфигурация с сохраненной конфигурацией. Он либо сообщает о состоянии, либо пытается привести компьютер в соответствие с сохраненной конфигурацией. Сохраненную конфигурацию на опрашивающем сервере можно изменить, чтобы привести компьютер или набор компьютеров в соответствие с измененной конфигурацией.

Ресурс DSC — это модуль кода, который имеет определенные возможности, такие как управление сетью, Active Directory или SQL Server. Ресурс DSC Chocolatey может получать доступ к серверу NuGet, загружать и устанавливать пакеты и т. д. Имеется также множество других ресурсов DSC, доступных в [коллекции PowerShell](https://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title). Эти модули устанавливаются на опрашивающем сервере конфигурации состояния службы автоматизации Azure для использования в конфигурациях.

Шаблоны диспетчер ресурсов предоставляют декларативный способ создания инфраструктуры, например сети, подсети, сетевой безопасности и маршрутизации, подсистемы балансировки нагрузки, сетевые карты, виртуальные машины и т. д. Ниже приведена [статья](../azure-resource-manager/management/deployment-models.md) , сравнивающая модель развертывания Диспетчер ресурсов (декларативная) с моделью развертывания управления службами Azure (ASM или классическая модель) (императивный). Эта статья содержит обсуждение основных поставщиков ресурсов: вычислений, хранения и сети.

Одной из ключевых особенностей шаблона диспетчер ресурсов является возможность установить расширение виртуальной машины на виртуальную машину по мере ее подготовки. Расширение виртуальной машины имеет определенные возможности, такие как запуск пользовательского сценария, установка антивирусного по и выполнение сценария настройки DSC. Существует много других типов расширений VM.

## <a name="quick-trip-around-the-diagram"></a>Краткий обзор схемы

Начиная с верхнего, вы пишете код, создаете его, тестируете, а затем создаете пакет установки. Chocolatey может обрабатывать пакеты установки различных типов, например MSI, MSU и ZIP. Кроме того, у вас есть все возможности PowerShell для выполнения фактической установки, если собственные возможности шоколадного управления не нужны. Поместите пакет в некоторое доступное место — в репозиторий пакетов. Он может располагаться где угодно. Например, в этом примере используется общая папка в учетной записи хранилища больших двоичных объектов Azure. Chocolatey работает непосредственно с серверами NuGet и некоторыми другими серверами в рамках управления метаданными пакета. Возможные варианты описаны в [этой статье](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed). В примере использования используется NuGet. Nuspec — это метаданные о пакетах. Сведения о nuspec компилируются в NuPkg и хранятся на сервере NuGet. Когда конфигурация запрашивает пакет по имени и ссылается на сервер NuGet, ресурс с шоколадным DSC на виртуальной машине извлекает пакет и устанавливает его. Можно также запросить определенную версию пакета.

В левом нижнем углу изображения имеется шаблон Azure Resource Manager. В этом примере расширение виртуальной машины регистрирует виртуальную машину с помощью опрашивающего сервера конфигурации состояния службы автоматизации Azure в качестве узла. Конфигурация хранится на опрашивающем сервере дважды: один раз в виде обычного текста и после компиляции в виде MOF-файла. В портал Azure MOF представляет конфигурацию узла, а не простую конфигурацию. Это артефакт, связанный с узлом, чтобы узел знал о его конфигурации. Ниже объясняется, как назначить узлу конфигурацию узла.

Создание nuspec, его компиляция и сохранение на сервере NuGet является небольшим делом. Кроме того, вы уже управляете виртуальными машинами. 

Чтобы выполнить следующий шаг для непрерывного развертывания, необходимо настроить опрашивающий сервер один раз, зарегистрировать узлы с помощью одного раза, а также создать и сохранить начальную конфигурацию на сервере. По мере обновления и развертывания пакетов в репозитории необходимо при необходимости обновить конфигурацию и конфигурацию узла на опрашивающем сервере.

Если вы не начинаете работу с шаблоном диспетчер ресурсов, это нормально. Существуют команды PowerShell, помогающие зарегистрировать виртуальные машины на опрашивающем сервере. Дополнительные сведения см. в статье подключение [компьютеров для управления с помощью конфигурации состояния службы автоматизации Azure](automation-dsc-onboarding.md).

## <a name="about-the-usage-example"></a>Сведения о примере использования

Пример использования в этой статье начинается с виртуальной машины из универсального образа Windows Server 2012 R2 из коллекции Azure. Ее можно запустить из любого сохраненного образа, а затем настроить, используя конфигурацию DSC.
Однако изменение конфигурации, встроенной в образ, требует гораздо больше усилий, чем динамическое обновление конфигурации с помощью DSC.

Для использования этого метода на виртуальных машинах не обязательно использовать шаблон Resource Manager и расширение VM. Кроме того, виртуальные машины, на которых должно выполняться непрерывное развертывание, не обязательно должны размещаться в Azure. На виртуальной машине достаточно установить Chocolatey и настроить локальный диспетчер конфигураций, чтобы указать для нее расположение опрашивающего сервера.

При обновлении пакета на виртуальной машине, находящейся в рабочей среде, во время установки обновления необходимо перевести виртуальную машину в режим вращения. Это можно сделать разными способами. Например, на виртуальной машине, которая находится под контролем балансировщика нагрузки Azure, можно добавить настраиваемый зонд. При обновлении виртуальной машины конечная точка зонда должна возвращать значение 400. Настройка, необходимая для этого изменения, может содержаться в вашей конфигурации, и после завершения обновления вы сможете снова переключиться на возвращение значения 200.

Полный исходный код для этого примера хранится в [этом проекте Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) на сайте GitHub.

## <a name="step-1-set-up-the-pull-server-and-automation-account"></a>Шаг 1. Настройка опрашивающего сервера и учетной записи службы автоматизации

В командной строке PowerShell с аутентификацией (`Connect-AzAccount`) выполните следующую команду (настройка опрашивающего сервера может занять несколько минут).

```azurepowershell-interactive
New-AzResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
New-AzAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT
```

Учетную запись службы автоматизации можно разместить в любом из следующих регионов (также известных как расположения): Восточная часть США 2, Юго-Центральный регион, US Gov (Вирджиния), Западная Европа, Юго-Восточная Азия, Восточная Япония, Центральная Индия и Юго-Восточная Австралия, Центральная Канада, Северная Европа.

## <a name="step-2-make-vm-extension-tweaks-to-the-resource-manager-template"></a>Шаг 2. Корректировка расширения виртуальной машины в шаблон диспетчер ресурсов

Сведения о регистрации виртуальных машин (с помощью расширения VM PowerShell DSC) можно найти в этом [кратком руководстве по шаблонам Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).
На этом шаге новая виртуальная машина регистрируется на опрашивающем сервере в списке узлов State Configuration. В рамках этой регистрации указывается конфигурация узла, применяемая к узлу. Эта конфигурация узла еще не должна существовать на опрашивающем сервере, поэтому на шаге 4 в первый раз это делается. Однако на данном шаге 2 нужно принять решение об имени узла и имени конфигурации. В этом примере использования узел называется isvbox, а конфигурация — ISVBoxConfig. Поэтому имя конфигурации узла (указываемое в DeploymentTemplate.json) имеет значение ISVBoxConfig.isvbox.

## <a name="step-3-add-required-dsc-resources-to-the-pull-server"></a>Шаг 3. добавление требуемых ресурсов DSC на опрашивающий сервер

Коллекция PowerShell содержит средства для установки ресурсов DSC в учетной записи службы автоматизации Azure.
Перейдите к нужному ресурсу и нажмите кнопку "развернуть в службе автоматизации Azure".

![Пример из коллекции PowerShell](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

Еще один способ, недавно добавленный в портал Azure, позволяет извлекать новые модули или обновлять существующие. Щелкните ресурс учетной записи службы автоматизации, плитку активы и, наконец, плитку модули. Значок "Обзор коллекции" позволяет просмотреть список модулей в коллекции, выполнить детализацию подробных сведений и импорт в учетную запись службы автоматизации. Это отличный способ периодически обновлять модули. Кроме того, во время импорта проверяется наличие зависимостей от других модулей, чтобы обеспечить полную синхронизацию.

Существует также ручной подход, используемый только один раз для каждого ресурса, если вы не хотите обновлять его позже. Дополнительные сведения о создании модулей интеграции PowerShell см. в статье [Создание модулей интеграции для службы автоматизации Azure](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/).

>[!NOTE]
>Структура папок модуля интеграции PowerShell для компьютера Windows немного отличается от структуры папок, ожидаемой службой автоматизации Azure. 

1. Установите [Windows Management Framework версии 5](https://aka.ms/wmf5latest) (не требуется для Windows 10).

2. Установите модуль интеграции.

    ```azurepowershell-interactive
    Install-Module –Name MODULE-NAME`    <—grabs the module from the PowerShell Gallery
    ```

3. Скопируйте папку Module из папки **C:\Program филес\виндовсповершелл\модулес\модуле-наме** во временную папку.

4. Удалите образцы и документацию из основной папки.

5. Заархивировать главную папку, присвоив ZIP-файлу имя папки.

6. Помещайте ZIP-файл в доступное расположение HTTP, например в хранилище BLOB-объектов в учетной записи хранения Azure.

7. Выполните следующую команду.

    ```azurepowershell-interactive
    New-AzAutomationModule `
      -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
      -Name MODULE-NAME –ContentLinkUri 'https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip'
    ```

Прилагаемый пример реализует эти шаги для cChoco и Кснетворкинг. 

## <a name="step-4-add-the-node-configuration-to-the-pull-server"></a>Шаг 4. Добавление конфигурации узла на опрашивающий сервер

В первоначальном импорте конфигурации на опрашивающий сервер и ее компиляции нет ничего особенного. Все последующие операции импорта или компиляции той же конфигурации выглядят одинаково. Каждый раз, когда вам нужно обновить пакет и передать его в рабочую среду, выполняйте этот шаг, предварительно проверив правильность файла конфигурации (включая новую версию пакета). Ниже приведен файл конфигурации **ISVBoxConfig. ps1**:

```powershell
Configuration ISVBoxConfig
{
    Import-DscResource -ModuleName cChoco
    Import-DscResource -ModuleName xNetworking

    Node 'isvbox' {

        cChocoInstaller installChoco
        {
            InstallDir = 'C:\choco'
        }

        WindowsFeature installIIS
        {
            Ensure = 'Present'
            Name   = 'Web-Server'
        }

        xFirewall WebFirewallRule
        {
            Direction    = 'Inbound'
            Name         = 'Web-Server-TCP-In'
            DisplayName  = 'Web Server (TCP-In)'
            Description  = 'IIS allow incoming web site traffic.'
            Enabled       = 'True'
            Action       = 'Allow'
            Protocol     = 'TCP'
            LocalPort    = '80'
            Ensure       = 'Present'
        }

        cChocoPackageInstaller trivialWeb
        {
            Name      = 'trivialweb'
            Version   = '1.0.0'
            Source    = 'MY-NUGET-V2-SERVER-ADDRESS'
            DependsOn = '[cChocoInstaller]installChoco','[WindowsFeature]installIIS'
        }
    }
}
```

Ниже приведен сценарий **Нев-конфигуратионскрипт. ps1** (измененный для использования модуля AZ):

```powershell
Import-AzAutomationDscConfiguration `
    -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 `
    -Published –Force

$jobData = Start-AzAutomationDscCompilationJob `
    -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -ConfigurationName ISVBoxConfig

$compilationJobId = $jobData.Id

Get-AzAutomationDscCompilationJob `
    -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT `
    -Id $compilationJobId
```

В результате выполнения этих действий на опрашивающем сервере помещается новая конфигурация узла с именем **ISVBoxConfig. isvbox** . Имя конфигурации узла создается как `configurationName.nodeName`.

## <a name="step-5-create-and-maintain-package-metadata"></a>Шаг 5. Создание и обслуживание метаданных пакета

Для каждого пакета, помещаемого в репозиторий пакетов, требуется nuspec, описывающий его. Она должна быть скомпилирована и сохранена на сервере NuGet. Этот процесс описан [здесь](https://docs.nuget.org/create/creating-and-publishing-a-package). 

**MyGet.org** можно использовать в качестве сервера NuGet. Вы можете приобрести эту службу, но три — это бесплатная начальная SKU. В [NuGet](https://www.nuget.org/)вы найдете инструкции по установке собственного сервера NuGet для частных пакетов.

## <a name="step-6-tie-it-all-together"></a>Шаг 6. Объедините все вместе

Каждый раз, когда версия проходит контроль качества и утверждается для развертывания, создается пакет, а nuspec и nupkg обновляются и развертываются на сервере NuGet. Конфигурацию (шаг 4) также необходимо обновить, чтобы согласовать с новым номером версии. Затем он должен быть отправлен на опрашивающий сервер и скомпилирован.

С этого момента именно виртуальные машины, зависящие от этой конфигурации, отвечают за получение обновления и его установку. Каждое из этих обновлений — просто строка или две из PowerShell. Для Azure DevOps некоторые из них инкапсулируются в задачи сборки, которые могут быть объединены в сборку в цепочку. Дополнительные сведения см. в [этой статье](https://www.visualstudio.com/docs/alm-devops-feature-index#continuous-delivery). В этом [репозитории GitHub](https://github.com/Microsoft/vso-agent-tasks) подробно описаны доступные задачи сборки.

## <a name="related-articles"></a>Похожие статьи
* [Обзор Automation DSC Azure](automation-dsc-overview.md)
* [Подключение компьютеров для управления с помощью Azure Automation DSC](automation-dsc-onboarding.md)

## <a name="next-steps"></a>Дальнейшие действия

- Общие сведения см. в статье [Настройка состояния службы автоматизации Azure](automation-dsc-overview.md).
- Чтобы приступить к работе, см. статью [Приступая к работе с конфигурацией состояния службы автоматизации Azure](automation-dsc-getting-started.md).
- Дополнительные сведения о компиляции конфигураций DSC с целью назначения их целевым узлам см. [в разделе Компиляция конфигураций в конфигурации состояния службы автоматизации Azure](automation-dsc-compile.md).
- Справочник по командлетам PowerShell см. в документации по [Az.Automation](https://docs.microsoft.com/powershell/module/az.automation/?view=azps-3.7.0#automation
).
- Сведения о ценах см. в разделе [цены на настройку состояния службы автоматизации Azure](https://azure.microsoft.com/pricing/details/automation/).
- Пример использования конфигурации состояния службы автоматизации Azure в конвейере непрерывного развертывания см. в статье [непрерывное развертывание с помощью конфигурации состояния службы автоматизации Azure и шоколадного](automation-dsc-cd-chocolatey.md)развертывания.
