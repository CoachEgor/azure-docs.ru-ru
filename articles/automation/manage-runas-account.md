---
title: Управление учетной записью запуска от имени службы автоматизации Azure
description: В этой статье объясняется, как управлять учетной записью запуска от имени с помощью PowerShell или портала Azure.
services: automation
ms.subservice: shared-capabilities
ms.date: 06/26/2020
ms.topic: conceptual
ms.openlocfilehash: cb804b21d6f5312c13bfdbf7b0fc0404961ba1e3
ms.sourcegitcommit: 3c66bfd9c36cd204c299ed43b67de0ec08a7b968
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2020
ms.locfileid: "90005740"
---
# <a name="manage-an-azure-automation-run-as-account"></a>Управление учетной записью запуска от имени службы автоматизации Azure

Учетные записи запуска от имени в службе автоматизации Azure позволяют выполнять аутентификацию для управления ресурсами в Azure с помощью командлетов Azure. При создании учетной записи запуска от имени в Azure Active Directory (AD) создается пользователь субъекта-службы и ему назначается роль участника на уровне подписки.

## <a name="types-of-run-as-accounts"></a>Типы учетных записей запуска от имени

Служба автоматизации Azure использует два типа учетных записей запуска от имени:

* учетная запись запуска от имени Azure;
* классическая учетная запись запуска от имени Azure.

>[!NOTE]
>Подписки Поставщика облачных речений Azure (CSP) поддерживают только модель Azure Resource Manager. Службы, не являющиеся частью Azure Resource Manager, недоступны в программе. При использовании подписки CSP создается не классическая учетная запись запуска от имени Azure, а учетная запись запуска от имени Azure. Дополнительные сведения о подписках CSP см. в разделе [Доступные службы в подписках CSP](/azure/cloud-solution-provider/overview/azure-csp-available-services).

У субъекта-службы для учетной записи запуска от имени по умолчанию нет разрешений на чтение данных из Azure AD. Если вы хотите добавить разрешения для чтения данных из Azure AD или управления ими, необходимо предоставить субъекту-службе разрешения в разделе **Разрешения API**. Дополнительные сведения см. в разделе [Добавление разрешений для доступа к веб-API](../active-directory/develop/quickstart-configure-app-access-web-apis.md#add-permissions-to-access-your-web-api).

### <a name="run-as-account"></a>учетная запись запуска от имени

Учетная запись запуска от имени используется для управления ресурсами в [модели развертывания Resource Manager](../azure-resource-manager/management/deployment-models.md). Она выполняет следующее.

* Создает приложение Azure AD с самозаверяющим сертификатом, учетную запись субъекта-службы для этого приложения в Azure AD, а также назначает роль участника для учетной записи в текущей подписке. Вместо этого параметра сертификата можно использовать роль владельца или любую другую роль. Дополнительные сведения см. в статье [Управление доступом на основе ролей в службе автоматизации Azure](automation-role-based-access-control.md).

* Создает ресурс сертификата службы автоматизации `AzureRunAsCertificate` в указанной учетной записи службы автоматизации. Этот ресурс содержит закрытый ключ сертификата, используемый в приложении Azure AD.

* Создает ресурс подключения службы автоматизации `AzureRunAsConnection` в указанной учетной записи службы автоматизации. Этот ресурс содержит идентификаторы приложения, клиента и подписки, а также отпечаток сертификата.

### <a name="azure-classic-run-as-account"></a>Классическая учетная запись запуска от имени Azure

Классическая учетная запись запуска от имени Azure используется для управления ресурсами в [классической модели развертывания Azure](../azure-resource-manager/management/deployment-models.md). Для создания или обновления учетной записи этого типа необходимо быть соадминистратором подписки.

Классическая учетная запись запуска от имени Azure выполняет следующее.

  * Создает сертификат управления в подписке.

  * Создает ресурс сертификата службы автоматизации `AzureClassicRunAsCertificate` в указанной учетной записи службы автоматизации. Этот ресурс содержит закрытый ключ сертификата, используемый в сертификате управления.

  * Создает ресурс подключения службы автоматизации `AzureClassicRunAsConnection` в указанной учетной записи службы автоматизации. Этот ресурс содержит имя подписки, идентификатор подписки и имя ресурса сертификата.

>[!NOTE]
>Классическая учетная запись запуска от имени Azure не создается по умолчанию при создании учетной записи службы автоматизации Azure. Эту учетную запись можно создать отдельно, выполнив действий, описанные далее в этой статье.

## <a name="obtain-run-as-account-permissions"></a><a name="permissions"></a>Получение разрешений учетной записи запуска от имени

В этом разделе определены разрешения для обычной и классической учетных записей запуска от имени.

### <a name="get-permissions-to-configure-run-as-accounts"></a>Получение разрешений для настройки учетных записей запуска от имени

Чтобы создать или обновить учетную запись запуска от имени, необходимо иметь привилегии и разрешения. Администратор приложений в Azure Active Directory и владелец в подписке могут выполнить все эти задачи. В следующей таблице показаны списки задач, эквивалентный командлет и необходимые разрешения для ситуаций, когда применяется разделение обязанностей.

|Задача|Командлет  |Минимальные разрешения  |Где необходимо установить разрешения|
|---|---------|---------|---|
|Создание приложения Azure AD|[New-AzADApplication](/powershell/module/az.resources/new-azadapplication)     | Роль разработчика приложения<sup>1</sup>        |[Azure AD](../active-directory/develop/howto-create-service-principal-portal.md#permissions-required-for-registering-an-app)</br>"Главная" > "Azure AD" > "Регистрация приложений" |
|Добавление учетных данных приложения|[New-AzADAppCredential](/powershell/module/az.resources/new-azadappcredential)     | Администратор приложений или глобальный администратор<sup>1</sup>         |[Azure AD](../active-directory/develop/howto-create-service-principal-portal.md#permissions-required-for-registering-an-app)</br>"Главная" > "Azure AD" > "Регистрация приложений"|
|Создание или получение субъекта-службы Azure AD|[New-AzADServicePrincipal](/powershell/module/az.resources/new-azadserviceprincipal)</br>[Get-AzADServicePrincipal](/powershell/module/az.resources/get-azadserviceprincipal)     | Администратор приложений или глобальный администратор<sup>1</sup>        |[Azure AD](../active-directory/develop/howto-create-service-principal-portal.md#permissions-required-for-registering-an-app)</br>"Главная" > "Azure AD" > "Регистрация приложений"|
|Назначение или получение роли Azure для указанного субъекта|[New-AzRoleAssignment](/powershell/module/az.resources/new-azroleassignment)</br>[Get-AzRoleAssignment](/powershell/module/Az.Resources/Get-AzRoleAssignment)      | Администратор доступа пользователей, владелец или пользователь со следующими разрешениями:</br></br><code>Microsoft.Authorization/Operations/read</br>Microsoft.Authorization/permissions/read</br>Microsoft.Authorization/roleDefinitions/read</br>Microsoft.Authorization/roleAssignments/write</br>Microsoft.Authorization/roleAssignments/read</br>Microsoft.Authorization/roleAssignments/delete</code></br></br> | [Подписка](../role-based-access-control/role-assignments-portal.md)</br>Подписки главной > > \<subscription name\> — Управление доступом (IAM)|
|Создание или удаление сертификата службы автоматизации|[New-AzAutomationCertificate](/powershell/module/Az.Automation/New-AzAutomationCertificate)</br>[Remove-AzAutomationCertificate](/powershell/module/az.automation/remove-azautomationcertificate)     | Участник группы ресурсов         |Группа ресурсов учетной записи службы автоматизации|
|Создание или удаление подключения службы автоматизации|[New-AzAutomationConnection](/powershell/module/az.automation/new-azautomationconnection)</br>[Remove-AzAutomationConnection](/powershell/module/az.automation/remove-azautomationconnection)|Участник группы ресурсов |Группа ресурсов учетной записи службы автоматизации|

<sup>1</sup> Пользователи без прав администратора в арендаторе Azure AD могут [регистрировать приложения AD](../active-directory/develop/howto-create-service-principal-portal.md#permissions-required-for-registering-an-app), если в этом арендаторе для параметра **Пользователи могут регистрировать приложения** на странице параметров пользователя установлено значение **Да**. Если для этого параметра задано значение **Нет**, то пользователь, выполняющий данное действие, должен соответствовать требованиям в этой таблице.

Если вам назначается роль глобального администратора или соадминистратора подписки, но вы не являетесь участником экземпляра Active Directory подписки, то вы будете добавлены в качестве гостя. В этом случае `You do not have permissions to create…` на странице **Добавление учетной записи службы автоматизации** появится предупреждение.

Если вы являетесь членом Active Directory экземпляра подписки при назначении роли глобального администратора, вы также можете получить `You do not have permissions to create…` предупреждение на странице **Добавление учетной записи службы автоматизации** . В этом случае можно запросить удаление своего пользователя из экземпляра Active Directory подписки, а затем запросить его повторное добавление, чтобы стать полным пользователем в Active Directory.

Вот как можно убедиться, что ситуация, создающая сообщение об ошибке, исправлена.

1. На портале Azure в области Azure Active Directory выберите **Пользователи и группы**.
2. Выберите **Все пользователи**.
3. Выберите свое имя, а затем выберите **Профиль**.
4. Убедитесь, что для атрибута **Тип пользователя** в профиле пользователя не задано значение **Гость**.

### <a name="get-permissions-to-configure-classic-run-as-accounts"></a><a name="permissions-classic"></a>Получение разрешений для настройки классических учетных записей запуска от имени

Чтобы настроить или обновить классические учетные записи запуска от имени, необходима роль соадминистратора на уровне подписки. Чтобы узнать больше о разрешениях классической подписки, ознакомьтесь с разделом [Классические администраторы подписок Azure](../role-based-access-control/classic-administrators.md#add-a-co-administrator).

## <a name="create-a-run-as-account-in-azure-portal"></a>Создание учетной записи запуска от имени на портале Azure

Выполните действия, с помощью которых на портале Azure можно обновить учетную запись службы автоматизации Azure. Учетные записи запуска от имени и классические учетные записи запуска от имени создаются отдельно. Если вам не нужно управлять классическими ресурсами, достаточно создать учетную запись запуска от имени Azure.

1. Войдите на портал Azure с помощью учетной записи, которая является участником роли администраторов подписки и соадминистратором подписки.

2. Найдите и выберите раздел **Учетные записи службы автоматизации**.

3. На странице учетных записей службы автоматизации выберите в списке нужную учетную запись.

4. В области слева выберите **Учетные записи запуска от имени** в разделе параметров учетной записи.

5. В зависимости от того, какую учетную запись необходимо создать, выберите **Учетная запись запуска от имени Azure** или **Классическая учетная запись запуска от имени Azure**.

6. В зависимости от того, какая учетная запись вас интересует, выберите область **Add Azure Run As** (Добавление учетной записи запуска от имени Azure) или **Add Azure Classic Run As Account** (Добавление классической учетной записи запуска от имени Azure). Просмотрев общие сведения, щелкните **Создать**.

7. Ход создания учетной записи запуска от имени в Azure можно отслеживать в разделе **Уведомления** в меню. Кроме того, отображается баннер с уведомлением о создании учетной записи. Процесс создания может занять несколько минут.

## <a name="delete-a-run-as-or-classic-run-as-account"></a>Удаление учетной записи запуска от имени или классической учетной записи запуска от имени

В этом разделе описывается, как удалить учетную запись запуска от имени или классическую учетную запись запуска от имени. При выполнении этого действия учетная запись службы автоматизации сохраняется. После удаления учетной записи ее можно создать заново на портале Azure.

1. На портале Azure откройте учетную запись службы автоматизации.

2. В области слева выберите **Учетные записи запуска от имени** в разделе параметров учетной записи.

3. На странице свойств учетных записей запуска от имени выберите учетную запись запуска от имени или классическую учетную запись запуска от имени, которую нужно удалить.

4. Затем в области "Свойства" выбранной учетной записи щелкните **Удалить**.

   ![Удаление учетной записи запуска от имени](media/manage-runas-account/automation-account-delete-runas.png)

5. Ход удаления учетной записи можно отслеживать в разделе **Уведомления** в меню.

6. После удаления учетной записи ее можно повторно создать на странице свойств учетных записей запуска от имени, выбрав параметр создания **Azure Run As Account** (Учетная запись запуска от имени Azure).

   ![Повторное создание учетной записи запуска от имени службы автоматизации](media/manage-runas-account/automation-account-create-runas.png)

## <a name="renew-a-self-signed-certificate"></a><a name="cert-renewal"></a>Продление самозаверяющего сертификата

Срок действия самозаверяющего сертификата, созданного для учетной записи запуска от имени, составляет один год с даты создания. В определенный момент перед истечением срока действия учетной записи запуска от имени вам потребуется продлить сертификат. Его можно продлить в любое время до истечения его срока действия.

При продлении самозаверяющего сертификата текущий действительный сертификат сохраняется, чтобы гарантировать, что все модули runbook, которые поставлены в очередь или активно выполняются и для аутентификации которых используется учетная запись запуска от имени, не пострадают. Сертификат будет существовать до окончания срока действия.

>[!NOTE]
>Если вы считаете, что учетная запись запуска от имени была скомпрометирована, то можете удалить самозаверяющий сертификат и создать его заново.

>[!NOTE]
>Если вы настроили учетную запись запуска от имени службы автоматизации для использования сертификата, выданного корпоративным центром сертификации, и используете параметр продления самозаверяющего сертификата, то этот корпоративный сертификат будет заменен самозаверяющим сертификатом.

Чтобы продлить самозаверяющий сертификат, выполните следующие действия.

1. На портале Azure откройте учетную запись службы автоматизации.

1. Выберите **Учетные записи запуска от имени** в разделе параметров учетной записи.

    ![Область свойств учетной записи службы автоматизации](media/manage-runas-account/automation-account-properties-pane.png)

1. На странице свойств учетных записей запуска от имени выберите обычную или классическую учетную запись запуска от имени, для которой нужно продлить сертификат.

1. В области свойств выбранной учетной записи щелкните **Продлить сертификат**.

    ![Обновление сертификата для учетной записи запуска от имени](media/manage-runas-account/automation-account-renew-runas-certificate.png)

1. Ход обновления сертификата можно отслеживать в разделе **Уведомления** в меню.

## <a name="limit-run-as-account-permissions"></a>Ограничение разрешений учетной записи запуска от имени

Чтобы управлять доступом службы автоматизации к ресурсам в Azure, можно запустить сценарий [Update-AutomationRunAsAccountRoleAssignments.ps1](https://aka.ms/AA5hug8). Этот сценарий изменяет существующий субъект-службу учетной записи запуска от имени, чтобы создать и использовать пользовательское определение роли. Это роль с разрешениями для всех ресурсов, кроме [Key Vault](../key-vault/index.yml).

>[!IMPORTANT]
>После запуска сценария **Update-AutomationRunAsAccountRoleAssignments.ps1** модули runbook, которые обращаются к Key Vault с помощью учетных записей запуска от имени, больше не будут работать. Перед выполнением сценария необходимо проверить модули runbook в вашей учетной записи на наличие вызовов к Azure Key Vault. Чтобы разрешить доступ к Key Vault из модулей runbook службы автоматизации Azure, необходимо [добавить учетную запись запуска от имени в разрешения Key Vault](#add-permissions-to-key-vault).

Если необходимо ввести дополнительные ограничения, выходящие за рамки возможностей субъекта-службы запуска от имени, можно добавить другие типы ресурсов в элемент `NotActions` пользовательского определения роли. В следующем примере ограничивается доступ к `Microsoft.Compute/*`. Если вы добавите этот тип ресурса в `NotActions` в определении роли, данная роль не сможет предоставить доступ к вычислительному ресурсу. Чтобы узнать больше об определениях ролей, ознакомьтесь с разделом [Общие сведения об определениях ролей для ресурсов Azure](../role-based-access-control/role-definitions.md).

```powershell
$roleDefinition = Get-AzRoleDefinition -Name 'Automation RunAs Contributor'
$roleDefinition.NotActions.Add("Microsoft.Compute/*")
$roleDefinition | Set-AzRoleDefinition
```

Определить, указан ли субъект-служба, используемый вашей учетной записью запуска от имени, в определении роли участника или пользовательском определении.

1. Перейдите к учетной записи службы автоматизации и выберите **Учетные записи запуска от имени** в разделе параметров учетной записи.
2. Выберите **Azure Run As Account** (Учетная запись запуска от имени Azure).
3. Выберите **Роль**, чтобы указать используемое определение роли.

:::image type="content" source="media/manage-runas-account/verify-role.png" alt-text="Проверьте роль учетной записи запуска от имени." lightbox="media/manage-runas-account/verify-role-expanded.png":::


Можно также задать определение роли, используемое учетными записями запуска от имени, для нескольких подписок или учетных записей автоматизации. Для этого используйте сценарий [Check-AutomationRunAsAccountRoleAssignments.ps1](https://aka.ms/AA5hug5) из коллекции PowerShell.

### <a name="add-permissions-to-key-vault"></a>Добавление разрешений в Key Vault

Вы можете разрешить службе автоматизации Azure проверять, используют ли Key Vault и субъект-служба учетной записи запуска от имени пользовательское определение роли. Необходимо сделать следующее:

* Предоставьте разрешения для Key Vault.
* Настройте политику доступа.

Вы можете использовать сценарий [Extend-AutomationRunAsAccountRoleAssignmentToKeyVault.ps1](https://aka.ms/AA5hugb) из коллекция PowerShell, чтобы предоставить учетной записи запуска от имени разрешения для Key Vault. Дополнительные сведения о настройке разрешений для Key Vault см. в разделе [Назначение политики доступа Key Vault](/azure/key-vault/general/assign-access-policy-powershell) .

## <a name="resolve-misconfiguration-issues-for-run-as-accounts"></a>Устранение проблем из-за неправильной конфигурации учетных записей запуска от имени

Во время начальной настройки некоторые из элементов конфигурации, необходимых для работы обычной или классической учетной записи запуска от имени, могут быть удалены или неправильно созданы. Возможные случаи неправильной конфигурации включают в себя:

* ресурс сертификата;
* ресурс подключения;
* удаление учетной записи запуска от имени из роли участника;
* субъект-службу или приложение в Azure AD.

В случае такой неправильной конфигурации учетная запись службы автоматизации обнаружит эти изменения и отобразит в области свойств учетных записей запуска от имени состояние *Не выполнено*.

![Сообщение о том, что настройка учетной записи запуска от имени не завершена](media/manage-runas-account/automation-account-runas-incomplete-config.png)

При выборе учетной записи запуска от имени в области свойств учетной записи отобразится приведенное ниже сообщение об ошибке.

```text
The Run As account is incomplete. Either one of these was deleted or not created - Azure Active Directory Application, Service Principal, Role, Automation Certificate asset, Automation Connect asset - or the Thumbprint is not identical between Certificate and Connection. Please delete and then re-create the Run As Account.
```

Вы можете быстро устранить проблемы с учетной записью запуска от имени, удалив и повторно создав учетную запись запуска от имени.

## <a name="next-steps"></a>Дальнейшие действия

* [Объекты приложения и субъекта-службы](../active-directory/develop/app-objects-and-service-principals.md)
* [Общие сведения о сертификатах для Облачных служб Azure](../cloud-services/cloud-services-certs-create.md)
