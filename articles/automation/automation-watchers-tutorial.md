---
title: Создание задачи наблюдателя в учетной записи службы автоматизации Azure
description: Узнайте, как создать задачу наблюдателя в учетной записи службы автоматизации Azure, чтобы отслеживать создание файлов в папке.
services: automation
ms.subservice: process-automation
ms.topic: conceptual
ms.date: 10/30/2018
ms.openlocfilehash: 5dc6145940883ff6f4446ad67c399cdf4931d38e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75419755"
---
# <a name="create-an-azure-automation-watcher-tasks-to-track-file-changes-on-a-local-machine"></a>Создание задач службы "Наблюдатель за автоматизацией Azure" для отслеживания изменений файлов на локальном компьютере

Служба автоматизации Azure использует задачи службы "Наблюдатель" для слежения за событиями и активации действий с помощью модулей runbook PowerShell. В этом руководстве пошагово описывается создание задачи службы "Наблюдатель" для отслеживания добавления новых файлов в каталог.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Импорт runbook службы "Наблюдатель"
> * Создание переменной службы автоматизации
> * Создание runbook действия
> * Создание задачи службы "Наблюдатель"
> * Активация службы "Наблюдатель"
> * Изучение выходных данных

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены необходимые условия для выполнения инструкций из этого руководства.

* Подписка Azure. Если у вас ее нет, [активируйте преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрируйте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации](automation-offering-get-started.md) для хранения runbook наблюдателя, runbook действия и задачи наблюдателя.
* [Гибридная рабочая роль runbook](automation-hybrid-runbook-worker.md), в которой выполняется задача наблюдателя.

> [!NOTE]
> Задачи наблюдения не поддерживаются в Azure China.

## <a name="import-a-watcher-runbook"></a>Импорт runbook службы "Наблюдатель"

В этом руководстве для поиска новых файлов в каталоге используется runbook службы "Наблюдатель" **Watch-NewFile**. Runbook службы "Наблюдатель" получает время последней записи в файлы в папке и ищет файлы, для которых это значение не превышает заданный предел.

Этот процесс импорта может быть сделано через [powerShell Галерея](https://www.powershellgallery.com).

1. Перейдите на страницу галереи [для Watch-NewFile.ps1](https://gallery.technet.microsoft.com/scriptcenter/Watcher-runbook-that-looks-36fc82cd).
2. Под вкладкой **Azure Automation** нажмите **«Развертывание в Автоматизации Azure».**

Вы также можете импортировать этот runbook в свой аккаунт автоматизации с портала, используя следующие шаги.

1. Откройте учетную запись службы автоматизации и щелкните на странице **Модули Runbook**.
2. Нажмите на кнопку **галереи Browse.**
3. Найдите пункт "Watcher runbook" (Runbook службы "Наблюдатель"), выберите **Watcher runbook that looks for new files in a directory** (Runbook службы "Наблюдатель", который ищет новые файлы в каталоге) и щелкните **Импорт**.
  ![Импорт runbook службы автоматизации с помощью пользовательского интерфейса](media/automation-watchers-tutorial/importsourcewatcher.png)
1. Укажите имя и описание runbook, затем нажмите кнопку **ОК**, чтобы импортировать runbook в учетную запись службы автоматизации.
1. Щелкните **Изменить**, затем щелкните **Опубликовать**. При появлении соответствующего запроса выберите **Да** для публикации runbook.

## <a name="create-an-automation-variable"></a>Создание переменной службы автоматизации

[Переменная службы автоматизации](automation-variables.md) используется для хранения меток времени, которые приведенный выше runbook считывает из каждого файла и сохраняет.

1. Выберите **Переменные** в разделе **Общие ресурсы**, затем щелкните **+ Добавить переменную**.
1. Введите имя "Watch-NewFileTimestamp".
1. Выберите тип "Дата и время".
1. Нажмите кнопку **Создать**. Будет создана переменная автоматизации.

## <a name="create-an-action-runbook"></a>Создание runbook действия

Runbook действия используется в задаче службы "Наблюдатель" для работы с данными, передаваемыми в нее из runbook службы "Наблюдатель". Модули runbook рабочих процессов PowerShell не поддерживаются в задачах службы "Наблюдатель". Необходимо использовать модули runbook PowerShell. Необходимо импортировать заранее определенный запуск действия под названием **Process-NewFile.**

Этот процесс импорта может быть сделано через [powerShell Галерея](https://www.powershellgallery.com).

1. Перейдите на страницу галереи для [Process-NewFile.ps1](https://gallery.technet.microsoft.com/scriptcenter/Watcher-action-that-b4ff7cdf).
2. Под вкладкой **Azure Automation** нажмите **«Развертывание в Автоматизации Azure».**

Вы также можете импортировать этот runbook в свой аккаунт автоматизации с портала, используя следующие шаги.

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Модули Runbook**.
1. Нажмите на кнопку **галереи Browse.**
1. Найдите пункт "Watcher action" (Действие службы "Наблюдатель"), выберите **Watcher action that processes events triggered by a watcher runbook** (Действие службы "Наблюдатель", обрабатывающее события, активированные runbook службы "Наблюдатель") и щелкните **Импорт**.
  ![Импорт runbook действия с помощью пользовательского интерфейса](media/automation-watchers-tutorial/importsourceaction.png)
1. Укажите имя и описание runbook, затем нажмите кнопку **ОК**, чтобы импортировать runbook в учетную запись службы автоматизации.
1. Щелкните **Изменить**, затем щелкните **Опубликовать**. При появлении соответствующего запроса выберите **Да** для публикации runbook.

## <a name="create-a-watcher-task"></a>Создание задачи службы "Наблюдатель"

Задача службы "Наблюдатель" состоит из двух частей. Службы "Наблюдатель" и действия. Служба "Наблюдатель" выполняется с интервалом, определенным в задаче службы "Наблюдатель". Данные из runbook службы "Наблюдатель" передаются в runbook действия. На этом этапе настраивается задача службы "Наблюдатель", указывающая на runbook службы "Наблюдатель" и runbook действия, определенные на предыдущих шагах.

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Задачи наблюдателя**.
1. Откройте страницу "Задачи наблюдателя" и нажмите кнопку **+ Добавить задачу наблюдателя**.
1. Введите имя "WatchMyFolder".

1. Выберите **наверстывание наблюдателя** и выберите runbook **Watch-NewFile.**

1. Введите следующие значения параметров.

   * **FOLDERPATH** (Путь к папке). Папка в гибридной рабочей роли, где создаются файлы. d:\examplefiles
   * **EXTENSION** (Расширение). Оставьте поле пустым, чтобы обрабатывались все расширения файлов.
   * **RECURSE** (Рекурсия). Оставьте это значение по умолчанию.
   * **RUN SETTINGS** (Параметры запуска). Выберите гибридную рабочую роль.

1. Нажмите кнопку "ОК" и щелкните "Выбрать", чтобы вернуться на страницу наблюдателя.
1. Выберите **настройку действия** и выберите runbook "Process-NewFile".
1. Введите следующие значения параметров:

   * **EVENTDATA** (Данные событий). Оставьте это поле пустым. Данные передаются из runbook наблюдателя.
   * **Run Settings** (Параметры запуска). Оставьте значение Azure, так как этот runbook выполняется в службе автоматизации.

1. Нажмите **OK**, а затем выберите, чтобы вернуться на страницу наблюдателя.
1. Нажмите **OK,** чтобы создать задачу наблюдателя.

![Настройка действия службы "Наблюдатель" с помощью пользовательского интерфейса](media/automation-watchers-tutorial/watchertaskcreation.png)

## <a name="trigger-a-watcher"></a>Активация службы "Наблюдатель"

Чтобы проверить, работает ли служба "Наблюдатель" надлежащим образом, необходимо создать тестовый файл.

Установите удаленное подключение к гибридной рабочей роли. Откройте **PowerShell** и создайте тестовый файл в папке.

```azurepowerShell-interactive
New-Item -Name ExampleFile1.txt
```

В следующем примере показаны ожидаемые выходные данные.

```output
    Directory: D:\examplefiles


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       12/11/2017   9:05 PM              0 ExampleFile1.txt
```

## <a name="inspect-the-output"></a>Изучение выходных данных

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Задачи наблюдателя**.
1. Щелкните задачу службы "Наблюдатель" WatchMyFolder.
1. Щелкните **Просмотреть потоки наблюдателей** в разделе **Потоки**, чтобы убедиться, что службой "Наблюдатель" обнаружен новый файл и запущен runbook действия.
1. Щелкните **Просмотреть задания действий наблюдателя**, чтобы просмотреть задания runbook действия. Вы можете выбрать каждое задание, чтобы просмотреть сведения о нем.

   ![Задания действия службы "Наблюдатель" в пользовательском интерфейсе](media/automation-watchers-tutorial/WatcherActionJobs.png)

Ожидаемые выходные данные при обнаружении нового файла можно увидеть в следующем примере.

```output
Message is Process new file...



Passed in data is @{FileName=D:\examplefiles\ExampleFile1.txt; Length=0}
```

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Импорт runbook службы "Наблюдатель"
> * Создание переменной службы автоматизации
> * Создание runbook действия
> * Создание задачи службы "Наблюдатель"
> * Активация службы "Наблюдатель"
> * Изучение выходных данных

Перейдите по ссылке для получения дополнительных сведений о создании собственного runbook.

> [!div class="nextstepaction"]
> [Мой первый PowerShell runbook](automation-first-runbook-textual-powershell.md).

