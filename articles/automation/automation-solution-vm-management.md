---
title: Решение "Запуск и остановка виртуальных машин в нерабочее время"
description: Решение по управлению запускает и останавливает виртуальные машины Azure Resource Manager по расписанию и осуществляет упреждающий мониторинг с журналы Azure Monitor.
services: automation
ms.service: automation
ms.subservice: process-automation
author: georgewallace
ms.author: gwallace
ms.date: 03/31/2019
ms.topic: conceptual
manager: carmonm
ms.openlocfilehash: 6d7b99da3e8e81973c51bbd68a15517828c9736d
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61306871"
---
# <a name="startstop-vms-during-off-hours-solution-in-azure-automation"></a>Решение для запуска и остановки виртуальных машин в нерабочее время в службе автоматизации Azure

Запуск и остановка виртуальных машин в нерабочее, решение запускает и останавливает виртуальные машины Azure на согласно определенным пользователем расписаниям, предоставляет важные сведения с помощью журналов Azure Monitor и отправляет необязательные электронные сообщения с помощью [группы действий](../azure-monitor/platform/action-groups.md). В большинстве сценариев оно поддерживает виртуальные машины Azure Resource Manager и классические виртуальные машины.

> [!NOTE]
> Запуск и остановка виртуальных машин в нерабочее время, которые решение был протестирован с модулями Azure, которые импортируются в учетной записи службы автоматизации, при развертывании решения. Решения в настоящее время не работает с более поздними версиями модуля Azure. Это относится только к учетной записи автоматизации, используемой для запуска и остановки виртуальных машин в рабочее решение нерабочее время. Можно по-прежнему использовать более новые версии модуля Azure в вашей другие учетные записи службы автоматизации, как описано в разделе [как обновить модули Azure PowerShell в службе автоматизации Azure](automation-update-azure-modules.md)

Это решение предоставляет возможность децентрализованной экономичной автоматизации пользователям, которым необходимо снизить расходы на виртуальные машины. Это решение обеспечивает следующие возможности:

- планирование запуска и остановки виртуальных машин;
- планирование запуска и остановки виртуальных машин в возрастающем порядке с помощью тегов Azure (не поддерживается для классических виртуальных машин);
- автоматическая остановка виртуальных машин при низком уровне использования ЦП.

Это решение имеет следующие ограничения:

- С помощью этого решения можно управлять виртуальными машинами в любом регионе, но его можно использовать только в той же подписке, что и учетная запись службы автоматизации Azure.
- Это решение можно развернуть в любом регионе Azure и AzureGov, в котором поддерживается рабочая область Log Analytics, учетная запись службы автоматизации Azure и отправка оповещений. Сейчас регионы AzureGov не поддерживают функции электронной почты.

> [!NOTE]
> Если вы используете решение для классических виртуальных машин, все виртуальные машины в каждой облачной службе будут обрабатываться последовательно. Виртуальные машины по-прежнему обрабатываются параллельно в разных облачных службах.
>
> Подписки поставщика облачных решений Azure (Azure CSP) поддерживают только модель Azure Resource Manager; в этой программе отсутствуют все службы, созданные с помощью других моделей. При выполнении решения для запуска и остановки могут возникнуть ошибки, так как в нем есть командлеты для управления классическими ресурсами. Дополнительные сведения о CSP см. в разделе [Комментарии](https://docs.microsoft.com/azure/cloud-solution-provider/overview/azure-csp-available-services#comments). Если вы используете подписку CSP, после развертывания вам следует изменить [**External_EnableClassicVMs**](#variables) на **False**.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="prerequisites"></a>Технические условия

Аутентификация модулей runbook в этом решении осуществляется с помощью [учетной записи запуска от имени Azure](automation-create-runas-account.md). Этот метод аутентификации является предпочтительным, так как в нем используется сертификат, а не пароль, который может устареть или часто меняться.

Рекомендуется использовать отдельную учетную запись службы автоматизации для запуска и остановки виртуальных Машин решения. Это, поскольку версии модулей Azure часто обновляются, и их параметров может измениться. Решение запуска и остановки виртуальной Машины не обновляется на том же периодичность, поэтому он не может работать с более поздними версиями командлетов, которые он использует. Рекомендуется проверять обновления модуля в тесте учетной записи службы автоматизации, прежде чем импортировать их в рабочей учетной записи службы автоматизации.

## <a name="deploy-the-solution"></a>Развертывание решения

Выполните следующие действия, чтобы добавить решение для запуска и остановки виртуальных машин в нерабочее время в свою учетную запись службы автоматизации, а затем настроить его.

1. В разделе **Связанные ресурсы** учетной записи службы автоматизации выберите **Запуск и остановка виртуальных машин**. На этой странице можно щелкнуть **Дополнительные сведения и включение решения**. Если решение для запуска и остановки виртуальных машин уже развернуто, щелкните **Настройка решения** и найдите его в списке.

   ![Включение из учетной записи службы автоматизации](./media/automation-solution-vm-management/enable-from-automation-account.png)

   > [!NOTE]
   > Это решение также можно развернуть из любого места на портале Azure, щелкнув **Создать ресурс**. На странице "Marketplace" введите ключевое слово, например **Start** или **Start/Stop**. Как только вы начнете вводить символы, список отфильтруется соответствующим образом. Кроме того, можно ввести одно или несколько ключевых слов из полного имени решения и нажать клавишу ВВОД. Выберите **Запуск и остановка виртуальных машин в нерабочее время** в результатах поиска.
2. На странице **Запуск и остановка виртуальных машин в нерабочее время** просмотрите сводные данные о выбранном решении и щелкните **Создать**.

   ![Портал Azure](media/automation-solution-vm-management/azure-portal-01.png)

3. Появится страница **Добавление решения**. В ней будет предложено настроить решение перед его импортом в подписку службы автоматизации.

   ![Страница "Добавление решения" в решении по управлению виртуальными машинами](media/automation-solution-vm-management/azure-portal-add-solution-01.png)

4. На странице **Добавление решения** выберите **Рабочая область**. Выберите рабочую область Log Analytics, связанную с подпиской Azure, в которой находится учетная запись службы автоматизации. Если у вас нет рабочей области, выберите **Создать рабочую область**. На **рабочей области Log Analytics** странице, выполните следующие действия:
   - Укажите имя для нового **рабочей области Log Analytics**, например «ContosoLAWorkspace».
   - Выберите из раскрывающегося списка **подписку**, с которой нужно связать рабочую область, если выбранная по умолчанию подписка не подходит.
   - В качестве **группы ресурсов** можно использовать имеющуюся группу или создать новую.
   - Выберите **расположение**. В настоящее время можно выбрать только следующие расположения: **Юго-Восточная Австралия**, **Центральная Канада**, **Центральная Индия**, **восточная часть США**, **Восточная Япония**, **Юго-Восточная Азия**, **южная часть Соединенного Королевства**, **Западная Европа** и **западная часть США 2**.
   - Выберите **ценовую категорию**. Выберите параметр **За ГБ (отдельный)**. Журналы Azure монитор был обновлен [цены](https://azure.microsoft.com/pricing/details/log-analytics/) и уровень "за ГБ" является единственным параметром.

5. Указав необходимые сведения на странице **Рабочая область Log Analytics**, щелкните **Создать**. Вы можете отслеживать ход выполнения, выбрав в меню **Уведомления**. После завершения вновь отобразится страница **Добавление решения**.
6. На странице **Добавление решения** выберите **Учетная запись службы автоматизации**. При создании рабочей области Log Analytics вы можете создать учетную запись службы автоматизации и связать ее с этой рабочей областью или выбрать имеющуюся учетную запись, которая уже связана с ней. Выберите имеющуюся учетную запись или щелкните **Создать учетную запись службы автоматизации** и на странице **Добавление учетной записи службы автоматизации** укажите следующие сведения:
   - В поле **Имя** введите имя учетной записи службы автоматизации.

     Все остальные параметры заполняются автоматически в зависимости от выбранной рабочей области Log Analytics. Эти параметры невозможно изменить. По умолчанию проверка подлинности модулей Runbook, добавленных в это решение, осуществляется с помощью учетной записи запуска от имени Azure. Нажмите кнопку **ОК**, чтобы проверить параметры конфигурации и создать учетную запись службы автоматизации. Ход создания можно просмотреть в разделе **Уведомления** в меню.

7. Наконец, на странице **Добавление решения** выберите **Конфигурация**. Появится страница **Параметры**.

   ![Страница "Параметры" решения](media/automation-solution-vm-management/azure-portal-add-solution-02.png)

   В ней будет предложено выполнить следующие действия.
   - Укажите значение **Target ResourceGroup Names** (Имена целевых групп ресурсов). Это имена групп ресурсов с виртуальными машинами, которыми должно управлять данное решение. Вы можете указать несколько имен, используя в качестве разделителя запятые (в именах не учитывается регистр). Если необходимо использовать виртуальные машины во всех группах ресурсов в рамках подписки, используйте подстановочный знак. Это значение хранится в переменных **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**.
   - Укажите значение **VM Exclude List (string)** (Список исключаемых виртуальных машин (строка)). Это список, содержащий одну или несколько виртуальных машин из целевой группы ресурсов. Вы можете указать несколько имен, используя в качестве разделителя запятые (в именах не учитывается регистр). Поддерживается использование подстановочных знаков. Это значение хранится в переменной **External_ExcludeVMNames**.
   - Выберите значение **Расписание**. Это повторяющиеся дата и время запуска и остановки виртуальных машин в целевых группах ресурсов. По умолчанию в качестве расписания настраивается период длительностью 30 минут с текущего момента. Выбрать другой регион невозможно. Чтобы настроить для расписания использование конкретного часового пояса после настройки решения, ознакомьтесь с разделом [Изменение расписания запуска и завершения работы](#modify-the-startup-and-shutdown-schedules).
   - Чтобы получать **уведомления по электронной почте** от группы действий, оставьте значение по умолчанию **Да** и укажите допустимый адрес электронной почты. Если вы указали значение **Нет**, но впоследствии решили, что вы хотите получать уведомления по электронной почте, то вы можете изменить [группу действий](../azure-monitor/platform/action-groups.md), созданную с допустимыми адресами электронной почты, разделенными запятыми. Кроме того, необходимо включить такие правила генерации оповещений:

     - AutoStop_VM_Child
     - Scheduled_StartStop_Parent
     - Sequenced_StartStop_Parent

     > [!IMPORTANT]
     > Значение по умолчанию **Target ResourceGroup Names** (Имена целевых групп ресурсов) — **&ast;**. Оно охватывает все виртуальные машины в подписке. Если вы не хотите, чтобы решение было нацелено на все виртуальные машины в подписке, это значение необходимо обновить, указав список имен групп ресурсов, прежде чем включать расписания.

8. Завершив начальную настройку обязательных параметров решения, нажмите кнопку **ОК**, чтобы закрыть страницу **Параметры**, и щелкните **Создать**. После проверки всех параметров решение будет развернуто в вашей подписке. Этот процесс может занять несколько секунд. Ход его выполнения можно просмотреть в разделе меню **Уведомления**.

> [!NOTE]
> Если у вас есть подписка поставщика облачных решений Azure (Azure CSP), после развертывание будет завершено, в учетной записи службы автоматизации, перейдите к **переменных** под **общие ресурсы** и задайте [ **External_EnableClassicVMs** ](#variables) переменной **False**. Это предотвратит поиск ресурсов в классической виртуальной машине со стороны решения.

## <a name="scenarios"></a>Сценарии

Это решение содержит три разных сценария. Они приведены ниже.

### <a name="scenario-1-startstop-vms-on-a-schedule"></a>Сценарий 1. Запуск и остановка виртуальных машин по расписанию

Это конфигурация по умолчанию, используемая после первого развертывания решения. Например, можно настроить ее, чтобы останавливать все виртуальные машины в подписке вечером, когда вы уходите с работы, и запускать их утром, когда вы возвращаетесь в офис. Если настроить расписания **Scheduled-StartVM** и **Scheduled-StopVM** во время развертывания, они будут запускать и останавливать целевые виртуальные машины. Можно настроить это решение только для остановки виртуальных машин. Ознакомьтесь с разделом [Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия) в службе автоматизации Azure](#modify-the-startup-and-shutdown-schedules), чтобы узнать, как настроить пользовательское расписание.

> [!NOTE]
> Используется часовой пояс, указанный при настройке параметра времени расписания. Однако он хранится в службе автоматизации Azure в формате UTC. Нет необходимости преобразовывать часовой пояс, так как это делается во время развертывания.

Можно выбрать виртуальные машины в области действия с помощью переменных таких: **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames**.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.

#### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Настройте переменные **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** для указания целевых виртуальных машин.
2. Включите и обновите расписания **Scheduled-StartVM** и **Scheduled-StopVM**.
3. Запустите runbook **ScheduledStartStop_Parent**, указав для параметра ACTION значение **start**, а для параметра WHATIF — значение **True**, чтобы воспользоваться предварительным просмотром изменений.

#### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Запустите runbook **ScheduledStartStop_Parent**, указав для параметра ACTION значение **start**, добавьте разделенный запятыми список виртуальных машин в параметр *VMList* и укажите для параметра WHATIF значение **True**. Воспользуйтесь предварительным просмотром изменений.
1. Настройте параметр **External_ExcludeVMNames**, указав разделенный запятыми список виртуальных машин (ВМ1, ВМ2, ВМ3).
1. В этом сценарии переменные **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupnames** не учитываются. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

> [!NOTE]
> Значение переменной **Target ResourceGroup Names** (Имена целевых групп ресурсов) хранится в качестве значений переменных **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**. Чтобы увеличить степень детализации, можно изменить эти переменные для различных групп ресурсов. Для действия запуска используйте **External_Start_ResourceGroupNames**, а для действия остановки — **External_Stop_ResourceGroupNames**. Виртуальные машины автоматически добавляются в расписания запуска и остановки.

### <a name="scenario-2-startstop-vms-in-sequence-by-using-tags"></a>Сценарий 2. Последовательный запуск и остановка виртуальных машин с использованием тегов

В среде, которая включает в себя два или более компонентов, работающих на нескольких виртуальных машинах, которые поддерживают распределенную рабочую нагрузку, важно наличие поддержки последовательного запуска и остановки компонентов в нужном порядке. Чтобы обеспечить это, выполните следующие действия.

#### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Добавьте теги **sequencestart** и **sequencestop**, значением которых является положительное целое число, для виртуальных машин, указанных в переменных **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**. Действия запуска и остановки будут выполняться в порядке возрастания. Чтобы узнать, как добавить тег к виртуальной машине, ознакомьтесь с разделами [Пометка виртуальной машины Windows в Azure](../virtual-machines/windows/tag.md) и [Пометка виртуальной машины Linux в Azure](../virtual-machines/linux/tag.md).
1. Измените расписания **Sequenced-StartVM** и **Sequenced-StopVM**, указав даты и время в соответствии со своими требованиями, после чего включите эти расписания.
1. Запустите runbook **SequencedStartStop_Parent**, указав для параметра ACTION значение **start**, а для параметра WHATIF — значение **True**, чтобы воспользоваться предварительным просмотром изменений.
1. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, можно будет вручную запустить runbook с параметром, имеющим значение **False**. Можно также позволить автоматический запуск расписаний службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM**, которые вы задали.

#### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Добавьте теги **sequencestart** и **sequencestop** со значением в виде положительного целого числа для виртуальных машин, которые вы планируете добавить в параметр **VMList**.
1. Запустите runbook **SequencedStartStop_Parent**, указав для параметра ACTION значение **start**, добавьте разделенный запятыми список виртуальных машин в параметр *VMList* и укажите для параметра WHATIF значение **True**. Воспользуйтесь предварительным просмотром изменений.
1. Настройте параметр **External_ExcludeVMNames**, указав разделенный запятыми список виртуальных машин (ВМ1, ВМ2, ВМ3).
1. В этом сценарии переменные **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupnames** не учитываются. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).
1. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, можно будет вручную запустить monitoring-and-diagnostics/monitoring-action-groupsrunbook с параметром, имеющим значение **False**. Можно также разрешить автоматический запуск расписаний службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM**, которые вы задали.

### <a name="scenario-3-startstop-automatically-based-on-cpu-utilization"></a>Сценарий 3. Автоматический запуск и остановка на основе загрузки ЦП

Это решение поможет контролировать затраты на работающие виртуальные машины в подписке, оценивая виртуальные машины Azure, которые не используются в периоды небольшой нагрузки, например в нерабочее время, и автоматически завершая их работу в случае, если процент использования процессора меньше x %.

По умолчанию это решение предварительно настроено для оценки метрики "Загрузка ЦП", и оно проверяет, составляет ли средняя загрузка 5 % или меньше. Для управления сценарием используются следующие переменные, которые можно изменить, если их значения по умолчанию не удовлетворяют ваши требования:

- External_AutoStop_MetricName;
- External_AutoStop_Threshold;
- External_AutoStop_TimeAggregationOperator;
- External_AutoStop_TimeWindow.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.

#### <a name="target-the-stop-action-against-a-subscription-and-resource-group"></a>Нацеливание действия Stop на подписку и группу ресурсов

1. Настройте переменные **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** для указания целевых виртуальных машин.
1. Включите и обновите расписание **Schedule_AutoStop_CreateAlert_Parent**.
1. Запустите runbook **AutoStop_CreateAlert_Parent**, указав для параметра ACTION значение **start**, а для параметра WHATIF — значение **True**, чтобы воспользоваться предварительным просмотром изменений.

#### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Запустите runbook **AutoStop_CreateAlert_Parent**, указав для параметра ACTION значение **start**, добавьте разделенный запятыми список виртуальных машин в параметр *VMList* и укажите для параметра WHATIF значение **True**. Воспользуйтесь предварительным просмотром изменений.
1. Настройте параметр **External_ExcludeVMNames**, указав разделенный запятыми список виртуальных машин (ВМ1, ВМ2, ВМ3).
1. В этом сценарии переменные **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupnames** не учитываются. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

Теперь, имея расписание для остановки виртуальных машин в соответствии с загрузкой ЦП, необходимо включить одно из приведенных ниже расписания для запуска.

- Нацельте действие запуска на подписку и группу ресурсов. В [сценарии 1](#scenario-1-startstop-vms-on-a-schedule) приведены инструкции по тестированию и включению расписания **Scheduled-StartVM**. Ознакомьтесь с ними.
- Нацельте действие запуска на подписку, группу ресурсов и тег. В [сценарии 2](#scenario-2-startstop-vms-in-sequence-by-using-tags) приведены инструкции по тестированию и включению расписания **Sequenced-StartVM**. Ознакомьтесь с ними.

## <a name="solution-components"></a>Компоненты решения

Это решение включает в себя предварительно настроенные модули Runbook, расписания и интеграцию с журналами Azure Monitor, можно настроить запуск и завершение работы виртуальных машин в соответствии с потребностями бизнеса.

### <a name="runbooks"></a>Модули Runbook

В таблице ниже перечислены модули runbook, развертываемые в вашей учетной записи службы автоматизации данным решением. Не следует вносить изменения в код runbook. Вместо этого напишите собственный runbook для новых функциональных возможностей.

> [!IMPORTANT]
> Не следует напрямую запускать какой-либо runbook со словом "child" в имени.

Все родительские модули runbook содержат параметр _WhatIf_. Если параметр _WhatIf_ имеет значение **True**, то он обеспечивает подробное описание реакции runbook на событие при запуске без параметра _WhatIf_ и проверяет правильность выбора целевых виртуальных машин. Модули runbook выполняют определенные в них действия, только если параметр _WhatIf_ имеет значение **False**.

|Runbook | Параметры | Описание|
| --- | --- | ---|
|AutoStop_CreateAlert_Child | VMObject <br> AlertAction <br> WebHookURI | Вызывается из родительского runbook. Этот runbook создает оповещения для каждого ресурса для сценария AutoStop.|
|AutoStop_CreateAlert_Parent | VMList<br> WhatIf: Значение true или false  | Создает или обновляет правила генерации оповещений Azure для виртуальных машин в целевой подписке или группах ресурсов. <br> VMList список виртуальных машин с разделителями-запятыми. Например, _vm1, vm2, vm3_.<br> *WhatIf* проверяет логику runbook без выполнения.|
|AutoStop_Disable | нет | Отключает оповещения AutoStop и расписание по умолчанию.|
|AutoStop_StopVM_Child | WebHookData | Вызывается из родительского runbook. Правила генерации оповещений вызывают этот runbook, чтобы остановить виртуальную машину.|
|Bootstrap_Main | нет | Используется один раз для установки конфигураций начальной загрузки, например webhookURI, которые, как правило, недоступны в Azure Resource Manager. Этот runbook автоматически удаляется после успешного развертывания.|
|ScheduledStartStop_Child | VMName <br> Действие: Start или Stop <br> ResourceGroupName | Вызывается из родительского runbook. Выполняет действие Start или Stop для запланированной остановки.|
|ScheduledStartStop_Parent | Действие: Start или Stop <br>VMList <br> WhatIf: Значение true или false | Этот параметр влияет на все виртуальные машины в подписке. Измените **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**, ограничив выполнение только этими целевыми группами ресурсов. Можно также исключить определенные виртуальные машины, обновив переменную **External_ExcludeVMNames**.<br> VMList список виртуальных машин с разделителями-запятыми. Например, _vm1, vm2, vm3_.<br> _WhatIf_ проверяет логику runbook без выполнения.|
|SequencedStartStop_Parent | Действие: Start или Stop <br> WhatIf: Значение true или false<br>VMList| Создайте теги **sequencestart** и **sequencestop** для каждой виртуальной машины, для которой требуется использовать действие последовательного запуска и остановки. В именах этих тегов учитывается регистр. Значением тега должно быть положительное целое число (1, 2, 3 и т. д.), которое соответствует очередности запуска или остановки. <br> VMList список виртуальных машин с разделителями-запятыми. Например, _vm1, vm2, vm3_. <br> _WhatIf_ проверяет логику runbook без выполнения. <br> **Примечание**. Виртуальные машины должны находиться в группах ресурсов, определенных в таких переменных службы автоматизации Azure: External_Start_ResourceGroupNames, External_Stop_ResourceGroupNames и External_ExcludeVMNames. Чтобы эти действия выполнялись, они должны иметь соответствующие теги.|

### <a name="variables"></a>Переменные

В таблице ниже перечислены переменные, создаваемые в вашей учетной записи службы автоматизации. Следует изменять только переменные с префиксом **External**. Изменение переменных с префиксом **Internal** приведет к нежелательным последствиям.

|Переменная | Описание|
|---------|------------|
|External_AutoStop_Condition | Условный оператор, необходимый для настройки условия перед активацией оповещения. Допустимые значения: **GreaterThan**, **GreaterThanOrEqual**, **LessThan** и **LessThanOrEqual**.|
|External_AutoStop_Description | Оповещение для остановки виртуальной машины в случае, если процент использования ЦП превышает пороговое значение.|
|External_AutoStop_MetricName; | Имя метрики производительности, для которой настраивается правило генерации оповещений Azure.|
|External_AutoStop_Threshold; | Пороговое значение для правила генерации оповещений Azure, указанного в переменной _External_AutoStop_MetricName_. Процентные значения могут находиться в диапазоне от 1 до 100.|
|External_AutoStop_TimeAggregationOperator; | Оператор агрегата времени, который будет применяться к выбранному интервалу для оценки условия. Допустимые значения: **Average**, **Minimum**, **Maximum**, **Total** и **Last**.|
|External_AutoStop_TimeWindow. | Размер интервала, на котором Azure анализирует выбранные метрики для активации оповещения. Этот параметр принимает входные данные в формате временного диапазона. Допустимые значения составляют от 5 минут до 6 часов.|
|External_EnableClassicVMs| Указывает, являются ли классические виртуальные машины целевыми для решения. По умолчанию используется значение True. Для подписок CSP должно быть присвоено значение False.|
|External_ExcludeVMNames | Введите имена виртуальных машин, которые должны быть исключены, разделяя их запятыми без пробелов. Запускать можно до 140 виртуальных машин. Если в список, разделенный запятыми, будет добавлено более 140 виртуальных машин, то те, которые необходимо исключить, могут начать запускаться или выключаться в случайном порядке.|
|External_Start_ResourceGroupNames | Позволяет указать одну или несколько групп ресурсов через запятую для действий запуска.|
|External_Stop_ResourceGroupNames | Позволяет указать одну или несколько групп ресурсов через запятую для действий остановки.|
|Internal_AutomationAccountName | Задает имя учетной записи службы автоматизации Azure.|
|Internal_AutoSnooze_WebhookUri | Указывает универсальный код ресурса (URI) веб-перехватчика, вызываемого в сценарии AutoStop.|
|Internal_AzureSubscriptionId | Указывает идентификатор подписки Azure.|
|Internal_ResourceGroupName | Указывает имя группы ресурсов учетной записи службы автоматизации.|

Во всех сценариях переменные **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** необходимы для нацеливания на виртуальные машины, если только не предоставляется разделенный запятыми список виртуальных машин для модулей runbook **AutoStop_CreateAlert_Parent**, **SequencedStartStop_Parent** и **ScheduledStartStop_Parent**. То есть виртуальные машины должны находиться в целевых группах ресурсов, чтобы выполнялись действия запуска и остановки. Эта логика напоминает политику Azure тем, что можно выбрать целевую подписку или группу ресурсов, после чего действия будут наследоваться создаваемыми в ней виртуальными машинами. Такой подход позволяет избежать необходимости использовать отдельное расписание для каждой виртуальной машины и управлять запуском и остановкой в соответствующем масштабе.

### <a name="schedules"></a>Расписания

В таблице ниже перечислены расписания по умолчанию, создаваемые в вашей учетной записи службы автоматизации. Можно изменить их или создать собственные пользовательские расписания. По умолчанию все эти расписания отключены, за исключением **Scheduled_StartVM** и **Scheduled_StopVM**.

Не следует включать все расписания, так как это может привести к перекрытию действий расписаний. Лучше определить, какие оптимизации нужно выполнить, и внести соответствующие изменения. Дополнительные пояснения можно получить, ознакомившись с примерами сценариев в разделе "Обзор".

|Имя расписания | Frequency | Описание|
|--- | --- | ---|
|Schedule_AutoStop_CreateAlert_Parent | Каждые 8 часов | Каждые 8 часов запускает runbook AutoStop_CreateAlert_Parent, который, в свою очередь, останавливает виртуальные машины на основе значений переменных службы автоматизации Azure External_Start_ResourceGroupNames, External_Stop_ResourceGroupNames и External_ExcludeVMNames. Кроме того, можно указать разделенный запятыми список виртуальных машин с помощью параметра VMList.|
|Scheduled_StopVM | Определяется пользователем, ежедневно | Запускает runbook Scheduled_Parent с параметром _Stop_ каждый день в указанное время. Автоматически останавливает все виртуальные машины, удовлетворяющие правилам, определенным с помощью переменных ресурса. Включите связанное расписание **Scheduled-StartVM**.|
|Scheduled_StartVM | Определяется пользователем, ежедневно | Запускает runbook Scheduled_Parent с параметром _Start_ каждый день в указанное время. Автоматически запускает все виртуальные машины, соответствующие определенным правилам и указанные в соответствующих переменных. Включите связанное расписание **Scheduled-StopVM**.|
|Sequenced-StopVM | 01:00 (UTC), каждую пятницу | Запускает runbook Scheduled_Parent с параметром _Stop_ каждую пятницу в указанное время. Последовательно (по возрастанию) останавливает все виртуальные машины с тегом **SequenceStop**, которые указаны в соответствующих переменных. Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов. Включите связанное расписание **Sequenced-StartVM**.|
|Sequenced-StartVM | 13:00 (UTC), каждый понедельник | Запускает runbook Scheduled_Parent с параметром _Start_ каждый понедельник в указанное время. Последовательно (по убыванию) запускает все виртуальные машины с тегом **SequenceStart**, которые указаны в соответствующих переменных. Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов. Включите связанное расписание **Sequenced-StopVM**.|

## <a name="azure-monitor-logs-records"></a>Azure Monitor регистрирует записи

Служба автоматизации создает в рабочей области Log Analytics записи двух типов: журналы заданий и потоки заданий.

### <a name="job-logs"></a>Журналы заданий

|Свойство | Описание|
|----------|----------|
|Caller |  Сторона, инициировавшая операцию. Допустимые значения: электронный адрес или system для запланированных заданий.|
|Category | Классификация типа данных. Для службы автоматизации значением является JobLogs.|
|CorrelationId | GUID, представляющий собой идентификатор корреляции задания runbook.|
|JobId | GUID, представляющий собой идентификатор задания runbook.|
|operationName | Указывает тип операции, выполняемой в Azure. Для службы автоматизации значением является Job.|
|resourceId | Указывает тип ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
|ResourceGroup | Указывает имя группы ресурсов задания Runbook.|
|ResourceProvider | Указывает службу Azure, которая предоставляет ресурсы для развертывания и управления. Для службы автоматизации значением будет Azure Automation.|
|ResourceType | Указывает тип ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
|resultType | Состояние задания Runbook. Возможные значения:<br>Started<br>- Остановлена<br>Приостановлено<br>Сбой<br>- Succeeded.|
|resultDescription | Описывает состояние результата задания Runbook. Возможные значения:<br>— Job is started;<br>— Job Failed;<br>- Job Completed.|
|RunbookName | Указывает имя модуля Runbook.|
|SourceSystem | Указывает исходную систему для отправленных данных. Для службы автоматизации значением является OpsManager.|
|StreamType | Задает тип события. Возможные значения:<br>- Verbose.<br>— Output;<br>error<br>Предупреждение|
|SubscriptionId | Указывает идентификатор подписки задания.
|Время | Дата и время выполнения задания Runbook.|

### <a name="job-streams"></a>Потоки заданий

|Свойство | Описание|
|----------|----------|
|Caller |  Сторона, инициировавшая операцию. Допустимые значения: электронный адрес или system для запланированных заданий.|
|Category | Классификация типа данных. Для службы автоматизации значением является JobStreams.|
|JobId | GUID, представляющий собой идентификатор задания runbook.|
|operationName | Указывает тип операции, выполняемой в Azure. Для службы автоматизации значением является Job.|
|ResourceGroup | Указывает имя группы ресурсов задания Runbook.|
|resourceId | Указывает идентификатор ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
|ResourceProvider | Указывает службу Azure, которая предоставляет ресурсы для развертывания и управления. Для службы автоматизации значением будет Azure Automation.|
|ResourceType | Указывает тип ресурса в Azure. Для службы автоматизации значением является учетная запись службы автоматизации, связанная с Runbook.|
|resultType | Результат задания Runbook во время создания события. Возможное значение:<br>- InProgress.|
|resultDescription | Включает в себя выходной поток из Runbook.|
|RunbookName | Имя Runbook.|
|SourceSystem | Указывает исходную систему для отправленных данных. Для службы автоматизации значением является OpsManager.|
|StreamType | Тип потока задания. Возможные значения:<br>- Progress<br>Выходные данные<br>Предупреждение<br>error<br>debug<br>- Verbose.|
|Время | Дата и время выполнения задания Runbook.|

При выполнении поиска по журналам, в результате которого возвращаются записи категории **JobLogs** или **JobStreams**, можно выбрать представление **JobLogs** или **JobStreams**. Эти представления отображают набор элементов с перечнем обновлений, возвращенных в результатах поиска.

## <a name="sample-log-searches"></a>Пример поисков журналов

Следующая таблица содержит примеры поисков по журналу для получения записей заданий, собранных этим решением.

|Запрос | Описание|
|----------|----------|
|Поиск успешно выполненных заданий runbook ScheduledStartStop_Parent. | <code>search Category == "JobLogs" <br>&#124;  where ( RunbookName_s == "ScheduledStartStop_Parent" ) <br>&#124;  where ( ResultType == "Completed" )  <br>&#124;  summarize <br>&#124; AggregatedValue = count() by ResultType, bin(TimeGenerated, 1h) <br>&#124;  sort by TimeGenerated desc</code>|
|Поиск успешно выполненных заданий runbook SequencedStartStop_Parent. | <code>search Category == "JobLogs" <br>&#124;  where ( RunbookName_s == "SequencedStartStop_Parent" ) <br>&#124;  where ( ResultType == "Completed" ) <br>&#124;  summarize <br>&#124; AggregatedValue = count() by ResultType, bin(TimeGenerated, 1h) <br>&#124;  sort by TimeGenerated desc```|

## <a name="viewing-the-solution"></a>Просмотр решения

Чтобы получить доступ к решению, в учетной записи службы автоматизации в разделе **Связанные ресурсы** выберите **Рабочая область**. На странице log analytics, выберите **решения** под **Общие**. На странице **Решения** выберите решение **Start-Stop-VM[рабочая_область]** из списка.

При выборе решения отобразится страница решения **Start-Stop-VM[рабочая_область]**. В ней можно просмотреть важные сведения, в том числе элемент **StartStopVM**. Как и в рабочей области Log Analytics, в нем отображаются сведения о количестве заданий runbook, которые были запущены и завершены для решения, а также их графическое представление.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-portal-vmupdate-solution-01.png)

Здесь можно открыть рабочую область OMS для дальнейшего анализа записей заданий. Для этого следует щелкнуть элемент "Кольцо". На панели мониторинга решения отображается журнал заданий и предварительно определенные запросы поиска по журналам. Переключиться в расширенный портале log analytics для поиска с помощью запросов поиска.

## <a name="configure-email-notifications"></a>Настройка уведомлений по электронной почте

Чтобы изменить уведомления по электронной почте после развертывания решения, измените группу действий, созданную во время развертывания.  

> [!NOTE]
> Подписки в облаке Azure для государственных организаций не поддерживают функцию электронной почты этого решения.

На портале Azure выберите "Монитор" > "Группы действий". Выберите группу действий под названием **StartStop_VM_Notication**.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-monitor.png)

На странице **StartStop_VM_Notification** в разделе **Сведения** щелкните **Изменить сведения**. Откроется страница **Электронная почта, SMS, push-уведомление, голосовой вызов**. Измените адрес электронной почты и нажмите кнопку **ОК**, чтобы сохранить изменения.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/change-email.png)

Кроме того, можно добавить дополнительные действия в группу действий. Дополнительные сведения о группах действий см. в статье [Группы действий](../azure-monitor/platform/action-groups.md)

Ниже приведен пример сообщения электронной почты, которое отправляется, когда решение завершает работу виртуальных машин.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/email.png)

## <a name="add-exclude-vms"></a>Добавление и исключение виртуальных машин

Решение позволяет добавлять виртуальные машины, на которые будет нацелено решение, или явно исключать компьютеры для решения.

### <a name="add-a-vm"></a>Добавление виртуальной машины

Убедиться в том, что виртуальная машина входит в список целевых объектов решения для запуска и остановки, когда оно работает, можно несколькими способами.

* У каждого из родительских модулей [runbook](#runbooks) решения есть параметр **VMList**. Вы можете передать разделенный запятыми список имен виртуальных машин в этот параметр при планировании соответствующего родительского модуля runbook для вашей ситуации, и эти виртуальные машины будут включены как целевые при запуске решения.

* Чтобы выбрать несколько виртуальных машин, укажите для параметров **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames** имена групп ресурсов, содержащих виртуальные машины, которые необходимо запустить или остановить. Вы также можете указать для этих параметров значение `*`, чтобы запустить решение для всех групп ресурсов в подписке.

### <a name="exclude-a-vm"></a>Исключение виртуальной машины

Чтобы исключить виртуальную машину для решения, вы можете добавить ее к переменной **External_ExcludeVMNames**. Эта переменная является разделенным запятыми списком отдельных виртуальных машин, которые необходимо исключить для решения запуска и остановки. В этом списке можно использовать до 140 виртуальных машин. Если в список, разделенный запятыми, будет добавлено более 140 виртуальных машин, то те, которые необходимо исключить, могут начать запускаться или выключаться в случайном порядке.

## <a name="modify-the-startup-and-shutdown-schedules"></a>Изменение расписаний запуска и завершения работы

Действия по управлению расписанием запуска и завершения работы в этом решении аналогичны описанным в статье [Создание расписания для Runbook в службе автоматизации Azure](automation-schedules.md). Требуется отдельное расписание для запуска и остановки виртуальных машин.

Поддерживается настройка решения только для остановки виртуальных машин в определенное время. В этом сценарии вы просто создаете расписание **остановки** без расписания **запуска**. Для этого необходимо выполнить следующие действия.

1. Убедитесь, что вы добавили группы ресурсов для виртуальных машин, работу которых требуется завершить, в переменную **External_Stop_ResourceGroupNames**.
2. Создайте собственное расписание для времени завершения работы виртуальных машин.
3. Перейдите к runbook **ScheduledStartStop_Parent** и щелкните **Расписание**. Это позволит выбрать расписание, созданное на предыдущем шаге.
4. Выберите **Parameters and run settings** (Параметры и настройки запуска) и задайте для параметра ACTION значение Stop.
5. Нажмите кнопку **ОК** , чтобы сохранить изменения.

## <a name="update-the-solution"></a>Обновление решения

Если вы развернули предыдущую версию этого решения, потребуется сначала удалить его из учетной записи, а затем развернуть обновленный выпуск. Выполните инструкции по [удалению решения](#remove-the-solution), затем выполните приведенные выше действия, чтобы [развернуть решение](#deploy-the-solution).

## <a name="remove-the-solution"></a>Удаление решения

Если решение больше не нужно, его можно удалить из учетной записи службы автоматизации. При этом удаляются только модули runbook. Расписания или переменные, которые были созданы при добавлении решения, не удаляются. Эти ресурсы понадобится удалить вручную, если они не используются в других модулях runbook.

Чтобы удалить решение, сделайте следующее:

1. Используя свою учетную запись службы автоматизации, выберите **Рабочая область** на странице слева.
1. На странице **Решения** выберите решение **Start-Stop-VM[Workspace]**. На странице **VMManagementSolution[рабочая_область]** в меню щелкните **Удалить**.<br><br> ![Удаление решения VMManagement](media/automation-solution-vm-management/vm-management-solution-delete.png)
1. В окне **Удаление решения** подтвердите удаление решения.
1. Пока проверяются данные, ход удаления решения можно проверить в разделе **Уведомления** в меню. После того, как начнется процесс удаления решения, вы вернетесь на страницу **Решения**.

В ходе этого процесса рабочая область Log Analytics и учетная запись службы автоматизации не удаляются. Если вы не хотите сохранить рабочую область Log Analytics, необходимо удалить ее вручную. Это можно сделать на портале Azure.

1. На домашней странице портала Azure, выберите **рабочих областей Log Analytics**.
1. На **рабочих областей Log Analytics** странице, выберите рабочую область.
1. В меню, расположенном на странице параметров рабочей области, выберите **Удалить**.

Если вы не хотите сохранять компоненты учетной записи службы автоматизации Azure, удалите вручную каждый. Список модулей runbook, переменных и расписаний, созданных в решении, см. в разделе [Компоненты решения](#solution-components).

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о том, как создавать различные поисковые запросы и просматривать журналы заданий службы автоматизации с помощью журналов Azure Monitor, см. в разделе [при поиске по журналам в Azure Monitor журналы](../log-analytics/log-analytics-log-searches.md).
- Дополнительные сведения о выполнении модулей Runbook, отслеживании заданий модуля Runbook и других технических деталях см. в статье [Выполнение модуля Runbook в службе автоматизации Azure](automation-runbook-execution.md).
- Дополнительные сведения о журналах Azure Monitor и источниках собираемых данных см. в разделе [данные в хранилище Azure, сбор в Azure Monitor регистрирует Обзор](../azure-monitor/platform/collect-azure-metrics-logs.md).
