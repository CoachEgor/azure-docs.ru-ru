---
title: Решение "Запуск и остановка виртуальных машин в нерабочее время"
description: Это решение для управления VM запускает и останавливает виртуальные машины Azure по расписанию и активно отслеживает журналы Azure Monitor.
services: automation
ms.subservice: process-automation
ms.date: 04/01/2020
ms.topic: conceptual
ms.openlocfilehash: cef3176c99cd57ae229b602feb3c825081fcfe3e
ms.sourcegitcommit: 980c3d827cc0f25b94b1eb93fd3d9041f3593036
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2020
ms.locfileid: "80548374"
---
# <a name="startstop-vms-during-off-hours-solution-in-azure-automation"></a>Решение для запуска и остановки виртуальных машин в нерабочее время в службе автоматизации Azure

Решение Start/Stop VMs в нерабочее время начинается и останавливает виртуальные машины Azure по установленным пользователям и графиком, предоставляет информацию через журналы Azure Monitor и отправляет дополнительные электронные письма с помощью [групп действий.](../azure-monitor/platform/action-groups.md) В большинстве сценариев оно поддерживает виртуальные машины Azure Resource Manager и классические виртуальные машины. 

Чтобы использовать это решение с помощью Классических VMs, вам нужна учетная запись Classic RunAs, которая не создается по умолчанию. Для получения инструкций по созданию учетной записи Classic RunAs [см.](automation-create-standalone-account.md#classic-run-as-accounts)

> [!NOTE]
> Для поддержки новейших версий доступных модулей Azure обновлено решение Start/Stop VMs в нерабочее время.

Это решение предоставляет возможность децентрализованной экономичной автоматизации пользователям, которым необходимо снизить расходы на виртуальные машины. Это решение обеспечивает следующие возможности:

- [Расписание VMs, чтобы начать и остановить](automation-solution-vm-management-config.md#schedule).
- Расписание VMs для запуска и остановки в порядке возрастания [с помощью tags Azure](automation-solution-vm-management-config.md#tags) (не поддерживается для классических VM).
- Autostop VMs на основе [низкого использования процессора](automation-solution-vm-management-config.md#cpuutil).

Ниже приведены ограничения с текущим решением:

- С помощью этого решения можно управлять виртуальными машинами в любом регионе, но его можно использовать только в той же подписке, что и учетная запись службы автоматизации Azure.
- Это решение доступно в правительстве Azure и Azure в любом регионе, поддерживающем рабочее пространство для аналитики журналов, учетную запись Автоматизации Azure и оповещения. В настоящее время правительственные регионы Azure не поддерживают функциональность электронной почты.

> [!NOTE]
> Если вы используете решение для классических виртуальных машин, все виртуальные машины в каждой облачной службе будут обрабатываться последовательно. Виртуальные машины по-прежнему обрабатываются параллельно в разных облачных службах. Если у вас более 20 вм хи-х на облачный **ScheduledStartStop_Parent** сервис, мы рекомендуем создать несколько расписаний с родительской ScheduledStartStop_Parent и указать 20 ВМ за расписание. В свойствах расписания укажите в виде списка, разделенного запятой, имена VM в параметре **VMList.** В противном случае, если задание автоматизации для этого решения выполняется более трех часов, оно временно выгружается или останавливается в пределах [справедливой доли.](automation-runbook-execution.md#fair-share)
>
> Подписки поставщика облачных решений Azure (Azure CSP) поддерживают только модель Azure Resource Manager; в этой программе отсутствуют все службы, созданные с помощью других моделей. При выполнении решения для запуска и остановки могут возникнуть ошибки, так как в нем есть командлеты для управления классическими ресурсами. Дополнительные сведения о CSP см. в разделе [Комментарии](https://docs.microsoft.com/azure/cloud-solution-provider/overview/azure-csp-available-services). Если вы используете подписку CSP, после развертывания вам следует изменить [**External_EnableClassicVMs**](#variables) на **False**.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="prerequisites"></a>Предварительные требования

Аутентификация модулей runbook в этом решении осуществляется с помощью [учетной записи запуска от имени Azure](automation-create-runas-account.md). Этот метод аутентификации является предпочтительным, так как в нем используется сертификат, а не пароль, который может устареть или часто меняться.

Мы рекомендуем использовать отдельную учетную запись автоматизации для решения Start/Stop VM. Это связано с тем, что версии модулей Azure часто обновляются, и их параметры могут меняться. Решение Start/Stop VM не обновляется на той же каденции, поэтому оно может не работать с новыми версиями смдлетов, которые он использует. Мы также рекомендуем вам протестировать обновления модуля в учетной записи автоматизации тестирования до их импорта в вашем производственном аккаунте автоматизации (ы).

### <a name="permissions"></a>Разрешения

Есть определенные разрешения, которые пользователь должен развернуть Start/Stop VMs в нерабочее время решения. Эти разрешения отличаются при использовании заранее созданного рабочего пространства учетной записи автоматизации и анализа журналов или создания новых во время развертывания. Если вы являетесь участником подписки и глобальным администратором в клиенте Active Directory Azure, вам не нужно настраивать следующие разрешения. Если у вас нет этих прав или вам необходимо настроить пользовательскую роль, см.

#### <a name="pre-existing-automation-account-and-log-analytics-workspace"></a>Ранее существовавшие автоматизационные учетные записи и аналитики журналов

Для развертывания ВМ Start/Stop в нерабочее время в существующем рабочем пространстве учетной записи автоматизации и анализа журналов пользователю требуется следующее разрешение в **группе ресурсов.** Чтобы узнать больше [Custom roles for Azure resources](../role-based-access-control/custom-roles.md)о ролях, см.

| Разрешение | Область|
| --- | --- |
| Microsoft.Automation/automationAccounts/read | Группа ресурсов |
| Microsoft.Automation/automationAccounts/variables/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/schedules/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/runbooks/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/connections/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/certificates/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/modules/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/modules/read | Группа ресурсов |
| Microsoft.automation/automationAccounts/jobSchedules/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/jobs/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/jobs/read | Группа ресурсов |
| Microsoft.OperationsManagement/solutions/write | Группа ресурсов |
| Microsoft.OperationalInsights/рабочие пространства/з. | Группа ресурсов |
| Microsoft.Insights/diagnosticSettings/write | Группа ресурсов |
| Microsoft.Insights/ActionGroups/Write | Группа ресурсов |
| Microsoft.Insights/ActionGroups/read | Группа ресурсов |
| Microsoft.Resources/subscriptions/resourceGroups/read | Группа ресурсов |
| Microsoft.Resources/deployments/* | Группа ресурсов |

#### <a name="new-automation-account-and-a-new-log-analytics-workspace"></a>Новый счет автоматизации и новое рабочее пространство Log Analytics

Для развертывания ВМ Start/Stop в нерабочее время в новое рабочее пространство учетной записи автоматизации и аналитики журналов пользователю, развертывающим решение, нужны разрешения, определенные в предыдущем разделе, а также следующие разрешения:

- Со-администратор по подписке - Это только необходимо создать классический Run As account, если вы собираетесь управлять классическим VMs. [Классические учетные записи RunAs](automation-create-standalone-account.md#classic-run-as-accounts) больше не создаются по умолчанию.
- Участник роли **разработчика приложений** [Active Directory Azure.](../active-directory/users-groups-roles/directory-assign-admin-roles.md) Для получения дополнительной информации о настройке Run As Accounts [см. Разрешения на настройку учетных записей Run As.](manage-runas-account.md#permissions)
- Автор подписки или следующих разрешений.

| Разрешение |Область|
| --- | --- |
| Microsoft.Авторизация/Операции/читай | Подписка|
| Microsoft.Authorization/permissions/read |Подписка|
| Microsoft.Authorization/roleAssignments/read | Подписка |
| Microsoft.Authorization/roleAssignments/write. | Подписка |
| Microsoft.Authorization/roleAssignments/delete | Подписка |
| Microsoft.Automation/automationAccounts/connections/read | Группа ресурсов |
| Microsoft.Automation/automationAccounts/certificates/read | Группа ресурсов |
| Microsoft.Automation/automationAccounts/write | Группа ресурсов |
| Microsoft.OperationalInsights/workspaces/write | Группа ресурсов |

## <a name="solution-components"></a>Компоненты решения

Это решение включает в себя предварительно настроенные руны, расписания и интеграцию с журналами Azure Monitor, чтобы вы могли адаптировать запуск и выключение виртуальных компьютеров в соответствии с потребностями вашего бизнеса.

### <a name="runbooks"></a>Модули runbook

В таблице ниже перечислены модули runbook, развертываемые в вашей учетной записи службы автоматизации данным решением. Не следует вносить изменения в код runbook. Вместо этого напишите собственный runbook для новых функциональных возможностей.

> [!IMPORTANT]
> Не запускайте непосредственно ни одного запуска с *ребенком,* придативаемым к его названию.

Все родительские модули runbook содержат параметр _WhatIf_. Если параметр _WhatIf_ имеет значение **True**, то он обеспечивает подробное описание реакции runbook на событие при запуске без параметра _WhatIf_ и проверяет правильность выбора целевых виртуальных машин. Модули runbook выполняют определенные в них действия, только если параметр _WhatIf_ имеет значение **False**.

|Модуль Runbook | Параметры | Описание|
| --- | --- | ---|
|AutoStop_CreateAlert_Child | VMObject <br> AlertAction <br> WebHookURI | Вызывается из родительского runbook. Этот runbook создает оповещения для каждого ресурса для сценария AutoStop.|
|AutoStop_CreateAlert_Parent | VMList<br> WhatIf: true или false.  | Создает или обновляет правила генерации оповещений Azure для виртуальных машин в целевой подписке или группах ресурсов. <br> VMList: разделенный запятыми список виртуальных машин. Например, _vm1, vm2, vm3_.<br> *WhatIf* проверяет логику runbook без выполнения.|
|AutoStop_Disable | none | Отключает оповещения AutoStop и расписание по умолчанию.|
|AutoStop_VM_Child | WebHookData | Вызывается из родительского runbook. Правила оповещения называют эту книгу, чтобы остановить классический VM.|
|AutoStop_VM_Child_ARM | WebHookData |Вызывается из родительского runbook. Правила генерации оповещений вызывают этот runbook, чтобы остановить виртуальную машину.  |
|ScheduledStartStop_Base_Classic; | CloudServiceName<br> Действие: Start или Stop<br> VMList  | Этот runbook используется для выполнения действий запуска или остановки в классической группе VM облачных служб.<br> VMList: разделенный запятыми список виртуальных машин. Например, _vm1, vm2, vm3_. |
|ScheduledStartStop_Child | VMName <br> Действие: Start или Stop <br> ResourceGroupName | Вызывается из родительского runbook. Выполняет действие Start или Stop для запланированной остановки.|
|ScheduledStartStop_Child_Classic; | VMName<br> Действие: Start или Stop<br> ResourceGroupName | Вызывается из родительского runbook. Выполняет действие старта или остановки для запланированной остановки для классических VMs. |
|ScheduledStartStop_Parent | Действие: Start или Stop <br>VMList <br> WhatIf: true или false. | Этот параметр влияет на все виртуальные машины в подписке. Измените **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**, ограничив выполнение только этими целевыми группами ресурсов. Можно также исключить определенные виртуальные машины, обновив переменную **External_ExcludeVMNames**.<br> VMList: разделенный запятыми список виртуальных машин. Например, _vm1, vm2, vm3_.<br> _WhatIf_ проверяет логику runbook без выполнения.|
|SequencedStartStop_Parent | Действие: Start или Stop <br> WhatIf: true или false.<br>VMList| Создавайте теги с именем **sequencestart** и **sequencestop** на каждом VM, для которого вы хотите последовательности начала / остановки деятельности. В именах этих тегов учитывается регистр. Значением тега должно быть положительное целое число (1, 2, 3 и т. д.), которое соответствует очередности запуска или остановки. <br> VMList: разделенный запятыми список виртуальных машин. Например, _vm1, vm2, vm3_. <br> _WhatIf_ проверяет логику runbook без выполнения. <br> **Примечание**. Виртуальные машины должны находиться в группах ресурсов, определенных в переменных службы автоматизации Azure External_Start_ResourceGroupNames, External_Stop_ResourceGroupNames и External_ExcludeVMNames. Чтобы эти действия выполнялись, они должны иметь соответствующие теги.|

### <a name="variables"></a>Переменные

В таблице ниже перечислены переменные, создаваемые в вашей учетной записи службы автоматизации. Следует изменять только переменные с префиксом **External**. Изменение переменных с префиксом **Internal** приведет к нежелательным последствиям.

|Переменная | Описание|
|---------|------------|
|External_AutoStop_Condition | Условный оператор, необходимый для настройки условия перед активацией оповещения. Допустимые значения: **GreaterThan**, **GreaterThanOrEqual**, **LessThan** и **LessThanOrEqual**.|
|External_AutoStop_Description | Оповещение для остановки виртуальной машины в случае, если процент использования ЦП превышает пороговое значение.|
|External_AutoStop_Frequency | Частота оценки для правила. Этот параметр принимает входные данные в формате временного диапазона. Возможные значения от 5 минут до 6 часов. |
|External_AutoStop_MetricName; | Имя метрики производительности, для которой настраивается правило генерации оповещений Azure.|
|External_AutoStop_Severity | Тяжесть метрика-оповещения, которая может варьироваться от 0 до 4. |
|External_AutoStop_Threshold; | Пороговое значение для правила генерации оповещений Azure, указанного в переменной _External_AutoStop_MetricName_. Процентные значения могут находиться в диапазоне от 1 до 100.|
|External_AutoStop_TimeAggregationOperator; | Оператор агрегата времени, который будет применяться к выбранному интервалу для оценки условия. Допустимые значения: **Average**, **Minimum**, **Maximum**, **Total** и **Last**.|
|External_AutoStop_TimeWindow. | Размер интервала, на котором Azure анализирует выбранные метрики для активации оповещения. Этот параметр принимает входные данные в формате временного диапазона. Допустимые значения составляют от 5 минут до 6 часов.|
|External_EnableClassicVMs| Указывает, являются ли классические виртуальные машины целевыми для решения. По умолчанию используется значение True. Для подписок CSP должно быть присвоено значение False. Классические VMs требуют [классический Run-As счета](automation-create-standalone-account.md#classic-run-as-accounts).|
|External_ExcludeVMNames | Введите имена виртуальных машин, которые должны быть исключены, разделяя их запятыми без пробелов. Запускать можно до 140 виртуальных машин. Если вы добавите более 140 ВМ в этот список, разделенный на запятую, вибрируют, которые будут исключены, могут быть непреднамеренно запущены или остановлены.|
|External_Start_ResourceGroupNames | Позволяет указать одну или несколько групп ресурсов через запятую для действий запуска.|
|External_Stop_ResourceGroupNames | Позволяет указать одну или несколько групп ресурсов через запятую для действий остановки.|
|External_WaitTimeForVMRetrySeconds |Время ожидания в секундах для действий, которые будут выполнены на VMs для последовательного запуска / остановки runbook.<br> Значение по умолчанию составляет 2100 секунд и поддерживает настройку до максимального значения 10800 или три часа.|
|Internal_AutomationAccountName | Задает имя учетной записи службы автоматизации Azure.|
|Internal_AutoSnooze_ARM_WebhookURI | Специфика Webhook URI призвал к сценарию AutoStop для классических VMs.|
|Internal_AutoSnooze_WebhookUri | Указывает универсальный код ресурса (URI) веб-перехватчика, вызываемого в сценарии AutoStop.|
|Internal_AzureSubscriptionId | Указывает идентификатор подписки Azure.|
|Internal_ResourceGroupName | Указывает имя группы ресурсов учетной записи службы автоматизации.|

>[!NOTE]
>Для переменной **External_WaitTimeForVMRetryInSeconds**значение по умолчанию было обновлено с 600 до 2100. Эта переменная позволяет runbook **сценария запуска/остановки Sequenced** ждать операции ребенка в течение определенного количества секунд, прежде чем приступить к следующему действию.
>

Во всех сценариях переменные **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** необходимы для нацеливания на виртуальные машины, если только не предоставляется разделенный запятыми список виртуальных машин для модулей runbook **AutoStop_CreateAlert_Parent**, **SequencedStartStop_Parent** и **ScheduledStartStop_Parent**. То есть виртуальные машины должны находиться в целевых группах ресурсов, чтобы выполнялись действия запуска и остановки. Эта логика напоминает политику Azure тем, что можно выбрать целевую подписку или группу ресурсов, после чего действия будут наследоваться создаваемыми в ней виртуальными машинами. Такой подход позволяет избежать необходимости использовать отдельное расписание для каждой виртуальной машины и управлять запуском и остановкой в соответствующем масштабе.

### <a name="schedules"></a>Расписания

В таблице ниже перечислены расписания по умолчанию, создаваемые в вашей учетной записи службы автоматизации.Можно изменить их или создать собственные пользовательские расписания.По умолчанию все эти расписания отключены, за исключением **Scheduled_StartVM** и **Scheduled_StopVM**.

Не следует включать все расписания, так как это может привести к перекрытию действий расписаний. Лучше определить, какие оптимизации нужно выполнить, и внести соответствующие изменения. Дополнительные пояснения можно получить, ознакомившись с примерами сценариев в разделе "Обзор".

|Имя расписания | Частота | Описание|
|--- | --- | ---|
|Schedule_AutoStop_CreateAlert_Parent | Каждые 8 часов | Каждые 8 часов запускает runbook AutoStop_CreateAlert_Parent, который, в свою очередь, останавливает виртуальные машины на основе значений переменных службы автоматизации Azure External_Start_ResourceGroupNames, External_Stop_ResourceGroupNames и External_ExcludeVMNames. Кроме того, можно указать разделенный запятыми список виртуальных машин с помощью параметра VMList.|
|Scheduled_StopVM | Определяется пользователем, ежедневно | Запускает runbook Scheduled_Parent с параметром _Stop_ каждый день в указанное время.Автоматически останавливает все виртуальные машины, удовлетворяющие правилам, определенным с помощью переменных ресурса.Включите связанное расписание **Scheduled-StartVM**.|
|Scheduled_StartVM | Определяется пользователем, ежедневно | Запускает runbook Scheduled_Parent с параметром _Start_ каждый день в указанное время. Автоматически запускает все виртуальные машины, соответствующие определенным правилам и указанные в соответствующих переменных.Включите связанное расписание **Scheduled-StopVM**.|
|Sequenced-StopVM | 01:00 (UTC), каждую пятницу | Запускает runbook Scheduled_Parent с параметром _Stop_ каждую пятницу в указанное время.Последовательно (по возрастанию) останавливает все виртуальные машины с тегом **SequenceStop**, которые указаны в соответствующих переменных. Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов.Включите связанное расписание **Sequenced-StartVM**.|
|Sequenced-StartVM | 13:00 (UTC), каждый понедельник | Запускает runbook Scheduled_Parent с параметром _Start_ каждый понедельник в указанное время. Последовательно (по убыванию) запускает все виртуальные машины с тегом **SequenceStart**, которые указаны в соответствующих переменных. Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов. Включите связанное расписание **Sequenced-StopVM**.|

## <a name="enable-the-solution"></a>Включение решения

Чтобы начать использовать решение, выполните шаги в [решении Enable Start/Stop VMs.](automation-solution-vm-management-enable.md)

## <a name="viewing-the-solution"></a>Просмотр решения

Вы можете получить доступ к решению после включения его с одного из следующих способов:

* Из учетной записи автоматизации выберите **Start/Stop VM** под **похожими ресурсами.** На странице **Start/Stop VM** выберите **решение** с правой стороны страницы под разделом **Manage Start/Stop VM Solutions.**

* Перейдите к рабочей области Log Analytics, связанной с учетной записью Автоматизация, и после выбора рабочего пространства выберите **Решения** из левого стекла. На странице **«Решения»** выберите из списка решение **Start-Stop-VM.'workspace.**  

При выборе решения отобразится страница решения **Start-Stop-VM[рабочая_область]**. В ней можно просмотреть важные сведения, в том числе элемент **StartStopVM**. Как и в рабочей области Log Analytics, в нем отображаются сведения о количестве заданий runbook, которые были запущены и завершены для решения, а также их графическое представление.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-portal-vmupdate-solution-01.png)

Здесь можно открыть рабочую область OMS для дальнейшего анализа записей заданий. Для этого следует щелкнуть элемент "Кольцо". На панели мониторинга решения отображается журнал заданий и предварительно определенные запросы поиска по журналам. Переключитесь на расширенный портал анализа журналов для поиска на основе поисковых запросов.

## <a name="update-the-solution"></a>Обновление решения

Если вы развернули предыдущую версию этого решения, потребуется сначала удалить его из учетной записи, а затем развернуть обновленный выпуск. Выполните шаги, чтобы [удалить решение,](#remove-the-solution) а затем следовать шагам для [развертывания решения.](automation-solution-vm-management-enable.md)

## <a name="remove-the-solution"></a>Удаление решения

Если решение больше не нужно, его можно удалить из учетной записи службы автоматизации. При этом удаляются только модули runbook. Расписания или переменные, которые были созданы при добавлении решения, не удаляются. Эти ресурсы понадобится удалить вручную, если они не используются в других модулях runbook.

Чтобы удалить решение, сделайте следующее:

1. Из учетной записи Automation, под **соответствующими ресурсами,** выберите **связанное рабочее пространство.**

2. Выберите **Перейти к рабочему пространству.**

3. Под **общим**, выберите **Решения**. 

4. На странице **Решения** выберите решение **Start-Stop-VM[Workspace]**. На странице **VMManagementSolution[рабочая_область]** в меню щелкните **Удалить**.<br><br> ![Удаление решения VMManagement](media/automation-solution-vm-management/vm-management-solution-delete.png)

5. В окне **Удаление решения** подтвердите удаление решения.

6. Пока проверяются данные, ход удаления решения можно проверить в разделе **Уведомления** в меню. После того, как начнется процесс удаления решения, вы вернетесь на страницу **Решения**.

В ходе этого процесса рабочая область Log Analytics и учетная запись службы автоматизации не удаляются. Если вы не хотите сохранить рабочую область Log Analytics, необходимо удалить ее вручную. Это можно сделать на портале Azure.

1. На портале Azure поиск и выбор **рабочих областей анализа журналов.**

2. На странице **рабочих областей анализа журналов** выберите рабочее пространство.

3. В меню, расположенном на странице параметров рабочей области, выберите **Удалить**.

Если вы не хотите сохранять компоненты учетной записи службы автоматизации Azure, удалите вручную каждый. Список модулей runbook, переменных и расписаний, созданных в решении, см. в разделе [Компоненты решения](#solution-components).

## <a name="next-steps"></a>Дальнейшие действия

[Включите](automation-solution-vm-management-enable.md) решение Start/Stop в нерабочее время для ваших VMs-м вне умов.
