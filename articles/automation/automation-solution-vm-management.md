---
title: Запуск/остановка ВМ в нерабочее время решения
description: Это решение для управления VM запускает и останавливает виртуальные машины Azure по расписанию и активно отслеживает журналы Azure Monitor.
services: automation
ms.subservice: process-automation
ms.date: 04/01/2020
ms.topic: conceptual
ms.openlocfilehash: 968e609772e08814a9943734d30c16bf6f5972e8
ms.sourcegitcommit: 5e49f45571aeb1232a3e0bd44725cc17c06d1452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81604712"
---
# <a name="startstop-vms-during-off-hours-solution-in-azure-automation"></a>Запуск/остановка ВМ во время работы в нерабочее время в Azure Automation

Решение **Start/stop VMs в нерабочее время** запускает или останавливает виртуальные машины Azure. Он запускает или останавливает машины по определенным для пользователя графикам, предоставляет информацию через журналы Azure Monitor и отправляет дополнительные электронные письма с помощью [групп действий.](../azure-monitor/platform/action-groups.md) Решение поддерживает как менеджер ресурсов Azure, так и классические вс-предысхвай для большинства сценариев. 

Это решение предоставляет возможность децентрализованной экономичной автоматизации пользователям, которым необходимо снизить расходы на виртуальные машины. Это решение обеспечивает следующие возможности:

- [Расписание VMs, чтобы начать и остановить](automation-solution-vm-management-config.md#schedule).
- Расписание VMs для запуска и остановки в порядке возрастания [с помощью tags Azure](automation-solution-vm-management-config.md#tags) (не поддерживается для классических VM).
- Autostop VMs на основе [низкого использования процессора](automation-solution-vm-management-config.md#cpuutil).

> [!NOTE]
> Для поддержки новейших версий доступных модулей Azure обновлено решение **Start/stop VMs в нерабочее время.**

Ниже приведены ограничения с текущим решением:

- Он управляет ввосай-мисами в любом регионе, но может использоваться только в той же подписке, что и ваша учетная запись Azure Automation.
- Он доступен в правительстве Azure и Azure в любом регионе, поддерживающем рабочее пространство для аналитики журналов, учетную запись автоматизации Azure и оповещения. В настоящее время правительственные регионы Azure не поддерживают функциональность электронной почты.

## <a name="solution-prerequisites"></a>Предпосылки решения

Аутентификация модулей runbook в этом решении осуществляется с помощью [учетной записи запуска от имени Azure](automation-create-runas-account.md). Учетная запись Run As является предпочтительным методом проверки подлинности, поскольку она использует проверку подлинности сертификата вместо пароля, который может истечь или часто изменяться.

Мы рекомендуем использовать отдельную учетную запись Автоматизации для решения **Start/stop VMs в нерабочее время.** Версии модулей Azure часто обновляются, и их параметры могут меняться. Решение не обновляется на той же каденции, и оно может не работать с новыми версиями cmdlets, которые он использует. Рекомендуется тестировать обновления модулей в учетной записи автоматизации тестирования, прежде чем импортировать их в свою учетную запись автоматизации производства(ы).

## <a name="solution-permissions"></a>Разрешения на решение

Вы должны иметь определенные разрешения на развертывание **ВМ-класса Start/stop в нерабочее время.** Разрешения отличаются, если в решении используется заранее созданная учетная запись Automation и рабочее пространство Log Analytics из необходимых разрешений, если решение создает новую учетную запись и рабочее пространство во время развертывания. 

Вам не нужно настраивать разрешения, если вы являетесь участником подписки и глобальным администратором в вашем арендаторе Active Directory Azure. Если у вас нет этих прав или вам необходимо настроить пользовательскую роль, убедитесь, что у вас есть разрешения, описанные ниже.

### <a name="permissions-for-pre-existing-automation-account-and-log-analytics-workspace"></a>Разрешения для уже существующих рабочих учетных записей автоматизации и анализа журналов

Для развертывания **ВМ Start/Stop в нерабочее время** в существующее рабочее пространство учетной записи Автоматизации и Log Analytics пользователю требуется следующее разрешение в области ресурсов. Чтобы узнать больше [Custom roles for Azure resources](../role-based-access-control/custom-roles.md)о ролях, см.

| Разрешение | Область|
| --- | --- |
| Microsoft.Automation/automationAccounts/read | Группа ресурсов |
| Microsoft.Automation/automationAccounts/variables/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/schedules/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/runbooks/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/connections/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/certificates/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/modules/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/modules/read | Группа ресурсов |
| Microsoft.automation/automationAccounts/jobSchedules/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/jobs/write | Группа ресурсов |
| Microsoft.Automation/automationAccounts/jobs/read | Группа ресурсов |
| Microsoft.OperationsManagement/solutions/write | Группа ресурсов |
| Microsoft.OperationalInsights/рабочие пространства/з. | Группа ресурсов |
| Microsoft.Insights/diagnosticSettings/write | Группа ресурсов |
| Microsoft.Insights/ActionGroups/Write | Группа ресурсов |
| Microsoft.Insights/ActionGroups/read | Группа ресурсов |
| Microsoft.Resources/subscriptions/resourceGroups/read | Группа ресурсов |
| Microsoft.Resources/deployments/* | Группа ресурсов |

### <a name="permissions-for-new-automation-account-and-new-log-analytics-workspace"></a>Разрешения на новую учетную запись автоматизации и новое рабочее пространство Log Analytics

Вы можете развернуть **VMs-технологий Start/stop в нерабочее время** в новое рабочее пространство учетной записи Automation и Log Analytics. В этом случае пользователю, развертывавшему решение, нужны разрешения, определенные в предыдущем разделе, а также разрешения, определенные в этом разделе. 

Пользователю, развертывая решение, нужны следующие роли:

- Коадминистратор по подписке. Эта роль необходима для создания учетной записи Classic Run As, если вы собираетесь управлять классическими VMs. [Аккаунты Classic Run As](automation-create-standalone-account.md#create-a-classic-run-as-account) больше не создаются по умолчанию.
- Членство в роли разработчика [приложений active Directory Azure.](../active-directory/users-groups-roles/directory-assign-admin-roles.md) Для получения дополнительной информации о настройке Run As Accounts [см. Разрешения на настройку учетных записей Run As.](manage-runas-account.md#permissions)
- Автор подписки или следующих разрешений.

| Разрешение |Область|
| --- | --- |
| Microsoft.Авторизация/Операции/читай | Подписка|
| Microsoft.Authorization/permissions/read |Подписка|
| Microsoft.Authorization/roleAssignments/read | Подписка |
| Microsoft.Authorization/roleAssignments/write. | Подписка |
| Microsoft.Authorization/roleAssignments/delete | Подписка |
| Microsoft.Automation/automationAccounts/connections/read | Группа ресурсов |
| Microsoft.Automation/automationAccounts/certificates/read | Группа ресурсов |
| Microsoft.Automation/automationAccounts/write | Группа ресурсов |
| Microsoft.OperationalInsights/workspaces/write | Группа ресурсов |

## <a name="solution-components"></a>Компоненты решения

Решение **Start/stop VMs в нерабочее время** включает в себя предварительно настроенные руны, расписания и интеграцию с журналами Azure Monitor. Эти элементы можно использовать для адаптации запуска и выключения вашего ввоза в соответствии с потребностями вашего бизнеса.

### <a name="runbooks"></a>Модули runbook

В следующей таблице перечислены книги, развернутые в учетной записи Автоматизации. НЕ внося изменений в код runbook. Вместо этого напишите собственный runbook для новых функциональных возможностей.

> [!IMPORTANT]
> Не запускайте непосредственно любой runbook с **ребенком,** придативаемым к его имени.

Все родительские runbooks включают параметр. `WhatIf` При установке на True параметр поддерживает точное поведение, которое принимает runbook при запуске без параметра, и проверяет, что правильные ВМ являются целевыми. Запуск выполняет свои определенные действия `WhatIf` только тогда, когда параметр установлен на ложный.

|Модуль Runbook | Параметры | Описание|
| --- | --- | ---|
|AutoStop_CreateAlert_Child | VMObject <br> AlertAction <br> WebHookURI | Вызывается из родительского runbook. Этот runbook создает оповещения на основе ресурсов для сценария Auto-Stop.|
|AutoStop_CreateAlert_Parent | VMList<br> WhatIf: true или false.  | Создает или обновляет правила генерации оповещений Azure для виртуальных машин в целевой подписке или группах ресурсов. <br> `VMList`— список VM, разделенный запятой. Например, `vm1, vm2, vm3`.<br> `WhatIf`позволяет проверить логику runbook без выполнения.|
|AutoStop_Disable | None | Отстраняет оповещения Auto-Stop и расписание по умолчанию.|
|AutoStop_VM_Child | WebHookData | Вызывается из родительского runbook. Правила оповещения называют эту книгу, чтобы остановить классический VM.|
|AutoStop_VM_Child_ARM | WebHookData |Вызывается из родительского runbook. Правила оповещения называют эту книгу, чтобы остановить VM.  |
|ScheduledStartStop_Base_Classic; | CloudServiceName<br> Действие: Start или Stop<br> VMList  | Выполняет действие старт а установят или останавливают в классической группе VM облачными службами. |
|ScheduledStartStop_Child | VMName <br> Действие: Start или Stop <br> ResourceGroupName | Вызывается из родительского runbook. Выполняет действие Start или Stop для запланированной остановки.|
|ScheduledStartStop_Child_Classic; | VMName<br> Действие: Start или Stop<br> ResourceGroupName | Вызывается из родительского runbook. Выполняет действие старта или остановки для запланированной остановки для классических VMs. |
|ScheduledStartStop_Parent | Действие: Start или Stop <br>VMList <br> WhatIf: true или false. | Запускает или останавливает все вмхоза в подписке. Отспособите `External_Start_ResourceGroupNames` переменные и `External_Stop_ResourceGroupNames` выполняйте только эти целевые группы ресурсов. Вы также можете исключить определенные `External_ExcludeVMNames` VMs путем обновления переменной.|
|SequencedStartStop_Parent | Действие: Start или Stop <br> WhatIf: true или false.<br>VMList| Создает теги, названные **sequencestart** и **sequencestop** на каждом VM, для которого вы хотите последовательности начала / остановки деятельности. В именах этих тегов учитывается регистр. Значением тега должно быть положительное целое число (1, 2, 3 и т. д.), которое соответствует очередности запуска или остановки. <br>**Примечание:** ВМ должны находиться `External_Start_ResourceGroupNames`в `External_Stop_ResourceGroupNames`группах ресурсов, определенных в и `External_ExcludeVMNames` переменных. Чтобы эти действия выполнялись, они должны иметь соответствующие теги.|

### <a name="variables"></a>Переменные

В таблице ниже перечислены переменные, создаваемые в вашей учетной записи службы автоматизации. Только изменить переменные `External`префиксированные с . Изменение переменных, закрепленных с `Internal` нежелательными последствиями.

> [!NOTE]
> Ограничения на имя ВМ и группу ресурсов в значительной степени являются результатом переменного размера.

|Переменная | Описание|
|---------|------------|
|External_AutoStop_Condition | Условный оператор, необходимый для настройки условия перед активацией оповещения. Приемлемые `GreaterThan` `GreaterThanOrEqual`значения, `LessThan`и `LessThanOrEqual`.|
|External_AutoStop_Description | Оповещение для остановки виртуальной машины в случае, если процент использования ЦП превышает пороговое значение.|
|External_AutoStop_Frequency | Частота оценки для правила. Этот параметр принимает входные данные в формате временного диапазона. Допустимые значения составляют от 5 минут до 6 часов. |
|External_AutoStop_MetricName; | Имя метрики производительности, для которой настраивается правило генерации оповещений Azure.|
|External_AutoStop_Severity | Тяжесть метрика-оповещения, которая может варьироваться от 0 до 4. |
|External_AutoStop_Threshold; | Порог для правила Azure Alert, `External_AutoStop_MetricName`указанный в переменной. Процентные значения варьируются от 1 до 100.|
|External_AutoStop_TimeAggregationOperator; | Оператор агрегации времени применяется к выбранному размеру окна для оценки состояния. Приемлемые `Average` `Minimum`значения, `Maximum` `Total`, `Last`, и .|
|External_AutoStop_TimeWindow. | Размер окна, в течение которого Azure анализирует выбранные метрики для запуска оповещения. Этот параметр принимает входные данные в формате временного диапазона. Допустимые значения составляют от 5 минут до 6 часов.|
|External_EnableClassicVMs| Значение, определяющее, если классические ВМ ориентированы на решение. По умолчанию используется значение True. Установите эту переменную на ложную для подписчиков поставщика облачных решений Azure (CSP). Классические VMs требуют [классический Run Как учетная запись](automation-create-standalone-account.md#create-a-classic-run-as-account).|
|External_ExcludeVMNames | Запятый разделенный список имен VM, чтобы исключить, ограниченный 140 VMs. Если вы добавите в список более 140 вм, вмхозание могут быть непреднамеренно запущены или остановлены.|
|External_Start_ResourceGroupNames | Список отдельных групп ресурсов, разделенных запятой, которые предназначены для начала действий.|
|External_Stop_ResourceGroupNames | Список отдельных групп ресурсов, разделенных запятой, которые предназначены для действий остановки.|
|External_WaitTimeForVMRetrySeconds |Время ожидания в секундах для действий, которые будут выполняться на вс-чатах для **SequencedStartStop_Parent** runbook. Эта переменная позволяет runbook ждать операции ребенка в течение определенного количества секунд, прежде чем приступить к следующему действию. Максимальное время ожидания 10800, или три часа. Значение по умолчанию составляет 2100 секунд.|
|Internal_AutomationAccountName | Задает имя учетной записи службы автоматизации Azure.|
|Internal_AutoSnooze_ARM_WebhookURI | Webhook URI призвал к сценарию AutoStop для VMs.|
|Internal_AutoSnooze_WebhookUri | Webhook URI призвал к сценарию AutoStop для классических VMs.|
|Internal_AzureSubscriptionId | Идентификатор подписки Azure.|
|Internal_ResourceGroupName | Имя группы ресурсов учетной записи Automation.|

>[!NOTE]
>Для переменной `External_WaitTimeForVMRetryInSeconds`значение по умолчанию было обновлено с 600 до 2100. 

Во всех сценариях `External_Start_ResourceGroupNames` `External_Stop_ResourceGroupNames`переменные `External_ExcludeVMNames` и необходимы для таргетинга на ВМ, за исключением запятой, разделенных списков VM для **AutoStop_CreateAlert_Parent,** **SequencedStartStop_Parent**и **ScheduledStartStop_Parent** runbooks. То есть ваши ВМ должны принадлежать целевым группам ресурсов для запуска и остановки действий. Эта логика напоминает политику Azure тем, что можно выбрать целевую подписку или группу ресурсов, после чего действия будут наследоваться создаваемыми в ней виртуальными машинами. Такой подход позволяет избежать необходимости использовать отдельное расписание для каждой виртуальной машины и управлять запуском и остановкой в соответствующем масштабе.

### <a name="schedules"></a>Расписания

В таблице ниже перечислены расписания по умолчанию, создаваемые в вашей учетной записи службы автоматизации.Можно изменить их или создать собственные пользовательские расписания.По умолчанию все расписания отключены, за исключением **Scheduled_StartVM** и **Scheduled_StopVM** расписаний.

Не включайте все расписания, так как это может привести к перекрывающимся действиям графика. Лучше всего определить, какие оптимизации вы хотите сделать, и изменить их соответствующим образом. Дополнительные пояснения можно получить, ознакомившись с примерами сценариев в разделе "Обзор".

|Имя расписания | Частота | Описание|
|--- | --- | ---|
|Schedule_AutoStop_CreateAlert_Parent | Каждые 8 часов | Запускает **AutoStop_CreateAlert_Parent** runbook каждые 8 часов, что, в свою `External_Start_ResourceGroupNames` `External_Stop_ResourceGroupNames`очередь, `External_ExcludeVMNames` останавливает значения на основе VM в, и переменные. Кроме того, можно указать список VMs, разделенный запятой, используя `VMList` параметр.|
|Scheduled_StopVM | Пользователь-определенный, ежедневно | Запускает **ScheduledStopStart_Parent** runbook с `Stop` параметром каждый день в указанное время.Автоматически останавливается все ВМ, которые соответствуют правилам, определенным переменными активами.Включить соответствующее расписание **Scheduled-StartVM**.|
|Scheduled_StartVM | Пользователь-определенный, ежедневно | Запускает **ScheduledStopStart_Parent** runbook с параметрьным `Start` значением каждого дня в указанное время. Автоматически запускает все VMs, которые соответствуют правилам, определенным переменными активами.Включить соответствующее расписание **Scheduled-StopVM**.|
|Sequenced-StopVM | 01:00 (UTC), каждую пятницу | Запускает Sequenced_Parent runbook со значением параметра `Stop` каждую пятницу в указанное время.Последовательно (по возрастанию) останавливает все виртуальные машины с тегом **SequenceStop**, которые указаны в соответствующих переменных. Ознакомьтесь с разделом "Модули Runbook", чтобы получить дополнительные сведения о значениях тегов и переменных ресурсов.Включите связанное расписание **Sequenced-StartVM**.|
|Sequenced-StartVM | 13:00 (UTC), каждый понедельник | Запускает **SequencedStopStart_Parent** runbook со значением параметра каждый `Start` понедельник в указанное время. Последовательно (по убыванию) запускает все виртуальные машины с тегом **SequenceStart**, которые указаны в соответствующих переменных. Для получения дополнительной информации о значениях [Runbooks](#runbooks)тегов и переменных активах см. Включите связанное расписание **Sequenced-StopVM**.

## <a name="use-of-the-solution-with-classic-vms"></a>Использование решения с классическими VMs

Если вы используете **Start/stop VMs в нерабочее время** для классических ВМ, автоматизация обрабатывает все ваши ввоспредства последовательно на облачный сервис. ВМ по-прежнему обрабатываются параллельно в различных облачных службах. 

Для использования решения с классическими VMs, вам нужно Классический Run As учетная запись, которая не создается по умолчанию. Для получения инструкций по созданию учетной записи Classic Run As [см.](automation-create-standalone-account.md#create-a-classic-run-as-account)

Если у вас более 20 вс-м внедряет в облачную службу, вот несколько рекомендаций:

* Создайте несколько расписаний с помощью родительской **ScheduledStartStop_Parent** и укажите 20 вс-м в ней по расписанию. 
* В свойствах расписания `VMList` используйте параметр для указания имен VM в качестве списка, разделенного запятой. 

В противном случае, если задание автоматизации для этого решения выполняется более трех часов, оно временно выгружается или останавливается в пределах [справедливой доли.](automation-runbook-execution.md#fair-share)

Подписки Azure CSP поддерживают только модель менеджера ресурсов Azure. Службы менеджера ресурсов, не связанные с Azure, недоступны в программе. При запуске **решения Start/stop VMs в нерабочее время** могут возникнуть ошибки, поскольку для управления классическими ресурсами имеется cmdlets. Дополнительные сведения о CSP см. в разделе [Комментарии](https://docs.microsoft.com/azure/cloud-solution-provider/overview/azure-csp-available-services). При использовании подписки CSP следует установить [External_EnableClassicVMs](#variables) переменную на false после развертывания.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="enable-the-solution"></a>Включение решения

Чтобы начать использовать решение, выполните последующие действия в [решении Enable Start/stop VMs.](automation-solution-vm-management-enable.md)

## <a name="view-the-solution"></a>Просмотр решения

Используйте один из следующих механизмов для доступа к решению после его включения:

* Из учетной записи автоматизации выберите **Start/Stop VM** под **похожими ресурсами.** На странице Start/Stop VM выберите **управление решением** с правой стороны страницы под **управлением Start/Stop VM Solutions.**

* Перейдите к рабочей области Log Analytics, связанной с учетной записью Автоматизация. После выбора рабочего пространства выберите **решения** из левой панели. На странице «Решения» выберите из списка решение **Start-Stop-VM.'workspace.**  

При выборе решения отобразится страница решения **Start-Stop-VM[рабочая_область]**. Здесь вы можете просмотреть важные детали, такие как информация в плитке **StartStopVM.** Как и в рабочей области Log Analytics, в нем отображаются сведения о количестве заданий runbook, которые были запущены и завершены для решения, а также их графическое представление.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-portal-vmupdate-solution-01.png)

Вы можете выполнить дальнейший анализ записей о работе, нажав на плитку пончика. Панель мониторинга решений показывает историю работы и предопределенные поисковые запросы. Переключитесь на расширенный портал анализа журналов для поиска на основе поисковых запросов.

## <a name="update-the-solution"></a>Обновление решения

Если вы развернули предыдущую версию этого решения, удалите ее из учетной записи перед развертыванием обновленного релиза. Выполните шаги, чтобы [удалить решение,](#remove-the-solution) а затем следовать шагам для [развертывания решения.](automation-solution-vm-management-enable.md)

## <a name="remove-the-solution"></a>Удаление решения

Если вам больше не нужно использовать решение, вы можете удалить его из учетной записи Автоматизация. При этом удаляются только модули runbook. Расписания или переменные, которые были созданы при добавлении решения, не удаляются. Удалите эти активы вручную, если вы не используете их с другими runbooks.

Чтобы удалить решение:

1. Из учетной записи Автоматизации выберите **связанное рабочее пространство** под **соответствующими ресурсами.**

2. Выберите **Перейти к рабочему пространству.**

3. Нажмите **Решения** под **общим**. 

4. На странице Решения выберите решение **Start-Stop-VM[Workspace]**. 

5. На странице **VMManagementSolution (Workspace)** выберите **Удаление** из меню.<br><br> ![Удаление решения VMManagement](media/automation-solution-vm-management/vm-management-solution-delete.png)

6. В окне **решения delete** подтвердите, что вы хотите удалить решение.

7. В то время как информация проверяется и решение удалено, вы можете отслеживать ход работ ы в соответствии с **уведомлениями, выбранными**из меню. После начала процесса удаления решения вы возвращаетесь на страницу «Решения».

В ходе этого процесса рабочая область Log Analytics и учетная запись службы автоматизации не удаляются. Если вы не хотите сохранять рабочее пространство analytics журнала, необходимо удалить его с портала Azure:

1. Поиск и выбор **рабочих областей анализа журналов.**

2. На странице рабочего пространства log Analytics выберите рабочее пространство.

3. В меню, расположенном на странице параметров рабочей области, выберите **Удалить**.

4. Если вы не хотите хранить [компоненты решения для](#solution-components)решения учетной записи Azure Automation, вы можете удалить каждый из них вручную.

## <a name="next-steps"></a>Дальнейшие действия

[Включите](automation-solution-vm-management-enable.md) в нерабочее время решения **Start/stop VMs** для ваших VMs-м вне учения.
