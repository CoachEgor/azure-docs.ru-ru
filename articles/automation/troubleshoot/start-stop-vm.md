---
title: Устранение неполадок в решении "Запуск и завершение виртуальных машин в нерабочее время"
description: В этой статье содержатся сведения об устранении неполадок в решении "Запуск и завершение виртуальной машины в часах".
services: automation
ms.service: automation
ms.subservice: process-automation
author: mgoedtel
ms.author: magoedte
ms.date: 04/04/2019
ms.topic: conceptual
manager: carmonm
ms.openlocfilehash: 611e8441fab56114ca010d0b555c9ed156ae9d40
ms.sourcegitcommit: c535228f0b77eb7592697556b23c4e436ec29f96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82855058"
---
# <a name="troubleshoot-the-startstop-vms-during-off-hours-solution"></a>Устранение неполадок с решением запуска и остановки виртуальных машин в нерабочее время

Эта статья содержит сведения об устранении неполадок, возникающих при работе с решением "Запуск и завершение виртуальных машин службы автоматизации Azure в часах".

>[!NOTE]
>Эта статья была изменена и теперь содержит сведения о новом модуле Az для Azure PowerShell. Вы по-прежнему можете использовать модуль AzureRM, исправления ошибок для которого будут продолжать выпускаться как минимум до декабря 2020 г. Дополнительные сведения о совместимости модуля Az с AzureRM см. в статье [Introducing the new Azure PowerShell Az module](https://docs.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-3.5.0) (Знакомство с новым модулем Az для Azure PowerShell). Инструкции по установке AZ Module в гибридной рабочей роли Runbook см. в статье [Установка модуля Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps?view=azps-3.5.0). Для учетной записи службы автоматизации Azure можно обновить модули до последней версии, используя [обновление модулей Azure PowerShell в службе автоматизации Azure](../automation-update-azure-modules.md).

## <a name="scenario-the-startstop-vms-during-off-hours-solution-fails-to-properly-deploy"></a><a name="deployment-failure"></a>Сценарий: решение "Запуск и завершение виртуальных машин в нерабочее время" не удается правильно развернуть

### <a name="issue"></a>Проблема

При развертывании [решения запуск/завершение виртуальных машин в нерабочее время](../automation-solution-vm-management.md)появляется одна из следующих ошибок:

```error
Account already exists in another resourcegroup in a subscription. ResourceGroupName: [MyResourceGroup].
```

```error
Resource 'StartStop_VM_Notification' was disallowed by policy. Policy identifiers: '[{\\\"policyAssignment\\\":{\\\"name\\\":\\\"[MyPolicyName]".
```

```error
The subscription is not registered to use namespace 'Microsoft.OperationsManagement'.
```

```error
The subscription is not registered to use namespace 'Microsoft.Insights'.
```

```error
The scope '/subscriptions/000000000000-0000-0000-0000-00000000/resourcegroups/<ResourceGroupName>/providers/Microsoft.OperationalInsights/workspaces/<WorkspaceName>/views/StartStopVMView' cannot perform write operation because following scope(s) are locked: '/subscriptions/000000000000-0000-0000-0000-00000000/resourceGroups/<ResourceGroupName>/providers/Microsoft.OperationalInsights/workspaces/<WorkspaceName>/views/StartStopVMView'. Please remove the lock and try again
```

```error
A parameter cannot be found that matches parameter name 'TagName'
```

```error
Start-AzureRmVm : Run Login-AzureRmAccount to login
```

### <a name="cause"></a>Причина

Развертывание может завершиться сбоем по одной из следующих причин:

- В выбранном регионе уже есть учетная запись службы автоматизации с тем же именем.
- Политика запрещает развертывание решения запуска/остановки виртуальных машин в нерабочее время.
- Тип `Microsoft.OperationsManagement`ресурса `Microsoft.Insights`, или `Microsoft.Automation` не зарегистрирован.
- Рабочая область Log Analytics заблокирована.
- У вас есть устаревшая версия модулей AzureRM или решение Start/остановки виртуальных машин в нерабочее время.

### <a name="resolution"></a>Решение

Чтобы получить возможные решения проблемы, ознакомьтесь с приведенными ниже исправлениями.

* Учетные записи службы автоматизации должны быть уникальными в пределах региона Azure, даже если они находятся в разных группах ресурсов. Проверьте существующие учетные записи службы автоматизации в целевом регионе.
* Существующая политика предотвращает развертывание ресурса, необходимого для запуска и остановки виртуальных машин в нерабочее время. Перейдите к назначению политики в портал Azure и проверьте, имеется ли назначение политики, разрешающее развертывание этого ресурса. Дополнительные сведения см. в разделе [RequestDisallowedByPolicy Error](../../azure-resource-manager/templates/error-policy-requestdisallowedbypolicy.md).
* Чтобы развернуть решение "Запуск и завершение виртуальных машин", необходимо зарегистрировать подписку в следующих пространствах имен ресурсов Azure:

    * `Microsoft.OperationsManagement`
    * `Microsoft.Insights`
    * `Microsoft.Automation`

   Дополнительные сведения об ошибках при регистрации поставщиков см. в статье [Устранение ошибок при регистрации поставщика ресурсов](../../azure-resource-manager/templates/error-register-resource-provider.md).
* Если у вас есть блокировка в рабочей области Log Analytics, перейдите в свою рабочую область на портале Azure и удалите все блокировки в ресурсе.
* Если эти решения не решают проблему, следуйте инструкциям в разделе [Обновление решения](../automation-solution-vm-management.md#update-the-solution) для повторного развертывания решения Start/остановки виртуальных машин в нерабочее время.

## <a name="scenario-all-vms-fail-to-start-or-stop"></a><a name="all-vms-fail-to-startstop"></a>Сценарий: не удается запустить или завершить все виртуальные машины

### <a name="issue"></a>Проблема

Вы настроили решение "Запуск и завершение виртуальных машин в нерабочее время", но не запускаете и не останавливает все виртуальные машины.

### <a name="cause"></a>Причина

Ошибка может быть вызвана одной из следующих причин:

- Расписание настроено неправильно.
- Возможно, учетная запись запуска от имени настроена неправильно.
- Возможно, модуль Runbook был запущен с ошибками.
- Возможно, виртуальные машины были исключены.

### <a name="resolution"></a>Решение

В следующем списке приведены возможные решения проблемы.

* Убедитесь, что вы правильно настроили расписание для решения "Запуск и завершение виртуальных машин в нерабочее время". Сведения о настройке расписания см. в разделе [расписания](../automation-schedules.md).

* Проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) , чтобы найти ошибки. Найдите задания из одного из следующих модулей Runbook:

  * **AutoStop_CreateAlert_Child**
  * **AutoStop_CreateAlert_Parent**
  * **AutoStop_Disable**
  * **AutoStop_VM_Child**
  * **ScheduledStartStop_Base_Classic;**
  * **ScheduledStartStop_Child_Classic;**
  * **ScheduledStartStop_Child**
  * **ScheduledStartStop_Parent**
  * **SequencedStartStop_Parent**

* Убедитесь, что [учетная запись запуска от имени](../manage-runas-account.md) имеет необходимые разрешения для виртуальных машин, которые вы пытаетесь запустить или приостанавливаться. Дополнительные сведения о проверке разрешений на ресурс см. в разделе [Краткое руководство. Просмотр ролей, назначенных пользователю с помощью портал Azure](../../role-based-access-control/check-access.md). Необходимо указать идентификатор приложения для субъекта-службы, используемого учетной записью запуска от имени. Это значение можно получить, перейдя к учетной записи службы автоматизации в портал Azure. Выберите **учетные записи запуска от имени** в разделе **Параметры учетной записи**и выберите соответствующую учетную запись запуска от имени.

* Виртуальные машины могут быть не запущены или остановлены, если они явно исключены. Исключенные виртуальные машины задаются в `External_ExcludeVMNames` переменной в учетной записи службы автоматизации, в которой развертывается решение. В следующем примере показано, как можно запросить это значение с помощью PowerShell.

  ```powershell-interactive
  Get-AzAutomationVariable -Name External_ExcludeVMNames -AutomationAccountName <automationAccountName> -ResourceGroupName <resourceGroupName> | Select-Object Value
  ```

## <a name="scenario-some-of-my-vms-fail-to-start-or-stop"></a><a name="some-vms-fail-to-startstop"></a>Сценарий: не удается запустить или завершить некоторые виртуальные машины

### <a name="issue"></a>Проблема

Вы настроили решение "Запуск и завершение виртуальных машин в нерабочее время", но не запускаете и не останавливает некоторые настроенные виртуальные машины.

### <a name="cause"></a>Причина

Ошибка может быть вызвана одной из следующих причин:

- В сценарии последовательности тег может отсутствовать или быть неверным.
- Виртуальная машина может быть исключена.
- Учетная запись запуска от имени может не иметь достаточных разрешений на виртуальной машине.
- У виртуальной машины может быть проблемы, которая остановила ее запуск или остановку.

### <a name="resolution"></a>Решение

Ниже приведен список возможных решений для вашей проблемы и указано, где следует искать источник неполадки.

* При использовании [сценария последовательности](../automation-solution-vm-management.md) в решении "Запуск и завершение виртуальных машин в нерабочее время" необходимо убедиться, что каждая виртуальная машина, которую нужно запустить или отключить, имеет правильный тег. Виртуальным машинам, которые нужно запустить, должен быть присвоен тег `sequencestart`, а виртуальным машинам, которые нужно остановить, — тег `sequencestop`. Для обоих тегов требуется положительное целое значение. Для поиска всех виртуальных машин с тегами и значений тегов можно использовать запрос, аналогичный приведенному ниже.

  ```powershell-interactive
  Get-AzResource | ? {$_.Tags.Keys -contains "SequenceStart" -or $_.Tags.Keys -contains "SequenceStop"} | ft Name,Tags
  ```

* Виртуальные машины могут быть не запущены или остановлены, если они явно исключены. Исключенные виртуальные машины задаются в `External_ExcludeVMNames` переменной в учетной записи службы автоматизации, в которой развертывается решение. В следующем примере показано, как можно запросить это значение с помощью PowerShell.

  ```powershell-interactive
  Get-AzAutomationVariable -Name External_ExcludeVMNames -AutomationAccountName <automationAccountName> -ResourceGroupName <resourceGroupName> | Select-Object Value
  ```

* Для запуска и завершения работы виртуальных машин учетная запись запуска от имени для учетной записи службы автоматизации должна иметь соответствующие разрешения для виртуальной машины. Дополнительные сведения о проверке разрешений на ресурс см. в разделе [Краткое руководство. Просмотр ролей, назначенных пользователю с помощью портал Azure](../../role-based-access-control/check-access.md). Необходимо указать идентификатор приложения для субъекта-службы, используемого учетной записью запуска от имени. Это значение можно получить, перейдя к учетной записи службы автоматизации в портал Azure. Выберите **учетные записи запуска от имени** в разделе **Параметры учетной записи** и выберите соответствующую учетную запись запуска от имени.
* Если при запуске или отмене выделения виртуальной машины возникла проблема, возможно, возникла проблема с самой виртуальной машиной. Примеры — это обновление, которое применяется при попытке завершить работу виртуальной машины, зависания службы и т. д. Перейдите к ресурсу виртуальной машины и проверьте **журналы действий** , чтобы проверить наличие ошибок в журналах. Вы также можете попытаться войти на виртуальную машину, чтобы проверить наличие ошибок в журналах событий. Дополнительные сведения об устранении неполадок виртуальной машины см. в статье [Устранение неполадок виртуальных машин Azure](../../virtual-machines/troubleshooting/index.yml).
* Проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) , чтобы найти ошибки. На портале перейдите к учетной записи службы автоматизации и выберите **задания** в разделе **Автоматизация процессов**.

## <a name="scenario-my-custom-runbook-fails-to-start-or-stop-my-vms"></a><a name="custom-runbook"></a>Сценарий: пользовательскому Runbook не удается запустить или отключить мои виртуальные машины

### <a name="issue"></a>Проблема

Вы создали пользовательский модуль Runbook или загрузили его из коллекция PowerShell, и он не работает должным образом.

### <a name="cause"></a>Причина

Может быть несколько причин сбоя. Перейдите к учетной записи службы автоматизации в портал Azure и выберите **задания** в разделе **Автоматизация процессов**. На странице **Задания** просмотрите, нет ли сведений о сбоях заданий runbook.

### <a name="resolution"></a>Решение

Мы рекомендуем следующее:

* Используйте [решение "Запуск и завершение виртуальных машин в нерабочее время](../automation-solution-vm-management.md) " для запуска и остановки виртуальных машин в службе автоматизации Azure. Разработчик этого решения — корпорация Майкрософт. 
* Имейте в виду, что корпорация Майкрософт не поддерживает пользовательские модули Runbook. Решение для пользовательского модуля Runbook можно найти в [статье Устранение неполадок Runbook](runbooks.md). Проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) , чтобы найти ошибки. 

## <a name="scenario-vms-dont-start-or-stop-in-the-correct-sequence"></a><a name="dont-start-stop-in-sequence"></a>Сценарий: виртуальные машины не запускаются и не останавливаются в правильной последовательности

### <a name="issue"></a>Проблема

Виртуальные машины, настроенные вами в решении, не запускаются или не останавливаются в правильной очередности.

### <a name="cause"></a>Причина

Эта проблема вызвана неправильным добавлением тегов на виртуальных машинах.

### <a name="resolution"></a>Решение

Выполните следующие действия, чтобы убедиться, что решение настроено правильно.

1. Убедитесь, что всем виртуальным машинам, которые нужно запустить, присвоен тег `sequencestart`, а тем, которые нужно остановить, — тег `sequencestop`. Этим тегам в качестве значения требуется положительное целое число. Виртуальные машины обрабатываются по возрастанию на основе этого значения.
1. Убедитесь, что группы ресурсов для виртуальных машин, которые нужно запустить, указаны в переменной `External_Start_ResourceGroupNames`, а для тех виртуальных машин, которые нужно остановить, — в переменной `External_Stop_ResourceGroupNames`.
1. Проверьте изменения, выполнив `SequencedStartStop_Parent` Runbook с параметром `WHATIF` , имеющим значение true, чтобы просмотреть изменения.

Дополнительные сведения об использовании решения для запуска и окончания последовательности виртуальных машин см. в статье запуск и [Завершение виртуальных машин в](../automation-solution-vm-management.md)последовательном запуске.

## <a name="scenario-startstop-vms-during-off-hours-job-fails-with-403-forbidden-error"></a><a name="403"></a>Сценарий: задание для запуска и остановки виртуальных машин в нерабочее время завершается с ошибкой 403.

### <a name="issue"></a>Проблема

Вы найдете задания, которые завершились `403 forbidden` сбоем с ошибкой для виртуальных машин запуска и остановки в течение нерабочее время в модулях Runbook решения.

### <a name="cause"></a>Причина

Эта проблема может быть вызвана неправильно настроенной или устаревшей учетной записью запуска от имени. Это также может быть вызвано недостаточными разрешениями для ресурсов виртуальной машины с помощью учетной записи запуска от имени.

### <a name="resolution"></a>Решение

Чтобы убедиться, что учетная запись запуска от имени настроена правильно, перейдите к учетной записи службы автоматизации в портал Azure и выберите **учетные записи запуска от имени** в разделе **Параметры учетной записи**. Если учетная запись запуска от имени настроена неправильно или срок ее действия истек, состояние отображает условие.

Если учетная запись запуска от имени настроена неправильно, удалите и повторно создайте учетную запись запуска от имени. Дополнительные сведения см. в статье [Управление учетными записями запуска от имени службы автоматизации Azure](../manage-runas-account.md).

Если срок действия сертификата истек для учетной записи запуска от имени, выполните действия, описанные в подразделе обновление сертификата с помощью [самозаверяющего обновления](../manage-runas-account.md#cert-renewal) .

Если отсутствуют разрешения, см. раздел [Краткое руководство. Просмотр ролей, назначенных пользователю с помощью портал Azure](../../role-based-access-control/check-access.md). Необходимо указать идентификатор приложения для субъекта-службы, используемого учетной записью запуска от имени. Это значение можно получить, перейдя к учетной записи службы автоматизации в портал Azure. Выберите **учетные записи запуска от имени** в разделе **Параметры учетной записи**и выберите соответствующую учетную запись запуска от имени.

## <a name="scenario-my-problem-isnt-listed-here"></a><a name="other"></a>Сценарий: Моя проблема не указана здесь

### <a name="issue"></a>Проблема

При использовании решения "запуск/завершение виртуальных машин в нерабочее время", которое не указано на этой странице, возникает проблема или непредвиденный результат.

### <a name="cause"></a>Причина

Зачастую ошибки могут возникать из-за использования старых и устаревших версий решения.

> [!NOTE]
> Решение для запуска и остановки виртуальных машин в нерабочее время было протестировано с модулями Azure, которые импортируются в учетную запись службы автоматизации при развертывании решения. В настоящее время решение не работает с более новыми версиями модуля Azure. Это ограничение влияет только на учетную запись службы автоматизации, используемую для запуска решения "Запуск и остановка виртуальных машин в нерабочее время". Вы по-прежнему можете использовать новые версии модуля Azure в других учетных записях службы автоматизации, как описано в [статье обновление модулей Azure PowerShell в службе автоматизации Azure](../automation-update-azure-modules.md).

### <a name="resolution"></a>Решение

Чтобы устранить многие ошибки, удалите и [Обновите решение "Запуск и завершение виртуальных машин в нерабочее время"](../automation-solution-vm-management.md#update-the-solution). Кроме того, можно проверить [потоки заданий](../automation-runbook-execution.md#job-statuses) , чтобы найти ошибки. 

## <a name="next-steps"></a>Дальнейшие шаги

Если вы не видите проблему здесь или вы не можете решить проблему, попробуйте использовать один из следующих каналов для получения дополнительной поддержки:

* Получите ответы от экспертов Azure на [форумах Azure](https://azure.microsoft.com/support/forums/).
* Подключайтесь с помощью официальной учетной записи Microsoft Azure для улучшения качества взаимодействия с [@AzureSupport](https://twitter.com/azuresupport)клиентами. Служба поддержки Azure подключается к сообществу Azure для получения ответов, поддержки и экспертов.
* Отправьте запрос в службу поддержки Azure Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/)и выберите **получить поддержку**.