---
title: Запуск и остановка ВМ - Автоматизация Azure
description: В этой статье содержится информация о устранении неполадок запуск и остановка ВМ в Azure Automation.
services: automation
ms.service: automation
ms.subservice: process-automation
author: mgoedtel
ms.author: magoedte
ms.date: 04/04/2019
ms.topic: conceptual
manager: carmonm
ms.openlocfilehash: 97ea98fc38fc8d06dc1bc65ee057241da6f15488
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78851379"
---
# <a name="troubleshoot-the-startstop-vms-during-off-hours-solution"></a>Устранение неполадок с решением запуска и остановки виртуальных машин в нерабочее время

## <a name="scenario-the-startstop-vm-solution-fails-to-properly-deploy"></a><a name="deployment-failure"></a>Сценарий: Решение Start/Stop VM не может должным образом развернуть

### <a name="issue"></a>Проблема

Развертывание [решения для запуска и остановки виртуальных машин в нерабочее время](../automation-solution-vm-management.md) приводит к одной из перечисленных ниже ошибок.

```error
Account already exists in another resourcegroup in a subscription. ResourceGroupName: [MyResourceGroup].
```

```error
Resource 'StartStop_VM_Notification' was disallowed by policy. Policy identifiers: '[{\\\"policyAssignment\\\":{\\\"name\\\":\\\"[MyPolicyName]".
```

```error
The subscription is not registered to use namespace 'Microsoft.OperationsManagement'.
```

```error
The subscription is not registered to use namespace 'Microsoft.Insights'.
```

```error
The scope '/subscriptions/000000000000-0000-0000-0000-00000000/resourcegroups/<ResourceGroupName>/providers/Microsoft.OperationalInsights/workspaces/<WorkspaceName>/views/StartStopVMView' cannot perform write operation because following scope(s) are locked: '/subscriptions/000000000000-0000-0000-0000-00000000/resourceGroups/<ResourceGroupName>/providers/Microsoft.OperationalInsights/workspaces/<WorkspaceName>/views/StartStopVMView'. Please remove the lock and try again
```

```error
A parameter cannot be found that matches parameter name 'TagName'
```

```error
Start-AzureRmVm : Run Login-AzureRmAccount to login
```

### <a name="cause"></a>Причина

Не удается выполнить развертывания по одной из следующих причин:

1. В выбранном регионе уже существует учетная запись службы автоматизации с тем же именем.
2. Местоположение политики запрещает развертывание решения для запуска и остановки виртуальных машин.
3. Типы ресурсов `Microsoft.OperationsManagement`, `Microsoft.Insights` или `Microsoft.Automation` не регистрируются.
4. Рабочая область Log Analytics имеет блокировку на них.
5. У вас есть устаревшая версия модулей AzureRM или решение Start/Stop.

### <a name="resolution"></a>Решение

Ниже приведен список возможных решений для вашей проблемы и указано, где следует искать источник неполадки.

1. Учетные записи службы автоматизации должны быть уникальными в пределах региона Azure, даже если они находятся в разных группах ресурсов. Проверьте существующие учетные записи службы автоматизации в целевом регионе.
2. Существующая политика запрещает использование ресурса, необходимого для развертывания решения для запуска и остановки виртуальной машины. Перейдите к своим назначениям политики на портале Azure и проверьте, есть ли у вас назначение политики, запрещающее развертывание этого ресурса. Дополнительные сведения см. в статье [Ошибка RequestDisallowedByPolicy с политикой ресурсов Azure](../../azure-resource-manager/templates/error-policy-requestdisallowedbypolicy.md).
3. Чтобы развернуть решение для запуска и остановки виртуальной машины, ваша подписка должна быть зарегистрирована в указанных ниже пространствах имен ресурсов Azure.
    * `Microsoft.OperationsManagement`
    * `Microsoft.Insights`
    * `Microsoft.Automation`

   Дополнительные сведения об ошибках при регистрации поставщиков см. в статье [Устранение ошибок регистрации поставщика ресурсов](../../azure-resource-manager/templates/error-register-resource-provider.md).
4. Если у вас есть блокировка в рабочей области Log Analytics, перейдите в свою рабочую область на портале Azure и удалите все блокировки в ресурсе.
5. Если приведенные выше резолюции не решают вашу проблему, следуйте инструкциям в рамках [обновления решения](../automation-solution-vm-management.md#update-the-solution) для повторного развертывания решения Start/Stop.

## <a name="scenario-all-vms-fail-to-startstop"></a><a name="all-vms-fail-to-startstop"></a>Сценарий: Все VMs не могут начать /остановить

### <a name="issue"></a>Проблема

Вы настроили решение запуска и остановки виртуальных машин, но оно не запускает или не останавливает работу всех настроенных виртуальных машин.

### <a name="cause"></a>Причина

Ошибка может быть вызвана одной из следующих причин:

1. Расписание настроено неправильно.
2. Учетная запись запуска от имени настроена неправильно.
3. При работе runbook возникли ошибки.
4. Виртуальные машины были исключены.

### <a name="resolution"></a>Решение

Ниже приведен список возможных решений для вашей проблемы и указано, где следует искать источник неполадки.

* Проверьте правильность настройки расписания для решения запуска и остановки виртуальных машин. Сведения о настройке расписания см. в [этой статье](../automation-schedules.md).

* Проверьте [потоки рабочих мест,](../automation-runbook-execution.md#viewing-job-status-from-the-azure-portal) чтобы найти любые ошибки. На портале перейдите к учетной записи службы автоматизации и в разделе **Автоматизация процессов** выберите **Задания**. На странице **Задания** найдите задания одного из следующих модулей runbook:

  * AutoStop_CreateAlert_Child
  * AutoStop_CreateAlert_Parent
  * AutoStop_Disable
  * AutoStop_VM_Child
  * ScheduledStartStop_Base_Classic;
  * ScheduledStartStop_Child_Classic;
  * ScheduledStartStop_Child
  * ScheduledStartStop_Parent
  * SequencedStartStop_Parent

* Убедитесь, что у [учетной записи запуска от имени](../manage-runas-account.md) есть соответствующие разрешения на виртуальные машины, которые вы пытаетесь запустить или остановить. Чтобы узнать, как проверить разрешения на [Quickstart: View roles assigned to a user using the Azure portal](../../role-based-access-control/check-access.md)ресурсе, см. Вам нужно будет предоставить идентификатор приложения для основного обслуживания, используемого учетной записью Run As. Чтобы получить это значение, перейдите к учетной записи службы автоматизации на портале Azure, выберите в разделе **Параметры учетной записи** пункт **Учетные записи запуска от имени** и щелкните соответствующую учетную запись запуска от имени.

* Виртуальные машины не могут быть запущены или остановлены, если они были явно исключены. Исключаемые виртуальные машины задаются в переменной **External_ExcludeVMNames** в учетной записи службы автоматизации, в которую развернуто решение. В следующем примере показано, как запросить это значение с помощью PowerShell.

  ```powershell-interactive
  Get-AzureRmAutomationVariable -Name External_ExcludeVMNames -AutomationAccountName <automationAccountName> -ResourceGroupName <resourceGroupName> | Select-Object Value
  ```

## <a name="scenario-some-of-my-vms-fail-to-start-or-stop"></a><a name="some-vms-fail-to-startstop"></a>Сценарий: Некоторые из моих vMs не могут начать или остановить

### <a name="issue"></a>Проблема

Вы настроили решение запуска и остановки виртуальных машин, но оно не запускает или не останавливает работу некоторых настроенных виртуальных машин.

### <a name="cause"></a>Причина

Ошибка может быть вызвана одной из следующих причин:

1. В случае использования сценария с поочередной обработкой тег может отсутствовать или быть неправильным.
2. Виртуальная машина была исключена.
3. У учетной записи запуска от имени недостаточно разрешений на виртуальную машину.
4. На виртуальной машины присутствует проблема, которая препятствует ее запуску или остановке.

### <a name="resolution"></a>Решение

Ниже приведен список возможных решений для вашей проблемы и указано, где следует искать источник неполадки.

* При использовании [сценария с поочередной обработкой](../automation-solution-vm-management.md#scenario-2-startstop-vms-in-sequence-by-using-tags) решения для запуска и остановки виртуальных машин в нерабочее время необходимо убедиться, что каждой виртуальной машине, которую нужно запустить или остановить, присвоен правильный тег. Виртуальным машинам, которые нужно запустить, должен быть присвоен тег `sequencestart`, а виртуальным машинам, которые нужно остановить, — тег `sequencestop`. Для обоих тегов требуется положительное целое значение. Для поиска всех виртуальных машин с тегами и значений тегов можно использовать запрос, аналогичный приведенному ниже.

  ```powershell-interactive
  Get-AzureRmResource | ? {$_.Tags.Keys -contains "SequenceStart" -or $_.Tags.Keys -contains "SequenceStop"} | ft Name,Tags
  ```

* Виртуальные машины не могут быть запущены или остановлены, если они были явно исключены. Исключаемые виртуальные машины задаются в переменной **External_ExcludeVMNames** в учетной записи службы автоматизации, в которую развернуто решение. В следующем примере показано, как запросить это значение с помощью PowerShell.

  ```powershell-interactive
  Get-AzureRmAutomationVariable -Name External_ExcludeVMNames -AutomationAccountName <automationAccountName> -ResourceGroupName <resourceGroupName> | Select-Object Value
  ```

* Для запуска и остановки виртуальных машин требуется, чтобы у учетной записи запуска от имени для учетной записи автоматизации были соответствующие разрешения на виртуальную машину. Чтобы узнать, как проверить разрешения на [Quickstart: View roles assigned to a user using the Azure portal](../../role-based-access-control/check-access.md)ресурсе, см. Вам нужно будет предоставить идентификатор приложения для основного обслуживания, используемого учетной записью Run As. Чтобы получить это значение, перейдите к учетной записи службы автоматизации на портале Azure, выберите в разделе **Параметры учетной записи** пункт **Учетные записи запуска от имени** и щелкните соответствующую учетную запись запуска от имени.

* Если на виртуальной машине возникла проблема при запуске или отмене распределения, это поведение может быть вызвано самой виртуальной машиной. Некоторые примеры потенциальных проблем такие: применение обновления при попытке завершить работу, зависание службы и т. д.) Перейдите к ресурсу виртуальной машины и проверьте, нет ли в **журналах действий** записей об ошибках. Вы также можете попытаться войти в систему виртуальной машины, чтобы просмотреть, нет ли ошибок в журналах событий. Чтобы узнать больше о устранении неполадок вашего VM, [см.](../../virtual-machines/troubleshooting/index.yml)

* Проверьте [потоки рабочих мест,](../automation-runbook-execution.md#viewing-job-status-from-the-azure-portal) чтобы найти любые ошибки. На портале перейдите к учетной записи службы автоматизации и в разделе **Автоматизация процессов** выберите **Задания**.

## <a name="scenario-my-custom-runbook-fails-to-start-or-stop-my-vms"></a><a name="custom-runbook"></a>Сценарий: Мой пользовательский runbook не может начать или остановить мои VMs

### <a name="issue"></a>Проблема

Вы создали пользовательский модуль runbook или скачали его из коллекции PowerShell, но он не работает должным образом.

### <a name="cause"></a>Причина

Сбой может возникнуть из-за множества причин. Перейдите к учетной записи службы автоматизации на портале Azure и в разделе **Автоматизация процессов** выберите **Задания**. На странице **Задания** просмотрите, нет ли сведений о сбоях заданий runbook.

### <a name="resolution"></a>Решение

Для запуска и остановки виртуальной машины в службе автоматизации Azure рекомендуется использовать [решение запуска и остановки виртуальных машин в нерабочее время](../automation-solution-vm-management.md). Разработчик этого решения — корпорация Майкрософт. Пользовательские модули runbook не поддерживаются корпорацией Майкрософт. Вы можете найти решение для пользовательского модуля runbook, ознакомившись со статьей [об устранении неполадок с runbook](runbooks.md). В этой статье содержатся общие рекомендации и сведения об устранении неполадок для модулей runbook всех типов. Проверьте [потоки рабочих мест,](../automation-runbook-execution.md#viewing-job-status-from-the-azure-portal) чтобы найти любые ошибки. На портале перейдите к учетной записи службы автоматизации и в разделе **Автоматизация процессов** выберите **Задания**.

## <a name="scenario-vms-dont-start-or-stop-in-the-correct-sequence"></a><a name="dont-start-stop-in-sequence"></a>Сценарий: VMs не запускать или останавливаться в правильной последовательности

### <a name="issue"></a>Проблема

Виртуальные машины, настроенные вами в решении, не запускаются или не останавливаются в правильной очередности.

### <a name="cause"></a>Причина

Это связано с неправильным присвоением тегов для виртуальных машин.

### <a name="resolution"></a>Решение

Выполните следующие действия, чтобы убедиться, что решение настроено правильно.

1. Убедитесь, что всем виртуальным машинам, которые нужно запустить, присвоен тег `sequencestart`, а тем, которые нужно остановить, — тег `sequencestop`. Этим тегам в качестве значения требуется положительное целое число. Виртуальные машины обрабатываются по возрастанию на основе этого значения.
2. Убедитесь, что группы ресурсов для виртуальных машин, которые нужно запустить, указаны в переменной `External_Start_ResourceGroupNames`, а для тех виртуальных машин, которые нужно остановить, — в переменной `External_Stop_ResourceGroupNames`.
3. Протестируйте изменения, запустив модуль runbook `SequencedStartStop_Parent` с параметром WHATIF, которому присвоено значение True. Так вы сможете предварительно просмотреть изменения.

Дополнительные сведения и рекомендации по использованию решения для запуска и остановки виртуальных машин по очереди см. в [этой статье](../automation-solution-vm-management.md#scenario-2-startstop-vms-in-sequence-by-using-tags).

## <a name="scenario-startstop-vm-job-fails-with-403-forbidden-status"></a><a name="403"></a>Сценарий: Работа Start/Stop VM не справляется с 403 запрещенным статусом

### <a name="issue"></a>Проблема

Найдите задания, которые завершились с ошибкой `403 forbidden` для модулей runbook с решением запуска и остановки виртуальных машин в нерабочее время.

### <a name="cause"></a>Причина

Эта проблема может быть вызвана неправильной настройкой или истекшим сроком действия учетной записи запуска от имени. Она также может быть связана с тем, что у учетной записи запуска от имени для службы автоматизации недостаточно разрешений на ресурсы виртуальной машины.

### <a name="resolution"></a>Решение

Чтобы проверить правильность настройки учетной записи запуска от имени, перейдите в службу автоматизации на портале Azure и в разделе **Параметры учетной записи** выберите **Учетные записи запуска от имени**. Здесь вы увидите состояние учетных записей запуска от имени. Если учетная запись запуска от имени настроена неправильно или срок ее действия истек, это будет отображаться в состоянии.

Если учетная запись Run As настроена неправильно, следует удалить и воссоздать учетную запись Run As. Смотрите [Управление Azure Автоматизация Run Как счета](../manage-runas-account.md).

Если срок действия сертификата для учетной записи запуска от имени истек, выполните действия, описанные в разделе [Обновление самозаверяющего сертификата](../manage-runas-account.md#cert-renewal), чтобы продлить сертификат.

Проблема может быть вызвана отсутствием разрешений. Чтобы узнать, как проверить разрешения на [Quickstart: View roles assigned to a user using the Azure portal](../../role-based-access-control/check-access.md)ресурсе, см. Вам нужно будет предоставить идентификатор приложения для основного обслуживания, используемого учетной записью Run As. Чтобы получить это значение, перейдите к учетной записи службы автоматизации на портале Azure, выберите в разделе **Параметры учетной записи** пункт **Учетные записи запуска от имени** и щелкните соответствующую учетную запись запуска от имени.

## <a name="scenario-my-problem-isnt-listed-above"></a><a name="other"></a>Сценарий: Моя проблема не указана выше

### <a name="issue"></a>Проблема

Во время использования решения запуска и остановки виртуальных машин в нерабочее время у вас возникла проблема или непредвиденный результат, которые не упомянуты на этой странице.

### <a name="cause"></a>Причина

Зачастую ошибки могут возникать из-за использования старых и устаревших версий решения.

> [!NOTE]
> Решение Start/Stop VMs в нерабочее время было протестировано с помощью модулей Azure, которые импортируются в учетную запись автоматизации при развертывании решения. В настоящее время решение не работает с новыми версиями модуля Azure. Это влияет только на учетную запись автоматизации, которую вы используете для запуска Start/Stop VMs в нерабочее время. В других учетных записях автоматизации по-прежнему можно использовать новые версии модуля Azure, описанные в [модулях Azure PowerShell в Azure Automation](../automation-update-azure-modules.md)

### <a name="resolution"></a>Решение

Чтобы устранить многие ошибки, рекомендуется удалить старую версию и обновить решение. Чтобы узнать, как обновить решение, ознакомьтесь с разделом [Обновление решения](../automation-solution-vm-management.md#update-the-solution). Кроме того, вы можете проверить [потоки задания,](../automation-runbook-execution.md#viewing-job-status-from-the-azure-portal) чтобы найти любые ошибки. На портале перейдите к учетной записи службы автоматизации и в разделе **Автоматизация процессов** выберите **Задания**.

## <a name="next-steps"></a>Дальнейшие действия

Если вы не видите своего варианта проблемы или вам не удается ее устранить, дополнительные сведения можно получить, посетив один из следующих каналов.

* Получите ответы специалистов Azure на [форумах Azure](https://azure.microsoft.com/support/forums/).
* Связь [@AzureSupport](https://twitter.com/azuresupport) с официальной учетной записью Microsoft Azure для улучшения обслуживания клиентов путем подключения сообщества Azure к нужным ресурсам: ответам, поддержке и экспертам.
* Если вам нужна дополнительная помощь, отправьте запрос в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите **«Получите поддержку».**
