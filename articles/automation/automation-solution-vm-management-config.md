---
title: Azure Автоматизация Настройка Start/Stop VMs в нерабочее время решения
description: В этой статье описывается, как настроить Start/Stop VMs в нерабочее время для поддержки различных случаев использования или сценариев.
services: automation
ms.subservice: process-automation
ms.date: 04/01/2020
ms.topic: conceptual
ms.openlocfilehash: 9842a736cf922e0490f2b0c8acb1d2e5833f3d6c
ms.sourcegitcommit: 5e49f45571aeb1232a3e0bd44725cc17c06d1452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81604765"
---
# <a name="how-to-configure-startstop-vms-during-off-hours-solution"></a>Как настроить Решение Start/Stop VMs в нерабочее время

С решением **Start/Stop VMs в нерабочее время** вы можете:

- [Расписание VMs, чтобы начать и остановить](#schedule).
- Расписание VMs для запуска и остановки в порядке возрастания [с помощью tags Azure](#tags) (не поддерживается для классических VM).
- Автоматическая остановка VMs на основе [низкого использования процессора.](#cpuutil)

В этой статье описывается, как успешно настроить решение для поддержки этих сценариев. Вы также можете узнать, как выполнить другие общие настройки конфигурации для решения, такие как:

* [Настройка уведомлений по электронной почте](#configure-email-notifications)

* [Добавление виртуальной машины](#add-a-vm)

* [Исключение виртуальной машины](#exclude-a-vm)

* [Изменение расписаний запуска и завершения работы](#modify-the-startup-and-shutdown-schedules)

## <a name="scenario-1-startstop-vms-on-a-schedule"></a><a name="schedule"></a>Сценарий 1. Запуск и остановка виртуальных машин по расписанию

Это конфигурация по умолчанию, используемая после первого развертывания решения. Например, можно настроить ее, чтобы останавливать все виртуальные машины в подписке вечером, когда вы уходите с работы, и запускать их утром, когда вы возвращаетесь в офис. Если настроить расписания **Scheduled-StartVM** и **Scheduled-StopVM** во время развертывания, они будут запускать и останавливать целевые виртуальные машины. Можно настроить это решение только для остановки виртуальных машин. Ознакомьтесь с разделом [Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия) в службе автоматизации Azure](#modify-the-startup-and-shutdown-schedules), чтобы узнать, как настроить пользовательское расписание.

> [!NOTE]
> Используется часовой пояс, указанный при настройке параметра времени расписания. Однако он хранится в службе автоматизации Azure в формате UTC. Нет необходимости преобразовывать часовой пояс, так как это делается во время развертывания.

Можно выбрать виртуальные машины в области действия с помощью переменных **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames**.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Нанастройка `External_Stop_ResourceGroupNames` `External_ExcludeVMNames` и переменные для определения целевых VM.

2. Включите и обновите расписания **Scheduled-StartVM** и **Scheduled-StopVM**.

3. Запустите **ScheduledStartStop_Parent** runbook с набором параметра **ACTION** **и** полем параметра **WHATIF,** установленным для просмотра изменений.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Запустите **ScheduledStartStop_Parent** runbook с **set ACTION,** чтобы **начать,** добавить запятой разделенный список VMs в поле параметра **VMList,** а затем установить поле параметра **WHATIF** true. Воспользуйтесь предварительным просмотром изменений.

2. Налажить `External_ExcludeVMNames` переменную с запятой разделенных список VMs (VM1, VM2, VM3).

3. Этот сценарий не `External_Start_ResourceGroupNames` `External_Stop_ResourceGroupnames` соответствует переменным. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

    > [!NOTE]
    > Значение для **имен целевой группы ресурсов** `External_Start_ResourceGroupNames` сохраняется как значение для обоих и `External_Stop_ResourceGroupNames`. Чтобы увеличить степень детализации, можно изменить эти переменные для различных групп ресурсов. Для начала действия `External_Start_ResourceGroupNames`и `External_Stop_ResourceGroupNames` используйте для остановки действий. Виртуальные машины автоматически добавляются в расписания запуска и остановки.

## <a name="scenario-2-startstop-vms-in-sequence-by-using-tags"></a><a name="tags"></a>Сценарий 2. Последовательный запуск и остановка виртуальных машин с помощью тегов

В среде, которая включает в себя два или более компонентов, работающих на нескольких виртуальных машинах, которые поддерживают распределенную рабочую нагрузку, важно наличие поддержки последовательного запуска и остановки компонентов в нужном порядке. Чтобы обеспечить это, выполните следующие действия.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Добавьте `sequencestart` `sequencestop` тег и тег с положительным значением для вс-же для вс-кнопок, которые ориентированы `External_Start_ResourceGroupNames` на `External_Stop_ResourceGroupNames` и переменные. Действия запуска и остановки будут выполняться в порядке возрастания. Чтобы узнать, как добавить тег к виртуальной машине, ознакомьтесь с разделами [Пометка виртуальной машины Windows в Azure](../virtual-machines/windows/tag.md) и [Пометка виртуальной машины Linux в Azure](../virtual-machines/linux/tag.md).

2. Измените расписания **Sequenced-StartVM** и **Sequenced-StopVM**, указав даты и время в соответствии со своими требованиями, после чего включите эти расписания.

3. Запустите **SequencedStartStop_Parent** runbook с **set ACTION,** чтобы **начать** и **WHATIF** установить на верной для предварительного просмотра изменений.

4. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда он будет готов, вручную выполните runbook с параметром, установленным на **False,** или дайте графику `Sequenced-StartVM` автоматизации и `Sequenced-StopVM` автоматически выполняйте предписанное расписание.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Добавьте `sequencestart` `sequencestop` тег и тег с положительным значением для вс-же в вд, которые вы планируете добавить к параметру. `VMList`

2. Запустите **SequencedStartStop_Parent** runbook с **set ACTION,** чтобы **начать,** добавить запятой разделенный список VMs в поле параметра **VMList,** а затем установить **WHATIF** к True. Воспользуйтесь предварительным просмотром изменений.

3. Налажить `External_ExcludeVMNames` переменную с запятой разделенных список VMs (VM1, VM2, VM3).

4. Этот сценарий не `External_Start_ResourceGroupNames` `External_Stop_ResourceGroupnames` соответствует переменным. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

5. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. При готовности вручную выполните **мониторинг-диагностику/мониторинг-действия-группы-группы** с параметром, установленным на **ложный.** Кроме того, пусть `Sequenced-StartVM` `Sequenced-StopVM` автоматизация график и работать автоматически после предписанного графика.

## <a name="scenario-3-startstop-automatically-based-on-cpu-utilization"></a><a name="cpuutil"></a>Сценарий 3. Автоматический запуск и остановка на основе загрузки ЦП

Это решение может помочь управлять затратами на запуск управления ресурсами Azure и классических виртуальных машин в подписке, оценивая виртуальные технологии, которые не используются в непиковые периоды, например в нерабочее время, и автоматически выключая их, если использование процессора меньше определенного процента.

По умолчанию это решение предварительно настроено для оценки метрики "Загрузка ЦП", и оно проверяет, составляет ли средняя загрузка 5 % или меньше. Этот сценарий контролируется следующими переменными и может быть изменен, если значения по умолчанию не соответствуют вашим требованиям:

* `External_AutoStop_MetricName`
* `External_AutoStop_Threshold`
* `External_AutoStop_TimeAggregationOperator`
* `External_AutoStop_TimeWindow`
* `External_AutoStop_Frequency`
* `External_AutoStop_Severity`

Вы можете включить и настроить таргетинг действия против группы подписчиков и ресурсов, а также настроить таргетинг на определенный список вс-ми.

При запуске **AutoStop_CreateAlert_Parent** runbook проверяется, что целевая подписка, группа ресурсов (ы) и VM существуют. Если VMs существуют, runbook затем вызывает **AutoStop_CreateAlert_Child** runbook для каждого проверенного VM родительской книгой. Этот детский runbook выполняет следующее:

* Создает правило предупреждения метрики для каждого проверенного VM.

* Триггеры **AutoStop_VM_Child** runbook для конкретного VM, если процессор падает ниже настроенного порога для указанного интервала времени. Этот runbook затем пытается остановить VM.

### <a name="to-target-the-auto-stop-action-against-all-vms-in-a-subscription"></a>Таргетинг на действие автоматической остановки против всех вс-авт.в подписке

1. Убедитесь, `External_Stop_ResourceGroupNames` что переменная пуста или установлена на q (wildcard).

2. (Необязательный шаг) Если вы хотите исключить некоторые ВМ из автоматического выключения, вы можете добавить `External_ExcludeVMNames` в переменную список, разделенный на запятой имен VM.

3. Включите `Schedule_AutoStop_CreateAlert_Parent` график для запуска для создания необходимых правил предупреждения метрики Stop VM для всех врезок в вашей подписке. Запуск этого типа расписания позволяет создавать новые правила предупреждения метрики по мере добавления новых ввода-нора в подписку.

### <a name="to-target-the-auto-stop-action-against-all-vms-in-a-resource-group-or-multiple-resource-groups"></a>Таргетинг на действие автоматической остановки против всех вс-управлений в группе ресурсов или нескольких группах ресурсов

1. Добавьте в `External_Stop_ResourceGroupNames` переменный список групп ресурсов, разделенный запятой.

2. Если вы хотите исключить некоторые из VM из автоматического выключения, вы можете добавить в `External_ExcludeVMNames` переменную список, разделенный на запятой имен VM.

3. Включить **Schedule_AutoStop_CreateAlert_Parent** расписание для запуска для создания необходимых правил оповещения метрики Stop VM для всех врезок ресурсов. Запуск этой операции по расписанию позволяет создавать новые правила предупреждения метрики по мере добавления новых ВМ в группу ресурсов (ы).

### <a name="to-target-the-autostop-action-to-a-list-of-vms"></a>Таргетинг действия автостопа на список VMs

1. Создайте новое [расписание](shared-resources/schedules.md#creating-a-schedule) и свяжите его с **AutoStop_CreateAlert_Parent** runbook, добавив в `VMList` параметр список, разделенный запятой имен VM.

2. Дополнительно, если вы хотите исключить некоторые ВМ из автоматического выключения, вы можете добавить запятой разделенных список имен VM к переменной. `External_ExcludeVMNames`

## <a name="configure-email-notifications"></a>Настройка уведомлений по электронной почте

Чтобы изменить уведомления электронной почты после развертывания решения, измените группу действий, созданную во время развертывания.  

> [!NOTE]
> Подписки в облаке правительства Azure не поддерживают функциональность электронной почты этого решения.

1. На портале Azure перейдите на **Monitor**, затем **группы действий.** Выберите группу действий под названием **StartStop_VM_Notication**.

    ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-monitor.png)

2. На странице **StartStop_VM_Notification** в разделе **Сведения** щелкните **Изменить сведения**. Откроется страница **Электронная почта, SMS, push-уведомление, голосовой вызов**. Измените адрес электронной почты и нажмите кнопку **ОК**, чтобы сохранить изменения.

    ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/change-email.png)

    Кроме того, можно добавить дополнительные действия в группу действий. Дополнительные сведения о группах действий см. в статье [Группы действий](../azure-monitor/platform/action-groups.md)

Ниже приведен пример сообщения электронной почты, которое отправляется, когда решение завершает работу виртуальных машин.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/email.png)

## <a name="addexclude-vms"></a><a name="add-exclude-vms"></a>Добавление и исключение виртуальных машин

Решение позволяет добавлять виртуальные машины, на которые будет нацелено решение, или явно исключать компьютеры для решения.

### <a name="add-a-vm"></a>Добавление виртуальной машины

Есть два варианта, которые можно использовать, чтобы убедиться, что VM включен в решение Start/Stop при его запуске.

* Каждый из родительских [книг](automation-solution-vm-management.md#runbooks) решения `VMList` имеет параметр. Вы можете передать запятой разделенных список имен VM к этому параметру при планировании соответствующего родительского runbook для вашей ситуации, и эти VMs будут включены, когда решение работает.

* Чтобы выбрать несколько `External_Start_ResourceGroupNames` ВМ, установите и `External_Stop_ResourceGroupNames` с именами группы ресурсов, которые содержат VMs вы хотите начать или остановить. Можно также установить переменные на `*` значение, чтобы решение было запущено против всех групп ресурсов в подписке.

### <a name="exclude-a-vm"></a>Исключение виртуальной машины

Чтобы исключить VM из решения, можно добавить его в переменную. `External_ExcludeVMNames` Эта переменная представляет собой запятый, разделенный список конкретных VMs, чтобы исключить из решения Start/Stop. В этом списке можно использовать до 140 виртуальных машин. Если вы добавите более 140 ВМ в этот список, разделенный на запятую, вибрируют, которые будут исключены, могут быть непреднамеренно запущены или остановлены.

## <a name="modify-the-startup-and-shutdown-schedules"></a>Изменение расписаний запуска и завершения работы

Действия по управлению расписанием запуска и завершения работы в этом решении аналогичны описанным в статье [Создание расписания для Runbook в службе автоматизации Azure](automation-schedules.md). Требуется отдельное расписание для запуска и остановки виртуальных машин.

Поддерживается настройка решения только для остановки виртуальных машин в определенное время. В этом сценарии вы просто создаете расписание **«Стоп»** и не соответствует расписанию **запуска.** Для этого необходимо выполнить следующие действия.

1. Убедитесь, что вы добавили группы ресурсов `External_Stop_ResourceGroupNames` для закрытия в переменной.

2. Создайте собственное расписание для времени завершения работы виртуальных машин.

3. Перейдите к runbook **ScheduledStartStop_Parent** и щелкните **Расписание**. Это позволит выбрать расписание, созданное на предыдущем шаге.

4. Выберите **параметры и запустите настройки** и установите поле **ACTION** для **остановки.**

5. Нажмите кнопку **ОК** , чтобы сохранить изменения.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы узнать, как устранить неполадки [Troubleshooting Start/Stop VMs](troubleshoot/start-stop-vm.md)Start/Stop VMs в нерабочее время, см.

* [Просмотрите](automation-solution-vm-management-logs.md) записи автоматизации, написанные в журналах Azure Monitor, и запросы поиска на примере для поиска, чтобы проанализировать состояние заданий запуска автоматизации с ми-мисток Start/Stop.
