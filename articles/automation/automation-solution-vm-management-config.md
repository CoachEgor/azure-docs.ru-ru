---
title: Настройка решения Start/Stop VMs
description: В этой статье описывается, как настроить Start/Stop VMs в нерабочее время для поддержки различных случаев использования или сценариев.
services: automation
ms.subservice: process-automation
ms.date: 04/01/2020
ms.topic: conceptual
ms.openlocfilehash: d3ca8d17d6637f0ab2b5a5d3d7a99ac0beaafd2e
ms.sourcegitcommit: 980c3d827cc0f25b94b1eb93fd3d9041f3593036
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2020
ms.locfileid: "80550387"
---
# <a name="how-to-configure-startstop-vms-during-off-hours-solution"></a>Как настроить Решение Start/Stop VMs в нерабочее время

С решением Start/Stop VMs в нерабочее время вы можете:

- [Расписание VMs, чтобы начать и остановить](#schedule).
- Расписание VMs для запуска и остановки в порядке возрастания [с помощью tags Azure](#tags) (не поддерживается для классических VM).
- Автоматическая остановка VMs на основе [низкого использования процессора.](#cpuutil)

В этой статье описывается, как успешно настроить решение для поддержки этих сценариев. Вы также можете узнать, как выполнить другие общие настройки конфигурации для решения, такие как:

* [Настройка уведомлений по электронной почте](#configure-email-notifications)

* [Добавление виртуальной машины](#add-a-vm)

* [Исключение виртуальной машины](#exclude-a-vm)

* [Изменение расписаний запуска и завершения работы](#modify-the-startup-and-shutdown-schedules)

## <a name="scenario-1-startstop-vms-on-a-schedule"></a><a name="schedule"></a>Сценарий 1. Запуск и остановка виртуальных машин по расписанию

Это конфигурация по умолчанию, используемая после первого развертывания решения. Например, можно настроить ее, чтобы останавливать все виртуальные машины в подписке вечером, когда вы уходите с работы, и запускать их утром, когда вы возвращаетесь в офис. Если настроить расписания **Scheduled-StartVM** и **Scheduled-StopVM** во время развертывания, они будут запускать и останавливать целевые виртуальные машины. Можно настроить это решение только для остановки виртуальных машин. Ознакомьтесь с разделом [Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия) в службе автоматизации Azure](#modify-the-startup-and-shutdown-schedules), чтобы узнать, как настроить пользовательское расписание.

> [!NOTE]
> Используется часовой пояс, указанный при настройке параметра времени расписания. Однако он хранится в службе автоматизации Azure в формате UTC. Нет необходимости преобразовывать часовой пояс, так как это делается во время развертывания.

Можно выбрать виртуальные машины в области действия с помощью переменных **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames**.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Настройте переменные **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames** для указания целевых виртуальных машин.

2. Включите и обновите расписания **Scheduled-StartVM** и **Scheduled-StopVM**.

3. Запустите runbook **ScheduledStartStop_Parent**, указав для параметра ACTION значение **start**, а для параметра WHATIF — значение **True**, чтобы воспользоваться предварительным просмотром изменений.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Запустите runbook **ScheduledStartStop_Parent**, указав для параметра ACTION значение **start**, добавьте разделенный запятыми список виртуальных машин в параметр *VMList* и укажите для параметра WHATIF значение **True**. Воспользуйтесь предварительным просмотром изменений.

2. Настройте параметр **External_ExcludeVMNames**, указав разделенный запятыми список виртуальных машин (ВМ1, ВМ2, ВМ3).

3. В этом сценарии переменные **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupnames** не учитываются. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

    > [!NOTE]
    > Значение переменной **Target ResourceGroup Names** (Имена целевых групп ресурсов) хранится в качестве значений переменных **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames**. Чтобы увеличить степень детализации, можно изменить эти переменные для различных групп ресурсов. Для действия запуска используйте **External_Start_ResourceGroupNames**, а для действия остановки — **External_Stop_ResourceGroupNames**. Виртуальные машины автоматически добавляются в расписания запуска и остановки.

## <a name="scenario-2-startstop-vms-in-sequence-by-using-tags"></a><a name="tags"></a>Сценарий 2. Последовательный запуск и остановка виртуальных машин с помощью тегов

В среде, которая включает в себя два или более компонентов, работающих на нескольких виртуальных машинах, которые поддерживают распределенную рабочую нагрузку, важно наличие поддержки последовательного запуска и остановки компонентов в нужном порядке. Чтобы обеспечить это, выполните следующие действия.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Добавьте **sequencestart** и тег **sequencestop** с положительным значением для vMs, которые ориентированы на **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames** переменных. Действия запуска и остановки будут выполняться в порядке возрастания. Чтобы узнать, как добавить тег к виртуальной машине, ознакомьтесь с разделами [Пометка виртуальной машины Windows в Azure](../virtual-machines/windows/tag.md) и [Пометка виртуальной машины Linux в Azure](../virtual-machines/linux/tag.md).

2. Измените расписания **Sequenced-StartVM** и **Sequenced-StopVM**, указав даты и время в соответствии со своими требованиями, после чего включите эти расписания.

3. Запустите runbook **SequencedStartStop_Parent**, указав для параметра ACTION значение **start**, а для параметра WHATIF — значение **True**, чтобы воспользоваться предварительным просмотром изменений.

4. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, можно будет вручную запустить runbook с параметром, имеющим значение **False**. Можно также позволить автоматический запуск расписаний службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM**, которые вы задали.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Добавьте теги **sequencestart** и **sequencestop** со значением в виде положительного целого числа для виртуальных машин, которые вы планируете добавить в параметр **VMList**.

2. Запустите runbook **SequencedStartStop_Parent**, указав для параметра ACTION значение **start**, добавьте разделенный запятыми список виртуальных машин в параметр *VMList* и укажите для параметра WHATIF значение **True**. Воспользуйтесь предварительным просмотром изменений.

3. Настройте параметр **External_ExcludeVMNames**, указав разделенный запятыми список виртуальных машин (ВМ1, ВМ2, ВМ3).

4. В этом сценарии переменные **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupnames** не учитываются. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

5. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, можно будет вручную запустить monitoring-and-diagnostics/monitoring-action-groupsrunbook с параметром, имеющим значение **False**. Можно также разрешить автоматический запуск расписаний службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM**, которые вы задали.

## <a name="scenario-3-startstop-automatically-based-on-cpu-utilization"></a><a name="cpuutil"></a>Сценарий 3. Автоматический запуск и остановка на основе загрузки ЦП

Это решение может помочь управлять затратами на запуск управления ресурсами Azure и классических виртуальных машин в подписке, оценивая виртуальные технологии, которые не используются в непиковые периоды, например в нерабочее время, и автоматически выключая их, если использование процессора меньше определенного процента.

По умолчанию это решение предварительно настроено для оценки метрики "Загрузка ЦП", и оно проверяет, составляет ли средняя загрузка 5 % или меньше. Для управления сценарием используются следующие переменные, которые можно изменить, если их значения по умолчанию не удовлетворяют ваши требования:

* **External_AutoStop_MetricName;**

* **External_AutoStop_Threshold;**

* **External_AutoStop_TimeAggregationOperator;**

* **External_AutoStop_TimeWindow.**

* **External_AutoStop_Frequency**

* **External_AutoStop_Severity**

Вы можете включить и настроить таргетинг действия против группы подписчиков и ресурсов, а также настроить таргетинг на определенный список вс-ми.

При запуске **AutoStop_CreateAlert_Parent** runbook проверяется, что целевая подписка, группа ресурсов (ы) и VM существуют. Если VMs существуют, он затем вызывает **AutoStop_CreateAlert_Child** runbook для каждого проверенного VM родительской книгой. Этот детский runbook выполняет следующее:

* Создает правило предупреждения метрики для каждого проверенного VM.

* Триггеры **AutoStop_VM_Child** runbook для конкретного VM, если процессор упадет ниже настроенного порога для указанного интервала времени. Этот runbook затем пытается остановить VM.

### <a name="to-target-the-auto-stop-action-against-all-vms-in-a-subscription"></a>Таргетинг на действие автоматической остановки против всех вс-авт.в подписке

1. Убедитесь, что **External_Stop_ResourceGroupNames** переменная пуста или установлена на no (wildcard).

2. (Необязательный шаг) Если вы хотите исключить некоторые ВМ из автоматического выключения, вы можете добавить запятую разделенный список имен VM к **External_ExcludeVMNames** переменной.

3. Включите **Schedule_AutoStop_CreateAlert_Parent** расписание для запуска для создания необходимых правил оповещения метрики Stop VM для всех вашего числа ввашей подписки. Запуск этого по расписанию позволит вам создать новые правила предупреждения метрики по мере добавления в подписку новых вс-да.

### <a name="to-target-the-auto-stop-action-against-all-vms-in-a-resource-groupmultiple-resource-groups"></a>Таргетинг на действие автоматической остановки против всех вс-управлений в группе ресурсов/группах ресурсов

1. Добавьте в **External_Stop_ResourceGroupNames** переменную общий разделенный список имен групп ресурсов.

2. Дополнительно, если вы хотите исключить некоторые из VMs из автоматического выключения, вы можете добавить запятую разделенный список имен VM к **External_ExcludeVMNames** переменной.

3. Включите **Schedule_AutoStop_CreateAlert_Parent** расписание для запуска для создания необходимых правил **оповещения метрики Stop VM** для всех вгрупп ресурсов. Запуск этого по расписанию позволяет создавать новые правила предупреждения метрики по мере добавления новых ВМ в группу ресурсов (ы).

### <a name="to-target-the-auto-stop-action-to-a-list-of-vms"></a>Таргетинг автоматического стоп-акции на список VMs

1. Создайте новое [расписание](shared-resources/schedules.md#creating-a-schedule) и свяжите его с **AutoStop_CreateAlert_Parent** runbook, добавив список разделенных запятых имен VM к параметру **VMList.**

2. Дополнительно, если вы хотите исключить некоторые ВМ из автоматического выключения, вы можете добавить запятую разделенный список имен VM к **External_ExcludeVMNames** переменной.

## <a name="configure-email-notifications"></a>Настройка уведомлений по электронной почте

Чтобы изменить уведомления по электронной почте после развертывания решения, измените группу действий, созданную во время развертывания.  

> [!NOTE]
> Подписки в облаке Azure для государственных организаций не поддерживают функцию электронной почты этого решения.

1. На портале Azure выберите "Монитор" > "Группы действий". Выберите группу действий под названием **StartStop_VM_Notication**.

    ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-monitor.png)

2. На странице **StartStop_VM_Notification** в разделе **Сведения** щелкните **Изменить сведения**. Откроется страница **Электронная почта, SMS, push-уведомление, голосовой вызов**. Измените адрес электронной почты и нажмите кнопку **ОК**, чтобы сохранить изменения.

    ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/change-email.png)

    Кроме того, можно добавить дополнительные действия в группу действий. Дополнительные сведения о группах действий см. в статье [Группы действий](../azure-monitor/platform/action-groups.md)

Ниже приведен пример сообщения электронной почты, которое отправляется, когда решение завершает работу виртуальных машин.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/email.png)

## <a name="addexclude-vms"></a><a name="add-exclude-vms"></a>Добавление и исключение виртуальных машин

Решение позволяет добавлять виртуальные машины, на которые будет нацелено решение, или явно исключать компьютеры для решения.

### <a name="add-a-vm"></a>Добавление виртуальной машины

Есть два варианта, которые можно использовать, чтобы убедиться, что VM включен в решение Start/Stop при его запуске.

* Каждая из родительских [книг](automation-solution-vm-management.md#runbooks) решения имеет параметр **VMList.** Вы можете передать запятой разделенных список имен VM к этому параметру при планировании соответствующего родительского runbook для вашей ситуации, и эти VMs будут включены, когда решение работает.

* Чтобы выбрать несколько виртуальных машин, укажите для параметров **External_Start_ResourceGroupNames** и **External_Stop_ResourceGroupNames** имена групп ресурсов, содержащих виртуальные машины, которые необходимо запустить или остановить. Вы также можете указать для этих параметров значение `*`, чтобы запустить решение для всех групп ресурсов в подписке.

### <a name="exclude-a-vm"></a>Исключение виртуальной машины

Чтобы исключить виртуальную машину для решения, вы можете добавить ее к переменной **External_ExcludeVMNames**. Эта переменная представляет собой запятый, разделенный список конкретных VMs, чтобы исключить из решения Start/Stop. В этом списке можно использовать до 140 виртуальных машин. Если вы добавите более 140 ВМ в этот список, разделенный на запятую, вибрируют, которые будут исключены, могут быть непреднамеренно запущены или остановлены.

## <a name="modify-the-startup-and-shutdown-schedules"></a>Изменение расписаний запуска и завершения работы

Действия по управлению расписанием запуска и завершения работы в этом решении аналогичны описанным в статье [Создание расписания для Runbook в службе автоматизации Azure](automation-schedules.md). Требуется отдельное расписание для запуска и остановки виртуальных машин.

Поддерживается настройка решения только для остановки виртуальных машин в определенное время. В этом сценарии вы просто создаете расписание **остановки** без расписания **запуска**. Для этого необходимо выполнить следующие действия.

1. Убедитесь, что вы добавили группы ресурсов для виртуальных машин, работу которых требуется завершить, в переменную **External_Stop_ResourceGroupNames**.

2. Создайте собственное расписание для времени завершения работы виртуальных машин.

3. Перейдите к runbook **ScheduledStartStop_Parent** и щелкните **Расписание**. Это позволит выбрать расписание, созданное на предыдущем шаге.

4. Выберите **параметры и запустите настройки** и установите параметр **ACTION** для **остановки.**

5. Нажмите кнопку **ОК** , чтобы сохранить изменения.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы узнать, как устранить неполадки [Troubleshooting Start/Stop VMs](troubleshoot/start-stop-vm.md)Start/Stop VMs в нерабочее время, см.

* [Просмотрите](automation-solution-vm-management-logs.md) записи автоматизации, написанные в журналах Azure Monitor, и запросы поиска на примере для поиска, чтобы проанализировать состояние заданий запуска автоматизации с ми-мисток Start/Stop.
