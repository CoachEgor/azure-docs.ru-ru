---
title: Решение "Настройка Запуск и остановка виртуальных машин в нерабочее времяного решения службы автоматизации Azure"
description: В этой статье описывается, как настроить решение Запуск и остановка виртуальных машин в нерабочее время для поддержки различных вариантов использования или сценариев.
services: automation
ms.subservice: process-automation
ms.date: 04/01/2020
ms.topic: conceptual
ms.openlocfilehash: 4cceb0d5ada82de73bc74c0ed408f8eb988ea8ec
ms.sourcegitcommit: 602e6db62069d568a91981a1117244ffd757f1c2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82864272"
---
# <a name="how-to-configure-startstop-vms-during-off-hours-solution"></a>Настройка решения Запуск и остановка виртуальных машин в нерабочее время

С помощью **Запуск и остановка виртуальных машин в нерабочее времяного** решения можно:

- [Запланируйте запуск и завершение виртуальных машин](#schedule).
- Запланируйте запуск и завершение виртуальных машин в возрастающем порядке с [помощью тегов Azure](#tags) (не поддерживается для классических виртуальных машин).
- Автоматическая блокировка виртуальных машин на основе [низкой загрузки ЦП](#cpuutil).

В этой статье описывается, как успешно настроить решение для поддержки этих сценариев. Вы также можете узнать, как выполнять другие общие параметры конфигурации для решения, например:

* [Настройка уведомлений по электронной почте](#configure-email-notifications)

* [Добавление виртуальной машины](#add-a-vm)

* [Исключение виртуальной машины](#exclude-a-vm)

* [Изменение расписаний запуска и завершения работы](#modify-the-startup-and-shutdown-schedules)

## <a name="scenario-1-startstop-vms-on-a-schedule"></a><a name="schedule"></a>Сценарий 1. Запуск и остановка виртуальных машин по расписанию

Это конфигурация по умолчанию, используемая после первого развертывания решения. Например, можно настроить ее, чтобы останавливать все виртуальные машины в подписке вечером, когда вы уходите с работы, и запускать их утром, когда вы возвращаетесь в офис. Если настроить расписания **Scheduled-StartVM** и **Scheduled-StopVM** во время развертывания, они будут запускать и останавливать целевые виртуальные машины. Можно настроить это решение только для остановки виртуальных машин. Ознакомьтесь с разделом [Решение для запуска и остановки виртуальных машин в нерабочее время (предварительная версия) в службе автоматизации Azure](#modify-the-startup-and-shutdown-schedules), чтобы узнать, как настроить пользовательское расписание.

> [!NOTE]
> Используется часовой пояс, указанный при настройке параметра времени расписания. Однако он хранится в службе автоматизации Azure в формате UTC. Нет необходимости преобразовывать часовой пояс, так как это делается во время развертывания.

Можно выбрать виртуальные машины в области действия с помощью переменных **External_Start_ResourceGroupNames**, **External_Stop_ResourceGroupNames** и **External_ExcludeVMNames**.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Настройте переменные `External_Stop_ResourceGroupNames` и `External_ExcludeVMNames` , чтобы указать целевые виртуальные машины.

2. Включите и обновите расписания **Scheduled-StartVM** и **Scheduled-StopVM**.

3. Запустите модуль Runbook **ScheduledStartStop_Parent** , указав в поле параметр **действия** значение **Start** , а для поля параметр **WHATIF** — значение true, чтобы просмотреть изменения.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Запустите модуль **runbook ScheduledStartStop_Parent** с параметром **действие** **Запуск**, добавьте список виртуальных машин с разделителями-запятыми в поле параметра **VMList** , а затем задайте для поля параметра **WHATIF** значение true. Воспользуйтесь предварительным просмотром изменений.

2. Настройте `External_ExcludeVMNames` переменную с помощью разделенного запятыми списка виртуальных машин (VM1, VM2, VM3).

3. Этот сценарий не учитывает переменные `External_Start_ResourceGroupNames` и. `External_Stop_ResourceGroupnames` Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

    > [!NOTE]
    > Значение для **имен целевых ресурсов** хранения сохраняется как значение для `External_Start_ResourceGroupNames` и. `External_Stop_ResourceGroupNames` Чтобы увеличить степень детализации, можно изменить эти переменные для различных групп ресурсов. Для действия Запуск, используйте `External_Start_ResourceGroupNames`и используйте `External_Stop_ResourceGroupNames` для действия "приостанавливает". Виртуальные машины автоматически добавляются в расписания запуска и остановки.

## <a name="scenario-2-startstop-vms-in-sequence-by-using-tags"></a><a name="tags"></a>Сценарий 2. Последовательный запуск и остановка виртуальных машин с помощью тегов

В среде, которая включает в себя два или более компонентов, работающих на нескольких виртуальных машинах, которые поддерживают распределенную рабочую нагрузку, важно наличие поддержки последовательного запуска и остановки компонентов в нужном порядке. Чтобы обеспечить это, выполните следующие действия.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Добавьте `sequencestart` и `sequencestop` тег с положительным целочисленным значением для виртуальных машин, целевых в `External_Start_ResourceGroupNames` переменные и `External_Stop_ResourceGroupNames` . Действия запуска и остановки будут выполняться в порядке возрастания. Чтобы узнать, как добавить тег к виртуальной машине, ознакомьтесь с разделами [Пометка виртуальной машины Windows в Azure](../virtual-machines/windows/tag.md) и [Пометка виртуальной машины Linux в Azure](../virtual-machines/linux/tag.md).

2. Измените расписания **Sequenced-StartVM** и **Sequenced-StopVM**, указав даты и время в соответствии со своими требованиями, после чего включите эти расписания.

3. Запустите модуль Runbook **SequencedStartStop_Parent** с параметром **действие** **запустить** , а для параметра **WHATIF** — значение true, чтобы просмотреть изменения.

4. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, вручную выполните модуль Runbook с параметром, для которого задано **значение false**, или настройте расписание `Sequenced-StartVM` автоматизации и `Sequenced-StopVM` запустите его автоматически после определенного расписания.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Добавьте `sequencestart` и `sequencestop` тег с положительным целым значением в виртуальные машины, которые планируется добавить в `VMList` параметр.

2. Запустите модуль **runbook SequencedStartStop_Parent** с параметром **действие** **Запуск**, добавьте список виртуальных машин с разделителями-запятыми в поле параметра **VMList** , а затем задайте для **WHATIF** значение true. Воспользуйтесь предварительным просмотром изменений.

3. Настройте `External_ExcludeVMNames` переменную с помощью разделенного запятыми списка виртуальных машин (VM1, VM2, VM3).

4. Этот сценарий не учитывает переменные `External_Start_ResourceGroupNames` и. `External_Stop_ResourceGroupnames` Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для Runbook в службе автоматизации Azure](../automation/automation-schedules.md).

5. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, вручную выполните **мониторинг-and-Diagnostics/Monitoring-Action-граупсрунбук** с параметром, для которого установлено значение **false**. Кроме того, пусть расписание `Sequenced-StartVM` автоматизации и `Sequenced-StopVM` запускается автоматически после определенного расписания.

## <a name="scenario-3-startstop-automatically-based-on-cpu-utilization"></a><a name="cpuutil"></a>Сценарий 3. Автоматический запуск и остановка на основе загрузки ЦП

Это решение может помочь в управлении затратами на выполнение Azure Resource Manager и классических виртуальных машин в подписке, оценивая виртуальные машины, которые не используются в периоды пиковых нагрузок, например спустя час, и автоматически завершают их работу, если загрузка процессора меньше заданного процента.

По умолчанию это решение предварительно настроено для оценки метрики "Загрузка ЦП", и оно проверяет, составляет ли средняя загрузка 5 % или меньше. Этот сценарий управляется следующими переменными и может быть изменен, если значения по умолчанию не соответствуют вашим требованиям:

* `External_AutoStop_MetricName`
* `External_AutoStop_Threshold`
* `External_AutoStop_TimeAggregationOperator`
* `External_AutoStop_TimeWindow`
* `External_AutoStop_Frequency`
* `External_AutoStop_Severity`

Вы можете включить действие и выбрать его для подписки и группы ресурсов или выбрать конкретный список виртуальных машин.

При запуске модуля Runbook **AutoStop_CreateAlert_Parent** он проверяет, существует ли Целевая подписка, группы ресурсов и виртуальные машины. Если виртуальные машины существуют, модуль Runbook вызывает **AutoStop_CreateAlert_Child** Runbook для каждой ПРОВЕРЕННОЙ виртуальной машины родительским модулем Runbook. Этот дочерний модуль Runbook выполняет следующие действия:

* Создает правило генерации оповещений метрик для каждой проверенной виртуальной машины.

* Запускает **AutoStop_VM_Child** Runbook для конкретной виртуальной машины, если ЦП падает ниже заданного порогового значения для указанного интервала времени. Затем этот Runbook пытается отключить виртуальную машину.

### <a name="to-target-the-auto-stop-action-against-all-vms-in-a-subscription"></a>Настройка автоматического завершения действия для всех виртуальных машин в подписке

1. Убедитесь, что `External_Stop_ResourceGroupNames` переменная пуста или имеет значение * (подстановочный знак).

2. [Необязательный шаг] Если вы хотите исключить некоторые виртуальные машины из автоматического завершения работы, в `External_ExcludeVMNames` переменную можно добавить разделенный запятыми список имен виртуальных машин.

3. Включите `Schedule_AutoStop_CreateAlert_Parent` расписание для запуска, чтобы создать необходимые правила оповещений МЕТРИК виртуальной машины для всех виртуальных машин в подписке. Запуск этого типа расписания позволяет создавать новые правила генерации оповещений метрик по мере добавления новых виртуальных машин в подписку.

### <a name="to-target-the-auto-stop-action-against-all-vms-in-a-resource-group-or-multiple-resource-groups"></a>Настройка автоматического завершения действия для всех виртуальных машин в группе ресурсов или нескольких групп ресурсов

1. Добавьте разделенный запятыми список имен групп ресурсов в `External_Stop_ResourceGroupNames` переменную.

2. Если вы хотите исключить некоторые из виртуальных машин из автоматического завершения работы, в `External_ExcludeVMNames` переменную можно добавить разделенный запятыми список имен виртуальных машин.

3. Включите расписание выполнения **Schedule_AutoStop_CreateAlert_Parent** , чтобы создать необходимые правила оповещений МЕТРИК виртуальной машины для всех виртуальных машин в группах ресурсов. Выполнение этой операции по расписанию позволяет создавать новые правила генерации оповещений метрик по мере добавления новых виртуальных машин в группы ресурсов.

### <a name="to-target-the-autostop-action-to-a-list-of-vms"></a>Назначение действия "Автозавершение" списку виртуальных машин

1. Создайте новое [Расписание](shared-resources/schedules.md#create-a-schedule) и свяжите его с **AutoStop_CreateAlert_Parent** модулем Runbook, добавив разделенный запятыми список имен виртуальных машин `VMList` в параметр.

2. Кроме того, если требуется исключить некоторые виртуальные машины из автоматического завершения работы, можно добавить в `External_ExcludeVMNames` переменную список имен виртуальных машин с разделителями-запятыми.

## <a name="configure-email-notifications"></a>Настройка уведомлений по электронной почте

Чтобы изменить уведомления по электронной почте после развертывания решения, измените группу действий, созданную во время развертывания.  

> [!NOTE]
> Подписки в облаке Azure для государственных организаций не поддерживают функции электронной почты этого решения.

1. В портал Azure перейдите к **монитору**, а затем **группы действий**. Выберите группу действий с именем **StartStop_VM_Notication**.

    ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/azure-monitor.png)

2. На странице **StartStop_VM_Notification** в разделе **Сведения** щелкните **Изменить сведения**. Откроется страница **Электронная почта, SMS, push-уведомление, голосовой вызов**. Измените адрес электронной почты и нажмите кнопку **ОК**, чтобы сохранить изменения.

    ![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/change-email.png)

    Кроме того, можно добавить дополнительные действия в группу действий. Дополнительные сведения о группах действий см. в статье [Группы действий](../azure-monitor/platform/action-groups.md)

Ниже приведен пример сообщения электронной почты, которое отправляется, когда решение завершает работу виртуальных машин.

![Страница обновления решения по управлению в службе автоматизации](media/automation-solution-vm-management/email.png)

## <a name="addexclude-vms"></a><a name="add-exclude-vms"></a>Добавление и исключение виртуальных машин

Решение позволяет добавлять виртуальные машины, на которые будет нацелено решение, или явно исключать компьютеры для решения.

### <a name="add-a-vm"></a>Добавление виртуальной машины

Существует два варианта, которые можно использовать, чтобы убедиться, что виртуальная машина включена в решение запуска/окончания при запуске.

* Каждый из родительских [модулей Runbook](automation-solution-vm-management.md#runbooks) решения имеет `VMList` параметр. Вы можете передать список имен виртуальных машин с разделителями-запятыми в этот параметр при планировании соответствующего родительского модуля Runbook для вашей ситуации, и эти виртуальные машины будут включаться при запуске решения.

* Чтобы выбрать несколько виртуальных машин, `External_Start_ResourceGroupNames` укажите `External_Stop_ResourceGroupNames` и с именами групп ресурсов, которые содержат виртуальные машины, которые необходимо запустить или отключить. Можно также задать для переменных значение, `*` чтобы решение выполнялось для всех групп ресурсов в подписке.

### <a name="exclude-a-vm"></a>Исключение виртуальной машины

Чтобы исключить виртуальную машину из решения, можно добавить ее в `External_ExcludeVMNames` переменную. Эта переменная представляет собой разделенный запятыми список конкретных виртуальных машин, исключаемых из решения запуска/окончания. В этом списке можно использовать до 140 виртуальных машин. Если добавить более 140 виртуальных машин в этот список с разделителями-запятыми, виртуальные машины, для которых настроено исключение, могут быть случайно запущены или остановлены.

## <a name="modify-the-startup-and-shutdown-schedules"></a>Изменение расписаний запуска и завершения работы

Действия по управлению расписанием запуска и завершения работы в этом решении аналогичны описанным в статье [Создание расписания для Runbook в службе автоматизации Azure](automation-schedules.md). Требуется отдельное расписание для запуска и остановки виртуальных машин.

Поддерживается настройка решения только для остановки виртуальных машин в определенное время. В этом сценарии вы просто создаете расписание **отмены** и не имеет соответствующего расписания **запуска** . Для этого необходимо выполнить следующие действия.

1. Убедитесь, что вы добавили группы ресурсов для виртуальных машин, чтобы завершить работу в `External_Stop_ResourceGroupNames` переменной.

2. Создайте собственное расписание для времени завершения работы виртуальных машин.

3. Перейдите к runbook **ScheduledStartStop_Parent** и щелкните **Расписание**. Это позволит выбрать расписание, созданное на предыдущем шаге.

4. Выберите **Параметры и параметры запуска** и задайте для поля **действие** значение **прерывать**.

5. Нажмите кнопку **OK**, чтобы сохранить изменения.

## <a name="next-steps"></a>Дальнейшие действия

* Сведения об устранении неполадок в Запуск и остановка виртуальных машин в нерабочее время см. в разделе [Устранение неполадок при запуске и отмене виртуальных машин](troubleshoot/start-stop-vm.md).

* [Ознакомьтесь](automation-solution-vm-management-logs.md) с записями службы автоматизации, записанными в журналы Azure Monitor, и примерами запросов поиска по журналам, чтобы проанализировать состояние заданий Runbook службы автоматизации на виртуальных машинах запуска и отмены.
