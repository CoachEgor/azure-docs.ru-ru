---
title: Запуск Runbook службы автоматизации Azure с помощью объекта webhook
description: Объект Webhook, который позволяет клиенту запустить модуль Runbook в службе автоматизации Azure с помощью HTTP-запроса.  В статье рассматривается создание объекта Webhook и вызов такого объекта для запуска модуля Runbook.
services: automation
ms.subservice: process-automation
ms.date: 01/16/2020
ms.topic: conceptual
ms.openlocfilehash: 043350db2c5372fc81fbb2b68155a4ac75457208
ms.sourcegitcommit: 509b39e73b5cbf670c8d231b4af1e6cfafa82e5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2020
ms.locfileid: "78373419"
---
# <a name="starting-an-azure-automation-runbook-with-a-webhook"></a>Запуск Runbook службы автоматизации Azure с помощью объекта webhook

Веб-перехватчик позволяет внешней службе запускать определенный модуль Runbook из службы автоматизации Azure с помощью одного HTTP-запроса. К внешним службам относятся Azure DevOps Services, GitHub, Azure Monitor журналы и пользовательские приложения. Такая служба может использовать веб-перехватчик для запуска модуля Runbook без реализации полного решения с помощью API службы автоматизации Azure. Вы можете сравнить веб-перехватчики с другими методами запуска модуля Runbook при [запуске модуля Runbook в службе автоматизации Azure](automation-starting-a-runbook.md).

> [!NOTE]
> Использование веб-перехватчика для запуска Runbook Python не поддерживается.

![вебхуксовервиев](media/automation-webhooks/webhook-overview-image.png)

>[!NOTE]
>Эта статья была изменена и теперь содержит сведения о новом модуле Az для Azure PowerShell. Вы по-прежнему можете использовать модуль AzureRM, исправления ошибок для которого будут продолжать выпускаться как минимум до декабря 2020 г. Дополнительные сведения о совместимости модуля Az с AzureRM см. в статье [Introducing the new Azure PowerShell Az module](https://docs.microsoft.com/powershell/azure/new-azureps-module-az?view=azps-3.5.0) (Знакомство с новым модулем Az для Azure PowerShell). Инструкции по установке AZ Module в гибридной рабочей роли Runbook см. в статье [Установка модуля Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps?view=azps-3.5.0). Для учетной записи службы автоматизации можно обновить модули до последней версии, используя [обновление модулей Azure PowerShell в службе автоматизации Azure](automation-update-azure-modules.md).

## <a name="webhook-properties"></a>Свойства веб-перехватчика

В следующей таблице описаны свойства, которые необходимо настроить для объекта Webhook.

| Свойство | Описание |
|:--- |:--- |
| Имя |Имя веб-перехватчика. Вы можете указать любое имя, так как оно не будет предоставлено клиенту. Имя используется для идентификации модуля Runbook в службе автоматизации Azure. Рекомендуется задать веб-перехватчику имя, связанное с клиентом, который будет его использовать. |
| URL-адрес |URL веб-перехватчика. Это уникальный адрес, который клиент вызывает с HTTP POST для запуска модуля Runbook, связанного с веб-перехватчиком. URL-адрес создается автоматически при создании веб-перехватчика. Нельзя указать другой URL-адрес. <br> <br> URL-адрес содержит маркер безопасности, который позволяет системе стороннего производителя вызывать модуль Runbook без дополнительной проверки подлинности. По этой причине URL-адрес следует рассматривать как пароль. По соображениям безопасности URL-адрес может быть только доступен в портал Azure при создании обработчика. Запишите URL-адрес в надежном месте, чтобы использовать его в дальнейшем. |
| Дата окончания срока действия | Дата окончания срока действия веб-перехватчика, после чего он больше не может использоваться. Вы можете изменить дату истечения срока действия после создания веб-перехватчика, если не истек срок его действия. |
| Активировать | Параметр, указывающий, включен ли веб-перехватчик по умолчанию при его создании. Если для этого свойства задано значение отключено, клиент не может использовать веб-перехватчик. Это свойство можно задать при создании веб-перехватчика или в любое другое время после его создания. |

## <a name="parameters-used-when-the-webhook-starts-a-runbook"></a>Параметры, используемые при запуске веб-перехватчика Runbook

Веб-перехватчик может определять значения параметров модуля Runbook, которые используются при запуске модуля Runbook. Веб-перехватчик должен включать значения для всех обязательных параметров Runbook и может включать значения для необязательных параметров. Значение параметра, настроенное для веб-перехватчика, можно изменить даже после создания веб-перехватчика. Несколько веб-перехватчиков, связанных с одним модулем Runbook, могут использовать различные значения параметров Runbook. Когда клиент запускает модуль Runbook с помощью веб-перехватчика, клиент не может переопределить значения параметров, определяемые веб-перехватчиком.

Для получения данных от клиента Runbook поддерживает один параметр с именем *WebhookData*. Этот параметр определяет объект, содержащий данные, которые клиент включает в запрос POST.

![Свойства WebhookData](media/automation-webhooks/webhook-data-properties.png)

Параметр *WebhookData* имеет следующие свойства.

| Свойство | Описание |
|:--- |:--- |
| WebhookName | Имя веб-перехватчика. |
| RequestHeader | Хэш-таблица, содержащая заголовки входящего запроса POST. |
| RequestBody | Текст входящего запроса POST. В этом тексте поддерживается форматирование данных, например String, JSON, XML или Form-Encoded. Модуль Runbook должен быть написан для работы с форматом данных, который ожидается. |

Для поддержки параметра *WebhookData* не требуется настраивать веб-перехватчик, а Runbook не должен его принимать. Если модуль Runbook не определяет параметр, все сведения о запросе, отправленном клиентом, игнорируются.

> [!NOTE]
> При вызове веб-перехватчика клиент всегда должен сохранять значения параметров в случае сбоя вызова. В случае сбоя сети или проблемы с подключением приложение не сможет получить вызовы веб-перехватчика, завершившиеся сбоем.

Если указать значение для *WebhookData* при создании веб-перехватчика, оно будет переопределено при запуске веб-перехватчика с данными из запроса POST клиента. Это происходит, даже если приложение не содержит никаких данных в тексте запроса. 

При запуске модуля Runbook, который определяет *WebhookData* с помощью механизма, отличного от веб-перехватчика, можно указать значение для *WebhookData* , распознаваемый модулем Runbook. Это значение должно быть объектом с теми же [свойствами](#webhook-properties) , что и параметр *WebhookData* , чтобы модуль Runbook мог работать с ним так же, как он работает с фактическими объектами *WebhookData* , передаваемыми веб-перехватчиком.

Например, если вы запускаете следующий модуль Runbook из портал Azure и хотите передать некоторые примеры данных веб-перехватчика для тестирования, необходимо передать данные в формате JSON в пользовательском интерфейсе.

![Параметр WebhookData из пользовательского интерфейса](media/automation-webhooks/WebhookData-parameter-from-UI.png)

Для следующего примера Runbook давайте определим следующие свойства *WebhookData*:

* **WebhookName**: мивебхук
* **RequestBody**: `*[{'ResourceGroup': 'myResourceGroup','Name': 'vm01'},{'ResourceGroup': 'myResourceGroup','Name': 'vm02'}]*`

Теперь мы передаем следующий объект JSON в пользовательском интерфейсе для параметра *WebhookData* . Этот пример с символами возврата каретки и новой строки соответствует формату, переданному из веб-перехватчика.

```json
{"WebhookName":"mywebhook","RequestBody":"[\r\n {\r\n \"ResourceGroup\": \"vm01\",\r\n \"Name\": \"vm01\"\r\n },\r\n {\r\n \"ResourceGroup\": \"vm02\",\r\n \"Name\": \"vm02\"\r\n }\r\n]"}
```

![Запуск параметра WebhookData из пользовательского интерфейса](media/automation-webhooks/Start-WebhookData-parameter-from-UI.png)

> [!NOTE]
> Служба автоматизации Azure регистрирует значения всех входных параметров с помощью задания Runbook. Поэтому любые входные данные, предоставляемые клиентом в запросе веб-перехватчика, записываются в журнал и доступны любому пользователю, имеющему доступ к заданию службы автоматизации. По этой причине необходимо соблюдать осторожность при указании критических данных в вызовах Webhook.

## <a name="webhook-security"></a>Безопасность веб-перехватчика

Безопасность веб-перехватчика зависит от конфиденциальности его URL, который содержит маркер безопасности, позволяющий вызывать веб-перехватчик. Служба автоматизации Azure не выполняет проверку подлинности запроса при условии, что он выполняется с правильным URL-адресом. По этой причине клиенты не должны использовать веб-перехватчики для модулей Runbook, которые выполняют строго конфиденциальные операции без использования альтернативного способа проверки запроса.

Можно включить логику в модуль Runbook, чтобы определить, вызывается ли он веб-перехватчиком. Убедитесь, что модуль Runbook проверяет свойство **WebhookName** параметра *WebhookData* . Модуль Runbook может выполнить дополнительную проверку, выполнив поиск конкретной информации в свойствах **рекуессеадер** и **RequestBody** .

Другая стратегия заключается в том, чтобы модуль Runbook выполнил некоторую проверку внешнего условия при получении запроса веб-перехватчика. Например, рассмотрим модуль Runbook, который вызывается GitHub каждый раз, когда в репозиторий GitHub зафиксируется новая фиксация. Модуль Runbook может подключиться к GitHub, чтобы убедиться, что перед продолжением была выполнена новая фиксация.

## <a name="creating-a-webhook"></a>Создание объекта Webhook

Чтобы создать новый веб-перехватчик, связанный с модулем Runbook, на портале Azure, воспользуйтесь следующей процедурой.

1. На странице модули Runbook в портал Azure щелкните модуль Runbook, который запускается веб-перехватчиком, чтобы просмотреть сведения о Runbook. Убедитесь, что поле **состояния** Runbook имеет значение **Опубликовано**.
2. Щелкните веб- **перехватчик** в верхней части страницы, чтобы открыть страницу Добавление веб-перехватчика.
3. Щелкните **создать новый веб-перехватчик** , чтобы открыть страницу создать веб перехватчик.
4. Заполните поля " **имя** " и " **Дата окончания срока действия** " для веб-перехватчика и укажите, следует ли его включить. Дополнительные сведения об этих свойствах см. в разделе [Свойства веб-перехватчика](#webhook-properties) .
5. Щелкните значок копирования и нажмите Ctrl+C, чтобы скопировать URL-адрес объекта Webhook. Сохраните URL-адрес в безопасном месте. 

    > [!NOTE]
    > После создания веб-перехватчика вы не сможете получить его снова.

   ![URL-адрес Webhook](media/automation-webhooks/copy-webhook-url.png)

1. Щелкните **Параметры**, чтобы указать значения для параметров модуля Runbook. Если у модуля Runbook есть обязательные параметры, вы не сможете создать веб-перехватчик, если не указать значения.
1. Щелкните **Создать**, чтобы создать объект Webhook.

## <a name="using-a-webhook"></a>Использование объекта Webhook

Чтобы использовать веб-перехватчик после его создания, клиент должен отправить запрос HTTP POST с URL-адресом для веб-перехватчика. Синтаксис:

```http
http://<Webhook Server>/token?=<Token Value>
```

Клиент получит один из следующих кодов возврата в ответ на запрос POST.

| Код | Text | Описание |
|:--- |:--- |:--- |
| 202 |Принято |Запрос был принят, и модуль Runbook успешно поставлен в очередь. |
| 400 |Неверный запрос |Запрос не был принят по одной из следующих причин: <ul> <li>Срок действия объекта webhook истек.</li> <li>Объект webhook отключен.</li> <li>Недопустимый токен в URL-адресе.</li>  </ul> |
| 404 |Не найдено |Запрос не был принят по одной из следующих причин: <ul> <li>Объект webhook не найден.</li> <li>Модуль Runbook не найден.</li> <li>Учетная запись не найдена.</li>  </ul> |
| 500 |Внутренняя ошибка сервера |URL-адрес допустимый, но произошла ошибка. Отправьте запрос повторно. |

Предполагая, что запрос успешно выполнен, ответ веб-перехватчика содержит идентификатор задания в формате JSON, как показано ниже. Он содержит один идентификатор задания, но формат JSON позволяет возникать будущие улучшения.

```json
{"JobIds":["<JobId>"]}
```

Клиент не может определить момент завершения задания Runbook и состояние его завершения из веб-перехватчика. Эти сведения можно найти с помощью идентификатора задания с другим механизмом, например [Windows PowerShell](https://docs.microsoft.com/powershell/module/servicemanagement/azure/get-azureautomationjob) или [API службы автоматизации Azure](/rest/api/automation/job).

## <a name="renew-webhook"></a>Обновление веб-перехватчика

При создании веб-перехватчика он имеет период действия 10 лет, по истечении которого он автоматически истечет. После истечения срока действия веб-перехватчика его нельзя будет активировать повторно. Вы можете удалить только, а затем создать его заново. 

Вы можете расширить веб-перехватчик, который не достиг времени истечения срока действия. Чтобы расширить веб-перехватчик, сделайте следующее:

1. Перейдите к Runbook, содержащему веб-перехватчик. 
2. Выберите **Веб-перехватчики** в разделе **Ресурсы**. 
3. Щелкните веб-перехватчик, который требуется расширить. 
4. На странице веб-перехватчик выберите новую дату и время окончания срока действия и нажмите кнопку **сохранить**.

## <a name="sample-runbook"></a>Пример Runbook

Следующий пример модуля Runbook принимает данные веб-перехватчика и запускает виртуальные машины, указанные в тексте запроса. Чтобы протестировать этот модуль Runbook, в учетной записи службы автоматизации в разделе **модули Runbook**щелкните **создать Runbook**. Если вы не знаете, как создать модуль Runbook, ознакомьтесь с [этой статьей](automation-quickstart-create-runbook.md).

> [!NOTE]
> Для неграфических модулей Runbook PowerShell **Add-азаккаунт** и **Add-AzureRMAccount** являются псевдонимами для [Connect-азаккаунт](https://docs.microsoft.com/powershell/module/az.accounts/connect-azaccount?view=azps-3.5.0). Вы можете использовать эти командлеты или [обновить модули](automation-update-azure-modules.md) в учетной записи службы автоматизации до последних версий. Вам может потребоваться обновить модули, даже если вы только что создали новую учетную запись службы автоматизации.

```powershell
param
(
    [Parameter (Mandatory = $false)]
    [object] $WebhookData
)

# If runbook was called from Webhook, WebhookData will not be null.
if ($WebhookData) {

    # Check header for message to validate request
    if ($WebhookData.RequestHeader.message -eq 'StartedbyContoso')
    {
        Write-Output "Header has required information"}
    else
    {
        Write-Output "Header missing required information";
        exit;
    }

    # Retrieve VMs from Webhook request body
    $vms = (ConvertFrom-Json -InputObject $WebhookData.RequestBody)

    # Authenticate to Azure by using the service principal and certificate. Then, set the subscription.

    Write-Output "Authenticating to Azure with service principal and certificate"
    $ConnectionAssetName = "AzureRunAsConnection"
    Write-Output "Get connection asset: $ConnectionAssetName"

    $Conn = Get-AutomationConnection -Name $ConnectionAssetName
            if ($Conn -eq $null)
            {
                throw "Could not retrieve connection asset: $ConnectionAssetName. Check that this asset exists in the Automation account."
            }
            Write-Output "Authenticating to Azure with service principal."
            Add-AzAccount -ServicePrincipal -Tenant $Conn.TenantID -ApplicationId $Conn.ApplicationID -CertificateThumbprint $Conn.CertificateThumbprint | Write-Output

        # Start each virtual machine
        foreach ($vm in $vms)
        {
            $vmName = $vm.Name
            Write-Output "Starting $vmName"
            Start-AzVM -Name $vm.Name -ResourceGroup $vm.ResourceGroup
        }
}
else {
    # Error
    write-Error "This runbook is meant to be started from an Azure alert webhook only."
}
```

## <a name="testing-the-sample"></a>Тестирование образца

В следующем примере модуль Runbook запускается с помощью Webhook из Windows PowerShell. Любой язык, с помощью которого можно сделать HTTP-запрос, может использовать этот веб-перехватчик. В качестве примера используется Windows PowerShell.

Модуль Runbook ожидает список виртуальных машин, отформатированный в JSON, в теле запроса. Модуль Runbook проверяет также, что заголовки содержат определенное сообщение для проверки действительности вызывающего объекта веб-перехватчика.

```azurepowershell-interactive
$uri = "<webHook Uri>"

$vms  = @(
            @{ Name="vm01";ResourceGroup="vm01"},
            @{ Name="vm02";ResourceGroup="vm02"}
        )
$body = ConvertTo-Json -InputObject $vms
$header = @{ message="StartedbyContoso"}
$response = Invoke-WebRequest -Method Post -Uri $uri -Body $body -Headers $header
$jobid = (ConvertFrom-Json ($response.Content)).jobids[0]
```

В следующем примере показан текст запроса, доступный модулю Runbook в свойстве **RequestBody** объекта *WebhookData*. Это значение форматируется в формате JSON для совместимости с форматом, включенным в текст запроса.

```json
[
    {
        "Name":  "vm01",
        "ResourceGroup":  "myResourceGroup"
    },
    {
        "Name":  "vm02",
        "ResourceGroup":  "myResourceGroup"
    }
]
```

На следующем рисунке показан запрос, отправляемый из Windows PowerShell, а также получаемый в результате ответ. Идентификатор задания извлекается из ответа и преобразуется в строку.

![Кнопка Webhook](media/automation-webhooks/webhook-request-response.png)

## <a name="next-steps"></a>Следующие шаги

* Сведения об использовании службы автоматизации Azure для выполнения действий с оповещениями Azure см. в статье [Использование оповещения для активации модуля Runbook службы автоматизации](automation-create-alert-triggered-runbook.md)Azure.
