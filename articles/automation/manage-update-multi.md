---
title: Управление обновлениями для нескольких виртуальных машин в службе автоматизации Azure
description: В этой статье рассказывается, как управлять обновлениями для нескольких виртуальных машин.
services: automation
ms.subservice: update-management
ms.date: 03/26/2020
ms.topic: conceptual
ms.openlocfilehash: d08afc6e501fd76167e0939633442213958f0d49
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83834634"
---
# <a name="manage-updates-for-multiple-vms"></a>Управление обновлениями для нескольких виртуальных машин

С помощью управления обновлениями службы автоматизации Azure вы можете управлять обновлениями и исправлениями виртуальных машин Windows и Linux. В учетной записи [службы автоматизации Azure](automation-offering-get-started.md) вы можете сделать следующее:

- подключить виртуальные машины к управлению обновлениями;
- оценить состояние доступных обновлений;
- запланировать установку необходимых обновлений;
- проверить результаты развертывания, чтобы убедиться, что обновления были успешно применены на всех виртуальных машинах, для которых включено управление обновлениями.

Дополнительные сведения о требованиях к системе для управление обновлениями см. [Требования клиента Управление обновлениями](automation-update-management.md#client-requirements).

## <a name="prerequisites"></a>Предварительные требования

* Виртуальная машина или компьютер, где установлена одна из поддерживаемых операционных систем.
* Доступ к репозиторию обновлений для виртуальных машин Linux, для которых включено Управление обновлениями.

## <a name="enable-update-management-for-azure-vms"></a>Включение Управления обновлениями для виртуальных машин Azure

1. На портале Azure откройте учетную запись службы автоматизации и выберите **Управление обновлениями**.

2. Выберите **Добавить виртуальные машины Azure**.

    ![Вкладка "Добавить виртуальную машину Azure"](./media/manage-update-multi/update-onboard-vm.png)

3. Выберите виртуальную машину, которую нужно включить, и выберите **Включить** в разделе **Включить Управление обновлениями**.

    ![Диалоговое окно "Включение управления обновлениями"](./media/manage-update-multi/update-enable.png)

    После завершения операции для виртуальной машины будет включено Управление обновлениями.

## <a name="enable-update-management-for-non-azure-vms-and-computers"></a>Включение управления обновлениями для виртуальных машин, помимо машин Azure, и компьютеров

На виртуальных машинах, работающих в корпоративной сети или в другой облачной среде, необходимо установить агент Log Analytics для Windows и Linux, чтобы включить для них Управление обновлениями. Сведения о системных требованиях и поддерживаемых методах для развертывания агента на машинах, размещенные вне Azure, см. в статье [Обзор агента Log Analytics](../azure-monitor/platform/log-analytics-agent.md).

## <a name="view-computers-attached-to-your-automation-account"></a>Просмотр сведений о компьютерах, подключенных к учетной записи службы автоматизации

Включив управление обновлениями для компьютеров, можно просмотреть сведения о них, нажав кнопку **Компьютеры**. Это такие сведения, как имя компьютера, состояние соответствия, среда, тип ОС, установленные критически важные обновления и обновления для системы безопасности, другие установленные обновления и состояние готовности к обновлению агента.

  ![Просмотр вкладки "Компьютеры"](./media/manage-update-multi/update-computers-tab.png)

Если управление обновлениями недавно включено для компьютеров, возможно, они еще не оценивались. Для таких компьютеров будет отображаться состояние соответствия `Not assessed`. Вот список возможных значений состояния соответствия:

- `Compliant`: компьютеры, на которых установлены все критически важные обновления и обновления для системы безопасности.
- `Non-compliant`: компьютеры, на которых отсутствует как минимум одно критически важное обновление или обновление для системы безопасности.
- `Not assessed`: данные оценки обновления не были получены от компьютера в течение ожидаемого отрезка времени. Для компьютеров Linux это последний час. Для компьютеров Windows это последние 12 часов.

Чтобы просмотреть состояние агента, перейдите по ссылке в столбце **Готовность к обновлению агента**. Откроется область гибридной рабочей роли со сведениями о состоянии этой роли. Ниже приведен пример агента, который долгое время не был подключен к решению "Управление обновлениями".

![Просмотр вкладки "Компьютеры"](./media/manage-update-multi/update-agent-broken.png)

## <a name="view-an-update-assessment"></a>Просмотр оценки обновлений

После включения решения Управление обновлениями отобразится соответствующая панель. На вкладке **Отсутствующие обновления** можно просмотреть список отсутствующих обновлений.

## <a name="collect-data"></a>Сбор данных

Агенты, установленные на виртуальных машинах и компьютерах, собирают данные об обновлениях. и отправляют их в решение управления обновлениями Azure.

### <a name="supported-agents"></a>Поддерживаемые агенты

В приведенной ниже таблице описаны подключенные источники, которые поддерживает Управление обновлениями.

| Подключенный источник | Поддерживается | Описание |
| --- | --- | --- |
| Агенты Windows |Да |Решение управления обновлениями собирает сведения об обновлениях системы с агентов Windows и запускает установку требуемых обновлений. |
| Агенты Linux |Да |Решение управления обновлениями собирает сведения об обновлениях системы с агентов Linux и запускает установку требуемых обновлений для поддерживаемых дистрибутивов. |
| Группа управления Operations Manager |Да |Решение управления обновлениями собирает сведения о системных обновлениях с агентов, состоящих в подключенной группе управления. |
| Учетная запись хранения Azure |нет |В службе хранилища Azure не хранятся сведения о системных обновлениях. |

### <a name="collection-frequency"></a>Частота сбора

После того как компьютер выполнит проверку соответствия обновлениям, агент переадресовывает сведения в Azure Monitor в пакетном режиме. На компьютере с Windows проверка на соответствие по умолчанию выполняется каждые 12 часов.

Помимо расписания проверки в течение 15 минут после перезапуска MMA запускается проверка на соответствие обновлений. Это происходит перед установкой обновления и после нее.

На компьютере с Linux проверка на соответствия по умолчанию выполняется каждый час. При перезапуске агента MMA проверка соответствия инициируется в течение 15 минут.

Отображение обновленных данных с управляемых компьютеров на панели мониторинга может занять от 30 минут до 6 часов.

## <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

Чтобы установить обновления, составьте план развертывания в рамках графика выпуска и периода обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

>[!NOTE]
>При планировании развертывания обновлений создается ресурс [планирования](shared-resources/schedules.md), связанный с runbook **Patch-MicrosoftOMSComputers**, который обрабатывает установку обновления на целевых компьютерах. Удаление ресурса расписания из портала Azure или с помощью PowerShell приводит к прерыванию запланированного развертывания обновлений и ошибке при попытке повторной настройки на портале. Ресурс расписания можно удалить только удалив соответствующее расписание развертывания.
>

Новое развертывание обновления для одной или нескольких виртуальных машин можно запланировать, щелкнув **Запланировать развертывание обновлений** в разделе **Управление обновлениями**.

В области **Новое развертывание обновления** укажите следующие сведения:

- **Name** (Имя). Введите уникальное имя для идентификации развертывания обновлений.
- **Операционная система**. Выберите **Windows** или **Linux**.
- **Группы для обновления**. Определите запрос на основе сочетания подписки, группы ресурсов, расположения и тегов для создания динамической группы виртуальных машин Azure, чтобы включить в развертывание. Для виртуальных машин, не относящихся к Azure, сохраненные поисковые запросы используются для создания динамической группы, включаемой в развертывание. Дополнительные сведения см. в статье [Динамические группы](automation-update-management-groups.md).
- **Компьютеры, на которые нужно установить обновления**. Выберите "Сохраненные поисковые запросы", группу "Импортировано" или выберите "Компьютеры", чтобы выбрать компьютеры, которые требуется обновить.

   >[!NOTE]
   >Выбор параметра "Сохраненные поисковые запросы" приводит к возврату не удостоверений компьютеров, а только их имен. При наличии нескольких виртуальных машин с одинаковым именем в нескольких группах ресурсов они возвращаются в результатах. Рекомендуется использовать параметр **Группы для обновления**, чтобы гарантировать включение уникальных виртуальных машин, соответствующих вашим критериям.

   Если выберете **Компьютеры**, готовность к обновлению будет показана в столбце **Готовность к обновлению агента**. Вы можете просмотреть состояние работоспособности компьютера перед планированием развертывания обновлений. Дополнительные сведения о различных способах создания групп компьютеров в журналах Azure Monitor см. в статье [Группы компьютеров в запросах к журналам Azure Monitor](../azure-monitor/platform/computer-groups.md).

  ![Область "Новое развертывание обновления"](./media/manage-update-multi/update-select-computers.png)

- **Классификация обновлений**. Выберите типы программного обеспечения, которые будут включены в развертывание обновления. Описание типов классификации обновлений см. в этом [разделе](automation-view-update-assessments.md#work-with-update-classifications). Ниже приведены типы классификации:
  - критические обновления;
  - Обновления для системы безопасности
  - накопительные пакеты обновления;
  - пакеты дополнительных компонентов;
  - пакеты обновления;
  - обновления определений;
  - Инструменты
  - Обновления

- **Обновления для включения или исключения**. После этого откроется страница "Включить или исключить". Обновления, которые можно включить или исключить, находятся на отдельных вкладках. Дополнительные сведения об обработке включений см. в разделе [Планирование развертывания обновлений](automation-tutorial-update-management.md#schedule-an-update-deployment).

> [!NOTE]
> Важно знать, что исключения переопределяют включения. Например, при определении правила исключения `*` ни исправления, ни пакеты не устанавливаются, так как они все будут исключены. Исключенные исправления по-прежнему отображаются как отсутствующие на компьютере. В компьютерах Linux, если пакет включен, но имеет зависимый пакет, который был исключен, пакет не устанавливается.

> [!NOTE]
> Нельзя указывать обновления, которые были заменены для включения в развертывание обновлений.

- **Параметры расписания**. Вы можете принять дату и время по умолчанию (на 30 минут позже текущего времени) либо указать другое время.

   Кроме того, можно указать, происходит ли развертывание один раз или повторяется по расписанию. Чтобы настроить регулярное расписание, в разделе **Повторение** щелкните параметр **Повторяющееся**.

   ![Диалоговое окно "Параметры расписания"](./media/manage-update-multi/update-set-schedule.png)

- **Сценарии предварительного и последующего выполнения**. Выберите сценарии, которые будут выполняться до и после развертывания. Дополнительные сведения см. в статье [Управление сценариями предварительного и последующего выполнения (предварительная версия)](pre-post-scripts.md).
- **Период обслуживания (минуты)** . Укажите период времени, в течение которого произойдет обновление развертывания. Этот параметр позволяет гарантировать, что изменения выполняются в рамках заданного периода обслуживания.

- **Управление перезагрузкой**. Этот параметр определяет способ обработки для развертывания обновлений после перезагрузки.

   |Параметр|Описание|
   |---|---|
   |Перезагрузка при необходимости| **(По умолчанию)** . Перезагрузка запускается при необходимости, если позволяет окно обслуживания.|
   |Всегда выполнять перезагрузку|Перезагрузка запускается независимо от того, требуется ли она. |
   |Никогда не перезагружать|Независимо от того, требуется ли перезагрузка, перезагрузки сбрасываются.|
   |Только перезагрузка без установки обновлений.|Этот параметр игнорирует установку обновлений, а только запускает перезагрузку.|

Завершив настройку расписания, нажмите кнопку **Создать**, чтобы вернуться к панели мониторинга состояния. В таблице **Запланированные** отобразится созданное расписание развертываний.

> [!NOTE]
> Управление обновлениями поддерживает развертывание обновлений из Центра обновлений Windows и предварительное скачивание исправлений. Для этого необходимо внести изменения в исправляемые системы. Просмотрите [этот раздел](automation-configure-windows-update.md#pre-download-updates), чтобы узнать, как настроить эти параметры в своих системах.

## <a name="view-results-of-an-update-deployment"></a>Просмотр результатов развертывания обновлений

После запуска запланированного развертывания можно контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**.

Если развертывание выполняется в этот момент, отображается состояние **Выполняется**. Когда развертывание успешно завершится, состояние изменится на **Успешно**.

В случае сбоя одного или нескольких обновлений при развертывании для состояния отобразится значение **Частичный сбой**.

![Состояние обновления развертывания](./media/manage-update-multi/update-view-results.png)

Щелкните завершенное развертывание обновлений, чтобы просмотреть панель мониторинга этого развертывания.

В области "Результаты обновления" отображаются общее количество обновлений и результаты развертывания на виртуальной машине. В таблице справа представлен подробный разбор каждого обновления и результатов установки. Результаты установки могут принимать одно из следующих значений:

- `Not attempted`: Обновление не установлено из-за недостатка времени в соответствии с заданным периодом обслуживания.
- `Succeeded`: Обновление выполнено.
- `Failed`: Обновление не выполнено.

Чтобы просмотреть все записи журнала, созданные при развертывании, щелкните **Все журналы**.

Щелкните плитку "Выходные данные", чтобы просмотреть поток заданий модуля runbook, который управляет развертыванием обновления на целевой виртуальной машине.

Чтобы просмотреть подробные сведения об ошибках развертывания, щелкните **Ошибки**.

## <a name="next-steps"></a>Дальнейшие действия

* Если необходимо выполнить поиск в журналах обновления, см. статью [Запрос на получение журналов Управления обновлениями](automation-update-management-query-logs.md).
