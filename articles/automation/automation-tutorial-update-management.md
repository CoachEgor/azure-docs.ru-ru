---
title: Управление обновлениями и исправлениями для виртуальных машин Azure в службе автоматизации Azure
description: В этой статье показано, как использовать Управление обновлениями для управления обновлениями и исправлениями для виртуальных машин Azure.
services: automation
ms.subservice: update-management
ms.topic: conceptual
ms.date: 04/06/2020
ms.custom: mvc
ms.openlocfilehash: a701a5a9fd77bd801bb535fe1f26bfa17c97757b
ms.sourcegitcommit: ec682dcc0a67eabe4bfe242fce4a7019f0a8c405
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2020
ms.locfileid: "86185795"
---
# <a name="manage-updates-and-patches-for-your-azure-vms"></a>Управление обновлениями и исправлениями для виртуальных машин Azure

В этой статье показано, как с помощью решения [Управление обновлениями](automation-update-management.md) службы автоматизации Azure управлять обновлениями и исправлениями для виртуальных машин Azure. Сведения о ценах см. на странице [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

> [!NOTE]
> Решение "Управление обновлениями" поддерживает развертывание обновлений из Центра обновления Windows и предварительное скачивание исправлений. Для поддержки этой возможности необходимо внести изменения в исправляемые системы. Узнайте, [как настроить параметры Центра обновления Windows для решения "Управление обновлениями" в службе автоматизации Azure](automation-configure-windows-update.md).

Прежде чем воспользоваться инструкциями в этой статье, включите на своих виртуальных машинах Управление обновлениями. Это можно сделать одним из следующих способов:

* [Включение Управления обновлениями в учетной записи службы автоматизации](automation-onboard-solutions-from-automation-account.md)
* [Включение Управления обновлениями на портале Azure](automation-onboard-solutions-from-browse.md)
* [Включение Управления обновлениями в последовательности runbook](automation-onboard-solutions.md)
* [Включение Управления обновлениями на виртуальных машинах Azure](automation-onboard-solutions-from-vm.md)

## <a name="limit-the-scope-for-the-deployment"></a><a name="scope-configuration"></a>Ограничение области развертывания

В Управлении обновлениями используется конфигурация в пределах рабочей области, определяющая целевые компьютеры, на которых будут устанавливаться обновления. Узнайте, [как ограничить область развертывания Управления обновлениями](automation-scope-configurations-update-management.md).

## <a name="view-update-assessment"></a>Просмотр оценок обновления

Чтобы посмотреть оценку обновления:

1. Войдите в учетную запись службы автоматизации и выберите в области **Управление обновлениями** раздел **Управление обновлениями**. 

2. На странице "Управление обновлениями" появится список обновлений для вашей среды. Если будут обнаружены отсутствующие обновления, их список отобразится на вкладке **Отсутствующие обновления**.

3. Чтобы прочитать справочную статью с важной информацией об определенном обновлении, щелкните по соответствующей ссылке в столбце **Ссылка на сведения**.

    ![Просмотр состояния обновления](./media/automation-tutorial-update-management/manageupdates-view-status-win.png)

4. Чтобы открыть область "Поиск по журналу", щелкните по любому другому месту в строке с обновлением. Запрос для поиска по журналам настроен для этого конкретного обновления. Вы можете изменить этот запрос или создать собственный, чтобы просмотреть подробные сведения.

    ![Просмотр состояния обновления](./media/automation-tutorial-update-management/logsearch.png)

## <a name="configure-alerts"></a>Настройка оповещений

Чтобы настроить оповещения о состоянии развертывания обновления, выполните следующие инструкции:

1. В учетной записи службы автоматизации в разделе **Мониторинг** выберите **Оповещения**, а затем щелкните **Новое правило генерации оповещений**.

2. На странице "Создание правила генерации оповещений" в качестве ресурса уже будет выбрана ваша учетная запись в службе автоматизации. Чтобы указать другой ресурс, нажмите **Изменение ресурса**. 

3. На странице "Выбор ресурса" выберите **Учетные записи службы автоматизации** в раскрывающемся меню **Фильтр по типу ресурсов**. 

4. Выберите учетную запись службы автоматизации, которую нужно использовать, и нажмите **Готово**.

5. Щелкните **Добавить условие**, чтобы выбрать сигнал, который подходит для развертывания обновления. В следующей таблице показаны сведения о двух доступных сигналах.

    |Название сигнала|Измерения|Описание
    |---|---|---|
    |`Total Update Deployment Runs`|— Имя развертывания обновления<br>— Состояние    |Оповещает об общем состоянии развертывания обновления.|
    |`Total Update Deployment Machine Runs`|— Имя развертывания обновления</br>— Состояние</br>— Целевой компьютер</br>— Идентификатор запуска развертывания обновления    |Оповещает о состоянии развертывания обновления, нацеленного на определенные компьютеры.|

6. Выберите допустимое значение измерения из списка. Если нужного значения нет в списке, щелкните значок **\+** рядом с измерением и введите пользовательское имя. Затем выберите нужное значение. Если вы хотите выбрать все значения для измерения, нажмите кнопку **Выбрать\*** . Если не задать значение измерения, Управление обновлениями будет игнорировать это измерение.

    ![Настройка логики сигналов](./media/automation-tutorial-update-management/signal-logic.png)

7. В разделе **Логика оповещений** введите в полях **Агрегат времени** и **Порог** нужные значения и нажмите **Готово**.

8. В следующей области введите имя и описание оповещения.

9. Установите для параметра **Серьезность** значение **Информационный (уровень серьезности 2)** для успешного запуска или **Информационный (уровень серьезности 1)** для неудачного запуска.

    ![Настройка логики сигналов](./media/automation-tutorial-update-management/define-alert-details.png)

10. Чтобы сразу включить правило генерации оповещений, нажмите кнопку **Да**. Чтобы пока не активировать его, нажмите **Нет**.

11. Чтобы не получать оповещения для текущего правила, нажмите **Отключить оповещения**.

## <a name="configure-action-groups-for-your-alerts"></a>Настройка групп действий для оповещений

После настройки оповещений можно создать для них группу действий, которые будут применяться сразу к нескольким оповещениям. Такими действиями могут быть уведомления электронной почты, модули runbook, веб-перехватчики и многое другое. Дополнительные сведения о группах действий см. в разделе [Создание групп действий и управление ими на портале Azure](../azure-monitor/platform/action-groups.md).

1. Выберите оповещение и нажмите в разделе **Группы действий** кнопку **Создать**. 

2. Введите полное и короткое имена для новой группы действий. Решение "Управление обновлениями" использует короткое имя группы при отправке уведомлений с помощью этой группы.

3. В разделе **Действия** введите имя, характеризующее действие (например, **Уведомление по электронной почте**). 

4. В разделе **Тип действия** выберите нужный тип, например **Электронная почта, SMS, push-уведомление, голосовое сообщение**. 

5. Щелкните **Изменить сведения**.

6. Введите данные, необходимые для выбранного типа действия. Например, для типа **Электронная почта, SMS, push-уведомление, голосовое сообщение** введите имя действия, установите флажок **Электронная почта**, введите допустимый адрес электронной почты и нажмите **ОК**.

    ![Настройка группы действий электронной почты](./media/automation-tutorial-update-management/configure-email-action-group.png)

7. В области "Добавление группы действий" нажмите кнопку **ОК**.

8. Для оповещения по электронной почте можно настроить тему письма. Для этого выберите в разделе **Создание правила** пункт **Настройка действий** и нажмите **Тема электронного письма**. 

9. Закончив, нажмите **Создать правило оповещения**. 

## <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

При планировании развертывания обновлений создается ресурс [расписания](shared-resources/schedules.md), связанный с модулем runbook **Patch-MicrosoftOMSComputers**, который обрабатывает установку обновления на целевых компьютерах. Для установки обновлений задайте расписание развертывания, соответствующее вашему графику выпуска и периоду обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

>[!NOTE]
>Если вы удалите ресурс расписания с помощью портала Azure или PowerShell после создания развертывания, это приведет к прерыванию запланированного развертывания обновлений и ошибке при попытке повторной настройки ресурса расписания на портале. Ресурс расписания можно удалить только удалив соответствующее расписание развертывания.  

Чтобы запланировать развертывание обновлений:

1. Войдите в учетную запись службы автоматизации и выберите в области **Управление обновлениями** раздел **Управление обновлениями**. Нажмите **Запланировать развертывание обновлений**.

2. В области **Новое развертывание обновления** введите уникальное имя развертывания в поле **Имя**.

3. Выберите операционную систему для развертывания обновлений.

4. В области **Группы для обновления (предварительная версия)** определите запрос, объединяющий подписку, группу ресурсов, расположения и теги для создания динамической группы виртуальных машин Azure, которую нужно включить в развертывание. Узнайте, [как использовать динамические группы с Управлением обновлениями](automation-update-management-groups.md).

5. В области **Обновляемые компьютеры** выберите сохраненный поисковый запрос, импортированную группу либо нажмите в раскрывающемся меню пункт **Компьютеры** и укажите нужные компьютеры. Так вы сможете проверить готовность агента Log Analytics для каждого компьютера. Дополнительные сведения о различных способах создания групп компьютеров в журналах Azure Monitor см. в статье [Группы компьютеров в запросах к журналам Azure Monitor](../azure-monitor/platform/computer-groups.md).

6. В области **Классификации обновлений** укажите [классификации обновлений](automation-view-update-assessments.md#work-with-update-classifications) продуктов. Для каждого продукта отмените выбор всех поддерживаемых классификаций обновлений, кроме тех, которые нужно включить в развертывание обновлений.

7. В области **Включение или исключение обновлений** выберите, какие обновления нужно развертывать. На странице включения-исключения перечислены идентификаторы обновлений в статьях базы знаний. Соответственно, для каждого обновления можно указать, развертывать его или нет. 
    
   > [!IMPORTANT]
   > Помните: исключения переопределяют включения. Например, если вы определите правило исключения `*`, решение "Управление обновлениями" не установит ни одного исправления и пакета, так как они все будут исключены. Исключенные исправления будут отображаться как отсутствующие на компьютере. На компьютерах под управлением Linux: если вы включите пакет с зависимым пакетом, который был исключен, решение "Управление обновлениями" не установит основной пакет.

   > [!NOTE]
   > Замененные обновления нельзя включать в развертывание.

8. Выберите **Параметры расписания**. Время начала по умолчанию — на 30 минут позднее текущего времени. В будущем можно изменить время начала на любое другое начиная с 10 минут.

9. Укажите в поле **Периодичность**, сколько раз выполнять развертывание — единожды или регулярно. Затем нажмите **ОК**.

10. В области **Сценарии предварительного и последующего выполнения (предварительная версия)** выберите сценарии, которые будут выполняться до и после развертывания. Узнайте, [как управлять сценариями предварительного и последующего выполнения](pre-post-scripts.md).
    
11. В поле **Период обслуживания (минуты)** укажите, сколько времени может длиться установка обновлений. При указании периода обслуживания учитывайте следующие особенности.

    * Период обслуживания определяет количество устанавливаемых обновлений.
    * Решение "Управление обновлениями" не останавливает установку новых обновлений, если приближается окончание периода обслуживания.
    * Решение "Управление обновлениями" не прекращает выполняющиеся обновления, если время периода обслуживания истекло.
    * Если период обслуживания в Windows превышен, это часто обусловлено тем, что установка пакета обновления занимает много времени.

    > [!NOTE]
    > Чтобы обновления применялись в Ubuntu только в период обслуживания, отключите в пакете `Unattended-Upgrade` автоматическое обновление. Инструкции по настройке пакета см. в разделе [Автоматические обновления](https://help.ubuntu.com/lts/serverguide/automatic-updates.html) руководства по Ubuntu Server.

12. В поле **Параметры перезагрузки** укажите, нужно ли перезагружать компьютеры при развертывании обновлений. Доступны следующие варианты: 
    * Reboot if necessary (Перезагружать при необходимости) (по умолчанию).
    * Всегда выполнять перезагрузку
    * Никогда не перезагружать
    * Только перезагрузка (без установки обновлений)

    > [!NOTE]
    > Разделы реестра, перечисленные в разделе [Registry keys used to manage restart](/windows/deployment/update/waas-restart#registry-keys-used-to-manage-restart) (Разделы реестра, используемые для управления перезапуском), могут вызвать событие перезагрузки, даже если для **параметров перезагрузки** установлено значение **Никогда не перезагружать**.

13. Настроив расписание развертывания, нажмите кнопку **Создать**.

    ![Панель параметров расписания обновлений](./media/automation-tutorial-update-management/manageupdates-schedule-win.png)

14. Вы вернетесь к панели мониторинга состояния. Чтобы посмотреть созданное расписание, выберите **Запланированные развертывания обновлений**.

## <a name="schedule-an-update-deployment-programmatically"></a>Программное планирование развертывания обновлений

Чтобы узнать, как создать развертывание обновлений с помощью REST API, ознакомьтесь со статьей [Software Update Configurations — Create](/rest/api/automation/softwareupdateconfigurations/create) (Конфигурации обновления программного обеспечения. Создание). 

Развертывание еженедельного обновления можно создать с помощью примера модуля runbook. Дополнительные сведения об этом модуле runbook см. в статье [Create a weekly update deployment for one or more VMs in a resource group](https://gallery.technet.microsoft.com/scriptcenter/Create-a-weekly-update-2ad359a1) (Создание развертывания еженедельного обновления для одной или нескольких виртуальных машин в группе ресурсов).

## <a name="check-deployment-status"></a>Проверка состояния развертывания

После запуска запланированного развертывания можно контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**. Во время выполнения развертывания отображается состояние **Выполняется**. Когда развертывание успешно завершится, состояние изменится на **Выполнено**. В случае сбоя одного или нескольких обновлений в развертывании устанавливается состояние **Частичный сбой**.

## <a name="view-results-of-a-completed-update-deployment"></a>Просмотр результатов выполненного развертывания обновлений

Когда развертывание завершится, выберите его. Откроется его панель мониторинга.

![Панель мониторинга состояния развертывания обновлений конкретного развертывания](./media/automation-tutorial-update-management/manageupdates-view-results.png)

В разделе **Результаты обновления** содержится сводная информация об общем количестве обновлений и результатах их развертывания на целевых виртуальных машинах. В таблице справа представлена подробная информация о каждом обновлении и результатах его установки.

Возможные значения:

* **Попытка не предпринималась**. Обновление не установлено из-за недостатка времени (т. е. слишком короткого периода обслуживания).
* **Не выбрано**. Обновление не включено в развертывание.
* **Выполнено**. Обновление успешно установлено.
* **Сбой**. Обновление не удалось установить.

Чтобы просмотреть все записи журнала, созданные при этом развертывании, выберите **Все журналы**.

Чтобы просмотреть поток заданий для модуля runbook, который управляет развертыванием обновлений на целевых виртуальных машинах, выберите **Выходные данные**.

Чтобы просмотреть подробные сведения об ошибках развертывания, выберите **Ошибки**.

## <a name="view-the-deployment-alert"></a>Просмотр оповещения о развертывании

Когда развертывание обновлений завершится, вы получите оповещение, настроенное при создании этого развертывания. Вот пример такого оповещения — в данном случае это электронное письмо с подтверждением установки исправления:

![Настройка группы действий электронной почты](./media/automation-tutorial-update-management/email-notification.png)

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте, [как ограничить область развертывания Управления обновлениями](automation-scope-configurations-update-management.md).
* Прочитайте статью [Поиск по журналам Azure Monitor](../azure-monitor/log-query/log-query-overview.md) и узнайте, как искать информацию в журналах, хранящихся в рабочей области Log Analytics.
* Если вы закончили работу с развертываниями, прочитайте, [как удалить связь между рабочей областью и учетной записью службы автоматизации для Управления обновлениями](automation-unlink-workspace-update-management.md).
* Узнайте, [как удалить из Управления обновлениями виртуальные машины](automation-remove-vms-from-update-management.md).
* Сведения об устранении общих ошибок Управления обновлениями см. в [этой статье](troubleshoot/update-management.md).
* Сведения об устранении неполадок, связанных с агентом обновления Windows, см. в [этой статье](troubleshoot/update-agent-issues.md).
* Прочитайте, [как устранять неполадки, связанные с агентом обновления Linux](troubleshoot/update-agent-issues-linux.md).
