---
title: Управление обновлениями и исправлениями для виртуальных машин Azure
description: В этой статье описывается применение службы автоматизации Azure для управления обновлениями и исправлениями для виртуальных машин Azure под управлением Windows.
services: automation
author: zjalexander
ms.service: automation
ms.subservice: update-management
ms.topic: tutorial
ms.date: 12/04/2018
ms.author: zachal
ms.custom: mvc
ms.openlocfilehash: 65bbf58d8514f9fea082b839f57e9aaf3417dc14
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73469729"
---
# <a name="manage-updates-and-patches-for-your-azure-vms"></a>Управление обновлениями и исправлениями для виртуальных машин Azure

С помощью решения по управлению обновлениями можно управлять обновлениями и исправлениями виртуальных машин. Из этого руководства можно узнать, как быстро оценить состояние доступных обновлений, назначить время установки необходимых обновлений, проверить результаты развертывания и создать оповещение, чтобы убедиться, что обновления успешно применены.

Сведения о ценах см. на странице [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

Из этого руководства вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Подключение виртуальной машины к управлению обновлениями
> * Просмотр оценки обновлений
> * Настройка оповещений
> * Планирование развертывания обновлений
> * просмотр результатов развертывания.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником необходимы указанные ниже компоненты.

* Подписка Azure. Если у вас ее нет, [активируйте ежемесячную сумму денег для подписчиков Visual Studio на счете в Azure](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или зарегистрируйте [бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации Azure](automation-offering-get-started.md) для хранения модулей runbook "наблюдатель" и "действия", а также модуля "задачи наблюдателя".
* [Виртуальная машина](../virtual-machines/windows/quick-create-portal.md) для подключения.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="enable-update-management"></a>Включение управления обновлениями

Для работы с этим руководством прежде всего включите управление обновлениями на виртуальной машине.

1. В меню [портала Azure](https://portal.azure.com) выберите **Виртуальные машины** или выполните поиск по этому запросу и выберите **Виртуальные машины** на **домашней странице**.
1. Выберите виртуальную машину, для которой требуется включить решение "Управление обновлениями".
1. На странице "Виртуальная машина" в разделе **Операции** выберите **Управление обновлениями**. Отобразится панель **Включение управления обновлениями**.

Проверка выполняется для определения, включено ли Управление обновлениями для этой виртуальной машины. При этом проверяется рабочая область Log Analytics Azure и связанная учетная запись службы автоматизации, а также наличие решения по управлению обновлениями в рабочей области.

Рабочая область [Log Analytics](../log-analytics/log-analytics-overview.md?toc=%2fazure%2fautomation%2ftoc.json) используется для сбора данных, созданных компонентами и службами, такими как "Управление обновлениями". Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.

В процессе проверки также определяется, была ли виртуальная машина подготовлена с помощью Microsoft Monitoring Agent (MMA) и гибридной рабочей роли службы автоматизации. Агент позволяет взаимодействовать со службой автоматизации Azure и получать сведения о состоянии обновления. Для взаимодействия со службой автоматизации Azure, а также для загрузки обновлений агенту требуется порт 443, который должен быть открыт.

Если во время подключения обнаружится, что отсутствует один из следующих компонентов, он будет автоматически добавлен.

* [Рабочая область Log Analytics](../log-analytics/log-analytics-overview.md?toc=%2fazure%2fautomation%2ftoc.json).
* [Учетная запись автоматизации](./automation-offering-get-started.md)
* [Гибридная рабочая роль runbook](./automation-hybrid-runbook-worker.md) (включена на виртуальной машине)

В разделе **Управление обновлениями** задайте рабочую область Log Analytics и учетную запись службы автоматизации. Нажмите кнопку **Включить**. Если эти параметры недоступны, это значит, что для виртуальной машины включено другое решение автоматизации. В этом случае необходимо использовать одну и ту же рабочую область и учетную запись автоматизации.

![Включение окна решения "Управление обновлениями"](./media/automation-tutorial-update-management/manageupdates-update-enable.png)

Включение решения может занять несколько минут. В течение этого времени не закрывайте окно браузера. После того как решение включено, сведения об отсутствующих обновлениях на виртуальной машине передаются в журналы Azure Monitor. На получение данных для анализа может уйти от 30 минут до 6 часов.

## <a name="view-update-assessment"></a>Просмотр оценок обновления

После включения решения "Управление обновлениями" отобразится панель **Управление обновлениями**. Если будут обнаружены отсутствующие обновления, их список отобразится на вкладке **Отсутствующие обновления**.

В разделе **Ссылка на сведения** выберите ссылку обновления, чтобы открыть в новом окне соответствующую статью технической поддержки. В этом окне можно получить важные сведения об обновлении.

![Просмотр состояния обновления](./media/automation-tutorial-update-management/manageupdates-view-status-win.png)

Чтобы открыть панель **Поиск по журналам** для выбранного обновления, щелкните обновление в любой точке. Запрос для поиска по журналам настроен для этого конкретного обновления. Вы можете изменить этот запрос или создать собственный, чтобы просмотреть подробные сведения об обновлениях, которые разворачиваются или отсутствуют в среде.

![Просмотр состояния обновления](./media/automation-tutorial-update-management/logsearch.png)

## <a name="configure-alerts"></a>Настройка оповещений

На этом шаге вы узнаете, как настроить оповещение, уведомляющее о состоянии развертывания обновления.

### <a name="alert-conditions"></a>Условия оповещения

В учетной записи службы автоматизации в разделе **Мониторинг** перейдите к разделу **Оповещения**, а затем щелкните **+ Новое правило генерации оповещений**.

Учетная запись службы автоматизации уже выбрана в качестве ресурса. Если вы хотите изменить ее, щелкните **Выбрать** и на странице **Выбор ресурса** в раскрывающемся списке **Фильтрация по типу ресурсов** выберите **Учетные записи службы автоматизации**. Выберите вашу учетную запись службы автоматизации и нажмите кнопку **Готово**.

Щелкните **Добавить условие**, чтобы выбрать сигнал, который подходит для развертывания обновления. В следующей таблице показаны сведения о двух доступных сигналах для развертывания обновлений:

|Название сигнала|Измерения|ОПИСАНИЕ|
|---|---|---|
|**Total Update Deployment Runs** (Общее количество запусков развертывания обновлений)|— Имя развертывания обновления</br>— Состояние|Этот сигнал используется для оповещения об общем состоянии развертывания обновления.|
|**Total Update Deployment Machine Runs** (Общее количество запусков развертывания обновлений для компьютера)|— Имя развертывания обновления</br>— Состояние</br>— Целевой компьютер</br>— Идентификатор запуска развертывания обновления|Этот сигнал используется для оповещения о состоянии развертывания обновления, направленного на определенные компьютеры.|

Выберите допустимое значение измерения из списка. Если искомого значения нет в списке, щелкните знак **\+** рядом с измерением и введите пользовательское имя. Затем можно выбрать значение, которое вы хотите найти. Если вы хотите выбрать все значения из измерения, нажмите кнопку **Выбрать\*** . Если вы не выберете значение для измерения, это измерение будет игнорироваться при оценке.

![Настройка логики сигналов](./media/automation-tutorial-update-management/signal-logic.png)

В разделе **Логика оповещений** для поля **Порог** введите **1**. По завершении нажмите кнопку **Готово**.

### <a name="alert-details"></a>Сведения об оповещении

В разделе **2. Определение сведений об оповещении** введите имя и описание для оповещения. Установите для параметра **Серьезность** значение **Информационный (уровень серьезности 2)** для успешного запуска или **Информационный (уровень серьезности 1)** для неудачного запуска.

![Настройка логики сигналов](./media/automation-tutorial-update-management/define-alert-details.png)

В разделе **Группы действий** выберите **Создать**. Группа действий содержит действия, которые можно использовать для нескольких оповещений. Эти действия могут включать в себя уведомления электронной почты, модули Runbook, веб-перехватчики и многое другое, но не ограничиваются ими. Дополнительные сведения о группах действий см. в разделе [Создание групп действий и управление ими на портале Azure](../azure-monitor/platform/action-groups.md).

В поле **Имя группы действий** введите имя для оповещения и короткое имя. Короткое имя используется вместо полного имени группы действий при отправке уведомлений с помощью этой группы.

В разделе **Действия** введите имя действия, например **Уведомления по электронной почте**. В разделе **Тип действия** выберите **Email/SMS/Push/Voice**. В разделе **Сведения** выберите **Изменить сведения**.

На панели **Email/SMS/Push/Voice** введите имя. Установите флажок **Электронная почта**, а затем введите допустимый адрес электронной почты.

![Настройка группы действий электронной почты](./media/automation-tutorial-update-management/configure-email-action-group.png)

На панели **Email/SMS/Push/Voice** выберите **ОК**. На панели **Добавить группу действий** выберите **ОК**.

Чтобы настроить тему оповещения по электронной почте, в разделе **Создать правило** в разделе **Настройка действий** выберите **Тема сообщения**. Когда закончите, выберите **Создать правило оповещения**. Это оповещение уведомляет об успешном завершении развертывания обновления и предоставляет сведения о том, на каких компьютерах выполнялось развертывание.

## <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

Для установки обновлений составьте план развертывания в рамках графика выпуска и периода обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

Чтобы запланировать новое развертывание обновления для виртуальной машины, перейдите в **Управление обновлениями**, а затем выберите **Запланировать развертывание обновлений**.

В разделе **Новое развертывание обновления** укажите следующие сведения.

* **Имя**. Введите уникальное имя для развертывания обновлений.

* **Операционная система**. Выберите операционную систему для развертывания обновлений.

* **Группы для обновления (предварительная версия)** . Определите запрос на основе сочетания подписки, группы ресурсов, расположения и тегов для создания динамической группы виртуальных машин Azure, чтобы включить в развертывание. Дополнительные сведения см. в статье [о динамических группах](automation-update-management-groups.md).

* **Компьютеры, на которые нужно установить обновления**. Щелкните "Сохраненные условия поиска", "Импортировать группу" или выберите "Компьютер" в раскрывающемся списке и выберите нужные компьютеры. Если выберете **Компьютеры**, готовность к обновлению будет показана в столбце **Готовность к обновлению агента**. Дополнительные сведения о различных способах создания групп компьютеров в журналах Azure Monitor см. в статье [Группы компьютеров в запросах к журналам Azure Monitor](../azure-monitor/platform/computer-groups.md).

* **Классификация обновлений**. Выберите типы программного обеспечения, развертывание обновления которого было включено в развертывание. Для целей этого руководства сохраните выбор всех типов.

  Ниже приведены типы классификации:

   |ОС  |type  |
   |---------|---------|
   |Windows     | критические обновления;</br>обновления для системы безопасности;</br>накопительные пакеты обновления;</br>пакеты дополнительных компонентов;</br>пакеты обновления;</br>обновления определений;</br>Средства</br>Обновления        |
   |Linux     | критические обновления и обновления для системы безопасности;</br>Другие обновления       |

   Описание типов классификации обновлений см. в этом [разделе](automation-view-update-assessments.md#update-classifications).

* **Обновления для включения или исключения**. После этого откроется страница **включения и исключения**. Обновления, которые можно включить или исключить, находятся на отдельных вкладках.

> [!NOTE]
> Важно знать, что исключения переопределяют включения. Например, при определении правила исключения `*` ни исправления, ни пакеты не устанавливаются, так как они все будут исключены. Исключенные исправления по-прежнему отображаются как отсутствующие на компьютере. В компьютерах Linux, если пакет включен, но имеет зависимый пакет, который был исключен, пакет не устанавливается.

* **Параметры расписания**. Откроется панель **Параметры расписания**. Время начала по умолчанию — на 30 минут позднее текущего времени. В будущем можно изменить время начала на любое другое начиная с 10 минут.

   Кроме того, можно указать, происходит ли развертывание один раз, или настроить расписание повторяющегося развертывания. В разделе **Периодичность** выберите **Однократно**. Оставьте значение 1 день по умолчанию и выберите **ОК**. Это действие устанавливает расписание с периодическим повторением.

* **Сценарии предварительного и последующего выполнения**. Выберите сценарии, которые будут выполняться до и после развертывания. Дополнительные сведения см. в статье [Управление сценариями предварительного и последующего выполнения (предварительная версия)](pre-post-scripts.md).

* **Период обслуживания (минуты)** . Оставьте значение по умолчанию. Период обслуживания определяет количество времени, необходимое для установки обновлений. При указании периода обслуживания учитывайте следующие детали.

  * Период обслуживания определяет количество попыток установки обновлений.
  * Решение "Управление обновлениями" не останавливает установку новых обновлений, если приближается конец периода обслуживания.
  * Решение "Управление обновлениями" не прекращает выполняющиеся обновления, если время периода обслуживания истекло.
  * Если период обслуживания в Windows превышен, это часто обусловлено тем, что установка пакета обновления занимает много времени.

  > [!NOTE]
  > Чтобы обновления применялись только в период обслуживания в Ubuntu, повторно настройте пакет unattended-upgrades и отключите автоматическое обновление. Дополнительные сведения о настройке пакета см. в разделе [Автоматические обновления](https://help.ubuntu.com/lts/serverguide/automatic-updates.html) руководства по Ubuntu Server.

* **Параметры перезагрузки**. Этот параметр определяет, как следует выполнять перезагрузку. Доступные параметры:
  * Перезагрузка при необходимости (по умолчанию)
  * Всегда выполнять перезагрузку
  * Никогда не перезагружать
  * Только перезагрузка без установки обновлений.

> [!NOTE]
> Разделы реестра, перечисленные в разделе [Registry keys used to manage restart](/windows/deployment/update/waas-restart#registry-keys-used-to-manage-restart) (Разделы реестра, используемые для управления перезапуском), могут вызвать событие перезагрузки, даже если для параметра **Reboot Control** (Управление перезагрузкой) установлено значение **Никогда не перезагружать**.

После окончания настройки расписания выберите **Создать**.

![Панель параметров расписания обновлений](./media/automation-tutorial-update-management/manageupdates-schedule-win.png)

Вы вернетесь к панели мониторинга состояния. Выберите **Запланированные развертывания обновлений**, чтобы отобразить созданный график развертывания.

> [!NOTE]
> Управление обновлениями поддерживает развертывание обновлений из Центра обновлений Windows и предварительное скачивание исправлений. Для этого необходимо внести изменения в исправляемые системы. Просмотрите [этот раздел](automation-configure-windows-update.md), чтобы узнать, как настроить эти параметры в своих системах.

**Развертывания обновлений** также можно создать программно. Чтобы узнать, как создать **развертывание обновлений** с помощью REST API, ознакомьтесь со статьей [Software Update Configurations — Create](/rest/api/automation/softwareupdateconfigurations/create) (Конфигурации обновления программного обеспечения. Создание). Кроме того, имеется пример модуля runbook, который можно использовать для создания **развертывания еженедельного обновления**. Дополнительные сведения об этом модуле runbook см. в статье [Create a weekly update deployment for one or more VMs in a resource group](https://gallery.technet.microsoft.com/scriptcenter/Create-a-weekly-update-2ad359a1) (Создание развертывания еженедельного обновления для одной или нескольких виртуальных машин в группе ресурсов).

## <a name="view-results-of-an-update-deployment"></a>Просмотр результатов развертывания обновлений

После запуска запланированного развертывания можно контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**. Во время выполнения развертывания отображается состояние **Выполняется**. После завершения развертывания состояние приобретает значение **Выполнено**. В случае сбоя одного или нескольких обновлений в развертывании устанавливается состояние **Частичный сбой**.

Выберите завершенное развертывание обновлений, чтобы просмотреть панель мониторинга для него.

![Панель мониторинга состояния развертывания обновлений конкретного развертывания](./media/automation-tutorial-update-management/manageupdates-view-results.png)

В разделе **Результаты обновления** содержится сводная информация об общем количестве обновлений и результатах их развертывания на виртуальной машине. В таблице справа представлена подробная информация о каждом обновлении и результатах установки.

Возможные значения представлены в следующем списке.

* **Попытка не предпринималась**. Обновление не установлено из-за недостатка времени в связи с заданной длительностью окна обслуживания.
* **Успешно**. Обновление выполнено.
* **Сбой**. Обновление не выполнено.

Чтобы просмотреть все записи журнала, созданные при этом развертывании, щелкните **Все журналы**.

Чтобы просмотреть поток заданий для модуля runbook, который управляет развертыванием обновления на целевой виртуальной машине, выберите **Вывести**.

Чтобы просмотреть подробные сведения об ошибках развертывания, выберите **Ошибки**.

После успешного развертывания обновления отправляется сообщение электронной почты, уведомляющее об успешном выполнении (как на следующем примере).

![Настройка группы действий электронной почты](./media/automation-tutorial-update-management/email-notification.png)

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Подключение виртуальной машины к управлению обновлениями
> * Просмотр оценки обновлений
> * Настройка оповещений
> * Планирование развертывания обновлений
> * просмотр результатов развертывания.

Теперь переходите к обзору решения для управления обновлениями.

> [!div class="nextstepaction"]
> [Update Management solution](../operations-management-suite/oms-solution-update-management.md?toc=%2fazure%2fautomation%2ftoc.json) (Решение для управления обновлениями)

