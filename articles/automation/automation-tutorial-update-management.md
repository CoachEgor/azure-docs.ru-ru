---
title: Управление обновлениями и исправлениями для виртуальных машин Azure
description: В этой статье описывается применение службы автоматизации Azure для управления обновлениями и исправлениями для виртуальных машин Azure и других поставщиков.
services: automation
ms.subservice: update-management
ms.topic: tutorial
ms.date: 04/06/2020
ms.custom: mvc
ms.openlocfilehash: 62c661f75aef77117a61be7e802562e6dde17ba5
ms.sourcegitcommit: 5e49f45571aeb1232a3e0bd44725cc17c06d1452
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/17/2020
ms.locfileid: "81604676"
---
# <a name="manage-updates-and-patches-for-your-azure-vms"></a>Управление обновлениями и исправлениями для виртуальных машин Azure

С помощью решения по управлению обновлениями можно управлять обновлениями и исправлениями виртуальных машин. Из этого руководства можно узнать, как быстро оценить состояние доступных обновлений, назначить время установки необходимых обновлений, проверить результаты развертывания и создать оповещение, чтобы убедиться, что обновления успешно применены.

Сведения о ценах см. на странице [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Просмотр оценки обновлений
> * Настройка оповещений
> * Планирование развертывания обновлений
> * просмотр результатов развертывания.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником необходимы указанные ниже компоненты.

* Решение [Управление обновлениями](automation-update-management.md), включенное для одной или нескольких виртуальных машин.
* [Виртуальная машина](../virtual-machines/windows/quick-create-portal.md) для подключения.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="view-update-assessment"></a>Просмотр оценок обновления

Когда вы включите Управление обновлениями, отобразится соответствующая страница. Если будут обнаружены отсутствующие обновления, их список отобразится на вкладке **Отсутствующие обновления**.

В разделе **Ссылка на сведения** выберите ссылку обновления, чтобы открыть соответствующую статью технической поддержки. Вы можете получить важные сведения об обновлении.

![Просмотр состояния обновления](./media/automation-tutorial-update-management/manageupdates-view-status-win.png)

Чтобы открыть панель "Поиск по журналу" для выбранного обновления, щелкните обновление в любой точке. Запрос для поиска по журналам настроен для этого конкретного обновления. Вы можете изменить этот запрос или создать собственный запрос, чтобы просмотреть подробные сведения об обновлениях, развернутых или отсутствующих в вашей среде.

![Просмотр состояния обновления](./media/automation-tutorial-update-management/logsearch.png)

## <a name="configure-alerts"></a>Настройка оповещений

На этом шаге вы узнаете, как настроить оповещение, уведомляющее о состоянии развертывания обновления.

### <a name="alert-conditions"></a>Условия оповещения

В учетной записи службы автоматизации в разделе **Мониторинг** выберите **Оповещения**, а затем щелкните **Новое правило генерации оповещений**.

Учетная запись службы автоматизации уже выбрана в качестве ресурса. Если вы хотите изменить ее, щелкните **Выбрать**. На странице "Выбор ресурса" выберите **Учетные записи службы автоматизации** в раскрывающемся меню **Фильтр по типу ресурсов**. Выберите свою учетную запись службы автоматизации и нажмите кнопку **Готово**.

Щелкните **Добавить условие**, чтобы выбрать сигнал, который подходит для развертывания обновления. В следующей таблице показаны сведения о двух доступных сигналах.

|Название сигнала|Измерения|Описание|
|---|---|---|
|`Total Update Deployment Runs`|— Имя развертывания обновления<br>— Состояние|Этот сигнал оповещает об общем состоянии развертывания обновления.|
|`Total Update Deployment Machine Runs`|— Имя развертывания обновления</br>— Состояние</br>— Целевой компьютер</br>— Идентификатор запуска развертывания обновления|Этот сигнал оповещает о состоянии развертывания обновления, направленного на определенные компьютеры.|

Выберите допустимое значение измерения из списка. Если нужного вам значения нет в списке, щелкните знак **\+** рядом с измерением и введите пользовательское имя. Затем выберите нужное значение. Если вы хотите выбрать все значения для измерения, нажмите кнопку **Выбрать\*** . Если вы не выберете значение для измерения, решение "Управление обновлениями" проигнорирует это измерение.

![Настройка логики сигналов](./media/automation-tutorial-update-management/signal-logic.png)

В разделе **Логика оповещений** для поля **Порог** введите **1**. По завершении нажмите кнопку **Готово**.

### <a name="alert-details"></a>Сведения об оповещении

В разделе **2. Определение сведений об оповещении** введите имя и описание для оповещения. Установите для параметра **Серьезность** значение **Информационный (уровень серьезности 2)** для успешного запуска или **Информационный (уровень серьезности 1)** для неудачного запуска.

![Настройка логики сигналов](./media/automation-tutorial-update-management/define-alert-details.png)

В разделе **Группы действий** выберите **Создать**. Группа действий содержит действия, которые можно использовать для нескольких оповещений. Такими действиями могут быть уведомления электронной почты, модули runbook, веб-перехватчики и многое другое. Дополнительные сведения о группах действий см. в разделе [Создание групп действий и управление ими на портале Azure](../azure-monitor/platform/action-groups.md).

В поле **Имя группы действий** введите имя для оповещения и короткое имя. Решение "Управление обновлениями" использует короткое имя вместо полного имени группы действий при отправке уведомлений с помощью указанной группы.

В разделе **Действия** введите имя действия, например **Уведомление по электронной почте**. В разделе **Тип действия** выберите **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовое сообщение). В разделе **Сведения** выберите **Изменить сведения**.

В области "Электронная почта, SMS, push-уведомление, голосовое сообщение" введите имя. Установите флажок **Электронная почта**, а затем введите допустимый адрес электронной почты.

![Настройка группы действий электронной почты](./media/automation-tutorial-update-management/configure-email-action-group.png)

В области "Электронная почта, SMS, push-уведомление, голосовое сообщение" нажмите кнопку **ОК**. В области "Добавление группы действий" нажмите кнопку **ОК**.

Чтобы настроить тему оповещения по электронной почте, последовательно выберите элементы **Создать правило**, **Настройка действий** и **Тема сообщения**. Когда закончите, выберите **Создать правило оповещения**. Это оповещение уведомляет об успешном завершении развертывания обновления и предоставляет сведения о том, на каких компьютерах выполнялось развертывание.

## <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

Для установки обновлений составьте план развертывания в рамках графика выпуска и периода обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

>[!NOTE]
>При планировании развертывания обновлений создается ресурс [расписания](shared-resources/schedules.md), связанный с модулем runbook **Patch-MicrosoftOMSComputers**, который обрабатывает установку обновления на целевых компьютерах. Если вы удалите ресурс расписания с помощью портала Azure или PowerShell после создания развертывания, это приведет к прерыванию запланированного развертывания обновлений и ошибке при попытке повторной настройки ресурса расписания на портале. Ресурс расписания можно удалить только удалив соответствующее расписание развертывания.  

Чтобы запланировать новое развертывание обновления для виртуальной машины, перейдите в **Управление обновлениями**, а затем выберите **Запланировать развертывание обновлений**.

В разделе **Новое развертывание обновления** укажите следующие сведения.

* **Name** (Имя). Введите уникальное имя для развертывания обновлений.

* **Операционная система**. Выберите операционную систему для развертывания обновлений.

* **Группы для обновления (предварительная версия)** . Определите запрос, в котором объединены подписка, группа ресурсов, расположение и теги, для создания динамической группы виртуальных машин Azure, предназначенной для включения в развертывание. Дополнительные сведения см. в статье [Использование динамических групп с Управлением обновлениями](automation-update-management-groups.md).

* **Компьютеры, на которые нужно установить обновления**. Выберите"Сохраненный поиск", Imported group (Импортированная группа) либо выберите **Компьютеры** в раскрывающемся меню и выберите нужные компьютеры. Если вы выберете **Компьютеры**, готовность к обновлению каждого компьютера будет показана в столбце **Готовность к обновлению агента**. Дополнительные сведения о различных способах создания групп компьютеров в журналах Azure Monitor см. в статье [Группы компьютеров в запросах к журналам Azure Monitor](../azure-monitor/platform/computer-groups.md).

* **Классификация обновлений**. Для каждого продукта отмените выбор всех поддерживаемых классификаций обновлений, кроме тех, которые нужно включить в развертывание обновлений. Для целей этого руководства сохраните выбор всех типов для всех продуктов.

  Ниже приведены типы классификации:

   |OS  |Тип  |
   |---------|---------|
   |Windows     | критические обновления;</br>Обновления для системы безопасности</br>накопительные пакеты обновления;</br>пакеты дополнительных компонентов;</br>пакеты обновления;</br>обновления определений;</br>Инструменты</br>Обновления<br>Драйвер        |
   |Linux     | критические обновления и обновления для системы безопасности;</br>Другие обновления       |

   Описание типов классификаций обновлений см. в разделе о [классификации обновлений](automation-view-update-assessments.md#update-classifications).

* **Updates to include/exclude** (Обновления для включения или исключения) — откроется страница включения и исключения. Обновления, которые нужно включить или исключить, находятся на отдельных вкладках и указываются по идентификатору статьи базы знаний. При указании одного или нескольких идентификаторов отмените выбор всех классификаций в развертывании обновлений. В таком случае при указании идентификаторов обновлений в пакет обновления не будут добавлены никакие другие обновления.

> [!NOTE]
> Важно знать, что исключения переопределяют включения. Например, при определении правила исключения `*` решение "Управление обновлениями" не установит ни одного исправления и пакета, так как они все будут исключены. Исключенные исправления по-прежнему отображаются как отсутствующие на компьютере. На компьютерах под управлением Linux: если вы включите пакет с зависимым пакетом, который был исключен, решение "Управление обновлениями" не установит основной пакет.

> [!NOTE]
> Нельзя указывать обновления, которые были заменены для включения в развертывание обновлений.
>

* **Параметры расписания**. Откроется панель "Параметры расписания". Время начала по умолчанию — на 30 минут позднее текущего времени. В будущем можно изменить время начала на любое другое начиная с 10 минут.

   Кроме того, можно указать, происходит ли развертывание один раз, или настроить расписание повторяющегося развертывания. В разделе **Периодичность** выберите **Однократно**. Оставьте предложенное по умолчанию значение "1 день" и нажмите кнопку **ОК**. Эти записи используются для настройки регулярного расписания.

* **Сценарии предварительного и последующего выполнения**. Выберите сценарии, которые будут выполняться до и после развертывания. Дополнительные сведения см. в статье [Управление сценариями предварительного и последующего выполнения (предварительная версия)](pre-post-scripts.md).

* **Период обслуживания (минуты)** . Оставьте значение по умолчанию. Период обслуживания определяет количество времени, необходимое для установки обновлений. При указании периода обслуживания учитывайте следующие особенности.

  * Период обслуживания определяет количество устанавливаемых обновлений.
  * Решение "Управление обновлениями" не останавливает установку новых обновлений, если приближается окончание периода обслуживания.
  * Решение "Управление обновлениями" не прекращает выполняющиеся обновления, если время периода обслуживания истекло.
  * Если период обслуживания в Windows превышен, это часто обусловлено тем, что установка пакета обновления занимает много времени.

  > [!NOTE]
  > Чтобы обновления применялись только в период обслуживания в Ubuntu, повторно настройте пакет unattended-upgrades и отключите автоматическое обновление. Дополнительные сведения о настройке пакета см. в разделе [Автоматические обновления](https://help.ubuntu.com/lts/serverguide/automatic-updates.html) руководства по Ubuntu Server.

* **Параметры перезагрузки**. Используйте, чтобы указать параметры для обработки перезагрузок. Доступны следующие варианты:
  * Reboot if necessary (Перезагружать при необходимости) (по умолчанию).
  * Всегда выполнять перезагрузку
  * Никогда не перезагружать
  * Only reboot - doesn't install updates (Только перезагрузка без установки обновлений).

> [!NOTE]
> Разделы реестра, перечисленные в разделе [Registry keys used to manage restart](/windows/deployment/update/waas-restart#registry-keys-used-to-manage-restart) (Разделы реестра, используемые для управления перезапуском), могут вызвать событие перезагрузки, даже если для **параметров перезагрузки** установлено значение **Никогда не перезагружать**.

После окончания настройки расписания нажмите кнопку **Создать**.

![Панель параметров расписания обновлений](./media/automation-tutorial-update-management/manageupdates-schedule-win.png)

Вы вернетесь к панели мониторинга состояния. Выберите **Запланированные развертывания обновлений**, чтобы отобразить созданный график развертывания.

> [!NOTE]
> Решение "Управление обновлениями" поддерживает развертывание обновлений из Центра обновлений Windows и предварительное скачивание исправлений. Для поддержки этой возможности необходимо внести изменения в исправляемые системы. Просмотрите [этот раздел](automation-configure-windows-update.md), чтобы узнать, как настроить эти параметры в своих системах.

Развертывания обновлений также можно создать программно. Чтобы узнать, как создать развертывание обновлений с помощью REST API, ознакомьтесь со статьей [Software Update Configurations — Create](/rest/api/automation/softwareupdateconfigurations/create) (Конфигурации обновления программного обеспечения. Создание). Кроме того, имеется пример модуля runbook, который можно использовать для создания развертывания еженедельного обновления. Дополнительные сведения об этом модуле runbook см. в статье [Create a weekly update deployment for one or more VMs in a resource group](https://gallery.technet.microsoft.com/scriptcenter/Create-a-weekly-update-2ad359a1) (Создание развертывания еженедельного обновления для одной или нескольких виртуальных машин в группе ресурсов).

## <a name="view-results-of-an-update-deployment"></a>Просмотр результатов развертывания обновлений

После запуска запланированного развертывания можно контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**. Во время выполнения развертывания отображается состояние **Выполняется**. Когда развертывание успешно завершится, состояние изменится на **Выполнено**. В случае сбоя одного или нескольких обновлений в развертывании устанавливается состояние **Частичный сбой**.

Выберите завершенное развертывание обновлений, чтобы просмотреть его панель мониторинга.

![Панель мониторинга состояния развертывания обновлений конкретного развертывания](./media/automation-tutorial-update-management/manageupdates-view-results.png)

В разделе **Результаты обновления** содержится сводная информация об общем количестве обновлений и результатах их развертывания на виртуальной машине. В таблице справа представлена подробная информация о каждом обновлении и результатах установки.

Возможные значения:

* **Попытка не предпринималась**. Обновление не установлено из-за недостатка времени в связи с заданной длительностью периода обслуживания.
* **Выполнено**. Обновление выполнено.
* **Ошибка**. Обновление не выполнено.

Чтобы просмотреть все записи журнала, созданные при этом развертывании, выберите **Все журналы**.

Чтобы просмотреть поток заданий для модуля runbook, который управляет развертыванием обновления на целевой виртуальной машине, выберите **Вывести**.

Чтобы просмотреть подробные сведения об ошибках развертывания, выберите **Ошибки**.

После завершения развертывания обновлений вы получите подтверждение по электронной почте, аналогичное следующему:

![Настройка группы действий электронной почты](./media/automation-tutorial-update-management/email-notification.png)

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Подключение виртуальной машины к управлению обновлениями
> * Просмотр оценки обновлений
> * Настройка оповещений
> * Планирование развертывания обновлений
> * просмотр результатов развертывания.

Теперь переходите к обзору решения для управления обновлениями.

> [!div class="nextstepaction"]
> [Update Management solution](automation-update-management.md) (Решение для управления обновлениями)