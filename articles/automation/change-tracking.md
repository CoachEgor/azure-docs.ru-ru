---
title: Общие сведения об отслеживании изменений и инвентаризации в службе автоматизации Azure
description: В этой статье описывается функция отслеживания изменений и инвентаризации, которая помогает выявлять изменения в программном обеспечении и службах Майкрософт, используемых в среде.
services: automation
ms.subservice: change-inventory-management
ms.date: 01/28/2019
ms.topic: conceptual
ms.openlocfilehash: 4f6ae1ad5b0f3904b84d47316c11aa1a67531a28
ms.sourcegitcommit: 0b80a5802343ea769a91f91a8cdbdf1b67a932d3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2020
ms.locfileid: "83835110"
---
# <a name="change-tracking-and-inventory-overview"></a>Общие сведения об отслеживании изменений и инвентаризации

В этой статье приводятся основные сведения об отслеживании изменений и инвентаризации в службе автоматизации Azure. Эта функция отслеживает изменения в виртуальных машинах и серверной инфраструктуре, помогая выявлять проблемы в работе программного обеспечения, управляемого диспетчером пакетов распространения. Элементы, которые отслеживаются функцией отслеживания изменений и инвентаризации: 

- Программное обеспечение Windows
- программное обеспечение Linux (пакеты);
- файлы Windows и Linux;
- разделы реестра Windows;
- службы Майкрософт;
- Управляющие программы Linux

> [!NOTE]
> Чтобы отслеживать изменения свойств Azure Resource Manager, обратитесь к [журналу изменений](../governance/resource-graph/how-to/get-resource-changes.md) в Azure Resource Graph.

Функция отслеживания изменений и инвентаризации получает данные из Azure Monitor. Виртуальные машины, подключенные к рабочим областям Log Analytics, используют агенты Log Analytics для сбора данных по изменениям в установленном программном обеспечении, службах Майкрософт, реестре Windows и файлах, а также в любых управляющих программах Linux на отслеживаемых серверах. Когда данные доступны, агенты отправляют их в Azure Monitor для обработки. Azure Monitor применяет логику к полученным данным, записывает их и делает доступными. 

Функция отслеживания изменений и инвентаризации обеспечивает функциональные области отслеживания изменений и инвентаризации в службе автоматизации Azure. Так как для обеих областей используется один и тот же агент Log Analytics, процесс добавления виртуальной машины в любую из них одинаков. 

> [!NOTE]
> Чтобы использовать функцию отслеживания изменений и инвентаризации, необходимо разместить все виртуальные машины в подписке и регионе учетной записи службы автоматизации.

В настоящее время функция отслеживания изменений и инвентаризации не поддерживают следующие элементы:

* Рекурсия для отслеживания реестра Windows
* сетевые файловые системы;
* другие методы установки;
* файлы * **.exe** для Windows.

Другие ограничения:

* в текущей версии столбец и значения **Максимальный размер файла** не используются;
* при сборе более 2500 файлов в течение тридцатиминутного цикла производительность отслеживания изменений и инвентаризации может снизиться;
* при интенсивном сетевом трафике изменение записей может занять до 6 часов;
* если изменение конфигурации выполняется на отключенном компьютере, он может внести изменения, относящиеся к предыдущей конфигурации.

В настоящее время известны перечисленные ниже проблемы решения для отслеживания изменений и инвентаризации.

* Для компьютеров Windows Server 2016 Core RS3 не собираются исправления обновлений.
* Управляющие программы Linux могут показывать измененное состояние, даже если изменений не было. Эта проблема возникает из-за способа записи данных `SvcRunLevels` в журнале [ConfigurationChange](https://docs.microsoft.com/azure/azure-monitor/reference/tables/configurationchange) в Azure Monitor.

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Функция отслеживания изменений и инвентаризации поддерживается во всех операционных системах, отвечающих требованиям для агента Log Analytics. К официально поддерживаемым версиям операционной системы Windows относятся Windows Server 2008 с пакетом обновления 1 (SP1) или более поздней версии и Windows 7 с пакетом обновления 1 (SP1) или более поздней версии. Поддерживается также ряд операционных систем Linux. См. [общие сведения об агенте Log Analytics](https://docs.microsoft.com/azure/azure-monitor/platform/log-analytics-agent). 

## <a name="network-requirements"></a>Требования к сети

Для функции отслеживания изменений и инвентаризации требуются сетевые адреса, перечисленные в приведенной ниже таблице. Для связи с этими адресами используется порт 443.

|Azure Public  |Azure для государственных организаций  |
|---------|---------|
|*.ods.opinsights.azure.com    | *.ods.opinsights.azure.us         |
|*.oms.opinsights.azure.com     | *.oms.opinsights.azure.us        |
|*.blob.core.windows.net | *.blob.core.usgovcloudapi.net|
|*.azure-automation.net | *.azure-automation.us|

## <a name="change-tracking-and-inventory-user-interface"></a>Пользовательский интерфейс отслеживания изменений и инвентаризации

Используйте функцию отслеживания изменений и инвентаризации на портале Azure для просмотра сводки изменений для отслеживаемых компьютеров. Чтобы получить доступ к этой функции, в учетной записи службы автоматизации необходимо выбрать команду добавления виртуальных машин для элемента **Отслеживание изменений** или **Инвентаризация** в разделе **Управление конфигурацией**.  

![Панель отслеживания изменений](./media/change-tracking/change-tracking-dash01.png)

Вверху панели мониторинга находятся раскрывающиеся списки. С их помощью можно отфильтровать диаграмму отслеживания изменений и подробные сведения по типу изменения и диапазону времени. Кроме того, вы можете щелкнуть на диаграмме и перетащить, чтобы выбрать нужный диапазон времени. 

Щелкните изменение или событие, чтобы отобразить подробные сведения о нем. Доступны следующие типы изменений:

* События
* Управляющие программы
* Файлы
* Реестр
* Программное обеспечение
* Службы Майкрософт

Каждое изменение можно добавить, изменить или удалить. В примере ниже тип запуска службы был изменен с "Ручного" на "Автоматический".

![Подробные сведения об отслеживании изменений](./media/change-tracking/change-tracking-details.png)

## <a name="tracking-of-file-changes"></a>Отслеживание изменений в файлах

Для отслеживания изменений в файлах в Windows и Linux функция отслеживания изменений и инвентаризации использует MD5-хэши файлов. Затем эти хэши применяются для определения того, вносились ли изменения с момента последней инвентаризации.

## <a name="tracking-of-file-content-changes"></a>Отслеживание изменений в содержимом файлов

Функция отслеживания изменений и инвентаризации позволяет просматривать содержимое файла Windows или Linux до и после изменения. Для каждого изменения в файле функция отслеживания изменений и инвентаризации сохраняет содержимое файла в [учетной записи хранения Azure](../storage/common/storage-create-storage-account.md). При отслеживании файла его содержимое можно просмотреть до или после изменения. Содержимое можно просмотреть как в самом файле, так и параллельно. 

![Просмотр изменений в файле](./media/change-tracking/view-file-changes.png)

## <a name="tracking-of-registry-keys"></a>Отслеживание разделов реестра

Функция отслеживания изменений и инвентаризации позволяет отслеживать изменения в разделах реестра. Целью такого отслеживания является точное определение точек расширяемости, в которых может быть активирован сторонний код или вредоносная программа. В приведенной ниже таблице перечислены предварительно настроенные (но не включенные) разделы реестра. Чтобы отслеживать эти разделы, необходимо включить каждый из них.

> [!div class="mx-tdBreakAll"]
> |Ключ реестра | Назначение |
> | --- | --- |
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\ShellEx\ContextMenuHandlers` | Отслеживаются общие записи автозапуска, привязывающиеся непосредственно к проводнику Windows и выполняющиеся с внутрипроцессным файлом **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup` | Отслеживаются сценарии, выполняемые при запуске.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Shutdown` | Отслеживаются сценарии, выполняемые при завершении работы.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run` | Отслеживаются разделы, загружаемые перед входом пользователя в учетную запись Windows. Этот раздел используется для 32-разрядных приложений, выполняющихся на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Microsoft\Active Setup\Installed Components` | Отслеживаются изменения параметров приложения.
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\ShellEx\ContextMenuHandlers` | Отслеживаются общие записи автозапуска, привязывающиеся непосредственно к проводнику Windows и выполняющиеся с внутрипроцессным файлом **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\Shellex\CopyHookHandlers` | Отслеживаются общие записи автозапуска, привязывающиеся непосредственно к проводнику Windows и выполняющиеся с внутрипроцессным файлом **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\ShellIconOverlayIdentifiers` | Отслеживается регистрация обработчика дополнительных значков.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\ShellIconOverlayIdentifiers` | Отслеживается регистрация обработчика дополнительных значков для 32-битных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects` | Отслеживаются новые подключаемые модули вспомогательных объектов браузера для Internet Explorer. Используется для доступа к модели DOM текущей страницы и управления навигацией.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects` | Отслеживаются новые подключаемые модули вспомогательных объектов браузера для Internet Explorer. Используется для получения доступа к модели DOM текущей страницы и управления навигацией для 32-разрядных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Internet Explorer\Extensions` | Отслеживаются новые расширения Internet Explorer, например пользовательские меню инструментов и пользовательские кнопки панели инструментов.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Internet Explorer\Extensions` | Отслеживаются новые расширения Internet Explorer, например пользовательские меню инструментов и пользовательские кнопки панели инструментов для 32-битных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Drivers32` | Отслеживаются 32-разрядные драйверы, связанные с устройствами wavemapper: wave1 и wave2, msacm.imaadpcm, .msadpcm, .msgsm610 и vidc. Ознакомьтесь с разделом о [драйверах] в файле **system.ini**.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Drivers32` | Отслеживаются 32-разрядные драйверы, связанные с устройствами wavemapper, — wave1 и wave2, msacm.imaadpcm, .msadpcm, .msgsm610 и vidc — для 32-разрядных приложений, работающих на 64-разрядных компьютерах. Ознакомьтесь с разделом о [драйверах] в файле **system.ini**.
> |`HKEY\LOCAL\MACHINE\System\CurrentControlSet\Control\Session Manager\KnownDlls` | Отслеживается список известных или часто используемых системных библиотек DLL. Эта система предотвращает использование ненадежных разрешений каталога приложений за счет удаления версий вредоносной программы типа "троянский конь" системных библиотек DLL.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify` | Отслеживается список пакетов, получающих уведомления о событиях из **winlogon.exe** — интерактивной модели поддержки входа в систему для Windows.

## <a name="support-for-file-integrity-monitoring-in-azure-security-center"></a>Поддержка мониторинга целостности файлов в Центре безопасности Azure

Функция отслеживания изменений и инвентаризации использует [систему мониторинга целостности файлов (FIM) в Центре безопасности Azure](https://docs.microsoft.com/azure/security-center/security-center-file-integrity-monitoring). Хотя FIM наблюдает только за файлами и реестрами, полная функция отслеживания изменений и инвентаризации также обеспечивает отслеживание следующих элементов:

- изменения программного обеспечения;
- Службы Майкрософт
- Управляющие программы Linux

## <a name="recursion-support"></a>Поддержка рекурсии

Функция отслеживания изменений и инвентаризации поддерживает рекурсию, что позволяет использовать подстановочные знаки для упрощения отслеживания в каталогах. Рекурсия также предоставляет переменные среды, которые позволяют отслеживать файлы в разных средах с несколькими или динамическими именами дисков. Ниже представлена общая информация, которую нужно знать при настройке рекурсии.

* Для отслеживания нескольких файлов необходимы подстановочные знаки.
* Подстановочные знаки можно использовать только в последнем сегменте пути, например **c:\папка\\файл*** или **/etc/*.conf**.
* Если у переменной среды недопустимый путь, проверка будет успешной, но выполнение завершится сбоем.
* Избегайте общих путей, так как это приведет к переходу по слишком большому количеству папок.

## <a name="change-tracking-and-inventory-data-collection"></a>Сбор данных для функции отслеживания изменений и инвентаризации

В таблице ниже указана частота сбора данных для типов изменений, поддерживаемых функцией отслеживания изменений и инвентаризации. Моментальный снимок данных текущего состояния для каждого типа обновляется по крайней мере каждые 24 часа.

| **Тип изменения** | **Частота** |
| --- | --- |
| Реестр Windows | 50 минут |
| Файловый ресурс Windows | 30 минут |
| Файловый ресурс Linux | 15 минут |
| Службы Майкрософт | от 10 секунд до 30 минут</br> Значение по умолчанию: 30 минут |
| Управляющие программы Linux | 5 мин |
| Программное обеспечение Windows | 30 минут |
| Программное обеспечение Linux | 5 мин |

В таблице ниже приведены ограничения по отслеживаемым элементам для одного компьютера при использовании функции отслеживания изменений и инвентаризации.

| **Ресурс** | **Ограничение** |
|---|---|---|
|Файл|500|
|Реестр|250|
|Программное обеспечение Windows (не включая исправления) |250|
|Пакеты Linux|1250|
|Службы|250|
|Управляющие программы|250|

Средний показатель использования данных Log Analytics для компьютера, использующего функцию отслеживания изменений и инвентаризации, — примерно 40 МБ в месяц в зависимости от среды. С помощью функции "Использование и ожидаемые затраты" рабочей области Log Analytics можно просмотреть данные, полученные функцией отслеживания изменений и инвентаризации, на диаграмме использования. Это представление данных можно использовать для оценки использования данных и определения того, как оно влияет на затраты. См. раздел [Просмотр сведений об использовании и оценка затрат](https://docs.microsoft.com/azure/azure-monitor/platform/manage-cost-storage#understand-your-usage-and-estimate-costs).  

### <a name="microsoft-service-data"></a>Данные по службам Майкрософт

Периодичность сбора по умолчанию для служб Майкрософт — 30 минут. Периодичность можно настроить с помощью ползунка на вкладке **Службы Майкрософт** в разделе **Изменить параметры**. 

![Ползунок на вкладке "Службы Майкрософт"](./media/change-tracking/windowservices.png)

Для оптимизации производительности агент Log Analytics отслеживает только изменения. Если вы установите высокое пороговое значение, изменения могут быть пропущены, когда служба вернется в исходное состояние. Если вы установите меньший период, то запишете изменения, которые в противном случае будут упущены.

> [!NOTE]
> Хотя агент может отслеживать изменения с 10-секундным интервалом, потребуется несколько минут, чтобы данные отобразились на портале Azure. В эти несколько минут изменения по-прежнему отслеживаются и записываются.

## <a name="support-for-alerts-on-configuration-state"></a>Поддержка оповещений о состоянии конфигурации

Ключевой возможностью отслеживания изменений и инвентаризации является возможность оповещения об изменениях состояния конфигурации в гибридной среде. Оповещения могут активировать многие полезные действия, например действия с функциями Azure, модулями runbook службы автоматизации, веб-перехватчиками и т. д. Предупреждение об изменениях в файле **C:\windows\system32\drivers\etc\hosts** компьютера — хороший пример применения оповещений для данных отслеживания изменений и инвентаризации. Существует множество других сценариев использования оповещений, включая сценарии запросов, определенные в следующей таблице. 

|Запрос  |Описание  |
|---------|---------|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Files" и FileSystemPath содержит " c:\\windows\\system32\\drivers\\"|Полезно для отслеживания изменений в системных критических файлах.|
|ConfigurationChange <br>&#124; где FieldsChanged содержит "FileContentChecksum" и FileSystemPath == "c:\\windows\\system32\\drivers\\etc\\hosts"|Полезно для отслеживания изменений в файлах конфигурации ключа.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Службы Майкрософт", SvcName содержит "w3svc", а SvcState == "Остановлено"|Полезно для отслеживания изменений в системных критически важных службах.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Управляющие программы", SvcName содержит "ssh", в SvcState == "Выполняется"|Полезно для отслеживания изменений в системных критически важных службах.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Software" и ChangeCategory == "Added"|Полезно для сред, которые требуют заблокированных конфигураций программного обеспечения.|
|ConfigurationData <br>&#124; где SoftwareName содержит "Monitoring Agent", а CurrentVersion != "8.0.11081.0"|Полезно для просмотра компьютеров, на которых установлена устаревшая или несовместимая версия программного обеспечения. Этот запрос сообщает о последнем сообщенном состоянии конфигурации, но не об изменениях.|
|ConfigurationChange <br>&#124; где RegistryKey == @"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\QualityCompat"| Полезно для отслеживания изменений в важных антивирусных ключах.|
|ConfigurationChange <br>&#124; где RegistryKey содержит @"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy"| Полезно для отслеживания изменений в параметрах брандмауэра.|

## <a name="next-steps"></a>Дальнейшие действия

* Подробные сведения о работе с отслеживанием изменений и инвентаризацией см. в статье [Управление решением для отслеживания изменений и инвентаризации](change-tracking-file-contents.md).
* Инструкции по включению этой функции из модуля runbook см. в статье [Включение отслеживания изменений и инвентаризации в последовательности runbook](automation-enable-changes-from-runbook.md).
* Инструкции по включению этой функции из учетной записи службы автоматизации см. в статье [Включение отслеживания изменений и инвентаризации в учетной записи службы автоматизации](automation-enable-changes-from-auto-acct.md).
* Инструкции по включению этой функции на портале Azure см. в статье [Включение отслеживания изменений и инвентаризации на портале Azure](automation-onboard-solutions-from-browse.md).
* Инструкции по включению этой функции из виртуальной машины Azure см. в статье [Включение отслеживания изменений и инвентаризации на виртуальной машине Azure](automation-enable-changes-from-vm.md).
* Если необходимо выполнить поиск по журналам, хранящимся в рабочей области Log Analytics, см. статью [Поиск по журналам Azure Monitor](../log-analytics/log-analytics-log-searches.md).
* Сведения об устранении ошибок функции см. в статье [Устранение неполадок с отслеживанием изменений и инвентаризации](troubleshoot/change-tracking.md).