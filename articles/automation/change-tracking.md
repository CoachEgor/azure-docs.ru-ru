---
title: Общие сведения об отслеживании изменений и инвентаризации в службе автоматизации Azure
description: В этой статье описывается функция Отслеживание изменений и инвентаризации, которая помогает обнаруживать изменения программного обеспечения и служб Майкрософт в вашей среде.
services: automation
ms.subservice: change-inventory-management
ms.date: 08/17/2020
ms.topic: conceptual
ms.openlocfilehash: 2fe92942e263cf53b9827ccbcb13a2d7bafc367c
ms.sourcegitcommit: 54d8052c09e847a6565ec978f352769e8955aead
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/18/2020
ms.locfileid: "88511054"
---
# <a name="change-tracking-and-inventory-overview"></a>Общие сведения об отслеживании изменений и инвентаризации

В этой статье приводятся основные сведения об отслеживании изменений и инвентаризации в службе автоматизации Azure. Эта функция отслеживает изменения в виртуальных машинах и серверной инфраструктуре, помогая выявлять проблемы в работе программного обеспечения, управляемого диспетчером пакетов распространения. Элементы, которые отслеживаются функцией отслеживания изменений и инвентаризации: 

- Программное обеспечение Windows
- программное обеспечение Linux (пакеты);
- файлы Windows и Linux;
- разделы реестра Windows;
- службы Майкрософт;
- Управляющие программы Linux

> [!NOTE]
> Чтобы отслеживать изменения свойств Azure Resource Manager, обратитесь к [журналу изменений](../governance/resource-graph/how-to/get-resource-changes.md) в Azure Resource Graph.

Функция отслеживания изменений и инвентаризации получает данные из Azure Monitor. Виртуальные машины, подключенные к Log Analytics рабочим областям, используют агент Log Analytics для получения данных об изменениях в установленном программном обеспечении, службах Майкрософт, реестре и файлах Windows и управляющих программах Linux на наблюдаемых серверах. Когда данные доступны, агент отправляет их в Azure Monitor для обработки. Azure Monitor применяет логику к полученным данным, записывает их и делает доступными.

> [!NOTE]
> Для Отслеживание изменений и инвентаризации необходимо связать Log Analytics рабочую область с учетной записью службы автоматизации. Полный список поддерживаемых регионов см. в статье о [сопоставлении рабочих областей Azure](./how-to/region-mappings.md). Сопоставления регионов не влияют на возможность управления виртуальными машинами в отдельном регионе из учетной записи службы автоматизации.

В настоящее время функция отслеживания изменений и инвентаризации не поддерживают следующие элементы:

- Рекурсия для отслеживания реестра Windows
- сетевые файловые системы;
- другие методы установки;
- файлы * **.exe** для Windows.

Другие ограничения:

- в текущей версии столбец и значения **Максимальный размер файла** не используются;
- Если вы соберете более 2500 файлов в течение 30-минутного цикла сбора, Отслеживание изменений и производительность инвентаризации могут снизиться.
- при интенсивном сетевом трафике изменение записей может занять до 6 часов;
- если изменение конфигурации выполняется на отключенном компьютере, он может внести изменения, относящиеся к предыдущей конфигурации.

В настоящее время известны перечисленные ниже проблемы решения для отслеживания изменений и инвентаризации.

- Обновления исправлений не собираются на компьютерах под RS3 Windows Server 2016 Core.

- Управляющие программы Linux могут показывать измененное состояние, даже если изменений не было. Эта проблема возникает из-за способа `SvcRunLevels` записи данных в журнал Azure Monitor [ConfigurationChange](/azure/azure-monitor/reference/tables/configurationchange) .

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Функция отслеживания изменений и инвентаризации поддерживается во всех операционных системах, отвечающих требованиям для агента Log Analytics. Официальными версиями операционной системы являются Windows Server 2008 SP1 или более поздней версии и Windows 7 SP1 или более поздней версии. Эта функция также поддерживается в ряде операционных систем Linux. Список поддерживаемых операционных систем см. в разделе [Общие сведения об агенте log Analytics](../azure-monitor/platform/log-analytics-agent.md).

Сведения о требованиях клиента к TLS 1,2 см. в разделе [Принудительная поддержка tls 1,2 для службы автоматизации Azure](automation-managing-data.md#tls-12-enforcement-for-azure-automation).

## <a name="network-requirements"></a>Требования к сети

Для функции отслеживания изменений и инвентаризации требуются сетевые адреса, перечисленные в приведенной ниже таблице. Для связи с этими адресами используется порт 443.

|Azure Public  |Azure для государственных организаций  |
|---------|---------|
|*.ods.opinsights.azure.com    | *.ods.opinsights.azure.us         |
|*.oms.opinsights.azure.com     | *.oms.opinsights.azure.us        |
|*.blob.core.windows.net | *.blob.core.usgovcloudapi.net|
|*.azure-automation.net | *.azure-automation.us|

## <a name="change-tracking-and-inventory-user-interface"></a>Пользовательский интерфейс отслеживания изменений и инвентаризации

Используйте функцию отслеживания изменений и инвентаризации на портале Azure для просмотра сводки изменений для отслеживаемых компьютеров. Чтобы получить доступ к этой функции, в учетной записи службы автоматизации необходимо выбрать команду добавления виртуальных машин для элемента **Отслеживание изменений** или **Инвентаризация** в разделе **Управление конфигурацией**.  

![Панель отслеживания изменений](./media/change-tracking/change-tracking-dash01.png)

Вверху панели мониторинга находятся раскрывающиеся списки. С их помощью можно отфильтровать диаграмму отслеживания изменений и подробные сведения по типу изменения и диапазону времени. Кроме того, вы можете щелкнуть на диаграмме и перетащить, чтобы выбрать нужный диапазон времени. 

Щелкните изменение или событие, чтобы отобразить подробные сведения о нем. Доступны следующие типы изменений:

- События
- Управляющие программы
- Файлы
- Реестр
- Программное обеспечение
- Службы Майкрософт

Каждое изменение можно добавить, изменить или удалить. В приведенном ниже примере показано изменение типа запуска службы с "вручную" на "автоматически".

![Сведения о Отслеживание изменений и инвентаризации](./media/change-tracking/change-tracking-details.png)

## <a name="fim-support-in-azure-security-center"></a>Поддержка FIM в центре безопасности Azure

Функция отслеживания изменений и инвентаризации использует [систему мониторинга целостности файлов (FIM) в Центре безопасности Azure](../security-center/security-center-file-integrity-monitoring.md). Хотя FIM наблюдает только за файлами и реестрами, полная функция отслеживания изменений и инвентаризации также обеспечивает отслеживание следующих элементов:

- изменения программного обеспечения;
- Службы Майкрософт
- Управляющие программы Linux

> [!NOTE]
> Включение решения для отслеживания изменений и инвентаризации может привести к дополнительным расходам. См. страницу [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/). Можно удалить FIM из [списка установленных решений мониторинга](../azure-monitor/insights/solutions.md#list-installed-monitoring-solutions) , доступных в портал Azure. См. раздел [Удаление решения для мониторинга](../azure-monitor/insights/solutions.md#remove-a-monitoring-solution).

## <a name="tracking-of-file-changes"></a>Отслеживание изменений в файлах

Для отслеживания изменений в файлах в Windows и Linux функция отслеживания изменений и инвентаризации использует MD5-хэши файлов. Затем эти хэши применяются для определения того, вносились ли изменения с момента последней инвентаризации.

## <a name="tracking-of-file-content-changes"></a>Отслеживание изменений в содержимом файлов

Отслеживание изменений и инвентаризация позволяет просматривать содержимое файла Windows или Linux. Для каждого изменения в файле функция отслеживания изменений и инвентаризации сохраняет содержимое файла в [учетной записи хранения Azure](../storage/common/storage-account-create.md). При отслеживании файла его содержимое можно просмотреть до или после изменения. Содержимое файла можно просмотреть как в строке, так и параллельно. 

![Просмотр изменений в файле](./media/change-tracking/view-file-changes.png)

## <a name="tracking-of-registry-keys"></a>Отслеживание разделов реестра

Отслеживание изменений и инвентаризация позволяет отслеживать изменения в разделах реестра Windows. Целью такого отслеживания является точное определение точек расширяемости, в которых может быть активирован сторонний код или вредоносная программа. В приведенной ниже таблице перечислены предварительно настроенные (но не включенные) разделы реестра. Чтобы отслеживать эти разделы, необходимо включить каждый из них.

> [!div class="mx-tdBreakAll"]
> |Ключ реестра | Назначение |
> | --- | --- |
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup` | Отслеживаются сценарии, выполняемые при запуске.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Shutdown` | Отслеживаются сценарии, выполняемые при завершении работы.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run` | Отслеживаются разделы, загружаемые перед входом пользователя в учетную запись Windows. Этот раздел используется для 32-разрядных приложений, выполняющихся на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Microsoft\Active Setup\Installed Components` | Отслеживаются изменения параметров приложения.
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\ShellEx\ContextMenuHandlers` | Отслеживает обработчики контекстного меню, которые напрямую присоединяются к проводнику Windows и обычно выполняются в процессе с **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\Shellex\CopyHookHandlers` | Отслеживает обработчики копирования, которые напрямую присоединяются к проводнику Windows и обычно выполняются в процессе с **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\ShellIconOverlayIdentifiers` | Отслеживается регистрация обработчика дополнительных значков.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\ShellIconOverlayIdentifiers` | Отслеживается регистрация обработчика дополнительных значков для 32-битных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects` | Отслеживаются новые подключаемые модули вспомогательных объектов браузера для Internet Explorer. Используется для доступа к модели DOM текущей страницы и управления навигацией.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects` | Отслеживаются новые подключаемые модули вспомогательных объектов браузера для Internet Explorer. Используется для получения доступа к модели DOM текущей страницы и управления навигацией для 32-разрядных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Internet Explorer\Extensions` | Отслеживаются новые расширения Internet Explorer, например пользовательские меню инструментов и пользовательские кнопки панели инструментов.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Internet Explorer\Extensions` | Отслеживаются новые расширения Internet Explorer, например пользовательские меню инструментов и пользовательские кнопки панели инструментов для 32-битных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Drivers32` | Отслеживаются 32-разрядные драйверы, связанные с устройствами wavemapper: wave1 и wave2, msacm.imaadpcm, .msadpcm, .msgsm610 и vidc. Ознакомьтесь с разделом о [драйверах] в файле **system.ini**.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Drivers32` | Отслеживаются 32-разрядные драйверы, связанные с устройствами wavemapper, — wave1 и wave2, msacm.imaadpcm, .msadpcm, .msgsm610 и vidc — для 32-разрядных приложений, работающих на 64-разрядных компьютерах. Ознакомьтесь с разделом о [драйверах] в файле **system.ini**.
> |`HKEY\LOCAL\MACHINE\System\CurrentControlSet\Control\Session Manager\KnownDlls` | Отслеживается список известных или часто используемых системных библиотек DLL. Наблюдение предотвращает использование слабых разрешений каталога приложений с помощью удаления в системных библиотеках DLL-Троянных версий.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify` | Отслеживается список пакетов, получающих уведомления о событиях из **winlogon.exe** — интерактивной модели поддержки входа в систему для Windows.

## <a name="recursion-support"></a>Поддержка рекурсии

Функция отслеживания изменений и инвентаризации поддерживает рекурсию, что позволяет использовать подстановочные знаки для упрощения отслеживания в каталогах. Рекурсия также предоставляет переменные среды, которые позволяют отслеживать файлы в разных средах с несколькими или динамическими именами дисков. В следующем списке приведены общие сведения, которые следует учитывать при настройке рекурсии.

- Для отслеживания нескольких файлов необходимы подстановочные знаки.

- Подстановочные знаки можно использовать только в последнем сегменте пути к файлу, например **c:\u1087? АПКА \\ File*** или **/etc/*. conf**.

- Если у переменной среды недопустимый путь, проверка будет успешной, но выполнение завершится сбоем.

- При задании пути не следует использовать общие имена путей, так как этот тип параметра может вызвать слишком много папок для обхода.

## <a name="change-tracking-and-inventory-data-collection"></a>Сбор данных для функции отслеживания изменений и инвентаризации

В таблице ниже указана частота сбора данных для типов изменений, поддерживаемых функцией отслеживания изменений и инвентаризации. Моментальный снимок данных текущего состояния для каждого типа обновляется по крайней мере каждые 24 часа.

| **Тип изменения** | **Частота** |
| --- | --- |
| Реестр Windows | 50 минут |
| Файловый ресурс Windows | 30 минут |
| Файловый ресурс Linux | 15 минут |
| Службы Майкрософт | от 10 секунд до 30 минут</br> Значение по умолчанию: 30 минут |
| Управляющие программы Linux | 5 мин |
| Программное обеспечение Windows | 30 минут |
| Программное обеспечение Linux | 5 мин |

В таблице ниже приведены ограничения по отслеживаемым элементам для одного компьютера при использовании функции отслеживания изменений и инвентаризации.

| **Ресурс** | **Ограничение** |
|---|---|---|
|Файл|500|
|Реестр|250|
|Программное обеспечение Windows (не включая исправления) |250|
|Пакеты Linux|1250|
|Службы|250|
|Управляющие программы|250|

Средний показатель использования данных Log Analytics для компьютера, использующего функцию отслеживания изменений и инвентаризации, — примерно 40 МБ в месяц в зависимости от среды. С помощью функции использования и оценки затрат рабочей области Log Analytics можно просмотреть данные, принимаемые Отслеживание изменений и инвентаризации на диаграмме использования. Используйте это представление данных, чтобы оценить использование данных и определить, как оно влияет на ваш счет. См. раздел [Просмотр сведений об использовании и оценка затрат](../azure-monitor/platform/manage-cost-storage.md#understand-your-usage-and-estimate-costs).

### <a name="microsoft-service-data"></a>Данные по службам Майкрософт

Периодичность сбора по умолчанию для служб Майкрософт — 30 минут. Периодичность можно настроить с помощью ползунка на вкладке **Службы Майкрософт** в разделе **Изменить параметры**.

![Ползунок на вкладке "Службы Майкрософт"](./media/change-tracking/windowservices.png)

Для оптимизации производительности агент Log Analytics отслеживает только изменения. Если вы установите высокое пороговое значение, изменения могут быть пропущены, когда служба вернется в исходное состояние. Если вы установите меньший период, то запишете изменения, которые в противном случае будут упущены.

> [!NOTE]
> Хотя агент может отслеживать изменения с 10-секундным интервалом, потребуется несколько минут, чтобы данные отобразились на портале Azure. В эти несколько минут изменения по-прежнему отслеживаются и записываются.

## <a name="support-for-alerts-on-configuration-state"></a>Поддержка оповещений о состоянии конфигурации

Ключевой возможностью отслеживания изменений и инвентаризации является возможность оповещения об изменениях состояния конфигурации в гибридной среде. Оповещения могут активировать многие полезные действия, например действия с функциями Azure, модулями runbook службы автоматизации, веб-перехватчиками и т. д. Предупреждение об изменениях в файле **c:\windows\system32\drivers\etc\hosts** для компьютера — это одно хорошее применение оповещений для отслеживание изменений и данных инвентаризации. Существует множество других сценариев использования оповещений, включая сценарии запросов, определенные в следующей таблице.

|Запрос  |Описание  |
|---------|---------|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Files" и FileSystemPath содержит " c:\\windows\\system32\\drivers\\"|Полезно для отслеживания изменений в системных критических файлах.|
|ConfigurationChange <br>&#124; где FieldsChanged содержит "FileContentChecksum" и FileSystemPath == "c:\\windows\\system32\\drivers\\etc\\hosts"|Полезно для отслеживания изменений в файлах конфигурации ключа.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "WindowsServices" и SvcName содержит "w3svc" и SvcState == "Stopped"|Полезно для отслеживания изменений в системных критически важных службах.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Управляющие программы", SvcName содержит "ssh", в SvcState == "Выполняется"|Полезно для отслеживания изменений в системных критически важных службах.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Software" и ChangeCategory == "Added"|Полезно для сред, которые требуют заблокированных конфигураций программного обеспечения.|
|ConfigurationData <br>&#124; где SoftwareName содержит "Monitoring Agent", а CurrentVersion != "8.0.11081.0"|Полезно для просмотра компьютеров, на которых установлена устаревшая или несовместимая версия программного обеспечения. Этот запрос сообщает о последнем сообщенном состоянии конфигурации, но не об изменениях.|
|ConfigurationChange <br>&#124; где RegistryKey == @"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\QualityCompat"| Полезно для отслеживания изменений в важных антивирусных ключах.|
|ConfigurationChange <br>&#124; где RegistryKey содержит @"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy"| Полезно для отслеживания изменений в параметрах брандмауэра.|

## <a name="next-steps"></a>Дальнейшие действия

- Инструкции по включению этой функции из учетной записи службы автоматизации см. в статье [Включение отслеживания изменений и инвентаризации в учетной записи службы автоматизации](automation-enable-changes-from-auto-acct.md).

- Сведения о включении этой функции путем просмотра портал Azure см. в разделе [включение отслеживание изменений и инвентаризации из портал Azure](automation-enable-changes-from-browse.md).

- Инструкции по включению этой функции из модуля runbook см. в статье [Включение отслеживания изменений и инвентаризации в последовательности runbook](automation-enable-changes-from-runbook.md).

- Инструкции по включению этой функции из виртуальной машины Azure см. в статье [Включение отслеживания изменений и инвентаризации на виртуальной машине Azure](automation-enable-changes-from-vm.md).
