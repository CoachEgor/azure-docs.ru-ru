---
title: Query Store в базе данных Azure для MariaDB
description: В этой статье описывается функция Store запросов в базе данных Azure для MariaDB
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: conceptual
ms.date: 06/12/2019
ms.openlocfilehash: 9016fa159e868f649901928cdf2dca2f08725e77
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67079396"
---
# <a name="monitor-azure-database-for-mariadb-performance-with-query-store"></a>Мониторинг базы данных Azure для MariaDB производительности с помощью Query Store

**Применяется к:**  база данных Azure для MariaDB 10.2

> [!NOTE]
> Query Store доступна Предварительная версия. Поддержка запросов Store на портале Azure будет развертываться и еще недоступен в вашем регионе.

Функция Store запросов в базе данных Azure для Mariadb предоставляет способ отслеживания производительности запросов с течением времени. Хранилище запросов упрощает устранение неполадок, позволяя быстро выявлять самые медленные и ресурсоемкие запросы. Хранилище запросов автоматически ведет журнал запросов и статистики выполнения и сохраняет их для просмотра. Этот компонент разделяет данные по периодам, давая представление о закономерностях использования баз данных. Данные для всех пользователей, баз данных и запросов хранятся в **mysql** схемы базы данных в базе данных Azure для MariaDB экземпляра.

## <a name="common-scenarios-for-using-query-store"></a>Распространенные сценарии использования Query Store

Хранилище запросов можно использовать в ряде сценариев, включая следующие:

- Обнаружение регрессионных запросов
- определение числа выполнений запроса за данный период времени;
- сравнение среднего времени выполнения запроса за периоды времени для выявления больших расхождений;
- определение самых медленно выполняющихся запросов за прошедшие X часов;
- определение основных N запросов, ожидающих ресурсы;
- Понимание характера ожидания для запроса
- Основные сведения о трендах для ожидания ресурсов и где существует конфликта ресурсов

## <a name="enabling-query-store"></a>Включение хранилища запросов

Хранилище запросов является дополнительной функцией, поэтому оно не активно на сервере по умолчанию. Хранилище запросов включено или отключено глобально для всех баз данных на данном сервере и не может включать и выключать на базу данных.

### <a name="enable-query-store-using-the-azure-portal"></a>Включение хранилища запросов с помощью портала Azure

1. Войдите на портал Azure и выберите свою базу данных Azure для MariaDB сервера.
1. Выберите **параметров сервера** в **параметры** меню.
1. Найдите параметр query_store_capture_mode.
1. Задайте значение для всех и **Сохранить**.

Чтобы включить статистику времени ожидания в Store вашего запроса:

1. Найдите параметр query_store_wait_sampling_capture_mode.
1. Задайте значение для всех и **Сохранить**.

Подождите 20 минут для первого пакета данных для сохранения в базе данных mysql.

## <a name="information-in-query-store"></a>Данные в хранилище запросов

Хранилище запросов включает два хранилища:

- Статистика времени выполнения хранилище для сохранения сведений о статистике выполнения запросов.
- Хранилище статистики ожидания для сохранения статистических сведений об ожидании.

Для уменьшения использования свободного места, статистические данные в хранилище статистики времени выполнения накапливаются в течение определенного интервала фиксированное, можно настроить. Сведения в этих хранилищах отображаются путем запроса представлений хранилища запросов.

Следующий запрос возвращает сведения о запросах в хранилище запросов:

```sql
SELECT * FROM mysql.query_store;
```

Или этот запрос для статистики ожидания:

```sql
SELECT * FROM mysql.query_store_wait_stats;
```

## <a name="finding-wait-queries"></a>Поиск запросов ожидания

Типы событий ожидания объединяют разные события ожидания в группы по принципу сходства. Хранилище запросов предоставляет тип события ожидания, имя определенного события ожидания и запрашиваемый запрос. Возможность сопоставлять эти сведения об ожидании со статистикой времени выполнения запроса позволяет получить более глубокое понимание аспектов, влияющих на характеристики производительности запросов.

Ниже приведены некоторые примеры получения более подробных сведений о рабочей нагрузке с помощью статистики ожидания в хранилище запросов.

| **Наблюдение** | **Действие** |
|---|---|
|Ожидания с высоким уровнем блокировки | Проверьте текст затронутых запросов и определите целевые сущности. Найдите в хранилище запросов другие запросы, изменяющие ту же сущность, которые часто выполняются и (или) имеют большую длительность. Определив эти запросы, рекомендуется изменить логику приложения, чтобы улучшить параллелизм, или использовать менее строгий уровень изоляции. |
|Ожидания с большим числом операций ввода-вывода буфера | Найдите в хранилище запросов запросы с большим числом физических операций чтения. Если они соответствуют запросам с высокие значения ожиданий ввода-ВЫВОДА, рассмотрите возможность ввести индекс для базовой сущности, чтобы выполнить поиск вместо сканирования. Это позволит свести к минимуму затраты на операции ввода-вывода запросов. Проверьте **рекомендации по повышению производительности** для сервера на портале, чтобы узнать, есть рекомендации по индексам для этого сервера, который бы оптимизировать запросы. |
|Ожидания с высокой загрузкой памяти | Найдите в хранилище запросов запросы, использующие больше всего памяти. Эти запросы, скорее всего, дополнительно задерживают выполнение соответствующих запросов. Проверьте **рекомендации по повышению производительности** для сервера на портале, чтобы узнать, есть рекомендации по индексам, которые бы оптимизировать такие запросы.|

## <a name="configuration-options"></a>Варианты настройки

При включении хранилища запросов оно сохраняет данные с 15-минутным периодом агрегирования: не более 500 уникальных запросов на период.

Ниже приведены настраиваемые параметры для хранилища запросов.

| **Параметр** | **Описание** | **По умолчанию** | **Range** |
|---|---|---|---|
| query_store_capture_mode | Включите хранилище запросов, ON/OFF на основе значения. Примечание. Если performance_schema имеет значение OFF, включение query_store_capture_mode включит performance_schema и подмножество instruments производительности схемы, необходимых для этого компонента. | ALL | НЕТ, ВСЕ |
| query_store_capture_interval | Хранилище запросов записи интервал в минутах. Позволяет указать интервал, в котором будут вычисляться метрики запросов | 15 | 5 - 60 |
| query_store_capture_utility_queries | Включение ON или OFF, чтобы регистрировать все запросы служебной программы, выполняемых в системе. | НЕТ | ДА, НЕТ |
| query_store_retention_period_in_days | Период в днях для хранения данных в хранилище запросов. | 7 | 1–30 |

Следующие параметры применяются исключительно к статистике ожидания.

| **Параметр** | **Описание** | **По умолчанию** | **Range** |
|---|---|---|---|
| query_store_wait_sampling_capture_mode | Можно включать ON / OFF статистику ожидания. | НЕТ | НЕТ, ВСЕ |
| query_store_wait_sampling_frequency | Изменяет частота выборки ожидания в секундах. 5 – 300 секунд. | 30 | 5-300 |

> [!NOTE]
> В настоящее время **query_store_capture_mode** заменяет этой конфигурации, то есть оба **query_store_capture_mode** и **query_store_wait_sampling_capture_mode** должен быть включен на все статистики ожидания для работы. Если **query_store_capture_mode** отключена, то Статистика времени ожидания будет отключено также поскольку использует статистику ожидания performance_schema включен и query_text, записанные хранилищем запросов.

Используйте [портала Azure](howto-server-parameters.md) требуется получить или задать другое значение для параметра.

## <a name="views-and-functions"></a>Представления и функции

Просмотр и управление хранилищем запросов осуществляеются с помощью следующих представлений и функций. Любой пользователь в [выберите привилегии роли public](howto-create-users.md#create-additional-admin-users) эти представления можно использовать для просмотра данных в Store запроса. Эти представления доступны только в **mysql** базы данных.

Запросы нормализованы: обратите внимание на их структуру после удаления литералов и констант. Если два запроса идентичны, за исключением литеральных значений, они будут иметь один хэш.

### <a name="mysqlquerystore"></a>mysql.query_store

Это представление возвращает все данные в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя и идентификатора запроса используется отдельная строка.

| **Имя** | **Тип данных** | **IS_NULLABLE** | **Описание** |
|---|---|---|---|
| `schema_name`| varchar(64) | НЕТ | Имя схемы |
| `query_id`| bigint(20) | НЕТ| Будет создан уникальный идентификатор, созданный для данного запроса, если тот же запрос выполняется в другую схему, новый идентификатор |
| `timestamp_id` | timestamp| НЕТ| Метка времени, в котором выполняется запрос. Это зависит от конфигурации query_store_interval|
| `query_digest_text`| longtext| НЕТ| Текст нормализованных запросов после удаления всех литералы|
| `query_sample_text` | longtext| НЕТ| Первое значение фактического запроса с помощью литералов|
| `query_digest_truncated` | bit| ДА| Были ли текст запроса усечены. Значение будет равно Yes, если запрос превышает 1 КБ|
| `execution_count` | bigint(20)| НЕТ| Число выполнений запроса есть для этого идентификатора timestamp / период настроенного интервала|
| `warning_count` | bigint(20)| НЕТ| Число предупреждений, этот запрос, созданный во время внутренней|
| `error_count` | bigint(20)| НЕТ| Количество ошибок, этот запрос, созданный во время интервала|
| `sum_timer_wait` | double| ДА| Общее время выполнения этого запроса во время интервала|
| `avg_timer_wait` | double| ДА| Среднее время выполнения для этого запроса во время интервала|
| `min_timer_wait` | double| ДА| Минимальные значения времени выполнения для этого запроса|
| `max_timer_wait` | double| ДА| Максимальное время выполнения|
| `sum_lock_time` | bigint(20)| НЕТ| Общее количество времени, затраченное на все блокировки для выполнения этого запроса в течение этого периода времени|
| `sum_rows_affected` | bigint(20)| НЕТ| Число затронутых строк|
| `sum_rows_sent` | bigint(20)| НЕТ| Число строк, отправленных клиенту|
| `sum_rows_examined` | bigint(20)| НЕТ| Число проверенных строк.|
| `sum_select_full_join` | bigint(20)| НЕТ| Число полного соединения|
| `sum_select_scan` | bigint(20)| НЕТ| Число просмотров select |
| `sum_sort_rows` | bigint(20)| НЕТ| Числом отсортированных строк|
| `sum_no_index_used` | bigint(20)| НЕТ| Количество раз, когда запрос не использовал все индексы|
| `sum_no_good_index_used` | bigint(20)| НЕТ| Количество раз, когда ядро выполнения запросов не использовался любой хороших индексов|
| `sum_created_tmp_tables` | bigint(20)| НЕТ| Общее число временные таблицы созданы|
| `sum_created_tmp_disk_tables` | bigint(20)| НЕТ| Общее число временных таблиц, созданные на диске (приводит к возникновению ошибки ввода-вывода)|
| `first_seen` | timestamp| НЕТ| Первое вхождение (UTC) запрос во время периода статистической обработки|
| `last_seen` | timestamp| НЕТ| Последнее вхождение (UTC) запрос во время этого периода статистической обработки|

### <a name="mysqlquerystorewaitstats"></a>mysql.query_store_wait_stats

Это представление возвращает данные событий ожидания в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя, идентификатора запроса и события используется отдельная строка.

| **Имя**| **Тип данных** | **IS_NULLABLE** | **Описание** |
|---|---|---|---|
| `interval_start` | timestamp | НЕТ| Начало интервала (шаг 15 минут)|
| `interval_end` | timestamp | НЕТ| Конец интервала (шаг 15 минут)|
| `query_id` | bigint(20) | НЕТ| Уникальный код в нормализованных запросов (из хранилища запросов)|
| `query_digest_id` | varchar(32) | НЕТ| Текст нормализованных запросов после удаления всех литералов (из хранилища запросов) |
| `query_digest_text` | longtext | НЕТ| Первое значение фактического запроса с литералами (из хранилища запросов) |
| `event_type` | varchar(32) | НЕТ| Категория события ожидания |
| `event_name` | varchar(128) | НЕТ| Имя события ожидания |
| `count_star` | bigint(20) | НЕТ| Число событий ожидания выборки в течение интервала запроса |
| `sum_timer_wait_ms` | double | НЕТ| Общее время ожидания (в миллисекундах) этого запроса во время интервала |

### <a name="functions"></a>Функции Azure

| **Имя**| **Описание** |
|---|---|
| `mysql.az_purge_querystore_data(TIMESTAMP)` | Удаляет все данные хранилища запросов перед метка заданного времени |
| `mysql.az_procedure_purge_querystore_event(TIMESTAMP)` | Очищает все ожидания данные события перед метка заданного времени |
| `mysql.az_procedure_purge_recommendation(TIMESTAMP)` | Очищает которого срок действия указывается перед отметку времени данного рекомендации |

## <a name="limitations-and-known-issues"></a>Ограничения и известные проблемы

- Если сервер MariaDB имеет параметр `default_transaction_read_only` , Query Store не записывает данные.
- Функциональные возможности Store запроса может быть прервана, при обнаружении длинные запросы Юникода (\>= 6000 байт).
- Срок хранения статистики ожидания составляет 24 часа.
- Статистика ожидания используется пример ti захвата часть событий. Можно изменить частоту с помощью параметра `query_store_wait_sampling_frequency`.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [анализ производительности запросов](concepts-query-performance-insight.md)
