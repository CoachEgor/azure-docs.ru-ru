---
title: Магазин запросов - База данных Azure для MariaDB
description: Узнайте о функции Магазина запросов в базе данных Azure для MariaDB, чтобы помочь вам отслеживать производительность с течением времени.
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: conceptual
ms.date: 3/18/2020
ms.openlocfilehash: a502638744009fc34a7f0a27f8034b89d2c8fa26
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79527815"
---
# <a name="monitor-azure-database-for-mariadb-performance-with-query-store"></a>Мониторинг базы данных Azure для производительности MariaDB с помощью магазина запросов

**Применяется к:** База данных Azure для MariaDB 10.2

Функция Хранилища запросов в базе данных Azure для Mariadb предоставляет способ отслеживания производительности запроса с течением времени. Хранилище запросов упрощает устранение неполадок, позволяя быстро выявлять самые медленные и ресурсоемкие запросы. Хранилище запросов автоматически ведет журнал запросов и статистики выполнения и сохраняет их для просмотра. Этот компонент разделяет данные по периодам, давая представление о закономерностях использования баз данных. Данные для всех пользователей, баз данных и запросов хранятся в базе данных **схемmy mysql** в базе данных Azure database для экземпляра MariaDB.

## <a name="common-scenarios-for-using-query-store"></a>Общие сценарии использования Магазина запросов

Хранилище запросов может быть использовано в нескольких сценариях, включая следующие:

- Обнаружение регрессных запросов
- определение числа выполнений запроса за данный период времени;
- сравнение среднего времени выполнения запроса за периоды времени для выявления больших расхождений;

## <a name="enabling-query-store"></a>Включение хранилища запросов

Хранилище запросов является дополнительной функцией, поэтому оно не активно на сервере по умолчанию. Хранилище запросов включено или отключено по всему миру для всех баз данных на данном сервере и не может быть включено или выключено в базе данных.

### <a name="enable-query-store-using-the-azure-portal"></a>Включение хранилища запросов с помощью портала Azure

1. Вопийте на портале Azure и выберите базу данных Azure для сервера MariaDB.
1. В разделе меню **Параметры** выберите **Параметры сервера**.
1. Поиск параметра query_store_capture_mode.
1. Установите значение для ВСЕХ и **Сохранить**.

Для включения статистики ожидания в магазин запросов:

1. Поиск query_store_wait_sampling_capture_mode параметра.
1. Установите значение для ВСЕХ и **Сохранить**.

Разрешить до 20 минут для первой партии данных, чтобы сохраниться в базе данных mysql.

## <a name="information-in-query-store"></a>Данные в хранилище запросов

Хранилище запросов включает два хранилища:

- Хранилище статистики времени выполнения для сохранения статистической информации о выполнении запросов.
- Хранилище статистики ожидания для сохраняющейся информации статистики ожидания.

Чтобы свести к минимуму использование пространства, статистика выполнения времени выполнения в хранилище статистики выполнения агрегируется по фиксированному, настраиваемому временному окну. Сведения в этих хранилищах отображаются путем запроса представлений хранилища запросов.

Следующий запрос возвращает сведения о запросах в хранилище запросов:

```sql
SELECT * FROM mysql.query_store;
```

Или этот запрос для статистики ожидания:

```sql
SELECT * FROM mysql.query_store_wait_stats;
```

## <a name="finding-wait-queries"></a>Поиск запросов ожидания

> [!NOTE]
> Статистика ожидания не должна быть включена в часы пиковой нагрузки или включена на неопределенный срок для чувствительных рабочих нагрузок. <br>Для рабочих нагрузок, работающих с высоким использованием процессора или на серверах, настроенных с более низкими vCores, используйте осторожность при включении статистики ожидания. Она не должна быть включена на неопределенный срок. 

Типы событий ожидания объединяют разные события ожидания в группы по принципу сходства. Хранилище запросов предоставляет тип события ожидания, имя определенного события ожидания и запрашиваемый запрос. Возможность сопоставлять эти сведения об ожидании со статистикой времени выполнения запроса позволяет получить более глубокое понимание аспектов, влияющих на характеристики производительности запросов.

Ниже приведены некоторые примеры получения более подробных сведений о рабочей нагрузке с помощью статистики ожидания в хранилище запросов.

| **Наблюдение** | **Действие** |
|---|---|
|Ожидания с высоким уровнем блокировки | Проверьте текст затронутых запросов и выявите целевые сущности. Найдите в хранилище запросов другие запросы, изменяющие ту же сущность, которые часто выполняются и (или) имеют большую длительность. Найдя такие запросы, рекомендуется изменить логику приложения, чтобы улучшить параллелизм, или использовать менее строгий уровень изоляции. |
|Ожидания с большим числом операций ввода-вывода буфера | Найдите в хранилище запросов запросы с большим числом физических операций чтения. Если они соответствуют запросам с высоким ожиданием IO, рассмотрите возможность введения индекса на базовой сущности, чтобы сделать запросы вместо сканирования. Это позволит свести к минимуму затраты на операции ввода-вывода запросов. Ознакомьтесь с **рекомендациями по повышению производительности** серверов на портале: возможно, для этого сервера есть рекомендации по индексам, которые позволят оптимизировать запросы. |
|Ожидания с высокой загрузкой памяти | Найдите в хранилище запросов те запросы, которые используют больше всего памяти. Вероятнее всего, эти запросы препятствуют дальнейшей обработке затронутых запросов. Ознакомьтесь с **рекомендациями по повышению производительности** для сервера на портале: возможно, есть рекомендации по индексам, которые позволят оптимизировать запросы.|

## <a name="configuration-options"></a>Варианты настройки

При включении хранилища запросов оно сохраняет данные с 15-минутным периодом агрегирования: не более 500 уникальных запросов на период.

Ниже приведены настраиваемые параметры для хранилища запросов.

| **Параметр** | **Описание** | **По умолчанию** | **Диапазон** |
|---|---|---|---|
| query_store_capture_mode | Поверните функцию хранилища запросов ON/OFF в зависимости от значения. Примечание: Если performance_schema OFF, включение query_store_capture_mode включит performance_schema и подмножество инструментов схемы производительности, необходимых для этой функции. | ALL | НЕТ, ВСЕ |
| query_store_capture_interval | Интервал захвата хранилища запросов за считанные минуты. Позволяет указать интервал, в котором агрегируются метрики запроса | 15 | 5 - 60 |
| query_store_capture_utility_queries | Включение ON или OFF для захвата всех запросов утилиты, которые исполняются в системе. | NO | ДА, НЕТ |
| query_store_retention_period_in_days | Окно времени в днях для сохранения данных в хранилище запросов. | 7 | 1–30 |

Следующие параметры применяются исключительно к статистике ожидания.

| **Параметр** | **Описание** | **По умолчанию** | **Диапазон** |
|---|---|---|---|
| query_store_wait_sampling_capture_mode | Позволяет поворачивать ON / OFF статистику ожидания. | None | НЕТ, ВСЕ |
| query_store_wait_sampling_frequency | Изменяет частоту выжидаемого отбора проб в считанные секунды. от 5 до 300 секунд. | 30 | 5-300 |

> [!NOTE]
> В настоящее время **query_store_capture_mode** заменяет эту конфигурацию, что означает, что **как query_store_capture_mode,** так и **query_store_wait_sampling_capture_mode** должны быть включены во все статистические данные ожидания для работы. Если **query_store_capture_mode** выключен, то статистика ожидания также отключается, так как статистика ожидания использует включенную performance_schema, а query_text захвачена хранилищем запросов.

Используйте [портал Azure,](howto-server-parameters.md) чтобы получить или установить другое значение для параметра.

## <a name="views-and-functions"></a>Представления и функции

Просмотр и управление хранилищем запросов осуществляеются с помощью следующих представлений и функций. Любой человек в [публичной роли избранной привилегии](howto-create-users.md#create-additional-admin-users) может использовать эти представления для просмотра данных в Магазине запросов. Эти представления доступны только в базе данных **mysql.**

Запросы нормализованы: обратите внимание на их структуру после удаления литералов и констант. Если два запроса идентичны, за исключением литеральных значений, они будут иметь один хэш.

### <a name="mysqlquery_store"></a>mysql.query_store

Это представление возвращает все данные в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя и идентификатора запроса используется отдельная строка.

| **Название** | **Тип данных** | **IS_NULLABLE** | **Описание** |
|---|---|---|---|
| `schema_name`| варчар (64) | NO | Название схемы |
| `query_id`| bigint (20) | NO| Уникальный идентификатор, генерируемый для конкретного запроса, если один и тот же запрос выполняется в разной схеме, будет сгенерирован новый идентификатор |
| `timestamp_id` | TIMESTAMP| NO| Метка времени, в которой выполняется запрос. Это основано на конфигурации query_store_interval|
| `query_digest_text`| longtext| NO| Нормализованный текст запроса после удаления всех букватов|
| `query_sample_text` | longtext| NO| Первое появление фактического запроса с буквальными|
| `query_digest_truncated` | bit| YES| Был ли усечен текст запроса. Значение будет да, если запрос длиннее 1 КБ|
| `execution_count` | bigint (20)| NO| Количество раз, когда запрос был выполнен для этого идентификатора временной метки / в течение настроенного интервала периода|
| `warning_count` | bigint (20)| NO| Количество предупреждений, генерируемых этим запросом во время|
| `error_count` | bigint (20)| NO| Количество ошибок, генерируемых этим запросом в интервале|
| `sum_timer_wait` | double| YES| Общее время выполнения этого запроса в интервале|
| `avg_timer_wait` | double| YES| Среднее время выполнения этого запроса в интервале|
| `min_timer_wait` | double| YES| Минимальное время выполнения для этого запроса|
| `max_timer_wait` | double| YES| Максимальное время выполнения|
| `sum_lock_time` | bigint (20)| NO| Общее количество времени, затраченного на все блокировки для выполнения этого запроса в течение этого временного окна|
| `sum_rows_affected` | bigint (20)| NO| количество затронутых строк.|
| `sum_rows_sent` | bigint (20)| NO| Количество строк, отправленных клиенту|
| `sum_rows_examined` | bigint (20)| NO| Число проверенных строк.|
| `sum_select_full_join` | bigint (20)| NO| Количество полных соединений|
| `sum_select_scan` | bigint (20)| NO| Количество выбранных сканирований |
| `sum_sort_rows` | bigint (20)| NO| Количество отсортированных рядов|
| `sum_no_index_used` | bigint (20)| NO| Количество раз, когда в запросе не использовались какие-либо индексы|
| `sum_no_good_index_used` | bigint (20)| NO| Количество случаев, когда движок выполнения запроса не использовал хороших индексов|
| `sum_created_tmp_tables` | bigint (20)| NO| Общее количество созданных таблиц temp|
| `sum_created_tmp_disk_tables` | bigint (20)| NO| Общее количество временных таблиц, созданных на диске (генерирует вводом/вводом)|
| `first_seen` | TIMESTAMP| NO| Первое возникновение (UTC) запроса во время окна агрегации|
| `last_seen` | TIMESTAMP| NO| Последнее возникновение (UTC) запроса в этом окне агрегации|

### <a name="mysqlquery_store_wait_stats"></a>mysql.query_store_wait_stats

Это представление возвращает данные событий ожидания в хранилище запросов. Для каждого отдельного идентификатора базы данных, идентификатора пользователя, идентификатора запроса и события используется отдельная строка.

| **Название**| **Тип данных** | **IS_NULLABLE** | **Описание** |
|---|---|---|---|
| `interval_start` | TIMESTAMP | NO| Начало интервала (15-минутный приращение)|
| `interval_end` | TIMESTAMP | NO| Конец интервала (15-минутный приращение)|
| `query_id` | bigint (20) | NO| Генерируемый уникальный идентификатор на нормализованном запросе (из магазина запросов)|
| `query_digest_id` |  varchar(32) | NO| Нормализованный текст запроса после удаления всех букватов (из магазина запросов) |
| `query_digest_text` | longtext | NO| Первое появление фактического запроса с буквальными буквами (из магазина запросов) |
| `event_type` |  varchar(32) | NO| Категория события ожидания |
| `event_name` | варчар (128) | NO| Название события ожидания |
| `count_star` | bigint (20) | NO| Количество событий ожидания, отобранных в интервале для запроса |
| `sum_timer_wait_ms` | double | NO| Общее время ожидания (в миллисекундах) этого запроса в интервале |

### <a name="functions"></a>Функции

| **Название**| **Описание** |
|---|---|
| `mysql.az_purge_querystore_data(TIMESTAMP)` | Очищает все данные хранилища запросов до данной отметки времени |
| `mysql.az_procedure_purge_querystore_event(TIMESTAMP)` | Очищает все данные события ожидания до данной отметки времени |
| `mysql.az_procedure_purge_recommendation(TIMESTAMP)` | Рекомендации по чисткам, срок действия которых равен данной отметке времени |

## <a name="limitations-and-known-issues"></a>Ограничения и известные проблемы

- Если сервер MariaDB имеет `default_transaction_read_only` параметр, Магазин запросов не может захватить данные.
- Функциональность хранилища запросов может быть прервана, если\>она сталкивается с длинными запросами Unicode (6000 байтов).
- Период удержания статистики ожидания составляет 24 часа.
- Статистика ожидания использует образец ti, захватив часть событий. Частота может быть изменена `query_store_wait_sampling_frequency`с помощью параметра.

## <a name="next-steps"></a>Дальнейшие действия

- Подробнее об [исследованиях производительности запросов](concepts-query-performance-insight.md)
