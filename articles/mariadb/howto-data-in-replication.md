---
title: Настройка репликации данных в службе "база данных Azure для MariaDB"
description: В этой статье описывается, как настроить Репликация входных данных в базе данных Azure для MariaDB.
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: conceptual
ms.date: 12/02/2019
ms.openlocfilehash: 0dbbc9b09d5d4770296223db9dc909c17f574fe8
ms.sourcegitcommit: 6bb98654e97d213c549b23ebb161bda4468a1997
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74767030"
---
# <a name="configure-data-in-replication-in-azure-database-for-mariadb"></a>Настройка Репликация входных данных в базе данных Azure для MariaDB

В этой статье описывается, как настроить Репликация входных данных в базе данных Azure для MariaDB, настроив главные и репликовые серверы. В этой статье предполагается, что у вас есть опыт работы с серверами и базами данных MariaDB.

Чтобы создать реплику в службе "база данных Azure для MariaDB", Репликация входных данных синхронизирует данные с главного MariaDB-сервера в локальной среде, на виртуальных машинах или в облачных службах баз данных.

> [!NOTE]
> Если главный сервер имеет версию 10,2 или более позднюю, рекомендуется настроить Репликация входных данных с помощью [идентификатора глобальной транзакции](https://mariadb.com/kb/en/library/gtid/).


## <a name="create-a-mariadb-server-to-use-as-a-replica"></a>Создание сервера MariaDB для использования в качестве реплики

1. Создайте новую базу данных Azure для сервера MariaDB (например, replica.mariadb.database.azure.com). Сервер является сервером-репликой в Репликация входных данных.

    Дополнительные сведения о создании сервера см. в статье [Создание сервера базы данных Azure для MariaDB с помощью портал Azure](quickstart-create-mariadb-server-database-using-azure-portal.md).

   > [!IMPORTANT]
   > Необходимо создать сервер базы данных Azure для MariaDB в общего назначения или ценовой категории, оптимизированные для памяти.

2. Создайте идентичные учетные записи пользователей и соответствующие привилегии.
    
    Учетные записи пользователей не реплицируются с главного сервера на сервер реплики. Чтобы предоставить пользователю доступ к серверу реплики, необходимо вручную создать все учетные записи и соответствующие привилегии на созданном сервере базы данных Azure для MariaDB.

## <a name="configure-the-master-server"></a>Настройка главного сервера

Следующие шаги подготавливают и настраивают сервер MariaDB, размещенный локально, на виртуальной машине или в облачной службе базы данных для Репликация входных данных. Сервер MariaDB является главным в Репликация входных данных.

1. Включите ведение журнала в двоичном формате.
    
    Чтобы узнать, включено ли ведение журнала на базе главного сервера, введите следующую команду:

   ```sql
   SHOW VARIABLES LIKE 'log_bin';
   ```

   Если переменная [`log_bin`](https://mariadb.com/kb/en/library/replication-and-binary-log-server-system-variables/#log_bin) возвращает значение `ON`, ведение двоичного журнала включено на сервере.

   Если `log_bin` возвращает значение `OFF`, измените файл **My. cnf** таким образом, чтобы `log_bin=ON` включит ведение двоичного журнала. Перезапустите сервер, чтобы изменения вступили в силу.

2. Настройте параметры главного сервера.

    Для Репликация входных данных требуется согласованность параметра `lower_case_table_names` между главным сервером и серверами реплики. Параметр `lower_case_table_names` по умолчанию имеет значение `1` в базе данных Azure для MariaDB.

   ```sql
   SET GLOBAL lower_case_table_names = 1;
   ```

3. Создайте новую роль репликации и настройте разрешения.

   Создайте учетную запись пользователя на главном сервере, настроенном с привилегиями репликации. Учетную запись можно создать с помощью команд SQL или MySQL Workbench. Если планируется репликация с помощью протокола SSL, необходимо указать ее при создании учетной записи пользователя.
   
   Чтобы узнать, как добавить учетные записи пользователей на главном сервере, см. [документацию по MariaDB](https://mariadb.com/kb/en/library/create-user/).

   С помощью приведенных ниже команд новая роль репликации может получить доступ к мастеру с любого компьютера, а не только с компьютера, на котором размещается сам хозяин. Для этого доступа укажите **синкусер\@"%"** в команде, чтобы создать пользователя.
   
   Дополнительные сведения о документации по MariaDB см. в разделе [Указание имен учетных записей](https://mariadb.com/kb/en/library/create-user/#account-names).

   **Команда SQL**

   - Репликация с помощью SSL

       Чтобы включить SSL для всех подключений пользователей, введите следующую команду, чтобы создать пользователя:

       ```sql
       CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
       GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%' REQUIRE SSL;
       ```

   - Репликация без SSL

       Если протокол SSL не требуется для всех подключений, введите следующую команду, чтобы создать пользователя:
    
       ```sql
       CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
       GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%';
       ```

   **MySQL Workbench**

   Чтобы создать роль репликации в MySQL Workbench, в области **управления** выберите **Пользователи и привилегии**. Затем выберите **Добавить учетную запись**.
 
   ![Пользователи и привилегии](./media/howto-data-in-replication/users_privileges.png)

   Введите имя пользователя в поле **имя входа** .

   ![Синхронизация пользователя](./media/howto-data-in-replication/syncuser.png)
 
   Выберите панель " **административные роли** ", а затем в списке **глобальных привилегий**выберите **репликация Slave**. Нажмите кнопку **Применить** , чтобы создать роль репликации.

   ![Ведомая роль репликации](./media/howto-data-in-replication/replicationslave.png)


4. Установите режим "только чтение" для главного сервера.

   Перед созданием дампа базы данных сервер должен быть переведен в режим "только для чтения". В режиме только для чтения мастер не может обработать какие-либо транзакции записи. Чтобы избежать воздействия на бизнес, запланируйте окно, доступное только для чтения, во время наименьшей нагрузки.

   ```sql
   FLUSH TABLES WITH READ LOCK;
   SET GLOBAL read_only = ON;
   ```

5. Возвращает текущее имя двоичного файла журнала и смещение.

   Чтобы определить текущее имя двоичного файла журнала и смещение, выполните команду [`show master status`](https://mariadb.com/kb/en/library/show-master-status/).
    
   ```sql
   show master status;
   ```
   Результаты должны быть похожи на приведенную ниже таблицу.
   
   ![Результаты состояния основного сервера](./media/howto-data-in-replication/masterstatus.png)

   Запишите имя двоичного файла, так как оно будет использоваться на последующих шагах.
   
6. Получите расположение ГТИД (необязательно, необходимое для репликации с помощью ГТИД).

   Запустите функцию [`BINLOG_GTID_POS`](https://mariadb.com/kb/en/library/binlog_gtid_pos/) , чтобы получить расположение гтид для соответствующего имени и смещения файла бинлог.
  
    ```sql
    select BINLOG_GTID_POS('<binlog file name>', <binlog offset>);
    ```
 

## <a name="dump-and-restore-the-master-server"></a>Дамп и восстановление главного сервера

1. Выведите дамп всех баз данных с главного сервера.

   Используйте mysqldump для дампа всех баз данных с главного сервера. Нет необходимости в выгрузить библиотеку библиотек и тестирования MySQL.

    Дополнительные сведения см. в разделе [dump и RESTORE](howto-migrate-dump-restore.md).

2. Задайте для главного сервера режим чтения/записи.

   После создания дампа базы данных смените сервер Master MariaDB обратно на режим чтения/записи.

   ```sql
   SET GLOBAL read_only = OFF;
   UNLOCK TABLES;
   ```

3. Восстановите файл дампа на новом сервере.

   Восстановите файл дампа на сервере, созданном в базе данных Azure для MariaDB. См. раздел [dump & Restore](howto-migrate-dump-restore.md) , как восстановить файл дампа на сервер MariaDB.

   Если файл дампа большой, отправьте его на виртуальную машину в Azure в том же регионе, что и сервер реплики. Восстановите его на сервере базы данных Azure для MariaDB с виртуальной машины.

## <a name="link-the-master-and-replica-servers-to-start-data-in-replication"></a>Свяжите главные и репликовые серверы для запуска Репликация входных данных

1. Задайте главный сервер.

   Все функции репликации входных данных выполняются хранимыми процедурами. Все процедуры можно найти в статье о [хранимых процедурах репликации входных данных](reference-data-in-stored-procedures.md). Хранимые процедуры можно запускать в оболочке MySQL или MySQL Workbench.

   Чтобы связать два сервера и запустить репликацию, войдите на целевой сервер реплики в службе "база данных Azure для MariaDB". Затем задайте внешний экземпляр в качестве главного сервера с помощью `mysql.az_replication_change_master` или `mysql.az_replication_change_master_with_gtid` хранимой процедуры на сервере базы данных Azure для MariaDB.

   ```sql
   CALL mysql.az_replication_change_master('<master_host>', '<master_user>', '<master_password>', 3306, '<master_log_file>', <master_log_pos>, '<master_ssl_ca>');
   ```
   
   или
   
   ```sql
   CALL mysql.az_replication_change_master_with_gtid('<master_host>', '<master_user>', '<master_password>', 3306, '<master_gtid_pos>', '<master_ssl_ca>');
   ```

   - master_host: имя узла главного сервера.
   - master_user: имя пользователя для главного сервера.
   - master_password: пароль для главного сервера.
   - master_log_file: имя файла двоичного журнала из выполняемой команды `show master status`.
   - master_log_pos: позиция в двоичном журнале из выполняемой команды `show master status`.
   - master_gtid_pos: расположение ГТИД от запуска `select BINLOG_GTID_POS('<binlog file name>', <binlog offset>);`
   - master_ssl_ca: контекст сертификата ЦС. Если вы не используете SSL, передайте пустую строку. *
    
    
    \* Мы рекомендуем передавать параметр master_ssl_ca в виде переменной. Дополнительные сведения представлены в примерах ниже.

   **Примеры**

   - Репликация с помощью SSL

       Создайте переменную `@cert`, выполнив следующие команды:

       ```sql
       SET @cert = '-----BEGIN CERTIFICATE-----
       PLACE YOUR PUBLIC KEY CERTIFICATE’S CONTEXT HERE
       -----END CERTIFICATE-----'
       ```

       Репликация с SSL настраивается между главным сервером, размещенным в домене companya.com, и сервером реплики, размещенным в базе данных Azure для MariaDB. Эта хранимая процедура выполняется на реплике.
    
       ```sql
       CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mariadb-bin.000016', 475, @cert);
       ```
   - Репликация без SSL

       Репликация без SSL настраивается между главным сервером, размещенным в домене companya.com, и сервером реплики, размещенным в базе данных Azure для MariaDB. Эта хранимая процедура выполняется на реплике.

       ```sql
       CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mariadb-bin.000016', 475, '');
       ```

2. Запустите репликацию.

   Чтобы запустить репликацию, вызовите хранимую процедуру `mysql.az_replication_start`.

   ```sql
   CALL mysql.az_replication_start;
   ```

3. Проверьте состояние репликации.

   Вызовите команду [`show slave status`](https://mariadb.com/kb/en/library/show-slave-status/) на сервере-реплике, чтобы просмотреть состояние репликации.
    
   ```sql
   show slave status;
   ```

   Если `Slave_IO_Running` и `Slave_SQL_Running` находятся в `yes`состояния, а значение `Seconds_Behind_Master` — `0`, репликация работает. `Seconds_Behind_Master` указывает величину задержки на реплике. Если значение не `0`, реплика обрабатывает обновления.

4. Обновите соответствующие переменные сервера, чтобы обеспечить безопасность репликации данных (требуется только для репликации без ГТИД).
    
    Из-за ограничений собственной репликации в MariaDB необходимо установить [`sync_master_info`](https://mariadb.com/kb/en/library/replication-and-binary-log-system-variables/#sync_master_info) и [`sync_relay_log_info`](https://mariadb.com/kb/en/library/replication-and-binary-log-system-variables/#sync_relay_log_info) переменных в репликации без сценария гтид.

    Проверьте `sync_master_info` и `sync_relay_log_info` переменные ведомого сервера, чтобы убедиться, что репликация данных является стабильной, и присвойте переменным значение `1`.
    
## <a name="other-stored-procedures"></a>Другие хранимые процедуры

### <a name="stop-replication"></a>Остановка репликации

Чтобы остановить репликацию между главным сервером и сервером-репликой, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_stop;
```

### <a name="remove-the-replication-relationship"></a>Удаление отношения репликации

Чтобы удалить связь между сервером главной и серверной реплики, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_remove_master;
```

### <a name="skip-the-replication-error"></a>Пропустить ошибку репликации

Чтобы пропустить ошибку репликации и разрешить репликацию, используйте следующую хранимую процедуру:
    
```sql
CALL mysql.az_replication_skip_counter;
```

## <a name="next-steps"></a>Дальнейшие действия
См. дополнительные сведения о [репликации входных данных](concepts-data-in-replication.md) в базе данных Azure для MariaDB.
