---
title: Настройка репликации входных данных для репликации данных в базу данных Azure для MariaDB.
description: В этой статье объясняется, как настроить репликацию входных данных для базы данных Azure для MariaDB.
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: conceptual
ms.date: 09/24/2018
ms.openlocfilehash: 3897c402e45962836880ccebbeb252d189188d3c
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61038608"
---
# <a name="how-to-configure-azure-database-for-mariadb-data-in-replication"></a>Настройка базы данных Azure для MariaDB для репликации входных данных

Из этой статьи вы узнаете о том, как настроить репликацию входных данных в базе данных Azure для MariaDB, настроив главный сервер и сервер-реплику. Репликация входных данных позволяет синхронизировать данные работающего локально главного сервера MariaDB на виртуальных машинах или в службах баз данных, размещенных другими облачными поставщиками, в реплику в службе "База данных Azure для MariaDB". 

В этой статье предполагается, что у вас имеется хотя бы небольшой опыт работы с серверами и базами данных MariaDB.

## <a name="create-a-mariadb-server-to-be-used-as-replica"></a>Создание сервера MariaDB для использования в качестве реплики

1. Создание нового сервера базы данных Azure для MariaDB

   Создайте новый сервер MariaDB (например, replica.mariadb.database.azure.com). Инструкции по созданию сервера см. в статье [Создание сервера базы данных Azure для MariaDB с помощью портала Azure](quickstart-create-mariadb-server-database-using-azure-portal.md). Этот сервер будет сервером-репликой в процессе репликации входных данных.

   > [!IMPORTANT]
   > Сервер базы данных Azure для MariaDB необходимо создать в ценовой категории "Общего назначения" или "Оптимизировано для памяти".
   > 

2. Создайте одинаковые учетные записи пользователей и соответствующие привилегии.

   Учетные записи пользователей не реплицируются с главного сервера на сервер-реплику. Если планируется предоставлять пользователям доступ к серверу-реплике, необходимо вручную создать все учетные записи и соответствующие привилегии на только что созданном сервере базы данных Azure для MariaDB.

## <a name="configure-the-master-server"></a>Настройка главного сервера
Ниже приведены действия для подготовки и настройки сервера MariaDB, размещенного в локальной среде или на виртуальной машине, либо службы базы данных, размещенной у другого поставщика облака облачных служб, для репликации входных данных. Этот сервер будет выступать в роли главного сервера в процессе репликации входных данных. 

1. Включите ведение двоичного журнала.

   Проверьте, включено ли ведение двоичного журнала на главном сервере, выполнив следующую команду: 

   ```sql
   SHOW VARIABLES LIKE 'log_bin';
   ```

   Если переменная [`log_bin`](https://mariadb.com/kb/en/library/replication-and-binary-log-server-system-variables/#log_bin) возвращается со значением ON (Вкл.), ведение двоичного журнала на сервере включено. 

   Если `log_bin` возвращается со значением OFF, включите ведение двоичного журнала, изменив соответствующую переменную в файле my.cnf на `log_bin=ON`, и перезагрузите сервер, чтобы изменение вступило в силу.

2. Параметры главного сервера

   Для репликации входных данных требуется согласованность параметра `lower_case_table_names` между главным сервером и сервером-репликой. По умолчанию этот параметр в базе данных Azure для MariaDB равен 1. 

   ```sql
   SET GLOBAL lower_case_table_names = 1;
   ```

3. Создайте новую роль репликации и настройте разрешения.

   Создайте учетную запись пользователя на главном сервере, настроенную с привилегиями репликации. Это можно сделать с помощью команд SQL или такого средства, как MySQL Workbench. Определите, планируется ли репликация с использованием SSL, так как это будет необходимо указать при создании пользователя. Чтобы узнать, как [добавить учетные записи пользователей](https://mariadb.com/kb/en/library/create-user/) на главном сервере, см. документацию по MariaDB. 

   В приведенных ниже командах созданная роль репликации имеет доступ к главному серверу с любого компьютера, а не только с компьютера, на котором размещен сам сервер. Для этого следует указать syncuser\@'%' в команде создания пользователя. Дополнительные сведения об [указании имен учетных записей](https://mariadb.com/kb/en/library/create-user/#account-names) см. в документации по MariaDB.

   **Команда SQL**

   *Репликация с использованием SSL*

   Чтобы настроить обязательное использование SSL для всех подключений пользователей, примените следующую команду для создания пользователя: 

   ```sql
   CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
   GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%' REQUIRE SSL;
   ```

   *Репликация без SSL*

   Если SSL не требуется для всех подключений, создайте пользователя с помощью следующей команды:

   ```sql
   CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
   GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%';
   ```

   **MySQL Workbench**

   Чтобы создать роль репликации в MySQL Workbench, откройте панель **Users and Privileges** (Пользователи и привилегии) с панели **Management** (Управление). Затем нажмите **Add Account** (Добавить учетную запись). 
 
   ![Пользователи и привилегии](./media/howto-data-in-replication/users_privileges.png)

   Введите имя пользователя в поле **Login Name** (Имя входа). 

   ![Синхронизация пользователя](./media/howto-data-in-replication/syncuser.png)
 
   Щелкните панель **Administrative Roles** (Роли администрирования), а затем выберите **Replication Slave** (Ведомая роль репликации) из списка **Global Privileges** (Глобальные привилегии). Затем щелкните **Apply** (Применить), чтобы создать роль репликации.

   ![Ведомая роль репликации](./media/howto-data-in-replication/replicationslave.png)


4. Настройте главный сервер в режиме только для чтения.

   Перед началом выгрузки базы данных сервер необходимо перевести в режим только для чтения. В режиме только для чтения главный сервер не сможет обрабатывать никакие транзакции записи. Оцените, как это повлияет на ваш бизнес, и при необходимости запланируйте окно режима только для чтения на непиковое время.

   ```sql
   FLUSH TABLES WITH READ LOCK;
   SET GLOBAL read_only = ON;
   ```

5. Узнайте имя файла двоичного журнала и смещение.

   Выполните команду [`show master status`](https://mariadb.com/kb/en/library/show-master-status/), чтобы определить текущее имя файла двоичного журнала и его смещение.
    
   ```sql
   show master status;
   ```
   Результаты должны выглядеть так, как показано ниже. Не забудьте записать имя двоичного файла, так как оно будет использоваться на последующих этапах.

   ![Результаты состояния основного сервера](./media/howto-data-in-replication/masterstatus.png)
 
## <a name="dump-and-restore-master-server"></a>Выгрузка и восстановление главного сервера

1. Выгрузите все базы данных с главного сервера.

   Для выгрузки баз данных с главного сервера можно использовать mysqldump. Подробные сведения см. в статье о [дампе и восстановлении](howto-migrate-dump-restore.md). Выгружать библиотеку MySQL и тестовую библиотеку нет необходимости.

2. Настройте для главного сервера режим чтения и записи.

   После выгрузки базы данных переведите главный сервер MariaDB обратно в режим чтения и записи.

   ```sql
   SET GLOBAL read_only = OFF;
   UNLOCK TABLES;
   ```

3. Восстановите файл дампа на новом сервере.

   Восстановите файл дампа на сервере, созданном в базе данных Azure для MariaDB. Чтобы узнать, как восстановить файл дампа на сервере MariaDB, см. статью о [дампе и восстановлении](howto-migrate-dump-restore.md). Если файл дампа имеет большой размер, отправьте его на виртуальную машину в Azure в том же регионе, где располагается сервер-реплика. Восстановите его на сервере базы данных Azure для MariaDB с виртуальной машины.

## <a name="link-master-and-replica-servers-to-start-data-in-replication"></a>Создание связи между главным сервером и сервером-репликой для запуска репликации входных данных

1. Настройте главный сервер.

   Все функции репликации входных данных выполняются хранимыми процедурами. Все процедуры можно найти в статье о [хранимых процедурах репликации входных данных](reference-data-in-stored-procedures.md). Хранимые процедуры можно выполнять в оболочке MySQL или MySQL Workbench.

   Чтобы создать связь между двумя серверами и начать репликацию, войдите на целевой сервер-реплику в базе данных Azure для MariaDB и задайте внешний экземпляр в качестве главного сервера. Это делается с помощью хранимой процедуры `mysql.az_replication_change_master` на сервере базы данных Azure для MariaDB.

   ```sql
   CALL mysql.az_replication_change_master('<master_host>', '<master_user>', '<master_password>', 3306, '<master_log_file>', <master_log_pos>, '<master_ssl_ca>');
   ```

   - master_host: имя узла главного сервера.
   - master_user: имя пользователя для главного сервера.
   - master_password: пароль для главного сервера.
   - master_log_file: имя файла двоичного журнала из выполняемой команды `show master status`.
   - master_log_pos: позиция в двоичном журнале из выполняемой команды `show master status`.
   - master_ssl_ca: контекст сертификата ЦС. Если протокол SSL не используется, передайте пустую строку.
       - Этот параметр рекомендуется передавать в виде переменной. См. следующие примеры для получения дополнительных сведений.

   **Примеры**

   *Репликация с использованием SSL*

   Переменная `@cert` создается путем выполнения следующих команд MariaDB: 

   ```sql
   SET @cert = '-----BEGIN CERTIFICATE-----
   PLACE YOUR PUBLIC KEY CERTIFICATE’S CONTEXT HERE
   -----END CERTIFICATE-----'
   ```

   Репликация с использованием SSL настраивается между главным сервером, размещенным в домене companya.com, и сервером-репликой, размещенным в базе данных Azure для MariaDB. Эта хранимая процедура выполняется на реплике. 

   ```sql
   CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mariadb-bin.000016', 475, @cert);
   ```
   *Репликация без SSL*

   Репликация без использования SSL настраивается между главным сервером, размещенным в домене companya.com, и сервером-репликой, размещенным в базе данных Azure для MariaDB. Эта хранимая процедура выполняется на реплике.

   ```sql
   CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mariadb-bin.000016', 475, '');
   ```

2. Запустите репликацию.

   Вызовите хранимую процедуру `mysql.az_replication_start`, чтобы начать репликацию.

   ```sql
   CALL mysql.az_replication_start;
   ```

3. Проверьте состояние репликации.

   Вызовите команду [`show slave status`](https://mariadb.com/kb/en/library/show-slave-status/) на сервере-реплике, чтобы просмотреть состояние репликации.
    
   ```sql
   show slave status;
   ```

   Если `Slave_IO_Running` и `Slave_SQL_Running` имеют состояние "yes" (да) и значение `Seconds_Behind_Master`, равное "0", репликация выполняется правильно. `Seconds_Behind_Master` указывает величину задержки на реплике. Если значение не равно "0", это означает, что реплика обрабатывает обновления. 

## <a name="other-stored-procedures"></a>Другие хранимые процедуры

### <a name="stop-replication"></a>Остановить репликацию

Чтобы остановить репликацию между главным сервером и сервером-репликой, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_stop;
```

### <a name="remove-replication-relationship"></a>Удаление связи репликации

Чтобы удалить связь между главным сервером и сервером-репликой, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_remove_master;
```

### <a name="skip-replication-error"></a>Пропуск ошибки репликации

Чтобы пропустить ошибку репликации и разрешить репликации продолжаться, используйте следующую хранимую процедуру:
    
```sql
CALL mysql.az_replication_skip_counter;
```

## <a name="next-steps"></a>Дальнейшие действия
- См. дополнительные сведения о [репликации входных данных](concepts-data-in-replication.md) в базе данных Azure для MariaDB.
