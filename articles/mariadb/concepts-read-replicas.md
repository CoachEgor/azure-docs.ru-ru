---
title: Чтение реплик в базе данных Azure для MariaDB
description: 'Сведения о репликах чтения в базе данных Azure для MariaDB: выбор регионов, создание реплик, подключение к репликам, мониторинг репликации и остановка репликации.'
author: ajlam
ms.author: andrela
ms.service: mariadb
ms.topic: conceptual
ms.date: 7/7/2020
ms.openlocfilehash: ec06fff73b1a4209546af5ca845e28aaa9dfb0b3
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91532352"
---
# <a name="read-replicas-in-azure-database-for-mariadb"></a>Реплики чтения в Базе данных Azure для MariaDB

Реплика чтения позволяет реплицировать данные с сервера Базы данных Azure для MariaDB на сервер только для чтения. Вы можете реплицировать данные с исходного сервера на несколько реплик (до пяти). Реплики обновляются асинхронно с помощью технологии репликации на основе расположения файлов двоичного журнала MariaDB Engine (бинлог) с глобальным ИДЕНТИФИКАТОРом транзакции (ГТИД). Дополнительные сведения о репликации binlog см. в [этой статье](https://mariadb.com/kb/en/library/replication-overview/).

Реплики — это новые серверы, управление которыми осуществляется аналогично обычным серверам базы данных Azure для MariaDB. За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о репликации ГТИД см. в [документации по репликации MariaDB](https://mariadb.com/kb/en/library/gtid/).

> [!NOTE]
> Обмен данными без смещения
>
> Корпорация Майкрософт поддерживает различные и включенные среды. Эта статья содержит ссылки на слово _Slave_. В соответствии с [руководством по стилю Майкрософт для обмена данными без](https://github.com/MicrosoftDocs/microsoft-style-guide/blob/master/styleguide/bias-free-communication.md) пересчета этот термин распознается как исключение. Это слово используется в этой статье для обеспечения согласованности, так как в настоящее время это слово, которое отображается в программном обеспечении. При обновлении программного обеспечения для удаления слова эта статья будет обновлена для выравнивания.
>

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения

Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения можно изолировать в реплики, направив рабочие нагрузки записи на главный сервер.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снимают с главного сервера нагрузку, связанную с записью. Этот компонент не предназначен для рабочих нагрузок с интенсивной записью.

Функция чтения реплики использует асинхронную репликацию. Этот компонент также не предназначен для сценариев синхронной репликации. Между источником и репликой возникает измеряемая задержка. Данные на реплике и на главном узле согласованы в конечном счете. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

## <a name="cross-region-replication"></a>Репликация между регионами
Вы можете создать реплику чтения в другом регионе на исходном сервере. Репликация между регионами полезна для таких сценариев, как планирование аварийного восстановления или перенос данных ближе к пользователям.

Исходный сервер может находиться в любом [регионе базы данных Azure для MariaDB](https://azure.microsoft.com/global-infrastructure/services/?products=mariadb).  Исходный сервер может иметь реплику в связанном регионе или в регионах универсальной реплики. На рисунке ниже показано, какие регионы реплик доступны в зависимости от исходного региона.

[ ![Регионы для реплики чтения](media/concepts-read-replica/read-replica-regions.png)](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>Универсальные регионы реплики
Реплику чтения можно создать в любом из следующих регионов, независимо от расположения исходного сервера. Поддерживаются следующие универсальные регионы реплики:

Восточная Австралия, Юго-Восточная Австралия, Центральная часть США, Восточная Азия, Восточная часть США, Восточная часть США 2, Восточная Япония, Западная Япония, Центральная Корея, Юго-Запад, северо-центральная часть США, Северная Европа, Юго-Центральная часть США, Юго-Восточная Азия, южная часть Соединенного Королевства, западная часть Соединенного Королевства, Западная Европа, Западная часть США, Западная часть США 2, Западная Центральная часть США.

### <a name="paired-regions"></a>Пары регионов
В дополнение к регионам универсальной реплики можно создать реплику чтения в парном регионе Azure исходного сервера. Если вы не знаете, какой регион является парным, изучите [эту статью](../best-practices-availability-paired-regions.md).

Если вы настраиваете репликацию между регионами в рамках планирования аварийного восстановления, мы рекомендуем создавать реплику именно в парном регионе, а не в одном из других. Для парных регионов не допускаются одновременные обновления, отслеживаются приоритеты по физической изоляции и месту расположения данных.  

Но есть и некоторые ограничения: 

* Доступность по регионам. база данных Azure для MariaDB доступна в центральном центре Франции, Северной и Германии. Но недоступны регионы, которые являются для них парными.
    
* Однонаправленные пары. Некоторые регионы Azure считаются парными только в одном направлении. К ним относятся: "Западная Индия", "Южная Бразилия" и US Gov (Вирджиния). 
   Это означает, что исходный сервер в Западной Индии может создать реплику в Южной Индии. Однако исходный сервер в Южной Индии не может создать реплику в Западной Индии. Это связано с тем, что для региона "Западная Индия" дополнительным регионом является "Южная Индия", но для региона "Южная Индия" дополнительный регион отличается от региона "Западная Индия".

## <a name="create-a-replica"></a>Создание реплики

> [!IMPORTANT]
> Функция чтения реплики доступна только для серверов базы данных Azure для MariaDB в общего назначения или ценовой категории, оптимизированные для памяти. Убедитесь, что исходный сервер находится в одной из этих ценовых категорий.

Если на исходном сервере нет серверов реплики, источник сначала перезапускается для подготовки к репликации.

При запуске рабочего процесса создания реплики будет создан пустой сервер базы данных Azure для MariaDB. Новый сервер заполняется данными, которые были на исходном сервере. Время создания зависит от объема данных в источнике и времени, прошедших с момента создания последней еженедельной полной архивации. Время может варьироваться от нескольких минут до нескольких часов.

> [!NOTE]
> Если вы еще не настроили оповещения хранилища на серверах, рекомендуем сделать это сейчас. Это позволит получать сведения о приближении к заполнению хранилища на сервере, которое влияет на эффективность репликации.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

## <a name="connect-to-a-replica"></a>Подключение к реплике

При создании реплика наследует правила брандмауэра исходного сервера. Затем эти правила независимы от исходного сервера.

Реплика наследует учетную запись администратора от исходного сервера. Все учетные записи пользователей на исходном сервере реплицируются на реплики чтения. Подключиться к реплике чтения можно только с помощью учетных записей пользователей, доступных на исходном сервере.

Вы можете подключиться к реплике, используя ее имя узла и допустимую учетную запись пользователя, как и на обычной базе данных Azure для сервера MariaDB. Например, для сервера с именем **myreplica** и именем пользователя с правами администратора **myadmin** подключение будет выполняться с помощью CLI mysql:

```bash
mysql -h myreplica.mariadb.database.azure.com -u myadmin@myreplica -p
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации

База данных Azure для MariaDB обеспечивает **задержку репликации в секундах** в Azure Monitor. Эта метрика доступна только для реплик.

Эта метрика вычисляется с помощью `seconds_behind_master` метрики, доступной в `SHOW SLAVE STATUS` команде MariaDB.

Настройте оповещение, чтобы сообщить вам, когда задержка репликации достигнет значения, неприемлемого для вашей рабочей нагрузки.

## <a name="stop-replication"></a>Остановка репликации

Можно отключить репликацию между источником и репликой. После остановки репликации между исходным сервером и репликой чтения реплика становится автономным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Изолированный сервер не перехватывается с исходным сервером.

Если вы решили отключить репликацию в реплике, она теряет все ссылки на предыдущие исходные и другие реплики. Автоматическая отработка отказа между источником и его репликой отсутствует.

> [!IMPORTANT]
> Это сервер нельзя снова преобразовать в реплику.
> Прежде, чем останавливать репликацию в реплике чтения убедитесь, что реплика содержит все необходимые данные.

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).

## <a name="failover"></a>Отработка отказа

Автоматическая отработка отказа между серверами источника и реплики отсутствует. 

Так как репликация является асинхронной, между источником и репликой возникает задержка. На величину запаздывания может влиять ряд факторов, таких как интенсивность выполнения рабочей нагрузки на исходном сервере и задержка между центрами обработки данных. В большинстве случаев задержка реплики составляет от нескольких секунд до пары минут. Вы можете отвести фактическую задержку репликации с помощью *задержки реплики*метрики, доступной для каждой реплики. Эта метрика показывает время, прошедшее с момента последнего воспроизведения транзакции. Рекомендуется определить среднюю задержку, просматривая запаздывание реплики в течение определенного периода времени. Вы можете настроить оповещение о задержке реплики, чтобы, если она выходит за пределы ожидаемого диапазона, можно предпринять действия.

> [!Tip]
> Если выполняется отработка отказа в реплике, задержка во время десвязи реплики с источником будет указывать на количество потерянных данных.

После того как вы решили выполнить отработку отказа в реплику, 

1. Останавливает репликацию в реплику<br/>
   Этот шаг необходим для того, чтобы сервер реплики мог принимать операции записи. В рамках этого процесса сервер реплики будет десвязываться с главным сервером. После инициации процесса репликации серверный процесс обычно занимает около 2 минут. Сведения о влиянии этого действия см. в разделе " [Завершение репликации](#stop-replication) " этой статьи.
    
2. Наведите приложение на реплику (бывшая)<br/>
   Каждый сервер имеет уникальную строку подключения. Обновите приложение так, чтобы оно указывало на (бывшая) реплику, а не на главную.
    
После успешной обработки операций чтения и записи приложение отработки отказа завершено. Время простоя, которое будет зависеть от работы приложения, зависит от того, обнаруживается ошибка и выполняются шаги 1 и 2, описанные выше.

## <a name="considerations-and-limitations"></a>Рекомендации и ограничения

### <a name="pricing-tiers"></a>Ценовые категории

Реплики чтения сейчас доступны только в ценовых категориях "Общее назначение" и "Оптимизировано для памяти".

> [!NOTE]
> Стоимость работы сервера реплики зависит от региона, в котором работает сервер реплики.

### <a name="source-server-restart"></a>Исходный сервер перезапуска

При создании реплики для источника, не имеющего существующих реплик, источник сначала перезапускается для подготовки к репликации. Это необходимо учесть, то есть выполнять такие операции в период низкой нагрузки.

### <a name="new-replicas"></a>Новые реплики

Реплика чтения создается как новый сервер базы данных Azure для MariaDB. Существующий сервер нельзя снова преобразовать в реплику. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики

Реплика создается с той же конфигурацией сервера, что и у главного сервера. После создания реплики некоторые параметры могут быть изменены независимо от исходного сервера: поколение вычислений, виртуальных ядер, хранилище, срок хранения резервных копий и версия подсистемы MariaDB. Изменить также можно ценовую категорию (за исключением уровня "Базовый").

> [!IMPORTANT]
> Прежде чем изменить параметры конфигурации на исходном сервере, установите на каждой реплике такие же или более высокие значения. Это позволит реплике справляться с нагрузкой, соответствующей новым параметрам главного сервера.

Правила брандмауэра и параметры параметров наследуются от исходного сервера реплике при создании реплики. После этого правила реплики будут независимыми.

### <a name="stopped-replicas"></a>Остановленные реплики

Если остановить репликацию между исходным сервером и репликой чтения, то остановленная реплика станет автономным сервером, принимающим операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-source-and-standalone-servers"></a>Удаленные исходные и автономные серверы

При удалении исходного сервера репликация будет остановлена для всех реплик чтения. Реплики чтения автоматически становятся автономными серверами и могут выполнять операции чтения и записи. Сам исходный сервер удаляется.

### <a name="user-accounts"></a>Учетные записи пользователей

Пользователи на исходном сервере реплицируются на реплики чтения. Подключиться к реплике чтения можно только с помощью учетных записей пользователей, доступных на исходном сервере.

### <a name="server-parameters"></a>Параметры сервера

Чтобы предотвратить синхронизацию данных и избежать их возможной потери, при использовании реплики чтения некоторые параметры сервера блокируются.

Следующие параметры сервера заблокированы на серверах источника и реплики:
- [`innodb_file_per_table`](https://mariadb.com/kb/en/library/innodb-system-variables/#innodb_file_per_table) 
- [`log_bin_trust_function_creators`](https://mariadb.com/kb/en/library/replication-and-binary-log-system-variables/#log_bin_trust_function_creators)

Параметр [`event_scheduler`](https://mariadb.com/kb/en/library/server-system-variables/#event_scheduler) заблокирован на серверах реплик.

Чтобы обновить один из указанных выше параметров на исходном сервере, удалите серверы реплики, обновите значение параметра в базе данных master и повторно создайте реплики.

### <a name="other"></a>Другое

- Создание реплики реплики не поддерживается.
- Таблицы в памяти могут привести к тому, что реплики не будут синхронизированы. Это ограничение технологии репликации MariaDB.
- Убедитесь, что таблицы исходного сервера имеют первичные ключи. Отсутствие первичных ключей может привести к задержке репликации между источником и репликами.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как [создавать реплики чтения и управлять ими с помощью портала Azure](howto-read-replicas-portal.md).
- Узнайте, как [создавать реплики чтения и управлять ими с помощью Azure CLI и REST API](howto-read-replicas-cli.md).
