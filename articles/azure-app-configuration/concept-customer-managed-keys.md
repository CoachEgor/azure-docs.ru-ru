---
title: Используйте управляемые клиентом ключи для шифрования данных конфигурации
description: Шифрование данных конфигурации с помощью ключей, управляемых клиентом
author: lisaguthrie
ms.author: lcozzens
ms.date: 02/18/2020
ms.topic: conceptual
ms.service: azure-app-configuration
ms.openlocfilehash: ace34cf4a72b871ba6646b279007b8ce21c03e9b
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81457439"
---
# <a name="use-customer-managed-keys-to-encrypt-your-app-configuration-data"></a>Используйте управляемые клиентом ключи для шифрования данных конфигурации приложения
Конфигурация приложений Azure [шифрует конфиденциальную информацию в состоянии покоя.](../security/fundamentals/encryption-atrest.md) Использование ключей, управляемых клиентами, обеспечивает повышенную защиту данных, позволяя управлять ключами шифрования.  При использовании управляемого шифрования ключей вся конфиденциальная информация в конфигурации приложения шифруется с помощью предоставленного пользователем ключа Azure Key Vault.  Это обеспечивает возможность поворота ключа шифрования по требованию.  Он также предоставляет возможность отозвать доступ конфигурации приложений Azure к конфиденциальной информации, отменив доступ к ключу экземпляра конфигурации приложений.

## <a name="overview"></a>Обзор 
Конфигурация приложений Azure шифрует конфиденциальную информацию в состоянии покоя с помощью 256-разрядного ключа шифрования AES, предоставленного корпорацией Майкрософт. Каждый экземпляр App Configuration имеет свой собственный ключ шифрования, управляемый службой и используемый для шифрования конфиденциальной информации. Конфиденциальная информация включает значения, найденные в парах значений ключей.  При включении ключевой возможности, управляемой клиентом, конфигурация приложения использует управляемый иственный, назначенный экземпляру конфигурации приложения, для проверки подлинности с помощью Active Directory Azure. Затем управляемая идентификация вызывает Хранилище ключей Azure и обертывает ключ шифрования экземпляра конфигурации App. Завернутый ключ шифрования затем хранится, а развернутый ключ шифрования кэшируется в конфигурации App в течение одного часа. Конфигурация приложений обновляет развернутую версию ключа шифрования экземпляра App Configuration. Это обеспечивает доступность в нормальных условиях эксплуатации. 

>[!IMPORTANT]
> Если личность, назначенная экземпляру Конфигурации Приложения, больше не уполномочена разворачивать ключ шифрования экземпляра или если управляемый ключ удален навсегда, то расшифровка конфиденциальной информации, хранящейся в экземпляре конфигурации приложения, больше невозможна. Использование функции [мягкого удаления](../key-vault/general/overview-soft-delete.md) Azure Key Vault снижает вероятность случайного удаления ключа шифрования.

Когда пользователи позволяют клиенту управлять ключевыми возможностями на экземпляре конфигурации приложений Azure, они контролируют возможность службы получить доступ к своей конфиденциальной информации. Управляемый ключ служит корневым ключом шифрования. Пользователь может отозвать доступ к управляемому ключу конфигурации приложения, изменив политику доступа к хранилищу ключей. Когда этот доступ будет отменен, конфигурация приложения потеряет возможность расшифровки пользовательских данных в течение одного часа. На этом этапе экземпляр конфигурации приложений запрещает все попытки доступа. Эта ситуация восстанавливается, предоставляя службе доступ к управляемому ключу еще раз.  В течение одного часа Приложение Configuration сможет расшифровывать данные пользователей и работать в нормальных условиях.

>[!NOTE]
>Все данные конфигурации приложений Azure хранятся в изолированном резервном копировании в течение 24 часов. Это включает в себя незавернутый ключ шифрования. Эти данные не доступны сразу для службы или службы команды. В случае аварийного восстановления конфигурация приложений Azure повторно отменяется из управляемых ключевых данных.

## <a name="requirements"></a>Требования
Для успешного включения ключевой возможности для конфигурации приложений Azure требуется следующие компоненты:
- Стандартный экземпляр конфигурации приложений Azure
- Azure Key Vault с функциями мягкого удаления и защиты от чистки
- Ключ RSA или RSA-HSM в ключевом Хранилище
    - Ключ не должен быть истек, он должен быть включен, и он должен иметь как обернуть и развернуть возможности включены

После настройки этих ресурсов остаются два шага, позволяющих конфигурации приложений Azure использовать ключ Убежища:
1. Назначить управляемое удостоверение экземпляру конфигурации приложений Azure
2. Предоставление идентификационных данных `GET` `WRAP`и `UNWRAP` разрешений в политике доступа к ключу Key Vault.

## <a name="enable-customer-managed-key-encryption-for-your-azure-app-configuration-instance"></a>Включить шифрование ключей с управлением клиентом для экземпляра конфигурации приложений Azure
Для начала потребуется правильно настроенный экземпляр конфигурации приложений Azure. Если у вас еще нет экземпляра конфигурации приложений, следуйте одному из этих quickstarts, чтобы настроить его:
- [Создайте приложение ASP.NET core с конфигурацией приложений Azure](quickstart-aspnet-core-app.md)
- [Создание приложения .NET Core с конфигурацией приложений Azure](quickstart-dotnet-core-app.md)
- [Создание приложения на .NET Framework с помощью службы конфигурации приложений Azure](quickstart-dotnet-app.md)
- [Создание приложения Java Spring с помощью службы "Конфигурация приложений Azure"](quickstart-java-spring-app.md)

>[!TIP]
> Azure Cloud Shell — это бесплатная интерактивная оболочка, с помощью которой можно выполнять инструкции командной строки, описанные в этой статье.  Она содержит предварительно установленные общие инструменты Azure, включая пакет SDK для .NET Core. Если вы вошли в подписку Azure, запустите [Azure Cloud Shell](https://shell.azure.com) на сайте shell.azure.com.  Дополнительные сведения об Azure Cloud Shell см. в [нашей документации](../cloud-shell/overview.md)

### <a name="create-and-configure-an-azure-key-vault"></a>Создание и настройка убежища ключей Azure
1. Создайте Хранилище ключей Azure с помощью Azure CLI.  Обратите внимание, что оба `vault-name` и `resource-group-name` являются пользователями и должны быть уникальными.  Мы `contoso-vault` используем `contoso-resource-group` и в этих примерах.

    ```azurecli
    az keyvault create --name contoso-vault --resource-group contoso-resource-group
    ```
    
1. Включите мягкое удаление и защиту от очистки для Убежища ключей. Замените имена Key Vault`contoso-vault`() и`contoso-resource-group`Группы ресурсов (), созданных в шаге 1.

    ```azurecli
    az keyvault update --name contoso-vault --resource-group contoso-resource-group --enable-purge-protection --enable-soft-delete
    ```
    
1. Создайте ключ Убежища. Предоставьте `key-name` уникальный для этого ключа и замените`contoso-vault`имена Key Vault (), созданные в шаге 1. Укажите, `RSA` предпочитаете ли вы или `RSA-HSM` шифрование.

    ```azurecli
    az keyvault key create --name key-name --kty {RSA or RSA-HSM} --vault-name contoso-vault
    ```
    
    Вывод из этой команды показывает идентификатор ключа ("ребенок") для генерируемого ключа.  Сделайте примечание идентификатора ключа для использования позже в этом упражнении.  Идентификатор ключа `https://{my key vault}.vault.azure.net/keys/{key-name}/{Key version}`имеет форму: .  Идентификатор ключа имеет три важных компонента:
    1. Key Vault URI: 'https:/(мой ключ хранилище).vault.azure.net
    1. Ключевое имя Key Vault: «Ключевое имя»
    1. Ключевая версия Key Vault: «Ключевая версия»

1. Создайте систему, назначенную управляемой идентификатором, используя Azure CLI, заменив имя экземпляра конфигурации приложений и группы ресурсов, используемой в предыдущих шагах. Управляемая идентификация будет использоваться для доступа к управляемому ключу. Мы `contoso-app-config` используем для иллюстрации названия экземпляра конфигурации приложений:
    
    ```azurecli
    az appconfig identity assign --na1. me contoso-app-config --group contoso-resource-group --identities [system]
    ```
    
    Выход этой команды включает основной идентификатор ("principalId") и идентификатор клиента ("tenandId") назначенного удостоверения системы.  Это будет использовано для предоставления идентификационным доступа к управляемому ключу.

    ```json
    {
    "principalId": {Principal Id},
    "tenantId": {Tenant Id},
    "type": "SystemAssigned",
    "userAssignedIdentities": null
    }
    ```

1. Управляемый идентификатор экземпляра конфигурации приложений Azure необходим доступ к ключу для выполнения проверки ключа, шифрования и расшифровки. Конкретный набор действий, к которым `GET` `WRAP`он `UNWRAP` нуждается в доступе включает в себя: , и для ключей.  Предоставление доступа требует основного идентификатора управляемой идентификации экземпляра конфигурации App. Это значение было получено на предыдущем этапе. Показано ниже, `contoso-principalId`как . Разрешение на получение управляемого ключа с помощью командной строки:

    ```azurecli
    az keyvault set-policy -n contoso-vault --object-id contoso-principalId --key-permissions get wrapKey unwrapKey
    ```

1. После того, как экземпляр Azure App Configuration получит доступ к управляемому ключу, мы сможем включить ключевую возможность в службе, управляемую клиентом, с помощью Azure CLI. Напомним следующие свойства, записанные `key name` `key vault URI`во время шагов создания ключей: .

    ```azurecli
    az appconfig update -g contoso-resource-group -n contoso-app-config --encryption-key-name key-name --encryption-key-version key-version --encryption-key-vault key-vault-Uri
    ```

Ваш экземпляр конфигурации приложений Azure теперь настроен для использования ключа, управляемого клиентом, хранящегося в Хранилище ключей Azure.

## <a name="next-steps"></a>Next Steps
В этой статье вы настроили экземпляр конфигурации приложения Azure для использования ключа, управляемого клиентом, для шифрования.  Узнайте, как [интегрировать службу с управляемыми идентификаторами Azure.](howto-integrate-azure-managed-service-identity.md)