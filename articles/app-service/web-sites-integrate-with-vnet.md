---
title: Интеграция приложения с виртуальной сетью Azure (Служба приложений Azure)
description: В этой статье показано, как подключить приложение к новой или существующей виртуальной сети Azure.
services: app-service
documentationcenter: ''
author: ccompy
manager: stefsch
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/25/2019
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 8321a9dd779406b2d1de44bd4c9313e4d855548d
ms.sourcegitcommit: d060947aae93728169b035fd54beef044dbe9480
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/02/2019
ms.locfileid: "68740899"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описывается функция интеграции виртуальной сети в службе приложений Azure и ее настройка с помощью приложений в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714). [Виртуальные сети Azure][VNETOverview] (Виртуальных сетей) позволяет разместить многие ресурсы Azure в сети, не поддерживающей маршрутизацию в Интернете.  

Служба приложений Azure имеет два варианта. 

1. Мультитенантные системы с поддержкой всей линейки тарифных планов, кроме плана "Изолированный"
2. Среда службы приложений (ASE), который развертывается в виртуальной сети и поддерживает приложения с планом расчета цен

В этом документе рассматриваются две функции интеграции с виртуальной сетью, предназначенные для использования в многоклиентской службе приложений. Если приложение находится в [Среда службы приложений][ASEintro], оно уже находится в виртуальной сети и не требует использования функции интеграции с виртуальной сетью для доступа к ресурсам в той же виртуальной сети. Дополнительные сведения о всех сетевых компонентах службы приложений см. в статье [сетевые функции службы приложений](networking-features.md) .

Существует две формы функции интеграции с виртуальной сетью.

1. Одна из версий обеспечивает интеграцию с виртуальных сетей в одном регионе. Эта форма компонента требует наличия подсети в виртуальной сети в том же регионе. Эта функция по-прежнему доступна в предварительной версии, но поддерживается для рабочих нагрузок приложений Windows с некоторыми предупреждениями, указанными ниже.
2. Другая версия обеспечивает интеграцию с виртуальных сетей в других регионах или с классической виртуальных сетей. Эта версия компонента требует развертывания шлюза виртуальной сети в виртуальной сети. Это функция на основе VPN типа "точка — сеть", которая поддерживается только в приложениях Windows.

Приложение может одновременно использовать только одну форму функции интеграции с виртуальной сетью. Далее следует вопрос, какой компонент следует использовать. Для многих целей можно использовать один из них. Очевидные отличия:

| Проблема  | Решение | 
|----------|----------|
| Хотите обратиться к адресу RFC 1918 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) в том же регионе | Интеграция региональной виртуальной сети |
| Требуется доступ к ресурсам в классической виртуальной сети или виртуальной сети в другом регионе | Интеграция виртуальной сети, требуемой шлюзом |
| Требуется доступ к конечным точкам RFC 1918 в ExpressRoute | Интеграция региональной виртуальной сети |
| Требуется доступ к ресурсам в конечных точках службы | Интеграция региональной виртуальной сети |

Ни одна из этих функций не позволяет обращаться к адресам, отличным от RFC 1918, в ExpressRoute. Для этого необходимо использовать ASE.

При использовании региональной интеграции виртуальной сети виртуальная сеть не подключается к локальным или настраивается конечные точки служб. Это отдельная конфигурация сети. Интеграция региональной виртуальной сети позволяет приложению выполнять вызовы через эти типы подключений.

Независимо от используемой версии, интеграция виртуальной сети позволяет веб-приложению получать доступ к ресурсам в вашей виртуальном сетевом режиме, но не предоставляет в виртуальной сети входящий частный доступ к веб-приложению. Доступ к частным сайтам подразумевает доступность приложения только из частной сети, например из виртуальной сети Azure. Интеграция виртуальной сети предназначена только для исходящих вызовов из приложения в виртуальную сеть. 

Интеграция с виртуальной сетью связана со следующими особенностями:

* требуется тарифный план "Стандартный", "Премиум" или "Премиум V2"; 
* поддерживает TCP и UDP;
* работает с приложениями службы приложений и приложениями функций

Функции, не поддерживаемые при интеграции с виртуальной сетью:

* подключение диска;
* интеграция с AD; 
* NetBios;

## <a name="regional-vnet-integration"></a>Интеграция региональной виртуальной сети 

При использовании интеграции с виртуальной сетью с виртуальных сетей в том же регионе, что и ваше приложение, для него необходимо использовать делегированную подсеть с как минимум 32 адресами. Подсеть не может использоваться ни для чего еще. Исходящие вызовы, выполненные из вашего приложения, будут выполняться из адресов в делегированной подсети. При использовании этой версии интеграции с виртуальной сетью вызовы выполняются из адресов в виртуальной сети. Использование адресов в виртуальной сети позволяет приложению выполнять следующие задачи:

* Вызов служб, защищенных конечной точкой службы
* Доступ к ресурсам через подключения ExpressRoute
* Доступ к ресурсам в виртуальной сети, к которой вы подключены
* Доступ к ресурсам через одноранговые соединения, включая подключения ExpressRoute

Эта функция доступна в предварительной версии, но она поддерживается для рабочих нагрузок приложений Windows со следующими ограничениями:

* Доступ к адресам можно получить только в диапазоне RFC 1918. Это адреса в блоках адресов 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16.
* Не удается получить доступ к ресурсам по глобальным одноранговым соединениям
* Невозможно задать маршруты для трафика, поступающего из приложения в виртуальную сеть
* Эта функция доступна только в новых единицах масштабирования службы приложений, поддерживающих планы службы приложений категории премиум v2.
* Подсеть интеграции может использоваться только одним планом службы приложений.
* Эта функция не может использоваться приложениями изолированного плана, которые находятся в Среда службы приложений
* Для этой функции требуется неиспользуемая подсеть, которая имеет значение/27 с 32 или больше в диспетчер ресурсов виртуальной сети
* Приложения и виртуальная сеть должны находиться в одном регионе.
* Удалить виртуальную сеть с интегрированным приложением невозможно. Сначала необходимо удалить интеграцию. 
* Можно использовать только одну региональную интеграцию с виртуальной сетью на один план службы приложений. Несколько приложений в одном плане службы приложений могут использовать одну и ту же виртуальную сеть. 

Один адрес используется для каждого экземпляра плана Службы приложений. При масштабировании приложения до 5 экземпляров используется 5 адресов. Так как размер подсети нельзя изменить после назначения, необходимо использовать подсеть, которая достаточно велика для размещения любого масштаба, к которому может получить доступ приложение. Рекомендуемый размер — от A/27 до 32 адресов, так как в нем будет содержаться план службы приложений уровня "Премиум", масштабируемый до 20 экземпляров.

Если вы хотите, чтобы ваши приложения в другом плане службы приложений достигли виртуальной сети, к которой уже подключены приложения в другом плане службы приложений, необходимо выбрать подсеть, отличную от используемой уже существующей интеграцией виртуальной сети.  

Эта функция доступна также в предварительной версии для Linux. Чтобы использовать функцию интеграции с виртуальной сетью в диспетчер ресурсов виртуальной сети в том же регионе:

1. Откройте пользовательский интерфейс работы с сетями на портале. Если приложение может использовать новую функцию, вы увидите вариант добавления виртуальной сети (Предварительная версия).  

   ![Выбор интеграции с виртуальной сетью][6]

1. Нажмите **Добавить виртуальную сеть (предварительная версия)** .  

1. Выберите нужную виртуальную сеть Resource Manager, а затем либо выберите пустую имеющуюся подсеть, либо создайте новую. Интеграция занимает меньше минуты. Во время интеграции приложение перезапускается.  По завершении интеграции вы увидите сведения об интегрированной виртуальной сети и баннер в верхней части страницы, указывающий, что это предварительная версия функции.

   ![Выбор виртуальной сети и подсети][7]

После интеграции приложения с виртуальной сетью будет использоваться тот же DNS-сервер, с которым настроена виртуальная сеть. 

Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. Веб-приложение будет перезапущено. 


#### <a name="web-app-for-containers"></a>Веб-приложение для контейнеров

Если вы используете службу приложений на платформе Linux со встроенными образами, функция интеграции с региональной сетью будет работать без дополнительных изменений. Если вы используете Веб-приложение для контейнеров, необходимо изменить образ DOCKER, чтобы использовать интеграцию с виртуальной сетью. В образе DOCKER используйте переменную среды порта в качестве порта прослушивания основного веб-сервера вместо использования жестко зафиксированного номера порта. Переменная среды порта автоматически задается платформой службы приложений в момент запуска контейнера.

### <a name="service-endpoints"></a>Конечные точки службы

Новая функция интеграции с виртуальной сетью позволяет использовать конечные точки служб.  Чтобы использовать конечные точки служб с приложением, воспользуйтесь новой функцией интеграции с виртуальной сетью, чтобы подключиться к выбранной виртуальной сети в подсети, которая использовалась для интеграции. 


### <a name="how-vnet-integration-works"></a>Как работает интеграция с виртуальной сетью

Приложения в службе приложений размещаются на рабочих ролях. Базовые и более высокие тарифные планы являются выделенными планами размещения, где нет других рабочих нагрузок клиентов, выполняющихся в одних и тех же работниках. Интеграция виртуальной сети осуществляется путем подключения виртуальных интерфейсов с адресами в делегированной подсети. Так как адрес отсчета находится в виртуальной сети, он имеет доступ к большинству вещей в виртуальной сети или через нее так же, как и виртуальная машина в виртуальной сети. Реализация сети отличается от работы виртуальной машины в виртуальной сети, поэтому некоторые сетевые функции пока не доступны при использовании этой функции.

![Интеграция виртуальной сети](media/web-sites-integrate-with-vnet/vnet-integration.png)

Если интеграция с виртуальной сетью включена, приложение по-прежнему будет выполнять исходящие вызовы к Интернету через те же каналы, что и обычные. Исходящие адреса, перечисленные на портале свойств приложения, по-прежнему являются адресами, используемыми приложением. Какие изменения в приложении являются, вызовы к защищенным конечным точкам служб или адреса RFC 1918 попадают в виртуальную сеть. 

Эта функция поддерживает только один виртуальный интерфейс для каждого рабочего процесса.  Один виртуальный интерфейс на каждый рабочий процесс означает, что для каждого плана службы приложений необходимо интегрировать одну региональную виртуальную сеть. Все приложения в одном плане службы приложений могут использовать одну и ту же интеграцию виртуальной сети, но если для подключения к дополнительной виртуальной сети требуется приложение, необходимо создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому у клиентов есть прямой доступ.

Из-за особенностей работы этой технологии трафик, используемый с интеграцией виртуальной сети, не отображается в журналах потоков или наблюдателя NSG.  

## <a name="gateway-required-vnet-integration"></a>Интеграция виртуальной сети, требуемой шлюзом 

Компонент "Интеграция виртуальной сети, требуемый шлюзом":

* Можно использовать для подключения к виртуальных сетей в любом регионе, чтобы они диспетчер ресурсов или классической виртуальных сетей
* Позволяет приложению подключаться только к одной виртуальной сети за раз
* Позволяет интегрировать до пяти виртуальных сетей в плане службы приложений. 
* Позволяет использовать одну и ту же виртуальную сеть в нескольких приложениях в плане службы приложений, не влияя на общее число, которое может использоваться планом службы приложений.  Если у вас есть 6 приложений, использующих одну и ту же виртуальную сеть в одном плане службы приложений, это считается, что используется одна виртуальная сеть. 
* Требуется шлюз виртуальной сети, настроенный с VPN-подключением типа "точка — сеть"
* Поддерживает соглашение об уровне обслуживания 99,9% из-за соглашения об уровне обслуживания на шлюзе

Эта функция не поддерживает:
* Использование с приложениями Linux
* доступ к ресурсам через ExpressRoute; 
* доступ к ресурсам через конечные точки служб. 

### <a name="getting-started"></a>Приступая к работе

Перед подключением веб-приложения к виртуальной сети обратите внимание на следующие моменты.

* Перед подключением к приложению в целевой виртуальной сети должна быть включена сеть VPN типа "точка — сеть" со шлюзом на основе маршрутов. 
* Виртуальная сеть должна относиться к той же подписке, что и план службы приложений (ASP).
* Приложения, которые интегрируются с виртуальной сетью, используют DNS-сервер, указанный для этой виртуальной сети.

### <a name="set-up-a-gateway-in-your-vnet"></a>Настройка шлюза в виртуальной сети ###

Если в шлюзе уже настроены адреса для подключения "точка — сеть", то настройку интеграции приложения с виртуальной сетью можно пропустить.  
Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. Укажите [адреса узлов в качестве точки][setp2saddresses]. Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Адресное пространство должно находиться в блоках адресов RFC 1918:10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

Если вы просто создаете шлюз для использования с интеграцией виртуальной сети службы приложений, вам не нужно отправлять сертификат. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно. 

### <a name="configure-vnet-integration-with-your-app"></a>Настройка интеграции приложения с виртуальной сетью 

Включение интеграции приложения с виртуальной сетью: 

1. Перейдите к своему приложению на портале Azure, откройте параметры приложения и выберите пункты "Сеть" > "Интеграция виртуальной сети". Ваш ASP должен иметь номер SKU "Стандартный" или лучше использовать либо функцию интеграции с виртуальной сетью. 
 ![Пользовательский интерфейс интеграции с виртуальной сетью][1]

1. Выберите **Добавить виртуальную сеть**. 
 ![Добавление интеграции с виртуальной сетью][2]

1. Выберите виртуальную сеть. 
  ![Выбор виртуальной сети][8]
  
После последнего действия приложение будет перезапущено.  

### <a name="how-the-gateway-required-vnet-integration-feature-works"></a>Как работает функция интеграции виртуальной сети, требуемая шлюзом

Функция интеграции виртуальной сети, требуемой для шлюза, основана на технологии VPN типа "точка — сеть". Технология "точка — сеть" разрешает доступ к сети только той виртуальной машине, в которой размещается приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. 

![Как работает интеграция с виртуальной сетью][3]

## <a name="managing-vnet-integration"></a>Управление интеграцией виртуальной сети
Возможность подключаться к виртуальной сети и отключаться от нее реализуется на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. На портале интеграции с виртуальной сетью > > приложений можно получить сведения о виртуальной сети. Аналогичные сведения можно просмотреть на уровне ASP на портале ASP > Networking > Integration Services Portal, в том числе о том, какие приложения в этом плане службы приложений используют данную интеграцию.

 ![Сведения о виртуальной сети][4]

Сведения, доступные в пользовательском интерфейсе интеграции с виртуальной сетью, одинаковы для приложений и порталов ASP.

* Имя виртуальной сети. Ссылки на пользовательский интерфейс виртуальной сети
* Расположение. Указывает расположение виртуальной сети. Интеграция с виртуальной сетью в другом расположении может вызывать проблемы с задержкой для приложения. 
* Состояние сертификата. Указывает, синхронизированы ли сертификаты между планом службы приложений и виртуальной сетью.
* Состояние шлюза. Если вы хотите использовать интеграцию виртуальной сети, требуемую для шлюза, вы увидите состояние шлюза.
* Адресное пространство виртуальной сети. Указывает IP-адреса, которые используются в виртуальной сети. 
* Адресное пространство "точка — сеть". Указывает IP-адреса, которые используются при подключении типа "точка — сеть" к виртуальной сети. При выполнении вызовов к виртуальной сети при использовании компонента, требуемого шлюзом, ваше приложение с адресом будет одним из этих адресов. 
* Адресное пространство "сеть — сеть". VPN типа "сеть — сеть" можно использовать для подключения виртуальной сети к ресурсам в локальной сети или к другим виртуальным сетям. Здесь показаны диапазоны IP-адресов, определенные этим VPN-подключением.
* DNS-серверы. Указывает DNS-серверы, настроенные для виртуальной сети.
* IP-адреса, направляемые в виртуальную сеть. Блоки адресов, используемые для направления трафика в виртуальную сеть 

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение будет перезапущено. Виртуальная сеть не меняется при отключении. Подсеть или шлюз не удалены. Если вы хотите удалить виртуальную сеть, необходимо сначала отключить приложение от виртуальной сети и удалить в нем ресурсы, такие как шлюзы. 

Чтобы открыть пользовательский интерфейс интеграции ASP с виртуальной сетью, откройте пользовательский интерфейс ASP и выберите **Сеть**.  В разделе "Интеграция с виртуальной сетью" нажмите **Щелкните здесь для настройки**, чтобы открыть пользовательский интерфейс состояния функций сети.

![Сведения об интеграции ASP с виртуальной сетью][5]

В пользовательском интерфейсе интеграции ASP с виртуальной сетью отображаются все виртуальные сети, используемые приложениями в ASP. Чтобы просмотреть сведения о той или иной виртуальной сети, щелкните нужную сеть. Здесь можно выполнить два действия.

* **Синхронизировать сеть.** Операция синхронизации в сети предназначена только для компонента интеграции с виртуальной сетью, зависящей от шлюза. Выполнение операции синхронизации обеспечивает синхронизацию сертификатов и сведений о сети. Если вы добавите или измените DNS виртуальной сети, то необходимо выполнить операцию **Синхронизировать сеть**. Эта операция перезапустит все приложения, использующие эту виртуальную сеть.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть.

**Маршрутизация.** Маршруты, определенные в виртуальной сети, используемые для направления трафика в виртуальную сеть из вашего приложения. Если вам нужно отправлять дополнительный исходящий трафик в виртуальную сеть, то вы можете добавить здесь соответствующие блоки адресов. Эта возможность работает только с обязательной интеграцией виртуальной сети.

**Сертификаты** Если для шлюза требуется интеграция виртуальной сети, необходим обмен сертификатами для обеспечения безопасности соединения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.
Если сертификаты или сведения о сети изменились, нажмите "Синхронизировать сеть". Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам
Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". При использовании интеграции виртуальной сети, требуемой для шлюза, необходимо обновить локальные Маршруты VPN-шлюза с блоками адресов типа "точка — сеть". При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Вы не можете настроить BGP с VPN-подключением типа "сеть — сеть".

Для компонента интеграции региональной виртуальной сети и локальной сети не требуется дополнительная настройка. Вам нужно просто подключить виртуальную сеть к локальной сети с помощью ExpressRoute или VPN типа "сеть — сеть". 

> [!NOTE]
> Функция интеграции с виртуальной сетью, требуемой для шлюза, не интегрирует приложение с виртуальной сетью, имеющей шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме][VPNERCoex] сосуществования, интеграция виртуальной сети не работает. Если вам требуется доступ к ресурсам через подключение ExpressRoute, можно использовать функцию интеграции с региональными виртуальными сетями или [Среда службы приложений][ASE], которая выполняется в виртуальной сети. 
> 
> 

## <a name="peering"></a>Пиринг
Если вы используете пиринг с региональной интеграцией виртуальной сети, вам не нужно выполнять дополнительную настройку. 

Если вы используете требуемую для шлюза интеграцию виртуальной сети с пирингом, необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите к разделу "План службы приложений" > "Сеть" > "Интеграция виртуальной сети" на портале.  Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены.  


## <a name="pricing-details"></a>Сведения о ценах
Функция интеграции с региональными виртуальными сетями не взимается за пределы цены на услуги по ценовым категориям ASP.

Использование функции шлюза, необходимого для интеграции виртуальной сети, связано с тремя затратами.

* Плата за ценовую категорию ASP. ваши приложения должны быть в плане службы приложений уровня "Стандартный", "Премиум" или "категории премиум v2". Дополнительные сведения о ценах на планы см. на странице [Цены на службу приложений][ASPricing]. 
* Затраты на передачу данных — взимается плата за исходящие данные, даже если виртуальная сеть находится в том же центре обработки данных. Эти тарифы описаны в [Передача данных сведения о ценах][DataPricing]. 
* Расходы на VPN-шлюз. для шлюза виртуальной сети, который требуется для VPN типа "точка — сеть", взимается плата. Подробные сведения см. на странице [цен на VPN-шлюз][VNETPricing] .


## <a name="troubleshooting"></a>Устранение неполадок
Простота настройки этой функции не гарантирует отсутствия проблем при ее использовании. При проблемах с доступом к нужной конечной точке можно воспользоваться некоторыми служебными программами для проверки подключения из консоли приложения. Вы можете использовать две консоли: консоль Kudu и консоль на портале Azure. Чтобы открыть консоль Kudu из приложения, выберите пункты "Сервис" -> "Kudu". Этот же интерфейс доступен по адресу [имя_сайта].scm.azurewebsites.net. В консоли перейдите на вкладку "Отладка". Чтобы воспользоваться консолью на портале Azure, откройте меню «Сервис» -> «Консоль». 

#### <a name="tools"></a>Сервис
Приложения **ping**, **nslookup** и **tracert** нельзя использовать в консоли из-за ограничений безопасности. Чтобы компенсировать это, добавлены два других средства. Для проверки работоспособности DNS мы добавили средство nameresolver.exe. Синтаксис выглядит следующим образом.

    nameresolver.exe hostname [optional: DNS Server]

Для проверки имен узлов, которые использует ваше приложение, можно использовать команду **nameresolver**. Так вы сможете обнаружить ошибки в настройке DNS-сервера или проблемы с доступом к DNS-серверу. Вы видите DNS-сервер, который приложение будет использовать в консоли, просмотрев переменные среды WEBSITE_DNS_SERVER и WEBSITE_DNS_ALT_SERVER.

Следующее средство позволяет проверить подключение к комбинации «узел:порт» по протоколу TCP. Этот инструмент называется **tcpping.exe** и использует следующий синтаксис.

    tcpping.exe hostname [optional: port]

Служебная программа **tcpping** сообщает, возможно ли получить доступ к определенному узлу и порту. Сообщение об успешном выполнении отображается только с том случае, когда приложение ожидает передачи данных от комбинации "узел:порт", а также есть доступ по сети из приложения к указанным узлу и порту.

#### <a name="debugging-access-to-vnet-hosted-resources"></a>Доступ к ресурсам виртуальной сети для отладки
У приложения могут возникнуть проблемы с доступом к определенной комбинации «узел:порт». Это происходит по многим причинам. Вот три наиболее распространенные причины:

* **Брандмауэр блокирует доступ.** Если вы используете брандмауэр, может быть превышено время ожидания TCP. В нашем случае это 21 секунда. Проверьте подключение с помощью средства **tcpping**. Время ожидания TCP может превышаться и по многим другим причинам, но начать стоит именно с этой. 
* **Служба DNS недоступна.** Время ожидания для DNS составляет три секунды на каждый DNS-сервер. Если у вас два DNS-сервера, то время ожидания составляет 6 секунд. Используйте средство nameresolver для проверки работы DNS. Помните, что средство nslookup не подходит для проверки, так как оно игнорирует настройки DNS для виртуальной сети. Если он недоступен, возможно, брандмауэр или NSG блокирует доступ к DNS.

Если эти элементы не отвечают на ваши проблемы, сначала изучите такие вещи, как: 

**Интеграция региональной виртуальной сети**
* адрес назначения — RFC 1918.
* Существует ли NSG блокировка исходящего трафика из подсети интеграции
* Если переход выполняется между ExpressRoute или VPN, локальный шлюз настроен для маршрутизации трафика в Azure? Если вы можете получить доступ к конечным точкам в виртуальной сети, но не в локальной среде, это можно проверить.

**Интеграция виртуальной сети, требуемой шлюзом**
* диапазон адресов "точка — сеть" в диапазонах RFC 1918 (10.0.0.0-10.255.255.255/172.16.0.0-172.31.255.255/192.168.0.0-192.168.255.255)?
* Отображается ли на портале шлюз в рабочем состоянии? Если шлюз не работает, восстановите его работоспособность.
* Отображаются ли сертификаты как синхронизированные или вы подозреваете, что конфигурация сети была изменена?  Если сертификаты не синхронизированы или вы подозреваете, что в конфигурацию виртуальной сети были внесены изменения, которые не были синхронизированы с планах ASP, нажмите "синхронизировать сеть".
* Если переход выполняется между ExpressRoute или VPN, локальный шлюз настроен для маршрутизации трафика в Azure? Если вы можете получить доступ к конечным точкам в виртуальной сети, но не в локальной среде, это можно проверить.

Отладка сетевых проблем является сложной задачей, так как здесь не видно, что блокирует доступ к определенной комбинации "узел: порт". Ниже представлено несколько возможных причин этой проблемы.

* На нужном узле запущен брандмауэр, который блокирует доступ к порту приложения для диапазона IP-адресов "точка — сеть". Для подключения между подсетями часто требуется разрешить общий доступ.
* Целевой узел не работает.
* Целевое приложение не работает.
* Указан неверный IP-адрес или неверное имя узла.
* Приложение ожидает передачи данных не по тому порту, который предполагается. Вы можете сопоставить ИД процесса с портом прослушивания при помощи команды "netstat -aon" в узле конечной точки. 
* Группы безопасности сети настроены на блокирование доступа к узлу и порту приложения для диапазона IP-адресов «точка-сеть».

Помните, что вы не уверены, какой адрес будет использоваться приложением. Это может быть любой адрес в подсети интеграции или диапазон адресов "точка — сеть", поэтому необходимо разрешить доступ из всего диапазона адресов. 

Можно выполнить дополнительные действия по отладке.

* Войдите на другую виртуальную машину в этой виртуальной сети и попробуйте из нее обратиться к нужной комбинации "узел:порт". Чтобы проверить доступ TCP, используйте команду PowerShell **test-netconnection**. Синтаксис выглядит следующим образом.

      test-netconnection hostname [optional: -Port]

* Выведите приложение на виртуальной машине и протестируйте доступ к этому узлу и порту из консоли приложения с помощью **tcpping**

#### <a name="on-premises-resources"></a>Локальные ресурсы ####

Если приложение не может перейти к ресурсу локально, проверьте, можно ли перейти к ней через виртуальную сеть. Чтобы проверить доступ по протоколу TCP, используйте команду PowerShell **test-netconnection**. Если виртуальная машина не может подключиться к локальному ресурсу, возможно, подключение VPN или ExpressRoute настроено неправильно.

Если размещенная в виртуальной сети виртуальная машина может взаимодействовать с локальной системой, а приложение — нет, это может быть вызвано одной из следующих причин:

* в ваших маршрутах не настроена подсеть или указаны диапазоны адресов сайтов в локальном шлюзе.
* ваши группы безопасности сети блокируют доступ к диапазону IP-адресов подключений "точка — сеть";
* локальные брандмауэры блокируют трафик из диапазона IP-адресов подключений "точка — сеть";
* Вы пытаетесь обратиться к адресу, отличному от RFC 1918, с помощью функции интеграции с региональной виртуальной сетью


## <a name="powershell-automation"></a>Автоматизация PowerShell

Службу приложений можно интегрировать с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-details.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-aspdetails.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-newvnet.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-newvnetdetails.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-selectvnet.png

<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ASEintro]: environment/intro.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#gatewaysubnet
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
