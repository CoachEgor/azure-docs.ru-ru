---
title: Интеграция приложения с виртуальной сетью Azure
description: Интегрируйте приложение в службе приложений Azure с помощью виртуальных сетей Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 04/16/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 78b49b8b7e17f12d49825390a302e28a61e10d16
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81770844"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure

В этой статье описывается функция интеграции с виртуальной сетью в службе приложений Azure и ее настройка с помощью приложений в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714). С помощью [виртуальной сети Azure][VNETOverview] (виртуальных сетей) можно разместить многие ресурсы Azure в сети, не поддерживающей маршрутизацию в Интернете.

Служба приложений Azure имеет два варианта:

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

## <a name="enable-vnet-integration"></a>Включение интеграции с виртуальной сетью

> [!NOTE]
> Если колонка "сети" отключена (неактивна) в меню для приложений Linux, это означает, что эта функция в настоящее время недоступна.
>

1. Перейдите к пользовательскому интерфейсу **сети** на портале службы приложений. В разделе **Интеграция виртуальной сети**выберите **щелкните здесь, чтобы настроить**.

1. Выберите **Добавить виртуальную сеть**.

   ![Выбор интеграции с виртуальной сетью][1]

1. Раскрывающийся список содержит все Azure Resource Manager виртуальные сети в подписке в одном регионе. Ниже приведен список диспетчер ресурсов виртуальных сетей во всех других регионах. Выберите виртуальную сеть, с которой необходимо выполнить интеграцию.

   ![Выберите виртуальную сеть][2]

   * Если виртуальная сеть находится в том же регионе, создайте новую подсеть или выберите пустую уже существующую подсеть.
   * Чтобы выбрать виртуальную сеть в другом регионе, необходимо подготовить шлюз виртуальной сети с включенным параметром "точка — сеть".
   * Чтобы выполнить интеграцию с классической виртуальной сетью, вместо выбора раскрывающегося списка **Виртуальная сеть** выберите **пункт Щелкните здесь, чтобы подключиться к классической виртуальной**сети. Выберите нужную классическую виртуальную сеть. В целевой виртуальной сети уже должен быть подготовлен шлюз виртуальной сети с поддержкой "точка — сеть".

    ![Выбор классической виртуальной сети][3]

Во время интеграции приложение перезапускается. После завершения интеграции вы увидите сведения о виртуальной сети, с которой вы интегрируетесь.

## <a name="regional-vnet-integration"></a>Интеграция региональной виртуальной сети

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

### <a name="how-regional-vnet-integration-works"></a>Принцип работы интеграции региональной виртуальной сети

Приложения в службе приложений размещаются на рабочих ролях. Базовые и более высокие тарифные планы являются выделенными планами размещения, где нет рабочих нагрузок других клиентов, выполняющихся в одних и тех же работниках. Интеграция региональной виртуальной сети осуществляется путем подключения виртуальных интерфейсов с адресами в делегированной подсети. Так как адрес отсчета находится в виртуальной сети, он может получить доступ к большинству вещей в виртуальной сети или через нее, например виртуальную машину в виртуальной сети. Реализация сети отличается от работы виртуальной машины в виртуальной сети. Вот почему некоторые сетевые функции еще не доступны для этой функции.

![Принцип работы интеграции региональной виртуальной сети][5]

Если включена интеграция с региональной виртуальной сетью, приложение выполняет исходящие вызовы к Интернету через те же каналы, что и обычные. Исходящие адреса, указанные на портале свойств приложения, — это адреса, которые все еще используются вашим приложением. Какие изменения в приложении являются вызовами служб, защищенных конечной точкой службы, или адресов RFC 1918, поступают в виртуальную сеть. Если WEBSITE_VNET_ROUTE_ALL имеет значение 1, весь исходящий трафик может быть отправлен в виртуальную сеть.

Эта функция поддерживает только один виртуальный интерфейс для каждого рабочего процесса. Один виртуальный интерфейс на каждый рабочий процесс означает, что для каждого плана службы приложений необходимо интегрировать одну региональную виртуальную сеть. Все приложения в одном плане службы приложений могут использовать одну и ту же интеграцию виртуальной сети. Если требуется, чтобы приложение подключаться к дополнительной виртуальной сети, необходимо создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому у клиентов есть прямой доступ.

Из-за особенностей работы этой технологии трафик, используемый с интеграцией виртуальной сети, не отображается в журналах потоков Azure или наблюдателя NSG.

## <a name="gateway-required-vnet-integration"></a>Интеграция виртуальной сети с требуемым шлюзом

Для шлюза требуется интеграция виртуальной сети, которая поддерживает подключение к виртуальной сети в другом регионе или в классическую виртуальную сеть. Интеграция виртуальной сети, необходимая шлюзу:

* Позволяет приложению подключаться только к одной виртуальной сети за раз.
* Позволяет интегрировать до пяти виртуальных сетей в рамках плана службы приложений.
* Позволяет использовать одну и ту же виртуальную сеть в нескольких приложениях в плане службы приложений, не влияя на общее число, которое может использоваться планом службы приложений. Если у вас есть шесть приложений, использующих одну и ту же виртуальную сеть в одном плане службы приложений, это считается, что используется одна виртуальная сеть.
* Поддерживает соглашение об уровне обслуживания 99,9% из-за соглашения об уровне обслуживания на шлюзе.
* Позволяет приложениям использовать DNS, для которого настроена виртуальная сеть.
* Для подключения к приложению требуется шлюз на основе маршрута виртуальной сети, настроенный с использованием VPN-подключения типа "точка — сеть" (SSTP).

Вы не можете использовать интеграцию виртуальной сети, требуемую шлюзом:

* С приложениями Linux.
* С виртуальной сетью, подключенной к Azure ExpressRoute.
* Для доступа к защищенным ресурсам конечной точки службы.
* С помощью шлюза сосуществования, поддерживающего как ExpressRoute, так и VPN типа "точка — сеть" или "сеть-сеть".

### <a name="set-up-a-gateway-in-your-azure-virtual-network"></a>Настройка шлюза в виртуальной сети Azure ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Задайте адреса "точка — сеть"][setp2saddresses]. Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Адресное пространство "точка — сеть" должно находиться в блоках адресов RFC 1918 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Если вы создаете шлюз для использования с интеграцией виртуальной сети службы приложений, вам не нужно отправлять сертификат. Создание шлюза может занять 30 минут. Вы не сможете интегрировать приложение с виртуальной сетью, пока шлюз не будет подготовлен.

### <a name="how-gateway-required-vnet-integration-works"></a>Как работает интеграция виртуальной сети, требующая шлюза

Интеграция виртуальной сети, необходимая для шлюза, основана на технологии VPN типа "точка — сеть". VPN типа "точка — сеть" ограничивает сетевой доступ к виртуальной машине, на которой размещено приложение. Приложения ограничены для отправки трафика в Интернет только через гибридные подключения или через интеграцию с виртуальной сетью. Если в приложении настроен портал для использования интеграции виртуальной сети, необходимой для шлюза, для создания и назначения сертификатов на шлюзе и на стороне приложения будет осуществляться комплексное согласование от вашего имени. В результате рабочие процессы, используемые для размещения приложений, могут напрямую подключаться к шлюзу виртуальной сети в выбранной виртуальной сети.

![Как работает интеграция виртуальной сети, требующая шлюза][6]

### <a name="access-on-premises-resources"></a>Доступ к локальным ресурсам

Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". При использовании интеграции виртуальной сети, необходимой для шлюза, обновите маршруты локального VPN-шлюза с помощью блоков адресов типа "точка — сеть". При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Подробные сведения о том, как это сделать, зависят от каждого шлюза и не описаны здесь. Вы не можете настроить BGP с VPN-подключением типа "сеть — сеть".

Для возможности интеграции региональной виртуальной сети с локальными ресурсами не требуется дополнительная настройка. Вам нужно просто подключить виртуальную сеть к локальным ресурсам с помощью ExpressRoute или VPN типа "сеть — сеть".

> [!NOTE]
> Компонент интеграции виртуальной сети, необходимый для шлюза, не интегрирует приложение с виртуальной сетью, имеющей шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex], интеграция виртуальной сети не работает. Если вам требуется доступ к ресурсам через подключение ExpressRoute, используйте функцию интеграции с региональной сетью или [Среда службы приложений][ASE], которая выполняется в виртуальной сети.
> 
> 

### <a name="peering"></a>Пиринг

При использовании пиринга с региональной интеграцией виртуальной сети вам не нужно выполнять дополнительную настройку.

При использовании интеграции виртуальной сети, необходимой для шлюза, с пирингом необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. При добавлении подключения пиринга включите параметр **Разрешить доступ к виртуальной сети** и выберите **Разрешить перенаправленный трафик** и **Разрешить транзит шлюза**.
1. Добавьте одноранговое подключение в виртуальную сеть, к которой подключена виртуальная сеть. При добавлении подключения пиринга в целевую виртуальную сеть включите параметр **Разрешить доступ к виртуальной сети** и выберите **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите > в раздел **план службы приложений**интерфейс**интеграции виртуальной сети** в**сети** > на портале. Выберите виртуальную сеть, к которой подключается приложение. В разделе "Маршрутизация" Добавьте диапазон адресов виртуальной сети, к которой подключено приложение.

## <a name="manage-vnet-integration"></a>Управление интеграцией виртуальной сети

Подключение и отключение виртуальной сети осуществляется на уровне приложения. Операции, которые могут повлиять на интеграцию виртуальной сети в нескольких приложениях, находятся на уровне плана службы приложений. На портале**интеграции** с **сетевой сетью** > > приложений можно получить сведения о виртуальной сети. Аналогичные сведения можно просмотреть на уровне плана службы приложений на портале **службы** > приложений**сеть сетевая** > **Интеграция сетевой виртуальной** сети.

Единственной операцией, которую можно выполнить в представлении приложения для экземпляра интеграции с виртуальной сетью, является отключение приложения от виртуальной сети, к которой он подключен. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. Приложение перезапускается при отключении от виртуальной сети. Виртуальная сеть не меняется при отключении. Подсеть или шлюз не удалены. Если вы хотите удалить виртуальную сеть, сначала отключите приложение от виртуальной сети и удалите в нем ресурсы, например шлюзы.

В пользовательском интерфейсе интеграции виртуальной сети плана службы приложений показаны все интеграции виртуальной сети, используемые приложениями в плане службы приложений. Чтобы просмотреть сведения о каждой виртуальной сети, выберите виртуальную сеть, в которой вы заинтересованы. Здесь можно выполнить два действия для интеграции виртуальной сети, необходимой для шлюза.

* **Сеть синхронизации**. операция синхронизации в сети используется только для компонента интеграции с виртуальной сетью, зависящей от шлюза. Выполнение операции синхронизации обеспечивает синхронизацию сертификатов и сведений о сети. При добавлении или изменении DNS виртуальной сети выполните операцию синхронизации сети. Эта операция перезапускает все приложения, использующие эту виртуальную сеть.
* **Добавление маршрутов**. при добавлении маршрутов в виртуальную сеть выводится исходящий трафик.

### <a name="gateway-required-vnet-integration-routing"></a>Шлюз — требуется маршрутизация интеграции виртуальной сети
Маршруты, определенные в виртуальной сети, используются для направления трафика в виртуальную сеть из приложения. Чтобы отправить дополнительный исходящий трафик в виртуальную сеть, добавьте сюда эти блоки адресов. Эта возможность работает только с интеграцией виртуальной сети, требующей шлюза. Таблицы маршрутов не влияют на трафик приложения при использовании интеграции виртуальной сети, необходимой для шлюза, так же, как и при интеграции с региональной виртуальной сетью.

### <a name="gateway-required-vnet-integration-certificates"></a>Сертификаты интеграции виртуальной сети, необходимые для шлюза
Если требуется интеграция виртуальной сети, требующая шлюза, необходимо выполнить обмен сертификатами, чтобы обеспечить безопасность подключения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.

Если изменились сертификаты или сведения о сети, выберите **синхронизировать сеть**. Если выбрать пункт **синхронизировать сеть**, это приведет к кратковременному сбою подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности.

## <a name="pricing-details"></a>Сведения о тарифах
Функция интеграции с региональной сетью не взимается за пределы ценовой категории плана службы приложений.

Три расхода связаны с использованием функции интеграции виртуальной сети, требуемой шлюзом:

* **Ценовая категория плана службы приложений. плата взимается**: приложения должны быть в плане службы приложений "Стандартный", "Премиум" или "категории премиум v2". Дополнительные сведения об этих затратах см. в статье [цены на службу приложений][ASPricing].
* **Затраты на передачу данных**. за исходящие данные взимается плата, даже если виртуальная сеть находится в одном центре обработки данных. Эти тарифы описаны в [Передача данных сведения о ценах][DataPricing].
* **Стоимость VPN-шлюза**. для шлюза виртуальной сети, который требуется для VPN типа "точка — сеть", взимается плата. Дополнительные сведения см. в разделе [цены на VPN-шлюз][VNETPricing].

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="automation"></a>Служба автоматизации

Поддержка CLI доступна для интеграции региональной виртуальной сети. Чтобы получить доступ к следующим командам, [установите Azure CLI][installCLI].

        az webapp vnet-integration --help

        Group
            az webapp vnet-integration : Methods that list, add, and remove virtual network integrations
            from a webapp.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            add    : Add a regional virtual network integration to a webapp.
            list   : List the virtual network integrations on a webapp.
            remove : Remove a regional virtual network integration from webapp.

        az appservice vnet-integration --help

        Group
            az appservice vnet-integration : A method that lists the virtual network integrations used in an
            appservice plan.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            list : List the virtual network integrations used in an appservice plan.

Для интеграции виртуальной сети, необходимой для шлюза, можно интегрировать службу приложений с виртуальной сетью Azure с помощью PowerShell. Готовый сценарий см. в статье [Подключение приложения в службе приложений Azure к виртуальной сети Azure](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
[VNETRouteTables]: https://docs.microsoft.com/azure/virtual-network/manage-route-table/
[installCLI]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest/
[privateendpoints]: networking/private-endpoint.md
