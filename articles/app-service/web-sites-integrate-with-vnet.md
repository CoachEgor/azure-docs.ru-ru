---
title: Интеграция приложения с виртуальной сетью Azure
description: Интеграция приложений в службу приложений Azure с виртуальными сетями Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 02/27/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 89aa78e0d26598eacf436ca88cc6c5549f91d2fc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78673226"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описывается функция виртуальной сетевой интеграции Azure App Service и способы ее настройки с помощью приложений в [Службе приложений Azure.](https://go.microsoft.com/fwlink/?LinkId=529714) [Виртуальные сети Azure][VNETOverview] (VNets) позволяют разместить многие ресурсы Azure в сети, не связанные с интернетом.  

Служба приложений Azure имеет два варианта.

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

## <a name="enable-vnet-integration"></a>Включить интеграцию VNet 

1. Перейдите на веб-ум сетевого взаимодействия на портале App Service. В рамках интеграции VNet выберите *"Нажмите здесь, чтобы настроить"*. 

1. Выберите **Добавить виртуальную сеть**.  

   ![Выберите интеграцию VNet][1]

1. Список выпадающих будет содержать все VNets менеджера ресурсов в вашей подписке в том же регионе и ниже, который представляет собой список всех ресурсов менеджера VNets во всех других регионах. Выберите VNet, с который вы хотите интегрироваться.

   ![Выберите VNet][2]

   * Если VNet находится в том же регионе, то либо создайте новую подсеть, либо выберите пустую уже существующую подсеть. 

   * Чтобы выбрать VNet в другом регионе, необходимо иметь шлюз виртуальной сети, подготовленный с включенной точкой сайта.

   * Чтобы интегрироваться с классическим VNet, вместо того, чтобы нажать на Падение VNet, выберите **Нажмите здесь, чтобы подключиться к классическому VNet.** Выберите желаемый Классический VNet. Целевой VNet уже должен иметь шлюз виртуальной сети, подготовленный с включенной точкой сайта.

    ![Выберите Классический VNet][3]
    
Во время интеграции приложение перезапускается.  Когда интеграция будет завершена, вы увидите подробную информацию о VNet вы интегрированы с. 

Как только ваше приложение будет интегрировано с Вашим VNet, оно будет использовать тот же DNS-сервер, с которым настроен ваш VNet, если только это не частные зоны Azure DNS. В настоящее время вы не можете использовать интеграцию VNet с частными зонами Azure DNS.

## <a name="regional-vnet-integration"></a>Региональная интеграция VNet

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

### <a name="how-regional-vnet-integration-works"></a>Как работает региональная интеграция VNet

Приложения в Службе приложений размещаются на ролях сотрудников. Основные и более высокие тарифные планы посвящены хостинг-планам, где нет других рабочих нагрузок клиентов, работающих на тех же работниках. Региональная интеграция VNet работает путем установки виртуальных интерфейсов с адресами в делегированной подсети. Поскольку адрес находится в вашем VNet, он может получить доступ к большинству вещей в или через ваш VNet так же, как VM в вашем VNet будет. Реализация сети отличается от запуска VM в VNet, и именно поэтому некоторые сетевые функции еще не доступны при использовании этой функции.

![Как работает региональная интеграция VNet][5]

Когда региональная интеграция VNet включена, ваше приложение будет по-прежнему совершать исходящие звонки в Интернет по тем же каналам, что и обычно. Исходящие адреса, перечисленные на портале свойств приложений, по-прежнему являются адресами, используемыми вашим приложением. Какие изменения в приложении, вызовы в службу безопасности услуг связи или адреса RFC 1918 входят в ваш VNet. Если WEBSITE_VNET_ROUTE_ALL настроен на 1, то весь исходящий трафик может быть отправлен в ваш VNet. 

Функция поддерживает только один виртуальный интерфейс на одного работника.  Один виртуальный интерфейс на одного работника означает одну региональную интеграцию VNet в план службы приложений. Все приложения в одном и том же плане Службы Приложений могут использовать ту же интеграцию VNet, но если вам нужно приложение для подключения к дополнительной VNet, вам нужно будет создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому клиенты имеют прямой доступ.

Из-за характера работы этой технологии трафик, используемый с интеграцией VNet, не отображается в журналах потока Network Watcher или NSG.  

## <a name="gateway-required-vnet-integration"></a>Шлюз требует интеграции VNet

Gateway требует сярты интеграции VNet, подключающиеся к VNet в другом регионе или к классическому VNet. Шлюз требует интеграции VNet: 

* Позволяет приложению подключаться только к 1 VNet одновременно
* Позволяет интегрировать до пяти VNets в план службы приложений 
* Позволяет использовать один и тот же VNet несколькимприложениям в плане службы приложений, не влияя на общее число, которое может быть использовано в плане Службы Приложения.  Если в том же плане Службы app используется шесть приложений, использующих один и тот же VNet, то это считается 1 VNet. 
* Поддерживает 99,9% SLA из-за SLA на шлюзе
* Позволяет вашим приложениям использовать DNS, с помощью которого настроен VNet
* Требуется шлюз на основе маршрутов виртуальной сети, настроенный с помощью VPN от SSTP от точки к сайту, прежде чем он может быть подключен к приложению. 

Вы не можете использовать шлюз, необходимый интеграция VNet:

* С приложениями Linux
* С VNet, связанным с ExpressRoute 
* Для доступа к конечным ресурсам службы обеспеченные ресурсы
* С шлюзом сосуществования, который поддерживает как ExpressRoute, так и указывают на сайт/сайт на VPN-сайтах

### <a name="set-up-a-gateway-in-your-vnet"></a>Настройка шлюза в виртуальной сети ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Задайте адреса для подключения "точка — сеть"][setp2saddresses]. Если шлюз не находится в базовом SKU, то IKEV2 должен быть отключен в точке к конфигурации сайта и SSTP должны быть выбраны. Точка адресного пространства сайта должна находиться в адресных блоках RFC 1918, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

Если вы просто создаете шлюз для использования с интеграцией App Service VNet, то вам не нужно загружать сертификат. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно. 

### <a name="how-gateway-required-vnet-integration-works"></a>Как работает интеграция VNet, необходимая шлюза

Шлюз требует интеграции VNet, построенной поверх точки для технологии VPN сайта. Укажите на сайт VPN, что ограничивает доступ к сети только виртуальной машине, принимающей приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. Когда приложение настроено с порталом для использования требуемой интеграции VNet, от вашего имени управляется сложное согласование для создания и присвоения сертификатов на шлюзе и стороне приложения. Конечным результатом является то, что работники, используемые для размещения ваших приложений, могут напрямую подключаться к виртуальному сетевому шлюзу в выбранном VNet. 

![Как работает интеграция VNet, необходимая шлюза][6]

### <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам

Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". Если вы используете необходимый шлюз VNet Integration, вам необходимо обновить маршруты VPN-шлюза с помощью адресных блоков точек.ru. При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Вы не можете настроить BGP с VPN-соединением от сайта к сайту.

Дополнительная конфигурация не требуется для того, чтобы региональная функция интеграции VNet была дополнила его через VNet и в помещении. Вам просто необходимо подключить VNet к местным с помощью ExpressRoute или VPN от сайта. 

> [!NOTE]
> Требуемая функция интеграции VNet не интегрирует приложение с VNet с шлюзом ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex], функция интеграции c виртуальной сетью работать не будет. Если вам необходимо получить доступ к ресурсам через соединение ExpressRoute, то вы можете использовать региональную функцию интеграции VNet или [среду службы приложений,][ASE]которая работает в вашем VNet. 
> 
> 

### <a name="peering"></a>Пиринг

Если вы используете с помощью региональной интеграции VNet, вам не нужно делать дополнительную конфигурацию. 

Если вы используете шлюз, необходимый интеграция VNet с пирингом, вам нужно настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите к разделу "План службы приложений" > "Сеть" > "Интеграция виртуальной сети" на портале.  Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены.  

## <a name="managing-vnet-integration"></a>Управление интеграцией VNet 

Подключение и отключение с VNet находится на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. С > сетевого > портала интеграции VNet вы можете получить подробную информацию о VNet. Аналогичную информацию можно увидеть на уровне ASP на портале ASP > сетевой > VNet Integration.

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение будет перезапущено. Виртуальная сеть не меняется при отключении. Подсеть или шлюз не удаляется. Если вы хотите удалить VNet, вам необходимо сначала отключить приложение от VNet и удалить ресурсы в нем, такие как шлюзы. 

UI-uI ASP VNet Integration покажет вам все интеграции VNet, используемые приложениями в вашем ASP. Чтобы просмотреть сведения о той или иной виртуальной сети, щелкните нужную сеть. Есть два действия, которые вы можете выполнить здесь для шлюза требуется VNet интеграции.

* **Синхронизировать сеть.** Операция сети синхронизации предназначена только для функции интеграции VNet, зависящей от шлюза. Выполнение операции сети синхронизации гарантирует синхронизацию сертификатов и сетевой информации. Если вы добавляете или изменяете DNS вашего VNet, вам необходимо выполнить операцию **сети Sync.** Эта операция перезапустит все приложения, использующие эту виртуальную сеть.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть. 

**Шлюз требует сятвора интеграции VNet** Маршруты, определяемые в VNet, используются для направления трафика в Ваш VNet из приложения. Если вам нужно отправлять дополнительный исходящий трафик в виртуальную сеть, то вы можете добавить здесь соответствующие блоки адресов. Эта возможность работает только с шлюзом, требуемым интеграцией VNet. Таблицы маршрутов не влияют на трафик приложения при использовании требуемой интеграции VNet, необходимой для интеграции VNet, как это делается в случае региональной интеграции VNet.

**Gateway требуется VNet Интеграция Сертификаты** При включении шлюза VNet Integration происходит необходимый обмен сертификатами для обеспечения безопасности соединения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.
Если сертификаты или сведения о сети изменились, нажмите "Синхронизировать сеть". Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="pricing-details"></a>Сведения о тарифах
Региональная функция интеграции VNet не взимает дополнительную плату за использование за пределами сборов уровня ценообразования ASP.

Есть три связанные с использованием шлюза требуется VNet Интеграция функция:

* Плата за повышение ценового уровня ASP - Ваши приложения должны быть в стандартном, премиум-плане обслуживания приложений PremiumV2. Дополнительные сведения о ценах на планы см. на странице [цен на службу приложений][ASPricing]. 
* Расходы на передачу данных - Существует плата за выход данных, даже если VNet находится в том же центре обработки данных. Эти тарифы описаны в [сведениях о ценах за передачу данных][DataPricing]. 
* VPN Gateway стоит - Существует стоимость шлюза VNet, которая необходима для точки к сайту VPN. Подробные сведения представлены на странице [Цены на VPN-шлюзы][VNETPricing].

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="automation"></a>Служба автоматизации

Существует поддержка CLI для региональной интеграции VNet. Чтобы получить доступ к следующим командам, [установите Azure CLI.][installCLI] 

        az webapp vnet-integration --help

        Group
            az webapp vnet-integration : Methods that list, add, and remove virtual network integrations
            from a webapp.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            add    : Add a regional virtual network integration to a webapp.
            list   : List the virtual network integrations on a webapp.
            remove : Remove a regional virtual network integration from webapp.

        az appservice vnet-integration --help

        Group
            az appservice vnet-integration : A method that lists the virtual network integrations used in an
            appservice plan.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            list : List the virtual network integrations used in an appservice plan.

Для интеграции VNet, необходимой для интеграции VNet, вы можете интегрировать службу приложений с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
[VNETRouteTables]: https://docs.microsoft.com/azure/virtual-network/manage-route-table/
[installCLI]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest/
