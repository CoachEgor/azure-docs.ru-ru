---
title: Интеграция приложения с виртуальной сетью Azure
description: Интегрируйте приложение в службу приложений Azure с виртуальными сетями Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 04/16/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 78b49b8b7e17f12d49825390a302e28a61e10d16
ms.sourcegitcommit: d57d2be09e67d7afed4b7565f9e3effdcc4a55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81770844"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure

В этой статье описывается функция интеграции службы приложений Azure VNet и способы ее настройки с помощью приложений в [Службе приложений Azure.](https://go.microsoft.com/fwlink/?LinkId=529714) С [помощью виртуальной сети Azure][VNETOverview] (VNets) вы можете разместить многие ресурсы Azure в сети, не связанные с интернетом.

Служба приложений Azure имеет два варианта:

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

## <a name="enable-vnet-integration"></a>Включить интеграцию VNet

> [!NOTE]
> Если лезвие "Сеть" отключено (серый) в меню для ваших приложений Linux, это означает, что функция в настоящее время недоступна.
>

1. Перейдите на **веб-ум сетевого** взаимодействия на портале App Service. В **рамках интеграции VNet**выберите **Нажмите здесь, чтобы настроить.**

1. Выберите **Добавить виртуальную сеть**.

   ![Выберите интеграцию VNet][1]

1. Список выпадающих средств содержит все виртуальные сети Azure Resource Manager в подписке в одном регионе. Под ним находится список виртуальных сетей Resource Manager во всех других регионах. Выберите VNet, с который вы хотите интегрироваться.

   ![Выберите VNet][2]

   * Если VNet находится в одном регионе, либо создайте новую подсеть, либо выберите пустую уже существующую подсеть.
   * Чтобы выбрать VNet в другом регионе, необходимо иметь шлюз VNet, подготовленный с включенной точкой сайта.
   * Чтобы интегрироваться с классическим VNet, вместо того, чтобы выбрать список выпадающих сетей **виртуальной сети,** выберите **Нажмите здесь, чтобы подключиться к классическому VNet.** Выберите классическую виртуальную сеть, которая вам нужна. Целевой VNet уже должен иметь шлюз виртуальной сети, подготовленный с включенным пунктом к сайту.

    ![Выберите Классический VNet][3]

Во время интеграции приложение перезапускается. Когда интеграция будет завершена, вы увидите подробную информацию о VNet, с помощью исвключенного в интеграцию.

## <a name="regional-vnet-integration"></a>Региональная интеграция VNet

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

### <a name="how-regional-vnet-integration-works"></a>Как работает региональная интеграция VNet

Приложения в Службе приложений размещаются на ролях работников. Основные и более высокие тарифные планы посвящены хостинг-планам, где нет рабочих нагрузок других клиентов, работающих на тех же работниках. Региональная интеграция VNet работает путем установки виртуальных интерфейсов с адресами в делегированной подсети. Поскольку адрес находится в вашем VNet, он может получить доступ к большинству вещей в или через ваш VNet, как VM в вашем VNet будет. Реализация сети отличается от запуска VM в VNet. Вот почему некоторые сетевые функции еще не доступны для этой функции.

![Как работает региональная интеграция VNet][5]

Когда региональная интеграция VNet включена, ваше приложение делает исходящие звонки в Интернет по тем же каналам, что и обычно. Исходящие адреса, перечисленные на портале свойств приложений, являются адресами, которые по-прежнему используются вашим приложением. Что изменится в приложении, так это вызовы в службу услуг безопасности или адреса RFC 1918, которые попадают в ваш VNet. Если WEBSITE_VNET_ROUTE_ALL настроен на 1, весь исходящий трафик может быть отправлен в ваш VNet.

Функция поддерживает только один виртуальный интерфейс на одного работника. Один виртуальный интерфейс на одного работника означает одну региональную интеграцию VNet в план службы приложений. Все приложения в одном и том же плане Службы приложений могут использовать одну и ту же интеграцию VNet. Если вам нужно приложение для подключения к дополнительному VNet, необходимо создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому клиенты имеют прямой доступ.

Из-за характера работы этой технологии трафик, используемый в интеграции VNet, не отображается в журналах Azure Network Watcher или NSG.

## <a name="gateway-required-vnet-integration"></a>Интеграция VNet, необходимая для шлюза

Интеграция VNet, необходимая для gateway, поддерживает подключение к VNet в другом регионе или к классической виртуальной сети. Интеграция VNet, необходимая для шлюза:

* Позволяет приложению подключаться только к одному VNet одновременно.
* Позволяет интегрировать до пяти VNets в план Службы приложений.
* Позволяет использовать один и тот же VNet несколькимприложениям в плане Службы приложений, не влияя на общее число, которое может быть использовано в плане Службы Приложения. Если в том же плане Службы app есть шесть приложений, использующих один и тот же VNet, это считается одним из используемых VNet.
* Поддерживает 99,9% SLA из-за SLA на шлюзе.
* Позволяет вашим приложениям использовать DNS, с которым настроен VNet.
* Требуется шлюз на основе маршрутов виртуальной сети, настроенный с VPN от SSTP от точки к сайту, прежде чем он может быть подключен к приложению.

Вы не можете использовать интеграцию VNet, требуемую шлюзом:

* С приложениями Linux.
* С VNet, подключенным к Azure ExpressRoute.
* Для доступа к конечным ресурсам службы обеспеченные ресурсы.
* С шлюзом сосуществования, который поддерживает как ExpressRoute, так и от точки к сайту или от места к сайту VPN.

### <a name="set-up-a-gateway-in-your-azure-virtual-network"></a>Настройка шлюза в виртуальной сети Azure ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Установите адреса точек на сайт.][setp2saddresses] Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Адресное пространство от точки к месту должно находиться в адресных блоках RFC 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Если вы создаете шлюз для использования с интеграцией App Service VNet, вам не нужно загружать сертификат. Создание шлюза может занять 30 минут. Вы не сможете интегрировать приложение с VNet до тех пор, пока шлюз не будет подготовлен.

### <a name="how-gateway-required-vnet-integration-works"></a>Как работает интеграция VNet, необходимая для шлюза

Интеграция VNet, необходимая для gateway, построена на основе технологии VPN от точки к сайту. VPN от точки к месту ограничивают доступ к сети к виртуальной машине, которая размещает приложение. Приложения ограничены для отправки трафика в Интернет только через гибридные соединения или через интеграцию VNet. Когда приложение настроено на портал для использования требуемой шлюзом интеграции VNet, от вашего имени удается создавать и назначать сертификаты на шлюзе и стороне приложения. В результате работники, используемые для размещения ваших приложений, могут напрямую подключаться к виртуальному сетевому шлюзу в выбранном VNet.

![Как работает интеграция VNet, необходимая для шлюза][6]

### <a name="access-on-premises-resources"></a>Доступ к ресурсам на месте

Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". Если вы используете интеграцию VNet, требуя шлюза, обновите маршруты VPN-шлюза с помощью адресных блоков точек.ru. При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Подробная информация о том, как это сделать, различаются в шлюзе и не описаны здесь. Вы не можете настроить BGP с VPN-соединением от сайта к сайту.

Дополнительная конфигурация не требуется для того, чтобы региональная функция интеграции VNet через VNet добирала ресурсы. Вам просто необходимо подключить VNet к местным ресурсам с помощью ExpressRoute или VPN-сайта.

> [!NOTE]
> Функция интеграции VNet, требуя шлюза, не интегрирует приложение с VNet с шлюзом ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования,][VPNERCoex]интеграция VNet не работает. Если вам необходимо получить доступ к ресурсам через соединение ExpressRoute, используйте региональную функцию интеграции VNet или [среду службы приложений,][ASE]которая работает в вашем VNet.
> 
> 

### <a name="peering"></a>Пиринг

Если вы используете вонючую с региональной интеграцией VNet, вам не нужно делать какую-либо дополнительную конфигурацию.

Если вы используете интеграцию VNet, требующую шлюза, с помощью пиринга, необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. При добавлении однорангового соединения включите **виртуальный доступ к сети** и выберите **Разрешить переадресованный трафик** и разрешить транзит **шлюза.**
1. Добавьте в VNet вглядывающее соединение, с которым внастоящесучено в подключенном к вам VNet. При добавлении вонючения в пункт назначения VNet, **разрешить виртуальный доступ к сети** и выбрать Разрешить **переадресованный трафик** и разрешить **удаленные шлюзы.**
1. Перейдите к **плану** > App Service**Networking** > **VNet Integration** UI на портале. Выберите виртуальную сеть, к которой подключается приложение. Под разделом трассировки добавьте адресную линейку VNet, которая заглянула к VNet, к которому подключено приложение VNet.

## <a name="manage-vnet-integration"></a>Управление интеграцией VNet

Подключение и отключение с VNet находится на уровне приложения. Операции, которые могут повлиять на интеграцию VNet в нескольких приложениях, находятся на уровне плана Службы Приложения. С сайта > **сетевой** > **интеграции VNet** вы можете получить подробную информацию о вашем VNet. Аналогичную информацию можно увидеть на уровне плана App Service на портале**интеграции** >  **Сетевого** > **VNet.**

Единственная операция, которая может быть проведена в представлении приложения в экземпляре интеграции VNet, заключается в отключении приложения от VNet, к нему в настоящее время подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. Приложение перезапускается при отключении от VNet. Виртуальная сеть не меняется при отключении. Подсеть или шлюз не удаляется. Если вы хотите удалить VNet, сначала отключите приложение от VNet и удалите ресурсы в нем, такие как шлюзы.

План интеграции службы приложений VNet отображает все интеграции VNet, используемые приложениями в плане службы приложений. Чтобы узнать подробности о каждом VNet, выберите интересуемый вам VNet. Есть два действия, которые вы можете выполнить здесь для интеграции VNet, необходимой для шлюза:

* **Сеть синхронизации:** Операция сети синхронизации используется только для функции интеграции VNet, зависящей от шлюза. Выполнение операции сети синхронизации гарантирует синхронизацию сертификатов и сетевой информации. Если вы добавляете или изменяете DNS вашего VNet, выполните операцию сети синхронизации. Эта операция перезапускает любые приложения, которые используют этот VNet.
* **Добавление маршрутов**: Добавление маршрутов приводит к исходящим трафику в ваш VNet.

### <a name="gateway-required-vnet-integration-routing"></a>Требуемая шлюза VNet Интеграция разгрома
Маршруты, определяемые в VNet, используются для направления трафика в Ваш VNet из приложения. Чтобы отправить дополнительный исходящий трафик в VNet, добавьте эти адресные блоки здесь. Эта возможность работает только с интеграцией VNet, необходимой для шлюза. Таблицы маршрутов не влияют на трафик приложения, когда вы используете интеграцию VNet, требуемую шлюзом, так, как они делают с региональной интеграцией VNet.

### <a name="gateway-required-vnet-integration-certificates"></a>Обязательные сертификаты интеграции VNet, необходимые для шлюза
При включении интеграции VNet, необходимой для подключения к шлюзу, для обеспечения безопасности соединения необходим обмен сертификатами. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.

Если сертификаты или сетевая информация изменены, выберите **Sync Network**. При выборе **Sync Network**вы вызываете кратковременное сбой в подключении между приложением и VNet. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности.

## <a name="pricing-details"></a>Сведения о тарифах
Региональная функция интеграции VNet не взимает дополнительную плату за использование за пределами платы за повышение уровня ценообразования в тарифном уровне службы App Service.

Три заряда связаны с использованием требуемой для шлюза функции интеграции VNet:

* **Плата за повышение ценового уровня App Service:** Ваши приложения должны быть в стандартном, премиум-плане или сервисе PremiumV2. Для получения дополнительной информации [App Service pricing][ASPricing]об этих расходах см.
* **Расходы на передачу данных:** За выход данных взимается плата, даже если VNet находится в том же центре обработки данных. Эти сборы описаны в [деталях ценообразования Data Transfer.][DataPricing]
* **VPN шлюз расходы**: Там в стоимость виртуальной сети шлюз, который требуется для точки к сайту VPN. Для получения дополнительной информации, см [VPN цены шлюза][VNETPricing].

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="automation"></a>Служба автоматизации

Поддержка CLI доступна для региональной интеграции VNet. Чтобы получить доступ к следующим командам, [установите Azure CLI.][installCLI]

        az webapp vnet-integration --help

        Group
            az webapp vnet-integration : Methods that list, add, and remove virtual network integrations
            from a webapp.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            add    : Add a regional virtual network integration to a webapp.
            list   : List the virtual network integrations on a webapp.
            remove : Remove a regional virtual network integration from webapp.

        az appservice vnet-integration --help

        Group
            az appservice vnet-integration : A method that lists the virtual network integrations used in an
            appservice plan.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            list : List the virtual network integrations used in an appservice plan.

Для интеграции VNet, необходимой для шлюза, вы можете интегрировать службу приложений с виртуальной сетью Azure с помощью PowerShell. Для готового к запуску скрипта [см. Подключите приложение в службе приложений Azure к виртуальной сети Azure.](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3)


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
[VNETRouteTables]: https://docs.microsoft.com/azure/virtual-network/manage-route-table/
[installCLI]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest/
[privateendpoints]: networking/private-endpoint.md
