---
title: Интеграция приложения с виртуальной сетью Azure
description: Интегрируйте приложения в службе приложений Azure с помощью виртуальных сетей Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 02/27/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 89aa78e0d26598eacf436ca88cc6c5549f91d2fc
ms.sourcegitcommit: bc792d0525d83f00d2329bea054ac45b2495315d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78673226"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описывается функция интеграции виртуальной сети в службе приложений Azure и ее настройка с помощью приложений в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714). [Виртуальные сети Azure][VNETOverview] (виртуальных сетей) позволяют разместить многие ресурсы Azure в сети, не поддерживающей маршрутизацию в Интернете.  

Служба приложений Azure имеет два варианта.

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

## <a name="enable-vnet-integration"></a>Включение интеграции с виртуальной сетью 

1. Перейдите к пользовательскому интерфейсу сети на портале службы приложений. В разделе Интеграция виртуальной сети выберите *пункт "щелкните здесь, чтобы настроить"* . 

1. Выберите **Добавить виртуальную сеть**.  

   ![Выбор интеграции с виртуальной сетью][1]

1. В раскрывающемся списке будут содержаться все диспетчер ресурсов виртуальных сетей в подписке в том же регионе, а ниже — список всех диспетчер ресурсов виртуальных сетей во всех других регионах. Выберите виртуальную сеть, с которой требуется выполнить интеграцию.

   ![Выберите виртуальную сеть][2]

   * Если виртуальная сеть находится в том же регионе, создайте новую подсеть или выберите пустую уже существующую подсеть. 

   * Чтобы выбрать виртуальную сеть в другом регионе, необходимо подготовить шлюз виртуальной сети с включенным параметром "точка — сеть".

   * Чтобы выполнить интеграцию с классической виртуальной сетью, вместо того чтобы щелкнуть раскрывающийся список виртуальная сеть, выберите **щелкните здесь, чтобы подключиться к классической виртуальной сети**. Выберите нужную классическую виртуальную сеть. В целевой виртуальной сети уже должен быть подготовлен шлюз виртуальной сети с включенным параметром "точка — сеть".

    ![Выбор классической виртуальной сети][3]
    
Во время интеграции приложение перезапускается.  После завершения интеграции вы увидите сведения о виртуальной сети, с которой вы интегрируетесь. 

После интеграции приложения с виртуальной сетью он будет использовать тот же DNS-сервер, с которым настроена виртуальная сеть, если только это не Частные зоны Azure DNS. Сейчас невозможно использовать интеграцию с виртуальной сетью с Частные зоны Azure DNS.

## <a name="regional-vnet-integration"></a>Интеграция региональной виртуальной сети

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

### <a name="how-regional-vnet-integration-works"></a>Принцип работы интеграции региональной виртуальной сети

Приложения в службе приложений размещаются на рабочих ролях. Базовые и более высокие тарифные планы являются выделенными планами размещения, где нет других рабочих нагрузок клиентов, выполняющихся в одних и тех же работниках. Интеграция региональной виртуальной сети осуществляется путем подключения виртуальных интерфейсов с адресами в делегированной подсети. Так как адрес отсчета находится в виртуальной сети, он может получить доступ к большинству вещей в виртуальной сети или через нее так же, как и виртуальная машина в виртуальной сети. Реализация сети отличается от работы виртуальной машины в виртуальной сети, поэтому некоторые сетевые функции пока не доступны при использовании этой функции.

![Принцип работы интеграции региональной виртуальной сети][5]

Если включена интеграция с региональной виртуальной сетью, приложение по-прежнему будет выполнять исходящие вызовы к Интернету через те же каналы, что и обычные. Исходящие адреса, перечисленные на портале свойств приложения, по-прежнему являются адресами, используемыми приложением. Какие изменения в приложении являются, вызовы к защищенным конечным точкам служб или адреса RFC 1918 попадают в виртуальную сеть. Если WEBSITE_VNET_ROUTE_ALL имеет значение 1, то весь исходящий трафик может быть отправлен в виртуальную сеть. 

Эта функция поддерживает только один виртуальный интерфейс для каждого рабочего процесса.  Один виртуальный интерфейс на каждый рабочий процесс означает, что для каждого плана службы приложений необходимо интегрировать одну региональную виртуальную сеть. Все приложения в одном плане службы приложений могут использовать одну и ту же интеграцию виртуальной сети, но если для подключения к дополнительной виртуальной сети требуется приложение, необходимо создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому у клиентов есть прямой доступ.

Из-за особенностей работы этой технологии трафик, используемый с интеграцией виртуальной сети, не отображается в журналах потоков или наблюдателя NSG.  

## <a name="gateway-required-vnet-integration"></a>Интеграция виртуальной сети, требуемой шлюзом

Интеграция виртуальной сети, требуемая для шлюза, поддерживает подключение к виртуальной сети в другом регионе или классической виртуальной сети. Интеграция виртуальной сети, требуемой для шлюза: 

* Позволяет приложению подключаться только к одной виртуальной сети за раз
* Позволяет интегрировать до пяти виртуальных сетей в рамках плана службы приложений. 
* Позволяет использовать одну и ту же виртуальную сеть в нескольких приложениях в плане службы приложений, не влияя на общее число, которое может использоваться планом службы приложений.  Если у вас есть шесть приложений, использующих одну и ту же виртуальную сеть в одном плане службы приложений, это будет считать, что используется одна виртуальная сеть. 
* Поддерживает соглашение об уровне обслуживания 99,9% из-за соглашения об уровне обслуживания на шлюзе
* Позволяет приложениям использовать DNS, для которого настроена виртуальная сеть
* Для подключения к приложению требуется шлюз, основанный на маршрутах виртуальной сети, настроенный с помощью VPN-подключения типа "точка — сеть". 

Вы не можете использовать шлюз, необходимый для интеграции виртуальной сети:

* С приложениями Linux
* С виртуальной сетью, подключенной с помощью ExpressRoute 
* Доступ к защищенным ресурсам конечных точек службы
* С помощью шлюза сосуществования, поддерживающего виртуальные частные сети с подключением ExpressRoute и между сайтами и узлами.

### <a name="set-up-a-gateway-in-your-vnet"></a>Настройка шлюза в виртуальной сети ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. Укажите [адреса узлов в качестве точки][setp2saddresses]. Если шлюз не входит в базовый SKU, необходимо отключить IKEV2 в конфигурации "точка — сеть" и "SSTP". Адресное пространство "точка — сеть" должно находиться в блоках адресов RFC 1918, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

Если вы просто создаете шлюз для использования с интеграцией виртуальной сети службы приложений, вам не нужно отправлять сертификат. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно. 

### <a name="how-gateway-required-vnet-integration-works"></a>Как работает шлюз, необходимый для интеграции виртуальной сети

Для шлюза требуется интеграция виртуальной сети, построенная на основе технологии VPN типа "точка — сеть". VPN типа "точка — сеть" ограничивает сетевой доступ только к виртуальной машине, на которой размещается приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. Если в приложении настроен портал для использования интеграции виртуальной сети, необходимой для шлюза, для создания и назначения сертификатов на шлюзе и на стороне приложения будет использоваться комплексное согласование от вашего имени. Конечный результат заключается в том, что работники, используемые для размещения приложений, могут напрямую подключаться к шлюзу виртуальной сети в выбранной виртуальной сети. 

![Как работает шлюз, необходимый для интеграции виртуальной сети][6]

### <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам

Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". При использовании интеграции виртуальной сети, требуемой для шлюза, необходимо обновить локальные Маршруты VPN-шлюза с блоками адресов типа "точка — сеть". При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Вы не можете настроить BGP с VPN-подключением типа "сеть — сеть".

Для компонента интеграции региональной виртуальной сети и локальной сети не требуется дополнительная настройка. Вам нужно просто подключить виртуальную сеть к локальной сети с помощью ExpressRoute или VPN типа "сеть — сеть". 

> [!NOTE]
> Функция интеграции с виртуальной сетью, требуемой для шлюза, не интегрирует приложение с виртуальной сетью, имеющей шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex] , интеграция виртуальной сети не работает. Если вам требуется доступ к ресурсам через подключение ExpressRoute, можно использовать функцию интеграции с региональными виртуальными сетями или [Среда службы приложений][ASE], которая выполняется в виртуальной сети. 
> 
> 

### <a name="peering"></a>Пиринг

Если вы используете пиринг с региональной интеграцией виртуальной сети, вам не нужно выполнять дополнительную настройку. 

Если вы используете требуемую для шлюза интеграцию виртуальной сети с пирингом, необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите к разделу "План службы приложений" > "Сеть" > "Интеграция виртуальной сети" на портале.  Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены.  

## <a name="managing-vnet-integration"></a>Управление интеграцией виртуальной сети 

Подключение и отключение виртуальной сети осуществляется на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. На портале интеграции с виртуальной сетью > > приложений можно получить сведения о виртуальной сети. Аналогичные сведения можно просмотреть на уровне ASP на портале ASP > Networking > VNet Integration.

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение будет перезапущено. Виртуальная сеть не меняется при отключении. Подсеть или шлюз не удалены. Если вы хотите удалить виртуальную сеть, необходимо сначала отключить приложение от виртуальной сети и удалить в нем ресурсы, такие как шлюзы. 

В пользовательском интерфейсе интеграции виртуальной сети ASP будут показаны все интеграции виртуальной сети, используемые приложениями в вашей ASP. Чтобы просмотреть сведения о той или иной виртуальной сети, щелкните нужную сеть. Здесь можно выполнить два действия для интеграции виртуальной сети, необходимой для шлюза.

* **Синхронизировать сеть.** Операция синхронизации в сети предназначена только для компонента интеграции с виртуальной сетью, зависящей от шлюза. Выполнение операции синхронизации обеспечивает синхронизацию сертификатов и сведений о сети. При добавлении или изменении DNS виртуальной сети необходимо выполнить операцию **синхронизации сети** . Эта операция перезапустит все приложения, использующие эту виртуальную сеть.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть. 

Для **шлюза требуется маршрутизация интеграции виртуальной сети** Маршруты, определенные в виртуальной сети, используются для направления трафика в виртуальную сеть из приложения. Если вам нужно отправлять дополнительный исходящий трафик в виртуальную сеть, то вы можете добавить здесь соответствующие блоки адресов. Эта возможность работает только с обязательной интеграцией виртуальной сети. Таблицы маршрутов не влияют на трафик приложения при использовании интеграции виртуальной сети, необходимой для шлюза, так же, как и при интеграции с региональной виртуальной сетью.

**Сертификаты интеграции виртуальной сети, необходимые шлюзу** Если для шлюза требуется интеграция виртуальной сети, необходим обмен сертификатами для обеспечения безопасности соединения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.
Если сертификаты или сведения о сети изменились, нажмите "Синхронизировать сеть". Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="pricing-details"></a>Сведения о тарифах
Функция интеграции с региональными виртуальными сетями не взимается за пределы цены на услуги по ценовым категориям ASP.

Использование функции шлюза, необходимого для интеграции виртуальной сети, связано с тремя затратами.

* Плата за ценовую категорию ASP. ваши приложения должны быть в плане службы приложений уровня "Стандартный", "Премиум" или "категории премиум v2". Дополнительные сведения об этих затратах можно просмотреть здесь: [цены на службу приложений][ASPricing]. 
* Затраты на передачу данных — взимается плата за исходящие данные, даже если виртуальная сеть находится в том же центре обработки данных. Эти тарифы описаны в [Передача данных сведения о ценах][DataPricing]. 
* Расходы на VPN-шлюз. для шлюза виртуальной сети, который требуется для VPN типа "точка — сеть", взимается плата. Подробные сведения см. на странице [цен на VPN-шлюз][VNETPricing] .

## <a name="troubleshooting"></a>Диагностика

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="automation"></a>Автоматизация

Для интеграции региональной виртуальной сети предусмотрена поддержка интерфейса командной строки. Чтобы получить доступ к следующим командам, [установите Azure CLI][installCLI]. 

        az webapp vnet-integration --help

        Group
            az webapp vnet-integration : Methods that list, add, and remove virtual network integrations
            from a webapp.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            add    : Add a regional virtual network integration to a webapp.
            list   : List the virtual network integrations on a webapp.
            remove : Remove a regional virtual network integration from webapp.

        az appservice vnet-integration --help

        Group
            az appservice vnet-integration : A method that lists the virtual network integrations used in an
            appservice plan.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            list : List the virtual network integrations used in an appservice plan.

Для интеграции виртуальной сети, необходимой для шлюза, можно интегрировать службу приложений с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
[VNETRouteTables]: https://docs.microsoft.com/azure/virtual-network/manage-route-table/
[installCLI]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest/
