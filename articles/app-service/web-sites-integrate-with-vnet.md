---
title: Интеграция приложения с виртуальной сетью Azure (Служба приложений Azure)
description: В этой статье показано, как подключить приложение к новой или существующей виртуальной сети Azure.
services: app-service
documentationcenter: ''
author: ccompy
manager: stefsch
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/14/2019
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: b269c75be7fec55fb77afecc6d04b86266c74a6f
ms.sourcegitcommit: 72f1d1210980d2f75e490f879521bc73d76a17e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/14/2019
ms.locfileid: "67147306"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описывается функция интеграции виртуальных сетей службы приложений Azure и как настроить проверку подлинности с приложениями в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714). [Виртуальные сети Azure][VNETOverview] позволяют размещать многие ресурсы Azure в сети, недоступной из Интернета.  

Служба приложений Azure реализована в виде двух моделей. 

1. Мультитенантные системы с поддержкой всей линейки тарифных планов, кроме плана "Изолированный"
2. Службы среда приложений (ASE), которая развертывается в виртуальной сети и поддерживает ценовой категории плана приложения Isolated

В этом документе рассматривается две функции интеграции с виртуальной сетью, который предназначен для использования в мультитенантной службе приложений. Если приложение размещено в [среде службы приложений][ASEintro], то оно уже находится в виртуальной сети, а для доступа к ресурсам из этой сети не требуется использовать функцию интеграции. Сведения обо всех сетевых компонентов службы приложений. в статье [службы приложений, сетевые компоненты](networking-features.md)

Существует две формы для интеграции с виртуальной сетью

1. Одна версия обеспечивает интеграцию с виртуальными сетями в одном регионе. Эта форма функции требуется подсеть в виртуальной сети в одном регионе. Эта функция находится на стадии предварительной версии, но поддерживается для рабочих нагрузок приложений Windows с некоторыми оговорками указано ниже.
2. Другая версия поддерживает интеграцию с виртуальными сетями в других регионах или с классическими виртуальными сетями. Эта версия компонента требует развертывания шлюза виртуальной сети в виртуальной сети. Это средство на основе VPN между сайтами.

Приложения можно использовать одновременно только одну форму интеграции с виртуальной сетью. Возникает вопрос о том какие функции следует использовать. Можно использовать либо для разных задач. Очистить отличия хотя являются:

| Проблема  | Решение | 
|----------|----------|
| Хотите связаться с адреса RFC 1918 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) в одном регионе | Интеграция с региональной виртуальной сетью |
| Чтобы охватить классическую виртуальную сеть или виртуальную сеть в другом регионе | Шлюз требуется интеграция с виртуальной сетью |
| Чтобы охватить RFC 1918 конечные точки в ExpressRoute | Интеграция с региональной виртуальной сетью |
| Чтобы получить доступ к ресурсам через конечные точки службы | Интеграция с региональной виртуальной сетью |

Ни функция дает возможность взаимодействовать с требованиями RFC 1918 адреса через ExpressRoute. Для этого нужно использовать ASE сейчас.

С помощью интеграции региональной виртуальной сети не подключать виртуальную сеть к локальной или настройте конечные точки службы. Это отдельный конфигурацию сети. Интеграция региональной виртуальной сети просто позволяет приложению выполнять вызовы для этих типов подключений.

Независимо от версии, используемой интеграция с виртуальной сетью предоставляет вашей веб-приложению доступ к ресурсам в виртуальной сети, но не предоставляет закрытый доступ входящего трафика для веб-приложения из виртуальной сети. Доступ к частным сайтам подразумевает доступность приложения только из частной сети, например из виртуальной сети Azure. Интеграция виртуальной сети — только для внесения исходящих вызовов из приложения в виртуальную сеть. 

Интеграция с виртуальной сетью связана со следующими особенностями:

* требуется тарифный план "Стандартный", "Премиум" или "Премиум V2"; 
* поддерживает TCP и UDP;
* работает с приложениями службы приложений и приложений-функций

Функции, не поддерживаемые при интеграции с виртуальной сетью:

* подключение диска;
* интеграция с AD; 
* NetBios;

## <a name="regional-vnet-integration"></a>Интеграция с региональной виртуальной сетью 

При интеграции с виртуальной сетью используется с виртуальными сетями, в том же регионе, что и приложение, он требует использования делегированного подсети с по крайней мере 32 адреса в нем. Подсети не может использоваться для любых других. Исходящие вызовы из приложения будут выполняться адреса в делегированного подсети. При использовании этой версии интеграции с виртуальной сетью, вызовы выполняются с адресами в виртуальной сети. С помощью адресов в виртуальной сети позволяет приложению:

* вызывать конечную точку службы, защищенным службам
* доступ к ресурсам через подключения ExpressRoute
* доступ к ресурсам в виртуальной сети, вы подключены к
* доступ к ресурсам через пиринговые подключения, в том числе подключений ExpressRoute

Эта функция доступна в предварительной версии, но она поддерживается для производственных рабочих нагрузок приложения Windows со следующими ограничениями:

* можно подключиться только адреса, которые находятся в диапазоне RFC 1918. Это адресов 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 блоки адресов.
* не удается достичь ресурсы через глобальный пиринговых подключений
* Невозможно установить маршруты для трафика, поступающие из вашего приложения в виртуальной сети
* Эта функция доступна только из более новые единицы масштабирования службы приложений, которые поддерживают планов службы приложений категории премиум v2.
* Эта функция не может использоваться план изолированного приложения, работающие в среде службы приложений
* компоненту требуется неиспользуемые подсети с по крайней мере 32 адресов в виртуальной сети Resource Manager.
* Приложения и виртуальная сеть должны находиться в одном регионе.
* Один адрес используется для каждого экземпляра плана Службы приложений. Так как размер подсети невозможно изменить после назначения, используйте подсеть, которая может превышать максимальный размер масштабов. 32-разрядные адреса /27 являются рекомендуемым размером, так как они способны вместить план Службы приложений, который масштабируется до 20 экземпляров.
* Удалить виртуальную сеть с интегрированным приложением невозможно. Сначала необходимо удалить интеграцию 
* Может иметь только один язык интеграции с виртуальной сетью на план службы приложений. Несколько приложений в одном плане службы приложений можно использовать ту же виртуальную сеть. 

Функция доступна в предварительной версии также для Linux. Для использования интеграции с виртуальной сетью с виртуальной сетью Resource Manager, в том же регионе:

1. Откройте пользовательский интерфейс работы с сетями на портале. Если ваше приложение сможет использовать новую функцию, вы увидите параметр для добавления виртуальной сети (Предварительная версия).  

   ![Выберите интеграцию с виртуальной сетью][6]

1. Нажмите **Добавить виртуальную сеть (предварительная версия)** .  

1. Выберите нужную виртуальную сеть Resource Manager, а затем либо выберите пустую имеющуюся подсеть, либо создайте новую. Интеграция занимает меньше минуты. Во время интеграции приложение перезапускается.  По завершении интеграции вы увидите сведения об интегрированной виртуальной сети и баннер в верхней части страницы, указывающий, что это предварительная версия функции.

   ![Выбор виртуальной сети и подсети][7]

После вашего приложение интегрировано с вашей виртуальной сети, он будет использовать один и тот же сервер DNS, виртуальная сеть настроена с. 

Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. Веб-приложение будет перезапущено. 

Новая функция интеграции с виртуальной сетью позволяет использовать конечные точки служб.  Чтобы использовать конечные точки служб с приложением, воспользуйтесь новой функцией интеграции с виртуальной сетью, чтобы подключиться к выбранной виртуальной сети в подсети, которая использовалась для интеграции. 

#### <a name="web-app-for-containers"></a>Веб-приложение для контейнеров

При использовании службы приложений на платформе Linux со встроенными образами региональных интеграции с виртуальной сетью работают без дополнительных изменений. Если вы используете веб-приложения для контейнеров, необходимо изменить образ docker для использования интеграции с виртуальной сетью. В образе docker служит переменная среды PORT порт прослушивания основной веб сервера, вместо того чтобы использовать номер порта жестко закодирован. Переменная среды PORT автоматически назначит значение платформы службы приложений во время запуска контейнера.

### <a name="how-vnet-integration-works"></a>Как работает интеграция с виртуальной сетью

Приложения в службе приложений размещаются на рабочих ролях. Основные и более поздних версий, тарифных планах выделены планами размещения которых нет других клиентов рабочих нагрузок, выполняющихся на том же рабочих ролях. Интеграция виртуальной сети работает путем монтирования виртуальных интерфейсов с адресами в подсети делегированного. Так как из адрес находится в виртуальной сети, она имеет доступ для большинства задач или с помощью виртуальной сети так же как виртуальную Машину в виртуальной сети. Реализация сети отличается от запуска виртуальной Машины в виртуальной сети, и т. е почему некоторые сетевые функции еще не доступны при использовании этой функции.

![Интеграция виртуальной сети](media/web-sites-integrate-with-vnet/vnet-integration.png)

При включении интеграции с виртуальной сетью, приложение будет производить исходящих вызовов к Интернету через те же каналы в обычном режиме. Исходящие адреса, которые перечислены на портале свойства приложений по-прежнему являются адресами, используемых приложением. Каковы изменения для своего приложения, вызовы к конечной точке службы защищены служб или адресов RFC 1918 попадают в виртуальной сети. 

Эта функция поддерживает только один виртуальный интерфейс каждой рабочей роли.  Один виртуальный интерфейс каждой рабочей роли означает один язык интеграции с виртуальной сетью на план службы приложений. Все приложения в одном плане службы приложений можно использовать же интеграция с виртуальной сетью, но если вам требуется приложение для подключения к дополнительной виртуальной сети, необходимо создать другой план службы приложений. Виртуальный интерфейс, используемый не является ресурсом, который клиенты имеют прямой доступ к.

Из-за природы как работает эта технология трафик, который используется для интеграции с виртуальной сетью не отображается в журналах последовательностей наблюдателя за сетями или группы безопасности сети.  

## <a name="gateway-required-vnet-integration"></a>Шлюз требуется интеграция с виртуальной сетью 

Шлюз требуется интеграции с виртуальной сетью:

* можно использовать для подключения к виртуальным сетям в любом регионе, будь то Resource Manager или классических виртуальных сетей
* позволяет приложению для подключения к виртуальной сети только 1 за раз
* позволяет интегрировать с в рамках плана службы приложений до пяти виртуальных сетей 
* позволяет нескольким приложениям в рамках плана службы приложений без влияния на общее количество, который может использоваться с планом службы приложений использовать одну виртуальную сеть.  Если у вас есть 6 приложения, с помощью той же виртуальной сети в одном плане службы приложений, который считается одной виртуальной сети; используется. 
* требуется шлюза виртуальной сети с VPN сайта, выберите пункт
* Не поддерживается для использования с приложениями Linux
* Поддерживает соглашение об уровне ОБСЛУЖИВАНИЯ 99,9% благодаря использованию шлюза

Эта функция не поддерживает:

* доступ к ресурсам через ExpressRoute; 
* доступ к ресурсам через конечные точки служб. 

### <a name="getting-started"></a>Приступая к работе

Перед подключением веб-приложения к виртуальной сети обратите внимание на следующие моменты.

* Перед подключением к приложению в целевой виртуальной сети должна быть включена сеть VPN типа "точка — сеть" со шлюзом на основе маршрутов. 
* Виртуальная сеть должна относиться к той же подписке, что и план службы приложений (ASP).
* Приложения, которые интегрируются с виртуальной сетью, используют DNS-сервер, указанный для этой виртуальной сети.

### <a name="set-up-a-gateway-in-your-vnet"></a>Настройка шлюза в виртуальной сети ###

Если в шлюзе уже настроены адреса для подключения "точка — сеть", то настройку интеграции приложения с виртуальной сетью можно пропустить.  
Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Задайте адреса для подключения "точка — сеть"][setp2saddresses]. Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Адресное пространство должно быть в блоки адресов RFC 1918, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

Если пользователь только созданием шлюза для использования приложения службы интеграции с виртуальной сетью, затем не нужно отправить сертификат. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно. 

### <a name="configure-vnet-integration-with-your-app"></a>Настройка интеграции приложения с виртуальной сетью 

Включение интеграции приложения с виртуальной сетью: 

1. Перейдите к своему приложению на портале Azure, откройте параметры приложения и выберите пункты "Сеть" > "Интеграция виртуальной сети". ASP необходимо находиться в SKU "стандартный" или лучше использовать возможности интеграции с виртуальной сетью. 
 ![Пользовательский интерфейс интеграции с виртуальной сетью][1]

1. Выберите **Добавить виртуальную сеть**. 
 ![Добавление интеграции с виртуальной сетью][2]

1. Выберите виртуальную сеть. 
  ![Выбор виртуальной сети][8]
  
После последнего действия приложение будет перезапущено.  

### <a name="how-the-gateway-required-vnet-integration-feature-works"></a>Работает как шлюз требуется интеграции с виртуальной сетью

Шлюз необходимые интеграции с виртуальной сетью лежит технология VPN между сайтами. Технология "точка — сеть" разрешает доступ к сети только той виртуальной машине, в которой размещается приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. 

![Как работает интеграция с виртуальной сетью][3]

## <a name="managing-vnet-integration"></a>Управление интеграцией виртуальной сети
Возможность подключаться к виртуальной сети и отключаться от нее реализуется на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. В приложении > сеть > Интеграция виртуальной сети портала, можно получить сведения о виртуальной сети. Вы увидите аналогичные сведения на уровне ASP в ASP > сеть > Интеграция виртуальной сети портала, включая какие приложения в этом плане обслуживания приложений при использовании определенной интеграции.

 ![Сведения о виртуальной сети][4]

Сведения, доступные для вас в пользовательском Интерфейсе интеграции виртуальной сети одинаков порталах ASP и приложения.

* Имя виртуальной сети. Ссылки на пользовательский интерфейс виртуальной сети
* Расположение. Указывает расположение виртуальной сети. Интеграция с виртуальной сетью в другом расположении может вызывать проблемы с задержкой для приложения. 
* Состояние сертификата. Указывает, синхронизированы ли сертификаты между планом службы приложений и виртуальной сетью.
* Состояние шлюза — следует используется шлюз требуется интеграция с виртуальной сетью, можно просмотреть состояние шлюза.
* Адресное пространство виртуальной сети. Указывает IP-адреса, которые используются в виртуальной сети. 
* Адресное пространство "точка — сеть". Указывает IP-адреса, которые используются при подключении типа "точка — сеть" к виртуальной сети. При выполнении вызовов в виртуальную сеть при использовании шлюза обязательных компонентов, ваш адрес FROM приложения будет иметь одно из этих адресов. 
* Адресное пространство "сеть — сеть". VPN типа "сеть — сеть" можно использовать для подключения виртуальной сети к ресурсам в локальной сети или к другим виртуальным сетям. Здесь показаны диапазоны IP-адресов, определенные этим VPN-подключением.
* DNS-серверы. Указывает DNS-серверы, настроенные для виртуальной сети.
* IP-адреса, направляемые в виртуальную сеть. Блоки адресов, используемые для направления трафика в виртуальную сеть 

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение будет перезапущено. Виртуальная сеть не меняется при отключении. Подсети или шлюз не удаляется. Если вы хотите удалить виртуальную сеть, необходимо сначала отключить приложение от виртуальной сети и удалить ресурсы в ней, таких как шлюзы. 

Чтобы открыть пользовательский интерфейс интеграции ASP с виртуальной сетью, откройте пользовательский интерфейс ASP и выберите **Сеть**.  В разделе "Интеграция с виртуальной сетью" нажмите **Щелкните здесь для настройки**, чтобы открыть пользовательский интерфейс состояния функций сети.

![Сведения об интеграции ASP с виртуальной сетью][5]

В пользовательском интерфейсе интеграции ASP с виртуальной сетью отображаются все виртуальные сети, используемые приложениями в ASP. Чтобы просмотреть сведения о той или иной виртуальной сети, щелкните нужную сеть. Здесь можно выполнить два действия.

* **Синхронизировать сеть.** Операция синхронизации сети предназначен только для зависимого компонента интеграции виртуальной сети шлюза. Выполняет операцию синхронизации сети гарантирует, что сертификаты и сведения о сети находятся в синхронизированном. Если вы добавите или измените DNS виртуальной сети, то необходимо выполнить операцию **Синхронизировать сеть**. Эта операция перезапустит все приложения, использующие эту виртуальную сеть.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть.

**Маршрутизация.** Маршруты, определенные в виртуальной сети, используемые для направления трафика в виртуальную сеть из вашего приложения. Если вам нужно отправлять дополнительный исходящий трафик в виртуальную сеть, то вы можете добавить здесь соответствующие блоки адресов. Функция работает только с помощью шлюза требуется интеграция с виртуальной сетью.

**Сертификаты** шлюз необходимую включена Интеграция виртуальной сети, имеется обязательный обмен сертификатами для обеспечения безопасности подключения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.
Если сертификаты или сведения о сети изменились, нажмите "Синхронизировать сеть". Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам
Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". Если вы используете шлюз требуется интеграция с виртуальной сетью, необходимо обновить свои маршруты шлюза VPN локальной с вашей блоки адресов между сайтами. При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Не может иметь BGP с VPN-подключение сайт сайт.

Нет каких-либо дополнительных настроек для региональных функции интеграции виртуальной сети для доступа через виртуальную сеть, а также к локальной. Необходимо просто для подключения к локальной виртуальной сети с помощью ExpressRoute или VPN-Подключение сайт сайт. 

> [!NOTE]
> Шлюз необходимые интеграции с виртуальной сетью не интеграция приложения с сетью, в которой установлен шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex], функция интеграции c виртуальной сетью работать не будет. Если вам требуется доступ к ресурсам через соединение ExpressRoute, то можно использовать функцию региональных интеграции виртуальной сети или [среды службы приложений][ASE], которая работает в вашей сети. 
> 
> 

## <a name="peering"></a>Пиринг
Если вы используете, пиринг с региональной Интеграция виртуальной сети, вы не обязательно должны выполнять дополнительную настройку. 

Если вы используете шлюз требуется интеграция с виртуальной сетью с пирингом, необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите к разделу "План службы приложений" > "Сеть" > "Интеграция виртуальной сети" на портале.  Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены.  


## <a name="pricing-details"></a>Сведения о тарифах
Функцию региональных интеграции виртуальной сети имеет отсутствие дополнительной платы за использование за пределами ценовой категории расходов на уровне плана ASP.

Существует три связанные расходы на использование функции интеграции с виртуальной сетью требуется шлюз.

* Ценовой категории уровня издержки ASP - приложения должны находиться в Standard, Premium или план службы приложений категории премиум v2. Дополнительные сведения о ценах на планы см. на странице [цен на Службу приложений][ASPricing]. 
* Стоимость передачи данных — здесь — это плата за исходящие данные, даже если виртуальная сеть находится в одном центре обработки данных. Эти тарифы описаны в [сведениях о ценах за передачу данных][DataPricing]. 
* Затраты на VPN-шлюз — там оплачивается шлюза виртуальной сети, которая необходима для VPN-Подключение между сайтами. Подробные сведения представлены на странице [Цены на VPN-шлюзы][VNETPricing].


## <a name="troubleshooting"></a>Устранение неполадок
Простота настройки этой функции не гарантирует отсутствия проблем при ее использовании. При проблемах с доступом к нужной конечной точке можно воспользоваться некоторыми служебными программами для проверки подключения из консоли приложения. Вы можете использовать две консоли: консоль Kudu и консоль на портале Azure. Чтобы открыть консоль Kudu из приложения, выберите пункты "Сервис" -> "Kudu". Этот же интерфейс доступен по адресу [имя_сайта].scm.azurewebsites.net. В консоли перейдите на вкладку "Отладка". Чтобы воспользоваться консолью на портале Azure, откройте меню «Сервис» -> «Консоль». 

#### <a name="tools"></a>Средства
Приложения **ping**, **nslookup** и **tracert** нельзя использовать в консоли из-за ограничений безопасности. Чтобы компенсировать это, добавлены два других средства. Для проверки работоспособности DNS мы добавили средство nameresolver.exe. Синтаксис:

    nameresolver.exe hostname [optional: DNS Server]

Для проверки имен узлов, которые использует ваше приложение, можно использовать команду **nameresolver**. Так вы сможете обнаружить ошибки в настройке DNS-сервера или проблемы с доступом к DNS-серверу. Вы увидите DNS-сервер, который будет использовать приложение в консоли, просмотрев WEBSITE_DNS_SERVER и WEBSITE_DNS_ALT_SERVER переменные среды.

Следующее средство позволяет проверить подключение к комбинации «узел:порт» по протоколу TCP. Этот инструмент называется **tcpping.exe** и использует следующий синтаксис.

    tcpping.exe hostname [optional: port]

Служебная программа **tcpping** сообщает, возможно ли получить доступ к определенному узлу и порту. Сообщение об успешном выполнении отображается только с том случае, когда приложение ожидает передачи данных от комбинации "узел:порт", а также есть доступ по сети из приложения к указанным узлу и порту.

#### <a name="debugging-access-to-vnet-hosted-resources"></a>Доступ к ресурсам виртуальной сети для отладки
У приложения могут возникнуть проблемы с доступом к определенной комбинации «узел:порт». Это происходит по многим причинам. Вот три наиболее распространенные причины:

* **Брандмауэр блокирует доступ.** Если вы используете брандмауэр, может быть превышено время ожидания TCP. В нашем случае это 21 секунда. Проверьте подключение с помощью средства **tcpping**. Время ожидания TCP может превышаться и по многим другим причинам, но начать стоит именно с этой. 
* **Служба DNS недоступна.** Время ожидания для DNS составляет три секунды на каждый DNS-сервер. Если у вас два DNS-сервера, то время ожидания составляет 6 секунд. Используйте средство nameresolver для проверки работы DNS. Помните, что средство nslookup не подходит для проверки, так как оно игнорирует настройки DNS для виртуальной сети. Если этот параметр недоступен, имеется брандмауэр или NSG блокирования доступа к DNS или она может быть недоступен.

Если эти рекомендации не помогут вашей проблемы, проверьте еще таких вещей, как: 

**Интеграция с региональной виртуальной сетью**
* – Это адреса RFC 1918
* есть ли группы безопасности сети блокировки исходящий трафик из подсети интеграции
* Если будут подключены через ExpressRoute или VPN-Подключение, шлюз локальной настроен для маршрутизации трафика резервного копирования Azure? Если вы можете связаться конечных точек в вашей виртуальной сети, но не локально, это удобно для проверки.

**Шлюз требуется интеграция с виртуальной сетью**
* диапазон адресов между сайтами в диапазонах RFC 1918 (10.0.0.0–10.255.255.255 / 172.16.0.0–172.31.255.255 / 192.168.0.0–192.168.255.255)?
* Отображается ли на портале шлюз в рабочем состоянии? Если шлюз не работает, восстановите его работоспособность.
* Больше сертификатов, показывать синхронизированы или вы подозреваете, что конфигурация сети было изменено?  Если сертификаты не синхронизированы или подозрение, что было изменение, внесенное в конфигурацию виртуальной сети, который не был синхронизирован с вашей страницы ASP, затем нажмите «Синхронизировать сеть».
* Если будут подключены через ExpressRoute или VPN-Подключение, шлюз локальной настроен для маршрутизации трафика резервного копирования Azure? Если вы можете связаться конечных точек в вашей виртуальной сети, но не локально, это удобно для проверки.

Отладка сетевых проблем является сложной задачей, поскольку здесь нельзя просмотреть, что блокирует доступ к сочетания узел: порт. Ниже представлено несколько возможных причин этой проблемы.

* На нужном узле запущен брандмауэр, который блокирует доступ к порту приложения для диапазона IP-адресов "точка — сеть". Для подключения между подсетями часто требуется разрешить общий доступ.
* Целевой узел не работает.
* Целевое приложение не работает.
* Указан неверный IP-адрес или неверное имя узла.
* Приложение ожидает передачи данных не по тому порту, который предполагается. Вы можете сопоставить ИД процесса с портом прослушивания при помощи команды "netstat -aon" в узле конечной точки. 
* Группы безопасности сети настроены на блокирование доступа к узлу и порту приложения для диапазона IP-адресов «точка-сеть».

Помните, что вы не знаете, какой адрес, фактически будет использовать приложение. Это может быть любой адрес в интеграции точка сеть или подсети диапазон адресов, поэтому вам нужно разрешить доступ из весь диапазон адресов. 

Можно выполнить дополнительные действия по отладке.

* Войдите на другую виртуальную машину в этой виртуальной сети и попробуйте из нее обратиться к нужной комбинации "узел:порт". Чтобы проверить доступ TCP, используйте команду PowerShell **test-netconnection**. Синтаксис:

      test-netconnection hostname [optional: -Port]

* Откройте приложение на виртуальной Машине и тестирование доступа к этому узлу и порт в консоль из приложения с помощью **tcpping**

#### <a name="on-premises-resources"></a>Локальные ресурсы ####

Если приложение не может перейти к ресурсу локально, проверьте, можно ли перейти к ней через виртуальную сеть. Чтобы проверить доступ по протоколу TCP, используйте команду PowerShell **test-netconnection**. Если ВМ не удается подключиться к локальному ресурсу, подключение VPN или ExpressRoute может настроено неправильно.

Если размещенная в виртуальной сети виртуальная машина может взаимодействовать с локальной системой, а приложение — нет, это может быть вызвано одной из следующих причин:

* маршрутов не настроены с подсетью или укажите диапазоны адресов сайта в ваш локальный шлюз
* ваши группы безопасности сети блокируют доступ к диапазону IP-адресов подключений "точка — сеть";
* локальные брандмауэры блокируют трафик из диапазона IP-адресов подключений "точка — сеть";
* Вы пытаетесь обратиться по адресу RFC 1918, региональной виртуальной сети с помощью интеграции с


## <a name="powershell-automation"></a>Автоматизация PowerShell

Службу приложений можно интегрировать с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-details.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-aspdetails.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-newvnet.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-newvnetdetails.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-selectvnet.png

<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ASEintro]: environment/intro.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#gatewaysubnet
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
