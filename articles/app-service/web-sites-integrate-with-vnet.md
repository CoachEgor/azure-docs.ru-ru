---
title: Интеграция приложений с виртуальной сетью Azure
description: Интеграция приложений в службу приложений Azure с виртуальными сетями Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 02/27/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: a1a9739c444db2e41d55b8876011c066f2e71ca3
ms.sourcegitcommit: 7581df526837b1484de136cf6ae1560c21bf7e73
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2020
ms.locfileid: "80421375"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure

В этой статье описывается функция интеграции службы приложений Azure VNet и способы ее настройки с помощью приложений в [Службе приложений Azure.](https://go.microsoft.com/fwlink/?LinkId=529714) С [помощью виртуальной сети Azure][VNETOverview]вы можете разместить многие ресурсы Azure в сети, не связанные с интернет-роут.

Служба приложений Azure имеет два варианта:

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

## <a name="enable-vnet-integration"></a>Включить интеграцию VNet

1. Перейдите на **веб-ум сетевого** взаимодействия на портале App Service. В **рамках интеграции VNet**выберите **Нажмите здесь, чтобы настроить.**

1. Выберите **Добавить виртуальную сеть**.

   ![Выберите интеграцию VNet][1]

1. Список выпадающих средств содержит все виртуальные сети Azure Resource Manager в подписке в одном регионе. Под ним находится список виртуальных сетей Resource Manager во всех других регионах. Выберите виртуальную сеть, с помощью которых вы хотите интегрироваться.

   ![Выберите виртуальную сеть][2]

   * Если виртуальная сеть находится в одном регионе, либо создайте новую подсеть, либо выберите пустую уже существующую подсеть.
   * Чтобы выбрать виртуальную сеть в другом регионе, необходимо иметь шлюз виртуальной сети, подготовленный с включенной точкой сайта.
   * Чтобы интегрироваться с классической виртуальной сетью, вместо того, чтобы выбрать список выпадающих сетей **виртуальной сети,** выберите **Нажмите здесь, чтобы подключиться к классическому VNet.** Выберите классическую виртуальную сеть, которая вам нужна. Целевая виртуальная сеть уже должна иметь шлюз виртуальной сети, подготовленный с включенным пунктом к сайту.

    ![Выберите Классический VNet][3]

Во время интеграции приложение перезапускается. Когда интеграция будет завершена, вы увидите подробную информацию о виртуальной сети, с вами интегрирована.

После того, как ваше приложение интегрировано с виртуальной сетью, оно использует тот же DNS-сервер, с которым настроена ваша виртуальная сеть, если только это не частные зоны Azure DNS. В настоящее время вы не можете использовать интеграцию VNet с частными зонами Azure DNS.

## <a name="regional-vnet-integration"></a>Региональная интеграция VNet

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

### <a name="how-regional-vnet-integration-works"></a>Как работает региональная интеграция VNet

Приложения в Службе приложений размещаются на ролях работников. Основные и более высокие тарифные планы посвящены хостинг-планам, где нет рабочих нагрузок других клиентов, работающих на тех же работниках. Региональная интеграция VNet работает путем установки виртуальных интерфейсов с адресами в делегированной подсети. Поскольку адрес находится в вашей виртуальной сети, он может получить доступ к большинству вещей в или через вашу виртуальную сеть, как VM в вашей виртуальной сети будет. Реализация сети отличается от запуска VM в виртуальной сети. Вот почему некоторые сетевые функции еще не доступны для этой функции.

![Как работает региональная интеграция VNet][5]

Когда региональная интеграция VNet включена, ваше приложение делает исходящие звонки в Интернет по тем же каналам, что и обычно. Исходящие адреса, перечисленные на портале свойств приложений, являются адресами, которые по-прежнему используются вашим приложением. Что изменится в приложении, так это вызовы в службу услуг безопасности, или адреса RFC 1918 входят в вашу виртуальную сеть. Если WEBSITE_VNET_ROUTE_ALL установлен на 1, весь исходящий трафик может быть отправлен в виртуальную сеть.

Функция поддерживает только один виртуальный интерфейс на одного работника. Один виртуальный интерфейс на одного работника означает одну региональную интеграцию VNet в план службы приложений. Все приложения в одном и том же плане Службы приложений могут использовать одну и ту же интеграцию VNet. Если вам нужно приложение для подключения к дополнительной виртуальной сети, необходимо создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому клиенты имеют прямой доступ.

Из-за характера работы этой технологии трафик, используемый в интеграции VNet, не отображается в журналах Azure Network Watcher или NSG.

## <a name="gateway-required-vnet-integration"></a>Интеграция VNet, необходимая для шлюза

Интеграция VNet, необходимая для gateway, поддерживает подключение к виртуальной сети в другом регионе или к классической виртуальной сети. Интеграция VNet, необходимая для шлюза:

* Позволяет приложению подключаться только к одной виртуальной сети одновременно.
* Позволяет интегрировать до пяти виртуальных сетей в план Службы приложений.
* Позволяет использовать одну и ту же виртуальную сеть несколькими приложениями в плане Службы приложений, не влияя на общее число, которое может быть использовано в плане Службы Приложения. Если у вас есть шесть приложений, использующих ту же виртуальную сеть в том же плане Службы Приложений, это считается одной виртуальной сетью, используемой.
* Поддерживает 99,9% SLA из-за SLA на шлюзе.
* Позволяет вашим приложениям использовать DNS, с которым настроена виртуальная сеть.
* Требуется шлюз на основе маршрутов виртуальной сети, настроенный с VPN от SSTP от точки к сайту, прежде чем он может быть подключен к приложению.

Вы не можете использовать интеграцию VNet, требуемую шлюзом:

* С приложениями Linux.
* С виртуальной сетью, подключенной к Azure ExpressRoute.
* Для доступа к конечным ресурсам службы обеспеченные ресурсы.
* С шлюзом сосуществования, который поддерживает как ExpressRoute, так и от точки к сайту или от места к сайту VPN.

### <a name="set-up-a-gateway-in-your-virtual-network"></a>Настройка шлюза в виртуальной сети ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Установите адреса точек на сайт.][setp2saddresses] Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Адресное пространство от точки к месту должно находиться в адресных блоках RFC 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Если вы создаете шлюз для использования с интеграцией App Service VNet, вам не нужно загружать сертификат. Создание шлюза может занять 30 минут. Вы не сможете интегрировать приложение с виртуальной сетью до тех пор, пока шлюз не будет подготовлен.

### <a name="how-gateway-required-vnet-integration-works"></a>Как работает интеграция VNet, необходимая для шлюза

Интеграция VNet, необходимая для gateway, построена на основе технологии VPN от точки к сайту. VPN от точки к месту ограничивают доступ к сети к виртуальной машине, которая размещает приложение. Приложения ограничены для отправки трафика в Интернет только через гибридные соединения или через интеграцию VNet. Когда приложение настроено на портал для использования требуемой шлюзом интеграции VNet, от вашего имени удается создавать и назначать сертификаты на шлюзе и стороне приложения. В результате работники, используемые для размещения ваших приложений, могут напрямую подключаться к виртуальному сетевому шлюзу в выбранной виртуальной сети.

![Как работает интеграция VNet, необходимая для шлюза][6]

### <a name="access-on-premises-resources"></a>Доступ к ресурсам на месте

Приложения могут получить доступ к местным ресурсам путем интеграции с виртуальными сетями, которые имеют соединения от места к сайту. Если вы используете интеграцию VNet, требуя шлюза, обновите маршруты VPN-шлюза с помощью адресных блоков точек.ru. При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Подробная информация о том, как это сделать, различаются в шлюзе и не описаны здесь. Вы не можете настроить BGP с VPN-соединением от сайта к сайту.

Дополнительная конфигурация не требуется для того, чтобы региональная функция интеграции VNet через виртуальную сеть достигла ресурсов. Вам просто необходимо подключить виртуальную сеть к местным ресурсам с помощью ExpressRoute или VPN-сайта.

> [!NOTE]
> Функция интеграции VNet, требуя шлюза, не интегрирует приложение с виртуальной сетью с шлюзом ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования,][VPNERCoex]интеграция VNet не работает. Если вам необходимо получить доступ к ресурсам через соединение ExpressRoute, используйте региональную функцию интеграции VNet или [среду службы приложений,][ASE]которая работает в вашей виртуальной сети.
> 
> 

### <a name="peering"></a>Пиринг

Если вы используете вонючую с региональной интеграцией VNet, вам не нужно делать какую-либо дополнительную конфигурацию.

Если вы используете интеграцию VNet, требующую шлюза, с помощью пиринга, необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте ввиртуальную сеть, к ней подключается приложение. При добавлении однорангового соединения включите **виртуальный доступ к сети** и выберите **Разрешить переадресованный трафик** и разрешить транзит **шлюза.**
1. Добавьте в виртуальную сеть одноранговое соединение, которое внастояще ездовелось в виртуальную сеть, к которую вы подключены. При добавлении вонючения в виртуальную сеть назначения, **включить Разрешить виртуальный доступ к сети** и выберите Разрешить **пересылённый трафик** и разрешить **удаленные шлюзы.**
1. Перейдите к **плану** > App Service**Networking** > **VNet Integration** UI на портале. Выберите виртуальную сеть, к ней подключается приложение. Под разделом «Трассирование» добавьте адресный диапазон виртуальной сети, в которую подключена виртуальная сеть, к которым подключено приложение.

## <a name="manage-vnet-integration"></a>Управление интеграцией VNet

Подключение и отключение с виртуальной сетью находится на уровне приложения. Операции, которые могут повлиять на интеграцию VNet в нескольких приложениях, находятся на уровне плана Службы Приложения. С > портала **сетевой** > **интеграции VNet** вы можете получить подробную информацию о вашей виртуальной сети. Аналогичную информацию можно увидеть на уровне плана App Service на портале**интеграции** >  **Сетевого** > **VNet.**

Единственная операция, которая может быть проведена в представлении приложения в экземпляре интеграции VNet, заключается в отключении приложения от виртуальной сети, к ней в настоящее время подключено. Чтобы отключить приложение от виртуальной сети, выберите **Отключение.** Приложение перезапускается при отключении от виртуальной сети. Отключение не меняет виртуальную сеть. Подсеть или шлюз не удаляется. Если вы хотите удалить виртуальную сеть, сначала отключите приложение от виртуальной сети и удалите ресурсы в ней, такие как шлюзы.

План Службы приложений VNet Integration UI показывает вам все виртуальные сетевые интеграции, используемые приложениями в плане службы приложений. Чтобы увидеть подробную информацию о каждой виртуальной сети, выберите интересуемые вам виртуальные сети. Есть два действия, которые вы можете выполнить здесь для интеграции VNet, необходимой для шлюза:

* **Сеть синхронизации:** Операция сети синхронизации используется только для функции интеграции VNet, зависящей от шлюза. Выполнение операции сети синхронизации гарантирует синхронизацию сертификатов и сетевой информации. Если вы добавляете или изменяете DNS вашей виртуальной сети, выполните операцию сети синхронизации. Эта операция перезапускает любые приложения, которые используют эту виртуальную сеть.
* **Добавление маршрутов**: Добавление маршрутов приводит к выходу трафика в виртуальную сеть.

### <a name="gateway-required-vnet-integration-routing"></a>Требуемая шлюза VNet Интеграция разгрома
Маршруты, определяемые в виртуальной сети, используются для направления трафика в виртуальную сеть из приложения. Чтобы отправить дополнительный исходящий трафик в виртуальную сеть, добавьте эти адресные блоки здесь. Эта возможность работает только с интеграцией VNet, необходимой для шлюза. Таблицы маршрутов не влияют на трафик приложения, когда вы используете интеграцию VNet, требуемую шлюзом, так, как они делают с региональной интеграцией VNet.

### <a name="gateway-required-vnet-integration-certificates"></a>Обязательные сертификаты интеграции VNet, необходимые для шлюза
При включении интеграции VNet, необходимой для подключения к шлюзу, для обеспечения безопасности соединения необходим обмен сертификатами. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.

Если сертификаты или сетевая информация изменены, выберите **Sync Network**. При выборе **Sync Network**вы вызываете кратковременное сбой в подключении между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности.

## <a name="pricing-details"></a>Сведения о тарифах
Региональная функция интеграции VNet не взимает дополнительную плату за использование за пределами платы за повышение уровня ценообразования в тарифном уровне службы App Service.

Три заряда связаны с использованием требуемой для шлюза функции интеграции VNet:

* **Плата за повышение ценового уровня App Service:** Ваши приложения должны быть в стандартном, премиум-плане или сервисе PremiumV2. Для получения дополнительной информации [App Service pricing][ASPricing]об этих расходах см.
* **Затраты на передачу данных:** За выход данных взимается плата, даже если виртуальная сеть находится в том же центре обработки данных. Эти сборы описаны в [деталях ценообразования Data Transfer.][DataPricing]
* **VPN шлюз расходы**: Там в стоимость виртуальной сети шлюз, который требуется для точки к сайту VPN. Для получения дополнительной информации, см [VPN цены шлюза][VNETPricing].

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="automation"></a>Служба автоматизации

Поддержка CLI доступна для региональной интеграции VNet. Чтобы получить доступ к следующим командам, [установите Azure CLI.][installCLI]

        az webapp vnet-integration --help

        Group
            az webapp vnet-integration : Methods that list, add, and remove virtual network integrations
            from a webapp.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            add    : Add a regional virtual network integration to a webapp.
            list   : List the virtual network integrations on a webapp.
            remove : Remove a regional virtual network integration from webapp.

        az appservice vnet-integration --help

        Group
            az appservice vnet-integration : A method that lists the virtual network integrations used in an
            appservice plan.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            list : List the virtual network integrations used in an appservice plan.

Для интеграции VNet, необходимой для шлюза, вы можете интегрировать службу приложений с виртуальной сетью Azure с помощью PowerShell. Для готового к запуску скрипта [см. Подключите приложение в службе приложений Azure к виртуальной сети Azure.](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3)


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
[VNETRouteTables]: https://docs.microsoft.com/azure/virtual-network/manage-route-table/
[installCLI]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest/
