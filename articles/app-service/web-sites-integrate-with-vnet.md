---
title: Интеграция приложения с виртуальной сетью Azure
description: Интегрируйте приложения в службе приложений Azure с помощью виртуальных сетей Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 02/27/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 76139716fe11536faa0ff792185ba1643801c641
ms.sourcegitcommit: 96dc60c7eb4f210cacc78de88c9527f302f141a9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2020
ms.locfileid: "77649076"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описывается функция интеграции виртуальной сети в службе приложений Azure и ее настройка с помощью приложений в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714). [Виртуальные сети Azure][VNETOverview] (виртуальных сетей) позволяют разместить многие ресурсы Azure в сети, не поддерживающей маршрутизацию в Интернете.  

Служба приложений Azure имеет два варианта. 

1. Мультитенантные системы с поддержкой всей линейки тарифных планов, кроме плана "Изолированный"
2. Среда службы приложений (ASE), который развертывается в виртуальной сети и поддерживает приложения с планом расчета цен

Этот документ проходит через функцию интеграции с виртуальной сетью, которая предназначена для использования в многоклиентской службе приложений. Если приложение находится в [Среда службы приложений][ASEintro], оно уже находится в виртуальной сети и не требует использования функции интеграции с виртуальной сетью для доступа к ресурсам в той же виртуальной сети. Дополнительные сведения о всех сетевых компонентах службы приложений см. в статье [сетевые функции службы приложений](networking-features.md) .

Интеграция с виртуальной сетью предоставляет веб-приложению доступ к ресурсам в виртуальной сети, но не предоставляет к ней доступ в качестве входящего частного доступа к веб-приложению. Доступ к частным сайтам подразумевает доступность приложения только из частной сети, например из виртуальной сети Azure. Интеграция виртуальной сети предназначена только для исходящих вызовов из приложения в виртуальную сеть. Функция интеграции с виртуальной сетью ведет себя иначе при использовании с виртуальных сетей в том же регионе и с виртуальных сетей в других регионах. Функция интеграции с виртуальной сетью имеет два варианта.

1. Интеграция региональной виртуальной сети. при подключении к диспетчер ресурсов виртуальных сетей в том же регионе необходимо иметь выделенную подсеть в виртуальной сети, с которой выполняется интеграция. 
2. Интеграция виртуальной сети, требуемая для шлюза. при подключении к виртуальных сетей в других регионах или к классической виртуальной сети в том же регионе необходим шлюз виртуальной сети, подготовленный в целевой виртуальной сети.

Функции интеграции с виртуальной сетью:

* требовать план ценообразования "Стандартный", "Премиум", категории премиум v2 или эластичный Premium 
* поддержка TCP и UDP
* Работа с приложениями службы приложений и приложениями функций

Функции, не поддерживаемые при интеграции с виртуальной сетью:

* подключение диска;
* интеграция с AD; 
* NetBios;

Интеграция виртуальной сети, требуемой для шлюза, предоставляет доступ только к ресурсам в целевой виртуальной сети или сетям, подключенным к целевой виртуальной сети с помощью пиринга или VPN. Интеграция виртуальной сети, требуемая для шлюза, не обеспечивает доступ к ресурсам, доступным через подключения ExpressRoute, или работает с конечными точками службы. 

Независимо от используемой версии, интеграция виртуальной сети позволяет веб-приложению получать доступ к ресурсам в вашей виртуальном сетевом режиме, но не предоставляет в виртуальной сети входящий частный доступ к веб-приложению. Доступ к частным сайтам подразумевает доступность приложения только из частной сети, например из виртуальной сети Azure. Интеграция виртуальной сети предназначена только для исходящих вызовов из приложения в виртуальную сеть. 

## <a name="enable-vnet-integration"></a>Включение интеграции с виртуальной сетью 

1. Перейдите к пользовательскому интерфейсу сети на портале службы приложений. В разделе Интеграция виртуальной сети выберите *пункт "щелкните здесь, чтобы настроить"* . 

1. Выберите **Добавить виртуальную сеть**.  

   ![Выбор интеграции с виртуальной сетью][1]

1. В раскрывающемся списке будут содержаться все диспетчер ресурсов виртуальных сетей в подписке в том же регионе, а ниже — список всех диспетчер ресурсов виртуальных сетей во всех других регионах. Выберите виртуальную сеть, с которой требуется выполнить интеграцию.

   ![Выберите виртуальную сеть][2]

   * Если виртуальная сеть находится в том же регионе, создайте новую подсеть или выберите пустую уже существующую подсеть. 

   * Чтобы выбрать виртуальную сеть в другом регионе, необходимо подготовить шлюз виртуальной сети с включенным параметром "точка — сеть".

   * Чтобы выполнить интеграцию с классической виртуальной сетью, вместо того чтобы щелкнуть раскрывающийся список виртуальная сеть, выберите **щелкните здесь, чтобы подключиться к классической виртуальной сети**. Выберите нужную классическую виртуальную сеть. В целевой виртуальной сети уже должен быть подготовлен шлюз виртуальной сети с включенным параметром "точка — сеть".

    ![Выбор классической виртуальной сети][3]
    
Во время интеграции приложение перезапускается.  После завершения интеграции вы увидите сведения о виртуальной сети, с которой вы интегрируетесь. 

После интеграции приложения с виртуальной сетью он будет использовать тот же DNS-сервер, с которым настроена виртуальная сеть, если только это не Частные зоны Azure DNS. Сейчас невозможно использовать интеграцию с виртуальной сетью с Частные зоны Azure DNS.

## <a name="regional-vnet-integration"></a>Интеграция региональной виртуальной сети

Использование региональной интеграции виртуальной сети позволяет приложению получить доступ к следующим данным:

* ресурсы в виртуальной сети в том же регионе, который интегрируется с 
* ресурсы в виртуальных сетей, подключенные к виртуальной сети в одном регионе
* защищенные службы конечной точки службы
* ресурсы для подключений ExpressRoute
* ресурсы в виртуальной сети, к которым вы подключены
* ресурсы по одноранговым соединениям, включая подключения ExpressRoute
* Частные конечные точки 

При использовании интеграции с виртуальной сетью с виртуальных сетей в том же регионе можно использовать следующие сетевые функции Azure:

* Группы безопасности сети (группы безопасности сети) — можно блокировать исходящий трафик с помощью группы безопасности сети, размещенной в подсети интеграции. Правила для входящих подключений не применяются, так как вы не можете использовать интеграцию с виртуальной сетью для предоставления входящего доступа к веб-приложению.
* Таблицы маршрутов (определяемые пользователем маршруты) — можно поместить таблицу маршрутов в подсеть интеграции для отправки исходящего трафика. 

По умолчанию приложение будет маршрутизировать трафик АДРЕСНЫЕ пространства RFC1918 в виртуальную сеть. Если вы хотите направить весь исходящий трафик в виртуальную сеть, примените параметр приложения WEBSITE_VNET_ROUTE_ALL к приложению. Чтобы настроить параметр приложения, выполните следующие действия.

1. Перейдите в пользовательский интерфейс настройки на портале приложения. Выбор **параметра "создать приложение** "
1. Введите **WEBSITE_VNET_ROUTE_ALL** в поле имя и **1** в поле значение.

   ![Укажите параметр приложения][4]

1. Нажмите кнопку **ОК**.
1. Нажмите кнопку **Сохранить**.

Если вы направите весь исходящий трафик в виртуальную сеть, он будет подвергаться группы безопасности сети и определяемые пользователем маршруты, которые применяются к подсети интеграции. При маршрутизации всего исходящего трафика в виртуальную сеть исходящие адреса будут по-прежнему являться исходящими адресами, перечисленными в свойствах вашего приложения, если только вы не укажите маршруты для отправки трафика в другое место. 

Существуют некоторые ограничения при использовании интеграции с виртуальной сетью с виртуальных сетей в одном регионе:

* Не удается получить доступ к ресурсам по глобальным одноранговым соединениям
* Эта функция доступна только в новых единицах масштабирования службы приложений, поддерживающих планы службы приложений категории премиум v2.
* Подсеть интеграции может использоваться только одним планом службы приложений.
* Эта функция не может использоваться приложениями изолированного плана, которые находятся в Среда службы приложений
* Для этой функции требуется неиспользуемая подсеть a/27 с 32 адресами или большим размером в диспетчер ресурсов виртуальной сети.
* Приложения и виртуальная сеть должны находиться в одном регионе.
* Удалить виртуальную сеть с интегрированным приложением невозможно. Удалите интеграцию перед удалением виртуальной сети. 
* Интегрировать с виртуальных сетей можно только в той же подписке, что и веб-приложение
* Можно использовать только одну региональную интеграцию с виртуальной сетью на один план службы приложений. Несколько приложений в одном плане службы приложений могут использовать одну и ту же виртуальную сеть. 
* Вы не можете изменить подписку приложения или план службы приложений, пока есть приложение, использующее интеграцию с региональной виртуальной сетью.

Один адрес используется для каждого экземпляра плана Службы приложений. При масштабировании приложения до пяти экземпляров используется пять адресов. Так как размер подсети нельзя изменить после назначения, необходимо использовать подсеть, которая достаточно велика для размещения любого масштаба, к которому может получить доступ приложение. Рекомендуемый размер — A/26 с 64 адресами. A/26 с 64 адресами будет соответствовать план службы приложений уровня "Премиум" с 30 экземплярами. При масштабировании плана службы приложений в течение короткого периода времени требуется дважды столько же адресов. 

Если вы хотите, чтобы ваши приложения в другом плане службы приложений достигли виртуальной сети, к которой уже подключены приложения в другом плане службы приложений, необходимо выбрать подсеть, отличную от используемой уже существующей интеграцией виртуальной сети.  

Эта функция доступна в предварительной версии для Linux. Форма Linux функции поддерживает вызовы только для адресов RFC 1918 (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).

### <a name="web-app-for-containers"></a>Веб-приложение для контейнеров

Если вы используете службу приложений на платформе Linux со встроенными образами, интеграция региональной виртуальной сети будет работать без дополнительных изменений. Если вы используете Веб-приложение для контейнеров, необходимо изменить образ DOCKER, чтобы использовать интеграцию с виртуальной сетью. В образе DOCKER используйте переменную среды порта в качестве порта прослушивания основного веб-сервера вместо использования жестко зафиксированного номера порта. Переменная среды порта автоматически задается платформой службы приложений в момент запуска контейнера. При использовании SSH управляющая программа SSH должна прослушивать номер порта, указанный в переменной среды SSH_PORT, при использовании интеграции с региональной виртуальной сетью.  Отсутствует поддержка интеграции виртуальной сети, требуемой для шлюза, в Linux. 

### <a name="service-endpoints"></a>Конечные точки службы

Интеграция региональной виртуальной сети позволяет использовать конечные точки службы.  Чтобы использовать конечные точки службы в приложении, используйте интеграцию с региональной виртуальной сетью, чтобы подключиться к выбранной виртуальной сети, а затем настройте конечные точки службы в используемой для интеграции подсеть. 

### <a name="network-security-groups"></a>группы сетевой безопасности;

Группы безопасности сети позволяют блокировать входящий и исходящий трафик для ресурсов в виртуальной сети. Веб-приложение, использующее региональную интеграцию виртуальной сети, может использовать [группу безопасности сети][VNETnsg] для блокировки исходящего трафика к ресурсам в виртуальной сети или Интернете. Для блокировки трафика на общедоступные адреса необходимо, чтобы параметр приложения WEBSITE_VNET_ROUTE_ALL установлен в значение 1. Правила для входящих подключений в NSG не применяются к вашему приложению, так как интеграция с виртуальной сетью влияет только на исходящий трафик из приложения. Чтобы управлять входящим трафиком к веб-приложению, используйте функцию ограничения доступа. NSG, применяемый к подсети интеграции, будет действовать независимо от всех маршрутов, примененных к подсети интеграции. Если параметру WEBSITE_VNET_ROUTE_ALL было присвоено значение 1, а у вас нет маршрутов, затрагивающих трафик общедоступного адреса в подсети интеграции, весь исходящий трафик по-прежнему будет подвергаться группы безопасности сети, назначенному вашей подсети интеграции. Если параметр WEBSITE_VNET_ROUTE_ALL не был задан, группы безопасности сети будет применяться только к трафику АДРЕСНЫЕ пространства RFC1918.

### <a name="routes"></a>Маршруты

Таблицы маршрутов позволяют направлять исходящий трафик из приложения в нужное место. По умолчанию таблицы маршрутов будут влиять только на трафик назначения АДРЕСНЫЕ пространства RFC1918.  Если для WEBSITE_VNET_ROUTE_ALL задано значение 1, будут затронуты все исходящие вызовы. Маршруты, настроенные в подсети интеграции, не влияют на ответы на входящие запросы приложений. Общие назначения могут включать устройства брандмауэра или шлюзы. Если требуется маршрутизировать весь исходящий трафик локально, можно использовать таблицу маршрутов для отправки всего исходящего трафика на шлюз ExpressRoute. Если вы направите трафик в шлюз, не забудьте установить маршруты во внешней сети для отправки ответов обратно.

Маршруты протокол BGP (BGP) также влияют на трафик приложения. Если у вас есть маршруты BGP, например шлюз ExpressRoute, будет затронуто исходящий трафик приложения. По умолчанию маршруты BGP будут влиять только на трафик назначения АДРЕСНЫЕ пространства RFC1918. Если параметр WEBSITE_VNET_ROUTE_ALL имеет значение 1, маршруты BGP могут повлиять на весь исходящий трафик. 

### <a name="how-regional-vnet-integration-works"></a>Принцип работы интеграции региональной виртуальной сети

Приложения в службе приложений размещаются на рабочих ролях. Базовые и более высокие тарифные планы являются выделенными планами размещения, где нет других рабочих нагрузок клиентов, выполняющихся в одних и тех же работниках. Интеграция региональной виртуальной сети осуществляется путем подключения виртуальных интерфейсов с адресами в делегированной подсети. Так как адрес отсчета находится в виртуальной сети, он может получить доступ к большинству вещей в виртуальной сети или через нее так же, как и виртуальная машина в виртуальной сети. Реализация сети отличается от работы виртуальной машины в виртуальной сети, поэтому некоторые сетевые функции пока не доступны при использовании этой функции.

![Принцип работы интеграции региональной виртуальной сети][5]

Если включена интеграция с региональной виртуальной сетью, приложение по-прежнему будет выполнять исходящие вызовы к Интернету через те же каналы, что и обычные. Исходящие адреса, перечисленные на портале свойств приложения, по-прежнему являются адресами, используемыми приложением. Какие изменения в приложении являются, вызовы к защищенным конечным точкам служб или адреса RFC 1918 попадают в виртуальную сеть. Если WEBSITE_VNET_ROUTE_ALL имеет значение 1, то весь исходящий трафик может быть отправлен в виртуальную сеть. 

Эта функция поддерживает только один виртуальный интерфейс для каждого рабочего процесса.  Один виртуальный интерфейс на каждый рабочий процесс означает, что для каждого плана службы приложений необходимо интегрировать одну региональную виртуальную сеть. Все приложения в одном плане службы приложений могут использовать одну и ту же интеграцию виртуальной сети, но если для подключения к дополнительной виртуальной сети требуется приложение, необходимо создать другой план службы приложений. Используемый виртуальный интерфейс не является ресурсом, к которому у клиентов есть прямой доступ.

Из-за особенностей работы этой технологии трафик, используемый с интеграцией виртуальной сети, не отображается в журналах потоков или наблюдателя NSG.  

## <a name="gateway-required-vnet-integration"></a>Интеграция виртуальной сети, требуемой шлюзом

Интеграция виртуальной сети, требуемая для шлюза, поддерживает подключение к виртуальной сети в другом регионе или классической виртуальной сети. Интеграция виртуальной сети, требуемой для шлюза: 

* Позволяет приложению подключаться только к одной виртуальной сети за раз
* Позволяет интегрировать до пяти виртуальных сетей в рамках плана службы приложений. 
* Позволяет использовать одну и ту же виртуальную сеть в нескольких приложениях в плане службы приложений, не влияя на общее число, которое может использоваться планом службы приложений.  Если у вас есть шесть приложений, использующих одну и ту же виртуальную сеть в одном плане службы приложений, это будет считать, что используется одна виртуальная сеть. 
* Поддерживает соглашение об уровне обслуживания 99,9% из-за соглашения об уровне обслуживания на шлюзе
* Позволяет приложениям использовать DNS, для которого настроена виртуальная сеть
* Для подключения к приложению требуется шлюз, основанный на маршрутах виртуальной сети, настроенный с помощью VPN-подключения типа "точка — сеть". 

Вы не можете использовать шлюз, необходимый для интеграции виртуальной сети:

* С приложениями Linux
* С виртуальной сетью, подключенной с помощью ExpressRoute 
* Доступ к защищенным ресурсам конечных точек службы
* С помощью шлюза сосуществования, поддерживающего виртуальные частные сети с подключением ExpressRoute и между сайтами и узлами.

### <a name="set-up-a-gateway-in-your-vnet"></a>Настройка шлюза в виртуальной сети ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.  

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. Укажите [адреса узлов в качестве точки][setp2saddresses]. Если шлюз не входит в базовый SKU, необходимо отключить IKEV2 в конфигурации "точка — сеть" и "SSTP". Адресное пространство "точка — сеть" должно находиться в блоках адресов RFC 1918, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

Если вы просто создаете шлюз для использования с интеграцией виртуальной сети службы приложений, вам не нужно отправлять сертификат. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно. 

### <a name="how-gateway-required-vnet-integration-works"></a>Как работает шлюз, необходимый для интеграции виртуальной сети

Для шлюза требуется интеграция виртуальной сети, построенная на основе технологии VPN типа "точка — сеть". VPN типа "точка — сеть" ограничивает сетевой доступ только к виртуальной машине, на которой размещается приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. Если в приложении настроен портал для использования интеграции виртуальной сети, необходимой для шлюза, для создания и назначения сертификатов на шлюзе и на стороне приложения будет использоваться комплексное согласование от вашего имени. Конечный результат заключается в том, что работники, используемые для размещения приложений, могут напрямую подключаться к шлюзу виртуальной сети в выбранной виртуальной сети. 

![Как работает шлюз, необходимый для интеграции виртуальной сети][6]

### <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам

Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". При использовании интеграции виртуальной сети, требуемой для шлюза, необходимо обновить локальные Маршруты VPN-шлюза с блоками адресов типа "точка — сеть". При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Вы не можете настроить BGP с VPN-подключением типа "сеть — сеть".

Для компонента интеграции региональной виртуальной сети и локальной сети не требуется дополнительная настройка. Вам нужно просто подключить виртуальную сеть к локальной сети с помощью ExpressRoute или VPN типа "сеть — сеть". 

> [!NOTE]
> Функция интеграции с виртуальной сетью, требуемой для шлюза, не интегрирует приложение с виртуальной сетью, имеющей шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex] , интеграция виртуальной сети не работает. Если вам требуется доступ к ресурсам через подключение ExpressRoute, можно использовать функцию интеграции с региональными виртуальными сетями или [Среда службы приложений][ASE], которая выполняется в виртуальной сети. 
> 
> 

### <a name="peering"></a>Пиринг

Если вы используете пиринг с региональной интеграцией виртуальной сети, вам не нужно выполнять дополнительную настройку. 

Если вы используете требуемую для шлюза интеграцию виртуальной сети с пирингом, необходимо настроить несколько дополнительных элементов. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите к разделу "План службы приложений" > "Сеть" > "Интеграция виртуальной сети" на портале.  Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены.  

## <a name="managing-vnet-integration"></a>Управление интеграцией виртуальной сети 

Подключение и отключение виртуальной сети осуществляется на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. На портале интеграции с виртуальной сетью > > приложений можно получить сведения о виртуальной сети. Аналогичные сведения можно просмотреть на уровне ASP на портале ASP > Networking > VNet Integration.

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение будет перезапущено. Виртуальная сеть не меняется при отключении. Подсеть или шлюз не удалены. Если вы хотите удалить виртуальную сеть, необходимо сначала отключить приложение от виртуальной сети и удалить в нем ресурсы, такие как шлюзы. 

В пользовательском интерфейсе интеграции виртуальной сети ASP будут показаны все интеграции виртуальной сети, используемые приложениями в вашей ASP. Чтобы просмотреть сведения о той или иной виртуальной сети, щелкните нужную сеть. Здесь можно выполнить два действия для интеграции виртуальной сети, необходимой для шлюза.

* **Синхронизировать сеть.** Операция синхронизации в сети предназначена только для компонента интеграции с виртуальной сетью, зависящей от шлюза. Выполнение операции синхронизации обеспечивает синхронизацию сертификатов и сведений о сети. При добавлении или изменении DNS виртуальной сети необходимо выполнить операцию **синхронизации сети** . Эта операция перезапустит все приложения, использующие эту виртуальную сеть.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть. 

Для **шлюза требуется маршрутизация интеграции виртуальной сети** Маршруты, определенные в виртуальной сети, используются для направления трафика в виртуальную сеть из приложения. Если вам нужно отправлять дополнительный исходящий трафик в виртуальную сеть, то вы можете добавить здесь соответствующие блоки адресов. Эта возможность работает только с обязательной интеграцией виртуальной сети. Таблицы маршрутов не влияют на трафик приложения при использовании интеграции виртуальной сети, необходимой для шлюза, так же, как и при интеграции с региональной виртуальной сетью.

**Сертификаты интеграции виртуальной сети, необходимые шлюзу** Если для шлюза требуется интеграция виртуальной сети, необходим обмен сертификатами для обеспечения безопасности соединения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.
Если сертификаты или сведения о сети изменились, нажмите "Синхронизировать сеть". Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="pricing-details"></a>Сведения о тарифах
Функция интеграции с региональными виртуальными сетями не взимается за пределы цены на услуги по ценовым категориям ASP.

Использование функции шлюза, необходимого для интеграции виртуальной сети, связано с тремя затратами.

* Плата за ценовую категорию ASP. ваши приложения должны быть в плане службы приложений уровня "Стандартный", "Премиум" или "категории премиум v2". Дополнительные сведения об этих затратах можно просмотреть здесь: [цены на службу приложений][ASPricing]. 
* Затраты на передачу данных — взимается плата за исходящие данные, даже если виртуальная сеть находится в том же центре обработки данных. Эти тарифы описаны в [Передача данных сведения о ценах][DataPricing]. 
* Расходы на VPN-шлюз. для шлюза виртуальной сети, который требуется для VPN типа "точка — сеть", взимается плата. Подробные сведения см. на странице [цен на VPN-шлюз][VNETPricing] .

## <a name="troubleshooting"></a>Диагностика
Простота настройки этой функции не гарантирует отсутствия проблем при ее использовании. При проблемах с доступом к нужной конечной точке можно воспользоваться некоторыми служебными программами для проверки подключения из консоли приложения. Вы можете использовать две консоли: консоль Kudu и консоль на портале Azure. Чтобы открыть консоль Kudu из приложения, выберите пункты "Сервис" -> "Kudu". Можно также обратиться к консоли Кудо по адресу [sitename]. SCM. azurewebsites. NET. После загрузки веб-сайта перейдите на вкладку консоль отладки. Чтобы открыть портал Azure размещенную консоль, в приложении перейдите в раздел Сервис-> консоль. 

#### <a name="tools"></a>Сервис
Средства **ping**, **nslookup**и **tracert** не будут работать через консоль из-за ограничений безопасности. Чтобы заполнить void, добавляются два отдельных средства. Для проверки работоспособности DNS мы добавили средство nameresolver.exe. Синтаксис:

    nameresolver.exe hostname [optional: DNS Server]

Для проверки имен узлов, которые использует ваше приложение, можно использовать команду **nameresolver**. Так вы сможете обнаружить ошибки в настройке DNS-сервера или проблемы с доступом к DNS-серверу. Вы видите DNS-сервер, который приложение будет использовать в консоли, просмотрев переменные среды WEBSITE_DNS_SERVER и WEBSITE_DNS_ALT_SERVER.

Следующее средство позволяет проверить подключение к комбинации «узел:порт» по протоколу TCP. Этот инструмент называется **tcpping.exe** и использует следующий синтаксис.

    tcpping.exe hostname [optional: port]

Служебная программа **tcpping** сообщает, возможно ли получить доступ к определенному узлу и порту. Сообщение об успешном выполнении отображается только с том случае, когда приложение ожидает передачи данных от комбинации "узел:порт", а также есть доступ по сети из приложения к указанным узлу и порту.

#### <a name="debugging-access-to-vnet-hosted-resources"></a>Доступ к ресурсам виртуальной сети для отладки
У приложения могут возникнуть проблемы с доступом к определенной комбинации «узел:порт». Это происходит по многим причинам. Вот три наиболее распространенные причины:

* **Брандмауэр блокирует доступ.** Если вы используете брандмауэр, может быть превышено время ожидания TCP. В нашем случае это 21 секунда. Проверьте подключение с помощью средства **tcpping**. Время ожидания TCP может превышаться и по многим другим причинам, но начать стоит именно с этой. 
* **Служба DNS недоступна.** Время ожидания для DNS составляет три секунды на каждый DNS-сервер. Если у вас два DNS-сервера, то время ожидания составляет 6 секунд. Используйте средство nameresolver для проверки работы DNS. Помните, что средство nslookup не подходит для проверки, так как оно игнорирует настройки DNS для виртуальной сети. Если он недоступен, возможно, брандмауэр или NSG блокирует доступ к DNS.

Если эти элементы не отвечают на ваши проблемы, сначала изучите такие вещи, как: 

**Интеграция региональной виртуальной сети**
* является ли назначение адресом, отличным от АДРЕСНЫЕ пространства RFC1918, и у вас не WEBSITE_VNET_ROUTE_ALL значение 1
* Существует ли NSG блокировка исходящего трафика из подсети интеграции
* Если переход выполняется между ExpressRoute или VPN, это локальный шлюз, настроенный для маршрутизации трафика в Azure? Если вы можете получить доступ к конечным точкам в виртуальной сети, но не в локальной среде, проверьте маршруты.
* у вас есть достаточные разрешения для настройки делегирования в подсети интеграции? Во время настройки интеграции с региональной виртуальной сетью ваша подсеть интеграции будет делегирована в Microsoft. Web. Пользовательский интерфейс интеграции виртуальной сети будет автоматически делегировать подсеть в Microsoft. Web. Если учетная запись не имеет достаточных сетевых разрешений для настройки делегирования, вам потребуется пользователь, который может задать атрибуты в подсети интеграции для делегирования подсети. Чтобы вручную делегировать подсеть интеграции, перейдите в пользовательский интерфейс подсети виртуальной сети Azure и настройте делегирование для Microsoft. Web. 

**Интеграция виртуальной сети, требуемой шлюзом**
* диапазон адресов "точка — сеть" в диапазонах RFC 1918 (10.0.0.0-10.255.255.255/172.16.0.0-172.31.255.255/192.168.0.0-192.168.255.255)?
* Отображается ли на портале шлюз в рабочем состоянии? Если шлюз не работает, восстановите его работоспособность.
* Отображаются ли сертификаты как синхронизированные или вы подозреваете, что конфигурация сети была изменена?  Если сертификаты не синхронизированы или вы подозреваете, что в конфигурацию виртуальной сети были внесены изменения, которые не были синхронизированы с планах ASP, нажмите "синхронизировать сеть".
* При переходе через VPN — локальный шлюз, настроенный для маршрутизации трафика в Azure? Если вы можете получить доступ к конечным точкам в виртуальной сети, но не в локальной среде, проверьте маршруты.
* Вы пытаетесь использовать шлюз сосуществования, поддерживающий обе точки с сайтом и ExpressRoute? Шлюзы сосуществования не поддерживаются при интеграции с виртуальной сетью 

Отладка сетевых проблем является сложной задачей, так как здесь не видно, что блокирует доступ к определенной комбинации "узел: порт". Ниже представлено несколько возможных причин этой проблемы.

* На нужном узле запущен брандмауэр, который блокирует доступ к порту приложения для диапазона IP-адресов "точка — сеть". Для подключения между подсетями часто требуется разрешить общий доступ.
* Целевой узел не работает.
* Целевое приложение не работает.
* Указан неверный IP-адрес или неверное имя узла.
* Приложение ожидает передачи данных не по тому порту, который предполагается. Вы можете сопоставить ИД процесса с портом прослушивания при помощи команды "netstat -aon" в узле конечной точки. 
* Группы безопасности сети настроены на блокирование доступа к узлу и порту приложения для диапазона IP-адресов «точка-сеть».

Помните, что вы не уверены, какой адрес будет использоваться приложением. Это может быть любой адрес в подсети интеграции или диапазон адресов "точка — сеть", поэтому необходимо разрешить доступ из всего диапазона адресов. 

Можно выполнить дополнительные действия по отладке.

* Войдите на другую виртуальную машину в этой виртуальной сети и попробуйте из нее обратиться к нужной комбинации "узел:порт". Чтобы проверить доступ TCP, используйте команду PowerShell **test-netconnection**. Синтаксис:

      test-netconnection hostname [optional: -Port]

* Выведите приложение на виртуальной машине и протестируйте доступ к этому узлу и порту из консоли приложения с помощью **tcpping**

#### <a name="on-premises-resources"></a>Локальные ресурсы ####

Если приложение не может перейти к ресурсу локально, проверьте, можно ли перейти к ней через виртуальную сеть. Чтобы проверить доступ по протоколу TCP, используйте команду PowerShell **test-netconnection**. Если виртуальная машина не может подключиться к локальному ресурсу, возможно, подключение VPN или ExpressRoute настроено неправильно.

Если размещенная в виртуальной сети виртуальная машина может взаимодействовать с локальной системой, а приложение — нет, это может быть вызвано одной из следующих причин:

* в ваших маршрутах не настроена подсеть или указаны диапазоны адресов сайтов в локальном шлюзе.
* ваши группы безопасности сети блокируют доступ к диапазону IP-адресов подключений "точка — сеть";
* локальные брандмауэры блокируют трафик из диапазона IP-адресов подключений "точка — сеть";
* Вы пытаетесь обратиться к адресу, отличному от RFC 1918, с помощью функции интеграции с региональной виртуальной сетью


## <a name="automation"></a>Автоматизация

Для интеграции региональной виртуальной сети предусмотрена поддержка интерфейса командной строки. Чтобы получить доступ к следующим командам, [установите Azure CLI][installCLI]. 

        az webapp vnet-integration --help

        Group
            az webapp vnet-integration : Methods that list, add, and remove virtual network integrations
            from a webapp.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            add    : Add a regional virtual network integration to a webapp.
            list   : List the virtual network integrations on a webapp.
            remove : Remove a regional virtual network integration from webapp.

        az appservice vnet-integration --help

        Group
            az appservice vnet-integration : A method that lists the virtual network integrations used in an
            appservice plan.
                This command group is in preview. It may be changed/removed in a future release.
        Commands:
            list : List the virtual network integrations used in an appservice plan.

Для интеграции виртуальной сети, необходимой для шлюза, можно интегрировать службу приложений с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-appsetting.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: https://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: https://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ASEintro]: environment/intro.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#creategw
[setp2saddresses]: https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal#addresspool
[VNETnsg]: https://docs.microsoft.com/azure/virtual-network/security-overview/
[VNETRouteTables]: https://docs.microsoft.com/azure/virtual-network/manage-route-table/
[installCLI]: https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest/
