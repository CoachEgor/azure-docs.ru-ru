---
title: Устранение нерегулярных ошибок исходящих подключений в службе приложений Azure
description: Устранение периодических ошибок подключения и связанных проблем с производительностью в службе приложений Azure
author: v-miegge
manager: barbkess
ms.topic: troubleshooting
ms.date: 07/24/2020
ms.author: ramakoni
ms.custom: security-recommendations,fasttrack-edit
ms.openlocfilehash: ee1b4da6f02623346d078b9812c99e5093dc2691
ms.sourcegitcommit: b48e8a62a63a6ea99812e0a2279b83102e082b61
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2020
ms.locfileid: "91408221"
---
# <a name="troubleshooting-intermittent-outbound-connection-errors-in-azure-app-service"></a>Устранение нерегулярных ошибок исходящих подключений в службе приложений Azure

Эта статья поможет вам устранить временные ошибки подключения и связанные с ними проблемы с производительностью в [службе приложений Azure](./overview.md). В этом разделе содержатся дополнительные сведения о методологиях и способах устранения неполадок для, исчерпания портов преобразования сети адресов источника (SNAT). Если вам нужна дополнительная помощь в любой момент в этой статье, обратитесь к экспертам по Azure на [портале MSDN Azure и на форумах Stack overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зафайлировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите **получить поддержку**.

## <a name="symptoms"></a>Симптомы

Приложения и функции, размещенные в службе приложений Azure, могут демонстрировать одну или несколько из следующих симптомов:

* Время отклика на все или некоторые экземпляры в плане обслуживания.
* Временные ошибки 5xx или **недопустимые шлюзы**
* Сообщения об ошибках времени ожидания
* Не удалось подключиться к внешним конечным точкам (например, SQLDB, Service Fabric, другие службы приложений и т. д.).

## <a name="cause"></a>Причина

Основная причина этих симптомов заключается в том, что экземпляр приложения не может открыть новое соединение с внешней конечной точкой, так как он достиг одного из следующих ограничений:

* TCP-подключения. существует ограничение на количество исходящих подключений, которые могут быть выполнены. Это связано с размером используемого рабочего процесса.
* Порты SNAT. как описано в разделе [Исходящие подключения в Azure](../load-balancer/load-balancer-outbound-connections.md), Azure использует преобразование адресов исходной сети (SNAT) и Load Balancer (не предоставляется клиентам) для обмена данными с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, а также конечных точек, внутренних для Azure, которые не используют конечные точки службы. Каждому экземпляру в службе приложений Azure изначально присвоено предварительно выделенное количество портов **128** SNAT. Этот предел влияет на открытие соединений с одним и тем же сочетанием узла и порта. Если приложение создает подключения к сочетаниям адресов и портов, вы не будете использовать порты SNAT. Порты SNAT используются при многократных вызовах с одним и тем же сочетанием адреса и порта. После освобождения порта он доступен для повторного использования по мере необходимости. Балансировщик сетевой нагрузки Azure освобождает порт SNAT от закрытых подключений только после ожидания в течение 4 минут.

Когда приложения или функции быстро открывают новое подключение, они могут быстро выделять предварительно выделенные квоты для портов 128. Затем они блокируются до тех пор, пока новый порт SNAT не станет доступен, либо через динамическое выделение дополнительных портов SNAT, либо путем повторного использования освобожденного порта SNAT. Приложения или функции, заблокированные из-за этой невозможности создания новых подключений, начинают испытывать одну или несколько проблем, описанных в разделе « **симптомы** » этой статьи.

## <a name="avoiding-the-problem"></a>Устранение проблемы

Если назначением является служба Azure, которая поддерживает конечные точки службы, можно избежать проблем нехватки портов SNAT, используя [интеграцию региональной виртуальной сети](./web-sites-integrate-with-vnet.md) и конечные точки службы или частные конечные точки. При использовании региональной интеграции виртуальной сети и размещении конечных точек службы в подсети интеграции исходящий трафик приложения к этим службам не будет иметь исходящих ограничений на порты SNAT. Аналогичным образом, если вы используете интеграцию с региональной виртуальной сетью и частные конечные точки, у вас не будет проблем с исходящим портом SNAT для этого места назначения. 

Устранение проблемы с портами SNAT означает, что не следует создавать новые подключения повторно для одного и того же узла и порта.

Общие стратегии по устранению нехватки портов SNAT обсуждаются в [разделе "решение проблем](../load-balancer/load-balancer-outbound-connections.md) " **исходящих подключений** к документации Azure. Следующие стратегии применимы к приложениям и функциям, размещенным в службе приложений Azure.

### <a name="modify-the-application-to-use-connection-pooling"></a>Изменение приложения для использования пулов подключений

* Чтобы составить пул HTTP-подключений, проверьте [подключения к пулу по протоколу HTTP с помощью хттпклиентфактори](/aspnet/core/performance/performance-best-practices#pool-http-connections-with-httpclientfactory).
* Дополнительные сведения о SQL Serverии пула соединений см. в [подSQL Serverии пулов соединений (ADO.NET)](/dotnet/framework/data/adonet/sql-server-connection-pooling).
* Сведения о реализации пула с приложениями Entity Framework см. в этой [DbContext](/ef/core/what-is-new/ef-core-2.0#dbcontext-pooling).

Ниже приведена коллекция ссылок для реализации пулов соединений по разным стекам решений.

#### <a name="node"></a>Узел

По умолчанию подключения для NodeJS не поддерживаются. Ниже приведены популярные базы данных и пакеты для пулов соединений, содержащие примеры их реализации.

* [MySQL](https://github.com/mysqljs/mysql#pooling-connections)
* [MongoDB](https://blog.mlab.com/2017/05/mongodb-connection-pooling-for-express-applications/)
* [PostgreSQL](https://node-postgres.com/features/pooling)
* [SQL Server](https://github.com/tediousjs/node-mssql#connection-pools)

Обеспечение активности HTTP

* [agentkeepalive](https://www.npmjs.com/package/agentkeepalive)
* [ Документация поNode.js 13.9.0 v](https://nodejs.org/api/http.html)

#### <a name="java"></a>Java

Ниже приведены популярные библиотеки, используемые для объединения соединений JDBC, которые содержат примеры их реализации: пулы подключений JDBC.

* [Tomcat 8](https://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html)
* [C3p0](https://github.com/swaldman/c3p0)
* [хикарикп](https://github.com/brettwooldridge/HikariCP)
* [Apache ДБКП](https://commons.apache.org/proper/commons-dbcp/)

Объединение соединений по протоколу HTTP

* [Управление подключениями Apache](https://hc.apache.org/httpcomponents-client-ga/tutorial/html/connmgmt.html)
* [Класс Пулингхттпклиентконнектионманажер](http://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/impl/conn/PoolingHttpClientConnectionManager.html)

#### <a name="php"></a>PHP

Хотя PHP не поддерживает пулы подключений, вы можете попытаться использовать постоянные подключения к базе данных на внутреннем сервере.
 
* Сервер MySQL

   * [Mysqli подключения](https://www.php.net/manual/mysqli.quickstart.connections.php) для более новых версий
   * [mysql_pconnect](https://www.php.net/manual/function.mysql-pconnect.php) для старых версий PHP

* Другие источники данных

   * [Управление подключениями PHP](https://www.php.net/manual/en/pdo.connections.php)

### <a name="modify-the-application-to-reuse-connections"></a>Изменение приложения для повторного использования подключений

*  Дополнительные указатели и примеры управления подключениями в функциях Azure см. в [подразделах Управление подключениями в функциях Azure](../azure-functions/manage-connections.md).

### <a name="modify-the-application-to-use-less-aggressive-retry-logic"></a>Изменение приложения для использования менее "жесткой" логики повторных попыток

* Дополнительные указания и примеры см. в статье [шаблон повторных попыток](/azure/architecture/patterns/retry).

### <a name="use-keepalives-to-reset-the-outbound-idle-timeout"></a>Использование проверки активности для сброса времени ожидания простоя исходящих подключений

* Чтобы реализовать проверку активности для приложений Node.js, изучите [мое приложение узла, которое делает избыточные исходящие вызовы](./app-service-web-nodejs-best-practices-and-troubleshoot-guide.md#my-node-application-is-making-excessive-outbound-calls).

### <a name="additional-guidance-specific-to-app-service"></a>Дополнительные рекомендации, относящиеся к службе приложений:

* [Нагрузочный тест](/azure/devops/test/load-test/app-service-web-app-performance-test) должен имитировать реальные данные на постоянной скорости передачи. Тестирование приложений и функций при реальной интенсивной нагрузке позволяет заранее определить и устранить проблемы нехватки портов SNAT.
* Убедитесь, что серверные службы могут быстро возвращать ответы. Для устранения проблем с производительностью базы данных SQL Azure ознакомьтесь [с разрешениями устранение проблем производительности базы данных SQL Azure с Intelligent Insights](../azure-sql/database/intelligent-insights-troubleshoot-performance.md#recommended-troubleshooting-flow).
* Масштабирование плана службы приложений до большего количества экземпляров. Дополнительные сведения о масштабировании см. в статье [Увеличение масштаба приложения в Azure](./manage-scale-up.md). Каждому рабочему экземпляру в плане службы приложений выделяется несколько портов SNAT. Если вы разбиваете использование в нескольких экземплярах, вы можете получить использование порта SNAT на экземпляр ниже рекомендуемого ограничения в 100 исходящих подключений на уникальную конечную точку.
* Рассмотрите возможность перехода на [Среда службы приложений (ASE)](./environment/using-an-ase.md), где вам выделяется один исходящий IP-адрес, а ограничения для подключений и портов SNAT значительно выше. В ASE количество портов SNAT на экземпляре основано на таблице предварительного [распределения балансировщика нагрузки Azure](../load-balancer/load-balancer-outbound-connections.md#snatporttable) , поэтому, например, ASE с 1-50 рабочих экземпляров имеет более 1024 предварительно выделенных портов на экземпляр, в то время как в ASE с 51-100 рабочих экземпляров 512 предварительно выделенные порты на экземпляр.

Избежание исходящих TCP-ограничений проще в решении, так как ограничения задаются размером рабочего процесса. Вы можете увидеть ограничения в ["песочнице" с числовыми пределами межвм — TCP-подключения](https://github.com/projectkudu/kudu/wiki/Azure-Web-App-sandbox#cross-vm-numerical-limits)

|Имя ограничения|Описание|Малый (a1)|Средний (a2)|Крупный (A3)|Изолированный уровень (ASE)|
|---|---|---|---|---|---|
|Соединения|Число подключений для всей виртуальной машины|1920|3968|8064|16 000|

Чтобы избежать исходящих ограничений TCP, можно либо увеличить размер рабочих процессов, либо горизонтально масштабировать.

## <a name="troubleshooting"></a>Устранение неполадок

Знание двух типов ограничений исходящих подключений и действий, выполняемых приложением, должно упростить устранение неполадок. Если вы уверены, что ваше приложение выполняет много вызовов одной и той же учетной записи хранения, вы можете подозрительное ограничение SNAT. Если приложение создает большое количество вызовов конечных точек через Интернет, вы считаете, что вы достигли предела виртуальной машины.

Если вы не уверены в поведении приложения, достаточного для быстрого определения причины, есть некоторые средства и методы, доступные в службе приложений, чтобы помочь в этом определении.

### <a name="find-snat-port-allocation-information"></a>Найти сведения о выделении портов SNAT

Вы можете использовать [диагностику службы приложений](./overview-diagnostics.md) , чтобы найти сведения о выделении портов SNAT и просмотреть метрику выделения портов SNAT сайта службы приложений. Чтобы найти сведения о выделении портов SNAT, выполните следующие действия.

1. Чтобы получить доступ к диагностике службы приложений, перейдите к веб-приложению службы приложений или Среда службы приложений в [портал Azure](https://portal.azure.com/). На панели навигации слева выберите **Диагностика и устранение проблем**.
2. Выбор категории доступности и производительности
3. Выберите плитку нехватка портов SNAT в списке доступных плиток в категории. Рекомендуется не размещать его ниже 128.
Если это необходимо, вы по-прежнему можете открыть запрос в службу поддержки, и инженер службы поддержки сможет получить метрику из серверной части.

Обратите внимание, что поскольку использование порта SNAT недоступно в качестве метрики, автомасштабирование с использованием порта SNAT невозможно или Настройка автоматического масштабирования на основе метрики распределения портов SNAT.

### <a name="tcp-connections-and-snat-ports"></a>TCP-подключения и порты SNAT

TCP-подключения и порты SNAT не связаны напрямую. Детектор использования TCP-подключений включен в колонку диагностика и устранение проблем любого сайта службы приложений. Выполните поиск фразы "TCP-подключения", чтобы найти ее.

* Порты SNAT используются только для внешних сетевых потоков, в то время как общее количество TCP-подключений включает в себя локальные соединения замыкания на себя.
* Порт SNAT может совместно использоваться различными потоками, если потоки различаются в протоколе, IP-адресе или порте. Метрика TCP-подключений учитывает каждое TCP-подключение.
* Ограничение TCP-подключений происходит на уровне экземпляра рабочего процесса. Исходящая балансировка сетевой нагрузки Azure не использует метрику подключений TCP для ограничения портов SNAT.
* Ограничения TCP-подключений описаны в разделе ["песочницы". числовые ограничения межвм (подключения по протоколу TCP)](https://github.com/projectkudu/kudu/wiki/Azure-Web-App-sandbox#cross-vm-numerical-limits)

|Имя ограничения|Описание|Малый (a1)|Средний (a2)|Крупный (A3)|Изолированный уровень (ASE)|
|---|---|---|---|---|---|
|Соединения|Число подключений для всей виртуальной машины|1920|3968|8064|16 000|

### <a name="webjobs-and-database-connections"></a>Веб-задания и подключения к базе данных
 
Если порты SNAT исчерпаны, и веб-заданиям не удается подключиться к базе данных SQL, то нет никакой метрики, показывающей, сколько подключений открываются каждым процессом отдельного приложения. Чтобы найти проблемное веб-задание, переместите несколько заданий в другой план службы приложений, чтобы узнать, улучшается ли ситуация или если проблема остается в одном из планов. Повторите эту процедуру, пока не найдете проблемное веб-задание.

### <a name="using-snat-ports-sooner"></a>Использование портов SNAT рано

Вы не можете изменить параметры Azure, чтобы освободить используемые порты SNAT, так как все порты SNAT будут выпущены в соответствии с приведенными ниже условиями, и поведение будет заключаться в проектировании.
 
* Если сервер или клиент отправляет ФИНАКК, [порт SNAT будет выпущен](../load-balancer/load-balancer-outbound-connections.md) через 240 с.
* Если отображается RST, то порт SNAT будет выпущен через 15 секунд.
* При достижении времени ожидания простоя порт освобождается.
 
## <a name="additional-information"></a>Дополнительные сведения

* [SNAT со службой приложений](https://4lowtherabbit.github.io/blogs/2019/10/SNAT/)
* [Устранение причин низкой производительности приложения в Службе приложений Azure](./troubleshoot-performance-degradation.md)