---
title: Интеграция шлюзов приложений с конечными точками обслуживания - Служба приложений Azure Документы Майкрософт
description: Описывает, как App Gateway интегрируется с службой приложений Azure, защищенной конечными точками обслуживания.
services: app-service
documentationcenter: ''
author: madsd
manager: ccompy
editor: ''
ms.assetid: 073eb49c-efa1-4760-9f0c-1fecd5c251cc
ms.service: app-service
ms.workload: web
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 12/09/2019
ms.author: madsd
ms.custom: seodec18
ms.openlocfilehash: 5e32baa10e98f0f57a861f8cebfb7506ad615631
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74980066"
---
# <a name="application-gateway-integration-with-service-endpoints"></a>Интеграция шлюзов приложений с конечными точками обслуживания
Существует три варианта службы приложений, которые требуют несколько иной конфигурации интеграции с Azure Application Gateway. Вариации включают в себя регулярные App Service - также известный как мультитенант, внутренняя нагрузка балансатор (ILB) App Service окружающей среды (ASE) и внешней ASE. В этой статье будет рассмотрен вопрос о том, как настроить ее с помощью Службы приложений (мультитенант) и обсудить соображения, связанные с ILB и внешним ASE.

## <a name="integration-with-app-service-multi-tenant"></a>Интеграция с службой приложений (мультитенант)
Служба приложений (мультитенант) имеет общедоступный интернет, обращенный к конечная точка. Используя [конечные точки обслуживания,](../../virtual-network/virtual-network-service-endpoints-overview.md) можно разрешить трафик только из определенной подсети в виртуальной сети Azure и заблокировать все остальное. В следующем сценарии мы будем использовать эту функцию, чтобы гарантировать, что экземпляр службы приложений может получать трафик только из определенного экземпляра шлюза приложений.

![Интеграция шлюзов приложений с службой приложений](./media/app-gateway-with-service-endpoints/service-endpoints-appgw.png)

Кроме создания службы приложений и шлюза приложений, в этой конфигурации есть две части. Первая часть позволяет конечным точкам обслуживания в подсети виртуальной сети, где развертывается шлюз приложения. Конечные точки обслуживания гарантируют, что весь сетевой трафик, оставляющий подсеть к Службе App, будет помечен конкретным идентификатором подсети. Вторая часть заключается в установлении ограничения доступа к конкретному веб-приложению, чтобы гарантировать, что допускается только трафик, отмеченный этим конкретным идентификатором подсети. Вы можете настроить его с помощью различных инструментов в зависимости от предпочтений.

## <a name="using-azure-portal"></a>Использование портала Azure
С помощью портала Azure вы выполните четыре шага, чтобы обеспечить и настроить настройку. Если у вас есть имеющиеся ресурсы, вы можете пропустить первые шаги.
1. Создайте службу app, используя один из кикстартов в документации Службы App, например [.Net Core квикстарт](../../app-service/app-service-web-get-started-dotnet.md)
2. Создайте шлюз приложения с помощью [портала Быстрый запуск](../../application-gateway/quick-create-portal.md), но пропустить Добавить разделе бэкэнд целей.
3. Настройте [службу приложений в качестве бэкэнда в шлюзе приложения,](../../application-gateway/configure-web-app-portal.md)но пропустите раздел Ограничить доступ.
4. Наконец, создайте [ограничение доступа с помощью конечных точек службы.](../../app-service/app-service-ip-restrictions.md#service-endpoints)

Теперь вы можете получить доступ к Службе App через Application Gateway, но если вы попытаетесь получить доступ к Службе App напрямую, вы должны получить ошибку 403 HTTP, указывающую на то, что веб-сайт остановлен.

![Интеграция шлюзов приложений с службой приложений](./media/app-gateway-with-service-endpoints/web-site-stopped.png)

## <a name="using-azure-resource-manager-template"></a>Использование шаблона Azure Resource Manager
[Шаблон развертывания диспетчера ресурсов][template-app-gateway-app-service-complete] предоставит полный сценарий. Сценарий состоит из экземпляра Службы приложений, заблокированного конечными точками обслуживания, и ограничения доступа только для получения трафика из шлюза приложения. Шаблон включает в себя множество smart Defaults и уникальных почтовых фиксов, добавленных в названия ресурсов, чтобы он был простым. Чтобы переопределить их, вам придется клонировать репо или скачать шаблон и отсваивать его. 

Для применения шаблона можно использовать кнопку «Развертывание в Azure», найденную в описании шаблона, или использовать соответствующую кнопку PowerShell/CLI.

## <a name="using-azure-command-line-interface"></a>Использование интерфейса командной строки Azure
[В выборке Azure CLI](../../app-service/scripts/cli-integrate-app-service-with-application-gateway.md) будет предусмотрена служба приложений, заблокированная с конечными точками обслуживания и ограничением доступа только для получения трафика с шлюза приложения. Если вам нужно только изолировать трафик к существующей службе приложений от существующего шлюза приложения, достаточно следующей команды.

```azurecli-interactive
az webapp config access-restriction add --resource-group myRG --name myWebApp --rule-name AppGwSubnet --priority 200 --subnet mySubNetName --vnet-name myVnetName
```

В конфигурации по умолчанию команда обеспечит как настройку конфигурации конечной точки службы в подсети, так и ограничение доступа в службе app.

## <a name="considerations-for-ilb-ase"></a>Рассмотрение iLB ASE
ILB ASE не подвергается воздействию Интернета, а трафик между экземпляром и шлюзом приложений, таким образом, уже изолирован в виртуальной сети. Следующее [руководство](../environment/integrate-with-application-gateway.md) настраивает ILB ASE и интегрирует его с порталом Приложений с помощью портала Azure. 

Если вы хотите убедиться, что только трафик из подсети Application Gateway достигает ASE, вы можете настроить группу безопасности сети (NSG), которая влияет на все веб-приложения в ASE. Для NSG вы можете указать диапазон IP-адрес подсети и опционально порты (80/443). Убедитесь, что вы не отменяете [требуемые правила NSG](../environment/network-info.md#network-security-groups) для правильной работы ASE.

Чтобы изолировать трафик в отдельном веб-приложении, необходимо использовать ограничения доступа на основе ip, поскольку конечные точки службы не будут работать для ASE. IP-адрес должен быть частным IP экземпляра прикладного шлюза.

## <a name="considerations-for-external-ase"></a>Рассмотрение внешних вопросов ASE
Внешний ASE имеет публичный балансиватор нагрузки, такой как multi-tenant App Service. Конечные точки обслуживания не работают для ASE, и именно поэтому вам придется использовать ограничения доступа на основе ip, используя общедоступный IP экземпляра портала приложений. Чтобы создать внешний ASE с помощью портала Azure, вы можете следить за этим [киватером](../environment/create-external-ase.md)

[template-app-gateway-app-service-complete]: https://github.com/Azure/azure-quickstart-templates/tree/master/201-web-app-with-app-gateway-v2/ "Шаблон управления ресурсами Azure для полного сценария"

## <a name="considerations-for-kuduscm-site"></a>Рассмотрение для сайта kudu/scm
Сайт scm, также известный как kudu, является админ-сайт, который существует для каждого веб-приложения. Это не возможно, чтобы обратить вспять прокси scm сайт, и вы, скорее всего, также хотите, чтобы заблокировать его до отдельных IP-адресов или конкретной подсети.

Если вы хотите использовать те же ограничения доступа, что и основной сайт, вы можете унаследовать настройки, используя следующую команду.

```azurecli-interactive
az webapp config access-restriction set --resource-group myRG --name myWebApp --use-same-restrictions-for-scm-site
```

Если вы хотите установить индивидуальные ограничения доступа для сайта scm, вы можете добавить ограничения доступа, используя флаг --scm-site, как показано ниже.

```azurecli-interactive
az webapp config access-restriction add --resource-group myRG --name myWebApp --scm-site --rule-name KudoAccess --priority 200 --ip-address 208.130.0.0/16
```

## <a name="next-steps"></a>Дальнейшие действия
Для получения дополнительной информации об [App Service Environment documentation](https://docs.microsoft.com/azure/app-service/environment)среде службы приложений см.

Для дальнейшей защиты веб-приложения информация о веб-приложении Firewall на портале приложений можно найти в [документации Azure Web Application Firewall.](../../web-application-firewall/ag/ag-overview.md)