---
title: Геораспределенное масштабирование
description: Узнайте, как горизонтально масштабировать приложения на основе географического распределения с помощью диспетчера трафика и сред службы приложения.
author: stefsch
ms.assetid: c1b05ca8-3703-4d87-a9ae-819d741787fb
ms.topic: article
ms.date: 09/07/2016
ms.author: stefsch
ms.custom: seodec18
ms.openlocfilehash: 7ab04e23b838f2dfd39b73476db7492947d62e6e
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "74688816"
---
# <a name="geo-distributed-scale-with-app-service-environments"></a>Географически распределенное масштабирование с использованием Среды службы приложений
## <a name="overview"></a>Обзор

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

В некоторых сценариях для корректной работы приложения требуется значительно больше вычислительных ресурсов, чем может обеспечить один развернутый экземпляр. Как следствие, необходимо обеспечить высокий уровень масштабируемости.  К примерам таких сценариев относятся проведение голосования, организация спортивных событий и телевизионных трансляций. Высокого уровня масштабируемости можно добиться за счет горизонтального масштабирования, при котором несколько приложений развертываются в одном или нескольких регионах.

Среды службы приложений — это идеальная платформа для горизонтального масштабирования.  После выбора конфигурации Среда службы приложений, которая может поддерживать известную частоту запросов, разработчики могут развернуть дополнительные среды службы приложений в "резчике файлов cookie", чтобы достичь желаемой емкости пиковой нагрузки.

Предположим, что для приложения используется конфигурация среды службы приложений, протестированная для обработки 20 тысяч запросов в секунду.  Если при пиковой нагрузке приложение должно обрабатывать 100 тысяч запросов в секунду, можно создать и настроить пять (5) сред службы приложений, чтобы обеспечить эффективную работу при прогнозируемой максимальной нагрузке.

Поскольку клиенты обычно обращаются к приложениям, используя именной (личный) домен, разработчикам необходим способ распределения запросов к приложению между всеми экземплярами среды службы приложений.  Идеальным решением этой задачи является разрешение личного домена с помощью [профиля диспетчера трафика Azure][AzureTrafficManagerProfile].  Можно настроить профиль диспетчера трафика таким образом, чтобы он указывал на все отдельные среды службы приложений.  Диспетчер трафика будет автоматически распределять клиентов между средами службы приложений на основе параметров балансировки нагрузки, заданных в профиле диспетчера трафика.  Этот подход работает независимо от того, развернуты среды службы приложений в одном регионе Azure или в нескольких.

Кроме того, поскольку клиенты обращаются к приложениям через именной домен, они не знают, в скольких средах службы приложений выполняется приложение.  Поэтому разработчики могут быстро добавлять и удалять среды службы приложений в зависимости от ожидаемого трафика.

На следующей схеме представлено приложение, выполняющееся в трех средах службы приложений в одном регионе.

![Концепция архитектуры][ConceptualArchitecture] 

Далее мы рассмотрим действия, связанные с настройкой распределенной топологии приложения. В нашем примере оно будет развернуто в нескольких средах службы приложений.

## <a name="planning-the-topology"></a>Планирование топологии
Прежде чем построить распределенную топологию приложения, необходимо собрать некоторые сведения.

* **Личный домен для приложения:**  Что такое имя личного домена, которое пользователи будут использовать для доступа к приложению?  Для примера приложения имя пользовательского домена`www.scalableasedemo.com`
* **Домен диспетчера трафика.** При создании [профиля диспетчера трафика Azure][AzureTrafficManagerProfile] необходимо выбрать доменное имя.  При регистрации записи домена, используемой диспетчером трафика, к этому имени будет добавлен суффикс *trafficmanager.net*.  В нашем примере приложения используется имя *scalable-ase-demo*,  В результате полное доменное имя, управляемое диспетчером трафика, — *Scalable-ASE-Demo.trafficmanager.NET*.
* **Стратегия масштабирования объема приложения:**  Будет ли приложение распределено между несколькими средами службы приложений в одном регионе?  в нескольких регионах,  или вы будете применять гибридный подход?  Решение должно основываться на предполагаемых источниках клиентского трафика, а также на характеристиках масштабируемости серверной инфраструктуры приложения.  Например, приложение, не хранящее сведения о состоянии, можно масштабировать, развернув конфигурацию из нескольких сред службы приложений в одном регионе, а также в нескольких регионах Azure.  В настоящее время доступно более 15 открытых регионов Azure, поэтому клиенты могут создать по-настоящему глобальное гипермасштабируемое приложение.  Для приложения, рассматриваемого в этой статье, создано три среды службы приложений в одном регионе Azure (центрально-южная часть США).
* **Соглашения об именовании для сред службы приложений:**  Каждому Среда службы приложенийу требуется уникальное имя.  Если используется больше двух сред службы приложений, рекомендуется присваивать каждой из них имя на основе соглашения об именовании.  В нашем примере используется простое соглашение об именовании:  Среды службы приложений называются *fe1ase*, *fe2ase* и *fe3ase*.
* **Соглашения об именовании приложений:**  Поскольку будет развернуто несколько экземпляров приложения, необходимо указать имя для каждого экземпляра развернутого приложения.  В разных средах службы приложений можно использовать одни и те же имена. Это малоизвестная, но очень полезная особенность сред службы приложений.  Так как у каждой среды службы приложений есть уникальный доменный суффикс, разработчики могут использовать одно и то же имя приложения во всех средах.  Например, разработчик может иметь приложения, названные следующим образом: *MyApp.Foo1.p.azurewebsites.NET*, *MyApp.Foo2.p.azurewebsites.NET*, *MyApp.foo3.p.azurewebsites.NET*и т. д.  Для примера приложения каждый экземпляр приложения также имеет уникальное имя.  *webfrontend1*, *webfrontend2* и *webfrontend3*.

## <a name="setting-up-the-traffic-manager-profile"></a>Настройка профиля диспетчера трафика
После развертывания нескольких экземпляров приложения в нескольких средах службы приложений отдельные экземпляры приложения можно зарегистрировать в диспетчере трафика.  В приложении, рассматриваемом в этой статье, профиль диспетчера трафика используется для перенаправления трафика с *scalable-ase-demo.trafficmanager.net* на следующие развернутые экземпляры:

* **webfrontend1.fe1ase.p.azurewebsites.NET:**  Экземпляр примера приложения, развернутый на первом Среда службы приложений.
* **webfrontend2.fe2ase.p.azurewebsites.NET:**  Экземпляр примера приложения, развернутого на втором Среда службы приложений.
* **webfrontend3.fe3ase.p.azurewebsites.NET:**  Экземпляр примера приложения, развернутого на третьем Среда службы приложений.

Самый простой способ зарегистрировать несколько конечных точек службы приложений Azure, работающих в **одном и том же** регионе Azure, — использовать PowerShell для [поддержки диспетчера трафика в Azure Resource Manager][ARMTrafficManager].  

Прежде всего необходимо создать профиль диспетчера трафика Azure.  Ниже приведен код, создающий профиль для нашего примера приложения.

    $profile = New-AzureTrafficManagerProfile –Name scalableasedemo -ResourceGroupName yourRGNameHere -TrafficRoutingMethod Weighted -RelativeDnsName scalable-ase-demo -Ttl 30 -MonitorProtocol HTTP -MonitorPort 80 -MonitorPath "/"

Обратите внимание, что для параметра *relativeDnsName* задано значение *scalable-ase-demo*.  С помощью этого параметра создается имя домена *scalable-ase-demo.trafficmanager.net* , которое связывается с профилем диспетчера трафика.

Параметр *TrafficRoutingMethod* определяет политику балансировки нагрузки, которую диспетчер трафика будет использовать для распределения клиентской нагрузки между всеми доступными конечными точками.  В этом примере выбран метод *Weighted* .  При использовании этого метода клиентские запросы распределяются по всем зарегистрированным конечным точкам приложения на основе веса, связанного с каждой из них. 

После создания профиля каждый экземпляр приложения добавляется в профиль как собственная конечная точка Azure.  Приведенный ниже код получает ссылку на каждое интерфейсное веб-приложение, а затем добавляет каждое приложение как конечную точку диспетчера трафика с помощью параметра *TargetResourceId* .

    $webapp1 = Get-AzWebApp -Name webfrontend1
    Add-AzureTrafficManagerEndpointConfig –EndpointName webfrontend1 –TrafficManagerProfile $profile –Type AzureEndpoints -TargetResourceId $webapp1.Id –EndpointStatus Enabled –Weight 10

    $webapp2 = Get-AzWebApp -Name webfrontend2
    Add-AzureTrafficManagerEndpointConfig –EndpointName webfrontend2 –TrafficManagerProfile $profile –Type AzureEndpoints -TargetResourceId $webapp2.Id –EndpointStatus Enabled –Weight 10

    $webapp3 = Get-AzWebApp -Name webfrontend3
    Add-AzureTrafficManagerEndpointConfig –EndpointName webfrontend3 –TrafficManagerProfile $profile –Type AzureEndpoints -TargetResourceId $webapp3.Id –EndpointStatus Enabled –Weight 10

    Set-AzureTrafficManagerProfile –TrafficManagerProfile $profile

Обратите внимание, что для каждого экземпляра приложения используется один вызов *Add-AzureTrafficManagerEndpointConfig* .  Параметр *TargetResourceId* в каждой команде PowerShell ссылается на один из трех экземпляров развернутого приложения.  Профиль диспетчера трафика будет распределять нагрузку на все три конечные точки, зарегистрированные в профиле.

Для всех трех конечных точек используется одно и то же значение параметра *Weight* (10),  поэтому диспетчер трафика распределяет клиентские запросы между всеми тремя экземплярами приложения относительно равномерно. 

## <a name="pointing-the-apps-custom-domain-at-the-traffic-manager-domain"></a>Перенаправление трафика с именного домена приложения на домен диспетчера трафика
В заключение необходимо настроить разрешение именного домена приложения в домен диспетчера трафика.  Для примера приложения это означает, что `www.scalableasedemo.com` указывает `scalable-ase-demo.trafficmanager.net`на.  Этот шаг выполняется в регистраторе доменов, который управляет именным доменом.  

Используя средства управления доменом, предоставленными регистратором, необходимо создать записи CNAME, которые будут разрешать именной домен в домен диспетчера трафика.  На рисунке ниже показан пример конфигурации CNAME:

![CNAME для именного домена][CNAMEforCustomDomain] 

Хотя в этой статье мы не рассматриваем регистрацию доменов, помните, что для каждого отдельного экземпляра приложения необходимо также зарегистрировать именной домен.  Запросы к экземпляру приложения, для которого не зарегистрирован именной домен, будут завершаться ошибкой.  

В этом примере личный домен имеет `www.scalableasedemo.com`значение, и каждый экземпляр приложения имеет связанный с ним личный домен.

![Личный домен][CustomDomain] 

Краткую информацию о регистрации личного домена в приложениях Службы приложений Azure см. в [этой статье о регистрации личных доменов][RegisterCustomDomain].

## <a name="trying-out-the-distributed-topology"></a>Тестирование распределенной топологии
Конечным результатом настройки диспетчера трафика и DNS является то, что запросы к `www.scalableasedemo.com` будут проходить через следующую последовательность:

1. Браузер или устройство сделает поиск DNS для`www.scalableasedemo.com`
2. Запись CNAME у регистратора домена перенаправляет запрос на диспетчер трафика Azure.
3. Поиск *scalable-ase-demo.trafficmanager.net* выполняется на одном из DNS-серверов диспетчера трафика Azure.
4. На основе политики балансировки нагрузки (параметр *TrafficRoutingMethod* , который использовался при создании профиля диспетчера трафика) диспетчер трафика выбирает одну из настроенных конечных точек и возвращает ее полное доменное имя браузеру или устройству.
5. Так как полное доменное имя конечной точки является URL-адресом экземпляра приложения, выполняющегося в среде службы приложений, браузер или устройство отправляет DNS-серверу Microsoft Azure запрос на разрешение полного доменного имени в IP-адрес. 
6. Браузер или устройство отправляет HTTP- или HTTPS-запрос на этот IP-адрес.  
7. Запрос поступает на один из экземпляров приложения, выполняющийся в одной из сред службы приложений.

На изображении окна консоли показано, как в результате поиска именного домена в DNS для нашего примера приложения выполняется разрешение на экземпляр приложения, выполняющийся в одной из трех сред службы приложений (в данном случае второй из трех сред службы приложений).

![Поиск в DNS][DNSLookup] 

## <a name="additional-links-and-information"></a>Дополнительные ссылки и сведения
Изучите документацию PowerShell по [поддержке диспетчера трафика в Azure Resource Manager][ARMTrafficManager].  

[!INCLUDE [app-service-web-try-app-service](../../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[AzureTrafficManagerProfile]: ../../traffic-manager/traffic-manager-manage-profiles.md
[ARMTrafficManager]: ../../traffic-manager/traffic-manager-powershell-arm.md
[RegisterCustomDomain]: ../app-service-web-tutorial-custom-domain.md


<!-- IMAGES -->
[ConceptualArchitecture]: ./media/app-service-app-service-environment-geo-distributed-scale/ConceptualArchitecture-1.png
[CNAMEforCustomDomain]:  ./media/app-service-app-service-environment-geo-distributed-scale/CNAMECustomDomain-1.png
[DNSLookup]:  ./media/app-service-app-service-environment-geo-distributed-scale/DNSLookup-1.png
[CustomDomain]:  ./media/app-service-app-service-environment-geo-distributed-scale/CustomDomain-1.png 
