---
title: Создание ILB ASE v1
description: Создайте среду службы приложений с внутренним балансером нагрузки (ILB ASE). Этот документ предоставляется только для клиентов, которые используют наследие v1 ASE.
author: stefsch
ms.assetid: 091decb6-b0de-42a1-9f2f-c18d9b2e67df
ms.topic: article
ms.date: 07/11/2017
ms.author: stefsch
ms.custom: seodec18
ms.openlocfilehash: f05780610a2a6033b069721b143aca5e5efa6c35
ms.sourcegitcommit: 6397c1774a1358c79138976071989287f4a81a83
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2020
ms.locfileid: "80804526"
---
# <a name="how-to-create-an-ilb-ase-using-azure-resource-manager-templates"></a>Создание среды службы приложений с внутренним балансировщиком нагрузки с помощью шаблонов Azure Resource Manager

> [!NOTE] 
> Эта статья посвящена среде службы приложений версии 1. Имеется более новая версия среды службы приложений, которая проще в использовании и которая работает на более мощной инфраструктуре. Чтобы узнать больше о новой версии начать с [Введением в среду службы приложений](intro.md).
>

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор
Вместо общедоступного виртуального IP-адреса для создания среды службы приложений (ASE) можно использовать внутренний адрес виртуальной сети.  Этот внутренний адрес принадлежит компоненту Azure, который называется внутренним балансировщиком нагрузки.  Среду ASE с внутренним балансировщиком нагрузки можно создать на портале Azure.  Ее также можно создать автоматически с помощью шаблонов Azure Resource Manager.  В этой статье описаны действия и синтаксис, необходимые для создания ASE с внутренним балансировщиком нагрузки с помощью шаблонов Azure Resource Manager.

Автоматическое создание среды ASE с внутренним балансировщиком нагрузки предусматривает три шага:

1. Сначала в виртуальной сети создается базовая среда ASE, для чего вместо общедоступного виртуального IP-адреса используется адрес внутреннего балансировщика нагрузки.  Кроме того, на этом шаге ASE с внутренним балансировщиком нагрузки присваивается имя корневого домена.
2. После создания ILB ASE загружается сертификат TLS/SSL.  
3. Загруженный сертификат TLS/SSL явно присваивается ILB ASE в качестве «по умолчанию» TLS/SSL-сертификата.  Этот сертификат TLS/SSL будет использоваться для tLS трафика для приложений на ILB ASE, когда приложения будут адресованы с помощью общего корневого домена, назначенного ASE `https://someapp.mycustomrootcomain.com`(например)

## <a name="creating-the-base-ilb-ase"></a>Создание базовой среды ASE с внутренним балансировщиком нагрузки
Пример шаблона Azure Resource Manager и соответствующий файл параметров доступны на сайте GitHub [здесь][quickstartilbasecreate].

Большинство параметров в файле *azuredeploy.parameters.json* используются при создании как ASE с внутренним балансировщиком нагрузки, так и ASE с привязкой к общедоступному виртуальному IP-адресу.  Ниже приведены параметры с особыми примечаниями и уникальные параметры, используемые при создании ASE с внутренним балансировщиком нагрузки.

* *internalLoadBalancingMode*: В большинстве случаев установить это на 3, что означает, как HTTP/HTTPS трафик на портах 80/443, и контроль / данные каналов портов, прослушиваемых службой FTP на ASE, будет связан с ILB выделенных виртуальных сетевых внутренних адресов.  Если задать для этого свойства значение 2, к адресу внутреннего балансировщика нагрузки будут привязаны только порты, связанные со службой FTP (канала данных и канала управления), а HTTP- и HTTP-трафик останется привязанным к общедоступному виртуальному IP-адресу.
* *dnsSuffix*. Этот параметр определяет корневой домен по умолчанию, который будет назначен среде службы приложений.  В общедоступной версии службы приложений Azure корневой домен по умолчанию для всех веб-приложений — *azurewebsites.net*.  Однако так как ASE с внутренним балансировщиком нагрузки является внутренней для виртуальной сети пользователя, бессмысленно использовать корневой домен по умолчанию общедоступной службы.  Вместо этого ASE с внутренним балансировщиком нагрузки необходимо назначить корневой домен по умолчанию, который целесообразно использовать в пределах внутренней виртуальной сети компании.  Например, гипотетическая компания Contoso может использовать корневой домен по умолчанию *internal-contoso.com* для приложений, которые должны быть разрешаемыми и доступными только в виртуальной сети компании Contoso. 
* *ipSslAddressCount*. Для этого параметра в файле *azuredeploy.json* автоматически задается значение 0, так как средам службы приложений с внутренним балансировщиком нагрузки назначен только адрес этого балансировщика.  Для ASE с внутренним балансировщиком нагрузки нет явно заданных адресов SSL на основе IP, поэтому для пула этих адресов необходимо задать значение 0. В противном случае произойдет ошибка подготовки. 

Когда файл *azuredeploy.parameters.json* для ASE с внутренним балансировщиком нагрузки будет заполнен, можно приступить к созданию соответствующей среды с помощью приведенного ниже фрагмента кода Powershell.  Измените пути к файлам в соответствии с расположением файлов шаблонов Azure Resource Manager на вашем компьютере.  Кроме того, введите собственные значения для имени развертывания Azure Resource Manager и группы ресурсов.

    $templatePath="PATH\azuredeploy.json"
    $parameterPath="PATH\azuredeploy.parameters.json"

    New-AzResourceGroupDeployment -Name "CHANGEME" -ResourceGroupName "YOUR-RG-NAME-HERE" -TemplateFile $templatePath -TemplateParameterFile $parameterPath

После отправки шаблона Azure Resource Manager для создания ASE с внутренним балансировщиком нагрузки потребуется несколько часов.  Созданная ASE с внутренним балансировщиком нагрузки появится на портале в списке сред службы приложений для подписки, использованной для развертывания.

## <a name="uploading-and-configuring-the-default-tlsssl-certificate"></a>Загрузка и настройка сертификата TLS/SSL "По умолчанию"
После создания ILB ASE сертификат TLS/SSL должен быть связан с ASE в качестве "по умолчанию" TLS/SSL-сертификата для создания tLS/SSL-соединений к приложениям.  Продолжая гипотетический пример Contoso Corporation, если суффикс DNS по умолчанию *https://some-random-app.internal-contoso.com* ASE *является internal-contoso.com,* то подключение к требует сертификата TLS/SSL, который действителен для *.internal-contoso.com*. 

Существует множество способов получения действительного сертификата TLS/SSL, включая внутренние CAs, покупку сертификата у внешнего эмитента и использование сертификата, подписанного самостоятельно.  Независимо от источника сертификата TLS/SSL, следующие атрибуты сертификата должны быть настроены должным образом:

* *Subject* — для этого атрибута необходимо задать значение \**.имя_корневого_домена.com*.
* *Subject Alternative Name* — этот атрибут должен содержать два значения: \**.имя_корневого_домена.com* и \**.scm.имя_корневого_домена.com*.  Причина второй записи заключается в том, что подключение TLS к сайту SCM/Kudu, связанное с каждым приложением, будет осуществляться с использованием адреса формы *your-app-name.scm.your-root-domain-here.com.*

При действительном сертификате TLS/SSL в руках необходимы два дополнительных подготовительных шага.  Сертификат TLS/SSL должен быть преобразован/сохранен в виде файла .pfx.  PFX-файл должен содержать все промежуточные и корневые сертификаты, а также быть защищен паролем.

Затем полученный файл .pfx должен быть преобразован в строку base64, поскольку сертификат TLS/SSL будет загружен с помощью шаблона Azure Resource Manager.  Эти шаблоны представлены в виде текстовых файлов. Такое преобразование требуется, чтобы добавить PFX-файл в качестве параметра шаблона.

В приведенном ниже фрагменте кода Powershell показано, как создать самозаверяющий сертификат, экспортировать его в формате PFX-файла, преобразовать PFX-файл в строку в кодировке Base64 и сохранить эту строку в отдельном файле.  Код PowerShell для преобразования в строку в кодировке Base64 взят из [блога скриптов Powershell][examplebase64encoding].

    $certificate = New-SelfSignedCertificate -certstorelocation cert:\localmachine\my -dnsname "*.internal-contoso.com","*.scm.internal-contoso.com"

    $certThumbprint = "cert:\localMachine\my\" + $certificate.Thumbprint
    $password = ConvertTo-SecureString -String "CHANGETHISPASSWORD" -Force -AsPlainText

    $fileName = "exportedcert.pfx"
    Export-PfxCertificate -cert $certThumbprint -FilePath $fileName -Password $password     

    $fileContentBytes = get-content -encoding byte $fileName
    $fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)
    $fileContentEncoded | set-content ($fileName + ".b64")

После успешного сгенерирования и преобразования сертификата TLS/SSL в закодированную строку base64 можно использовать пример шаблона менеджера ресурсов Azure на GitHub для [настройки сертификата TLS/SSL по умолчанию.][configuringDefaultSSLCertificate]

Ниже перечислены параметры, содержащиеся в файле *azuredeploy.parameters.json* .

* *appServiceEnvironmentName* — имя настраиваемой среды службы приложений с внутренним балансировщиком нагрузки.
* *existingAseLocation* — текстовая строка, содержащая регион Azure, где развернута среда службы приложений с внутренним балансировщиком нагрузки.  Например, центрально-южная часть США.
* *pfxBlobString* — представление PFX-файла в виде строки в кодировке Base64.  Нужно скопировать строку, содержащуюся в файле exportedcert.pfx.b64, и вставить ее в качестве значения атрибута *pfxBlobString* в фрагменте кода выше.
* *пароль*: Пароль, используемый для защиты файла .pfx.
* *certificateThumbprint* — отпечаток сертификата.  Если вы получите это значение из Powershell (например, значение *$certificate.Thumbprint* в приведенном выше фрагменте кода), его можно использовать без каких-либо изменений.  Однако если вы скопируете это значение в диалоговом окне сертификатов Windows, в нем нужно удалить лишние пробелы.  *СертификатБольшой отпечаток* должен выглядеть примерно так: AF3143EB61D43F677784115BB7F17BBCECACACAE
* *certificateName* — понятный идентификатор строки для сертификата. Пользователь может выбрать его по своему усмотрению.  Имя используется как часть уникального идентификатора ресурсов Azure Manager для *сущности Microsoft.Web/сертификатов,* представляющей сертификат TLS/SSL.  Название **должно** заканчиваться следующим суффиксом: \_yourASENameHere_InternalLoadBalancingASE.  Этот суффикс сообщает порталу о том, что для обеспечения безопасности ASE с поддержкой ILB используется сертификат.

Ниже приведен сокращенный пример файла *azuredeploy.parameters.json* .

    {
         "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json",
         "contentVersion": "1.0.0.0",
         "parameters": {
              "appServiceEnvironmentName": {
                   "value": "yourASENameHere"
              },
              "existingAseLocation": {
                   "value": "East US 2"
              },
              "pfxBlobString": {
                   "value": "MIIKcAIBAz...snip...snip...pkCAgfQ"
              },
              "password": {
                   "value": "PASSWORDGOESHERE"
              },
              "certificateThumbprint": {
                   "value": "AF3143EB61D43F6727842115BB7F17BBCECAECAE"
              },
              "certificateName": {
                   "value": "DefaultCertificateFor_yourASENameHere_InternalLoadBalancingASE"
              }
         }
    }

После заполнения файла *azuredeploy.parameters.json* сертификат TLS/SSL по умолчанию может быть настроен с помощью следующего фрагмента кода Powershell.  Измените пути к файлам в соответствии с расположением файлов шаблонов Azure Resource Manager на вашем компьютере.  Кроме того, введите собственные значения для имени развертывания Azure Resource Manager и группы ресурсов.

    $templatePath="PATH\azuredeploy.json"
    $parameterPath="PATH\azuredeploy.parameters.json"

    New-AzResourceGroupDeployment -Name "CHANGEME" -ResourceGroupName "YOUR-RG-NAME-HERE" -TemplateFile $templatePath -TemplateParameterFile $parameterPath

Когда шаблон Azure Resource Manager будет отправлен, применение изменений для одного внешнего интерфейса ASE займет примерно сорок минут.  Например, для среды ASE с размером по умолчанию, содержащей два внешних интерфейса, реализация шаблона займет примерно один час и двадцать минут.  Во время выполнения шаблона нельзя масштабировать среду ASE.  

Как только шаблон завершается, приложения на ILB ASE могут быть доступны через HTTPS и соединения будут защищены с помощью сертификата TLS/SSL по умолчанию.  Сертификат TLS/SSL по умолчанию будет использоваться при обращении с приложениями на ILB ASE с использованием комбинации имени приложения плюс имени хоста по умолчанию.  Например, *https://mycustomapp.internal-contoso.com* будет использоваться сертификат TLS/SSL по умолчанию для*q .internal-contoso.com*.

Однако, как и приложения, работающие на общедоступном мультитенантном сервисе, разработчики могут также настроить пользовательские имена хостов для отдельных приложений, а затем настроить уникальные привязки сертификатов SNI TLS/SSL для отдельных приложений.  

## <a name="getting-started"></a>Начало работы
Сведения о том, как начать работу со средами службы приложений, см. в статье [Введение в среду службы приложений](app-service-app-service-environment-intro.md).

[!INCLUDE [app-service-web-try-app-service](../../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[quickstartilbasecreate]: https://azure.microsoft.com/documentation/templates/201-web-app-ase-ilb-create/
[examplebase64encoding]: https://powershellscripts.blogspot.com/2007/02/base64-encode-file.html 
[configuringDefaultSSLCertificate]: https://azure.microsoft.com/documentation/templates/201-web-app-ase-ilb-configure-default-ssl/ 

