---
title: Блокировка исходящего трафика из Среды службы приложений Azure
description: Руководство по интеграции с брандмауэром Azure для защиты исходящего трафика
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 955a4d84-94ca-418d-aa79-b57a5eb8cb85
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/29/2019
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 3e24b95704249a8a0b7588112cbaa678ae1e2c86
ms.sourcegitcommit: 08d3a5827065d04a2dc62371e605d4d89cf6564f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/29/2019
ms.locfileid: "68619136"
---
# <a name="locking-down-an-app-service-environment"></a>Блокирование среды службы приложений

Среда Службы приложений (ССП) имеет ряд внешних зависимостей, доступ к которым необходим для правильной работы. ССП находится в пользовательской виртуальной сети Azure (VNet). Пользователи должны разрешить трафик зависимостей ССП, что является проблемой для тех пользователей, которым нужно заблокировать все выходы из своей виртуальной сети.

ССП имеет ряд входящих зависимостей. Входящий трафик управления невозможно отправлять через устройство брандмауэра. Исходные адреса этого трафика известны и опубликованы в документе [Адреса управления среды Службы приложений](https://docs.microsoft.com/azure/app-service/environment/management-addresses). Используя эту информацию можно создать группу безопасности сети, которая защитит входящий трафик.

Исходящие зависимости СПП почти полностью определены с помощью FQDN, которые не содержат статических адресов. Отсутствие статических адресов означает, что для блокировки исходящего из СПП трафика нельзя использовать группу безопасности сети. Адреса часто меняются, поэтому создать правила, основанные на текущем разрешении, и использовать их для создания NSG невозможно. 

Решение для защиты исходящих адресов заключается в использовании устройства брандмауэра, которое может контролировать исходящий трафик на основе доменных имен. Брандмауэр Azure может ограничить исходящий трафик HTTP и HTTPS на основе FQDN назначения.  

## <a name="system-architecture"></a>Архитектура системы

Для развертывания ASE с исходящим трафиком, который проходит через устройство брандмауэра, необходимо изменить маршруты в подсети ASE. Маршруты работают на уровне IP-адреса. Если вы не следите за определением маршрутов, вы можете принудительно применить ответный трафик TCP к источнику из другого адреса. Это называется асимметричной маршрутизацией и будет нарушить работу протокола TCP.

Должны быть определены маршруты, чтобы входящий трафик в ASE мог ответить обратно таким же образом, как и поступил трафик. Это справедливо для входящих запросов управления, и это справедливо для входящих запросов приложений.

Входящий и исходящий трафик ASE должен соответствовать следующим соглашениям.

* Трафик к Azure SQL, хранилищу и концентратору событий не поддерживается при использовании устройства брандмауэра. Этот трафик должен быть отправлен непосредственно в эти службы. Это можно сделать, настроив конечные точки службы для этих трех служб. 
* Необходимо определить правила таблицы маршрутов, которые отправляют входящий трафик управления обратно из места поступления.
* Необходимо определить правила таблицы маршрутов, которые отправляют входящий трафик приложения обратно из места поступления. 
* Весь остальной трафик, исходящий из ASE, можно отправить на устройство брандмауэра с помощью правила таблицы маршрутов.

![Сетевые подключения Среды службы приложений с Брандмауэром Azure][5]

## <a name="configuring-azure-firewall-with-your-ase"></a>Настройка брандмауэра Azure с помощью СПП 

Шаги по блокировке исходящего трафика существующей Среды службы приложений с помощью Брандмауэра Azure:

1. Включите конечные точки служб для SQL, службы хранилища и концентратора событий в подсети ASE. Для этого перейдите на портал сети, перейдите к подсетям и выберите Microsoft.EventHub, Microsoft.SQL и Microsoft.Storage из раскрывающегося списка конечных точек служб. Включив конечные точки служб для SQL Azure, необходимо также настроить конечные точки для всех зависимостей SQL Azure, которые есть у ваших приложений. 

   ![Выбор конечных точек служб][2]
  
1. Создайте подсеть с именем AzureFirewallSubnet в виртуальной сети, в которой находится Среда службы приложений. Следуйте указаниям, приведенным в [документации по Брандмауэру Azure](https://docs.microsoft.com/azure/firewall/), чтобы создать Брандмауэр Azure.
1. В пользовательском интерфейсе Брандмауэра Azure откройте "Правила" > "Коллекция правил приложения" и выберите "Добавить коллекцию правил приложения". Укажите имя, приоритет и в поле "Действие" установите значение "Разрешить". В области тегов полных доменных имен введите имя, задайте * в качестве исходного адреса и выберите значение "Среда службы приложений" и "Центр обновления Windows". 
   
   ![Добавление правила приложения][1]
   
1. В пользовательском интерфейсе Брандмауэра Azure откройте "Правила" > "Коллекция правил сети" и выберите "Добавить коллекцию правил сети". Укажите имя, приоритет и в поле "Действие" установите значение "Разрешить". В области "Правила" введите имя, в поле "Протокол" выберите **Любой**, в полях адресов источника и назначения укажите *, а в поле "Порты назначения" — 123. Это правило позволяет системе выполнять синхронизации часов, используя NTP. Таким же образом создайте правило для порта 12000, чтобы упростить диагностику проблем с системой.

   ![Добавление сетевого правила NTP][3]

1. Создайте таблицу маршрутов с помощью адресов управления из документации [Адреса управления среды Службы приложений]( https://docs.microsoft.com/azure/app-service/environment/management-addresses) со следующим прыжком Интернета. Записи таблицы маршрутов необходимы для предотвращения проблем с асимметричной маршрутизацией. Добавьте маршруты для зависимостей IP-адресов, указанных ниже в зависимостях IP-адреса, со следующим прыжком Интернета. Добавьте маршрут виртуального модуля к таблице маршрутов для 0.0.0.0/0, при этом следующий прыжок должен представлять частный IP-адрес вашего Брандмауэра Azure. 

   ![Создание таблицы маршрутов][4]
   
1. Назначьте таблицу маршрутов, созданную в вашей подсети Среды службы приложений.

#### <a name="deploying-your-ase-behind-a-firewall"></a>Развертывание Среды службы приложений за брандмауэром

Шаги по развертыванию Среды службы приложений с защитой брандмауэром аналогичны настройке существующей Среды службы приложений с Брандмауэром Azure, за исключением того, что необходимо будет создать соответствующую подсеть и выполнить предыдущие шаги. Чтобы создать Среду службы приложений в существующей подсети, необходимо [использовать шаблон Resource Manager](https://docs.microsoft.com/azure/app-service/environment/create-from-template).

## <a name="application-traffic"></a>Трафик приложения 

Вышеупомянутые шаги позволят вашей СПП работать без проблем. Чтобы удовлетворить потребности приложения, вам все же необходимо выполнить некоторые настройки. С приложениями в СПП, настроенными с помощью брандмауэра Azure, возникают две проблемы.  

- В Брандмауэр Azure или таблицу маршрутов необходимо добавить зависимости приложения. 
- Маршруты должны создаваться для трафика приложения, чтобы избежать проблемы с асимметричной маршрутизацией.

Если ваше приложение имеет зависимости, то их необходимо добавить в брандмауэр Azure. Создайте правила приложения, чтобы разрешать трафик протокола HTTP/HTTPS, и правила сети для всего остального. 

Если вам известен диапазон адресов, из которых будет поступать трафик запроса к приложению, то вы можете добавить его в таблицу маршрутов, назначенную вашей подсети СПП. Если диапазон адресов большой или не задан, то вы можете использовать сетевое устройство, такое как приложение Gateway, которое даст вам один адрес, который необходимо добавить в таблицу маршрутов. Дополнительные сведения о настройке шлюза приложений с подсистемой балансировки нагрузки СПП см. в статье [Интеграция среды Службы приложений с внутренней подсистемой балансировки нагрузки со шлюзом приложений Azure](https://docs.microsoft.com/azure/app-service/environment/integrate-with-application-gateway)

Такое использование Шлюза приложений — один из примеров того, как настроить систему. Если вы предпочтете этот вариант, вам понадобится добавить маршрут к таблице маршрутов подсети Среды службы приложений, чтобы ответный трафик, передаваемый в Шлюз приложений, поступал туда напрямую. 

## <a name="logging"></a>Ведение журнала 

Брандмауэр Azure может отправлять журналы в службу хранилища Azure, концентратор событий или в журналы Azure Monitor. Чтобы интегрировать приложение с любым поддерживаемым местом назначения, перейдите в раздел "Журналы диагностики"на портале Брандмауэра Azure и включите журналы для требуемого расположения. При интеграции с журналами Azure Monitor вы сможете увидеть ведение журналов с любым трафиком, отправляемым в Брандмауэр Azure. Чтобы просмотреть отклоняемый трафик, откройте раздел "Журналы" на портале Log Analytics и введите следующий запрос. 

    AzureDiagnostics | where msg_s contains "Deny" | where TimeGenerated >= ago(1h)
 
Интеграция Брандмауэра Azure с журналами Azure Monitor очень полезна при первом рабочем запуске приложения, когда вам известны не все зависимости приложения. См. дополнительные сведения о журналах Azure Monitor в статье [Анализ данных журнала в Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview)
 
## <a name="dependencies"></a>Зависимости

Следующие сведения требуются, только если вы хотите настроить не Брандмауэр Azure, а другой брандмауэр. 

- В разделе "Конечные точки" должны быть указаны конечные точки для включенных служб.
- Зависимости IP-адреса задаются для трафика, не использующего протокол HTTP/HTTPS (TCP и UDP-трафик)
- В устройство брандмауэра можно добавить FQDN конечных точек для протокола HTTP/HTTPS.
- Произвольные конечные точки для HTTP/HTTPS — это зависимости, которые могут меняться вместе со средой СПП в зависимости от количества квалификаторов. 
- Зависимости Linux становятся предметом беспокойства только при развертывании Linux-приложений в СПП. Если вы не развертываете Linux-приложения в СПП, то вам не обязательно добавлять эти адреса в брандмауэр. 

#### <a name="service-endpoint-capable-dependencies"></a>Зависимости конечной точки службы 

| Конечная точка |
|----------|
| Azure SQL |
| Служба хранилища Azure |
| Концентратор событий Azure |

#### <a name="ip-address-dependencies"></a>Зависимости IP-адреса

| Конечная точка | Подробнее |
|----------| ----- |
| \*:123 | Проверка часов NTP. Трафик проверяется в нескольких конечных точках на порте 123. |
| \*:12000 | Этот порт используется для некоторых операций мониторинга системы. Если он заблокирован, некоторые проблемы будет сложнее диагностировать, но Среда службы приложений сохранит работоспособность. |
| 40.77.24.27:80 | Требуется для отслеживания проблем ASE и оповещения о них |
| 40.77.24.27:443 | Требуется для отслеживания проблем ASE и оповещения о них |
| 13.90.249.229:80 | Требуется для отслеживания проблем ASE и оповещения о них |
| 13.90.249.229:443 | Требуется для отслеживания проблем ASE и оповещения о них |
| 104.45.230.69:80 | Требуется для отслеживания проблем ASE и оповещения о них |
| 104.45.230.69:443 | Требуется для отслеживания проблем ASE и оповещения о них |
| 13.82.184.151:80 | Требуется для отслеживания проблем ASE и оповещения о них |
| 13.82.184.151:443 | Требуется для отслеживания проблем ASE и оповещения о них |

При подключении Брандмауэра Azure все перечисленные ниже параметры автоматически настраиваются с тегами полных доменных имен. 

#### <a name="fqdn-httphttps-dependencies"></a>Зависимости FQDN протокола HTTP/HTTPS 

| Конечная точка |
|----------|
|graph.windows.net:443 |
|login.live.com:443 |
|login.windows.com:443 |
|login.windows.net:443 |
|login.microsoftonline.com:443 |
|client.wns.windows.com:443 |
|definitionupdates.microsoft.com:443 |
|go.microsoft.com:80 |
|go.microsoft.com:443 |
|www.microsoft.com:80 |
|www.microsoft.com:443 |
|wdcpalt.microsoft.com:443 |
|wdcp.microsoft.com:443 |
|ocsp.msocsp.com:443 |
|mscrl.microsoft.com:443 |
|mscrl.microsoft.com:80 |
|crl.microsoft.com:443 |
|crl.microsoft.com:80 |
|www.thawte.com:443 |
|crl3.digicert.com:80 |
|ocsp.digicert.com:80 |
|csc3-2009-2.crl.verisign.com:80 |
|crl.verisign.com:80 |
|ocsp.verisign.com:80 |
|cacerts.digicert.com:80 |
|azperfcounters1.blob.core.windows.net:443 |
|azurewatsonanalysis-prod.core.windows.net:443 |
|global.metrics.nsatc.net:80 |
|global.metrics.nsatc.net:443 |
|az-prod.metrics.nsatc.net:443 |
|antares.metrics.nsatc.net:443 |
|azglobal-black.azglobal.metrics.nsatc.net:443 |
|azglobal-red.azglobal.metrics.nsatc.net:443 |
|antares-black.antares.metrics.nsatc.net:443 |
|antares-red.antares.metrics.nsatc.net:443 |
|maupdateaccount.blob.core.windows.net:443 |
|clientconfig.passport.net:443 |
|packages.microsoft.com:443 |
|schemas.microsoft.com:80 |
|schemas.microsoft.com:443 |
|management.core.windows.net:443 |
|management.core.windows.net:80 |
|management.azure.com:443 |
|www.msftconnecttest.com:80 |
|shavamanifestcdnprod1.azureedge.net:443 |
|validation-v2.sls.microsoft.com:443 |
|flighting.cp.wd.microsoft.com:443 |
|dmd.metaservices.microsoft.com:80 |
|admin.core.windows.net:443 |
|prod.warmpath.msftcloudes.com:443 |
|prod.warmpath.msftcloudes.com:80 |
|azureprofileruploads.blob.core.windows.net:443 |
|azureprofileruploads2.blob.core.windows.net:443 |
|azureprofileruploads3.blob.core.windows.net:443 |
|azureprofileruploads4.blob.core.windows.net:443 |
|azureprofileruploads5.blob.core.windows.net:443 |
|azureprofilerfrontdoor.cloudapp.net:443 |

#### <a name="wildcard-httphttps-dependencies"></a>Зависимости подстановочного знака протокола HTTP/HTTPS 

| Конечная точка |
|----------|
|gr-Prod-\*.cloudapp.net:443 |
| \*.management.azure.com:443 |
| \*.update.microsoft.com:443 |
| \*.windowsupdate.microsoft.com:443 |

#### <a name="linux-dependencies"></a>Зависимости Linux 

| Конечная точка |
|----------|
|wawsinfraprodbay063.blob.core.windows.net:443 |
|registry-1.docker.io:443 |
|auth.docker.io:443 |
|production.cloudflare.docker.com:443 |
|download.docker.com:443 |
|us.archive.ubuntu.com:80 |
|download.mono-project.com:80 |
|packages.treasuredata.com:80|
|security.ubuntu.com:80 |

<!--Image references-->
[1]: ./media/firewall-integration/firewall-apprule.png
[2]: ./media/firewall-integration/firewall-serviceendpoints.png
[3]: ./media/firewall-integration/firewall-ntprule.png
[4]: ./media/firewall-integration/firewall-routetable.png
[5]: ./media/firewall-integration/firewall-topology.png
