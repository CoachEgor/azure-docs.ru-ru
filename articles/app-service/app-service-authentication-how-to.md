---
title: Расширенное использование AuthN/AuthO
description: Научитесь настраивать функцию проверки подлинности и авторизации в Службе приложений для различных сценариев и получать требования пользователей и различные токены.
ms.topic: article
ms.date: 10/24/2019
ms.custom: seodec18
ms.openlocfilehash: d57b196bf95ebdf31bc459ad4b9d718fd32ca495
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79280837"
---
# <a name="advanced-usage-of-authentication-and-authorization-in-azure-app-service"></a>Расширенное использование проверки подлинности и авторизации в Службе приложений Azure

В этой статье показано, как настроить встроенные [проверку подлинности и авторизацию в службе приложений](overview-authentication-authorization.md), а также управлять удостоверениями, используя приложение. 

Чтобы быстро приступить к работе, ознакомьтесь с одним из следующих руководств:

* [Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure (Windows)](app-service-web-tutorial-auth-aad.md)
* [Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure (Linux)](containers/tutorial-auth-aad.md)
* [Настройка приложения службы приложений для использования службы входа Azure Active Directory](configure-authentication-provider-aad.md)
* [Как настроить приложение службы приложений для использования имени для входа Facebook](configure-authentication-provider-facebook.md)
* [Настройка приложения для использования имени входа Google](configure-authentication-provider-google.md)
* [Настройка приложения для использования входа по учетной записи Майкрософт](configure-authentication-provider-microsoft.md)
* [Настройка приложения для использования имени входа Twitter](configure-authentication-provider-twitter.md)

## <a name="use-multiple-sign-in-providers"></a>Использование нескольких поставщиков входа

На портале нельзя напрямую настроить несколько поставщиков входа для пользователей (например, через Facebook и Twitter). Однако эту функцию можно легко добавить к функциональным возможностям вашего приложения. Для этого необходимо сделать следующее:

Во-первых, на странице **Authentication / Authorization** (Проверка подлинности и авторизация) на портале Azure настройте все поставщики удостоверений, которые нужно включить.

В раскрывающемся списке **Action to take when request is not authenticated** (Предпринимаемое действие, если проверка подлинности для запроса не выполнена) выберите **Разрешить анонимные запросы (нет действия)**.

На странице входа, на панели навигации или в любом другом расположении приложения добавьте ссылку входа для каждого включенного поставщика (`/.auth/login/<provider>`). Пример:

```HTML
<a href="/.auth/login/aad">Log in with Azure AD</a>
<a href="/.auth/login/microsoftaccount">Log in with Microsoft Account</a>
<a href="/.auth/login/facebook">Log in with Facebook</a>
<a href="/.auth/login/google">Log in with Google</a>
<a href="/.auth/login/twitter">Log in with Twitter</a>
```

Когда пользователь щелкнет одну из этих ссылок, откроется соответствующая страница для входа.

Чтобы перенаправить пользователя после входа по пользовательскому URL-адресу, используйте параметр строки запроса `post_login_redirect_url` (не следует путать с URI перенаправления в конфигурации поставщика удостоверений). Например, чтобы перенаправить пользователя к `/Home/Index` после входа в систему, используйте следующий код HTML:

```HTML
<a href="/.auth/login/<provider>?post_login_redirect_url=/Home/Index">Log in</a>
```

## <a name="validate-tokens-from-providers"></a>Проверка токенов от поставщиков

При входе с помощью клиента приложение входит в систему поставщика вручную, а затем отправляет токен проверки подлинности службе приложений для проверки (см. [Поток проверки подлинности](overview-authentication-authorization.md#authentication-flow)). Эта проверка сама по себе не предоставляет вам доступ к требуемым ресурсам приложения, но успешная проверка даст вам токен сеанса, который вы можете использовать для доступа к ресурсам приложений. 

Чтобы проверить токен поставщика, для приложения службы приложений сначала нужно настроить требуемый поставщик. Получив токен проверки подлинности у своего поставщика, во время выполнения отправьте токен по адресу `/.auth/login/<provider>` для проверки. Пример: 

```
POST https://<appname>.azurewebsites.net/.auth/login/aad HTTP/1.1
Content-Type: application/json

{"id_token":"<token>","access_token":"<token>"}
```

Формат токена незначительно отличается в соответствии с поставщиком. Дополнительные сведения см. в таблице, приведенной ниже.

| Значение поставщика | Требуется в тексте запроса | Комментарии |
|-|-|-|
| `aad` | `{"access_token":"<access_token>"}` | |
| `microsoftaccount` | `{"access_token":"<token>"}` | Свойство `expires_in` необязательное. <br/>При запросе маркера из служб Live всегда запрашиваются области `wl.basic`. |
| `google` | `{"id_token":"<id_token>"}` | Свойство `authorization_code` необязательное. Если указано, при необходимости оно может сопровождаться свойством `redirect_uri`. |
| `facebook`| `{"access_token":"<user_access_token>"}` | Используйте допустимый [токен доступа пользователя](https://developers.facebook.com/docs/facebook-login/access-tokens) из Facebook. |
| `twitter` | `{"access_token":"<access_token>", "access_token_secret":"<acces_token_secret>"}` | |
| | | |

При успешной проверке токена поставщика API возвращается с `authenticationToken` в тексте ответа, который является вашим токеном сеанса. 

```json
{
    "authenticationToken": "...",
    "user": {
        "userId": "sid:..."
    }
}
```

Получив этот токен сеанса, вы можете получить доступ к защищенным ресурсам приложений, добавив заголовок `X-ZUMO-AUTH` к HTTP-запросам. Пример: 

```
GET https://<appname>.azurewebsites.net/api/products/1
X-ZUMO-AUTH: <authenticationToken_value>
```

## <a name="sign-out-of-a-session"></a>Выход из сеанса

Пользователи могут сделать выход, отправив запрос `GET` в конечную точку `/.auth/logout` приложения. Запрос `GET` выполняет следующие действия:

- Очищает файлы cookie проверки подлинности в текущем сеансе.
- Удаляет текущие маркеры пользователя из хранилища маркеров.
- Выполняет выход в поставщике удостоверений на стороне сервера для Azure Active Directory и Google.

Здесь представлена ссылка для простого выхода на веб-странице:

```HTML
<a href="/.auth/logout">Sign out</a>
```

После успешного выхода клиент по умолчанию перенаправляется на URL-адрес `/.auth/logout/done`. Можно изменить страницу перенаправления после выхода, добавив параметр запроса `post_logout_redirect_uri`. Пример:

```
GET /.auth/logout?post_logout_redirect_uri=/index.html
```

Рекомендуется [закодировать](https://wikipedia.org/wiki/Percent-encoding) значение `post_logout_redirect_uri`.

При использовании полного URL-адреса он должен размещаться в одном и том же домене или быть настроенным в качестве разрешенного URL-адреса внешнего перенаправления для приложения. В следующем примере показано перенаправление на адрес `https://myexternalurl.com`, который не размещен в одном и том же домене:

```
GET /.auth/logout?post_logout_redirect_uri=https%3A%2F%2Fmyexternalurl.com
```

Выполнить следующую команду в [облачной оболочке Azure:](../cloud-shell/quickstart.md)

```azurecli-interactive
az webapp auth update --name <app_name> --resource-group <group_name> --allowed-external-redirect-urls "https://myexternalurl.com"
```

## <a name="preserve-url-fragments"></a>Сохранение фрагментов URL-адреса

После входа в приложение пользователи обычно желают быть перенаправленными в один и тот же раздел той же страницы, например `/wiki/Main_Page#SectionZ`. Но так как [фрагменты URL-адреса](https://wikipedia.org/wiki/Fragment_identifier) (например, `#SectionZ`) никогда не отправляются на сервер, они не сохраняются по умолчанию после завершения входа OAuth и перенаправления обратно в приложение. Это неудобно для пользователей, когда им снова нужно перейти в требуемую закладку. Это ограничение распространяется на все решения аутентификации на стороне сервера.

При использовании аутентификации службы приложений можно сохранять фрагменты URL-адресов во время входа OAuth. Чтобы сделать это, установите для параметра приложения `WEBSITE_AUTH_PRESERVE_URL_FRAGMENT` значение `true`. Это можно сделать на [портале Azure](https://portal.azure.com) или просто выполнив следующую команду в [Azure Cloud Shell](../cloud-shell/quickstart.md):

```azurecli-interactive
az webapp config appsettings set --name <app_name> --resource-group <group_name> --settings WEBSITE_AUTH_PRESERVE_URL_FRAGMENT="true"
```

## <a name="access-user-claims"></a>Доступ к утверждениям пользователей

Служба приложений передает утверждения пользователей в приложение с помощью специальных заголовков. Эти заголовки нельзя настроить с помощью внешних запросов. Они присутствуют, только если это установлено службой приложений. Некоторые примеры заголовков включают:

* X-MS-CLIENT-PRINCIPAL-NAME
* X-MS-CLIENT-PRINCIPAL-ID

Сведения из этих заголовков можно получить с помощью кода, написанного на любом языке или в любой платформе. Для приложений ASP.NET 4.6 автоматически настраивается класс **ClaimsPrincipal** с соответствующими значениями. ASP.NET Core, однако, не предоставляет промежуточное программное обеспечение для проверки подлинности, которое интегрируется с требованиями пользователей Службы App. Для обхода, [см.](https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth)

В приложении можно также получить дополнительные сведения о пользователе, прошедшем проверку подлинности, путем вызова `/.auth/me`. Пакеты SDK для серверной части мобильных приложений предоставляют вспомогательные методы для работы с этими данными  Дополнительные сведения см. Дополнительные сведения см. в разделах [Практическое руководство. Использование утверждений аутентификации для таблиц](../app-service-mobile/app-service-mobile-node-backend-how-to-use-server-sdk.md#howto-tables-getidentity) и [Практическое руководство. Получение сведений о пользователе, прошедшем проверку подлинности](../app-service-mobile/app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#user-info).

## <a name="retrieve-tokens-in-app-code"></a>Извлечение токенов в коде приложения

Токены, предоставляющиеся поставщиком, вводятся в заголовке запроса из кода сервера, что позволяет легко получить к ним доступ. В следующей таблице показаны возможные заголовки токена.

| Поставщик | Имена заголовков |
|-|-|
| Azure Active Directory | `X-MS-TOKEN-AAD-ID-TOKEN` <br/> `X-MS-TOKEN-AAD-ACCESS-TOKEN` <br/> `X-MS-TOKEN-AAD-EXPIRES-ON`  <br/> `X-MS-TOKEN-AAD-REFRESH-TOKEN` |
| Токен Facebook | `X-MS-TOKEN-FACEBOOK-ACCESS-TOKEN` <br/> `X-MS-TOKEN-FACEBOOK-EXPIRES-ON` |
| Google | `X-MS-TOKEN-GOOGLE-ID-TOKEN` <br/> `X-MS-TOKEN-GOOGLE-ACCESS-TOKEN` <br/> `X-MS-TOKEN-GOOGLE-EXPIRES-ON` <br/> `X-MS-TOKEN-GOOGLE-REFRESH-TOKEN` |
| Учетная запись Майкрософт | `X-MS-TOKEN-MICROSOFTACCOUNT-ACCESS-TOKEN` <br/> `X-MS-TOKEN-MICROSOFTACCOUNT-EXPIRES-ON` <br/> `X-MS-TOKEN-MICROSOFTACCOUNT-AUTHENTICATION-TOKEN` <br/> `X-MS-TOKEN-MICROSOFTACCOUNT-REFRESH-TOKEN` |
| Twitter | `X-MS-TOKEN-TWITTER-ACCESS-TOKEN` <br/> `X-MS-TOKEN-TWITTER-ACCESS-TOKEN-SECRET` |
|||

В коде клиента (например, мобильного приложения или JavaScript в браузере) отправьте HTTP-запрос `GET` к `/.auth/me`. В возвращаемом JSON-файле будут содержаться предоставляемые поставщиком токены.

> [!NOTE]
> Токены доступа предназначены для получения доступа к ресурсам поставщика, поэтому они заданы, только если настройка поставщика осуществляется с помощью секрета клиента. Дополнительные сведения о том, как получить токены обновления, см. в разделе об обновлении маркеров доступа.

## <a name="refresh-identity-provider-tokens"></a>Обновление маркеров поставщика удостоверений

По истечении срока действия маркера доступа вашего провайдера (а не [токена сеанса](#extend-session-token-expiration-grace-period)) необходимо повторно подтвердить подлинность пользователя, прежде чем снова использовать этот маркер. Истечения срока действия токена можно избежать, выполнив вызов `GET` к конечной точке приложения `/.auth/refresh`. В этом случае служба приложений автоматически обновляет токены доступа в хранилище токенов для пользователя, прошедшего проверку подлинности. В результате последующих запросов на токены с помощью кода приложения будут возвращаться обновленные токены. Однако для правильного обновления токена в хранилище токенов должны содержаться [токены обновления](https://auth0.com/learn/refresh-tokens/) для поставщика. Способ получения токенов обновления документируется каждым поставщиком, но ниже приведено краткое описание.

- **Google**. Добавьте параметр строки запроса `access_type=offline` к вызову API `/.auth/login/google`. Если используется пакет SDK для мобильных служб, можно добавить параметр к одной из перегрузок `LogicAsync` (см. в разделе о [токенах обновления Google](https://developers.google.com/identity/protocols/OpenIDConnect#refresh-tokens)).
- **Facebook**. Не предоставляет токены обновления. Срок действия токенов с долгим временем существования истекает через 60 дней (см. раздел об [истечении и продлении срока действия токенов доступа Facebook](https://developers.facebook.com/docs/facebook-login/access-tokens/expiration-and-extension)).
- **Twitter**. Срок действия токенов доступа не истекает (см. раздел о [часто задаваемых вопросах о Twitter OAuth](https://developer.twitter.com/en/docs/basics/authentication/FAQ)).
- **Учетная запись Майкрософт**. [Настраивая параметры проверки подлинности учетной записи Майкрософт](configure-authentication-provider-microsoft.md), выберите область `wl.offline_access`.
- **Azure Active Directory**. В [https://resources.azure.com](https://resources.azure.com) сделайте следующее:
    1. В верхней части страницы выберите **Read/Write** (Чтение и запись).
    2. В левом браузере, перейдите к **подписке** > **_\<имя\__** > **_\<\_ _** >  > названия**ресурсов группы** > **_\<\_\_ресурсов группы>_**  >  **провайдеров** > **Microsoft.Web****сайты**приложения имя> >  **конфигурации** > **authsettings**. 
    3. Щелкните **Правка**.
    4. Измените следующее свойство. Замените _ \<идентификатор\_приложения>_ идентификатором приложения Azure Active Directory службы, к которому вы хотите получить доступ.

        ```json
        "additionalLoginParams": ["response_type=code id_token", "resource=<app_id>"]
        ```

    5. Щелкните **Put**. 

После настройки поставщика можно [найти токен обновления и срок действия для токена доступа](#retrieve-tokens-in-app-code) в хранилище токенов. 

Чтобы обновить токен доступа в любое время, просто позвоните `/.auth/refresh` на любом языке. В следующем фрагменте кода jQuery используется для обновления токенов доступа из клиента JavaScript.

```JavaScript
function refreshTokens() {
  let refreshUrl = "/.auth/refresh";
  $.ajax(refreshUrl) .done(function() {
    console.log("Token refresh completed successfully.");
  }) .fail(function() {
    console.log("Token refresh failed. See application logs for details.");
  });
}
```

Если пользователь отменяет разрешения, предоставленные приложению, вызов `/.auth/me` может завершиться ошибкой `403 Forbidden`. Чтобы выполнить диагностику ошибок, проверьте дополнительные сведения в журналах приложений.

## <a name="extend-session-token-expiration-grace-period"></a>Продление льготного периода срока действия токена сеанса

Сеанс проверки подлинности истекает через 8 часов. По истечении срока действия авторизованного сеанса по умолчанию предоставляется 72-часовой льготный период. В течение этого льготного периода токен сеанса можно обновить с помощью Службы приложений без повторной проверки подлинности пользователя. Если токен сеанса становится недействительным, вы можете просто вызвать `/.auth/refresh`, и вам не нужно самостоятельно отслеживать истечение срока действия токена. После завершения 72-часового льготного периода пользователь должен выполнить вход в систему, чтобы получить действительный токен сеанса.

Если 72 часов не достаточно, можно продлить этот льготный период. Значительное продление этого периода может повлиять на уровень безопасности (например, токен проверки подлинности может быть утерян или украден). В связи с этим следует оставить значение по умолчанию (72 часа) или установить для периода продления наименьшее значение.

Чтобы продлить льготный период истечения срока действия по умолчанию, выполните следующую команду в [Cloud Shell](../cloud-shell/overview.md).

```azurecli-interactive
az webapp auth update --resource-group <group_name> --name <app_name> --token-refresh-extension-hours <hours>
```

> [!NOTE]
> Льготный период применяется только к сеансу, проверка подлинности для которого осуществлялась с помощью службы приложений, а не токенов, предоставляемых поставщиками удостоверений. Льготный период на предоставленные поставщиком токены, срок действия которых истек, не распространяется. 
>

## <a name="limit-the-domain-of-sign-in-accounts"></a>Ограничение домена учетных записей для входа

Учетные записи Майкрософт и Azure Active Directory позволяют выполнять вход из нескольких доменов. Например, учетная запись Майкрософт позволяет выполнять вход с помощью учетных записей _outlook.com_, _live.com_ и _hotmail.com_. Azure AD позволяет использовать любое количество пользовательских доменов для учетных записей, вскакивающих в систему. Тем не менее, вы можете ускорить ваши пользователи прямо на свой собственный `contoso.com`фирменный Azure AD войти в страницу (например, ). Чтобы предложить доменное имя учетных записей, следуйте этим шагам.

В [https://resources.azure.com](https://resources.azure.com), перейдите к **подписке** > **_\<имя\__** > **_\<\_ _** >  >  > названия**ресурсов группы** >  >   >   > **_\<ресурсов\_\_группы>_** **провайдеров****Microsoft.Web****сайты**приложение имя>**конфигурации****authsettings**. 

Щелкните **Edit** (Изменить), измените следующее свойство и выберите **Put**. Не забудьте заменить _ \<доменное\_имя>_ доменом, который вы хотите.

```json
"additionalLoginParams": ["domain_hint=<domain_name>"]
```

Эта настройка `domain_hint` придает параметр строки запроса перенаправлению URL-адреса. 

> [!IMPORTANT]
> Клиент может удалить `domain_hint` параметр после получения url-адреса перенаправления, а затем войти в другой домен. Таким образом, хотя эта функция удобна, она не является функцией безопасности.
>

## <a name="authorize-or-deny-users"></a>Разрешить или отказать пользователям

В то время как Служба app занимается простейших случаев авторизации (т.е. отклонить непроверенные запросы), ваше приложение может потребовать более мелкозернистого поведения авторизации, например, ограничить доступ только к определенной группе пользователей. В некоторых случаях необходимо написать код пользовательского приложения, чтобы разрешить или отказать в доступе к пользователю, зарегистрированному в. В других случаях Служба поддержки приложений или поставщик идентификационных данных могут оказать помощь, не требуя изменений кода.

- [Уровень сервера](#server-level-windows-apps-only)
- [Уровень поставщика идентификационных данных](#identity-provider-level)
- [Уровень применения](#application-level)

### <a name="server-level-windows-apps-only"></a>Уровень сервера (только приложения Windows)

Для любого приложения Windows можно определить поведение авторизации веб-сервера IIS, редактируя файл *Web.config.* Приложения Linux не используют IIS и не могут быть настроены через *Web.config*.

1. Перейдите на страницу `https://<app-name>.scm.azurewebsites.net/DebugConsole`.

1. В браузере исследователь файлов службы приложений, перейдите на *сайт / wwwroot*. Если *Web.config* не существует, создайте его, выбрав **+**  >  **новый файл**. 

1. Выберите карандаш для *Web.config,* чтобы отсваить его. Добавьте следующий код конфигурации и нажмите **Сохранить**. Если *Web.config* уже существует, `<authorization>` просто добавьте элемент со всем в нем. Добавьте учетные записи, `<allow>` которые вы хотите разрешить в элементе.

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <configuration>
       <system.web>
          <authorization>
            <allow users="user1@contoso.com,user2@contoso.com"/>
            <deny users="*"/>
          </authorization>
       </system.web>
    </configuration>
    ```

### <a name="identity-provider-level"></a>Уровень поставщика идентификационных данных

Поставщик идентификационных данных может предоставить определенную авторизацию под ключ. Пример:

- Для [службы приложений Azure](configure-authentication-provider-aad.md)вы можете [управлять доступом на корпоративном уровне](../active-directory/manage-apps/what-is-access-management.md) непосредственно в Azure AD. Для получения инструкций см. [Как удалить доступ пользователя к приложению.](../active-directory/manage-apps/methods-for-removing-user-access.md)
- Для [Google,](configure-authentication-provider-google.md)Google API проекты, которые принадлежат [организации](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#organizations) могут быть настроены, чтобы разрешить доступ только к пользователям в вашей организации (см. [Google **Настройка OAuth 2.0** страницы поддержки](https://support.google.com/cloud/answer/6158849?hl=en)).

### <a name="application-level"></a>На уровне приложения

Если какой-либо из других уровней не предоставляет необходимую авторизацию или если ваша платформа или поставщик идентификационных данных не поддерживается, необходимо написать пользовательский код, чтобы авторизовать пользователей на основе [требований пользователя.](#access-user-claims)

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Учебник: Аутентифицировать и уполномочивать пользователей сквозной (Windows)](app-service-web-tutorial-auth-aad.md)
> [Учебник: Authenticate и авторизовать пользователей сквозной (Linux)](containers/tutorial-auth-aad.md)
