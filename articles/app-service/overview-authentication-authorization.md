---
title: Аутентификация и авторизация
description: Узнайте о встроенной поддержке аутентификации и авторизации в службе приложений Azure и о том, как она может помочь обезопасить приложение от несанкционированного доступа.
ms.assetid: b7151b57-09e5-4c77-a10c-375a262f17e5
ms.topic: article
ms.date: 08/12/2019
ms.reviewer: mahender
ms.custom: seodec18
ms.openlocfilehash: 825d113bbe081ba6fb85da19ff6449824db92d10
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79475397"
---
# <a name="authentication-and-authorization-in-azure-app-service"></a>Проверка подлинности и авторизация в службе приложений Azure

> [!NOTE]
> В настоящее время AAD V2 (включая MSAL) не поддерживается для служб приложений Azure и Функций Azure. Пожалуйста, проверьте обновления.
>

Служба приложений Azure обеспечивает встроенную поддержку проверки подлинности и авторизации, поэтому для входа пользователей в систему и предоставления доступа к данным необходимо написать минимальный код или обойтись без кода в веб-приложении, RESTfu API и серверной части мобильных приложений, а также в [Функциях Azure](../azure-functions/functions-overview.md). В этой статье описывается, как служба приложений помогает упростить проверку подлинности и авторизацию для вашего приложения.

Безопасные проверка подлинности и авторизация требуют глубокого понимания средств обеспечения безопасности, в том числе федерации, шифрования, управления [токенами JWT](https://wikipedia.org/wiki/JSON_Web_Token), [типов предоставления разрешений](https://oauth.net/2/grant-types/) и т. д. Служба приложений предоставляет эти служебные программы, чтобы вы могли уделять больше времени предоставлению бизнес-преимуществ для своего клиента.

> [!IMPORTANT]
> Вы не обязаны использовать службу приложений для AuthN/AuthO. Вы можете использовать пакетные функции безопасности в веб-инфраструктуре выбора, или вы можете написать свои собственные утилиты. Однако имейте в виду, что [Chrome 80 вносит перерывные изменения в его реализации SameSite для файлов cookie](https://www.chromestatus.com/feature/5088147346030592) (дата релиза в марте 2020 года), а пользовательские удаленной аутентификации или других сценариев, которые полагаются на кросс-сайт cookie размещения может сломаться, когда клиент Chrome браузеры обновляются. Обходной путь является сложным, поскольку он должен поддерживать различные поведения SameSite для различных браузеров. 
>
> Версии ASP.NET Core 2.1 и выше, размещенные Службой App, уже исправлены для этого изменения и соответствующие обработки Chrome 80 и более старых браузеров. Кроме того, в течение января 2020 года в экземплярах Службы приложений используется один и тот же патч для ASP.NET Framework 4.7.2. Для получения дополнительной информации, в том числе о [Azure App Service SameSite cookie update](https://azure.microsoft.com/updates/app-service-samesite-cookie-update/)том, как узнать, получил ли ваше приложение патч, см.
>

Сведения для собственных мобильных приложений см. в статье [Проверка подлинности и авторизация в мобильных приложениях Azure](../app-service-mobile/app-service-mobile-auth.md).

## <a name="how-it-works"></a>Принцип работы

Модуль проверки подлинности и авторизации выполняется в той же песочнице, что и код приложения. Если он включен, каждый входящий HTTP-запрос проходит через него перед обработкой кодом вашего приложения.

![](media/app-service-authentication-overview/architecture.png)

Этот модуль выполняет следующие операции для вашего приложения:

- проверку подлинности пользователей с указанным поставщиком;
- проверку, хранение и обновление токенов;
- управление сеансом с проверкой подлинности;
- вставка сведений об удостоверении в заголовки запросов.

Модуль работает отдельно от кода приложения и настраивается с помощью параметров приложения. Для кода приложения не нужны пакеты SDK, определенные языки или изменения. 

### <a name="user-claims"></a>Утверждения пользователя

Для всех языковых платформ служба приложений делает утверждения пользователя доступными для вашего кода, вставляя их в заголовки запросов. Для приложений ASP.NET 4.6 служба приложений заполняет свойство [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) утверждениями пользователя, прошедшими проверку подлинности, поэтому вы можете следовать стандартным шаблонам кода .NET, включая атрибут `[Authorize]`. Аналогичным образом для приложений PHP служба приложений заполняет переменную `_SERVER['REMOTE_USER']`. Для Java-приложений заявки [доступны из сервлета Tomcat.](containers/configure-language-java.md#authenticate-users-easy-auth)

Для [Функций Azure](../azure-functions/functions-overview.md)не `ClaimsPrincipal.Current` увлажняется код .NET, но вы все равно можете найти требования пользователя в заголовках запросов.

Дополнительные сведения см. в разделе [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя).

### <a name="token-store"></a>Хранилище токенов

Служба приложений предоставляет встроенное хранилище токенов, которое представляет собой репозиторий токенов, связанных с пользователями ваших веб-приложений, API или собственных мобильных приложений. При включении проверки подлинности с помощью любого поставщика это хранилище токенов немедленно становится доступным для вашего приложения. Если для кода вашего приложения требуется доступ к данным из этих поставщиков от имени пользователя, чтобы: 

- опубликовать запись в ленте Facebook прошедшего проверку подлинности пользователя;
- читать корпоративные данные пользователя с помощью API Графика Майкрософт

Как правило, вам необходимо писать код для сбора, хранения и обновления этих токенов в своем приложении. В хранилище токенов при необходимости вы просто [извлекаете токены](app-service-authentication-how-to.md#retrieve-tokens-in-app-code) и [указываете службе приложений обновить их](app-service-authentication-how-to.md#refresh-identity-provider-tokens), если они становятся недопустимыми. 

Токены идентификатора, доступа и обновления кэшируются для проверенного сеанса. Они доступны только соответствующему пользователю.  

Если вам не нужно использовать токены в приложении, вы можете отключить хранилище токенов.

### <a name="logging-and-tracing"></a>Ведение журнала и трассировка

Если вы [включите ведение журнала приложений](troubleshoot-diagnostic-logs.md), вы увидите трассировку проверки подлинности и авторизации непосредственно в файлах журналов. Если появится неожиданная ошибка проверки подлинности, вы можете легко найти все сведения, просмотрев имеющиеся журналы приложений. Если вы включили [трассировку неудачно завершенных запросов](troubleshoot-diagnostic-logs.md), вы можете точно определить, какую роль мог выполнять модуль проверки подлинности и авторизации в неудавшемся запросе. Найдите ссылки на модуль с именем `EasyAuthModule_32/64` в журналах трассировки. 

## <a name="identity-providers"></a>Поставщики удостоверений

Служба приложений использует [федеративную идентификацию](https://en.wikipedia.org/wiki/Federated_identity), при которой сторонний поставщик управляет удостоверениями пользователей и потоком проверки подлинности. По умолчанию доступны пять поставщиков удостоверений. 

| Поставщик | Конечная точка входа |
| - | - |
| [Azure Active Directory](../active-directory/fundamentals/active-directory-whatis.md) | `/.auth/login/aad` |
| [Учетная запись Майкрософт](../active-directory/develop/v2-overview.md) | `/.auth/login/microsoftaccount` |
| [Facebook](https://developers.facebook.com/docs/facebook-login) | `/.auth/login/facebook` |
| [Google](https://developers.google.com/identity/choose-auth) | `/.auth/login/google` |
| [Twitter](https://developer.twitter.com/en/docs/basics/authentication) | `/.auth/login/twitter` |

При включении проверки подлинности и авторизации с помощью одного из этих поставщиков конечная точка входа станет доступной для проверки подлинности пользователя и для проверки токенов проверки подлинности от поставщика. Вы можете легко предоставить своим пользователям любое количество этих вариантов входа. Кроме того, вы можете добавить другого поставщика удостоверений или [собственное настраиваемое решение для идентификации][custom-auth].

## <a name="authentication-flow"></a>Поток проверки подлинности

Поток проверки подлинности одинаков для всех поставщиков, но будет различным для разных способов входа в систему: с использованием пакета SDK поставщика или без.

- Без использования пакета SDK поставщика. Приложение делегирует федеративный вход в службу приложений. Обычно это относится к приложениям браузера, которые могут предоставить пользователю страницу входа поставщика. Код сервера управляет процессом входа, поэтому он также называется _управляемым сервером потоком_ или _потоком сервера_. Этот вариант применяется к браузерным приложениям. Он также относится к собственным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK для клиента мобильных приложений. Пакет SDK открывает веб-представление, в котором пользователи выполняют вход с помощью проверки подлинности службы приложений. 
- С использованием пакета SDK поставщика. Вход пользователей в приложение на странице поставщика выполняется вручную, а затем приложение отправляет маркер проверки подлинности в Службу приложений Azure для проверки. Обычно это относится к внебраузерным приложениям, которые не могут предоставить пользователю страницу входа в систему. Код приложения управляет процессом входа, поэтому его также называют _управляемым клиентом потоком_ или _потоком клиента_. Этот вариант применяется к REST API, [Функциям Azure](../azure-functions/functions-overview.md) и клиентам браузера JavaScript, а также к браузерным приложениям, которым требуется больше гибкости при входе в систему. Это также относится к собственным мобильным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK поставщика.

> [!NOTE]
> При осуществлении вызовов из доверенного приложения браузера в службе приложений другой REST API в службе приложений или [Функциях Azure](../azure-functions/functions-overview.md) может пройти проверку подлинности с помощью управляемого сервером потока. Дополнительные сведения см. в статье [Настройка проверки подлинности и авторизации в Службе приложений Azure](app-service-authentication-how-to.md).
>

В приведенной ниже таблице показаны шаги выполнения потока проверки подлинности.

| Шаг | Без использования пакета SDK поставщика | С использованием пакета SDK поставщика |
| - | - | - |
| 1. Войти в пользователя в | Перенаправляет клиента к `/.auth/login/<provider>`. | Код клиента выполняет вход пользователя непосредственно через пакет SDK поставщика и получает токен проверки подлинности. Дополнительные сведения см. в документации поставщика. |
| 2. Постаутентация | Поставщик перенаправляет клиент к `/.auth/login/<provider>/callback`. | Код клиента [публикует токен от поставщика](app-service-authentication-how-to.md#validate-tokens-from-providers) до `/.auth/login/<provider>` проверки. |
| 3. Установить аутентифицированную сессию | Служба приложений добавляет файлы cookie, прошедшие проверку подлинности, в ответ. | Служба приложений возвращает собственный токен проверки подлинности в код клиента. |
| 4. Подавать аутентифицированный контент | Клиент включает файлы cookie, прошедшие проверку подлинности, в последующие запросы (автоматически обрабатываются браузером). | Код клиента предоставляет токен проверки подлинности в заголовке `X-ZUMO-AUTH` (автоматически обрабатывается пакетами SDK для клиента мобильных приложений). |

Для клиентских браузеров служба приложений может автоматически перенаправлять всех не прошедших проверку пользователей к `/.auth/login/<provider>`. Вы также можете отправить пользователям одну или несколько ссылок `/.auth/login/<provider>`, чтобы они вошли в ваше приложение с использованием поставщика по выбору.

<a name="authorization"></a>

## <a name="authorization-behavior"></a>Поведение авторизации

На [портале Azure](https://portal.azure.com)можно настроить авторизацию Службы app с рядом моделей поведения, когда входящий запрос не проверен.

![](media/app-service-authentication-overview/authorization-flow.png)

Ниже описаны возможные варианты.

### <a name="allow-anonymous-requests-no-action"></a>Разрешить Анонимные запросы (без действия)

Эта опция откладывает авторизацию недостоверного трафика на код приложения. Для запросов, прошедших проверку подлинности, служба приложений также передает сведения о проверке подлинности в заголовках HTTP. 

Такой вариант обеспечивает большую гибкость в обработке анонимных запросов. Например, он позволяет [предоставлять пользователям несколько поставщиков входа](app-service-authentication-how-to.md#use-multiple-sign-in-providers). Тем не менее необходимо написать код. 

### <a name="allow-only-authenticated-requests"></a>Разрешить только запросы, прошедшие проверку подлинности

Параметр — **Войти с помощью \<поставщик>**. Служба приложений перенаправляет все анонимные запросы к `/.auth/login/<provider>` для выбранного вами поставщика. Если анонимный запрос поступает из собственного мобильного приложения, возвращаемый ответ `HTTP 401 Unauthorized`.

В этом случае в клиентском приложении не нужен код для проверки подлинности. Более точная авторизация, например авторизация для конкретной роли, может выполняться путем проверки утверждений пользователя (см. раздел [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя)).

> [!CAUTION]
> Ограничение доступа таким образом распространяется на все вызовы в ваше приложение, что может оказаться нежелательным для приложений, желающих иметь общедоступную домашнюю страницу, как это имеет место во многих одностраничных приложениях.

## <a name="more-resources"></a>Дополнительные ресурсы

[Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure (Windows)](app-service-web-tutorial-auth-aad.md)  
[Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure (Linux)](containers/tutorial-auth-aad.md)  
[Customize authentication and authorization in Azure App Service](app-service-authentication-how-to.md) (Настройка проверки подлинности и авторизации в Службе приложений Azure)

Практические руководства для поставщика:

* [Настройка приложения службы приложений для использования службы входа Azure Active Directory][AAD]
* [Как настроить приложение службы приложений для использования имени для входа Facebook][Facebook]
* [Настройка приложения для использования имени входа Google][Google]
* [Настройка приложения для использования входа по учетной записи Майкрософт][MSA]
* [Настройка приложения для использования имени входа Twitter][Twitter]
* [Практическое руководство. Использование пользовательской проверки подлинности для приложения][custom-auth]

[AAD]: configure-authentication-provider-aad.md
[Facebook]: configure-authentication-provider-facebook.md
[Google]: configure-authentication-provider-google.md
[MSA]: configure-authentication-provider-microsoft.md
[Twitter]: configure-authentication-provider-twitter.md

[custom-auth]: ../app-service-mobile/app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#custom-auth

[ADAL-Android]: ../app-service-mobile/app-service-mobile-android-how-to-use-client-library.md#adal
[ADAL-iOS]: ../app-service-mobile/app-service-mobile-ios-how-to-use-client-library.md#adal
[ADAL-dotnet]: ../app-service-mobile/app-service-mobile-dotnet-how-to-use-client-library.md#adal
