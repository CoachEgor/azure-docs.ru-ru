---
title: Аутентификация и авторизация
description: Узнайте о встроенной поддержке проверки подлинности и авторизации в службе приложений Azure и о том, как она помогает защитить приложение от несанкционированного доступа.
ms.assetid: b7151b57-09e5-4c77-a10c-375a262f17e5
ms.topic: article
ms.date: 08/12/2019
ms.reviewer: mahender
ms.custom: seodec18
ms.openlocfilehash: efef578f5c62bef4ae33b98b568fd6d5c1389c4a
ms.sourcegitcommit: f52ce6052c795035763dbba6de0b50ec17d7cd1d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2020
ms.locfileid: "76715109"
---
# <a name="authentication-and-authorization-in-azure-app-service"></a>Проверка подлинности и авторизация в службе приложений Azure

> [!NOTE]
> В настоящее время AAD v2 (включая MSAL) не поддерживается для служб приложений Azure и функций Azure. Ознакомьтесь с обновлениями.
>

Служба приложений Azure обеспечивает встроенную поддержку проверки подлинности и авторизации, поэтому для входа пользователей в систему и предоставления доступа к данным необходимо написать минимальный код или обойтись без кода в веб-приложении, RESTfu API и серверной части мобильных приложений, а также в [Функциях Azure](../azure-functions/functions-overview.md). В этой статье описывается, как служба приложений помогает упростить проверку подлинности и авторизацию для вашего приложения.

Безопасные проверка подлинности и авторизация требуют глубокого понимания средств обеспечения безопасности, в том числе федерации, шифрования, управления [токенами JWT](https://wikipedia.org/wiki/JSON_Web_Token), [типов предоставления разрешений](https://oauth.net/2/grant-types/) и т. д. Служба приложений предоставляет эти служебные программы, чтобы вы могли уделять больше времени предоставлению бизнес-преимуществ для своего клиента.

> [!IMPORTANT]
> Вы не обязаны использовать службу приложений для AuthN и Аусо. Вы можете использовать объединенные функции безопасности в вашей веб-среде или написать собственные служебные программы. Однако следует помнить, что [хром 80 вносит коренные изменения в реализацию SameSite для файлов cookie](https://www.chromestatus.com/feature/5088147346030592) (Дата выпуска около марта 2020), а также пользовательскую удаленную проверку подлинности или другие сценарии, использующие межсайтовые публикации файлов cookie, могут прерываться при обновлении клиентских браузеров Chrome. Обходной путь является сложным, так как он должен поддерживать различные поведения SameSite для различных браузеров. 
>
> ASP.NET Core 2,1 и более поздних версий, размещенных в службе приложений, уже исправлены для этого критического изменения и соответствующим образом обрабатывают браузеры Chrome 80 и более ранние версии. Кроме того, одно исправление для ASP.NET Framework 4.7.2 развертывается в экземплярах службы приложений в течение 2020 января. Дополнительные сведения, в том числе о том, как узнать, было ли приложение получено исправление, см. в [статье обновление файла cookie SameSite для службы приложений Azure](https://azure.microsoft.com/updates/app-service-samesite-cookie-update/).
>

Сведения для собственных мобильных приложений см. в статье [Проверка подлинности и авторизация в мобильных приложениях Azure](../app-service-mobile/app-service-mobile-auth.md).

## <a name="how-it-works"></a>Принцип работы

Модуль проверки подлинности и авторизации выполняется в той же песочнице, что и код приложения. Если он включен, каждый входящий HTTP-запрос проходит через него перед обработкой кодом вашего приложения.

![](media/app-service-authentication-overview/architecture.png)

Этот модуль выполняет следующие операции для вашего приложения:

- проверку подлинности пользователей с указанным поставщиком;
- проверку, хранение и обновление токенов;
- управление сеансом с проверкой подлинности;
- вставка сведений об удостоверении в заголовки запросов.

Модуль работает отдельно от кода приложения и настраивается с помощью параметров приложения. Для кода приложения не нужны пакеты SDK, определенные языки или изменения. 

### <a name="user-claims"></a>Утверждения пользователя

Для всех языковых платформ служба приложений делает утверждения пользователя доступными для вашего кода, вставляя их в заголовки запросов. Для приложений ASP.NET 4.6 служба приложений заполняет свойство [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) утверждениями пользователя, прошедшими проверку подлинности, поэтому вы можете следовать стандартным шаблонам кода .NET, включая атрибут `[Authorize]`. Аналогичным образом для приложений PHP служба приложений заполняет переменную `_SERVER['REMOTE_USER']`. Для приложений Java утверждения доступны в [Tomcat сервлета](containers/configure-language-java.md#authenticate-users-easy-auth).

В [Функциях Azure](../azure-functions/functions-overview.md) утверждения `ClaimsPrincipal.Current` не расконсервированы для кода .NET, но вы все равно можете найти утверждения пользователей в заголовках запросов.

Дополнительные сведения см. в разделе [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя).

### <a name="token-store"></a>Хранилище токенов

Служба приложений предоставляет встроенное хранилище токенов, которое представляет собой репозиторий токенов, связанных с пользователями ваших веб-приложений, API или собственных мобильных приложений. При включении проверки подлинности с помощью любого поставщика это хранилище токенов немедленно становится доступным для вашего приложения. Если для кода вашего приложения требуется доступ к данным из этих поставщиков от имени пользователя, чтобы: 

- опубликовать запись в ленте Facebook прошедшего проверку подлинности пользователя;
- прочитать корпоративные данные пользователя из API Graph Azure Active Directory или даже Microsoft Graph.

Как правило, вам необходимо писать код для сбора, хранения и обновления этих токенов в своем приложении. В хранилище токенов при необходимости вы просто [извлекаете токены](app-service-authentication-how-to.md#retrieve-tokens-in-app-code) и [указываете службе приложений обновить их](app-service-authentication-how-to.md#refresh-identity-provider-tokens), если они становятся недопустимыми. 

Токены идентификатора, доступа и обновления кэшируются для проверенного сеанса. Они доступны только соответствующему пользователю.  

Если вам не нужно использовать токены в приложении, вы можете отключить хранилище токенов.

### <a name="logging-and-tracing"></a>Ведение журнала и трассировка

Если вы [включите ведение журнала приложений](troubleshoot-diagnostic-logs.md), вы увидите трассировку проверки подлинности и авторизации непосредственно в файлах журналов. Если появится неожиданная ошибка проверки подлинности, вы можете легко найти все сведения, просмотрев имеющиеся журналы приложений. Если вы включили [трассировку неудачно завершенных запросов](troubleshoot-diagnostic-logs.md), вы можете точно определить, какую роль мог выполнять модуль проверки подлинности и авторизации в неудавшемся запросе. Найдите ссылки на модуль с именем `EasyAuthModule_32/64` в журналах трассировки. 

## <a name="identity-providers"></a>Поставщики удостоверений

Служба приложений использует [федеративную идентификацию](https://en.wikipedia.org/wiki/Federated_identity), при которой сторонний поставщик управляет удостоверениями пользователей и потоком проверки подлинности. По умолчанию доступны пять поставщиков удостоверений. 

| Поставщик | Конечная точка входа |
| - | - |
| [Azure Active Directory](../active-directory/fundamentals/active-directory-whatis.md) | `/.auth/login/aad` |
| [Учетная запись Майкрософт](../active-directory/develop/v2-overview.md) | `/.auth/login/microsoftaccount` |
| [Facebook](https://developers.facebook.com/docs/facebook-login) | `/.auth/login/facebook` |
| [Google](https://developers.google.com/identity/choose-auth) | `/.auth/login/google` |
| [Twitter](https://developer.twitter.com/en/docs/basics/authentication) | `/.auth/login/twitter` |

При включении проверки подлинности и авторизации с помощью одного из этих поставщиков конечная точка входа станет доступной для проверки подлинности пользователя и для проверки токенов проверки подлинности от поставщика. Вы можете легко предоставить своим пользователям любое количество этих вариантов входа. Вы также можете интегрировать другого поставщика удостоверений или [собственное пользовательское решение для идентификации][custom-auth].

## <a name="authentication-flow"></a>Поток проверки подлинности

Поток проверки подлинности одинаков для всех поставщиков, но будет различным для разных способов входа в систему: с использованием пакета SDK поставщика или без.

- Без использования пакета SDK поставщика. Приложение делегирует федеративный вход в службу приложений. Обычно это относится к приложениям браузера, которые могут предоставить пользователю страницу входа поставщика. Код сервера управляет процессом входа, поэтому он также называется _управляемым сервером потоком_ или _потоком сервера_. Этот вариант применяется к браузерным приложениям. Он также относится к собственным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK для клиента мобильных приложений. Пакет SDK открывает веб-представление, в котором пользователи выполняют вход с помощью проверки подлинности службы приложений. 
- С использованием пакета SDK поставщика. Вход пользователей в приложение на странице поставщика выполняется вручную, а затем приложение отправляет маркер проверки подлинности в Службу приложений Azure для проверки. Обычно это относится к внебраузерным приложениям, которые не могут предоставить пользователю страницу входа в систему. Код приложения управляет процессом входа, поэтому его также называют _управляемым клиентом потоком_ или _потоком клиента_. Этот вариант применяется к REST API, [Функциям Azure](../azure-functions/functions-overview.md) и клиентам браузера JavaScript, а также к браузерным приложениям, которым требуется больше гибкости при входе в систему. Это также относится к собственным мобильным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK поставщика.

> [!NOTE]
> При осуществлении вызовов из доверенного приложения браузера в службе приложений другой REST API в службе приложений или [Функциях Azure](../azure-functions/functions-overview.md) может пройти проверку подлинности с помощью управляемого сервером потока. Дополнительные сведения см. в статье [Настройка проверки подлинности и авторизации в Службе приложений Azure](app-service-authentication-how-to.md).
>

В приведенной ниже таблице показаны шаги выполнения потока проверки подлинности.

| Шаг | Без использования пакета SDK поставщика | С использованием пакета SDK поставщика |
| - | - | - |
| 1. вход пользователя | Перенаправляет клиента к `/.auth/login/<provider>`. | Код клиента выполняет вход пользователя непосредственно через пакет SDK поставщика и получает токен проверки подлинности. Дополнительные сведения см. в документации поставщика. |
| 2. После проверки подлинности | Поставщик перенаправляет клиент к `/.auth/login/<provider>/callback`. | Код клиента [отправляет маркер от поставщика](app-service-authentication-how-to.md#validate-tokens-from-providers) в `/.auth/login/<provider>` для проверки. |
| 3. Установите сеанс с проверкой подлинности | Служба приложений добавляет файлы cookie, прошедшие проверку подлинности, в ответ. | Служба приложений возвращает собственный токен проверки подлинности в код клиента. |
| 4. предоставление содержимого, прошедшего проверку подлинности | Клиент включает файлы cookie, прошедшие проверку подлинности, в последующие запросы (автоматически обрабатываются браузером). | Код клиента предоставляет токен проверки подлинности в заголовке `X-ZUMO-AUTH` (автоматически обрабатывается пакетами SDK для клиента мобильных приложений). |

Для клиентских браузеров служба приложений может автоматически перенаправлять всех не прошедших проверку пользователей к `/.auth/login/<provider>`. Вы также можете отправить пользователям одну или несколько ссылок `/.auth/login/<provider>`, чтобы они вошли в ваше приложение с использованием поставщика по выбору.

<a name="authorization"></a>

## <a name="authorization-behavior"></a>Поведение авторизации

В [портал Azure](https://portal.azure.com)можно настроить авторизацию службы приложений с помощью ряда поведений, если входящий запрос не прошел проверку подлинности.

![](media/app-service-authentication-overview/authorization-flow.png)

Ниже описаны возможные варианты.

### <a name="allow-anonymous-requests-no-action"></a>Разрешить анонимные запросы (без действий)

Этот параметр откладывает авторизацию трафика, не прошедшего проверку подлинности, в код приложения. Для запросов, прошедших проверку подлинности, служба приложений также передает сведения о проверке подлинности в заголовках HTTP. 

Такой вариант обеспечивает большую гибкость в обработке анонимных запросов. Например, он позволяет [предоставлять пользователям несколько поставщиков входа](app-service-authentication-how-to.md#use-multiple-sign-in-providers). Тем не менее необходимо написать код. 

### <a name="allow-only-authenticated-requests"></a>Разрешить только запросы, прошедшие проверку подлинности

Параметр — **Войти с помощью \<поставщик>** . Служба приложений перенаправляет все анонимные запросы к `/.auth/login/<provider>` для выбранного вами поставщика. Если анонимный запрос поступает из собственного мобильного приложения, возвращаемый ответ `HTTP 401 Unauthorized`.

В этом случае в клиентском приложении не нужен код для проверки подлинности. Более точная авторизация, например авторизация для конкретной роли, может выполняться путем проверки утверждений пользователя (см. раздел [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя)).

> [!CAUTION]
> Таким образом, ограниченный доступ применяется ко всем вызовам приложения, что может быть нежелательно для приложений, которым требуется общедоступная Домашняя страница, как во многих одностраничных приложениях.

## <a name="more-resources"></a>Дополнительные ресурсы

[Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure (Windows)](app-service-web-tutorial-auth-aad.md)  
[Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure (Linux)](containers/tutorial-auth-aad.md)  
[Customize authentication and authorization in Azure App Service](app-service-authentication-how-to.md) (Настройка проверки подлинности и авторизации в Службе приложений Azure)

Практические руководства для поставщика:

* [Настройка приложения для использования имени входа Azure Active Directory][AAD]
* [Настройка приложения для использования имени входа Facebook][Facebook]
* [Настройка приложения для использования имени входа Google][Google]
* [Настройка приложения для использования входа по учетной записи Майкрософт][MSA]
* [Настройка приложения для использования имени входа Twitter][Twitter]
* [Практическое руководство. Использование пользовательской проверки подлинности для приложения][custom-auth]

[AAD]: configure-authentication-provider-aad.md
[Facebook]: configure-authentication-provider-facebook.md
[Google]: configure-authentication-provider-google.md
[MSA]: configure-authentication-provider-microsoft.md
[Twitter]: configure-authentication-provider-twitter.md

[custom-auth]: ../app-service-mobile/app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#custom-auth

[ADAL-Android]: ../app-service-mobile/app-service-mobile-android-how-to-use-client-library.md#adal
[ADAL-iOS]: ../app-service-mobile/app-service-mobile-ios-how-to-use-client-library.md#adal
[ADAL-dotnet]: ../app-service-mobile/app-service-mobile-dotnet-how-to-use-client-library.md#adal
