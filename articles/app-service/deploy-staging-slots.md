---
title: Настройка промежуточных сред для веб-приложений в службе приложений Azure | Документация Майкрософт
description: Узнайте, как использовать промежуточную публикацию для веб-приложений в службе приложений Azure.
services: app-service
documentationcenter: ''
author: cephalin
writer: cephalin
manager: jpconnoc
editor: mollybos
ms.assetid: e224fc4f-800d-469a-8d6a-72bcde612450
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 09/19/2019
ms.author: cephalin
ms.custom: fasttrack-edit
ms.openlocfilehash: 7f98ba9851216737712b6be1ec29156ba0b1a68b
ms.sourcegitcommit: f523c8a8557ade6c4db6be12d7a01e535ff32f32
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/22/2019
ms.locfileid: "74382271"
---
# <a name="set-up-staging-environments-in-azure-app-service"></a>Настройка промежуточных сред в службе приложений Azure
<a name="Overview"></a>

При развертывании веб-приложения, веб-приложения в Linux, серверной части для мобильных устройств или приложения API в [службе приложений Azure](https://go.microsoft.com/fwlink/?LinkId=529714)можно использовать отдельный слот развертывания вместо рабочего слота по умолчанию при работе в **стандартном**, **расширенном**или **изолированном.** Уровень плана службы приложений. Слоты развертывания — это динамические приложения с собственными именами узлов. Содержимое приложений и элементы конфигурации можно переключать между двумя слотами развертывания (включая рабочий слот). 

Развертывание приложения в слоте, не являющимся рабочим, дает следующие преимущества:

* Внеся изменения в приложение, вы можете проверить их в промежуточном слоте развертывания, прежде чем переключать в рабочий слот.
* Развертывание приложения в промежуточном слоте и последующее переключение в рабочий слот гарантирует, что все экземпляры слота будут подготовлены до переключения в рабочую среду. Это позволит вам избежать простоя при развертывании приложения. Перенаправление трафика не вызывает затруднений, а запросы не теряются из-за операций переключения. Вы можете автоматизировать весь рабочий процесс, настроив [Автоматическое переключение](#Auto-Swap) , если проверка перед переключением не требуется.
* После переключения в слоте, где ранее находилась промежуточная версия приложения, будет размещено приложение, которое до этого было рабочим. Если изменения в рабочем слоте не соответствуют вашим ожиданиям, вы можете мгновенно переключиться назад к последней рабочей версии сайта.

Каждый уровень плана службы приложений поддерживает разное количество слотов развертывания. Дополнительная плата за использование слотов развертывания не взимается. Сведения о количестве слотов, поддерживаемых уровнем приложения, см. в разделе [ограничения службы приложений](https://docs.microsoft.com/azure/azure-subscription-service-limits#app-service-limits). 

Чтобы масштабировать приложение на другой уровень, убедитесь, что целевой уровень поддерживает количество слотов, которое уже использует ваше приложение. Например, если приложение содержит более пяти слотов, нельзя масштабировать его до уровня " **стандартный** ", так как уровень " **стандартный** " поддерживает только пять слотов развертывания. 

<a name="Add"></a>

## <a name="add-a-slot"></a>Добавление слота
Чтобы включить несколько слотов развертывания, приложение должно быть ценовой категории **Стандартный**, **Премиум** или **Изолированный**.

1. На [портале Azure](https://portal.azure.com/) откройте [страницу ресурсов](../azure-resource-manager/manage-resources-portal.md#manage-resources) приложения.

2. В левой области выберите **слоты развертывания** > **Добавить слот**.
   
    ![Добавить новый слот развернутого приложения](./media/web-sites-staged-publishing/QGAddNewDeploymentSlot.png)
   
   > [!NOTE]
   > Если приложение еще не находится на уровне " **стандартный**", " **премиум**" или " **изолированный** ", вы получаете сообщение с указанием поддерживаемых уровней для включения промежуточной публикации. На этом этапе вы можете выбрать вариант **Обновить** и перейти на вкладку **масштаб** приложения, прежде чем продолжить.
   > 

3. В диалоговом окне **Добавить слот** введите имя слота и укажите, следует ли клонировать конфигурацию приложения из другого слота развертывания. Нажмите кнопку **Добавить** , чтобы продолжить.
   
    ![Источник конфигурации](./media/web-sites-staged-publishing/ConfigurationSource1.png)
   
    Можно клонировать конфигурацию из любого существующего слота. При клонировании копируются такие параметры, как настройки приложения, строки подключения, языковые версии платформы, веб-сокеты, версия HTTP и разрядность платформы.

4. После добавления слота нажмите кнопку **Закрыть** , чтобы закрыть диалоговое окно. Теперь новый слот отображается на странице **слоты развертывания** . По умолчанию для параметра **трафик%** устанавливается значение 0 для нового слота, а весь трафик клиента направляется в рабочий слот.

5. Выберите новый слот развертывания, чтобы открыть страницу ресурсов этого слота.
   
    ![Заголовок слота развертывания](./media/web-sites-staged-publishing/StagingTitle.png)

    Страница управления для промежуточного слота ничем не отличается от страницы для любого приложения Службы приложений. Здесь вы можете изменить конфигурацию слота. В верхней части страницы отображается имя слота, напоминающее о том, что вы просматриваете слот развертывания.

6. Выберите URL-адрес приложения на странице ресурсов слота. Слот развертывания имеет собственное имя узла, а также активное приложение. Чтобы ограничить общий доступ к слоту развертывания, см. раздел [ограничения IP-адресов службы приложений Azure](app-service-ip-restrictions.md).

Новый слот развертывания не имеет содержимого, даже если вы клонировали параметры из другого слота. Например, можно [опубликовать в этом слоте с помощью Git](app-service-deploy-local-git.md). Вы можете выполнять развертывание в слот из другой ветви репозитория или даже из другого репозитория. 

<a name="AboutConfiguration"></a>

## <a name="what-happens-during-a-swap"></a>Что происходит во время переключения

### <a name="swap-operation-steps"></a>Шаги операции переключения

При переключении двух слотов (обычно из промежуточного слота в рабочий) служба приложений выполняет следующие действия, чтобы гарантировать, что целевой слот не будет работать просто:

1. Примените следующие параметры из целевого слота (например, рабочего слота) ко всем экземплярам исходного слота: 
    - Параметры приложения и строки подключения для [каждого слота](#which-settings-are-swapped) , если применимо.
    - Параметры [непрерывного развертывания](deploy-continuous-deployment.md) , если они включены.
    - Параметры [проверки подлинности службы приложений](overview-authentication-authorization.md) , если они включены.
    
    Любой из этих случаев вызывает перезапуск всех экземпляров в слоте источника. Во время [переключения с предварительным просмотром](#Multi-Phase)это означает конец первого этапа. Операция переключения приостановлена, и вы можете проверить правильность работы исходного слота с параметрами целевого слота.

1. Дождитесь завершения перезапуска каждого экземпляра в слоте источника. Если какой либо экземпляр не перезапускается, операция переключения вернет все изменения в исходный слот и прекратит выполнение операции.

1. Если [локальный кэш](overview-local-cache.md) включен, активируйте инициализацию локального кэша, выполнив HTTP-запрос к корню приложения ("/") на каждом экземпляре исходного слота. Дождитесь, пока каждый экземпляр возвратит ответ HTTP. Локальная Инициализация кэша вызывает еще один перезапуск на каждом экземпляре.

1. Если [Автоматическое переключение](#Auto-Swap) включено с помощью [настраиваемого прогрева](#Warm-up), активируйте [инициацию приложения](https://docs.microsoft.com/iis/get-started/whats-new-in-iis-8/iis-80-application-initialization) , выполнив HTTP-запрос к корневому каталогу приложения ("/") на каждом экземпляре исходного слота.

    Если `applicationInitialization` не указан, активируйте HTTP-запрос к корню исходного слота для каждого экземпляра. 
    
    Если экземпляр возвращает любой ответ HTTP, он считается подготовленным.

1. Если все экземпляры в исходном слоте успешно загружены, переключайте два слота, переключив правила маршрутизации для двух слотов. После выполнения этого шага в целевом слоте (например, в рабочем слоте) приложение, которое ранее было перегревается в исходном слоте.

1. Теперь, когда исходный слот имеет предварительно переставляемое приложение в целевом слоте, выполните ту же операцию, применив все параметры и перезапуская экземпляры.

В любой момент операции переключения вся работа по инициализации переключенных приложений происходит в исходном слоте. Целевой слот остается в сети во время подготовки и прогрева исходного слота, независимо от того, где происходит переключение. Чтобы переключить промежуточный слот на рабочий слот, убедитесь, что рабочий слот всегда является целевым слотом. Таким образом, операция переключения не влияет на рабочее приложение.

### <a name="which-settings-are-swapped"></a>Какие параметры переносятся?

[!INCLUDE [app-service-deployment-slots-settings](../../includes/app-service-deployment-slots-settings.md)]

Чтобы настроить параметр приложения или строку подключения для прикрепления к определенному слоту (не переключенному), перейдите на страницу **настройки** для этого слота. Добавьте или измените параметр, а затем выберите **параметр слот развертывания**. Установка этого флажка сообщает службе приложений, что параметр не может быть переключен. 

![Параметр слота](./media/web-sites-staged-publishing/SlotSetting.png)

<a name="Swap"></a>

## <a name="swap-two-slots"></a>Переключение двух слотов 
Слоты развертывания можно поменять на странице **слоты развертывания** приложения и на странице **обзора** . Технические сведения о переключении слотов см. в разделе [что происходит во время переключения](#AboutConfiguration).

> [!IMPORTANT]
> Прежде чем переключать приложение из слота развертывания в рабочую среду, убедитесь, что в качестве целевого слота используется рабочая среда, а все параметры в исходном слоте настроены так, как если бы они настроились в рабочей среде.
> 
> 

Для переключения слотов развертывания:

1. Перейдите на страницу **слотов развертывания** приложения и выберите **Переключить**.
   
    ![Кнопка переключения](./media/web-sites-staged-publishing/SwapButtonBar.png)

    В диалоговом окне **Переключение** отображаются параметры в выбранном исходном и целевом слотах, которые будут изменены.

2. Выберите **исходный** и **целевой** слоты. В качестве целевого чаще всего используется рабочий слот. Кроме того, выберите вкладки **исходные изменения** и **целевые изменения** и убедитесь, что изменения конфигурации ожидаемы. По завершении можно сразу поменять местами слоты, выбрав **Переключить**.

    ![Полное переключение](./media/web-sites-staged-publishing/SwapImmediately.png)

    Чтобы увидеть, как целевой слот будет работать с новыми параметрами, прежде чем произойдет переключение, не выбирайте параметр **поменять местами**, но следуйте инструкциям в разделе [Переключение с предварительной версией](#Multi-Phase).

3. По завершении закройте диалоговое окно, нажав кнопку **Закрыть**.

Если у вас возникнут проблемы, см. раздел [Устранение неполадок замены](#troubleshoot-swaps).

<a name="Multi-Phase"></a>

### <a name="swap-with-preview-multi-phase-swap"></a>Переключение с предварительным просмотром (многофазное переключение)

Перед переключением в рабочее место в качестве целевого слота убедитесь, что приложение выполняется с переименованными параметрами. Исходный слот также загревается до завершения переключения, что желательно для критически важных приложений.

При выполнении переключения с предварительным просмотром служба приложений выполняет ту же [операцию переключения](#AboutConfiguration) , но приостанавливается после первого шага. Затем можно проверить результат в промежуточном слоте перед завершением переключения. 

При отмене переключения служба приложений повторно применяет элементы конфигурации к исходному слоту.

Переключение с помощью предварительной версии:

1. Выполните действия, описанные в разделе [Переключение слотов развертывания](#Swap) , но выберите **выполнить переключение с помощью предварительной версии**.

    ![Переключение с предварительным просмотром](./media/web-sites-staged-publishing/SwapWithPreview.png)

    В этом диалоговом окне показано, как конфигурация в слоте источника изменяется в фазе 1, а также изменяется исходный и целевой слоты в фазе 2.

2. Когда вы будете готовы начать переключение, нажмите кнопку **начать подкачку**.

    Когда этап 1 завершается, вы получаете уведомления в диалоговом окне. Просмотрите подкачку в исходном слоте, перейдя к `https://<app_name>-<source-slot-name>.azurewebsites.net`. 

3. Когда все будет готово к завершению ожидающего переключения, выберите **завершить переключение** в **действие переключение** и нажмите кнопку **завершить переключение**.

    Чтобы отменить ожидающее переключение, выберите **отменить переключение** .

4. По завершении закройте диалоговое окно, нажав кнопку **Закрыть**.

Если у вас возникнут проблемы, см. раздел [Устранение неполадок замены](#troubleshoot-swaps).

Чтобы автоматизировать многофазное переключение, см. руководство [Автоматизация с помощью PowerShell](#automate-with-powershell).

<a name="Rollback"></a>

## <a name="roll-back-a-swap"></a>Откат переключения
Если в целевом слоте (обычно это рабочий слот) будут обнаружены ошибки после переключения слотов, немедленно восстановите прежнее (до переключения) состояние слотов, выполнив обратное переключение.

<a name="Auto-Swap"></a>

## <a name="configure-auto-swap"></a>Настройка автоматического переключения

> [!NOTE]
> Автоматическое переключение не поддерживается в веб-приложениях на платформе Linux.

Автоматическое переключение упрощает сценарии DevOps Azure, в которых необходимо постоянно развертывать приложения с нулевым запуском и нулевым временем простоя для клиентов приложения. При включении автоматического переключения из слота в рабочую среду при каждой отправке изменений кода в этот слот служба приложений автоматически перемещает [приложение в рабочую среду](#swap-operation-steps) после его прогрева в исходном слоте.

   > [!NOTE]
   > Перед настройкой автоматического переключения для рабочего слота рассмотрите возможность тестирования автоматического переключения в непроизводственном целевом слоте.
   > 

Настройка автоматического переключения:

1. Перейдите на страницу ресурсов приложения. Выберите **слоты развертывания** >  *\<требуемый исходный слот >*  > **Configuration** > **Общие параметры**.
   
2. Для **включения автоматического переключения**выберите **вкл**. Затем выберите требуемый целевой слот для **слота развертывания автоматического переключения**и нажмите кнопку **сохранить** на панели команд. 
   
    ![Выбор для настройки автоматического переключения](./media/web-sites-staged-publishing/AutoSwap02.png)

3. Передайте код в исходный слот. Автоматическое переключение происходит через некоторое время, а обновление отражается в URL-адресе целевого слота.

Если у вас возникнут проблемы, см. раздел [Устранение неполадок замены](#troubleshoot-swaps).

<a name="Warm-up"></a>

## <a name="specify-custom-warm-up"></a>Укажите настраиваемый прогрев

Перед переключением некоторые приложения могут потребовать дополнительных действий по прогреву. Элемент конфигурации `applicationInitialization` в файле Web. config позволяет указать настраиваемые действия инициализации. [Операция переключения](#AboutConfiguration) ожидает завершения этого пользовательского прогрева перед переключением целевого слота. Ниже приведен пример фрагмента Web. config.

    <system.webServer>
        <applicationInitialization>
            <add initializationPage="/" hostName="[app hostname]" />
            <add initializationPage="/Home/About" hostName="[app hostname]" />
        </applicationInitialization>
    </system.webServer>

Дополнительные сведения о настройке элемента `applicationInitialization` см. в разделе [типичные сбои переключения слотов развертывания и способы их устранения](https://ruslany.net/2017/11/most-common-deployment-slot-swap-failures-and-how-to-fix-them/).

Можно также настроить поведение при прогреве с помощью одного или обоих следующих [параметров приложения](configure-common.md):

- `WEBSITE_SWAP_WARMUP_PING_PATH`: путь для подготовки сайта к проверке связи. Добавьте этот параметр приложения, указав настраиваемый путь, который начинается с косой черты в качестве значения. Например, `/statuscheck`. По умолчанию используется значение `/`. 
- `WEBSITE_SWAP_WARMUP_PING_STATUSES`: допустимые коды HTTP-ответов для операции прогрева. Добавьте этот параметр приложения со списком кодов HTTP, разделенным запятыми. Пример — `200,202`. Если возвращенный код состояния отсутствует в списке, операции прогрева и замены останавливаются. По умолчанию все коды ответов являются допустимыми.

> [!NOTE]
> Элемент конфигурации `<applicationInitialization>` является частью каждого запуска приложения, в то время как два параметра, применяемые для прогрева, применяются только к переключениям слотов.

Если у вас возникнут проблемы, см. раздел [Устранение неполадок замены](#troubleshoot-swaps).

## <a name="monitor-a-swap"></a>Мониторинг переключения

Если [Операция переключения](#AboutConfiguration) занимает много времени, можно получить сведения об операции переключения в [журнале действий](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md).

На странице ресурсов приложения на портале в области слева выберите **Журнал действий**.

Операция переключения отображается в запросах журнала в виде `Swap Web App Slots`. Вы можете развернуть этот элемент и выбрать вложенные операции или ошибки, чтобы увидеть подробные сведения о них.

## <a name="route-traffic"></a>Маршрутизация трафика

По умолчанию все клиентские запросы, поступающие на URL-адрес приложения (`http://<app_name>.azurewebsites.net`), направляются в рабочий слот. Вы можете перенаправить часть этого трафика в другой слот. Это очень удобно, когда вам нужно собрать отзывы пользователей о новой версии, но вы пока не готовы публиковать ее в рабочей среде.

### <a name="route-production-traffic-automatically"></a>Автоматическая маршрутизация рабочего трафика

Для автоматического перенаправления рабочего трафика:

1. Перейдите на страницу ресурсов приложения и выберите **слоты развертывания**.

2. В столбце **Процент трафика** для слота, в который нужно направить часть трафика, укажите значение в процентах (от 0 до 100) от общего объема распределяемого трафика. Щелкните **Сохранить**.

    ![Установка процента трафика](./media/web-sites-staged-publishing/RouteTraffic.png)

После сохранения параметра заданный процент клиентов случайным образом направляется в нерабочий слот. 

После того как клиент автоматически направляется в конкретный слот, он прикрепляется к этому слоту в течение жизненного цикла этого клиентского сеанса. Вы можете проверить, к какому слоту прикреплен клиент, просмотрев значение параметра cookie `x-ms-routing-name` в заголовках HTTP средствами браузера. Если запросы направляются в промежуточный слот, этот параметр имеет значение `x-ms-routing-name=staging`. Если запросы направляются в рабочий слот, этот параметр имеет значение `x-ms-routing-name=self`.

   > [!NOTE]
   > Рядом с порталом Azure можно также использовать команду [`az webapp traffic-routing set`](/cli/azure/webapp/traffic-routing#az-webapp-traffic-routing-set) в Azure CLI, чтобы задать проценты маршрутизации из средств CI/CD, таких как конвейеры DevOps или другие системы автоматизации.
   > 

### <a name="route-production-traffic-manually"></a>Маршрутизация рабочего трафика вручную

Кроме автоматической маршрутизации трафика, Служба приложений поддерживает направление запросов в конкретные слоты. Это полезно, если вы хотите, чтобы пользователи могли принять участие в вашей бета-версии приложения или отказаться от него. Для маршрутизации рабочего трафика вручную применяется параметр запроса `x-ms-routing-name`.

Чтобы разрешить пользователям отказаться от использования бета-версии приложения, например, можно разместить эту ссылку на веб-странице:

```HTML
<a href="<webappname>.azurewebsites.net/?x-ms-routing-name=self">Go back to production app</a>
```

Строка `x-ms-routing-name=self` определяет рабочий слот. После того как браузер клиента попытается получить доступ к ссылке, он перенаправляется в рабочий слот. Каждый последующий запрос содержит файл cookie `x-ms-routing-name=self`, который закрепляет сеанс в рабочем слоте.

Чтобы разрешить пользователям использовать бета-версию приложения, задайте для одного и того же параметра запроса имя нерабочего слота. Ниже приведен пример:

```
<webappname>.azurewebsites.net/?x-ms-routing-name=staging
```

По умолчанию новым слотам присваивается правило маршрутизации `0%`, отображаемое серым цветом. Если это значение явно задано как `0%` (отображается в черном тексте), пользователи могут получить доступ к промежуточному слоту вручную с помощью параметра запроса `x-ms-routing-name`. Но они не будут направляться в слот автоматически, так как процент маршрутизации имеет значение 0. Это расширенный сценарий, в котором можно "скрыть" промежуточный слот от общедоступного, а также разрешить внутренним командам тестировать изменения в слоте.

<a name="Delete"></a>

## <a name="delete-a-slot"></a>Удаление слота

Перейдите на страницу ресурсов приложения. Выберите **слоты развертывания** >  *\<слот, чтобы удалить >*  > **Обзор**. На панели команд выберите **Удалить** .  

![Удаление слота развертывания](./media/web-sites-staged-publishing/DeleteStagingSiteButton.png)

<!-- ======== AZURE POWERSHELL CMDLETS =========== -->

<a name="PowerShell"></a>

## <a name="automate-with-powershell"></a>Автоматизация с помощью PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Azure PowerShell — это модуль, который предоставляет командлеты для управления Azure с помощью Windows PowerShell, а также поддерживает управление слотами развертывания в службе приложений Azure.

Сведения об установке и настройке Azure PowerShell и об аутентификации Azure PowerShell с использованием подписки Azure см. в разделе [Установка и настройка Microsoft Azure PowerShell](/powershell/azure/overview).  

---
### <a name="create-a-web-app"></a>Создание веб-приложения
```powershell
New-AzWebApp -ResourceGroupName [resource group name] -Name [app name] -Location [location] -AppServicePlan [app service plan name]
```

---
### <a name="create-a-slot"></a>Создание слота
```powershell
New-AzWebAppSlot -ResourceGroupName [resource group name] -Name [app name] -Slot [deployment slot name] -AppServicePlan [app service plan name]
```

---
### <a name="initiate-a-swap-with-a-preview-multi-phase-swap-and-apply-destination-slot-configuration-to-the-source-slot"></a>Запуск переключения с предварительным просмотром (Многофазное переключение) и применение конфигурации конечного слота к исходному слоту
```powershell
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action applySlotConfig -Parameters $ParametersObject -ApiVersion 2015-07-01
```

---
### <a name="cancel-a-pending-swap-swap-with-review-and-restore-the-source-slot-configuration"></a>Отмена ожидающего переключения (переключение с проверкой) и восстановление конфигурации исходного слота
```powershell
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action resetSlotConfig -ApiVersion 2015-07-01
```

---
### <a name="swap-deployment-slots"></a>Переключение слотов развертывания
```powershell
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action slotsswap -Parameters $ParametersObject -ApiVersion 2015-07-01
```

### <a name="monitor-swap-events-in-the-activity-log"></a>Мониторинг событий переключения в журнале действий
```powershell
Get-AzLog -ResourceGroup [resource group name] -StartTime 2018-03-07 -Caller SlotSwapJobProcessor  
```

---
### <a name="delete-a-slot"></a>Удаление слота
```powershell
Remove-AzResource -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots –Name [app name]/[slot name] -ApiVersion 2015-07-01
```

## <a name="automate-with-arm-templates"></a>Автоматизация с помощью шаблонов ARM

[Шаблоны ARM](https://docs.microsoft.com/azure/azure-resource-manager/template-deployment-overview) — это декларативные файлы JSON, используемые для автоматизации развертывания и настройки ресурсов Azure. Чтобы поменять местами слоты с помощью шаблонов ARM, необходимо задать два свойства в ресурсах *Microsoft. Web/Sites/слоты* и *Microsoft. Web/Sites* :

- `buildVersion`: это строковое свойство, представляющее текущую версию приложения, развернутого в слоте. Например: "v1", "1.0.0.1" или "2019-09-20T11:53:25.2887393-07:00".
- `targetBuildVersion`: это строковое свойство, указывающее, какие `buildVersion` должен иметься слот. Если Таржетбуилдверсион не равно текущему `buildVersion`, это приведет к активации операции переключения путем поиска слота с указанным `buildVersion`.

### <a name="example-arm-template"></a>Пример шаблона ARM

Следующий шаблон ARM обновит `buildVersion` промежуточного слота и задаст `targetBuildVersion` в рабочем слоте. Это позволит поменять местами два слота. В шаблоне предполагается, что у вас уже есть webapp, созданный с помощью слота с именем "промежуточное хранение".

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "my_site_name": {
            "defaultValue": "SwapAPIDemo",
            "type": "String"
        },
        "sites_buildVersion": {
            "defaultValue": "v1",
            "type": "String"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/slots",
            "apiVersion": "2018-02-01",
            "name": "[concat(parameters('my_site_name'), '/staging')]",
            "location": "East US",
            "kind": "app",
            "properties": {
                "buildVersion": "[parameters('sites_buildVersion')]"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2018-02-01",
            "name": "[parameters('my_site_name')]",
            "location": "East US",
            "kind": "app",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites/slots', parameters('my_site_name'), 'staging')]"
            ],
            "properties": {
                "targetBuildVersion": "[parameters('sites_buildVersion')]"
            }
        }        
    ]
}
```

Этот шаблон ARM — идемпотентными, то есть он может быть выполнен повторно и выдавать то же состояние слотов. После первого выполнения `targetBuildVersion` будет соответствовать текущему `buildVersion`, поэтому переключение не будет запущено.

<!-- ======== Azure CLI =========== -->

<a name="CLI"></a>

## <a name="automate-with-the-cli"></a>Автоматизация с помощью интерфейса командной строки

Чтобы ознакомиться с командами [Azure CLI](https://github.com/Azure/azure-cli) для слотов развертывания, изучите описание команды [az webapp deployment slot](/cli/azure/webapp/deployment/slot).

## <a name="troubleshoot-swaps"></a>Устранение неполадок переключения

Если во время [переключения слотов](#AboutConfiguration)возникает какая-либо ошибка, она заносится в *д:\хоме\логфилес\евентлог.ксмл*. Он также заносится в журнал ошибок конкретного приложения.

Ниже приведены некоторые распространенные ошибки переключения.

- Время HTTP-запроса к корню приложения истекло. Операция переключения ожидает в течение 90 секунд для каждого HTTP-запроса и повторяет попытку до 5 раз. Если время ожидания всех повторных попыток истекло, операция переключения останавливается.

- Инициализация локального кэша может завершиться ошибкой, если содержимое приложения превышает квоту локального диска, указанную для локального кэша. Дополнительные сведения см. в разделе [Общие сведения о локальном кэше](overview-local-cache.md).

- Во время [настраиваемого прогрева](#Warm-up)HTTP-запросы выполняются внутренним образом (без использования внешнего URL-адреса). Они могут завершиться ошибкой с определенными правилами переопределения URL-адресов в *файле Web. config*. Например, правила перенаправления доменных имен или принудительного применения HTTPS могут препятствовать выполнению запросов на прогрев кода приложения. Чтобы обойти эту неполадку, измените правила перезаписи, добавив следующие два условия:

    ```xml
    <conditions>
      <add input="{WARMUP_REQUEST}" pattern="1" negate="true" />
      <add input="{REMOTE_ADDR}" pattern="^100?\." negate="true" />
      ...
    </conditions>
    ```
- Без настраиваемых прогревов правила переопределения URL-адресов могут блокировать HTTP-запросы. Чтобы обойти эту проблему, измените правила перезаписи, добавив следующие условия.

    ```xml
    <conditions>
      <add input="{REMOTE_ADDR}" pattern="^100?\." negate="true" />
      ...
    </conditions>
    ```
- Некоторые [правила ограничения IP-адресов](app-service-ip-restrictions.md) могут препятствовать отправке HTTP-запросов в приложение операцией переключения. Диапазоны IPv4-адресов, начинающиеся с `10.` и `100.`, являются внутренними для вашего развертывания. Вы должны разрешить им подключаться к вашему приложению.

- После переключения слотов приложение может столкнуться с неожиданным перезапуском. Это обусловлено тем, что после переключения конфигурация привязки имени узла не синхронизирована, что сама по себе не приводит к перезапуску. Однако некоторые базовые события хранилища (такие как отказоустойчивость тома хранилища) могут обнаружить эти расхождения и принудительно перезапустить все рабочие процессы. Чтобы избежать перезагрузки этих типов, задайте [параметр приложения`WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG=1`](https://github.com/projectkudu/kudu/wiki/Configurable-settings#disable-the-generation-of-bindings-in-applicationhostconfig) во *всех слотах*. Однако этот параметр приложения *не* работает с приложениями Windows Communication Foundation (WCF).

## <a name="next-steps"></a>Дополнительная информация
[Ограничения статических IP-адресов в службе приложений Azure](app-service-ip-restrictions.md)
