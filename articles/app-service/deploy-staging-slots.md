---
title: Настройка промежуточных сред для веб-приложений в службе приложений Azure | Документация Майкрософт
description: Узнайте, как использовать промежуточную публикацию для веб-приложений в службе приложений Azure.
services: app-service
documentationcenter: ''
author: cephalin
writer: cephalin
manager: jpconnoc
editor: mollybos
ms.assetid: e224fc4f-800d-469a-8d6a-72bcde612450
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/03/2019
ms.author: cephalin
ms.openlocfilehash: 1e09eec89c683d36df49110227488a6413ed371c
ms.sourcegitcommit: 24fd3f9de6c73b01b0cee3bcd587c267898cbbee
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2019
ms.locfileid: "65955912"
---
# <a name="set-up-staging-environments-in-azure-app-service"></a>Настройка промежуточных сред в службе приложений Azure
<a name="Overview"></a>

> [!NOTE]
> В этом практическом руководстве показано, как управлять слотами, используя новую страницу управления (предварительная версия). Клиенты, которые привыкли к существующей странице управления слотами, могут продолжать использовать ее. 
>

Ценовые категории плана службы приложений **Стандартный**, **Премиум** и **Изолированный** позволяют развертывать веб-приложения, веб-приложения в Linux, серверные части мобильных приложений и приложения API в [службе приложений](https://go.microsoft.com/fwlink/?LinkId=529714) в отдельный слот развертывания вместо рабочего слота по умолчанию. Слоты развертывания фактически являются динамическими приложениями со своими собственными именами узлов. Содержимое приложений и элементы конфигурации можно переключать между двумя слотами развертывания (включая рабочий слот). Развертывание приложения в слоте, не являющимся рабочим, дает следующие преимущества:

* Внеся изменения в приложение, вы можете проверить их в промежуточном слоте развертывания, прежде чем переключать в рабочий слот.
* Развертывание приложения в промежуточном слоте и последующее переключение в рабочий слот гарантирует, что все экземпляры слота будут подготовлены до переключения в рабочую среду. Это позволит вам избежать простоя при развертывании приложения. Перенаправление трафика не вызывает затруднений, а запросы не теряются из-за операций переключения. Весь этот рабочий процесс можно автоматизировать, настроив функцию [автоматического переноса](#Auto-Swap), если проверка перед переносом не требуется.
* После переключения в слоте, где ранее находилась промежуточная версия приложения, будет размещено приложение, которое до этого было рабочим. Если изменения в рабочем слоте не соответствуют вашим ожиданиям, вы можете мгновенно переключиться назад к последней рабочей версии сайта.

Каждый уровень плана службы приложений поддерживает разное количество слотов развертывания. Чтобы узнать, сколько слотов поддерживает уровень вашего приложения, ознакомьтесь с ограничениями службы приложений в следующей [статье](https://docs.microsoft.com/azure/azure-subscription-service-limits#app-service-limits). Чтобы масштабировать приложение на другой уровень, целевой уровень должен поддерживать такое число слотов, которое использует ваше приложение. Например, если приложение уже использует более пяти слотов, вы не сможете перейти на ценовую категорию **Стандартный** с поддержкой только пяти слотов развертывания.

<a name="Add"></a>

## <a name="add-slot"></a>Добавление слота
Чтобы включить несколько слотов развертывания, приложение должно быть ценовой категории **Стандартный**, **Премиум** или **Изолированный**.

1. На [портале Azure](https://portal.azure.com/) откройте [страницу ресурсов](../azure-resource-manager/manage-resources-portal.md#manage-resources) приложения.

2. В области навигации слева выберите **Слоты развертывания (предварительная версия)**, а затем щелкните **Добавить слот**.
   
    ![Добавить новый слот развертывания](./media/web-sites-staged-publishing/QGAddNewDeploymentSlot.png)
   
   > [!NOTE]
   > Если для приложение не имеет ценовой категории **Стандартный**, **Премиум** или **Изолированный**, появится сообщение со списком допустимых уровней с поддержкой промежуточной публикации. На этом этапе вы можете выбрать команду **Обновить** и перейти на вкладку **Масштаб** приложения, а затем продолжить процесс.
   > 

3. В диалоговом окне **Добавление слота** присвойте слоту имя и выберите, нужно ли клонировать конфигурацию приложения из другого существующего слота развертывания. Чтобы продолжить, щелкните **Добавить**.
   
    ![Источник конфигурации](./media/web-sites-staged-publishing/ConfigurationSource1.png)
   
    Вы можете клонировать конфигурацию из любого существующего слота. При клонировании копируются такие параметры, как настройки приложения, строки подключения, языковые версии платформы, веб-сокеты, версия HTTP и разрядность платформы.

4. Добавив слота, щелкните **Закрыть**, чтобы закрыть диалоговое окно. Новый слот отобразится на странице **Слоты развертывания (предварительная версия)**. По умолчанию параметр **Процент трафика** для нового слота имеет значение 0, то есть весь клиентский трафик направляется только в рабочий слот.

5. Щелкните созданный слот развертывания, чтобы открыть его страницу ресурсов.
   
    ![Название области развертывания](./media/web-sites-staged-publishing/StagingTitle.png)

    Страница управления для промежуточного слота ничем не отличается от страницы для любого приложения Службы приложений. Здесь вы можете изменить конфигурацию слота. В верхней части страницы отображается имя слота, напоминающее о том, что вы просматриваете слот развертывания.

6. Щелкните URL-адрес приложения на странице ресурса слота. Слот развертывания имеет собственное имя узла и доступен из Интернета. Чтобы ограничить доступ к слоту развертывания, воспользуйтесь механизмом [ограничения IP-адресов для Службы приложений Azure](app-service-ip-restrictions.md).

Новый слот развертывания не имеет содержимого, даже если вы клонировали параметры из другого слота. Например, вы можете выполнить [публикацию в эту область с помощью Git](app-service-deploy-local-git.md). Вы можете выполнять развертывание в слот из другой ветви репозитория или даже из другого репозитория. 

<a name="AboutConfiguration"></a>

## <a name="which-settings-are-swapped"></a>Какие параметры переносятся?
При клонировании конфигурации из другой области развертывания вы можете изменять клонированную конфигурацию. Кроме того, некоторые элементы конфигурации переносятся при переключении вместе с содержимым (элементы, которые не определяются слотом), а другие элементы сохраняются в том же слоте (определяемые слотом элементы). Ниже приведен список параметров, которые изменяются при переключении слотов.

**Переносимые параметры**:

* Общие параметры, например версия платформы, 32/64-разрядная версия, веб-сокеты
* Параметры приложения (их также можно привязать к слоту)
* Строки подключения (их также можно привязать к слоту)
* Сопоставления обработчиков
* Настройки диагностики и мониторинга
* Открытые сертификаты
* Содержимое веб-заданий
* Гибридные подключения *
* Интеграция виртуальной сети *
* Конечные точки службы *
* Сеть доставки Содержимого Azure *

Функции, отмеченные * планируется сделать прикрепленные к слоту. 

**Параметры, которые не переносятся**:

* Конечные точки публикации
* Имена личных доменов
* Закрытые сертификаты и привязки SSL
* Настройки масштаба
* Планировщики веб-заданий
* Ограничения IP-адресов
* AlwaysOn
* Параметры протокола (HTTP**S**, версию TLS, сертификатов)
* Параметры журнала диагностики
* CORS

<!-- VNET and hybrid connections not yet sticky to slot -->

Чтобы привязать к слоту параметр приложения или строку подключения (запретить их перенос в другой слот), откройте страницу **Параметры приложения** для нужного слота и установите флажок **Параметр слота** для всех элементов конфигурации, которые нельзя переносить в другой слот. Служба приложений не выполняет перенос для всех элементов конфигурации, которые помечены как параметры слота. 

![Параметр слота](./media/web-sites-staged-publishing/SlotSetting.png)

<a name="Swap"></a>

## <a name="swap-two-slots"></a>Переключение двух слотов 
Вы можете переключить слоты развертывания на странице **Слоты развертывания (предварительная версия)** для приложения. 

Также переключение слотов доступно на страницах **Обзор** и **Слоты развертывания**, но здесь пока открывается старый интерфейс. Это руководство посвящено новому пользовательскому интерфейсу, размещенному на странице **Слоты развертывания (предварительная версия)**.

> [!IMPORTANT]
> Перед переключением приложения из слота развертывания в рабочий слот убедитесь, что все параметры настроены так, как нужно для целевого слота.
> 
> 

Чтобы переключить слоты развертывания, выполните следующие действия:

1. Перейдите к странице **Слоты развертывания (предварительная версия)** своего приложения и щелкните **Переключение**.
   
    ![Кнопка "Переключить"](./media/web-sites-staged-publishing/SwapButtonBar.png)

    Диалоговое окно **Переключение** отобразит параметры в выбранных слотах (исходном и целевом), которые будут изменены.

2. Выберите **исходный** и **целевой** слоты. В качестве целевого чаще всего используется рабочий слот. Также здесь следует проверить все ожидаемые изменения конфигурации на вкладках **Изменения в источнике** и **Изменения в целевом объекте**. Завершив проверку, щелкните **Переключить**, чтобы немедленно переключить слоты.

    ![Завершить переключение](./media/web-sites-staged-publishing/SwapImmediately.png)

    Вы можете еще до переключения увидеть, как целевой слот будет работать с новыми параметрами. Для этого вместо выбора действия **Переключить** выполните инструкции из раздела [Переключение с предварительным просмотром](#Multi-Phase).

3. Завершив операцию, закройте диалоговое окно, нажав кнопку **Закрыть**.

<a name="Multi-Phase"></a>

### <a name="swap-with-preview-multi-phase-swap"></a>Переключение с предварительным просмотром (многофазное переключение)

> [!NOTE]
> Переключение с предварительным просмотром не поддерживается для веб-приложений в ОС Linux.

Прежде, чем переключать приложение в целевой рабочий слот, убедитесь, что оно успешно выполняется с новыми параметрами. Кроме того, для исходного слота перед переключением будет выполнена подготовка, что очень полезно для критически важных приложений.

При запуске переключения с предварительным просмотром Служба приложений выполняет следующие действия:

- Сохраняет целевой слот в неизменном виде, чтобы не мешать выполнению рабочей нагрузки в этом слоте (обычно это рабочий слот).
- Применяет к исходному слоту элементы конфигурации из целевого слота, в том числе строки соединения и параметры приложения, определяемые слотом.
- Перезапускает процессы рабочей роли в исходном слоте, используя настроенные элементы конфигурации. Вы можете открыть исходный слот в браузере и проверить, как работает приложение с новой конфигурацией.

Если на следующем шаге вы подтвердите переключение, Служба приложений меняет местами подготовленный исходный слот и целевой слот. Если переключение отменяется, Служба приложений восстанавливает в исходном слоте все прежние элементы конфигурации.

Чтобы выполнить переключение с предварительным просмотром, примените следующую процедуру.

1. Выполните действия, описанные в разделе [Переключение слотов развертывания](#Swap), выбрав вариант **Переключение с предварительным просмотром**.

    ![Переключение с предварительным просмотром](./media/web-sites-staged-publishing/SwapWithPreview.png)

    Это диалоговое окно отображает, как изменяется конфигурация исходного слота на первом этапе и как выполняется переключение исходного и целевого слотов на втором этапе.

2. Когда вы будете готовы к переключению, щелкните **Запустить переключение**.

    В диалоговом окне вы получите уведомление о завершении первого этапа. Чтобы проверить предварительную версию исходного слота, перейдите на страницу `https://<app_name>-<source-slot-name>.azurewebsites.net`. 

3. Когда все будет готово для завершения переключения, выберите **Завершить переключение** в разделе **Действие переключения** и щелкните **Завершить переключение**.

    Чтобы отменить промежуточное переключение, выберите **Отменить переключение** и щелкните **Отменить переключение**.

4. Завершив операцию, закройте диалоговое окно, нажав кнопку **Закрыть**.

Чтобы автоматизировать многофазное переключение, см. раздел "Автоматизация с помощью PowerShell".

<a name="Rollback"></a>

## <a name="roll-back-swap"></a>Откат переключения
Если в целевом слоте (обычно это рабочий слот) будут обнаружены ошибки после переключения слотов, немедленно восстановите прежнее (до переключения) состояние слотов, выполнив обратное переключение.

<a name="Auto-Swap"></a>

## <a name="configure-auto-swap"></a>Настройка автоматического переключения

> [!NOTE]
> Автоматическое переключение не поддерживается для веб-приложений в Linux.

Функция автоматического переключения упрощает сценарии DevOps, в которых требуется регулярно разворачивать приложение с нулевым временем холодного запуска и нулевым временем простоя для пользователей этого приложения. Если для слота настроено автоматическое переключение в рабочий слот, при каждой отправке кода в такой слот Служба приложений будет автоматически переключать приложение из исходного слота в рабочий слот, как только завершится его подготовка.

   > [!NOTE]
   > Перед настройкой автоматического переноса для рабочего слота мы рекомендуем проверить автоматическое переключение на другом целевом слоте.
   > 

Чтобы настроить автоматическое переключение, выполните следующие действия:

1. Перейдите на страницу ресурсов приложения. Последовательно выберите **Слоты развертывания (предварительная версия)** > *\<требуемый исходный слот>* > **параметры приложения**.
   
2. Установите переключатель **Автоматическое переключение** в положение **Включено**, выберите целевой слот из списка **Слот автоматического переключения** и на панели команд щелкните **Сохранить**. 
   
    ![](./media/web-sites-staged-publishing/AutoSwap02.png)

3. Передайте код в исходный слот. Вскоре произойдет автоматическое переключение и эти изменения отразятся в URL-адресе целевого слота.

<a name="Warm-up"></a>

## <a name="custom-warm-up"></a>Пользовательская подготовка
При использовании [автоматического переключения](#Auto-Swap) некоторым приложениям требуются дополнительные действия подготовки. В элементе конфигурации `applicationInitialization` в файле web.config можно указать пользовательские действия инициализации. Операция переключения ожидает, пока завершатся эти пользовательские действия, и лишь затем переключает приложение в целевой слот. Ниже приведен пример фрагмента файла web.config.

    <system.webServer>
        <applicationInitialization>
            <add initializationPage="/" hostName="[app hostname]" />
            <add initializationPage="/Home/About" hostName="[app hostname]" />
        </applicationInitialization>
    </system.webServer>

Дополнительные сведения о настройке `applicationInitialization` элемент, см. в разделе [наиболее распространенных сбоев замены слота развертывания и способы их устранения](https://ruslany.net/2017/11/most-common-deployment-slot-swap-failures-and-how-to-fix-them/).

Вы также можете настроить реакцию на событие прогрева с одним или несколькими из следующих [параметров приложения](configure-common.md).

- `WEBSITE_SWAP_WARMUP_PING_PATH`: Путь проверки связи для прогрева вашего сайта. Добавьте этот параметр приложения, указав настраиваемый путь, который начинается с косой черты в качестве значения. Например, `/statuscheck`. По умолчанию используется значение `/`. 
- `WEBSITE_SWAP_WARMUP_PING_STATUSES`: Допустимые коды ответов HTTP для операции прогрева. Добавьте этот параметр приложения со списком кодов HTTP, разделенным запятыми. Например, `200,202`. Если возвращаемый код состояния не находится в списке, операции прогрева и замены будут остановлены. По умолчанию все коды ответов являются допустимыми.

## <a name="monitor-swap"></a>Мониторинг переключения

Если операция переключения выполняется слишком долго, вы можете получить сведения об операции переключения в [журнале действий](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md).

На странице ресурса приложения на портале выберите **Журнал действий** в области навигации слева.

Операция переключения отображается в запросах журнала в виде `Swap Web App Slots`. Вы можете развернуть этот элемент и выбрать вложенные операции или ошибки, чтобы увидеть подробные сведения о них.

## <a name="route-traffic"></a>Маршрутизация трафика

По умолчанию все клиентские запросы, поступающие на URL-адрес приложения (`http://<app_name>.azurewebsites.net`), направляются в рабочий слот. Вы можете перенаправить часть этого трафика в другой слот. Это очень удобно, когда вам нужно собрать отзывы пользователей о новой версии, но вы пока не готовы публиковать ее в рабочей среде.

### <a name="route-production-traffic-automatically"></a>Автоматическая маршрутизация рабочего трафика

Чтобы настроить автоматическую маршрутизацию рабочего трафика, выполните следующие действия:

1. Перейдите на страницу ресурса приложения и выберите **Слоты развертывания (предварительная версия)**.

2. В столбце **Процент трафика** для слота, в который нужно направить часть трафика, укажите значение в процентах (от 0 до 100) от общего объема распределяемого трафика. Выберите команду **Сохранить**.

    ![](./media/web-sites-staged-publishing/RouteTraffic.png)

После сохранения этого параметра указанная доля клиентов будет случайным образом направляться в другой слот. 

Каждый клиент связывается с тем слотом, в который его направит механизм автоматической маршрутизации, на весь период текущего сеанса. Вы можете проверить, к какому слоту прикреплен клиент, просмотрев значение параметра cookie `x-ms-routing-name` в заголовках HTTP средствами браузера. Если запросы направляются в промежуточный слот, этот параметр имеет значение `x-ms-routing-name=staging`. Если запросы направляются в рабочий слот, этот параметр имеет значение `x-ms-routing-name=self`.

### <a name="route-production-traffic-manually"></a>Маршрутизация рабочего трафика вручную

Кроме автоматической маршрутизации трафика, Служба приложений поддерживает направление запросов в конкретные слоты. Это полезно, если вы хотите предоставить пользователям возможность согласиться или отказаться от использования бета-версии приложения. Для маршрутизации рабочего трафика вручную применяется параметр запроса `x-ms-routing-name`.

Чтобы пользователи могли отказаться от использования бета-версии приложения, можно поместить эту ссылку на своей веб-странице:

```HTML
<a href="<webappname>.azurewebsites.net/?x-ms-routing-name=self">Go back to production app</a>
```

Строка `x-ms-routing-name=self` определяет рабочий слот. Когда браузер клиента переходит по ссылке, он не только перенаправляется в рабочий слот, но и получает параметр cookie `x-ms-routing-name=self` для привязки сеанса к рабочему слоту.

Чтобы пользователи могли согласиться использовать бета-версию приложения, укажите для имени нерабочей области один параметр запроса, например:

```
<webappname>.azurewebsites.net/?x-ms-routing-name=staging
```

По умолчанию новый слотов, получают правила маршрутизации из `0%`, которые отображаются серым цветом. Явно установив это значение в `0%` (показано черным шрифтом), пользователи смогут работать промежуточный слот вручную с помощью `x-ms-routing-name` параметр запроса, но они не будут направляться в слоте автоматически так, как процент маршрутизации имеет значение 0. Это расширенный сценарий, где можно «скрыть» промежуточного слота из общедоступной предоставляя внутренних групп проверить изменения в слоте.

<a name="Delete"></a>

## <a name="delete-slot"></a>Удаление слота

Перейдите на страницу ресурсов приложения. Последовательно выберите **Слоты развертывания (предварительная версия)** > *\<удаляемый слот>* > **Обзор**. На панели команд щелкните **Удалить**.  

![Удаление слота развертывания](./media/web-sites-staged-publishing/DeleteStagingSiteButton.png)

<!-- ======== AZURE POWERSHELL CMDLETS =========== -->

<a name="PowerShell"></a>

## <a name="automate-with-powershell"></a>Автоматизация с помощью PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Azure PowerShell — это модуль, который предоставляет командлеты для управления Azure с помощью Windows PowerShell, а также поддерживает управление слотами развертывания в службе приложений Azure.

Сведения об установке и настройке Azure PowerShell и об аутентификации Azure PowerShell с использованием подписки Azure см. в разделе [Установка и настройка Microsoft Azure PowerShell](/powershell/azure/overview).  

- - -
### <a name="create-web-app"></a>Создание веб-приложения
```powershell
New-AzWebApp -ResourceGroupName [resource group name] -Name [app name] -Location [location] -AppServicePlan [app service plan name]
```

- - -
### <a name="create-slot"></a>Создание слота
```powershell
New-AzWebAppSlot -ResourceGroupName [resource group name] -Name [app name] -Slot [deployment slot name] -AppServicePlan [app service plan name]
```

- - -
### <a name="initiate-swap-with-preview-multi-phase-swap-and-apply-destination-slot-configuration-to-source-slot"></a>Запуск переключения с предварительным просмотром (многофазное переключение) и применение конфигурации целевого слота к исходному слоту
```powershell
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action applySlotConfig -Parameters $ParametersObject -ApiVersion 2015-07-01
```

- - -
### <a name="cancel-pending-swap-swap-with-review-and-restore-source-slot-configuration"></a>Отмена промежуточного переключения (переключения с предварительным просмотром) и восстановление конфигурации исходного слота
```powershell
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action resetSlotConfig -ApiVersion 2015-07-01
```

- - -
### <a name="swap-deployment-slots"></a>Переключение слотов развертывания
```powershell
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action slotsswap -Parameters $ParametersObject -ApiVersion 2015-07-01
```

### <a name="monitor-swap-events-in-the-activity-log"></a>Просмотр событий переключения в журнале действий
```powershell
Get-AzLog -ResourceGroup [resource group name] -StartTime 2018-03-07 -Caller SlotSwapJobProcessor  
```

- - -
### <a name="delete-slot"></a>Удаление слота
```powershell
Remove-AzResource -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots –Name [app name]/[slot name] -ApiVersion 2015-07-01
```

- - -
<!-- ======== Azure CLI =========== -->

<a name="CLI"></a>

## <a name="automate-with-cli"></a>Автоматизация с помощью CLI

Чтобы ознакомиться с командами [Azure CLI](https://github.com/Azure/azure-cli) для слотов развертывания, изучите описание команды [az webapp deployment slot](/cli/azure/webapp/deployment/slot).

## <a name="next-steps"></a>Дальнейшие действия
[Ограничения статических IP-адресов в службе приложений Azure](app-service-ip-restrictions.md)
