---
title: Настройка промежуточных сред
description: Узнайте, как развернуть приложения в непроизводственном слоте и сделать автосеповерт в производство. Увеличьте надежность и устраните время простоя приложения из развертываний.
ms.assetid: e224fc4f-800d-469a-8d6a-72bcde612450
ms.topic: article
ms.date: 03/04/2020
ms.custom: fasttrack-edit
ms.openlocfilehash: 21e025088e59c7f65f848b332ecb393b05918261
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "78300877"
---
# <a name="set-up-staging-environments-in-azure-app-service"></a>Настройка промежуточных сред в службе приложений Azure
<a name="Overview"></a>

При развертывании веб-приложения, веб-приложения на Linux, мобильного бэк-энда или приложения API в [Azure App Service](https://go.microsoft.com/fwlink/?LinkId=529714)можно использовать отдельный слот для развертывания вместо производственного слота по умолчанию, когда вы работаете в стандартном, **Standard** **Премиуме**, или **изолированном** уровне службы приложений. Слоты развертывания — это живые приложения с их собственными именами хостов. Содержимое приложений и элементы конфигурации можно переключать между двумя слотами развертывания (включая рабочий слот). 

Развертывание приложения в слоте, не являющимся рабочим, дает следующие преимущества:

* Внеся изменения в приложение, вы можете проверить их в промежуточном слоте развертывания, прежде чем переключать в рабочий слот.
* Развертывание приложения в промежуточном слоте и последующее переключение в рабочий слот гарантирует, что все экземпляры слота будут подготовлены до переключения в рабочую среду. Это позволит вам избежать простоя при развертывании приложения. Перенаправление трафика не вызывает затруднений, а запросы не теряются из-за операций переключения. Вы можете автоматизировать весь рабочий процесс, настраивая [автоскакок,](#Auto-Swap) когда предварительная проверка swap не требуется.
* После переключения в слоте, где ранее находилась промежуточная версия приложения, будет размещено приложение, которое до этого было рабочим. Если изменения в рабочем слоте не соответствуют вашим ожиданиям, вы можете мгновенно переключиться назад к последней рабочей версии сайта.

Каждый уровень плана службы приложений поддерживает разное количество слотов развертывания. Дополнительная плата за использование слотов развертывания не взимается. Чтобы узнать количество слотов, поддерживающих уровень приложения, смотрите [ограничения службы app.](../azure-resource-manager/management/azure-subscription-service-limits.md#app-service-limits) 

Чтобы масштабировать приложение до другого уровня, убедитесь, что целевой уровень поддерживает количество уже использовавшихся слотов. Например, если в приложении более пяти слотов, вы не можете масштабировать его до **уровня Стандарта,** поскольку **стандартный** уровень поддерживает только пять слотов развертывания. 

<a name="Add"></a>

## <a name="add-a-slot"></a>Добавление слота
Приложение должно работать в **стандартном,** **Премиум**, или **изолированный** уровень для того, чтобы включить несколько слотов развертывания.


1. на [портале Azure](https://portal.azure.com/)ищите и выбирайте **службы приложений** и выберите приложение. 
   
    ![Поиск служб приложений](./media/web-sites-staged-publishing/search-for-app-services.png)
   

2. В левом стеле выберите **слоты** > развертывания**Добавить слот.**
   
    ![Добавить новый слот развернутого приложения](./media/web-sites-staged-publishing/QGAddNewDeploymentSlot.png)
   
   > [!NOTE]
   > Если приложение еще не включено в **стандартный,** **премиум**, или **изолированный** уровень, вы получите сообщение, которое указывает на поддерживаемые уровни для включения поэтапной публикации. На этом этапе у вас есть возможность выбрать **обновление** и перейти на вкладку **шкалы** вашего приложения, прежде чем продолжить.
   > 

3. В поле диалога **слотов** дайте слоту имя и выберите, клонировать ли конфигурацию приложения из другого слота развертывания. Выберите **Добавить** для продолжения.
   
    ![Источник конфигурации](./media/web-sites-staged-publishing/ConfigurationSource1.png)
   
    Можно клонировать конфигурацию из любого существующего слота. При клонировании копируются такие параметры, как настройки приложения, строки подключения, языковые версии платформы, веб-сокеты, версия HTTP и разрядность платформы.

4. После добавления слота выберите **Close,** чтобы закрыть поле диалога. Новый слот теперь отображается на странице **слотов развертывания.** По умолчанию **трафик %** устанавливается до 0 для нового слота, при этом весь трафик клиента направляется в производственный слот.

5. Выберите новый слот развертывания, чтобы открыть страницу ресурса этого слота.
   
    ![Название слота развертывания](./media/web-sites-staged-publishing/StagingTitle.png)

    Страница управления для промежуточного слота ничем не отличается от страницы для любого приложения Службы приложений. Здесь вы можете изменить конфигурацию слота. В верхней части страницы отображается имя слота, напоминающее о том, что вы просматриваете слот развертывания.

6. Выберите URL-адрес приложения на странице ресурса слота. Слот развертывания имеет свое собственное имя хоста, а также является живым приложением. Чтобы ограничить доступ общественности к [Azure App Service IP restrictions](app-service-ip-restrictions.md)слоту развертывания, см.

Новый слот развертывания не имеет содержимого, даже если вы клонировали параметры из другого слота. Например, вы можете [опубликовать в этом слоте с Git](app-service-deploy-local-git.md). Вы можете выполнять развертывание в слот из другой ветви репозитория или даже из другого репозитория. 

<a name="AboutConfiguration"></a>

## <a name="what-happens-during-a-swap"></a>Что происходит во время свопа

### <a name="swap-operation-steps"></a>Шаги операции своп

При замене двух слотов (обычно из постановочного слота в производственный слот) Служба приложений делает следующее, чтобы гарантировать, что целевой слот не испытывает простоя:

1. Примените следующие параметры из целевого слота (например, производственного слота) ко всем экземплярам исходного слота: 
    - [Настройки](#which-settings-are-swapped) приложения для слотов и строки соединения, если это применимо.
    - [Непрерывные](deploy-continuous-deployment.md) настройки развертывания, если включены.
    - Настройки [аутентификации Службы приложения,](overview-authentication-authorization.md) если включены.
    
    Любой из этих случаев вызывает все экземпляры в исходном слоте для перезагрузки. Во время [свопа с предварительного просмотра,](#Multi-Phase)это знаменует собой окончание первой фазы. Операция своп приостановлена, и вы можете проверить, что слот исходного кода работает правильно с настройками целевого слота.

1. Подождите, пока каждый экземпляр в исходном слоте завершит перезагрузку. Если какой-либо экземпляр не перезаработает, операция своп возвращает все изменения в исходный слот и останавливает операцию.

1. Если [локальный кэш](overview-local-cache.md) включен, запустите инициализацию локального кэша, сделав запрос HTTP к корню приложения ("/) на каждом экземпляре исходного слота. Подождите, пока каждый экземпляр не вернет ответ HTTP. Локальная инициализация кэша вызывает еще один перезапуск в каждом экземпляре.

1. Если [автоматический своп](#Auto-Swap) включен с [помощью пользовательского разогрева,](#Warm-up)запустите [инициирование приложения,](https://docs.microsoft.com/iis/get-started/whats-new-in-iis-8/iis-80-application-initialization) сделав запрос HTTP на корень приложения ("/) на каждом экземпляре исходного слота.

    Если `applicationInitialization` не указано, запустите запрос HTTP к корнеприложения исходного слота в каждом экземпляре. 
    
    Если экземпляр возвращает любой ответ HTTP, он считается разогретым.

1. Если все экземпляры исходного слота успешно прогреваются, поменяйте два слота, переключив правила разгрома для двух слотов. После этого шага в целевом слоте (например, в производственном слоте) есть приложение, которое предварительно разогревалось в исходном слоте.

1. Теперь, когда слот исходного кода имеет предварительное своп-приложение, ранее входиввввввв в целевой слот, выполните ту же операцию, применяя все настройки и перезапустив экземпляры.

В любой точке операции своп, вся работа по инициализации замененных приложений происходит на исходном слоте. Целевой слот остается в сети, в то время как исходный слот готовится и нагревается, независимо от того, где своп удается или не удается. Чтобы поменять сценич-слот на производственный слот, убедитесь, что производственный слот всегда является целевым слотом. Таким образом, операция своп не влияет на приложение для производства.

### <a name="which-settings-are-swapped"></a>Какие параметры переносятся?

[!INCLUDE [app-service-deployment-slots-settings](../../includes/app-service-deployment-slots-settings.md)]

Чтобы настроить настройку приложения или строку соединения, чтобы придерживаться определенного слота (не менялся), перейдите на страницу **Конфигурации** для этого слота. Добавление или отображайте настройки, а затем выберите **настройки слота развертывания.** Выбор этого флажка говорит Службе приложения, что параметр не подменен. 

![Параметр слота](./media/web-sites-staged-publishing/SlotSetting.png)

<a name="Swap"></a>

## <a name="swap-two-slots"></a>Переключение двух слотов 
Вы можете поменять слоты развертывания на странице **слотов развертывания** приложения и на странице **«Обзор».** Для получения технических подробностей о слот-своп, [см. Что происходит во время свопа](#AboutConfiguration).

> [!IMPORTANT]
> Перед тем, как поменять приложение из слота развертывания в производство, убедитесь, что производство является вашим целевым слотом и что все настройки в исходном слоте настроены точно так, как вы хотите, чтобы они были в производстве.
> 
> 

Для замены слотов развертывания:

1. Перейдите на страницу **слотов развертывания** приложения и выберите **Swap.**
   
    ![Кнопка свопа](./media/web-sites-staged-publishing/SwapButtonBar.png)

    В поле **обмена** диалогом отображаются параметры в выбранном источнике и целевых слотах, которые будут изменены.

2. Выберите **исходный** и **целевой** слоты. В качестве целевого чаще всего используется рабочий слот. Кроме того, выберите вкладки **Исходных изменений** и **целевых изменений** и убедитесь, что изменения конфигурации ожидаются. Когда вы закончите, вы можете поменять слоты сразу, выбрав **Swap**.

    ![Полное переключение](./media/web-sites-staged-publishing/SwapImmediately.png)

    Чтобы увидеть, как ваш целевой слот будет работать с новыми настройками, прежде чем своп на самом деле происходит, не выберите **Swap**, но следуйте инструкциям в [Swap с предварительным просмотром.](#Multi-Phase)

3. Когда вы закончите, закройте поле диалога, выбрав **Close**.

Если у вас возникли какие-либо [проблемы, см.](#troubleshoot-swaps)

<a name="Multi-Phase"></a>

### <a name="swap-with-preview-multi-phase-swap"></a>Переключение с предварительным просмотром (многофазное переключение)

Перед тем, как поменять в производство в качестве целевого слота, проверьте, что приложение работает с замененными настройками. Исходный слот также нагревается до завершения свопа, что желательно для критически важных приложений.

При выполнении свопа с предварительным просмотром Служба App выполняет ту же [операцию свопа,](#AboutConfiguration) но приостанавливается после первого шага. Затем можно проверить результат на слоте постановки перед завершением свопа. 

При отмене свопа Служба appa повторно применяет элементы конфигурации к исходной слоту.

Чтобы поменять с предварительным просмотром:

1. Следуйте шагам в [слотах развертывания Swap,](#Swap) но выберите **Своп выполните функции предварительного просмотра.**

    ![Переключение с предварительным просмотром](./media/web-sites-staged-publishing/SwapWithPreview.png)

    В поле диалога показано, как изменяется конфигурация в исходном слоте в фазе 1, и как изменяется исходный и целевой слот на этапе 2.

2. Когда вы будете готовы начать своп, выберите **Start Swap.**

    Когда этап 1 заканчивается, вы будете уведомлены в диалоговом окне. Предварительный своп в исходном `https://<app_name>-<source-slot-name>.azurewebsites.net`слоте, перейдя в . 

3. Когда вы будете готовы завершить отложенный своп, выберите **Полный своп** в **действии Swap** и выберите **Полный Своп.**

    Чтобы отменить отложенный своп, выберите Вместо этого **отменить swap.**

4. Когда вы закончите, закройте поле диалога, выбрав **Close**.

Если у вас возникли какие-либо [проблемы, см.](#troubleshoot-swaps)

Чтобы автоматизировать многофазный своп, [см. Автоматизировать с PowerShell.](#automate-with-powershell)

<a name="Rollback"></a>

## <a name="roll-back-a-swap"></a>Откат свопа
Если в целевом слоте (обычно это рабочий слот) будут обнаружены ошибки после переключения слотов, немедленно восстановите прежнее (до переключения) состояние слотов, выполнив обратное переключение.

<a name="Auto-Swap"></a>

## <a name="configure-auto-swap"></a>Настройка автоматического переключения

> [!NOTE]
> Автосвопсина не поддерживается в веб-приложениях на Linux.

Автосвопсив упрощает сценарии Azure DevOps, где требуется непрерывное развертывание приложения с нулевыми холодными стартами и нулевым временем простоя для клиентов приложения. Когда автоматический своп включен из слота в производство, каждый раз, когда вы нажимаете изменения кода на этот слот, Служба приложений автоматически [меняет приложение в производство](#swap-operation-steps) после его разогрева в исходном слоте.

   > [!NOTE]
   > Перед настройкой автоматического своп для производственного слота рассмотрите возможность тестирования автоматического своп на непроизводственном целевом слоте.
   > 

Для настройки автоматического свопа:

1. Перейдите на страницу ресурсов приложения. Выберите >  **слоты** >   >  **Configuration***\< *для развертывания желаемого исходного слота>общие**настройки конфигурации.**
   
2. Для **автоматического своп включен,** выберите **на**. Затем выберите нужный целевой слот для **слота для развертывания Автоматического своп**и выберите **Сохранить** на панели команд. 
   
    ![Выбор для настройки автоматического своп](./media/web-sites-staged-publishing/AutoSwap02.png)

3. Передайте код в исходный слот. Автообмен происходит через некоторое время, и обновление отражается на URL-адресе вашего целевого слота.

Если у вас возникли какие-либо [проблемы, см.](#troubleshoot-swaps)

<a name="Warm-up"></a>

## <a name="specify-custom-warm-up"></a>Укажите пользовательский разминку

Некоторые приложения могут потребовать пользовательских действий разминки до свопа. Элемент `applicationInitialization` конфигурации в web.config позволяет указать пользовательские действия инициализации. [Операция своп](#AboutConfiguration) ждет этого пользовательского разминки, чтобы закончить, прежде чем заменить с целевым слотом. Вот пример web.config фрагмент.

    <system.webServer>
        <applicationInitialization>
            <add initializationPage="/" hostName="[app hostname]" />
            <add initializationPage="/Home/About" hostName="[app hostname]" />
        </applicationInitialization>
    </system.webServer>

Для получения дополнительной информации о настройке элемента `applicationInitialization` см. [Наиболее распространенные сбои слот-своп развертывания и как их исправить.](https://ruslany.net/2017/11/most-common-deployment-slot-swap-failures-and-how-to-fix-them/)

Вы также можете настроить поведение разминки с одним или обоими из [следующих настроек приложения:](configure-common.md)

- `WEBSITE_SWAP_WARMUP_PING_PATH`: Путь к пинг, чтобы разогреть ваш сайт. Добавьте этот параметр приложения, указав настраиваемый путь, который начинается с косой черты в качестве значения. Например, `/statuscheck`. Значение по умолчанию — `/`. 
- `WEBSITE_SWAP_WARMUP_PING_STATUSES`: Действительные коды ответов HTTP для операции разминки. Добавьте этот параметр приложения со списком кодов HTTP, разделенным запятыми. Примером `200,202` является . Если код состояния возвращенного не указан в списке, операции по разогреву и свопа прекращаются. По умолчанию все коды ответов являются допустимыми.

> [!NOTE]
> Элемент `<applicationInitialization>` конфигурации является частью каждого запуска приложения, в то время как два параметра поведения разогрева применяются только к свопам слотов.

Если у вас возникли какие-либо [проблемы, см.](#troubleshoot-swaps)

## <a name="monitor-a-swap"></a>Мониторинг свопа

Если [операция своп](#AboutConfiguration) занимает много времени, вы можете получить информацию об операции свопа в [журнале активности.](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md)

На странице ресурсов приложения на портале, в левом стеле, выберите **журнал activity.**

Операция переключения отображается в запросах журнала в виде `Swap Web App Slots`. Вы можете развернуть этот элемент и выбрать вложенные операции или ошибки, чтобы увидеть подробные сведения о них.

## <a name="route-traffic"></a>Маршрутизация трафика

По умолчанию все клиентские запросы, поступающие на URL-адрес приложения (`http://<app_name>.azurewebsites.net`), направляются в рабочий слот. Вы можете перенаправить часть этого трафика в другой слот. Это очень удобно, когда вам нужно собрать отзывы пользователей о новой версии, но вы пока не готовы публиковать ее в рабочей среде.

### <a name="route-production-traffic-automatically"></a>Автоматическая маршрутизация рабочего трафика

Для автоматического маршрутного производственного трафика:

1. Перейдите на страницу ресурсов приложения и выберите **слоты развертывания.**

2. В столбце **Процент трафика** для слота, в который нужно направить часть трафика, укажите значение в процентах (от 0 до 100) от общего объема распределяемого трафика. Нажмите кнопку **Сохранить**.

    ![Установка процента трафика](./media/web-sites-staged-publishing/RouteTraffic.png)

После сохранения настройки указанный процент клиентов случайным образом направляется в непроизводственный слот. 

После того, как клиент автоматически направляется в определенный слот, он «прикрепляется» к этому слоту на протяжении всего срока службы этого сеанса клиента. Вы можете проверить, к какому слоту прикреплен клиент, просмотрев значение параметра cookie `x-ms-routing-name` в заголовках HTTP средствами браузера. Если запросы направляются в промежуточный слот, этот параметр имеет значение `x-ms-routing-name=staging`. Если запросы направляются в рабочий слот, этот параметр имеет значение `x-ms-routing-name=self`.

   > [!NOTE]
   > Рядом с порталом Azure можно [`az webapp traffic-routing set`](/cli/azure/webapp/traffic-routing#az-webapp-traffic-routing-set) также использовать команду в Azure CLI для настройки процентных ставок маршрутизации с помощью инструментов CI/CD, таких как конвейеры DevOps или других систем автоматизации.
   > 

### <a name="route-production-traffic-manually"></a>Маршрутизация рабочего трафика вручную

Кроме автоматической маршрутизации трафика, Служба приложений поддерживает направление запросов в конкретные слоты. Это полезно, когда вы хотите, чтобы ваши пользователи могли выбрать или отказаться от вашего бета-приложения. Для маршрутизации рабочего трафика вручную применяется параметр запроса `x-ms-routing-name`.

Например, чтобы пользователи могли отказаться от бета-приложения, эту ссылку можно разместить на своей веб-странице:

```HTML
<a href="<webappname>.azurewebsites.net/?x-ms-routing-name=self">Go back to production app</a>
```

Строка `x-ms-routing-name=self` определяет рабочий слот. После того, как клиентский браузер получает доступ к ссылке, он перенаправляется в производственный слот. Каждый последующий `x-ms-routing-name=self` запрос имеет файл cookie, который прикрепляет сеанс к производственному слоту.

Чтобы позволить пользователям выбрать в вашем бета-приложении, установите тот же параметр запроса на имя непроизводственного слота. Ниже приведен пример:

```
<webappname>.azurewebsites.net/?x-ms-routing-name=staging
```

По умолчанию новым слотам дается правило `0%`конечности смили, отображаемым серым цветом. При явном настройке `0%` этого значения (показано черным текстом) пользователи могут получить `x-ms-routing-name` доступ к слоту-постановке вручную, используя параметр запроса. Но они не будут направлены в слот автоматически, потому что процент маршрутизации установлен до 0. Это продвинутый сценарий, где вы можете "скрыть" ваш постановочного слота от общественности, позволяя внутренним группам тестировать изменения на слоте.

<a name="Delete"></a>

## <a name="delete-a-slot"></a>Удалить слот

Поиск и выбор приложения. Выберите*\<слот * **для слотов** > для развертывания> >  **обзоре.** Выберите **Удалить** в панели команд.  

![Удаление слота развертывания](./media/web-sites-staged-publishing/DeleteStagingSiteButton.png)

<!-- ======== AZURE POWERSHELL CMDLETS =========== -->

<a name="PowerShell"></a>

## <a name="automate-with-powershell"></a>Автоматизация с помощью PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Azure PowerShell — это модуль, который предоставляет командлеты для управления Azure с помощью Windows PowerShell, а также поддерживает управление слотами развертывания в службе приложений Azure.

Сведения об установке и настройке Azure PowerShell и об аутентификации Azure PowerShell с использованием подписки Azure см. в разделе [Установка и настройка Microsoft Azure PowerShell](/powershell/azure/overview).  

---
### <a name="create-a-web-app"></a>Создание веб-приложения
```powershell
New-AzWebApp -ResourceGroupName [resource group name] -Name [app name] -Location [location] -AppServicePlan [app service plan name]
```

---
### <a name="create-a-slot"></a>Создание слота
```powershell
New-AzWebAppSlot -ResourceGroupName [resource group name] -Name [app name] -Slot [deployment slot name] -AppServicePlan [app service plan name]
```

---
### <a name="initiate-a-swap-with-a-preview-multi-phase-swap-and-apply-destination-slot-configuration-to-the-source-slot"></a>Инициировать своп с предварительным просмотром (многофазный своп) и применить конфигурацию слота назначения к исходной слоту
```powershell
$ParametersObject = @{targetSlot  = "[slot name – e.g. "production"]"}
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action applySlotConfig -Parameters $ParametersObject -ApiVersion 2015-07-01
```

---
### <a name="cancel-a-pending-swap-swap-with-review-and-restore-the-source-slot-configuration"></a>Отмена ожидающего своп (своп с обзором) и восстановление конфигурации исходного слота
```powershell
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action resetSlotConfig -ApiVersion 2015-07-01
```

---
### <a name="swap-deployment-slots"></a>Переключение слотов развертывания
```powershell
$ParametersObject = @{targetSlot  = "[slot name – e.g. "production"]"}
Invoke-AzResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action slotsswap -Parameters $ParametersObject -ApiVersion 2015-07-01
```

### <a name="monitor-swap-events-in-the-activity-log"></a>Мониторинг событий свопа в журнале активности
```powershell
Get-AzLog -ResourceGroup [resource group name] -StartTime 2018-03-07 -Caller SlotSwapJobProcessor  
```

---
### <a name="delete-a-slot"></a>Удалить слот
```powershell
Remove-AzResource -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots –Name [app name]/[slot name] -ApiVersion 2015-07-01
```

## <a name="automate-with-resource-manager-templates"></a>Автоматизация с помощью шаблонов управления ресурсами

[Шаблоны Менеджер ресурсов Azure](https://docs.microsoft.com/azure/azure-resource-manager/template-deployment-overview) — это декларативные файлы JSON, используемые для автоматизации развертывания и конфигурации ресурсов Azure. Для замены слотов с помощью шаблонов «Менеджер ресурсов» вы установите два свойства на *сайтах Microsoft.Web/сайтах/слотах* и ресурсах *Microsoft.Web/sites:*

- `buildVersion`: это свойство строки, которое представляет текущую версию приложения, развернутого в слоте. Например: "v1", "1.0.0.1" или "2019-09-20T11:53:25.2887393-07:00".
- `targetBuildVersion`: Это свойство строки, которое определяет, что `buildVersion` слот должен иметь. Если targetBuildVersion не равен `buildVersion`току, то это вызовет операцию свопа, найдя слот, в котором `buildVersion`указан.

### <a name="example-resource-manager-template"></a>Пример шаблона менеджера ресурсов

Следующий шаблон менеджера ресурсов `buildVersion` обновит слот постановки и установит `targetBuildVersion` производственный слот. Это позволит поменять два слота. Шаблон предполагает, что у вас уже есть веб-приложение, созданное с слотом под названием "постановка".

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "my_site_name": {
            "defaultValue": "SwapAPIDemo",
            "type": "String"
        },
        "sites_buildVersion": {
            "defaultValue": "v1",
            "type": "String"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/slots",
            "apiVersion": "2018-02-01",
            "name": "[concat(parameters('my_site_name'), '/staging')]",
            "location": "East US",
            "kind": "app",
            "properties": {
                "buildVersion": "[parameters('sites_buildVersion')]"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2018-02-01",
            "name": "[parameters('my_site_name')]",
            "location": "East US",
            "kind": "app",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites/slots', parameters('my_site_name'), 'staging')]"
            ],
            "properties": {
                "targetBuildVersion": "[parameters('sites_buildVersion')]"
            }
        }        
    ]
}
```

Этот шаблон Resource Manager является идемпотентным, что означает, что он может быть выполнен повторно и производить то же состояние слотов. После первого `targetBuildVersion` исполнения, будет `buildVersion`соответствовать току, так что своп не будет срабатывать.

<!-- ======== Azure CLI =========== -->

<a name="CLI"></a>

## <a name="automate-with-the-cli"></a>Автоматизация с ПОМОЩЬю CLI

Чтобы ознакомиться с командами [Azure CLI](https://github.com/Azure/azure-cli) для слотов развертывания, изучите описание команды [az webapp deployment slot](/cli/azure/webapp/deployment/slot).

## <a name="troubleshoot-swaps"></a>Свопы устранения неполадок

Если какая-либо ошибка возникает во время [слот-своп,](#AboutConfiguration)она регистрируется в *D: »Home»LogFiles.eventlog.xml*. Он также входит в журнал ошибок, специфичный для приложения.

Вот некоторые распространенные ошибки своп:

- Запрос HTTP к корню приложения приурочен. Операция свопа ждет 90 секунд для каждого запроса HTTP и повторно требует до 5 раз. Если все повторы приурочены, операция свопа прекращается.

- Локальная инициализация кэша может вывести из строя, если содержимое приложения превышает локальную квоту диска, указанную для локального кэша. Для получения дополнительной информации [см.](overview-local-cache.md)

- Во время [пользовательской разминки](#Warm-up)запросы HTTP производятся внутренне (без прохождения внешнего URL). Они могут потерпеть неудачу с определенными правилами переписывания URL в *Web.config*. Например, правила перенаправления доменных имен или обеспечения httpS могут воспрепятствовать запросам на разогрев амдокинга в код приложения. Чтобы обойти эту проблему, измените правила переписывания, добавив следующие два условия:

    ```xml
    <conditions>
      <add input="{WARMUP_REQUEST}" pattern="1" negate="true" />
      <add input="{REMOTE_ADDR}" pattern="^100?\." negate="true" />
      ...
    </conditions>
    ```
- Без пользовательского разогрева правила переписывания URL-адреса могут блокировать запросы HTTP. Чтобы обойти эту проблему, измените правила переписывания, добавив следующее условие:

    ```xml
    <conditions>
      <add input="{REMOTE_ADDR}" pattern="^100?\." negate="true" />
      ...
    </conditions>
    ```
- Некоторые [правила ограничения IP](app-service-ip-restrictions.md) могут помешать операции своп отправки запросов HTTP в ваше приложение. Диапазоны адресов IPv4, которые начинаются с `10.` развертывания и `100.` являются внутренними. Вы должны разрешить им подключиться к вашему приложению.

- После слот-свопов приложение может столкнуться с неожиданными перезагрузками. Это связано с тем, что после свопа конфигурация связывания хоста выходит из синхронизации, что само по себе не приводит к перезагрузке. Однако некоторые основные события хранения (например, сбой объема хранилища) могут обнаружить эти расхождения и заставить все рабочие процессы перезапуститься. Чтобы свести к минимуму эти типы перезагрузки, установите [ `WEBSITE_ADD_SITENAME_BINDINGS_IN_APPHOST_CONFIG=1` настройку приложения](https://github.com/projectkudu/kudu/wiki/Configurable-settings#disable-the-generation-of-bindings-in-applicationhostconfig) на *всех слотах.* Тем не менее, эта настройка приложения *не* работает с приложениями Windows Communication Foundation (WCF).

## <a name="next-steps"></a>Дальнейшие действия
[Ограничения статических IP-адресов в службе приложений Azure](app-service-ip-restrictions.md)
