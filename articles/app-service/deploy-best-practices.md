---
title: Рекомендации по развертыванию
description: Узнайте о ключевых механизмах развертывания в службе приложений Azure. Найдите рекомендации по языку и другие предостережения.
keywords: лазурный сервис приложений, веб-приложение, развертывание, развертывание, конвейеры, сборка
author: jasonfreeberg
ms.assetid: bb51e565-e462-4c60-929a-2ff90121f41d
ms.topic: article
ms.date: 07/31/2019
ms.author: jafreebe
ms.openlocfilehash: 4dd959d75fd582d787e68db4a415a4a694b9cda8
ms.sourcegitcommit: d57d2be09e67d7afed4b7565f9e3effdcc4a55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81770689"
---
# <a name="deployment-best-practices"></a>Рекомендации по развертыванию

Каждая команда разработчиков имеет уникальные требования, которые могут затруднить реализацию эффективного конвейера развертывания на любом облачном сервисе. В этой статье представлены три основных компонента развертывания в службе приложений: источники развертывания, сборка конвейеров и механизмы развертывания. В этой статье также рассматриваются некоторые рекомендации и советы по конкретным языковым стеки.

## <a name="deployment-components"></a>Компоненты развертывания

### <a name="deployment-source"></a>Источник развертывания

Источник развертывания — это расположение кода приложения. Для производственных приложений источник развертывания обычно является репозиторием, размещенным программным обеспечением управления версиями, таким как [GitHub, BitBucket или Azure Repos.](deploy-continuous-deployment.md) Для сценариев разработки и тестирования источником развертывания может быть [проект локальной машины.](deploy-local-git.md) Служба поддержки приложений также поддерживает [папки OneDrive и Dropbox](deploy-content-sync.md) в качестве источников развертывания. В то время как облачные папки могут легко начать работу с App Service, обычно не рекомендуется использовать этот источник для производственных приложений корпоративного уровня. 

### <a name="build-pipeline"></a>Конвейер сборки

После того, как вы решите источник развертывания, следующим шагом будет выбор конвейера сборки. Конвейер сборки считывает исходный код из источника развертывания и выполняет ряд шагов (таких как компиляция кода, минимация HTML и JavaScript, запущенные тесты и компоненты упаковки), чтобы получить приложение в исполнимом состоянии. Конкретные команды, выполняемые конвейером сборки, зависят от стека языка. Эти операции могут выполняться на сервере сборки, например Azure Pipelines, или выполняться локально.

### <a name="deployment-mechanism"></a>Механизм развертывания

Механизм развертывания — это действие, используемое для размещения встроенного приложения в *каталог /home/site/wwwroot* вашего веб-приложения. *Каталог /wwwroot* — это смонтированное место хранения, совместно ехатое всеми экземплярами вашего веб-приложения. Когда механизм развертывания помещает приложение в этот каталог, экземпляры получают уведомление для синхронизации новых файлов. Служба приложений поддерживает следующие механизмы развертывания:

- Конечные точки Kudu: [Kudu](https://github.com/projectkudu/kudu/wiki) — это инструмент производительности разработчиков с открытым исходным кодом, который работает как отдельный процесс в службе Windows App Service и как второй контейнер в Linux App Service. Kudu обрабатывает непрерывные развертывания и предоставляет конечные точки HTTP для развертывания, такие как zipdeploy.
- FTP и WebDeploy: Используя свой [сайт или учетные данные пользователей,](deploy-configure-credentials.md)вы можете загружать файлы [через FTP](deploy-ftp.md) или WebDeploy. Эти механизмы не проходят через Куду.  

Инструменты развертывания, такие как Azure Pipelines, Jenkins и плагины редактора, используют один из этих механизмов развертывания.

## <a name="use-deployment-slots"></a>Используйте слоты развертывания

По возможности используйте [слоты развертывания](deploy-staging-slots.md) при развертывании новой сборки. При использовании уровня Standard App Service Plan или лучше можно развернуть приложение в среде постановки, проверить изменения и сделать тесты на курение. Когда вы будете готовы, вы можете поменять свои постановочные и производственные слоты. Операция свопа разогревает необходимые экземпляры работника, чтобы соответствовать вашей производственной шкале, тем самым устраняя время простоя.

### <a name="continuously-deploy-code"></a>Постоянное развертывание кода

Если в проекте определены ветви для тестирования, qA и постановки, то каждая из этих ветвей должна быть постоянно развернута в постановочном слоте. (Это известно как [дизайн Gitflow](https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow).) Это позволяет заинтересованным сторонам легко оценить и протестировать развернутую ветвь. 

Непрерывное развертывание никогда не должно быть включено для производственного слота. Вместо этого вветки производства (часто мастер) следует развернуть на непроизводственном слоте. Когда вы будете готовы выпустить базовую ветку, поменяйте ее в производственный слот. Замена в производство , вместо развертывания в производство предотвращает простои и позволяет откатить изменения, поменяв снова. 

![Использование слотов визуальное](media/app-service-deploy-best-practices/slot_flow_code_diagam.png)

### <a name="continuously-deploy-containers"></a>Постоянное развертывание контейнеров

Для пользовательских контейнеров из Docker или других контейнерных реестров разместите изображение в промежуточный слот и своп в производство, чтобы предотвратить простои. Автоматизация сложнее, чем развертывание кода, потому что необходимо нажать изображение в реестр контейнеров и обновить тег изображения в веб-приложении.

Для каждой ветви, которая требуется развернуть в слот, навязайте автоматизацию, чтобы сделать следующее на каждом коммите в ветке.

1. **Создайте и пометьте изображение.** В рамках конвейера сборки пометьте изображение идентификатором git commit, меткой времени или другой идентифицируемой информацией. Лучше не использовать "последний" тег по умолчанию. В противном случае трудно отследить, какой код в настоящее время развернут, что значительно затрудняет отладку.
1. **Нажмите на помеченное изображение.** После того, как изображение построено и помечено, конвейер толкает изображение в наш реестр контейнеров. На следующем этапе слот развертывания вытащит помеченное изображение из реестра контейнеров.
1. **Обновление слота развертывания с новым тегом изображения.** Когда это свойство будет обновлено, сайт автоматически перезапустит и вытащит новое изображение контейнера.

![Использование слотов визуальное](media/app-service-deploy-best-practices/slot_flow_container_diagram.png)

Ниже приведены примеры общих инфраструктур автоматизации.

### <a name="use-azure-devops"></a>Используйте Azure DevOps

Служба приложений имеет [встроенную непрерывную доставку](deploy-continuous-deployment.md) контейнеров через Центр развертывания. Перейдите к приложению на [портале Azure](https://portal.azure.com/) и выберите **Центр развертывания** под **развертыванием.** Следуйте инструкциям по выбору репозитория и филиала. Это позволит настроить конвейер сборки и выпуска DevOps для автоматической сборки, тегов и развертывания контейнера при перемещении новых коммитов в выбранную ветку.

### <a name="use-github-actions"></a>Использование действий GitHub

Вы также можете автоматизировать развертывание контейнера [с помощью действий GitHub.](containers/deploy-container-github-action.md)  Файл рабочего процесса ниже будет строить и отмечать контейнер с идентификатором коммита, перекаживать его в реестр контейнеров и обновлять указанный слот сайта с помощью нового тега изображений.

```yaml
name: Build and deploy a container image to Azure Web Apps

on:
  push:
    branches:
    - <your-branch-name>

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@master

    -name: Authenticate using a Service Principal
      uses: azure/actions/login@v1
      with:
        creds: ${{ secrets.AZURE_SP }}

    - uses: azure/container-actions/docker-login@v1
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push the image tagged with the git commit hash
      run: |
        docker build . -t contoso/demo:${{ github.sha }}
        docker push contoso/demo:${{ github.sha }}

    - name: Update image tag on the Azure Web App
      uses: azure/webapps-container-deploy@v1
      with:
        app-name: '<your-webapp-name>'
        slot-name: '<your-slot-name>'
        images: 'contoso/demo:${{ github.sha }}'
```

### <a name="use-other-automation-providers"></a>Использование других поставщиков автоматизации

Перечисленные ранее шаги применяются к другим утилитам автоматизации, таким как CircleCI или Travis CI. Однако на заключительном этапе необходимо использовать Azure CLI для обновления слотов развертывания с помощью новых тегов изображений. Чтобы использовать Azure CLI в скрипте автоматизации, создайте директора службы, используя следующую команду.

```shell
az ad sp create-for-rbac --name "myServicePrincipal" --role contributor \
   --scopes /subscriptions/{subscription}/resourceGroups/{resource-group} \
   --sdk-auth
```

В вашем скрипте, `az login --service-principal`войдите в систему использования, предоставляя информацию директора. Затем можно `az webapp config container set` установить имя контейнера, тег, URL-адрес реестра и пароль реестра. Ниже приведены некоторые полезные ссылки для вас, чтобы построить ваш контейнер CI процесса.

- [Как войти в Azure CLI на Круг CI](https://circleci.com/orbs/registry/orb/circleci/azure-cli) 

## <a name="language-specific-considerations"></a>Языковые соображения

### <a name="java"></a>Java

Используйте Kudu [zipdeploy/](deploy-zip.md) API для развертывания приложений JAR и [wardeploy/для](deploy-zip.md#deploy-war-file) приложений WAR. Если вы используете Jenkins, вы можете использовать эти AA непосредственно на этапе развертывания. Дополнительные сведения см. в [этой статье](../jenkins/execute-cli-jenkins-pipeline.md).

### <a name="node"></a>Узел

По умолчанию Kudu выполняет шаги сборки для`npm install`вашего приложения Узла (). Если вы используете службу сборки, такую как Azure DevOps, то сборка Kudu не нужна. Чтобы отключить сборку Kudu, создайте `SCM_DO_BUILD_DURING_DEPLOYMENT`настройку приложения, `false`со значением.

### <a name="net"></a>.NET 

По умолчанию Kudu выполняет шаги сборки для`dotnet build`вашего приложения .NET (). Если вы используете службу сборки, такую как Azure DevOps, то сборка Kudu не нужна. Чтобы отключить сборку Kudu, создайте `SCM_DO_BUILD_DURING_DEPLOYMENT`настройку приложения, `false`со значением.

## <a name="other-deployment-considerations"></a>Другие соображения о развертывании

### <a name="local-cache"></a>локальный кэш

Содержимое Службы приложений Azure хранится в Службе хранилища Azure; оно доступно в долгосрочном режиме в общей папке содержимого. Тем не менее, некоторые приложения просто нуждаются в высокопроизводительном магазине контента только для чтения, который они могут работать с высокой доступностью. Эти приложения могут извлечь выгоду из использования [локального кэша.](overview-local-cache.md) Местный кэш не рекомендуется для сайтов управления контентом, таких как WordPress.

Всегда используйте локальный кэш в сочетании с [слотами развертывания,](deploy-staging-slots.md) чтобы предотвратить простои. Смотрите [этот раздел](overview-local-cache.md#best-practices-for-using-app-service-local-cache) для получения информации об использовании этих функций вместе.

### <a name="high-cpu-or-memory"></a>Высокий процессор или память

Если ваш план службы приложений использует более 90% доступного процессора или памяти, базовая виртуальная машина может столкнуться с проблемами с обработкой развертывания. Когда это происходит, временно масштабируйте количество экземпляров для выполнения развертывания. После завершения развертывания можно вернуть количество экземпляров в прежнее значение.

Для получения дополнительной информации о наилучшей практике посетите [службу диагностики приложений,](https://docs.microsoft.com/azure/app-service/overview-diagnostics) чтобы узнать, что наилучшие практики, характерные для вашего ресурса.

- Перейдите к веб-приложению на [портале Azure.](https://portal.azure.com)
- Нажмите на **Диагностика и решить проблемы** в левой навигации, которая открывает App Service Diagnostics.
- Выберите плитку на главной странице **«Лучшие практики».**
- Нажмите на **рекомендации по доступности & производительности** или **рекомендации для оптимальной конфигурации,** чтобы просмотреть текущее состояние вашего приложения в отношении этих рекомендаций.

Вы также можете использовать эту ссылку, чтобы непосредственно `https://ms.portal.azure.com/?websitesextension_ext=asd.featurePath%3Ddetectors%2FParentAvailabilityAndPerformance#@microsoft.onmicrosoft.com/resource/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Web/sites/{siteName}/troubleshoot`открыть службу app Diagnostics для вашего ресурса: .
