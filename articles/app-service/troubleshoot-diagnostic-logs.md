---
title: Включение ведения журнала диагностики для приложений в Службе приложений Azure
description: Узнайте, как включить ведение журналов диагностики и добавить инструментирование в приложение, а также, как получить доступ к данным журналов Azure.
services: app-service
documentationcenter: .net
author: cephalin
manager: erikre
editor: jimbe
ms.assetid: c9da27b2-47d4-4c33-a3cb-1819955ee43b
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/06/2016
ms.author: cephalin
ms.custom: seodec18
ms.openlocfilehash: c21a923f06a768c0a9a0f2843a24583df7a7821d
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "67059643"
---
# <a name="enable-diagnostics-logging-for-apps-in-azure-app-service"></a>Включение ведения журнала диагностики для приложений в Службе приложений Azure
## <a name="overview"></a>Обзор
В Azure доступны встроенные средства диагностики для отладки [приложения Службы приложений](https://go.microsoft.com/fwlink/?LinkId=529714). Из этой статьи вы узнаете, как включить ведение журналов диагностики и добавить инструментирование в свое приложение, а также как получить доступ к данным журналов Azure.

В этой статье используется [портал Azure](https://portal.azure.com) и Azure CLI для работы с журналами диагностики. Дополнительные сведения о работе с журналами диагностики с использованием Visual Studio см. в статье [Устранение неполадок Azure в Visual Studio](troubleshoot-dotnet-visual-studio.md).

## <a name="whatisdiag"></a>Диагностика веб-сервера и приложений
Службы приложений включают функции диагностики для записи в журнал информации как с веб-сервера, так и из веб-приложения. Используется следующее логическое разделение: **диагностика веб-сервера** и **диагностика приложений**.

### <a name="web-server-diagnostics"></a>Диагностика веб-сервера
Вы можете включить или отключить такие виды журналов:

* **Подробное ведение журнала ошибок** -подробные сведения для любой запрос с кодом состояния HTTP 400 и выше. Здесь могут содержаться сведения, которые помогут определить причину, по которой сервер вернул код ошибки. Один HTML-файл создается для каждой ошибки в файловой системе приложения и до 50 ошибки (файлы), будут сохранены. Если количество файлов HTML превышает 50, автоматически удаляются самые старые файлы 26.
* **Трассировка неудачно завершенных запросов** — регистрация подробной информации о неудачных запросах, включая трассировку компонентов IIS для обработки запроса и время каждого компонента. Это полезно, если вы хотите повысить производительность веб-сайта или определить конкретную ошибку HTTP. Одной папки в файловой системе приложения создается для каждой ошибки. Политики хранения файлов совпадают подробное ведение журнала выше ошибок.
* **Журналы веб-сервера** — регистрация сведений о HTTP-транзакциях в [расширенном формате файла журнала W3C](/windows/desktop/Http/w3c-logging). Это удобно при определении общих показателей сайта, например числа обработанных запросов или запросов, поступивших с определенного IP-адреса.

### <a name="application-diagnostics"></a>Диагностика приложения
Диагностика приложений позволяет записывать сведения, созданные веб-приложениями. Приложения ASP.NET могут использовать класс [System.Diagnostics.Trace](/dotnet/api/system.diagnostics.trace) для записи информации в журнал диагностики приложений. Например:

    System.Diagnostics.Trace.TraceError("If you're seeing this, something bad happened");

Во время выполнения эти журналы доступны для устранения неполадок. Дополнительную информацию см. в разделе [Troubleshoot an app in Azure App Service using Visual Studio](troubleshoot-dotnet-visual-studio.md) (Устранение неполадок приложения в Службе приложений Azure с помощью Visual Studio).

Служба приложений также записывает в журнал сведения о развертывании при публикации содержимого в приложение. Это происходит автоматически, а параметры конфигурации для ведения журнала развертывания отсутствуют. Ведение журнала развертывания позволяет определить причину сбоя развертывания. Например, если применяется пользовательский сценарий развертывания, можно использовать ведение журнала развертывания, чтобы определить, почему не удается выполнить сценарий.

## <a name="enablediag"></a>Практическое руководство. Включение диагностики
Чтобы включить диагностику на [портале Azure](https://portal.azure.com), на странице своего приложения выберите **Параметры > Журналы диагностики**.

<!-- todo:cleanup dogfood addresses in screenshot -->
![Часть журналов](./media/web-sites-enable-diagnostic-log/logspart.png)

Включив **диагностику приложений**, также можно выбрать ее **уровень**. В следующей таблице показаны категории журналов, которые включает каждый уровень:

| Уровень| Включенные категории журналов |
|-|-|
|**Disabled** | Нет |
|**Ошибка** | "Ошибка", "Критические" |
|**Предупреждение;** | "Предупреждение", "Ошибка", "Критические"|
|**Сведения** | "Информация", "Предупреждение", "Ошибка", "Критические"|
|**Подробный** | "Трассировка", "Отладка", "Информация", "Предупреждение", "Ошибка", "Критические" (все категории) |
|-|-|

Для **ведения журнала приложения** можно временно включить параметр "Файловая система" для отладки. Этот параметр автоматически отключается через 12 часов. Вы также можете включить параметр "Хранилище BLOB-объектов", чтобы выбрать контейнер BLOB-объектов для записи журналов.

> [!NOTE]
> Сейчас в хранилище BLOB-объектов можно записывать только журналы приложения .NET. Журналы приложений Java, PHP, Node.js, Python могут храниться только в файловой системе (без изменений кода для записи журналов во внешнее хранилище).
>
>

Для **ведения журнала веб-сервера** можно выбрать **хранилище** или **файловую систему**. Выбрав **хранилище**, вы сможете указать учетную запись хранилища, а затем — BLOB-контейнер, в который записываются журналы. 

Если журналы хранятся в файловой системе, доступ к этим файлам можно получить с помощью FTP, а также скачать их в виде архива с использованием Azure CLI.

По умолчанию журналы не удаляются автоматически, за исключением **журнала приложения (файловая система)** . Чтобы журналы удалялись автоматически, задайте значение в поле **Срок хранения (в днях)** .

> [!NOTE]
> Если вы [создаете повторно ключи доступа учетной записи хранения](../storage/common/storage-create-storage-account.md), то необходимо сбросить соответствующую конфигурацию ведения журнала, чтобы использовать обновленные ключи. Для этого:
>
> 1. На вкладке **Настройка** установите значение **Выключено** для соответствующего компонента ведения журнала. Сохраните вашу настройку.
> 2. Снова включите ведение журнала для большого двоичного объекта учетной записи хранения. Сохраните вашу настройку.
>
>

Можно одновременно активировать варианты "Файловая система" или "Хранилище BLOB-объектов" в любом сочетании, а также настроить индивидуальные конфигурации уровня ведения журнала. Например, запись в хранилище ошибок и предупреждений в хранилище blob-объектов может потребоваться в качестве решения для длительного подробного ведения журнала.

Хотя оба места хранения содержат одну и ту же базовую информацию о событиях, вносимых в журнал, в журналах **хранилища BLOB-объектов** содержатся дополнительные сведения, например идентификатор экземпляра, идентификатор потока и более подробная метка времени (формат тактов) по сравнению с журналом для **файловой системы**.

> [!NOTE]
> Доступ к сведениям, хранящимся в **хранилище BLOB-объектов**, можно получить только с помощью клиента хранилища или приложения, которое может напрямую работать с этими системами хранения данных. Например, в Visual Studio 2013 содержится обозреватель хранилища, который может использоваться для просмотра хранилища BLOB-объектов, а HDInsight может получать доступ к данным, хранящимся в хранилище BLOB-объектов. Можно также написать приложение, которое обращается к хранилищу Azure, используя один из [пакетов SDK для Azure](https://azure.microsoft.com/downloads/).
>

## <a name="download"></a>Практическое руководство. Скачивание журналов
Доступ к диагностическим сведениям, хранящимся в файловой системе приложения, можно получить непосредственно через FTP. Кроме того, их можно скачать как ZIP-архив с помощью Azure CLI.

Структура каталогов, в которых хранятся журналы, выглядит следующим образом:

* **Журналы приложений** — /LogFiles/Application/. Эта папка содержит один или несколько текстовых файлов со сведениями, созданными при ведении журнала приложения.
* **Трассировка невыполненных запросов** — /LogFiles/W3SVC#########/. Эта папка содержит XSL-файл и один или несколько XML-файлов. Убедитесь, что XSL-файл загружен в тот же каталог, что и XML-файлы, так как XSL-файл обеспечивает функциональные возможности форматирования и фильтрации содержимого XML-файлов при просмотре в браузере Internet Explorer.
* **Подробные журналы ошибок** — /LogFiles/DetailedErrors/. Эта папка содержит один или несколько HTM-файлов с подробными сведениями обо всех произошедших ошибках HTTP.
* **Журналы веб-сервера** — /LogFiles/http/RawLogs. Эта папка содержит один или несколько текстовых файлов, отформатированных с применением [расширенного формата журнала W3C](/windows/desktop/Http/w3c-logging).
* **Журналы развертывания** — /LogFiles/Git. В этой папке содержатся журналы, созданные внутренними процессами развертывания, используемыми Службой приложений, а также журналы развертываний с применением Git. Также журналы развертывания можно найти в папке D:\home\site\deployments.

### <a name="ftp"></a>FTP

Чтобы открыть подключение по FTP к FTP-серверу приложения, изучите статью [Развертывание приложения в службе приложений Azure с помощью FTP или FTPS](deploy-ftp.md).

После подключения к FTP- или FTPS-серверу приложения откройте папку **LogFiles**, где хранятся файлы журналов.

### <a name="download-with-azure-cli"></a>Скачивание с использованием Azure CLI
Чтобы скачать файлы журналов с использованием интерфейса командной строки Azure, откройте командную строку, PowerShell, Bash или сеанс терминала и введите следующую команду:

    az webapp log download --resource-group resourcegroupname --name appname

Эта команда сохраняет журналы для приложения с именем «appname» в файл с именем **webapp_logs.zip** в текущем каталоге.

> [!NOTE]
> Если компонент Azure CLI не установлен или не настроен для использования подписки Azure, ознакомьтесь со статьей [Начало работы с Azure CLI](https://docs.microsoft.com/cli/azure/get-started-with-azure-cli?view=azure-cli-latest).
>
>

## <a name="how-to-view-logs-in-application-insights"></a>Практическое руководство: Просмотр журналов Application Insights
Visual Studio Application Insights предоставляет средства для фильтрации и поиска журналов, а также для связывания журналов с запросами и другими событиями.

1. Добавление SDK Application Insights в проект в Visual Studio.
   * В обозревателе решений щелкните проект правой кнопкой мыши и выберите пункт "Добавить Application Insights". Откроется мастер, состоящий из нескольких шагов, включая шаг создания ресурса Application Insights. [Подробнее](../azure-monitor/app/asp-net.md)
2. Добавление прослушивателя трассировки пакета в проект.
   * Щелкните проект правой кнопкой мыши и выберите пункт "Управление пакетами NuGet". Выберите `Microsoft.ApplicationInsights.TraceListener` [Подробнее](../azure-monitor/app/asp-net-trace-logs.md)
3. Загрузите проект и запустите его для создания данных журнала.
4. На [портале Azure](https://portal.azure.com/) перейдите к новому ресурсу Application Insights и откройте **Поиск**. Вы увидите данные журнала, а также запросы, сведения об использовании и другие данные телеметрии. Получение некоторых данных телеметрии может занять несколько минут: щелкните "Обновить". [Подробнее](../azure-monitor/app/diagnostic-search.md)

[Дополнительные сведения об отслеживании производительности с помощью Application Insights](../azure-monitor/app/azure-web-apps.md)

## <a name="streamlogs"></a>Практическое руководство. Журналы потоковой передачи
При разработке приложения удобно видеть сведения о ведении журнала практически в режиме реального времени. Вы можете выполнять потоковую передачу журналов в среду разработки с помощью Azure CLI.

> [!NOTE]
> Некоторые типы буфера журнала записывают данные в файл журнала, что может привести к нарушению порядка событий в потоке. Например, запись в журнале приложений, возникающая при посещении пользователем страницы, может отображаться в потоке перед соответствующей записью журнала HTTP о запросе страницы.
>
> [!NOTE]
> При потоковой передаче журнала также передаются данные, записанные в любой текстовый файл, хранящийся в папке **D:\\home\\LogFiles\\** .
>
>

### <a name="streaming-with-azure-cli"></a>Потоковая передача с помощью интерфейса командной строки Azure
Чтобы передать информацию журналов, откройте новое окно командной строки, PowerShell, Bash или сеанс терминала и введите следующую команду:

    az webapp log tail --name appname --resource-group myResourceGroup

Эта команда подключается к приложению (appname) и по мере возникновения в приложении регистрируемых событий начинает потоковую передачу информации в окно. Вся информация, записываемая в файлы с расширением .txt, .log или .htm, которые сохраняются в каталоге /LogFiles (d:/home/logfiles), передается при потоковой передаче на локальную консоль.

Чтобы отфильтровать определенные события, например ошибки, используйте параметр **--Filter** . Например:

    az webapp log tail --name appname --resource-group myResourceGroup --filter Error

Чтобы отфильтровать определенные типы журналов, например HTTP, используйте параметр **--Path** . Например:

    az webapp log tail --name appname --resource-group myResourceGroup --path http

> [!NOTE]
> Если компонент Azure CLI не установлен или не настроен для использования подписки Azure, ознакомьтесь со статьей [Начало работы с Azure CLI](../cli-install-nodejs.md).
>
>

## <a name="understandlogs"></a>Практическое руководство. Интерпретация журналов диагностики
### <a name="application-diagnostics-logs"></a>Журналы диагностики приложений
Диагностика приложений хранит данные в определенном формате для приложений .NET в зависимости от того, куда сохраняются журналы: в файловую систему или хранилище BLOB-данных. 

Базовый набор данных является одинаковым для обоих типов хранилища и включает следующие данные: дата и время, когда произошло событие, идентификатор процесса, который создал событие, тип события (информация, предупреждение, ошибка) и сообщение о событии. Использование файловой системы для хранения журналов полезно в том случае, когда требуется немедленный доступ для устранения проблемы, так как файлы журналов обновляются практически мгновенно. Хранилище BLOB-объектов используется в целях архивирования, так как файлы кэшируются, а затем записываются в контейнер хранилища по расписанию.

**Файловая система**

Каждая строка, регистрируемая в файловой системе или полученная при потоковой передаче, имеет следующий формат:

    {Date}  PID[{process ID}] {event type/level} {message}

Например, сообщение об ошибке будет выглядеть, как в следующем примере:

    2014-01-30T16:36:59  PID[3096] Error       Fatal error on the page!

Ведение журнала в файловой системе позволяет получить базовые сведения о трех доступных методах. При этом: предоставляются только следующие данные: время, идентификатор процесса, уровень события и сообщение.

**Хранилище BLOB-объектов**

Если журнал ведется в хранилище blob-объектов, данные хранятся в формате с разделителями-запятыми (CSV). Фиксируются дополнительные поля с более подробными сведениями о событии. Для каждой строки CSV-файла используются следующие свойства:

| Имя свойства | Значение/формат |
| --- | --- |
| Дата |Дата и время возникновения события |
| Уровень |Уровень события (например, "Ошибка", "Предупреждение", "Информация") |
| ApplicationName |Имя приложения |
| InstanceId |Экземпляр приложения, в котором произошло событие |
| EventTickCount |Дата и время, когда произошло событие, в формате отсчетов (более высокая точность) |
| EventId |Идентификатор события<p><p>По умолчанию равен 0 (если не указан) |
| Pid |ИД процесса |
| Tid |Идентификатор потока, который вызвал это событие |
| Сообщение |Сообщение с подробными сведениями о событии |

Данные в хранилище BLOB-объектов будут выглядеть, как в следующем примере:

    date,level,applicationName,instanceId,eventTickCount,eventId,pid,tid,message
    2014-01-30T16:36:52,Error,mywebapp,6ee38a,635266966128818593,0,3096,9,An error occurred

> [!NOTE]
> В ASP.NET Core ведение журнала осуществляется с помощью поставщика [Microsoft.Extensions.Logging.AzureAppServices](https://www.nuget.org/packages/Microsoft.Extensions.Logging.AzureAppServices). Этот поставщик хранит дополнительные файлы журналов в контейнере больших двоичных объектов. Дополнительные сведения см. в разделе [о ведении журнала ASP.NET Core в Azure](/aspnet/core/fundamentals/logging).
>
>

### <a name="failed-request-traces"></a>Трассировка невыполненных запросов
Трассировки неудачно завершенных запросов хранятся в XML-файлах с именами **fr######.xml**. Чтобы облегчить просмотр данных журнала, используется таблица стилей XSL с именем **freb.xsl**, расположенная в том же каталоге, что и XML-файлы. При открытии одного из XML-файлов в Internet Explorer будет использоваться таблица стилей XSL для форматированного отображения информации о трассировке, как в следующем примере:

![вид трассировки неудачно завершенных запросов в браузере](./media/web-sites-enable-diagnostic-log/tws-failedrequestinbrowser.png)

> [!NOTE]
> Для перехода к странице вашего приложения на портале — простой способ просмотреть трассировки форматированный невыполненных запросов. В меню слева выберите **Диагностика и решение проблем**, а затем найдите **журналы невыполненных запросов трассировки**, щелкните значок, для просмотра трассировки, необходимо.
>

### <a name="detailed-error-logs"></a>Подробные журналы ошибок
Подробные журналы ошибок представляют собой документы HTML, в которых содержатся более подробные сведения о возникших ошибках HTTP. Поскольку они являются простыми HTML-документами, их можно просматривать с помощью веб-браузера.

### <a name="web-server-logs"></a>Журналы веб-сервера
Журналы веб-сервера форматируются с помощью [расширенного формата журнала W3C](/windows/desktop/Http/w3c-logging). Эти данные могут быть прочитаны с помощью текстового редактора, либо можно провести их синтаксический анализ с помощью служебных программ, таких как [Log Parser](https://go.microsoft.com/fwlink/?LinkId=246619)

> [!NOTE]
> Журналы, созданные Службой приложений Azure, не поддерживают поля **s-computername**, **s-ip** и **cs-version**.
>
>

## <a name="nextsteps"></a>Дальнейшие действия
* [Мониторинг приложений в Службе приложений Azure](web-sites-monitor.md)
* [Troubleshoot an app in Azure App Service using Visual Studio](troubleshoot-dotnet-visual-studio.md) (Устранение неполадок приложения в Службе приложений Azure с помощью Visual Studio)
* [Анализ журналов приложения в HDInsight](https://gallery.technet.microsoft.com/scriptcenter/Analyses-Windows-Azure-web-0b27d413)
