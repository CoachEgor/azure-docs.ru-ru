---
title: Включение ведения журналов диагностики
description: Узнайте, как включить ведение журналов диагностики и добавить инструментирование в приложение, а также, как получить доступ к данным журналов Azure.
ms.assetid: c9da27b2-47d4-4c33-a3cb-1819955ee43b
ms.topic: article
ms.date: 09/17/2019
ms.custom: seodec18
ms.openlocfilehash: e945fd77c2615e6f5213a9aa4fc996f0c4d2f3dd
ms.sourcegitcommit: d57d2be09e67d7afed4b7565f9e3effdcc4a55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81769988"
---
# <a name="enable-diagnostics-logging-for-apps-in-azure-app-service"></a>Включение ведения журнала диагностики для приложений в Службе приложений Azure
## <a name="overview"></a>Обзор
В Azure доступны встроенные средства диагностики для отладки [приложения Службы приложений](overview.md). Из этой статьи вы узнаете, как включить ведение журналов диагностики и добавить инструментирование в свое приложение, а также как получить доступ к данным журналов Azure.

В этой статье используется [портал Azure](https://portal.azure.com) и Azure CLI для работы с журналами диагностики. Дополнительные сведения о работе с журналами диагностики с использованием Visual Studio см. в статье [Устранение неполадок Azure в Visual Studio](troubleshoot-dotnet-visual-studio.md).

> [!NOTE]
> В дополнение к инструкциям по регистрации в этой статье появилась новая интегрированная возможность регистрации с Azure Monitoring. Вы найдете больше этой возможности в разделе Отправить журналы в [раздел Azure Monitor (предварительный просмотр).](#send-logs-to-azure-monitor-preview) 
>
>

|Тип|Платформа|Местоположение|Описание|
|-|-|-|-|
| Ведение журнала приложения | Windows, Linux | Файловая система Службы Приложений и/или капли хранения Azure | Входит в сообщения, генерируемые кодом приложения. Сообщения могут быть генерированы веб-инфраструктурой, которую вы выбираете, или из кода приложения непосредственно с использованием стандартного шаблона регистрации вашего языка. Каждое сообщение присваивается одной из следующих категорий: **Критические**, **Ошибка**, Предупреждение , **Информация**, **Отожение**, и **тихие**. **Info** Вы можете выбрать, насколько многословным вы хотите, чтобы журнал был, установив уровень серьезности при входе приложения.|
| Регистрация веб-серверов| Windows | Файловая система Службы приложений или капли хранения Azure| Необработанные данные запроса HTTP в [расширенном формате файла журнала W3C.](/windows/desktop/Http/w3c-logging) Каждое сообщение журнала включает в себя такие данные, как метод HTTP, ресурс URI, клиентский IP, порт клиента, агент пользователя, код ответа и так далее. |
| Подробные сообщения об ошибках| Windows | Файловая система Службы Приложения | Копии страниц ошибок *.htm,* которые были бы отправлены в браузер клиента. По соображениям безопасности подробные страницы ошибок не должны отправляться клиентам в производственной сфере, но Служба приложений может сохранять страницу ошибки каждый раз, когда происходит ошибка приложения с кодом HTTP 400 или больше. Страница может содержать информацию, которая может помочь определить, почему сервер возвращает код ошибки. |
| трассировка неудачно завершенных запросов. | Windows | Файловая система Службы Приложения | Подробная отслеживание информации о невыполненных запросах, включая след компонентов IIS, используемых для обработки запроса, и время, затрачиваемые на каждый компонент. Это полезно, если вы хотите повысить производительность веб-сайта или определить конкретную ошибку HTTP. Для каждого сутого запроса генерируется одна папка, которая содержит файл журнала XML и таблицу стилей XSL для просмотра файла журнала. |
| Регистрация развертывания | Windows, Linux | Файловая система Службы Приложения | Входы для публикации содержимого в приложении. Регистрация развертывания происходит автоматически, и нет настраиваемых настроек для регистрации развертывания. Это поможет определить причину сбой развертывания. Например, если используется [пользовательский сценарий развертывания,](https://github.com/projectkudu/kudu/wiki/Custom-Deployment-Script)можно использовать журнал развертывания, чтобы определить причину сбоя скрипта. |

> [!NOTE]
> App Service предоставляет специальный интерактивный инструмент диагностики, который поможет вам устранить неполадки в приложении. Для получения дополнительной информации смотрите [обзор диагностики службы приложений Azure](overview-diagnostics.md).
>
> Кроме того, можно использовать другие службы Azure для улучшения возможностей регистрации и мониторинга вашего приложения, таких как [Azure Monitor.](../azure-monitor/app/azure-web-apps.md)
>

## <a name="enable-application-logging-windows"></a>Включить журнал приложений (Windows)

> [!NOTE]
> Регистрация приложений для хранения капли может использовать учетные записи хранилища только в том же регионе, что и Служба приложений

Чтобы включить журнал приложений для Windows на [портале Azure,](https://portal.azure.com)перейдите к приложению и выберите **журналы Службы приложений.**

Выберите **on** для **регистрации приложений (Filesystem)** или **регистрации приложений (Blob)** или обоих. 

Опция **Filesystem** предназначена для временных отладок и выключается за 12 часов. **Blob** вариант предназначен для долгосрочной лесозаготовки, и нуждается в контейнере для хранения капли для записи журналов.  Blob опция также включает в себя дополнительную информацию в журнале сообщений,`InstanceId`таких как`Tid`идентификатор происхождения[`EventTickCount`](https://docs.microsoft.com/dotnet/api/system.datetime.ticks)VM экземпляр ассиф журнала сообщение ( ), идентификатор потока ( ), и более гранулированный метки времени ( ). **Blob**

> [!NOTE]
> Сейчас в хранилище BLOB-объектов можно записывать только журналы приложения .NET. Записи приложений Java, PHP, Node.js, Python могут храниться только в файловой системе Службы App (без изменений кода для записи журналов во внешнее хранилище).
>
> Кроме того, при [регенерации ключей доступа учетной записи хранилища](../storage/common/storage-create-storage-account.md)необходимо сбросить соответствующую конфигурацию журнала, чтобы использовать обновленные ключи доступа. Для этого:
>
> 1. На вкладке **Настройка** установите значение **Выключено** для соответствующего компонента ведения журнала. Сохраните вашу настройку.
> 2. Снова включите ведение журнала для большого двоичного объекта учетной записи хранения. Сохраните вашу настройку.
>
>

Выберите **уровень**или уровень деталей для входа. В следующей таблице показаны категории журналов, включенные в каждый уровень:

| Level | Включенные категории |
|-|-|
|**Отключено** | None |
|**Error** | "Ошибка", "Критические" |
|**Предупреждение** | "Предупреждение", "Ошибка", "Критические"|
|**Сведения** | "Информация", "Предупреждение", "Ошибка", "Критические"|
|**Подробного** | "Трассировка", "Отладка", "Информация", "Предупреждение", "Ошибка", "Критические" (все категории) |

После завершения, выберите **Сохранить**.

## <a name="enable-application-logging-linuxcontainer"></a>Включить регистрацию приложений (Linux/Container)

Для обеспечения регистрации приложений для приложений Linux или пользовательских контейнерных приложений на [портале Azure](https://portal.azure.com)перейдите к приложению и выберите **журналы Службы приложений.**

При **регистрации приложений**выберите **файловую систему.**

В **квоте (MB)** укажите квоту диска для журналов приложений. В **период удержания (дней)** установите количество дней, в течение которых журналы должны быть сохранены.

После завершения, выберите **Сохранить**.

## <a name="enable-web-server-logging"></a>Включение ведения журналов веб-сервера

Чтобы включить систему регистрации веб-серверов для приложений Windows [на портале Azure,](https://portal.azure.com)перейдите к приложению и выберите **журналы Службы приложений.**

Для **регистрации веб-серверов**выберите **Хранилище** для хранения журналов на хранилище кабо, или **файловой системы** для хранения журналов в файловой системе Службы Приложения. 

В **период удержания (дней)** установите количество дней, в течение которых журналы должны быть сохранены.

> [!NOTE]
> Если вы [создаете повторно ключи доступа учетной записи хранения](../storage/common/storage-create-storage-account.md), то необходимо сбросить соответствующую конфигурацию ведения журнала, чтобы использовать обновленные ключи. Для этого:
>
> 1. На вкладке **Настройка** установите значение **Выключено** для соответствующего компонента ведения журнала. Сохраните вашу настройку.
> 2. Снова включите ведение журнала для большого двоичного объекта учетной записи хранения. Сохраните вашу настройку.
>
>

После завершения, выберите **Сохранить**.

## <a name="log-detailed-errors"></a>Вход подробные ошибки

Чтобы сохранить страницу ошибок или неудалось отслеживание запроса для приложений Windows на [портале Azure,](https://portal.azure.com)перейдите к приложению и выберите **журналы Службы приложений.**

При **детальной регистрации ошибок** или **неудавом отслеживании запроса,** выберите **on,** затем выберите **Сохранить**.

Оба типа журналов хранятся в файловой системе Службы Приложений. Сохраняется до 50 ошибок (файлы/папки). Когда количество HTML-файлов превышает 50, старые 26 ошибок автоматически удаляются.

## <a name="add-log-messages-in-code"></a>Добавление сообщений журнала в код

В коде приложения используются обычные средства регистрации для отправки сообщений журналов в журналы приложений. Пример:

- Приложения ASP.NET могут использовать класс [System.Diagnostics.Trace](/dotnet/api/system.diagnostics.trace) для записи информации в журнал диагностики приложений. Пример:

    ```csharp
    System.Diagnostics.Trace.TraceError("If you're seeing this, something bad happened");
    ```

- По умолчанию ASP.NET Core использует провайдера журналов [Microsoft.Extensions.Logging.AzureAppServices.](https://www.nuget.org/packages/Microsoft.Extensions.Logging.AzureAppServices) Дополнительные сведения см. в разделе [о ведении журнала ASP.NET Core в Azure](https://docs.microsoft.com/aspnet/core/fundamentals/logging/).

## <a name="stream-logs"></a>Журналы потоковой передачи

Перед тем, как передавать журналы в режиме реального времени, включите нужный тип журнала. Любая информация, записанная в файлах, заканчивающихся в .txt, .log или .htm, которые хранятся в каталоге */LogFiles* (d:/home/logfiles), передается Службой app Service.

> [!NOTE]
> Некоторые типы буфера журнала записывают данные в файл журнала, что может привести к нарушению порядка событий в потоке. Например, запись в журнале приложений, возникающая при посещении пользователем страницы, может отображаться в потоке перед соответствующей записью журнала HTTP о запросе страницы.
>

### <a name="in-azure-portal"></a>На портале Azure

Для потоковой передачи журналов на [портале Azure](https://portal.azure.com)перейдите в приложение и выберите **поток журнала.** 

### <a name="in-cloud-shell"></a>В облачной оболочке

Для потоковой передачи журналов в [облачной оболочке](../cloud-shell/overview.md)используйте следующую команду:

```azurecli-interactive
az webapp log tail --name appname --resource-group myResourceGroup
```

Чтобы отфильтровать определенные события, например ошибки, используйте параметр **--Filter** . Пример:

```azurecli-interactive
az webapp log tail --name appname --resource-group myResourceGroup --filter Error
```
Чтобы отфильтровать определенные типы журналов, например HTTP, используйте параметр **--Path** . Пример:

```azurecli-interactive
az webapp log tail --name appname --resource-group myResourceGroup --path http
```

### <a name="in-local-terminal"></a>В местном терминале

Чтобы поток журналов в локальной консоли, [установите Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli) и [войдите в свой аккаунт.](https://docs.microsoft.com/cli/azure/authenticate-azure-cli) После входного в входного в восподписании последовалинструкции [инструкции для Cloud Shell](#in-cloud-shell)

## <a name="access-log-files"></a>Файлы журнала доступа

При настройке опции Azure Storage blobs для типа журнала необходим клиентский инструмент, работающий с Azure Storage. Для получения дополнительной [Azure Storage Client Tools](../storage/common/storage-explorers.md)информации см.

Для журналов, хранящихся в файловой системе Службы App, самый простой способ — загрузить файл в браузере по адресу:

- Linux/контейнерные приложения:`https://<app-name>.scm.azurewebsites.net/api/logs/docker/zip`
- Приложения для Windows:`https://<app-name>.scm.azurewebsites.net/api/dump`

Для приложений Linux/container файл с пультом содержит журналы вывода консолей как для хоста докера, так и для контейнера докеров. Для уменьшенного приложения файл «ЗИП» содержит один набор журналов для каждого экземпляра. В файловой системе Службы Приложений эти файлы журнала являются содержимым каталога */home/LogFiles.*

Для приложений с Windows файл с системой «ЗИП» содержит содержимое каталога *D:«Home»LogFiles* в файловой системе Службы Приложения. Он имеет следующую структуру:

| Тип журнала | Каталог | Описание |
|-|-|-|
| **Журналы приложений** |*/LogFiles/Application/* | Содержит один или несколько текстовых файлов. Формат сообщений журнала зависит от поставщика журнальных данных, который вы используете. |
| **Неудавшийся запрос Следы** | */LogFiles/W3SVC » (* | Содержит файлы XML и файл XSL. Вы можете просмотреть отформатированные файлы XML в браузере. |
| **Подробные журналы ошибок** | */LogFiles/DetailedErrors/* | Содержит файлы ошибок HTM. Вы можете просматривать файлы HTM в браузере.<br/>Другой способ просмотра несудавшихся следов запроса — перейти на страницу приложения на портале. Из левого меню, выберите **Диагностика и решить проблемы,** а затем поиск **не удалось отслеживания запросов журналы**, а затем нажмите значок для просмотра и просмотра трассы вы хотите. |
| **Веб-сервер журналы** | */LogFiles/http/RawLogs/* | Содержит текстовые файлы, отформатированные с помощью [расширенного формата файла журнала W3C.](/windows/desktop/Http/w3c-logging) Эта информация может быть прочитана с помощью текстового редактора или утилиты, такой как [Log Parser.](https://go.microsoft.com/fwlink/?LinkId=246619)<br/>Служба приложений `s-computername`не поддерживает `s-ip`ни `cs-version` поля, ни поля. |
| **Журналы развертывания** | */LogFiles/Git/* и */развертывание/* | Содержат журналы, генерируемые внутренними процессами развертывания, а также журналы для развертывания Git. |

## <a name="send-logs-to-azure-monitor-preview"></a>Отправка журналов на монитор Azure (предварительный просмотр)

С новой [интеграцией Azure Monitor](https://aka.ms/appsvcblog-azmon)можно [создать диагностические настройки (предварительный просмотр)](https://azure.github.io/AppService/2019/11/01/App-Service-Integration-with-Azure-Monitor.html#create-a-diagnostic-setting) для отправки журналов в учетные записи хранения данных, концентраторы событий и аналитику журналов. 

> [!div class="mx-imgBorder"]
> ![Диагностические настройки (предварительный просмотр)](media/troubleshoot-diagnostic-logs/diagnostic-settings-page.png)

### <a name="supported-log-types"></a>Поддерживаемые типы журналов

В следующей таблице показаны поддерживаемые типы и описания журналов: 

| Тип журнала | Поддержка Windows | Поддержка Linux (Docker) | Описание |
|-|-|-|
| AppServiceConsoleLogs | TBA | Да | Стандартный выход и стандартная ошибка |
| AppServiceHTTPLogs | Да | Да | Журналы веб-сервера |
| AppServiceEnvironmentPlatformLogs | Да | Да | Среда службы приложений: масштабирование, изменения конфигурации и журналы статусов|
| AppServiceAuditLogLogs | Да | Да | Активность входа через FTP и Kudu |
| AppServiceFileAuditLogLogLogs | Да | TBD | Изменения файлов через FTP и Kudu |
| AppServiceAppLogs | TBA | Java SE & Tomcat | Журналы приложений |

## <a name="next-steps"></a><a name="nextsteps"></a> Дальнейшие действия
* [Журналы запросов с помощью Azure Monitor](../azure-monitor/log-query/log-query-overview.md)
* [Мониторинг приложений в Службе приложений Azure](web-sites-monitor.md)
* [Troubleshoot an app in Azure App Service using Visual Studio](troubleshoot-dotnet-visual-studio.md) (Устранение неполадок приложения в Службе приложений Azure с помощью Visual Studio)
* [Анализ журналов приложения в HDInsight](https://gallery.technet.microsoft.com/scriptcenter/Analyses-Windows-Azure-web-0b27d413)
