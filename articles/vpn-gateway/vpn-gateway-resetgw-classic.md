---
title: Сброс VPN-шлюза Azure для повторного установления туннелей IPsec | Документация Майкрософт
description: В этой статье описывается, как выполнить сброс настроек VPN-шлюза Azure для повторного установления туннелей IPsec. Инструкции в этой статье применимы к VPN-шлюзам, созданным как на базе классической модели развертывания, так и на базе модели развертывания с помощью Resource Manager.
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: article
ms.date: 07/05/2019
ms.author: cherylmc
ms.openlocfilehash: 359773dad53f333b2f052dd5b5481645c72746da
ms.sourcegitcommit: 040abc24f031ac9d4d44dbdd832e5d99b34a8c61
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/16/2019
ms.locfileid: "69533931"
---
# <a name="reset-a-vpn-gateway"></a>Сброс VPN-шлюза

Сброс настроек VPN-шлюза Azure полезен при потере распределенного VPN-подключения в одном или нескольких VPN-туннелях типа "сеть-сеть". В этой ситуации все локальные VPN-устройства работают правильно, но не могут взаимодействовать с VPN-шлюзами Azure через туннели IPsec. Эта статья поможет вам сбросить VPN-шлюз.

### <a name="what-happens-during-a-reset"></a>Что происходит при сбросе?

VPN-шлюз состоит из двух экземпляров виртуальной машины (активного и резервного) с соответствующими конфигурациями. Во время сброса настроек шлюза он перезагружает шлюз и повторно применяет на нем конфигурации распределенного подключения. Шлюз сохранит имеющийся общедоступный IP-адрес. Это означает, что вам не нужно указывать в конфигурации VPN-маршрутизатора новый общедоступный IP-адрес VPN-шлюза Azure.

Выполнение команды сброса шлюза влечет за собой немедленную перезагрузку текущего активного экземпляра VPN-шлюза Azure. Переход от активного (перезагружаемого) экземпляра к резервному при отработке отказа сопровождается небольшой паузой. Пауза не должна превышать одну минуту.

Если после первой перезагрузки соединение не восстановится, выполните эту же команду еще раз, чтобы перезагрузить второй экземпляр виртуальной машины (новый активный шлюз). Если необходимо выполнить две последовательные перезагрузки (обоих экземпляров виртуальных машин — активного и резервного), это займет немного больше времени. Это приведет к более длительному разрыву подключения VPN (до 30 – 45 минут) для завершения перезагрузки виртуальных машин.

Если после двух перезагрузок проблема с распределенным подключением не решится, отправьте запрос в службу поддержки на портале Azure.

## <a name="before"></a>Перед началом работы

Перед сбросом настроек шлюза проверьте ключевые условия для каждого VPN-туннеля IPsec типа S2S, перечисленные ниже. Если какое-то из условий не выполняется, подключение через VPN-туннели типа S2S не будет работать. Проверка и исправление конфигурации для локальных VPN-шлюзов и VPN-шлюзов Azure избавляет от ненужных перезагрузок, а другие рабочие подключения через шлюзы — от сбоев.

Перед сбросом настроек шлюза проверьте следующие условия.

* IP-адреса в Интернете (VIP) для VPN-шлюза Azure и локального VPN-шлюза должны быть настроены правильно в политиках Azure и локальных политиках VPN.
* Общий ключ должен быть одинаковым для VPN-шлюза Azure и локального VPN-шлюза.
* Если применяется определенная конфигурация IPsec/IKE, например шифрование, алгоритмы хэширования и режим безопасной пересылки (PFS), задайте для VPN-шлюза Azure и локального VPN-шлюза одинаковые настройки.

## <a name="portal"></a>Портал Azure

Сбросить настройки VPN-шлюза Resource Manager можно на портале Azure. Если необходимо сбросить настройки классического шлюза, ознакомьтесь с [этим разделом](#resetclassic).

### <a name="resource-manager-deployment-model"></a>Модель развертывания диспетчера ресурсов

1. Откройте [портал Azure](https://portal.azure.com) и перейдите к шлюзу виртуальной сети Resource Manager, настройки которого необходимо сбросить.
2. В колонке для шлюза виртуальной сети щелкните "Сброс".

   ![Колонка сброса VPN-шлюза](./media/vpn-gateway-howto-reset-gateway/reset-vpn-gateway-portal.png)
3. В колонке "Сброс" нажмите кнопку **Сброс**.

## <a name="ps"></a>PowerShell

### <a name="resource-manager-deployment-model"></a>Модель развертывания диспетчера ресурсов

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Командлет сброса шлюза — **Reset-AzVirtualNetworkGateway**. Перед выполнением сброса убедитесь, что у вас установлена последняя версия командлетов [PowerShell AZ](https://docs.microsoft.com/powershell/module/az.network). В следующем примере выполняется сброс шлюза виртуальной сети с именем VNet1GW в группе ресурсов TestRG1:

```powershell
$gw = Get-AzVirtualNetworkGateway -Name VNet1GW -ResourceGroupName TestRG1
Reset-AzVirtualNetworkGateway -VirtualNetworkGateway $gw
```

Результат:

Вывод результата подразумевает успешное выполнение сброса шлюза. Тем не менее никакие данные в возвращаемом результате не указывают явно на то, что сброс выполнен успешно. Если вам требуется проверить журнал, чтобы узнать точное время сброса шлюза, эти сведения можно просмотреть на [портале Azure](https://portal.azure.com). На портале перейдите в раздел **ИмяШлюза -> Работоспособность ресурсов**.

### <a name="resetclassic"></a>Классическая модель развертывания

Командлет сброса шлюза — **Reset-AzureVNetGateway**. Командлеты Azure PowerShell для управления службами должны быть установлены локально на рабочем столе. Нельзя использовать Azure Cloud Shell. Перед выполнением сброса убедитесь, что у вас установлена последняя версия командлетов [PowerShell для управления службами](https://docs.microsoft.com/powershell/azure/servicemanagement/install-azure-ps?view=azuresmps-4.0.0#azure-service-management-cmdlets). В следующем примере выполняется сброс шлюза для виртуальной сети с именем ContosoVNet:

```powershell
Reset-AzureVNetGateway –VnetName “ContosoVNet”
```

Результат:

```powershell
Error          :
HttpStatusCode : OK
Id             : f1600632-c819-4b2f-ac0e-f4126bec1ff8
Status         : Successful
RequestId      : 9ca273de2c4d01e986480ce1ffa4d6d9
StatusCode     : OK
```

## <a name="cli"></a>Интерфейс командной строки Azure

Чтобы сбросить шлюз, используйте команду [az network vnet-gateway reset](https://docs.microsoft.com/cli/azure/network/vnet-gateway). В следующем примере выполняется сброс шлюза виртуальной сети с именем VNet5GW в группе ресурсов TestRG5:

```azurecli
az network vnet-gateway reset -n VNet5GW -g TestRG5
```

Результат:

Вывод результата подразумевает успешное выполнение сброса шлюза. Тем не менее никакие данные в возвращаемом результате не указывают явно на то, что сброс выполнен успешно. Если вам требуется проверить журнал, чтобы узнать точное время сброса шлюза, эти сведения можно просмотреть на [портале Azure](https://portal.azure.com). На портале перейдите в раздел **ИмяШлюза -> Работоспособность ресурсов**.
