---
title: 'Подключение компьютера к виртуальной сети с помощью подключения типа "точка — сеть" и аутентификации на основе сертификата: портал Azure классическая модель | Документация Майкрософт'
description: Создание классического подключения VPN-шлюза "точка — сеть" с помощью портала Azure
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 10/08/2020
ms.author: cherylmc
ms.openlocfilehash: bf0618c120a7fe572aa55b423d36dce3ef5656da
ms.sourcegitcommit: fbb620e0c47f49a8cf0a568ba704edefd0e30f81
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "91876198"
---
# <a name="configure-a-point-to-site-connection-by-using-certificate-authentication-classic"></a>Настройка подключения типа "точка — сеть" с помощью проверки подлинности на основе сертификата (классическая модель)

[!INCLUDE [deployment models](../../includes/vpn-gateway-classic-deployment-model-include.md)]

В этой статье объясняется, как создать виртуальную сеть с подключением типа "точка — сеть". Эта виртуальная сеть создается с помощью классической модели развертывания, используя портал Azure. В этой конфигурации для аутентификации подключающегося клиента используются сертификаты — самозаверяющие или выпущенные ЦС. Эту конфигурацию можно также создать с помощью другого средства развертывания или модели, используя варианты, описанные в следующих статьях:

> [!div class="op_single_selector"]
> * [Портал Azure](vpn-gateway-howto-point-to-site-resource-manager-portal.md)
> * [PowerShell](vpn-gateway-howto-point-to-site-rm-ps.md)
> * [Портал Azure (классический)](vpn-gateway-howto-point-to-site-classic-azure-portal.md)
>

С помощью VPN-шлюза типа "точка — сеть" (P2S) создается безопасное подключение к виртуальной сети с отдельного клиентского компьютера. VPN-подключения типа "точка — сеть" (P2S) эффективны для подключения к виртуальной сети из удаленного расположения. Если у вас небольшое количество клиентов, которым требуется подключение к виртуальной сети, такая конфигурация эффективна для использования вместо VPN-подключения типа "сеть — сеть". VPN-подключение типа P2S сначала устанавливается с клиентского компьютера.

> [!IMPORTANT]
> Классическая модель развертывания поддерживает только клиенты VPN в Windows и использует Socket Tunneling Protocol (SSTP), протокол VPN на основе SSL. Чтобы обеспечить поддержку клиентов VPN не в Windows, виртуальную сеть следует создавать с использованием модели развертывания с помощью Resource Manager. Помимо SSTP, эта модель развертывания поддерживает VPN IKEv2. Дополнительные сведения см. в статье [Сведения о VPN-подключениях типа "точка — сеть"](point-to-site-about.md).
>
>

![Схема подключения типа "точка — сеть"](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/point-to-site-connection-diagram.png)

## <a name="prerequisites"></a>Предварительные требования

Для проверки подлинности подключений типа "точка — сеть" на основе сертификатов необходимы следующие компоненты:

* Динамический VPN-шлюз.
* Открытый ключ (CER-файл) для корневого сертификата, импортированный в Azure. Этот ключ считается доверенным сертификатом и используется для проверки подлинности.
* Сертификат клиента создается из корневого сертификата и устанавливается на каждом подключаемом клиентском компьютере. Этот сертификат используется для проверки подлинности клиента.
* Пакет конфигурации VPN-клиента необходимо создать и установить на каждом подключаемом клиентском компьютере. Пакет конфигурации клиента настраивает собственный VPN-клиент, находящийся в операционной системе, используя данные, необходимые для подключения к виртуальной сети.

Для подключения типа "точка — сеть" не требуется VPN-устройство или локальный общедоступный IP-адрес. Для создания VPN-подключения используется протокол SSTP (Secure Socket Tunneling Protocol). На стороне сервера поддерживается SSTP версии 1.0, 1.1 и 1.2. Какую версию использовать, решает клиент. Для Windows 8.1 и более поздних версий по умолчанию используется SSTP версии 1.2. 

Дополнительные сведения о подключениях типа "точка — сеть" [см. в вопросах и ответах](#point-to-site-faq).

### <a name="example-settings"></a>Примеры настроек

Используйте следующие значения для создания тестовой среды или для лучшего понимания примеров в этой статье:

- **Создание параметров виртуальной сети (классической)**
   - **Имя**: введите *VNet1*.
   - **Адресное пространство**: введите *192.168.0.0/16*. В этом примере мы используем только одно адресное пространство, но для виртуальной сети можно настроить несколько, как показано на схеме.
   - **Имя подсети**. Введите *интерфейс*.
   - **Диапазон адресов подсети**: введите *192.168.1.0/24*.
   - **Подписка**. Выберите подписку из списка доступных подписок.
   - **Группа ресурсов**: введите *TestRG*. Выберите **Создать новый**, если группа ресурсов не существует.
   - **Расположение**: выберите **Восточная часть США** из списка.

  - **Параметры VPN-подключения**
    - **Тип подключения**: выберите **точка-сеть**.
    - **Адресное пространство клиента**: введите *172.16.201.0/24*. VPN-клиенты, подключающиеся к виртуальной сети с помощью этого подключения "точка — сеть", получают IP-адреса из указанного пула.

- **Параметры подсети конфигурации шлюза**
   - **Имя**: Автозаполнение *GatewaySubnet*.
   - **Диапазон адресов**: введите *192.168.200.0/24*. 

- **Параметры конфигурации шлюза**:
   - **Размер**. Выберите номер SKU шлюза, который вы хотите использовать.
   - **Тип маршрутизации**: выберите **динамический**.

## <a name="create-a-virtual-network-and-a-vpn-gateway"></a>Создание виртуальной сети и VPN-шлюза.

Прежде чем начать, убедитесь в том, что у вас есть подписка Azure. Если у вас еще нет подписки Azure, вы можете активировать преимущества для [подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details) или зарегистрироваться для использования [бесплатной учетной записи](https://azure.microsoft.com/pricing/free-trial).

### <a name="part-1-create-a-virtual-network"></a>Часть 1. Создание виртуальной сети

Если у вас уже есть виртуальная сеть, проверьте совместимость параметров со структурой VPN-шлюза. Обратите особое внимание на подсети, которые могут пересекаться с другими сетями.

[!INCLUDE [basic classic vnet](../../includes/vpn-gateway-vnet-classic.md)]

[!INCLUDE [basic classic DNS](../../includes/vpn-gateway-dns-classic.md)]

### <a name="part-2-create-a-gateway-subnet-and-a-dynamic-routing-gateway"></a>Часть 2. Создание подсети шлюза и шлюза динамической маршрутизации

На этом шаге создается подсеть шлюза и шлюз динамической маршрутизации. При создании подсети шлюза и шлюза на портале Azure для классической модели развертывания используются те же страницы конфигурации. Используйте подсеть шлюза только для служб шлюза. Поэтому не развертывайте ничего (например, виртуальные машины или другие службы) напрямую в подсеть шлюза.

1. В портал Azure перейдите к виртуальной сети, для которой требуется создать шлюз.

2. На странице виртуальной сети выберите **Обзор** и в разделе **VPN-подключения** щелкните **Шлюз**.

   ![Выбор создания шлюза](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/beforegw125.png)
3. На странице **Новое VPN-подключение** выберите **Точка — сеть**.

   ![Подключение типа "точка — сеть"](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/newvpnconnect.png)
4. Для параметра **Адресное пространство клиента** добавьте диапазон IP-адресов, из которого VPN-клиенты будут получать IP-адреса при подключении. Используйте диапазон частных IP-адресов, который не пересекается с локальным расположением, из которого выполнено подключение, или с виртуальной сетью, к которой вы подключаетесь. Вы можете перезаписать автоматически заполненный диапазон частным диапазоном IP-адресов, который хотите использовать. В этом примере показан автоматически заполненный диапазон. 

   ![Адресное пространство клиента](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/clientaddress.png)
5. Установите флажок **Немедленно создать шлюз** и щелкните **Дополнительная настройка шлюза**, чтобы открыть страницу **Настройка шлюза**.

   ![Выбор дополнительной настройки шлюза](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/optsubnet125.png)

6. На странице **Конфигурация шлюза** выберите **Подсеть** и добавьте подсеть шлюза. Можно создать подсеть шлюза размера /29. Тем не менее мы рекомендуем создать подсеть большего размера, включающую несколько адресов, выбрав по крайней мере значение /28 или /27. Таким образом, у вас будет достаточно адресов, чтобы добавить дополнительные конфигурации в будущем. При работе с подсетями шлюза не связывайте группу безопасности сети (NSG) с подсетью шлюза. Связывание группы безопасности сети с этой подсетью приведет к тому, что VPN-шлюз перестанет правильно функционировать. Нажмите кнопку **ОК**, чтобы сохранить этот параметр.

   ![Добавление подсети шлюза](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/gwsubnet125.png)
7. Выберите **размер** шлюза. Размер — это SKU шлюза для шлюза виртуальной сети. На портале Azure SKU по умолчанию — **По умолчанию**. Дополнительные сведения о SKU шлюзов см. в разделе [сведения о параметрах VPN-шлюза](vpn-gateway-about-vpn-gateway-settings.md#gwsku).

   ![Размер шлюза](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/gwsize125.png)
8. Выберите **тип маршрутизации** для шлюза. Конфигурации "точка — сеть" требует **динамического** типа маршрутизации. Нажмите кнопку **ОК** после завершения настройки этой страницы.

   ![Настройка типа маршрутизации](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/routingtype125.png)

9. В нижней части страницы **Новое VPN-подключение** нажмите кнопку **ОК**, чтобы приступить к созданию шлюза виртуальной сети. Создание VPN-шлюза может занять до 45 минут в зависимости от выбранного номера SKU шлюза.
 
## <a name="create-certificates"></a><a name="generatecerts"></a>Создание сертификатов

В Azure сертификаты используются для проверки подлинности VPN-клиентов в VPN-подключениях типа "точка — сеть". Необходимо отправить сведения об открытом ключе корневого сертификата в Azure. Открытый ключ считается *доверенным*. Сертификаты клиентов должны создаваться из доверенного корневого сертификата, а затем устанавливаться на каждом клиентском компьютере в хранилище сертификатов Certificates-Current User\Personal\Certificates. Сертификат используется для проверки подлинности клиента, когда он подключается к виртуальной сети. 

Используемые самозаверяющие сертификаты должны быть созданы с помощью определенных параметров. Чтобы создать самозаверяющий сертификат, см. инструкции по [PowerShell и Windows 10](vpn-gateway-certificates-point-to-site.md) или [MakeCert](vpn-gateway-certificates-point-to-site-makecert.md). Следовать этим инструкциям очень важно при использовании самозаверяющих корневых сертификатов и создании на их основе клиентских сертификатов. В противном случае создаваемые сертификаты не будут совместимы с подключениями типа "точка — сеть", и вы получите сообщение об ошибке подключения.

### <a name="acquire-the-public-key-cer-for-the-root-certificate"></a>Получение открытого ключа CER-файла для корневого сертификата

[!INCLUDE [vpn-gateway-basic-vnet-rm-portal](../../includes/vpn-gateway-p2s-rootcert-include.md)]

### <a name="generate-a-client-certificate"></a>Создание сертификата клиента

[!INCLUDE [vpn-gateway-basic-vnet-rm-portal](../../includes/vpn-gateway-p2s-clientcert-include.md)]

## <a name="upload-the-root-certificate-cer-file"></a>Отправка CER-файла корневого сертификата

После создания шлюза отправьте CER-файл (который содержит сведения об открытом ключе) доверенного корневого сертификата на сервер Azure. Не отправляйте закрытый ключ для корневого сертификата. После отправки CER-файла Azure будет использовать его для проверки подлинности клиентов, на которых установлен клиентский сертификат, созданный из доверенного корневого сертификата. При необходимости позже можно отправить дополнительные файлы доверенных корневых сертификатов (до 20).  

1. На странице виртуальной сети в разделе **VPN-подключения** щелкните рисунок, обозначающий клиентов, чтобы открыть страницу **VPN-подключение типа "точка — сеть"**.

   ![Клиенты](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/clients125.png)

2. На странице **VPN-подключение типа "точка — сеть"** щелкните **Управление сертификатами**, чтобы открыть страницу **Сертификаты**.

   ![Страница «Сертификаты»](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/ptsmanage.png)

1. На странице **Сертификаты** выберите **Отправить**, чтобы открыть страницу **Отправка сертификата**.

    ![Страница "Отправка сертификата"](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/uploadcerts.png)

4. Щелкните значок папки, чтобы найти CER-файл. Выберите файл и нажмите кнопку **ОК**. Отправленный сертификат отобразится на странице **Сертификаты**.

   ![Передача сертификата](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/upload.png)


## <a name="configure-the-client"></a>Настройка клиента

Для подключения к виртуальной сети с помощью VPN-подключения типа "точка — сеть" для каждого клиента необходимо установить пакет конфигурации для собственного VPN-клиента Windows. Пакет конфигурации настраивает собственный VPN-клиент Windows с необходимыми параметрами для подключения к виртуальной сети.

На каждом клиентском компьютере можно использовать один и тот же пакет конфигурации VPN-клиента при условии, что его версия соответствует архитектуре клиента. Список поддерживаемых клиентских операционных систем см. в разделе [Часто задаваемые вопросы о подключениях типа "точка — сеть"](#point-to-site-faq).

### <a name="generate-and-install-a-vpn-client-configuration-package"></a>Создание и установка пакета конфигурации VPN-клиента

1. На портале Azure на странице **Обзор** виртуальной сети в разделе **VPN-подключения** щелкните рисунок, обозначающий клиентов, чтобы открыть страницу **VPN-подключение типа "точка — сеть"**.

2. На странице **VPN-подключение типа "точка — сеть"** выберите пакет скачивания для операционной системы, в которой установлен клиент:

   * Для 64-разрядных клиентов выберите вариант **VPN-клиент (64-разрядная версия)**.
   * Для 32-разрядных клиентов выберите вариант **VPN-клиент (32-разрядная версия)**.

   ![Скачивание пакета конфигурации VPN-клиента](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/dlclient.png)

3. После создания пакета скачайте и установите его на клиентском компьютере. При появлении всплывающего окна SmartScreen выберите **Подробнее**, а затем выберите **Выполнить в любом случае**. Вы также можете сохранить пакет для установки на других клиентских компьютерах.

### <a name="install-a-client-certificate"></a>Установка сертификата клиента

Чтобы создать подключение типа "точка — сеть" на другом клиентском компьютере, отличном от того, который использовался для создания сертификатов клиентов, установите сертификат клиента. При установке сертификата клиента потребуется пароль, созданный при экспорте сертификата клиента. Как правило, можно установить сертификат, просто дважды щелкнув его. Дополнительные сведения см. в разделе [Установка экспортированного сертификата клиента](vpn-gateway-certificates-point-to-site.md#install).


## <a name="connect-to-your-vnet"></a>Подключение к виртуальной сети

>[!NOTE]
>Вам потребуются права администратора для клиентского компьютера, с которого устанавливается подключение.
>
>

1. Чтобы подключиться к виртуальной сети, на клиентском компьютере перейдите к **VPN-подключениям** в портал Azure и найдите созданное VPN-подключение. Название VPN-подключения совпадает с названием вашей виртуальной сети. Выберите **Подключиться**. Если появится всплывающее сообщение о сертификате, выберите **Продолжить**, чтобы использовать более высокий уровень привилегий.

2. На странице состояния **подключения** щелкните **Подключить**. Если отображается экран **Выбор сертификата**, убедитесь, что отображается правильный сертификат клиента. Если это не так, выберите правильный сертификат из раскрывающегося списка и нажмите кнопку **ОК**.

3. Если подключение выполняется успешно, появится уведомление **Подключено**.


### <a name="troubleshooting-p2s-connections"></a>Устранение неполадок подключения P2S

[!INCLUDE [verify-client-certificates](../../includes/vpn-gateway-certificates-verify-client-cert-include.md)]

## <a name="verify-the-vpn-connection"></a>Проверка VPN-подключения

1. Убедитесь, что вы используете активное VPN-подключение. Откройте командную строку с повышенными привилегиями на клиентском компьютере и выполните **ipconfig/all**.
2. Просмотрите результаты. Обратите внимание, что полученный вами IP-адрес — это один из адресов в адресном пространстве подключения типа "точка — сеть", которое вы указали при создании виртуальной сети. Результаты должны выглядеть приблизительно как в приведенном примере.

   ```
    PPP adapter VNet1:
        Connection-specific DNS Suffix .:
        Description.....................: VNet1
        Physical Address................:
        DHCP Enabled....................: No
        Autoconfiguration Enabled.......: Yes
        IPv4 Address....................: 192.168.130.2(Preferred)
        Subnet Mask.....................: 255.255.255.255
        Default Gateway.................:
        NetBIOS over Tcpip..............: Enabled
   ```

## <a name="connect-to-a-virtual-machine"></a>Подключение к виртуальной машине

[!INCLUDE [Connect to a VM](../../includes/vpn-gateway-connect-vm-p2s-classic-include.md)]

## <a name="add-or-remove-trusted-root-certificates"></a>Добавление и удаление доверенного корневого сертификата

Вы можете добавлять доверенные корневые сертификаты в Azure, а также удалять их из Azure. При удалении корневого сертификата клиенты, использующие сертификат, созданный из этого корневого сертификата, больше не смогут пройти проверку подлинности и подключиться. Чтобы эти клиенты снова могли проходить проверку подлинности и подключаться, необходимо установить новый сертификат клиента, созданный на основе корневого сертификата, который является доверенным для Azure.

### <a name="to-add-a-trusted-root-certificate"></a>Добавление доверенного корневого сертификата

В Azure можно добавить до 20 CER-файлов доверенных корневых сертификатов. Инструкции см. в разделе "Отправка CER-файла корневого сертификата".

### <a name="to-remove-a-trusted-root-certificate"></a>Удаление доверенного корневого сертификата

1. На странице виртуальной сети в разделе **VPN-подключения** щелкните рисунок, обозначающий клиентов, чтобы открыть страницу **VPN-подключение типа "точка — сеть"**.

   ![Клиенты](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/clients125.png)

2. На странице **VPN-подключение типа "точка — сеть"** щелкните **Управление сертификатами**, чтобы открыть страницу **Сертификаты**.

   ![Страница «Сертификаты»](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/ptsmanage.png)

3. На странице **Сертификаты** выберите кнопку с многоточием рядом с сертификатом, который требуется удалить, а затем выберите **Удалить**.

   ![Удаление корневого сертификата](./media/vpn-gateway-howto-point-to-site-classic-azure-portal/deleteroot.png)

## <a name="revoke-a-client-certificate"></a>Отзыв сертификата клиента

При необходимости можно отозвать сертификат клиента. Список отзыва сертификатов позволяет выборочно запрещать подключение типа "точка-сеть" на основе отдельных сертификатов клиента. Этот метод отличается от удаления доверенного корневого сертификата. При удалении доверенного корневого сертификата (CER-файл) из Azure будет запрещен доступ для всех сертификатов клиента, созданных на основе отозванного корневого сертификата или подписанных им. Отзыв сертификата клиента, а не корневого сертификата, позволяет по-прежнему использовать другие сертификаты, созданные на основе корневого сертификата, для проверки подлинности подключения типа "точка — сеть".

Обычно корневой сертификат используется для управления доступом на уровнях группы или организации, а отозванный сертификат клиента — для точного контроля доступа для отдельных пользователей.

### <a name="to-revoke-a-client-certificate"></a>Отзыв сертификата клиента

Вы можете отозвать сертификат клиента, добавив отпечаток в список отзыва.

1. Получите отпечаток сертификата клиента. Дополнительные сведения см. в статье [Практическое руководство. Извлечение отпечатка сертификата](https://msdn.microsoft.com/library/ms734695.aspx).
2. Скопируйте данные в текстовый редактор и удалите все пробелы, чтобы предоставить отпечаток в виде непрерывной строки.
3. Перейдите в классическую виртуальную сеть. Выберите **VPN-подключение типа "точка — сеть"**, а затем щелкните **Управление сертификатами**, чтобы открыть страницу **Сертификаты**.
4. Выберите **Список отзыва**, чтобы открыть страницу **Список отзыва**. 
5. Выберите **Добавить сертификат**, чтобы открыть страницу **Добавление сертификата в список отзыва**.
6. На странице **Отпечаток** вставьте отпечаток сертификата в виде одной непрерывной текстовой строки без пробелов. Нажмите кнопку **ОК** для завершения.

После применения изменений сертификат больше не будет использоваться для подключения. Клиенты, пытающиеся подключиться с помощью этого сертификата, получат сообщение, что он недействителен.

## <a name="point-to-site-faq"></a>Часто задаваемые вопросы о подключениях типа "точка — сеть"

[!INCLUDE [Point-to-Site FAQ](../../includes/vpn-gateway-faq-point-to-site-classic-include.md)]

## <a name="next-steps"></a>Дальнейшие шаги

- Установив подключение, можно добавить виртуальные машины в виртуальные сети. Дополнительные сведения о виртуальных машинах см. [здесь](https://docs.microsoft.com/azure/). 

- Дополнительные сведения о сетях и виртуальных машинах см. в статье [Виртуальные сети и виртуальные машины в Azure](../virtual-machines/linux/network-overview.md).

- Дополнительные сведения см. в руководстве по [устранению неполадок с подключением "точка — сеть" в Azure](vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems.md).
