---
title: 'Подключение к VNet с помощью P2S VPN & проверки сертификата сертификата: портал'
titleSuffix: Azure VPN Gateway
description: Установите безопасное подключение между клиентами Windows, Mac OS X или Linux и виртуальной сетью Azure с помощью P2S и самозаверяющих сертификатов или сертификатов, выданных ЦС. В этой статье используется портал Azure.
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: conceptual
ms.date: 03/04/2020
ms.author: cherylmc
ms.openlocfilehash: 013ebc2a1343c8eab3d477023e36660c93fa6da5
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79244489"
---
# <a name="configure-a-point-to-site-vpn-connection-to-a-vnet-using-native-azure-certificate-authentication-azure-portal"></a>Настройте VPN-соединение от точки к сайту к VNet с помощью аутентификации сертификата Azure: портал Azure

Эта статья поможет вам установить безопасное подключение отдельных клиентов под управлением Windows, Mac OS X или Linux к виртуальной сети Azure. VPN-подключения типа "точка — сеть" (P2S) эффективны для подключения к виртуальной сети из удаленного расположения, например, если вы дома или на конференции. Вы также можете использовать подключение "точка — сеть" вместо VPN-подключения "сеть — сеть" при наличии небольшого количества клиентов, которым требуется подключение к виртуальной сети. Для подключения типа "точка — сеть" не требуется VPN-устройство или общедоступный IP-адрес. Подключение "точка — сеть" — это VPN-подключение по протоколу SSTP (Secure Socket Tunneling Protocol) или IKEv2. См. дополнительные сведения о [VPN-подключениях "точка — сеть"](point-to-site-about.md).

![Схема соединения компьютера с виртуальной сетью Azure через подключение типа "точка — сеть"](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/p2snativeportal.png)

## <a name="architecture"></a>Architecture

Для собственной аутентификации Azure на основе сертификата при подключениях "точка — сеть" необходимы следующие компоненты, которые можно настроить в этом руководстве:

* VPN-шлюз с маршрутизацией на основе маршрутов.
* Открытый ключ (CER-файл) для корневого сертификата, импортированный в Azure. Сразу после передачи сертификат считается доверенным сертификатом и используется для проверки подлинности.
* Сертификат клиента, созданный на основе корневого сертификата. Сертификат клиента, установленный на каждом клиентском компьютере, который будет подключен к виртуальной сети. Этот сертификат используется для проверки подлинности клиента.
* Конфигурация VPN-клиента. Файлы конфигурации VPN-клиента содержат информацию, необходимую для подключения клиента к виртуальной сети. Эти файлы позволяют настроить существующий VPN-клиент, предоставляемый в операционной системе. Перед подключением каждый клиент нужно настроить, используя параметры в файлах конфигурации.

#### <a name="example-values"></a><a name="example"></a>Значения примера

Следующие значения можно использовать для создания тестовой среды или для лучшего понимания примеров в этой статье.

* **Имя VNet:** VNet1
* **Адресная площадь:** 10.1.0.0/16<br>В этом примере мы используем только одно адресное пространство, но для виртуальной сети можно настроить несколько.
* **Название подсети:** Frontend
* **Диапазон адресов подсети:** 10.1.0.0/24
* **Подписка**. Если у вас есть несколько подписок, убедитесь, что используется правильная.
* **Ресурсная группа:** TestRG1
* **Местонахождение:** Восток США
* **GatewaySubnet:** 10.1.255.0/27<br>
* **Имя шлюза виртуальной сети:** VNet1GW
* **Тип шлюза:** Vpn
* **Тип VPN:** Маршрутна
* **Имя общедоступного IP-адреса:** VNet1GWpip
* **Тип подключения:** "точка — сеть"
* **Пул адресов клиента:** 172.16.201.0/24<br>VPN-клиенты, подключающиеся к виртуальной сети с помощью этого подключения типа "точка — сеть", получают IP-адреса из пула адресов клиента.

## <a name="1-create-a-virtual-network"></a><a name="createvnet"></a>1. Создание виртуальной сети

Прежде чем начать, убедитесь в том, что у вас есть подписка Azure. Если у вас еще нет подписки на Azure, вы можете активировать льготы для [абонента MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details) или подписаться на [бесплатную учетную запись.](https://azure.microsoft.com/pricing/free-trial)
[!INCLUDE [Basic Point-to-Site VNet](../../includes/vpn-gateway-basic-vnet-rm-portal-include.md)]

## <a name="2-create-a-virtual-network-gateway"></a><a name="creategw"></a>2. Создание виртуального сетевого шлюза

На этом шаге вы создадите шлюз для своей виртуальной сети. Создание шлюза часто занимает 45 минут и более, в зависимости от выбранного SKU шлюза.

>[!NOTE]
>Базовый шлюз SKU не поддерживает проверку подлинности IKEv2 или RADIUS. Если вы планируете подключить клиентов Mac к виртуальной сети, не используйте Basic SKU.
>

[!INCLUDE [About gateway subnets](../../includes/vpn-gateway-about-gwsubnet-portal-include.md)]

[!INCLUDE [Create a gateway](../../includes/vpn-gateway-add-gw-rm-portal-include.md)]

## <a name="3-generate-certificates"></a><a name="generatecert"></a>3. Создание сертификатов

Сертификаты используются в Azure для проверки подлинности клиентов, подключающихся к виртуальной сети с помощью подключения "точка — сеть". После получения корневого сертификата необходимо [отправить](#uploadfile) сведения об открытом ключе в Azure. После этого действия корневой сертификат считается "доверенным" в Azure для подключения к виртуальной сети через подключение типа "точка — сеть". Необходимо также создать сертификат клиента на основе доверенного корневого сертификата, а затем установить их на каждом клиентском компьютере. Сертификат клиента используется для проверки подлинности клиента, когда он инициирует подключение к виртуальной сети. 

### <a name="1-obtain-the-cer-file-for-the-root-certificate"></a><a name="getcer"></a>1. Получить файл .cer для корневого сертификата

[!INCLUDE [root-certificate](../../includes/vpn-gateway-p2s-rootcert-include.md)]

### <a name="2-generate-a-client-certificate"></a><a name="generateclientcert"></a>2. Создание сертификата клиента

[!INCLUDE [generate-client-cert](../../includes/vpn-gateway-p2s-clientcert-include.md)]

## <a name="4-add-the-client-address-pool"></a><a name="addresspool"></a>4. Добавить пул адресов клиента

Пул адресов клиента представляет собой диапазон частных IP-адресов, указанных вами. Клиенты, которые подключаются через подключение типа "точка — сеть", динамически получают IP-адреса из этого диапазона. Используйте диапазон частных IP-адресов, не пересекающихся с локальным расположением, из которого будет выполняться подключение, или виртуальной сетью, к которой вы хотите подключиться. Если настроить несколько протоколов и SSTP является одним из протоколов, то настроенный пул адресов делится между настроенными протоколами поровну.

1. После создания шлюза виртуальной сети перейдите к разделу **Параметры** на странице шлюза виртуальной сети. В разделе **Настройки** выберите **конфигурацию от точки к сайту.** Выберите **настройку сейчас,** чтобы открыть страницу конфигурации.

   ![Страница "Конфигурация типа "точка — сеть"](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/point-to-site-configure.png "Настройка от точки к месту сейчас")
2. На странице **конфигурации Point-to-site** можно настроить различные настройки. Если на этой странице не отображается тип туннеля или тип аутентификации, шлюз использует базовый SKU. SKU "Базовый" не поддерживает проверку подлинности IKEv2 и RADIUS. Если вы хотите использовать эти настройки, вам нужно удалить и воссоздать шлюз с помощью другого шлюза SKU.

   [![Страница конфигурации от точки к сайту](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/certificate-settings-address.png "указать пул адресов")](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/certificate-settings-expanded.png#lightbox)
3. В поле **пула Адреса** добавьте частный диапазон IP-адресов, который вы хотите использовать. VPN-клиенты динамически получают IP-адрес из указанного вами диапазона. Минимальная поднетная маска составляет 29 бит для активной/пассивной и 28 битдлядлядля для активной/активной конфигурации.
4. Перейдите к следующему разделу для настройки типа туннеля.

## <a name="5-configure-tunnel-type"></a><a name="tunneltype"></a>5. Настройка типа туннеля

Вы можете выбрать тип туннеля. Варианты туннеля OpenVPN, SSTP и IKEv2.

* Для подключения клиент strongSwan в Android и Linux и собственный VPN-клиент IKEv2 в iOS и OSX используют только туннель IKEv2.
* Клиенты Windows сначала примеряют IKEv2, и если это не подключается, они возвращаются к SSTP.
* Вы можете использовать клиент OpenVPN для подключения к типу туннеля OpenVPN.

![Тип туннеля](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/tunnel.png "указать тип туннеля")

## <a name="6-configure-authentication-type"></a><a name="authenticationtype"></a>6. Настройка типа аутентификации

Для **типа аутентификации**выберите **сертификат Azure.**

  ![Тип аутентификации](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/authentication-type.png "указать тип проверки подлинности")

## <a name="7-upload-the-root-certificate-public-certificate-data"></a><a name="uploadfile"></a>7. Загрузить данные об открытом сертификате корневого сертификата

Всего вы можете отправить до 20 дополнительных доверенных корневых сертификатов. После отправки общедоступных данных сертификата Azure сможет использовать их для проверки подлинности клиентов, на которых установлен клиентский сертификат, созданный из доверенного корневого сертификата. Отправьте сведения об открытом ключе корневого сертификата в Azure.

1. Сертификаты добавляются на страницу **Point-to-site configuration** (Конфигурация "точка — сеть") в колонку **Корневой сертификат**.
2. Корневой сертификат необходимо экспортировать в виде CER-файла X.509 в кодировке Base64. Это позволит открыть сертификат в текстовом редакторе.
3. Откройте сертификат в текстовом редакторе, например в блокноте. При копировании данных сертификата обязательно скопируйте текст как одну непрерывную строку без символов возврата каретки и перевода строки. Может потребоваться изменить параметры представления в текстовом редакторе, чтобы показать символы или показать все знаки и просмотреть символы возврата каретки и перевода строки. Скопируйте только указанный ниже раздел как одну непрерывную строку.

   ![Данные сертификата](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/notepadroot.png "копировать данные корневого сертификата")
4. Вставьте данные сертификата в поле **Данные общедоступного сертификата**. **Назовите** сертификат, а затем выберите **Сохранить**. Вы можете добавить до 20 доверенных корневых сертификатов.

   ![Данные сертификата вставки](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/uploaded.png "данные сертификата вставки")
5. Выберите **Сохранить** в верхней части страницы, чтобы сохранить все настройки конфигурации.

   ![Сохранение конфигурации](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/save.png "сохранить конфигурацию")

## <a name="8-install-an-exported-client-certificate"></a><a name="installclientcert"></a>8. Установка экспортируемого сертификата клиента

Если вы хотите создать подключение типа "точка — сеть" на клиентском компьютере, отличном от того, который использовался для создания сертификатов клиентов, необходимо установить сертификат клиента. При установке сертификата клиента потребуется пароль, созданный при экспорте сертификата клиента.

Убедитесь, что сертификат клиента был экспортирован как PFX-файл вместе со всей цепочкой сертификатов (это значение по умолчанию). В противном случае данные корневого сертификата будут отсутствовать на клиентском компьютере и клиент не сможет пройти проверку должным образом.

Дополнительные сведения см. в руководстве по [установке сертификата клиента](point-to-site-how-to-vpn-client-install-azure-cert.md).

## <a name="9-generate-and-install-the-vpn-client-configuration-package"></a><a name="clientconfig"></a>9. Создание и установка пакета конфигурации VPN

Файлы конфигурации VPN-клиента содержат параметры для настройки устройств, которые подключаются к виртуальной сети с использованием подключения "точка — сеть". Дополнительные сведения см. в инструкциях по [созданию и установке файлов конфигурации VPN-клиента для собственной аутентификации Azure на основе сертификата при подключениях "точка — сеть"](point-to-site-vpn-client-configuration-azure-cert.md).

## <a name="10-connect-to-azure"></a><a name="connect"></a>10. Подключение к Azure

### <a name="to-connect-from-a-windows-vpn-client"></a>Подключение из VPN-клиента для Windows

>[!NOTE]
>Вам потребуются права администратора для клиентского компьютера Windows, с которого устанавливается подключение.
>
>

1. Чтобы подключиться к виртуальной сети, откройте VPN-подключения на клиентском компьютере и найдите созданное VPN-подключение. Его имя совпадает с названием вашей виртуальной сети. Выберите **Подключиться**. Может появиться всплывающее сообщение об использовании сертификата. Выберите **Продолжить** использование повышенных привилегий.

2. На странице состояния **подключения** щелкните **Подключить**. При отображении экрана **Выбор сертификата** убедитесь, что отображается именно тот сертификат клиента, который предполагается использовать для соединения. Если это не так, используйте выпадающую стрелку, чтобы выбрать правильный сертификат, а затем выберите **OK.**

   ![Подключение VPN-клиента к Azure](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/clientconnect.png "подключение")
3. Теперь подключение установлено.

   ![Подключение установлено](./media/vpn-gateway-howto-point-to-site-resource-manager-portal/connected.png "подключение установлено")

#### <a name="troubleshoot-windows-p2s-connections"></a>Устранение неполадок с подключением Windows типа "точка — сеть"

[!INCLUDE [verifies client certificates](../../includes/vpn-gateway-certificates-verify-client-cert-include.md)]

### <a name="to-connect-from-a-mac-vpn-client"></a>Подключение из VPN-клиента для Mac

Из сетевого диалогового окна найдите выбранный для клиента профиль клиента, укажите настройки из [VpnSettings.xml,](point-to-site-vpn-client-configuration-azure-cert.md#installmac)а затем выберите **Connect.**

Ознакомьтесь с подробными инструкциями в разделе [Установка Mac (OS X)](https://docs.microsoft.com/azure/vpn-gateway/point-to-site-vpn-client-configuration-azure-cert#installmac). Если у вас возникают неполадки подключения, убедитесь, что шлюз виртуальной сети не использует SKU "Базовый". SKU "Базовый" не поддерживается для клиентов Mac.

  ![Подключение для Mac](./media/vpn-gateway-howto-point-to-site-rm-ps/applyconnect.png "Подключение")

## <a name="to-verify-your-connection"></a><a name="verify"></a>Проверка подключения

Эти инструкции применимы к клиентам Windows.

1. Чтобы проверить, активно ли VPN-подключение, откройте окно командной строки от имени администратора и выполните команду *ipconfig/all*.
2. Просмотрите результаты. Обратите внимание, что полученный вами IP-адрес — это один из адресов в пуле адресов VPN-клиента подключения "точка–cеть", указанном в конфигурации. Вы должны увидеть результат, аналогичный приведенному ниже.

   ```
   PPP adapter VNet1:
      Connection-specific DNS Suffix .:
      Description.....................: VNet1
      Physical Address................:
      DHCP Enabled....................: No
      Autoconfiguration Enabled.......: Yes
      IPv4 Address....................: 172.16.201.3(Preferred)
      Subnet Mask.....................: 255.255.255.255
      Default Gateway.................:
      NetBIOS over Tcpip..............: Enabled
   ```

## <a name="to-connect-to-a-virtual-machine"></a><a name="connectVM"></a>Подключение к виртуальной машине

Эти инструкции применимы к клиентам Windows.

[!INCLUDE [Connect to a VM](../../includes/vpn-gateway-connect-vm-p2s-include.md)]

## <a name="to-add-or-remove-trusted-root-certificates"></a><a name="add"></a>Добавление и удаление доверенного корневого сертификата

Вы можете добавлять доверенные корневые сертификаты в Azure, а также удалять их из Azure. При удалении корневого сертификата клиенты, использующие сертификат, созданный из этого корневого сертификата, не смогут пройти проверку подлинности и поэтому не смогут подключиться. Чтобы клиенты могли проходить аутентификацию и подключаться, необходимо установить новый сертификат клиента, созданный на основе корневого сертификата, который является доверенным для Azure (то есть он передан в Azure).

### <a name="to-add-a-trusted-root-certificate"></a>Добавление доверенного корневого сертификата

В Azure можно добавить до 20 CER-файлов доверенных корневых сертификатов. Дополнительные сведения см. в разделе [Отправка доверенного корневого сертификата](#uploadfile) в этой статье.

### <a name="to-remove-a-trusted-root-certificate"></a>Удаление доверенного корневого сертификата

1. Чтобы удалить доверенный корневой сертификат, перейдите на страницу **Point-to-site configuration** (Конфигурация "точка — сеть") вашего шлюза виртуальной сети.
2. В разделе страницы**Root certificate** (Корневой сертификат) найдите сертификат, который требуется удалить.
3. Выберите эллипсис рядом с сертификатом, а затем выберите 'Удалить'.

## <a name="to-revoke-a-client-certificate"></a><a name="revokeclient"></a>Отзыв сертификата клиента

Можно отозвать сертификаты клиента. Список отзыва сертификатов позволяет выборочно запрещать подключение типа "точка-сеть" на основе отдельных сертификатов клиента. Эта процедура отличается от удаления доверенного корневого сертификата. При удалении доверенного корневого сертификата (CER-файл) из Azure будет запрещен доступ для всех сертификатов клиента, созданных на основе отозванного корневого сертификата или подписанных им. Отзыв сертификата клиента, а не корневого сертификата, позволяет по-прежнему использовать другие сертификаты, созданные на основе корневого сертификата, для проверки подлинности.

Обычно корневой сертификат используется для управления доступом на уровнях группы или организации, а отозванный сертификат клиента — для точного контроля доступа для отдельных пользователей.

### <a name="revoke-a-client-certificate"></a>Отзыв сертификата клиента

Вы можете отозвать сертификат клиента, добавив отпечаток в список отзыва.

1. Получите отпечаток сертификата клиента. Для получения дополнительной [информации см.](https://msdn.microsoft.com/library/ms734695.aspx)
2. Скопируйте данные в текстовый редактор и удалите все пробелы, чтобы предоставить отпечаток в виде непрерывной строки.
3. Перейдите к странице шлюза виртуальной сети **Point-to-site-configuration** (Конфигурация "точка — сеть"). Это та же колонка, которая использовалась для [отправки доверенного корневого сертификата](#uploadfile).
4. В разделе **Отозванные сертификаты** введите понятное имя сертификата (это не должно быть общее имя).
5. Скопируйте и вставьте строку отпечатка в поле **Отпечаток**.
6. Отпечаток будет проверен и автоматически добавлен в список отзыва. На экране появится сообщение о том, что список обновляется. 
7. После применения изменений сертификат больше не будет использоваться для подключения. Клиенты, пытающиеся подключиться с помощью этого сертификата, получат сообщение, что он недействителен.

## <a name="point-to-site-faq"></a><a name="faq"></a>Часто задаваемые вопросы о подключениях типа "точка — сеть"

[!INCLUDE [Point-to-Site FAQ](../../includes/vpn-gateway-faq-p2s-azurecert-include.md)]

## <a name="next-steps"></a>Дальнейшие действия
Установив подключение, можно добавить виртуальные машины в виртуальные сети. Дополнительные сведения о виртуальных машинах см. [здесь](https://docs.microsoft.com/azure/). Дополнительные сведения о сетях и виртуальных машинах см. в статье [Azure и Linux: обзор сетей виртуальных машин](../virtual-machines/linux/azure-vm-network-overview.md).

Дополнительные сведения см. в руководстве по [устранению неполадок подключения типа "точка — сеть" в Azure](vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems.md).
