---
title: Чтение запросов к репликам
description: База данных SQL Azure предоставляет возможность балансировки нагрузки только для чтения с использованием емкости реплик только для чтения, называемых горизонтальным масштабированием чтения.
services: sql-database
ms.service: sql-db-mi
ms.subservice: high-availability
titleSuffix: Azure SQL Database & SQL Managed Instance
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: sstein, carlrab
ms.date: 06/03/2019
ms.openlocfilehash: a043eb5eed8f5554e42a113a3d7963be94da8a49
ms.sourcegitcommit: 93462ccb4dd178ec81115f50455fbad2fa1d79ce
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2020
ms.locfileid: "85985573"
---
# <a name="use-read-only-replicas-to-load-balance-read-only-query-workloads"></a>Использование реплик, доступных только для чтения, для распределения рабочих нагрузок запросов, доступных только для чтения
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

В рамках архитектуры с [высоким уровнем доступности](high-availability-sla.md#premium-and-business-critical-service-tier-availability)каждая база данных на уровнях Premium и критически важный для бизнеса служб автоматически подготавливается с помощью первичной и нескольких вторичных реплик. Вторичные реплики подготавливаются с тем же размером вычислений, что и первичная реплика. Функция *масштабирования чтения* позволяет балансировать нагрузку только для чтения базы данных SQL, используя емкость одной из реплик только для чтения, а не предоставляет доступ к реплике для чтения и записи. Таким образом, Рабочая нагрузка только для чтения будет изолирована от основной рабочей нагрузки для чтения и записи и не повлияет на ее производительность. Эта функция предназначена для приложений, которые содержат логически разделенные рабочие нагрузки только для чтения, такие как аналитика. На уровнях служб "Премиум" и "критически важный для бизнеса" приложения могут повысить производительность с помощью этой дополнительной емкости без дополнительных затрат.

При создании хотя бы одной вторичной реплики также доступна функция горизонтального масштабирования для чтения на уровне служб. Несколько вторичных реплик можно использовать, если для рабочих нагрузок только для чтения требуется больше ресурсов, чем доступно на одной вторичной реплике. Архитектура высокого уровня доступности уровней "базовый", "Стандартный" и "общего назначения" не включает ни одной реплики. Функция горизонтального масштабирования чтения недоступна на этих уровнях служб.

На следующей схеме показано использование базы данных критически важный для бизнеса.

![Реплики только для чтения](./media/read-scale-out/business-critical-service-tier-read-scale-out.png)

Функция масштабирования чтения по умолчанию включена для новых баз данных Premium, критически важный для бизнеса и Scale. Для линейного масштабирования одна вторичная реплика по умолчанию создается для новых баз данных. Если строка подключения SQL настроена с помощью `ApplicationIntent=ReadOnly` , то приложение будет перенаправляться шлюзом в реплику, доступную только для чтения этой базы данных. Сведения об использовании `ApplicationIntent` свойства см. в разделе [Указание намерения приложения](https://docs.microsoft.com/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#specifying-application-intent).

Если вы хотите убедиться, что приложение подключается к первичной реплике независимо от `ApplicationIntent` параметра в строке подключения SQL, необходимо явно отключить горизонтальное масштабирование чтения при создании базы данных или при изменении ее конфигурации. Например, если вы обновите базу данных с уровня "Стандартный" или "общего назначения" на "Премиум", "критически важный для бизнеса" или "Масштаб" и хотите убедиться, что все подключения продолжают переходить на первичную реплику, отключите масштабирование чтения. Дополнительные сведения об отключении см. в разделе [Включение и отключение горизонтального масштабирования для чтения](#enable-and-disable-read-scale-out).

> [!NOTE]
> Хранилище данных запросов, расширенные события и функции SQL Profiler не поддерживаются в репликах только для чтения.

## <a name="data-consistency"></a>Согласованность данных

Одним из преимуществ реплик является то, что реплики всегда находятся в состоянии транзакционной согласованности, но в разные моменты времени может возникать небольшая задержка между различными репликами. Масштабное масштабирование чтения поддерживает согласованность на уровне сеанса. Это означает, что если сеанс только для чтения повторно подключится после ошибки подключения, вызванной недоступностью реплики, она может быть перенаправлена на реплику, которая не 100% в актуальном состоянии с репликой для чтения и записи. Аналогично, если приложение записывает данные с помощью сеанса чтения и записи и сразу же считывает их с помощью сеанса только для чтения, возможно, что последние обновления не будут немедленно видны в реплике. Задержка вызвана асинхронной операцией повтора журнала транзакций.

> [!NOTE]
> Задержка репликации в пределах региона мала, и такая ситуация возникает редко.

## <a name="connect-to-a-read-only-replica"></a>Подключение к реплике только для чтения

При включении масштабирования чтения для базы данных `ApplicationIntent` параметр в строке подключения, предоставленной клиентом, определяет, будет ли соединение направляться к реплике записи или к реплике только для чтения. В частности, если `ApplicationIntent` значение равно `ReadWrite` (значение по умолчанию), соединение будет перенаправляться в реплику, доступную для чтения и записи базы данных. Также происходит и без этой функции. Если значение `ApplicationIntent` — `ReadOnly`, подключение направляется к реплике, доступной только для чтения.

Например, следующая строка подключения позволяет подключить клиента к реплике только для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```sql
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadOnly;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

Обе приведенные ниже строки подключения подключают подключить клиента к реплике для чтения и записи (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```sql
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadWrite;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;

Server=tcp:<server>.database.windows.net;Database=<mydatabase>;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

## <a name="verify-that-a-connection-is-to-a-read-only-replica"></a>Убедитесь, что подключение выполняется к реплике только для чтения

Можно проверить, подключены ли вы к реплике только для чтения, выполнив приведенный ниже запрос. Он возвратит READ_ONLY при подключении к реплике только для чтения.

```sql
SELECT DATABASEPROPERTYEX(DB_NAME(), 'Updateability')
```

> [!NOTE]
> В любой момент времени только одна из реплик AlwaysON доступна только сеансам, доступным только для чтения.

## <a name="monitor-and-troubleshoot-a-read-only-replica"></a>Мониторинг и устранение неполадок реплики только для чтения

При подключении к реплике только для чтения можно получить доступ к метрикам производительности с помощью `sys.dm_db_resource_stats` динамического административного представления. Для доступа к статистике плана запроса используйте `sys.dm_exec_query_stats` динамические `sys.dm_exec_query_plan` `sys.dm_exec_sql_text` административные представления.

> [!NOTE]
> Динамическое административное представление `sys.resource_stats` в логической базе данных Master возвращает данные об использовании ЦП и хранилища первичной реплики.

## <a name="enable-and-disable-read-scale-out"></a>Включение и отключение горизонтального масштабирования для чтения

Горизонтальное масштабирование чтения включено по умолчанию на уровнях служб Premium, критически важный для бизнеса и Scale. Невозможно включить горизонтальное масштабирование чтения на уровнях служб "базовый", "Стандартный" или "общего назначения". Горизонтальное масштабирование чтения автоматически отключается для баз данных масштаба, настроенных с нулевыми репликами.

Вы можете отключить и повторно включить масштабирование чтения для отдельных баз данных и баз данных эластичного пула на уровне службы Premium или критически важный для бизнеса, используя следующие методы.

> [!NOTE]
> Возможность отключения горизонтального масштабирования для чтения предоставляется для обеспечения обратной совместимости.

### <a name="azure-portal"></a>Портал Azure

Вы можете управлять параметром масштабирования чтения в колонке **Настройка** базы данных.

### <a name="powershell"></a>PowerShell

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается, но вся будущая разработка предназначена для модуля AZ. SQL. Модуль Azure Resource Manager продолжит отправлять исправления ошибок до 2020 декабря.  Аргументы для команд в модуле AZ и в Azure Resource Managerных модулях значительно идентичны. Дополнительные сведения о совместимости см. в разделе [Введение в новый модуль Azure PowerShell AZ](/powershell/azure/new-azureps-module-az).

Для управления горизонтальным масштабированием чтения в Azure PowerShell требуется выпуск от декабря 2016 Azure PowerShell или более поздней версии. Последнюю версию Azure PowerShell см. [здесь](https://docs.microsoft.com/powershell/azure/install-az-ps).

Можно отключить или повторно включить горизонтальное масштабирование чтения в Azure PowerShell, вызвав командлет [Set-азсклдатабасе](/powershell/module/az.sql/set-azsqldatabase) и передав нужное значение ( `Enabled` или `Disabled` ) для `-ReadScale` параметра.

Чтобы отключить горизонтальное масштабирование чтения в существующей базе данных (замените элементы в угловых скобках правильными значениями для вашей среды и удалите угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Disabled
```

Чтобы отключить горизонтальное масштабирование чтения в новой базе данных (замените элементы в угловых скобках правильными значениями для вашей среды и удалите угловые скобки):

```powershell
New-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Disabled -Edition Premium
```

Чтобы повторно включить горизонтальное масштабирование чтения в существующей базе данных (заменив элементы в угловых скобках на правильные значения для вашей среды и удалив угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Enabled
```

### <a name="rest-api"></a>REST API

Чтобы создать базу данных с отключенным горизонтальным масштабированием чтения или изменить параметр для существующей базы данных, используйте следующий метод со `readScale` свойством, для которого задано значение `Enabled` или `Disabled` , как в следующем примере запроса.

```rest
Method: PUT
URL: https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{GroupName}/providers/Microsoft.Sql/servers/{ServerName}/databases/{DatabaseName}?api-version= 2014-04-01-preview
Body: {
   "properties": {
      "readScale":"Disabled"
   }
}
```

Дополнительные сведения см. в разделе [базы данных — создание или обновление](https://docs.microsoft.com/rest/api/sql/databases/createorupdate).

## <a name="using-tempdb-on-a-read-only-replica"></a>Использование TempDB в реплике только для чтения

База данных TempDB не реплицируется в реплики только для чтения. Каждая реплика имеет собственную версию базы данных TempDB, созданную при создании реплики. Это гарантирует, что база данных TempDB может быть обновлена и изменена во время выполнения запроса. Если Рабочая нагрузка только для чтения зависит от использования объектов TempDB, следует создать эти объекты в рамках скрипта запроса.

## <a name="using-read-scale-out-with-geo-replicated-databases"></a>Использование горизонтального масштабирования для чтения с географически реплицируемыми базами данных

Если вы используете масштабирование для чтения и балансировки нагрузки только для чтения в базе данных, которая является геореплицированной (например, членом группы отработки отказа), убедитесь, что горизонтальное масштабирование для чтения включено как в основной, так и в геореплицированных базах данных-получателях. Эта конфигурация гарантирует, что при подключении приложения к новой версии-источнику после отработки отказа будет выполняться одна и та же процедура балансировки нагрузки. 

Если вы подключаетесь к геореплицированной базе данных-получателю с включенной возможностью чтения и масштабирования, ваши сеансы `ApplicationIntent=ReadOnly` будут направляться в одну из реплик так же, как мы маршрутизировать соединения в базе данных-источнике.  Сеансы без `ApplicationIntent=ReadOnly` будут направляться в первичную реплику геореплицированной базы данных-получателя (тоже только для чтения). Так как геореплицированная база данных-получатель имеет другую конечную точку, чем база данных-источник, для доступа к ней не требовалось задавать значение `ApplicationIntent=ReadOnly` . Для обеспечения обратной совместимости в динамическом административном представлении `sys.geo_replication_links` отображается `secondary_allow_connections=2` (разрешены любые подключения клиента).

> [!NOTE]
> Циклический перебор или любая другая маршрутизация с балансировкой нагрузки между локальными репликами базы данных-получателя не поддерживается.

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о предложении для масштабирования базы данных SQL см. в разделе " [уровень служб](service-tier-hyperscale.md)".
