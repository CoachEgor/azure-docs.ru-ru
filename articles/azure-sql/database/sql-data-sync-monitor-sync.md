---
title: Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor
description: Узнайте, как отслеживать синхронизация данных SQL с помощью журналов Azure Monitor.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: data sync, sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: carlrab
ms.date: 12/20/2018
ms.openlocfilehash: 307e501743d01b94cfca3692cc09c05cc90ed3ce
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "84343240"
---
# <a name="monitor-sql-data-sync-with-azure-monitor-logs"></a>Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor 

Чтобы проверить журнал действий синхронизации данных SQL и обнаружить ошибки и предупреждения, необходимо сначала проверить синхронизацию данных SQL вручную на портале Azure, с помощью PowerShell или REST API. Выполните шаги в этой статье, чтобы настроить пользовательское решение, которое улучшает мониторинг синхронизации данных. Вы можете настроить это решение в соответствии со своим сценарием.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../../includes/azure-monitor-log-analytics-rebrand.md)]

Общие сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL в Azure](sql-data-sync-data-sql-server-sql-database.md).

> [!IMPORTANT]
> В настоящее время синхронизация данных SQL **не поддерживает Azure** SQL управляемый экземпляр.

## <a name="monitoring-dashboard-for-all-your-sync-groups"></a>Панель мониторинга для всех групп синхронизации 

Для поиска проблем больше не нужно просматривать журналы каждой группы синхронизации по отдельности. Вы можете отслеживать все группы синхронизации из любой подписки в одном месте, используя настраиваемое представление Azure Monitor. В этом представлении отображается информация, которая важна для клиентов синхронизации данных SQL.

![Панель мониторинга синхронизации данных](./media/sql-data-sync-monitor-sync/sync-monitoring-dashboard.png)

## <a name="automated-email-notifications"></a>Автоматические уведомления по электронной почте

Вам больше не требуется проверять журнал вручную на портале Azure, через PowerShell или REST API. С помощью [журналов Azure Monitor](https://docs.microsoft.com/azure/log-analytics/log-analytics-overview)можно создавать оповещения, которые будут обращаться непосредственно к адресам электронной почты людей, которые должны видеть их при возникновении ошибки.

![Уведомления по электронной почте о синхронизации данных](./media/sql-data-sync-monitor-sync/sync-email-notifications.png)

## <a name="how-do-you-set-up-these-monitoring-features"></a>Как настроить эти возможности мониторинга? 

Реализуйте настраиваемое Azure Monitor журналов решение для мониторинга синхронизация данных SQL менее часа, выполнив следующие действия.

Необходимо настроить три компонента:

-   Модуль Runbook PowerShell для передачи данных журнала синхронизация данных SQL в журналы Azure Monitor.

-   Оповещение Azure Monitor для уведомлений по электронной почте.

-   Представление Azure Monitor для мониторинга.

### <a name="samples-to-download"></a>Примеры для скачивания

Скачайте два следующих образца:

-   [Модуль runbook PowerShell для журнала синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogPowerShellRunbook.ps1)

-   [Представление Azure Monitor синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogOmsView.omsview)

### <a name="prerequisites"></a>Предварительные условия

Настройте следующие компоненты:

-   учетную запись службы автоматизации Azure;

-   Рабочая область Log Analytics

## <a name="powershell-runbook-to-get-sql-data-sync-log"></a>Использование модуля runbook PowerShell для получения журнала синхронизации данных SQL 

Используйте модуль Runbook PowerShell, размещенный в службе автоматизации Azure, чтобы извлечь данные журнала синхронизация данных SQL и отправить их в журналы Azure Monitor. Пример сценария включен. Предварительно необходимо создать учетную запись службы автоматизации Azure. Затем необходимо создать модуль runbook и запланировать его запуск. 

### <a name="create-a-runbook"></a>Создание модуля runbook

Дополнительные сведения о создании модулей runbook см. в статье [Мой первый модуль Runbook PowerShell](https://docs.microsoft.com/azure/automation/automation-first-runbook-textual-powershell).

1.  В рамках учетной записи службы автоматизации Azure выберите вкладку **Модули Runbook** в разделе Process Automation (Автоматизация процессов).

2.  Выберите **Добавить Runbook** в левом верхнем углу страницы модули Runbook.

3.  Выберите **Импорт существующего модуля Runbook**.

4.  В разделе **Runbook file** (Файл runbook) используйте данный файл `DataSyncLogPowerShellRunbook`. Задайте **тип runbook** как `PowerShell`. Присвойте имя модулю runbook.

5.  Выберите **Создать**. Теперь у вас есть модуль runbook.

6.  В рамках учетной записи службы автоматизации Azure в разделе "Общие ресурсы" выберите вкладку **Переменные**.

7.  На странице "Переменные" выберите **Add a variable** (Добавить переменную). Создайте переменную для времени последнего выполнения модуля Runbook. Если у вас есть несколько модулей runbook, необходимо создать переменную для каждого из них.

8.  Присвойте переменной имя `DataSyncLogLastUpdatedTime` и задайте для нее тип DateTime.

9.  Выберите runbook и нажмите кнопку "Изменить" в верхней части страницы.

10. Внесите необходимые изменения в учетной записи и конфигурации синхронизации данных SQL. (Дополнительные сведения см. в примере сценария.)

    1.  Сведения, касающиеся Azure.

    2.  сведения о группе синхронизации.

    3.  Azure Monitor сведения о журналах. Найти эти сведения в портал Azure | Параметры | Подключенные источники. Дополнительные сведения об отправке данных в журналы Azure Monitor см. [в статье отправка данных в журналы Azure Monitor с помощью API сборщика данных HTTP (Предварительная версия)](../../azure-monitor/platform/data-collector-api.md).

11. Запустите runbook в области тестирования. Убедитесь, что он выполнен успешно.

    При наличии ошибок убедитесь, что у вас установлена последняя версия модуля PowerShell. Вы можете установить последнюю версию модуля PowerShell в **коллекции модулей** в вашей учетной записи службы автоматизации.

12. Нажмите кнопку **опубликовать** .

### <a name="schedule-the-runbook"></a>Создание расписания для runbook

Чтобы создать расписание для runbook:

1.  В модуле runbook в разделе Resources (Ресурсы) выберите вкладку **Schedules** (Расписания).

2.  Выберите **Add a Schedule** (Добавить расписание) на странице Schedules (Расписания).

3.  Выберите **связать расписание с модулем Runbook**.

4.  Выберите **создать новое расписание.**

5.  Задайте **повторение** и установите необходимый интервал. Используйте этот же интервал в скрипте и в журналах Azure Monitor.

6.  Выберите **Создать**.

### <a name="check-the-automation"></a>Проверка автоматизации

Для наблюдения за тем, работает ли автоматизация как ожидалось, в разделе **Обзор** вашей учетной записи автоматизации в разделе **Мониторинг** найдите представление **Job Statistics** (Статистика задания). Закрепите представление на панели мониторинга, чтобы его было удобнее просматривать. Успешные запуски Runbook имеют состояние "Завершено", а для запусков, которые завершились сбоем, отображается состояние "Сбой".

## <a name="create-an-azure-monitor-reader-alert-for-email-notifications"></a>Создание оповещения модуля чтения Azure Monitor для уведомлений по электронной почте

Чтобы создать оповещение, которое использует журналы Azure Monitor, выполните следующие действия. В качестве необходимого компонента необходимо иметь Azure Monitor журналы, связанные с рабочей областью Log Analytics.

1.  На портале Azure выберите **Поиск по журналу**.

2.  Создайте запрос, чтобы выбрать ошибки и предупреждения по группе синхронизации в течение выбранного интервала. Пример:

    `DataSyncLog_CL | where LogLevel_s != "Success" | summarize AggregatedValue = count() by bin(TimeGenerated,60m),SyncGroupName_s`

3.  После выполнения запроса щелкните значок в виде колокольчика, сигнализирующий об **оповещении**.

4.  В разделе **Generate alert based on** (Создать оповещение на основе) выберите **Metric Measurement** (Измерение метрик).

    1.  Установите статистическое значение **Больше чем**.

    2.  После задания **Больше чем** введите пороговое значение, по достижении которого начнут поступать уведомления. В синхронизации данных ожидается наличие временных ошибок. Чтобы уменьшить шум, установите пороговое значение 5.

5.  В разделе **действия**задайте для **уведомления по электронной почте** значение "Да". Введите необходимые электронные адреса получателей.

6.  Нажмите кнопку **Сохранить**. Теперь при возникновении ошибок заданные получатели будут получать уведомления по электронной почте.

## <a name="create-an-azure-monitor-view-for-monitoring"></a>Создание представления Azure Monitor для мониторинга

На этом шаге создается представление Azure Monitor для визуального наблюдения за всеми указанными группами синхронизации. Представление содержит несколько компонентов:

-   плитку обзора, которая показывает количество ошибок, успешных выполнений и предупреждений во всех группах синхронизации;

-   плитку для всех групп синхронизации, которая показывает количество ошибок и предупреждений в группе синхронизации (группы, в которых нет сбоев, не отображаются на этой плитке);

-   Плитка для каждой группы синхронизации, показывающая количество ошибок, успешных и предупреждающих сообщений, а также последние сообщения об ошибках.

Чтобы настроить Azure Monitor представление, выполните следующие действия.

1.  На домашней странице рабочей области Log Analytics щелкните плюс слева, чтобы открыть **Конструктор представлений**.

2.  Выберите **Импорт** на верхней панели конструктора представлений. Затем выберите пример файла "DataSyncLogOMSView".

3.  Этот пример представления предназначен для управления двумя группами синхронизации. Измените это представление в соответствии с вашим сценарием. Щелкните **Изменить** и внесите следующие изменения:

    1.  При необходимости создайте объекты "Кольцевая диаграмма и список" из коллекции.

    2.  В каждой плитке обновите запросы, указав свои сведения.

        1.  В каждой плитке измените интервал TimeStamp_t соответствующим образом.

        2.  На плитках каждой группы синхронизации обновите имена групп синхронизации.

    3.  Обновите название каждой плитки соответствующим образом.

4.  Нажмите кнопку **Сохранить**. Представление готово.

## <a name="cost-of-this-solution"></a>Стоимость этого решения

В большинстве случаев это решение будет бесплатным.

**Служба автоматизации Azure.** В зависимости от вашего использования могут возникнуть дополнительные затраты, связанные с учетной записью службы автоматизации Azure. Первые 500 минут времени выполнения заданий в месяц бесплатны. Ожидается, что в большинстве случаев это решение будет использовать менее 500 минут в месяц. Чтобы избежать расходов, создайте расписание для runbook с интервалом в два или более часов. Дополнительные сведения см. на странице [цен на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

**Журналы Azure Monitor:** В зависимости от используемого использования могут возникнуть затраты, связанные с Azure Monitor журналами. На бесплатном уровне доступно 500 МБ получаемых данных в день. Ожидается, что в большинстве случаев это решение будет принимать менее чем 500 МБ в день. Чтобы уменьшить потребление, используйте фильтрацию по сбоям, включенную в runbook. Если вы используете более 500 МБ в день, выполните обновление до платного уровня, чтобы избежать риска остановки аналитики при достижении ограничения. Дополнительные сведения см. в статье [цены на Azure Monitor журналов](https://azure.microsoft.com/pricing/details/log-analytics/).

## <a name="code-samples"></a>Примеры кода

Скачайте примеры кода, описанные в этой статье, по следующим ссылкам:

-   [Модуль runbook PowerShell для журнала синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogPowerShellRunbook.ps1)

-   [Представление Azure Monitor синхронизации данных](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/sql-data-sync/DataSyncLogOmsView.omsview)

## <a name="next-steps"></a>Дальнейшие шаги
Дополнительные сведения о синхронизации данных SQL:

-   Обзор. [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL в Azure](sql-data-sync-data-sql-server-sql-database.md)
-   Настройка синхронизации данных
    - На портале — [учебник. настройка синхронизация данных SQL для синхронизации данных между базой данных SQL Azure и SQL Server](sql-data-sync-sql-server-configure.md)
    - С помощью PowerShell
        -  [Синхронизация нескольких баз данных в базе данных SQL Azure с помощью PowerShell](scripts/sql-data-sync-sync-data-between-sql-databases.md)
        -  [Использование PowerShell для синхронизации между базой данных в базе данных SQL Azure и базой данных в экземпляре SQL Server](scripts/sql-data-sync-sync-data-between-azure-onprem.md)
-   Агент синхронизации данных: [Агент синхронизации данных для синхронизации данных SQL в Azure](sql-data-sync-agent-overview.md)
-   Рекомендации: [Рекомендации по синхронизации данных SQL в Azure](sql-data-sync-best-practices.md)
-   Устранение неполадок: [Устранение неполадок с синхронизацией данных SQL в Azure](sql-data-sync-troubleshoot.md)
-   Обновление схемы синхронизации
    -   С помощью Transact-SQL — [Автоматизируйте репликацию изменений схемы в Синхронизация данных SQL в Azure](sql-data-sync-update-sync-schema.md)
    -   С помощью PowerShell: [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/update-sync-schema-in-sync-group.md).

Дополнительные сведения о Базе данных SQL:

-   [Обзор Базы данных SQL](../../sql-database/sql-database-technical-overview.md)
-   [Управление жизненным циклом базы данных](https://msdn.microsoft.com/library/jj907294.aspx)
