---
title: Распределенные транзакции по облачным базам данных
description: Общие сведения о транзакциях эластичной базы данных с помощью базы данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: scale-out
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 03/12/2019
ms.openlocfilehash: 5c94234644fcefb70a40ba0b2c21e6e205be0e65
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85829420"
---
# <a name="distributed-transactions-across-cloud-databases"></a>Распределенные транзакции по облачным базам данных
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Транзакции эластичных баз данных для базы данных SQL Azure позволяют выполнять транзакции, охватывающие несколько баз данных в базе. Транзакции эластичных баз данных для базы данных SQL доступны для приложений .NET с помощью ADO .NET и интегрируются с привычным интерфейсом программирования с помощью классов [System. Transaction](https://msdn.microsoft.com/library/system.transactions.aspx) . Инструкции по подключению библиотеки см. в статье [Microsoft .NET Framework 4.6.1 (веб-установщик) для Windows 7 SP1, Windows 8, Windows 8.1, Windows 10, Windows Server 2008 R2 SP1, Windows Server 2012 и Windows Server 2012 R2](https://www.microsoft.com/download/details.aspx?id=49981).

В локальной среде такой сценарий обычно требует запуска Microsoft координатор распределенных транзакций (MSDTC). Так как MSDTC недоступен для приложения типа "платформа как услуга" в Azure, возможность координировать распределенные транзакции теперь напрямую интегрирована в базу данных SQL. Приложения могут подключаться к любой базе данных в базе данных SQL для запуска распределенных транзакций, а одна из баз данных будет прозрачно координировать распределенную транзакцию, как показано на следующем рисунке.

  ![Осуществление распределенных транзакций в Базе данных SQL Azure с использованием транзакций эластичной базы данных ][1]

## <a name="common-scenarios"></a>Распространенные сценарии

Транзакции эластичных баз данных для базы данных SQL позволяют приложениям вносить атомарные изменения в данные, хранящиеся в разных базах данных SQL. Эта предварительная версия ориентирована на клиентскую разработку на языке C# с использованием платформы .NET. В будущем планируется предоставить возможность такой работы на сервере с использованием T-SQL.  
Транзакции эластичной базы данных предназначены для следующих сценариев:

* Приложения с несколькими базами данных в Azure. в этом сценарии данные вертикально секционированы по нескольким базам данных SQL, так что различные типы данных находятся в разных базах данных. Некоторые операции нуждаются в изменениях данных, которые хранятся в двух или более базах данных. Приложение использует транзакции эластичной базы данных для скоординированного внесения изменений в базах данных и обеспечения атомарности.
* Сегментированные приложения баз данных в Azure. в этом сценарии уровень данных использует [клиентскую библиотеку эластичной базы данных](elastic-database-client-library.md) или самосегментирование для горизонтального секционирования данных по нескольким базам данных в SQL. Первый пример использования заключается в необходимости внести атомарные изменения в сегментированное мультитенантное приложение, если изменения распространяются на клиенты. Например, рассмотрим передачу данных из одного клиента в другой, при этом оба клиента находятся в разных базах данных. Второй вариант — детальное сегментирование для удовлетворения потребностей больших клиентов, которые, в свою очередь, обычно подразумевают, что некоторые атомарные операции должны быть перенесены в несколько баз данных, используемых для одного и того же клиента. Третий пример предусматривает атомарное обновление, обеспечивающее возможность ссылаться на данные, реплицируемые в базах данных. Теперь благодаря предварительной версии стала возможна координация атомарных транзакционных операций со всеми этими строками в нескольких базах данных.
  Транзакции эластичной базы данных используют двухфазную фиксацию для обеспечения атомарности транзакций в базах данных. Это хорошо подходит для транзакций, в которых в одной транзакции задействовано менее 100 баз данных. Эти ограничения не применяются, но при превышении этих ограничений для транзакций эластичной базы данных следует рассчитывать на производительность и успешную скорость.

## <a name="installation-and-migration"></a>Установка и миграция

Возможности транзакций эластичной базы данных в базе данных SQL предоставляются посредством обновления библиотек .NET System.Data.dll и System.Transactions.dll. Библиотеки DLL обеспечивают использование двухфазной фиксации для соблюдения атомарности. Чтобы начать разработку приложений, использующих транзакции эластичной базы данных, установите платформу [.NET 4.6.1](https://www.microsoft.com/download/details.aspx?id=49981) или более поздней версии. При использовании платформы .NET предыдущей версии происходит ошибка повышения уровня транзакций до распределенных, после чего возникает исключение.

После установки можно использовать интерфейсы API распределенных транзакций в System. Transactions с соединениями с базой данных SQL. При наличии приложений MSDTC, использующих эти API, после установки платформы 4.6.1 просто повторно создайте существующие приложения .NET 4.6. Если проекты ориентированы на .NET 4,6, они будут автоматически использовать обновленные библиотеки DLL из новой версии платформы и вызовы API распределенных транзакций в сочетании с подключениями к базе данных SQL теперь будут выполнены.

Помните, что для транзакций эластичной базы данных не требуется установка MSDTC. Вместо этого транзакции эластичной базы данных напрямую управляются с помощью и в базе данных SQL. Это значительно упрощает облачные сценарии, поскольку развертывание MSDTC не требуется для использования распределенных транзакций с базой данных SQL. В разделе 4 более подробно описано развертывание транзакций эластичной базы данных и требуемой платформы .NET вместе с облачными приложениями в Azure.

## <a name="development-experience"></a>Разработка

### <a name="multi-database-applications"></a>Приложения, использующие несколько баз данных

В следующем примере кода знакомые приемы программирования используются в сочетании с System.Transactions .NET. Класс TransactionScope позволяет выполнить внешнюю транзакцию в .NET. («Внешняя транзакция» — это то, что находится в текущем потоке.) Все соединения, открытые в TransactionScope, участвуют в транзакции. Если в транзакции задействовано несколько разных баз данных, ее уровень автоматически повышается и она стает распределенной. Для этого необходимо задать в настройках области ее завершение, что позволяет обозначить выполнение фиксации.

```csharp
    using (var scope = new TransactionScope())
    {
        using (var conn1 = new SqlConnection(connStrDb1))
        {
            conn1.Open();
            SqlCommand cmd1 = conn1.CreateCommand();
            cmd1.CommandText = string.Format("insert into T1 values(1)");
            cmd1.ExecuteNonQuery();
        }

        using (var conn2 = new SqlConnection(connStrDb2))
        {
            conn2.Open();
            var cmd2 = conn2.CreateCommand();
            cmd2.CommandText = string.Format("insert into T2 values(2)");
            cmd2.ExecuteNonQuery();
        }

        scope.Complete();
    }
```

### <a name="sharded-database-applications"></a>Приложения, использующие сегментированные базы данных

Транзакции эластичных баз данных для базы данных SQL также поддерживают координацию распределенных транзакций, где используется метод OpenConnectionForKey клиентской библиотеки эластичной базы данных для открытия соединений для масштабируемого уровня данных. Рассмотрим случаи, когда необходимо обеспечить согласованность изменений транзакций для нескольких разных значений ключей сегментирования. Подключения к сегментам с разными значениями ключей сегментирования устанавливаются через посредника с использованием OpenConnectionForKey. В большинстве случаев устанавливаются подключения к разным сегментам. Поэтому для осуществления транзакций требуется выполнение распределенной транзакции.
Этот подход показан в следующем примере кода. В нем предполагается использование переменной shardmap для представления карты сегментов в клиентской библиотеке эластичной базы данных:

```csharp
    using (var scope = new TransactionScope())
    {
        using (var conn1 = shardmap.OpenConnectionForKey(tenantId1, credentialsStr))
        {
            conn1.Open();
            SqlCommand cmd1 = conn1.CreateCommand();
            cmd1.CommandText = string.Format("insert into T1 values(1)");
            cmd1.ExecuteNonQuery();
        }

        using (var conn2 = shardmap.OpenConnectionForKey(tenantId2, credentialsStr))
        {
            conn2.Open();
            var cmd2 = conn2.CreateCommand();
            cmd2.CommandText = string.Format("insert into T1 values(2)");
            cmd2.ExecuteNonQuery();
        }

        scope.Complete();
    }
```

## <a name="net-installation-for-azure-cloud-services"></a>Установка .NET для облачных служб Azure

Azure включает несколько предложений для размещения приложений .NET. Сравнение различных предложений приведено в статье [Сравнение службы приложений, облачных служб и виртуальных машин Azure](/azure/architecture/guide/technology-choices/compute-decision-tree). Если версия гостевой операционной системы предложения меньше .NET 4.6.1 (версия, необходимая для эластичных транзакций), необходимо обновить гостевую ОС до версии 4.6.1.

Для службы приложений Azure обновления до гостевой ОС в настоящее время не поддерживаются. В виртуальных машинах Azure необходимо просто выполнить вход и запустить установщик для последней версии .NET Framework. Для облачных служб Azure необходимо включить установку более новой версии .NET в задачи запуска данного развертывания. Основные понятия и рекомендованные шаги см. в статье [Установка .NET для роли облачной службы](../../cloud-services/cloud-services-dotnet-install-dotnet.md).  

Обратите внимание на то, что в процессе начальной загрузки в облачных службах Azure для установки .NET 4.6.1 может потребоваться больше объема временного хранилища, чем для установки .NET 4.6. Для успешной установки необходимо увеличить временное хранилище для облачной службы Azure в разделе LocalResources файла ServiceDefinition.csdef и в параметрах среды для задачи запуска, как показано в следующем примере:

```xml
    <LocalResources>
    ...
        <LocalStorage name="TEMP" sizeInMB="5000" cleanOnRoleRecycle="false" />
        <LocalStorage name="TMP" sizeInMB="5000" cleanOnRoleRecycle="false" />
    </LocalResources>
    <Startup>
        <Task commandLine="install.cmd" executionContext="elevated" taskType="simple">
            <Environment>
        ...
                <Variable name="TEMP">
                    <RoleInstanceValue xpath="/RoleEnvironment/CurrentInstance/LocalResources/LocalResource[@name='TEMP']/@path" />
                </Variable>
                <Variable name="TMP">
                    <RoleInstanceValue xpath="/RoleEnvironment/CurrentInstance/LocalResources/LocalResource[@name='TMP']/@path" />
                </Variable>
            </Environment>
        </Task>
    </Startup>
```

## <a name="transactions-across-multiple-servers"></a>Транзакции между несколькими серверами

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Эти командлеты см. в разделе [AzureRM. SQL](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле AZ и в модулях AzureRm существенно идентичны.

Транзакции эластичной базы данных поддерживаются на разных серверах в базе данных SQL Azure. Если транзакции пересекают границы сервера, участвующие серверы сначала должны быть указаны в связи взаимной связи. После установления отношения взаимодействия любая база данных на любом из двух серверов может участвовать в эластичных транзакциях с базами данных другого сервера. При наличии транзакций, охватывающих более двух серверов, для любой пары серверов необходимо установить связь связи.

Используйте следующие командлеты PowerShell для управления отношениями взаимодействия между серверами для транзакций эластичной базы данных:

* **New-азсклсерверкоммуникатионлинк**: Используйте этот командлет для создания нового отношения взаимодействия между двумя серверами в базе данных SQL Azure. Связь является симметричной. Это означает, что оба сервера могут инициировать транзакции с другим сервером.
* **Get-азсклсерверкоммуникатионлинк**: Используйте этот командлет для получения существующих отношений связи и их свойств.
* **Remove-азсклсерверкоммуникатионлинк**: Используйте этот командлет для удаления существующего отношения связи.

## <a name="monitoring-transaction-status"></a>Мониторинг состояния транзакций

Используйте динамические административные представления (DMV) в базе данных SQL для отслеживания состояния и хода выполнения текущих транзакций эластичной базы данных. Все динамические административные представления, связанные с транзакциями, относятся к распределенным транзакциям в базе данных SQL. Соответствующий список динамических административных представлений можно найти здесь: [Динамические административные представления и функции, связанные с транзакциями (Transact-SQL)](https://msdn.microsoft.com/library/ms178621.aspx).

Особенно полезны следующие динамические административные представления.

* **sys.dm\_tran\_active\_transactions** — позволяет просматривать список активных транзакций и их состояние. В столбце UOW (единица работы) можно просмотреть различные дочерние транзакции, которые относятся к одной распределенной транзакции. У всех транзакций в рамках одной распределенной транзакции одинаковое значение UOW. Дополнительные сведения см. в [документации по динамическим административным представлениям](https://msdn.microsoft.com/library/ms174302.aspx).
* **sys.dm\_tran\_database\_transactions** — здесь можно просматривать дополнительные сведения о транзакциях, включая расположение транзакции в журнале. Дополнительные сведения см. в [документации по динамическим административным представлениям](https://msdn.microsoft.com/library/ms186957.aspx).
* **sys.dm\_tran\_locks** — в этом представлении указываются сведения о текущих блокировках транзакций. Дополнительные сведения см. в [документации по динамическим административным представлениям](https://msdn.microsoft.com/library/ms190345.aspx).

## <a name="limitations"></a>Ограничения

В настоящее время к транзакциям эластичных баз данных в базе данных SQL применяются следующие ограничения:

* Поддерживаются только транзакции в базах данных SQL. Другие поставщики ресурсов и базы данных [XA](https://en.wikipedia.org/wiki/X/Open_XA) , расположенные за пределами базы данных SQL, не могут участвовать в транзакциях эластичной базы данных. Это означает, что транзакции эластичной базы данных не могут быть перенесены в локальные SQL Server и базу данных SQL Azure. Чтобы осуществлять распределенные транзакции локально, нужно использовать MSDTC.
* Поддерживаются только транзакции, которые осуществляются с помощью приложения .NET и которые координирует клиент. Сейчас выполнение запросов T-SQL на серверах (например, BEGIN DISTRIBUTED TRANSACTION) не поддерживается, но в будущем мы планируем добавить эту возможность.
* Транзакции в службах WCF не поддерживаются. Например, если у вас есть метод службы WCF, выполняющий транзакцию, включение вызова в область транзакции завершится ошибкой с исключением [System.ServiceModel.ProtocolException](https://msdn.microsoft.com/library/system.servicemodel.protocolexception).

## <a name="next-steps"></a>Дальнейшие шаги

Для получения вопросов обратитесь к нам на [странице Microsoft Q&A вопрос для базы данных SQL](https://docs.microsoft.com/answers/topics/azure-sql-database.html). Для запросов функций добавьте их на [Форум обратной связи базы данных SQL](https://feedback.azure.com/forums/217321-sql-database/).

<!--Image references-->
[1]: ./media/elastic-transactions-overview/distributed-transactions.png
 