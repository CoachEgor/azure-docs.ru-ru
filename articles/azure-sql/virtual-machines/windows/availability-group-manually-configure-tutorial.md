---
title: Учебник. Настройка группы доступности SQL Server Always On
description: В этом руководстве показано, как создать группу доступности AlwaysOn SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.assetid: 08a00342-fee2-4afe-8824-0db1ed4b8fca
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 08/30/2018
ms.author: mathoma
ms.custom: seo-lt-2019
ms.openlocfilehash: 22240c61b2341999528dcb477308990133042fa0
ms.sourcegitcommit: dccb85aed33d9251048024faf7ef23c94d695145
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87286858"
---
# <a name="tutorial-configure-a-sql-server-availability-group-on-azure-virtual-machines-manually"></a>Руководство. Настройка группы доступности SQL Server на виртуальных машинах Azure вручную

[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этом руководстве показано, как создать группу доступности AlwaysOn SQL Server на виртуальных машинах Azure. Полная версия руководства позволяет создать группу доступности с репликой базы данных на двух серверах SQL Server.

**Оценка времени**. Потребуется около 30 минут (при условии что предварительные требования уже выполнены).

На схеме ниже показаны шаги, которые описываются в этом руководстве.

![Группа доступности](./media/availability-group-manually-configure-tutorial/00-EndstateSampleNoELB.png)

## <a name="prerequisites"></a>Предварительные требования

К данному руководству можно переходить, если у вас имеются базовое представление о группах доступности AlwaysOn SQL Server. Если вы хотите узнать больше, ознакомьтесь с разделом [Группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/ff877884.aspx).

В следующей таблице перечислены предварительные условия, которые необходимо выполнить перед изучением данного руководства.

| Требование |Описание |
|----- |----- |----- |
|![](./media/availability-group-manually-configure-tutorial/square.png)**Два экземпляра** в квадратных SQL Server    | В группе доступности Azure. <br/> В отдельном домене. <br/> С установленным компонентом отказоустойчивой кластеризации. |
|![Квадратный ](./media/availability-group-manually-configure-tutorial/square.png) **Windows Server**    | Файловый ресурс для свидетеля кластера. |  
|![Квадратный ](./media/availability-group-manually-configure-tutorial/square.png) **SQL Server учетная запись службы**    | Доменная учетная запись |
|![Квадратный ](./media/availability-group-manually-configure-tutorial/square.png) **Агент SQL Server учетная запись службы**    | Доменная учетная запись |  
|![Открыты квадратные ](./media/availability-group-manually-configure-tutorial/square.png) **порты брандмауэра**    | — SQL Server: **1433** для экземпляра по умолчанию. <br/> — Конечная точка зеркального отображения базы данных: **5022** или любой доступный порт. <br/> — Проверка работоспособности группы доступности подсистемы балансировки нагрузки для IP-адреса: **59999** или любой доступный порт. <br/> — Проверка работоспособности ядра кластера подсистемы балансировки нагрузки для IP-адреса: **58888** или любой доступный порт. |
|![Квадратный ](./media/availability-group-manually-configure-tutorial/square.png) **компонент добавления отказоустойчивой кластеризации**    | Этот компонент нужен на обоих экземплярах SQL Server |
|![Квадратная ](./media/availability-group-manually-configure-tutorial/square.png) **учетная запись домена установки**    | Локальный администратор на каждом сервере SQL Server. <br/> Участник фиксированной роли сервера SQL Server sysadmin для каждого экземпляра SQL Server.  |


Прежде чем приступить к этому руководству, необходимо [настроить необходимые компонентов для создания групп доступности AlwaysOn на виртуальных машинах Azure](availability-group-manually-configure-prerequisites-tutorial.md). Если эти предварительные условия уже выполнены, то можно перейти к [созданию кластера](#CreateCluster).

  >[!NOTE]
  > Многие шаги, приведенные в этом руководстве, теперь можно автоматизировать с помощью [Azure SQL VM CLI](availability-group-az-cli-configure.md) и [шаблонов быстрого запуска Azure](availability-group-quickstart-template-configure.md).


<!--**Procedure**: *This is the first "step". Make titles H2's and short and clear – H2's appear in the right pane on the web page and are important for navigation.*-->

<a name="CreateCluster"></a>

## <a name="create-the-cluster"></a>Создайте кластер.

Первым шагом после выполнения предварительных условий является создание отказоустойчивого кластера Windows Server, включающего в себя два сервера SQL Server и следящий сервер.

1. Используйте протокол удаленного рабочего стола (RDP) для подключения к первой SQL Server. Используйте учетную запись домена, которая является администратором на обоих серверах SQL Server и следящего сервера.

   >[!TIP]
   >Если вы следовали указаниям в [документе с предварительными требованиями](availability-group-manually-configure-prerequisites-tutorial.md), то уже создали учетную запись **CORP\Install**. Используйте ее.

2. На панели мониторинга **Диспетчер сервера** выберите **инструменты**и щелкните **Диспетчер отказоустойчивости кластеров**.
3. В левой области щелкните правой кнопкой мыши **Диспетчер отказоустойчивости кластеров**, а затем выберите **создать кластер**.

   ![Создать кластер](./media/availability-group-manually-configure-tutorial/40-createcluster.png)

4. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано в таблице ниже.

   | Страница | Настройки |
   | --- | --- |
   | Перед началом |По умолчанию |
   | Выбор серверов |Введите имя первого SQL Server в поле **введите имя сервера** и нажмите кнопку **Добавить**. |
   | Предупреждение проверки |Выберите **нет. для этого кластера не требуется поддержка Майкрософт, поэтому не нужно выполнять проверочные тесты. Когда я наберу кнопку Далее, продолжите создание кластера**. |
   | Точка доступа для администрирования кластера |Введите имя кластера, например **SQLAGCluster1**, в поле **Имя кластера**.|
   | Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с примечанием после этой таблицы. |

### <a name="set-the-windows-server-failover-cluster-ip-address"></a>Указание IP-адреса отказоустойчивого кластера Windows Server

  > [!NOTE]
  > В Windows Server 2019 кластер создает **имя распределенного сервера** вместо **сетевого имени кластера**. Если вы используете Windows Server 2019, пропустите все действия, которые ссылаются на имя ядра кластера в этом руководстве. Вы можете создать имя сети кластера с помощью [PowerShell](failover-cluster-instance-storage-spaces-direct-manually-configure.md#create-failover-cluster). Ознакомьтесь с блогом [Отказоустойчивый кластер: объекта сети кластера](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97) для получения дополнительных сведений. 

1. В **диспетчере отказоустойчивости кластеров** прокрутите вниз до раздела **Ресурсы ядра кластера** и разверните сведения о кластере. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Ресурс IP-адреса невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и виртуальной машине, то есть он повторяется.

2. Щелкните правой кнопкой мыши ресурс **IP-адреса** с ошибками и выберите пункт **свойства**.

   ![Свойства кластера](./media/availability-group-manually-configure-tutorial/42_IPProperties.png)

3. Выберите **Статический IP-адрес** и укажите доступный адрес из той же подсети, что и ваши виртуальные машины.

4. В разделе **ресурсы ядра кластера** щелкните правой кнопкой мыши имя кластера и выберите **перевести в режим**«в сети». Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера переходит в режим «в сети», он обновляет сервер контроллера домена с новой учетной записью компьютера Active Directory (AD). Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.

### <a name="add-the-other-sql-server-to-cluster"></a><a name="addNode"></a>Добавление в кластер другого сервера SQL Server

Добавьте в кластер другой сервер SQL Server.

1. В дереве браузера щелкните правой кнопкой мыши кластер и выберите команду **Добавить узел**.

    ![Добавление узла в кластер](./media/availability-group-manually-configure-tutorial/44-addnode.png)

1. В **мастере добавления узлов**нажмите кнопку **Далее**. На странице **Выбор серверов** добавьте второй сервер SQL Server. Введите имя сервера в поле **введите имя сервера** и нажмите кнопку **Добавить**. По завершении нажмите кнопку **Далее**.

1. На странице **предупреждение проверки** выберите **нет** (в рабочем сценарии необходимо выполнить проверочные тесты). Затем нажмите кнопку **Далее**.

8. Если вы используете дисковые пространства, то на странице **Подтверждение** снимите флажок **Добавление всех допустимых хранилищ в кластер**.

   ![Подтверждение добавления узла](./media/availability-group-manually-configure-tutorial/46-addnodeconfirmation.png)

   >[!WARNING]
   >Если вы используете дисковые пространства и не сняли флажок **Добавление всех допустимых хранилищ в кластер**, то Windows отключит виртуальные диски во время процесса кластеризации. В результате они не отображаются в диспетчере дисков или обозревателе, пока дисковые пространства не будут удалены из кластера и повторно присоединены с помощью PowerShell. Дисковые пространства группируют несколько дисков в пулы носителей. Дополнительные сведения см. в статье [Обзор дисковых пространств](https://technet.microsoft.com/library/hh831739).
   >

1. Выберите **Далее**.

1. Нажмите кнопку **Готово**.

   Диспетчер отказоустойчивости кластеров показывает, что в кластере появился новый узел. Он отображается в контейнере **Nodes**.

10. Выйдите из сеанса удаленного рабочего стола.

### <a name="add-a-cluster-quorum-file-share"></a>Добавление файлового ресурса кворума кластера

В этом примере кластер Windows использует файловый ресурс для создания кворума кластера. В этом руководстве используется кворум "Большинство узлов и общих файловых ресурсов". Дополнительные сведения см. в разделе [Общее представление о конфигурациях кворума в отказоустойчивом кластере](https://technet.microsoft.com/library/cc731739.aspx).

1. Подключитесь к рядовому серверу файлового ресурса-свидетеля с помощью сеанса удаленного рабочего стола.

1. На **Диспетчер сервера**выберите **инструменты**. Откройте **Управление компьютером**.

1. Выберите **Общие папки**.

1. Щелкните правой кнопкой мыши элемент **Общие папки**и выберите **создать общую папку...**.

   ![Новый общий ресурс](./media/availability-group-manually-configure-tutorial/48-newshare.png)

   Используйте **мастер создания общих ресурсов**, чтобы создать общий ресурс.

1. В поле **путь к папке**выберите **Обзор** и найдите или создайте путь к общей папке. Выберите **Далее**.

1. В окне **Имя, описание и параметры** проверьте имя и путь общего ресурса. Выберите **Далее**.

1. В окне **Разрешения для общей папки** выберите **Настройка разрешений доступа**. Выбрать **Настраиваемый...**.

1. На вкладку **Настройка разрешений**нажмите кнопку **Добавить...**.

1. Убедитесь, что у учетной записи, используемой для создания кластера, имеется полный доступ.

   ![Новый общий ресурс](./media/availability-group-manually-configure-tutorial/50-filesharepermissions.png)

1. Щелкните **ОК**.

1. В окне **разрешения общей папки**нажмите кнопку **Готово**. Выберите **Готово** еще раз.  

1. Выйдите с сервера.

### <a name="configure-the-cluster-quorum"></a>Настройка кворума кластера

Теперь настройте кворум кластера.

1. Подключитесь к первому узлу кластера с помощью сеанса удаленного рабочего стола.

1. В **Диспетчер отказоустойчивости кластеров**щелкните кластер правой кнопкой мыши, укажите пункт **Дополнительные действия**и выберите пункт **настроить параметры кворума кластера.**...

   ![Новый общий ресурс](./media/availability-group-manually-configure-tutorial/52-configurequorum.png)

1. В **мастере настройки кворума кластера**нажмите кнопку **Далее**.

1. В **параметре выбор конфигурации кворума**выберите **пункт выбрать следящий сервер кворума**и нажмите кнопку **Далее**.

1. На **Выбор следящего сервера кворума**выберите **настроить файловый ресурс-свидетель**.

   >[!TIP]
   >Windows Server 2016 поддерживает облако-свидетель. При выборе этого типа свидетеля файловый ресурс-свидетель не требуется. Дополнительные сведения см. в разделе [Развертывание облачного следящего сервера для отказоустойчивого кластера](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness). В этом руководстве используется файловый ресурс-свидетель, который поддерживается в предыдущих операционных системах.
   >

1. В поле **Настройка файлового ресурса-свидетеля** введите путь к созданному общему ресурсу. Выберите **Далее**.

1. Проверьте параметры в окне **Подтверждение**. Выберите **Далее**.

1. Нажмите кнопку **Готово**.

Теперь ресурсы ядра кластера настроены для использования файлового ресурса-свидетеля.

## <a name="enable-availability-groups"></a>Включение групп доступности

Далее следует включить функцию **групп доступности AlwaysOn**. Выполните эти шаги для обоих серверов SQL Server.

1. На **начальном экране** запустите **Диспетчер конфигурации SQL Server**.
2. В дереве браузера выберите **SQL Server службы**, щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.
3. Перейдите на вкладку **высокий уровень доступности AlwaysOn** , а затем выберите **включить группы доступности AlwaysOn**, как показано ниже.

    ![Включение групп доступности AlwaysOn](./media/availability-group-manually-configure-tutorial/54-enableAlwaysOn.png)

4. Нажмите кнопку **Применить**. Во всплывающем диалоговом окне нажмите кнопку **ОК** .

5. Перезапустите службу SQL Server.

Повторите эти действия на другом сервере SQL Server.

<!-----------------
## <a name="endpoint-firewall"></a>Open firewall for the database mirroring endpoint

Each instance of SQL Server that participates in an Availability Group requires a database mirroring endpoint. This endpoint is a TCP port for the instance of SQL Server that is used to synchronize the database replicas in the Availability Groups on that instance.

On both SQL Servers, open the firewall for the TCP port for the database mirroring endpoint.

1. On the first SQL Server **Start** screen, launch **Windows Firewall with Advanced Security**.
2. In the left pane, select **Inbound Rules**. On the right pane, select **New Rule**.
3. For **Rule Type**, choose **Port**.
1. For the port, specify TCP and choose an unused TCP port number. For example, type *5022* and select **Next**.

   >[!NOTE]
   >For this example, we're using TCP port 5022. You can use any available port.

5. In the **Action** page, keep **Allow the connection** selected and select **Next**.
6. In the **Profile** page, accept the default settings and select **Next**.
7. In the **Name** page, specify a rule name, such as **Default Instance Mirroring Endpoint** in the **Name** text box, then select **Finish**.

Repeat these steps on the second SQL Server.
-------------------------->

## <a name="create-a-database-on-the-first-sql-server"></a>Создание базы данных на первом сервере SQL Server

1. Запустите RDP-файл подключения к первому серверу SQL Server с доменной учетной записью, которая является участником фиксированной серверной роли sysadmin.
1. Откройте SQL Server Management Studio и подключитесь к первому серверу SQL Server.
7. В **обозревателе объектов**щелкните правой кнопкой мыши **базы данных** и выберите пункт **создать базу данных**.
8. В списке **имя базы данных**введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="create-a-backup-share"></a><a name="backupshare"></a>Создание общего ресурса для резервных копий

1. На первом SQL Server в **Диспетчер сервера**выберите **инструменты**. Откройте **Управление компьютером**.

1. Выберите **Общие папки**.

1. Щелкните правой кнопкой мыши элемент **Общие папки**и выберите **создать общую папку...**.

   ![Новый общий ресурс](./media/availability-group-manually-configure-tutorial/48-newshare.png)

   Используйте **мастер создания общих ресурсов**, чтобы создать общий ресурс.

1. В поле **путь к папке**выберите **Обзор** и найдите или создайте путь к общей папке резервного копирования базы данных. Выберите **Далее**.

1. В окне **Имя, описание и параметры** проверьте имя и путь общего ресурса. Выберите **Далее**.

1. В окне **Разрешения для общей папки** выберите **Настройка разрешений доступа**. Выбрать **Настраиваемый...**.

1. На вкладку **Настройка разрешений**нажмите кнопку **Добавить...**.

1. Убедитесь, что учетные записи службы SQL Server и агента службы SQL Server для обоих серверов имеют полный доступ.

   ![Новый общий ресурс](./media/availability-group-manually-configure-tutorial/68-backupsharepermission.png)

1. Щелкните **ОК**.

1. В окне **разрешения общей папки**нажмите кнопку **Готово**. Выберите **Готово** еще раз.  

### <a name="take-a-full-backup-of-the-database"></a>Создание полной резервной копии базы данных

Необходимо создать резервную копию новой базы данных, чтобы инициализировать цепочку журналов. Если не создать резервную копию новой базы данных, то ее невозможно будет добавить в группу доступности.

1. В **обозревателе объектов**щелкните правой кнопкой мыши базу данных, наведите указатель на пункт **задачи...**, выберите пункт **создать резервную копию**.

1. Нажмите кнопку **ОК** , чтобы создать полную резервную копию в расположении резервной копии по умолчанию.

## <a name="create-the-availability-group"></a>Создание группы доступности

Теперь все готово к настройке группы доступности. Для этого выполните следующее.

* Создайте базу данных на первом сервере SQL Server.
* Создание полной резервной копии и резервной копии журнала транзакций базы данных.
* Восстановите полные резервные копии журналов и на второй SQL Server с параметром **NORECOVERY** .
* Создайте группу доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и вторичными репликами для чтения.

### <a name="create-the-availability-group"></a>Создание группы доступности

1. Откройте сеанс удаленного рабочего стола для первого сервера SQL Server. В **обозревателе объектов** в среде SSMS щелкните правой кнопкой мыши **Высокая доступность AlwaysOn** и выберите **Мастер создания группы доступности**.

    ![Запуск мастера создания групп доступности](./media/availability-group-manually-configure-tutorial/56-newagwiz.png)

2. На странице **Введение** нажмите кнопку **Далее**. На странице **Указание имени группы доступности** введите имя группы доступности в поле **имя группы доступности**. Например, **AG1**. Выберите **Далее**.

    ![Мастер создания группы доступности, указание имени группы доступности](./media/availability-group-manually-configure-tutorial/58-newagname.png)

3. На странице **Выбор баз** данных выберите свою базу данных, а затем нажмите кнопку **Далее**.

   >[!NOTE]
   >Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.
   >

   ![Мастер создания группы доступности, выбор баз данных](./media/availability-group-manually-configure-tutorial/60-newagselectdatabase.png)

4. На странице **Указание реплик** выберите **Добавить реплику**.

   ![Мастер создания группы доступности, указание реплик](./media/availability-group-manually-configure-tutorial/62-newagaddreplica.png)

5. Появится диалоговое окно **Подключение к серверу** . Введите имя второго сервера в поле **Имя сервера**. Выберите **Подключиться**.

   На странице **Указание реплик** в списке **Реплики доступности** должен отобразиться второй сервер. Настройте реплики, как описано ниже.

   ![Мастер создания группы доступности, указание реплик (завершено)](./media/availability-group-manually-configure-tutorial/64-newagreplica.png)

6. Выберите **конечные точки** , чтобы увидеть конечную точку зеркального отображения базы данных для этой группы доступности. Используйте тот же порт, что и при настройке [правила брандмауэра для конечных точек зеркального отображения базы данных](availability-group-manually-configure-prerequisites-tutorial.md#endpoint-firewall).

    ![Мастер создания группы доступности, выбор начальной синхронизации данных](./media/availability-group-manually-configure-tutorial/66-endpoint.png)

8. На странице **Выбор начальной синхронизации данных** выберите **Полная** и укажите сетевую папку. Это должен быть [созданный вами общий ресурс для резервных копий](#backupshare). В этом примере ** \\ \\<сначала SQL Server \> \Backup \\ **. Выберите **Далее**.

   >[!NOTE]
   >При полной синхронизации полная резервная копия базы данных создается на первом экземпляре SQL Server и восстанавливается на втором экземпляре. Полная синхронизация не рекомендуется для больших баз данных, так как может занимать много времени. Это время можно сократить, вручную создав резервную копию базы данных и восстановив ее с параметром `NO RECOVERY`. Если база данных уже была восстановлена с параметром `NO RECOVERY` на втором сервере SQL Server перед настройкой группы доступности, выберите переключатель **Только присоединение**. Если вы хотите создать резервную копию после настройки группы доступности, выберите переключатель **Пропустить начальную синхронизацию данных**.
   >

   ![Мастер создания группы доступности, выбор начальной синхронизации данных](./media/availability-group-manually-configure-tutorial/70-datasynchronization.png)

9. На странице **Проверка** нажмите кнопку **Далее**. Эта страница должна выглядеть, как на рисунке ниже.

    ![Мастер создания группы доступности, проверка](./media/availability-group-manually-configure-tutorial/72-validation.png)

    >[!NOTE]
    >Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Это предупреждение можно игнорировать, так как на виртуальных машинах Azure создать прослушиватель можно и после создания Azure Load Balancer.

10. На странице **Сводка** нажмите кнопку **Готово**, а затем подождите, пока мастер настроит новую группу доступности. На странице **выполнение** можно выбрать **Дополнительные сведения** для просмотра подробной информации о ходе выполнения. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться в том, что группа доступности успешно создана.

     ![Мастер создания группы доступности, результаты](./media/availability-group-manually-configure-tutorial/74-results.png)

11. Нажмите кнопку **Закрыть**, чтобы выйти из мастера.

### <a name="check-the-availability-group"></a>Проверка группы доступности

1. В **обозревателе объектов**разверните узел **Высокая доступность AlwaysOn**, а затем узел **группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните правой кнопкой мыши группу доступности и выберите пункт **отобразить панель мониторинга**.

   ![Отображение панели мониторинга группы доступности](./media/availability-group-manually-configure-tutorial/76-showdashboard.png)

   **Панель мониторинга AlwaysOn** должна выглядеть примерно так, как показано на снимке экрана ниже.

   ![Панель мониторинга группы доступности](./media/availability-group-manually-configure-tutorial/78-agdashboard.png)

   Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.

2. В **Диспетчер отказоустойчивости кластеров**выберите свой кластер. Выберите **Роли**. Имя группы доступности, которое вы использовали, представляет собой роль в кластере. У этой группы доступности нет IP-адреса для клиентских подключений, так как вы не настроили прослушиватель. Вы настроите прослушиватель после создания Azure Load Balancer.

   ![Группа доступности в диспетчер отказоустойчивости кластеров](./media/availability-group-manually-configure-tutorial/80-clustermanager.png)

   > [!WARNING]
   > Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказов следует выполнять через **панель мониторинга AlwaysOn** в SSMS. Дополнительные сведения см. в статье [Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/ff929171.aspx).
    >

На этом этапе имеется группа доступности с репликами в двух экземплярах SQL Server. Группу доступности можно перемещать между экземплярами. Пока что подключиться к группе доступности невозможно, так как отсутствует прослушиватель. В виртуальных машинах Azure для прослушивателя требуется подсистема балансировки нагрузки. Следующий шаг — создание подсистемы балансировки нагрузки в Azure.

<a name="configure-internal-load-balancer"></a>

## <a name="create-an-azure-load-balancer"></a>Создание Azure Load Balancer

Для группы доступности SQL Server на виртуальных машинах Azure необходима подсистема балансировки нагрузки. Подсистема балансировки нагрузки хранит IP-адреса для прослушивателей группы доступности и отказоустойчивого кластера Windows Server. В этом разделе кратко описывается, как создать подсистему балансировки нагрузки на портале Azure.

Балансировщик нагрузки в Azure может быть либо Load Balancer (цен. категория "Стандартный"), либо базовым Load Balancer. Load Balancer уровня "Стандартный" имеет больше возможностей, чем Load Balancer уровня "Базовый". Для группы доступности Load Balancer уровня "Базовый" является обязательным, если используется зона доступности (вместо набора доступности). Дополнительные сведения о различиях между подсистемами балансировки нагрузки см. в разделе [Сравнение SKU Load Balancer](../../../load-balancer/skus.md).

1. В портал Azure перейдите к группе ресурсов, в которой находятся серверы SQL Server, и выберите **+ Добавить**.
1. Найдите **балансировщик нагрузки**. Выберите подсистему балансировки нагрузки, опубликованную корпорацией Майкрософт.

   ![Группа доступности в диспетчер отказоустойчивости кластеров](./media/availability-group-manually-configure-tutorial/82-azureloadbalancer.png)

1. Нажмите кнопку **создания**.
1. Настройте следующие параметры для балансировщика нагрузки:

   | Параметр | Поле |
   | --- | --- |
   | **Имя** |Используйте для подсистемы балансировки нагрузки текстовое имя, например **sqlLB**. |
   | **Тип** |Внутренние |
   | **Виртуальная сеть** |Используйте имя виртуальной сети Azure. |
   | **Подсеть** |Используйте имя подсети, в которой находится виртуальная машина.  |
   | **Назначение IP-адресов** |Статические |
   | **IP-адрес** |Используйте доступный адрес из подсети. Этот адрес используется для прослушивателя группы доступности. Обратите внимание, что он отличается от IP-адреса кластера.  |
   | **Подписка** |Используйте подписку, в которой находится виртуальная машина. |
   | **Расположение** |Используйте расположение, в котором находится виртуальная машина. |

   Колонка портала Azure должна выглядеть следующим образом.

   ![Создание балансировщика нагрузки](./media/availability-group-manually-configure-tutorial/84-createloadbalancer.png)

1. Выберите **создать**, чтобы создать подсистему балансировки нагрузки.

Для настройки подсистемы балансировки нагрузки необходимо создать внутренний пул, пробу и задать правила балансировки нагрузки. Это можно сделать на портале Azure.

### <a name="add-a-backend-pool-for-the-availability-group-listener"></a>Добавление внутреннего пула для прослушивателя группы доступности

1. На портале Azure перейдите к своей группе доступности. Может потребоваться обновить представление, чтобы отобразить только что созданную подсистему балансировки нагрузки.

   ![Поиск подсистемы балансировки нагрузки в группе ресурсов](./media/availability-group-manually-configure-tutorial/86-findloadbalancer.png)

1. Выберите подсистему балансировки нагрузки, выберите **серверные пулы**и нажмите кнопку **+ Добавить**.

1. Введите имя для серверного пула.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **Целевые IP-конфигурации сети** установите флажок **Виртуальная машина** и выберите обе виртуальные машины, на которых будут размещаться реплики группы доступности. Не следует добавлять сервер файлового ресурса-свидетеля.

   >[!NOTE]
   >Если не указать обе виртуальные машины, будет установлено подключение только к первичной реплике.

1. Нажмите кнопку **ОК**, чтобы создать серверный пул.

### <a name="set-the-probe"></a>Настройка пробы

1. Выберите подсистему балансировки нагрузки, выберите **зонды работоспособности**и нажмите кнопку **+ Добавить**.

1. Настройте пробу работоспособности прослушивателя, как показано ниже.

   | Параметр | Описание: | Пример
   | --- | --- |---
   | **имя**; | текст | SQLAlwaysOnEndPointProbe |
   | **протокол**; | Выберите протокол TCP. | TCP |
   | **порт**. | Любой неиспользуемый порт. | 59999 |
   | **Интервал**  | Промежуток времени между повторными попытками выполнения пробы в секундах. |5 |
   | **Пороговое значение сбоя** | Число последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.  | 2 |

1. Нажмите кнопку **ОК** , чтобы задать пробу работоспособности.

### <a name="set-the-load-balancing-rules"></a>Настройка правил балансировки нагрузки

1. Выберите подсистему балансировки нагрузки, выберите **правила балансировки нагрузки**и нажмите кнопку **+ Добавить**.

1. Настройте правила балансировки нагрузки прослушивателя, как показано ниже.

   | Параметр | Описание: | Пример
   | --- | --- |---
   | **имя**; | текст | SQLAlwaysOnEndPointListener |
   | **Frontend IP address** (Интерфейсный IP-адрес) | Выберите адрес. |Используйте адрес, который был создан при создании подсистемы балансировки нагрузки. |
   | **протокол**; | Выберите протокол TCP. |TCP |
   | **порт**. | Создайте порт для прослушивателя группы доступности | 1433 |
   | **Серверный порт** | Это поле не используется, если задан плавающий IP-адрес для прямого ответа от сервера. | 1433 |
   | **Проба** |Имя, указанное для пробы. | SQLAlwaysOnEndPointProbe |
   | **Сохранение сеанса** | Раскрывающийся список. | **None** |
   | **Время ожидания простоя** | Интервал (в минутах), в течение которого подключение TCP остается открытым. | 4 |
   | **Плавающий IP-адрес (прямой ответ от сервера)** | |Активировано |

   > [!WARNING]
   > Параметры прямого ответа от сервера задаются во время создания. Их невозможно изменить.
   >

1. Нажмите кнопку **ОК** , чтобы задать правила балансировки нагрузки прослушивателя.

### <a name="add-the-cluster-core-ip-address-for-the-windows-server-failover-cluster-wsfc"></a>Добавьте IP-адрес ядра кластера для отказоустойчивого кластера Windows Server (WSFC).

IP-адрес WSFC также должен находиться в подсистеме балансировки нагрузки.

1. В портал Azure перейдите к той же подсистеме балансировки нагрузки Azure. Выберите **интерфейсная IP-конфигурация** и нажмите кнопку **+ Добавить**. Используйте IP-адрес, настроенный для WSFC в ресурсах ядра кластера. Укажите статический IP-адрес.

1. В подсистеме балансировки нагрузки выберите **зонды работоспособности**и нажмите кнопку **+ Добавить**.

1. Настройте пробу работоспособности IP-адреса ядра кластера WSFC следующим образом.

   | Параметр | Описание: | Пример
   | --- | --- |---
   | **имя**; | текст | WSFCEndPointProbe |
   | **протокол**; | Выберите протокол TCP. | TCP |
   | **порт**. | Любой неиспользуемый порт. | 58888 |
   | **Интервал**  | Промежуток времени между повторными попытками выполнения пробы в секундах. |5 |
   | **Пороговое значение сбоя** | Число последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.  | 2 |

1. Нажмите кнопку **ОК** , чтобы задать пробу работоспособности.

1. Настройте правила балансировки нагрузки. Выберите **правила балансировки нагрузки**и нажмите кнопку **+ Добавить**.

1. Задайте правила балансировки нагрузки IP-адресов ядра кластера следующим образом.

   | Параметр | Описание: | Пример
   | --- | --- |---
   | **имя**; | текст | WSFCEndPoint |
   | **Frontend IP address** (Интерфейсный IP-адрес) | Выберите адрес. |Используйте адрес, который был создан при настройке IP-адреса WSFC. Он отличается от IP-адреса прослушивателя |
   | **протокол**; | Выберите протокол TCP. |TCP |
   | **порт**. | Используйте порт для IP-адреса кластера. Это доступный порт, который не используется для порта пробы прослушивателя. | 58888 |
   | **Серверный порт** | Это поле не используется, если задан плавающий IP-адрес для прямого ответа от сервера. | 58888 |
   | **Проба** |Имя, указанное для пробы. | WSFCEndPointProbe |
   | **Сохранение сеанса** | Раскрывающийся список. | **None** |
   | **Время ожидания простоя** | Интервал (в минутах), в течение которого подключение TCP остается открытым. | 4 |
   | **Плавающий IP-адрес (прямой ответ от сервера)** | |Активировано |

   > [!WARNING]
   > Параметры прямого ответа от сервера задаются во время создания. Их невозможно изменить.
   >

1. Нажмите кнопку **ОК** , чтобы задать правила балансировки нагрузки.

## <a name="configure-the-listener"></a><a name="configure-listener"></a>Настройка прослушивателя

Далее нужно настроить прослушиватель группы доступности в отказоустойчивом кластере.

> [!NOTE]
> В этом руководстве показано, как создать один прослушиватель с одним IP-адресом ILB. Чтобы создать один или несколько прослушивателей с использованием одного или нескольких IP-адресов, ознакомьтесь со статьей [Configure one or more Always On Availability Group Listeners - Resource Manager](availability-group-listener-powershell-configure.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Настройка одного или нескольких прослушивателей группы доступности AlwaysOn в модели Resource Manager).
>

[!INCLUDE [ag-listener-configure](../../../../includes/virtual-machines-ag-listener-configure.md)]

## <a name="set-listener-port"></a>Настройка порта прослушивателя

Настройте порт прослушивателя в SQL Server Management Studio.

1. Запустите SQL Server Management Studio и подключитесь к основной реплике.

1. Перейдите в раздел **Высокий уровень доступности AlwaysOn** > **Группы доступности** > **Прослушиватели группы доступности**.

1. Теперь вы увидите имя прослушивателя, созданного в диспетчере отказоустойчивости кластеров. Щелкните правой кнопкой мыши имя прослушивателя и выберите пункт **Свойства**.

1. В поле **Порт** укажите номер порта для прослушивателя группы доступности. значение по умолчанию — 1433. Щелкните **ОК**.

Теперь у вас есть группа доступности SQL Server на виртуальных машинах Azure в режиме Resource Manager.

## <a name="test-connection-to-listener"></a>Проверка подключения к прослушивателю

Чтобы проверить подключение:

1. Используйте RDP для подключения к SQL Server, который находится в той же виртуальной сети, но не является владельцем реплики. Можно использовать другой сервер SQL Server в кластере.

1. Проверьте подключение с помощью служебной программы **sqlcmd** . Например, в следующем сценарии **sqlcmd** подключается к основной реплике через прослушиватель с использованием аутентификации Windows.

   ```cmd
   sqlcmd -S <listenerName> -E
   ```

   Если прослушиватель использует порт, отличный от порта по умолчанию (1433), укажите порт в строке подключения. Например, следующая `sqlcmd` команда подключается к прослушивателю через порт 1435:

   ```cmd
   sqlcmd -S <listenerName>,1435 -E
   ```

sqlcmd автоматически подключается к любому экземпляру SQL Server, на котором размещена основная реплика.

> [!TIP]
> Указанный порт должен быть открыт в брандмауэре обоих серверов SQL Server. Для обоих серверов требуется правило для входящего трафика используемого TCP-порта. Дополнительные сведения см. в статье [Добавление и изменение правила брандмауэра](https://technet.microsoft.com/library/cc753558.aspx).
>

## <a name="next-steps"></a>Дальнейшие действия

- [Добавление в подсистему балансировки нагрузки IP-адреса для второй группы доступности](availability-group-listener-powershell-configure.md#Add-IP).
