---
title: Использование SQL Server FCI с общими папками уровня "Премиум" — Виртуальные машины Azure
description: В этой статье объясняется, как создать экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure с использованием общих папок уровня "Премиум".
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.assetid: 9fc761b1-21ad-4d79-bebc-a2f094ec214d
ms.service: virtual-machines-sql
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 10/09/2019
ms.author: mathoma
ms.openlocfilehash: 60526dbeb3e221e6a2e4c6b900ff3a109d4cdf8f
ms.sourcegitcommit: 053e5e7103ab666454faf26ed51b0dfcd7661996
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2020
ms.locfileid: "84032425"
---
# <a name="configure-a-sql-server-failover-cluster-instance-with-premium-file-share-on-azure-virtual-machines"></a>Настройка экземпляра отказоустойчивого кластера SQL Server на виртуальных машинах Azure с использованием общий папки категории "Премиум"
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье объясняется, как создать экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure с использованием [общих папок уровня "Премиум"](../../../storage/files/storage-how-to-create-premium-fileshare.md).

Общие папки уровня "Премиум" — это общие папки с резервными копиями на SSD и малой задержкой, которые полностью совместимы с экземплярами отказоустойчивых кластеров для SQL Server 2012 и боле поздних версий на базе Windows Server 2012 и более поздних версий. Общие папки уровня "Премиум" отличаются повышенной гибкостью: вы может менять их размеры и масштабировать их без простоя.


## <a name="before-you-begin"></a>Перед началом

Прежде чем начать, необходимо знать несколько моментов.

Вам необходимо иметь представление о следующих технологиях:

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);
- [экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server).

Учтите, что для отказоустойчивого кластера виртуальных машин IaaS Azure мы советуем использовать один сетевой адаптер на сервер (узел кластера) и одну подсеть. Сеть Azure обладает физической избыточностью, что делает ненужными дополнительные сетевые адаптеры и подсети в кластере гостевых виртуальных машин IaaS Azure. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в отказоустойчивых кластерах виртуальных машин Azure IaaS.

Вам также необходимо иметь общее представление о следующих технологиях:

- [общие папки уровня "Премиум" Azure](../../../storage/files/storage-how-to-create-premium-fileshare.md);
- [группы ресурсов Azure](../../../azure-resource-manager/management/manage-resource-groups-portal.md).

> [!IMPORTANT]
> На данный момент экземпляры отказоустойчивого кластера SQL Server на виртуальных машинах Azure поддерживаются только в [режиме облегченного управления](sql-vm-resource-provider-register.md#management-modes) [расширения агента IaaS SQL Server](sql-server-iaas-agent-extension-automate-management.md). Чтобы перейти с полного режима расширения на упрощенный, удалите ресурс **виртуальной машины SQL** для соответствующих виртуальных машин, а затем зарегистрируйте их с помощью поставщика ресурсов виртуальной машины SQL в упрощенном режиме. При удалении ресурса **виртуальной машины SQL** с помощью портала Azure **снимите флажок рядом с соответствующей виртуальной машиной**. Полное расширение поддерживает такие компоненты, как автоматическое резервное копирование, установка исправлений и расширенное управление порталом. Эти функции не будут работать для виртуальных машин SQL после переустановки агента в упрощенном режиме управления.

Характеристики скорости ввода-вывода и пропускной способности общих папок уровня "Премиум" отвечают потребностям множества рабочих нагрузок. Для нагрузок с интенсивным вводом-выводом рекомендуется использовать [экземпляры отказоустойчивых кластеров SQL Server с Локальными дисковыми пространствами](failover-cluster-instance-storage-spaces-direct-manually-configure.md) на базе управляемых дисков уровня "Премиум" или "Ультра".  

Прежде чем начинать развертывание или миграцию, проанализируйте нагрузку на подсистему ввода-вывода в своей среде и убедитесь, что характеристик общих папок уровня "Премиум" будет достаточно. Уточнить общую скорость ввода вывода (количество операций обмена данных с диском в секунду) и пропускную способность (объем операций обмена данными с диском в секунду), необходимые для работы с данными SQL Server и файлами временной базы данных, можно с помощью Монитора производительности Windows.

Во многих сценариях нагрузка на подсистему ввода-вывода возрастает пиковым образом, поэтому рекомендуется проверять характеристики в периоды интенсивного использования, чтобы выяснить как максимальную, так и среднюю скорость. Скорость ввода-вывода при использовании общих папок уровня "Премиум" зависит от размера папки. Кроме того, общие папки уровня "Премиум" поддерживают возможность на период до часа увеличить скорость ввода-вывода втрое относительно базовых показателей.

Дополнительные сведения о характеристиках общих папок уровня "Премиум" см. в статье [Уровни производительности файлового ресурса](https://docs.microsoft.com/azure/storage/files/storage-files-planning#storage-tiers).

### <a name="licensing-and-pricing"></a>Лицензирование и цены

На виртуальных машинах Azure можно лицензировать SQL Server, используя образы виртуальных машин с оплатой по мере использования (PAYG) или с использованием собственной лицензии (BYOL). Тип выбранного образа влияет на процесс выставления счетов.

При лицензировании с оплатой по мере использования для экземпляра отказоустойчивого кластера (FCI) SQL Server на виртуальных машинах Azure оплачиваются все узлы, в том числе пассивные. Дополнительные сведения см. на странице [Цены на виртуальные машины SQL Server Enterprise](https://azure.microsoft.com/pricing/details/virtual-machines/sql-server-enterprise/).

Если у вас есть Соглашение Enterprise с применением программы Software Assurance, вы можете использовать по одному бесплатному пассивному узлу отказоустойчивого кластера на каждый активный узел. Чтобы получить такую возможность в Azure, используйте образы виртуальных машин BYOL, а затем примените одну и ту же лицензию как к активным, так и к пассивным узлам FCI. Дополнительные сведения см. в статье о [Соглашении Enterprise](https://www.microsoft.com/Licensing/licensing-programs/enterprise.aspx).

Чтобы сравнить возможности лицензирования с оплатой по мере использования и BYOL для SQL Server на виртуальных машинах Azure, см. статью о [начале работы с виртуальными машинами SQL](sql-server-on-azure-vm-iaas-what-is-overview.md#get-started-with-sql-vms).

Полные сведения о лицензировании SQL Server см. [на странице с ценами](https://www.microsoft.com/sql-server/sql-server-2017-pricing).

### <a name="filestream"></a>Файловый поток

Функция файлового потока для отказоустойчивых кластеров с общими папками уровня "Премиум" не поддерживается. Для использования файлового потока разверните кластер на базе [Локальных дисковых пространств](failover-cluster-instance-storage-spaces-direct-manually-configure.md).

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, необходимо следующее:

- подписка Microsoft Azure;
- домен Windows на виртуальных машинах Azure;
- учетная запись пользователя домена с разрешениями на создание объектов как на виртуальных машинах Azure, так и в Active Directory;
- учетная запись пользователя домена для запуска службы SQL Server, с помощью можно будет войти на виртуальную машину при подключении общей папки;  
- виртуальная сеть и подсеть Azure с достаточным пространством IP-адресов для следующих компонентов:
   - две виртуальные машины;
   - IP-адрес отказоустойчивого кластера;
   - IP-адрес для каждого экземпляра отказоустойчивого кластера;
- служба DNS, настроенная в сети Azure, которая указывает на контроллеры домена;
- [общая папка уровня "Премиум"](../../../storage/files/storage-how-to-create-premium-fileshare.md), которая будет использоваться в качестве кластеризованного диска, с учетом квоты хранилища для вашей базы с файлами данных.
- Если у вас Windows Server 2012 R2 или более ранняя версия системы, вам потребуется еще одна общая папка в качестве файлового ресурса-свидетеля, поскольку облака-свидетели поддерживаются только начиная с версии Windows 2016. Вы можете воспользоваться другой общей папкой Azure или общей папкой на отдельной виртуальной машине. Если вы используете еще одну общую папку Azure, ее можно подключить с помощью той же процедуры, что и общую папку уровня "Премиум", которая служит кластеризованным диском. 

После выполнения этих предварительных требований можно приступить к созданию отказоустойчивого кластера. Сначала нужно создать виртуальные машины.

## <a name="step-1-create-the-virtual-machines"></a>Шаг 1. Создание виртуальных машин

1. Войдите на [портал Azure](https://portal.azure.com) со своей подпиской.

1. [Создайте группу доступности Azure](../../../virtual-machines/linux/tutorial-availability-sets.md).

   Группа доступности группирует виртуальные машины в доменах сбоя и доменах обновления. Она гарантирует, что на ваше приложение не повлияют единые точки отказа, такие как сетевой коммутатор или блок питания стойки серверов.

   Если вы не создали группу ресурсов для виртуальных машин, сделайте это во время создания группы доступности Azure. Если вы используете портал Azure для создания группы доступности, сделайте следующее:

   1. На портале Azure выберите **Создать ресурс**, чтобы открыть Azure Marketplace. Найдите **Группа доступности**.
   1. Выберите **Группа доступности**.
   1. Нажмите кнопку **создания**.
   1. В разделе **Создание группы доступности** укажите следующие значения:
      - **Name** (Имя). Имя группы доступности.
      - **Подписка**: Вашу подписку Azure.
      - **Группа ресурсов.** Если вы хотите использовать имеющуюся группу, щелкните **Выбрать существующую** и выберите группу из раскрывающегося списка. В противном случае выберите **Создать** и введите имя для группы.
      - **Расположение.** Задайте расположение, в котором вы планируете создать виртуальные машины.
      - **Домены сбоя**. Используйте значение по умолчанию (**3**).
      - **Домены обновления**. Используйте значение по умолчанию (**5**).
   1. Щелкните **Создать**, чтобы создать группу доступности.

1. Создайте виртуальные машины в группе доступности.

   Подготовьте две виртуальные машины SQL Server в группе доступности Azure. Инструкции см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](create-sql-vm-portal.md).

   Разместите обе виртуальные машины:

   - в той же группе ресурсов Azure, что и группа доступности;
   - в той же сети, что и контроллер домена;
   - в подсети с достаточным пространством IP-адресов для обеих виртуальных машин и всех экземпляров отказоустойчивого кластера, которые со временем могут использоваться в этом кластере;
   - в группе доступности Azure.

      >[!IMPORTANT]
      >После создания виртуальной машины установить или изменить группу доступности невозможно.

   Выберите образ из Azure Marketplace. Вы можете использовать образ Azure Marketplace, который включает Windows Server и SQL Server или просто Windows Server. Дополнительные сведения см. в статье [Приступая к работе с SQL Server в виртуальных машинах Azure](sql-server-on-azure-vm-iaas-what-is-overview.md).

   Официальные образы SQL Server в коллекции Azure содержат установленный экземпляр SQL Server, а также программное обеспечение для установки SQL Server и необходимый ключ.

   >[!IMPORTANT]
   > После создания виртуальной машины удалите предварительно установленный автономный экземпляр SQL Server. Вы будете использовать предварительно установленный носитель SQL Server для создания экземпляра отказоустойчивого кластера SQL Server после настройки отказоустойчивого кластера и общей папки уровня "Премиум" в качестве хранилища.

   Кроме того, можно использовать образы Azure Marketplace, которые содержат только операционную систему. Выберите образ **Windows Server 2016 Datacenter** и установите экземпляр отказоустойчивого кластера SQL Server после настройки отказоустойчивого кластера и общей папки уровня "Премиум" в качестве хранилища. Этот образ не содержит установочный носитель SQL Server. Разместите установочный носитель SQL Server в расположении, где его можно запускать для каждого сервера.

1. После создания виртуальных машин в Azure подключитесь к каждой виртуальной машине с помощью протокола удаленного рабочего стола.

   При первом подключении к виртуальной машине с помощью протокола удаленного рабочего стола вы получаете запрос, должен ли этот компьютер быть доступным в сети. Выберите **Да**.

1. Если вы используете один из образов виртуальных машин на основе SQL Server, удалите экземпляр SQL Server.

   1. В разделе **Программы и компоненты** правой кнопкой мыши щелкните **Microsoft SQL Server 201_ (64-разрядная версия)** и выберите **Удалить/Изменить**.
   1. Щелкните **Удалить**.
   1. Выберите экземпляр по умолчанию.
   1. Удалите все компоненты в разделе **Службы ядра СУБД**. Не удаляйте компоненты в разделе **Общие компоненты**. Вы должны увидеть примерно следующее:

        ![Выбор компонентов](./media/failover-cluster-instance-premium-file-share-manually-configure/03-remove-features.png)

   1. Щелкните **Далее**, а затем **Удалить**.

1. <span id="ports"> </span> Откройте порты брандмауэра.  

   На каждой виртуальной машине откройте следующие порты в брандмауэре Windows:

   | Назначение | TCP-порт | Примечания
   | ------ | ------ | ------
   | SQL Server | 1433 | Обычный порт для экземпляров SQL Server по умолчанию. Если используется образ из коллекции, этот порт будет автоматически открыт.
   | Проверка работоспособности | 59999 | Любой открытый TCP-порт. Позже настройте [проверку работоспособности](#probe) балансировщика нагрузки и кластер для использования этого порта.
   | Общая папка | 445 | Порт, используемый службой общих папок.

1. [Добавьте виртуальные машины в имеющийся домен](availability-group-manually-configure-prerequisites-tutorial.md#joinDomain).

После создания и настройки виртуальных машин можно настроить общую папку уровня "Премиум".

## <a name="step-2-mount-the-premium-file-share"></a>Шаг 2. Подключение общей папки уровня "Премиум"

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к учетной записи хранения.
1. В подразделе **Общие папки** раздела **Файловая служба** выберите общую папку уровня "Премиум", которую будете использовать в качестве хранилища SQL.
1. Выберите **Подключить**, чтобы открыть строку подключения общей папки.
1. Выберите нужную букву диска из раскрывающегося списка и скопируйте оба блока кода в Блокнот.


   :::image type="content" source="media/manually-configure-failover-cluster-instance-premium-file-share/premium-file-storage-commands.png" alt-text="Скопируйте обе команды PowerShell с портала подключения общей папки":::

1. С помощью RDP подключитесь к виртуальной машине SQL Server с учетной записью, которую ваш экземпляр отказоустойчивого сервера SQL Server будет использовать в качестве учетной записи службы.
1. Откройте административную консоль командной строки PowerShell.
1. Выполните команды, сохраненные ранее во время работы на портале.
1. Откройте файловую папку в Проводнике или из диалогового окна **Выполнить** (клавиша Windows + R). Укажите сетевой путь `\\storageaccountname.file.core.windows.net\filesharename`. Например `\\sqlvmstorageaccount.file.core.windows.net\sqlpremiumfileshare`.

1. Создайте хотя бы одну подпапку в подключенной общей папке, где будут размещаться файлы данных SQL.
1. Повторите эти действия для каждой виртуальной машины SQL Server, которая будет входить в состав кластера.

  > [!IMPORTANT]
  > - Для файлов резервной копии рекомендуется использовать отдельную папку, чтобы снизить нагрузку на подсистему ввода-вывода и использовать меньше места в общей папке с файлами данных и журналов. Для хранения резервных копий можно использовать общую папку как уровня "Премиум", так и уровня "Стандарт".
  > - Если у вас Windows 2012 R2 или более ранняя версия системы, с помощью той же процедуры подключите общую папку, которая станет файловым ресурсом-свидетелем. 

## <a name="step-3-configure-the-failover-cluster"></a>Шаг 3. Настройка отказоустойчивого кластера

Следующим шагом является настройка отказоустойчивого кластера. На этом шаге выполняются следующие действия:

1. Добавление компонента отказоустойчивой кластеризации Windows Server.
1. Проверка кластера.
1. Создание отказоустойчивого кластера.
1. Создание облака-свидетеля (для Windows Server 2016 и более поздних версий) или файлового ресурса-свидетеля (для Windows Server 2012 R2 и более ранних версий).


### <a name="add-windows-server-failover-clustering"></a>Настройка отказоустойчивой кластеризации Windows Server

1. Подключитесь к первой виртуальной машине с помощью протокола удаленного рабочего стола, используя учетную запись домена, которая является участником локальной группы администраторов, а также имеет разрешения на создание объектов в Active Directory. Используйте эту учетную запись для остальной части конфигурации.

1. [Добавьте компонент отказоустойчивой кластеризации для каждой виртуальной машины](availability-group-manually-configure-prerequisites-tutorial.md#add-failover-clustering-features-to-both-sql-server-vms).

   Чтобы установить отказоустойчивую кластеризацию из пользовательского интерфейса, сделайте следующее на обеих виртуальных машинах:
   1. В **диспетчере сервера** выберите **Управление**, а затем — **Добавить роли и компоненты**.
   1. В **мастере добавления ролей и компонентов** нажимайте кнопку **Далее**, пока не откроется раздел **Выбор компонентов**.
   1. В разделе **Выбор компонентов** выберите **Отказоустойчивая кластеризация**. Включите все необходимые компоненты и средства управления. Выберите **Добавить компоненты**.
   1. Чтобы установить компоненты, нажмите кнопку **Далее**, а затем — **Готово**.

   Чтобы установить отказоустойчивую кластеризацию с помощью PowerShell, запустите следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   $nodes = ("<node1>","<node2>")
   Invoke-Command  $nodes {Install-WindowsFeature Failover-Clustering -IncludeAllSubFeature -IncludeManagementTools}
   ```

### <a name="validate-the-cluster"></a>Проверка кластера

Проверьте кластер в пользовательском интерфейсе или с помощью PowerShell.

Чтобы проверить работу кластера с помощью пользовательского интерфейса, сделайте следующее на одной из виртуальных машин:

1. На панели **Диспетчер серверов** выберите **Инструменты** и нажмите **Диспетчер отказоустойчивости кластеров**.
1. В разделе **Диспетчер отказоустойчивости кластеров** выберите **Действие**, а затем выберите **Проверить конфигурацию**.
1. Выберите **Далее**.
1. На вкладке **Выбор серверов или кластера** введите имена обеих виртуальных машин.
1. На вкладке **Параметры тестирования** выберите **Выполнять только выбранные тесты**. Выберите **Далее**.
1. В разделе **Выбор тестов** выберите все тесты, кроме **Хранилище** и **Локальные дисковые пространства**, как показано ниже:

   :::image type="content" source="media/manually-configure-failover-cluster-instance-premium-file-share/cluster-validation.png" alt-text="Выбор проверочных тестов кластера":::

1. Выберите **Далее**.
1. В разделе **Подтверждение** нажмите **Далее**.

**Мастер проверки конфигурации** выполняет проверочные тесты.

Чтобы проверить кластер с помощью PowerShell, запустите следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   Test-Cluster –Node ("<node1>","<node2>") –Include "Inventory", "Network", "System Configuration"
   ```

После проверки кластера создайте отказоустойчивый кластер.

### <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера.

Для создания отказоустойчивого кластера требуется следующее.
- Имена виртуальных машин, которые становятся узлами кластера.
- Имя отказоустойчивого кластера.
- IP-адрес отказоустойчивого кластера. Вы можете использовать IP-адрес, который не используется в той же виртуальной сети и подсети Azure, где расположены узлы кластера.

#### <a name="windows-server-2012-through-windows-server-2016"></a>С Windows Server 2012 по Windows Server 2016

Следующий скрипт PowerShell создает отказоустойчивый кластер для Windows Server версий с 2012 по 2016. Обновите скрипт, введя имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage
```   

#### <a name="windows-server-2019"></a>Windows Server 2019

Следующий скрипт PowerShell создает отказоустойчивый кластер для Windows Server 2019. Дополнительные сведения см. в статье [Отказоустойчивый кластер: сетевой объект кластера](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97). Обновите скрипт, введя имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage -ManagementPointNetworkType Singleton 
```


### <a name="create-a-cloud-witness-win-2016-"></a>Создание облака-свидетеля (Windows 2016 и более поздние версии)

Если у вас Windows Server 2016 или более поздняя версия системы, вам потребуется создать облако-свидетеля. Облако-свидетель является новым типом свидетеля кворума кластера, хранящегося в хранилище больших двоичных объектов Azure. Это устраняет необходимость в отдельной виртуальной машине, используемой для размещения файлового ресурса-свидетеля, или отдельной общей папке.

1. [Создайте облако-свидетель для отказоустойчивого кластера](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness).

1. Создайте контейнер больших двоичных объектов.

1. Сохраните ключи доступа и URL-адрес контейнера.

### <a name="configure-quorum"></a>Настройка кворума 

В Windows Server 2016 и более поздних версиях настройте кластер для использования созданного вами облака-свидетеля. Выполните процедуру из раздела о [настройке свидетеля кворума в пользовательском интерфейсе](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness#to-configure-cloud-witness-as-a-quorum-witness).

В Windows Server 2012 R2 и более ранних версиях выполните процедуру, описанную в статье о [настройке свидетеля кворума в пользовательском интерфейсе](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness#to-configure-cloud-witness-as-a-quorum-witness), однако на станице **выбора свидетеля кворума** выберите вариант **Настроить файловый ресурс-свидетель**. Укажите общую папку, которую создали в качестве файлового ресурса-свидетеля (она может располагаться на отдельной виртуальной машине или подключаться из Azure). 


## <a name="step-4-test-cluster-failover"></a>Шаг 4. Тестирование отказоустойчивого кластера

Протестируйте отказоустойчивость своего кластера. В **диспетчере отказоустойчивости кластеров** щелкните свой кластер правой кнопкой мыши и выберите **Другие действия** > **Переместить основной кластерный ресурс** > **Выбрать узел**, а затем выберите другой узел кластера. Перенесите основной кластерный ресурс на каждый узел кластера, а затем верните его на основной узел. Если вам удалось успешно перенести ресурс на каждый узел, вы готовы к установке SQL Server.  

:::image type="content" source="media/manually-configure-failover-cluster-instance-premium-file-share/test-cluster-failover.png" alt-text="Тестирование отказоустойчивости кластеров путем переноса основного кластерного ресурса на другие узлы":::

## <a name="step-5-create-the-sql-server-fci"></a>Шаг 5. Создание экземпляра отказоустойчивого кластера SQL Server

После настройки отказоустойчивого кластера можно создать экземпляр отказоустойчивого кластера SQL Server.

1. Подключитесь к первой виртуальной машине Azure с помощью протокола удаленного рабочего стола (RDP).

1. В **диспетчере отказоустойчивости кластеров** убедитесь, что все основные ресурсы кластера находятся на первой виртуальной машине. При необходимости переместите все ресурсы на эту виртуальную машину.

1. Найдите установочный носитель. Если на виртуальной машине используется один из образов Azure Marketplace, носитель находится в папке `C:\SQLServer_<version number>_Full`. Выберите **Установить**.

1. В диалоговом окне **Центр установки SQL Server** выберите **Установка**.

1. Щелкните **Новая установка отказоустойчивого кластера SQL Server**. Следуйте указаниям мастера, чтобы установить экземпляр отказоустойчивого кластера SQL Server.

   Каталоги данных экземпляра отказоустойчивого кластера должны находиться в общей папки уровня "Премиум". Введите полный путь к папке в следующем виде: `\\storageaccountname.file.core.windows.net\filesharename\foldername`. Появится предупреждение о том, что вы указали файловый сервер в качестве каталога данных. Это нормально. Учетная запись пользователя, с помощью которой вы через RDP подключились к виртуальной машине при сохранении общей папки, должна совпадать с учетной записью, которую служба SQL Server использует для отработки отказов.

   :::image type="content" source="media/manually-configure-failover-cluster-instance-premium-file-share/use-file-share-as-data-directories.png" alt-text="Использование общей папки в качестве каталога для хранения данных SQL":::

1. После завершения процедуры в мастере программа установки установит экземпляр отказоустойчивого кластера SQL Server на первом узле.

1. После установки экземпляра отказоустойчивого кластера на первом узле подключитесь ко второму узлу с помощью протокола удаленного рабочего стола.

1. Откройте диалоговое окно **Центр установки SQL Server**. Нажмите **Установка**.

1. Выберите **Добавление узла в отказоустойчивый кластер SQL Server**. Следуйте указаниям мастера, чтобы установить сервер SQL и добавить его в экземпляр отказоустойчивого кластера.

   >[!NOTE]
   >При использовании образа коллекции Azure Marketplace с SQL Server средства SQL Server включаются в образ. Если вы не использовали один из этих образов, установите средства SQL Server отдельно. См. сведения в статье [Скачивание SQL Server Management Studio (SSMS)](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="step-6-create-the-azure-load-balancer"></a>Шаг 6. Создание подсистемы балансировки нагрузки Azure Load Balancer

На виртуальных машинах Azure кластеры используют балансировщик нагрузки для хранения IP-адреса, который должен находиться на одном узле кластера в определенный момент времени. В этом решении балансировщик нагрузки используется для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.

Дополнительные сведения см. в разделе [Создание и настройка Azure Load Balancer](availability-group-manually-configure-tutorial.md#configure-internal-load-balancer).

### <a name="create-the-load-balancer-in-the-azure-portal"></a>Создание балансировщика нагрузки на портале Azure

Создание балансировщика нагрузки

1. На портале Azure перейдите в группу ресурсов с виртуальными машинами.

1. Выберите **Добавить**. В Azure Marketplace найдите **Load Balancer**. Выберите **Load Balancer**.

1. Нажмите кнопку **создания**.

1. Настройте подсистему балансировки нагрузки, указав следующие значения:

   - **Подписка**: Вашу подписку Azure.
   - **Группа ресурсов.** Группа ресурсов, которая содержит ваши виртуальные машины.
   - **Name** (Имя). Имя, определяющее подсистему балансировки нагрузки.
   - **Регион**. Расположение Azure, которое содержит ваши виртуальные машины.
   - **Тип**. Открытый или закрытый. Доступ к закрытой подсистеме балансировки нагрузки может осуществляться в пределах одной виртуальной сети. Большинство приложений Azure могут использовать закрытый балансировщик нагрузки. Если приложению требуется доступ к SQL Server непосредственно через Интернет, используйте открытую подсистему балансировки нагрузки.
   - **SKU**: Стандартная.
   - **Виртуальная сеть.** Виртуальная сеть, в которой находятся виртуальные машины.
   - **Назначение IP-адресов**. Статический. 
   - **Частный IP-адрес**. IP-адрес, назначенный сетевому ресурсу кластера SQL Server FCI.

   На следующем изображении показан пользовательский интерфейс **создания подсистемы балансировки нагрузки**:

   ![Настройка подсистемы балансировки нагрузки](./media/failover-cluster-instance-premium-file-share-manually-configure/30-load-balancer-create.png)
   

### <a name="configure-the-load-balancer-backend-pool"></a>Настройка серверного пула балансировщика нагрузки

1. Вернитесь в группу ресурсов Azure с виртуальными машинами и найдите новую подсистему балансировки нагрузки. Возможно, потребуется обновить представление в группе ресурсов. Выберите подсистему балансировки нагрузки.

1. Выберите **Серверные пулы**, а затем щелкните **Добавить**.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **Целевые IP-конфигурации сети** установите флажок **Виртуальная машина** и выберите виртуальные машины, которые будут узлами кластера. Не забудьте включить все виртуальные машины, на которых будут размещаться FCI.

1. Нажмите кнопку **ОК**, чтобы создать серверный пул.

### <a name="configure-a-load-balancer-health-probe"></a>Настройка пробы работоспособности балансировщика нагрузки

1. В колонке подсистемы балансировки нагрузки щелкните **Пробы работоспособности**.

1. Выберите **Добавить**.

1. В колонке **Добавить пробу работоспособности** <span id="probe"> </span> задайте указанные ниже параметры пробы работоспособности.

   - **Name** (Имя). Имя для проверки работоспособности.
   - **Протокол**. Протокол TCP.
   - **Порт**. Порт, созданный в брандмауэре для пробы работоспособности в [этом шаге](#ports). В качестве примера в этой статье используется TCP-порт `59999`.
   - **Интервал**: 5 секунд.
   - **Пороговое значение сбоя**: 2 последовательных сбоя.

1. Щелкните **ОК**.

### <a name="set-load-balancing-rules"></a>Задание правил балансировки нагрузки

1. В колонке подсистемы балансировки нагрузки щелкните **Правила балансировки нагрузки**.

1. Выберите **Добавить**.

1. Настройте следующие параметры балансировки нагрузки:

   - **Name** (Имя). Имя для правил балансировки нагрузки.
   - **Интерфейсный IP-адрес**. IP-адрес для сетевого ресурса кластера SQL Server FCI.
   - **Порт**: TCP-порт экземпляра отказоустойчивого кластера SQL Server. Порт экземпляра по умолчанию — 1433.
   - **Серверный порт**. Используется тот же порт, что и для значения **Порт** при включении параметра **Плавающий IP-адрес (прямой ответ от сервера)** .
   - **Серверный пул**. Имя серверного пула, настроенного ранее.
   - **Зонд работоспособности**. Проба работоспособности, настроенная ранее.
   - **Сохранение сеанса**. Нет.
   - **Время ожидания простоя (в минутах)** . 4.
   - **Плавающий IP-адрес (прямой ответ от сервера)** . Включено.

1. Щелкните **ОК**.

## <a name="step-7-configure-the-cluster-for-the-probe"></a>Шаг 7. Настройка кластера для пробы

Задайте параметр порта проверки кластера в PowerShell.

Чтобы задать параметр порта пробы кластера, измените переменные в следующем скрипте, указав значения для своей среды. Удалите из скрипта угловые скобки (`<` и `>`).

   ```powershell
   $ClusterNetworkName = "<Cluster Network Name>"
   $IPResourceName = "<SQL Server FCI IP Address Resource Name>" 
   $ILBIP = "<n.n.n.n>" 
   [int]$ProbePort = <nnnnn>

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

Вот список значений, которые необходимо обновить:

   - `<Cluster Network Name>`: имя отказоустойчивого кластера Windows Server для сети. Выберите **Диспетчер отказоустойчивости кластеров** > **Сети**, щелкните сеть правой кнопкой мыши и выберите **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<SQL Server FCI IP Address Resource Name>`: имя ресурса IP-адреса экземпляра отказоустойчивого кластера SQL Server. Выберите **Диспетчер отказоустойчивости кластеров** > **Роли**. Для роли экземпляра отказоустойчивого кластера SQL Server в разделе **Имя сервера** щелкните правой кнопкой мыши ресурс IP-адреса и выберите **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<ILBIP>`: IP-адрес внутренней подсистемы балансировки нагрузки. Этот адрес настраивается на портале Azure в качестве интерфейсного адреса внутренней подсистемы балансировки нагрузки. Это также IP-адрес экземпляра отказоустойчивого кластера SQL Server. Его можно найти в окне **Диспетчер отказоустойчивости кластеров** на той же странице свойств, где указано значение `<SQL Server FCI IP Address Resource Name>`.  

   - `<nnnnn>`: порт пробы, настроенный в пробе работоспособности подсистемы балансировки нагрузки. Допускается любой неиспользуемый TCP-порт.

>[!IMPORTANT]
>Маска подсети для параметра кластера должна быть широковещательным адресом TCP IP: `255.255.255.255`.

После настройки пробы кластера все параметры кластера можно просмотреть в PowerShell. Выполните следующий скрипт:

   ```powershell
   Get-ClusterResource $IPResourceName | Get-ClusterParameter
  ```

## <a name="step-8-test-fci-failover"></a>Шаг 8. Проверка отработки отказа экземпляра отказоустойчивого кластера

Проверьте отработку отказа экземпляра отказоустойчивого кластера, чтобы проверить функциональные возможности кластера. Сделайте следующее:

1. Подключитесь к одному из узлов кластера SQL Server FCI с помощью протокола удаленного рабочего стола.

1. Откройте **диспетчер отказоустойчивости кластеров**. Выберите **Роли**. Обратите внимание, какой узел является владельцем роли SQL Server FCI.

1. Щелкните правой кнопкой мыши роль SQL Server FCI.

1. Выберите **Переместить**, а затем выберите **Лучший возможный узел**.

В **диспетчере отказоустойчивости кластеров** отобразится роль, и ее ресурсы перейдут в автономный режим. Затем ресурсы переместятся и снова станут доступными на другом узле.

### <a name="test-connectivity"></a>Проверка подключения

Чтобы проверить подключение, войдите на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к экземпляру отказоустойчивого кластера SQL Server.

>[!NOTE]
>При необходимости можно [скачать SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="limitations"></a>Ограничения

Виртуальные машины Azure поддерживают координатор распределенных транзакций Microsoft (MSDTC) на Windows Server 2019 с хранилищем на общем томе кластера (CSV) и с [Load Balancer ценовой категории "Стандартный"](../../../load-balancer/load-balancer-standard-overview.md).

MSDTC не поддерживается на виртуальных машинах Azure в Windows Server 2016 и более ранних версий по следующим причинам:

- Кластерный ресурс MSDTC нельзя настроить для использования общего хранилища. В Windows Server 2016, если вы создаете ресурс MSDTC, не будет отображаться доступное общее хранилище, даже если оно существует. Эта проблема устранена в Windows Server 2019.
- Load Balancer ценовой категории "Стандартный" не обрабатывает порты RPC.

## <a name="see-also"></a>См. также раздел

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);
- [экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server).
