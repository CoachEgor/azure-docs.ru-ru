---
title: Рекомендации по конфигурации кластера
description: Сведения о поддерживаемых конфигурациях кластера при настройке высокого уровня доступности и аварийного восстановления для SQL Server на виртуальных машинах Azure, таких как поддерживаемые кворумы или параметры маршрутизации подключений.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.openlocfilehash: de773bb2188f09822cae59ce42924a9a49f8087e
ms.sourcegitcommit: dccb85aed33d9251048024faf7ef23c94d695145
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/28/2020
ms.locfileid: "87285634"
---
# <a name="cluster-configuration-best-practices-sql-server-on-azure-vms"></a>Рекомендации по конфигурации кластера (SQL Server на виртуальных машинах Azure)
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

Кластер используется для обеспечения высокой доступности и аварийного восстановления (HADR) с SQL Server на виртуальных машинах Azure. 

В этой статье приведены рекомендации по конфигурации кластера для [экземпляров отказоустойчивого кластера (FCI)](failover-cluster-instance-overview.md) и [групп доступности](availability-group-overview.md) при их использовании с SQL Server на виртуальных машинах Azure. 


## <a name="networking"></a>Сеть

Используйте одну сетевую карту на сервер (узел кластера) и одну подсеть. Сеть Azure имеет физическую избыточность, что делает дополнительные сетевые карты и подсети ненужными в гостевом кластере виртуальной машины Azure. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в гостевых отказоустойчивых кластерах виртуальных машин Azure.

## <a name="quorum"></a>Кворум

Несмотря на то, что кластер с двумя узлами будет работать без [ресурса кворума](/windows-server/storage/storage-spaces/understand-quorum), клиентам необходимо использовать ресурс кворума для поддержки рабочей среды. При проверке кластера не будет передаваться ни один кластер без ресурса кворума. 

Технически кластер из трех узлов может потерять вероятность потери одного узла (не более двух узлов) без ресурса кворума. Но после отключения кластера от двух узлов существует риск выполнения следующих действий: 

- **Раздел в пространстве** (разделение). узлы кластера разделяются по сети из-за ошибки сервера, сетевого адаптера или коммутатора. 
- **Секция во времени** (амнесиа): узел присоединяется к кластеру или повторно присоединяется к нему и пытается ненадлежащим образом запрашивать владение кластерной группой или ролью кластера. 

Ресурс кворума защищает кластер от любой из этих проблем. 

В следующей таблице перечислены параметры кворума, доступные в заказе, рекомендуемом для использования с виртуальной машиной Azure. предпочтительнее использовать диск-свидетель. 


||[Диск-свидетель](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum)  |[Облачный следящий сервер](/windows-server/failover-clustering/deploy-cloud-witness)  |[Файловый ресурс-свидетель](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum)  |
|---------|---------|---------|---------|
|**Поддерживаемая ОС**| Все |Windows Server 2016+| Windows Server 2012 +|




### <a name="disk-witness"></a>Диск-свидетель

Диск-свидетель — это небольшой кластерный диск в группе хранения, доступной для кластера. Этот диск является высокодоступным и может выполнять отработку отказа между узлами. Он содержит копию базы данных кластера с размером по умолчанию, который обычно меньше 1 ГБ. Диск-свидетель является предпочтительным вариантом кворума для виртуальной машины Azure, так как он может решить проблему с разделом во времени, в отличие от облака-свидетеля и файлового ресурса-свидетеля. 

Настройте общий диск Azure в качестве диска-свидетеля. 

Чтобы приступить к работе, см. раздел [Настройка диска-свидетеля](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum).


**Поддерживаемая ОС**: все   


### <a name="cloud-witness"></a>Облако-свидетель

Облачный следящий сервер — это тип следящего сервера кворума отказоустойчивого кластера, который использует Microsoft Azure для передачи голоса по кворуму кластера. Размер по умолчанию составляет около 1 МБ и содержит только метку времени. Облако-свидетель идеально подходит для развертываний на нескольких сайтах, в нескольких зонах и в нескольких регионах.

Чтобы приступить к работе, см. раздел [Настройка облачного следящего сервера](/windows-server/failover-clustering/deploy-cloud-witness#CloudWitnessSetUp).


**Поддерживаемая ОС**: Windows Server 2016 и более поздние версии   


### <a name="file-share-witness"></a>Файловый ресурс-свидетель

Файловый ресурс-свидетель — это общая папка SMB, которая обычно настраивается на файловом сервере под Windows Server. Он хранит сведения о кластеризации в файле следящего сервера. log, но не сохраняет копию базы данных кластера. В Azure можно настроить [файловый ресурс Azure](../../../storage/files/storage-how-to-create-file-share.md) для использования в качестве файлового ресурса-свидетеля или использовать общую папку на отдельной виртуальной машине.

Если вы собираетесь использовать файловый ресурс Azure, его можно подключить с помощью того же процесса, который используется для [подключения общей папки Premium](failover-cluster-instance-premium-file-share-manually-configure.md#mount-premium-file-share). 

Чтобы приступить к работе, см. раздел [Настройка файлового ресурса-свидетеля](/windows-server/failover-clustering/manage-cluster-quorum#configure-the-cluster-quorum).


**Поддерживаемая ОС**: Windows Server 2012 и более поздние версии   

## <a name="connectivity"></a>Соединение

В традиционной локальной сетевой среде SQL Server экземпляр отказоустойчивого кластера является единственным экземпляром SQL Server, работающим на одном компьютере. Так как экземпляр отказоустойчивого кластера отключается от узла к узлу, имя виртуальной сети (VNN) для экземпляра предоставляет единую точку подключения и позволяет приложениям подключаться к экземпляру SQL Server, не зная, какой узел в данный момент активен. Когда происходит отработка отказа, имя виртуальной сети регистрируется на новом активном узле после его запуска. Этот процесс является прозрачным для клиента или приложения, которое подключается к SQL Server, что сокращает время простоя, которое клиент или приложение выдает в случае сбоя. 

Используйте VNN с Azure Load Balancer или именем распределенной сети (DNN) для маршрутизации трафика в VNN экземпляра отказоустойчивого кластера с SQL Server на виртуальных машинах Azure. Функция DNN в настоящее время доступна только для SQL Server 2019 CU2 и более поздних версий на виртуальной машине Windows Server 2016 (или более поздней версии). 

В следующей таблице сравниваются Поддерживаемые подключения HADR. 

| |**Имя виртуальной сети (VNN)**  |**Имя распределенной сети (DNN)**  |
|---------|---------|---------|
|**Минимальная версия ОС**| Windows Server 2012 | Windows Server 2016|
|**Минимальная версия SQL Server** |SQL Server 2012 |SQL Server 2019 CU2|
|**Поддерживаемое решение HADR** | Экземпляр отказоустойчивого кластера <br/> группа доступности | Экземпляр отказоустойчивого кластера|


### <a name="virtual-network-name-vnn"></a>Имя виртуальной сети (VNN)

Так как виртуальная IP-точка доступа работает иначе в Azure, необходимо настроить [Azure Load Balancer](../../../load-balancer/index.yml) для маршрутизации трафика по IP-адресу узлов FCI. В виртуальных машинах Azure подсистема балансировки нагрузки содержит IP-адрес VNN, от которых полагаются кластерные ресурсы SQL Server. Балансировщик нагрузки распределяет входящие потоки, поступающие на внешний интерфейс, а затем направляет трафик в экземпляры, определенные внутренним пулом. Поток трафика настраивается с помощью правил балансировки нагрузки и проверок работоспособности. В SQL Server FCI экземпляры пула серверной части — это виртуальные машины Azure под управлением SQL Server. 

При использовании балансировщика нагрузки существует небольшая задержка отработки отказа, поскольку проверка работоспособности по умолчанию выполняет проверки активности каждые 10 секунд. 

Чтобы приступить к работе, Узнайте, как [настроить Azure Load Balancer для FCI](hadr-vnn-azure-load-balancer-configure.md). 

**Поддерживаемая ОС**: Windows Server 2012 и более поздние версии   
**Поддерживаемая версия SQL**: SQL Server 2012 и более поздних версий   
**Поддерживаемое решение HADR**: экземпляр отказоустойчивого кластера и группа доступности 


### <a name="distributed-network-name-dnn"></a>Имя распределенной сети (DNN)

Имя распределенной сети — это новая функция Azure для SQL Server 2019 CU2. DNN предоставляет альтернативный способ для SQL Server клиентов подключаться к экземпляру отказоустойчивого кластера SQL Server без использования балансировщика нагрузки. 

При создании ресурса DNN кластер привязывает DNS-имя с IP адресами всех узлов в кластере. Клиент SQL попытается подключиться к каждому IP-адресу в этом списке, чтобы найти узел, на котором в данный момент выполняется экземпляр отказоустойчивого кластера. Вы можете ускорить этот процесс, указав `MultiSubnetFailover=True` в строке подключения. Этот параметр указывает поставщику, что необходимо параллельно пытаться использовать все IP-адреса, чтобы клиент мог мгновенно подключиться к FCI. 

По возможности рекомендуется использовать имя распределенной сети в подсистеме балансировки нагрузки, поскольку: 
- Комплексное решение является более надежным, так как вам больше не нужно поддерживать ресурс балансировщика нагрузки. 
- Устранение проверок балансировщика нагрузки уменьшает длительность отработки отказа. 
- DNN упрощает подготовку и управление экземпляром отказоустойчивого кластера с SQL Server на виртуальных машинах Azure. 

Большинство функций SQL Server прозрачно работают с FCI. В таких случаях можно просто заменить существующее DNS-имя VNN именем DNN DNS или задать значение DNN существующим DNS-именем VNN. Однако для некоторых серверных компонентов требуется сетевой псевдоним, который сопоставляет имя VNN с именем DNN. В определенных случаях может потребоваться явное использование DNS-имени DNN, например при определении определенных URL-адресов в конфигурации на стороне сервера. 

Чтобы приступить к работе, Узнайте, как [настроить ресурс DNN для FCI](hadr-distributed-network-name-dnn-configure.md). 

**Поддерживаемая ОС**: Windows Server 2016 и более поздние версии   
**Поддерживаемая версия SQL**: SQL Server 2019 и более поздних версий   
**Поддерживаемое решение HADR**: только экземпляр отказоустойчивого кластера


## <a name="limitations"></a>Ограничения

При работе с FCI или группами доступности и SQL Server на виртуальных машинах Azure учитывайте следующие ограничения. 

### <a name="msdtc"></a>MSDTC 
Виртуальные машины Azure поддерживают Microsoft координатор распределенных транзакций (MSDTC) в Windows Server 2019 с хранилищем в общих томах кластера (CSV) и [Azure Load Balancer (цен. Категория "Стандартный")](../../../load-balancer/load-balancer-standard-overview.md).

На виртуальных машинах Azure MSDTC не поддерживается для Windows Server 2016 или более ранних версий, так как:

- Кластерный ресурс MSDTC нельзя настроить для использования общего хранилища. В Windows Server 2016, если вы создаете ресурс MSDTC, не будет отображаться доступное общее хранилище, даже если оно существует. Эта проблема устранена в Windows Server 2019.
- Load Balancer ценовой категории "Стандартный" не обрабатывает порты RPC.


## <a name="next-steps"></a>Дальнейшие шаги

После того как вы определили соответствующие рекомендации для решения, приступайте [к подготовке виртуальной машины SQL Server для FCI](failover-cluster-instance-prepare-vm.md). Вы также можете создать группу доступности с помощью [Azure CLI](availability-group-az-cli-configure.md)или шаблонов быстрого запуска [Azure](availability-group-quickstart-template-configure.md). 

