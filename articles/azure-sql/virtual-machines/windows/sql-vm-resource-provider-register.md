---
title: Регистрация с помощью поставщика ресурсов виртуальных машин SQL
description: Зарегистрируйте виртуальную машину Azure SQL Server с помощью поставщика ресурсов виртуальной машины SQL, чтобы включить функции для SQL Server виртуальных машин, развернутых за пределами Azure Marketplace, а также для обеспечения соответствия и улучшенной управляемости.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
tags: azure-resource-manager
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 11/13/2019
ms.author: mathoma
ms.reviewer: jroth
ms.custom: devx-track-azurecli, devx-track-azurepowershell
ms.openlocfilehash: 3f1a9a2756d81765d82938651672e5a83edc48ed
ms.sourcegitcommit: 656c0c38cf550327a9ee10cc936029378bc7b5a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/28/2020
ms.locfileid: "89078696"
---
# <a name="register-a-sql-server-vm-in-azure-with-the-sql-vm-resource-provider-rp"></a>Регистрация SQL Server виртуальной машины в Azure с помощью поставщика ресурсов виртуальной машины (RP) SQL
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье описывается, как зарегистрировать виртуальную машину SQL Server в Azure с помощью поставщика ресурсов виртуальной машины (RP) SQL. При регистрации с помощью поставщика ресурсов в рамках подписки создается отдельный _ресурс_ **виртуальной машины SQL**. При отмене регистрации виртуальной машины SQL Server в поставщике ресурсов будет удален _ресурс_ **виртуальной машины SQL**, но не будет удалена фактическая виртуальная машина. 

Развертывание образа виртуальной машины SQL Server из Azure Marketplace через портал Azure предусматривает автоматическую регистрацию виртуальной машины SQL Server в поставщике ресурсов. Однако, если вы решили самостоятельно установить SQL Server на виртуальной машине Azure или подготовили виртуальную машину Azure из пользовательского виртуального жесткого диска, вы должны зарегистрировать виртуальную машину SQL Server в поставщике ресурсов, чтобы получить следующие возможности:

- **Функциональные преимущества.** При регистрации виртуальной машины SQL Server в поставщике ресурсов вы сможете разблокировать возможности [автоматической установки исправлений](automated-patching.md), [автоматического резервного копирования](automated-backup.md), а также мониторинга и управления. Кроме того, вы получите широкий выбор [лицензий](licensing-model-azure-hybrid-benefit-ahb-change.md) и [выпусков](change-sql-server-edition.md). Ранее эти функции были доступны только для образов виртуальных машин SQL Server, развернутых из Azure Marketplace. 

- **Соответствие.** Регистрация в поставщике ресурсов виртуальной машины SQL предоставляет упрощенный метод выполнения требования по уведомлению корпорации Майкрософт о включении Преимущества гибридного использования Azure, как указано в условиях продукта. Этот процесс устраняет необходимость в управлении формами регистрации лицензий для каждого ресурса.  

- **Бесплатное управление**. Регистрация в поставщике ресурсов ВИРТУАЛЬНОЙ машины SQL во всех трех режимах управляемости полностью бесплатная. За использование поставщика ресурсов или за изменение режимов управления дополнительная плата не взимается. 

- **Упрощенное управление лицензиями.** Регистрация с помощью поставщика ресурсов виртуальной машины SQL упрощает управление лицензиями SQL Server и позволяет быстро определить виртуальные машины SQL Server с Преимуществом гибридного использования Azure, включенным с помощью [портала Azure](manage-sql-vm-portal.md), Az CLI или PowerShell: 

   # <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

   ```azurecli-interactive
   $vms = az sql vm list | ConvertFrom-Json
   $vms | Where-Object {$_.sqlServerLicenseType -eq "AHUB"}
   ```

   # <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

   ```powershell-interactive
   Get-AzSqlVM | Where-Object {$_.LicenseType -eq 'AHUB'}
   ```

   ---

Чтобы использовать поставщик ресурсов виртуальной машины SQL, необходимо сначала [зарегистрировать подписку в поставщике ресурсов](#register-subscription-with-rp), что дает поставщику ресурсов возможность создавать ресурсы в этой подписке.

## <a name="prerequisites"></a>Предварительные требования

Для регистрации виртуальной машины SQL Server с помощью поставщика ресурсов понадобится: 

- [Подписка Azure](https://azure.microsoft.com/free/).
- [Виртуальная машина SQL Server](create-sql-vm-portal.md) модели ресурсов Azure, развернутая в общедоступном облаке или в облаке Azure для государственных организаций. 
- Последняя версия [Azure CLI](/cli/azure/install-azure-cli) или [PowerShell](/powershell/azure/new-azureps-module-az). 

## <a name="management-modes"></a>Режимы управления

Если [расширение IaaS для SQL](sql-server-iaas-agent-extension-automate-management.md) еще не установлено, то при регистрации с помощью поставщика ресурсов виртуальной машины SQL будет автоматически установлено расширение IaaS для SQL Server в одном из трех режимов управления, указанных во время регистрации. Если не указать режим управления, расширение IaaS для SQL будет установлено в режиме полного управления.  

Если расширение IaaS для SQL уже установлено вручную, то оно уже находится в режиме полного управления и регистрация с помощью поставщика ресурсов в полном режиме не приведет к перезапуску службы SQL Server.

Три режима управления:

- **Упрощенный** режим не требует перезапуска SQL Server, но поддерживает только изменение типа лицензии и выпуска SQL Server. Используйте этот параметр для виртуальных машин SQL Server с несколькими экземплярами или участвующих в экземпляре отказоустойчивого кластера (FCI). Упрощенный режим не влияет на память или загрузку ЦП и дополнительная плата не взимается. Рекомендуется сначала зарегистрировать виртуальную машину SQL Server в упрощенном режиме, а затем выполнить обновление до полного режима в течение запланированного периода обслуживания.  

- **Полный** режим предоставляет все функциональные возможности. Для работы в этом режиме необходимо перезапустить разрешения SQL Server и системного администратора. Этот вариант устанавливается по умолчанию при установке расширения IaaS для SQL вручную. Используйте его для управления виртуальной машиной SQL Server с одним экземпляром. В полном режиме устанавливаются две службы Windows, которые минимально воздействуют на память и загрузку ЦП. Это воздействие можно отслеживать с помощью диспетчера задач. Плата за использование режима полного управления не взимается. 

- Режим **NoAgent** предназначен для SQL Server 2008 и SQL Server 2008 R2, установленных в Windows Server 2008. Режим NoAgent не влияет на память или загрузку ЦП. Плата за использование режима управления NoAgent не взимается. 

Текущий режим агента IaaS для SQL Server можно просмотреть с помощью PowerShell: 

  ```powershell-interactive
  # Get the SqlVirtualMachine
  $sqlvm = Get-AzSqlVM -Name $vm.Name  -ResourceGroupName $vm.ResourceGroupName
  $sqlvm.SqlManagementType
  ```

## <a name="register-subscription-with-rp"></a>Регистрация подписки с помощью поставщика ресурсов

Чтобы зарегистрировать виртуальную машину SQL Server с помощью поставщика ресурсов виртуальной машины SQL, необходимо сначала зарегистрировать подписку с помощью поставщика ресурсов. Это дает поставщику ресурсов виртуальной машины SQL возможность создавать ресурсы в подписке.  Это можно сделать с помощью портала Azure, Azure CLI или PowerShell.

### <a name="azure-portal"></a>Портал Azure

1. Войдите на портал Azure и откройте раздел **Все службы**. 
1. Перейдите к разделу **Подписки** и выберите нужную подписку.  
1. На странице **Подписки** перейдите к элементу **Поставщики ресурсов**. 
1. Введите в фильтр значение **sql**, чтобы отсортировать поставщиков ресурсов, имеющих отношение к SQL. 
1. Выберите действие **Зарегистрировать**, **Перерегистрировать** или **Отменить регистрацию** для поставщика **Microsoft.SqlVirtualMachine** в зависимости от ваших намерений. 

   ![Изменение поставщика](./media/sql-vm-resource-provider-register/select-resource-provider-sql.png)


### <a name="command-line"></a>Командная строка

Зарегистрируйте поставщик ресурсов виртуальной машины SQL в подписке Azure с помощью Azure CLI или PowerShell. 

# <a name="azure-cli"></a>[Azure CLI](#tab/bash)

```azurecli-interactive
# Register the SQL VM resource provider to your subscription 
az provider register --namespace Microsoft.SqlVirtualMachine 
```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

```powershell-interactive
# Register the SQL VM resource provider to your subscription
Register-AzResourceProvider -ProviderNamespace Microsoft.SqlVirtualMachine
```

---

## <a name="register-with-rp"></a>Регистрация с помощью RP

### <a name="lightweight-management-mode"></a>Режим упрощенного управления

Если [расширение агента SQL Server IaaS](sql-server-iaas-agent-extension-automate-management.md) не установлено на виртуальной машине, рекомендуется зарегистрироваться в поставщике ресурсов ВИРТУАЛЬНОЙ машины SQL в упрощенном режиме. Это позволит установить расширение IaaS для SQL Server в [упрощенном режиме](#management-modes) и избежать перезапуска службы SQL Server. Затем в любое время можно выполнить обновление до полного режима, но это приведет к перезапуску службы SQL Server. Поэтому рекомендуется дождаться периода запланированного обслуживания. 

Укажите тип лицензии SQL Server: с оплатой по мере использования (`PAYG`), чтобы платить только за потребляемые ресурсы, Преимущество гибридного использования Azure (`AHUB`), чтобы использовать собственную лицензию, или аварийное восстановление (`DR`), чтобы активировать [лицензии бесплатной реплики аварийного восстановления](business-continuity-high-availability-disaster-recovery-hadr-overview.md#free-dr-replica-in-azure).

Экземпляры отказоустойчивого кластера и развертывания с несколькими экземплярами можно зарегистрировать только в поставщике ресурсов виртуальной машины SQL в упрощенном режиме. 

# <a name="azure-cli"></a>[Azure CLI](#tab/bash)

Зарегистрируйте SQL Serverную виртуальную машину в упрощенном режиме с Azure CLI: 

  ```azurecli-interactive
  # Register Enterprise or Standard self-installed VM in Lightweight mode
  az sql vm create --name <vm_name> --resource-group <resource_group_name> --location <vm_location> --license-type PAYG 
  ```


# <a name="powershell"></a>[PowerShell](#tab/powershell)

Регистрация SQL Server виртуальной машины в упрощенном режиме с помощью PowerShell:  


  ```powershell-interactive
  # Get the existing compute VM
  $vm = Get-AzVM -Name <vm_name> -ResourceGroupName <resource_group_name>
          
  # Register SQL VM with 'Lightweight' SQL IaaS agent
  New-AzSqlVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName -Location $vm.Location `
    -LicenseType PAYG -SqlManagementType LightWeight  
  ```

---

### <a name="full-management-mode"></a>Режим полного управления


Если расширение IaaS для SQL уже установлено на виртуальной машине вручную, можно зарегистрировать SQL Server виртуальную машину в полном режиме без перезапуска службы SQL Server. **Однако если расширение IaaS для SQL не установлено, при регистрации в полном режиме будет установлено расширение IaaS для SQL в полном режиме и перезагружена служба SQL Server. Выполняйте дальнейшие действия с осторожностью.**


Чтобы зарегистрировать виртуальную машину SQL Server сразу в полном режиме (и, возможно, перезагрузить службу SQL Server), используйте следующую команду PowerShell: 

  ```powershell-interactive
  # Get the existing  Compute VM
  $vm = Get-AzVM -Name <vm_name> -ResourceGroupName <resource_group_name>
        
  # Register with SQL VM resource provider in full mode
  New-AzSqlVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName -SqlManagementType Full
  ```

### <a name="noagent-management-mode"></a>Режим управления NoAgent 

SQL Server 2008 и 2008 R2, установленные в Windows Server 2008 (_не R2_), можно зарегистрировать с помощью поставщика ресурсов виртуальной машины SQL в [режиме NoAgent](#management-modes). Этот вариант обеспечивает соответствие и позволяет отслеживать виртуальную машину SQL Server на портале Azure с ограниченными функциональными возможностями.

Укажите `AHUB`, `PAYG` или `DR` в качестве **sqlLicenseType** и `SQL2008-WS2008` или `SQL2008R2-WS2008` в качестве **sqlImageOffer**. 

Чтобы зарегистрировать SQL Server 2008 или 2008 R2 в экземпляре Windows Server 2008, используйте следующий фрагмент кода Azure CLI или PowerShell: 


# <a name="azure-cli"></a>[Azure CLI](#tab/bash)

Зарегистрируйте виртуальную машину SQL Server 2008 в режиме агента с Azure CLI: 

  ```azurecli-interactive
   az sql vm create -n sqlvm -g myresourcegroup -l eastus |
   --license-type PAYG --sql-mgmt-type NoAgent 
   --image-sku Enterprise --image-offer SQL2008-WS2008
 ```
 
 
Зарегистрируйте виртуальную машину SQL Server 2008 R2 в режиме агента с Azure CLI: 

  ```azurecli-interactive
   az sql vm create -n sqlvm -g myresourcegroup -l eastus |
   --license-type PAYG --sql-mgmt-type NoAgent 
   --image-sku Enterprise --image-offer SQL2008R2-WS2008
 ```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Зарегистрируйте виртуальную машину SQL Server 2008 в режиме "без агента" с помощью PowerShell: 


  ```powershell-interactive
  # Get the existing compute VM
  $vm = Get-AzVM -Name <vm_name> -ResourceGroupName <resource_group_name>
          
  New-AzSqlVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName -Location $vm.Location `
    -LicenseType PAYG -SqlManagementType NoAgent -Sku Standard -Offer SQL2008-WS2008
  ```
  
  Зарегистрируйте виртуальную машину SQL Server 2008 R2 в режиме агента с помощью PowerShell: 


  ```powershell-interactive
  # Get the existing compute VM
  $vm = Get-AzVM -Name <vm_name> -ResourceGroupName <resource_group_name>
          
  New-AzSqlVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName -Location $vm.Location `
    -LicenseType PAYG -SqlManagementType NoAgent -Sku Standard -Offer SQL2008R2-WS2008
  ```

---

## <a name="upgrade-to-full"></a>Обновить до полной версии  

Виртуальные машины SQL Server с установленным расширением IaaS в *упрощенном* режиме могут обновить режим до _полного_ с помощью портала Azure, Azure CLI или PowerShell. Виртуальные машины SQL Server в режиме _NoAgent_ можно обновить до _полного_ режима после обновления операционной системы до Windows 2008 R2 или выше. Переход на использование более ранней версии невозможен. Чтобы сделать это, необходимо [отменить регистрацию](#unregister-from-rp) виртуальной машины SQL Server в поставщике ресурсов виртуальной машины SQL. При этом будет удален _ресурс_ **виртуальной машины SQL**, но не фактическая виртуальная машина. 

Текущий режим агента IaaS для SQL Server можно просмотреть с помощью PowerShell: 

  ```powershell-interactive
  # Get the SqlVirtualMachine
  $sqlvm = Get-AzSqlVM -Name $vm.Name  -ResourceGroupName $vm.ResourceGroupName
  $sqlvm.SqlManagementType
  ```

Чтобы обновить режим агента до полного, сделайте следующее: 


### <a name="azure-portal"></a>Портал Azure

1. Войдите на [портал Azure](https://portal.azure.com).
1. Перейдите к ресурсу [виртуальных машин SQL](manage-sql-vm-portal.md#access-the-sql-virtual-machines-resource). 
1. Выберите SQL Server виртуальную машину и щелкните **Обзор**. 
1. Для виртуальных машин IaaS для SQL Server с упрощенным режимом IaaS или NoAgent выберите сообщение **Only license type and edition updates are available with the SQL IaaS extension** (Для режима расширения SQL IaaS доступно только изменение типа лицензии и выпуска).

   ![Выбранные элементы изменения режима на портале](./media/sql-vm-resource-provider-register/change-sql-iaas-mode-portal.png)

1. Установите флажок **Я соглашаюсь перезапустить службу SQL Server на виртуальной машине**, а затем выберите **Подтвердить**, чтобы обновить режим IaaS до полного. 

    ![Флажок, подтверждающий согласие перезапуска службы SQL Server на виртуальной машине](./media/sql-vm-resource-provider-register/enable-full-mode-iaas.png)

### <a name="command-line"></a>Командная строка

# <a name="azure-cli"></a>[Azure CLI](#tab/bash)

Выполните следующий фрагмент кода Azure CLI:

  ```azurecli-interactive
  # Update to full mode
  az sql vm update --name <vm_name> --resource-group <resource_group_name> --sql-mgmt-type full  
  ```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Выполните следующий фрагмент кода PowerShell:

  ```powershell-interactive
  # Get the existing  Compute VM
  $vm = Get-AzVM -Name <vm_name> -ResourceGroupName <resource_group_name>
        
  # Register with SQL VM resource provider in full mode
  Update-AzSqlVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName -SqlManagementType Full
  ```

---

## <a name="verify-registration-status"></a>Проверка состояния регистрации
Вы можете проверить, зарегистрирована ли виртуальная машина SQL Server в с помощью поставщика ресурсов виртуальной машины SQL, используя портал Azure, Azure CLI или PowerShell. 

### <a name="azure-portal"></a>Портал Azure 

1. Войдите на [портал Azure](https://portal.azure.com). 
1. Перейдите на [SQL Server виртуальные машины](manage-sql-vm-portal.md).
1. Выберите свою виртуальную машину SQL Server из списка. Если вашей виртуальной машины SQL Server здесь нет, скорее всего, она не была зарегистрирована с помощью поставщика ресурсов виртуальной машины SQL. 
1. Просмотрите значение в разделе **Состояние**. Если **Состояние** имеет значение **Успешно**, то виртуальная машина SQL Server успешно зарегистрирована с помощью поставщика ресурсов виртуальной машины SQL. 

   ![Проверка состояния при регистрации с помощью поставщика ресурсов SQL](./media/sql-vm-resource-provider-register/verify-registration-status.png)

### <a name="command-line"></a>Командная строка

Проверьте текущее состояние регистрации виртуальной машины SQL Server с помощью Azure CLI или PowerShell. Параметр `ProvisioningState` отображает состояние `Succeeded`, если регистрация прошла успешно. 

# <a name="azure-cli"></a>[Azure CLI](#tab/bash)


  ```azurecli-interactive
  az sql vm show -n <vm_name> -g <resource_group>
 ```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

  ```powershell-interactive
  Get-AzSqlVM -Name <vm_name> -ResourceGroupName <resource_group>
  ```

---

Ошибка указывает на то, что виртуальная машина SQL Server не зарегистрирована с помощью поставщика ресурсов. 


## <a name="unregister-from-rp"></a>Отменить регистрацию в RP

Чтобы отменить регистрацию SQL Server виртуальной машины с помощью поставщика ресурсов виртуальной машины SQL, удалите *ресурс* ВИРТУАЛЬНОЙ машины SQL, используя портал Azure или Azure CLI. При удалении *ресурса* ВИРТУАЛЬНОЙ машины SQL SQL Server виртуальная машина не удаляется. Тем не менее будьте внимательны и осторожны при выполнении этих действий, так как при попытке удалить *ресурс* можно случайно удалить виртуальную машину. 

Отмена регистрации виртуальной машины SQL с поставщиком ресурсов виртуальной машины SQL необходима для перехода в режим управления с полной на более раннюю версию. 

### <a name="azure-portal"></a>Портал Azure

Чтобы отменить регистрацию виртуальной машины SQL Server с помощью поставщика ресурсов на портале Azure, выполните следующие действия:

1. Войдите на [портал Azure](https://portal.azure.com).
1. Перейдите к ресурсу виртуальной машины SQL. 
  
   ![Ресурс "Виртуальные машины SQL"](./media/sql-vm-resource-provider-register/sql-vm-manage.png)

1. Выберите команду **Удалить**. 

   ![Удаление поставщика ресурсов виртуальной машины SQL](./media/sql-vm-resource-provider-register/delete-sql-vm-resource-provider.png)

1. Введите имя виртуальной машины SQL и **снимите флажок рядом с этой виртуальной машиной**.

   ![Удаление поставщика ресурсов виртуальной машины SQL](./media/sql-vm-resource-provider-register/confirm-delete-of-resource-uncheck-box.png)

   >[!WARNING]
   > Если не снять флажок рядом с именем виртуальной машины, то она будет *удалена* полностью. Снимите флажок, чтобы отменить регистрацию виртуальной машины SQL Server в поставщике ресурсов и *не удалить фактическую виртуальную машину*. 

1. Выберите **Удалить** , чтобы подтвердить удаление *ресурса*виртуальной машины SQL, а не SQL Server виртуальной машины. 

### <a name="command-line"></a>Командная строка

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)
Чтобы отменить регистрацию SQL Server виртуальной машины в поставщике ресурсов с помощью Azure CLI, используйте команду [AZ SQL VM Delete](/cli/azure/sql/vm?view=azure-cli-latest#az-sql-vm-delete) . Это приведет к удалению *ресурса* виртуальной машины SQL Server, но не удалит виртуальную машину. 


```azurecli-interactive
az sql vm delete 
  --name <SQL VM resource name> |
  --resource-group <Resource group name> |
  --yes 
```

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
Чтобы отменить регистрацию SQL Server виртуальной машины в поставщике ресурсов с помощью Azure CLI, используйте команду [New-азсклвм](/powershell/module/az.sqlvirtualmachine/new-azsqlvm). Это приведет к удалению *ресурса* виртуальной машины SQL Server, но не удалит виртуальную машину. 

```powershell-interactive
Remove-AzSqlVM -ResourceGroupName <resource_group_name> -Name <VM_name>
```

---

## <a name="limitations"></a>Ограничения

Поставщик ресурсов виртуальной машины SQL поддерживает только:
- Виртуальные машины SQL Server, развернутые с помощью Azure Resource Manager. Виртуальные машины SQL Server, развернутые с помощью классической модели развертывания, не поддерживаются. 
- Виртуальные машины SQL Server, развернутые в общедоступном облаке или в облаке Azure для государственных организаций. Развертывания в других частных облаках или облаках для государственных организаций не поддерживаются. 


## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы 

**Следует ли регистрировать виртуальную машину SQL Server, подготовленную на основе образа SQL Server, в Azure Marketplace?**

Нет. Корпорация Майкрософт автоматически регистрирует виртуальные машины, подготовленные на основе образов SQL Server в Azure Marketplace. Регистрация с помощью поставщика ресурсов виртуальной машины SQL требуется только в том случае, если виртуальная машина *не* была подготовлена из образов SQL Server в Azure Marketplace, а SQL Server был установлен самостоятельно.

**Доступен ли поставщик ресурсов виртуальной машины SQL для всех клиентов?** 

Да. Клиенты должны зарегистрировать свои виртуальные машины SQL Server с помощью поставщиков ресурсов виртуальной машины SQL, если они не использовали образ SQL Server из Azure Marketplace, а вместо этого самостоятельно установили SQL Server или использовали свой собственный виртуальный жесткий диск. Виртуальные машины, принадлежащие всем типам подписок (Direct, Соглашение Enterprise и поставщик облачных решений), могут быть зарегистрированы с помощью поставщика ресурсов виртуальной машины SQL.

**Следует ли выполнять регистрацию с помощью поставщика ресурсов виртуальной машины SQL, если на моей виртуальной машине SQL Server уже установлено расширение IaaS для SQL Server?**

Регистрация с помощью поставщика ресурсов виртуальной машины SQL требуется, если виртуальная машина SQL Server не была подготовлена из образов SQL Server в Azure Marketplace, а установлена самостоятельно, даже если установлено расширение IaaS для SQL Server. При регистрации в поставщике ресурсов виртуальной машины SQL создается новый ресурс типа Microsoft. Склвиртуалмачине. При установке расширения IaaS для SQL Server этот ресурс не создается.

**Что такое режим управления по умолчанию при регистрации с помощью поставщика ресурсов виртуальной машины SQL?**

По умолчанию при регистрации с помощью поставщика ресурсов виртуальной машины SQL используется *режим полного управления*. Если свойство управления SQL Server не задано при регистрации с помощью поставщика ресурсов виртуальной машины SQL, будет установлен режим полного управления, а служба SQL Server будет перезапущена. Рекомендуется сначала зарегистрироваться с помощью поставщика ресурсов виртуальной машины SQL в упрощенном режиме, а затем выполнить обновление до полного режима в течение периода обслуживания. 

**Какие предварительные требования для регистрации с помощью поставщика ресурсов виртуальной машины SQL?**

Для регистрации в поставщике ресурсов виртуальной машины SQL в упрощенном или NoAgent режиме нет предварительных требований. Предварительное требование для регистрации с помощью поставщика ресурсов виртуальной машины SQL в полном режиме — наличие расширения IaaS для SQL Server, установленного на виртуальной машине (иначе служба SQL Server будет перезапущена). 

**Следует ли регистрироваться с помощью поставщика ресурсов виртуальной машины SQL, если на виртуальной машине еще не установлено расширение IaaS для SQL Server?**

Да, вы можете зарегистрироваться с помощью поставщика ресурсов виртуальной машины SQL в режиме упрощенного управления, если на виртуальной машине не установлено расширение IaaS для SQL Server. В упрощенном режиме поставщик ресурсов виртуальной машины SQL будет использовать консольное приложение для проверки версии и выпуска экземпляра SQL Server. 

По умолчанию при регистрации в поставщике ресурсов виртуальной машины SQL используется режим _полного управления_ SQL. Если свойство управления SQL не задано при регистрации с помощью поставщика ресурсов виртуальной машины SQL, то будет установлен режим полного управления. Рекомендуется сначала зарегистрироваться с помощью поставщика ресурсов виртуальной машины SQL в упрощенном режиме, а затем выполнить обновление до полного режима в течение периода обслуживания. 

**Будет ли установлен агент на мою виртуальную машину при регистрации с помощью поставщика ресурсов виртуальной машины SQL?**

Да, при регистрации в поставщике ресурсов виртуальной машины SQL на виртуальной машине будет установлен агент.

Расширение SQL Server IaaS использует агент для запроса метаданных SQL Server. Единственный момент, когда агент не установлен, — это то, что поставщик ресурсов виртуальной машины SQL регситеред в режиме "без агента".

**Будет ли регистрация с помощью SQL Server перезапуска поставщика ресурсов виртуальной машины SQL на моей виртуальной машине?**

Это зависит от режима, выбранного во время регистрации. Если указан режим NoAgent или упрощенный, то служба SQL Server не перезапустится. Однако если задать режим управления как полный или вообще не выбирать режим управления, то расширение IaaS для SQL будет установлено в режиме полного управления, что приведет к перезапуску службы SQL Server. 

**В чем разница между режимами управления NoAgent и упрощенным при регистрации с помощью поставщика ресурсов виртуальной машины SQL?** 

Режим управления NoAgent доступен только для SQL Server 2008 и SQL Server 2008 R2, установленных в Windows Server 2008. Это единственный доступный режим управления для этих версий. Для всех других версий SQL Server есть два доступных режима управления — упрощенный и полный. 

Для режима NoAgent требуется, чтобы свойства версии и выпуска SQL Server были заданы клиентом. Упрощенный режим запрашивает у виртуальной машины версию и выпуск экземпляра SQL Server.

**Можно ли выполнить регистрацию с помощью поставщика ресурсов виртуальной машины SQL, не указывая тип лицензии SQL Server?**

Нет. Тип лицензии SQL Server является обязательным свойством при регистрации в поставщике ресурсов виртуальной машины SQL. При регистрации в поставщике ресурсов виртуальной машины SQL необходимо задать тип лицензии SQL Server с оплатой по мере использования или Преимущество гибридного использования Azure во всех режимах управления (NoAgent, упрощенный и полный).

**Можно ли обновить расширение IaaS для SQL Server и перейти с режима NoAgent на полный?**

Нет. Вы не можете обновить режим управления NoAgent до полного или упрощенного. Это техническое ограничение Windows Server 2008. Необходимо сначала обновить ОС до Windows Server 2008 R2 или более поздней версии, после чего вы сможете выполнить обновление до режима полного управления. 

**Можно ли обновить расширение IaaS для SQL Server и перейти с упрощенного режима на полный?**

Да. Обновление режима управления с упрощенного на полный поддерживается с помощью PowerShell или портала Azure. Для этого необходимо перезапустить службу SQL Server.

**Можно ли понизить уровень расширения IaaS для SQL Server с полного на упрощенный режим управления или NoAgent?**

Нет. Понижение уровня режима управления расширения IaaS для SQL Server не поддерживается. Режим управления не может быть понижен с полного до упрощенного или до NoAgent, а также с упрощенного до NoAgent. 

Чтобы изменить режим управляемости с полной управляемости, [Отмените регистрацию](#unregister-from-rp) SQL Server виртуальной машины в поставщике ресурсов ВИРТУАЛЬНОЙ машины SQL, удалив *ресурс* SQL Server и повторно ЗАрегистрируйте SQL Serverную виртуальную машину с помощью поставщика ресурсов виртуальной машины SQL в другом режиме управления.

**Можно ли зарегистрироваться с помощью поставщика ресурсов виртуальной машины SQL на портале Azure?**

Нет. Регистрация с помощью поставщика ресурсов виртуальной машины SQL на портале Azure недоступна. Регистрация с помощью поставщика ресурсов виртуальной машины SQL поддерживается только с помощью Azure CLI или PowerShell. 

**Можно ли зарегистрировать виртуальную машину с помощью поставщика ресурсов виртуальной машины SQL перед установкой SQL Server?**

Нет. Виртуальная машина должна иметь хотя бы один экземпляр SQL Server (ядро СУБД) для успешной регистрации с помощью поставщика ресурсов виртуальной машины SQL. Если на виртуальной машине нет экземпляра SQL Server, новый ресурс Microsoft.SqlVirtualMachine будет находиться в состоянии сбоя.

**Можно ли зарегистрировать виртуальную машину с помощью поставщика ресурсов виртуальной машины SQL, если имеется несколько экземпляров SQL Server?**

Да. Поставщик ресурсов виртуальной машины SQL будет регистрировать только один экземпляр SQL Server (ядро СУБД). Поставщик ресурсов виртуальной машины SQL будет регистрировать экземпляр SQL Server по умолчанию, если имеется несколько экземпляров. Если экземпляр по умолчанию отсутствует, то поддерживается только регистрация в упрощенном режиме. Чтобы выполнить обновление с упрощенного на полный режим управления, должен существовать либо экземпляр SQL Server по умолчанию, либо виртуальная машина должна иметь только один именованный экземпляр SQL Server.

**Можно ли зарегистрировать экземпляр отказоустойчивого кластера SQL Server с помощью поставщика ресурсов виртуальной машины SQL?**

Да. Экземпляры отказоустойчивого кластера SQL Server можно зарегистрировать с помощью поставщика ресурсов виртуальной машины SQL в упрощенном режиме. Однако экземпляры отказоустойчивого кластера SQL Server нельзя обновить до режима полного управления.

**Можно ли зарегистрировать виртуальную машину с помощью поставщика ресурсов виртуальной машины SQL, если настроена группа доступности Always On?**

Да. Для регистрации экземпляра SQL Server на виртуальной машине Azure с помощью поставщика ресурсов виртуальной машины SQL нет никаких ограничений, если вы участвуете в конфигурации группы доступности Always On.

**Какова стоимость регистрации с помощью поставщика ресурсов виртуальной машины SQL или обновления до режима полного управления?**
Нет. При регистрации с помощью поставщика ресурсов виртуальной машины SQL или использовании любого из трех режимов управления плата не взимается. Управление виртуальной машиной SQL Server с помощью поставщика ресурсов полностью бесплатное. 

**Как сказывается на производительности использование различных режимов управления?**
Использование *упрощенного* режима управления и *NoAgent* не влияет на производительность. При использовании режима *полного* управления есть минимальное влияние двух служб, установленных в операционной системе. Их можно отслеживать с помощью диспетчера задач и просматривать во встроенной консоли служб Windows. 

Имена этих двух служб:
- `SqlIaaSExtensionQuery` (отображаемое имя — `Microsoft SQL Server IaaS Query Service`);
- `SQLIaaSExtension` (отображаемое имя — `Microsoft SQL Server IaaS Agent`).


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих статьях: 

* [Обзор SQL Server на виртуальных машинах Windows](sql-server-on-azure-vm-iaas-what-is-overview.md).
* [Вопросы и ответы об SQL Server на виртуальных машинах Windows](frequently-asked-questions-faq.md)  
* [Руководство по ценам для виртуальных машин SQL Server в Azure](pricing-guidance.md)
* [Заметки о выпуске SQL Server на виртуальных машинах Windows](../../database/doc-changes-updates-release-notes.md)
