---
title: Рекомендации по оптимизации производительности SQL Server в Azure | Документация Майкрософт
description: Содержит рекомендации по оптимизации производительности SQL Server в Виртуальные машины Microsoft Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
editor: ''
tags: azure-service-management
ms.assetid: a0c85092-2113-4982-b73a-4e80160bac36
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 10/18/2019
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 56bf60eb3d80352a98025627cd448ef304f9a153
ms.sourcegitcommit: 271601d3eeeb9422e36353d32d57bd6e331f4d7b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/20/2020
ms.locfileid: "88654180"
---
# <a name="performance-guidelines-for-sql-server-on-azure-virtual-machines"></a>Рекомендации по производительности для SQL Server на виртуальных машинах Azure
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье приводятся рекомендации по оптимизации производительности SQL Server в Виртуальные машины Microsoft Azure.

## <a name="overview"></a>Обзор

 При запуске SQL Server на виртуальных машинах Azure рекомендуется продолжать использовать те же параметры настройки производительности базы данных, которые применяются для SQL Server в локальных серверных средах. Однако производительность реляционной базы данных в общедоступном облаке зависит от многих факторов, таких как размер виртуальной машины и конфигурации дисков с данными.

[SQL Server образы, подготовленные в портал Azure](sql-vm-create-portal-quickstart.md) следовать рекомендациям по общей конфигурации хранилища (Дополнительные сведения о настройке хранилища см. в статье [Конфигурация хранилища для виртуальных машин SQL Server](storage-configuration.md)). Завершив подготовку обдумайте, нужно ли применить другие виды оптимизации, описанные в этой статье. При принятии решений учитывайте характер рабочих нагрузок, а затем проверьте выбор путем тестирования.

> [!TIP]
> Как правило, существует компромисс между оптимизацией затрат и оптимизацией производительности. Эта статья посвящена *повышению производительности* SQL Server на виртуальных машинах Azure. Если рабочая нагрузка не так велика, могут потребоваться не все перечисленные ниже оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности, затраты и характер рабочих нагрузок.

## <a name="quick-checklist"></a>Краткий контрольный список

Ниже приведен краткий контрольный список для достижения оптимальной производительности SQL Server на виртуальных машинах Azure.

| Область | Оптимизация |
| --- | --- |
| [Размер виртуальной машины](#vm-size-guidance) | – Используйте размеры виртуальных машин с 4 или более виртуальными ЦП, например [E4S_v3](../../../virtual-machines/ev3-esv3-series.md) и более мощные или [DS12_v2](../../../virtual-machines/dv2-dsv2-series-memory.md) и более мощные.<br/><br/> - Виртуальные машины [серий Es, Eas, Ds и Das](../../../virtual-machines/sizes-general.md) обеспечивают оптимальное соотношение памяти и виртуальных ЦП, необходимое для выполнения рабочих нагрузок OLTP. <br/><br/> - Виртуальные машины [серии M](../../../virtual-machines/m-series.md) обеспечивают наивысшее соотношение объема памяти и виртуальных ЦП, необходимое для обеспечения критической производительности, и идеально подходят для рабочих нагрузок хранилища данных. <br/><br/> – Соберите данные о требованиях к [скорости операций ввода-вывода](../../../virtual-machines/windows/premium-storage-performance.md#iops), [пропускной способности](../../../virtual-machines/windows/premium-storage-performance.md#throughput) и [задержке](../../../virtual-machines/windows/premium-storage-performance.md#latency) в часы пик для целевой рабочей нагрузки с помощью [контрольного списка требований к производительности приложений](../../../virtual-machines/windows/premium-storage-performance.md#application-performance-requirements-checklist), а затем выберите такой [размер виртуальной машины](../../../virtual-machines/sizes-general.md), чтобы она могла масштабироваться в соответствии с требованиями к производительности вашей рабочей нагрузки.|
| [Память](#storage-guidance) | — Для подробного тестирования SQL Server производительности виртуальных машин Azure с помощью TPC-E и TPC_Cных тестов производительности см. в блоге [оптимизировать производительность OLTP](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794). <br/><br/> – Используйте [диски SSD ценовой категории "Премиум"](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794), чтобы обеспечить лучшее соотношение цены и производительности. Настройте [кэш со значением ReadOnly (только для чтения)](../../../virtual-machines/windows/premium-storage-performance.md#disk-caching) для файлов данных и не задавайте кэш для файлов журналов. <br/><br/> – Используйте [диски ценовой категории "Ультра"](../../../virtual-machines/disks-types.md#ultra-disk), если для рабочей нагрузки требуется задержка к хранилищу менее 1 мс. Дополнительные сведения см. в статье [Переход на Ultra Disk](storage-migrate-to-ultradisk.md) . <br/><br/> – Соберите данные о требованиях к задержке при обращении к хранилищу для файлов данных SQL Server, журналов и базы данных TempDB, [выполнив мониторинг приложения](../../../virtual-machines/windows/premium-storage-performance.md#application-performance-requirements-checklist), прежде чем выбирать тип диска. Если при обращении к хранилищу требуется задержка менее 1 мс, используйте диски ценовой категории "Ультра". В противном случае используйте SSD ценовой категории "Премиум". Если низкая задержка требуется только для файлов журналов, но не для файлов данных, [подготовьте диски ценовой категории "Ультра"](../../../virtual-machines/disks-enable-ultra-ssd.md) с нужными уровнями пропускной способности и скорости ввода-вывода только для файлов журналов. <br/><br/> -  [Общие файловые ресурсы](failover-cluster-instance-premium-file-share-manually-configure.md) уровня "Премиум" рекомендуется использовать в качестве общего хранилища для экземпляра отказоустойчивого кластера SQL Server. Общие папки ценовой категории "Премиум" не поддерживают кэширование и имеют ограниченную производительность по сравнению с дисками SSD ценовой категории "Премиум". Выберите управляемые диски SSD ценовой категории "Премиум", а не общие папки ценовой категории "Премиум", для изолированных экземпляров SQL. Используйте общие папки ценовой категории "Премиум" для общедоступного хранилища с экземпляром отказоустойчивого кластера, чтобы упростить обслуживание и повысить гибкость масштабирования. <br/><br/> – Служба хранилища ценовой категории "Стандартный" рекомендуется только для разработки и тестирования, а также для хранения файлов резервных копий. Она не должна использоваться для производственных рабочих нагрузок. <br/><br/> Храните [учетную запись хранения](../../../storage/common/storage-create-storage-account.md) и виртуальную машину SQL Server в одном и том же регионе.<br/><br/> – Отключите [геоизбыточное хранилище](../../../storage/common/storage-redundancy.md) (георепликацию) Azure в учетной записи хранения.  |
| [диски;](#disks-guidance) | – Используйте как минимум 2 [диска SSD ценовой категории "Премиум"](../../../virtual-machines/disks-types.md#premium-ssd) (1 для файлов журнала и 1 для файлов данных). <br/><br/> – Для рабочих нагрузок, которым требуется задержка ввода-вывода на уровне менее 1 мс, включите ускоритель записи на виртуальных машинах серии M. Для серий Es и DS в таких случаях мы рекомендуем использовать диски SSD ценовой категории "Ультра". <br/><br/> – Включите [кэширование операций чтения](../../../virtual-machines/windows/premium-storage-performance.md#disk-caching) на дисках, где размещаются файлы данных.<br/><br/> — Добавьте дополнительные 20% операций ввода-вывода или пропускной способности уровня "Премиум", чем требуется рабочей нагрузки при [настройке хранилища для SQL Server файлов данных, журналов и tempdb](storage-configuration.md) . <br/><br/> Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br/><br/> Не включайте кэширование на дисках, где находится файл журнала.  **Важно!** при изменении параметров кэша для диска виртуальных машин Azure следует прекращать работу службы SQL Server.<br/><br/> – Обеспечьте чередование нескольких дисков данных Azure для увеличения пропускной способности хранилища.<br/><br/> Выполняйте форматирование с использованием задокументированных размеров кластеров. <br/><br/> – Разместите базу данных TempDB на локальном диске SSD `D:\` для критически важных рабочих нагрузок SQL Server (выбрав правильный размер виртуальной машины). Если вы создаете виртуальную машину из шаблонов быстрого запуска портал Azure или Azure и [размещаете временную базу данных на локальном диске](https://techcommunity.microsoft.com/t5/SQL-Server/Announcing-Performance-Optimized-Storage-Configuration-for-SQL/ba-p/891583) , дальнейшие действия не требуются. во всех остальных случаях выполните действия в блоге, чтобы  [использовать SSDS для хранения базы данных tempdb](https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/) , чтобы предотвратить сбои после перезагрузки. Если емкости локального диска недостаточно для размещения TempDB, разместите эту базу данных в пуле носителей, созданном путем [чередования](../../../virtual-machines/windows/premium-storage-performance.md) дисков SSD ценовой категории "Премиум" с [кэшированием только для чтения](../../../virtual-machines/windows/premium-storage-performance.md#disk-caching). |
| [ВВОД-ВЫВОД](#io-guidance) |Включите сжатие страниц базы данных.<br/><br/> Включите быструю инициализацию для файлов данных.<br/><br/> Ограничьте авторасширение базы данных.<br/><br/> Отключите автосжатие базы данных.<br/><br/> Переместите все базы данных на диски с данными, включая системные базы данных.<br/><br/> Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски данных.<br/><br/> – Настройте расположения по умолчанию для файлов резервных копий и базы данных.<br/><br/> - [Включите блокировку страниц в памяти.](/sql/database-engine/configure-windows/enable-the-lock-pages-in-memory-option-windows?view=sql-server-2017)<br/><br/> Примените исправления производительности SQL Server. |
| [Характерные особенности компонента](#feature-specific-guidance) | — Резервное копирование непосредственно в хранилище BLOB-объектов Azure.<br/><br/>– Используйте [резервные копии моментальных снимков файлов](/sql/relational-databases/backup-restore/file-snapshot-backups-for-database-files-in-azure) для баз данных размером более 12 ТБ. <br/><br/>– Используйте несколько файлов TempDB (1 файл на ядро, до 8 файлов).<br/><br/>– Задайте максимальный объем памяти сервера на уровне 90 % или оставьте до 50 ГБ для операционной системы. <br/><br/>– Включите программную архитектуру NUMA. |

Дополнительные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в подробных сведениях и руководствах, предоставленных в следующих разделах.

## <a name="vm-size-guidance"></a>Рекомендации по выбору размеров виртуальных машин

Начните со сбора данных о требованиях к ЦП, памяти и пропускной способности хранилища для рабочих нагрузок в пиковое время. Счетчики производительности \LogicalDisk\Disk Reads/Sec и \LogicalDisk\Disk Writes/Sec можно использовать для сбора данных о требованиях к скорости операций ввода-вывода при записи, а счетчик \LogicalDisk\Disk Bytes/Sec — для сбора данных о [требованиях к пропускной способности хранилища](../../../virtual-machines/windows/premium-storage-performance.md#disk-caching) для файлов данных, журналов и TempDB. Определив требования к скорости операций ввода-вывода и пропускной способности, оцените размеры виртуальных машин, которые смогут удовлетворить их. Например, если в пиковое время рабочей нагрузке требуется выполнять 20 тыс. операций ввода-вывода в секунду при чтении и 10 тыс. операций ввода-вывода в секунду при записи, вы можете выбрать размер E16s_v3 (с до 32 тыс кэшированных и 25 600 некэшированных операций ввода-вывода в секунду) или M16_s (с до 20 тыс. кэшированных и 10 тыс. некэшированных операций ввода-вывода в секунду) с 2 дисками P30. Обязательно определите требования к пропускной способности и скорости операций ввода-вывода для рабочей нагрузки, так как виртуальные машины имеют разные пределы масштабирования для этих показателей.<br/><br/>Виртуальные машины серий [DSv_3](../../../virtual-machines/dv3-dsv3-series.md) и [Es_v3](../../../virtual-machines/ev3-esv3-series.md) размещаются на оборудовании общего назначения с процессорами Intel Haswell или Broadwell. Виртуальные машины [серии M](../../../virtual-machines/m-series.md) имеют самое большое число виртуальных ЦП и объем памяти для крупнейших рабочих нагрузок SQL Server. Они размещаются на оптимизированном для операций с памятью оборудовании с процессорами Skylake. Такие виртуальные машины поддерживают хранилище класса Premium, которое рекомендуется для обеспечения наилучшей производительности с кэшем чтения на уровне узла. Как Es_v3, так и серии M также доступны в [ограниченном размере ядра](../../../virtual-machines/windows/constrained-vcpu.md), что экономит деньги на рабочих нагрузках с более низкими требованиями к объему вычислений и высокой емкости хранилища. 

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Подробное тестирование производительности SQL Server на виртуальных машинах Azure с помощью TPC-E и TPC_Cных тестов см. в блоге [Оптимизация производительности OLTP](https://techcommunity.microsoft.com/t5/SQL-Server/Optimize-OLTP-Performance-with-SQL-Server-on-Azure-VM/ba-p/916794). 

Для всех производственных рабочих нагрузок мы рекомендуем использовать кэш BLOB-объектов Azure с дисками SSD ценовой категории "Премиум". 

> [!WARNING]
> HDD и SSD (цен. категория "Стандартный") характеризуются различными задержками и пропускной способностью и рекомендуется только для рабочих нагрузок по разработке и тестированию. Для производственных рабочих нагрузок необходимо использовать SSD (цен. категория "Премиум").

Кроме того, рекомендуется создать свою учетную запись хранения Azure в одном центре обработки данных с виртуальными машинами SQL Server для уменьшения задержек при передаче данных. При создании учетной записи хранения отключите георепликацию, поскольку согласованный порядок записи на несколько дисков не гарантируется. Вместо этого рекомендуется реализовать средства аварийного восстановления SQL Server между двумя центрами обработки данных Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](business-continuity-high-availability-disaster-recovery-hadr-overview.md).

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

На виртуальных машинах Azure есть три основных типа дисков:

* **Диск ОС**. при создании виртуальной машины Azure платформа присоединяет по крайней мере один диск (помеченный как диск **C** ) к виртуальной машине для диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.
* **Временный диск**: виртуальные машины Azure содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.
* **Диски данных**: Вы также можете присоединить к виртуальной машине дополнительные диски, например диски данных, и они также будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это VHD, который можно загружать и подключать в качестве работающей версии операционной системы и помечен как диск **C** .

По умолчанию для диска операционной системы применяется политика кэширования **Чтение и запись**. Для приложений, чувствительных к уровню производительности, рекомендуется использовать диски данных вместо диска операционной системы. См. подраздел "Диски данных" ниже.

### <a name="temporary-disk"></a>Временный диск

Временный диск хранилища, помеченный как диск **D** , не сохраняется в хранилище BLOB-объектов Azure. Не храните файлы пользовательской базы данных или файлы журнала транзакций пользователя на диске **D**.

Разместите базу данных TempDB на локальном диске SSD `D:\` для критически важных рабочих нагрузок SQL Server (выбрав правильный размер виртуальной машины). Если вы создаете виртуальную машину из шаблонов быстрого запуска портал Azure или Azure и [размещаете временную базу данных на локальном диске](https://techcommunity.microsoft.com/t5/SQL-Server/Announcing-Performance-Optimized-Storage-Configuration-for-SQL/ba-p/891583), дальнейшие действия не требуются. во всех остальных случаях выполните действия в блоге, чтобы  [использовать SSDS для хранения базы данных tempdb](https://cloudblogs.microsoft.com/sqlserver/2014/09/25/using-ssds-in-azure-vms-to-store-sql-server-tempdb-and-buffer-pool-extensions/) , чтобы предотвратить сбои после перезагрузки. Если емкости локального диска недостаточно для размещения TempDB, разместите эту базу данных в пуле носителей, созданном путем [чередования](../../../virtual-machines/windows/premium-storage-performance.md) дисков SSD ценовой категории "Премиум" с [кэшированием только для чтения](../../../virtual-machines/windows/premium-storage-performance.md#disk-caching).

Для виртуальных машин, которые поддерживают диски SSD ценовой категории "Премиум", базу данных TempDB можно разместить на диске с поддержкой дисков SSD ценовой категории "Премиум" с включенным кэшированием чтения.


### <a name="data-disks"></a>Диски данных

* **Используйте диски SSD ценовой категории "Премиум" для файлов данных и журналов.** Если вы не применяете чередование дисков, используйте два диска SSD ценовой категории "Премиум", где один диск содержит файлы журналов, а другой — файлы данных. Каждый SSD ценовой категории "Премиум" обеспечивает определенное количество операций ввода-вывода в секунду и пропускную способность (МБ/с) в зависимости от своего размера, как описано в [этой статье](../../../virtual-machines/disks-types.md). При использовании метода чередования дисков, например дискового пространства, можно достичь оптимальной производительности, имея два пула: один для файлов журнала, а другой для файлов данных. Но если вы планируете использовать экземпляры отказоустойчивого кластера (FCI) SQL Server, необходимо настроить один пул или использовать [общие папки ценовой категории "Премиум"](failover-cluster-instance-premium-file-share-manually-configure.md).

   > [!TIP]
   > - Результаты тестирования различных конфигураций дисков и рабочих нагрузок см. в следующей записи блога: [рекомендации по настройке хранилища для SQL Server на виртуальных машинах Azure](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2018/09/25/storage-configuration-guidelines-for-sql-server-on-azure-vm/).
   > - Чтобы обеспечить надежную работу критически важных серверов SQL Server, для которых требуется порядка 50 000 операций ввода-вывода в секунду, рассмотрите возможность замены дисков P10–P30 дисками SSD (цен. категория "Ультра"). Дополнительные сведения доступны в этой записи блога: [Mission critical performance with Ultra SSD](https://azure.microsoft.com/blog/mission-critical-performance-with-ultra-ssd-for-sql-server-on-azure-vm/) (Выполнение критически важных операций с помощью дисков SSD (цен. категория "Ультра")).

   > [!NOTE]
   > При подготовке виртуальной машины SQL Server на портале у вас есть возможность изменить конфигурацию хранилища. В зависимости от конфигурации Azure настраивает один или несколько дисков. Несколько дисков объединяются в единый пул хранилищ с чередованием. Файлы данных и журналов совместно размещаются в этой конфигурации. Дополнительные сведения см. в статье [Настройка хранилища для виртуальных машин SQL Server](storage-configuration.md).

* **Чередование дисков**. для большей пропускной способности можно добавить дополнительные диски данных и использовать чередование дисков. Чтобы определить количество дисков данных, необходимо проанализировать количество операций ввода-вывода в секунду и пропускную способность, необходимые для ваших файлов журналов, файлов данных и tempdb. Обратите внимание, что разные размеры виртуальной машины накладывают разные ограничения на количество операций ввода-вывода в секунду и пропускную способность. Ознакомьтесь с таблицами зависимости количества операций ввода-вывода в секунду от [размера виртуальной машины](../../../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Придерживайтесь приведенных ниже рекомендаций.

  * Для Windows 8 и Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://technet.microsoft.com/library/hh831739.aspx), придерживаясь приведенных ниже рекомендаций.

      1. Задайте для чередования значение 64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262 144 байт) для рабочих нагрузок хранилища данных, чтобы избежать снижения производительности из-за рассогласования разделов. Это следует сделать в PowerShell.
      2. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более 8 дисков. 

    Например, следующая оболочка PowerShell создает новый пул носителей с размером чередования в 64 КБ и число столбцов, равное количеству физических дисков в пуле носителей:

    ```powershell
    $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}
    
    New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" `
        -PhysicalDisks $PhysicalDisks | New- VirtualDisk -FriendlyName "DataFiles" `
        -Interleave 65536 -NumberOfColumns $PhysicalDisks .Count -ResiliencySettingName simple `
        –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter `
        -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" `
        -AllocationUnitSize 65536 -Confirm:$false 
    ```

  * Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы), при этом размер чередования всегда составляет 64 КБ. Эта возможность не поддерживается в Windows 8 и Windows Server 2012. Дополнительные сведения см. в заявлении о поддержке в статье [Virtual Disk Service is transitioning to Windows Storage Management API](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx) (Служба виртуальных дисков переходит на API управления хранилищами Windows).

  * Если вы используете [локальные дисковые пространства (S2D)](/windows-server/storage/storage-spaces/storage-spaces-direct-in-vm) с [экземплярами отказоустойчивого кластера SQL Server](failover-cluster-instance-storage-spaces-direct-manually-configure.md), вам нужно настроить единый пул. Хотя в этом пуле можно создать тома с разной емкостью, они будут иметь общую характеристику, например одну политику кэширования.

  * Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в статье [размеры виртуальных машин](../../../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

  * Если вы не используете твердотельные накопители уровня "Премиум" (сценарии разработки и тестирования), рекомендуется добавить максимальное число дисков данных, поддерживаемое [размером виртуальной машины](../../../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) , и использовать чередование дисков.

* **Политика кэширования**: изучите предложенные ниже рекомендации по выбору политики кэширования в зависимости от конфигурации хранилища.

  * Если вы используете отдельные диски для файлов данных и файлов журналов, включите кэширование операций чтения только на дисках с файлами данных и файлами TempDB. Это позволит существенно повысить производительность. Не включайте кэширование для диска, где хранятся файлы журналов, так как это немного снижает производительность.

  * Если вы используете чередование дисков в едином пуле хранилища, для большинства рабочих нагрузок кэширование операций чтения повысит производительность. Если у вас есть отдельные пулы хранения для файлов журнала и данных, включите кэширование чтения только в пуле хранения для файлов данных. Для некоторых рабочих нагрузок с операциями записи большого объема данных можно повысить производительность, отключив кэширование. Точные данные можно получить только путем тестирования.

  * Все описанные выше рекомендации относятся к SSD (цен. категория "Премиум"). Если SSD (цен. категория "Премиум") не используется, не включайте кэширование ни для каких дисков данных.

  * Инструкции по настройке кэширования дисков см. в указанных ниже статьях. Для классической модели развертывания (ASM) изучите: [Set-AzureOSDisk](https://msdn.microsoft.com/library/azure/jj152847) и [Set-AzureDataDisk](https://msdn.microsoft.com/library/azure/jj152851.aspx). Для модели развертывания Azure Resource Manager изучите следующие ресурсы: [Set-AzOSDisk](https://docs.microsoft.com/powershell/module/az.compute/set-azvmosdisk) и [Set-AzVMDataDisk](https://docs.microsoft.com/powershell/module/az.compute/set-azvmdatadisk).

     > [!WARNING]
     > При изменении параметра кэша для дисков виртуальных машин Azure следует отключить службу SQL Server, чтобы избежать возможного повреждения базы данных.

* **Размер единицы размещения NTFS**: При форматировании диска с данными мы советуем использовать размер единицы размещения 64 КБ для файлов данных и журналов, а также TempDB. Если база данных TempDB размещена на временном диске (D:\), производительность, обеспечиваемая таким диском, позволяет отказаться от использования размера единицы размещения в 64 КБ. 

* **Рекомендации по управлению дисками**: при удалении диска данных или изменении его типа кэша остановите службу SQL Server. При изменении параметров кэширования диска ОС Azure останавливает виртуальную машину, изменяет тип кэша и перезапускает виртуальную машину. При изменении параметров кэша диска данных виртуальная машина не останавливается. Диск данных отключается от нее на время внесения изменений, а затем снова подключается к виртуальной машине.

  > [!WARNING]
  > Если не останавливать службу SQL Server на время таких операций, это может привести к повреждению базы данных.


## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

* Наилучшие результаты работы с SSD (цен. категория "Премиум") достигаются при параллелизации приложений и запросов. SSD (цен. категория "Премиум") предназначено для сценариев, где глубина очереди ввода-вывода больше 1, поэтому прирост производительности для однопоточных последовательных запросов почти не ощущается (даже если они направляются в хранилище в большом объеме). Например, это может негативно повлиять на результаты однопоточного тестирования в средствах анализа производительности, таких как SQLIO.

* Рекомендуется использовать [сжатие страниц базы данных](https://msdn.microsoft.com/library/cc280449.aspx) , так как это позволяет повысить производительность рабочих нагрузок с большим объемом операций ввода-вывода. Однако сжатие данных может повысить потребление ресурсов ЦП на сервере базы данных.

* Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте SE_MANAGE_VOLUME_NAME учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, то учетная запись службы по умолчанию (NT Service\MSSQLSERVER) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в разделе [Инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).

* Имейте в виду, что **автоувеличение** считается просто случайом для непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании авторасширения предварительно увеличьте размер файла с помощью параметра размера.

* Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.

* Переместите все базы данных на диски с данными, включая системные базы данных. Дополнительные сведения см. в статье [Перемещение системных баз данных](https://msdn.microsoft.com/library/ms345408.aspx).

* Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными. Для этого в диспетчере конфигурации SQL Server щелкните правой кнопкой мыши свой экземпляр SQL Server и выберите пункт "Свойства". На вкладке **Параметры запуска** можно изменить параметры файлов трассировки и журнала ошибок. Каталог дампа указан на вкладке **Дополнительно** . На приведенных далее снимках экрана показано, где находится параметр запуска журнала ошибок.

    ![Снимок экрана SQL ErrorLog](./media/performance-guidelines-best-practices/sql_server_error_log_location.png)

* Настройте резервное копирование и расположение файлов базы данных по умолчанию. Следуйте рекомендациям в этой статье и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журнала (среда SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). На следующем снимке экрана показано, где нужно внести необходимые изменения.

    ![Файлы журнала данных SQL и резервных копий](./media/performance-guidelines-best-practices/sql_server_default_data_log_backup_locations.png)
* Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра «Блокировка страниц в памяти» (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

* Если вы используете SQL Server 2012, установите накопительный пакет обновления 10 для пакета обновления 1. Это обновление содержит исправление для низкой производительности ввода-вывода при выполнении оператора выборки во временную таблицу в SQL Server 2012. Дополнительные сведения см. в этой [статье базы знаний](https://support.microsoft.com/kb/2958012).

* Рекомендуется сжимать файлы данных при их передаче в среду Azure и из нее.

## <a name="feature-specific-guidance"></a>Обзор конкретных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

### <a name="back-up-to-azure-storage"></a>Резервное копирование в службу хранилища Azure
При выполнении резервного копирования для SQL Server, выполняющихся на виртуальных машинах Azure, можно использовать [SQL Server резервное копирование на URL-адрес](https://msdn.microsoft.com/library/dn435916.aspx). Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных. При резервном копировании и восстановлении в хранилище Azure или из него следуйте рекомендациям, приведенным в [статье SQL Server Backup to URL, рекомендации и устранение неполадок и восстановление из резервных копий, хранящихся в службе хранилища Azure](https://msdn.microsoft.com/library/jj919149.aspx). Вы также можете автоматизировать эти резервные копии, используя [автоматическую архивацию для SQL Server на виртуальных машинах Azure](../../../azure-sql/virtual-machines/windows/automated-backup-sql-2014.md).

В выпусках, предшествующих SQL Server 2012, можно использовать [инструмент архивации SQL Server в Azure](https://www.microsoft.com/download/details.aspx?id=40740). Это средство может помочь повысить пропускную способность при архивации благодаря использованию нескольких чередующихся целей архивации.

### <a name="sql-server-data-files-in-azure"></a>Файлы данных SQL Server в Azure

эта новая функция, [Файлы данных SQL Server в Microsoft Azure](https://msdn.microsoft.com/library/dn385720.aspx), доступна, начиная с SQL Server 2014. Выполнение SQL Server с файлами данных в Azure демонстрирует уровень производительности, сравнимый с использованием дисков данных Azure.

### <a name="failover-cluster-instance-and-storage-spaces"></a>Экземпляр отказоустойчивого кластера и дисковые пространства

Если при добавлении узлов в кластер на странице **подтверждения** используются дисковые пространства, снимите флажок **Добавить все подходящие хранилища в кластер**. 

![Снятие флажка для допустимого хранилища](./media/performance-guidelines-best-practices/uncheck-eligible-cluster-storage.png)

Если вы используете дисковые пространства и не сняли флажок **Добавление всех допустимых хранилищ в кластер**, то Windows отключит виртуальные диски во время процесса кластеризации. Как следствие, они не отобразятся в диспетчере дисков или Explorer, пока дисковые пространства не будут удалены из кластера и повторно подключены с помощью PowerShell. Дисковые пространства группируют несколько дисков в пулы носителей. Дополнительные сведения см. в статье [Обзор дисковых пространств](/windows-server/storage/storage-spaces/overview).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о хранении и производительности см. [в статье рекомендации по настройке хранилища для SQL Server на виртуальных машинах Azure](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2018/09/25/storage-configuration-guidelines-for-sql-server-on-azure-vm/) .

Рекомендации по обеспечению безопасности см. [в статье вопросы безопасности SQL Server на виртуальных машинах Azure](security-considerations-best-practices.md).

Ознакомьтесь с другими статьями, посвященными виртуальным машинам SQL Server, используя руководство с [обзором SQL Server на виртуальных машинах с Windows](sql-server-on-azure-vm-iaas-what-is-overview.md). Если у вас есть вопросы по виртуальным машинам SQL Server, см. раздел [часто задаваемых вопросов](frequently-asked-questions-faq.md).
