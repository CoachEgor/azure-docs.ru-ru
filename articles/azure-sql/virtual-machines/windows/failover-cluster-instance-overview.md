---
title: Экземпляры отказоустойчивого кластера
description: Сведения об экземплярах отказоустойчивого кластера (FCI) с SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.service: virtual-machines-sql
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.openlocfilehash: 8a5374bf15798fd7e53f0d93e69f2f40a2d57b94
ms.sourcegitcommit: 3d56d25d9cf9d3d42600db3e9364a5730e80fa4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/03/2020
ms.locfileid: "87533824"
---
# <a name="failover-cluster-instances-with-sql-server-on-azure-virtual-machines"></a>Экземпляры отказоустойчивого кластера с SQL Server на виртуальных машинах Azure
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье рассматриваются различия в функциях при работе с экземплярами отказоустойчивого кластера (FCI) для SQL Server на виртуальных машинах Azure. 

## <a name="overview"></a>Обзор

SQL Server на виртуальных машинах Azure использует функции отказоустойчивой кластеризации Windows Server (WSFC), чтобы обеспечить локальную высокую доступность с помощью избыточности на уровне экземпляра сервера: экземпляр отказоустойчивого кластера. FCI — это единственный экземпляр SQL Server, который устанавливается между узлами WSFC (или просто кластером) и, возможно, между несколькими подсетями. В сети FCI является экземпляром SQL Server, выполняющимся на одном компьютере. Но FCI обеспечивает отработку отказа с одного узла WSFC на другой, если текущий узел становится недоступным.

Оставшаяся часть статьи посвящена различиям между экземплярами отказоустойчивого кластера, когда они используются с SQL Server на виртуальных машинах Azure. Дополнительные сведения о технологии отказоустойчивой кластеризации см. в следующих статьях: 

- [технологии кластера под управлением Windows](https://docs.microsoft.com/windows-server/failover-clustering/failover-clustering-overview);
- [Экземпляры отказоустойчивого кластера SQL Server](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

## <a name="quorum"></a>Кворум

Экземпляры отказоустойчивого кластера с SQL Server на виртуальных машинах Azure поддерживают использование диска-свидетеля, облака-свидетеля или файлового ресурса-свидетеля для кворума кластера.

Дополнительные сведения см. в статье рекомендации [по кворуму с помощью SQL Server виртуальных машин в Azure](hadr-cluster-best-practices.md#quorum). 


## <a name="storage"></a>Хранение

В традиционных локальных кластеризованных средах отказоустойчивый кластер Windows использует сеть хранения данных (SAN), доступную для обоих узлов в качестве общего хранилища. SQL Server файлы размещаются в общем хранилище, и только активный узел может одновременно получить доступ к файлам. 

SQL Server на виртуальных машинах Azure предлагает различные варианты в качестве решения общего хранилища для развертывания экземпляров отказоустойчивого кластера SQL Server. 

||[Общие диски Azure](../../../virtual-machines/windows/disks-shared.md)|[Общие файловые ресурсы уровня "Премиум"](../../../storage/files/storage-how-to-create-premium-fileshare.md) |[Локальные дисковые пространства (S2D)](/windows-server/storage/storage-spaces/storage-spaces-direct-overview)|
|---------|---------|---------|---------|
|**Минимальная версия ОС**| Все |Windows Server 2012|Windows Server 2016|
|**Минимальная версия SQL Server**|Все|SQL Server 2012|SQL Server 2016|
|**Поддерживаемая доступность виртуальной машины** |Группы доступности с группами размещения с учетом расположения |Группы доступности и зоны доступности|Группы доступности |
|**Поддержка FileStream**|да|Нет|да |
|**Кэш больших двоичных объектов Azure**|Нет|Нет|да|

В оставшейся части этого раздела перечислены преимущества и ограничения для каждого из вариантов хранения, доступных для SQL Server на виртуальных машинах Azure. 

### <a name="azure-shared-disks"></a>Общие диски Azure

[Общие диски Azure](../../../virtual-machines/windows/disks-shared.md) — это функция [управляемых дисков Azure](../../../virtual-machines/windows/managed-disks-overview.md). Отказоустойчивая кластеризация Windows Server поддерживает использование общих дисков Azure с экземпляром отказоустойчивого кластера. 

**Поддерживаемая ОС**: все   
**Поддерживаемая версия SQL**: все     

**Преимущества**: 
- Полезно для приложений, предназначенных для миграции в Azure с сохранением архитектуры высокого уровня доступности и аварийного восстановления (HADR) как есть. 
- Может выполнять миграцию кластерных приложений в Azure в связи с поддержкой постоянных резервирований SCSI (SCSI PR). 
- Поддерживает общие SSD (цен. категория "Премиум") Azure для всех версий SQL Server и Azure Ultra Хранилище дисков Shared для SQL Server 2019. 
- Для создания общего пула носителей можно использовать один общий диск или несколько чередующихся общих дисков. 
- Поддерживает FILESTREAM.


**Ограничения**. 
- Виртуальные машины должны быть помещены в одну группу доступности и группы размещения с близкой назначением.
- Зоны доступности не поддерживаются.
- SSD (цен. категория "Премиум") кэширование диска не поддерживается.
 
Чтобы приступить к работе, см. статью [SQL Server экземпляр отказоустойчивого кластера с общими дисками Azure](failover-cluster-instance-azure-shared-disks-manually-configure.md). 

### <a name="storage-spaces-direct"></a>Локальные дисковые пространства

[Локальные дисковые пространства](/windows-server/storage/storage-spaces/storage-spaces-direct-overview) является компонентом Windows Server, который поддерживается отказоустойчивой кластеризацией на виртуальных машинах Azure. Она предоставляет программную виртуальную сеть SAN.

**Поддерживаемая ОС**: Windows Server 2016 и более поздние версии   
**Поддерживаемая версия SQL**: SQL Server 2016 и более поздних версий   


**Среди** 
- Достаточная пропускная способность сети обеспечивает надежное и высокопроизводительное решение общего хранилища. 
- Поддерживает кэш больших двоичных объектов Azure, поэтому операции чтения можно обслуживать локально из кэша. (Обновления реплицируются одновременно на оба узла.) 
- Поддерживает FileStream. 

**Ограничений**
- Доступно только для Windows Server 2016 и более поздних версий. 
- Зоны доступности не поддерживаются.
- Требуется диск, подключенный к обеим виртуальным машинам. 
- Высокая пропускная способность сети необходима для достижения высокой производительности из-за текущей репликации диска. 
- Требуется больший размер виртуальной машины и удвоенная плата за хранилище, так как хранилище подключено к каждой виртуальной машине. 

Чтобы приступить к работе, см. раздел [SQL Server экземпляр отказоустойчивого кластера с Локальные дисковые пространства](failover-cluster-instance-storage-spaces-direct-manually-configure.md). 

### <a name="premium-file-share"></a>Общая папка Premium

[Файловые ресурсы](../../../storage/files/storage-how-to-create-premium-fileshare.md) уровня "Премиум" — это функция [файлов Azure](../../../storage/files/index.yml). Файловые ресурсы уровня "Премиум" являются резервными файлами SSD и постоянно имеют низкую задержку. Они полностью поддерживаются для использования с экземплярами отказоустойчивого кластера для SQL Server 2012 или более поздней версии на Windows Server 2012 или более поздней версии. Файловые ресурсы уровня "Премиум" обеспечивают большую гибкость, так как вы можете изменять размер и масштабировать общую папку без простоев.

**Поддерживаемая ОС**: Windows Server 2012 и более поздние версии   
**Поддерживаемая версия SQL**: SQL Server 2012 и более поздних версий   

**Среди** 
- Только решение общих хранилищ для виртуальных машин, распределенное по нескольким зонам доступности. 
- Полностью управляемая файловая система с задержкой в одну цифру и производительностью операций ввода-вывода. 

**Ограничений**
- Доступно только для Windows Server 2012 и более поздних версий. 
- FileStream не поддерживается. 


Чтобы приступить к работе, см. раздел [SQL Server экземпляр отказоустойчивого кластера с общей папкой Premium](failover-cluster-instance-premium-file-share-manually-configure.md). 

### <a name="partner"></a>Партнер

Существуют решения для кластеризации партнеров с поддерживаемым хранилищем. 

**Поддерживаемая ОС**: все   
**Поддерживаемая версия SQL**: все   

В одном из примеров в качестве хранилища используется SIOS. Дополнительные сведения см. в записи блога [отказоустойчивая кластеризация и SIOS](https://azure.microsoft.com/blog/high-availability-for-a-file-share-using-wsfc-ilb-and-3rd-party-software-sios-datakeeper/).

### <a name="iscsi-and-expressroute"></a>iSCSI и ExpressRoute

Вы также можете предоставить хранилище общего блочного хранилища iSCSI через Azure ExpressRoute. 

**Поддерживаемая ОС**: все   
**Поддерживаемая версия SQL**: все   

Например, решение NetApp Private Storage (NPS) предоставляет цели iSCSI через ExpressRoute с Equinix для виртуальных машин Azure.

Чтобы получить доступ к общим хранилищам и решениям репликации данных от партнеров Майкрософт, обратитесь к поставщику за всеми проблемами, связанными с доступом к данным при отработке отказа.

## <a name="connectivity"></a>Соединение

Экземпляры отказоустойчивого кластера с SQL Server на виртуальных машинах Azure используют [имя распределенной сети (DNN)](hadr-distributed-network-name-dnn-configure.md) или [имя ВИРТУАЛЬНОЙ сети (VNN) с Azure Load Balancer](hadr-vnn-azure-load-balancer-configure.md) для маршрутизации трафика к SQL Server экземпляру, независимо от того, какой узел в настоящее время владеет кластеризованными ресурсами. При использовании определенных функций и DNN с SQL Server FCI необходимо учитывать дополнительные моменты. Дополнительные сведения см. в статье [взаимодействие DNN с SQL Server FCI](failover-cluster-instance-dnn-interoperability.md) . 

Дополнительные сведения о вариантах подключения к кластеру см. в статье [Маршрутизация подключений HADR к SQL Server на виртуальных машинах Azure](hadr-cluster-best-practices.md#connectivity). 

## <a name="limitations"></a>Ограничения

Примите во внимание следующие ограничения для экземпляров отказоустойчивого кластера с SQL Server на виртуальных машинах Azure. 

### <a name="lightweight-resource-provider"></a>Облегченный поставщик ресурсов   
В настоящее время SQL Server экземпляры отказоустойчивого кластера на виртуальных машинах Azure поддерживаются только в [режиме упрощенного управления](sql-vm-resource-provider-register.md#management-modes) [расширением агента IaaS SQL Server](sql-server-iaas-agent-extension-automate-management.md). Чтобы перейти с полного режима расширения на облегченный, удалите ресурс **виртуальной машины SQL** для соответствующих виртуальных машин, а затем зарегистрируйте их с помощью поставщика ресурсов ВИРТУАЛЬНОЙ машины SQL в упрощенном режиме. При удалении ресурса **виртуальной машины SQL** с помощью портал Azure снимите флажок рядом с соответствующей виртуальной машиной. 

Полное расширение поддерживает такие компоненты, как автоматическое резервное копирование, установка исправлений и расширенное управление порталом. Эти функции не будут работать для SQL Server виртуальных машин после переустановки агента в режиме упрощенного управления.

### <a name="msdtc"></a>MSDTC   
Виртуальные машины Azure поддерживают MSDTC в Windows Server 2019 с хранилищем в общих томах кластера (CSV) и [Azure Load Balancer (цен. Категория "Стандартный")](../../../load-balancer/load-balancer-standard-overview.md).

На виртуальных машинах Azure MSDTC не поддерживается для Windows Server 2016 или более ранних версий, так как:

- Кластерный ресурс MSDTC нельзя настроить для использования общего хранилища. В Windows Server 2016, если вы создаете ресурс MSDTC, не будет отображаться доступное общее хранилище, даже если оно существует. Эта проблема устранена в Windows Server 2019.
- Load Balancer ценовой категории "Стандартный" не обрабатывает порты RPC.


## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с рекомендациями по [конфигурации кластера](hadr-cluster-best-practices.md)и [Подготовьте виртуальную машину SQL Server для FCI](failover-cluster-instance-prepare-vm.md). 

Дополнительные сведения можно найти в разделе 

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);   
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

