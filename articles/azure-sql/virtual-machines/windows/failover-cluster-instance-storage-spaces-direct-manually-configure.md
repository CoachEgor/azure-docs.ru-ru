---
title: Экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure | Документация Майкрософт
description: В этой статье объясняется, как создать экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MikeRayMSFT
manager: craigg
editor: monicar
tags: azure-service-management
ms.assetid: 9fc761b1-21ad-4d79-bebc-a2f094ec214d
ms.service: virtual-machines-sql
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/11/2018
ms.author: mikeray
ms.openlocfilehash: 75c25454451b733870f8a674b292cd131454f4d2
ms.sourcegitcommit: 053e5e7103ab666454faf26ed51b0dfcd7661996
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2020
ms.locfileid: "84032315"
---
# <a name="configure-a-sql-server-failover-cluster-instance-on-azure-virtual-machines"></a>Настройка экземпляра отказоустойчивого кластера SQL Server на виртуальных машинах Azure
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье объясняется, как создать экземпляр отказоустойчивого кластера SQL Server на виртуальных машинах Azure в модели Azure Resource Manager. В этом решении [Локальные дисковые пространства Windows Server 2016 Datacenter Edition](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview) используются в качестве программной виртуальной сети SAN, синхронизирующей хранилище (диски с данными) между узлами (виртуальные машины Azure) в кластере Windows. Локальные дисковые пространства впервые были представлены в Windows Server 2016.

На следующей схеме показано полное решение на виртуальных машинах Azure.

![Полное решение](./media/failover-cluster-instance-storage-spaces-direct-manually-configure/00-sql-fci-s2d-complete-solution.png)

На этой схеме показано следующее:

- Две виртуальные машины Azure в отказоустойчивом кластере Windows Server. Когда виртуальная машина находится в отказоустойчивом кластере, она также называется *узлом кластера* или просто *узлом*.
- В каждой виртуальной машине есть два или больше дисков данных.
- Локальные дисковые пространства синхронизируют данные на диске данных и представляют синхронизированное хранилище в качестве пула носителей.
- Пул носителей представляет общий том кластера (CSV) для отказоустойчивого кластера.
- Роль экземпляра кластера SQL Server FCI использует CSV для дисков данных.
- Azure Load Balancer для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.
- В группе доступности Azure хранятся все ресурсы.

>[!NOTE]
>Все ресурсы Azure, представленные на схеме, находятся в одной и той же группе ресурсов.

Дополнительные сведения о локальных дисковых пространствах см. в статье [Локальные дисковые пространства в Windows Server 2016](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview).

Локальные дисковые пространства поддерживают два типа архитектуры — конвергентную и гиперконвергентную. В этом документе используется гиперконвергентная архитектура. Гиперконвергентная инфраструктура размещает хранилище на тех же серверах, на которых размещено кластеризованное приложение. В этой архитектуре хранилище находится на каждом узле экземпляра отказоустойчивого кластера SQL Server.

## <a name="licensing-and-pricing"></a>Лицензирование и цены

На виртуальных машинах Azure можно лицензировать SQL Server, используя образы виртуальных машин с оплатой по мере использования (PAYG) или с использованием собственной лицензии (BYOL). Тип выбранного образа влияет на процесс выставления счетов.

При лицензировании с оплатой по мере использования для экземпляра отказоустойчивого кластера (FCI) SQL Server на виртуальных машинах Azure оплачиваются все узлы, в том числе пассивные. Дополнительные сведения см. на странице [Цены на виртуальные машины SQL Server Enterprise](https://azure.microsoft.com/pricing/details/virtual-machines/sql-server-enterprise/).

Если у вас есть Соглашение Enterprise с применением программы Software Assurance, вы можете использовать по одному бесплатному пассивному узлу отказоустойчивого кластера на каждый активный узел. Чтобы получить такую возможность в Azure, используйте образы виртуальных машин BYOL, а затем примените одну и ту же лицензию как к активным, так и к пассивным узлам FCI. Дополнительные сведения см. в статье о [Соглашении Enterprise](https://www.microsoft.com/Licensing/licensing-programs/enterprise.aspx).

Чтобы сравнить возможности лицензирования с оплатой по мере использования и BYOL для SQL Server на виртуальных машинах Azure, см. статью о [начале работы с виртуальными машинами SQL](sql-server-on-azure-vm-iaas-what-is-overview.md#get-started-with-sql-vms).

Полные сведения о лицензировании SQL Server см. [на странице с ценами](https://www.microsoft.com/sql-server/sql-server-2017-pricing).

### <a name="example-azure-template"></a>Пример шаблона Azure

На основе шаблона в Azure можно создать полное решение. Пример шаблона доступен в [шаблонах быстрого запуска Azure](https://github.com/MSBrett/azure-quickstart-templates/tree/master/sql-server-2016-fci-existing-vnet-and-ad) на GitHub. Этот пример не предназначен или не протестирован для какой-либо конкретной рабочей нагрузки. Вы можете запустить шаблон, чтобы создать экземпляр отказоустойчивого кластера SQL Server с хранилищем Локальных дисковых пространств, подключенным к вашему домену. Шаблон можно оценить и изменить в соответствии со своими потребностями.

## <a name="before-you-begin"></a>Перед началом

Прежде чем начать, необходимо знать несколько моментов.

### <a name="what-to-know"></a>Необходимые знания
Вам необходимо иметь представление о следующих технологиях:

- [технологии кластера под управлением Windows](https://docs.microsoft.com/windows-server/failover-clustering/failover-clustering-overview);
- [экземпляры отказоустойчивого кластера SQL Server](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server).

Учтите, что для отказоустойчивого кластера гостевых виртуальных машин IaaS Azure мы советуем использовать один сетевой адаптер на сервер (узел кластера) и одну подсеть. Сеть Azure обладает физической избыточностью, что делает ненужными дополнительные сетевые адаптеры и подсети в кластере гостевых виртуальных машин IaaS Azure. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в гостевых отказоустойчивых кластерах виртуальных машин Azure IaaS.

Вам также необходимо иметь общее представление о следующих технологиях:

- [гиперконвергентное решение, использующее локальные дисковые пространства в Windows Server 2016](https://docs.microsoft.com/windows-server/storage/storage-spaces/storage-spaces-direct-overview);
- [группы ресурсов Azure](../../../azure-resource-manager/management/manage-resource-groups-portal.md).

> [!IMPORTANT]
> На данный момент экземпляры отказоустойчивого кластера SQL Server на виртуальных машинах Azure поддерживаются только в [режиме облегченного управления](sql-vm-resource-provider-register.md#management-modes) [расширения агента IaaS SQL Server](sql-server-iaas-agent-extension-automate-management.md). Чтобы перейти с полного режима расширения на упрощенный, удалите ресурс **виртуальной машины SQL** для соответствующих виртуальных машин, а затем зарегистрируйте их с помощью поставщика ресурсов виртуальной машины SQL в упрощенном режиме. При удалении ресурса **виртуальной машины SQL** с помощью портала Azure **снимите флажок рядом с соответствующей виртуальной машиной**. Полное расширение поддерживает такие компоненты, как автоматическое резервное копирование, установка исправлений и расширенное управление порталом. Эти функции не будут работать для виртуальных машин SQL после переустановки агента в упрощенном режиме управления.

### <a name="what-to-have"></a>Необходимые компоненты

Чтобы выполнить действия, описанные в этой статье, необходимо следующее:

- подписка Microsoft Azure;
- домен Windows на виртуальных машинах Azure;
- учетная запись с разрешениями на создание объектов как на виртуальных машинах Azure, так и в Active Directory;
- виртуальная сеть и подсеть Azure с достаточным пространством IP-адресов для следующих компонентов:
   - обе виртуальные машины;
   - IP-адрес отказоустойчивого кластера;
   - IP-адрес для каждого экземпляра отказоустойчивого кластера;
- служба DNS, настроенная в сети Azure, указывающей на контроллеры домена.

После выполнения этих предварительных требований можно приступить к созданию отказоустойчивого кластера. Сначала нужно создать виртуальные машины.

## <a name="step-1-create-the-virtual-machines"></a>Шаг 1. Создание виртуальных машин

1. Войдите на [портал Azure](https://portal.azure.com) со своей подпиской.

1. [Создайте группу доступности Azure](../../../virtual-machines/linux/tutorial-availability-sets.md).

   Группа доступности группирует виртуальные машины в доменах сбоя и доменах обновления. Она гарантирует, что на ваше приложение не повлияют единые точки отказа, такие как сетевой коммутатор или блок питания стойки серверов.

   Если вы не создали группу ресурсов для виртуальных машин, сделайте это во время создания группы доступности Azure. Если вы используете портал Azure для создания группы доступности, сделайте следующее.

   1. На портале Azure выберите **Создать ресурс**, чтобы открыть Azure Marketplace. Найдите **Группа доступности**.
   1. Выберите **Группа доступности**.
   1. Нажмите кнопку **создания**.
   1. В разделе **Создание группы доступности** укажите следующие значения:
      - **Name** (Имя). Имя группы доступности.
      - **Подписка**: Вашу подписку Azure.
      - **Группа ресурсов.** Если вы хотите использовать имеющуюся группу, щелкните **Выбрать существующую** и выберите группу из раскрывающегося списка. В противном случае выберите **Создать** и введите имя для группы.
      - **Расположение.** Задайте расположение, в котором вы планируете создать виртуальные машины.
      - **Домены сбоя**. Используйте значение по умолчанию (**3**).
      - **Домены обновления**. Используйте значение по умолчанию (**5**).
   1. Щелкните **Создать**, чтобы создать группу доступности.

1. Создайте виртуальные машины в группе доступности.

   Подготовьте две виртуальные машины SQL Server в группе доступности Azure. Инструкции см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](create-sql-vm-portal.md).

   Разместите обе виртуальные машины:

   - в той же группе ресурсов Azure, что и группа доступности;
   - в той же сети, что и контроллер домена;
   - в подсети с достаточным пространством IP-адресов для обеих виртуальных машин и всех экземпляров отказоустойчивого кластера, которые со временем могут использоваться в этом кластере;
   - в группе доступности Azure.

      >[!IMPORTANT]
      >После создания виртуальной машины установить или изменить группу доступности невозможно.

   Выберите образ из Azure Marketplace. Вы можете использовать образ Azure Marketplace, который включает Windows Server и SQL Server или просто Windows Server. Дополнительные сведения см. в статье [Приступая к работе с SQL Server в виртуальных машинах Azure](sql-server-on-azure-vm-iaas-what-is-overview.md).

   Официальные образы SQL Server в коллекции Azure содержат установленный экземпляр SQL Server, а также программное обеспечение для установки SQL Server и необходимый ключ.

   Выберите необходимый образ в соответствии с желаемым способом оплаты за лицензию SQL Server:

   - **Лицензирование с оплатой за потребление**. Посекундная оплата этих образов доступна в таких лицензиях SQL Server:
      - **SQL Server 2016 Enterprise на базе Windows Server 2016 Datacenter**;
      - **SQL Server 2016 Standard на базе Windows Server 2016 Datacenter**;
      - **SQL Server 2016 Developer на базе Windows Server 2016 Datacenter**;

   - **BYOL (с использованием собственной лицензии)** :

      - **(BYOL) SQL Server 2016 Enterprise на базе Windows Server 2016 Datacenter**;
      - **(BYOL) SQL Server 2016 Standard на базе Windows Server 2016 Datacenter**.

   >[!IMPORTANT]
   >После создания виртуальной машины удалите предварительно установленный автономный экземпляр SQL Server. Вы будете использовать предварительно установленный носитель SQL Server для создания экземпляра отказоустойчивого кластера SQL Server после настройки отказоустойчивого кластера и Локальных дисковых пространств.

   Кроме того, можно использовать образы Azure Marketplace, которые содержат только операционную систему. Выберите образ **Windows Server 2016 Datacenter** и установите экземпляр отказоустойчивого кластера SQL Server после настройки отказоустойчивого кластера и Локальных дисковых пространств. Этот образ не содержит установочный носитель SQL Server. Поместите установочный носитель SQL Server в расположении, где его можно запускать для каждого сервера.

1. После создания виртуальных машин в Azure подключитесь к каждой виртуальной машине с помощью протокола удаленного рабочего стола.

   При первом подключении к виртуальной машине с помощью протокола удаленного рабочего стола вы получаете запрос, должен ли этот компьютер быть доступным в сети. Выберите **Да**.

1. Если вы используете один из образов виртуальных машин на основе SQL Server, удалите экземпляр SQL Server.

   1. В разделе **Программы и компоненты** правой кнопкой мыши щелкните **Microsoft SQL Server 2016 (64-разрядная версия)** и выберите **Удалить/Изменить**.
   1. Щелкните **Удалить**.
   1. Выберите экземпляр по умолчанию.
   1. Удалите все компоненты в разделе **Службы ядра СУБД**. Не удаляйте компоненты в разделе **Общие компоненты**. Вы должны увидеть примерно следующее:

      ![Выбор компонентов](./media/failover-cluster-instance-storage-spaces-direct-manually-configure/03-remove-features.png)

   1. Щелкните **Далее**, а затем **Удалить**.

1. <a name="ports"></a>Откройте порты брандмауэра.

   На каждой виртуальной машине откройте следующие порты в брандмауэре Windows:

   | Назначение | TCP-порт | Примечания
   | ------ | ------ | ------
   | SQL Server | 1433 | Обычный порт для экземпляров SQL Server по умолчанию. Если используется образ из коллекции, этот порт будет автоматически открыт.
   | Проверка работоспособности | 59999 | Любой открытый TCP-порт. Позже настройте [проверку работоспособности](#probe) балансировщика нагрузки и кластер для использования этого порта.  

1. Добавьте хранилище в виртуальную машину. Дополнительные сведения см. в статье [Хранилище класса "Премиум": высокопроизводительная служба хранилища для рабочих нагрузок виртуальных машин Azure](../../../virtual-machines/linux/disks-types.md).

   Для обеих виртуальных машин необходимо по крайней мере два диска данных.

   Присоедините диски в формате RAW — диски, не отформатированные в NTFS.
      >[!NOTE]
      >Если присоединить диски, отформатированные в NTFS, Локальные дисковые пространства можно включить только без проверки допустимости диска.  

   Подключите как минимум два SSD (цен. категория "Премиум") к каждой виртуальной машине. Мы рекомендуем по крайней мере диски P30 (1 ТБ).

   Для кэширования узла задайте значение **Только для чтения**.

   Емкость хранилища, используемого в рабочих средах, зависит от рабочей нагрузки. Значения, описанные в этой статье, предназначены для демонстрации и тестирования.

1. [Добавьте виртуальные машины в имеющийся домен](availability-group-manually-configure-prerequisites-tutorial.md#joinDomain).

После создания и настройки виртуальных машин можно настроить отказоустойчивый кластер.

## <a name="step-2-configure-the-windows-server-failover-cluster-with-storage-spaces-direct"></a>Шаг 2. Настройка отказоустойчивого кластера Windows Server с Локальными дисковыми пространствами

Следующим шагом является настройка отказоустойчивого кластера с Локальными дисковыми пространствами. На этом шаге выполните следующие действия.

1. Добавление компонента отказоустойчивой кластеризации Windows Server.
1. Проверка кластера.
1. Создание отказоустойчивого кластера.
1. Создание облака-свидетеля.
1. Добавление хранилища.

### <a name="add-windows-server-failover-clustering"></a>Добавление отказоустойчивой кластеризации Windows Server

1. Подключитесь к первой виртуальной машине с помощью протокола удаленного рабочего стола, используя учетную запись домена, которая является участником локальной группы администраторов, а также имеет разрешения на создание объектов в Active Directory. Используйте эту учетную запись для остальной части конфигурации.

1. [Добавьте компонент отказоустойчивой кластеризации для каждой виртуальной машины](availability-group-manually-configure-prerequisites-tutorial.md#add-failover-clustering-features-to-both-sql-server-vms).

   Чтобы установить отказоустойчивую кластеризацию из пользовательского интерфейса, сделайте следующее на обеих виртуальных машинах.
   1. В **диспетчере сервера** выберите **Управление**, а затем — **Добавить роли и компоненты**.
   1. В **мастере добавления ролей и компонентов** нажимайте кнопку **Далее**, пока не откроется раздел **Выбор компонентов**.
   1. В разделе **Выбор компонентов** выберите **Отказоустойчивая кластеризация**. Включите все необходимые компоненты и средства управления. Выберите **Добавить компоненты**.
   1. Чтобы установить компоненты, нажмите кнопку **Далее**, а затем — **Готово**.

   Чтобы установить отказоустойчивую кластеризацию с помощью PowerShell, запустите следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   $nodes = ("<node1>","<node2>")
   Invoke-Command  $nodes {Install-WindowsFeature Failover-Clustering -IncludeAllSubFeature -IncludeManagementTools}
   ```

Для справки в следующих шагах используются инструкции, приведенные на шаге 3 в статье [Гиперконвергентное решение с использованием Локальных дисковых пространств в Windows Server 2016](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-3-configure-storage-spaces-direct).

### <a name="validate-the-cluster"></a>Проверка кластера

Проверьте кластер в пользовательском интерфейсе или с помощью PowerShell.

Чтобы проверить работу кластера с помощью пользовательского интерфейса, сделайте следующее на одной из виртуальных машин:

1. На панели **Диспетчер серверов** выберите **Инструменты** и нажмите **Диспетчер отказоустойчивости кластеров**.
1. В разделе **Диспетчер отказоустойчивости кластеров** выберите **Действие**, а затем выберите **Проверить конфигурацию**.
1. Выберите **Далее**.
1. На вкладке **Выбор серверов или кластера** введите имена обеих виртуальных машин.
1. На вкладке **Параметры тестирования** выберите **Выполнять только выбранные тесты**. Выберите **Далее**.
1. В разделе **Выбор тестов** выберите все тесты, кроме **Хранилище**, как показано ниже:

   ![Выбор проверочных тестов кластера](./media/failover-cluster-instance-storage-spaces-direct-manually-configure/10-validate-cluster-test.png)

1. Выберите **Далее**.
1. В разделе **Подтверждение** нажмите **Далее**.

Мастер проверки конфигурации выполняет проверочные тесты.

Чтобы проверить кластер с помощью PowerShell, запустите следующий скрипт из сеанса PowerShell администратора на одной из виртуальных машин:

   ```powershell
   Test-Cluster –Node ("<node1>","<node2>") –Include "Storage Spaces Direct", "Inventory", "Network", "System Configuration"
   ```

После проверки кластера создайте отказоустойчивый кластер.

### <a name="create-the-failover-cluster"></a>Создание отказоустойчивого кластера.

Для создания отказоустойчивого кластера требуется следующее.
- Имена виртуальных машин, которые становятся узлами кластера.
- Имя отказоустойчивого кластера.
- IP-адрес отказоустойчивого кластера. Вы можете использовать IP-адрес, который не используется в той же виртуальной сети и подсети Azure, где расположены узлы кластера.

#### <a name="windows-server-2008-through-windows-server-2016"></a>С Windows Server 2008 по Windows Server 2016

Следующий сценарий PowerShell создает отказоустойчивый кластер для Windows Server версий с 2008 по 2016. Обновите скрипт, введя имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage
```   

#### <a name="windows-server-2019"></a>Windows Server 2019

Следующий сценарий PowerShell создает отказоустойчивый кластер для Windows Server 2019. Дополнительные сведения см. в статье [Отказоустойчивый кластер: сетевой объект кластера](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97). Обновите скрипт, введя имена узлов (имена виртуальных машин) и доступный IP-адрес из виртуальной сети Azure.

```powershell
New-Cluster -Name <FailoverCluster-Name> -Node ("<node1>","<node2>") –StaticAddress <n.n.n.n> -NoStorage -ManagementPointNetworkType Singleton 
```


### <a name="create-a-cloud-witness"></a>Создание облака-свидетеля

Облако-свидетель является новым типом свидетеля кворума кластера, хранящегося в хранилище больших двоичных объектов Azure. Это устраняет необходимость в отдельной виртуальной машине, используемой для размещения файлового ресурса-свидетеля.

1. [Создайте облако-свидетель для отказоустойчивого кластера](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness).

1. Создайте контейнер больших двоичных объектов.

1. Сохраните ключи доступа и URL-адрес контейнера.

1. Настройте свидетель кворума отказоустойчивого кластера. См. раздел о [настройке свидетеля кворума в пользовательском интерфейсе](https://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness#to-configure-cloud-witness-as-a-quorum-witness).

### <a name="add-storage"></a>Добавление хранилища

Диски для Локальных дисковых пространств должны быть пустыми. Они не могут содержать разделы или другие данные. Чтобы очистить диски, выполните [действия, описанные в этом руководстве](https://docs.microsoft.com/windows-server/storage/storage-spaces/deploy-storage-spaces-direct?redirectedfrom=MSDN#step-31-clean-drives).

1. [Включение Локальных дисковых пространств](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-35-enable-storage-spaces-direct).

   Следующий скрипт PowerShell включает Локальные дисковые пространства:  

   ```powershell
   Enable-ClusterS2D
   ```

   В **диспетчере отказоустойчивости кластеров** теперь отображается пул носителей.

1. [Создайте том](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct#step-36-create-volumes).

   Локальные дисковые пространства автоматически создают пул носителей при включении. Теперь можно создать том. Командлет PowerShell `New-Volume` автоматизирует процесс создания тома. Этот процесс включает форматирование, добавление тома в кластер и создание общего тома кластера (CSV). В этом примере создается CSV емкостью 800 ГБ:

   ```powershell
   New-Volume -StoragePoolFriendlyName S2D* -FriendlyName VDisk01 -FileSystem CSVFS_REFS -Size 800GB
   ```   

   После выполнения этой команды том емкостью 800 ГБ подключается как ресурс кластера. Том находится в папке `C:\ClusterStorage\Volume1\`.

   На этом снимке экрана показан общий том кластера с Локальными дисковыми пространствами:

   ![Общий том кластера](./media/failover-cluster-instance-storage-spaces-direct-manually-configure/15-cluster-shared-volume.png)

## <a name="step-3-test-failover-cluster-failover"></a>Шаг 3. Тестирование отработки отказа отказоустойчивого кластера

В **диспетчере отказоустойчивости кластеров** убедитесь, что можете переместить ресурс хранилища в другой узел кластера. Если вы можете подключиться к отказоустойчивому кластеру с помощью **диспетчера отказоустойчивости кластеров** и перемещать хранилище с одного узла на другой, можно приступать к настройке экземпляра отказоустойчивого кластера.

## <a name="step-4-create-the-sql-server-fci"></a>Шаг 4. Создание экземпляра отказоустойчивого кластера SQL Server

После настройки отказоустойчивого кластера и всех компонентов кластера, включая хранилище, можно создать экземпляр отказоустойчивого кластера SQL Server.

1. Подключитесь к первой виртуальной машине Azure с помощью RDP.

1. В **диспетчере отказоустойчивости кластеров** убедитесь, что все основные ресурсы кластера находятся на первой виртуальной машине. При необходимости переместите все ресурсы на эту виртуальную машину.

1. Найдите установочный носитель. Если на виртуальной машине используется один из образов Azure Marketplace, носитель находится в папке `C:\SQLServer_<version number>_Full`. Выберите **Установить**.

1. В диалоговом окне **Центр установки SQL Server** выберите **Установка**.

1. Щелкните **Новая установка отказоустойчивого кластера SQL Server**. Следуйте указаниям мастера, чтобы установить экземпляр отказоустойчивого кластера SQL Server.

   Каталоги данных экземпляра отказоустойчивого кластера должны находиться в кластеризованном хранилище. В случае с Локальными дисковыми пространствами это не общий диск, а точка подключения к тому на каждом сервере. Локальные дисковые пространства синхронизируют том между обоими узлами. Том предоставляется в кластере в качестве общего тома кластера. Используйте точки подключения CSV для каталогов данных.

   ![Каталоги данных](./media/failover-cluster-instance-storage-spaces-direct-manually-configure/20-data-dicrectories.png)

1. После выполнения инструкций мастера программа установки установит экземпляр отказоустойчивого кластера SQL Server на первом узле.

1. После установки экземпляра отказоустойчивого кластера на первом узле подключитесь ко второму узлу с помощью протокола удаленного рабочего стола.

1. Откройте диалоговое окно **Центр установки SQL Server**. Нажмите **Установка**.

1. Выберите **Добавление узла в отказоустойчивый кластер SQL Server**. Следуйте указаниям мастера, чтобы установить сервер SQL и добавить его в экземпляр отказоустойчивого кластера.

   >[!NOTE]
   >При использовании образа коллекции Azure Marketplace, который содержит SQL Server, средства SQL Server включаются в образ. Если вы не использовали один из этих образов, установите средства SQL Server отдельно. См. сведения в статье [Скачивание SQL Server Management Studio (SSMS)](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="step-5-create-the-azure-load-balancer"></a>Шаг 5. Создание Azure Load Balancer

На виртуальных машинах Azure кластеры используют балансировщик нагрузки для хранения IP-адреса, который должен находиться на одном узле кластера в определенный момент времени. В этом решении балансировщик нагрузки используется для хранения IP-адреса для экземпляра отказоустойчивого кластера SQL Server.

Дополнительные сведения см. в разделе [Создание и настройка Azure Load Balancer](availability-group-manually-configure-tutorial.md#configure-internal-load-balancer).

### <a name="create-the-load-balancer-in-the-azure-portal"></a>Создание балансировщика нагрузки на портале Azure

Создание балансировщика нагрузки

1. На портале Azure перейдите в группу ресурсов с виртуальными машинами.

1. Выберите **Добавить**. В Azure Marketplace найдите **Load Balancer**. Выберите **Load Balancer**.

1. Нажмите кнопку **создания**.

1. Настройте для балансировщика нагрузки следующие параметры.

   - **Подписка**: Вашу подписку Azure.
   - **Группа ресурсов.** Группа ресурсов, которая содержит ваши виртуальные машины.
   - **Name** (Имя). Имя, определяющее подсистему балансировки нагрузки.
   - **Регион**. Расположение Azure, которое содержит ваши виртуальные машины.
   - **Тип**. Открытый или закрытый. Доступ к закрытому балансировщику нагрузки может осуществляться в пределах одной виртуальной сети. Большинство приложений Azure могут использовать закрытый балансировщик нагрузки. Если приложению требуется доступ к SQL Server непосредственно через Интернет, используйте открытый балансировщик нагрузки.
   - **SKU**: Стандартная.
   - **Виртуальная сеть.** Виртуальная сеть, в которой находятся виртуальные машины.
   - **Назначение IP-адресов**. Статический. 
   - **Частный IP-адрес**. IP-адрес, назначенный сетевому ресурсу кластера SQL Server FCI.

 На следующем снимке экрана показан пользовательский интерфейс **создания подсистемы балансировки нагрузки**:

   ![Настройка подсистемы балансировки нагрузки](./media/failover-cluster-instance-storage-spaces-direct-manually-configure/30-load-balancer-create.png)

### <a name="configure-the-load-balancer-backend-pool"></a>Настройка серверного пула балансировщика нагрузки

1. Вернитесь в группу ресурсов Azure с виртуальными машинами и найдите новый балансировщик нагрузки. Возможно, потребуется обновить представление в группе ресурсов. Выберите подсистему балансировки нагрузки.

1. Выберите **Серверные пулы**, а затем щелкните **Добавить**.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **Целевые IP-конфигурации сети** установите флажок **Виртуальная машина** и выберите виртуальные машины, которые будут узлами кластера. Не забудьте включить все виртуальные машины, на которых будут размещаться FCI.

1. Нажмите кнопку **ОК**, чтобы создать серверный пул.

### <a name="configure-a-load-balancer-health-probe"></a>Настройка пробы работоспособности балансировщика нагрузки

1. В колонке подсистемы балансировки нагрузки щелкните **Пробы работоспособности**.

1. Выберите **Добавить**.

1. В колонке **Добавить пробу работоспособности** <a name="probe"></a>задайте параметры пробы работоспособности.

   - **Name** (Имя). Имя для проверки работоспособности.
   - **Протокол**. Протокол TCP.
   - **Порт**: Укажите порт, созданный в брандмауэре для пробы работоспособности в [этом шаге](#ports). В качестве примера в этой статье используется TCP-порт `59999`.
   - **Интервал**: 5 секунд.
   - **Пороговое значение сбоя**: 2 последовательных сбоя.

1. Щелкните **ОК**.

### <a name="set-load-balancing-rules"></a>Задание правил балансировки нагрузки

1. В колонке подсистемы балансировки нагрузки щелкните **Правила балансировки нагрузки**.

1. Выберите **Добавить**.

1. Настройте следующие параметры балансировки нагрузки:

   - **Name** (Имя). Имя для правил балансировки нагрузки.
   - **Интерфейсный IP-адрес**. IP-адрес для сетевого ресурса кластера SQL Server FCI.
   - **Порт**: TCP-порт экземпляра отказоустойчивого кластера SQL Server. Порт экземпляра по умолчанию — 1433.
   - **Серверный порт**: используется тот же порт, что и для значения **Порт** при включении параметра **Плавающий IP-адрес (прямой ответ от сервера)** .
   - **Серверный пул**. Имя серверного пула, настроенного ранее.
   - **Зонд работоспособности**. Проба работоспособности, настроенная ранее.
   - **Сохранение сеанса**. Нет.
   - **Время ожидания простоя (в минутах)** . 4.
   - **Плавающий IP-адрес (прямой ответ от сервера)** . Включено.

1. Щелкните **ОК**.

## <a name="step-6-configure-the-cluster-for-the-probe"></a>Шаг 6. Настройка кластера для пробы

Задайте параметр порта проверки кластера в PowerShell.

Чтобы задать параметр порта пробы кластера, измените переменные в следующем сценарии, указав значения для своей среды. Удалите угловые скобки (`<` и `>`) из сценария.

   ```powershell
   $ClusterNetworkName = "<Cluster Network Name>"
   $IPResourceName = "<SQL Server FCI IP Address Resource Name>" 
   $ILBIP = "<n.n.n.n>" 
   [int]$ProbePort = <nnnnn>

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

Ниже приводится список значений, которые необходимо обновить:

   - `<Cluster Network Name>`: Имя отказоустойчивого кластера Windows Server для сети. Выберите **Диспетчер отказоустойчивости кластеров** > **Сети**, щелкните правой кнопкой мыши сеть и щелкните **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.

   - `<SQL Server FCI IP Address Resource Name>`: Имя ресурса IP-адреса экземпляра отказоустойчивого кластера SQL Server. Выберите **Диспетчер отказоустойчивости кластеров** > **Роли**. Для роли экземпляра отказоустойчивого кластера SQL Server в разделе **Имя сервера** щелкните правой кнопкой мыши ресурс IP-адреса и выберите **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**. 

   - `<ILBIP>`: IP-адрес внутренней подсистемы балансировки нагрузки. Этот адрес настраивается на портале Azure в качестве интерфейсного адреса внутренней подсистемы балансировки нагрузки. Это также IP-адрес экземпляра отказоустойчивого кластера SQL Server. Его можно найти в окне **Диспетчер отказоустойчивости кластеров** на той же странице свойств, где указано значение `<SQL Server FCI IP Address Resource Name>`.  

   - `<nnnnn>`: Порт пробы, настроенный в пробе работоспособности подсистемы балансировки нагрузки. Допускается любой неиспользуемый TCP-порт.

>[!IMPORTANT]
>Маска подсети для параметра кластера должна быть широковещательным адресом TCP IP: `255.255.255.255`.

После настройки пробы кластера все параметры кластера можно просмотреть в PowerShell. Выполните следующий сценарий:

   ```powershell
   Get-ClusterResource $IPResourceName | Get-ClusterParameter 
  ```

## <a name="step-7-test-fci-failover"></a>Шаг 7. Проверка отработки отказа экземпляра отказоустойчивого кластера

Проверьте отработку отказа экземпляра отказоустойчивого кластера, чтобы проверить функциональные возможности кластера. Сделайте следующее:

1. Подключитесь к одному из узлов кластера SQL Server FCI с помощью протокола удаленного рабочего стола.

1. Откройте **диспетчер отказоустойчивости кластеров**. Выберите **Роли**. Обратите внимание, какой узел является владельцем роли SQL Server FCI.

1. Щелкните правой кнопкой мыши роль SQL Server FCI.

1. Выберите **Переместить**, а затем выберите **Лучший возможный узел**.

В **диспетчере отказоустойчивости кластеров** отобразится роль, и ее ресурсы перейдут в автономный режим. Затем ресурсы переместятся и станут доступными на другом узле.

### <a name="test-connectivity"></a>Проверка подключения

Чтобы проверить подключение, войдите на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к экземпляру отказоустойчивого кластера SQL Server.

>[!NOTE]
>При необходимости можно [скачать SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).

## <a name="limitations"></a>Ограничения

Виртуальные машины Azure поддерживают координатор распределенных транзакций Microsoft (MSDTC) на Windows Server 2019 с хранилищем на общем томе кластера (CSV) и с [Load Balancer ценовой категории "Стандартный"](../../../load-balancer/load-balancer-standard-overview.md).

MSDTC не поддерживается на виртуальных машинах Azure в Windows Server 2016 и более ранних версий, поскольку:

- Кластерный ресурс MSDTC нельзя настроить для использования общего хранилища. В Windows Server 2016, если вы создаете ресурс MSDTC, не будет отображаться доступное общее хранилище, даже если оно существует. Эта проблема устранена в Windows Server 2019.
- Load Balancer ценовой категории "Стандартный" не обрабатывает порты RPC.

## <a name="see-also"></a>См. также раздел

[Настройка Локальных дисковых пространств с помощью удаленного рабочего стола (Azure)](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/rds-storage-spaces-direct-deployment)

[Гиперконвергентное решение с использованием Локальных дисковых пространств](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/hyper-converged-solution-using-storage-spaces-direct)

[Обзор Локальных дисковых пространств](https://technet.microsoft.com/windows-server-docs/storage/storage-spaces/storage-spaces-direct-overview)

[Поддержка SQL Server для Локальных дисковых пространств](https://blogs.technet.microsoft.com/dataplatforminsider/2016/09/27/sql-server-2016-now-supports-windows-server-2016-storage-spaces-direct/)
