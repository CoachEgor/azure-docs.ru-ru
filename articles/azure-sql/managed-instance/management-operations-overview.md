---
title: Операции управления
titleSuffix: Azure SQL Managed Instance
description: Узнайте больше о длительности операций управления Управляемый экземпляр SQL Azure и рекомендациях.
services: sql-database
ms.service: sql-managed-instance
ms.subservice: operations
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: urosmil
ms.author: urmilano
ms.reviewer: sstein, carlrab, MashaMSFT
ms.date: 07/10/2020
ms.openlocfilehash: 5cff54b1f71d30f7932c4ead722d1dda0a7aec57
ms.sourcegitcommit: 3543d3b4f6c6f496d22ea5f97d8cd2700ac9a481
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/20/2020
ms.locfileid: "86531991"
---
# <a name="overview-of-azure-sql-managed-instance-management-operations"></a>Общие сведения об операциях управления Управляемый экземпляр SQL Azure
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

## <a name="what-are-management-operations"></a>Что такое операции управления?
Управляемый экземпляр Azure SQL предоставляет операции управления, которые можно использовать для автоматического развертывания новых управляемых экземпляров, обновления свойств экземпляра и удаления экземпляров, когда они больше не нужны.

Для поддержки [развертываний в виртуальных сетях Azure](../../virtual-network/virtual-network-for-azure-services.md) и обеспечения изоляции и безопасности для клиентов SQL управляемый экземпляр использует [виртуальные кластеры](connectivity-architecture-overview.md#high-level-connectivity-architecture). Виртуальный кластер представляет выделенный набор изолированных виртуальных машин, развернутых внутри подсети виртуальной сети клиента. По сути, каждое развертывание управляемого экземпляра в пустой подсети приводит к созданию нового виртуального кластера.

Последующие операции с развернутыми управляемыми экземплярами также могут иметь эффекты в базовом виртуальном кластере. Эти операции влияют на длительность операций управления, так как развертывание дополнительных виртуальных машин сопровождается накладными расходами, которые необходимо учитывать при планировании новых развертываний или обновлений существующих управляемых экземпляров.

Все операции управления можно классифицировать следующим образом:

- Развертывание экземпляра (создание нового экземпляра).
- Обновление экземпляра (изменение свойств экземпляра, например виртуальных ядер или зарезервированное хранилище).
- Удаление экземпляра.

## <a name="management-operations-duration"></a>Длительность операций управления
Как правило, операции с виртуальными кластерами имеют наибольшее значение. Длительность операций в виртуальных кластерах зависит от значений, которые обычно могут рассчитываться на основе существующих данных телеметрии службы:

- **Создание виртуального кластера**. Создание — это синхронный шаг в операциях управления экземплярами. **90% операций завершено за 4 часа**.
- **Изменение размера виртуального кластера (расширение или сжатие)**. Расширение — это синхронный этап, а сжатие выполняется асинхронно (без влияния на длительность операций управления экземпляром). **90% расширения кластера заканчиваются менее чем на 2,5 часов**.
- **Удаление виртуального кластера**. Удаление — это асинхронный шаг, но его также можно [инициировать вручную](virtual-cluster-delete.md) в пустом виртуальном кластере. в этом случае он выполняется синхронно. **90% операций удаления виртуальных кластеров заканчивается через 1,5 часов**.

Кроме того, управление экземплярами может также включать одну из операций в размещенных базах данных, что приводит к более длительным длительностьм:

- **Присоединение файлов базы данных из службы хранилища Azure**: синхронный шаг, например вычисление (виртуальных ядер) или масштабирование хранилища, на уровне служб общего назначения. **90% этих операций завершается за 5 минут**.
- **Always on заполнения группы доступности**: синхронный шаг, например вычисление (виртуальных ядер) или масштабирование хранилища на уровне служб критически важный для бизнеса, а также изменение уровня службы с общего назначения на критически важный для бизнеса (или наоборот). Длительность этой операции пропорциональна общему размеру базы данных, а также текущей активности базы данных (число активных транзакций). Операция базы данных при обновлении экземпляра может значительно отклонить общую длительность. **90% этих операций выполняется с 220 ГБ/ч или выше**.

В следующей таблице перечислены операции и типичные общие длительности.

|Категория  |Операция  |Долгосрочный сегмент  |Ожидаемая продолжительность  |
|---------|---------|---------|---------|
|**Deployment** |Первый экземпляр в пустой подсети|Создание виртуального кластера|90% операций завершено за 4 часа.|
|Развертывание |Первый экземпляр другого поколения оборудования в непустой подсети (например, первый экземпляр поколения 5 в подсети с экземплярами поколения 4)|Создание виртуального кластера *|90% операций завершено за 4 часа.|
|Развертывание |Первое создание экземпляра 4 виртуальных ядер в пустой или непустой подсети|Создание виртуального кластера * *|90% операций завершено за 4 часа.|
|Развертывание |Последующее создание экземпляра в непустой подсети (2-й, третий и т. д. экземпляр)|Изменение размера виртуального кластера|90% операций завершается через 2,5 часов.|
|**Update** |Изменение свойства экземпляра (пароль администратора, имя входа Azure AD, флаг Преимущество гибридного использования Azure)|Недоступно|До 1 минуты.|
|Обновление |Масштабирование хранилища экземпляров (уровень служб общего назначения)|Присоединение файлов базы данных|90% операций завершается за 5 минут.|
|Обновление |Масштабирование хранилища экземпляров (уровень служб критически важный для бизнеса)|-Изменение размера виртуального кластера<br>-Always On заполнение группы доступности|90% операций завершено за 2,5 часов + время для заполнения всех баз данных (220 ГБ/ч).|
|Обновление |Вычисление экземпляра (виртуальных ядер) увеличение и уменьшение масштаба (общего назначения)|-Изменение размера виртуального кластера<br>— Присоединение файлов базы данных|90% операций завершается через 2,5 часов.|
|Обновление |Вычисление экземпляра (виртуальных ядер) увеличение и уменьшение масштаба (критически важный для бизнеса)|-Изменение размера виртуального кластера<br>-Always On заполнение группы доступности|90% операций завершено за 2,5 часов + время для заполнения всех баз данных (220 ГБ/ч).|
|Обновление |Изменение уровня служб экземпляра (общего назначения для критически важный для бизнеса и наоборот)|-Изменение размера виртуального кластера<br>-Always On заполнение группы доступности|90% операций завершено за 2,5 часов + время для заполнения всех баз данных (220 ГБ/ч).|
|**Лежащие**|Удаление экземпляра|Резервное копирование заключительного фрагмента журнала для всех баз данных|90% операций завершается до 1 минуты.<br>Примечание. Если удаляется последний экземпляр в подсети, эта операция планирует удаление виртуального кластера через 12 часов. * *|
|Удаление|Удаление виртуального кластера (в качестве операции, инициированной пользователем)|Удаление виртуального кластера|90% операций завершается до 1,5 часов.|

\*Виртуальный кластер строится для каждого создания оборудования.

\*\*12 часов — это текущая конфигурация, но она может измениться в будущем, поэтому не следует зависеть от нее. Если вам нужно удалить виртуальный кластер ранее (например, освободить подсеть), см. раздел [Удаление подсети после удаления управляемого экземпляра](virtual-cluster-delete.md).

## <a name="instance-availability-during-management-operations"></a>Доступность экземпляра во время операций управления

SQL Управляемый экземпляр **доступен во время операций обновления**, за исключением короткого простоя, вызванного отработкой отказа, происходящим в конце обновления. Обычно это занимает до 10 секунд даже в случае прерывания длительных транзакций благодаря [ускоренному восстановлению базы данных](../accelerated-database-recovery.md).

> [!IMPORTANT]
> Не рекомендуется масштабировать вычислительные ресурсы или хранилище Управляемый экземпляр SQL Azure, а также изменять уровень служб одновременно с длительными транзакциями (импорт данных, задания обработки данных, перестроение индекса и т. д.). Отработка отказа базы данных, которая будет выполнена в конце операции, приведет к отмене всех текущих транзакций.

SQL Управляемый экземпляр недоступен для клиентских приложений во время операций развертывания и удаления.

## <a name="management-operations-cross-impact"></a>Операции управления — перекрестное воздействие

Операции управления на управляемом экземпляре могут повлиять на другие операции управления экземплярами, размещенными в том же виртуальном кластере:

- **Длительные операции восстановления** в виртуальном кластере приводят к удержанию других операций создания экземпляра или масштабирования в той же подсети.<br/>**Пример:** Если при выполнении длительной операции восстановления имеется запрос на создание или масштабирование в той же подсети, выполнение этого запроса займет больше времени, так как перед продолжением операции восстановления произойдет ожидание его завершения.
    
- **Последующая операция создания или масштабирования экземпляра** помещается на удержании ранее инициированного экземпляра или масштаба экземпляра, который инициировал изменение размера виртуального кластера.<br/>**Пример:** Если в одной подсети в одном и том же виртуальном кластере есть несколько запросов Create и/или Scale, и один из них инициирует изменение размера виртуального кластера, все запросы, отправленные в течение 5 и более минут с момента, когда требовался изменение размера виртуального кластера, будут выполняться дольше, чем ожидалось, так как эти запросы должны ожидать завершения изменения размера, прежде чем возобновить работу.

- **Операции создания и масштабирования, отправленные в 5-минутном окне** , будут пакетированы и выполнены параллельно.<br/>**Пример:** Только один размер виртуального кластера будет выполнен для всех операций, отправленных в 5-минутном окне (измерение с момента выполнения запроса первой операции). Если другой запрос отправляется более чем за 5 минут после отправки первого, он будет ожидать завершения изменения виртуального кластера до начала выполнения.

> [!IMPORTANT]
> Операции управления, которые помещаются на удержании из-за другой выполняемой операции, будут автоматически возобновлены после выполнения условий для продолжения. Для возобновления временно приостановленных операций управления не требуется никаких действий пользователя.

## <a name="canceling-management-operations"></a>Отмена операций управления

В следующей таблице перечислены возможности отмены конкретных операций управления и типичных общих длительностей.

Категория  |Операция  |Отменяемого  |Предполагаемая длительность отмены  |
|---------|---------|---------|---------|
|Развертывание |Создание экземпляра |Нет |  |
|Обновление |Увеличение/уменьшение масштаба хранилища экземпляров (общего назначения) |Нет |  |
|Обновление |Увеличение/уменьшение масштаба хранилища экземпляров (критически важный для бизнеса) |Да |90% операций завершается за 5 минут. |
|Обновление |Вычисление экземпляра (виртуальных ядер) увеличение и уменьшение масштаба (общего назначения) |Да |90% операций завершается за 5 минут. |
|Обновление |Вычисление экземпляра (виртуальных ядер) увеличение и уменьшение масштаба (критически важный для бизнеса) |Да |90% операций завершается за 5 минут. |
|Обновление |Изменение уровня служб экземпляра (общего назначения для критически важный для бизнеса и наоборот) |Да |90% операций завершается за 5 минут. |
|DELETE |Удаление экземпляра |Нет |  |
|DELETE |Удаление виртуального кластера (в качестве операции, инициированной пользователем) |Нет |  |

# <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы отменить операцию управления, перейдите в колонку "Обзор" и щелкните поле уведомления текущей операции. С правой стороны появится экран с текущей операцией, и появится кнопка для отмены операции. После первого щелчка вам будет предложено снова нажать кнопку и подтвердить, что вы хотите отменить операцию.

[![Отмена операции](./media/management-operations-overview/canceling-operation.png)](./media/management-operations-overview/canceling-operation.png#lightbox)

После отправки и обработки запроса на отмену вы получите уведомление, если отправка отменена успешно.

Если отправленный запрос на отмену выполнен успешно, операция управления будет отменена через пару минут, что приведет к сбою.

![Результат операции отмены](./media/management-operations-overview/canceling-operation-result.png)

Если запрос на отмену завершился неудачей или кнопка Отмена неактивна, это означает, что операция управления перешла в состояние, которое не отменяется и что оно завершится через несколько минут. Операция управления продолжит выполнение до ее завершения.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Если у вас еще не установлен Azure PowerShell, см. раздел [Установка модуля Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps).

Чтобы отменить операцию управления, необходимо указать имя операции управления. Поэтому сначала используйте команду Get для получения списка операций, а затем отмените определенную операцию.

```powershell-interactive
$managedInstance = "yourInstanceName"
$resourceGroup = "yourResourceGroupName"

$managementOperations = Get-AzSqlInstanceOperation -ManagedInstanceName $managedInstance  -ResourceGroupName $resourceGroup

foreach ($mo in $managementOperations ) {
    if($mo.State -eq "InProgress" -and $mo.IsCancellable){
        $cancelRequest = Stop-AzSqlInstanceOperation -ResourceGroupName $resourceGroup -ManagedInstanceName $managedInstance -Name $mo.Name
        Get-AzSqlInstanceOperation -ManagedInstanceName $managedInstance  -ResourceGroupName $resourceGroup -Name $mo.Name
    }
}
```

Подробные сведения о командах см. в разделе [Get-азсклинстанцеоператион](https://docs.microsoft.com/powershell/module/az.sql/get-azsqlinstanceoperation) и [останавливает-азсклинстанцеоператион](https://docs.microsoft.com/powershell/module/az.sql/stop-azsqlinstanceoperation).

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Если вы еще не установили Azure CLI, обратитесь к разделу [Установка Azure CLI](/cli/azure/install-azure-cli?view=azure-cli-latest).

Чтобы отменить операцию управления, необходимо указать имя операции управления. Поэтому сначала используйте команду Get для получения списка операций, а затем отмените определенную операцию.

```azurecli-interactive
az sql mi op list -g yourResourceGroupName --mi yourInstanceName --query "[?state=='InProgress' && isCancellable].{Name: name}" -o tsv |
while read -r operationName; do
    az sql mi op cancel -g yourResourceGroupName --mi yourInstanceName -n $operationName
done
```

Подробное описание команд см. в разделе [AZ SQL MI Op](https://docs.microsoft.com/cli/azure/sql/mi/op?view=azure-cli-latest).

---

## <a name="next-steps"></a>Дальнейшие действия
- Сведения о создании первого управляемого экземпляра см. в разделе [Краткое руководство](instance-create-quickstart.md).
- Сведения о функциях и список сравнения см. в статье [Сравнение функций Базы данных SQL Azure и SQL Server](../database/features-comparison.md).
- Дополнительные сведения о конфигурации виртуальной сети см. в разделе [Конфигурация SQL управляемый экземпляр vnet](connectivity-architecture-overview.md).
- Краткое руководство по созданию управляемого экземпляра и восстановлению базы данных из файла резервной копии см. в разделе [Создание управляемого экземпляра](instance-create-quickstart.md).
- Руководство по использованию Azure Database Migration Service для миграции см. в разделе [Миграция SQL управляемый экземпляр с помощью Database Migration Service](../../dms/tutorial-sql-server-to-managed-instance.md).
