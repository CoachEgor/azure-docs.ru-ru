---
title: Концепция блокировки ресурсов
description: Узнайте о возможности блокировки для защиты ресурсов при назначении схемы.
author: DCtheGeek
ms.author: dacoulte
ms.date: 04/24/2019
ms.topic: conceptual
ms.service: blueprints
manager: carmonm
ms.custom: seodec18
ms.openlocfilehash: db0b5bbe1261c7bdf76393c69a1189d2a850cd07
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "64719752"
---
# <a name="understand-resource-locking-in-azure-blueprints"></a>Общие сведения о блокировке ресурсов в Azure Blueprint

Создавать крупные согласованные среды имеет смысл только при наличии механизма, поддерживающего эту согласованность. В этой статье рассказывается, как работает блокировка ресурсов в Azure Blueprint. Чтобы ознакомиться с примером блокировки ресурсов и практике применения _запретить назначения_, см. в разделе [защита новые ресурсы](../tutorials/protect-new-resources.md) руководства.

## <a name="locking-modes-and-states"></a>Режимы и состояния блокировки

Режим блокировки применяется для назначения схемы и имеет три варианта: **Не блокировать**, **Только чтение** или **Do Not Delete** (Не удалять). Режим блокировки настраивается во время развертывания артефактов при назначении схемы. Вы можете задать другой режим блокировки, обновив назначение схемы.
Тем не менее режим блокировки нельзя изменить вне службы Blueprints.

Ресурсы, созданные артефактами в составе назначения схемы, имеют четыре состояния: **Не заблокировано**, **Только чтение**, **Невозможно изменить/удалить** или **Cannot Delete** (Невозможно удалить). Каждый тип артефакта может находиться в состоянии **Не заблокировано**. Следующую таблицу можно использовать для определения состояния ресурса:

|Режим|Тип ресурса артефакта|Состояние|Описание|
|-|-|-|-|
|Не блокировать|*|Не заблокировано|Ресурсы не защищены службой Blueprints. Это состояние также используется для ресурсов, добавленных к артефакту группы ресурсов **Только чтение** или **Do Not Delete** (Не удалять) за пределами назначения схемы.|
|Только чтение|Группа ресурсов|Невозможно изменить/удалить|Группа ресурсов доступна только для чтения, и теги в этой группе недоступны для изменения. Ресурсы с состоянием **Не заблокировано** можно добавлять, перемещать, изменять или удалять из этой группы ресурсов.|
|Только чтение|Нересурсная группа|Только чтение|Ресурс невозможно изменить или удалить каким-либо образом.|
|Не удалять|*|Cannot Delete (Невозможно удалить)|Ресурсы можно изменить, но невозможно удалить. Ресурсы с состоянием **Не заблокировано** можно добавлять, перемещать, изменять или удалять из этой группы ресурсов.|

## <a name="overriding-locking-states"></a>Переопределение состояний блокировки

Обычно сохраняется возможность предоставить права на изменение и (или) удаление любого ресурса владельцу соответствующих прав [управления доступом на основе ролей](../../../role-based-access-control/overview.md) (RBAC) в подписке. Но эта возможность недоступна, если схема применяет блокировку в составе развернутого назначения. Если назначение было установлено с состоянием **Только чтение** или **Do Not Delete** (Не удалять), даже владелец подписки не сможет выполнять заблокированное действие для защищенного ресурса.

Эта мера предосторожности защищает согласованность определенной схемы и среды, для создания которой эта схема предназначается, от случайного или программного удаления либо изменения.

## <a name="removing-locking-states"></a>Удаление состояний блокировки

Если нужно изменить или удалить ресурс, защищенный назначением, это можно сделать двумя способами.

- Установить для назначения схемы режим блокировки с состоянием **Не блокировать**.
- Удалить назначение схемы.

После удаления назначения созданные схемами блокировки удаляются. Но при этом сам ресурс сохраняется. Его следует удалить обычными средствами.

## <a name="how-blueprint-locks-work"></a>Как работают блокировки схемы

Действие [запрета назначений](../../../role-based-access-control/deny-assignments.md) RBAC применяется к ресурсам артефактов во время назначения схемы, если для назначения выбрано состояние **Только чтение** или **Do Not Delete** (Не удалять). Запрещающее действие добавляется управляемым удостоверением назначения схемы и может быть удалено из ресурсов артефактов только тем же управляемым удостоверением. Эта мера предосторожности обеспечивает механизм блокировки и предотвращает попытки удалить блокировку схемы за пределами схемы.

![В рамках схемы deny назначения в группе ресурсов](../media/resource-locking/blueprint-deny-assignment.png)

[Запретить назначение свойства](../../../role-based-access-control/deny-assignments.md#deny-assignment-properties) для каждого из режимов, следующим образом:

|Режим |Permissions.Actions |Permissions.NotActions |Субъекты [i]. Тип |ExcludePrincipals [i]. Идентификатор | DoNotApplyToChildScopes |
|-|-|-|-|-|-|
|Только чтение |**\*** |**\*/ чтение** |SystemDefined («все») |Схема назначения и определяемых пользователем в **excludedPrincipals** |Группа ресурсов — _true_; Ресурс - _false_ |
|Не удалять |**\*/ DELETE** | |SystemDefined («все») |Схема назначения и определяемых пользователем в **excludedPrincipals** |Группа ресурсов — _true_; Ресурс - _false_ |

> [!IMPORTANT]
> Azure Resource Manager кэширует сведения о назначении роли на срок до 30 минут. Это означает, что действие запрета назначений для ресурсов схемы может не сразу вступать в полную силу. В течение этого периода сохраняется возможность удалить ресурс, который должен быть защищен блокировками схемы.

## <a name="exclude-a-principal-from-a-deny-assignment"></a>Исключение участника в назначении deny

В некоторых сценариях проектирования и безопасности, он может потребоваться исключить субъект из [запретить назначение](../../../role-based-access-control/deny-assignments.md) создает назначения схемы. Это делается в REST API, добавив до пяти значений **excludedPrincipals** массива в **блокировки** свойство при [назначение](/rest/api/blueprints/assignments/createorupdate).
Ниже приведен пример тела запроса, который включает в себя **excludedPrincipals**:

```json
{
  "identity": {
    "type": "SystemAssigned"
  },
  "location": "eastus",
  "properties": {
    "description": "enforce pre-defined simpleBlueprint to this XXXXXXXX subscription.",
    "blueprintId": "/providers/Microsoft.Management/managementGroups/{mgId}/providers/Microsoft.Blueprint/blueprints/simpleBlueprint",
    "locks": {
        "mode": "AllResourcesDoNotDelete",
        "excludedPrincipals": [
            "7be2f100-3af5-4c15-bcb7-27ee43784a1f",
            "38833b56-194d-420b-90ce-cff578296714"
        ]
    },
    "parameters": {
      "storageAccountType": {
        "value": "Standard_LRS"
      },
      "costCenter": {
        "value": "Contoso/Online/Shopping/Production"
      },
      "owners": {
        "value": [
          "johnDoe@contoso.com",
          "johnsteam@contoso.com"
        ]
      }
    },
    "resourceGroups": {
      "storageRG": {
        "name": "defaultRG",
        "location": "eastus"
      }
    }
  }
}
```

## <a name="next-steps"></a>Дальнейшие действия

- Выполните [защитить новые ресурсы](../tutorials/protect-new-resources.md) руководства.
- Ознакомьтесь с [жизненным циклом схемы](lifecycle.md).
- Узнайте, как использовать [статические и динамические параметры](parameters.md).
- Научитесь настраивать [последовательность схемы](sequencing-order.md).
- Узнайте, как [обновлять существующие назначения](../how-to/update-existing-assignments.md).
- Устраняйте проблемы, возникающие во время назначения схемы, с помощью [общих инструкций по устранению неполадок](../troubleshoot/general.md).