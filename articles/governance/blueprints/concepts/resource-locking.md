---
title: Концепция блокировки ресурсов
description: Узнайте о вариантах блокировки в чертежах Azure для защиты ресурсов при назначении чертежа.
ms.date: 03/25/2020
ms.topic: conceptual
ms.openlocfilehash: 94ed8efd0d6c654cba129dfc69fbfe5add7a0824
ms.sourcegitcommit: ea006cd8e62888271b2601d5ed4ec78fb40e8427
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81383588"
---
# <a name="understand-resource-locking-in-azure-blueprints"></a>Общие сведения о блокировке ресурсов в Azure Blueprint

Создавать крупные согласованные среды имеет смысл только при наличии механизма, поддерживающего эту согласованность. В этой статье рассказывается, как работает блокировка ресурсов в Azure Blueprint. Чтобы увидеть пример блокировки ресурсов и применения _заданий отказа,_ см. [protecting new resources](../tutorials/protect-new-resources.md)

> [!NOTE]
> Блокировки ресурсов, развернутые в проектах Azure, применяются только к ресурсам, развернутым в назначении чертежа. Существующие ресурсы, например в группах ресурсов, которые уже существуют, не добавляют сяков.

## <a name="locking-modes-and-states"></a>Режимы и состояния блокировки

Режим блокировки применяется к назначению чертежа и имеет три варианта: **Не блокировка,** **только читать**или **не удалять.** Режим блокировки настраивается во время развертывания артефактов при назначении схемы. Вы можете задать другой режим блокировки, обновив назначение схемы.
Однако режимы блокировки не могут быть изменены за пределами чертежей Azure.

Ресурсы, созданные артефактами в назначении чертежа, имеют четыре состояния: **Не заблокирован,** **прочитан только,** **не может изменить / Удалить,** или **не удалит.** Каждый тип артефакта может находиться в состоянии **Не заблокировано**. Следующую таблицу можно использовать для определения состояния ресурса:

|Режим|Тип ресурса артефакта|Состояние|Описание|
|-|-|-|-|
|Не блокировать|*|Не заблокировано|Ресурсы не защищены чертежами Azure. Это состояние также используется для ресурсов, добавленных к артефакту группы ресурсов **Только чтение** или **Do Not Delete** (Не удалять) за пределами назначения схемы.|
|Только для чтения|Группа ресурсов|Невозможно изменить/удалить|Группа ресурсов доступна только для чтения, и теги в этой группе недоступны для изменения. Ресурсы с состоянием **Не заблокировано** можно добавлять, перемещать, изменять или удалять из этой группы ресурсов.|
|Только для чтения|Нересурсная группа|Только для чтения|Ресурс невозможно изменить или удалить каким-либо образом.|
|Не удалять|*|Cannot Delete (Невозможно удалить)|Ресурсы можно изменить, но невозможно удалить. Ресурсы с состоянием **Не заблокировано** можно добавлять, перемещать, изменять или удалять из этой группы ресурсов.|

## <a name="overriding-locking-states"></a>Переопределение состояний блокировки

Обычно сохраняется возможность предоставить права на изменение и (или) удаление любого ресурса владельцу соответствующих прав [управления доступом на основе ролей](../../../role-based-access-control/overview.md) (RBAC) в подписке. Этот доступ не относится к случаям, когда чертежи Azure применяютблокировку в качестве части развернутого назначения. Если назначение было установлено с состоянием **Только чтение** или **Do Not Delete** (Не удалять), даже владелец подписки не сможет выполнять заблокированное действие для защищенного ресурса.

Эта мера предосторожности защищает согласованность определенной схемы и среды, для создания которой эта схема предназначается, от случайного или программного удаления либо изменения.

### <a name="assign-at-management-group"></a>Назначить в управленческой группе

Дополнительная опция, запрещающая владельцам подписок удалять назначение чертежа, заключается в назначении чертежа группе управления. В этом сценарии только **владельцы** группы управления имеют разрешения, необходимые для удаления назначения чертежа.

Чтобы назначить чертеж группе управления вместо подписки, aPI REST изменяет вызов, чтобы выглядеть следующим образом:

```http
PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{assignmentMG}/providers/Microsoft.Blueprint/blueprintAssignments/{assignmentName}?api-version=2018-11-01-preview
```

Группа управления, `{assignmentMG}` определяемая, должна быть либо в иерархии группы управления, либо быть той же группой управления, где сохраняется определение чертежа.

Тело запроса назначения чертежа выглядит следующим образом:

```json
{
    "identity": {
        "type": "SystemAssigned"
    },
    "location": "eastus",
    "properties": {
        "description": "enforce pre-defined simpleBlueprint to this XXXXXXXX subscription.",
        "blueprintId": "/providers/Microsoft.Management/managementGroups/{blueprintMG}/providers/Microsoft.Blueprint/blueprints/simpleBlueprint",
        "scope": "/subscriptions/{targetSubscriptionId}",
        "parameters": {
            "storageAccountType": {
                "value": "Standard_LRS"
            },
            "costCenter": {
                "value": "Contoso/Online/Shopping/Production"
            },
            "owners": {
                "value": [
                    "johnDoe@contoso.com",
                    "johnsteam@contoso.com"
                ]
            }
        },
        "resourceGroups": {
            "storageRG": {
                "name": "defaultRG",
                "location": "eastus"
            }
        }
    }
}
```

Ключевым отличием в этом органе запроса и `properties.scope` один назначается подписке является свойство. Это необходимое свойство должно быть установлено в подписке, к которую применяется назначение чертежа. Подписка должна быть прямым ребенком иерархии группы управления, в которой хранится назначение чертежа.

> [!NOTE]
> Проект, присвоенный области группы управления, по-прежнему выполняется как назначение чертежа уровня подписки. Разница лишь в том, где сохраняется назначение чертежа, чтобы владельцы подписок не удаляли назначение и связанные с ними блокировки.

## <a name="removing-locking-states"></a>Удаление состояний блокировки

Если нужно изменить или удалить ресурс, защищенный назначением, это можно сделать двумя способами.

- Установить для назначения схемы режим блокировки с состоянием **Не блокировать**.
- Удалить назначение схемы.

При удалении назначения блокиры, созданные чертежами Azure, удаляются. Но при этом сам ресурс сохраняется. Его следует удалить обычными средствами.

## <a name="how-blueprint-locks-work"></a>Как работают блокировки схемы

Действие [запрета назначений](../../../role-based-access-control/deny-assignments.md) RBAC применяется к ресурсам артефактов во время назначения схемы, если для назначения выбрано состояние **Только чтение** или **Do Not Delete** (Не удалять). Запрещающее действие добавляется управляемым удостоверением назначения схемы и может быть удалено из ресурсов артефактов только тем же управляемым удостоверением. Эта мера безопасности обеспечивает соблюдение механизма блокировки и предотвращает удаление блокировки чертежа за пределами чертежей Azure.

:::image type="content" source="../media/resource-locking/blueprint-deny-assignment.png" alt-text="Проект отказать в назначении в группе ресурсов" border="false":::

Свойства [назначения в](../../../role-based-access-control/deny-assignments.md#deny-assignment-properties) каждом режиме являются следующими:

|Режим |Разрешения.Действия |Permissions.NotActions |Руководители. Тип |ИсключитьПринципы. Id | DoNotApplyToChildScopes |
|-|-|-|-|-|-|
|Только для чтения |**\*** |**\*/Читайте** |СистемаОпределена (Все) |назначение чертежа и пользователь-определенный в **исключенныхПринципах** |Ресурсная группа - _правда;_ Ресурс - _ложный_ |
|Не удалять |**\*/удалить** | |СистемаОпределена (Все) |назначение чертежа и пользователь-определенный в **исключенныхПринципах** |Ресурсная группа - _правда;_ Ресурс - _ложный_ |

> [!IMPORTANT]
> Azure Resource Manager кэширует сведения о назначении роли на срок до 30 минут. Это означает, что действие запрета назначений для ресурсов схемы может не сразу вступать в полную силу. В течение этого периода сохраняется возможность удалить ресурс, который должен быть защищен блокировками схемы.

## <a name="exclude-a-principal-from-a-deny-assignment"></a>Исключить доверителя из назначения отрицания

В некоторых сценариях проектирования или безопасности может потребоваться исключить основной из [назначения отрицания,](../../../role-based-access-control/deny-assignments.md) которое создает назначение чертежа. Этот шаг выполняется в REST API путем добавления до пяти значений к **исключенному** массиву Principals в **свойстве замков** при [создании назначения.](/rest/api/blueprints/assignments/createorupdate) Следующее определение назначения является примером органа запроса, который включает **исключенныеПринципы:**

```json
{
  "identity": {
    "type": "SystemAssigned"
  },
  "location": "eastus",
  "properties": {
    "description": "enforce pre-defined simpleBlueprint to this XXXXXXXX subscription.",
    "blueprintId": "/providers/Microsoft.Management/managementGroups/{mgId}/providers/Microsoft.Blueprint/blueprints/simpleBlueprint",
    "locks": {
        "mode": "AllResourcesDoNotDelete",
        "excludedPrincipals": [
            "7be2f100-3af5-4c15-bcb7-27ee43784a1f",
            "38833b56-194d-420b-90ce-cff578296714"
        ]
    },
    "parameters": {
      "storageAccountType": {
        "value": "Standard_LRS"
      },
      "costCenter": {
        "value": "Contoso/Online/Shopping/Production"
      },
      "owners": {
        "value": [
          "johnDoe@contoso.com",
          "johnsteam@contoso.com"
        ]
      }
    },
    "resourceGroups": {
      "storageRG": {
        "name": "defaultRG",
        "location": "eastus"
      }
    }
  }
}
```

## <a name="exclude-an-action-from-a-deny-assignment"></a>Исключить действие из назначения отказа

Подобно [исключению основного](#exclude-a-principal-from-a-deny-assignment) при [назначении отказа](../../../role-based-access-control/deny-assignments.md) в назначении чертежа, можно исключить определенные [операции RBAC.](../../../role-based-access-control/resource-provider-operations.md) В **блоке свойств.locks,** в том же месте, где **исключены Принципы,** могут быть добавлены **исключенныеДействия:**

```json
"locks": {
    "mode": "AllResourcesDoNotDelete",
    "excludedPrincipals": [
        "7be2f100-3af5-4c15-bcb7-27ee43784a1f",
        "38833b56-194d-420b-90ce-cff578296714"
    ],
    "excludedActions": [
        "Microsoft.ContainerRegistry/registries/push/write",
        "Microsoft.Authorization/*/read"
    ]
},
```

В то время как **исключенные Принципы** должны `*` быть явными, **исключенные** позиции действия могут использоваться для сопоставления подстановочных карт операций RBAC.

## <a name="next-steps"></a>Следующие шаги

- Следуйте за учебником [по защите новых ресурсов.](../tutorials/protect-new-resources.md)
- Узнайте о [жизненном цикле чертежей.](lifecycle.md)
- Узнайте, как использовать [статические и динамические параметры](parameters.md).
- Научитесь настраивать [последовательность схемы](sequencing-order.md).
- Узнайте, как [обновлять существующие назначения](../how-to/update-existing-assignments.md).
- Устраняйте проблемы, возникающие во время назначения схемы, с помощью [общих инструкций по устранению неполадок](../troubleshoot/general.md).