---
title: Создание запроса и предоставление общего доступа к нему на портале Azure
description: В этом учебнике вы узнаете, как создать запрос Resource Graph и предоставить его в совместный доступ на портале Azure.
ms.date: 10/23/2019
ms.topic: tutorial
ms.openlocfilehash: 65b96da3bd9064f34d75d5e87f1fcf55336d9893
ms.sourcegitcommit: 39da2d9675c3a2ac54ddc164da4568cf341ddecf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2019
ms.locfileid: "73958560"
---
# <a name="tutorial-create-and-share-an-azure-resource-graph-query-in-the-azure-portal"></a>Руководство по Создание запроса Azure Resource Graph и предоставление общего доступа к нему на портале Azure

Обозреватель Azure Resource Graph позволяет выполнять запросы Resource Graph непосредственно на портале Azure. Существует два типа запросов. _Закрытый_ и _Общий_. Закрытый запрос сохраняется в параметрах портала Azure. Общий запрос, в свою очередь, является ресурсом Resource Manager и поддерживает управление через RBAC (управление доступом на основе ролей) и защиту с помощью блокировок ресурсов.

Сохраняя запросы на портале Azure, вы экономите время на поиск избранных или часто используемых запросов. Совместное использование запросов помогает команде добиться согласованности и повысить эффективность благодаря повторяемости.

В этом учебнике вы выполните следующие задачи.

> [!div class="checklist"]
> - Создание и удаление закрытого запроса
> - Создание общего запроса
> - Поиск общих запросов
> - Удаление общего запроса

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется подписка Azure. Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/), прежде чем начать работу.

## <a name="create-and-delete-a-private-query"></a>Создание и удаление закрытого запроса

Закрытые запросы доступны и видимы только той учетной записи, которая их создала. Так как они сохраняются в параметрах учетной записи на портале Azure , их можно создавать, использовать и удалять только через портал Azure. Закрытый запрос не является ресурсом Resource Manager. Чтобы создать закрытый запрос, выполните следующие действия.

1. В меню портала выберите **Все службы** или используйте поле поиска Azure в верхней части любой страницы. Найдите и выберите **Обозреватель Resource Graph**.

1. На вкладке **Запрос 1** на странице обозревателя Azure Resource Graph введите следующий запрос:

   ```kusto
   Resources
   | where type =~ 'Microsoft.Compute/virtualMachines'
   | summarize count() by tostring(properties.storageProfile.osDisk.osType)
   ```

   Щелкните **Выполнить запрос** и просмотрите результаты запроса на панели внизу.

   Дополнительные сведения об этом запросе см. в статье [Tutorial: Create and share an Azure Resource Graph query in the Azure portal](../samples/starter.md#count-virtual-machines-by-os-type) (Примеры. Подсчет количества виртуальных машин по типу ОС).


1. Выберите **Сохранить** или **Сохранить как**, введите имя **Число виртуальных машин по ОС**, сохраните выбранный тип **Закрытый запрос** и щелкните **Сохранить** в нижней части панели **Сохранение запроса**. В заголовке вкладки вместо **Запрос 1** отобразится **Число виртуальных машин по ОС**.

1. Перейдите на любую другую страницу портала Azure, а затем вернитесь к Обозревателю Azure Resource Graph. Обратите внимание, что сохраненный запрос здесь больше не отображается, и снова появилась вкладка **Запрос 1**.

1. Щелкните **Открыть запрос**. Убедитесь, что выбран тип **Закрытый запрос**. Сохраненное имя **Число виртуальных машин по ОС** теперь отображается в списке **Имя запроса**. Когда вы щелкнете ссылку на заголовке сохраненного запроса, он загружается на новую вкладку, имя которой совпадает с именем этого запроса.

   > [!NOTE] 
   >Когда открыт сохраненный запрос на вкладке с таким же именем, нажатие кнопки **Сохранить** обновляет этот запрос, сохраняя все внесенные изменения. Чтобы создать новый сохраненный запрос на основе текущего открытого запроса, щелкните **Сохранить как** и продолжайте тот же процесс, как при сохранении запроса с нуля.

1. Чтобы удалить сохраненный запрос, снова щелкните **Открыть запрос** и убедитесь, что для поля **Тип** задано значение **Закрытый запрос**. В строке сохраненного запроса `Count VMs by OS` выберите действие **Удалить** (значок корзины). Выберите **Да** в диалоговом окне подтверждения, чтобы завершить удаление запроса.
   Затем закройте панель **Открыть запрос**.

## <a name="create-a-shared-query"></a>Создание общего запроса

В отличие от закрытого, общий запрос является ресурсом Resource Manager. Это означает, что запрос сохраняется в группу ресурсов, им можно управлять с помощью RBAC, и его можно защитить с помощью блокировок ресурсов. Как и любой другой ресурс, он доступен для просмотра и использования любому пользователю, который имеет соответствующие разрешения.
Чтобы создать общий запрос, выполните следующие действия.

1. В меню портала выберите **Все службы** или используйте поле поиска Azure в верхней части любой страницы, чтобы найти и выбрать **Обозреватель Resource Graph**.

1. На вкладке **Запрос 1** на странице обозревателя Azure Resource Graph введите следующий запрос:

   ```kusto
   Resources
   | where type =~ 'Microsoft.Compute/virtualMachines'
   | summarize count() by tostring(properties.storageProfile.osDisk.osType)
   ```
    
   Щелкните **Выполнить запрос** и просмотрите результаты запроса на панели внизу.

   Дополнительные сведения об этом запросе см. в статье [Tutorial: Create and share an Azure Resource Graph query in the Azure portal](../samples/starter.md#count-virtual-machines-by-os-type) (Примеры. Подсчет количества виртуальных машин по типу ОС).

1. Щелкните **Сохранить** или **Сохранить как**.

   
   ![Сохранение запроса кнопкой "Сохранить"](../media/create-share-query/save-shared-query-buttons.png)

1. На панели **Сохранить запрос** введите имя **Число виртуальных машин по ОС**.

1. Также укажите тип **Общий запрос**, задайте в поле описания значение **Число виртуальных машин по типу ОС** и в поле **Подписка** выберите, где нужно создать ресурс запроса.

1. Сохраните установленный флажок **Опубликовать в группе ресурсов resource-graph-queries**, а в поле **Расположение группы ресурсов** оставьте значение **(США) Центрально-западная часть США**.

1. Щелкните **Сохранить** в нижней части панели **Сохранение запроса**. В заголовке вкладки вместо **Запрос 1** отобразится **Число виртуальных машин по ОС**. При первом использовании группы ресурсов **resource-graph-queries** сохранение займет больше времени, чем можно ожидать, поскольку одновременно создается группа ресурсов.
   
   ![Сохранение нового запроса в качестве общего запроса](../media/create-share-query/save-shared-query-window.png)

   > [!NOTE] 
   > Если вы хотите указать имя существующей группы ресурсов для сохранения общего запроса, снимите флажок **Опубликовать в группе ресурсов resource-graph-queries**. Использование для запросов именованной группы ресурсов по умолчанию упрощает обнаружение общих запросов. Также эта группа ресурсов более заметна. Но вы можете выбрать любую существующую группу ресурсов, например по соображениям безопасности и (или) с учетом существующих разрешений.

1. Перейдите на любую другую страницу портала Azure, а затем вернитесь к Обозревателю Azure Resource Graph. Обратите внимание, что сохраненный запрос здесь больше не отображается, и снова появилась вкладка **Запрос 1**.

1. Щелкните **Открыть запрос**. Убедитесь, что здесь выбран тип**Общий запрос**, а сочетание параметров **Подписка** и **Группа ресурсов** совпадают с реальным расположением запроса. Сохраненный элемент **Число виртуальных машин по ОС** теперь отображается в списке **Имя запроса**. Щелчок по ссылке в заголовке сохраненного запроса загружает этот запрос на новую вкладку, имя которой совпадает с именем запроса. Для общего запроса на вкладке рядом с заголовком отображается значок, обозначающий тип общего запроса.

   ![Отображение общего запроса с соответствующим значком](../media/create-share-query/show-saved-shared-query.png)

   > [!NOTE] 
   > Когда открыт сохраненный запрос на вкладке с таким же именем, кнопка **Сохранить** обновляет этот запрос, сохраняя все внесенные изменения. Чтобы создать новый сохраненный запрос, щелкните **Сохранить как** и продолжайте тот же процесс, как при сохранении запроса с нуля.

## <a name="discover-shared-queries"></a>Поиск общих запросов

Так как общий запрос является ресурсом Resource Manager, его можно найти несколькими способами.

- В обозревателе Azure Resource Graph щелкните **Открыть запрос** и выберите тип **Общий запрос**.
- Через страницу портала с запросами Resource Graph.
- Из группы ресурсов, в которой был сохранен этот общий запрос.
- С помощью запроса к Resource Graph.

### <a name="view-resource-graph-queries"></a>Просмотр запросов Resource Graph

На портале Azures страница запросов Resource Graph отображает все общие запросы, к которым есть доступ у учетной записи, с которой выполнен вход. Эта страница поддерживает фильтрацию по имени, подписке, группе ресурсов и другим свойствам запросов Resource Graph. Также с помощью этого интерфейса можно присваивать теги запросам Resource Graph, экспортировать и удалять их.

Выбор любого из запросов открывает страницу запроса Resource Graph. Как и для любого другого ресурса Resource Manager, на этой странице представлен интерактивный обзор данных, журнал действий, управление доступом и теги. Также вы можете применить блокировку ресурсов непосредственно на этой странице.

Откройте страницу запросов Resource Graph через меню портала, щелкнув элемент **Все службы** или применив поле поиска Azure в верхней части любой страницы. Найдите и выберите **обозреватель Resource Graph**.

### <a name="list-resource-groups-resources"></a>Вывода списка ресурсов групп ресурсов

Запрос Resource Graph включается в список вместе с другими ресурсами, которые входят в группу ресурсов.
Выбор любого из запросов Resource Graph открывает страницу этого запроса. Элементы меню, которые открываются значком многоточия и щелчком правой кнопки мыши (контекстного меню) работают так же, как и на странице запроса Resource Graph.

### <a name="query-resource-graph"></a>Запрос в Resource Graph

Запросы Resource Graph можно найти с помощью запроса к Resource Graph. Следующий запрос Resource Graph ограничивает выводимые запросы типом `Microsoft.ResourceGraph/queries`, а затем применяет `project`, чтобы список содержал только имя, время изменения и сам текст запроса:

```kusto
Resources
| where type == "microsoft.resourcegraph/queries"
| project name, properties.timeModified, properties.query
```

## <a name="delete-a-shared-query"></a>Удаление общего запроса

Если общий запрос больше не нужен, удалите его. При удалении общего запроса удаляется соответствующий ресурс Resource Manager. После этого все панели мониторинга, на которых была закреплена схема результатов, будут отображать сообщение об ошибке. Когда отображается такое сообщение об ошибке, кнопкой **Удалить с панели мониторинга** вы можете очистить панель мониторинга.

Общий запрос можно удалить с помощью следующих интерфейсов:
- страница запросов Resource Graph;
- страница запроса Resource Graph;
- страница **Открыть запрос** в Обозревателе Resource Graph;
- страница групп ресурсов.

## <a name="clean-up-resources"></a>Очистка ресурсов

После завершения работы с этим учебником удалите все созданные для него закрытые и общие запросы, если они больше не нужны.

## <a name="next-steps"></a>Дополнительная информация

- Выполните свой первый запрос с помощью [портала Azure](../first-query-portal.md).
- Получите более подробную информацию о [языке запросов](../concepts/query-language.md).
- Дополнительные сведения об [исследовании ресурсов](../concepts/explore-resources.md).
- Изучите примеры [базовых запросов](../samples/starter.md).
- Ознакомьтесь с примерами [усложненных запросов](../samples/advanced.md).
- Оставьте отзыв с помощью [UserVoice](https://feedback.azure.com/forums/915958-azure-governance).