---
title: Создание политик для свойств массива ресурсов
description: Узнайте, как работать с параметрами массива и выражениями языка массива, оценивать псевдоним [*] и добавлять элементы с помощью правил определения Политики Azure.
ms.date: 05/20/2020
ms.topic: how-to
ms.openlocfilehash: f3d30f76d555386e5ab8041a0b8cc82b5b60e28e
ms.sourcegitcommit: 50673ecc5bf8b443491b763b5f287dde046fdd31
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2020
ms.locfileid: "83684252"
---
# <a name="author-policies-for-array-properties-on-azure-resources"></a>Создание политик для свойств массива ресурсов Azure

Свойства Azure Resource Manager обычно определяются как строки и логические значения. Если существует связь "один ко многим", то сложные свойства определяются как массивы. В Политике Azure массивы используются несколькими различными способами:

- тип [параметра определения](../concepts/definition-structure.md#parameters) для предоставления нескольких параметров;
- часть [правила политики](../concepts/definition-structure.md#policy-rule) с использованием условий **in** или **notIn**;
- часть правила политики, которая оценивает [псевдоним \[\*\]](../concepts/definition-structure.md#understanding-the--alias):
  - такие сценарии, как **Нет**, **Любое** или **Все**;
  - сложные сценарии с **count**;
- В [действии добавления](../concepts/effects.md#append) для замены или добавления в существующий массив.

В этой статье рассматривается каждый вариант использования в Политике Azure и приводится несколько примеров определений.

## <a name="parameter-arrays"></a>Массивы параметров

### <a name="define-a-parameter-array"></a>Определение массива параметров

Определение параметра в качестве массива обеспечивает гибкость политики, если требуется более одного значения.
Это определение политики допускает любое отдельное расположение в параметре **allowedLocations** и по умолчанию использует значение _eastus2_:

```json
"parameters": {
    "allowedLocations": {
        "type": "string",
        "metadata": {
            "description": "The list of allowed locations for resources.",
            "displayName": "Allowed locations",
            "strongType": "location"
        },
        "defaultValue": "eastus2"
    }
}
```

Так как параметр **type** имеет значение _string_, при назначении этой политики можно задать только одно значение. При назначении этой политики ресурсы в области допускаются только в пределах одного региона Azure. Большинство определений политик должно допускать список утвержденных параметров, например _eastus2_, _eastus_ и _westus2_.

Чтобы создать определение политики, допускающее несколько параметров, используйте свойство **type** со значением _array_. Эту же политику можно переписать следующим образом:

```json
"parameters": {
    "allowedLocations": {
        "type": "array",
        "metadata": {
            "description": "The list of allowed locations for resources.",
            "displayName": "Allowed locations",
            "strongType": "location"
        },
        "defaultValue": "eastus2",
        "allowedValues": [
            "eastus2",
            "eastus",
            "westus2"
        ]

    }
}
```

> [!NOTE]
> После сохранения определения политики изменить свойство **type** параметра невозможно.

Это новое определение параметра принимает более одного значения во время назначения политики. Если определено свойство массива **allowedValues**, значения, доступные во время назначения, дополнительно ограничиваются предопределенным списком. Использовать **allowedValues** необязательно.

### <a name="pass-values-to-a-parameter-array-during-assignment"></a>Передача значений в массив параметров во время назначения

При назначении политики с помощью портала Azure параметр с **типом** _массива_ отображается как одно текстовое поле. В подсказке указано "Указывайте значения через ;. (например, Лондон;Нью-Йорк)". Чтобы передать допустимые значения расположения _eastus2_, _eastus_ и _westus2_ в параметр, используйте следующую строку:

`eastus2;eastus;westus2`

Формат значения параметра различается при использовании Azure CLI, Azure PowerShell или REST API. Значения передаются в строке JSON, которая также содержит имя параметра.

```json
{
    "allowedLocations": {
        "value": [
            "eastus2",
            "eastus",
            "westus2"
        ]
    }
}
```

Чтобы использовать эту строку с каждым пакетом SDK, выполните следующие команды:

- Azure CLI: команда [az policy assignment create](/cli/azure/policy/assignment?view=azure-cli-latest#az-policy-assignment-create) с параметром **params**;
- Azure PowerShell: командлет [New-AzPolicyAssignment](/powershell/module/az.resources/New-Azpolicyassignment) с параметром **PolicyParameter**;
- REST API: операция _PUT_ [create](/rest/api/resources/policyassignments/create) в тексте запроса в качестве значения свойства **properties.parameters**.

## <a name="policy-rules-and-arrays"></a>Правила политики и массивы

### <a name="array-conditions"></a>Условия массива

Параметр _типа_
**массива** можно использовать только с [условиями](../concepts/definition-structure.md#conditions) правила политики `in` и `notIn`. В качестве примера возьмем следующее определение политики с условием `equals`:

```json
{
  "policyRule": {
    "if": {
      "not": {
        "field": "location",
        "equals": "[parameters('allowedLocations')]"
      }
    },
    "then": {
      "effect": "audit"
    }
  },
  "parameters": {
    "allowedLocations": {
      "type": "Array",
      "metadata": {
        "description": "The list of allowed locations for resources.",
        "displayName": "Allowed locations",
        "strongType": "location"
      }
    }
  }
}
```

Попытка создать определение политики с помощью портала Azure приводит к ошибке наподобие следующей:

- "Политику "{GUID}" не удалось параметризовать из-за ошибок проверки. Убедитесь в том, что параметры политики определены правильно. Внутреннее исключение: "Результат вычисления выражения языка "[parameters('allowedLocations')]" имеет тип "Array"; ожидаемый тип — "String"."

Ожидаемый **тип** условия `equals` — _string_. Так как **allowedLocations** определен с **типом** _массива_, подсистема политик вычисляет выражение языка и выдает ошибку. При условии `in` и `notIn` подсистема политик ожидает **тип** _массива_ в выражении языка. Чтобы устранить эту ошибку, измените `equals` на `in` или `notIn`.

### <a name="evaluating-the--alias"></a>Вычисление псевдонима [*]

Псевдонимы, к именам которых добавлена строка **\[\*\]** , имеют **тип** _массива_. Вместо вычисления значения всего массива **\[\*\]** позволяет вычислить каждый элемент массива по отдельности с логическим И между элементами. Существует три стандартных сценария, в которых полезно вычисление отдельных элементов: совпадение с _ни одним_, _любым_ или _всеми_ элементами. В сложных сценариях используйте [count](../concepts/definition-structure.md#count).

Подсистема политик активирует **действие** в блоке **then** только в том случае, если правило **if** имеет значение true.
Этот факт важен для понимания того, как **\[\*\]** вычисляет каждый отдельный элемент массива.

Вот пример правила политики для приведенной ниже таблицы сценариев:

```json
"policyRule": {
    "if": {
        "allOf": [
            {
                "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules",
                "exists": "true"
            },
            <-- Condition (see table below) -->
        ]
    },
    "then": {
        "effect": "[parameters('effectType')]"
    }
}
```

Массив **ipRules** для приведенной ниже таблицы сценариев выглядит так:

```json
"ipRules": [
    {
        "value": "127.0.0.1",
        "action": "Allow"
    },
    {
        "value": "192.168.1.1",
        "action": "Allow"
    }
]
```

Для каждого примера условия ниже замените `<field>` на `"field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*].value"`.

Ниже приведены результаты сочетания условия с примером правила политики и массивом существующих значений, приведенными выше.

|Условие |Результат | Сценарий |Объяснение |
|-|-|-|-|
|`{<field>,"notEquals":"127.0.0.1"}` |Ничего |Ни одного совпадения |Один элемент массива вычисляется как false (127.0.0.1 != 127.0.0.1), а другой — как true (127.0.0.1 != 192.168.1.1), поэтому условие **notEquals** имеет значение _false_ и действие не активируется. |
|`{<field>,"notEquals":"10.0.4.1"}` |Эффект политики |Ни одного совпадения |Оба элемента массива вычисляются как true (10.0.4.1 != 127.0.0.1 и 10.0.4.1 != 192.168.1.1), поэтому условие **notEquals** имеет значение _true_ и действие активируется. |
|`"not":{<field>,"notEquals":"127.0.0.1" }` |Эффект политики |Одно или несколько совпадений |Один элемент массива вычисляется как false (127.0.0.1 != 127.0.0.1), а другой — как true (127.0.0.1 != 192.168.1.1), поэтому условие **notEquals** имеет значение _false_. Логический оператор вычисляется как true (**не** _false_), поэтому действие активируется. |
|`"not":{<field>,"notEquals":"10.0.4.1"}` |Ничего |Одно или несколько совпадений |Оба элемента массива вычисляются как true (10.0.4.1 != 127.0.0.1 и 10.0.4.1 != 192.168.1.1), поэтому условие **notEquals** имеет значение _true_. Логический оператор вычисляется как false (**не** _true_), поэтому действие не активируется. |
|`"not":{<field>,"Equals":"127.0.0.1"}` |Эффект политики |Не все совпадают |Один элемент массива вычисляется как true (127.0.0.1 == 127.0.0.1), а другой — как false (127.0.0.1 == 192.168.1.1), поэтому условие **Equals** имеет значение _false_. Логический оператор вычисляется как true (**не** _false_), поэтому действие активируется. |
|`"not":{<field>,"Equals":"10.0.4.1"}` |Эффект политики |Не все совпадают |Оба элемента массива вычисляются как false (10.0.4.1 == 127.0.0.1 и 10.0.4.1 == 192.168.1.1), поэтому условие **Equals** имеет значение _false_. Логический оператор вычисляется как true (**не** _false_), поэтому действие активируется. |
|`{<field>,"Equals":"127.0.0.1"}` |Ничего |Совпадают все |Один элемент массива вычисляется как true (127.0.0.1 == 127.0.0.1), а другой — как false (127.0.0.1 == 192.168.1.1), поэтому условие **Equals** имеет значение _false_ и действие не активируется. |
|`{<field>,"Equals":"10.0.4.1"}` |Ничего |Совпадают все |Оба элемента массива вычисляются как false (10.0.4.1 == 127.0.0.1 и 10.0.4.1 == 192.168.1.1), поэтому условие **Equals** имеет значение _false_ и действие не активируется. |

## <a name="the-append-effect-and-arrays"></a>Действие добавления и массивы

[Действие добавления](../concepts/effects.md#append) выполняется по-разному в зависимости от того, является ли **details.field** псевдонимом **\[\*\]** .

- Если поле не является псевдонимом **\[\*\]** , действие добавления заменяет весь массив свойством **value**.
- Если поле является псевдонимом **\[\*\]** , действие добавления добавляет свойство **value** в существующий массив или создает новый массив.

Дополнительные сведения см. в [примерах добавления](../concepts/effects.md#append-examples).

## <a name="next-steps"></a>Дальнейшие действия

- Изучите примеры на странице [примеров Политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](../concepts/definition-structure.md).
- Изучите [сведения о действии политик](../concepts/effects.md).
- Узнайте о [программном создании политик](programmatically-create.md).
- Узнайте, как [исправлять несоответствующие ресурсы](remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
