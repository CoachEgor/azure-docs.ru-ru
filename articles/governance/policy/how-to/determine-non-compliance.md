---
title: Определение причин несоответствия требованиям
description: Когда ресурс не соответствует требованиям, существует множество возможных причин. Узнайте, что стало причиной несоблюдения.
ms.date: 04/26/2019
ms.topic: how-to
ms.openlocfilehash: c931831ddf3cc727b9861e75969eac3bf00c9e45
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79264639"
---
# <a name="determine-causes-of-non-compliance"></a>Определение причин несоответствия требованиям

Когда ресурс Azure определяется как несовместимый с правилом политики, полезно понять, какая часть правила, с которой ресурс не соответствует. Также полезно понять, какие изменения изменили ранее соответствующий ресурс, чтобы сделать его несовместимым. Существует два способа найти эту информацию:

> [!div class="checklist"]
> - [Детали соответствия](#compliance-details)
> - [Журнал изменений (предварительная версия)](#change-history)

## <a name="compliance-details"></a>Детали соответствия

Если ресурс не соответствует требованиям, сведения о соответствии этому ресурсу доступны на странице **соответствия политике.** Панель детали соответствия включает в себя следующую информацию:

- Данные о ресурсах, такие как имя, тип, местоположение и идентификатор ресурса
- Состояние соответствия и метка времени последней оценки для текущего назначения политики
- Перечень _причин_ несоблюдения ресурса

> [!IMPORTANT]
> Поскольку сведения о соответствии для ресурса, не _совместимого с_ требованиями, показывают текущую ценность свойств на этом ресурсе, пользователь должен **прочитать** операцию по **типу** ресурса. Например, если _ресурсом, не совместимым_ с требованиями, является **Microsoft.Compute/virtualMachines,** то пользователь должен иметь операцию **Microsoft.Compute/virtualMachines/read.** Если у пользователя нет необходимой операции, отображается ошибка доступа.

Чтобы просмотреть сведения о соответствии, выполните следующие действия:

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. На странице **«Обзор»** или **«Соответствие»** выберите политику в **состоянии соответствия,** которое _не соответствует_требованиям.

1. В соответствии со вкладкой **соответствия требованиям ресурсов** страницы **соответствия Политике,** нажмите право йгнули или выберите эллипсис ресурса в **состоянии соответствия,** которое _не соответствует_требованиям. Затем выберите **сведения о соответствии.**

   ![Просмотр опции комплаенс-детали](../media/determine-non-compliance/view-compliance-details.png)

1. **Панель комплаенс отображает** информацию от последней оценки ресурса до текущего назначения политики. В этом примере поле **Microsoft.Sql/серверы/версия** оказывается _12.0,_ в то время как определение политики ожидается _14.0_. Если ресурс не соответствует требованиям по нескольким причинам, каждый из них указан на этом панели.

   ![Детали соответствия панели и причины несоблюдения](../media/determine-non-compliance/compliance-details-pane.png)

   Для определения политики **auditIfNotExists** или **deployIfNotExists** детали включают свойство **details.type** и любые дополнительные свойства. Для списка см. [свойства auditIfNotExists](../concepts/effects.md#auditifnotexists-properties) и [свойства deployIfNotExists.](../concepts/effects.md#deployifnotexists-properties) **Последний оцененный ресурс** — это связанный ресурс из **раздела детализации** определения.

   Пример **частичного развертыванияIfNotExists** определение:

   ```json
   {
       "if": {
           "field": "type",
           "equals": "[parameters('resourceType')]"
       },
       "then": {
           "effect": "DeployIfNotExists",
           "details": {
               "type": "Microsoft.Insights/metricAlerts",
               "existenceCondition": {
                   "field": "name",
                   "equals": "[concat(parameters('alertNamePrefix'), '-', resourcegroup().name, '-', field('name'))]"
               },
               "existenceScope": "subscription",
               "deployment": {
                   ...
               }
           }
       }
   }
   ```

   ![Детали соответствия панели - «ifNotExists](../media/determine-non-compliance/compliance-details-pane-existence.png)

> [!NOTE]
> Для защиты данных, когда значение свойства является _секретом,_ текущее значение отображает звездочки.

Эти сведения объясняют, почему ресурс в настоящее время не соответствует требованиям, но не отображаются, когда было внесено изменение ресурса, из-за которого он стал несоответствующим. Для получения этой информации ниже приведена [история изменений (Предварительный просмотр).](#change-history)

### <a name="compliance-reasons"></a>Причины соблюдения

Следующие матрицы карты каждой возможной _причины_ ответственного [состояния](../concepts/definition-structure.md#conditions) в определении политики:

|Причина | Условие |
|-|-|
|Текущее значение должно содержать целевое значение в качестве ключа. |containsKey или **неContainsKey** |
|Текущее значение должно содержать целевое значение. |содержит или **неСодержит** |
|Текущее значение должно быть равным целевому значению. |равняется или **неEquals** |
|Текущее значение должно быть меньше целевого значения. |меньше или **не** большеРавно |
|Текущее значение должно быть больше или равно целевому значению. |большеОУравов или **не** меньше |
|Текущее значение должно быть больше целевого значения. |больше или **не** менееОУрает |
|Текущее значение должно быть меньше целевого значения или равняться его. |меньшеОравноили или **не** больше |
|Текущее значение должно существовать. |exists (существует) |
|Текущее значение должно быть в целевом значении. |в или **нетВ** |
|Текущее значение должно быть как целевое значение. |нравится или **неlike** |
|Текущее значение должно соответствовать целевому значению. |матч или **нетМатч** |
|Текущее значение должно соответствовать целевому значению. |матчНечувствительно **not** или нематчНечувствительно |
|Текущее значение не должно содержать целевое значение в качестве ключа. |notContainsKey или **не** содержитКлюч|
|Текущее значение не должно содержать целевое значение. |неСодержит или **не** содержит |
|Текущее значение не должно быть равен целевому значению. |notEquals или **не** равны |
|Текущее значение не должно существовать. |**не** существует  |
|Текущее значение не должно находиться в целевом значении. |не в или **не** в |
|Текущее значение не должно быть как целевое значение. |не нравится или **не** нравится |
|Текущее значение не должно соответствовать целевому значению. |notMatch или **не совпадают** |
|Текущее значение не должно соответствовать целевому значению. |notMatchInsensitively или **не** соответствуетНечувствительно |
|Никакие связанные ресурсы не соответствуют деталям эффекта в определении политики. |Ресурс типа, определенный **в then.details.type** и связанный с ресурсом, определенным в **части** правила политики, не существует. |

## <a name="compliance-details-for-guest-configuration"></a>Детали соответствия для конфигурации гостей

Для _политик auditIfNotExists_ в категории _«Конфигурация гостей»_ может быть оценено несколько параметров внутри VM, и вам нужно будет просматривать детали по настройке. Например, если вы проводите аудит для списка политик паролей и только одна из них имеет статус _Несовместимые,_ вам нужно знать, какие конкретные политики паролей не соответствуют требованиям и почему.

Вы также не можете иметь доступ для входе в VM непосредственно, но вы должны сообщить о том, почему VM _не соответствует_требованиям.

### <a name="azure-portal"></a>Портал Azure

Начните с тех же шагов в разделе выше для просмотра деталей соответствия политике.

В **деталях соответствия** просмотреть панель нажмите на ссылку **Последний оцененный ресурс**.

   ![Просмотр деталей определения auditIfNotExists](../media/determine-non-compliance/guestconfig-auditifnotexists-compliance.png)

Страница **«Назначение гостей»** отображает все доступные сведения о соответствии. Каждая строка в представлении представляет собой оценку, которая была выполнена внутри машины. В столбце **«Причина»** отображается фраза, описывающая, почему назначение гостя _не соответствует требованиям._ Например, при аудите политики паролей в столбце **Reason** будет отображаться текст, включающий текущее значение для каждого параметра.

![Просмотр сведений о соответствии](../media/determine-non-compliance/guestconfig-compliance-details.png)

### <a name="azure-powershell"></a>Azure PowerShell

Вы также можете просматривать сведения о соответствии от Azure PowerShell. Во-первых, убедитесь, что у вас установлен модуль конфигурации гостей.

```azurepowershell-interactive
Install-Module Az.GuestConfiguration
```

Вы можете просмотреть текущее состояние всех гостевых назначений для VM, используя следующую команду:

```azurepowershell-interactive
Get-AzVMGuestPolicyReport -ResourceGroupName <resourcegroupname> -VMName <vmname>
```

```output
PolicyDisplayName                                                         ComplianceReasons
-----------------                                                         -----------------
Audit that an application is installed inside Windows VMs                 {[InstalledApplication]bwhitelistedapp}
Audit that an application is not installed inside Windows VMs.            {[InstalledApplication]NotInstalledApplica...
```

Чтобы просмотреть только _причину_ фразы, которая описывает, почему VM _не соответствует,_ верните только свойство ребенка Причина ребенка.

```azurepowershell-interactive
Get-AzVMGuestPolicyReport -ResourceGroupName <resourcegroupname> -VMName <vmname> | % ComplianceReasons | % Reasons | % Reason
```

```output
The following applications are not installed: '<name>'.
```

Можно также вывести историю соответствия требованиям для назначений гостей в области для машины. Выход из этой команды включает в себя детали каждого отчета для VM.

> [!NOTE]
> Выход может вернуть большой объем данных. Рекомендуется хранить выход в переменной.

```azurepowershell-interactive
$guestHistory = Get-AzVMGuestPolicyStatusHistory -ResourceGroupName <resourcegroupname> -VMName <vmname>
$guestHistory
```

```output
PolicyDisplayName                                                         ComplianceStatus ComplianceReasons StartTime              EndTime                VMName LatestRepor
                                                                                                                                                                  tId
-----------------                                                         ---------------- ----------------- ---------              -------                ------ -----------
[Preview]: Audit that an application is installed inside Windows VMs      NonCompliant                       02/10/2019 12:00:38 PM 02/10/2019 12:00:41 PM VM01  ../17fg0...
<truncated>
```

Чтобы упростить это представление, используйте параметр **ShowChanged.** Выход из этой команды включает только отчеты, которые последовали за изменением статуса соответствия.

```azurepowershell-interactive
$guestHistory = Get-AzVMGuestPolicyStatusHistory -ResourceGroupName <resourcegroupname> -VMName <vmname> -ShowChanged
$guestHistory
```

```output
PolicyDisplayName                                                         ComplianceStatus ComplianceReasons StartTime              EndTime                VMName LatestRepor
                                                                                                                                                                  tId
-----------------                                                         ---------------- ----------------- ---------              -------                ------ -----------
Audit that an application is installed inside Windows VMs                 NonCompliant                       02/10/2019 10:00:38 PM 02/10/2019 10:00:41 PM VM01  ../12ab0...
Audit that an application is installed inside Windows VMs.                Compliant                          02/09/2019 11:00:38 AM 02/09/2019 11:00:39 AM VM01  ../e3665...
Audit that an application is installed inside Windows VMs                 NonCompliant                       02/09/2019 09:00:20 AM 02/09/2019 09:00:23 AM VM01  ../15ze1...
```

## <a name="change-history-preview"></a><a name="change-history"/>Журнал изменений (предварительная версия)

В рамках нового **публичного предварительного просмотра**последние 14 дней истории изменений доступны для всех ресурсов Azure, поддерживающих [полное удаление режима.](../../../azure-resource-manager/templates/complete-mode-deletion.md) Журнал изменений содержит подробные сведения о том, когда было обнаружено изменение и _отличия между визуальными элементами_ для каждого изменения. Обнаружение изменений срабатывает при добавлении, удалении или изменении свойств менеджера ресурсов.

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. На странице **«Обзор»** или **«Соответствие»** выберите политику в любом **состоянии соответствия.**

1. В соответствии со вкладкой **соответствия ресурса** странице **соответствия политике** выберите ресурс.

1. На странице **Соответствие ресурсов** выберите вкладку **Журнал изменений (предварительная версия)**. После этого отобразится список обнаруженных изменений (при наличии).

   ![Вкладка истории изменения политики Azure на странице соответствия ресурсам](../media/determine-non-compliance/change-history-tab.png)

1. Выберите одно из обнаруженных изменений. _Визуальный дифф_ для ресурса представлен на странице **истории изменений.**

   ![История изменения политики Azure Visual Diff на странице истории изменений](../media/determine-non-compliance/change-history-visual-diff.png)

_Отличия между визуальными элементами_ позволяют обнаружить изменения ресурса. Обнаруженные изменения могут не быть связаны с текущим состоянием соответствия ресурса.

Данные истории изменений предоставляются [Azure Resource Graph](../../resource-graph/overview.md). Чтобы зазыть эту информацию за пределами портала Azure, [см.](../../resource-graph/how-to/get-resource-changes.md)

## <a name="next-steps"></a>Дальнейшие действия

- Просмотрите [примеры на примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](../concepts/definition-structure.md).
- Изучите [сведения о действии политик](../concepts/effects.md).
- Понять, как [программно создавать политики.](programmatically-create.md)
- Узнайте, как [получить данные о соответствии.](get-compliance-data.md)
- Узнайте, как [исправления несовместимых ресурсов.](remediate-resources.md)
- Просмотрите, что представляет собой группа управления с [организацией ресурсов с группами управления Azure.](../../management-groups/overview.md)
