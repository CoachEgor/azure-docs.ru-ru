---
title: Определение причин несоответствия требованиям
description: Если ресурс не соответствует требованиям, возможных причин этого множество. Узнайте, как находить то, что привело к несоответствию.
ms.date: 07/06/2020
ms.topic: how-to
ms.openlocfilehash: d548f5b9db141eb6aed5984c43f00543d0228f31
ms.sourcegitcommit: f684589322633f1a0fafb627a03498b148b0d521
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/06/2020
ms.locfileid: "85970779"
---
# <a name="determine-causes-of-non-compliance"></a>Определение причин несоответствия требованиям

Если ресурс Azure определен как не соответствующий правилу политики, полезно понять, какой части правила он не соответствует. Также полезно понять, какое изменение ранее соответствовавшего ресурса сделало его несоответствующим. Эту информацию можно найти через два источника:

- [Сведения о соответствии](#compliance-details)
- [Журнал изменений (предварительная версия)](#change-history)

## <a name="compliance-details"></a>Сведения о соответствии

Если ресурс не соответствует требованиям, сведения о соответствии для этого ресурса доступны на странице **Соответствия политике**. Область сведений о соответствии содержит следующие сведения:

- Сведения о ресурсе, такие как имя, тип, расположение и идентификатор ресурса.
- Состояние соответствия и отметка времени последней оценки для текущего назначения политики.
- Список _причин_ несоответствия ресурса.

> [!IMPORTANT]
> Так как сведения о соответствии для _Несоответствующего_ ресурса показывают текущее значение свойств этого ресурса, пользователь должен иметь операцию **чтения** для **типа** ресурса. Например, если _Несоответствующий_ ресурсом является **Microsoft.Compute/virtualMachines**, то пользователь должен иметь операцию **Microsoft.Compute/virtualMachines/read**. Если у пользователя нет необходимой операции, отображается ошибка доступа.

Чтобы просмотреть сведения о соответствии, выполните следующие действия.

1. Запустите службу Политика Azure на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. На странице **Обзор** или **Соответствие** выберите политику, с **состоянием соответствия** _Не соответствует_.

1. На вкладке **Соответствие ресурса** страницы **Соответствие политике** щелкните правой кнопкой мыши или выберите многоточие ресурса с **состоянием соответствия** _Не соответствует_. Затем выберите **Просмотреть сведения о соответствии**.

   :::image type="content" source="../media/determine-non-compliance/view-compliance-details.png" alt-text="Параметр просмотра сведений о соответствии" border="false":::

1. Панель **Сведения о соответствии** отображает информацию от последней оценки ресурса до назначения текущей политики. В этом примере поле **Microsoft. SQL/Servers/Version** содержит _12.0_, в то время как определение политики ожидало _14.0_. Если ресурс не соответствует требованиям по нескольким причинам, каждая из них отображается на этой панели.

   :::image type="content" source="../media/determine-non-compliance/compliance-details-pane.png" alt-text="Область сведений о соответствии и причины несоответствия" border="false":::

   Для определения политики **auditIfNotExists** или **deployIfNotExists** сведения включают в себя свойство **details.type** и любые дополнительные свойства. Список см. в разделах [свойства auditIfNotExists](../concepts/effects.md#auditifnotexists-properties) и [свойства deployIfNotExists](../concepts/effects.md#deployifnotexists-properties). **Последний оцененный ресурс** — это связанный ресурс из раздела **сведений** определения.

   Пример частичного определения **deployIfNotExists**:

   ```json
   {
       "if": {
           "field": "type",
           "equals": "[parameters('resourceType')]"
       },
       "then": {
           "effect": "DeployIfNotExists",
           "details": {
               "type": "Microsoft.Insights/metricAlerts",
               "existenceCondition": {
                   "field": "name",
                   "equals": "[concat(parameters('alertNamePrefix'), '-', resourcegroup().name, '-', field('name'))]"
               },
               "existenceScope": "subscription",
               "deployment": {
                   ...
               }
           }
       }
   }
   ```

   :::image type="content" source="../media/determine-non-compliance/compliance-details-pane-existence.png" alt-text="Область сведений о соответствии — *ifNotExists" border="false":::

> [!NOTE]
> Для защиты данных, если значение свойства является _секретом_, текущее значение отображает звездочки.

В этих сведениях объясняется, почему ресурс в настоящее время не соответствует требованиям, но не показывается, когда было внесено изменение в ресурс, вызвавшее это несоответствие. Информацию о последнем см. в разделе [Журнал изменений (предварительная версия)](#change-history) ниже.

### <a name="compliance-reasons"></a>Причины соответствия

Следующая матрица показывает каждую из возможных _причин_ вызвавшего несоответствие [условия](../concepts/definition-structure.md#conditions) в определении политики:

|Причина | Условие |
|-|-|
|Текущее значение должно содержать целевое значение в качестве ключа. |containsKey или **нет** notContainsKey |
|Текущее значение должно содержать целевое значение. |contains или **нет** notContains |
|Текущее значение должно быть равно целевому значению. |equals или **нет** notEquals |
|Текущее значение должно быть меньше целевого значения. |less или **нет** greaterOrEquals |
|Текущее значение должно быть не меньше целевого значения. |greaterOrEquals или **нет** less |
|Текущее значение должно быть больше целевого значения. |greater или **нет** lessOrEquals |
|Текущее значение должно быть не больше целевого значения. |lessOrEquals или **нет** greater |
|Текущее значение должно существовать. |exists (существует) |
|Текущее значение должно быть включено в целевое значение. |in или **нет** notIn |
|Текущее значение должно быть аналогично целевому значению. |Like или **нет** notLike |
|Текущее значение должно соответствовать целевому значению с учетом регистра. |match или **нет** notMatch |
|Текущее значение должно соответствовать целевому значению без учета регистра. |matchInsensitively или **нет** notMatchInsensitively |
|Текущее значение не должно содержать целевое значение в качестве ключа. |notContainsKey или **нет** containsKey|
|Текущее значение не должно содержать целевое значение. |notContains или **нет** contains |
|Текущее значение не должно быть равно целевому значению. |notEquals или **нет** equals |
|Текущее значение не должно существовать. |**нет** exists  |
|Текущее значение не должно быть включено в целевое значение. |notIn или **нет** in |
|Текущее значение не должно быть аналогично целевому значению. |notLike или **нет** like |
|Текущее значение не должно соответствовать целевому значению с учетом регистра. |notMatch или **нет** match |
|Текущее значение не должно соответствовать целевому значению без учета регистра. |notMatchInsensitively или **нет** matchInsensitively |
|Нет связанных ресурсов, соответствующих сведениям о воздействии в определении политики. |Ресурс типа, определенный в **then.details.type** и связанный с ресурсом, определенным в части **if** правила политики, не существует. |

## <a name="compliance-details-for-guest-configuration"></a>Сведения о соответствии для гостевой конфигурации

Для политик _auditIfNotExists_ в категории _Гостевая конфигурация_ может существовать несколько параметров, оцениваемых в виртуальной машине, и необходимо будет просмотреть подробные сведения о каждом параметре. Например, если вы выполняете аудит для списка политик паролей и только одна из них имеет состояние _Не соответствует_, необходимо знать, какие конкретные политики паролей не соответствуют требованиям и почему.

У вас также может не быть доступа для входа на виртуальную машину напрямую при необходимости сообщить о том, почему виртуальная машина _Не соответствует_.

### <a name="azure-portal"></a>Портал Azure

Сначала выполните действия, описанные в предыдущем разделе, чтобы просмотреть сведения о соответствии политике.

В представлении "Сведения о соответствии" щелкните ссылку **Последний оцененный ресурс**.

:::image type="content" source="../media/determine-non-compliance/guestconfig-auditifnotexists-compliance.png" alt-text="Просмотрите сведения об определении auditIfNotExists" border="false":::

На странице **Назначение гостей** отображаются все доступные сведения о соответствии. Каждая строка в представлении представляет собой оценку выполненную внутри виртуальной машины. В столбце **Причина** отображается фраза, в которой описывается, почему назначение гостя _Не соответствует_ требованиям. Например, при аудите политик паролей в столбце **Причина** будет отображаться текст, включающий текущее значение для каждого параметра.

:::image type="content" source="../media/determine-non-compliance/guestconfig-compliance-details.png" alt-text="Просмотр сведений о соответствии" border="false":::

### <a name="azure-powershell"></a>Azure PowerShell

Также можно просмотреть сведения о соответствии из Azure PowerShell. Сначала убедитесь, что на вашем компьютере установлен модуль гостевой конфигурации.

```azurepowershell-interactive
Install-Module Az.GuestConfiguration
```

Вы можете просмотреть текущее состояние всех назначений гостей для виртуальной машины с помощью следующей команды:

```azurepowershell-interactive
Get-AzVMGuestPolicyReport -ResourceGroupName <resourcegroupname> -VMName <vmname>
```

```output
PolicyDisplayName                                                         ComplianceReasons
-----------------                                                         -----------------
Audit that an application is installed inside Windows VMs                 {[InstalledApplication]bwhitelistedapp}
Audit that an application is not installed inside Windows VMs.            {[InstalledApplication]NotInstalledApplica...
```

Чтобы просмотреть только фразу _причина_, описывающую, почему виртуальная машина имеет статус _Не соответствует_, возвращайте только свойство дочернего элемента Reason (Причина).

```azurepowershell-interactive
Get-AzVMGuestPolicyReport -ResourceGroupName <resourcegroupname> -VMName <vmname> | % ComplianceReasons | % Reasons | % Reason
```

```output
The following applications are not installed: '<name>'.
```

Вы также можете вывести журнал соответствия для назначений гостей в области действия для виртуальной машины. Выходные данные этой команды содержат подробности каждого отчета для виртуальной машины.

> [!NOTE]
> Это может быть большой объем данных. Рекомендуется сохранить выходные данные для последующего использования.

```azurepowershell-interactive
$guestHistory = Get-AzVMGuestPolicyStatusHistory -ResourceGroupName <resourcegroupname> -VMName <vmname>
$guestHistory
```

```output
PolicyDisplayName                                                         ComplianceStatus ComplianceReasons StartTime              EndTime                VMName LatestRepor
                                                                                                                                                                  tId
-----------------                                                         ---------------- ----------------- ---------              -------                ------ -----------
[Preview]: Audit that an application is installed inside Windows VMs      NonCompliant                       02/10/2019 12:00:38 PM 02/10/2019 12:00:41 PM VM01  ../17fg0...
<truncated>
```

Чтобы упростить это представление, используйте параметр **ShowChanged**. Выходные данные этой команды включают только отчеты, которые следуют за изменением состояния соответствия.

```azurepowershell-interactive
$guestHistory = Get-AzVMGuestPolicyStatusHistory -ResourceGroupName <resourcegroupname> -VMName <vmname> -ShowChanged
$guestHistory
```

```output
PolicyDisplayName                                                         ComplianceStatus ComplianceReasons StartTime              EndTime                VMName LatestRepor
                                                                                                                                                                  tId
-----------------                                                         ---------------- ----------------- ---------              -------                ------ -----------
Audit that an application is installed inside Windows VMs                 NonCompliant                       02/10/2019 10:00:38 PM 02/10/2019 10:00:41 PM VM01  ../12ab0...
Audit that an application is installed inside Windows VMs.                Compliant                          02/09/2019 11:00:38 AM 02/09/2019 11:00:39 AM VM01  ../e3665...
Audit that an application is installed inside Windows VMs                 NonCompliant                       02/09/2019 09:00:20 AM 02/09/2019 09:00:23 AM VM01  ../15ze1...
```

## <a name="change-history-preview"></a><a name="change-history"></a>Журнал изменений (предварительная версия)

В рамках новой **общедоступной предварительной версии** последние 14 дней в журнале изменений теперь доступны для всех ресурсов Azure, поддерживающих [полное удаление режимов](../../../azure-resource-manager/templates/complete-mode-deletion.md). Журнал изменений содержит подробные сведения о том, когда было обнаружено изменение и _отличия между визуальными элементами_ для каждого изменения. Обнаружение изменений активируется при добавлении, удалении или изменении свойств Azure Resource Manager.

1. Запустите службу Политика Azure на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. На странице **Обзор** или **Соответствие** выберите политику в любом **состоянии соответствия**.

1. На вкладке **Соответствие ресурсов** страницы **Соответствие политики** выберите ресурс.

1. На странице **Соответствие ресурсов** выберите вкладку **Журнал изменений (предварительная версия)** . После этого отобразится список обнаруженных изменений (при наличии).

   :::image type="content" source="../media/determine-non-compliance/change-history-tab.png" alt-text="Вкладка "Журнал изменений политики Azure" на странице "Соответствие ресурсов"" border="false":::

1. Выберите одно из обнаруженных изменений. _Отличия между визуальными элементами_ для ресурса представлены на странице **Журнал изменений**.

   :::image type="content" source="../media/determine-non-compliance/change-history-visual-diff.png" alt-text="Отличия между визуальными элементами в Журнале изменений политики Azure на странице "Журнал изменений"" border="false":::

_Отличия между визуальными элементами_ позволяют обнаружить изменения ресурса. Обнаруженные изменения могут не быть связаны с текущим состоянием соответствия ресурса.

Данные журнала изменений предоставляются [Azure Resource Graph](../../resource-graph/overview.md). Чтобы запросить эти сведения за пределами портала Azure, см. [Получение изменений ресурсов](../../resource-graph/how-to/get-resource-changes.md).

## <a name="next-steps"></a>Дальнейшие действия

- Рассмотрите примеры в [образцах для Политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](../concepts/definition-structure.md).
- Изучите [сведения о действии политик](../concepts/effects.md).
- Узнайте о [программном создании политик](programmatically-create.md).
- Узнайте, как [получать сведения о соответствии](get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
