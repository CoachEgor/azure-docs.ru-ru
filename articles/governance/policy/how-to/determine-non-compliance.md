---
title: Определение причин несоответствия требованиям
description: Если ресурс не соответствует требованиям, существует множество возможных причин. Узнайте, что привело к несоответствию.
author: DCtheGeek
ms.author: dacoulte
ms.date: 04/26/2019
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.openlocfilehash: a0faaeee369a2227f6018141e5aa5d18c9037e9d
ms.sourcegitcommit: a7a9d7f366adab2cfca13c8d9cbcf5b40d57e63a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/20/2019
ms.locfileid: "71161979"
---
# <a name="determine-causes-of-non-compliance"></a>Определение причин несоответствия требованиям

Если ресурс Azure определен как не соответствующий правилу политики, полезно понимать, с какой частью правила он не соответствует. Также полезно понять, какое изменение изменило ранее совместимый ресурс, чтобы сделать его несоответствующим. Найти эти сведения можно двумя способами:

> [!div class="checklist"]
> - [Сведения о соответствии](#compliance-details)
> - [Журнал изменений (Предварительная версия)](#change-history)

## <a name="compliance-details"></a>Сведения о соответствии

Если ресурс не соответствует требованиям, сведения о соответствии для этого ресурса доступны на странице **соответствие политике** . Область сведения о соответствии содержит следующие сведения.

- Сведения о ресурсах, такие как имя, тип, расположение и идентификатор ресурса
- Состояние соответствия и отметка времени последней оценки для текущего назначения политики
- Список _причин_ несоответствия ресурсов

> [!IMPORTANT]
> Так как сведения о соответствии для _несоответствующего_ ресурса показывают текущее значение свойств этого ресурса, пользователь должен иметь операцию **чтения** с **типом** ресурса. Например, если ресурсом, который _не соответствует требованиям_ , является **Microsoft. COMPUTE/virtualMachines** , то пользователь должен иметь операцию **Microsoft. COMPUTE/virtualMachines/Read** . Если у пользователя нет необходимой операции, отображается ошибка доступа.

Чтобы просмотреть сведения о соответствии, выполните следующие действия.

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. На странице **Обзор** или **соответствие** выберите политику в **состоянии соответствия** , которое не _соответствует требованиям_.

1. На вкладке **соответствие ресурсов** на странице **соответствие политике** щелкните правой кнопкой мыши или выберите многоточие ресурса в **состоянии соответствия** , которое не _соответствует требованиям_. Затем выберите **Просмотреть сведения о соответствии**.

   ![Просмотр параметра сведений о соответствии](../media/determine-non-compliance/view-compliance-details.png)

1. В области **сведения о соответствии** отображаются сведения от последней оценки ресурса до текущего назначения политики. В этом примере для поля **Microsoft. SQL/Servers/Version** обнаружено значение _12,0_ , а для определения политики — значение _14,0_. Если ресурс не соответствует нескольким причинам, каждый из них отображается на этой панели.

   ![Область сведений о соответствии и причины несоответствия](../media/determine-non-compliance/compliance-details-pane.png)

   Для определения политики **помощью параметров auditifnotexists** или **deployIfNotExists** сведения включают свойство **Details. Type** и все необязательные свойства. Список см. в разделе [Свойства помощью параметров auditifnotexists](../concepts/effects.md#auditifnotexists-properties) и [Свойства deployIfNotExists](../concepts/effects.md#deployifnotexists-properties). **Последний оцененный ресурс** — это связанный ресурс из раздела **Details** определения.

   Пример частичного определения **deployIfNotExists** :

   ```json
   {
       "if": {
           "field": "type",
           "equals": "[parameters('resourceType')]"
       },
       "then": {
           "effect": "DeployIfNotExists",
           "details": {
               "type": "Microsoft.Insights/metricAlerts",
               "existenceCondition": {
                   "field": "name",
                   "equals": "[concat(parameters('alertNamePrefix'), '-', resourcegroup().name, '-', field('name'))]"
               },
               "existenceScope": "subscription",
               "deployment": {
                   ...
               }
           }
       }
   }
   ```

   ![Область сведений о соответствии — * Ифнотексистс](../media/determine-non-compliance/compliance-details-pane-existence.png)

> [!NOTE]
> Для защиты данных, если значение свойства является секретом , текущее значение отображает звездочки.

В этих сведениях объясняется, почему ресурс в настоящее время не соответствует требованиям, но не показывает, когда было внесено изменение в ресурс, вызвавший, что он стал несоответствующим. Дополнительные сведения см. в разделе [История изменений (Предварительная версия)](#change-history) ниже.

### <a name="compliance-reasons"></a>Причины соответствия

Следующая матрица сопоставляет каждую возможную _причину_ с ответственным [условием](../concepts/definition-structure.md#conditions) в определении политики:

|`Reason` | Условие |
|-|-|
|Текущее значение должно содержать целевое значение в качестве ключа. |containsKey или **не** нотконтаинскэй |
|Текущее значение должно содержать целевое значение. |Contains или **Not** notContains |
|Текущее значение должно быть равно целевому значению. |Equals или **Not** notEquals |
|Текущее значение должно быть меньше целевого значения. |меньше или **не** греатерорекуалс |
|Текущее значение должно быть больше целевого значения или равно ему. |Греатерорекуалс или **не** меньше |
|Текущее значение должно быть больше целевого значения. |выше или **не** лессорекуалс |
|Текущее значение должно быть меньше целевого значения или равно ему. |Лессорекуалс или **не** выше |
|Текущее значение должно существовать. |exists (существует) |
|Текущее значение должно быть в целевом значении. |в или **не** notIn |
|Текущее значение должно быть похоже на целевое значение. |Like или **Not** notLike |
|Текущее значение должно соответствовать целевому значению с учетом регистра. |Match или **Not** notMatch |
|Текущее значение должно соответствовать целевому значению без учета регистра. |Матчинсенситивели или **не** нотматчинсенситивели |
|Текущее значение не должно содержать целевое значение в качестве ключа. |Нотконтаинскэй или **не** ContainsKey|
|Текущее значение не должно содержать целевое значение. |notContains или **не** содержит |
|Текущее значение не должно равняться целевому значению. |notEquals или **Not** Equals |
|Текущее значение не должно существовать. |**не** существует  |
|Текущее значение не должно быть в целевом значении. |notIn или **не** в |
|Текущее значение не должно быть похоже на целевое значение. |notLike или **не** нравится |
|Текущее значение не должно соответствовать целевому значению без учета регистра. |notMatch или **не** соответствует |
|Текущее значение не должно соответствовать целевому значению без учета регистра. |Нотматчинсенситивели или **не** матчинсенситивели |
|Нет связанных ресурсов, соответствующих сведениям о действиях в определении политики. |Ресурс с типом, определенным в **then. Details. Type** и связанный с ресурсом, определенным в части правила политики, которая не существует. |

## <a name="compliance-details-for-guest-configuration"></a>Сведения о соответствии для гостевой конфигурации

Для политик _помощью параметров auditifnotexists_ в категории _конфигурации "гость_ " в виртуальной машине может быть определено несколько параметров, поэтому необходимо просмотреть подробные сведения о параметрах. Например, если вы выполняете аудит для списка политик паролей и только один из них имеет состояние _не соответствует_, необходимо знать, какие политики паролей не соответствуют требованиям и почему.

У вас также может не быть доступа для входа на виртуальную машину напрямую, но необходимо сообщить о том, почему виртуальная машина не _соответствует требованиям_.

### <a name="azure-portal"></a>портала Azure

Сначала выполните действия, описанные в предыдущем разделе, чтобы просмотреть сведения о соответствии политике.

В области **сведения о соответствии** щелкните ссылку **последний оцененный ресурс**.

   ![Просмотреть сведения об определении помощью параметров auditifnotexists](../media/determine-non-compliance/guestconfig-auditifnotexists-compliance.png)

На странице **назначения гостей** отображаются все доступные сведения о соответствии. Каждая строка в представлении представляет собой вычисление, выполненное внутри компьютера. В столбце **Причина** отображается фраза, описывающая, почему назначение гостя не _соответствует требованиям_ . Например, при аудите политик паролей в столбце **Причина** будет отображаться текст, включая текущее значение для каждого параметра.

![Просмотрите сведения о соответствии.](../media/determine-non-compliance/guestconfig-compliance-details.png)

### <a name="azure-powershell"></a>Azure PowerShell

Также можно просмотреть сведения о соответствии Azure PowerShell. Сначала убедитесь, что установлен модуль гостевой конфигурации.

```azurepowershell-interactive
Install-Module Az.GuestConfiguration
```

Вы можете просмотреть текущее состояние всех назначений гостей для виртуальной машины с помощью следующей команды:

```azurepowershell-interactive
Get-AzVMGuestPolicyReport -ResourceGroupName <resourcegroupname> -VMName <vmname>
```

```output
PolicyDisplayName                                                         ComplianceReasons
-----------------                                                         -----------------
Audit that an application is installed inside Windows VMs                 {[InstalledApplication]bwhitelistedapp}
Audit that an application is not installed inside Windows VMs.            {[InstalledApplication]NotInstalledApplica...
```

Чтобы просмотреть только конечную _фразу_ , описывающую причину _несоответствия_виртуальной машины, возвращайте только свойство дочернего элемента Reason.

```azurepowershell-interactive
Get-AzVMGuestPolicyReport -ResourceGroupName <resourcegroupname> -VMName <vmname> | % ComplianceReasons | % Reasons | % Reason
```

```output
The following applications are not installed: '<name>'.
```

Вы также можете вывести журнал соответствия для назначений гостей в области действия для компьютера. Выходные данные этой команды содержат сведения о каждом отчете для виртуальной машины.

> [!NOTE]
> Выходные данные могут возвращать большой объем данных. Рекомендуется хранить выходные данные в переменной.

```azurepowershell-interactive
$guestHistory = Get-AzVMGuestPolicyStatusHistory -ResourceGroupName <resourcegroupname> -VMName <vmname>
$guestHistory
```

```output
PolicyDisplayName                                                         ComplianceStatus ComplianceReasons StartTime              EndTime                VMName LatestRepor
                                                                                                                                                                  tId
-----------------                                                         ---------------- ----------------- ---------              -------                ------ -----------
[Preview]: Audit that an application is installed inside Windows VMs      NonCompliant                       02/10/2019 12:00:38 PM 02/10/2019 12:00:41 PM VM01  ../17fg0...
<truncated>
```

Чтобы упростить это представление, используйте параметр **шовчанжед** . Выходные данные этой команды включают только отчеты, которые следуют за изменением состояния соответствия.

```azurepowershell-interactive
$guestHistory = Get-AzVMGuestPolicyStatusHistory -ResourceGroupName <resourcegroupname> -VMName <vmname> -ShowChanged
$guestHistory
```

```output
PolicyDisplayName                                                         ComplianceStatus ComplianceReasons StartTime              EndTime                VMName LatestRepor
                                                                                                                                                                  tId
-----------------                                                         ---------------- ----------------- ---------              -------                ------ -----------
Audit that an application is installed inside Windows VMs                 NonCompliant                       02/10/2019 10:00:38 PM 02/10/2019 10:00:41 PM VM01  ../12ab0...
Audit that an application is installed inside Windows VMs.                Compliant                          02/09/2019 11:00:38 AM 02/09/2019 11:00:39 AM VM01  ../e3665...
Audit that an application is installed inside Windows VMs                 NonCompliant                       02/09/2019 09:00:20 AM 02/09/2019 09:00:23 AM VM01  ../15ze1...
```

## <a name="a-namechange-historychange-history-preview"></a><a name="change-history"/>Журнал изменений (Предварительная версия)

В рамках новой **общедоступной предварительной версии**История изменений за последние 14 дней доступна для всех ресурсов Azure, поддерживающих [полное удаление режима](../../../azure-resource-manager/complete-mode-deletion.md). Журнал изменений содержит подробные сведения о том, когда было обнаружено изменение и _отличия между визуальными элементами_ для каждого изменения. Обнаружение изменений активируется при добавлении, удалении или изменении свойств диспетчер ресурсов.

1. Запустите службу "Политика Azure" на портале Azure, щелкнув **Все службы**, а затем выполнив поиск и выбрав **Политика**.

1. На странице **Обзор** или **соответствие** выберите политику в любом **состоянии соответствия**.

1. На вкладке **соответствие ресурсов** на странице **соответствие политике** выберите ресурс.

1. На странице **Соответствие ресурсов** выберите вкладку **Журнал изменений (предварительная версия)** . После этого отобразится список обнаруженных изменений (при наличии).

   ![Вкладка "журнал изменений политики Azure" на странице "соответствие ресурсов"](../media/determine-non-compliance/change-history-tab.png)

1. Выберите одно из обнаруженных изменений. _Визуальная разница_ для ресурса представлена на странице **Журнал изменений** .

   ![Страница "журнал изменений" политики Azure — Визуальная разница на странице журнала изменений](../media/determine-non-compliance/change-history-visual-diff.png)

_Отличия между визуальными элементами_ позволяют обнаружить изменения ресурса. Обнаруженные изменения могут не быть связаны с текущим состоянием соответствия ресурса.

Данные журнала изменений предоставляются [графом ресурсов Azure](../../resource-graph/overview.md). Сведения о запросе этих сведений за пределами портал Azure см. в разделе [Получение изменений ресурсов](../../resource-graph/how-to/get-resource-changes.md).

## <a name="next-steps"></a>Следующие шаги

- Просмотрите примеры в [примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](../concepts/definition-structure.md).
- Изучите [сведения о действии политик](../concepts/effects.md).
- Узнайте, как [программно создавать политики](programmatically-create.md).
- Узнайте, как [получить данные о соответствии](getting-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
