---
title: Разработка политики как рабочих процессов кода
description: Научитесь проектировать рабочие процессы для развертывания определений политик Azure в виде кода и автоматической проверки ресурсов.
author: DCtheGeek
ms.author: dacoulte
ms.date: 11/04/2019
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.openlocfilehash: e3fcb9996266af7e952538c7c92c665929bb9492
ms.sourcegitcommit: c22327552d62f88aeaa321189f9b9a631525027c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73518701"
---
# <a name="design-policy-as-code-workflows"></a>Разработка политики как рабочих процессов кода

По мере того как вы переходите к своему пути к управлению облаком, вам потребуется вручную управлять каждым определением политики в портал Azure или с помощью различных пакетов SDK, чтобы повысить управляемость и повторяемость в масштабах предприятия. Два основных подхода к управлению системами с масштабированием в облаке:

- Инфраструктура как код. Методика рассмотрения содержимого, определяющего среды, от диспетчер ресурсов шаблонов до определений политик Azure до проектов Azure в качестве исходного кода.
- DevOps: объединение людей, процессов и продуктов, чтобы обеспечить непрерывную доставку ценности конечным пользователям.

Политика как код — это сочетание этих идей. По сути, сохраните определения политик в системе управления версиями и при каждом внесении изменений проверьте и проверьте это изменение. Однако это не должно быть областью политик, вовлеченных в инфраструктуру как Code или DevOps.

Этап проверки также должен быть компонентом других рабочих процессов непрерывной интеграции или непрерывного развертывания. Примеры включают развертывание среды приложения или виртуальной инфраструктуры. Делая проверку политики Azure ранним компонентом процесса сборки и развертывания, приложения и группы эксплуатации обнаруживают, являются ли их изменения нежалобами, долго до того, как они слишком поздно и пытаются выполнить развертывание в рабочей среде.

## <a name="workflow-overview"></a>Обзор рабочего процесса

Рекомендуемый общий рабочий процесс политики как код выглядит как эта диаграмма:

![Обзор политики в качестве рабочего процесса кода](../media/policy-as-code/policy-as-code-workflow.png)

### <a name="create-and-update-policy-definitions"></a>Создание и обновление определений политик

Определения политик создаются с помощью JSON и хранятся в системе управления версиями. Каждая политика имеет собственный набор файлов, таких как параметры, правила и параметры среды, которые должны храниться в одной папке. Следующая структура является рекомендуемым способом сохранения определений политик в системе управления версиями.

```text
.
|
|- policies/  ________________________ # Root folder for policies
|  |- policy1/  ______________________ # Subfolder for a policy
|     |- policy.json _________________ # Policy definition
|     |- policy.parameters.json ______ # Policy definition of parameters
|     |- policy.rules.json ___________ # Policy rule
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
|  |- policy2/  ______________________ # Subfolder for a policy
|     |- policy.json _________________ # Policy definition
|     |- policy.parameters.json ______ # Policy definition of parameters
|     |- policy.rules.json ___________ # Policy rule
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
```

При добавлении новой политики или обновлении существующей она должна автоматически обновлять определение политики в Azure. Тестирование нового или обновленного определения политики происходит позже.

### <a name="create-and-update-initiative-definitions"></a>Создание и обновление определений инициатив

Аналогичным образом, инициативы имеют собственный файл JSON и связанные файлы, которые должны храниться в одной и той же папке. Для определения инициативы необходимо, чтобы определение политики было уже существует, поэтому не может быть создано или обновлено до тех пор, пока источник политики не будет обновлен в системе управления версиями, а затем обновлен в Azure. Следующая структура является рекомендуемым способом сохранения определений инициативы в системе управления версиями:

```text
.
|
|- initiatives/ ______________________ # Root folder for initiatives
|  |- init1/ _________________________ # Subfolder for an initiative
|     |- policyset.json ______________ # Initiative definition
|     |- policyset.definitions.json __ # Initiative list of policies
|     |- policyset.parameters.json ___ # Initiative definition of parameters
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
|  |- init2/ _________________________ # Subfolder for an initiative
|     |- policyset.json ______________ # Initiative definition
|     |- policyset.definitions.json __ # Initiative list of policies
|     |- policyset.parameters.json ___ # Initiative definition of parameters
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
```

Как и определения политик, при добавлении или обновлении существующей инициативы рабочий процесс должен автоматически обновлять определение инициативы в Azure. Тестирование нового или обновленного определения инициативы происходит позже.

### <a name="test-and-validate-the-updated-definition"></a>Проверка и проверка обновленного определения

После того как служба автоматизации записала созданные или обновленные определения политики или инициативы и внес обновление в объект в Azure, пора протестировать внесенные изменения. Либо политика, либо инициатива, которая является частью, должна быть назначена ресурсам в среде самым крайним из рабочих сред. Обычно это среда _разработки_.

Назначение должно использовать [енфорцементмоде](./assignment-structure.md#enforcement-mode) из _отключенных_ , чтобы создание и обновление ресурсов не блокировалось, но все существующие ресурсы по-прежнему будут проверены на соответствие обновленному определению политики. Даже при использовании Енфорцементмоде рекомендуется, чтобы область назначения была либо группой ресурсов, либо подпиской, которая специально используется для проверки политик.

> [!NOTE]
> Хотя режим принудительного применения полезен, он не является заменой тщательного тестирования определения политики при различных условиях. Определение политики следует тестировать с `PUT` и `PATCH` REST API вызовы, соответствующие и несоответствующие ресурсы, а также граничные варианты, например свойство, отсутствующее в ресурсе.

После развертывания назначения используйте пакет SDK для политики, чтобы [получить данные о соответствии](../how-to/get-compliance-data.md) для нового назначения. Среда, используемая для проверки политик и назначений, должна иметь как соответствующие, так и не соответствующие требованиям ресурсы. Как и в случае с хорошим модульным тестом для кода, необходимо проверить, что ресурсы являются ожидаемыми и что у вас также нет ложных срабатываний или ложных отрицательных результатов. При тестировании и проверке только ожидаемых результатов может возникнуть непредвиденная и Неопознанная воздействие политики. Дополнительные сведения см. [в статье Оценка влияния новой политики Azure](./evaluate-impact.md).

### <a name="enable-remediation-tasks"></a>Включить задачи исправления

Если проверка назначения соответствует ожиданиям, следующим шагом является проверка исправления.
Политики, использующие [deployIfNotExists](./effects.md#deployifnotexists) или [Modify](./effects.md#modify) , могут быть включены в задачу исправления и исправлять ресурсы из состояния, не соответствующего требованиям.

Первый шаг — предоставление назначения политики для назначения роли, определенной в определении политики. Это назначение ролей дает управляемому удостоверению назначения политики достаточно прав для внесения необходимых изменений, чтобы сделать ресурс соответствующим.

Когда назначение политики будет иметь соответствующие права, используйте пакет SDK для политики, чтобы активировать задачу по исправлению для набора ресурсов, которые известны как несовместимые. Перед продолжением необходимо выполнить три теста для этих исправленных задач:

- Проверка успешного завершения задачи исправления
- Выполните оценку политики, чтобы убедиться, что результаты соответствия политике обновлены должным образом.
- Выполните модульный тест среды для ресурсов напрямую, чтобы проверить, изменились их свойства

При тестировании обновленных результатов оценки политики и в среде непосредственно предоставляется подтверждение о том, что задачи исправления изменились, что ожидалось, а определение политики обнаружило изменение соответствия, как ожидалось.

### <a name="update-to-enforced-assignments"></a>Обновление для принудительных назначений

После завершения всех проверочных шлюзов обновите назначение, чтобы использовать **енфорцементмоде** с _включенным_. Это изменение сначала должно быть сделано в той же среде, что и далеко из рабочей среды. После того как среда будет проверена как ожидаемая, необходимо изменить область, чтобы она включала следующую среду и так далее, пока политика не будет развернута в рабочих ресурсах.

## <a name="process-integrated-evaluations"></a>Обработка встроенных оценок

Общий рабочий процесс для политики в качестве кода предназначен для разработки и развертывания политик и инициатив в масштабе среды. Однако оценка политики должна быть частью процесса развертывания для любого рабочего процесса, который развертывает или создает ресурсы в Azure, таких как развертывание приложений или запуск шаблонов диспетчер ресурсов для создания инфраструктуры.

В таких случаях после развертывания приложения или инфраструктуры в тестовой подписке или группе ресурсов следует выполнить оценку политики для проверки области всех существующих политик и инициатив. Хотя они могут быть настроены как **енфорцементмоде** _отключены_ в такой среде, полезно заранее определить, если развертывание приложения или инфраструктуры нарушает определения политик. Таким образом, эта оценка политики должна быть шагом в этих рабочих процессах и неудачными развертываниями, которые создают ресурсы, не соответствующие требованиям.

## <a name="review"></a>Проверка

В этой статье рассматривается общий рабочий процесс для политики в виде кода, а также, где оценка политики должна быть частью других рабочих процессов развертывания. Этот рабочий процесс можно использовать в любой среде, которая поддерживает действия сценариев и автоматизацию на основе триггеров.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о [структуре определения политики](./definition-structure.md).
- Сведения о [структуре назначений политик](./assignment-structure.md).
- Узнайте, как [программно создавать политики](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/getting-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).