---
title: Рабочие процессы политики разработки как кода
description: Научитесь разрабатывать рабочие процессы для развертывания определений политики Azure в качестве кода и автоматической проверки ресурсов.
ms.date: 11/04/2019
ms.topic: conceptual
ms.openlocfilehash: 0914ba6510c9d2ef87d3f83417f97340d42c8bce
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74267278"
---
# <a name="design-policy-as-code-workflows"></a>Рабочие процессы политики разработки как кода

По мере продвижения пути с помощью Cloud Governance необходимо перейти от ручного управления каждым определением политики на портале Azure или через различные SDK к чему-то более управляемому и повторяемому в корпоративном масштабе. Два из основных подходов к управлению системами в масштабе в облаке:

- Инфраструктура как код: Практика обработки содержимого, определяющего ваши среды, от шаблонов «Менеджер ресурсов» до определений политики Azure и azure blueprints— в качестве исходного кода.
- DevOps: Объединение людей, процессов и продуктов, чтобы обеспечить непрерывную доставку стоимости для наших конечных пользователей.

Политика как Код – это сочетание этих идей. По существу, держите определения политики в элементах управления исходным источником и всякий раз, когда вноситесь изменения, проверяйте и проверяйте это изменение. Тем не менее, это не должно быть степень политики участия с инфраструктурой, как код или DevOps.

Шаг проверки также должен быть компонентом других непрерывных интеграционных или непрерывных рабочих процессов развертывания. Примеры включают развертывание среды приложений или виртуальной инфраструктуры. Сделав проверку azure Policy ранним компонентом процесса сборки и развертывания, группы приложений и операций обнаруживают, не жалобы ли их изменения, задолго до того, как стало слишком поздно, и они пытаются развернуть в процессе производства.

## <a name="workflow-overview"></a>Обзор рабочего процесса

Рекомендуемый общий рабочий процесс Политики как Кода выглядит следующим образом:

![Обзор рабочего процесса кода как код](../media/policy-as-code/policy-as-code-workflow.png)

### <a name="create-and-update-policy-definitions"></a>Создание и обновление определений политик

Определения политики создаются с помощью JSON и хранятся в исходном элементе. Каждая политика имеет свой собственный набор файлов, таких как параметры, правила и параметры среды, которые должны храниться в одной папке. Следующая структура является рекомендуемым способом сохранения определения политики в контроле исходного кода.

```text
.
|
|- policies/  ________________________ # Root folder for policies
|  |- policy1/  ______________________ # Subfolder for a policy
|     |- policy.json _________________ # Policy definition
|     |- policy.parameters.json ______ # Policy definition of parameters
|     |- policy.rules.json ___________ # Policy rule
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
|  |- policy2/  ______________________ # Subfolder for a policy
|     |- policy.json _________________ # Policy definition
|     |- policy.parameters.json ______ # Policy definition of parameters
|     |- policy.rules.json ___________ # Policy rule
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
```

При добавлении новой политики или обновлении рабочего процесса необходимо автоматически обновлять определение политики в Azure. Тестирование нового или обновленного определения политики происходит на более позднем этапе.

### <a name="create-and-update-initiative-definitions"></a>Создание и обновление определений инициатив

Кроме того, инициативы имеют свой собственный файл JSON и связанные с ними файлы, которые должны храниться в одной папке. Определение инициативы требует уже существующего определения политики, поэтому не может быть создано или обновлено до тех пор, пока источник политики не будет обновлен в элементе управления исходом, а затем обновлен в Azure. Следующая структура является рекомендуемым способом сохранения определения вашей инициативы в контроле исходного кода:

```text
.
|
|- initiatives/ ______________________ # Root folder for initiatives
|  |- init1/ _________________________ # Subfolder for an initiative
|     |- policyset.json ______________ # Initiative definition
|     |- policyset.definitions.json __ # Initiative list of policies
|     |- policyset.parameters.json ___ # Initiative definition of parameters
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
|  |- init2/ _________________________ # Subfolder for an initiative
|     |- policyset.json ______________ # Initiative definition
|     |- policyset.definitions.json __ # Initiative list of policies
|     |- policyset.parameters.json ___ # Initiative definition of parameters
|     |- params.dev.json _____________ # Parameters for a Dev environment
|     |- params.prd.json _____________ # Parameters for a Prod environment
|     |- params.tst.json _____________ # Parameters for a Test environment
|
```

Например, определения политики при добавлении или обновлении существующей инициативы рабочий процесс должен автоматически обновлять определение инициативы в Azure. Тестирование нового или обновленного определения инициативы происходит на более позднем этапе.

### <a name="test-and-validate-the-updated-definition"></a>Протестите и проверяем обновленное определение

После того, как автоматизация приняла новые или обновленные определения политики или инициативы и сделала обновление объекта в Azure, пришло время проверить внесенные изменения. Либо политика, либо инициатива (часть ее части) должны быть назначены ресурсам в среде, наиболее далекой от производства. Эта среда, как правило, _Dev_.

В назначении следует использовать [enforcementMode](./assignment-structure.md#enforcement-mode) _отключений,_ чтобы создание и обновление ресурсов не блокировалось, но что существующие ресурсы по-прежнему проверяются на соответствие обновленного определения политики. Даже при соблюдении режима действия, рекомендуется, чтобы область назначения была либо группой ресурсов, либо подпиской, специально используемой для проверки политик.

> [!NOTE]
> Хотя режим принудительного исполнения полезен, он не является заменой тщательного тестирования определения политики в различных условиях. Определение политики должно `PUT` быть `PATCH` проверено с помощью вызовов и REST API, совместимых и несовместимых ресурсов, а также крайних случаев, таких как свойство, отсутствующее в ресурсе.

После развертывания назначения используйте SDK политики для [получения данных о соответствии](../how-to/get-compliance-data.md) новому назначению. Среда, используемая для проверки политик и назначений, должна иметь как соответствующие, так и несовместимые ресурсы. Как хороший модульный тест для кода, вы хотите проверить, что ресурсы, как ожидалось, и что у вас также нет ложных срабатываний или ложных негативов. Если вы тестируете и проверяете только на то, что вы ожидаете, может быть неожиданное и неопознанное воздействие политики. Для получения дополнительной информации [см.](./evaluate-impact.md)

### <a name="enable-remediation-tasks"></a>Включить задачи восстановления

Если проверка назначения соответствует ожиданиям, следующим шагом является проверка исправления.
Политики, которые используют либо [deployIfNotExists,](./effects.md#deployifnotexists) либо [изменяются,](./effects.md#modify) могут быть преобразованы в задачу восстановления и исправление ресурсов из состояния, не отвечаемого требованиям.

Первым шагом к этому является предоставление назначению политики назначению роли, определенному в определении политики. Это назначение ролей дает назначению политики управляемое удостоверение личности достаточно прав, чтобы внести необходимые изменения, чтобы сделать ресурс совместимым.

После того, как назначение политики имеет соответствующие права, используйте SDK политики, чтобы вызвать задачу восстановления против набора ресурсов, которые, как известно, не соответствуют требованиям. Перед началом работы должны быть завершены три испытания этих исправленных задач:

- Проверка того, что задача восстановления успешно выполнена
- Выполнить оценку политики, чтобы увидеть, что результаты соответствия политике обновляются, как и ожидалось
- Выполнить модульный тест среды с ресурсами непосредственно для проверки их свойств изменились

Тестирование как обновленных результатов оценки политики, так и среды непосредственно подтверждает, что задачи по исправлению положения изменили то, что ожидалось, и что определение политики считает изменение соответствия ожидаемым.

### <a name="update-to-enforced-assignments"></a>Обновление до обязательных заданий

После завершения всех стробов проверки обновите назначение для использования **enforcementMode** _включенного._ Это изменение должно первоначально быть сделано в той же среде, вдали от производства. После проверки этой среды как работающей, как и ожидалось, изменение должно быть включено в следующую среду и так далее до тех пор, пока политика не будет развернута в производственных ресурсах.

## <a name="process-integrated-evaluations"></a>Процесс комплексных оценок

Общий рабочий процесс для политики как Кодекса предназначен для разработки и развертывания политик и инициатив в среде в масштабе. Однако оценка политики должна быть частью процесса развертывания для любого рабочего процесса, который развертывает или создает ресурсы в Azure, например, развертывание приложений или запуск шаблонов управления ресурсами для создания инфраструктуры.

В этих случаях после развертывания приложения или инфраструктуры для тестовой подписки или группы ресурсов следует проводить оценку политики для проверки сферы проверки всех существующих политик и инициатив. Хотя они могут быть настроены как _неработающие_ **enforcementMode** в такой среде, полезно знать заранее, если развертывание приложения или инфраструктуры нарушает определения политики на ранней стадии. Поэтому эта оценка политики должна быть шагом в этих рабочих процессах и сбоями в развертывании, которые создают несовместимые ресурсы.

## <a name="review"></a>Просмотр

В этой статье рассматривается общий рабочий процесс для политики как кода, а также место, где оценка политики должна быть частью других рабочих процессов развертывания. Этот рабочий процесс может быть использован в любой среде, которая поддерживает сценарий шагов и автоматизации на основе триггеров.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте о [структуре определения политики](./definition-structure.md).
- Узнайте о [структуре назначения политики.](./assignment-structure.md)
- Понять, как [программно создавать политики.](../how-to/programmatically-create.md)
- Узнайте, как [получить данные о соответствии.](../how-to/get-compliance-data.md)
- Узнайте, как [исправления несовместимых ресурсов.](../how-to/remediate-resources.md)
- Просмотрите, что представляет собой группа управления с [организацией ресурсов с группами управления Azure.](../../management-groups/overview.md)