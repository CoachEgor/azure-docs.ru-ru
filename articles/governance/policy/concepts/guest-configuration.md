---
title: Научитесь проверять содержимое виртуальных машин
description: Узнайте, как Azure Policy использует агента конфигурации гостей для проверки настроек внутри виртуальных машин.
ms.date: 11/04/2019
ms.topic: conceptual
ms.openlocfilehash: 889e99e94b2c81a6654fcbe7851e93c40163a0c6
ms.sourcegitcommit: 7d8158fcdcc25107dfda98a355bf4ee6343c0f5c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2020
ms.locfileid: "80985326"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

Помимо аудита и [исправления](../how-to/remediate-resources.md) ресурсов Azure, Azure Policy может проверять настройки внутри машины. Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как:

- Конфигурация операционной системы
- конфигурация или наличие приложения;
- Параметры среды

В настоящее время большинство политик Azure Policy Guest Configuration политики только параметры аудита внутри машины. Они не применяются конфигурации. Исключением является одна встроенная политика, [на которая ссылается ниже](#applying-configurations-using-guest-configuration).

## <a name="extension-and-client"></a>Расширение и клиент

Для проверки настроек внутри машины [включено виртуальное расширение машины.](../../../virtual-machines/extensions/overview.md) Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

### <a name="limits-set-on-the-extension"></a>Ограничения, установленные на расширение

Чтобы ограничить расширение от воздействия приложений, работающих внутри машины, конфигурация гостя не может превышать более 5% от использования процессора. Это ограничение существует как для встроенных, так и для пользовательских определений.

## <a name="register-guest-configuration-resource-provider"></a>Регистрация поставщика ресурсов гостевой конфигурации

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Регистрацию можно выполнить с помощью портала или PowerShell. Поставщик ресурсов регистрируется автоматически, если через портал осуществляется назначение политики конфигурации гостей.

### <a name="registration---portal"></a>Регистрация на портале

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через портал Azure, выполните следующие действия:

1. Запустите портал Azure и выберите **Все службы**. Выполните поиск по запросу **Подписки** и выберите этот пункт.

1. Найдите ту подписку, для которой нужно включить гостевую конфигурацию, и выберите ее.

1. В меню слева страницы **Подписка** щелкните **Поставщики ресурсов**.

1. Выполните фильтрацию или прокрутите, пока не найдете **Microsoft.GuestConfiguration**, а затем выберите **Регистрация** в той же строке.

### <a name="registration---powershell"></a>Регистрация с помощью PowerShell

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через PowerShell, выполните следующую команду:

```azurepowershell-interactive
# Login first with Connect-AzAccount if not using Cloud Shell
Register-AzResourceProvider -ProviderNamespace 'Microsoft.GuestConfiguration'
```

## <a name="validation-tools"></a>Инструменты проверки

Внутри машины клиент Гостевой Конфигурации использует локальные инструменты для выполнения аудита.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Windows PowerShell Желаемое состояние Конфигурация](/powershell/scripting/dsc/overview/overview) v2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Если Ruby и Python не находятся на машине, они устанавливаются расширением конфигурации гостя. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя настройки этой конфигурации перепроверяются с 15-минутным интервалом.
Результаты отправляются поставщику ресурсов гостевой конфигурации по завершении аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. Это обновление заставляет политику Azure оценивать свойства диспетчера ресурсов Azure. Оценка политики Azure по требованию получает последнее значение от поставщика ресурсов гостевой конфигурации. Однако это не вызывает нового аудита конфигурации в машине.

## <a name="supported-client-types"></a>Поддерживаемые типы клиентов

В следующей таблице перечислены операционные системы, поддерживаемые в образах Azure:

|Издатель|Имя|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14.04, 16.04, 18.04|
|Credativ|Debian|8, 9|
|Microsoft|Windows Server|2012 Центр обработки данных, 2012 R2 Центр обработки данных, 2016 Центр обработки данных, 2019 Центр обработки данных|
|Microsoft|Клиент Windows|Windows 10|
|OpenLogic|CentOS|7.3, 7.4, 7.5, 7.6, 7.7|
|Red Hat|Red Hat Enterprise Linux|7.4, 7.5, 7.6, 7.7|
|Suse|SLES|12 с пакетом обновления 3|

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

Наносервер Windows Server не поддерживается ни в одной версии.

## <a name="guest-configuration-extension-network-requirements"></a>Требования к сети расширения конфигурации гостей

Для связи с поставщиком ресурсов Гостевой Конфигурации в Azure машинам требуется исходящий доступ к центрам обработки данных Azure в порту **443.** Если вы используете частную виртуальную сеть в Azure, которая не позволяет осуществлять исходящий трафик, назначайте исключения с [правилами Группы сетевой безопасности.](../../../virtual-network/manage-network-security-group.md#create-a-security-rule)
[Тег сервиса](../../../virtual-network/service-tags-overview.md) "GuestAndHybridManagement" можно использовать для ссылки на службу конфигурации гостей.

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Каждый аудит, проводимый гостевой конфигурацией, требует двух определений политики: определения **DeployIfNotExists** и определения **AuditIfNotExists.** Определение **DeployIfNotExists** используется для подготовки машины с агентом конфигурации гостей и другими компонентами для поддержки [инструментов проверки.](#validation-tools)

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Проверка машины была назначена конфигурация для оценки. Если в настоящее время нет назначения, получите задание и подготовьте машину:
  - Проверка подлинности машины с помощью [управляемой идентификации](../../../active-directory/managed-identities-azure-resources/overview.md)
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Если назначение **DeployIfNotExists** не соответствует требованиям, можно использовать [задачу восстановления.](../how-to/remediate-resources.md#create-a-remediation-task)

После того, как назначение **DeployIfNotExistsis** соответствует требованиям, в задании политики **AuditIfNotExists** используются локальные инструменты проверки, чтобы определить, соответствует ли назначение конфигурации или не соответствует требованиям. Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/get-compliance-data.md).

> [!NOTE]
> Политика **DeployIfNotExists** необходима для того, чтобы политика **AuditIfNotExists была** возвращена результатам. Без **DeployIfNotExists**, **политика AuditIfNotExists** показывает ресурсы "0 из 0" как статус.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива под названием _ \[Preview\]: Параметры безопасности аудита password внутри машин Linux и Windows_ содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **AuditIfNotExists** для Windows и три пары для Linux. Логика [определения политики](definition-structure.md#policy-rule) подтверждает, что оценивается только целевая операционная система.

#### <a name="auditing-operating-system-settings-following-industry-baselines"></a>Аудит настроек операционной системы в соответствии с отраслевыми базовыми стандартами

Одна из инициатив, доступных в Azure Policy, позволяет проводить аудит настроек операционной системы внутри виртуальных машин после «базового» от корпорации Майкрософт. Определение, _ \[Предварительный\]просмотр: Аудит Windows VMs, которые не соответствуют базовым настройкам безопасности Azure,_ включает полный набор правил аудита, основанных на настройках из политики Группы активных каталогов.

Большинство настроек доступны в качестве параметров. Эта функциональность позволяет настроить аудит, чтобы привести политику в соответствие с вашими организационными требованиями или сопоставить политику с информацией третьих сторон, такой как отраслевые нормативные стандарты.

Некоторые параметры поддерживают целый диапазон значений. Например, параметр Maximum Password Age может быть установлен с помощью оператора диапазона, чтобы дать гибкость владельцам машин. Можно проверить, что эффективная настройка групповой политики, требующая от пользователей менять пароли, должна быть не более 70 дней, но не должна быть менее одного дня. Как описано в информационном пузыре по параметру, чтобы сделать эту бизнес-политику эффективной аудиторской ценностью, установите значение в 1,70.

При определении политики с помощью шаблона развертывания диспетчера ресурсов Azure можно использовать файл параметров для управления этими настройками из элемента управления исходным ресурсом. Использование такого инструмента, как Git, для управления изменениями в политиках аудита с комментариями по каждой регистрации документов, свидетельством того, почему назначение должно быть исключением из ожидаемого значения.

#### <a name="applying-configurations-using-guest-configuration"></a>Применение конфигураций с использованием конфигурации гостей

Последняя функция Azure Policy настраивает настройки внутри машин. Определение _Настройка часового пояса на компьютерах Windows_ вносит изменения в машину, настраивая часовой пояс.

При назначении определений, начатых с _настройки,_ необходимо также назначить предпосылки развертывания определения _для включения политики конфигурации гостевых номеров для Windows VMs._ Вы можете объединить эти определения в инициативе, если вы выберете.

#### <a name="assigning-policies-to-machines-outside-of-azure"></a>Назначение политик для машин за пределами Azure

Политики аудита, доступные для конфигурации гостей, включают тип ресурсов **Microsoft.HybridCompute/machines.** Автоматически включаются любые машины, находящиеся на борту [Azure Arc для серверов,](../../../azure-arc/servers/overview.md) которые находятся в сфере назначения политики.

### <a name="multiple-assignments"></a>Несколько заданий

Политики конфигурации гостей в настоящее время поддерживают назначение одного и того же назначения гостя только один раз в машине, даже если в назначении политики используются различные параметры.

## <a name="client-log-files"></a>Файлы журналов клиента

Расширение конфигурации гостей записывает файлы журнала в следующие места:

Windows: `C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log`

Linux: `/var/lib/GuestConfig/gc_agent_logs/gc_agent.log`

Где `<version>` относится к текущему номеру версии.

### <a name="collecting-logs-remotely"></a>Сбор журналов удаленно

Первым шагом в устранении неполадок конфигураций или `Test-GuestConfigurationPackage` модулей гостевой конфигурации должно быть использование cmdlet следующие шаги, как [создать пользовательские гостевой конфигурации аудита политики для Windows.](../how-to/guest-configuration-create.md#step-by-step-creating-a-custom-guest-configuration-audit-policy-for-windows)
Если это не удалось, сбор журналов клиентов может помочь диагностировать проблемы.

#### <a name="windows"></a>Windows

Для использования возможности команды Azure VM Run Command для сбора информации из файлов журналов в компьютерах Windows может быть полезно использовать следующий пример скрипт PowerShell. Для получения дополнительной информации смотрите [сценарии Run PowerShell в Windows VM с командой Run.](../../../virtual-machines/windows/run-command.md)

```powershell
$linesToIncludeBeforeMatch = 0
$linesToIncludeAfterMatch = 10
$logPath = 'C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log'
Select-String -Path $logPath -pattern 'DSCEngine','DSCManagedEngine' -CaseSensitive -Context $linesToIncludeBeforeMatch,$linesToIncludeAfterMatch | Select-Object -Last 10
```

#### <a name="linux"></a>Linux

Для использования возможности команды Azure VM Run Command для сбора информации из файлов журналов в машинах Linux может быть полезно использовать следующий сценарий Bash. Для получения дополнительной информации смотрите [сценарии оболочки Run в вашем Linux VM с командой Run](../../../virtual-machines/linux/run-command.md)

```Bash
linesToIncludeBeforeMatch=0
linesToIncludeAfterMatch=10
logPath=/var/lib/GuestConfig/gc_agent_logs/gc_agent.log
egrep -B $linesToIncludeBeforeMatch -A $linesToIncludeAfterMatch 'DSCEngine|DSCManagedEngine' $logPath | tail
```

## <a name="guest-configuration-samples"></a>Образцы конфигурации гостей

Источник для встроенных инициатив по настройке гостевых политических гостей доступен в следующих местах:

- [Встроенные определения политики - Конфигурация гостей](../samples/built-in-policies.md#guest-configuration)
- [Встроенные инициативы - Конфигурация гостей](../samples/built-in-initiatives.md#guest-configuration)
- [Образцы политики Azure GitHub репо](https://github.com/Azure/azure-policy/tree/master/built-in-policies/policySetDefinitions/Guest%20Configuration)

## <a name="next-steps"></a>Дальнейшие действия

- Просмотрите [примеры на примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Изучите [сведения о действии политик](effects.md).
- Понять, как [программно создавать политики.](../how-to/programmatically-create.md)
- Узнайте, как [получить данные о соответствии.](../how-to/get-compliance-data.md)
- Узнайте, как [исправления несовместимых ресурсов.](../how-to/remediate-resources.md)
- Просмотрите, что представляет собой группа управления с [организацией ресурсов с группами управления Azure.](../../management-groups/overview.md)
