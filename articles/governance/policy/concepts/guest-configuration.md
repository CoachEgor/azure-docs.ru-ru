---
title: Изучение аудита содержимого виртуальных машин
description: Узнайте, как политика Azure использует агент гостевой конфигурации для аудита параметров в виртуальных машинах.
ms.date: 11/04/2019
ms.topic: conceptual
ms.openlocfilehash: 89f7cc3931971d70b441490f77b67ace89434c2b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82025226"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

Помимо аудита и [устранения](../how-to/remediate-resources.md) ресурсов Azure, политика Azure может выполнять аудит параметров внутри компьютера. Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как:

- Конфигурация операционной системы
- конфигурация или наличие приложения;
- Параметры среды

В настоящее время большинство политик гостевой конфигурации политики Azure только наследует параметры аудита на компьютере. Они не применяют конфигурации. Исключением является одна встроенная политика, [Указанная ниже](#applying-configurations-using-guest-configuration).

## <a name="resource-provider"></a>Поставщик ресурсов

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Поставщик ресурсов регистрируется автоматически, если назначение политики конфигурации на виртуальной машине выполняется на портале. Можно вручную зарегистрироваться на [портале](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-portal), [Azure PowerShell](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-powershell)или [Azure CLI](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-cli).

## <a name="extension-and-client"></a>Расширение и клиент

Для аудита параметров на компьютере включено [расширение виртуальной машины](../../../virtual-machines/extensions/overview.md) . Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

> [!Important]
> Для проведения аудита на виртуальных машинах Azure требуется расширение конфигурации гостевой виртуальной машины.
> Чтобы развернуть расширение в масштабе, назначьте следующие определения политик:
>   - [Развертывание необходимых компонентов для политики гостевой конфигурации на виртуальных машинах Windows](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2F0ecd903d-91e7-4726-83d3-a229d7f2e293)
>   - [Развертывание необходимых компонентов для политики гостевой конфигурации на виртуальных машинах Linux](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2Ffb27e9e0-526e-4ae1-89f2-a2a0bf0f8a50)

### <a name="limits-set-on-the-extension"></a>Ограничения, установленные для расширения

Чтобы ограничить расширение, влияющее на приложения, выполняемые внутри компьютера, конфигурация гостевой системы не может превышать 5% ресурсов ЦП. Это ограничение существует как для встроенных, так и для пользовательских определений.

### <a name="validation-tools"></a>Инструменты проверки

На виртуальной машине клиент настройки гостевой системы использует локальные средства для запуска аудита.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Настройка требуемого состояния Windows PowerShell](/powershell/scripting/dsc/overview/overview) v2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Если Ruby и Python не находятся на компьютере, они устанавливаются с помощью модуля настройки гостевой конфигурации. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя параметры для этой конфигурации повторно проверяются через 15-минутный интервал.
Результаты отправляются поставщику ресурсов гостевой конфигурации по завершении аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. Это обновление приводит к тому, что политика Azure оценивает свойства Azure Resource Manager. При оценке политики Azure по запросу извлекается Последнее значение из поставщика ресурсов гостевой конфигурации. Однако он не активирует новый аудит конфигурации в пределах компьютера.

## <a name="supported-client-types"></a>Поддерживаемые типы клиентов

Политики настройки гостевой системы являются инклюзивными для новых версий. Более старые версии операционных систем, доступные в Azure Marketplace, исключаются, если агент гостевой конфигурации несовместим. В следующей таблице приведен список поддерживаемых операционных систем в образах Azure.

|Издатель|Имя|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14,04 и более поздние версии|
|Credativ|Debian|8 и более поздних версий|
|Microsoft|Windows Server|2012 и более поздние версии|
|Microsoft|Клиент Windows|быть под управлением ОС Windows 10;|
|OpenLogic|CentOS|7,3 и более поздние версии|
|Red Hat|Red Hat Enterprise Linux|7,4 и более поздние версии|
|Suse|SLES|12 SP3 и более поздние версии|

Пользовательские образы виртуальных машин поддерживаются политиками гостевой конфигурации, если они являются одной из операционных систем в приведенной выше таблице.

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

Windows Server Nano Server не поддерживается ни в одной версии.

## <a name="guest-configuration-extension-network-requirements"></a>Требования к сети для расширения конфигурации гостя

Для взаимодействия с поставщиком ресурсов гостевой конфигурации в Azure компьютерам требуется исходящий доступ к центрам обработки данных Azure через порт **443**. Если сеть в Azure не разрешает исходящий трафик, настройте исключения с помощью правил [группы безопасности сети](../../../virtual-network/manage-network-security-group.md#create-a-security-rule) .
[Тег службы](../../../virtual-network/service-tags-overview.md) "гуестандхибридманажемент" можно использовать для ссылки на гостевую службу настройки.

## <a name="azure-managed-identity-requirements"></a>Требования к управляемому удостоверению Azure

Политики **DeployIfNotExists** , добавляющие расширение к виртуальным машинам, также позволяют назначить управляемое системой удостоверение, если оно не существует.

> [!WARNING]
> Не следует включать назначенное пользователем управляемое удостоверение для виртуальных машин в области действия для политик, которые позволяют использовать управляемое удостоверение, назначенное системой. Пользователь, которому назначено удостоверение, будет заменен, а компьютер может перестать отвечать на запросы.

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Для каждого запуска аудита в гостевой конфигурации требуются два определения политик: определение **DeployIfNotExists** и определение **помощью параметров auditifnotexists** . 

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Убедитесь, что компьютеру назначена конфигурация для оценки. Если назначение отсутствует, получите назначение и Подготовьте компьютер следующим образом.
  - Проверка подлинности на компьютере с помощью [управляемого удостоверения](../../../active-directory/managed-identities-azure-resources/overview.md)
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Если назначение **DeployIfNotExists** не соответствует требованиям, можно использовать [задачу по исправлению](../how-to/remediate-resources.md#create-a-remediation-task) .

Когда назначение **DeployIfNotExists** соответствует требованиям, назначение назначения политики **помощью параметров auditifnotexists** определяет, является ли назначение гостя соответствующим или несоответствующим. Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/get-compliance-data.md).

> [!NOTE]
> Политика **DeployIfNotExists** необходима, чтобы политика **помощью параметров auditifnotexists** возвращала результаты. Без **DeployIfNotExists**политика **помощью параметров auditifnotexists** показывает ресурсы "0 из 0" в качестве состояния.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива с именем _ \[Предварительная версия\]: аудит безопасности паролей на компьютерах Linux и Windows_ содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **AuditIfNotExists** для Windows и три пары для Linux. Логика [определения политики](definition-structure.md#policy-rule) проверяет, что оценивается только Целевая операционная система.

#### <a name="auditing-operating-system-settings-following-industry-baselines"></a>Аудит параметров операционной системы в следующих отраслевых показателях

Одна инициатива в политике Azure предоставляет возможность аудита параметров операционной системы после "базового плана". Определение, _ \[Предварительная\]версия: аудит виртуальных машин Windows, которые не соответствуют базовым параметрам безопасности Azure,_ включает набор правил на основе групповая политика Active Directory.

Большинство параметров доступны в качестве параметров. Параметры позволяют настроить аудит. Выровняйте политику с вашими требованиями или сопоставьте ее со сторонними сведениями, такими как отраслевые стандарты.

Некоторые параметры поддерживают диапазон целочисленных значений. Например, параметр максимального срока действия пароля может проверять действующий параметр групповая политика. Диапазон "1, 70" подтверждает, что пользователи должны будут менять свои пароли по крайней мере каждые 70 дней, но не менее одного дня.

Если вы назначаете политику с помощью шаблона развертывания Azure Resource Manager, используйте файл параметров для управления исключениями. Верните файлы в систему управления версиями, например Git. Комментарии об изменениях файлов предоставляют свидетельство о том, почему присваивание является исключением ожидаемого значения.

#### <a name="applying-configurations-using-guest-configuration"></a>Применение конфигураций с помощью гостевой конфигурации

Последняя функция политики Azure настраивает параметры внутри компьютеров. Определение Настройка часового _пояса на компьютерах Windows_ вносит изменения на компьютере, настраивая часовой пояс.

При назначении определений, начинающихся с _Configure_, необходимо также назначить определение _необходимые условия для включения гостевой политики конфигурации на виртуальных машинах Windows_. Вы можете комбинировать эти определения в инициативе, если вы решили.

#### <a name="assigning-policies-to-machines-outside-of-azure"></a>Назначение политик компьютерам за пределами Azure

Политики аудита, доступные для гостевой конфигурации, включают тип ресурса **Microsoft. хибридкомпуте/Machines** . Все компьютеры, подключенные к [службе "Дуга Azure" для серверов](../../../azure-arc/servers/overview.md) , которые находятся в области назначения политики, включаются автоматически.

### <a name="multiple-assignments"></a>Несколько назначений

Политики конфигурации гостя в настоящее время поддерживают назначение одного и того же назначения гостей один раз на компьютер, даже если в назначении политики используются другие параметры.

## <a name="client-log-files"></a>Файлы журналов клиента

Модуль настройки гостевой конфигурации записывает файлы журналов в следующие расположения:

Windows: `C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log`

Linux: `/var/lib/GuestConfig/gc_agent_logs/gc_agent.log`

Где `<version>` — номер текущей версии.

### <a name="collecting-logs-remotely"></a>Удаленная сбор журналов

Первым шагом в устранении неполадок конфигураций гостевой конфигурации или модулей является использование командлета, `Test-GuestConfigurationPackage` описанного в разделе [Создание пользовательской политики аудита конфигурации гостя для Windows](../how-to/guest-configuration-create.md#step-by-step-creating-a-custom-guest-configuration-audit-policy-for-windows).
Если это не удалось, сбор журналов клиентов может помочь в диагностике проблем.

#### <a name="windows"></a>Windows

Используйте следующий пример сценария PowerShell, чтобы записать сведения из файлов журнала с помощью [команды запуска виртуальной машины Azure](../../../virtual-machines/windows/run-command.md).

```powershell
$linesToIncludeBeforeMatch = 0
$linesToIncludeAfterMatch = 10
$logPath = 'C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log'
Select-String -Path $logPath -pattern 'DSCEngine','DSCManagedEngine' -CaseSensitive -Context $linesToIncludeBeforeMatch,$linesToIncludeAfterMatch | Select-Object -Last 10
```

#### <a name="linux"></a>Linux

Захватывать данные из файлов журнала с помощью [команды запуска виртуальной машины Azure](../../../virtual-machines/linux/run-command.md), может быть полезным следующий пример bash скрипта.

```Bash
linesToIncludeBeforeMatch=0
linesToIncludeAfterMatch=10
logPath=/var/lib/GuestConfig/gc_agent_logs/gc_agent.log
egrep -B $linesToIncludeBeforeMatch -A $linesToIncludeAfterMatch 'DSCEngine|DSCManagedEngine' $logPath | tail
```

## <a name="guest-configuration-samples"></a>Примеры настройки гостевой виртуальной машины

Примеры встроенной политики настройки гостевой конфигурации доступны в следующих расположениях:

- [Встроенные определения политик — конфигурация гостя](../samples/built-in-policies.md#guest-configuration)
- [Встроенные инициативы — конфигурация гостя](../samples/built-in-initiatives.md#guest-configuration)
- [Репозиторий с примерами политик Azure](https://github.com/Azure/azure-policy/tree/master/built-in-policies/policySetDefinitions/Guest%20Configuration)

## <a name="next-steps"></a>Дальнейшие шаги

- Узнайте, как просмотреть сведения о каждом параметре в [представлении "соответствие конфигурации гостевой виртуальной машины](../how-to/determine-non-compliance.md#compliance-details-for-guest-configuration) ".
- Просмотрите примеры в [примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Изучите [сведения о действии политик](effects.md).
- Узнайте, как [программно создавать политики](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Узнайте, что такое группа управления, и [Организуйте ресурсы с помощью групп управления Azure](../../management-groups/overview.md).
