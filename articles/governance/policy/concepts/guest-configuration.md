---
title: Научитесь проверять содержимое виртуальных машин
description: Узнайте, как Azure Policy использует агента конфигурации гостей для проверки настроек внутри виртуальных машин.
ms.date: 11/04/2019
ms.topic: conceptual
ms.openlocfilehash: 1721c0f1ca7c084d636278aabc96f8dac3293038
ms.sourcegitcommit: 31e9f369e5ff4dd4dda6cf05edf71046b33164d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81759079"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

Помимо аудита и [исправления](../how-to/remediate-resources.md) ресурсов Azure, Azure Policy может проверять настройки внутри машины. Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как:

- Конфигурация операционной системы
- конфигурация или наличие приложения;
- Параметры среды

В настоящее время большинство политик Azure Policy Guest Configuration политики только параметры аудита внутри машины. Они не применяются конфигурации. Исключением является одна встроенная политика, [на которая ссылается ниже](#applying-configurations-using-guest-configuration).

## <a name="resource-provider"></a>Поставщик ресурсов

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Поставщик ресурсов регистрируется автоматически, если через портал осуществляется назначение политики конфигурации гостей. Вы можете вручную зарегистрироваться через [портал,](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-portal) [Azure PowerShell](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-powershell), или [Azure CLI](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-cli).

## <a name="extension-and-client"></a>Расширение и клиент

Для проверки настроек внутри машины [включено виртуальное расширение машины.](../../../virtual-machines/extensions/overview.md) Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

> [!Important]
> Расширение конфигурации гостей необходимо для проведения аудита в виртуальных машинах Azure.
> Чтобы развернуть расширение в масштабе, назначайте следующие определения политики:
>   - Развертывание необходимых компонентов для политики гостевой конфигурации на виртуальных машинах Windows
>   - Развертывание необходимых компонентов для политики гостевой конфигурации на виртуальных машинах Linux

### <a name="limits-set-on-the-extension"></a>Ограничения, установленные на расширение

Чтобы ограничить расширение от воздействия приложений, работающих внутри машины, конфигурация гостя не может превышать более 5% процессора. Это ограничение существует как для встроенных, так и для пользовательских определений.

### <a name="validation-tools"></a>Инструменты проверки

Внутри машины клиент Гостевой Конфигурации использует локальные инструменты для выполнения аудита.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Windows PowerShell Желаемое состояние Конфигурация](/powershell/scripting/dsc/overview/overview) v2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Если Ruby и Python не находятся на машине, они устанавливаются расширением конфигурации гостя. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя настройки этой конфигурации перепроверяются с 15-минутным интервалом.
Результаты отправляются поставщику ресурсов гостевой конфигурации по завершении аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. Это обновление заставляет политику Azure оценивать свойства диспетчера ресурсов Azure. Оценка политики Azure по требованию получает последнее значение от поставщика ресурсов гостевой конфигурации. Однако это не вызывает нового аудита конфигурации в машине.

## <a name="supported-client-types"></a>Поддерживаемые типы клиентов

Политики конфигурации гостей включают в себя новые версии. Старые версии операционных систем, доступных на рынке Azure, исключаются, если агент гостевой конфигурации не совместим. В следующей таблице приведен список поддерживаемых операционных систем на изображениях Azure:

|Издатель|Имя|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14.04 и позже|
|Credativ|Debian|8 и более поздних|
|Майкрософт|Windows Server|2012 и более поздние|
|Майкрософт|Клиент Windows|Windows 10|
|OpenLogic|CentOS|7.3 и более поздние|
|Red Hat|Red Hat Enterprise Linux|7.4 и более поздние|
|Suse|SLES|12 SP3 и позже|

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

Наносервер Windows Server не поддерживается ни в одной версии.

## <a name="guest-configuration-extension-network-requirements"></a>Требования к сети расширения конфигурации гостей

Для связи с поставщиком ресурсов Гостевой Конфигурации в Azure машинам требуется исходящий доступ к центрам обработки данных Azure в порту **443.** Если сеть в Azure не разрешает исходящий трафик, назначайте исключения с [правилами Группы сетевой безопасности.](../../../virtual-network/manage-network-security-group.md#create-a-security-rule)
[Тег сервиса](../../../virtual-network/service-tags-overview.md) "GuestAndHybridManagement" можно использовать для ссылки на службу конфигурации гостей.

## <a name="azure-managed-identity-requirements"></a>Управляемые требования к идентификационным излза Azure

Политики **DeployIfNotExists,** добавляющие расширение к виртуальным машинам, также позволяют системе, назначенной управляемой идентификации, если она не существует.

> [!WARNING]
> Избегайте включения пользователя, назначенного управляемым имитатом, виртуальным машинам в области политик, которые позволяют системе присваиваемо управляемое удостоверение. Назначенный пользователем идентификатор будет заменен и может стать машиной без ответа.

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Каждый аудит, проводимый гостевой конфигурацией, требует двух определений политики: определения **DeployIfNotExists** и определения **AuditIfNotExists.** 

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Проверка машины была назначена конфигурация для оценки. Если в настоящее время нет назначения, получите задание и подготовьте машину:
  - Проверка подлинности машины с помощью [управляемой идентификации](../../../active-directory/managed-identities-azure-resources/overview.md)
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Если назначение **DeployIfNotExists** не соответствует требованиям, можно использовать [задачу восстановления.](../how-to/remediate-resources.md#create-a-remediation-task)

После того, как назначение **DeployIfNotExistsIs** соответствует требованиям, назначение политики **AuditIfNotExists** определяет, соответствует ли назначение гостя требованиям или не соответствует требованиям. Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/get-compliance-data.md).

> [!NOTE]
> Политика **DeployIfNotExists** необходима для того, чтобы политика **AuditIfNotExists была** возвращена результатам. Без **DeployIfNotExists**, **политика AuditIfNotExists** показывает ресурсы "0 из 0" как статус.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива под названием _ \[Preview\]: Безопасность аудита паролей внутри Linux и Windows-машин_ содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **AuditIfNotExists** для Windows и три пары для Linux. Логика [определения политики](definition-structure.md#policy-rule) подтверждает, что оценивается только целевая операционная система.

#### <a name="auditing-operating-system-settings-following-industry-baselines"></a>Аудит настроек операционной системы в соответствии с отраслевыми базовыми стандартами

Одна из инициатив В Azure Policy предоставляет возможность аудита настроек операционной системы после «базового». Определение, _ \[Предварительный\]просмотр: Аудит Windows VMs, которые не соответствуют базовым настройкам безопасности Azure,_ включает в себя набор правил, основанных на политике группы Active Directory.

Большинство настроек доступны в качестве параметров. Параметры позволяют настроить то, что проверяется. Составить политику с вашими требованиями или сопоставить политику с информацией третьих сторон, такой как отраслевые нормативные стандарты.

Некоторые параметры поддерживают целый диапазон значений. Например, параметр "Максимальный возраст паролей" может провести аудит эффективной настройки групповой политики. Диапазон "1,70" подтвердит, что пользователи должны менять свои пароли не реже чем каждые 70 дней, но не менее одного дня.

При свяжем политику с помощью шаблона развертывания диспетчера ресурсов Azure, используйте файл параметров для управления исключениями. Проверьте файлы в системе управления версиями, такой как Git. Комментарии об изменениях файлов свидетельствуют о том, почему назначение является исключением из ожидаемого значения.

#### <a name="applying-configurations-using-guest-configuration"></a>Применение конфигураций с использованием конфигурации гостей

Последняя функция Azure Policy настраивает настройки внутри машин. Определение _Настройка часового пояса на компьютерах Windows_ вносит изменения в машину, настраивая часовой пояс.

При назначении определений, начатых с _настройки,_ необходимо также назначить предпосылки развертывания определения _для включения политики конфигурации гостевых номеров для Windows VMs._ Вы можете объединить эти определения в инициативе, если вы выберете.

#### <a name="assigning-policies-to-machines-outside-of-azure"></a>Назначение политик для машин за пределами Azure

Политики аудита, доступные для конфигурации гостей, включают тип ресурсов **Microsoft.HybridCompute/machines.** Автоматически включаются любые машины, находящиеся на борту [Azure Arc для серверов,](../../../azure-arc/servers/overview.md) которые находятся в сфере назначения политики.

### <a name="multiple-assignments"></a>Несколько заданий

Политики конфигурации гостей в настоящее время поддерживают назначение одного и того же назначения гостя только один раз в машине, даже если в назначении политики используются различные параметры.

## <a name="client-log-files"></a>Файлы журналов клиента

Расширение конфигурации гостей записывает файлы журнала в следующие места:

Windows: `C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log`

Linux: `/var/lib/GuestConfig/gc_agent_logs/gc_agent.log`

Где `<version>` относится к текущему номеру версии.

### <a name="collecting-logs-remotely"></a>Сбор журналов удаленно

Первым шагом в устранении неполадок конфигураций или `Test-GuestConfigurationPackage` модулей гостевой конфигурации должно быть использование cmdlet следующие шаги, как [создать пользовательские гостевой конфигурации аудита политики для Windows.](../how-to/guest-configuration-create.md#step-by-step-creating-a-custom-guest-configuration-audit-policy-for-windows)
Если это не удалось, сбор журналов клиентов может помочь диагностировать проблемы.

#### <a name="windows"></a>Windows

Захват информации из файлов журналов с помощью [команды Azure VM Run,](../../../virtual-machines/windows/run-command.md)следующий пример сценария PowerShell может быть полезным.

```powershell
$linesToIncludeBeforeMatch = 0
$linesToIncludeAfterMatch = 10
$logPath = 'C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log'
Select-String -Path $logPath -pattern 'DSCEngine','DSCManagedEngine' -CaseSensitive -Context $linesToIncludeBeforeMatch,$linesToIncludeAfterMatch | Select-Object -Last 10
```

#### <a name="linux"></a>Linux

Захват информации из файлов журналов с помощью [команды Azure VM Run,](../../../virtual-machines/linux/run-command.md)следующий пример Bash скрипт может быть полезным.

```Bash
linesToIncludeBeforeMatch=0
linesToIncludeAfterMatch=10
logPath=/var/lib/GuestConfig/gc_agent_logs/gc_agent.log
egrep -B $linesToIncludeBeforeMatch -A $linesToIncludeAfterMatch 'DSCEngine|DSCManagedEngine' $logPath | tail
```

## <a name="guest-configuration-samples"></a>Образцы конфигурации гостей

Встроенные образцы политики конфигурации гостей доступны в следующих местах:

- [Встроенные определения политики - Конфигурация гостей](../samples/built-in-policies.md#guest-configuration)
- [Встроенные инициативы - Конфигурация гостей](../samples/built-in-initiatives.md#guest-configuration)
- [Образцы политики Azure GitHub репо](https://github.com/Azure/azure-policy/tree/master/built-in-policies/policySetDefinitions/Guest%20Configuration)

## <a name="next-steps"></a>Следующие шаги

- Узнайте, как просматривать сведения о каждом параметре из [представления о соответствии конфигурации гостей](../how-to/determine-non-compliance.md#compliance-details-for-guest-configuration)
- Просмотрите [примеры на примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Изучите [сведения о действии политик](effects.md).
- Понять, как [программно создавать политики.](../how-to/programmatically-create.md)
- Узнайте, как [получить данные о соответствии.](../how-to/get-compliance-data.md)
- Узнайте, как [исправления несовместимых ресурсов.](../how-to/remediate-resources.md)
- Просмотрите, что представляет собой группа управления с [организацией ресурсов с группами управления Azure.](../../management-groups/overview.md)
