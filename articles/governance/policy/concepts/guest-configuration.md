---
title: Узнайте, как аудит содержимого виртуальной машины
description: Узнайте, как служба "Политика Azure" использует гостевую конфигурацию для аудита параметров на виртуальной машине Azure.
author: DCtheGeek
ms.author: dacoulte
ms.date: 03/18/2019
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.custom: seodec18
ms.openlocfilehash: c98229a28f31ff715f252dc3915ca690e99245ff
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65979511"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

В дополнение к аудит и [исправления](../how-to/remediate-resources.md) параметры на виртуальной машине можно аудита ресурсов Azure, "Политика Azure". Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как конфигурация операционной системы, конфигурация или наличие приложения, настройки среды и т. д.

[!INCLUDE [az-powershell-update](../../../../includes/updated-for-az.md)]

## <a name="extension-and-client"></a>Расширение и клиент

Для аудита параметров на виртуальной машине включено [расширение виртуальной машины](../../../virtual-machines/extensions/overview.md). Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

### <a name="register-guest-configuration-resource-provider"></a>Регистрация поставщика ресурсов гостевой конфигурации

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Регистрацию можно выполнить с помощью портала или PowerShell. Поставщик ресурсов зарегистрирован автоматически, если назначение политики конфигурации гостевой осуществляется с помощью портала.

#### <a name="registration---portal"></a>Регистрация на портале

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через портал Azure, выполните следующие действия:

1. Запустите портал Azure и выберите **Все службы**. Выполните поиск по запросу **Подписки** и выберите этот пункт.

1. Найдите ту подписку, для которой нужно включить гостевую конфигурацию, и выберите ее.

1. В меню слева страницы **Подписка** щелкните **Поставщики ресурсов**.

1. Выполните фильтрацию или прокрутите, пока не найдете **Microsoft.GuestConfiguration**, а затем выберите **Регистрация** в той же строке.

#### <a name="registration---powershell"></a>Регистрация с помощью PowerShell

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через PowerShell, выполните следующую команду:

```azurepowershell-interactive
# Login first with Connect-AzAccount if not using Cloud Shell
Register-AzResourceProvider -ProviderNamespace 'Microsoft.GuestConfiguration'
```

### <a name="validation-tools"></a>Инструменты проверки

Для выполнения аудита на виртуальной машине клиент гостевой конфигурации использует локальные средства.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Конфигурация требуемого состояния Майкрософт](/powershell/dsc) версии 2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Ruby и Python устанавливаются с помощью расширения гостевой конфигурации. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя параметры проверяются с 15-минутным интервалом. Результаты отправляются поставщику ресурсов гостевой конфигурации после завершения аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. В этом случае Политика Azure должна оценивать свойства Azure Resource Manager. Вычисления по запросу "Политика Azure" получает последнее значение из поставщика ресурсов конфигурации гостевой. Однако она не запускает новый аудит конфигурации в виртуальной машине.

### <a name="supported-client-types"></a>Поддерживаемые типы клиентов

В следующей таблице перечислены операционные системы, поддерживаемые в образах Azure:

|Издатель|Name|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14.04, 16.04, 18.04|
|Credativ|Debian|8, 9|
|Майкрософт|Windows Server|2012 Datacenter, Datacenter 2012 R2, 2016 Datacenter, Datacenter 2019 г.|
|Майкрософт|Клиент Windows|Windows 10|
|OpenLogic|CentOS|7.3, 7.4, 7.5|
|Red Hat|Red Hat Enterprise Linux.|7.4, 7.5|
|SUSE|SLES|12 с пакетом обновления 3|

> [!IMPORTANT]
> Конфигурации гостевых проводить аудит узлов под управлением поддерживаемой операционной Системой. Если вы хотите аудит виртуальных машин, использующих пользовательский образ, необходимо дублировать **DeployIfNotExists** определение и изменение **Если** раздел, посвященный вашей свойства изображения.

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

Windows Server Nano Server не поддерживается в любой версии.

### <a name="guest-configuration-extension-network-requirements"></a>Требования к сети гостевой конфигурации расширения

Для взаимодействия с поставщиком ресурсов в Azure конфигурации гостевых виртуальных машин требуется исходящий доступ к центрам обработки данных Azure через порт **443**. Если вы используете виртуальной частной сети в Azure и не разрешить исходящий трафик, исключения должен быть настроен с помощью [группы безопасности сети](../../../virtual-network/manage-network-security-group.md#create-a-security-rule) правила. В настоящее время тег службы не существует конфигурация гостя политики Azure.

Списки IP-адресов, то вы можете скачать [Microsoft Azure Datacenter IP-диапазонов](https://www.microsoft.com/download/details.aspx?id=41653). Файл обновляется еженедельно и содержит развернутые в настоящее время диапазоны и все предстоящие изменения диапазонов IP-адресов. Необходимо разрешить исходящий доступ к IP-адресов в регионах, где развернуты виртуальные машины.

> [!NOTE]
> В XML-файле IP-адресов центра обработки данных Azure приводится список диапазонов IP-адресов, используемых в центрах обработки данных Microsoft Azure. Этот файл включает диапазоны вычисления, хранения и SQL. Обновленный файл публикуется еженедельно. Он отражает развернутые в настоящее время диапазоны и все предстоящие изменения IP-адресов. Новые диапазоны, появившиеся в файле, не будут использоваться в центрах обработки данных по крайней мере одну неделю. Скачивайте новый XML-файл каждую неделю и вносите соответствующие изменения на своем сайте, чтобы правильно определять службы, выполняемые в Azure. Пользователям Azure ExpressRoute следует обратить внимание, что этот файл используется для того, чтобы обновлять протокол BGP в пространстве Azure в первую неделю каждого месяца.

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Каждый аудита, обслуживаемая конфигурации гостевой требует два определения политик, **DeployIfNotExists** определения и **аудита** определения. **DeployIfNotExists** определение служит для подготовки виртуальной машины с помощью конфигурации гостевой агент и другие компоненты для поддержки [средства проверки](#validation-tools).

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Проверяет, что виртуальной машине назначена конфигурация для проверки. Если в настоящее время назначения не существует, получите назначение и подготовьте виртуальную машину путем:
  - выполнения аутентификации на виртуальной машине с помощью [управляемого удостоверения](../../../active-directory/managed-identities-azure-resources/overview.md);
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Если **DeployIfNotExists** присваивания — не соответствует, [задачи исправления](../how-to/remediate-resources.md#create-a-remediation-task) может использоваться.

Один раз **DeployIfNotExists** назначен совместимый, **аудита** назначение политики используются средства, локальная проверка для определения того, является ли назначение конфигурации соответствующих или не соответствующие требованиям.
Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/getting-compliance-data.md).

> [!NOTE]
> Для каждого определения гостевой конфигурации должны существовать оба определения политик: и **DeployIfNotExists**, и **Audit**.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива *[Предварительная версия]. Проверка параметров безопасности паролей в виртуальных машинах Linux и Windows* содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **Audit** для Windows и три пары для Linux. В каждом случае логика в определении проверяет, чтобы только целевая операционная система оценивалась на основе определения [правила политики](definition-structure.md#policy-rule).

## <a name="client-log-files"></a>Файлы журналов клиента

Расширение конфигурации гостевой записывает файлы журнала в следующих расположениях:

Windows: `C:\Packages\Plugins\Microsoft.GuestConfiguration.ConfigurationforWindows\<version>\dsc\logs\dsc.log`

Linux: `/var/lib/waagent/Microsoft.GuestConfiguration.ConfigurationforLinux-<version>/GCAgent/logs/dsc.log`

Где `<version>` ссылается на номер текущей версии.

## <a name="guest-configuration-samples"></a>Примеры конфигурации гостевой

Примеры конфигурации гостевой политики доступны в следующих расположениях:

- [Примеры указатель - Гость конфигурации](../samples/index.md#guest-configuration)
- ["Политика Azure" Примеры репозиторий GitHub](https://github.com/Azure/azure-policy/tree/master/samples/GuestConfiguration).

## <a name="next-steps"></a>Дальнейшие действия

- Просмотрите примеры доступны на [примеры политик Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Изучите [сведения о действии политик](effects.md).
- Понять, как [программное создание политик](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/getting-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/index.md).