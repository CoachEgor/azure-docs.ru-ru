---
title: Сведения о том, как выполнять аудит содержимого виртуальной машины
description: Узнайте, как служба "Политика Azure" использует гостевую конфигурацию для аудита параметров на виртуальной машине Azure.
author: DCtheGeek
ms.author: dacoulte
ms.date: 03/18/2019
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.custom: seodec18
ms.openlocfilehash: 18a85fae7d2d241bd8d582db73c71e1d1472f04d
ms.sourcegitcommit: 94ee81a728f1d55d71827ea356ed9847943f7397
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2019
ms.locfileid: "70036319"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

Помимо аудита и [устранения](../how-to/remediate-resources.md) ресурсов Azure, политика Azure может выполнять аудит параметров внутри виртуальной машины. Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как конфигурация операционной системы, конфигурация или наличие приложения, настройки среды и т. д.

В настоящее время Гостевая Конфигурация политики Azure выполняет только аудит параметры числа внутри компьютера.
Применение конфигураций пока невозможно.

[!INCLUDE [az-powershell-update](../../../../includes/updated-for-az.md)]

## <a name="extension-and-client"></a>Расширение и клиент

Для аудита параметров на виртуальной машине включено [расширение виртуальной машины](../../../virtual-machines/extensions/overview.md). Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

### <a name="limits-set-on-the-exension"></a>Ограничения, установленные для ексенсион

Чтобы ограничить расширение, влияющее на приложения, выполняющиеся на компьютере, конфигурация гостевой системы не может превышать 5% использования ЦП.
Это справедливо Бох для конфигураций, предоставляемых корпорацией Майкрософт в качестве встроенных, и для пользовательских конфигураций, созданных клиентами.

## <a name="register-guest-configuration-resource-provider"></a>Регистрация поставщика ресурсов гостевой конфигурации

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Регистрацию можно выполнить с помощью портала или PowerShell. Поставщик ресурсов регистрируется автоматически, если назначение политики конфигурации на виртуальной машине выполняется на портале.

### <a name="registration---portal"></a>Регистрация на портале

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через портал Azure, выполните следующие действия:

1. Запустите портал Azure и выберите **Все службы**. Выполните поиск по запросу **Подписки** и выберите этот пункт.

1. Найдите ту подписку, для которой нужно включить гостевую конфигурацию, и выберите ее.

1. В меню слева страницы **Подписка** щелкните **Поставщики ресурсов**.

1. Выполните фильтрацию или прокрутите, пока не найдете **Microsoft.GuestConfiguration**, а затем выберите **Регистрация** в той же строке.

### <a name="registration---powershell"></a>Регистрация с помощью PowerShell

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через PowerShell, выполните следующую команду:

```azurepowershell-interactive
# Login first with Connect-AzAccount if not using Cloud Shell
Register-AzResourceProvider -ProviderNamespace 'Microsoft.GuestConfiguration'
```

## <a name="validation-tools"></a>Инструменты проверки

Для выполнения аудита на виртуальной машине клиент гостевой конфигурации использует локальные средства.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Конфигурация требуемого состояния Майкрософт](/powershell/dsc) версии 2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Ruby и Python устанавливаются с помощью расширения гостевой конфигурации. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя параметры проверяются с 15-минутным интервалом. Результаты отправляются поставщику ресурсов гостевой конфигурации после завершения аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. В этом случае Политика Azure должна оценивать свойства Azure Resource Manager. При оценке политики Azure по запросу извлекается Последнее значение из поставщика ресурсов гостевой конфигурации. Однако она не запускает новый аудит конфигурации в виртуальной машине.

## <a name="supported-client-types"></a>Поддерживаемые типы клиентов

В следующей таблице перечислены операционные системы, поддерживаемые в образах Azure:

|Издатель|Название|Версии|
|-|-|-|
|Канонический|Сервер Ubuntu|14.04, 16.04, 18.04|
|Credativ|Debian|8, 9|
|Майкрософт|Windows Server|2012 Datacenter, 2012 R2 Datacenter, 2016 Datacenter, 2019 Datacenter|
|Майкрософт|Клиент Windows|Windows 10|
|OpenLogic|CentOS|7.3, 7.4, 7.5|
|Red Hat|Red Hat Enterprise Linux|7.4, 7.5|
|SUSE|SLES|12 с пакетом обновления 3|

> [!IMPORTANT]
> Гостевая конфигурация может выполнять аудит узлов, работающих под управлением поддерживаемой ОС. Если вы хотите выполнять аудит виртуальных машин, использующих пользовательский образ, необходимо дублировать определение **DeployIfNotExists** и изменить раздел **If** , включив в него свойства изображения.

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

Windows Server Nano Server не поддерживается ни в одной версии.

## <a name="guest-configuration-extension-network-requirements"></a>Требования к сети для расширения конфигурации гостя

Для взаимодействия с поставщиком ресурсов гостевой конфигурации в Azure виртуальным машинам требуется исходящий доступ к центрам обработки данных Azure через порт **443**. Если вы используете в Azure частную виртуальную сеть и не разрешаете исходящий трафик, необходимо настроить исключения с помощью правил [группы безопасности сети](../../../virtual-network/manage-network-security-group.md#create-a-security-rule) . В настоящее время тег службы не существует для гостевой конфигурации политики Azure.

Для списков IP-адресов можно скачать [диапазоны IP-адреса центра обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). Файл обновляется еженедельно и содержит развернутые в настоящее время диапазоны и все предстоящие изменения диапазонов IP-адресов. Вам нужно только разрешить исходящий доступ к IP-адресам в регионах, где развернуты виртуальные машины.

> [!NOTE]
> В XML-файле IP-адресов центра обработки данных Azure приводится список диапазонов IP-адресов, используемых в центрах обработки данных Microsoft Azure. Этот файл включает диапазоны вычисления, хранения и SQL. Обновленный файл публикуется еженедельно. Он отражает развернутые в настоящее время диапазоны и все предстоящие изменения IP-адресов. Новые диапазоны, появившиеся в файле, не будут использоваться в центрах обработки данных по крайней мере одну неделю. Скачивайте новый XML-файл каждую неделю и вносите соответствующие изменения на своем сайте, чтобы правильно определять службы, выполняемые в Azure. Пользователям Azure ExpressRoute следует обратить внимание, что этот файл используется для того, чтобы обновлять протокол BGP в пространстве Azure в первую неделю каждого месяца.

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Для каждого запуска аудита в гостевой конфигурации требуются два определения политик: определение **DeployIfNotExists** и определение **помощью параметров auditifnotexists** . Определение **DeployIfNotExists** используется для подготовки виртуальной машины с помощью гостевого агента конфигурации и других компонентов для поддержки [средств проверки](#validation-tools).

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Проверяет, что виртуальной машине назначена конфигурация для проверки. Если в настоящее время назначения не существует, получите назначение и подготовьте виртуальную машину путем:
  - выполнения аутентификации на виртуальной машине с помощью [управляемого удостоверения](../../../active-directory/managed-identities-azure-resources/overview.md);
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Если назначение **DeployIfNotExists** не соответствует требованиям, можно использовать [задачу](../how-to/remediate-resources.md#create-a-remediation-task) по исправлению.

После того как назначение **DeployIfNotExists** соответствует требованиям, назначение политики **помощью параметров auditifnotexists** использует средства локальной проверки, чтобы определить, является ли назначение конфигурации совместимым или несоответствующим.
Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/getting-compliance-data.md).

> [!NOTE]
> Политика **DeployIfNotExists** необходима, чтобы политика **помощью параметров auditifnotexists** возвращала результаты.
> Без **DeployIfNotExists**политика **помощью параметров auditifnotexists** показывает ресурсы "0 из 0" в качестве состояния.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива *[Предварительная версия]. Проверка параметров безопасности паролей в виртуальных машинах Linux и Windows* содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **AuditIfNotExists** для Windows и три пары для Linux. В каждом случае логика в определении проверяет, чтобы только целевая операционная система оценивалась на основе определения [правила политики](definition-structure.md#policy-rule).

### <a name="multiple-assignments"></a>Несколько назначений

Политики конфигурации гостя в настоящее время поддерживают назначение одного и того же назначения гостей один раз для каждой виртуальной машины, даже если назначение политики использует другие параметры.

## <a name="client-log-files"></a>Файлы журналов клиента

Модуль настройки гостевой конфигурации записывает файлы журналов в следующие расположения:

Windows: `C:\Packages\Plugins\Microsoft.GuestConfiguration.ConfigurationforWindows\<version>\dsc\logs\dsc.log`

Linux: `/var/lib/waagent/Microsoft.GuestConfiguration.ConfigurationforLinux-<version>/GCAgent/logs/dsc.log`

Где `<version>` — номер текущей версии.

## <a name="guest-configuration-samples"></a>Примеры настройки гостевой виртуальной машины

Примеры настройки гостевой конфигурации политики доступны в следующих расположениях:

- [Индекс выборок — конфигурация гостя](../samples/index.md#guest-configuration)
- [Репозиторий GitHub с примерами политик Azure](https://github.com/Azure/azure-policy/tree/master/samples/GuestConfiguration).

## <a name="next-steps"></a>Следующие шаги

- Просмотрите примеры в [примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Изучите [сведения о действии политик](effects.md).
- Узнайте, как [программно создавать политики](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/getting-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/index.md).
