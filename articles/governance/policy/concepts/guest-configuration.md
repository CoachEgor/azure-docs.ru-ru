---
title: Изучение аудита содержимого виртуальных машин
description: Узнайте, как политика Azure использует агент гостевой конфигурации для аудита параметров в виртуальных машинах.
ms.date: 11/04/2019
ms.topic: conceptual
ms.openlocfilehash: 73f986774fc13ac8c69cd800c977c909b591a74c
ms.sourcegitcommit: f255f869c1dc451fd71e0cab340af629a1b5fb6b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/16/2020
ms.locfileid: "77369742"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

Помимо аудита и [устранения](../how-to/remediate-resources.md) ресурсов Azure, политика Azure может выполнять аудит параметров внутри компьютера. Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как:

- Конфигурация операционной системы
- конфигурация или наличие приложения;
- Параметры среды

В настоящее время гостевая конфигурация политики Azure выполняет аудит только параметров внутри компьютера. Конфигурации не применяются.

## <a name="extension-and-client"></a>Расширение и клиент

Для аудита параметров на компьютере включено [расширение виртуальной машины](../../../virtual-machines/extensions/overview.md) . Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации.

### <a name="limits-set-on-the-extension"></a>Ограничения, установленные для расширения

Чтобы ограничить расширение, влияющее на приложения, выполняемые внутри компьютера, конфигурация гостевой системы не может превышать 5% использования ЦП. Это ограничение существует как для встроенных, так и для пользовательских определений.

## <a name="register-guest-configuration-resource-provider"></a>Регистрация поставщика ресурсов гостевой конфигурации

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Регистрацию можно выполнить с помощью портала или PowerShell. Поставщик ресурсов регистрируется автоматически, если назначение политики конфигурации на виртуальной машине выполняется на портале.

### <a name="registration---portal"></a>Регистрация на портале

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через портал Azure, выполните следующие действия:

1. Запустите портал Azure и выберите **Все службы**. Выполните поиск по запросу **Подписки** и выберите этот пункт.

1. Найдите ту подписку, для которой нужно включить гостевую конфигурацию, и выберите ее.

1. В меню слева страницы **Подписка** щелкните **Поставщики ресурсов**.

1. Выполните фильтрацию или прокрутите, пока не найдете **Microsoft.GuestConfiguration**, а затем выберите **Регистрация** в той же строке.

### <a name="registration---powershell"></a>Регистрация с помощью PowerShell

Чтобы зарегистрировать поставщик ресурсов для гостевой конфигурации через PowerShell, выполните следующую команду:

```azurepowershell-interactive
# Login first with Connect-AzAccount if not using Cloud Shell
Register-AzResourceProvider -ProviderNamespace 'Microsoft.GuestConfiguration'
```

## <a name="validation-tools"></a>Инструменты проверки

На виртуальной машине клиент настройки гостевой системы использует локальные средства для запуска аудита.

В следующей таблице перечислены локальные средства, используемые в поддерживаемых операционных системах:

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Настройка требуемого состояния Windows PowerShell](/powershell/scripting/dsc/overview/overview) v2| |
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Ruby и Python устанавливаются с помощью расширения гостевой конфигурации. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя параметры проверяются с 15-минутным интервалом. Результаты отправляются поставщику ресурсов гостевой конфигурации после завершения аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. Это обновление приводит к тому, что политика Azure оценивает свойства Azure Resource Manager. При оценке политики Azure по запросу извлекается Последнее значение из поставщика ресурсов гостевой конфигурации. Однако он не активирует новый аудит конфигурации в пределах компьютера.

## <a name="supported-client-types"></a>Поддерживаемые типы клиентов

В следующей таблице перечислены операционные системы, поддерживаемые в образах Azure:

|Издатель|Имя|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14.04, 16.04, 18.04|
|Credativ|Debian|8, 9|
|Microsoft|Windows Server|2012 Datacenter, 2012 R2 Datacenter, 2016 Datacenter, 2019 Datacenter|
|Microsoft|Клиент Windows|Windows 10|
|OpenLogic|CentOS|7.3, 7.4, 7.5|
|Red Hat|Red Hat Enterprise Linux|7.4, 7.5|
|Suse|SLES|12 с пакетом обновления 3|

> [!IMPORTANT]
> Гостевая конфигурация может выполнять аудит узлов, работающих под управлением поддерживаемой ОС. Если вы хотите выполнять аудит виртуальных машин, использующих пользовательский образ, необходимо дублировать определение **DeployIfNotExists** и изменить раздел **If** , включив в него свойства изображения.

### <a name="unsupported-client-types"></a>Неподдерживаемые типы клиентов

Windows Server Nano Server не поддерживается ни в одной версии.

## <a name="guest-configuration-extension-network-requirements"></a>Требования к сети для расширения конфигурации гостя

Для взаимодействия с поставщиком ресурсов гостевой конфигурации в Azure компьютерам требуется исходящий доступ к центрам обработки данных Azure через порт **443**. Если вы используете в Azure частную виртуальную сеть, которая не разрешает исходящий трафик, настройте исключения с помощью правил [группы безопасности сети](../../../virtual-network/manage-network-security-group.md#create-a-security-rule) .
[Тег службы](../../../virtual-network/service-tags-overview.md) "гуестандхибридманажемент" можно использовать для ссылки на гостевую службу настройки.

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Для каждого запуска аудита в гостевой конфигурации требуются два определения политик: определение **DeployIfNotExists** и определение **помощью параметров auditifnotexists** . Определение **DeployIfNotExists** используется для подготовки компьютера с помощью гостевого агента конфигурации и других компонентов для поддержки [средств проверки](#validation-tools).

Определение политики **DeployIfNotExists** проверяет и исправляет следующее:

- Убедитесь, что компьютеру назначена конфигурация для оценки. Если назначение отсутствует, получите назначение и Подготовьте компьютер следующим образом.
  - Проверка подлинности на компьютере с помощью [управляемого удостоверения](../../../active-directory/managed-identities-azure-resources/overview.md)
  - установки последней версии расширения **Microsoft.GuestConfiguration**;
  - установки [средств проверки](#validation-tools) и зависимостей, если это необходимо.

Если назначение **DeployIfNotExists** не соответствует требованиям, можно использовать [задачу по исправлению](../how-to/remediate-resources.md#create-a-remediation-task) .

После того как назначение **DeployIfNotExists** соответствует требованиям, назначение политики **помощью параметров auditifnotexists** использует средства локальной проверки, чтобы определить, является ли назначение конфигурации совместимым или несоответствующим. Средство проверки предоставляет результаты клиенту гостевой конфигурации. Клиент перенаправляет результаты в гостевое расширение, чтобы сделать их доступными через поставщик ресурсов гостевой конфигурации.

Служба "Политика Azure" использует свойство поставщиков ресурсов **complianceStatus**, чтобы сообщить о совместимости в узле **Compliance**. Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/get-compliance-data.md).

> [!NOTE]
> Политика **DeployIfNotExists** необходима, чтобы политика **помощью параметров auditifnotexists** возвращала результаты. Без **DeployIfNotExists**политика **помощью параметров auditifnotexists** показывает ресурсы "0 из 0" в качестве состояния.

Все встроенные политики гостевой конфигурации включены в инициативу для группировки определений, которые могут использоваться в назначениях. Встроенная инициатива с именем _\[Preview\]: аудит параметров безопасности паролей в Linux и Windows_ содержит 18 политик. Существует шесть пар определений **DeployIfNotExists** и **AuditIfNotExists** для Windows и три пары для Linux. Логика [определения политики](definition-structure.md#policy-rule) проверяет, что оценивается только Целевая операционная система.

#### <a name="auditing-operating-system-settings-following-industry-baselines"></a>Аудит параметров операционной системы в следующих отраслевых показателях

Одна из инициатив, доступных в политике Azure, позволяет выполнять аудит параметров операционной системы в виртуальных машинах с помощью "базовых показателей" от корпорации Майкрософт. Определение _\[Предварительная версия\]: аудит виртуальных машин Windows, которые не соответствуют базовым параметрам безопасности Azure,_ включает полный набор правил аудита на основе параметров из Active Directory групповая политика.

Большинство параметров доступны в качестве параметров. Эта функция позволяет настроить аудит, чтобы согласовать политику с требованиями организации или сопоставлять политику со сторонними сведениями, такими как отраслевые стандарты.

Некоторые параметры поддерживают диапазон целочисленных значений. Например, параметр максимального срока действия пароля может быть установлен с помощью оператора Range для предоставления гибкости владельцам компьютеров. Можно было бы проследить, что действующий параметр групповая политика, требующий от пользователей изменять пароли, должен быть не более 70 дней, но должен быть не меньше одного дня. Как описано в информационном подсказке для параметра, чтобы бизнес-политика действовала в соответствии с действующим значением аудита, установите значение "1, 70".

При назначении политики с помощью шаблона развертывания Azure Resource Manager можно использовать файл параметров для управления этими параметрами из системы управления версиями. Использование таких средств, как Git, для управления изменениями политик аудита с комментариями при каждом документе возврата свидетельствует о том, почему назначение должно быть исключением из ожидаемого значения.

#### <a name="applying-configurations-using-guest-configuration"></a>Применение конфигураций с помощью гостевой конфигурации

Последняя функция политики Azure настраивает параметры внутри компьютеров. Определение Настройка часового _пояса на компьютерах Windows_ вносит изменения на компьютере, настраивая часовой пояс.

При назначении определений, начинающихся с _Configure_, необходимо также назначить определение _необходимые условия для включения гостевой политики конфигурации на виртуальных машинах Windows_. Вы можете комбинировать эти определения в инициативе, если вы решили.

#### <a name="assigning-policies-to-machines-outside-of-azure"></a>Назначение политик компьютерам за пределами Azure

Политики аудита, доступные для гостевой конфигурации, включают тип ресурса **Microsoft. хибридкомпуте/Machines** . Все компьютеры, подключенные к [службе "Дуга Azure" для серверов](../../../azure-arc/servers/overview.md) , которые находятся в области назначения политики, включаются автоматически.

### <a name="multiple-assignments"></a>Несколько назначений

Политики конфигурации гостя в настоящее время поддерживают назначение одного и того же назначения гостей один раз на компьютер, даже если в назначении политики используются другие параметры.

## <a name="built-in-resource-modules"></a>Встроенные модули ресурсов

При установке расширения гостевой конфигурации модуль PowerShell "Гуестконфигуратион" входит в последнюю версию модулей ресурсов DSC. Этот модуль можно скачать из коллекция PowerShell с помощью ссылки для скачивания вручную на странице модуля [гуестконфигуратион](https://www.powershellgallery.com/packages/GuestConfiguration/). Формат файла ". nupkg" можно переименовать в ZIP-файл для распаковки и просмотра.

## <a name="client-log-files"></a>Файлы журналов клиента

Модуль настройки гостевой конфигурации записывает файлы журналов в следующие расположения:

Windows: `C:\Packages\Plugins\Microsoft.GuestConfiguration.ConfigurationforWindows\<version>\dsc\logs\dsc.log`

Linux: `/var/lib/waagent/Microsoft.GuestConfiguration.ConfigurationforLinux-<version>/GCAgent/logs/dsc.log`

Где `<version>` ссылается на номер текущей версии.

### <a name="collecting-logs-remotely"></a>Удаленная сбор журналов

Первым шагом в устранении неполадок конфигураций гостевых конфигураций или модулей является использование командлета `Test-GuestConfigurationPackage`, следуя инструкциям в разделе [тестирование гостевого пакета конфигурации](../how-to/guest-configuration-create.md#test-a-guest-configuration-package).
Если это не удалось, сбор журналов клиентов может помочь в диагностике проблем.

#### <a name="windows"></a>Windows

Чтобы использовать возможности команды запуска виртуальной машины Azure для записи данных из файлов журнала на компьютерах Windows, может оказаться полезным следующий пример сценария PowerShell. Дополнительные сведения см. [в статье запуск сценариев PowerShell в виртуальной машине Windows с помощью команды Run](../../../virtual-machines/windows/run-command.md).

```powershell
$linesToIncludeBeforeMatch = 0
$linesToIncludeAfterMatch = 10
$latestVersion = Get-ChildItem -Path 'C:\Packages\Plugins\Microsoft.GuestConfiguration.ConfigurationforWindows\' | ForEach-Object {$_.FullName} | Sort-Object -Descending | Select-Object -First 1
Select-String -Path "$latestVersion\dsc\logs\dsc.log" -pattern 'DSCEngine','DSCManagedEngine' -CaseSensitive -Context $linesToIncludeBeforeMatch,$linesToIncludeAfterMatch | Select-Object -Last 10
```

#### <a name="linux"></a>Linux

Чтобы использовать возможности команды запуска виртуальной машины Azure для записи данных из файлов журнала на компьютерах Linux, может быть полезным следующий пример bash скрипта. Дополнительные сведения см. [в статье запуск сценариев оболочки на виртуальной машине Linux с помощью команды Run](../../../virtual-machines/linux/run-command.md) .

```Bash
linesToIncludeBeforeMatch=0
linesToIncludeAfterMatch=10
latestVersion=$(find /var/lib/waagent/ -type d -name "Microsoft.GuestConfiguration.ConfigurationforLinux-*" -maxdepth 1 -print | sort -z | sed -n 1p)
egrep -B $linesToIncludeBeforeMatch -A $linesToIncludeAfterMatch 'DSCEngine|DSCManagedEngine' "$latestVersion/GCAgent/logs/dsc.log" | tail
```

## <a name="guest-configuration-samples"></a>Примеры настройки гостевой виртуальной машины

Источник для политики встроенных инициатив настройки гостевой конфигурации доступен в следующих расположениях:

- [Встроенные определения политик — конфигурация гостя](../samples/built-in-policies.md#guest-configuration)
- [Встроенные инициативы — конфигурация гостя](../samples/built-in-initiatives.md#guest-configuration)
- [Репозиторий с примерами политик Azure](https://github.com/Azure/azure-policy/tree/master/built-in-policies/policySetDefinitions/Guest%20Configuration)

## <a name="next-steps"></a>Следующие шаги

- Просмотрите примеры в [примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Изучите [сведения о действии политик](effects.md).
- Узнайте, как [программно создавать политики](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
