---
title: Принцип работы эффектов
description: Определения политик Azure содержат различные действия, влияющие на управление соответствием требованиям и отчеты о нем.
ms.date: 05/20/2020
ms.topic: conceptual
ms.openlocfilehash: 6c2dc8303b630eb01de5c3ad9e3504dfec5256bc
ms.sourcegitcommit: 493b27fbfd7917c3823a1e4c313d07331d1b732f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2020
ms.locfileid: "83746904"
---
# <a name="understand-azure-policy-effects"></a>Сведения о действии политик Azure

Каждое определение политики в Azure имеет один эффект. Этот эффект определяет, что происходит при вычислении правила политики при сопоставлении. Действия по-разному влияют на новые, обновленные и имеющиеся ресурсы.

В настоящее время в определении политики поддерживается следующие действия.

- [Append](#append)
- [Аудит](#audit)
- [AuditIfNotExists](#auditifnotexists)
- [Запретить](#deny)
- [DeployIfNotExists](#deployifnotexists)
- [Отключено](#disabled)
- [EnforceOPAConstraint](#enforceopaconstraint) (предварительная версия)
- [EnforceRegoPolicy](#enforceregopolicy) (предварительная версия)
- [Изменение](#modify)

## <a name="order-of-evaluation"></a>Порядок оценки

Запросы на создание или обновление ресурса с помощью Azure Resource Manager сначала оцениваются политикой Azure. Политика Azure создает список всех назначений, которые применяются к ресурсу, а затем оценивает ресурс по каждому определению. Прежде чем передать запрос к соответствующему поставщику ресурса, политика Azure обрабатывает несколько действий. Благодаря этому поставщик ресурсов не будет выполнять ненужную обработку, если ресурс не соответствует правилам управления, установленным в Политике Azure.

- Действие **Disabled** проверяется первым. Таким образом определяется, нужно ли оценить правило политики.
- Затем оцениваются **Append** и **Modify**. Поскольку оба могут изменить запрос, а внесенное изменение может отменить вызов действия аудита или запрета.
- Затем оценивается действие **Deny** (запрет). Запрет оценивается перед аудитом, чтобы нежелательный ресурс не заносился в журнал дважды.
- Затем оценивается действие **Audit** (аудит), после чего запрос отправляется поставщику ресурсов.

После того, как поставщик ресурсов вернет код успешного выполнения, **AuditIfNotExists** и **DeployIfNotExists** вычисляются для определения того, чтобы определить, требуется ли дополнительное ведение журнала соответствия или действие.

В настоящее время порядок оценки не используется для действий **EnforceOPAConstraint** и **EnforceRegoPolicy**.

## <a name="append"></a>Append

Это действие используется для добавления полей к запрашиваемому ресурсу во время создания или обновления. Типичный пример — указание разрешенных IP-адресов для ресурса хранилища.

> [!IMPORTANT]
> Append предназначено для использования со свойствами, не являющимися тегами. Несмотря на то что Append может добавлять теги к ресурсу во время запроса на создание или обновление, рекомендуется использовать [Modify](#modify) для тегов.

### <a name="append-evaluation"></a>Оценка добавления

Добавление оценивается до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Это действие добавляет поля к ресурсу, если выполняется условие **if** правила политики. Если добавление приведет к замене значения в исходном запросе на другое значение, то оно работает как действие запрета и отклоняет запрос. Чтобы добавить новое значение к имеющемуся массиву, используйте версию псевдонима **\[\*\]** .

При запуске определения политики с использованием действия добавления в рамках цикла оценивания оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="append-properties"></a>Свойства добавления

Действие добавления содержит только обязательный массив **details**. Так как свойство **details** представляет собой массив, оно может принимать как одну, так и несколько пар **поле/значение**. Список допустимых полей представлен в статье, посвященной [структуре определения](definition-structure.md#fields).

### <a name="append-examples"></a>Примеры добавления

Пример 1: Одна пара **поле/значение**, использующая псевдоним не являющийся **\[\*\]** — [псевдонимом](definition-structure.md#aliases) со **значением** массива для установки правил IP-адресов учетной записи хранения. Когда псевдоним без **\[\*\]** находится в массиве, действие добавляет **значение** ко всему массиву. Если массив уже существует, из конфликта возникает событие отказа.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules",
        "value": [{
            "action": "Allow",
            "value": "134.5.0.0/21"
        }]
    }]
}
```

Пример 2. Одна пара **поле/значение**, использующая **\[\*\]** — [псевдоним](definition-structure.md#aliases) со **значением** массива для установки правил IP-адресов учетной записи хранения. Путем использования **\[\*\]** — псевдонима действие добавляет **значение** к потенциально имеющемуся массиву. Если массив еще не существует, он будет создан.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*]",
        "value": {
            "value": "40.40.40.40",
            "action": "Allow"
        }
    }]
}
```




## <a name="audit"></a>Аудит

Аудит используется, чтобы создать предупреждение в журнале действий при оценке несоответствующего ресурса, но такое действие не останавливает запрос.

### <a name="audit-evaluation"></a>Оценка аудита

Аудит — это последнее действие проверки политики при создании или обновлении ресурса. Затем политика Azure отправляет ресурс Поставщику ресурсов. Аудит работает одинаково для запроса ресурса и для цикла оценки. Политика Azure добавляет операцию `Microsoft.Authorization/policies/audit/action` в журнал действий и помечает ресурс как несовместимый.

### <a name="audit-properties"></a>Свойства аудита

Действие аудита не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="audit-example"></a>Пример аудита

Пример Использование действия аудита.

```json
"then": {
    "effect": "audit"
}
```

## <a name="auditifnotexists"></a>AuditIfNotExists

Действие AuditIfNotExists позволяет выполнять аудит ресурсов, соответствующих условию **if**, но не содержат компонентов, указываемых в свойстве **details** условия **then**.

### <a name="auditifnotexists-evaluation"></a>Оценка AuditIfNotExists

Действие AuditIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Этот аудит происходит только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. Политика Azure добавляет операцию `Microsoft.Authorization/policies/audit/action` в журнал действий точно так же, как действие аудита. При вызове этого действия ресурс, соответствующий условию **if**, отмечается как несоответствующий.

### <a name="auditifnotexists-properties"></a>Свойства AuditIfNotExists

Свойство **details** действия AuditIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Если **details.type** является типом ресурса в основе ресурса условия **if**, политика запрашивает ресурсы этого **type** в области вычисляемого ресурса. В противном случае политики выполняет запрос в той же группе ресурсов, что и оцененный ресурс.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Если значения условия для **if.field.type** и **then.details.type** совпадают, **Имя** становится _обязательным_ и должно быть `[field('name')]`. Однако вместо этого следует учитывать действие [audit](#audit).
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а аудит не выполняется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не вызывает аудит.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.

### <a name="auditifnotexists-example"></a>Пример AuditIfNotExists

Пример Оценка виртуальных машин для поиска антивредоносного расширения с последующим аудитом при его отсутствии.

```json
{
    "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
    },
    "then": {
        "effect": "auditIfNotExists",
        "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "existenceCondition": {
                "allOf": [{
                        "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                        "equals": "Microsoft.Azure.Security"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/extensions/type",
                        "equals": "IaaSAntimalware"
                    }
                ]
            }
        }
    }
}
```

## <a name="deny"></a>Запрет

Запрет используется, чтобы не пропускать запросы ресурсов, не соответствующие определенным стандартам, через определение политики. При этом запрос завершается с ошибкой.

### <a name="deny-evaluation"></a>Оценка запрета

При создании или обновлении соответствующего ресурса запрет останавливает запрос до его отправки поставщику ресурсов. Запрос возвращает `403 (Forbidden)`. На портале для развертывания, запрещенного в связи с назначением политики, отображается состояние "Запрещено".

Во время оценки существующие ресурсы, которые соответствуют определению политики запрета, помечаются как несовместимые.

### <a name="deny-properties"></a>Свойства запрета

Действие запрета не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="deny-example"></a>Пример запрета

Пример Использование действия запрета.

```json
"then": {
    "effect": "deny"
}
```


## <a name="deployifnotexists"></a>DeployIfNotExists

Как и AuditIfNotExists, определение политики DeployIfNotExists выполняет шаблон развертывания при соблюдении условия.

> [!NOTE]
> [Вложенные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#nested-template) поддерживаются с **deployIfNotExists**, но [связанные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#linked-template) сейчас не поддерживаются.

### <a name="deployifnotexists-evaluation"></a>Оценка DeployIfNotExists

Действие DeployIfNotExists выполняется в течении примерно 15 минут после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Шаблон развертывания появляется только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true.
Длительность развертывания зависит от сложности ресурсов, включенных в шаблон.

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием DeployIfNotExists, отмечаются как несоответствующие, но с ними не выполняется никаких действий. Существующие несоответствующие ресурсы можно исправить, активировав [задачу исправления](../how-to/remediate-resources.md).

### <a name="deployifnotexists-properties"></a>Свойства DeployIfNotExists

Свойство **details** действия DeployIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления и шаблон развертывания.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Если значения условия для **if.field.type** и **then.details.type** совпадают, **Имя** становится _обязательным_ и должно быть `[field('name')]`.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
  - Шаблон развертывания выполняется в группе ресурсов, соответствующей этому значению.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а развертывание не активируется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не активирует развертывание.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.
- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
- **DeploymentScope** (необязательно)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает тип инициируемого развертывания. _Subscription_ указывает на [развертывание на уровне подписки](../../../azure-resource-manager/templates/deploy-to-subscription.md), а _ResourceGroup_ — на развертывание в группе ресурсов.
  - Свойство _location_ должно быть указано для объекта _Deployment_ при использовании развертываний на уровне подписки.
  - По умолчанию задано значение _ResourceGroup_.
- **Deployment** [обязательный]
  - Это свойство должно содержать полный шаблон развертывания, так как оно будет передано в API PUT `Microsoft.Resources/deployments`. Дополнительные сведения см. в [документации по REST API развертываний](/rest/api/resources/deployments).

  > [!NOTE]
  > Все функции в свойстве **Deployment** оцениваются как компоненты шаблона, а не политики. Исключение составляет свойство **parameters**, передающее значения из политики в шаблон. Свойство **value** из этого раздела под именем параметра шаблона используется для передачи значения (см. _fullDbName_ в примере DeployIfNotExists).

### <a name="deployifnotexists-example"></a>Пример DeployIfNotExists

Пример Оценка баз данных SQL Server, позволяющая определить, включен ли параметр transparentDataEncryption. Если это не так, выполняется развертывание для включения.

```json
"if": {
    "field": "type",
    "equals": "Microsoft.Sql/servers/databases"
},
"then": {
    "effect": "DeployIfNotExists",
    "details": {
        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
        "name": "current",
        "roleDefinitionIds": [
            "/subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
            "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
        ],
        "existenceCondition": {
            "field": "Microsoft.Sql/transparentDataEncryption.status",
            "equals": "Enabled"
        },
        "deployment": {
            "properties": {
                "mode": "incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "fullDbName": {
                            "type": "string"
                        }
                    },
                    "resources": [{
                        "name": "[concat(parameters('fullDbName'), '/current')]",
                        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                        "apiVersion": "2014-04-01",
                        "properties": {
                            "status": "Enabled"
                        }
                    }]
                },
                "parameters": {
                    "fullDbName": {
                        "value": "[field('fullName')]"
                    }
                }
            }
        }
    }
}
```

## <a name="disabled"></a>Выключено

Это действие применяется при тестировании или для определения, имеет ли политика параметризованное действие. Такая гибкость позволяет отключить одно назначение этой политики вместо всех назначений.

Альтернативой действию Disabled является **enforcementMode, который задается в назначении политики.
Когда **enforcementMode** является _Disabled_, ресурсы все равно оцениваются. Ведение журнала, например журналов действий, и последствий применения политик не выполняются. Дополнительные сведения см. в [назначение политик — режим применения](./assignment-structure.md#enforcement-mode).


## <a name="enforceopaconstraint"></a>EnforceOPAConstraint

Это действие используется с определением политики _mode_ из `Microsoft.Kubernetes.Data`. Оно используется для передачи правил управления допуском Gatekeeper v3, определенных с помощью [OPA Constraint Framework](https://github.com/open-policy-agent/frameworks/tree/master/constraint#opa-constraint-framework), [Open Policy Agent](https://www.openpolicyagent.org/) (OPA) в кластерах Kubernetes в Azure.

> [!NOTE]
> [Политика Azure для Kubernetes](./policy-for-kubernetes.md) доступна в предварительной версии и поддерживает только пулы узлов Linux и встроенные определения политик.

### <a name="enforceopaconstraint-evaluation"></a>Оценка EnforceOPAConstraint

Контроллер допуска Open Policy Agent оценивает все новые запросы в кластере в режиме реального времени.
Каждые 15 минут завершается полное сканирование кластера и результаты отправляются политике Azure.

### <a name="enforceopaconstraint-properties"></a>Свойства EnforceOPAConstraint

Свойство **details** для действия EnforceOPAConstraint имеет вложенные свойства, описывающие правило управления допуском Gatekeeper v3.

- **constraintTemplate** [обязательное]
  - Шаблон ограничения CustomResourceDefinition (CRD), который определяет новые ограничения. Этот шаблон определяет логику Rego, схему ограничения и параметры ограничения, которые передаются через **значения** из политики Azure.
- **constraint** [обязательное]
  - Реализация CRD шаблона ограничения. Использует параметры, передаваемые через **значения** как `{{ .Values.<valuename> }}`. В приведенном ниже примере это значения `{{ .Values.cpuLimit }}` и `{{ .Values.memoryLimit }}`.
- **values** [необязательное]
  - Определяет все параметры и значения, передаваемые ограничению. Каждое значение должно существовать в шаблоне ограничения CRD.

### <a name="enforceopaconstraint-example"></a>Пример EnforceOPAConstraint

Пример Правило управления допуском Gatekeeper v3 для задания ограничений контейнера ЦП и ресурсов памяти в Kubernetes.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "in": [
                "Microsoft.ContainerService/managedClusters",
                "AKS Engine"
            ]
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "enforceOPAConstraint",
    "details": {
        "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/template.yaml",
        "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/constraint.yaml",
        "values": {
            "cpuLimit": "[parameters('cpuLimit')]",
            "memoryLimit": "[parameters('memoryLimit')]"
        }
    }
}
```

## <a name="enforceregopolicy"></a>EnforceRegoPolicy

Это действие используется с определением политики _mode_ из `Microsoft.ContainerService.Data`. Оно используется для передачи правил управления допуском Gatekeeper v2, определенных с помощью [Rego](https://www.openpolicyagent.org/docs/latest/policy-language/#what-is-rego), [Open Policy Agent](https://www.openpolicyagent.org/) (OPA) в [службе AzureKubernetes](../../../aks/intro-kubernetes.md).

> [!NOTE]
> [Политика Azure для Kubernetes](./policy-for-kubernetes.md) доступна в предварительной версии и поддерживает только пулы узлов Linux и встроенные определения политик. Определения встроенных политик находятся в категории **Kubernetes**. Определения политик ограниченного просмотра с помощью действия **EnforceRegoPolicy**, а также связанная категория **Kubernetes Service** _являются устаревшими_. Вместо этого используйте обновленное действие [EnforceOPAConstraint](#enforceopaconstraint).

### <a name="enforceregopolicy-evaluation"></a>Оценка EnforceRegoPolicy

Контроллер допуска Open Policy Agent оценивает все новые запросы в кластере в режиме реального времени.
Каждые 15 минут завершается полное сканирование кластера и результаты отправляются политике Azure.

### <a name="enforceregopolicy-properties"></a>Свойства EnforceRegoPolicy

Свойство **details** для действия EnforceRegoPolicy имеет вложенные свойства, описывающие правило управления допуском Gatekeeper v2.

- **policyId** [обязательное]
  - Уникальное имя, передаваемое в качестве параметра в правило управления допуском Rego.
- **policy** [обязательное]
  - Указывает универсальный код ресурса (URI) правила управления допуском Rego.
- **policyParameters** [необязательное]
  - Определяет все параметры и значения, передаваемые политике Rego.

### <a name="enforceregopolicy-example"></a>Пример EnforceRegoPolicy

Пример Правило управления допуском Gatekeeper v2, разрешающее только указанные образы контейнеров в AKS.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "equals": "Microsoft.ContainerService/managedClusters"
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "EnforceRegoPolicy",
    "details": {
        "policyId": "ContainerAllowedImages",
        "policy": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/KubernetesService/container-allowed-images/limited-preview/gatekeeperpolicy.rego",
        "policyParameters": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]"
        }
    }
}
```

## <a name="modify"></a>Изменить

Modify используется для добавления, обновления или удаления тегов ресурса во время создания или обновления. Распространенный пример — обновление тегов для таких ресурсов, как costCenter. У политики Modify `mode` всегда должен быть установлен на _Индексированные_, если целевой ресурс не является группой ресурсов. Существующие несоответствующие ресурсы можно исправить, активировав [задачу исправления](../how-to/remediate-resources.md). Одно правило Modify может иметь любое количество операций.

> [!IMPORTANT]
> Это правило в настоящее время предназначено только для использования с тегами. Если вы управляете тегами, рекомендуется использовать Modify вместо Append, так как Modify предоставляет дополнительные типы операций и возможность исправлять существующие ресурсы. Однако рекомендуется использовать Append, когда вы не можете создать управляемое удостоверение.

### <a name="modify-evaluation"></a>Оценка Modify

Modify выполняет оценку до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Modify добавляет или обновляет теги ресурсу, если выполняется условие **if** правила политики.

При запуске определения политики с использованием действия Modify в рамках цикла оценки оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="modify-properties"></a>Свойства Modify

Свойство **details** действия Modify имеет все вложенные свойства, определяющие разрешения, необходимые для исправления, а также **operations**, используемые для добавления, обновления или удаления значений тегов.

- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
  - Определенная роль должна включать все операции, предоставленные участнику роли [Contributor](../../../role-based-access-control/built-in-roles.md#contributor).
- **operations** [обязательное]
  - Массив всех операций тегов, которые должны быть выполнены при сопоставлении ресурсов.
  - Свойства:
    - **operation** [обязательное]
      - Определяет, какое действие следует предпринять с совпавшим ресурсом. Возможные варианты: _addOrReplace_, _Add_, _Remove_. _Add_ ведет себя так же, как и [Append](#append).
    - **field** [обязательное]
      - Добавляемый, заменяемый или удаляемый тег Имена тегов должны соответствовать тому же соглашению об именовании, что и другие [поля](./definition-structure.md#fields).
    - **value** [необязательное]
      - Задаваемое значение тега.
      - Это свойство является обязательным, если **operation** (операцией) является _addOrReplace_ или _Add_.

### <a name="modify-operations"></a>Операции Modify

Массив свойств **operation** позволяет изменять несколько тегов различными способами из одного определения политики. Каждая операция состоит из свойств **operation** (операция), **field** (поле) и **value** (значение). Операция определяет, что делает задача исправления в тегах, поле определяет, какой тег изменяется, а значение определяет новый параметр для этого тега. Приведенный ниже пример вносит следующие изменения в теги.

- Задает для тега `environment` значение Test, даже если он уже существует с другим значением.
- Удаляет тег `TempResource`.
- Задает тег `Dept` для параметра политики _DeptName_, настроенного для назначения политики.

```json
"details": {
    ...
    "operations": [
        {
            "operation": "addOrReplace",
            "field": "tags['environment']",
            "value": "Test"
        },
        {
            "operation": "Remove",
            "field": "tags['TempResource']",
        },
        {
            "operation": "addOrReplace",
            "field": "tags['Dept']",
            "value": "[parameters('DeptName')]"
        }
    ]
}
```

Свойство **operation** имеет следующие параметры.

|Операция |Описание |
|-|-|
|addOrReplace |Добавляет определенный тег и значение к ресурсу, даже если этот тег уже существует с другим значением. |
|Добавить |Добавляет определенный тег и значение к ресурсу. |
|Удалить |Удаляет определенный тег из ресурса. |

### <a name="modify-examples"></a>Примеры Modify

Пример 1: Добавьте тег `environment` и замените существующие теги `environment` на Test.

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "Test"
            }
        ]
    }
}
```

Пример 2. Удалите тег `env` и добавьте тег `environment` или замените существующие теги `environment` параметризованным значением.

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "Remove",
                "field": "tags['env']"
            },
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "[parameters('tagValue')]"
            }
        ]
    }
}
```



## <a name="layering-policy-definitions"></a>Наложение определений политик

На ресурс могут влиять несколько назначений. Эти назначения могут быть в одной или в разных областях. Для этих назначений наверняка будут назначены разные действия. Условие и действие для каждой политики вычисляется независимо друг от друга. Пример:

- Политика 1
  - Ограничивает расположение ресурсов для региона "westus"
  - Назначенная подписка А
  - Результат запрета
- Политика 2
  - Ограничивает расположение ресурсов для региона "eastus"
  - Назначенные группе ресурсов B в подписке A
  - Действие аудита
  
Эта настройка приведет к следующему результату.

- Любой ресурс, уже входящий в группу ресурсов В и находящийся в регионе "eastus", соответствует политике 2, но не соответствует политике 1.
- Любой ресурс, уже входящий в группу ресурсов В и не находящийся в регионе "eastus", не соответствует политике 2 и политике 1, если не находится в регионе "westus".
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс, который создается в подписке A и группе ресурсов В, расположенный в регионе "westus" и не соответствует политике 2.

Если задать для политик 1 и 2 действие запрета, ситуация изменится следующим образом.

- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "eastus", не соответствует политике 2.
- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "westus", не соответствует политике 1.
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс в группе ресурсов B в подписке A запрещается.

Каждое назначение оценивается по отдельности. Таким образом, у ресурса нет возможности ускользнуть из-за различий в объеме. Общий результат наложения определений политик считается **накопительным по принципу максимальной строгости**. Например, если бы политики 1 и 2 имели эффект запрета, ресурс был бы заблокирован перекрывающимися и конфликтующими определениями политик. Если вам все равно нужно создать ресурс в целевой области, пересмотрите исключения в каждом назначении, чтобы гарантировать, что определения политик влияют на правильные области.

## <a name="next-steps"></a>Дальнейшие действия

- См. другие [примеры шаблонов для службы Политика Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Узнайте о [программном создании политик](../how-to/programmatically-create.md).
- Узнайте, как [получать сведения о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
