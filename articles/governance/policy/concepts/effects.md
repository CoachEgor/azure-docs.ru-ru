---
title: Принцип работы эффектов
description: Определения политик Azure содержат различные действия, влияющие на управление соответствием требованиям и отчеты о нем.
author: DCtheGeek
ms.author: dacoulte
ms.date: 03/29/2019
ms.topic: conceptual
ms.service: azure-policy
manager: carmonm
ms.custom: seodec18
ms.openlocfilehash: c2bf19a2599d59b9ff2b3d189b26134f1528a878
ms.sourcegitcommit: f56b267b11f23ac8f6284bb662b38c7a8336e99b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/28/2019
ms.locfileid: "67448570"
---
# <a name="understand-azure-policy-effects"></a>Сведения о действии политик Azure

Каждое определение политики в Azure имеет один эффект. Этот эффект определяет, что происходит при вычислении правила политики при сопоставлении. Действия по-разному влияют на новые, обновленные и имеющиеся ресурсы.

Эти эффекты в настоящее время поддерживаются в определении политики:

- [добавить](#append)
- [Аудит](#audit)
- [AuditIfNotExists](#auditifnotexists)
- [DENY, запрет](#deny)
- [DeployIfNotExists](#deployifnotexists)
- [Disabled](#disabled)
- [EnforceRegoPolicy](#enforceregopolicy) (Предварительная версия)

## <a name="order-of-evaluation"></a>Порядок оценки

Запросов на создание или обновление ресурса через Azure Resource Manager сначала оцениваются "Политика Azure". "Политика Azure" создает список всех назначений, применяемых к ресурсу и затем оценивает ресурса относительно каждого определения. Политика Azure обрабатывает несколько эффектов перед передачей запрос соответствующего поставщика ресурсов. Это позволяет предотвратить обработку поставщиком ресурсов, если ресурс не соответствует требованию спроектированное управление элементами управления "Политика Azure".

- Действие **Disabled** проверяется первым. Таким образом определяется, нужно ли оценить правило политики.
- Затем оценивается действие **Append**. При добавлении запрос может измениться, а внесенное изменение может отменить вызов действия аудита или запрета.
- Затем оценивается действие **Deny** (запрет). Запрет оценивается перед аудитом, чтобы нежелательный ресурс не заносился в журнал дважды.
- Затем оценивается действие **Audit** (аудит), после чего запрос отправляется поставщику ресурсов.

После того, как поставщик ресурсов вернет код успешного выполнения, **AuditIfNotExists** и **DeployIfNotExists** вычисляются для определения того, чтобы определить, требуется ли дополнительное ведение журнала соответствия или действие.

В настоящее время не все порядок вычисления для **EnforceRegoPolicy** эффект.

## <a name="disabled"></a>Отключено

Это действие применяется при тестировании или для определения, имеет ли политика параметризованное действие. Такая гибкость позволяет отключить одно назначение этой политики вместо всех назначений.

## <a name="append"></a>Добавить

Это действие используется для добавления полей к запрашиваемому ресурсу во время создания или обновления. Общим примером является добавления тегов к таким ресурсам, как costCenter, или указания разрешенных IP-адресов для ресурса хранилища.

### <a name="append-evaluation"></a>Оценка добавления

Добавление оценивается до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Это действие добавляет поля к ресурсу, если выполняется условие **if** правила политики. Если добавление приведет к замене значения в исходном запросе на другое значение, то оно работает как действие запрета и отклоняет запрос. Чтобы добавить новое значение к имеющемуся массиву, используйте версию псевдонима **[\*]** .

При запуске определения политики с использованием действия добавления в рамках цикла оценивания оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="append-properties"></a>Свойства добавления

Действие добавления содержит только обязательный массив **details**. Так как свойство **details** представляет собой массив, оно может принимать как одну, так и несколько пар **поле/значение**. Список допустимых полей представлен в статье, посвященной [структуре определения](definition-structure.md#fields).

### <a name="append-examples"></a>Примеры добавления

Пример 1 Одна пара **поле/значение** для добавления тега.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "tags.myTag",
        "value": "myTagValue"
    }]
}
```

Пример 2 Две пары **поле/значение** для добавления набора тегов.

```json
"then": {
    "effect": "append",
    "details": [{
            "field": "tags.myTag",
            "value": "myTagValue"
        },
        {
            "field": "tags.myOtherTag",
            "value": "myOtherTagValue"
        }
    ]
}
```

Пример 3 Единый **поля и значения** связываться с помощью отличного **[\*]** [псевдоним](definition-structure.md#aliases) с массивом **значение** устанавливать правила IP-адрес учетной записи хранения. Когда псевдоним без **[\*]** в массиве, эффект добавляет **value** ко всему массиву. Если массив уже существует, из конфликта возникает событие отказа.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules",
        "value": [{
            "action": "Allow",
            "value": "134.5.0.0/21"
        }]
    }]
}
```

Пример 4. Одна пара **поле/значение** с использованием [псевдонима](definition-structure.md#aliases) **[\*]** с массивом **value** для установки правил IP-адресов для учетной записи хранения. С использованием псевдонима **[\*]** эффект добавляет **value** к потенциально имеющемуся массиву. Если массив еще не существует, он будет создан.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*]",
        "value": {
            "value": "40.40.40.40",
            "action": "Allow"
        }
    }]
}
```

## <a name="deny"></a>Deny

Запрет используется, чтобы не пропускать запросы ресурсов, не соответствующие определенным стандартам, через определение политики. При этом запрос завершается с ошибкой.

### <a name="deny-evaluation"></a>Оценка запрета

При создании или обновлении соответствующего ресурса запрет останавливает запрос до его отправки поставщику ресурсов. Запрос возвращает `403 (Forbidden)`. На портале для развертывания, запрещенного в связи с назначением политики, отображается состояние "Запрещено".

Во время оценки существующие ресурсы, которые соответствуют определению политики запрета, помечаются как несовместимые.

### <a name="deny-properties"></a>Свойства запрета

Действие запрета не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="deny-example"></a>Пример запрета

Пример: Использование действия запрета.

```json
"then": {
    "effect": "deny"
}
```

## <a name="audit"></a>Аудит

Аудит используется, чтобы создать предупреждение в журнале действий при оценке несоответствующего ресурса, но такое действие не останавливает запрос.

### <a name="audit-evaluation"></a>Оценка аудита

Аудит — это последний эффект, проверяется политика Azure во время создания или обновления ресурса. "Политика Azure" отправляет ресурс поставщика ресурсов. Аудит работает одинаково для запроса ресурса и для цикла оценки. Политика Azure добавляет `Microsoft.Authorization/policies/audit/action` операции в журнал действий и помечает ресурс как несовместимые.

### <a name="audit-properties"></a>Свойства аудита

Действие аудита не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="audit-example"></a>Пример аудита

Пример: Использование действия аудита.

```json
"then": {
    "effect": "audit"
}
```

## <a name="auditifnotexists"></a>AuditIfNotExists

Действие AuditIfNotExists позволяет выполнять аудит ресурсов, соответствующих условию **if**, но не содержат компонентов, указываемых в свойстве **details** условия **then**.

### <a name="auditifnotexists-evaluation"></a>Оценка AuditIfNotExists

Действие AuditIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Этот аудит происходит только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. Политика Azure добавляет `Microsoft.Authorization/policies/audit/action` операции к действию входа так же, как с эффектом аудита. При вызове этого действия ресурс, соответствующий условию **if**, отмечается как несоответствующий.

### <a name="auditifnotexists-properties"></a>Свойства AuditIfNotExists

Свойство **details** действия AuditIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Если **details.type** — это тип ресурсов под **Если** условие ресурса, политика запросов для ресурсов этого **тип** в пределах вычисленное ресурсов. В противном случае — политики запросов в той же группе ресурсов, что вычисленное ресурсов.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Когда условие значения для **if.field.type** и **then.details.type** совпадают, выполняется **имя** становится _требуется_ и должен быть `[field('name')]`. Тем не менее [аудита](#audit) вместо этого следует учитывать влияние.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а аудит не выполняется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не вызывает аудит.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.

### <a name="auditifnotexists-example"></a>Пример AuditIfNotExists

Пример: Оценка виртуальных машин для поиска антивредоносного расширения с последующим аудитом при его отсутствии.

```json
{
    "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
    },
    "then": {
        "effect": "auditIfNotExists",
        "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "existenceCondition": {
                "allOf": [{
                        "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                        "equals": "Microsoft.Azure.Security"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/extensions/type",
                        "equals": "IaaSAntimalware"
                    }
                ]
            }
        }
    }
}
```

## <a name="deployifnotexists"></a>DeployIfNotExists

Как и AuditIfNotExists, действие DeployIfNotExists выполняет шаблон развертывания при соблюдении условия.

> [!NOTE]
> [Вложенные шаблоны](../../../azure-resource-manager/resource-group-linked-templates.md#nested-template) поддерживаются с **deployIfNotExists**, но [связанные шаблоны](../../../azure-resource-manager/resource-group-linked-templates.md) сейчас не поддерживаются.

### <a name="deployifnotexists-evaluation"></a>Оценка DeployIfNotExists

Действие DeployIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Шаблон развертывания появляется только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true.

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием DeployIfNotExists, отмечаются как несоответствующие, но с ними не выполняется никаких действий.

### <a name="deployifnotexists-properties"></a>Свойства DeployIfNotExists

Свойство **details** действия DeployIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления и шаблон развертывания.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Когда условие значения для **if.field.type** и **then.details.type** совпадают, выполняется **имя** становится _требуется_ и должен быть `[field('name')]`.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
  - Шаблон развертывания выполняется в группе ресурсов, соответствующей этому значению.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а развертывание не активируется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не активирует развертывание.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.
- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
- **DeploymentScope** (необязательно)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает тип инициируемого развертывания. _Subscription_ указывает на [развертывание на уровне подписки](../../../azure-resource-manager/deploy-to-subscription.md), а _ResourceGroup_ — на развертывание в группе ресурсов.
  - Свойство _location_ должно быть указано для объекта _Deployment_ при использовании развертываний на уровне подписки.
  - По умолчанию задано значение _ResourceGroup_.
- **Deployment** [обязательный]
  - Это свойство должно содержать полный шаблон развертывания, так как оно будет передано в API PUT `Microsoft.Resources/deployments`. Дополнительные сведения см. в [документации по REST API развертываний](/rest/api/resources/deployments).

  > [!NOTE]
  > Все функции в свойстве **Deployment** оцениваются как компоненты шаблона, а не политики. Исключение составляет свойство **parameters**, передающее значения из политики в шаблон. Свойство **value** из этого раздела под именем параметра шаблона используется для передачи значения (см. _fullDbName_ в примере DeployIfNotExists).

### <a name="deployifnotexists-example"></a>Пример DeployIfNotExists

Пример: Оценка баз данных SQL Server, позволяющая определить, включен ли параметр transparentDataEncryption. Если это не так, выполняется развертывание для включения.

```json
"if": {
    "field": "type",
    "equals": "Microsoft.Sql/servers/databases"
},
"then": {
    "effect": "DeployIfNotExists",
    "details": {
        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
        "name": "current",
        "roleDefinitionIds": [
            "/subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
            "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
        ],
        "existenceCondition": {
            "field": "Microsoft.Sql/transparentDataEncryption.status",
            "equals": "Enabled"
        },
        "deployment": {
            "properties": {
                "mode": "incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "fullDbName": {
                            "type": "string"
                        }
                    },
                    "resources": [{
                        "name": "[concat(parameters('fullDbName'), '/current')]",
                        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                        "apiVersion": "2014-04-01",
                        "properties": {
                            "status": "Enabled"
                        }
                    }]
                },
                "parameters": {
                    "fullDbName": {
                        "value": "[field('fullName')]"
                    }
                }
            }
        }
    }
}
```

## <a name="enforceregopolicy"></a>EnforceRegoPolicy

С помощью определения политики используется этот эффект *режим* из `Microsoft.ContainerService.Data`. Он используется для передачи правил управления допуском, определенные с помощью [Rego](https://www.openpolicyagent.org/docs/how-do-i-write-policies.html#what-is-rego) для [откройте агент политики](https://www.openpolicyagent.org/) (OPA) на [службе Azure Kubernetes](../../../aks/intro-kubernetes.md).

> [!NOTE]
> [Политика Azure для Kubernetes](rego-for-aks.md) в общедоступной предварительной версии и поддерживает только определения встроенных политик.

### <a name="enforceregopolicy-evaluation"></a>EnforceRegoPolicy оценки

Контроллер допуском откройте агент политики оценивает любой новый запрос в кластере в режиме реального времени.
Каждые 5 минут, полная проверка кластера завершается, и результаты будут передаваться с политикой Azure.

### <a name="enforceregopolicy-properties"></a>Свойства EnforceRegoPolicy

**Сведения** свойство эффекта EnforceRegoPolicy имеет вложенные свойства, которые описывают правила управления допуском Rego.

- **policyId** [обязательный параметр]
  - Уникальное имя, переданный в качестве параметра для правила управления допуском Rego.
- **политика** [обязательный параметр]
  - Указывает URI Rego правила управления допуском.
- **policyParameters** [необязательно]
  - Определяет, все параметры и значения для передачи в rego политику.

### <a name="enforceregopolicy-example"></a>Пример EnforceRegoPolicy

Пример: Rego правило управления допуском, чтобы разрешить только образы из указанного контейнера в AKS.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "equals": "Microsoft.ContainerService/managedClusters"
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "EnforceRegoPolicy",
    "details": {
        "policyId": "ContainerAllowedImages",
        "policy": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/KubernetesService/container-allowed-images/limited-preview/gatekeeperpolicy.rego",
        "policyParameters": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]"
        }
    }
}
```

## <a name="layering-policies"></a>Наложение политик

На ресурс могут влиять несколько назначений. Эти назначения могут быть в одной или в разных областях. Для этих назначений наверняка будут назначены разные действия. Условие и действие для каждой политики вычисляется независимо друг от друга. Пример:

- Политика 1
  - Ограничивает расположение ресурсов для региона "westus"
  - Назначенная подписка А
  - Результат запрета
- Политика 2
  - Ограничивает расположение ресурсов для региона "eastus"
  - Назначенные группе ресурсов B в подписке A
  - Действие аудита
  
Эта настройка приведет к следующему результату.

- Любой ресурс, уже входящий в группу ресурсов В и находящийся в регионе "eastus", соответствует политике 2, но не соответствует политике 1.
- Любой ресурс, уже входящий в группу ресурсов В и не находящийся в регионе "eastus", не соответствует политике 2 и политике 1, если не находится в регионе "westus".
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс, который создается в подписке A и группе ресурсов В, расположенный в регионе "westus" и не соответствует политике 2.

Если задать для политик 1 и 2 действие запрета, ситуация изменится следующим образом.

- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "eastus", не соответствует политике 2.
- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "westus", не соответствует политике 1.
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс в группе ресурсов B в подписке A запрещается.

Каждое назначение оценивается по отдельности. Таким образом, у ресурса нет возможности ускользнуть из-за различий в объеме. Общий результат наложения или перекрывания политик считается **накопительным по принципу максимальной строгости**. Например, если бы политики 1 и 2 имели эффект запрета, ресурс был бы заблокирован перекрывающимися и конфликтующими политиками. Если вам все равно нужно создать ресурс в целевой области, пересмотрите исключения в каждом назначении, чтобы гарантировать, что политики влияют на правильные области.

## <a name="next-steps"></a>Дальнейшие действия

- Просмотрите примеры доступны на [примеры политик Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Понять, как [программное создание политик](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/getting-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).