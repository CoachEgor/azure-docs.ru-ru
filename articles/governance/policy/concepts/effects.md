---
title: Принцип работы эффектов
description: Определения политики Azure имеют различные эффекты, определяющие, как управляется соответствие и отчет.
ms.date: 03/23/2020
ms.topic: conceptual
ms.openlocfilehash: 0330cb5c732921efda3627dec92e486657097d82
ms.sourcegitcommit: 7581df526837b1484de136cf6ae1560c21bf7e73
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2020
ms.locfileid: "80422456"
---
# <a name="understand-azure-policy-effects"></a>Сведения о действии политик Azure

Каждое определение политики в Azure имеет один эффект. Этот эффект определяет, что происходит при вычислении правила политики при сопоставлении. Действия по-разному влияют на новые, обновленные и имеющиеся ресурсы.

Эти последствия в настоящее время поддерживаются в определении политики:

- [Append](#append)
- [Аудит](#audit)
- [АудитНесуществует](#auditifnotexists)
- [Запрет](#deny)
- [РазвертываниеНесуществует](#deployifnotexists)
- [Отключен](#disabled)
- [EnforceOPAConstraint](#enforceopaconstraint) (предварительный просмотр)
- [EnforceRegoPolicy](#enforceregopolicy) (предварительный просмотр)
- [Изменение](#modify)

## <a name="order-of-evaluation"></a>Порядок вычислений

Запросы на создание или обновление ресурса с помощью Azure Resource Manager сначала оцениваются политикой Azure. Политика Azure создает список всех назначений, которые применяются к ресурсу, а затем оценивает ресурс по каждому определению. Политика Azure обрабатывает несколько эффектов, прежде чем передать запрос соответствующему поставщику ресурсов. Это предотвращает ненужную обработку поставщиком ресурсов, когда ресурс не соответствует разработанному управлению политики Azure.

- Действие **Disabled** проверяется первым. Таким образом определяется, нужно ли оценить правило политики.
- **Затем** оцениваются приложение и **модификация.** Поскольку либо это может изменить запрос, внесенное изменение может предотвратить запуск аудита или отказать в запуске эффекта.
- Затем оценивается действие **Deny** (запрет). Запрет оценивается перед аудитом, чтобы нежелательный ресурс не заносился в журнал дважды.
- Затем оценивается действие **Audit** (аудит), после чего запрос отправляется поставщику ресурсов.

После того, как поставщик ресурсов вернет код успешного выполнения, **AuditIfNotExists** и **DeployIfNotExists** вычисляются для определения того, чтобы определить, требуется ли дополнительное ведение журнала соответствия или действие.

В настоящее время нет никакого порядка оценки для **enforceOPAConstraint** или **EnforceRegoPolicy** эффектов.

## <a name="disabled"></a>Выключено

Это действие применяется при тестировании или для определения, имеет ли политика параметризованное действие. Такая гибкость позволяет отключить одно назначение этой политики вместо всех назначений.

Альтернативой эффекту для инвалидов является **enforcementMode,** который устанавливается в назначении политики.
Когда **enforcementMode** _отключен,_ ресурсы по-прежнему оцениваются. Регистрация, например журналы активности, и эффект политики не происходят. Для получения дополнительной информации [см.](./assignment-structure.md#enforcement-mode)

## <a name="append"></a>Append

Это действие используется для добавления полей к запрашиваемому ресурсу во время создания или обновления. Распространенным примером является указание разрешенных ИП для ресурса хранения.

> [!IMPORTANT]
> Приложение предназначено для использования с свойствами, не относясь к тегам. В то время как Приложение может добавлять теги к ресурсу во время запроса на создание или обновление, рекомендуется использовать эффект [«Изменение»](#modify) для тегов.

### <a name="append-evaluation"></a>Оценка добавления

Добавление оценивается до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Это действие добавляет поля к ресурсу, если выполняется условие **if** правила политики. Если добавление приведет к замене значения в исходном запросе на другое значение, то оно работает как действие запрета и отклоняет запрос. Чтобы привнести новое значение к существующему массиву, используйте **версию\*** псевдонима.

При запуске определения политики с использованием действия добавления в рамках цикла оценивания оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="append-properties"></a>Свойства добавления

Действие добавления содержит только обязательный массив **details**. Так как свойство **details** представляет собой массив, оно может принимать как одну, так и несколько пар **поле/значение**. Список допустимых полей представлен в статье, посвященной [структуре определения](definition-structure.md#fields).

### <a name="append-examples"></a>Примеры добавления

Пример 1: Одно**\*** **поле/пара значений,** использующее [псевдоним](definition-structure.md#aliases) без значения **массива** для установки правил IP на учетной записи хранилища. Когда псевдоним non-**no\*** является массивом, эффект придатит **значение** как весь массив. Если массив уже существует, из конфликта возникает событие отказа.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules",
        "value": [{
            "action": "Allow",
            "value": "134.5.0.0/21"
        }]
    }]
}
```

Пример 2: **Однополе/пара значений,** использующее [псевдоним](definition-structure.md#aliases) **\*«зенит»** со **значением** массива для установки правил IP на учетной записи хранилища. Используя псевдоним **\*«Кля»,** эффект придатит **значение** к потенциально уже существующему массиву. Если массив еще не существует, он будет создан.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*]",
        "value": {
            "value": "40.40.40.40",
            "action": "Allow"
        }
    }]
}
```

## <a name="modify"></a>Изменить

Изменение используется для добавления, обновления или удаления тегов на ресурсе во время создания или обновления. Распространенным примером является обновление тегов на ресурсах, таких как costCenter. Политика изменения всегда `mode` должна быть установлена для _индексирования,_ если целевой ресурс не является группой ресурсов. Существующие несовместимые ресурсы могут быть исправлены с [помощью задачи по исправлению положения.](../how-to/remediate-resources.md) Одно правило модифицировать может иметь любое количество операций.

> [!IMPORTANT]
> Изменение в настоящее время только для использования с тегами. Если вы управляете тегами, рекомендуется использовать Modify вместо приложения, так как Modify предоставляет дополнительные типы операций и возможность исправления существующих ресурсов. Тем не менее, приложение рекомендуется, если вы не в состоянии создать управляемый итог.

### <a name="modify-evaluation"></a>Изменение оценки

Изменение оценок до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Изменение добавлений или обновлений **if** тегов на ресурсе при соблюдении состояния правила политики.

Когда определение политики с использованием эффекта «Изменение» работает как часть цикла оценки, оно не внося изменений в уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="modify-properties"></a>Изменение свойств

Свойство **деталей** эффекта модифицировать имеет все субсвойства, определяющие разрешения, необходимые для исправления, и **операции,** используемые для добавления, обновления или удаления значений тегов.

- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
  - Определенная роль должна включать все операции, предоставленные роли [вкладчика.](../../../role-based-access-control/built-in-roles.md#contributor)
- **операции** (обязательно)
  - Массив всех операций тегов, которые должны быть завершены на соответствующих ресурсах.
  - Свойства:
    - **операция** (требуется)
      - Определяет, какие действия необходимо предпринять в отношении соответствующего ресурса. Варианты: _добавитьИли,_ _добавить,_ _удалить_. _Добавить_ ведет себя аналогично эффекту [приложения.](#append)
    - **поле** (обязательно)
      - Тег для добавления, замены или удаления. Имена тегов должны придерживаться той же конвенции именования для других [полей.](./definition-structure.md#fields)
    - **значение** (необязательно)
      - Значение для установки тега.
      - Это свойство необходимо, если **операция** _добавленаИли_ или _добавлены._

### <a name="modify-operations"></a>Изменение операций

Массив свойств **операций** позволяет изменять несколько тегов по-разному из единого определения политики. Каждая операция состоит из **эксплуатационных,** **полевых**и **ценных** свойств. Операция определяет, что задача восстановления делает с тегами, поле определяет, какой тег изменен, а значение определяет новую настройку для этого тега. Приведенный ниже пример изменяет следующие теги:

- Устанавливает `environment` тег на "Тест", даже если он уже существует с другим значением.
- Удаляет тег `TempResource`.
- Устанавливает `Dept` тег под параметр политики _DeptName,_ настроенный на назначение политики.

```json
"details": {
    ...
    "operations": [
        {
            "operation": "addOrReplace",
            "field": "tags['environment']",
            "value": "Test"
        },
        {
            "operation": "Remove",
            "field": "tags['TempResource']",
        },
        {
            "operation": "addOrReplace",
            "field": "tags['Dept']",
            "value": "[parameters('DeptName')]"
        }
    ]
}
```

Свойство **операции** имеет следующие варианты:

|Операция |Описание |
|-|-|
|addOrReplace |Добавляет определенный тег и значение к ресурсу, даже если тег уже существует с другим значением. |
|Добавить |Добавляет определенный тег и значение к ресурсу. |
|Удалить |Удаляет определенный тег с ресурса. |

### <a name="modify-examples"></a>Изменение примеров

Пример 1: `environment` Добавить тег `environment` и заменить существующие теги на "Тест":

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "Test"
            }
        ]
    }
}
```

Пример 2: `env` Удалите `environment` тег и `environment` добавьте тег или замените существующие теги параметризированным значением:

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "Remove",
                "field": "tags['env']"
            },
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "[parameters('tagValue')]"
            }
        ]
    }
}
```

## <a name="deny"></a>Запрет

Запрет используется, чтобы не пропускать запросы ресурсов, не соответствующие определенным стандартам, через определение политики. При этом запрос завершается с ошибкой.

### <a name="deny-evaluation"></a>Оценка запрета

При создании или обновлении соответствующего ресурса запрет останавливает запрос до его отправки поставщику ресурсов. Запрос возвращает `403 (Forbidden)`. На портале для развертывания, запрещенного в связи с назначением политики, отображается состояние "Запрещено".

Во время оценки существующие ресурсы, которые соответствуют определению политики запрета, помечаются как несовместимые.

### <a name="deny-properties"></a>Свойства запрета

Действие запрета не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="deny-example"></a>Пример запрета

Пример: использование действия запрета.

```json
"then": {
    "effect": "deny"
}
```

## <a name="audit"></a>Аудит

Аудит используется, чтобы создать предупреждение в журнале действий при оценке несоответствующего ресурса, но такое действие не останавливает запрос.

### <a name="audit-evaluation"></a>Оценка аудита

Аудит — последний эффект, проверенный политикой Azure при создании или обновлении ресурса. Затем политика Azure отправляет ресурс поставщику ресурсов. Аудит работает одинаково для запроса ресурса и для цикла оценки. Политика Azure `Microsoft.Authorization/policies/audit/action` добавляет операцию в журнал активности и отмечает ресурс как не соответствующий требованиям.

### <a name="audit-properties"></a>Свойства аудита

Действие аудита не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="audit-example"></a>Пример аудита

Пример: использование действия аудита.

```json
"then": {
    "effect": "audit"
}
```

## <a name="auditifnotexists"></a>AuditIfNotExists

Действие AuditIfNotExists позволяет выполнять аудит ресурсов, соответствующих условию **if**, но не содержат компонентов, указываемых в свойстве **details** условия **then**.

### <a name="auditifnotexists-evaluation"></a>Оценка AuditIfNotExists

Действие AuditIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Этот аудит происходит только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. Политика Azure `Microsoft.Authorization/policies/audit/action` добавляет операцию в журнал активности так же, как и эффект аудита. При вызове этого действия ресурс, соответствующий условию **if**, отмечается как несоответствующий.

### <a name="auditifnotexists-properties"></a>Свойства AuditIfNotExists

Свойство **details** действия AuditIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Если **detail.type** является типом ресурса под ресурсом **конечного** состояния, запросы политики для ресурсов этого **типа** в пределах оцениваемого ресурса. В противном случае запросы политики в той же группе ресурсов, что и оцениваемый ресурс.
- **Имя** (необязательно)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Когда условие значения для **if.field.type,** а **затем.details.type** совпадают, `[field('name')]`то **имя** становится _обязательным_ и должно быть . Однако вместо этого следует рассмотреть эффект [аудита.](#audit)
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а аудит не выполняется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не вызывает аудит.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.

### <a name="auditifnotexists-example"></a>Пример AuditIfNotExists

Пример: оценка виртуальных машин для поиска антивредоносного расширения с последующим аудитом при его отсутствии.

```json
{
    "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
    },
    "then": {
        "effect": "auditIfNotExists",
        "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "existenceCondition": {
                "allOf": [{
                        "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                        "equals": "Microsoft.Azure.Security"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/extensions/type",
                        "equals": "IaaSAntimalware"
                    }
                ]
            }
        }
    }
}
```

## <a name="deployifnotexists"></a>DeployIfNotExists

Подобно auditIfNotExists, определение политики DeployIfNotExists выполняет развертывание шаблона при выполнении условия.

> [!NOTE]
> [Вложенные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#nested-template) поддерживаются с **deployIfNotExists**, но [связанные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#linked-template) сейчас не поддерживаются.

### <a name="deployifnotexists-evaluation"></a>Оценка DeployIfNotExists

DeployIfNotExists работает примерно через 15 минут после того, как поставщик ресурсов обработал запрос на создание или обновление ресурса и вернул код состояния успеха. Шаблон развертывания появляется только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true.
Продолжительность развертывания зависит от сложности ресурсов, включенных в шаблон.

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием DeployIfNotExists, отмечаются как несоответствующие, но с ними не выполняется никаких действий. Существующие несовместимые ресурсы могут быть исправлены с [помощью задачи по исправлению положения.](../how-to/remediate-resources.md)

### <a name="deployifnotexists-properties"></a>Свойства DeployIfNotExists

Свойство **деталей** эффекта DeployIfNotExists содержит все субсвойства, определяющие соответствующие ресурсы для сопоставления, и развертывание шаблона для выполнения.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Имя** (необязательно)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Когда условие значения для **if.field.type,** а **затем.details.type** совпадают, `[field('name')]`то **имя** становится _обязательным_ и должно быть .
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
  - Шаблон развертывания выполняется в группе ресурсов, соответствующей этому значению.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а развертывание не активируется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не активирует развертывание.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.
- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
- **DeploymentScope** (необязательно)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает тип инициируемого развертывания. _Subscription_ указывает на [развертывание на уровне подписки](../../../azure-resource-manager/templates/deploy-to-subscription.md), а _ResourceGroup_ — на развертывание в группе ресурсов.
  - Свойство _location_ должно быть указано для объекта _Deployment_ при использовании развертываний на уровне подписки.
  - По умолчанию задано значение _ResourceGroup_.
- **Deployment** [обязательный]
  - Это свойство должно содержать полный шаблон развертывания, так как оно будет передано в API PUT `Microsoft.Resources/deployments`. Дополнительные сведения см. в [документации по REST API развертываний](/rest/api/resources/deployments).

  > [!NOTE]
  > Все функции в свойстве **Deployment** оцениваются как компоненты шаблона, а не политики. Исключение составляет свойство **parameters**, передающее значения из политики в шаблон. Свойство **value** из этого раздела под именем параметра шаблона используется для передачи значения (см. _fullDbName_ в примере DeployIfNotExists).

### <a name="deployifnotexists-example"></a>Пример DeployIfNotExists

Пример: оценка баз данных SQL Server, позволяющая определить, включен ли параметр transparentDataEncryption. Если это не так, выполняется развертывание для включения.

```json
"if": {
    "field": "type",
    "equals": "Microsoft.Sql/servers/databases"
},
"then": {
    "effect": "DeployIfNotExists",
    "details": {
        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
        "name": "current",
        "roleDefinitionIds": [
            "/subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
            "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
        ],
        "existenceCondition": {
            "field": "Microsoft.Sql/transparentDataEncryption.status",
            "equals": "Enabled"
        },
        "deployment": {
            "properties": {
                "mode": "incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "fullDbName": {
                            "type": "string"
                        }
                    },
                    "resources": [{
                        "name": "[concat(parameters('fullDbName'), '/current')]",
                        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                        "apiVersion": "2014-04-01",
                        "properties": {
                            "status": "Enabled"
                        }
                    }]
                },
                "parameters": {
                    "fullDbName": {
                        "value": "[field('fullName')]"
                    }
                }
            }
        }
    }
}
```

## <a name="enforceopaconstraint"></a>ПринудительныйopAConstraint

Этот эффект используется с *режимом* определения политики `Microsoft.Kubernetes.Data`. Он используется для передачи правил контроля входа Gatekeeper v3, определенных с [помощью OPA Constraint Framework](https://github.com/open-policy-agent/frameworks/tree/master/constraint#opa-constraint-framework) для [open Policy Agent](https://www.openpolicyagent.org/) (OPA) для самоуправляемых кластеров Kubernetes в Azure.

> [!NOTE]
> [Политика Azure для AKS Engine](aks-engine.md) находится в публичном предварительном просмотре и поддерживает только встроенные определения политики.

### <a name="enforceopaconstraint-evaluation"></a>Оценка enforceOPAConstraint

Контроллер приема агента открытой политики оценивает любой новый запрос на кластере в режиме реального времени.
Каждые 5 минут завершается полное сканирование кластера и отчетоистые результаты в Azure Policy.

### <a name="enforceopaconstraint-properties"></a>Свойства EnforceOPAConstraint

В **свойстве детали** эффекта EnforceOPAConstraint есть субсвойства, описывающие правило контроля входа Gatekeeper v3.

- **ограничениеШаблон** (обязательно)
  - Шаблон ограничения CustomResourceDefinition (CRD), определяющий новые ограничения. Шаблон определяет логику Rego, схему ограничения и параметры ограничения, которые передаются через значения из **политики** Azure.
- **ограничение** (обязательно)
  - Реализация CRD шаблона Constraint. Использует параметры, передаваемые через **значения** как `{{ .Values.<valuename> }}`. В приведенном ниже примере, это будет `{{ .Values.cpuLimit }}` и `{{ .Values.memoryLimit }}`.
- **значения** (необязательно)
  - Определяет любые параметры и значения для передачи в Ограничение. Каждое значение должно существовать в шаблоне CrD-ограничения.

### <a name="enforceopaconstraint-example"></a>Пример EnforceOPAConstraint

Пример: Правило управления приемом Gatekeeper v3 для установки процессора контейнера и ограничений ресурсов памяти в AKS Engine.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "in": [
                "Microsoft.ContainerService/managedClusters",
                "AKS Engine"
            ]
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "enforceOPAConstraint",
    "details": {
        "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/template.yaml",
        "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/constraint.yaml",
        "values": {
            "cpuLimit": "[parameters('cpuLimit')]",
            "memoryLimit": "[parameters('memoryLimit')]"
        }
    }
}
```

## <a name="enforceregopolicy"></a>EnforceRegoPolicy

Этот эффект используется с *режимом* определения политики `Microsoft.ContainerService.Data`. Он используется для передачи Gatekeeper v2 правила контроля приема, определенные с [Rego](https://www.openpolicyagent.org/docs/latest/policy-language/#what-is-rego) для [открытого агента политики](https://www.openpolicyagent.org/) (OPA) на [Azure Kubernetes Service.](../../../aks/intro-kubernetes.md)

> [!NOTE]
> [Политика Azure для AKS](rego-for-aks.md) находится в ограниченном предварительном просмотре и поддерживает только встроенные определения политики

### <a name="enforceregopolicy-evaluation"></a>Оценка EnforceRegoPolicy

Контроллер приема агента открытой политики оценивает любой новый запрос на кластере в режиме реального времени.
Каждые 5 минут завершается полное сканирование кластера и отчетоистые результаты в Azure Policy.

### <a name="enforceregopolicy-properties"></a>Свойства EnforceRegoPolicy

**Подробная** собственность эффекта EnforceRegoPolicy имеет субсвойства, которые описывают правило контроля входа Gatekeeper v2.

- **policyId** (обязательно)
  - Уникальное имя перешло в качестве параметра к правилу контроля входа Rego.
- **политика** (обязательно)
  - Определяет URI правила контроля за приемом Rego.
- **Параметры политики** (необязательно)
  - Определяет любые параметры и значения для передачи в политику рего.

### <a name="enforceregopolicy-example"></a>Пример EnforceRegoPolicy

Пример: Правило контроля входа Gatekeeper v2, позволяющее разрешать только указанные изображения контейнера в AKS.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "equals": "Microsoft.ContainerService/managedClusters"
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "EnforceRegoPolicy",
    "details": {
        "policyId": "ContainerAllowedImages",
        "policy": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/KubernetesService/container-allowed-images/limited-preview/gatekeeperpolicy.rego",
        "policyParameters": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]"
        }
    }
}
```

## <a name="layering-policies"></a>Наложение политик

На ресурс могут влиять несколько назначений. Эти назначения могут быть в одной или в разных областях. Для этих назначений наверняка будут назначены разные действия. Условие и действие для каждой политики вычисляется независимо друг от друга. Пример:

- Политика 1
  - Ограничивает расположение ресурсов для региона "westus"
  - Назначенная подписка А
  - Результат запрета
- Политика 2
  - Ограничивает расположение ресурсов для региона "eastus"
  - Назначенные группе ресурсов B в подписке A
  - Действие аудита
  
Эта настройка приведет к следующему результату.

- Любой ресурс, уже входящий в группу ресурсов В и находящийся в регионе "eastus", соответствует политике 2, но не соответствует политике 1.
- Любой ресурс, уже входящий в группу ресурсов В и не находящийся в регионе "eastus", не соответствует политике 2 и политике 1, если не находится в регионе "westus".
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс, который создается в подписке A и группе ресурсов В, расположенный в регионе "westus" и не соответствует политике 2.

Если задать для политик 1 и 2 действие запрета, ситуация изменится следующим образом.

- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "eastus", не соответствует политике 2.
- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "westus", не соответствует политике 1.
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс в группе ресурсов B в подписке A запрещается.

Каждое назначение оценивается по отдельности. Таким образом, у ресурса нет возможности ускользнуть из-за различий в объеме. Общий результат наложения или перекрывания политик считается **накопительным по принципу максимальной строгости**. Например, если бы политики 1 и 2 имели эффект запрета, ресурс был бы заблокирован перекрывающимися и конфликтующими политиками. Если вам все равно нужно создать ресурс в целевой области, пересмотрите исключения в каждом назначении, чтобы гарантировать, что политики влияют на правильные области.

## <a name="next-steps"></a>Следующие шаги

- Просмотрите [примеры на примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Понять, как [программно создавать политики.](../how-to/programmatically-create.md)
- Узнайте, как [получить данные о соответствии.](../how-to/get-compliance-data.md)
- Узнайте, как [исправления несовместимых ресурсов.](../how-to/remediate-resources.md)
- Просмотрите, что представляет собой группа управления с [организацией ресурсов с группами управления Azure.](../../management-groups/overview.md)
