---
title: Принцип работы эффектов
description: Определения политик Azure имеют различные эффекты, которые определяют, как Управление соответствием и о них сообщается.
ms.date: 03/23/2020
ms.topic: conceptual
ms.openlocfilehash: 0330cb5c732921efda3627dec92e486657097d82
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80422456"
---
# <a name="understand-azure-policy-effects"></a>Сведения о действии политик Azure

Каждое определение политики в Azure имеет один эффект. Этот эффект определяет, что происходит при вычислении правила политики при сопоставлении. Действия по-разному влияют на новые, обновленные и имеющиеся ресурсы.

В настоящее время эти эффекты поддерживаются в определении политики:

- [Добавление](#append)
- [Аудит](#audit)
- [Помощью параметров auditifnotexists](#auditifnotexists)
- [Запрет](#deny)
- [DeployIfNotExists](#deployifnotexists)
- [Отключен](#disabled)
- [Енфорцеопаконстраинт](#enforceopaconstraint) (Предварительная версия)
- [Енфорцерегополици](#enforceregopolicy) (Предварительная версия)
- [Изменение](#modify)

## <a name="order-of-evaluation"></a>Порядок вычислений

Запросы на создание или обновление ресурса с помощью Azure Resource Manager сначала оцениваются политикой Azure. Политика Azure создает список всех назначений, которые применяются к ресурсу, а затем оценивает ресурс по каждому определению. Политика Azure обрабатывает несколько эффектов перед передачей запроса соответствующему поставщику ресурсов. Это предотвращает ненужную обработку поставщиком ресурсов, если ресурс не соответствует специально разработанным элементам управления политики Azure.

- Действие **Disabled** проверяется первым. Таким образом определяется, нужно ли оценить правило политики.
- Затем оцениваются и **добавляются** и **изменяются** . Так как можно изменить запрос, внесенные изменения могут помешать срабатыванию аудита или отказа от триггеров.
- Затем оценивается действие **Deny** (запрет). Запрет оценивается перед аудитом, чтобы нежелательный ресурс не заносился в журнал дважды.
- Затем оценивается действие **Audit** (аудит), после чего запрос отправляется поставщику ресурсов.

После того, как поставщик ресурсов вернет код успешного выполнения, **AuditIfNotExists** и **DeployIfNotExists** вычисляются для определения того, чтобы определить, требуется ли дополнительное ведение журнала соответствия или действие.

В настоящее время не существует порядка вычисления **енфорцеопаконстраинт** или **енфорцерегополици** .

## <a name="disabled"></a>Отключен

Это действие применяется при тестировании или для определения, имеет ли политика параметризованное действие. Такая гибкость позволяет отключить одно назначение этой политики вместо всех назначений.

Альтернативой отключенному результату является **енфорцементмоде** , который задается в назначении политики.
Если **Енфорцементмоде** _отключен_, ресурсы по-прежнему оцениваются. Ведение журнала, например журналы действий, и последствия применения политики не выполняются. Дополнительные сведения см. в статье [режим принудительного применения политики](./assignment-structure.md#enforcement-mode).

## <a name="append"></a>Append

Это действие используется для добавления полей к запрашиваемому ресурсу во время создания или обновления. Типичный пример — указание разрешенных IP-адресов для ресурса хранилища.

> [!IMPORTANT]
> Append предназначен для использования со свойствами, не являющимися тегами. Несмотря на то, что Append может добавлять теги к ресурсу во время запроса на создание или обновление, вместо этого рекомендуется использовать для тегов эффекты [изменения](#modify) .

### <a name="append-evaluation"></a>Оценка добавления

Добавление оценивается до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Это действие добавляет поля к ресурсу, если выполняется условие **if** правила политики. Если добавление приведет к замене значения в исходном запросе на другое значение, то оно работает как действие запрета и отклоняет запрос. Чтобы добавить новое значение в существующий массив, используйте версию псевдонима **[\*]** .

При запуске определения политики с использованием действия добавления в рамках цикла оценивания оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="append-properties"></a>Свойства добавления

Действие добавления содержит только обязательный массив **details**. Так как свойство **details** представляет собой массив, оно может принимать как одну, так и несколько пар **поле/значение**. Список допустимых полей представлен в статье, посвященной [структуре определения](definition-structure.md#fields).

### <a name="append-examples"></a>Примеры добавления

Пример 1. одиночная пара " **поле-значение** " с использованием [псевдонима](definition-structure.md#aliases) , отличного от **[\*]** , со **значением** массива для задания IP-правил в учетной записи хранения. Если псевдоним, не**являющийся\*[]** , является массивом, этот результат добавляет **значение** в качестве всего массива. Если массив уже существует, из конфликта возникает событие отказа.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules",
        "value": [{
            "action": "Allow",
            "value": "134.5.0.0/21"
        }]
    }]
}
```

Пример 2. одиночная пара " **поле-значение** " с использованием [псевдонима](definition-structure.md#aliases) **[\*]** со **значением** массива для задания IP-правил в учетной записи хранения. Используя псевдоним **\*[]** , этот результат добавляет **значение** к потенциально существовавшему ранее массиву. Если массив еще не существует, он будет создан.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*]",
        "value": {
            "value": "40.40.40.40",
            "action": "Allow"
        }
    }]
}
```

## <a name="modify"></a>Изменить

Изменение используется для добавления, обновления или удаления тегов для ресурса во время создания или обновления. Распространенный пример — обновление тегов для ресурсов, таких как costCenter. Политика изменения всегда должна быть `mode` настроена для _индексирования_ , если целевой ресурс не является группой ресурсов. Существующие несоответствующие ресурсы можно исправить с помощью [задачи исправления](../how-to/remediate-resources.md). Одно правило изменения может иметь любое количество операций.

> [!IMPORTANT]
> Параметр modify в настоящее время предназначен только для использования с тегами. Если вы управляете тегами, рекомендуется использовать параметр изменить вместо Append в качестве изменения предоставляет дополнительные типы операций и возможность исправлять существующие ресурсы. Однако рекомендуется использовать Append, если вы не можете создать управляемое удостоверение.

### <a name="modify-evaluation"></a>Изменение оценки

Изменение вычисляется до того, как запрос будет обработан поставщиком ресурсов во время создания или обновления ресурса. Изменение добавляет или обновляет теги в ресурсе при соблюдении условия **If** правила политики.

Когда определение политики, использующее действие изменения, выполняется в рамках цикла оценки, оно не вносит изменения в уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="modify-properties"></a>Изменение свойств

Свойство **Details** в результате изменения имеет все вложенные свойства, определяющие разрешения, необходимые для исправления, и **операции** , используемые для добавления, обновления или удаления значений тегов.

- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
  - Определенная роль должна включать все операции, предоставленные роли [участника](../../../role-based-access-control/built-in-roles.md#contributor) .
- **операции** [обязательный]
  - Массив всех операций тегов, которые должны быть выполнены для сопоставления ресурсов.
  - Свойства:
    - **Операция** [обязательный]
      - Определяет, какое действие следует предпринять с соответствующим ресурсом. Возможные варианты: _аддорреплаце_, _Add_, _Remove_. _Добавление_ ведет себя аналогично результату [добавления](#append) .
    - **поле** [обязательное]
      - Тег для добавления, замены или удаления. Имена тегов должны соответствовать тому же соглашению об именовании для других [полей](./definition-structure.md#fields).
    - **значение** (необязательно)
      - Значение, для которого задается тег.
      - Это свойство является обязательным, если **Операция** — _аддорреплаце_ или _Add_.

### <a name="modify-operations"></a>Изменение операций

Массив свойств **операций** позволяет изменять несколько тегов различными способами из одного определения политики. Каждая операция состоит из свойств **операции**, **поля**и **значения** . Операция определяет, что делает задача исправления в тегах, поле определяет, какой тег изменяется, а значение определяет новый параметр для этого тега. Приведенный ниже пример вносит изменения в Теги:

- Задает для `environment` тега значение "Test", даже если он уже существует с другим значением.
- Удаляет тег `TempResource`.
- Задает `Dept` тег для параметра политики _дептнаме_ , настроенного для назначения политики.

```json
"details": {
    ...
    "operations": [
        {
            "operation": "addOrReplace",
            "field": "tags['environment']",
            "value": "Test"
        },
        {
            "operation": "Remove",
            "field": "tags['TempResource']",
        },
        {
            "operation": "addOrReplace",
            "field": "tags['Dept']",
            "value": "[parameters('DeptName')]"
        }
    ]
}
```

Свойство **Operation** имеет следующие параметры.

|Операция |Описание |
|-|-|
|аддорреплаце |Добавляет определенный тег и значение к ресурсу, даже если тег уже существует с другим значением. |
|Add |Добавляет определенный тег и значение к ресурсу. |
|Удалить |Удаляет определенный тег из ресурса. |

### <a name="modify-examples"></a>Изменение примеров

Пример 1. добавление `environment` тега и замена существующих `environment` тегов на "Test":

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "Test"
            }
        ]
    }
}
```

Пример 2. Удалите `env` тег и добавьте `environment` тег или замените существующие `environment` Теги на параметризованное значение:

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "Remove",
                "field": "tags['env']"
            },
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "[parameters('tagValue')]"
            }
        ]
    }
}
```

## <a name="deny"></a>Запрет

Запрет используется, чтобы не пропускать запросы ресурсов, не соответствующие определенным стандартам, через определение политики. При этом запрос завершается с ошибкой.

### <a name="deny-evaluation"></a>Оценка запрета

При создании или обновлении соответствующего ресурса запрет останавливает запрос до его отправки поставщику ресурсов. Запрос возвращает `403 (Forbidden)`. На портале для развертывания, запрещенного в связи с назначением политики, отображается состояние "Запрещено".

Во время оценки существующие ресурсы, которые соответствуют определению политики запрета, помечаются как несовместимые.

### <a name="deny-properties"></a>Свойства запрета

Действие запрета не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="deny-example"></a>Пример запрета

Пример: использование действия запрета.

```json
"then": {
    "effect": "deny"
}
```

## <a name="audit"></a>Аудит

Аудит используется, чтобы создать предупреждение в журнале действий при оценке несоответствующего ресурса, но такое действие не останавливает запрос.

### <a name="audit-evaluation"></a>Оценка аудита

Аудит — это последний результат, проверенный политикой Azure во время создания или обновления ресурса. Затем политика Azure отправляет ресурс поставщику ресурсов. Аудит работает одинаково для запроса ресурса и для цикла оценки. Политика Azure добавляет `Microsoft.Authorization/policies/audit/action` операцию в журнал действий и помечает ресурс как несовместимый.

### <a name="audit-properties"></a>Свойства аудита

Действие аудита не содержит никаких дополнительных свойств для использования в условии **then** определения политики.

### <a name="audit-example"></a>Пример аудита

Пример: использование действия аудита.

```json
"then": {
    "effect": "audit"
}
```

## <a name="auditifnotexists"></a>AuditIfNotExists

Действие AuditIfNotExists позволяет выполнять аудит ресурсов, соответствующих условию **if**, но не содержат компонентов, указываемых в свойстве **details** условия **then**.

### <a name="auditifnotexists-evaluation"></a>Оценка AuditIfNotExists

Действие AuditIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Этот аудит происходит только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. Политика Azure добавляет `Microsoft.Authorization/policies/audit/action` операцию в журнал действий так же, как и результат аудита. При вызове этого действия ресурс, соответствующий условию **if**, отмечается как несоответствующий.

### <a name="auditifnotexists-properties"></a>Свойства AuditIfNotExists

Свойство **details** действия AuditIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Если **Details. Type** является типом ресурса под ресурсом условия **If** , политика запрашивает ресурсы этого **типа** в области вычисляемого ресурса. В противном случае запросы политики в той же группе ресурсов, что и вычисленный ресурс.
- **Имя** (необязательно)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Если значения условия для **. Field. Type** и then. **Details. Type** совпадают, то **имя** будет _обязательным_ и должно быть `[field('name')]`. Однако вместо этого следует рассмотреть результат [аудита](#audit) .
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а аудит не выполняется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не вызывает аудит.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.

### <a name="auditifnotexists-example"></a>Пример AuditIfNotExists

Пример: оценка виртуальных машин для поиска антивредоносного расширения с последующим аудитом при его отсутствии.

```json
{
    "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
    },
    "then": {
        "effect": "auditIfNotExists",
        "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "existenceCondition": {
                "allOf": [{
                        "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                        "equals": "Microsoft.Azure.Security"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/extensions/type",
                        "equals": "IaaSAntimalware"
                    }
                ]
            }
        }
    }
}
```

## <a name="deployifnotexists"></a>DeployIfNotExists

Как и в случае с помощью параметров auditifnotexists, определение политики DeployIfNotExists выполняет развертывание шаблона при выполнении условия.

> [!NOTE]
> [Вложенные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#nested-template) поддерживаются с **deployIfNotExists**, но [связанные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#linked-template) сейчас не поддерживаются.

### <a name="deployifnotexists-evaluation"></a>Оценка DeployIfNotExists

DeployIfNotExists запускается примерно через 15 минут после того, как поставщик ресурсов обработал запрос на создание или обновление ресурса и вернул код состояния успеха. Шаблон развертывания появляется только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true.
Длительность развертывания зависит от сложности ресурсов, включенных в шаблон.

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием DeployIfNotExists, отмечаются как несоответствующие, но с ними не выполняется никаких действий. Существующие несоответствующие ресурсы можно исправить с помощью [задачи исправления](../how-to/remediate-resources.md).

### <a name="deployifnotexists-properties"></a>Свойства DeployIfNotExists

Свойство **Details** элемента DeployIfNotExists имеет все вложенные свойства, которые определяют связанные ресурсы для сопоставления и развертывание шаблона для выполнения.

- **Type** [обязательный]
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Имя** (необязательно)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Если значения условия для **. Field. Type** и then. **Details. Type** совпадают, то **имя** будет _обязательным_ и должно быть `[field('name')]`.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
  - Шаблон развертывания выполняется в группе ресурсов, соответствующей этому значению.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а развертывание не активируется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не активирует развертывание.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.
- **roleDefinitionIds** [обязательное свойство].
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
- **DeploymentScope** (необязательно)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает тип инициируемого развертывания. _Subscription_ указывает на [развертывание на уровне подписки](../../../azure-resource-manager/templates/deploy-to-subscription.md), а _ResourceGroup_ — на развертывание в группе ресурсов.
  - Свойство _location_ должно быть указано для объекта _Deployment_ при использовании развертываний на уровне подписки.
  - По умолчанию задано значение _ResourceGroup_.
- **Deployment** [обязательный]
  - Это свойство должно содержать полный шаблон развертывания, так как оно будет передано в API PUT `Microsoft.Resources/deployments`. Дополнительные сведения см. в [документации по REST API развертываний](/rest/api/resources/deployments).

  > [!NOTE]
  > Все функции в свойстве **Deployment** оцениваются как компоненты шаблона, а не политики. Исключение составляет свойство **parameters**, передающее значения из политики в шаблон. Свойство **value** из этого раздела под именем параметра шаблона используется для передачи значения (см. _fullDbName_ в примере DeployIfNotExists).

### <a name="deployifnotexists-example"></a>Пример DeployIfNotExists

Пример: оценка баз данных SQL Server, позволяющая определить, включен ли параметр transparentDataEncryption. Если это не так, выполняется развертывание для включения.

```json
"if": {
    "field": "type",
    "equals": "Microsoft.Sql/servers/databases"
},
"then": {
    "effect": "DeployIfNotExists",
    "details": {
        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
        "name": "current",
        "roleDefinitionIds": [
            "/subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
            "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
        ],
        "existenceCondition": {
            "field": "Microsoft.Sql/transparentDataEncryption.status",
            "equals": "Enabled"
        },
        "deployment": {
            "properties": {
                "mode": "incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "fullDbName": {
                            "type": "string"
                        }
                    },
                    "resources": [{
                        "name": "[concat(parameters('fullDbName'), '/current')]",
                        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                        "apiVersion": "2014-04-01",
                        "properties": {
                            "status": "Enabled"
                        }
                    }]
                },
                "parameters": {
                    "fullDbName": {
                        "value": "[field('fullName')]"
                    }
                }
            }
        }
    }
}
```

## <a name="enforceopaconstraint"></a>енфорцеопаконстраинт

Этот результат используется с *режимом* определения политики `Microsoft.Kubernetes.Data`. Он используется для передачи правил управления допуском привратника версии 3, определенных с помощью [инфраструктуры ограничений непрозра](https://github.com/open-policy-agent/frameworks/tree/master/constraint#opa-constraint-framework) , чтобы [Открыть агент политики](https://www.openpolicyagent.org/) (непрозра) для самостоятельно управляемых кластеров Kubernetes в Azure.

> [!NOTE]
> [Политика Azure для AKS Engine](aks-engine.md) доступна в общедоступной предварительной версии и поддерживает только встроенные определения политик.

### <a name="enforceopaconstraint-evaluation"></a>Оценка Енфорцеопаконстраинт

Контроллер допуска Open Policy Agent оценивает все новые запросы в кластере в режиме реального времени.
Каждые 5 минут завершается полное сканирование кластера и результаты, отправленные в политику Azure.

### <a name="enforceopaconstraint-properties"></a>Свойства Енфорцеопаконстраинт

Свойство **Details** элемента енфорцеопаконстраинт имеет вложенные свойства, описывающие правило управления допуском привратника 3.

- **констраинттемплате** [обязательный]
  - Шаблон ограничения Кустомресаурцедефинитион (CRD), который определяет новые ограничения. Шаблон определяет логику Рего, схему ограничения и параметры ограничения, которые передаются через **значения** из политики Azure.
- **ограничение** [обязательный]
  - Реализация CRD шаблона ограничения. Использует параметры, передаваемые через `{{ .Values.<valuename> }}` **значения** , как. В приведенном ниже примере это будет `{{ .Values.cpuLimit }}` и. `{{ .Values.memoryLimit }}`
- **значения** [необязательно]
  - Определяет все параметры и значения, передаваемые в ограничение. Каждое значение должно существовать в шаблоне ограничения CRD.

### <a name="enforceopaconstraint-example"></a>Пример Енфорцеопаконстраинт

Пример. правило управления допуском "привратник V3" для задания ограничений ресурсов ЦП и памяти контейнера в подсистеме AKS Engine.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "in": [
                "Microsoft.ContainerService/managedClusters",
                "AKS Engine"
            ]
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "enforceOPAConstraint",
    "details": {
        "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/template.yaml",
        "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/constraint.yaml",
        "values": {
            "cpuLimit": "[parameters('cpuLimit')]",
            "memoryLimit": "[parameters('memoryLimit')]"
        }
    }
}
```

## <a name="enforceregopolicy"></a>енфорцерегополици

Этот результат используется с *режимом* определения политики `Microsoft.ContainerService.Data`. Он используется для передачи правил управления допуском привратника версии 2, определенных с помощью [Рего](https://www.openpolicyagent.org/docs/latest/policy-language/#what-is-rego) , для [открытия агента политики](https://www.openpolicyagent.org/) (Непрозра) в [службе Kubernetes Azure](../../../aks/intro-kubernetes.md).

> [!NOTE]
> [Политика Azure для AKS](rego-for-aks.md) ограничена предварительной версией и поддерживает только встроенные определения политик

### <a name="enforceregopolicy-evaluation"></a>Оценка Енфорцерегополици

Контроллер допуска Open Policy Agent оценивает все новые запросы в кластере в режиме реального времени.
Каждые 5 минут завершается полное сканирование кластера и результаты, отправленные в политику Azure.

### <a name="enforceregopolicy-properties"></a>Свойства Енфорцерегополици

Свойство **Details** элемента енфорцерегополици имеет вложенные свойства, описывающие правило управления допуском привратника 2.

- **policyId** [обязательный]
  - Уникальное имя, передаваемое в качестве параметра в правило управления допуском Рего.
- **Политика** [обязательный параметр]
  - Указывает универсальный код ресурса (URI) правила управления допуском Рего.
- **полиципараметерс** [необязательно]
  - Определяет все параметры и значения, передаваемые в политику Рего.

### <a name="enforceregopolicy-example"></a>Пример Енфорцерегополици

Пример: правило управления допуском для привратника v2, разрешающее только указанные образы контейнеров в AKS.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "equals": "Microsoft.ContainerService/managedClusters"
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "EnforceRegoPolicy",
    "details": {
        "policyId": "ContainerAllowedImages",
        "policy": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/KubernetesService/container-allowed-images/limited-preview/gatekeeperpolicy.rego",
        "policyParameters": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]"
        }
    }
}
```

## <a name="layering-policies"></a>Наложение политик

На ресурс могут влиять несколько назначений. Эти назначения могут быть в одной или в разных областях. Для этих назначений наверняка будут назначены разные действия. Условие и действие для каждой политики вычисляется независимо друг от друга. Пример:

- Политика 1
  - Ограничивает расположение ресурсов для региона "westus"
  - Назначенная подписка А
  - Результат запрета
- Политика 2
  - Ограничивает расположение ресурсов для региона "eastus"
  - Назначенные группе ресурсов B в подписке A
  - Действие аудита
  
Эта настройка приведет к следующему результату.

- Любой ресурс, уже входящий в группу ресурсов В и находящийся в регионе "eastus", соответствует политике 2, но не соответствует политике 1.
- Любой ресурс, уже входящий в группу ресурсов В и не находящийся в регионе "eastus", не соответствует политике 2 и политике 1, если не находится в регионе "westus".
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс, который создается в подписке A и группе ресурсов В, расположенный в регионе "westus" и не соответствует политике 2.

Если задать для политик 1 и 2 действие запрета, ситуация изменится следующим образом.

- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "eastus", не соответствует политике 2.
- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "westus", не соответствует политике 1.
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс в группе ресурсов B в подписке A запрещается.

Каждое назначение оценивается по отдельности. Таким образом, у ресурса нет возможности ускользнуть из-за различий в объеме. Общий результат наложения или перекрывания политик считается **накопительным по принципу максимальной строгости**. Например, если бы политики 1 и 2 имели эффект запрета, ресурс был бы заблокирован перекрывающимися и конфликтующими политиками. Если вам все равно нужно создать ресурс в целевой области, пересмотрите исключения в каждом назначении, чтобы гарантировать, что политики влияют на правильные области.

## <a name="next-steps"></a>Дальнейшие шаги

- Просмотрите примеры в [примерах политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Узнайте, как [программно создавать политики](../how-to/programmatically-create.md).
- Узнайте, как [получить данные о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Узнайте, что такое группа управления, и [Организуйте ресурсы с помощью групп управления Azure](../../management-groups/overview.md).
