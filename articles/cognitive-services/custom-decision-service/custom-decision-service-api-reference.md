---
title: Справочник по API — пользовательская служба принятия решений
titlesuffix: Azure Cognitive Services
description: Полное руководство по API для пользовательской службы принятия решений.
services: cognitive-services
author: slivkins
manager: nitinme
ms.service: cognitive-services
ms.subservice: custom-decision-service
ms.topic: conceptual
ms.date: 05/11/2018
ms.author: slivkins
ROBOTS: NOINDEX
ms.openlocfilehash: 4f263e3b57103174f0084ab3d25430d8c47359fd
ms.sourcegitcommit: ad9120a73d5072aac478f33b4dad47bf63aa1aaa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/01/2019
ms.locfileid: "68707297"
---
# <a name="api"></a>API

Пользовательская служба принятия решений Azure предоставляет два API, которые вызываются для каждого решения: [API ранжирования](#ranking-api) для ввода ранжирования действий и [API вознаграждения](#reward-api) для вывода вознаграждения. Кроме того, вы предоставляете [API набора действий](#action-set-api-customer-provided), чтобы указать действия в Пользовательской службе принятия решений Azure. В этой статье рассматриваются эти три API. Ниже для отображения используется типичный сценарий, когда Пользовательская служба принятия решений оптимизирует ранжирование статей.

## <a name="ranking-api"></a>API ранжирования

API ранжирования использует стандартный шаблон обмена данными [JSONP](https://en.wikipedia.org/wiki/JSONP) для оптимизации задержки и обхода [политики одного источника](https://en.wikipedia.org/wiki/Same-origin_policy). Последний запрещает JavaScript получать данные за пределами исходной страницы.

Вставьте этот фрагмент в заголовок HTML главной страницы (где отображается персонализированный список статей):

```html
// define the "callback function" to render UI
<script> function callback(data) { … } </script>
// "data" provides the ranking of URLs, see example below.

// call to Ranking API
<script src="https://ds.microsoft.com/api/v2/<appId>/rank/<actionSetId>?<parameters>" async></script>
// action set id is the name of the corresponding RSS/Atom feed.

// same call with multiple action sets:
// <script src="https://ds.microsoft.com/api/v2/<appId>/rank/<A1>/<A2>/.../<An>?<parameters>" async></script>
```

> [!IMPORTANT]
> Функцию обратного вызова следует определить перед вызовом API ранжирования.

> [!TIP]
> Чтобы сократить задержку, API ранжирования выполняется через HTTP, а не HTTPS, как в `https://ds.microsoft.com/api/v2/<appId>/rank/*`.
> Тем не менее, конечная точка HTTPS должна использоваться, если первая страница обслуживается через HTTPS.

Когда параметры не используются, ответ HTTP от API ранжирования — это строка в формате JSONP:

```json
callback({
   "ranking":[{"id":"url1"}, {"id":"url2"}, {"id":"url3"}],
   "eventId":"<opaque event string>",
   "appId":"<your app id>",
   "actionSets":[{"id":"<A1>","lastRefresh":"2017-04-29T22:34:25.3401438Z"},
                 {"id":"<A2>","lastRefresh":"2017-04-30T22:34:25.3401438Z"}]});
```

Затем браузер выполняет эту строку как вызов функции `callback()`.

Параметр функции обратного вызова в предыдущем примере имеет следующую схему:

- `ranking`. Предоставляет ранжирование URL-адресов для отображения.
- `eventId`. Используется внутри Пользовательской службы принятия решений для сопоставления ранжирования с соответствующими щелчками.
- `appId`. Позволяет функции обратного вызова различать несколько приложений Пользовательской службы принятия решений, работающих на одной и той же веб-странице.
- `actionSets`. Отображает список всех действий, используемых в вызове API ранжирования, а также временную метку UTC последнего успешного обновления. Пользовательская служба принятия решений периодически обновляет веб-каналы набора действий. Например, если некоторые из наборов действий не являются текущими, функции обратного вызова может потребоваться вернутся к ранжированию по умолчанию.

> [!IMPORTANT]
> Указанные наборы действий обрабатываются и, возможно, урезаются, чтобы сформировать ранжирование статей по умолчанию. Затем ранжирование по умолчанию повторно упорядочивается и возвращается в ответе HTTP. Здесь определяется ранжирование по умолчанию:
>
> - В пределах каждого набора действий статьи будут урезаны до 15 самых последних статей (если возвращается более 15).
> - Если несколько наборов действий указаны, они объединяются в том же порядке, что и при вызове API. Исходный порядок статей сохраняется в пределах каждого набора действий. Дубликаты удаляются в пользу более ранних копий.
> - Первые `n` статей хранятся в списке объединенных статей, где `n=20` по умолчанию.

### <a name="ranking-api-with-parameters"></a>Параметры API ранжирования

API ранжирования разрешает такие параметры:

- `details=1` и `details=2` вставляют дополнительные сведения о каждой статье, перечисленные в `ranking`.
- `limit=<n>`. Указывает максимальное количество статей в ранжировании по умолчанию. `n`. Должен находиться в диапазоне от `2` до `30` (или в противном случае он усекается до `2` или `30` соответственно).
- `dnt=1`. Отключает файлы cookie пользователя.

Параметры могут быть объединены в стандартном синтаксисе строки запроса, например `details=2&dnt=1`.

> [!IMPORTANT]
> В Европе значение по умолчанию должно быть `dnt=1`, пока клиент не согласится с баннером cookie. Он также должен быть настройкой по умолчанию для сайтов, предназначенных для несовершеннолетних. Дополнительные сведения см. в статье [об условия использования](https://www.microsoft.com/cognitive-services/en-us/legal/CognitiveServicesTerms20160804).

Элемент `details=1` вставляет `guid` каждой статьи, если он обрабатывается API набора действий. HTTP-ответ:

```json
callback({
   "ranking":[{"id":"url1","details":[{"guid":"123"}]},
              {"id":"url2","details":[{"guid":"456"}]},
              {"id":"url3","details":[{"guid":"789"}]}],
   "eventId":"<opaque event string>",
   "appId":"<your app id>",
   "actionSets":[{"id":"<A1>","lastRefresh":"timeStamp1"},
                 {"id":"<A2>","lastRefresh":"timeStamp2"}]});
```

Элемент `details=2` добавляет дополнительные сведения, которые Пользовательская служба принятия решений может извлечь из [кода функций](https://github.com/Microsoft/mwt-ds/tree/master/Crawl) метатегов SEO статей:

- `title` из `<meta property="og:title" content="..." />`, `<meta property="twitter:title" content="..." />` или `<title>...</title>`
- `description` из `<meta property="og:description" ... />`, `<meta property="twitter:description" content="..." />` или `<meta property="description" content="..." />`
- `image` из `<meta property="og:image" content="..." />`
- `ds_id` из `<meta name=”microsoft:ds_id” content="..." />`

HTTP-ответ:

```json
callback({
   "ranking":[{"id":"url1","details":<details>},
              {"id":"url2","details":<details>},
              {"id":"url3","details":<details>}],
   "eventId":"<opaque event string>",
   "appId":"<your app id>",
   "actionSets":[{"id":"<A1>","lastRefresh":"timeStamp1"},
                 {"id":"<A2>","lastRefresh":"timeStamp2"}]});
```

Элемент `<details>`:

```json
[{"guid":"123"}, {"description":"some text", "ds_id":"234", "image":"ImageUrl1", "title":"some text"}]
```

## <a name="reward-api"></a>API вознаграждения

Пользовательская служба принятия решений использует щелчки только в верхнем слоте. Каждый щелчок интерпретируется как вознаграждение 1. Отсутствие щелчка интерпретируется как вознаграждение 0. Щелчки сопоставляются с соответствующими ранжированиями, используя идентификаторы, которые создаются вызовом [API ранжирования](#ranking-api). При необходимости идентификаторы событий могут быть переданы через cookie сеанса.

Для обработки щелчка в верхнем слоте поместите этот код на первой странице:

```javascript
$.ajax({
    type: "POST",
    url: '//ds.microsoft.com/api/v2/<appId>/reward/' + data.eventId,
    contentType: "application/json" })
```

Здесь `data` является аргументом функции `callback()`, как было описано выше. Использование `data` в коде обработки выбранных элементов требует некоторой осторожности. Пример приведен в этом [руководстве](custom-decision-service-tutorial-news.md#use-the-apis).

Только для тестирования API ранжирования можно вызвать через [cURL](https://en.wikipedia.org/wiki/CURL):

```sh
curl -v https://ds.microsoft.com/api/v2/<appId>/reward/<eventId> -X POST -d 1 -H "Content-Type: application/json"
```

Ожидаемый результат: ответ HTTP 200 (ОК). Вознаграждение 1 за это событие можно увидеть в журнале (если на портале был добавлен ключ учетной записи Azure).

## <a name="action-set-api-customer-provided"></a>API набора действий (предоставленного клиентом)

На высоком уровне API набора действий возвращает список статей (действий). Каждая статья определяется своим URL-адресом и (необязательно) названием статьи, а также датой публикации. На портале можно указать несколько наборов действий. Для каждого набора действий должен использоваться другой API набора действий в качестве отдельного URL-адреса.

Каждый API набора действий можно реализовать двумя способами: как веб-канал RSS или веб-канал Atom. Каждый должен соответствовать стандарту и возвращать правильный XML-код. Ниже приведен пример RSS:

```xml
<rss version="2.0">
<channel>
   <item>
      <title><![CDATA[title (possibly with url) ]]></title>
      <link>url</link>
      <guid>guid (could be a your internal database id)</guid>
      <pubDate>date</pubDate>
    </item>
   <item>
       ....
   </item>
</channel>
</rss>
```

Каждый элемент верхнего уровня `<item>` описывает действие:

- `<link>`. Является обязательным и используется в качестве идентификатора действия.
- `<date>`. Игнорируется, если в нем находится 15 или меньше элементов, в другом случае — обязателен.
  - Если присутствует больше 15 элементов, используется 15 последних.
  - Он должен быть в стандартном формате для RSS или Atom, соответственно:
    - [RFC 822](https://tools.ietf.org/html/rfc822) для RSS. Например, `"Fri, 28 Apr 2017 18:02:06 GMT"`
    - [RFC 3339](https://tools.ietf.org/html/rfc3339) для RSS. Например, `"2016-12-19T16:39:57-08:00"`
- `<title>`. Является необязательным и используется для создания компонентов, описывающих статью.
- `<guid>`. Необязательный, передается по системе для обратного вызова функции (если параметр `?details` указан в вызове API ранжирования).

Другие элементы в `<item>` игнорируются.

Веб-канал Atom использует версию того же XML-синтаксиса и соглашения.

> [!TIP]
> Если ваша система использует собственные идентификаторы статей, их можно передать в функцию обратного вызова, используя `<guid>`.
