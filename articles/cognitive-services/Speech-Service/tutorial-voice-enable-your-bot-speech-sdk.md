---
title: Учебник. Использование голосов для работы с роботами с помощью речевого пакета SDK — служба речи
titleSuffix: Azure Cognitive Services
description: В этом руководстве вы создадите эхо-робот с помощью Microsoft Bot — Framework, развернете его в Azure и зарегистрируете в канале голосовых речевых команд в Bot-Framework. Затем вы настроите пример клиентского приложения для Windows, который позволит вам поговорить с программой-роботом и слышать ответ.
services: cognitive-services
author: IEvangelist
manager: nitinme
ms.service: cognitive-services
ms.subservice: speech-service
ms.topic: conceptual
ms.date: 02/25/2020
ms.author: dapine
ms.openlocfilehash: 9112c7070708f3b97d79c1978a9b7204721c3194
ms.sourcegitcommit: f15f548aaead27b76f64d73224e8f6a1a0fc2262
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/26/2020
ms.locfileid: "77616637"
---
# <a name="tutorial-voice-enable-your-bot-using-the-speech-sdk"></a>Учебник. Включение программы-робота с помощью речевого пакета SDK

Теперь вы можете использовать возможности службы распознавания речи, чтобы легко включить голосовые роботы для разговора.

В этом руководстве вы создадите эхо-робот с помощью Microsoft Bot — Framework, развернете его в Azure и зарегистрируете в канале голосовых речевых команд в Bot-Framework. Затем вы настроите пример клиентского приложения для Windows, который позволит вам поговорить с программой-роботом и слышать ответ.

Этот учебник предназначен для разработчиков, которые просто начинают работать с Azure, Bot-программы-роботы, прямой голосовой речь или речевым пакетом SDK и хотят быстро создать рабочую систему с ограниченным кодом. Нет опыта или знакомства с этими службами.

В конце этого упражнения вы настроили систему, которая будет работать следующим образом:

1. Пример клиентского приложения настроен для подключения к каналу голосовой речи и эхо-роботу.
1. Звук записывается с микрофона по умолчанию при нажатии кнопки (или постоянно записывается при активации настраиваемого ключевого слова).
1. При необходимости выполняется обнаружение пользовательских ключевых слов, ограничение потоковой передачи звука в облако
1. С помощью пакета SDK для распознавания речи приложение подключается к каналу голосовой речи и потокам аудио
1. При необходимости в службе выполняется проверка ключевых слов с более высокой точностью
1. Звук передается в службу распознавания речи и расшифрованной в текст
1. Распознанный текст передается в эхо-Bot как действие платформы Bot 
1. Текст ответа включается службой преобразования текста в речь (TTS) и передается обратно в клиентское приложение для воспроизведения.

![Тег схемы](media/tutorial-voice-enable-your-bot-speech-sdk/diagram.png "Поток речевого канала")

> [!NOTE]
> Для выполнения действий, описанных в этом руководстве, не требуется платная служба. Как новый пользователь Azure, вы сможете использовать кредиты бесплатной пробной подписки Azure и бесплатный уровень службы речи для выполнения этого руководства.

Темы, рассматриваемые в этом руководстве:
> [!div class="checklist"]
> * Создание ресурсов Azure
> * Создание, тестирование и развертывание образца Echo Bot в службе приложений Azure
> * Регистрация программы-робота с помощью канала прямого перевода строки
> * Создание и запуск голосового клиента Direct Line для взаимодействия с эхо-роботом
> * Добавить активацию настраиваемого ключевого слова
> * Узнайте, как изменить язык распознанной и речевой речи

## <a name="prerequisites"></a>предварительные требования

Для работы с этим руководством необходимо выполнить следующие действия.

- КОМПЬЮТЕР с Windows 10 с рабочим микрофоном и динамиками (или наушниками)
- [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) или более поздней версии
- [Пакет SDK для .NET Core](https://dotnet.microsoft.com/download) версии 2,1 или более поздней
- Учетная запись Azure. [Зарегистрируйтесь бесплатно](https://azure.microsoft.com/free/ai/).
- Учетная запись [GitHub](https://github.com/) .
- [Git для Windows](https://git-scm.com/download/win)

## <a name="create-a-resource-group"></a>Создание группы ресурсов

В клиентском приложении, которое вы создадите в этом руководстве, используется несколько служб Azure. Чтобы сократить время приема-передачи для ответов от программы-робота, необходимо убедиться, что эти службы расположены в одном регионе Azure. В этом разделе вы создадите группу ресурсов в регионе " **Западная часть США** ". Эта группа ресурсов будет использоваться при создании отдельных ресурсов для Bot-Framework, канала речевого перевода строки и службы распознавания речи.

1. <a href="https://ms.portal.azure.com/#create/Microsoft.ResourceGroup" target="_blank">Создание группы ресурсов<span class="docon docon-navigate-external x-hidden-focus"></span></a>
1. Вам будет предложено ввести некоторые сведения:
   * Установите **бесплатную пробную версию** **подписки** (можно также использовать существующую подписку).
   * Введите имя **группы ресурсов**. Рекомендуется **спичечоботтуториал-ResourceGroup**.
   * В раскрывающемся списке **регион** выберите **Западная часть США**.
1. Щелкните **Проверка и создание**. Вы увидите баннер, **прошедший проверку**на прочтение.
1. Нажмите кнопку **Создать**. Создание группы ресурсов может занять несколько минут.
1. Как и в случае с ресурсами, которые будут созданы далее в этом учебнике, рекомендуется закрепить эту группу ресурсов на панели мониторинга для упрощения доступа. Если вы хотите закрепить эту группу ресурсов, щелкните значок закрепления в верхнем правом углу панели мониторинга.

### <a name="choosing-an-azure-region"></a>Выбор региона Azure

Если вы хотите использовать другой регион для этого руководства, эти факторы могут ограничить выбор:

* Убедитесь, что вы используете [поддерживаемый регион Azure](regions.md#voice-assistants).
* В канале голосового перевода прямой линии используется служба преобразования текста в речь, которая имеет стандартные и нейронные голоса. Нейронные голоса [ограничены конкретными регионами Azure](regions.md#standard-and-neural-voices).
* Ключи бесплатных пробных версий могут быть ограничены конкретным регионом.

Дополнительные сведения о регионах см. в разделе [расположения Azure](https://azure.microsoft.com/global-infrastructure/locations/).

## <a name="create-resources"></a>Создание ресурсов

Теперь, когда у вас есть группа ресурсов в поддерживаемом регионе, необходимо создать отдельные ресурсы для каждой службы, которая будет использоваться в этом руководстве.

### <a name="create-a-speech-service-resource"></a>Создание ресурса службы речи

Чтобы создать речевой ресурс, выполните следующие инструкции:

1. <a href="https://ms.portal.azure.com/#create/Microsoft.CognitiveServicesSpeechServices" target="_blank">Создание ресурса службы речи<span class="docon docon-navigate-external x-hidden-focus"></span></a>
4. Вам будет предложено ввести некоторые сведения:
   * Присвойте ресурсу **имя**. Рекомендуем **спичечоботтуториал-речь**
   * Убедитесь, что для **подписки**выбрана **Бесплатная пробная версия** .
   * В качестве **расположения**выберите **Западная часть США**.
   * В качестве **ценовой**категории выберите **F0**. Это бесплатный уровень.
   * В качестве **группы ресурсов**выберите **спичечоботтуториал-ResourceGroup**.
5. После введения всех необходимых сведений нажмите кнопку **создать**. Создание ресурса может занять несколько минут.
6. Далее в этом учебнике вам понадобятся ключи подписки для этой службы. Доступ к этим ключам можно получить в любое время из **обзора** ресурса (управление ключами) или **ключей**.

На этом этапе убедитесь, что в группе ресурсов (**спичечоботтуториал-ResourceGroup**) есть ресурс речи:

| Имя | Тип  | Location |
|------|-------|----------|
| Спичечоботтуториал — речь | Cognitive Services | западная часть США |

### <a name="create-an-azure-app-service-plan"></a>Создание плана службы приложений Azure

Следующим шагом является создание плана службы приложений. План службы приложений определяет набор вычислительных ресурсов, на которых выполняется веб-приложение.

1. <a href="https://ms.portal.azure.com/#create/Microsoft.AppServicePlanCreate" target="_blank">Создание плана службы приложений Azure<span class="docon docon-navigate-external x-hidden-focus"></span></a>
4. Вам будет предложено ввести некоторые сведения:
   * Установите **бесплатную пробную версию** **подписки** (можно также использовать существующую подписку).
   * В качестве **группы ресурсов**выберите **спичечоботтуториал-ResourceGroup**.
   * Присвойте ресурсу **имя**. Рекомендуется **спичечоботтуториал-AppServicePlan**
   * В качестве **операционной системы**выберите **Windows**.
   * В качестве **региона**выберите **Западная часть США**.
   * Убедитесь, что для **ценовой**категории выбрано " **стандартный S1** ". Это должно быть значение по умолчанию. Если это не так, убедитесь, что установлена **Операционная система** **Windows** , как описано выше.
5. Щелкните **Проверка и создание**. Вы увидите баннер, **прошедший проверку**на прочтение.
6. Нажмите кнопку **Создать**. Создание группы ресурсов может занять несколько минут.

На этом этапе убедитесь, что ваша группа ресурсов (**спичечоботтуториал-ResourceGroup**) имеет два ресурса:

| Имя | Тип  | Location |
|------|-------|----------|
| Спичечоботтуториал — AppServicePlan | План обслуживания приложения | западная часть США |
| Спичечоботтуториал — речь | Cognitive Services | западная часть США |

## <a name="build-an-echo-bot"></a>Создание эхо-робота

Теперь, когда вы создали некоторые ресурсы, давайте создадим робот. Мы начнем с образца Echo Bot, который, как следует из названия, отображает текст, введенный в качестве ответа. Не беспокойтесь, пример кода готов к использованию без каких-либо изменений. Он настроен для работы с каналом голосовых речевых операций, который мы будем подключать после развертывания программы-робота в Azure.

> [!NOTE]
> Приведенные ниже инструкции, а также дополнительные сведения о программе Echo Bot доступны в [файле сведений примера на сайте GitHub](https://github.com/microsoft/BotBuilder-Samples/blob/master/samples/csharp_dotnetcore/02.echo-bot/README.md).

### <a name="run-the-bot-sample-on-your-machine"></a>Запуск примера программы Bot на компьютере

1. Клонировать репозиторий примеров:

   ```bash
   git clone https://github.com/Microsoft/botbuilder-samples.git
   ```

2. Запустите Visual Studio.
3. На панели инструментов выберите **файл** > **Открыть** > **проект/решение**и откройте решение Echo Bot проекта:

   ```
   samples\csharp_dotnetcore\02.echo-bot\EchoBot.sln
   ```

4. После загрузки проекта нажмите клавишу <kbd>F5</kbd> , чтобы построить и запустить проект.
5. Браузер должен запуститься, и появится экран, похожий на этот.
    > [!div class="mx-imgBorder"]
    > [![ечобот — работает на локальном компьютере](media/tutorial-voice-enable-your-bot-speech-sdk/echobot-running-on-localhost.png "Ечобот, выполняемый на localhost")](media/tutorial-voice-enable-your-bot-speech-sdk/echobot-running-on-localhost.png#lightbox)

### <a name="test-the-bot-sample-with-the-bot-framework-emulator"></a>Тестирование образца Bot с помощью эмулятора Bot Framework

[Эмулятор Bot](https://github.com/microsoft/botframework-emulator) — это классическое приложение, позволяющее Bot-разработчикам тестировать и отлаживать свои программы-роботы локально или удаленно через туннель. Эмулятор поддерживает ввод текста в качестве входных данных (а не голоса). Bot будет отвечать на текст. Выполните следующие действия, чтобы использовать эмулятор Bot-канала для проверки запуска эхо-робота на локальном компьютере с текстовым входом и выводом текста. После развертывания Bot в Azure мы протестируем его с голосовым входом и голосовым выходом.

1. Установка [эмулятора Bot Framework](https://github.com/Microsoft/BotFramework-Emulator/releases/latest) версии 4.3.0 или более поздней
2. Запустите эмулятор Bot Framework и откройте программу Bot:
   * **Файл** -> **Открыть Bot**.
3. Введите URL-адрес для Bot. Пример:

   ```
   http://localhost:3978/api/messages
   ```
   и нажмите кнопку "подключить".
4. Bot должен сразу greet вас с "Привет и Добро пожаловать!" . Введите любое текстовое сообщение и подтвердите получение ответа от программы-робота.
5. В этом случае обмен данными с экземпляром Echo Bot может выглядеть так: [ ![Bot-Framework-Emulator](media/tutorial-voice-enable-your-bot-speech-sdk/bot-framework-emulator.png "Эмулятор Bot Framework") .](media/tutorial-voice-enable-your-bot-speech-sdk/bot-framework-emulator.png#lightbox)

## <a name="deploy-your-bot-to-an-azure-app-service"></a>Развертывание программы Bot в службе приложений Azure

Следующим шагом является развертывание эхо-робота в Azure. Существует несколько способов развертывания программы-робота, но в этом учебнике мы рассмотрим публикацию непосредственно из Visual Studio.

> [!NOTE]
> Кроме того, программу-робот можно развернуть с помощью шаблонов [Azure CLI](https://docs.microsoft.com/azure/bot-service/bot-builder-deploy-az-cli) и [развертывания](https://github.com/microsoft/BotBuilder-Samples/tree/master/experimental/directline-speech/csharp_dotnetcore/02.echo-bot/DeploymentTemplates).

1. В Visual Studio откройте эхо-робот, настроенный для использования с прямым каналом речи:

   ```
   samples\csharp_dotnetcore\02.echo-bot\EchoBot.sln
   ```

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект **Ечобот** и выберите **Опубликовать...**
1. Откроется новое окно **Выбор целевого объекта публикации** .
1. Выберите **служба приложений** в области навигации **служб Azure** , выберите **создать**и нажмите кнопку **создать профиль**.
1. Когда появится окно **Создание службы приложений** :
   * Щелкните **Добавить учетную запись**и выполните вход с использованием учетных данных учетной записи Azure. Если вы уже вошли, выберите нужную учетную запись из раскрывающегося списка.
   * В качестве **имени приложения**необходимо ввести глобально уникальное имя для программы Bot. Это имя используется для создания уникального URL-адреса Bot. Будет заполнено значение по умолчанию, включая дату и время (например, "EchoBot20190805125647"). Для этого руководства можно использовать имя по умолчанию.
   * Для параметра **Подписка**установите значение **Бесплатная пробная версия** .
   * В качестве **группы ресурсов**выберите **спичечоботтуториал-ResourceGroup** .
   * Для **плана размещения**выберите **спичечоботтуториал-AppServicePlan** .
   * Для **Application Insights**оставьте **значение None (нет** ).
1. Нажмите кнопку **Создать**.
1. В Visual Studio должно отобразиться сообщение об успешном выполнении, которое выглядит следующим образом:

   ```
   Publish Succeeded.
   Web App was published successfully https://EchoBot20190805125647.azurewebsites.net/
   ```

1. Браузер по умолчанию должен открыть и отобразить страницу, которая читает: "ваш робот готов!".
1. На этом этапе проверьте группу ресурсов **спичечоботтуториал-ResourceGroup** в портал Azure и убедитесь в наличии трех ресурсов:

| Имя | Тип  | Location |
|------|-------|----------|
| EchoBot20190805125647 | Служба приложений | западная часть США |
| Спичечоботтуториал — AppServicePlan | План службы приложений | западная часть США |
| Спичечоботтуториал — речь | Cognitive Services | западная часть США |

## <a name="enable-web-sockets"></a>Включение протокола WebSocket

Необходимо внести небольшое изменение в конфигурацию, чтобы программа Bot могла обмениваться данными с каналом голосовой речи с помощью веб-сокетов. Чтобы включить веб-сокеты, выполните следующие действия.

1. Перейдите к [портал Azure](https://portal.azure.com)и найдите службу приложений. Ресурс должен называться похожим на **EchoBot20190805125647** (уникальное имя приложения).
2. В области навигации **служб Azure** в разделе **Параметры**щелкните **Конфигурация**.
3. Перейдите на вкладку **Общие параметры** .
4. Выберите переключатель для **веб-сокетов** и установите для него значение **вкл**.
5. Выберите команду **Сохранить**.

> [!TIP]
> Вы можете использовать элементы управления в верхней части страницы службы приложений Azure, чтобы прерывать или перезапускать службу. Это может быть полезным при устранении неполадок.

## <a name="create-a-channel-registration"></a>Создание регистрации канала

Теперь, когда вы создали службу приложений Azure для размещения программы Bot, следующим шагом является создание **регистрации каналов Bot**. Создание регистрации канала является необходимым условием для регистрации робота с каналами Bot-Framework, включая канал прямого перевода голоса.

> [!NOTE]
> Если вы хотите узнать больше о том, как программы-роботы использует каналы, см. статью [Подключение канала Bot к каналам](https://docs.microsoft.com/azure/bot-service/bot-service-manage-channels?view=azure-bot-service-4.0).


1. <a href="https://ms.portal.azure.com/#create/Microsoft.BotServiceConnectivityGalleryPackage" target="_blank">Создание регистрации каналов Azure Bot<span class="docon docon-navigate-external x-hidden-focus"></span></a>
2. Вам будет предложено ввести некоторые сведения:
   * В качестве **маркера Bot**введите **спичечоботтуториал-ботрегистратион**.
   * В качестве **подписки**выберите **Бесплатная пробная версия**.
   * В качестве **группы ресурсов**выберите **спичечоботтуториал-ResourceGroup**.
   * В качестве **расположения**выберите **Западная часть США**.
     * В качестве **ценовой**категории выберите **F0**.
     * В поле " **Конечная точка обмена сообщениями**" введите URL-адрес для веб – приложения с добавленным `/api/messages` путем к концу. Например, если глобально уникальное имя приложения было **EchoBot20190805125647**, ваша конечная точка обмена сообщениями будет: `https://EchoBot20190805125647.azurewebsites.net/api/messages/`.
     * Для **Application Insights**можно установить значение **Off**. Дополнительные сведения см. в статье [Bot Analytics](https://docs.microsoft.com/azure/bot-service/bot-service-manage-analytics?view=azure-bot-service-4.0).
     * Игнорировать **Автоматическое создание идентификатора приложения и пароля**.
5. В нижней части колонки **регистрации каналов Bot** щелкните **создать**.

На этом этапе проверьте группу ресурсов **спичечоботтуториал-ResourceGroup** в портал Azure. Теперь он должен показывать четыре ресурса:

| Имя | Тип  | Location |
|------|-------|----------|
| EchoBot20190805125647 | Служба приложений | западная часть США |
| Спичечоботтуториал — AppServicePlan | План службы приложений | западная часть США |
| Спичечоботтуториал — Ботрегистратион | Регистрация каналов Bot | глобальная |
| Спичечоботтуториал — речь | Cognitive Services | западная часть США |

> [!IMPORTANT]
> В ресурсе регистрации каналов Bot будет показан глобальный регион, даже если вы выбрали "Западная часть США". Это ожидаемое поведение.

## <a name="register-the-direct-line-speech-channel"></a>Регистрация канала речи прямой линии

Теперь пришло время зарегистрировать программу-робот с помощью канала голосовой речи прямой линии. Этот канал используется для создания подключения между программой Echo Bot и клиентским приложением, скомпилированным с помощью речевого пакета SDK.

1. Перейдите к ресурсу **спичечоботтуториал-ботрегистратион** в [портал Azure](https://portal.azure.com)и откройте его.
1. В области навигации **служб Azure** выберите **каналы**.
   * Найдите **дополнительные каналы**и щелкните **прямое распознавание речи**.
   * Просмотрите текст на странице " **Настройка прямого перевода строки**", а затем разверните раскрывающееся меню под названием "учетная запись службы".
   * Выберите созданный ранее ресурс речи (например, **спичечоботтуториал-Speech**) в меню, чтобы связать робот с ключом подписки на речь.
   * Выберите команду **Сохранить**.

1. На панели навигации по **управлению Bot** щелкните **Параметры**.
   * Установите флажок **включить конечную точку потоковой передачи**. Это необходимо для включения протокола связи, созданного на основе веб-сокетов между программой Bot и каналом голосовой речи прямой линии.
   * Выберите команду **Сохранить**.

> [!TIP]
> Дополнительные сведения см. в статье [Подключение программы-робота к прямой речи](https://docs.microsoft.com/azure/bot-service/bot-service-channel-connect-directlinespeech?view=azure-bot-service-4.0). На этой странице содержатся дополнительные сведения и известные проблемы.

## <a name="build-the-direct-line-speech-client"></a>Создание голосового клиента Direct Line

На этом шаге вы собираетесь создать клиентский речевой голос. Клиент — это приложение Windows Presentation Foundation (WPF) в C# , которое использует [речевой пакет SDK](https://docs.microsoft.com/azure/cognitive-services/speech-service/speech-sdk) для управления связью с программой-роботом с помощью канала голосовой речи Direct Line. Используйте его для взаимодействия с и тестирования ленты перед написанием пользовательского клиентского приложения.

Клиентское речевое сообщение имеет простой пользовательский интерфейс, позволяющий настроить подключение к Bot, просмотреть текстовую беседу, просмотреть действия Bot-платформы в формате JSON и отобразить адаптивные карты. Он также поддерживает использование пользовательских ключевых слов. Этот клиент будет использоваться для разговора с программой Bot и получения голосового ответа.

Прежде чем мы перейдем к, убедитесь, что микрофон и динамики включены и работают.

1. Перейдите в репозиторий GitHub для [клиента прямого перевода строки](https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/README.md).
2. Следуйте инструкциям, приведенным для клонирования репозитория, сборки проекта, настройки клиента и запуска клиента.
3. Нажмите кнопку **Повторное соединение** и убедитесь, что сообщение отображается **нажатием кнопки MIC, или введите, чтобы начать говорить с программой Bot**.
4. Давайте протестируем ее. Нажмите кнопку микрофон и говорите несколько слов на английском языке. Распознанный текст будет отображаться при диктовке. Когда речь закончится, Bot ответит на свой собственный голос, говорящий «Echo», за которым следует распознанные слова.
5. Можно также использовать текст для взаимодействия с Bot. Просто введите текст на нижней панели. 

### <a name="troubleshooting-errors-in-direct-line-speech-client"></a>Устранение ошибок в построчном клиенте голосовой речи

Если в главном окне приложения появляется сообщение об ошибке, используйте следующую таблицу для обнаружения и устранения ошибки:

| Ошибка | Что делать? |
|-------|----------------------|
|Ошибка Аусентикатионфаилуре: сбой обновления WebSocket с ошибкой проверки подлинности (401). Проверьте правильность ключа подписки (или маркера авторизации) и имя региона.| На странице Параметры приложения убедитесь, что вы правильно указали ключ подписки на речь и его регион.<br>Убедитесь, что ваш ключ речи и область ключей введены правильно. |
|Ошибка Коннектионфаилуре: подключение было закрыто удаленным узлом. Код ошибки: 1011. Сведения об ошибке: не удалось подключиться к Bot перед отправкой сообщения | Убедитесь, что [установлен флажок "включить конечную точку потоковой передачи"](#register-the-direct-line-speech-channel) и/или [переключаемые **веб-сокеты** ](#enable-web-sockets) .<br>Убедитесь, что служба приложений Azure запущена. Если это так, попробуйте перезапустить службу приложений.|
|Ошибка Коннектионфаилуре: подключение было закрыто удаленным узлом. Код ошибки: 1011. Сведения об ошибке: код состояния ответа не указывает на успешное выполнение: 500 (InternalServerError)| Ваш Bot указал нейронный голос [в поле](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#speak) выходного действия, но регион Azure, связанный с ключом подписки на речь, не поддерживает нейронные голоса. См. раздел [Стандартные и нейронные голоса](https://docs.microsoft.com/azure/cognitive-services/speech-service/regions#standard-and-neural-voices).|
|Ошибка Коннектионфаилуре: подключение было закрыто удаленным узлом. Код ошибки: 1000. Сведения об ошибке: превышение максимального времени простоя подключения к веб-сокету (> 300000 МС)| Это ожидаемая ошибка, когда подключение к каналу остается открытым и неактивным в течение более пяти минут. |

Если эта ошибка не устранена в таблице, см. раздел ["помощники для голоса": часто задаваемые вопросы](faq-voice-assistants.md).

### <a name="view-bot-activities"></a>Просмотр действий программы-робота

Каждый Bot отправляет и получает сообщения о **действиях** . В окне " **Журнал действий** " в разделе клиентское речевое взаимодействие вы увидите журналы с метками времени с каждым действием, полученным клиентом от Bot. Вы также можете просмотреть действия, отправленные клиентом в Bot с помощью метода [`DialogServiceConnector.SendActivityAsync`](https://docs.microsoft.com/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconnector.sendactivityasync) . При выборе элемента журнала отображаются сведения о связанном действии в формате JSON.

Ниже приведен пример JSON действия, полученного клиентом.

```json
{
    "attachments":[],
    "channelData":{
        "conversationalAiData":{
             "requestInfo":{
                 "interactionId":"8d5cb416-73c3-476b-95fd-9358cbfaebfa",
                 "version":"0.2"
             }
         }
    },
    "channelId":"directlinespeech",
    "conversation":{
        "id":"129ebffe-772b-47f0-9812-7c5bfd4aca79",
        "isGroup":false
    },
    "entities":[],
    "from":{
        "id":"SpeechEchoBotTutorial-BotRegistration"
    },
    "id":"89841b4d-46ce-42de-9960-4fe4070c70cc",
    "inputHint":"acceptingInput",
    "recipient":{
        "id":"129ebffe-772b-47f0-9812-7c5bfd4aca79|0000"
    },
    "replyToId":"67c823b4-4c7a-4828-9d6e-0b84fd052869",
    "serviceUrl":"urn:botframework:websocket:directlinespeech",
    "speak":"<speak version='1.0' xmlns='https://www.w3.org/2001/10/synthesis' xml:lang='en-US'><voice name='Microsoft Server Speech Text to Speech Voice (en-US, JessaRUS)'>Echo: Hello and welcome.</voice></speak>",
    "text":"Echo: Hello and welcome.",
    "timestamp":"2019-07-19T20:03:51.1939097Z",
    "type":"message"
}
```

Дополнительные сведения о возможностях, возвращаемых в выходных данных JSON, см. в разделе [поля в действии](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md). В рамках этого руководства вы можете сосредоточиться на [тексте](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#text) и [поговорить](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#speak) с полями.

### <a name="view-client-source-code-for-calls-to-the-speech-sdk"></a>Просмотр исходного кода клиента для вызовов пакета SDK для распознавания речи

Речевой клиент Direct Line использует пакет NuGet [Microsoft. CognitiveServices. Speech](https://www.nuget.org/packages/Microsoft.CognitiveServices.Speech/), который содержит РЕЧЕВОЙ пакет SDK. Хорошим местом для начала рассмотрения примера кода является метод Инитспичконнектор () в файле [`DLSpeechClient\MainWindow.xaml.cs`](https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/DLSpeechClient/MainWindow.xaml.cs), который создает эти два объекта SDK для речи:
- [`DialogServiceConfig`](https://docs.microsoft.com/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconfig) — для параметров конфигурации (например, ключ подписки на речь, регион ключа)
- [`DialogServiceConnector`](https://docs.microsoft.com/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconnector.-ctor) — управление подключением канала и событиями клиентской подписки для обработки распознанных речевых ответов и сообщений Bot.

## <a name="add-custom-keyword-activation"></a>Добавить активацию настраиваемого ключевого слова

Пакет SDK для распознавания речи поддерживает пользовательскую активацию ключевого слова. Как и в случае с "Привет, Кортана" для помощника Майкрософт, вы можете написать приложение, которое будет постоянно прослушивать ключевое слово по своему усмотрению. Помните, что ключевое слово может быть одиночным словом или словосочетанием из нескольких слов.

> [!NOTE]
> *Ключевое слово* Term часто используется с термином « *пробуждение слова*» и может отображаться и в документации Майкрософт.

Обнаружение ключевых слов выполняется в клиентском приложении. Если используется ключевое слово, то при обнаружении ключевого слова звук будет передаваться только в канал прямого перевода строки. Канал распознавания речи прямой линии включает компонент, именуемый *проверкой ключевого слова (КВВ)* , который выполняет более сложную обработку в облаке, чтобы убедиться, что выбранное ключевое слово находится в начале аудиопотока. Если проверка ключевых слов выполняется, канал будет взаимодействовать с Bot.

Выполните следующие действия, чтобы создать модель ключевых слов, настроить клиент прямого перевода речи для использования этой модели и, наконец, проверить ее с помощью программы Bot.

1. Выполните эти инструкции, чтобы [создать настраиваемое ключевое слово с помощью службы распознавания речи](https://docs.microsoft.com/azure/cognitive-services/speech-service/speech-devices-sdk-create-kws).
2. Распакуйте файл модели, скачанный на предыдущем шаге. Он должен называться для ключевого слова. Выполняется поиск файла с именем `kws.table`.
3. В клиентском речевом клиенте найдите меню **Параметры** (найдите значок шестеренки в правом верхнем углу). Выберите **путь к файлу модели** и введите полный путь к файлу `kws.table` из шага 2.
4. Убедитесь, что установлен флажок **включено**. Это сообщение должно появиться рядом с флажком: "будет прослушивать ключевое слово при следующем соединении". Если вы указали неправильный файл или недопустимый путь, появится сообщение об ошибке.
5. Введите **ключ подписки**на речь и **регион ключа подписки**, а затем нажмите кнопку **ОК** , чтобы закрыть меню **параметров** .
6. Нажмите кнопку **Повторное соединение**. Должно отобразиться сообщение: "новый диалог начал работать — тип, нажмите кнопку" микрофон "или скажите ключевое слово". Теперь приложение постоянно ожидает передачи данных.
7. Говорите любую фразу, которая начинается с ключевого слова. Например: " **{ваше ключевое слово}** , какое время это?". Не нужно приостанавливать после уттеринг ключевого слова. По завершении происходят две вещи:
   * Вы увидите транскрипцию того, что вы используете.
   * Вскоре после этого вы услышите ответ Bot
8. Продолжайте экспериментировать с тремя типами входных данных, которые поддерживает Bot:
   * Типизированный текст на нижней панели
   * Нажатие клавиши со значком микрофона и речи
   * Произнести фразу, которая начинается с ключевого слова

### <a name="view-the-source-code-that-enables-keyword"></a>Просмотр исходного кода, включающего ключевое слово

В исходном коде клиентского речевого клиента просмотрите эти файлы, чтобы просмотреть код, используемый для включения обнаружения ключевых слов:

1. [`DLSpeechClient\Models.cs`](https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/DLSpeechClient/Models.cs) включает вызов метода Speech SDK [`KeywordRecognitionModel.fromFile()`](https://docs.microsoft.com/javascript/api/microsoft-cognitiveservices-speech-sdk/keywordrecognitionmodel?view=azure-node-latest#fromfile-string-), который используется для создания экземпляра модели из локального файла на диске.
1. [`DLSpeechClient\MainWindow.xaml.cs`](https://github.com/Azure-Samples/Cognitive-Services-Direct-Line-Speech-Client/blob/master/DLSpeechClient/MainWindow.xaml.cs) включает вызов метода Speech SDK [`DialogServiceConnector.StartKeywordRecognitionAsync()`](https://docs.microsoft.com/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconnector.startkeywordrecognitionasync), который активирует непрерывное обнаружение ключевых слов.

## <a name="optional-change-the-language-and-bot-voice"></a>Используемых Изменение языка и Bot-голоса

Созданная программа-робот будет прослушивать и отвечать на английском языке с голосовым стандартом американского английского текста в речь. Однако вы не ограничены использованием английского языка или голоса по умолчанию. В этом разделе вы узнаете, как изменить язык, который будет прослушивать Bot и реагировать на него. Вы также узнаете, как выбрать другой голоса для этого языка.

### <a name="change-the-language"></a>Изменение языка

Вы можете выбрать один из языков, упомянутых в таблице преобразования [речи в текст](language-support.md#speech-to-text) . В приведенном ниже примере мы изменим язык на немецкий.

1. Откройте приложение "прямое распознавание речи", нажмите кнопку "Параметры" (значок с правом верхнего правого значка) и введите `de-de` в поле "язык" (это значение локали, указанное в таблице " [речь-текст](language-support.md#speech-to-text) "). Это задает распознавание речевого языка, переопределяя `en-us`по умолчанию. Это также указывает каналу прямого перевода строки на использование немецкого голоса по умолчанию для ответа Bot.
2. Закройте страницу параметры и нажмите кнопку повторного подключения, чтобы установить новое подключение к роботу Echo.
3. Нажмите кнопку микрофон и скажите фразу на немецком языке. Вы увидите распознанный текст и эхо-робот, отвечающий на немецком языке по умолчанию.

### <a name="change-the-default-bot-voice"></a>Изменение голоса для ленты по умолчанию

Выбор голоса для преобразования текста в речь и контроль произношения можно выполнить, если программа-робот задает ответ в виде [языка разметки речи](speech-synthesis-markup.md) (SSML) вместо простого текста. Программа Echo Bot не использует SSML, но можно легко изменить код, чтобы сделать это. В приведенном ниже примере мы добавим SSML к ответу эхо-робота, чтобы вместо розетки по умолчанию использовался немецкий Voice Стефан Apollo (папа). См. список [стандартных голосов](language-support.md#standard-voices) и [нейронных голосов](language-support.md#neural-voices) , поддерживаемых для вашего языка.

1. Начнем с открытия `samples\csharp_dotnetcore\02.echo-bot\echo-bot.cs`.
2. Нахождение следующих двух строк:
    ```csharp
    var replyText = $"Echo: {turnContext.Activity.Text}";
    await turnContext.SendActivityAsync(MessageFactory.Text(replyText, replyText), cancellationToken);
    ```
3. Замените их следующим:
    ```csharp
    var replyText = $"Echo: {turnContext.Activity.Text}";
    var replySpeak = @"<speak version='1.0' xmlns='https://www.w3.org/2001/10/synthesis' xml:lang='de-DE'>
                    <voice name='Microsoft Server Speech Text to Speech Voice (de-DE, Stefan, Apollo)'>" +
                    $"{replyText}" + "</voice></speak>";
    await turnContext.SendActivityAsync(MessageFactory.Text(replyText, replySpeak), cancellationToken);
    ```
4. Создайте решение в Visual Studio и исправьте все ошибки сборки.

Второй аргумент в методе ' Мессажефактори. Text ' задает [поле действия говорите](https://github.com/Microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#speak) в ответе Bot. При приведенном выше изменении он был заменен простым текстом на SSML для указания немецкого голоса по умолчанию.

### <a name="redeploy-your-bot"></a>Повторное развертывание программы-робота

Теперь, когда вы внесли необходимые изменения в Bot, следующим шагом является повторная публикация в службе приложений Azure и пробная работа:

1. В окне обозреватель решений щелкните правой кнопкой мыши проект **ечобот** и выберите **Publish (опубликовать**).
2. Предыдущая конфигурация развертывания уже загружена по умолчанию. Просто щелкните **Publish (опубликовать** ) рядом с **EchoBot20190805125647-веб-развертывание**.
3. В окне вывода Visual Studio появится сообщение « **Публикация завершена** », и откроется веб-страница с сообщением «ваш робот готов!».
4. Откройте приложение "прямое распознавание речи", нажмите кнопку параметров (значок с правом верхнего правого значка) и убедитесь, что в поле язык по-прежнему есть `de-de`.
5. Следуйте инструкциям в разделе [Создание почтового клиента с прямым распознаванием](#build-the-direct-line-speech-client) для повторного подключения к вновь развернутому роботу, говорите на новом языке и поговорите о том, что на этом языке я говорю о новом голосе.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не собираетесь продолжать использовать Echo-Bot, развернутые в этом руководстве, вы можете удалить его и все связанные с ним ресурсы Azure, просто удалив группу ресурсов Azure **спичечоботтуториал-ResourceGroup**.

1. В [портал Azure](https://portal.azure.com)щелкните **группы ресурсов** в области навигации **служб Azure** .
2. Найдите группу ресурсов с именем: **спичечоботтуториал-ResourceGroup**. Щелкните три точки (...).
3. Выберите **Удалить группу ресурсов**.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Создание собственного клиентского приложения с помощью пакета SDK для распознавания речи](quickstart-voice-assistant-csharp-uwp.md)

## <a name="see-also"></a>См. также раздел

* Развертывание в [регионе Azure рядом с вами](https://azure.microsoft.com/global-infrastructure/locations/) , чтобы увидеть улучшение времени ответа Bot
* Развертывание в [регионе Azure, поддерживающем высококачественные голосовые нейроны TTS](https://docs.microsoft.com/azure/cognitive-services/speech-service/regions#standard-and-neural-voices)
* Цены, связанные с прямым каналом голосового перевода строки:
  * [Расценки службы ботов](https://azure.microsoft.com/pricing/details/bot-service/)
  * [Служба распознавания речи](https://azure.microsoft.com/pricing/details/cognitive-services/speech-services/)
* Создание и развертывание собственного робота с поддержкой голоса:
  * Создание [робота Bot-Framework](https://dev.botframework.com/). Зарегистрируйте его с помощью прямого голосового [канала](https://docs.microsoft.com/azure/bot-service/bot-service-channel-connect-directlinespeech?view=azure-bot-service-4.0) и [Настройте робот для голосовой связи](https://docs.microsoft.com/azure/bot-service/directline-speech-bot?view=azure-bot-service-4.0)
  * Знакомство с существующими [решениями для Bot-Framework](https://microsoft.github.io/botframework-solutions/index): создание [виртуального помощника](https://microsoft.github.io/botframework-solutions/overview/virtual-assistant-solution/) и [расширение его для перевода речи в прямые строки](https://microsoft.github.io/botframework-solutions/clients-and-channels/tutorials/enable-speech/1-intro/)
