---
title: 'Azure ExpressRoute: Проектирование для аварийного восстановления'
description: Эта страница содержит архитектурные рекомендации для аварийного восстановления при использовании Azure ExpressRoute.
services: expressroute
author: rambk
ms.service: expressroute
ms.topic: article
ms.date: 05/25/2019
ms.author: rambala
ms.openlocfilehash: 726a014983c0da959d72b7976fef2ebb2c6e9b9e
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74076701"
---
# <a name="designing-for-disaster-recovery-with-expressroute-private-peering"></a>Проектирование для аварийного восстановления с помощью приватного пиринга ExpressRoute

ExpressRoute предназначен для высокой доступности для обеспечения частного подключения к сети оператора для ресурсов Майкрософт. Другими словами, в сети Microsoft нет ни одной точки сбоя в маршруте ExpressRoute. Для проектных соображений, чтобы максимизировать доступность схемы ExpressRoute, [см. Проектирование для высокой доступности с ExpressRoute][HA].

Однако, принимая популярную пословица Мерфи -*если что-то может пойти не так, это будет*--в-в-в рассмотрении, в этой статье давайте сосредоточимся на решениях, которые выходят за рамки неудач, которые могут быть решены с помощью одной схемы ExpressRoute. Другими словами, в этой статье давайте рассмотрим соображения архитектуры сети для создания надежного бэкэнд-сетевого подключения для аварийного восстановления с использованием гео-излишних схем ExpressRoute.

## <a name="need-for-redundant-connectivity-solution"></a>Потребность в избыточном решении подключения

Есть возможности и случаи, когда вся региональная служба (будь то Microsoft, поставщики сетевых услуг, клиент или другие поставщики облачных услуг) деградирует. Коренной причиной такого широкого спектра воздействия на услуги в регионе являются стихийные бедствия. Поэтому для непрерывности бизнеса и критически важных приложений для миссии важно планировать аварийное восстановление.   

Независимо от того, запускаемые ли вы критически важные приложения миссии в регионе Azure или в помещениях или где-либо еще, вы можете использовать другой регион Azure в качестве сайта для отказа. Следующие статьи рассматриваются аварийного восстановления из приложений и перспектив доступа фронт-энда:

- [Аварийное восстановление корпоративного масштаба][Enterprise DR]
- [Аварийное восстановление для малого и среднего бизнеса с помощью Azure Site Recovery][SMB DR]

Если вы полагаетесь на подключение ExpressRoute между вашей мобильной сетью и корпорацией Майкрософт для критически важных операций, ваш план аварийного восстановления должен также включать гео-излишним подключением к сети. 

## <a name="challenges-of-using-multiple-expressroute-circuits"></a>Проблемы использования нескольких схем ExpressRoute

При подключении одного и того же набора сетей с использованием нескольких соединений вводятся параллельные пути между сетями. Параллельные пути, когда не были должным образом отнесены к архитектуре, могут привести к асимметричной маршрутизированию. Если в пути есть объекты состояния (например, NAT, брандмауэр), асимметричная маршрутизирующая маршрутизирующая система может блокировать поток трафика.  Как правило, по частному пути вглядывания ExpressRoute вы не столкнетесь с объектами, накоторых объектов- статей, таких как NAT или Firewalls. Таким образом, асимметричная маршрутизирующая маршрутизм через приватное пиринг ExpressRoute не обязательно блокирует транспортный поток.
 
Однако, если вы загружаете трафик баланса через гео-излишние параллельные пути, независимо от того, есть ли у вас объекты с состоянием или нет, вы столкнетесь с несогласованной производительностью сети. В этой статье давайте обсудим, как решить эти проблемы.

## <a name="small-to-medium-on-premises-network-considerations"></a>Малые и средние соображения сети

Рассмотрим пример сети, иллюстрированный на следующей диаграмме. В этом примере гео-излишнее подключения ExpressRoute устанавливается между локальным местоположением Contoso и VNet Contoso в регионе Azure. На диаграмме твердая зеленая линия указывает предпочтительный путь (через ExpressRoute 1), а пунктирная — резервный путь (через ExpressRoute 2).

[![1]][1]

При проектировании подключения ExpressRoute для аварийного восстановления необходимо учитывать:

- с помощью гео-избыточных схем ExpressRoute
- используя разнообразную сеть поставщиков услуг (ы) для различных схем ExpressRoute
- проектирование каждой из схем ExpressRoute для [высокой доступности][HA]
- прекращение работы различных схем ExpressRoute в другом месте в клиентской сети

По умолчанию, если вы рекламируете маршруты одинаково по всем маршрутам ExpressRoute, Azure будет загружать-балансировать на предпосылках связанный трафик через все пути ExpressRoute с помощью маршрутизатора с несколькими путями равной стоимости (ECMP).

Однако с геоизлишними схемами ExpressRoute нам необходимо учитывать различные сетевые представления с различными сетевыми путями (особенно для задержки сети). Чтобы получить более последовательную производительность сети во время нормальной работы, вы можете предпочесть схему ExpressRoute, которая предлагает минимальную задержку.

Вы можете повлиять на Azure, чтобы предпочесть одну схему ExpressRoute по сравнению с другой, используя один из следующих методов (перечисленных в порядке эффективности):

- реклама более специфического маршрута по предпочтительной схеме ExpressRoute по сравнению с другими схемами ExpressRoute (ы)
- настройка более высокого веса соединения на соединение, которое связывает виртуальную сеть с предпочтительной схемой ExpressRoute
- реклама маршрутов по менее предпочтительной схеме ExpressRoute с более длинным AS Path (AS Path prepend)

### <a name="more-specific-route"></a>Более конкретный маршрут

Следующая диаграмма иллюстрирует влияние выбора траектории ExpressRoute с использованием более конкретной рекламы маршрута. В иллюстрированном примере, Contoso на-предпосылки /24 IP диапазон рекламируется как два /25 адрес диапазонов через предпочтительный путь (ExpressRoute 1) и как /24 через резервный путь (ExpressRoute 2).

[![2]][2]

Поскольку /25 более специфичен, по сравнению с /24, Azure отправит трафик, предназначенный для 10.1.11.0/24 через ExpressRoute 1 в нормальном состоянии. Если оба соединения ExpressRoute 1 пойти вниз, то VNet увидит рекламу трассы 10.1.11.0/24 только через ExpressRoute 2; и поэтому в этом состоянии сбоя используется схема ожидания.

### <a name="connection-weight"></a>Вес подключения

Следующий скриншот иллюстрирует настройку веса соединения ExpressRoute через портал Azure.

[![3]][3]

Следующая диаграмма иллюстрирует влияние выбора траектории ExpressRoute с использованием веса соединения. Вес соединения по умолчанию расшатывая значение 0. В приведенном ниже примере вес соединения для ExpressRoute 1 настроен как 100. Когда VNet получает приставку маршрута, рекламируемую через более чем одну схему ExpressRoute, VNet предпочитает соединение с наибольшим весом.

[![4]][4]

Если оба соединения ExpressRoute 1 пойти вниз, то VNet увидит рекламу трассы 10.1.11.0/24 только через ExpressRoute 2; и поэтому в этом состоянии сбоя используется схема ожидания.

### <a name="as-path-prepend"></a>AS предещение пути

Следующая диаграмма иллюстрирует влияние на выбор траектории ExpressRoute с помощью подготовки пути AS. На диаграмме реклама маршрута через ExpressRoute 1 указывает на поведение eBGP по умолчанию. На маршруте рекламы через ExpressRoute 2, на территории сети ASN дополнительно готовится на пути AS маршрута маршрута. Когда один и тот же маршрут получен через несколько схем ExpressRoute, в процессе выбора маршрута eBGP, VNet предпочел бы маршрут с кратчайшим as-маршрутом. 

[![5]][5]

Если оба соединения ExpressRoute 1 пойти вниз, то VNet увидит рекламу маршрута 10.1.11.0/24 только через ExpressRoute 2. В конечном счете, чем дольше путь AS станет неуместным. Таким образом, в этом состоянии сбоя будет использоваться схема ожидания.

Используя любой из методов, если вы влияете на Azure, чтобы отчесть один из ваших ExpressRoute по сравнению с другими, необходимо также обеспечить, чтобы припредтечная сеть также предпочитала тот же путь ExpressRoute для трафика, связанного с Azure, чтобы избежать асимметричных потоков. Как правило, значение локальных предпочтений используется для влияния локальной сети, чтобы отдавать предпочтение одной схеме ExpressRoute по сравнению с другими. Локальные предпочтения — это внутренняя метрика BGP (iBGP). Предпочтительным является маршрут BGP с самым высоким значением местных предпочтений.

> [!IMPORTANT]
> При использовании определенных схем ExpressRoute в качестве резервных, необходимо активно управлять ими и периодически тестировать сбой операции. 
> 

## <a name="large-distributed-enterprise-network"></a>Большая распределенная корпоративная сеть

Если у вас есть большая распределенная корпоративная сеть, вы, вероятно, имеете несколько схем ExpressRoute. В этом разделе давайте посмотрим, как проектировать аварийное восстановление с помощью активно активных схем ExpressRoute, без дополнительных резервных схем. 

Рассмотрим пример, иллюстрированный на следующей диаграмме. В этом примере Contoso имеет два места, связанные с двумя развертываниями Contoso IaaS в двух разных регионах Azure через схемы ExpressRoute в двух разных местах. 

[![6]][6]

Как мы архитектор аварийного восстановления влияет на то, как пересекают региональный пересечь местоположение (регион1/регион2 к location2/location1) трафик направляется. Рассмотрим две различные архитектуры стихийных бедствий, которые по-разному пересекают трафик по местоположению в регионе.

### <a name="scenario-1"></a>Сценарий 1

В первом сценарии давайте спроектируем аварийное восстановление таким образом, чтобы весь трафик между областью Azure и локальной сетью проходил через локальную схему ExpressRoute в стабильном состоянии. Если локальная схема ExpressRoute выходит из строя, то для всех транспортных потоков между Azure и локальной сетью используется дистанционная схема ExpressRoute.

Сценарий 1 проиллюстрирован на следующей диаграмме. На диаграмме зеленые линии указывают пути движения между VNet1 и натерритории сетей. Синие линии указывают пути движения между VNet2 и наемными сетями. Твердые линии указывают желаемый путь в устойчивом состоянии, а разбитые линии указывают траекторию движения в отказе соответствующей схемы ExpressRoute, которая несет устойчивый поток трафика. 

[![7]][7]

Вы можете поговожть сценарий, используя вес соединения, чтобы влиять на VNets, чтобы предпочесть подключение к локальному местоположению ExpressRoute для локального сетевого трафика. Чтобы завершить решение, необходимо обеспечить симметричный обратный транспортный поток. Вы можете использовать локальные предпочтения на сессии iBGP между маршрутизаторами BGP (на которых схемы ExpressRoute прекращаются на локальной стороне), чтобы предпочесть схему ExpressRoute. Решение проиллюстрировано на следующей диаграмме. 

[![8]][8]

### <a name="scenario-2"></a>Сценарий 2

Сценарий 2 проиллюстрирован на следующей диаграмме. На диаграмме зеленые линии указывают пути движения между VNet1 и натерритории сетей. Синие линии указывают пути движения между VNet2 и наемными сетями. В устойчивом состоянии (твердые линии на диаграмме) весь трафик между VNets и местами на местах протекает через магистраль Microsoft по большей части и проходит через присоединение между местами предварительного помещения только в состоянии сбоя (пунктирные линии в диаграмма) ExpressRoute.

[![9]][9]

Решение проиллюстрировано на следующей диаграмме. Как показано на примере проиллюстрировано, можно создать сценарий либо с помощью более конкретного маршрута (Option 1), либо для подготовки AS-пути (Option 2), чтобы повлиять на выбор пути VNet. Чтобы повлиять на выбор локальных сетевых маршрутов для трафика, связанного с Azure, необходимо настроить соединение между локальным местоположением как менее предпочтительное. Howe вы настраиваете ссылку на присоединение как предпочтительное зависит от протокола разгрома, используемого в сети. Вы можете использовать локальные предпочтения с iBGP или метрику с IGP (OSPF или IS-IS).

[![10]][10]


## <a name="next-steps"></a>Дальнейшие действия

В этой статье мы обсудили, как разработать для аварийного восстановления схемы ExpressRoute частных пиринговых подключения. Следующие статьи рассматриваются аварийного восстановления из приложений и перспектив доступа фронт-энда:

- [Аварийное восстановление корпоративного масштаба][Enterprise DR]
- [Аварийное восстановление для малого и среднего бизнеса с помощью Azure Site Recovery][SMB DR]

<!--Image References-->
[1]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/one-region.png "соображения сети малого и среднего размера"
[2]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/specificroute.png "Влияние выбора пути с использованием более конкретных маршрутов"
[3]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/configure-weight.png "настройка веса соединения через портал Azure"
[4]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/connectionweight.png "Влияющий выбор пути с использованием веса соединения"
[5]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/aspath.png "Влияющий выбор пути с помощью подготовки пути AS"
[6]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region.png "крупных распределенных вопросов о сети"
[7]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-arch1.png "сценарий 1"
[8]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-sol1.png "активно активных схем ExpressRoute решение 1"
[9]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-arch2.png "сценарий 2"
[10]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-sol2.png "активно активных схем ExpressRoute решение 2"

<!--Link References-->
[HA]: https://docs.microsoft.com/azure/expressroute/designing-for-high-availability-with-expressroute
[Enterprise DR]: https://azure.microsoft.com/solutions/architecture/disaster-recovery-enterprise-scale-dr/
[SMB DR]: https://azure.microsoft.com/solutions/architecture/disaster-recovery-smb-azure-site-recovery/
[con wgt]: https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing#solution-assign-a-high-weight-to-local-connection
[AS Path Pre]: https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing#solution-use-as-path-prepending





