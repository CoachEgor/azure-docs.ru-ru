---
title: Разработка для аварийного восстановления с помощью Azure ExpressRoute | Документация Майкрософт
description: Эта страница предоставляет архитектурные рекомендации для аварийного восстановления при использовании Azure ExpressRoute.
documentationcenter: na
services: networking
author: rambk
manager: tracsman
ms.service: expressroute
ms.topic: article
ms.workload: infrastructure-services
ms.date: 05/25/2019
ms.author: rambala
ms.openlocfilehash: cf2b4e385de901254fde3c3d3e807feda98d5b41
ms.sourcegitcommit: c63e5031aed4992d5adf45639addcef07c166224
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/28/2019
ms.locfileid: "67466072"
---
# <a name="designing-for-disaster-recovery-with-expressroute-private-peering"></a>Разработка для аварийного восстановления с частным пирингом ExpressRoute

ExpressRoute предназначен для обеспечения высокой доступности для обеспечения корпоративного класса подключения к частной сети к ресурсам Microsoft перевозчика. Другими словами является единственной точки сбоя в путь ExpressRoute сети корпорации Майкрософт. Рекомендации по проектированию для достижения максимальной доступности канала ExpressRoute, см. в разделе [проектирование для обеспечения высокой доступности с помощью ExpressRoute][HA].

Тем не менее, выполнив его Мерфи популярных старая поговорка--*Если что-то может пойти не так, он будет*--во внимание, в этой статье позволит нам сосредоточиться на решениях, которые выходят за рамки сбоев, которые можно устранить, используя один канал ExpressRoute. Другими словами в этой статье обратимся к вопросу в аспекты архитектуры сети для создания надежной серверной части сети для аварийного восстановления с использованием геоизбыточного каналов ExpressRoute.

## <a name="need-for-redundant-connectivity-solution"></a>Требуется решение избыточные возможности подключения

Существуют возможности и экземплярах, где получает Деградация всей региональной службе (будь то, что корпорации Microsoft, сети поставщиков услуг, клиента или других поставщиков облачных служб). Основную причину такого влияния региональная служба широкий включают стихийного бедствия. Таким образом для обеспечения непрерывности и критически важных приложений важно составить план аварийного восстановления.   

Независимо от того, при выполнении вашего критически важных приложений в регионе Azure или локально, или любом другом месте можно использовать другой регион Azure как сайт отработки отказа. Следующие статьи адреса аварийного восстановления из приложений и перспективы доступа внешнего интерфейса:

- [Аварийное восстановление корпоративного масштаба][Enterprise DR]
- [SMB аварийного восстановления с помощью Azure Site Recovery][SMB DR]

Если вы используете expressroute между локальной сетью и Майкрософт для критически важных операций, ваш план аварийного восстановления следует также включить геоизбыточное сетевое подключение. 

## <a name="challenges-of-using-multiple-expressroute-circuits"></a>Проблем использования нескольких каналов ExpressRoute

Когда вы соединения тот же набор сетей с помощью более одного соединения, которые вы вводите параллельных путей между сетями. Параллельные пути, если неправильно архитектурой, может привести к асимметричной маршрутизации. Если в пути с отслеживанием состояния сущностей (например, NAT, брандмауэром), асимметричной маршрутизации может заблокировать поток трафика.  Как правило по пути частного пиринга ExpressRoute вы не столкнетесь с отслеживанием состояния сущности, такие как NAT или брандмауэром. Таким образом асимметричной маршрутизации через частный пиринг ExpressRoute не блокирует обязательно поток трафика.
 
Тем не менее если распределять нагрузку трафика в географически избыточная параллельных путей, независимо от наличия с отслеживанием состояния сущностей или нет, будет испытывать производительность несогласованные сети. В этой статье давайте рассмотрим как решать эти проблемы.

## <a name="small-to-medium-on-premises-network-considerations"></a>Небольших и рекомендации относительно среднего размера в локальной сети

Давайте рассмотрим пример сети, показано на следующей схеме. В примере геоизбыточное ExpressRoute подключение устанавливается между компании Contoso между локальным расположением и виртуальной сети компании Contoso в регионе Azure. На диаграмме щелкните сплошной зеленой линией Указывает предпочтительный путь (с помощью ExpressRoute 1) и точками один представляет путь ожидания (с помощью ExpressRoute 2).

[![1]][1]

При создании подключения ExpressRoute для аварийного восстановления, вы должны учесть следующее.

- с помощью геоизбыточного каналов ExpressRoute
- с помощью различных служб поставщика сети для различных канала ExpressRoute
- Проектирование каждого канала ExpressRoute для [высокого уровня доступности][HA]
- Завершение другой канал ExpressRoute в другом расположении в сети клиента

По умолчанию Если вы объявляете маршруты одинаково по всем путям ExpressRoute, Azure будет балансировки нагрузки трафика локальных привязки для всех путей ExpressRoute, с помощью маршрутизации Equal-cost многопутевых (ECMP).

Тем не менее с-геоизбыточное хранилище с каналами ExpressRoute необходимо принимать во внимание другую сеть производительность с использованием различных сетевых путей (особенно для задержки в сети). Чтобы получить более надежной работы сети во время обычной работы, может потребоваться использовать канал ExpressRoute, которая предлагает минимальной задержкой.

Azure для одного канала ExpressRoute по возможности отдавайте предпочтение еще один, с помощью одного из следующих способов (перечисленные в порядке эффективности), можно изменить:

- объявление конкретные маршруты через основной канал ExpressRoute, по сравнению с другими каналы ExpressRoute
- Настройка высокий вес подключения для подключения, ссылающейся на предпочтительный канал ExpressRoute виртуальной сети
- объявление маршрутов через менее предпочтительный канал ExpressRoute с более длинный путь AS (как в начале пути)

### <a name="more-specific-route"></a>Конкретные маршруты

На следующей схеме показано взаимодействие выбора пути ExpressRoute, с использованием более конкретные объявление маршрута. В приведенный пример Contoso локальной/24 диапазон IP-адресов объявляется как диапазоны адресов два /25 с помощью предпочтительного пути (ExpressRoute 1) и как диапазоном/24 через путь ожидания (ExpressRoute 2).

[![2]][2]

Поскольку /25 является более точным, по сравнению с диапазоном/24, Azure будет отправлять трафик, предназначенный для 10.1.11.0/24 через ExpressRoute 1 в обычном состоянии. Если оба соединения ExpressRoute 1 вышли из строя, виртуальной сети будет см. объявление маршрута 10.1.11.0/24 только через ExpressRoute 2. и поэтому ожидания канала используется в этом состоянии сбоя.

### <a name="connection-weight"></a>Веса подключения

На следующем снимке экрана показано, вес подключение ExpressRoute с помощью портала Azure.

[![3]][3]

На следующей схеме показано взаимодействие выбора пути ExpressRoute, с использованием вес подключения. Вес подключения по умолчанию — 0. В приведенном ниже примере вес подключения для ExpressRoute 1 будет настроена как 100. Если виртуальная сеть получит префикс маршрута, объявляемые с помощью более чем одного канала ExpressRoute, виртуальной сети будет предпочитать подключение с максимальным весом.

[![4]][4]

Если оба соединения ExpressRoute 1 вышли из строя, виртуальной сети будет см. объявление маршрута 10.1.11.0/24 только через ExpressRoute 2. и поэтому ожидания канала используется в этом состоянии сбоя.

### <a name="as-path-prepend"></a>КАК добавить в начало

На следующей схеме показано взаимодействие Выделение контура ExpressRoute, с помощью, как добавить в начало пути. На схеме объявление маршрута по ExpressRoute 1 указывает eBGP по умолчанию. На объявление маршрута по ExpressRoute 2 ASN в локальной сети добавляется Кроме того на маршруте, как путь. При получении через несколько каналов ExpressRoute, в процесс выбора маршрута eBGP, тот же маршрут виртуальной сети предпочли бы маршрут с кратчайшего пути. 

[![5]][5]

Если подключения ExpressRoute 1 вышли из строя, виртуальной сети будет отображено объявление маршрута 10.1.11.0/24 только через ExpressRoute 2. Следовательно тем больше времени, как путь стал бы не имеет значения. Таким образом резервный канала будет использоваться в этом состоянии сбоя.

С помощью любого метода, если влияют Azure использовать один из ExpressRoute по сравнению с другими, также необходимо убедиться в локальной сети также предпочитать один и тот же путь ExpressRoute для трафика во избежание асимметричного потоки, привязанного к Azure. Как правило значение локального предпочтения используется на локальной сети к предпочитали один канал ExpressRoute по сравнению с другими. Значения локального предпочтения — внутренняя метрика BGP (iBGP). Маршрут BGP с наибольшего значения локального предпочтения является предпочтительным.

> [!IMPORTANT]
> При использовании определенных каналов ExpressRoute в качестве резервного, необходимо обеспечить эффективное управление ими и периодическим тестированием операции отработки отказа. 
> 

## <a name="large-distributed-enterprise-network"></a>Большой распределенной корпоративной сети

При наличии большой распределенной корпоративной сети, вы скорее всего, использовать несколько каналов ExpressRoute. В этом разделе описано давайте посмотрим, как спроектировать аварийного восстановления с использованием активных каналов ExpressRoute, без необходимости дополнительных ждущий каналов. 

Давайте рассмотрим пример показан на следующей схеме. В примере Contoso имеет два локальных расположений, подключенных к два развертывания Contoso IaaS в двух разных регионах Azure с помощью каналов ExpressRoute в двух разных местах пиринга. 

[![6]][6]

Как мы создать архитектуру аварийного восстановления влияет на кросс-региональные пересекать расположение (Регион1/область2 для размещение2/location1) маршрутизацией трафика. Давайте рассмотрим два разных аварийного архитектур, направляет трафик между расположение области по-разному.

### <a name="scenario-1"></a>Сценарий 1

В первом сценарии давайте создадим аварийного восстановления, таким образом, что весь трафик между регионе и в локальной сети Azure проходил через локальный канал ExpressRoute в устойчивом состоянии. В случае сбоя локальным каналом ExpressRoute затем удаленный канал ExpressRoute используется для всех потоков трафика между Azure и локальной сети.

Сценарий 1 проиллюстрирован на следующей схеме. На схеме зеленые линии обозначают пути для потока трафика между сетями VNet1 и локальных. Синие линии обозначают пути для потока трафика между VNet2 и локальными сетями. Сплошными линиями показаны необходимого пути в устойчивом состоянии и пунктирные линии указывают путь трафика со сбоем соответствующий канал ExpressRoute, передающий поток трафика устойчивого состояния. 

[![7]][7]

Можно разработать с помощью вес подключения, чтобы повлиять предпочитаете подключения в локальное расположение пиринга ExpressRoute для локальной сети трафик виртуальных сетей. Для завершения решения, необходимо обеспечить симметричное обратный трафик. Можно использовать значения локального предпочтения в сеансе iBGP между вашими маршрутизаторами BGP (на которых каналов ExpressRoute, завершаются на локальной стороне) использовать канал ExpressRoute. На следующей схеме показано решение. 

[![8]][8]

### <a name="scenario-2"></a>Сценарий 2

Сценарий 2 проиллюстрирован на следующей схеме. На схеме зеленые линии обозначают пути для потока трафика между сетями VNet1 и локальных. Синие линии обозначают пути для потока трафика между VNet2 и локальными сетями. В устойчивом состоянии (сплошные линии на диаграмме) все проходят через магистраль Майкрософт, по большей части трафика между виртуальными сетями и локальными расположениями и проходит через взаимодействие между локальными расположениями только в состоянии сбоя (пунктирные линии в схема) из канала ExpressRoute.

[![9]][9]

На следующей схеме показано решение. Как было показано, можно разработать сценария, либо с помощью более конкретные route (вариант 1) или AS path в начале (вариант 2) влияют на Выбор пути к виртуальной сети. Чтобы повлиять на выбор маршрута в локальной сети для привязанного трафика Azure, необходимо настроить взаимодействие между локальным расположением как менее предпочтительным. Настроить эти инструменты ссылку как более предпочтительным, чем Хау зависит от маршрутизации протокола, используемого в локальной сети. Можно использовать значения локального предпочтения с iBGP или метрики с помощью IGP (OSPF или IS-IS).

[![10]][10]


## <a name="next-steps"></a>Дальнейшие действия

В этой статье мы рассмотрели, как разрабатывать приложения для аварийного восстановления канала частного пиринга соединения ExpressRoute. Следующие статьи адреса аварийного восстановления из приложений и перспективы доступа внешнего интерфейса:

- [Аварийное восстановление корпоративного масштаба][Enterprise DR]
- [SMB аварийного восстановления с помощью Azure Site Recovery][SMB DR]

<!--Image References-->
[1]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/one-region.png "небольшого и среднего размера в локальной сети рекомендации"
[2]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/specificroute.png "влияние выбора пути, с использованием более определенных маршрутов"
[3]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/configure-weight.png "настройки веса подключения с помощью портала Azure"
[4]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/connectionweight.png "влияние выбора пути, с использованием веса подключения"
[5]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/aspath.png "влияющих на Выбор пути, используя в качестве пути спереди"
[6]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region.png "больших распределенных с локальной сетью вопросы"
[7]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-arch1.png "сценарий 1"
[8]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-sol1.png "ExpressRoute активных каналов решение 1"
[9]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-arch2.png "сценарий 2"
[10]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-sol2.png "ExpressRoute активных каналов решение 2"

<!--Link References-->
[HA]: https://docs.microsoft.com/azure/expressroute/designing-for-high-availability-with-expressroute
[Enterprise DR]: https://azure.microsoft.com/solutions/architecture/disaster-recovery-enterprise-scale-dr/
[SMB DR]: https://azure.microsoft.com/solutions/architecture/disaster-recovery-smb-azure-site-recovery/
[con wgt]: https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing#solution-assign-a-high-weight-to-local-connection
[AS Path Pre]: https://docs.microsoft.com/azure/expressroute/expressroute-optimize-routing#solution-use-as-path-prepending





