---
title: 'Устранение неполадок сетевого канала: Azure'
description: Эта страница содержит сведения о стандартном методе тестирования производительности сетевого соединения Azure.
services: expressroute
author: tracsman
ms.service: expressroute
ms.topic: article
ms.date: 12/20/2017
ms.author: jonor
ms.custom: seodec18
ms.openlocfilehash: bb68919fba731caa32dcca3f4c991b8881afc6f9
ms.sourcegitcommit: 9405aad7e39efbd8fef6d0a3c8988c6bf8de94eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "74869652"
---
# <a name="troubleshooting-network-performance"></a>Устранение проблем с производительностью сети
## <a name="overview"></a>Краткое описание
Azure предоставляет стабильные и быстрые способы подключения вашей локальной сети к Azure. Небольшие и крупные компании успешно используют такие методы, как VPN-подключение "сеть — сеть" и ExpressRoute, для ведения бизнеса в Azure. Но что происходит, когда производительность не соответствует вашим ожиданиям или прежним показателям? Этот документ поможет стандартизировать методы тестирования и настроить общую конфигурацию конкретной среды.

Здесь показано, как можно с легкостью тестировать задержку и пропускную способность сети между двумя узлами. Здесь также содержатся некоторые советы о том, как анализировать сеть Azure и определить проблемные точки. Для рассматриваемых скрипта PowerShell и средств требуется наличие двух узлов в сети (на обоих концах тестируемого соединения). Один узел должен быть Windows Server или рабочим столом, другой может быть Windows или Linux. 

>[!NOTE]
>Используемые подход к устранению неполадок, инструменты и методы зависят от личных предпочтений. В этом документе описывается подход и инструменты, которые я часто использую. Вы можете использовать собственный подход к решению проблем. Тем не менее если у вас нет установленного подхода, этот документ может помочь вам сформировать собственные методы и определить нужные инструменты для устранения неполадок сети.
>
>

## <a name="network-components"></a>Сетевые компоненты
Прежде чем углубиться в устранение неполадок, рассмотрим некоторые общие понятия и компоненты. Мы упомянем каждый компонент в сквозной цепочке, которая обеспечивает возможность подключения в Azure.
![1][1]

На высшем уровне описывается три основных домена сетевой маршрутизации:

- сеть Azure (синее облако справа);
- Интернет или глобальная сеть (зеленое облако в центре);
- корпоративная сеть (персиковое облако слева).

Кратко рассмотрим каждый компонент на схеме, идя справа налево.
 - **Виртуальная машина.** Сервер может иметь несколько сетевых адаптеров, чтобы статические маршруты, маршруты по умолчанию и параметры операционной системы отправляли и получали трафик требуемым образом. Кроме того, каждый номер SKU виртуальной машины имеет ограничение пропускной способности. Если вы используете меньший номер SKU виртуальной машины, трафик ограничивается пропускной способностью, доступной в сетевом адаптере. Обычно я использую DS5v2 для тестирования (после чего удаляю эту виртуальную машину для экономии средств), чтобы обеспечить достаточную пропускную способность на виртуальной машине.
 - **Сетевой адаптер.** Убедитесь, что вы знаете частный IP-адрес, назначенный сетевому адаптеру.
 - **Группы безопасности сети, примененные к сетевому адаптеру.** На уровне сетевого адаптера могут применяться конкретные группы безопасности сети (NSG). Убедитесь, что набор правил группы безопасности сети подходит для передаваемого трафика. Например, убедитесь, что порты 5201 для iPerf, 3389 для RDP или 22 для SSH открыты для прохождения тестового трафика.
 - **Подсеть виртуальной сети.** Сетевой адаптер назначается конкретной подсети. Вам нужно знать, какой подсети и какие правила с ней связаны.
 - **Группа безопасности сети для подсети**. Аналогично сетевым адаптерам группы безопасности сети также могут применяться к подсети. Убедитесь, что набор правил группы безопасности сети подходит для передаваемого трафика. (Для трафика, входящего в сетевой адаптер, сначала применяется NSG подсети, затем NSG сетевого адаптера и наоборот, для трафика, исходящего от виртуальной машины, сначала применяется NSG сетевого адаптера, а затем NSG подсети.)
 - **Определяемый пользователем маршрут подсети.** Определяемые пользователем маршруты могут направлять трафик к промежуточному прыжку (брандмауэр или балансировщик нагрузки). Если определяемые пользователем маршруты настроены, убедитесь, что знаете, куда направляется трафик и каким будет следующий прыжок (например, брандмауэр может передавать некоторый трафик и запрещать другой трафик между двумя узлами).
 - **Определяемый пользователем маршрут или NSG подсети шлюза.** Так же как подсеть виртуальной машины, подсеть шлюза может иметь группы безопасности сети и определяемые пользователем маршруты. Убедитесь, что вы знаете об их наличии и о том, как они влияют на ваш трафик.
 - **Шлюз виртуальной сети (ExpressRoute).** При использовании пиринга (ExpressRoute) или включения VPN не многие параметры могут повлиять на маршрутизацию трафика. Если к одному и тому же шлюзу виртуальной сети подключено несколько каналов ExpressRoute или VPN-туннелей, вы должны знать настройки веса подключения, так как этот параметр влияет на настройки подключения и на путь прохождения трафика.
 - **Фильтр маршрутов** (не показан). Фильтр маршрутов применяется только к пирингу Майкрософт в ExpressRoute, но его следует проверить, если вы не видите ожидаемые маршруты в пиринге Майкрософт. 

Мы дошли к части глобальной сети соединения. Этим доменом маршрутизации может быть поставщик услуг, глобальная корпоративная сеть или Интернет. Многие прыжки, технологии и компании, связанные с этими соединениями, могут затруднить устранение неполадок. Зачастую сначала следует исключить Azure и ваши корпоративные сети, прежде чем переходить к компаниям и прыжкам.

На предыдущей схеме слева находится ваша корпоративная сеть. В зависимости от размера вашей компании этот домен маршрутизации может быть представлен несколькими сетевыми устройствами между вами и глобальной сетью или несколькими уровнями устройств в сети корпуса или предприятия.

Учитывая сложности этих различных сетевых сред высокого уровня, часто бывает целесообразно начинать с краев и попытаться выявить, где производительность хорошая, а где — плохая. Этот подход может помочь выявить проблемный домен маршрутизации, чтобы сосредоточить внимание на конкретной среде.

## <a name="tools"></a>Средства
Большинство проблем сети можно проанализировать и изолировать с помощью базовых средств, таких как проверка связи и трассировка маршрута. В редких случаях придется выполнить анализ пакетов с помощью анализатора трафика, например Wireshark. Чтобы помочь в поиске и устранении неисправностей, был разработан набор средств подключения Azure (AzureCT), содержащий некоторые из этих средств. Для тестирования производительности я предпочитаю использовать iPerf и PSPing. iPerf — это часто используемое средство, которое работает в большинстве операционных систем. Средство iPerf хорошо подходит для базовых тестов производительности и довольно простое в использовании. PSPing — это средство проверки связи, разработанное компанией SysInternals. Оно позволяет легко проверять связь через ICMP и TCP с помощью простой команды. Это упрощенные средства, которые легко установить, скопировав файлы в каталог на узле.

Я упаковал эти средства и методы в модуль PowerShell (AzureCT), который вы можете установить и использовать.

### <a name="azurect---the-azure-connectivity-toolkit"></a>AzureCT — набор средств подключения Azure
Модуль AzureCT PowerShell содержит два компонента: [тестирование доступности][Availability Doc] и [Тестирование производительности][Performance Doc]. В этом документе рассматривается только тестирование производительности, поэтому сосредоточимся на двух командах производительности соединения в этом модуле PowerShell.

Для использования этого набора средств для тестирования производительности следует выполнить три шага: 1) установить модуль PowerShell; 2) установить вспомогательные приложения iPerf и PSPing; 3) выполнить тест производительности.

1. Установите модуль PowerShell.

    ```powershell
    (new-object Net.WebClient).DownloadString("https://aka.ms/AzureCT") | Invoke-Expression
    
    ```

    Эта команда загружает модуль PowerShell и устанавливает его локально.

2. Установите вспомогательные приложения.
    ```powershell
    Install-LinkPerformance
    ```
    Эта команда AzureCT устанавливает iPerf и PSPing в новый каталог "C:\ACTTools", а также открывает порты брандмауэра Windows, чтобы разрешить трафик по протоколу ICMP через порт 5201 (iPerf).

3. Запустите тест производительности.

    Во-первых, на удаленном узле необходимо установить и запустить iPerf в режиме сервера. Убедитесь, что удаленный хост прослушивает порт 3389 (протокол удаленного рабочего стола для Windows) либо порт 22 (SSH для Linux) и разрешает трафик через порт 5201 для iPerf. Если удаленный узел работает под управлением Windows, установите AzureCT и запустите команду Install-LinkPerformance, чтобы настроить iPerf и правила брандмауэра, необходимые для успешного запуска iPerf в режиме сервера. 
    
    После подготовки удаленного компьютера откройте PowerShell на локальном компьютере и запустите тестирование:
    ```powershell
    Get-LinkPerformance -RemoteHost 10.0.0.1 -TestSeconds 10
    ```

    Эта команда выполняет серию параллельных нагрузочных тестов и тестов задержки, чтобы оценить пропускную способность и задержку вашего сетевого соединения.

4. Просмотрите результаты тестирования.

    Формат выходных данных PowerShell выглядит примерно так:

    ![4..][4]

    Подробные результаты всех тестов iPerf и PSPing находятся в отдельных текстовых файлах в каталоге средств AzureCT в пути "C:\ACTTools".

## <a name="troubleshooting"></a>Устранение неисправностей
Если тест производительности не дает ожидаемых результатов, следует применить прогрессивный пошаговый процесс. Учитывая количество компонентов подключения, систематический подход, как правило, позволяет быстрее решить проблему, чем бесполезное многократное тестирование.

>[!NOTE]
>Рассматриваемый сценарий решает проблему с производительностью, а не проблему с подключением. Шаги будут отличаться, если передача трафика не происходит.
>
>

Во-первых, следует проверить правильность своих предположений. Целесообразны ли ваши ожидания? Например, если у вас есть канал ExpressRoute с пропускной способностью 1 Гбит/с и задержкой 100 мс, необоснованно ожидать полной нагрузки такого канала с учетом характеристик производительности TCP по соединениям с высокой задержкой. Дополнительные сведения касательно предположений о производительности см. в разделе [Справка](#references).

Далее рекомендуется начать с конечных точек между доменами маршрутизации и попытаться связать проблему с одним крупным доменом маршрутизации, корпоративной сетью, глобальной сетью или сетью Azure. Люди часто винят принцип "черного ящика", что может значительно отсрочить решение проблемы, особенно если она на самом деле касается области, в которую вы можете вносить изменения. Перед обращением к поставщику услуг или интернет-провайдеру убедитесь, что вы выполнили комплексную проверку.

Как только вы определили основной домен маршрутизации, с которым, как вы считаете, возникла проблема, составьте схему соответствующей области. Создайте подробный план действий на доске, в блокноте, либо в Visio, чтобы реализовать систематический подход для поиска источника проблемы. Вы можете запланировать тестовые точки и обновлять карту по мере выполнения тестирования.

Теперь, когда у вас есть схема, разделите сеть на сегменты, чтобы сузить область поиска проблемы. Проверьте, в которых из сегментов присутствуют и отсутствуют проблемы. Продолжайте перемещаться по тестовым точкам, чтобы определить проблемный компонент.

Кроме того, не забудьте проверить другие уровни модели OSI. Вы можете сразу сосредоточиться на сети и уровнях 1–3 (физический уровень, уровень данных и уровень сети), но проблемы также могут быть на уровне 7 на уровне приложений. Будьте непредвзяты и проверяйте любые предположения.

## <a name="advanced-expressroute-troubleshooting"></a>Расширенное устранение проблем с ExpressRoute
Если вы не знаете, где на самом деле находится граничная точка облака, это может усложнить изолирование компонентов Azure. При использовании ExpressRoute граничной точкой является сетевой компонент Microsoft Enterprise Edge (MSEE). **В этом случае** это первая точка контакта в сети Майкрософт и последний прыжок при выходе из сети Майкрософт. Когда вы создаете объект подключения между шлюзом виртуальной сети и каналом ExpressRoute, вы фактически подключаетесь к MSEE. Для изоляции проблем с сетью Azure важно рассматривать MSEE в качестве первого или последнего прыжка (в зависимости от направления), чтобы убедиться, что проблема заключается в Azure или связана с глобальной или корпоративной сетью. 

![2][2]

>[!NOTE]
> Обратите внимание, что MSEE не находится в облаке Azure. ExpressRoute фактически находится в граничной части сети Майкрософт, а не в Azure. После установления соединения с MSEE через ExpressRoute вы будете подключены к сети Майкрософт, оттуда вы сможете перейти к любой из облачных служб, например Office 365 (с пирингом Майкрософт) или Azure (с помощью частного пиринга или пиринга Майкрософт).
>
>

Если две виртуальные сети (сети A и B на схеме) подключены к **одному** каналу ExpressRoute, вы можете выполнить ряд тестов, чтобы определить, что проблема связана с Azure (или наоборот доказать обратное).
 
### <a name="test-plan"></a>План тестирования
1. Запустите тест Get-LinkPerformance между ВМ1 и ВМ2. Этот тест помогает определить, является ли проблема локальной. Если результаты теста показывают приемлемые задержку и пропускную способность, вы можете отметить локальную виртуальную сеть как работоспособную.
2. При условии, что в виртуальной локальной сети трафик проходит без проблем, запустите тест Get-LinkPerformance между ВМ1 и ВМ3. Этот тест проверяет подключение через сеть Майкрософт к MSEE и обратно в Azure. Если результаты теста показывают приемлемые задержку и пропускную способность, вы можете отметить сеть Azure как работоспособную.
3. После исключения Azure вы можете выполнить аналогичную последовательность тестов в вашей корпоративной сети. Если тестирование прошло успешно, пора обратиться к поставщику услуг или интернет-провайдеру для диагностики вашего подключения к глобальной сети. Пример. Выполните этот тест между двумя филиалами или вашим компьютером и сервером центра обработки данных. В зависимости от того, что вы тестируете, найдите конечные точки (серверы, ПК и т. д.), которые могут использовать этот путь.

>[!IMPORTANT]
> Для каждого теста нужно отмечать время его запуска и записывать результаты, например, в OneNote или Excel. Каждый тестовый запуск должен иметь идентичные выходные данные, чтобы вы могли сравнивать их результаты без "пробелов" в данных. Согласованность нескольких тестов является основной причиной, по которой рекомендуется использовать AzureCT для устранения неполадок. Суть не в точных сценариях нагрузки. Она *заключается в том*, что *тесты и выходные данные* согласованы каждый раз. Сведения о времени выполнения и согласованные данные всех тестов особенно полезны, если позже вы обнаружите, что проблема является спорадической. Будьте внимательны и собирайте данные с самого начала, чтобы избежать повторного тестирования тех же сценариев.
>
>

## <a name="the-problem-is-isolated-now-what"></a>Область возникновения проблемы обнаружена, что делать дальше?
Чем больше вы сузили область возникновения проблемы, тем легче ее исправить. При этом часто бывает, что вы не можете продвинуться в поиске. Пример. Вы видите соединение с вашим поставщиком услуг, который выполняет скачок через Европу, но ожидаемый путь находится в Азии. В таком случае вы должны обратиться за помощью. К кому обратиться, зависит от домена маршрутизации, в котором находится проблема, а лучше всего сузить ее до определенного компонента.

В случае проблем с корпоративной сетью ваш внутренний ИТ-отдел или поставщик услуг, поддерживающий вашу сеть (который может быть производителем оборудования), может помочь в настройке устройства или ремонте оборудования.

В случае проблем с глобальной сетью следует передать результаты тестирования поставщику услуг или интернет-провайдеру, чтобы им не пришлось выполнять рутинное тестирование, которое вы уже выполнили. Однако отнеситесь с пониманием к ситуации, если они захотят сами проверить результаты вашего тестирования. "Доверяй, но проверяй" — это хороший девиз при устранении неполадок на основе результатов других людей.

После того как вы разрешаете эту неполадку в Azure, вы можете ознакомиться с [документацией по сети Azure][Network Docs] , а затем, если все еще нужно, [открыть запрос в службу поддержки][Ticket Link].

## <a name="references"></a>Справочники
### <a name="latencybandwidth-expectations"></a>Ожидания задержки и пропускной способности
>[!TIP]
> Задержка, связанная с географическим расположением (мили или километры) между конечными точками, которые вы тестируете, на сегодняшний день является самой значительной. Хотя существует также задержка, связанная с оборудованием, (физические и виртуальные компоненты, количество прыжков и т. д.), географическая составляющаяся является самой существенной частью задержки при работе с подключениями к глобальной сети. Важно отметить, что расстояние соответствует протяженности оптоволоконной линии, а не расстоянию по прямой или на дорожной карте. Это расстояние невероятно сложно точно рассчитать. В результате я обычно использую калькулятор расстояния в Интернете. Конечно, этот метод не предоставляет точных показателей, но этого достаточно, чтобы получить общее представление.
>
>

Я использую расположение ExpressRoute — Сиэтл, штат Вашингтон в США. В приведенной ниже таблице показаны показатели задержки и пропускной способности, полученные в результате тестирования подключения в различных расположениях Azure. Я рассчитал географическое расстояние между каждым граничным объектом теста.

Настройка тестирования:
 - Физический сервер под управлением Windows Server 2016 с сетевым адаптером 10 Гбит/с, подключенный к каналу ExpressRoute.
 - Канал ExpressRoute уровня "Премиум" с пропускной способностью 10 Гбит/с в расположении с частным пирингом.
 - Виртуальная сеть Azure со шлюзом UltraPerformance в указанном регионе.
 - Виртуальная машина DS5v2, работающая под управлением Windows Server 2016 в виртуальной сети. Не присоединенная к домену виртуальная машина, созданная на основе образа Azure по умолчанию (без оптимизации или настройки), с установленным AzureCT.
 - Во всех тестах использовалась команда AzureCT Get-LinkPerformance с 5-минутным нагрузочным тестом для каждого из шести тестовых запусков. Пример.

    ```powershell
    Get-LinkPerformance -RemoteHost 10.0.0.1 -TestSeconds 300
    ```
 - Поток данных для каждого теста имел нагрузку, исходящую от локального физического сервера (клиент iPerf в Сиэтле) к виртуальной машине Azure (сервер iPerf в указанном регионе Azure).
 - Данные столбца "Задержка" взяты из теста "Без нагрузки" (тест задержки TCP без запуска iPerf).
 - Данные столбца "Максимальная пропускная способность" взяты из 16-го теста нагрузки потока данных TCP с размером окна 1 МБ.

![3][3]

### <a name="latencybandwidth-results"></a>Результаты задержки и пропускной способности
>[!IMPORTANT]
> Эти данные предназначены только для общего ознакомления. Многие факторы влияют на задержку, и, хотя эти значения в целом согласуются с течением времени, условия в пределах Azure или сети поставщиков услуг могут отправлять трафик по разным каналам, что может повлиять на задержку и пропускную способность. Как правило, последствия этих изменений не приводят к существенным различиям.
>
>

| | | | | | |
|-|-|-|-|-|-|
|ExpressRoute<br/>Location|Azure<br/>Регион|Приблизительно<br/>Расстояние (км)|Задержка|Сеанс 1<br/>Пропускная способность|Максимальная<br/>Пропускная способность|
| Сиэтл; | Западная часть США 2        |    191 км |   5 мс | 262 Мбит/с |  3,74 Гбит/с |
| Сиэтл; | Западная часть США          |  1,094 км |  18 мс |  82,3 Мбит/с |  3,70 Гбит/с |
| Сиэтл; | Центральная часть США       |  2,357 км |  40 мс |  38,8 Мбит/с |  2,55 Гбит/с |
| Сиэтл; | Центрально-южная часть США |  2,877 км |  51 мс |  30,6 Мбит/с |  2,49 Гбит/с |
| Сиэтл; | Центрально-северная часть США |  2,792 км |  55 мс |  27,7 Мбит/с |  2,19 Гбит/с |
| Сиэтл; | Восточная часть США 2        |  3,769 км |  73 мс |  21,3 Мбит/с |  1,79 Гбит/с |
| Сиэтл; | Восточная часть США          |  3,699 км |  74 мс |  21,1 Мбит/с |  1,78 Гбит/с |
| Сиэтл; | Восточная Япония       |  7,705 км | 106 мс |  14,6 Мбит/с |  1,22 Гбит/с |
| Сиэтл; | Южная часть Соединенного Королевства         |  7,708 км | 146 мс |  10,6 Мбит/с |   896 Мбит/с |
| Сиэтл; | Западная Европа      |  7,834 км | 153 мс |  10,2 Мбит/с |   761 Мбит/с |
| Сиэтл; | Восточная Австралия   | 12,484 км | 165 мс |   9,4 Мбит/с |   794 Мбит/с |
| Сиэтл; | Юго-Восточная Азия   | 12,989 км | 170 мс |   9,2 Мбит/с |   756 Мбит/с |
| Сиэтл; | Южная Бразилия*   | 10,930 км | 189 мс |   8,2 Мбит/с |   699 Мбит/с |
| Сиэтл; | Южная Индия      | 12,918 км | 202 мс |   7,7 Мбит/с |   634 Мбит/с |

\* Задержка передачи данных в Бразилию является хорошим примером того, что прямолинейное расстояние значительно отличается от расстояния протяженности оптоволоконной линии. Я ожидал, что задержка будет примерно 160 мс, а на самом деле она составляет 189 мс. Это отличие может указывать на проблему с сетью, но, скорее всего, сетевая магистраль от Сиэтла до Бразилии не проложена по прямой линии и длиннее прямого расстояния на 1000 км.

## <a name="next-steps"></a>Дальнейшие действия
1. Скачайте набор средств подключения Azure из GitHub по адресу [https://aka.ms/AzCT][ACT]
2. Следуйте инструкциям по [тестированию производительности канала][Performance Doc] .

<!--Image References-->
[1]: ./media/expressroute-troubleshooting-network-performance/network-components.png "Сетевые компоненты Azure"
[2]: ./media/expressroute-troubleshooting-network-performance/expressroute-troubleshooting.png "Устранение неполадок ExpressRoute"
[3]: ./media/expressroute-troubleshooting-network-performance/test-diagram.png "Тестовая среда тестирования производительности"
[4]: ./media/expressroute-troubleshooting-network-performance/powershell-output.png "Выходные данные PowerShell"

<!--Link References-->
[Performance Doc]: https://github.com/Azure/NetworkMonitoring/blob/master/AzureCT/PerformanceTesting.md
[Availability Doc]: https://github.com/Azure/NetworkMonitoring/blob/master/AzureCT/AvailabilityTesting.md
[Network Docs]: https://docs.microsoft.com/azure/index
[Ticket Link]: https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview
[ACT]: https://aka.ms/AzCT
