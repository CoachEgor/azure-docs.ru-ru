---
title: 'Требования ExpressRoute к маршрутизации: Azure | Документация Майкрософт'
description: На этой странице подробно описаны требования по настройке маршрутизации для каналов ExpressRoute и управлению этой маршрутизацией.
services: expressroute
author: ganesr
ms.service: expressroute
ms.topic: conceptual
ms.date: 01/11/2019
ms.author: ganesr
ms.custom: seodec18
ms.openlocfilehash: 9a4b99e311a65435595c9cb0455b0411b7c09324
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60883119"
---
# <a name="expressroute-routing-requirements"></a>Требования ExpressRoute к маршрутизации
Для подключения к облачным службам Майкрософт с помощью ExpressRoute необходимо настроить маршрутизацию и управлять ею. Некоторые поставщики услуг подключения предлагают настройку маршрутизации как управляемой службы и управление этой службой. Узнайте у поставщика услуг подключения, предоставляет ли он такую услугу. В противном случае необходимо выполнить требования, указанные ниже:

Описание сеансов маршрутизации, которые необходимо настроить для установки подключения, см. в статье [Каналы ExpressRoute и домены маршрутизации](expressroute-circuit-peerings.md).

> [!NOTE]
> Майкрософт не поддерживает применение протоколов избыточности маршрутизаторов (например, HSRP, VRRP) в конфигурациях высокой доступности. Для обеспечения высокой доступности мы используем избыточную пару сеансов BGP на каждый пиринг.
> 
> 

## <a name="ip-addresses-used-for-peerings"></a>IP-адреса для пирингов
Для настройки маршрутизации между сетью и концевыми маршрутизаторами Microsoft Enterprise (MSEE) необходимо зарезервировать несколько блоков IP-адресов. В этом разделе приводится список требований и описание правил получения и использования этих IP-адресов.

### <a name="ip-addresses-used-for-azure-private-peering"></a>IP-адреса для частного пиринга Azure
Для настройки пиринга можно использовать либо частные, либо общедоступные IP-адреса. Диапазон адресов, используемых для настройки маршрутов, не должен пересекаться с диапазонами адресов, используемых для создания виртуальных сетей в Azure. 

* Для маршрутизации интерфейсов необходимо зарезервировать подсеть /29 или две подсети /30.
* В качестве используемых подсетей можно использовать либо частные, либо общедоступные IP-адреса.
* Подсети не должны конфликтовать с диапазоном, зарезервированным клиентом для использования в облаке Майкрософт.
* Если используется подсеть /29, ее можно разбить на две подсети /30. 
  * Первая подсеть /30 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
  * Для каждой из подсетей /30 необходимо передать в маршрутизатор первый IP-адрес подсети /30. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /30.
  * [Заявленная в соглашении об уровне обслуживания доступность](https://azure.microsoft.com/support/legal/sla/) гарантируется, если настроены оба сеанса BGP.  

#### <a name="example-for-private-peering"></a>Пример для частного пиринга
Если вы решите использовать для настройки пиринга подсеть a.b.c.d/29, она будет разделена на две подсети /30. В следующем примере обратите внимание, как используется подсеть a.b.c.d/29.

* Подсеть a.b.c.d/29 будет разбита на подсети a.b.c.d/30 и a.b.c.d+4/30 и передана в Майкрософт путем подготовки API.
  * Подсеть a.b.c.d+1 будет использоваться как IP-адрес VRF для основного PE, а Майкрософт будет использовать подсеть a.b.c.d+2 как IP-адрес VRF для основного MSEE.
  * Подсеть a.b.c.d+5 будет использоваться как IP-адрес VRF для дополнительного PE, а Майкрософт будет использовать подсеть a.b.c.d+6 как IP-адрес VRF для дополнительного MSEE.

Допустим, вы выбрали подсеть 192.168.100.128/29 для настройки частного пиринга. Подсеть 192.168.100.128/29 включает адреса с 192.168.100.128 по 192.168.100.135, причем:

* Подсеть 192.168.100.128/30 назначается связи link1, поставщик услуг подключения использует адрес 192.168.100.129, а Майкрософт — адрес 192.168.100.130.
* Подсеть 192.168.100.132/30 назначается связи link2, поставщик услуг подключения использует адрес 192.168.100.133, а Майкрософт — адрес 192.168.100.134.

### <a name="ip-addresses-used-for-microsoft-peering"></a>IP-адреса, используемые для пиринга Майкрософт
Для настройки сеансов BGP используйте принадлежащие вам общедоступные IP-адреса. У Майкрософт должна быть возможность проверить владельца IP-адреса по региональному интернет-реестру или интернет-реестру маршрутизации.

* С помощью IP-адресов, указанных на портале для объявленных общедоступных префиксов для пиринга Майкрософт, создаются списки ACL для основных маршрутизаторов Microsoft, чтобы разрешить входящий трафик с этих IP-адресов. 
* При настройке сеансов BGP для каждого пиринга в канале ExpressRoute (если их несколько) необходимо использовать уникальную подсеть /29 (IPv4) или /125 (IPv6) либо две подсети /30 (IPv4) или /126 (IPv6).
* Если используется подсеть /29, ее можно разбить на две подсети /30.
* Первая подсеть /30 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
* Для каждой из подсетей /30 необходимо передать в маршрутизатор первый IP-адрес подсети /30. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /30.
* Если используется подсеть /125, ее можно разбить на две подсети /126.
* Первая подсеть /126 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
* Для каждой из подсетей /126 необходимо передать в маршрутизатор первый IP-адрес подсети /126. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /126.
* [Заявленная в соглашении об уровне обслуживания доступность](https://azure.microsoft.com/support/legal/sla/) гарантируется, если настроены оба сеанса BGP.

### <a name="ip-addresses-used-for-azure-public-peering"></a>IP-адреса для общедоступного пиринга Azure

> [!NOTE]
> Общедоступный пиринг Azure недоступен для новых каналов.
> 

Для настройки сеансов BGP используйте принадлежащие вам общедоступные IP-адреса. У Майкрософт должна быть возможность проверить владельца IP-адреса по региональному интернет-реестру или интернет-реестру маршрутизации. 

* При настройке сеансов BGP для каждого пиринга в канале ExpressRoute (если их несколько) необходимо использовать уникальную подсеть /29 или две подсети /30. 
* Если используется подсеть /29, ее можно разбить на две подсети /30. 
  * Первая подсеть /30 используется в качестве основной ссылки, а вторая — в качестве дополнительной.
  * Для каждой из подсетей /30 необходимо передать в маршрутизатор первый IP-адрес подсети /30. Для настройки сеанса BGP Майкрософт использует второй IP-адрес подсети /30.
  * [Заявленная в соглашении об уровне обслуживания доступность](https://azure.microsoft.com/support/legal/sla/) гарантируется, если настроены оба сеанса BGP.

## <a name="public-ip-address-requirement"></a>Использование общедоступного IP-адреса

### <a name="private-peering"></a>Частный пиринг
Для частного пиринга можно использовать как частные, так и общедоступные адреса IPv4. Мы обеспечиваем сквозную изоляцию трафика, поэтому в случае частного пиринга перекрытие адресов другими клиентами исключено. Такие адреса не объявляются в Интернете. 

### <a name="microsoft-peering"></a>Пиринг Майкрософт
Путь пиринга Майкрософт позволяет подключаться к облачным службам Майкрософт. В список этих служб входят службы Office 365, такие как Exchange Online, SharePoint Online, Skype для бизнеса и Dynamics 365. Корпорация Майкрософт поддерживает двустороннее подключение через пиринг Майкрософт. Входящий трафик облачных служб Майкрософт перед попаданием в сеть Майкрософт должен пройти через действительные общедоступные IPv4-адреса.

Убедитесь, что ваш IP-адрес и число AS зарегистрированы на ваше имя в одном из следующих реестров:

* [ARIN](https://www.arin.net/)
* [APNIC](https://www.apnic.net/)
* [AFRINIC](https://www.afrinic.net/)
* [LACNIC](https://www.lacnic.net/)
* [RIPENCC](https://www.ripe.net/)
* [RADB](https://www.radb.net/)
* [ALTDB](https://altdb.net/)

Если префиксы и номер AS не присвоены вам в предыдущих реестрах, нужно отправить запрос в службу поддержки, чтобы специалисты вручную проверили ваши префиксы и ASN. Им потребуется документация, такая как письмо проверки подлинности, которое доказывает, что вам разрешено использовать ресурсы.

Частный номер AS разрешен с пирингом Майкрософт, однако также потребуется проверка вручную. Кроме того, для полученных префиксов частные номера AS в атрибуте AS PATH удаляются. Вследствие этого вы не можете добавлять частные номера AS в атрибут AS PATH, чтобы [управлять маршрутизацией пиринга Майкрософт](expressroute-optimize-routing.md). 

> [!IMPORTANT]
> Не объявляйте одни и те же общедоступные IP-адреса маршрута в Интернете и через ExpressRoute. Чтобы снизить риск неправильной конфигурации, которая приводит к асимметричной маршрутизации, мы настоятельно рекомендуем, чтобы [IP-адреса NAT](expressroute-nat.md), объявленные для Майкрософт через ExpressRoute, были из диапазона, который вообще не объявляется в Интернете. Если этого нельзя добиться, то очень важно убедиться, что вы объявляете более конкретный диапазон через ExpressRoute чем тот, который объявлен в Интернете. Кроме общедоступного маршрута для NAT, вы также можете объявить через ExpressRoute общедоступные IP-адреса, которые используются сетевыми серверами, взаимодействующими с конечными точками Office 365 в корпорации Майкрософт. 
> 
> 

### <a name="public-peering-deprecated---not-available-for-new-circuits"></a>Общедоступный пиринг (устарел и больше не доступен для новых каналов)
Путь общедоступного пиринга Azure позволяет подключаться ко всем службам, размещенным в Azure, по их открытым IP-адресам. Сюда входят службы, перечисленные в статье [Вопросы и ответы по ExpessRoute](expressroute-faqs.md), а также все службы, размещенные независимыми поставщиками программного обеспечения в Microsoft Azure. Подключение к службам Microsoft Azure через общедоступный пиринг всегда осуществляется от локальной сети к сети Microsoft. Необходимо использовать общедоступные IP-адреса для трафика, предназначенного для сети Microsoft.

> [!IMPORTANT]
> Все службы Azure PaaS доступны через пиринг Майкрософт.
>   

Частный номер AS разрешен с общедоступным пирингом.

## <a name="dynamic-route-exchange"></a>Динамический обмен маршрутами
Обмен маршрутами осуществляется по протоколу eBGP. Сеансы EBGP устанавливаются между MSEEs и вашими маршрутизаторами. Проверка подлинности сеансов BGP не требуется. При необходимости можно настроить MD5-хэш. Сведения о настройке сеансов BGP приведены в статьях [Создание и изменение маршрутизации для канала ExpressRoute](how-to-routefilter-portal.md) и [Процедуры ExpressRoute для подготовки каналов и состояний каналов](expressroute-workflows.md).

## <a name="autonomous-system-numbers"></a>Номера автономных систем (AS)
Майкрософт использует AS 12076 для общедоступного и частного пиринга Azure, а также пиринга Майкрософт. Номера AS с 65515 по 65520 зарезервированы для внутреннего использования. Поддерживаются 16- и 32-битные номера AS.

Требования к симметрии передачи данных не предъявляются. Прямые и обратные пути могут проходить по разным парам маршрутов. С каждой стороны в различных принадлежащих вам парах каналов должны быть объявлены идентичные маршруты. Метрики маршрута могут не совпадать.

## <a name="route-aggregation-and-prefix-limits"></a>Статистическая обработка маршрутов и ограничения префиксов
Мы поддерживаем до 4000 префиксов, объявляемых через частный пиринг Azure. При включении надстройки ExpressRoute Premium это число можно увеличить до 10 000 префиксов. Мы принимаем до 200 префиксов на сеанс BGP для общедоступного пиринга Azure и пиринга Майкрософт. 

Если количество префиксов превысит лимит, сеанс BGP будет сброшен. Маршруты по умолчанию принимаются только по связи частного пиринга. Поставщик должен отфильтровывать маршрут по умолчанию и частные IP-адреса (RFC 1918) от путей общедоступного пиринга Azure и пиринга Майкрософт. 

## <a name="transit-routing-and-cross-region-routing"></a>Транзитная и межрегиональная маршрутизация
ExpressRoute нельзя настроить как транзитный маршрутизатор. За услугами транзитной маршрутизации данных обращайтесь к поставщику услуг подключения.

## <a name="advertising-default-routes"></a>Объявление маршрутов по умолчанию
Маршруты по умолчанию разрешены только для сеансов частного пиринга Azure. В данном случае мы будем направлять весь трафик из связанных виртуальных сетей в вашу сеть. Объявление маршрутов по умолчанию в частный пиринг вызовет блокировку внутреннего пути из Azure. Для направления входящего и исходящего интернет-трафика служб, размещенных в Azure, используйте ресурсы своей корпоративной сети. 

 Для подключения к другим услугам и инфраструктурным службам Azure требуется соблюдение одного из следующих условий:

* общедоступный пиринг Azure включен для направления трафика в общедоступные конечные точки;
* маршрутизация определяется пользователем, что обеспечивает интернет-подключение к каждой подсети, требующей подключения к Интернету.

> [!NOTE]
> Объявление маршрутов по умолчанию аннулирует действие лицензий Windows и других виртуальных машин. Чтобы решить эту проблему, выполните [данные инструкции](https://blogs.msdn.com/b/mast/archive/2015/05/20/use-azure-custom-routes-to-enable-kms-activation-with-forced-tunneling.aspx) .
> 
> 

## <a name="bgp"></a>Поддержка сообществ BGP
Этот раздел содержит общие сведения об использовании сообществ BGP с ExpressRoute. Майкрософт объявляет маршруты в путях общедоступного пиринга и пиринга Microsoft с маршрутами, помеченными значениями соответствующего сообщества. Для чего это нужно и что такое значения сообществ, рассмотрим ниже. При этом Майкрософт не учитывает значения сообществ, которыми помечены маршруты, объявленные для Майкрософт.

Подключившись к Майкрософт через ExpressRoute в любом расположении пиринга в геополитической области, вы получите доступ ко всем облачным службам Майкрософт во всех регионах этой геополитической области. 

Например, подключившись через ExpressRoute к Майкрософт в Амстердаме, вы получите доступ ко всем облачным службам Майкрософт, размещенным в Северной и Западной Европе. 

Подробный список геополитических регионов, связанных с ними регионов Azure и расположений соответствующих пирингов ExpressRoute см. на странице [Партнеры и одноранговые расположения ExpressRoute](expressroute-locations.md).

Вы можете приобрести больше одного канала ExpressRoute на каждый геополитический регион. За счет геоизбыточности наличие нескольких подключений даст вам более высокий уровень доступности. Имея несколько каналов ExpressRoute, вы будете получать тот же набор префиксов, который объявляется из Майкрософт для путей пиринга Майкрософт и общедоступного пиринга. Это означает, что из вашей сети в Майкрософт будет вести сразу несколько путей. В такой ситуации есть вероятность, что ваша сеть будет выбирать маршрутизацию не самым оптимальным образом, а значит, подключение к некоторым службам может оказаться недостаточно надежным. Значения сообществ помогут вам правильно сделать выбор и обеспечить своим пользователям [оптимальную маршрутизацию](expressroute-optimize-routing.md).

| **Регион Microsoft Azure** | **Региональные сообществ BGP** | **Сообщества BGP хранилища** | **Сообщества SQL BGP** | 
| --- | --- | --- | --- |
| **Северная Америка** | |
| Восточная часть США | 12076:51004 | 12076:52004 | 12076:53004 |
| Восток США 2 | 12076:51005 | 12076:52005 | 12076:53005 |
| Запад США | 12076:51006 | 12076:52006 | 12076:53006 |
| Западный регион США 2 | 12076:51026 | 12076:52026 | 12076:53026 |
| Западно-центральная часть США | 12076:51027 | 12076:52027 | 12076:53027 |
| Центрально-северная часть США | 12076:51007 | 12076:52007 | 12076:53007 |
| Центрально-южная часть США | 12076:51008 | 12076:52008 | 12076:53008 |
| Центральный регион США | 12076:51009 | 12076:52009 | 12076:53009 |
| Центральная Канада | 12076:51020 | 12076:52020 | 12076:53020 |
| Восточная Канада | 12076:51021 | 12076:52021 | 12076:53021 |
| **Южная Америка** | |
| Южная часть Бразилии | 12076:51014 | 12076:52014 | 12076:53014 |
| **Европа** | |
| Северная Европа | 12076:51003 | 12076:52003 | 12076:53003 |
| Западная Европа | 12076:51002 | 12076:52002 | 12076:53002 |
| Южная часть Великобритании | 12076:51024 | 12076:52024 | 12076:53024 |
| Западная часть Великобритании | 12076:51025 | 12076:52025 | 12076:53025 |
| Центральная Франция | 12076:51030 | 12076:52030 | 12076:53030 |
| Южная Франция | 12076:51031 | 12076:52031 | 12076:53031 |
| **Азиатско-Тихоокеанский регион** | |
| Восточная Азия | 12076:51010 | 12076:52010 | 12076:53010 |
| Юго-Восточная Азия | 12076:51011 | 12076:52011 | 12076:53011 |
| **Япония** | |
| Восточная часть Японии | 12076:51012 | 12076:52012 | 12076:53012 |
| Западная часть Японии | 12076:51013 | 12076:52013 | 12076:53013 |
| **Австралия** | |
| Восточная часть Австралии | 12076:51015 | 12076:52015 | 12076:53015 |
| Юго-Восточная часть Австралии | 12076:51016 | 12076:52016 | 12076:53016 |
| **Государственные организации Австралии** | |
| Центральная Австралия | 12076:51032 | 12076:52032 | 12076:53032 |
| Центральная Австралия 2 | 12076:51033 | 12076:52033 | 12076:53033 |
| **Индия** | |
| Южная Индия | 12076:51019 | 12076:52019 | 12076:53019 |
| Западная Индия | 12076:51018 | 12076:52018 | 12076:53018 |
| Центральная Индия | 12076:51017 | 12076:52017 | 12076:53017 |
| **Корея** | |
| Корея, юг | 12076:51028 | 12076:52028 | 12076:53028 |
| Центральная Корея | 12076:51029 | 12076:52029 | 12076:53029 |


Все объявляемые Майкрософт маршруты будут помечаться значением соответствующего сообщества. 

> [!IMPORTANT]
> В глобальные префиксы добавляется соответствующее значение сообщества.
> 
> 

Наряду с вышеизложенным Майкрософт будет также помечать префиксы в зависимости от того, к какой службе они относятся. Это правило действует только для пиринга Майкрософт. В представленной ниже таблице показано сопоставление служб и значений сообществ BGP.

| **Служба** | **Значение сообщества BGP** |
| --- | --- |
| Exchange Online | 12076:5010 |
| SharePoint Online | 12076:5020 |
| Skype для бизнеса Online | 12076:5030 |
| Dynamics 365 | 12076:5040 |
| Глобальные службы Azure* | 12076:5050 |
| Другие онлайн-службы Office 365 | 12076:5100 |

* Сейчас в глобальные службы Azure входит только Azure DevOps.


> [!NOTE]
> Майкрософт не учитывает установленные вами значения сообществ BGP в маршрутах, объявленных для Майкрософт.
> 
> 

### <a name="bgp-community-support-in-national-clouds"></a>Поддержка сообщества BGP в национальных облаках

| **Регион Azure для национальных облаков**| **Значение сообщества BGP** |
| --- | --- |
| **Правительство США** |  |
| Аризона (для обслуживания государственных организаций США) | 12076:51106 |
| US Gov (Айова) | 12076:51109 |
| Правительство штата Вирджиния | 12076:51105 |
| Техас (для обслуживания государственных организаций США) | 12076:51108 |
| Центральная часть США, МО | 12076:51209 |
| Восток США, МО | 12076:51205 |


| **Служба в национальных облаках** | **Значение сообщества BGP** |
| --- | --- |
| **Правительство США** |  |
| Exchange Online |12076:5110 |
| SharePoint Online |12076:5120 |
| Skype для бизнеса Online |12076:5130 |
| Dynamics 365 |12076:5140 |
| Другие онлайн-службы Office 365 |12076:5200 |

## <a name="next-steps"></a>Дальнейшие действия
* Настройте подключение ExpressRoute.
  
  * [Создание и изменение канала ExpressRoute с помощью PowerShell](expressroute-howto-circuit-arm.md)
  * [Создание и изменение пиринга для канала ExpressRoute с помощью PowerShell](expressroute-howto-routing-arm.md)
  * [Связывание виртуальной сети с каналом ExpressRoute](expressroute-howto-linkvnet-arm.md)
