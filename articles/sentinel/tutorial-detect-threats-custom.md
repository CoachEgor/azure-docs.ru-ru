---
title: Создавайте пользовательские аналитические правила для обнаружения подозрительных угроз с помощью Azure Sentinel Документы Майкрософт
description: Используйте этот учебник, чтобы узнать, как создавать пользовательские аналитические правила для обнаружения подозрительных угроз с помощью Azure Sentinel.
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/20/2020
ms.author: yelevin
ms.openlocfilehash: cea7429ecea105355b0afe306bfa334e55d5d9c4
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77585113"
---
# <a name="tutorial-create-custom-analytic-rules-to-detect-suspicious-threats"></a>Учебник: Создание пользовательских аналитических правил для обнаружения подозрительных угроз

После [подключения источников](quickstart-onboard.md) данных к Azure Sentinel можно создать пользовательские правила, которые могут искать определенные критерии в среде и создавать инциденты при согласовании критериев, чтобы вы могли исследовать их. Этот учебник поможет вам создать пользовательские правила для обнаружения угроз с помощью Azure Sentinel.

Этот учебник поможет вам обнаружить угрозы с помощью Azure Sentinel.
> [!div class="checklist"]
> * Создание аналитических правил
> * Автоматизация реагирования на угрозы

## <a name="create-custom-analytic-rules"></a>Создание пользовательских аналитических правил

Можно создать пользовательские аналитические правила, которые помогут вам найти типы угроз и аномалий, которые являются подозрительными в вашей среде. Правило гарантирует, что вы сразу же уведомлены, так что вы можете сортировать, исследовать и устранять угрозы.

1. На портале Azure в разделе Azure Sentinel выберите **Аналитика**.

1. В верхней панели меню выберите правило **«Создать»** и выбрать **правило запланированного запроса.** Это открывает **мастер правил Аналитики.**

    ![Создание запланированного запроса](media/tutorial-detect-threats-custom/create-scheduled-query.png)

1. В **общей** вкладке, предоставить уникальное **имя**, и **описание**. В поле **Тактики** можно выбрать из категорий атак, с помощью которых можно классифицировать правило. Установите **серьезность** оповещения по мере необходимости. При создании правила его **статус** **включен** по умолчанию, что означает, что оно будет запущено сразу после его завершения. Если вы не хотите, чтобы он работал немедленно, выберите **Отключение,** и правило будет добавлено в вкладку **Активных правил,** и вы можете включить его оттуда, когда вам это нужно.

    ![Начните создавать пользовательское аналитическое правило](media/tutorial-detect-threats-custom/general-tab.png)

1. Во вкладке **логики правила Set** можно либо записать запрос непосредственно в поле **запроса правил,** либо создать запрос в журнале Analytics, а затем скопировать и вставить его там.
 
   ![Создание запроса в Azure Sentinel](media/tutorial-detect-threats-custom/settings-tab.png)

   - См. область **предварительного просмотра результатов** справа, где Azure Sentinel показывает количество результатов (событий журнала), которые будет генерировать запрос, изменяя на лету при написании и настройке запроса. На графике показано количество результатов за определенный период времени, которое определяется настройками в разделе **планирования запроса.**
    - Если вы видите, что запрос вызовет слишком много или слишком частые оповещения, можно установить базовую строку в разделе **порогового оповещения.**

      Вот пример запроса, который будет предупреждать вас при создании аномального количества ресурсов в деятельности Azure.

      `AzureActivity
     \| where OperationName == "Create or Update Virtual Machine" or OperationName =="Create Deployment"
     \| where ActivityStatus == "Succeeded"
     \| make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller`

      > [!NOTE]
      > Длина запроса должна сойти от 1 до 10 000 символов и не может содержать "поиск" \*или "союз". \*

    1. Используйте раздел **«Карты»** для сопоставления параметров результатов запроса с распознанными объектами, признанными Azure Sentinel. Эти сущности составляют основу для дальнейшего анализа, включая группировку предупреждений в инциденты во **вкладке настройки инцидента.**
    1. В разделе **планирования запросов** установите следующие параметры:

       1. Установить **запрос Run каждый,** чтобы контролировать, как часто запрос работает - так часто, как каждые 5 минут или так редко, как один раз в день.

       1. Направь **данные поиска из последнего,** чтобы определить период времени данных, охватываемых запросом - например, он может запросить последние 10 минут данных или последние 6 часов данных.

       > [!NOTE]
       > Эти две настройки не зависят друг от друга, вплоть до определенного момента. Вы можете запустить запрос с коротким интервалом, охватывающим период времени дольше интервала (фактически имеющий перекрывающиеся запросы), но вы не можете запустить запрос с интервалом, превышаюющим период покрытия, в противном случае у вас будут пробелы в общем охвате запроса.

    1. Для определения базовой линии используйте раздел **порога оповещения.** Например, установите **оповещение generate, когда количество результатов запроса** **превышает** число, и введите число 1000, если требуется, чтобы правило генерирует оповещение только в том случае, если запрос генерирует более 1000 результатов каждый раз, когда он выполняется. Поскольку это необходимое поле, если вы не хотите устанавливать базовый уклад - то есть, если вы хотите, чтобы ваше оповещение зарегистрировало каждое событие - введите 0 в поле числа.

    1. В разделе **"Подавление"** можно включить **запрос "Стоп", после того как генерируется оповещение,** **если** после получения предупреждения необходимо приостановить работу этого правила на период времени, превышающий интервал запроса. При включании этого, необходимо установить **"Стоп запуск" запроса на** время, в течение которого запрос должен прекратить работу, до 24 часов.

1. Во вкладке **«Настройки инцидентов»** можно выбрать, превращает ли Azure Sentinel оповещения в действия. Если эта вкладка останется в покое, Azure Sentinel создаст один отдельный инцидент от каждого предупреждения. Вы можете выбрать не создавать инцидентов или сгруппировать несколько оповещений в один инцидент, изменив настройки в этой вкладке.

    1. В разделе **Параметры инцидентов** **создание инцидентов из предупреждений, вызванных этим правилом аналитики,** устанавливается по умолчанию, а это означает, что Azure Sentinel создаст один отдельный инцидент от каждого предупреждения, вызванного правилом. **Enabled**<br></br>Если вы не хотите, чтобы это правило привело к созданию каких-либо инцидентов (например, если это правило просто для сбора информации для последующего анализа), установите это **для инвалидов.**

    1. В разделе **группирования оповещения,** если вы хотите, чтобы один инцидент был создан из группы аналогичных или повторяющихся предупреждений, установите **оповещения, связанные с группой, вызванные этим правилом аналитики, в инциденты** **включено**и установите следующие параметры.

    1. **Ограничьте группу оповещениями, созданными в выбранный промежуток времени:**<br></br> Определите временные рамки, в течение которых аналогичные или повторяющиеся оповещения будут сгруппированы вместе. Все соответствующие оповещения в течение этого периода времени будут коллективно генерировать инцидент или набор инцидентов (в зависимости от настроек группировки ниже). Оповещения за пределами этого периода времени будут генерировать отдельный инцидент или набор инцидентов.

    2. **Групповые оповещения, вызванные этим правилом аналитики, в один инцидент:** Выберите основу, на которой оповещения будут сгруппированы вместе:

        - **Группа оповещения в одном инциденте, если все объекты совпадают:** <br></br>Оповещения группируются, если они разделяют одинаковые значения для каждого из отображенных объектов (определяемых в вкладке логики правила Set выше). Это рекомендуемый параметр.

        - **Группируйте все оповещения, вызванные этим правилом, в один инцидент:** <br></br>Все оповещения, генерируемые этим правилом, сгруппированы вместе, даже если они не имеют одинаковых значений.

        - **Группа предупреждает об одном инциденте, если выбранные сущности совпадают:** <br></br>Оповещения группируются, если они разделяют одинаковые значения для некоторых из отображенных сущностей (которые можно выбрать из списка выпадающих). Вы можете использовать этот параметр, если, например, требуется создать отдельные инциденты на основе источника или целевых IP-адресов.

    3. **Повторное открытие закрытых совпадающих инцидентов:** Если инцидент был закрыт (имеется в виду, что основная проблема была решена), а затем генерируется еще одно оповещение, которое было бы сгруппировано в этот инцидент, установите эту настройку **включено,** если вы хотите, чтобы закрытый инцидент был вновь открыт, и оставьте как **отключенный,** если вы хотите, чтобы оповещение создало новый инцидент.

1. Во вкладке **«Автоматизированные ответы»** выберите любые игровые книги, которые вы хотите запустить автоматически, когда оповещение генерируется пользовательским правилом. Для получения дополнительной информации о создании и автоматизации игровых книг [см.](tutorial-respond-threats-playbook.md)

1. Выберите **обзор и создайте** для просмотра всех параметров для нового правила оповещения, а затем выберите **Создать для инициализации правила оповещения.**
  
1. После создания оповещения в таблице в соответствии с **правилами Active**в таблице добавляется пользовательское правило. Из этого списка вы можете включить, отключить или удалить каждое правило.

1. Чтобы просмотреть результаты создаваемых правил оповещения, перейдите на страницу **«Инциденты»,** где можно сортировать, [расследовать инциденты](tutorial-investigate-cases.md)и устранять угрозы.


> [!NOTE]
> Оповещения, генерируемые в Azure Sentinel, доступны через [Microsoft Graph Security.](https://aka.ms/securitygraphdocs) Для получения дополнительной [информации смотрите документацию Microsoft Graph Security.](https://aka.ms/graphsecurityreferencebetadocs)

## <a name="next-steps"></a>Дальнейшие действия

В этом уроке вы узнали, как начать обнаруживать угрозы с помощью Azure Sentinel.

Чтобы узнать, как автоматизировать ответы на угрозы, [нависните автоматизированные ответы на угрозы в Azure Sentinel.](tutorial-respond-threats-playbook.md)

