---
title: Создание настраиваемых правил аналитики для обнаружения подозрительных угроз с помощью Sentinel Azure | Документация Майкрософт
description: С помощью этого учебника вы узнаете, как создавать пользовательские аналитические правила для обнаружения подозрительных угроз с помощью Sentinel Azure.
services: sentinel
documentationcenter: na
author: rkarlin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/20/2020
ms.author: rkarlin
ms.openlocfilehash: bdd36e2f3c2b426f4bad3e787c12be2f7d09b303
ms.sourcegitcommit: f27b045f7425d1d639cf0ff4bcf4752bf4d962d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/23/2020
ms.locfileid: "77565525"
---
# <a name="tutorial-create-custom-analytic-rules-to-detect-suspicious-threats"></a>Учебник. Создание настраиваемых правил аналитики для обнаружения подозрительных угроз

После [подключения источников данных](quickstart-onboard.md) к Azure Sentinel можно создать настраиваемые правила, которые могут искать определенные критерии в среде и создавать инциденты при совпадении критериев, чтобы их можно было исследовать. Этот учебник поможет вам создать настраиваемые правила для обнаружения угроз с помощью Azure Sentinel.

Этот учебник поможет обнаружить угрозы с помощью Azure Sentinel.
> [!div class="checklist"]
> * Создание аналитических правил
> * Автоматизация реагирования на угрозы

## <a name="create-custom-analytic-rules"></a>Создание настраиваемых правил аналитики

Можно создать настраиваемые аналитические правила, которые помогут найти типы угроз и аномалий, подозрительных в вашей среде. Правило гарантирует, что вы будете уведомлены о том, что вы можете рассмотреть, исследовать и исправлять угрозы.

1. На портале Azure в разделе Azure Sentinel выберите **Аналитика**.

1. В верхней строке меню выберите **+ создать** и выберите **запланированное правило запроса**. Откроется **Мастер правил аналитики**.

    ![Создание запланированного запроса](media/tutorial-detect-threats-custom/create-scheduled-query.png)

1. На вкладке **Общие** укажите уникальное **имя**и **Описание**. В поле **тактика** можно выбрать один из категорий атак, по которым будет классифицироваться правило. При необходимости задайте **серьезность** предупреждения. При создании правила его **состояние** **включается** по умолчанию. Это означает, что оно будет запущено сразу после создания. Если вы не хотите, чтобы он выполнялся немедленно, выберите **отключено**, и правило будет добавлено на вкладку **активные правила** , и вы сможете включить его там, где это необходимо.

    ![Начать создание настраиваемого аналитического правила](media/tutorial-detect-threats-custom/general-tab.png)

1. На вкладке **задать логику правила** можно либо написать запрос непосредственно в поле **запроса правила** , либо создать запрос в log Analytics, а затем скопировать и вставить его.
 
   ![Создание запроса в Azure Sentinel](media/tutorial-detect-threats-custom/settings-tab.png)

   - Просмотрите область **просмотра результатов** справа, где метка Azure показывает количество результатов (событий журнала), которые будут создаваться запросом, изменяя при написании и настройке запроса. На диаграмме показано количество результатов за определенный период времени, которое определяется параметрами в разделе " **планирование запросов** ".
    - Если вы видите, что запрос запускает слишком много или слишком частое оповещение, можно задать базовый уровень в разделе **порог оповещения** .

      Ниже приведен пример запроса, который выдаст предупреждение при создании аномального числа ресурсов в действии Azure.

      `AzureActivity
     \| where OperationName == "Create or Update Virtual Machine" or OperationName =="Create Deployment"
     \| where ActivityStatus == "Succeeded"
     \| make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller`

      > [!NOTE]
      > Длина запроса должна составлять от 1 до 10 000 символов и не может содержать "Search \*" или "Union \*".

    1. Используйте раздел **Map Entities** , чтобы связать параметры из результатов запроса с сущностями, распознаваемыми в Azure Sentinel. Эти сущности формируют базу для дальнейшего анализа, включая группировку оповещений в инциденты на вкладке **Параметры инцидента** .
    1. В разделе **планирование запросов** задайте следующие параметры.

       1. Установите параметр **выполнять запрос каждые** , чтобы управлять частотой выполнения запроса, как часто каждые 5 минут или как нечастое число раз в день.

       1. Установите **данные подстановки, начиная с последней** , чтобы определить период времени для данных, покрываемых запросом. Например, он может запросить данные за последние 10 минут или за последние 6 часов данных.

       > [!NOTE]
       > Эти два параметра не зависят друг от друга, вплоть до точки. Можно выполнить запрос через короткий интервал, охватывающий период времени, превышающий интервал (при наличии перекрывающихся запросов), но нельзя выполнить запрос с интервалом, превышающим период покрытия, иначе в общем объеме запроса будут пропуски.

    1. Чтобы определить базовый план, используйте раздел **порог оповещения** . Например, установите параметр **создавать оповещение, если число результатов запроса** **превышает** и введите число 1000, если необходимо, чтобы правило создавало предупреждение только в том случае, если запрос формирует более 1000 результатов при каждом запуске. Так как это обязательное поле, если вы не хотите задавать базовый план, то есть если вы хотите, чтобы оповещение регистрировало каждое событие, введите 0 в поле номер.

    1. В разделе **подавления** можно включить параметр **остановить выполнение запроса после создания предупреждения** **в** случае, если при получении предупреждения вы хотите приостановить операцию этого правила в течение определенного периода времени, превышающего интервал запроса. Если включить этот параметр, необходимо задать для параметра **прерывать выполнение запросов** значение в течение времени, в течение которого запрос должен прерываться до 24 часов.

1. На вкладке **Параметры инцидента** можно выбрать, будет ли и как Azure Sentinel переключать предупреждения в инциденты, требующие действий. Если эта вкладка не оставлена, Azure Sentinel создаст один отдельный инцидент из каждого предупреждения. Можно выбрать отсутствие инцидентов или сгруппировать несколько предупреждений в один инцидент, изменив параметры на этой вкладке.

    1. В разделе **Параметры инцидента** **Создание инцидентов на основе предупреждений, активированных этим правилом аналитики** по умолчанию устанавливается в значение **включено**. Это означает, что метка Azure создает один отдельный инцидент от каждого предупреждения, инициированного правилом.<br></br>Если вы не хотите, чтобы это правило приводило к созданию инцидентов (например, если это правило только собирает сведения для последующего анализа), установите для этого параметра значение **отключено**.

    1. Если вы хотите, чтобы один инцидент создавался из группы схожих или повторяющихся оповещений, в разделе **группирование оповещений** задайте для параметра **связанные с группой предупреждения, активируемые этим правилом аналитики,** на **включенные**и задайте следующие параметры.

    1. **Ограничьте группу предупреждениями, созданными в течение выбранного интервала времени**:<br></br> Определите интервал времени, в течение которого сходные или повторяющиеся оповещения будут сгруппированы вместе. Все соответствующие предупреждения в течение этого промежутка времени будут собираются инцидентом или набором инцидентов (в зависимости от приведенных ниже параметров группирования). Оповещения за пределами этого промежутка времени будут создавать отдельные инциденты или наборы инцидентов.

    2. **Группировать предупреждения, активируемые этим правилом аналитики, в один инцидент**: выберите базу, в которой будут сгруппированы оповещения:

        - **Группировать предупреждения в один инцидент, если все сущности совпадают**: <br></br>Оповещения группируются вместе, если они совместно используют одинаковые значения для каждой из сопоставленных сущностей (определенных на вкладке логика набора правил выше). Этот способ является рекомендуемым.

        - **Сгруппируйте все предупреждения, активируемые этим правилом, в один инцидент**: <br></br>Все предупреждения, созданные этим правилом, группируются, даже если они не имеют одинаковых значений.

        - **Группировать предупреждения в один инцидент, если выбранные сущности совпадают**: <br></br>Оповещения группируются, если они совместно используют одинаковые значения для некоторых сопоставленных сущностей (которые можно выбрать из раскрывающегося списка). Этот параметр может потребоваться использовать, например, если необходимо создать отдельные инциденты на основе исходного или целевого IP-адреса.

    3. **Повторно открыть закрытые совпадающие инциденты**. Если инцидент был закрыт (это означает, что проблема устранена), а затем создается другое предупреждение, которое было бы сгруппировано в этот инцидент, установите этот параметр в значение **Enabled (включено** ), если хотите повторно открыть закрытый инцидент, и оставьте его **отключенным** , если вы хотите, чтобы оповещение создавало новый инцидент.

1. На вкладке **автоматизированные ответы** выберите любой модули PlayBook, который требуется запустить автоматически при создании оповещения настраиваемым правилом. Дополнительные сведения о создании и автоматизации модули PlayBook см. в разделе [реагирование на угрозы](tutorial-respond-threats-playbook.md).

1. Выберите **проверить и создать** , чтобы проверить все параметры нового правила генерации оповещений, а затем нажмите кнопку **создать, чтобы инициализировать правило генерации оповещений**.
  
1. После создания оповещения в таблицу в разделе **активные правила**добавляется настраиваемое правило. В этом списке можно включить, отключить или удалить каждое правило.

1. Чтобы просмотреть результаты создаваемых правил генерации оповещений, перейдите на страницу **инциденты** , где можно рассмотреть, [исследовать инциденты](tutorial-investigate-cases.md)и устранить угрозы.


> [!NOTE]
> Оповещения, созданные в Azure Sentinel, доступны через [Microsoft Graph безопасность](https://aka.ms/securitygraphdocs). Дополнительные сведения см. в [документации по Microsoft Graph оповещениями системы безопасности](https://aka.ms/graphsecurityreferencebetadocs).

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как приступить к обнаружению угроз с помощью Sentinel Azure.

Чтобы узнать, как автоматизировать реагирование на угрозы, [Настройте автоматические ответы на угрозы в Azure Sentinel](tutorial-respond-threats-playbook.md).

