---
title: Создание настраиваемых правил аналитики для обнаружения угроз с помощью Azure Sentinel | Документация Майкрософт
description: С помощью этого учебника вы узнаете, как создавать пользовательские правила аналитики для обнаружения угроз безопасности с помощью Sentinel в Azure.
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/06/2020
ms.author: yelevin
ms.openlocfilehash: 0e5989490603e22745a8bc972b16ed016c894893
ms.sourcegitcommit: d661149f8db075800242bef070ea30f82448981e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/19/2020
ms.locfileid: "88605911"
---
# <a name="tutorial-create-custom-analytics-rules-to-detect-threats"></a>Учебник. Создание настраиваемых правил аналитики для обнаружения угроз

После [подключения источников данных](quickstart-onboard.md)   к Azure Sentinel можно создать настраиваемые правила, которые могут искать определенные критерии в среде и создавать инциденты при совпадении критериев, чтобы их можно было исследовать. Этот учебник поможет вам создать настраиваемые правила для обнаружения угроз с помощью Azure Sentinel.

Этот учебник поможет обнаружить угрозы с помощью Azure Sentinel.
> [!div class="checklist"]
> * Создание правил аналитики
> * Автоматизация реагирования на угрозы

## <a name="create-custom-analytics-rules"></a>Создание настраиваемых правил аналитики

Можно создать пользовательские правила аналитики, которые помогут найти типы угроз и аномалий, подозрительных в вашей среде. Правило гарантирует, что вы будете уведомлены о том, что вы можете рассмотреть, исследовать и исправлять угрозы.

1. На портале Azure в разделе Azure Sentinel выберите **Аналитика**.

1. В верхней строке меню выберите **+ создать** и выберите **запланированное правило запроса**. Откроется **Мастер правил аналитики**.

    :::image type="content" source="media/tutorial-detect-threats-custom/create-scheduled-query.png" alt-text="Создание запланированного запроса":::

1. На вкладке **Общие** укажите уникальное **имя** и **Описание**. В поле **тактика** можно выбрать один из категорий атак, по которым будет классифицироваться правило. При необходимости задайте **серьезность** предупреждения. При создании правила его **состояние** **включается** по умолчанию. Это означает, что оно будет запущено сразу после создания. Если вы не хотите, чтобы он выполнялся немедленно, выберите **отключено**, и правило будет добавлено на вкладку **активные правила** , и вы сможете включить его там, где это необходимо.

    ![Начать создание настраиваемого правила аналитики](media/tutorial-detect-threats-custom/general-tab.png)

1. На вкладке **задать логику правила** можно либо написать запрос непосредственно в поле **запроса правила** , либо создать запрос в log Analytics, а затем скопировать и вставить его.
 
   ![Создание запроса в Azure Sentinel](media/tutorial-detect-threats-custom/settings-tab.png)

   - Просмотрите область **просмотра результатов** справа, где метка Azure показывает количество результатов (событий журнала), которые будут создаваться запросом, изменяя при написании и настройке запроса. На диаграмме показано количество результатов за определенный период времени, которое определяется параметрами в разделе " **планирование запросов** ".
    - Если вы видите, что запрос запускает слишком много или слишком частое оповещение, можно задать базовый уровень в разделе **порог оповещения** .

      Ниже приведен пример запроса, который выдаст предупреждение при создании аномального числа ресурсов в действии Azure.

      `AzureActivity
     \| where OperationName == "Create or Update Virtual Machine" or OperationName =="Create Deployment"
     \| where ActivityStatus == "Succeeded"
     \| make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller`

      > [!NOTE]
      > Длина запроса должна составлять от 1 до 10 000 символов и не может содержать "Search \* " или "Union \* ".

    1. Используйте раздел **Map Entities** , чтобы связать параметры из результатов запроса с сущностями, распознаваемыми в Azure Sentinel. Эти сущности формируют базу для дальнейшего анализа, включая группировку оповещений в инциденты на вкладке **Параметры инцидента** .
  
    1. В разделе **планирование запросов** задайте следующие параметры.

       1. Установите параметр **выполнять запрос каждые** , чтобы управлять частотой выполнения запроса, как часто каждые 5 минут или как нечастое число раз в день.

       1. Установите **данные подстановки, начиная с последней** , чтобы определить период времени для данных, покрываемых запросом. Например, он может запросить данные за последние 10 минут или за последние 6 часов данных.

       > [!NOTE]
       > Эти два параметра не зависят друг от друга, вплоть до точки. Можно выполнить запрос через короткий интервал, охватывающий период времени, превышающий интервал (при наличии перекрывающихся запросов), но нельзя выполнить запрос с интервалом, превышающим период покрытия, иначе в общем объеме запроса будут пропуски.

    1. Чтобы определить базовый план, используйте раздел **порог оповещения** . Например, установите параметр **создавать оповещение, если число результатов запроса** **превышает** и введите число 1000, если необходимо, чтобы правило создавало предупреждение только в том случае, если запрос возвращает больше 1000 результатов при каждом запуске. Это обязательное поле, поэтому если вы не хотите задавать базовый план, то есть если вы хотите, чтобы оповещение регистрировало каждое событие, введите 0 в поле "номер".
    
    1. В разделе **Группирование событий**выберите один из двух способов для управления группированием **событий** в **оповещения**. 

       - **Сгруппируйте все события в одно предупреждение** (значение по умолчанию). Правило создает одно предупреждение при каждом запуске, пока запрос возвращает больше результатов, чем указано выше **порогового значения предупреждения** . Предупреждение содержит сводку по всем событиям, возвращенным в результатах. 

       - **Активировать оповещение для каждого события**. Правило создает уникальное оповещение для каждого события, возвращенного запросом. Это полезно, если требуется, чтобы события отображались по отдельности, или если вы хотите сгруппировать их по определенным параметрам — по пользователю, имени узла или что-либо другому. Эти параметры можно определить в запросе.
    
       В настоящее время количество предупреждений, которое может быть создано правилом, ограничено на 20. Если в определенном правиле указано, что **Группирование событий** **запускает оповещение для каждого события**, а запрос правила возвращает более 20 событий, каждое из первых 19 событий создаст уникальное оповещение, а двадцатое оповещение будет суммировать весь набор возвращенных событий. Иными словами, двадцатым предупреждением является то, что было бы создано при выборе параметра **Группировать все события в одно оповещение** .

       > [!NOTE]
       > В чем разница между **событиями** и **предупреждениями**?
       >
       > - **Событие** представляет собой описание одного вхождения. Например, одна запись в файле журнала может считаться событием. В этом контексте событие ссылается на один результат, возвращенный запросом в правиле аналитики.
       >
       > - **Предупреждение** — это набор событий, которые, в совокупности, являются значительными для точки зрения безопасности. Предупреждение может содержать одно событие, если событие приводило к существенным последствиям для безопасности — например, административное имя входа из внешней страны за пределами Office Hours.
       >
       > - Кстати, что такое **инциденты**? Внутренняя логика Azure Sentinel создает **инциденты** на основе **предупреждений** или групп предупреждений. Очередь инцидентов — это Фокальная точка рассмотрения, исследования и исправления.
       > 
       > Sentinel Azure принимает необработанные события из некоторых источников данных и уже обрабатывали предупреждения от других. Важно отметить, с какой из них вы работаете в любое время.

       > [!IMPORTANT]
       > В настоящее время Группирование событий находится в общедоступной предварительной версии. Эта функция предоставляется без соглашения об уровне обслуживания и не рекомендуется для рабочих нагрузок в рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).
    
    1. В разделе **подавления** можно включить параметр **остановить выполнение запроса после создания предупреждения** **в** случае, если при получении предупреждения вы хотите приостановить операцию этого правила в течение определенного периода времени, превышающего интервал запроса. Если включить этот параметр, необходимо задать для параметра **прерывать выполнение запросов** значение в течение времени, в течение которого запрос должен прерываться до 24 часов.

1. На вкладке **Параметры инцидента** можно выбрать, будет ли и как Azure Sentinel переключать предупреждения в инциденты, требующие действий. Если эта вкладка не оставлена, Azure Sentinel создаст один отдельный инцидент из каждого предупреждения. Можно выбрать отсутствие инцидентов или сгруппировать несколько предупреждений в один инцидент, изменив параметры на этой вкладке.

   > [!IMPORTANT]
   > Вкладка Параметры инцидента сейчас находится в общедоступной предварительной версии. Эта функция предоставляется без соглашения об уровне обслуживания и не рекомендуется для рабочих нагрузок в рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).
    
    1. В разделе **Параметры инцидента** **Создание инцидентов на основе предупреждений, активированных этим правилом аналитики** по умолчанию устанавливается в значение **включено**. Это означает, что метка Azure создает один отдельный инцидент от каждого предупреждения, инициированного правилом.
       - Если вы не хотите, чтобы это правило приводило к созданию инцидентов (например, если это правило только собирает сведения для последующего анализа), установите для этого параметра значение **отключено**.

    1. Если вы хотите, чтобы один инцидент создавался из группы до 150 схожих или повторяющихся оповещений (см. Примечание) в разделе **группирование оповещений** , **Задайте для**параметра **связанные с группой предупреждения, активируемые этим правилом аналитики,** а затем задайте следующие параметры.

    - **Ограничьте группу предупреждениями, созданными в течение выбранного периода времени**: Определите интервал времени, в течение которого будут группироваться похожие или повторяющиеся оповещения. Все соответствующие предупреждения в течение этого промежутка времени будут собираются инцидентом или набором инцидентов (в зависимости от приведенных ниже параметров группирования). Оповещения за пределами этого промежутка времени будут создавать отдельные инциденты или наборы инцидентов.

    - **Группировать предупреждения, активируемые этим правилом аналитики, в один инцидент**: выберите базу, в которой будут сгруппированы оповещения:

        - **Группировать предупреждения в один инцидент, если все сущности совпадают**: оповещения группируются вместе, если они совместно используют одинаковые значения для каждой из сопоставленных сущностей (определенных на вкладке логика набора правил выше). Это рекомендуемый параметр.

        - **Сгруппируйте все предупреждения, активируемые этим правилом, в один инцидент**: все предупреждения, создаваемые этим правилом, группируются вместе, даже если они не имеют одинаковых значений.

        - **Группировать предупреждения в один инцидент, если выбранные сущности совпадают**: оповещения группируются, если они имеют одинаковые значения для некоторых сопоставленных сущностей (которые можно выбрать из раскрывающегося списка). Этот параметр может потребоваться использовать, например, если необходимо создать отдельные инциденты на основе исходного или целевого IP-адреса.

    - **Повторно открыть закрытые совпадающие инциденты**. Если инцидент был разрешен и закрыт, а позднее в другом оповещении будет состоять из этого инцидента, установите этот параметр в значение **Enabled (включено** ), если хотите повторно открыть закрытое инцидент, и оставьте его **отключенным** , если вы хотите, чтобы оповещение создавало новый инцидент.
    
        > [!NOTE]
        > До 150 оповещений можно сгруппировать в один инцидент. Если в правиле, которое группирует их в один инцидент, создано более 150 предупреждений, будет сформирован новый инцидент с теми же сведениями об инциденте, что и у исходного, а избыточные предупреждения будут сгруппированы в новый инцидент.

1. На вкладке **автоматизированные ответы** выберите любой модули PlayBook, который требуется запустить автоматически при создании оповещения настраиваемым правилом. Дополнительные сведения о создании и автоматизации модули PlayBook см. в разделе [реагирование на угрозы](tutorial-respond-threats-playbook.md).

1. Выберите **проверить и создать** , чтобы проверить все параметры нового правила генерации оповещений, а затем нажмите кнопку **создать, чтобы инициализировать правило генерации оповещений**.
  
1. После создания оповещения в таблицу в разделе **активные правила**добавляется настраиваемое правило. В этом списке можно включить, отключить или удалить каждое правило.

1. Чтобы просмотреть результаты создаваемых правил генерации оповещений, перейдите на страницу **инциденты** , где можно рассмотреть, [исследовать инциденты](tutorial-investigate-cases.md)и устранить угрозы.


> [!NOTE]
> Оповещения, созданные в Azure Sentinel, доступны через [Microsoft Graph безопасность](https://aka.ms/securitygraphdocs). Дополнительные сведения см. в [документации по Microsoft Graph оповещениями системы безопасности](https://aka.ms/graphsecurityreferencebetadocs).

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как приступить к обнаружению угроз с помощью Sentinel Azure.

Чтобы узнать, как автоматизировать реагирование на угрозы, [Настройте автоматические ответы на угрозы в Azure Sentinel](tutorial-respond-threats-playbook.md).

