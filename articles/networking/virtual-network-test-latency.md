---
title: Проверка задержки сети виртуальной машины Azure в виртуальной сети Azure | Документация Майкрософт
titleSuffix: Azure Virtual Network latency
description: Узнайте, как проверить задержку сети между виртуальными машинами Azure в виртуальной сети.
services: virtual-network
documentationcenter: na
author: steveesp
manager: Marina Lipshteyn
editor: ''
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/29/2019
ms.author: steveesp
ms.openlocfilehash: d5efc1b802246597b4ee545b4d805e4f0d10ebb5
ms.sourcegitcommit: 0b1a4101d575e28af0f0d161852b57d82c9b2a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73166568"
---
# <a name="testing-network-latency"></a>Тестирование задержки сети

Измерение задержки сети с помощью инструмента, предназначенного для задачи, дает наиболее точные результаты. Общедоступные средства, такие как Соккперф (для Linux) и латте (для Windows) — это примеры средств, которые могут изолировать и измерять задержку в сети, не исключая задержки других типов, например задержки приложений. Эти средства сосредоточены на типе сетевого трафика, который влияет на производительность приложения, а именно TCP и UDP. Другие распространенные средства подключения, например проверка связи, иногда могут использоваться для измерения задержки, но эти результаты могут не соответствовать сетевому трафику, используемому в реальных рабочих нагрузках. &#39;Так как большинство этих средств используют протокол ICMP, который может обрабатываться иначе, чем трафик приложения, результаты могут быть неприменимы к рабочим нагрузкам, использующим TCP и UDP. Для точного тестирования сетевых протоколов, используемых большинством приложений, Соккперф (для Linux) и латте (для Windows) предоставляют наиболее релевантные результаты. В этом документе рассматриваются оба этих средства.

## <a name="overview"></a>Краткое описание

С помощью двух виртуальных машин (один в качестве отправителя и одного получателя) создается двусторонний канал связи для отправки и получения пакетов в обоих направлениях для измерения времени приема-передачи (RTT).

Эти действия можно использовать для измерения задержки сети между двумя виртуальными машинами (ВМ) или даже между двумя физическими компьютерами. Измерения задержки могут быть полезны в следующих сценариях:

- Создание теста производительности для задержки сети между развернутыми виртуальными машинами
- Сравните последствия изменений в сетевой задержке после внесения связанных изменений в:
  - Программное обеспечение для систем или сетевых стеков, включая изменения конфигурации
  - Метод развертывания виртуальной машины, например развертывание в зоне или ППГ
  - Свойства виртуальной машины, такие как ускорение сети или изменение размера
  - Виртуальная сеть, например изменение маршрутизации или фильтрация

### <a name="tools-for-testing"></a>Средства для тестирования
Чтобы измерить задержку, у нас есть два разных варианта: один для систем на основе Windows и один для систем на основе Linux.

Для Windows: латте. exe (Windows) [https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b](https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b)

Для Linux: Соккперф (Linux) [https://github.com/mellanox/sockperf](https://github.com/mellanox/sockperf)

Использование этих средств гарантирует, что измеряется только время доставки полезных данных TCP или UDP, а не ICMP (проверка связи) или другие типы пакетов, которые не используются приложениями и не влияют на их производительность.

### <a name="tips-for-an-optimal-vm-configuration"></a>Советы по оптимальной конфигурации виртуальной машины:

- Использование последней версии Windows или Linux
- Включение ускорения работы в сети для достижения наилучших результатов
- Развертывание виртуальных машин с помощью [группы размещения](https://docs.microsoft.com/azure/virtual-machines/linux/co-location) службы "близость" Azure
- Крупные виртуальные машины обычно работают лучше, чем небольшие.

### <a name="tips-for-analysis"></a>Советы по анализу

- Создание базовых показателей на раннем этапе после завершения развертывания, настройки и оптимизации
- Всегда сравнивать новые результаты с базовыми показателями или иным способом из одного теста в другой с управляемыми изменениями
- Повторение тестов при каждом обнаружении или планировании изменений


## <a name="testing-vms-running-windows"></a>Тестирование виртуальных машин под Windows:

## <a name="get-latteexe-onto-the-vms"></a>Получение латте. exe на виртуальных машинах

Скачайте последнюю версию: [https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b](https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b)

Рассмотрите возможность помещения латте. exe в отдельную папку, например c:\Tools

## <a name="allow-latteexe-through-the-windows-firewall"></a>Разрешить латте. exe через брандмауэр Windows

На ПРИЕМНИКе создайте правило разрешения в брандмауэре Windows, чтобы разрешить поступление трафика латте. exe. Проще всего разрешать всей программе латте. exe по имени, а не разрешать передачу конкретных TCP-портов.

Разрешить латте. exe через брандмауэр Windows следующим образом:

netsh advfirewall Firewall Добавление правила программа =\<путь\>\\латте. exe Name =&quot;латте&quot; Protocol = любой dir = в действии = разрешить Enable = да профиль = ANY


Например, если вы скопировали латте. exe в папку &quot;c:\\Tools&quot;, это будет команда:

```cmd
netsh advfirewall firewall add rule program=c:\tools\latte.exe name="Latte" protocol=any dir=in action=allow enable=yes profile=ANY
```

## <a name="running-latency-tests"></a>Выполнение тестов задержки

Запустите латте. exe на ПРИЕМНИКе (запустите из CMD-файла, а не из PowerShell):

Латте — IP-адрес получателя &lt;&gt;:&lt;порт&gt;-i &lt;итерации&gt;

Вокруг предел 65 тысяч итераций достаточно долго, чтобы возвращать репрезентативные результаты.

Любой доступный номер порта прекрасно подходит.

Если виртуальная машина имеет IP-адрес 10.0.0.4, она будет выглядеть следующим образом:

```cmd
latte -a 10.0.0.4:5005 -i 65100
```

Запустите латте. exe на отправителю (запустите из CMD-файла, а не из PowerShell):

Латте-c-a \<IP-адрес получателя\>:\<порт\>-i \<итерации\>


Полученная команда аналогична команде получателя, за исключением добавления &quot;-c&quot;, чтобы указать, что это &quot;клиентский&quot; или отправитель:

```cmd
latte -c -a 10.0.0.4:5005 -i 65100
```

Дождитесь результатов. В зависимости от того, насколько далеко находятся виртуальные машины, выполнение может занять несколько минут. Рекомендуется начинать с меньшего количества итераций для проверки успешности перед выполнением длинных тестов.



## <a name="testing-vms-running-linux"></a>Тестирование виртуальных машин под управлением Linux

Используйте Соккперф. Он доступен из [https://github.com/mellanox/sockperf](https://github.com/mellanox/sockperf)

### <a name="install-sockperf-on-the-vms"></a>Установка Соккперф на виртуальных машинах

На виртуальных машинах Linux (как отправитель, так и получатель) выполните следующие команды, чтобы подготовить Соккперф на виртуальных машинах. Для основных дистрибутивов предоставляются команды.

#### <a name="for-rhel--centos-follow-these-steps"></a>Для RHEL/CentOS выполните следующие действия.
```bash
#CentOS / RHEL - Install GIT and other helpful tools
    sudo yum install gcc -y -q
    sudo yum install git -y -q
    sudo yum install gcc-c++ -y
    sudo yum install ncurses-devel -y
    sudo yum install -y automake
    sudo yum install -y autoconf
```

#### <a name="for-ubuntu-follow-these-steps"></a>Для Ubuntu выполните следующие действия.
```bash
#Ubuntu - Install GIT and other helpful tools
    sudo apt-get install build-essential -y
    sudo apt-get install git -y -q
    sudo apt-get install -y autotools-dev
    sudo apt-get install -y automake
    sudo apt-get install -y autoconf
```

#### <a name="for-all-distros-copy-compile-and-install-sockperf-according-to-the-following-steps"></a>Для всех дистрибутивов скопируйте, скомпилируйте и установите Соккперф в соответствии с приведенными ниже шагами.
```bash
#Bash - all distros

#From bash command line (assumes git is installed)
git clone https://github.com/mellanox/sockperf
cd sockperf/
./autogen.sh
./configure --prefix=

#make is slower, may take several minutes
make

#make install is fast
sudo make install
```

### <a name="run-sockperf-on-the-vms"></a>Запуск Соккперф на виртуальных машинах

После завершения установки Соккперф виртуальные машины готовы к запуску тестов задержки. 

Сначала запустите Соккперф на ПОЛУЧАТЕЛЕ.

Любой доступный номер порта прекрасно подходит. В этом примере мы используем порт 12345:
```bash
#Server/Receiver - assumes server's IP is 10.0.0.4:
sudo sockperf sr --tcp -i 10.0.0.4 -p 12345
```
Теперь, когда сервер прослушивает, клиент может начать отправку пакетов на сервер через порт, на котором он прослушивается, в данном случае 12345.

Около 100 секунд достаточно долго для возврата репрезентативных результатов, как показано в следующем примере:
```bash
#Client/Sender - assumes server's IP is 10.0.0.4:
sockperf ping-pong -i 10.0.0.4 --tcp -m 350 -t 101 -p 12345  --full-rtt
```

Дождитесь результатов. В зависимости от того, насколько далеко находятся виртуальные машины, количество итераций будет разным. Рекомендуется начать с более коротких тестов около 5 секунд для проверки успешности перед выполнением длинных тестов.

В этом примере Соккперф используется размер сообщения 350 байт, поскольку он представляет собой типичный пакет среднего размера. Размер сообщения можно изменить выше или ниже, чтобы получить результаты, более точно отражающие рабочую нагрузку, которая будет выполняться на виртуальных машинах.


## <a name="next-steps"></a>Дальнейшие действия
* Повышение задержки с помощью [группы размещения](https://docs.microsoft.com/azure/virtual-machines/linux/co-location) службы "близость" Azure
* Узнайте, как [оптимизировать сетевые подключения для виртуальных машин](../virtual-network/virtual-network-optimize-network-bandwidth.md) в вашем сценарии.
* Узнайте, как [выделяется пропускная способность для виртуальных машин](../virtual-network/virtual-machine-network-throughput.md)
* Дополнительные сведения см. в статье [Виртуальная сеть Azure: часто задаваемые вопросы](../virtual-network/virtual-networks-faq.md).
