---
title: Развертывание Azure Databricks в вашей виртуальной сети (Предварительная версия)
description: В этой статье описывается развертывание Azure Databricks к виртуальной сети, также называется путем внедрения кода виртуальной сети.
services: azure-databricks
author: mamccrea
ms.author: mamccrea
ms.reviewer: jasonh
ms.service: azure-databricks
ms.topic: conceptual
ms.date: 03/18/2019
ms.openlocfilehash: 2db588a0cf67d7826408139e8facb43a2e897951
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "62126687"
---
# <a name="deploy-azure-databricks-in-your-virtual-network-preview"></a>Развертывание Azure Databricks в вашей виртуальной сети (Предварительная версия)

Развертывание по умолчанию из Azure Databricks — это полностью управляемая служба в Azure: все ресурсы плоскости данных, включая виртуальную сеть (VNet), развертываются в группу заблокированного ресурса. Если необходимо изменить сети, тем не менее, можно развернуть ресурсы Azure Databricks в собственной виртуальной сети (также именем виртуальной сети путем внедрения кода), когда позволяет:

* Подключения Azure Databricks к другим службам Azure (например, службу хранилища Azure) в более безопасном режиме с помощью конечных точек службы.
* Подключение к локальным данным источников для использования с помощью Azure Databricks, используя преимущества определяемые пользователем маршруты.
* Подключения Azure Databricks к виртуальный сетевой модуль для проверки весь исходящий трафик и предпринять действия по разрешающих и запрещающих правил.
* Настройка Azure Databricks, чтобы использовать пользовательский DNS-сервер.
* Настройте правила группы безопасности сети, чтобы указать ограничения исходящего трафика.
* Развертывание кластеров Azure Databricks в имеющуюся виртуальную сеть.

Развертывание ресурсов Azure Databricks к виртуальной сети также позволяет воспользоваться преимуществами гибкой диапазоны CIDR (в любом месте между /16-/ 24 для виртуальной сети, а также между /18-/ 26 для подсетей).

  > [!NOTE]
  > Невозможно заменить виртуальную сеть для существующей рабочей области. Если в текущую рабочую область, не может вместить необходимое количество активные узлы кластера, создайте другую рабочую область в более крупной виртуальной сети. Выполните [эти подробные указания по миграции](howto-regional-disaster-recovery.md#detailed-migration-steps) копирование ресурсов (записные книжки, конфигурации кластера, задания) из старого в новой рабочей области.

## <a name="virtual-network-requirements"></a>Требования к виртуальной сети

Интерфейс развертывания рабочей области Azure Databricks на портале Azure можно использовать для автоматической настройки существующей виртуальной сети с требуются подсети, группы безопасности сети и параметры в список разрешений, или можно использовать Azure Resource Manager шаблоны для настройки виртуальной сети и развертывания рабочей области.

Развертывание рабочей области Azure Databricks для выбранной виртуальной сети должна отвечать следующим требованиям:

### <a name="location"></a>Расположение

Виртуальная сеть должны находиться в том же расположении, что рабочей области Azure Databricks.

### <a name="subnets"></a>Подсети

Виртуальная сеть должна включать две подсети, предназначенный для Azure Databricks:

   1. Частной подсети настроенные сетевые группы безопасности, которая обеспечивает обмен данными внутри кластера

   2. Общедоступной подсети с группой безопасности сеть настроена, позволяющем связываться с плоскостью управления Azure Databricks.

### <a name="address-space"></a>Пространство адресов

Блок CIDR между /16 — / 24 для виртуальной сети, а блок CIDR между /18-/26 для частных и общедоступных подсетей.

### <a name="whitelisting"></a>Включение в список зарегистрированных пользователей

Весь входящий и исходящий трафик между подсетями и плоскостью управления Azure Databricks должны быть добавлены в список разрешений.

## <a name="create-an-azure-databricks-workspace"></a>Создание рабочей области Azure Databricks

В этом разделе описывается, как создать рабочую область Azure Databricks на портале Azure и развернуть его в существующую виртуальную сеть. Azure Databricks обновляет виртуальную сеть с двумя новых подсетей и групп безопасности сети с помощью предоставленных вами диапазоны CIDR, разрешенных входящих подключений и подсеть исходящего трафика и развертывает рабочую область обновленной виртуальной сети.

## <a name="prerequisites"></a>Технические условия

Необходимо иметь виртуальную сеть, к которому вы развернете рабочей области Azure Databricks. Можно использовать существующую виртуальную сеть или создайте новую, но виртуальная сеть должны находиться в том же регионе, что рабочей области Azure Databricks, который планируется создать. Для виртуальной сети необходим диапазон CIDR между /16-диапазоном/24.

  > [!Warning]
  > Рабочая область с более мелкие виртуальной сети — т. е ниже CIDR диапазона — может закончиться IP-адреса (пространство сети) быстрее, чем рабочая область с более крупной виртуальной сети. Например, рабочая область с/24 виртуальную сеть и /26 подсети может иметь не более 64 узлов в каждый момент времени, тогда как рабочая область с /20 виртуальную сеть и/22 до подсети можно разместить до 1024 узлов.

  В подсетях создается автоматически при настройке рабочей области, и у вас будет возможность предоставить диапазон CIDR для подсети во время настройки.

## <a name="configure-the-virtual-network"></a>Настройка виртуальной сети

1. На портале Azure выберите **+ создать ресурс > Аналитика > Azure Databricks** откроется диалоговое окно службы Azure Databricks.

2. Выполните шаги настройки, описанные на шаге 2: Создание рабочей области Azure Databricks руководства по началу работы и флажок "рабочей области Azure Databricks развертывание в вашей виртуальной сети".

   ![Создание службы Azure Databricks](./media/vnet-injection/create-databricks-service.png)

3. Выберите виртуальную сеть, которую вы хотите использовать.

   ![Параметры виртуальной сети](./media/vnet-injection/select-vnet.png)

4. Укажите диапазоны CIDR, в блоке между /18-/26 для подсетей, выделенный для Azure Databricks:

   * Общедоступной подсети создается с группой безопасности связанной сети, позволяющем связываться с плоскостью управления Azure Databricks.
   * Частной подсети создается с группой безопасности связанной сети, которая обеспечивает обмен данными внутри кластера.

5. Нажмите кнопку **создать** для развертывания рабочей области Azure Databricks к виртуальной сети.

## <a name="advanced-resource-manager-configurations"></a>Диспетчер конфигурации дополнительных ресурсов

Если требуется больший контроль над конфигурацией виртуальной сети — например, вы хотите использовать существующих подсетях, используйте существующие группы безопасности сети или создать собственные правила безопасности — можно использовать следующие шаблоны Azure Resource Manager, а не развертывание и настройка рабочей области портала виртуальной сети.

### <a name="all-in-one"></a>В одном решении

Чтобы создать виртуальную сеть, группы безопасности сети и рабочей области Azure Databricks в одном решении, используйте [All-In-one шаблон для рабочих областей Databricks виртуальной сети вставлен](https://azure.microsoft.com/resources/templates/101-databricks-all-in-one-template-for-vnet-injection/).

При использовании этого шаблона, вы не обязательно должны сделать любой вручную список разрешенных для трафика подсети.

### <a name="network-security-groups"></a>Группы безопасности сети

Создание групп безопасности сети с необходимые правила для существующей виртуальной сети, использовать [шаблон группы безопасности сети для внедрения виртуальной сети Databricks](https://azure.microsoft.com/resources/templates/101-databricks-nsg-for-vnet-injection).

При использовании этого шаблона, вы не обязательно должны сделать любой вручную список разрешенных для трафика подсети.

### <a name="virtual-network"></a>Виртуальная сеть

Чтобы создать виртуальную сеть с правильной общедоступной и частной подсетями, использовать [шаблона виртуального сети для виртуальной сети внедрения Databricks](https://azure.microsoft.com/resources/templates/101-databricks-vnet-for-vnet-injection).

При использовании этого шаблона без параметра шаблона группы безопасности сети, необходимо вручную добавить правила списка разрешений для групп безопасности сети, используемой с виртуальной сетью.

### <a name="azure-databricks-workspace"></a>Рабочая область Azure Databricks

Чтобы развернуть рабочую область Azure Databricks к существующей виртуальной сети с общедоступной и частной подсетями и правильно настроенные сетевые группы безопасности, уже настроен, используйте [шаблон рабочей области для внедрения виртуальной сети Databricks](https://azure.microsoft.com/resources/templates/101-databricks-workspace-with-vnet-injection).

При использовании этого шаблона без параметра шаблона группы безопасности сети, необходимо вручную добавить правила списка разрешений для групп безопасности сети, используемой с виртуальной сетью.

## <a name="whitelisting-subnet-traffic"></a>Трафик подсети в список разрешений

Если вы не используете [портала Azure](https://docs.azuredatabricks.net/administration-guide/cloud-configurations/azure/vnet-inject.html#vnet-inject-portal) или [шаблонов Azure Resource Manager](https://docs.azuredatabricks.net/administration-guide/cloud-configurations/azure/vnet-inject.html#vnet-inject-advanced) Создание групп безопасности сети, необходимо вручную список разрешений следующие трафика в подсети.

|Направление|Протокол|source|Исходный порт|Место назначения|Конечный порт|
|---------|--------|------|-----------|-----------|----------------|
|Входящий трафик|\*|Виртуальная сеть|\*|\*|\*|
|Входящий трафик|\*|IP-адресов NAT плоскости управления|\*|\*|22|
|Входящий трафик|\*|IP-адресов NAT плоскости управления|\*|\*|5557|
|Исходящие|\*|\*|\*|IP-адрес веб-приложения|\*|
|Исходящие|\*|\*|\*|SQL (тег службы)|\*|
|Исходящие|\*|\*|\*|Хранилище (тег службы)|\*|
|Исходящие|\*|\*|\*|Виртуальная сеть|\*|

Трафик подсети список разрешений, с помощью следующих IP-адреса. Для SQL (хранилище метаданных) и хранилища (артефакта и журнала хранилища), следует использовать Sql и хранилища [теги служб](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags).

|Регион Azure Databricks|Service|Общедоступный IP-адрес|
|-----------------------|-------|---------|
|Восточная часть США|Плоскость управления NAT </br></br>Веб-приложения|23.101.152.95/32 </br></br>40.70.58.221/32|
|Восток США 2|Плоскость управления NAT </br></br>Веб-приложения|23.101.152.95/32 </br></br>40.70.58.221/32|
|Центрально-северная часть США|Плоскость управления NAT </br></br>Веб-приложения|23.101.152.95/32 </br></br>40.70.58.221/32|
|Центральный регион США|Плоскость управления NAT </br></br>Веб-приложения|23.101.152.95/32 </br></br>40.70.58.221/32|
|Центрально-южная часть США|Плоскость управления NAT </br></br>Веб-приложения|40.83.178.242/32 </br></br>40.118.174.12/32|
|Запад США|Плоскость управления NAT </br></br>Веб-приложения|40.83.178.242/32 </br></br>40.118.174.12/32|
|Западный регион США 2|Плоскость управления NAT </br></br>Веб-приложения|40.83.178.242/32 </br></br>40.118.174.12/32|
|Центральная Канада|Плоскость управления NAT </br></br>Веб-приложения|40.85.223.25/32 </br></br>13.71.184.74/32|
|Восточная Канада|Плоскость управления NAT </br></br>Веб-приложения|40.85.223.25/32 </br></br>13.71.184.74/32|
|Западная часть Великобритании|Плоскость управления NAT </br></br>Веб-приложения|51.140.203.27/32 </br></br>51.140.204.4/32|
|Южная часть Великобритании|Плоскость управления NAT </br></br>Веб-приложения|51.140.203.27/32 </br></br>51.140.204.4/32|
|Западная Европа|Плоскость управления NAT </br></br>Веб-приложения|23.100.0.135/32 </br></br>52.232.19.246/32|
|Северная Европа|Плоскость управления NAT </br></br>Веб-приложения|23.100.0.135/32 </br></br>52.232.19.246/32|
|Центральная Индия|Плоскость управления NAT </br></br>Веб-приложения|104.211.89.81/32 </br></br>104.211.101.14/32|
|Южная Индия|Плоскость управления NAT </br></br>Веб-приложения|104.211.89.81/32 </br></br>104.211.101.14/32|
|Западная Индия|Плоскость управления NAT </br></br>Веб-приложения|104.211.89.81/32 </br></br>104.211.101.14/32|
|Юго-Восточная Азия|Плоскость управления NAT </br></br>Веб-приложения|52.187.0.85/32 </br></br>52.187.145.107/32|
|Восточная Азия|Плоскость управления NAT </br></br>Веб-приложения|52.187.0.85/32 </br></br>52.187.145.107/32|
|Восточная часть Австралии|Плоскость управления NAT </br></br>Веб-приложения|13.70.105.50/32 </br></br>13.75.218.172/32|
|Юго-Восточная часть Австралии|Плоскость управления NAT </br></br>Веб-приложения|13.70.105.50/32 </br></br>13.75.218.172/32|
|Центральная Австралия|Плоскость управления NAT </br></br>Веб-приложения|13.70.105.50/32 </br></br>13.75.218.172/32|
|Центральная Австралия 2|Плоскость управления NAT </br></br>Веб-приложения|13.70.105.50/32 </br></br>13.75.218.172/32|
|Восточная часть Японии|Плоскость управления NAT </br></br>Веб-приложения|13.78.19.235/32 </br></br>52.246.160.72/32|
|Западная часть Японии|Плоскость управления NAT </br></br>Веб-приложения|13.78.19.235/32 </br></br>52.246.160.72/32|

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="workspace-launch-errors"></a>Ошибки запуска рабочей области

Запуск рабочей области в настраиваемой виртуальной сети происходит сбой в Azure Databricks входа, в котором со следующей ошибкой: **«Мы ошибка при создании рабочей области. Убедитесь, что используется правильная конфигурация настраиваемой сети и повторите попытку.»**

Эта ошибка вызвана конфигурации сети, не соответствует требованиям. Убедитесь, что вы выполнили инструкции в этом разделе, при создании рабочей области.

### <a name="cluster-creation-errors"></a>Ошибки при создании кластера

**Экземпляры недоступен: Ресурсы не были доступны по протоколу SSH.**

Возможная причина: блокируется трафика от плоскости управления для рабочих ролей. Исправление, гарантируя, что правила безопасности для входящего трафика соответствуют требованиям. Если развертываются на существующую виртуальную сеть, подключенная к локальной сети, просмотрите настройки, используя сведения, предоставленные в подключении к сети в локальной рабочей области Azure Databricks.

**Сбой Непредвиденная запуска: При настройке кластера произошла непредвиденная ошибка. Повторите попытку и обратитесь в службу Azure Databricks, если проблема будет повторяться. Внутреннее сообщение об ошибке: Время ожидания при помещении узла.**

Возможная причина: блокируется трафика из рабочих ролей к конечным точкам хранилища Azure. Исправление, гарантируя, что правила безопасности для исходящего трафика соответствуют требованиям. Если вы используете пользовательские DNS-серверы, также проверьте состояние DNS-серверов в виртуальной сети.

**Сбой запуска поставщика облачных служб: При настройке кластера произошла ошибка поставщика облачных служб. См. Дополнительные сведения можно найти в руководстве Azure Databricks. Код ошибки Azure: AuthorizationFailed/InvalidResourceReference.**

Возможная причина: виртуальную сеть или подсети больше не существует. Убедитесь, что существуют виртуальной сети и подсети.

**Завершен кластера. Причина: Сбой запуска SPARK: Не удалось вовремя запустить Spark. Эта проблема может быть вызвана неработающий хранилища метаданных Hive, недопустимые конфигурации Spark или сбои init сценариев. См. журналы драйвера Spark, чтобы устранить эту проблему и если ошибка повторится, обратитесь к Databricks. Внутреннее сообщение об ошибке: Не удалось запустить SPARK: Драйвер не удалось запустить во времени.**

Возможная причина: Контейнер не может взаимодействовать с размещенном экземпляре или учетной записи хранения DBFS. Исправьте, добавив настраиваемый маршрут для подсети для учетной записи хранения DBFS со следующим прыжком, Интернет.

### <a name="notebook-command-errors"></a>Ошибки команды записной книжки

**Команда не отвечает**

Возможная причина: рабочей роли для рабочей роли обмен данными блокируется. Исправление, убедившись, что правила безопасности для входящего трафика соответствуют требованиям.

**Рабочий процесс записной книжки завершится ошибкой с исключением: com.databricks.WorkflowException: org.apache.http.conn.ConnectTimeoutException**

Возможная причина: блокируется трафика из рабочих ролей к веб-приложений Azure Databricks. Исправление, убедившись, что правила безопасности для исходящего трафика соответствуют требованиям.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Извлечение, преобразование и загрузка данных с помощью Azure Databricks](databricks-extract-load-sql-data-warehouse.md)
