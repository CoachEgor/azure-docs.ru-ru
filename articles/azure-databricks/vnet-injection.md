---
title: Развертывание Azure Databricks в виртуальной сети
description: В этой статье описывается, как развертывать Azure Databricks в виртуальной сети, также называемой внедрением VNet.
services: azure-databricks
author: mamccrea
ms.author: mamccrea
ms.reviewer: jasonh
ms.service: azure-databricks
ms.topic: conceptual
ms.date: 10/10/2019
ms.openlocfilehash: 0bb3221c201e6dd4dd17cca8ef7e3ed3331de228
ms.sourcegitcommit: 77bfc067c8cdc856f0ee4bfde9f84437c73a6141
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72432663"
---
# <a name="deploy-azure-databricks-in-your-virtual-network"></a>Развертывание Azure Databricks в виртуальной сети

Развертывание Azure Databricks по умолчанию — это полностью управляемая служба в Azure: все ресурсы плоскости данных, включая виртуальную сеть, развертываются в заблокированной группе ресурсов. Если вам требуется настройка сети, можно развернуть Azure Databricks ресурсы в своей виртуальной сети (также называемой внедрением виртуальной сети), когда позволит вам:

* Подключайте Azure Databricks к другим службам Azure (например, службе хранилища Azure) более безопасным образом с помощью конечных точек службы.
* Подключение к локальным источникам данных для использования с Azure Databricks, используя преимущества определяемых пользователем маршрутов.
* Подключите Azure Databricks к сетевому виртуальному устройству для проверки всего исходящего трафика и выполнения действий в соответствии с разрешающими и запрещающими правилами.
* Настройте Azure Databricks для использования настраиваемой службы DNS.
* Настройте правила группы безопасности сети (NSG), чтобы указать ограничения трафика исходящих данных.
* Развертывание Azure Databricks кластеров в существующей виртуальной сети.

Развертывание ресурсов Azure Databricks в своей виртуальной сети также позволяет использовать гибкие диапазоны CIDR (где угодно между/16-/24 для виртуальной сети и между/18-/26 для подсетей).

  > [!NOTE]
  > Невозможно заменить виртуальную сеть для существующей рабочей области. Если текущая рабочая область не может разместить необходимое количество активных узлов кластера, создайте другую рабочую область в более крупной виртуальной сети. Выполните [эти подробные шаги миграции](howto-regional-disaster-recovery.md#detailed-migration-steps) , чтобы скопировать ресурсы (записные книжки, конфигурации кластера, задания) из старой в новую рабочую область.

## <a name="virtual-network-requirements"></a>Требования к виртуальной сети

Вы можете использовать интерфейс развертывания Azure Databricks рабочей области в портал Azure для автоматической настройки существующей виртуальной сети с необходимыми подсетями, группой безопасности сети и параметрами список разрешений, либо можно использовать Azure Resource Manager шаблоны для настройки виртуальной сети и развертывания рабочей области.

Виртуальная сеть, в которой развертывается Рабочая область Azure Databricks, должна соответствовать следующим требованиям.

### <a name="location"></a>Location

Виртуальная сеть должна находиться в том же расположении, что и Рабочая область Azure Databricks.

### <a name="subnets"></a>Подсети

Виртуальная сеть должна содержать две подсети, выделенные для Azure Databricks:

   1. Частная подсеть с настроенной группой безопасности сети, которая обеспечивает внутреннее взаимодействие с кластером

   2. Общедоступная подсеть с настроенной группой безопасности сети, которая позволяет обмениваться данными с плоскостью управления Azure Databricks.

### <a name="address-space"></a>Пространство адресов

Блок CIDR между/16-/24 для виртуальной сети и блок CIDR между/18-/26 для частных и общедоступных подсетей.

### <a name="whitelisting"></a>Включение в список зарегистрированных пользователей

Весь исходящий и входящий трафик между подсетями и плоскостью управления Azure Databricks должен быть список разрешений.

## <a name="create-an-azure-databricks-workspace"></a>Создание рабочей области Azure Databricks

В этом разделе описано, как создать рабочую область Azure Databricks в портал Azure и развернуть ее в существующей виртуальной сети. Azure Databricks обновляет виртуальную сеть с двумя новыми подсетями и группами безопасности сети, используя предоставленные вами диапазоны CIDR, добавляются входящий и исходящий трафик подсети и развертывает рабочую область в обновленной виртуальной сети.

## <a name="prerequisites"></a>Технические условия

Необходимо наличие виртуальной сети, в которой будет развернута рабочая область Azure Databricks. Вы можете использовать существующую виртуальную сеть или создать новую, но виртуальная сеть должна находиться в том же регионе, что и Рабочая область Azure Databricks, которую планируется создать. Для виртуальной сети требуется диапазон CIDR от/16-/24.

  > [!Warning]
  > Рабочая область с меньшей виртуальной сетью, то есть меньшего диапазона CIDR, может работать с небольшими IP-адресами (сетевое пространство) быстрее, чем Рабочая область с крупной виртуальной сетью. Например, Рабочая область с виртуальной сетью (/24) и/26 подсетями может одновременно иметь не более 64 узлов, а Рабочая область с подсетями/20 и/22 может содержать не более 1024 узлов.

  Подсети будут созданы автоматически при настройке рабочей области, и у вас будет возможность предоставить диапазон CIDR для подсетей во время настройки.

## <a name="configure-the-virtual-network"></a>Настройка виртуальной сети

1. В портал Azure выберите **+ создать ресурс > аналитика > Azure Databricks** , чтобы открыть диалоговое окно службы Azure Databricks.

2. Выполните действия по настройке, описанные в разделе Шаг 2. Создание Azure Databricks рабочей области в руководстве по начало работы, и выберите параметр развернуть Azure Databricks рабочую область в виртуальной сети.

   ![Создание службы Azure Databricks](./media/vnet-injection/create-databricks-service.png)

3. Выберите виртуальную сеть, которую вы хотите использовать.

   ![Параметры виртуальной сети](./media/vnet-injection/select-vnet.png)

4. Укажите диапазоны CIDR в блоке между/18-/26 для двух подсетей, выделенных для Azure Databricks:

   * Будет создана общедоступная подсеть с соответствующей группой безопасности сети, которая обеспечивает связь с плоскостью управления Azure Databricks.
   * Будет создана частная подсеть с соответствующей группой безопасности сети, которая обеспечивает внутреннюю связь с кластером.

5. Нажмите кнопку **создать** , чтобы развернуть рабочую область Azure Databricks в виртуальной сети.

## <a name="advanced-resource-manager-configurations"></a>Расширенные конфигурации Resource Manager

Если требуется больший контроль над конфигурацией виртуальной сети, например, если вы хотите использовать существующие подсети, использовать существующие группы безопасности сети или создать собственные правила безопасности, можно использовать следующие шаблоны Azure Resource Manager вместо Конфигурация виртуальной сети портала и развертывание рабочей области.

### <a name="all-in-one"></a>Все в одном

Чтобы создать виртуальную сеть, группы безопасности сети и рабочую область Azure Databricks в одном, используйте шаблон " [все в одном" для подсетей VNet, добавленных в виртуальную](https://azure.microsoft.com/resources/templates/101-databricks-all-in-one-template-for-vnet-injection/)сеть.

При использовании этого шаблона не нужно выполнять никаких ручных список разрешений трафика подсети.

### <a name="network-security-groups"></a>Группы безопасности сети

Чтобы создать группы безопасности сети с необходимыми правилами для существующей виртуальной сети, используйте [шаблон группы безопасности сети для внедрения в VNet](https://azure.microsoft.com/resources/templates/101-databricks-all-in-one-template-for-vnet-injection/).

При использовании этого шаблона не нужно выполнять никаких ручных список разрешений трафика подсети.

### <a name="virtual-network"></a>Виртуальная сеть

Чтобы создать виртуальную сеть с правильными общедоступными и частными подсетями, используйте [шаблон виртуальной сети для внедрения VNet](https://azure.microsoft.com/resources/templates/101-databricks-vnet-for-vnet-injection)в виртуальную сеть.

Если вы используете этот шаблон без использования шаблона групп безопасности сети, необходимо вручную добавить правила список разрешений в группы безопасности сети, используемые в виртуальной сети.

### <a name="azure-databricks-workspace"></a>Рабочая область Azure Databricks

Чтобы развернуть рабочую область Azure Databricks в существующей виртуальной сети, которая имеет общедоступные и частные подсети и правильно настроенные группы безопасности сети, используйте [шаблон рабочей области для внедрения виртуальной сети в модулях](https://azure.microsoft.com/resources/templates/101-databricks-workspace-with-vnet-injection)данных.

Если вы используете этот шаблон без использования шаблона групп безопасности сети, необходимо вручную добавить правила список разрешений в группы безопасности сети, используемые в виртуальной сети.

## <a name="whitelisting-subnet-traffic"></a>Трафик подсети список разрешений

Если вы не используете шаблоны [портал Azure](https://docs.azuredatabricks.net/administration-guide/cloud-configurations/azure/vnet-inject.html#vnet-inject-portal) или [Azure Resource Manager](https://docs.azuredatabricks.net/administration-guide/cloud-configurations/azure/vnet-inject.html#vnet-inject-advanced) для создания групп безопасности сети, необходимо вручную список разрешений следующий трафик в подсети.

|Направление|Протокол|Источник|Исходный порт|Место назначения|Конечный порт|
|---------|--------|------|-----------|-----------|----------------|
|Вход.|\*|Виртуальная сеть|\*|\*|\*|
|Вход.|\*|IP-адрес преобразования для плоскости управления|\*|\*|22|
|Вход.|\*|IP-адрес преобразования для плоскости управления|\*|\*|5557|
|Исход.|\*|\*|\*|Webapp IP-адрес|\*|
|Исход.|\*|\*|\*|SQL (тег службы)|\*|
|Исход.|\*|\*|\*|Хранилище (тег службы)|\*|
|Исход.|\*|\*|\*|Виртуальная сеть|\*|

Список разрешений трафика подсети с помощью следующих IP-адресов. Для SQL (хранилище метаданных) и хранилища (артефакты и хранилища журналов) следует использовать [теги службы](https://docs.microsoft.com/azure/virtual-network/security-overview#service-tags)SQL и хранилища.

|Регион Azure Databricks|Служба|Общедоступный IP-адрес|
|-----------------------|-------|---------|
|Восточная часть США|Управление NAT на плоскости управления </br></br>Webapp|23.101.152.95/32 </br></br>40.70.58.221/32|
|Восточная часть США 2|Управление NAT на плоскости управления </br></br>Webapp|23.101.152.95/32 </br></br>40.70.58.221/32|
|Центрально-северная часть США|Управление NAT на плоскости управления </br></br>Webapp|23.101.152.95/32 </br></br>40.70.58.221/32|
|Центральная часть США|Управление NAT на плоскости управления </br></br>Webapp|23.101.152.95/32 </br></br>40.70.58.221/32|
|Центрально-южная часть США|Управление NAT на плоскости управления </br></br>Webapp|40.83.178.242/32 </br></br>40.118.174.12/32|
|Западная часть США|Управление NAT на плоскости управления </br></br>Webapp|40.83.178.242/32 </br></br>40.118.174.12/32|
|Западная часть США 2|Управление NAT на плоскости управления </br></br>Webapp|40.83.178.242/32 </br></br>40.118.174.12/32|
|Центральная Канада|Управление NAT на плоскости управления </br></br>Webapp|40.85.223.25/32 </br></br>13.71.184.74/32|
|Восточная Канада|Управление NAT на плоскости управления </br></br>Webapp|40.85.223.25/32 </br></br>13.71.184.74/32|
|Западная часть Соединенного Королевства|Управление NAT на плоскости управления </br></br>Webapp|51.140.203.27/32 </br></br>51.140.204.4/32|
|Южная часть Соединенного Королевства|Управление NAT на плоскости управления </br></br>Webapp|51.140.203.27/32 </br></br>51.140.204.4/32|
|Западная Европа|Управление NAT на плоскости управления </br></br>Webapp|23.100.0.135/32 </br></br>52.232.19.246/32|
|Северная Европа|Управление NAT на плоскости управления </br></br>Webapp|23.100.0.135/32 </br></br>52.232.19.246/32|
|Центральная Индия|Управление NAT на плоскости управления </br></br>Webapp|104.211.89.81/32 </br></br>104.211.101.14/32|
|Южная Индия|Управление NAT на плоскости управления </br></br>Webapp|104.211.89.81/32 </br></br>104.211.101.14/32|
|Западная Индия|Управление NAT на плоскости управления </br></br>Webapp|104.211.89.81/32 </br></br>104.211.101.14/32|
|Юго-Восточная Азия|Управление NAT на плоскости управления </br></br>Webapp|52.187.0.85/32 </br></br>52.187.145.107/32|
|Восточная Азия|Управление NAT на плоскости управления </br></br>Webapp|52.187.0.85/32 </br></br>52.187.145.107/32|
|Восточная Австралия|Управление NAT на плоскости управления </br></br>Webapp|13.70.105.50/32 </br></br>13.75.218.172/32|
|Юго-Восточная Австралия|Управление NAT на плоскости управления </br></br>Webapp|13.70.105.50/32 </br></br>13.75.218.172/32|
|Центральная Австралия|Управление NAT на плоскости управления </br></br>Webapp|13.70.105.50/32 </br></br>13.75.218.172/32|
|Центральная Австралия 2|Управление NAT на плоскости управления </br></br>Webapp|13.70.105.50/32 </br></br>13.75.218.172/32|
|Восточная Япония|Управление NAT на плоскости управления </br></br>Webapp|13.78.19.235/32 </br></br>52.246.160.72/32|
|Западная Япония|Управление NAT на плоскости управления </br></br>Webapp|13.78.19.235/32 </br></br>52.246.160.72/32|

## <a name="troubleshooting"></a>Устранение неисправностей

### <a name="workspace-launch-errors"></a>Ошибки при запуске рабочей области

Запуск рабочей области в пользовательской виртуальной сети завершается сбоем на Azure Databricks экране входа со следующей ошибкой: **"произошла ошибка при создании рабочей области. Убедитесь, что настроена правильная конфигурация сети, и повторите попытку. "**

Эта ошибка вызвана тем, что конфигурация сети не соответствует требованиям к собранию. При создании рабочей области убедитесь, что выполнены инструкции, приведенные в этом разделе.

### <a name="cluster-creation-errors"></a>Ошибки при создании кластера

**Недостижимые экземпляры: ресурсы недоступны через SSH.**

Возможная причина: трафик из плоскости управления в рабочие роли блокируется. Исправить, убедившись, что правила безопасности для входящего трафика соответствуют требованиям. При развертывании в существующей виртуальной сети, подключенной к локальной сети, проверьте установку, используя сведения, приведенные в подразделе подключение рабочей области Azure Databricks к локальной сети.

**Непредвиденный сбой при запуске: при настройке кластера произошла непредвиденная ошибка. Повторите попытку и обратитесь в Azure Databricks, если проблема повторится. Внутреннее сообщение об ошибке: истекло время ожидания при помещении узла.**

Возможная причина: трафик от рабочих ролей к конечным точкам службы хранилища Azure заблокирован. Исправить, убедившись, что правила безопасности исходящего трафика соответствуют требованиям. Если вы используете пользовательские DNS-серверы, также проверьте состояние DNS-серверов в виртуальной сети.

**Сбой при запуске поставщика облачных служб: произошла ошибка поставщика облачных служб при настройке кластера. Дополнительные сведения см. в разделе Azure Databricks Guide. Код ошибки Azure: AuthorizationFailed/Инвалидресаурцереференце.**

Возможная причина: виртуальная сеть или подсети больше не существует. Убедитесь, что виртуальная сеть и подсети существуют.

**Работа кластера прекращена. Причина: сбой запуска Spark: не удалось запустить Spark вовремя. Эта проблема может быть вызвана неработающей хранилище метаданных Hive, недопустимыми конфигурациями Spark или неработающими сценариями инициализации. Чтобы устранить эту неполадку, обратитесь к журналам драйверов Spark и свяжитесь с модулями в случае повторения ошибки. Внутреннее сообщение об ошибке: не удалось запустить Spark: драйвер не удалось запустить вовремя.**

Возможная причина: контейнер не может взаимодействовать с учетной записью хранения DBFS или экземпляром размещения. Чтобы устранить проблему, добавьте настраиваемый маршрут в подсети для учетной записи хранения DBFS со следующим прыжком к Интернету.

### <a name="notebook-command-errors"></a>Ошибки команды записной книжки

**Команда не отвечает**

Возможная причина: обмен данными между рабочими работниками заблокирован. Исправьте их, убедившись, что правила безопасности для входящего трафика соответствуют требованиям.

**Рабочий процесс записной книжки завершается с исключением: com. Воркфловексцептион: org. Apache. http. conn. Коннекттимеаутексцептион**

Возможная причина: трафик от рабочих ролей к Azure Databricks webapp заблокирован. Исправьте их, убедившись в том, что правила безопасности для исходящего трафика соответствуют требованиям.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Извлечение, преобразование и загрузка данных с помощью Azure Databricks](databricks-extract-load-sql-data-warehouse.md)
