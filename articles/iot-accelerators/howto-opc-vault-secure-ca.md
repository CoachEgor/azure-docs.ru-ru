---
title: Безопасное выполнение службы управления сертификатами хранилища OPC в Azure | Документация Майкрософт
description: В этой статье описывается, как безопасно запустить службу управления сертификатами хранилища OPC в Azure и другие рекомендации по безопасности.
author: mregen
ms.author: mregen
ms.date: 8/16/2019
ms.topic: conceptual
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: f35836f60fae11c0955c128e96a4cea188681942
ms.sourcegitcommit: 4b8a69b920ade815d095236c16175124a6a34996
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2019
ms.locfileid: "69997662"
---
# <a name="how-to-run-the-opc-vault-certificate-management-service-securely"></a>Безопасное выполнение службы управления сертификатами хранилища OPC

В этой статье объясняется, как безопасно запустить службу управления сертификатами хранилища OPC в Azure и использовать другие рекомендации по обеспечению безопасности.

## <a name="roles"></a>Роли

### <a name="trusted-and-authorized-roles"></a>Доверенные и полномочные роли

Микрослужба хранилища OPC настроена на предоставление отдельным ролям доступа к различным частям службы.

> [!IMPORTANT]
> Во время развертывания скрипт добавляет пользователя, запускающего скрипт развертывания, в качестве пользователя для всех ролей.
> Это назначение роли должно быть просмотрено для рабочего развертывания и перенастроено соответствующим образом, следуя приведенным ниже рекомендациям.
> Эта задача требует ручного назначения ролей и служб на портале корпоративных приложений Azure AD.

### <a name="certificate-management-service-roles"></a>Роли службы управления сертификатами

Микрослужба хранилища OPC определяют следующие роли:

- **Читатель**: По умолчанию любой пользователь, прошедший проверку подлинности в клиенте, имеет доступ на чтение. 
  - Доступ для чтения к приложениям и запросам сертификатов. Может выводить список приложений и запросов на сертификаты и выполнять запросы к ним. Кроме того, сведения об обнаружении устройств и общедоступные сертификаты доступны с доступом на чтение.
- **Модуль записи**: Роль модуля записи назначается пользователю для добавления разрешений на запись для определенных задач. 
  - Доступ для чтения и записи к приложениям и запросам сертификатов. Может регистрировать, обновлять и отменять регистрацию приложений. Может создавать запросы на сертификаты и получать утвержденные закрытые ключи и сертификаты. Также может удалять закрытые ключи.
- **Утверждающий**: Роль утверждающего назначается пользователю для утверждения или отклонения запросов сертификатов. Роль не включает другие роли.
  - Кроме роли утверждающего для доступа к API микрослужбы хранилища OPC, у пользователя также должно быть разрешение подписывания ключа в Key Vault, чтобы иметь возможность подписывать сертификаты.
  - Роль модуля записи и утверждающего должна быть назначена разным пользователям.
  - Основной ролью утверждающего является утверждение создания и отклонение запросов сертификатов.
- **Администратор**. Роль администратора назначается пользователю для управления группами сертификатов. Роль не поддерживает роль утверждающего, но включает в себя роль модуля записи.
  - Администратор может управлять группами сертификатов, изменять конфигурацию и отзывать сертификаты приложений, выдавая новый список отзыва сертификатов.
  - В идеале роли модуля записи, утверждающего и администратора назначаются разным пользователям. Для обеспечения дополнительной безопасности пользователь с ролью "Утверждающий" или "Администратор" также должен иметь разрешение на подписывание ключей в KeyVault для выдачи сертификатов или продления сертификата ЦС поставщика.
  - Помимо роли администрирования микрослужб роль включает также и не ограничивается:
    - Отвечает за администрирование реализации рекомендаций по безопасности ЦС.
    - Управление созданием, отзывом и приостановкой сертификатов. 
    - Управление жизненным циклом криптографического ключа (например, обновление ключей ЦС издателя).
    - Установка, Настройка и обслуживание служб, которые работают с ЦС.
    - Повседневная работа служб. 
    - ЦС и резервное копирование и восстановление базы данных.

### <a name="other-role-assignments"></a>Другие назначения ролей

Следующие роли следует также рассматривать и назначать при запуске службы:

- Бизнес-владелец контракта на закупок сертификатов с внешним корневым центром сертификации (в случае, когда владелец приобретает сертификаты из внешнего ЦС или работает с центром сертификации, подчиненным внешнему ЦС).
- Разработка и проверка центра сертификации.
- Проверка записей аудита.
- Персонал, помогающий поддерживать ЦС или управлять физическими и облачными устройствами, но не являющийся напрямую доверенным для выполнения операций ЦС, определяется как авторизованная роль. Набор задач, которым разрешено выполнять задачи авторизованной роли, также должен быть документирован.

### <a name="memberships-of-trusted-and-authorized-roles-must-be-reviewed-annually"></a>Членство доверенных и авторизованных ролей должно проверяться ежегодно

Членство доверенных и авторизованных ролей должно быть проверено по крайней мере ежеквартально, чтобы гарантировать, что набор людей (для ручных процессов) или удостоверения службы (для автоматизированных процессов) в каждой из ролей будет минимальным.

### <a name="certificate-issuance-process-must-enforce-role-separation-between-certificate-requester-and-approver"></a>Процесс выдачи сертификата должен обеспечивать разделение ролей между инициатором запроса и утверждающим сертификатом

Процесс выдачи сертификата должен обеспечивать разделение ролей между инициатором запроса сертификата и ролями утверждающего сертификата (лицами или автоматизированными системами). Выдача сертификата должна быть разрешена ролью утверждающего сертификата, которая проверяет, имеет ли запрашивающий сертификат права на получение сертификатов. Лица, которые содержат роль утверждающего сертификата, должны быть формально авторизованными лицами.

### <a name="privileged-role-management-must-restrict-access-and-be-reviewed-quarterly"></a>Управление привилегированными ролями должно ограничивать доступ и просматривать ежеквартально

Назначение привилегированных ролей, таких как авторизация членства в группе Администраторы и утверждающие, должно быть ограничено ограниченным набором уполномоченных сотрудников. Доступ к изменениям привилегированных ролей должен быть отменен в течение 24 часов. Наконец, назначения привилегированных ролей должны быть просмотрены ежеквартально, а все ненужные или просроченные назначения должны быть удалены.

### <a name="privileged-roles-should-use-two-factor-authentication"></a>Привилегированные роли должны использовать двухфакторную проверку подлинности

Многофакторная идентификация (двухфакторная проверка подлинности, MFA или ТФА) должна использоваться для интерактивного входа утверждающих лиц и администраторов в службу.

## <a name="certificate-service-operation-guidelines"></a>Рекомендации по операциям службы сертификатов

### <a name="operational-contacts"></a>Операционные контакты

Служба сертификатов должна иметь актуальный план реагирования на безопасность в файле, который содержит подробные контактные данные для ответов на рабочие инциденты.

### <a name="security-updates"></a>Обновления для системы безопасности

Все системы должны постоянно отслеживаться и обновляться с помощью последних обновлений безопасности или соответствия исправлений.

> [!IMPORTANT]
> Репозиторий GitHub службы хранилища OPC постоянно обновляется с помощью исправлений системы безопасности. Обновления на GitHub должны отслеживаться, а обновления будут применяться к службе через регулярные интервалы.

### <a name="security-monitoring"></a>Мониторинг безопасности

Подпишитесь или реализуйте соответствующий мониторинг безопасности, например, подписавшись на решение для централизованного мониторинга (например, в центре безопасности Azure, решение для мониторинга Office 365) и настроив его соответствующим образом, чтобы обеспечить передачу событий безопасности в решение для мониторинга.

> [!IMPORTANT]
> По умолчанию служба хранилища OPC развертывается с [Application Insights Azure](https://docs.microsoft.com/azure/azure-monitor/app/devops) в качестве решения для мониторинга. Настоятельно рекомендуется добавить решение для обеспечения безопасности, такое как [Центр безопасности Azure](https://azure.microsoft.com/services/security-center/) .

### <a name="assess-security-of-open-source-software-components"></a>Оценка безопасности программных компонентов с открытым исходным кодом

Все компоненты с открытым исходным кодом, используемые в продукте или службе, должны быть свободны от умеренных или более уязвимостей безопасности.

> [!IMPORTANT]
> Репозиторий GitHub службы хранилища OPC проверяет все компоненты во время сборки непрерывной интеграции на наличие уязвимостей. Обновления на GitHub должны отслеживаться, а обновления будут применяться к службе через регулярные интервалы.

### <a name="maintain-an-inventory"></a>Ведение запасов

Инвентаризация активов должна поддерживаться для всех рабочих узлов (включая постоянные виртуальные машины), устройств, всех внутренних диапазонов IP-адресов, VIP и общедоступных доменных имен DNS. Эта Инвентаризация должна быть обновлена с добавлением или удалением системы, IP-адреса устройства, виртуальных IP-адресов или общедоступного домена DNS в течение 30 дней.

#### <a name="inventory-of-the-default-azure-opc-vault-microservice-production-deployment"></a>Инвентаризация рабочего развертывания микрослужбы хранилища Azure OPC по умолчанию: 

В **Azure**:
- **App Service Plan** (План службы приложений). План службы приложений для узлов служб. Значение S1 по умолчанию.
- **Служба приложений** для микрослужбы: Узел службы хранилища OPC.
- **Служба приложений** для примера приложения: Узел примера приложения для хранилища OPC.
- **KeyVault Standard**: Для хранения секретов и ключей Cosmos DB для веб-служб.
- **KeyVault Premium**: Для размещения ключей ЦС издателя, для службы подписывания, для настройки хранилища и хранения закрытых ключей приложения.
- **Cosmos DB**. База данных для запросов приложений и сертификатов. 
- **Application Insights**: (необязательно) мониторинг решения для веб-службы и приложения.
- **Регистрация приложения AzureAD**: Регистрация для примера приложения, службы и модуля ребра.

Для облачных служб все имена узлов, группы ресурсов, названия ресурсов, идентификатор подписки, используемые для развертывания службы, должны быть документированы. 

В **IOT Edge** или на локальном **IOT Edgeном сервере**:
- **Модуль IOT Edge хранилища OPC**: Для поддержки сервера глобального обнаружения в фабричном сетевом сервере OPC UA. 

Для IoT Edge устройств имена узлов и IP-адреса должны быть документированы. 

### <a name="document-the-certification-authorities-cas"></a>Документирование центров сертификации (ЦС)

Документация по иерархии ЦС должна содержать все управляемые ЦС, включая все связанные подчиненные ЦС, родительские ЦС и корневые ЦС, даже если они не управляются службой. Вместо формальной документации можно предоставить исчерпывающий набор всех неистекших сертификатов ЦС.

> [!NOTE]
> Пример приложения для хранилища OPC поддерживает загрузку всех сертификатов, используемых и созданных в службе, для документации.

### <a name="document-the-issued-certificates-by-all-certification-authorities-cas"></a>Документирование выданных сертификатов всеми центрами сертификации (ЦС)

Для документации необходимо предоставить исчерпывающий набор всех сертификатов, выпущенных за последние 12 месяцев.

> [!NOTE]
> Пример приложения для хранилища OPC поддерживает загрузку всех сертификатов, используемых и созданных в службе, для документации.

### <a name="document-the-sop-for-securely-deleting-cryptographic-keys"></a>Документирование СОП для безопасного удаления криптографических ключей

Удаление ключа может происходить лишь редко в течение всего времени существования центра сертификации, поэтому у пользователя нет назначенного право на удаление сертификата KeyVault и почему нет интерфейсов API для удаления сертификата ЦС поставщика. Ручная стандартная процедура безопасного удаления криптографических ключей центра сертификации доступна только путем прямого доступа к KeyVault в портал Azure и путем удаления группы сертификатов в KeyVault. Чтобы обеспечить немедленное удаление, [KeyVault обратимое удаление](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete) должно быть отключено.

## <a name="certificates"></a>Сертификаты

### <a name="certificates-must-comply-with-minimum-certificate-profile"></a>Сертификаты должны соответствовать минимальному профилю сертификата

Служба хранилища OPC — это Интернет-центры сертификации (ЦС), которые выдает подписчикам сертификаты конечных сущностей.
Микрослужба хранилища OPC следует этим рекомендациям в реализации по умолчанию.

- Все сертификаты должны содержать следующие поля X. 509, как указано ниже:
  - Содержимое поля Version должно иметь значение v3. 
  - Содержимое поля serialNumber должно включать по меньшей мере 8 байт энтропии, полученное от FIPS (федеральные стандарты обработки информации) 140, утвержденный генератор случайных чисел.<br>
    > [!IMPORTANT]
    > Серийный номер хранилища OPC по умолчанию равен 20 байтам и получается от генератора криптографических случайных чисел операционной системы. Генератор случайных чисел — это FIPS 140, одобренный на устройствах Windows, но не на разновидностях Linux. Этот факт необходимо учитывать при выборе развертывания службы, в котором используются виртуальные машины Linux или контейнеры DOCKER Linux, на которых базовая технология OpenSSL не является FIPS 140 утверждена.
  - Поля Иссуеруникуеид и Субжектуникуеид не должны присутствовать.
  - Сертификаты конечных сущностей должны быть определены с помощью расширения базовых ограничений в соответствии с IETF RFC 5280.
  - Для выдающего сертификата ЦС в поле Пасленконстраинт должно быть задано значение 0. 
  - Расширение расширенного использования ключа должно присутствовать и содержать минимальный набор идентификаторов объектов расширенного использования ключа (OID). Не следует указывать OID Анекстендедкэйусаже (2.5.29.37.0). 
  - Расширение точки распространения списка отзыва сертификатов (CDP) должно присутствовать в сертификате ЦС издателя.<br>
    > [!IMPORTANT]
    > Расширение точки распространения списков отзыва сертификатов (CDP) имеется в сертификатах ЦС хранилища OPC, но на устройствах OPC UA используются настраиваемые методы распространения списков отзыва сертификатов.
  - Расширение доступа к информации о центрах сертификации должно присутствовать в сертификатах подписчика.<br>
    > [!IMPORTANT]
    > Расширение доступа к информации о центрах сертификации содержится в сертификатах подписчика хранилища OPC, но на устройствах OPC UA используются пользовательские методы для распространения сведений о ЦС издателя.
- Необходимо использовать утвержденные асимметричные алгоритмы, длины ключей, хэш-функции и режимы заполнения.
  - **RSA** и **SHA-2** являются единственными поддерживаемыми алгоритмами (*).
  - RSA может использоваться для шифрования, обмена ключами и подписи.
  - Шифрование RSA должно использовать только режимы заполнения OAEP, RSA-кем или RSA-PSS.
  - Требуется длина ключа > = 2048 бит.
  - Используйте семейство алгоритмов хэширования SHA-2 (SHA256, SHA384 и SHA512).
  - Ключи корневого ЦС RSA с типичным сроком жизни > = 20 лет должны быть 4096 бит или выше.
  - Ключи ЦС RSA Issuer должны составлять не менее 2048 бит; Если срок действия сертификата ЦС истекает через 2030, ключ ЦС должен быть больше 4096 бит.
- Время существования сертификата
  - Сертификаты корневого ЦС: Максимальный срок действия сертификата для корневого ЦС не должен превышать 25 лет.
  - Сертификаты промежуточного ЦС или ЦС онлайн-поставщика: Максимальный срок действия сертификата для центров сертификации, которые находятся в сети и выдают только сертификаты подписчиков, не должен превышать 6 лет. Для этих центров сертификации соответствующий закрытый ключ подписи не должен использоваться дольше трех лет для выпуска новых сертификатов.<br>
    > [!IMPORTANT]
    > Сертификат издателя, как он создается в микрослужбе хранилища OPC по умолчанию без внешнего корневого ЦС, рассматривается как подсистема интерактивного ЦС с соответствующими требованиями и временем существования. Время жизни по умолчанию составляет пять лет с длиной ключа > = 2048.
  - Все асимметричные ключи должны иметь максимальный срок действия в пять лет, рекомендуемый срок жизни в один год.<br>
    > [!IMPORTANT]
    > По умолчанию время существования сертификатов приложений, выданных в хранилище OPC, составляет два года и их следует заменять каждый год. 
  - Каждый раз при обновлении сертификата он обновляется с помощью нового ключа.
- Особые расширения OPC UA в сертификатах экземпляров приложения
  - Расширение subjectAltName включает URI приложения и имена узлов, которые также могут включать в себя полные доменные имена, адреса IPv4 и IPv6.
  - Кэйусаже включает Дигиталсигнатуре, неподдельность, keyEncipherment и ДатаенЦифермент.
  - Екстендедкэйусаже включает serverAuth и (или) Клиентаус.
  - Аусоритикэйидентифиер указывается в подписанных сертификатах.

### <a name="certificate-authority-ca-keys-and-certificates-must-meet-minimum-requirements"></a>Ключи и сертификаты центра сертификации должны соответствовать минимальным требованиям

- **Закрытые ключи**: Ключи **RSA** должны составлять не менее 2048 бит; Если срок действия сертификата ЦС истекает через 2030, ключ ЦС должен быть больше 4096 бит.
- **Время существования**: Максимальный срок действия сертификата для центров сертификации, которые находятся в сети и выдают только сертификаты подписчиков, не должен превышать 6 лет. Для этих центров сертификации соответствующий закрытый ключ подписи не должен использоваться дольше трех лет для выпуска новых сертификатов.

### <a name="ca-keys-are-protected-using-hardware-security-modules-hsm"></a>Ключи ЦС защищаются с помощью аппаратных модулей безопасности (HSM).

- Опкваулт использует Azure KeyVault Premium и ключи защищаются аппаратными модулями безопасности (HSM) FIPS 140-2 уровня 2. 

Криптографические модули, используемые Key Vault, будь то HSM или программные модули, соответствуют стандартам FIPS.<br>
Ключи, созданные или импортированные как АППАРАТно-защищенные, обрабатываются внутри АППАРАТного модуля безопасности, проверенного на уровне FIPS 140-2 уровня 2.<br>
Ключи, созданные или импортированные как программно-защищенные, обрабатываются в криптографических модулях с проверкой FIPS 140-2 уровня 1.

## <a name="operational-practices"></a>Рабочие методики

### <a name="document-and-maintain-standard-operational-pki-practices-for-certificate-enrollment"></a>Документирование и поддержание стандартных рабочих методов PKI для регистрации сертификатов

Документирование и обслуживание стандартных операционных процедур (SOP), определяющих выдачу сертификатов в центрах сертификации, в том числе: 
- Идентификация и проверка подлинности подписчика 
- Обработка и проверка запроса на сертификат (если применимо, включите также то, как обрабатываются запросы на продление и смены сертификатов). 
- Способ распространения выданных сертификатов подписчикам 

СОП микрослужбы хранилища OPC описывается в [обзоре](overview-opc-vault-architecture.md) и [управлении](howto-opc-vault-manage.md) документами. Рекомендации соответствуют спецификации унифицированной архитектуры OPC, часть 12. Обнаружение и глобальные службы.


### <a name="document-and-maintain-standard-operational-pki-practices-for-certificate-revocation"></a>Документирование и обслуживание стандартных рабочих методов PKI для отзыва сертификатов

Процесс отзыва сертификата описан в [обзоре](overview-opc-vault-architecture.md) и [об управлении](howto-opc-vault-manage.md) документами.
    
### <a name="document-certification-authority-ca-key-generation-ceremony"></a>Документация по созданию ключей центра сертификации (CA) формальностей 

Создание ключа ЦС издателя в микрослужбе хранилища OPC упрощено из-за защищенного хранилища в Azure KeyVault и описано в статье [Управление](howto-opc-vault-manage.md) документацией.

Однако при использовании внешнего корневого центра сертификации формальностей создания ключей центра сертификации (ЦС) должен соответствовать следующим требованиям.

Формальностей создания ключа ЦС необходимо выполнить для документированного скрипта, который включает по крайней мере следующие элементы: 
1. Определение ролей и обязанностей участников
2. Утверждение на проведение создания ключа ЦС формальностей
3. Оборудование шифрования и материалы для активации, необходимые для формальностей
4. Подготовка оборудования (включая обновление сведений о ресурсах, сведения о конфигурации и выход из нее)
5. Установка операционной системы
6. Конкретные действия, выполняемые во время создания ключа ЦС формальностей, например: 
7. Установка и настройка приложения ЦС
8. Создание ключа ЦС
9. Резервное копирование ключа ЦС
10. Подписывание сертификата ЦС
9. Импортируйте подписанные ключи в защищенный АППАРАТный модуль безопасности службы.
11. Завершение работы системы центра сертификации
12. Подготовка материалов для хранения


## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали, как безопасно управлять хранилищем OPC, предлагаем следующий шаг:

> [!div class="nextstepaction"]
> [Защита устройств OPC UA с помощью хранилища OPC](howto-opc-vault-secure.md)