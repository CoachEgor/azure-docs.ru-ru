---
title: Архитектура хранилища OPC (Azure) | Документация Майкрософт
description: Архитектура службы управления сертификатами для хранилища OPC
author: mregen
ms.author: mregen
ms.date: 08/16/2019
ms.topic: overview
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: 9331473402ddd22180df3b404824969360d48164
ms.sourcegitcommit: 4b8a69b920ade815d095236c16175124a6a34996
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2019
ms.locfileid: "69995817"
---
# <a name="opc-vault-architecture"></a>Архитектура хранилища OPC

В этой статье приводятся общие сведения о **микрослужбе хранилища OPC** и **модуле IOT Edge для хранилища OPC**.

## <a name="overview"></a>Обзор

Приложения OPC UA используют сертификаты экземпляра приложения для обеспечения безопасности на уровне приложения. Безопасное соединение устанавливается с помощью асимметричной криптографии, для которой предоставляется пара из открытого и закрытого ключей в сертификате приложения. Сертификат может быть самозаверяющим или выданным центром сертификации (ЦС).

Приложение OPC UA содержит список доверенных сертификатов для приложений, которым оно доверяет. Эти сертификаты могут быть самозаверяющими, подписанными ЦС или сами являться корневым или второстепенным ЦС. Если доверенный сертификат является частью более крупной цепочки сертификатов, приложение доверяет всем сертификатам в этой цепочке вплоть до сертификата, включенного в список доверия, если есть возможность проверить всю цепочку сертификатов.

Основное различие между доверием к самозаверяющим сертификатам и к сертификату ЦС заключается в том, что для первого потребуются дополнительные усилия на установку и поддержание доверия, а также на размещение центра сертификации конкретной компании. 

Чтобы распространить отношение доверия на самозаверяющие сертификаты для нескольких серверов с одним клиентским приложением, необходимо установить все серверные сертификаты приложений в список доверия клиентского приложения, а клиентский сертификат приложения установить во все списки доверия серверных приложений. Эти административные действия требуют значительных усилий, особенно с учетом времени существования и обновления сертификатов.

Использование центра сертификации конкретной компании может значительно упростить управление доверием при нескольких серверах и клиентах. В этом случае администратор создает сертификат экземпляра приложения, подписанный центром сертификации, только один раз для каждого используемого клиента и сервера. Кроме того, сертификат ЦС устанавливается в каждом списке доверия приложений на всех серверах и клиентах. При таком подходе нужно обновлять только сертификаты с истекшим сроком действия, заменяя их в затронутых приложениях.

Служба управления сертификатами OPC UA для промышленного интернета вещей Azure — это наше решение для управления центром сертификации конкретной компании при использовании приложений OPC UA на основе микрослужбы хранилища OPC.

Хранилище OPC предоставляет микрослужбу для размещения центра сертификации конкретной компании в безопасном облаке с использованием защищенных служб Azure AD, Azure Key Vault с аппаратными модулями безопасности, Cosmos DB и, при необходимости, центра Интернета вещей в качестве магазина приложений.

Микрослужба хранилища OPC поддерживает рабочий процесс на основе ролей, где персонал OT запрашивает подписанные сертификаты приложений, а администраторы безопасности и утверждающие с правами на подписывание в Azure Key Vault утверждают и отклоняют такие запросы.

Для совместимости с существующими решениями OPC UA для OT на основе GDS эти службы поддерживают граничный модуль на основе микрослужбы хранилища OPC, который реализует интерфейс *сервера глобального обнаружения OPC UA и управления сертификатами* для распространения сертификатов и списков доверия в соответствии с частью 12 спецификации. Но, насколько нам известно, этот интерфейс сервера глобального обнаружения пока не используется достаточно широко и поддерживает не все нужные функции (ограничен ролью считывателя). [По запросу пользователя мы можем улучшить это взаимодействие (*)](#yet-unsupported-features).

## <a name="architecture"></a>Архитектура

Архитектура основана на микрослужбе хранилища OPC с модулем IoT Edge хранилища OPC для сети фабрики и примером веб-интерфейса для управления рабочим процессом:

![Архитектура хранилища OPC](media/overview-opc-vault-architecture/opc-vault.png)

## <a name="opc-vault-microservice"></a>Микрослужба хранилища OPC

Микрослужба хранилища OPC состоит из следующих интерфейсов, которые позволяют реализовать рабочий процесс для распространения ЦС конкретной компании и управления им для приложений OPC UA:

### <a name="application"></a>Приложение 
- Приложение OPC UA может выполнять роль сервера, клиента или обоих одновременно. В этом случае хранилище OPC выступает в качестве центра регистрации приложений. 
- Помимо основных операций по регистрации, обновлению и отмене регистрации приложений, предоставляются интерфейсы для поиска приложений и запросов к ним с использованием выражений поиска. 
- Запрос сертификата должен ссылаться на допустимое приложение, чтобы обрабатывать запрос и возвращать подписанный сертификат со всеми расширениями для OPC UA. 
- Служба приложения создается на основе базы данных Cosmos DB либо [реестра устройств OpcTwin (*)](#yet-unsupported-features) в зависимости от конфигурации клиента.

### <a name="certificate-group"></a>Группа сертификатов
- Группа сертификатов — это сущность, в которой хранится сертификат корневого или второстепенного ЦС, включая закрытый ключ для подписывания сертификатов. 
- Длина ключа RSA, длина хэша SHA-2 и время существования настраиваются отдельно для сертификатов ЦС издателя и подписанных сертификатов приложений. 
- В одной службе можно разместить несколько групп, что позволяет дополнять их группами сертификатов HTTPS, пользователя или алгоритма ECC [(*)](#yet-unsupported-features). 
- Сертификаты ЦС хранятся в Azure Key Vault с поддержкой аппаратными модулями безопасности (HSM) FIPS 140-2 уровня 2. Закрытый ключ никогда не покидает безопасное хранилище, так как подписывание выполняется в операции Key Vault, защищенной через AzureAD. 
- Сертификаты ЦС могут обновляться с течением времени и оставаться в надежном хранилище благодаря функции истории в Key Vault. 
- Список отзыва для каждого сертификата ЦС также хранится в Key Vault в качестве секрета. После отмены регистрации приложения администратор отзывает также и сертификат приложения в списке отзыва сертификатов.
- Поддерживается пакетный и одиночный отзыв сертификата.

### <a name="certificate-request"></a>Запрос сертификата
Запрос сертификата реализует рабочий процесс для создания новой пары ключей или подписанного сертификата через "запрос подписи сертификата" (CSR) для приложения OPC UA. 
- Этот запрос сохраняется в базе данных вместе с дополнительной информацией (тема или CSR) и ссылкой на приложение OPC UA. 
- Бизнес-логика в службе проверяет запрос на соответствие информации, хранящейся в базе данных приложения. Например, URI приложения в базе данных должен совпадать с URI приложения в CSR.
- Администратор безопасности с правами на подписывание (роль утверждающего) утверждает или отклоняет запрос. Если запрос утвержден, создается новая пара ключей и (или) подписанный сертификат. Новый закрытый ключ безопасно сохраняется в KeyVault, а новый подписанный открытый сертификат сохраняется в базе данных запроса на сертификат.
- Запросивший может узнать состояние запроса, пока он не будет утвержден или отозван. Если запрос утвержден, закрытый ключ и сертификат можно скачать и установить их в хранилище сертификатов приложения OPC UA.
- Теперь запрашивающий может подтвердить запрос на удаление ненужных сведений из базы данных запросов. 

В течение времени существования подписанного сертификата приложение может быть удалено или ключ может быть скомпрометирован. В таком случае диспетчер ЦС может сделать следующее:
- Удалить приложение, что означает одновременное удаление всех ожидающих и утвержденных запросов на сертификат для этого приложения. 
- Удалить только один запрос сертификата, если возобновляется или скомпрометирован только ключ.
- После этого утвержденные и принятые запросы на скомпрометированный сертификаты помечаются как удаленные.
- Диспетчер может регулярно выполнять обновление списка отзывов сертификатов для ЦС поставщика. Во время обновления отзываются все удаленные запросы на сертификат, а серийные номера сертификатов добавляются в список отзыва сертификатов. Отозванные запросы сертификатов помечаются как отозванные.
- В срочных случаях можно отзывать даже отдельные запросы на сертификат.
- Наконец, обновленные списки отзыва сертификатов предоставляются для распространения участвующим клиентам и серверам OPC UA.

Дополнительные сведения об API микрослужбы хранилища OPC вы можете найти в документации Swagger по этой микрослужбе.

## <a name="opc-vault-iot-edge-module"></a>Модуль IoT Edge хранилища OPC
Для поддержки сервера глобального обнаружения в сети фабрики вы можете развернуть модуль хранилища OPC на границе, выполнить как локальное приложение .Net Core или запустить в контейнере Docker. Проверка подлинности Auth2 в текущем стеке .NET Standard для OPC UA не поддерживается, поэтому функциональные возможности граничного модуля хранилища OPC ограничены ролью считывателя. Граничный модуль не может олицетворять пользователя при взаимодействии с микрослужбой через стандартный интерфейс OPC UA GDS. На этом этапе разрешены только те операции, которые не нуждаются в роли модуля записи, администратора или утверждающего лица [(*)](#yet-unsupported-features). 

## <a name="yet-unsupported-features"></a>Неподдерживаемые функции

**(*)** Функция пока не поддерживается.

## <a name="next-steps"></a>Дополнительная информация

Итак, вы ознакомились с принципами работы и архитектурой хранилища OPC, теперь мы предлагаем вам следующий шаг обучения:

> [!div class="nextstepaction"]
> [Создание и развертывание хранилища OPC](howto-opc-vault-deploy.md)
