---
title: Управление службой сертификатов хранилища OPC в Azure | Документация Майкрософт
description: Управление сертификатами корневого ЦС хранилища OPC и разрешениями пользователей.
author: mregen
ms.author: mregen
ms.date: 8/16/2019
ms.topic: conceptual
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: 4420e5b0d895f8ea30dbd39fc50dd7480d57d086
ms.sourcegitcommit: 4b8a69b920ade815d095236c16175124a6a34996
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2019
ms.locfileid: "69995995"
---
# <a name="how-to-manage-the-opc-vault-certificate-service"></a>Управление службой сертификатов хранилища OPC

В этой статье объясняются задачи администрирования для службы управления сертификатами хранилища OPC в Azure, способы обновления сертификатов ЦС поставщика, продление списка отзыва сертификатов (CRL), а также предоставление и отзыв доступа пользователей.

## <a name="create-or-renew-the-root-ca-certificate"></a>Создание или продление сертификата корневого ЦС

Создание сертификата корневого ЦС является обязательным шагом после развертывания. Без действительного сертификата ЦС издателя сертификаты приложений не могут быть подписаны и выдаваться.<br>Ознакомьтесь с главой о [времени существования сертификатов](howto-opc-vault-secure-ca.md#certificates) , чтобы управлять сертификатами с учетом разумных и безопасных жизненных циклов. Сертификат ЦС издателя должен обновляться после половины его времени существования, но не позднее, чем до установленного времени существования нового подписанного сертификата приложения, превысит время существования сертификата издателя.<br>
> [!IMPORTANT]
> Для создания или продления сертификата ЦС поставщика требуется роль "Администратор".

1. Откройте службу сертификатов по адресу `https://myResourceGroup-app.azurewebsites.net` и выполните вход.
2. Перейдите на страницу `Certificate Groups`.
3. Указана одна `Default` группа сертификатов. Щелкните `Edit`.
4. В `Edit Certificate Group Details` можно изменить имя субъекта и время жизни ЦС и сертификатов приложений.<br>Субъект и время жизни следует устанавливать только один раз перед выдаче первого сертификата ЦС. Изменения времени существования во время операций могут привести к несогласованному времени существования выданных сертификатов и списков отзыва сертификатов.
5. Введите допустимую тему, `CN=My CA Root, O=MyCompany, OU=MyDepartment`например.<br>
   > [!IMPORTANT]
   > Для изменения субъекта необходимо обновить сертификат издателя, иначе служба не сможет подписывать сертификаты приложения. Тема конфигурации работоспособности проверяется по теме активного сертификата поставщика. Если субъекты не совпадают, подписывание сертификата отклоняется.
6. `Save` Нажмите кнопку.
7. Если на этом этапе вы столкнулись с ошибкой "запрещено", учетные данные пользователя не имеют разрешения администратора на изменение или создание нового корневого сертификата. По умолчанию пользователь, развернутый в службе, имеет доступ к ролям администратора и подписи со службой, другие пользователи должны быть добавлены к ролям "Утверждающий", "модуль записи" или "Администратор" в соответствии с регистрацией приложения AzureAD.
8. `Details` Нажмите кнопку. В `View Certificate Group Details` должно отобразиться обновленная информация.
9. `Renew CA Certificate` Нажмите кнопку, чтобы выдать первый сертификат ЦС поставщика или продлить сертификат издателя. Для `Ok` продолжения нажмите кнопку.
10. Через несколько секунд `Certificate Details` отобразится. Нажмите `Issuer` или`Crl` , чтобы скачать последний сертификат ЦС и список отзыва сертификатов для распространения в приложения OPC UA.
11. Теперь служба управления сертификатами OPC UA готова выдавать сертификаты для приложений OPC UA.

## <a name="renew-the-crl"></a>Обновление списка отзыва сертификатов

Продление списка отзыва сертификатов (CRL) — это обновление, которое должно быть распространено в приложения через регулярные промежутки времени. Устройства OPC UA, которые поддерживают расширение X509 точки распространения списков отзыва сертификатов, могут напрямую обновлять список отзыва сертификатов из конечной точки микрослужбы. Другие устройства OPC UA могут потребовать обновления вручную или в лучшем случае можно обновить с помощью GDS Server Push Extensions (*), чтобы обновить списки доверия с сертификатами и списками отзыва сертификатов.

В следующем рабочем процессе все запросы сертификатов в удаленных состояниях отменяются в списках отзыва сертификатов, которые соответствуют сертификату ЦС поставщика, для которого они были выпущены. Номер версии списка отзыва сертификатов увеличивается на 1. <br>
> [!NOTE]
> Все выданные списки отзыва сертификатов действительны до истечения срока действия сертификата ЦС поставщика, так как Спецификация OPC UA не требует обязательной, детерминированной модели распределения для списка отзыва сертификатов.

> [!IMPORTANT]
> Для продления CRL поставщика требуется роль "Администратор".

1. Откройте службу сертификатов по адресу `https://myResourceGroup.azurewebsites.net` и выполните вход.
2. Перейдите на страницу `Certificate Groups`.
3. `Details` Нажмите кнопку. `View Certificate Group Details` Должен отобразить текущий сертификат и сведения о списке отзыва сертификатов.
4. `Update CRL Revocation List(CRL)` Нажмите кнопку, чтобы выдать обновленный список CRL для всех активных сертификатов поставщика в хранилище хранилища OPC.
5. Через несколько секунд `Certificate Details` отобразится. Нажмите `Issuer` или`Crl` , чтобы скачать последний сертификат ЦС и список отзыва сертификатов для распространения в приложения OPC UA.

## <a name="manage-user-roles"></a>Управление ролями пользователей

Управление ролями пользователей для микрослужбы хранилища OPC осуществляется в корпоративном приложении Azure Active Directory Enterprise.

Подробное описание определений ролей см. в разделе [roles](howto-opc-vault-secure-ca.md#roles) .

По умолчанию пользователь, прошедший проверку подлинности в клиенте, может войти в службу как читатель. Для более высокопривилегированных ролей требуется ручное управление в портал Azure или с помощью PowerShell.

### <a name="add-user"></a>Добавление пользователя

1. Откройте портал Azure по адресу `portal.azure.com`.
2. Перейдите по адресу `Azure Active Directory`/`Enterprise applications`.
3. Выберите регистрацию микрослужбы хранилища OPC по умолчанию `resourceGroupName-service`.
4. Перейдите на страницу `Users and Groups`.
5. Щелкните `Add User`.
6. Выберите или пригласите пользователя, чтобы назначить определенную роль.
7. Выберите роль для пользователей.
8. `Assign` Нажмите кнопку.
9. Для пользователей `Administrator` или `Approver` ролей Продолжайте добавлять политики доступа Azure Key Vault.

### <a name="remove-user"></a>Удаление пользователя

1. Откройте портал Azure по адресу `portal.azure.com`.
2. Перейдите по адресу `Azure Active Directory`/`Enterprise applications`.
3. Выберите регистрацию микрослужбы хранилища OPC по умолчанию `resourceGroupName-service`.
4. Перейдите на страницу `Users and Groups`.
5. Выберите пользователя с ролью для удаления.
6. `Remove` Нажмите кнопку.
7. Удалите удаленных администраторов и утверждающих также из политик Azure Key Vault.

### <a name="add-user-access-policy-to-azure-key-vault"></a>Добавление политики доступа пользователей в Azure Key Vault

Для **утверждающих** и **администраторов**требуются дополнительные политики доступа.

По умолчанию удостоверение службы имеет только ограниченные разрешения на доступ к Key Vault для предотвращения операций с повышенными правами или изменений, выполняемых без олицетворения пользователя. Основные разрешения службы — `Get` и `List` для секретов, и для сертификатов. Для секретов существует только одно исключение — служба может получить `Delete` закрытый ключ из хранилища секретов после принятия пользователем. Для всех остальных операций требуются олицетворенные разрешения пользователя.<br>

#### <a name="for-an-approver-role-the-following-permissions-must-be-added-to-key-vault"></a>Для **роли утверждающего** необходимо добавить следующие разрешения в Key Vault:

1. Откройте портал Azure по адресу `portal.azure.com`.
2. Перейдите к хранилищу `resourceGroupName`OPC, используемому во время развертывания.
3. Перейдите к Key Vault `resourceGroupName-xxxxx`.
4. Перейдите к `Access Policies`.
5. Щелкните `Add new`.
6. Пропуск шаблона, шаблон соответствует требованиям.
7. `Select Principal` Щелкните и выберите пользователя, которого нужно добавить, или пригласите нового пользователя к клиенту.
8. Проверьте `Key permissions` :`Get`и самое важное`Sign`. `List`
9. Проверьте `Secret permissions`: `Get`, `List` и.`Delete` `Set`
10. Проверьте `Certificate permissions`: `Get`и .`List`
11. Щелкните `Ok`.
12. `Save`изменениями.

#### <a name="for-an-administrator-role-the-following-permissions-must-be-added-to-key-vault"></a>Для **роли администратора** в Key Vault необходимо добавить следующие разрешения:

1. Откройте портал Azure по адресу `portal.azure.com`.
2. Перейдите к хранилищу `resourceGroupName`OPC, используемому во время развертывания.
3. Перейдите к Key Vault `resourceGroupName-xxxxx`.
4. Перейдите к `Access Policies`.
5. Щелкните `Add new`.
6. Пропуск шаблона, шаблон соответствует требованиям.
7. `Select Principal` Щелкните и выберите пользователя, которого нужно добавить, или пригласите нового пользователя к клиенту.
8. Проверьте `Key permissions` :`Get`и самое важное`Sign`. `List`
9. Проверьте `Secret permissions`: `Get`, `List` и.`Delete` `Set`
10. Проверьте `Certificate permissions`: `Get`, `List`, `Update`и. `Create` `Import`
11. Щелкните `Ok`.
12. `Save`изменениями.

### <a name="remove-user-access-policy-from-azure-key-vault"></a>Удаление политики доступа пользователей из Azure Key Vault

1. Откройте портал Azure по адресу `portal.azure.com`.
2. Перейдите к хранилищу `resourceGroupName`OPC, используемому во время развертывания.
3. Перейдите к Key Vault `resourceGroupName-xxxxx`.
4. Перейдите к `Access Policies`.
5. Найдите пользователя, которого нужно удалить, и `... / Delete` щелкните, чтобы удалить доступ пользователя.

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали, как управлять сертификатами и пользователями хранилища OPC, предлагаем следующий шаг:

> [!div class="nextstepaction"]
> [Безопасное взаимодействие устройств OPC](howto-opc-vault-secure.md)
