---
title: Руководство по обнаружению аномалий на пограничных устройствах в решении Azure | Документация Майкрософт
description: Из этого руководства вы узнаете, как отслеживать устройства IoT Edge с помощью акселератора решения для удаленного мониторинга.
author: dominicbetts
manager: timlt
ms.author: dobett
ms.service: iot-accelerators
services: iot-accelerators
ms.date: 11/08/2018
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: 43ba14845765230b9a54c2b34dbc7ccd53af950b
ms.sourcegitcommit: bdd5c76457b0f0504f4f679a316b959dcfabf1ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90970008"
---
# <a name="tutorial-detect-anomalies-at-the-edge-with-the-remote-monitoring-solution-accelerator"></a>Руководство. Обнаружение аномалий на пограничных устройствах с помощью акселератора решения для удаленного мониторинга

Изучив это руководство, вы настроите в решении для удаленного мониторинга реагирование на аномалии, обнаруженные на устройстве IoT Edge. Устройства IoT Edge позволяют обрабатывать данные телеметрии в пограничной зоне. Это дает возможность сократить объем данных телеметрии, отправляемых в решение, и ускорить реагирование на события на устройствах. Дополнительные сведения о преимуществах обработки данных на пограничных устройствах см. в статье [Что такое Azure IoT Edge](../iot-edge/about-iot-edge.md).

Для демонстрации обработки данных на пограничных устройствах с использованием решения для удаленного мониторинга в этом руководстве используется имитация станка-качалки для добычи нефти. Этот станок-качалка, управляемый организацией Contoso, подключен к акселератору решения для удаленного мониторинга. Датчики станка-качалки измеряют температуру и давление. Операторы Contoso знают, что аномальное повышение температуры может привести к замедлению работы станка-качалки. Им не требуется отслеживать температуру устройства, когда она находится в пределах обычного диапазона.

Компания Contoso хочет развернуть интеллектуальный пограничный модуль, подключенный к станку-качалке, который обнаруживает температурные аномалии. Еще один пограничный модуль отправляет предупреждения в решение для удаленного мониторинга. При получении предупреждения оператор Contoso может отправить на вызов специалиста по техническому обслуживанию. Contoso также может настроить автоматическое действие, например отправку сообщения электронной почты, в случаях, когда в решение поступает предупреждение.

На схеме ниже показаны ключевые компоненты сценария, который рассматривается в этом руководстве:

![На схеме показан станок-качалка, подключенный к модулю IoT Edge Stream Analytics на устройстве IoT Edge для телеметрии и команд. Отфильтрованные данные телеметрии переходят на устройство IoT Edge в акселераторе решений для удаленного мониторинга в облаке. Облако также содержит развертывание и пакет. На устройстве развертывается среда выполнения IoT Edge.](media/iot-accelerators-remote-monitoring-edge/overview.png)

Изучив это руководство, вы:

>[!div class="checklist"]
> * добавить устройство IoT Edge в решение;
> * Создание манифеста Edge
> * импортировать манифесты в виде пакетов, определяющих модули, которые будут выполняться на устройстве;
> * развернуть пакет на устройстве IoT Edge;
> * просматривать предупреждения, поступающие с устройства.

На устройстве IoT Edge выполняется следующее:

* Среда выполнения получает пакет, а затем в ней устанавливаются модули.
* Модуль Stream Analytics обнаруживает температурные аномалии в станке-качалке и отправляет команды для устранения проблемы.
* Модуль Stream Analytics пересылает отфильтрованные данные в акселератор решений.

При работе с этим руководством в качестве устройства IoT Edge используется виртуальная машина Linux. На ней устанавливается модуль Edge для имитации станка-качалки.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

[!INCLUDE [iot-accelerators-tutorial-prereqs](../../includes/iot-accelerators-tutorial-prereqs.md)]

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

## <a name="add-an-iot-edge-device"></a>Добавление устройства IoT Edge

Добавить устройство IoT Edge в акселератор решения для удаленного мониторинга можно в два этапа. В этом разделе показано, как:

* добавить устройство IoT Edge на страницу **Device Explorer** в веб-интерфейсе решения для удаленного мониторинга;
* установить среду выполнения IoT Edge на виртуальной машине Linux.

### <a name="add-an-iot-edge-device-to-your-solution"></a>Добавление устройства IoT Edge в решение

Чтобы добавить устройство IoT Edge в акселератор решения для удаленного мониторинга, перейдите на страницу **Device Explorer** в веб-интерфейсе и щелкните **+ Новое устройство**.

На панели **Новое устройство** выберите **Устройство IoT Edge** и введите **oil-pump** в качестве идентификатора устройства. Для остальных параметров можно оставить значения по умолчанию. Нажмите кнопку **Применить**:

[![Добавление устройства IoT Edge](./media/iot-accelerators-remote-monitoring-edge/addedgedevice-inline.png)](./media/iot-accelerators-remote-monitoring-edge/addedgedevice-expanded.png#lightbox)

Запишите строку подключения устройства — она понадобится вам в следующем разделе этого руководства.

После того как вы зарегистрируете устройство в центре Интернета вещей в акселераторе решения для удаленного мониторинга, оно отобразится на странице **Device Explorer** в веб-интерфейсе:

[![Новое устройство IoT Edge](./media/iot-accelerators-remote-monitoring-edge/newedgedevice-inline.png)](./media/iot-accelerators-remote-monitoring-edge/newedgedevice-expanded.png#lightbox)

Чтобы упростить управление устройствами IoT Edge в решении, создайте группу устройств и добавьте в нее устройство IoT Edge:

1. Выберите устройство **oil-pump** в списке на странице **Device Explorer** и щелкните **Задания**.

1. Создайте задание по добавлению к устройству тега **IsEdge**, используя следующие параметры:

    | Параметр | Значение |
    | ------- | ----- |
    | Задание     | Теги  |
    | Имя задания | AddEdgeTag |
    | Ключ     | IsOilPump |
    | Значение   | Y     |
    | Тип    | Текст  |

    [![Добавление тега](./media/iot-accelerators-remote-monitoring-edge/addtag-inline.png)](./media/iot-accelerators-remote-monitoring-edge/addtag-expanded.png#lightbox)

1. Нажмите кнопку **Применить**, а затем — **Закрыть**.

1. На странице **Device Explorer** выберите **Manage device groups** (Управление группами устройств).

1. Щелкните **Create new device group** (Создать новую группу устройств). Создайте группу устройств со следующими параметрами:

    | Параметр | Значение |
    | ------- | ----- |
    | Имя    | OilPumps |
    | Поле   | Tags.IsOilPump |
    | Оператор | = Equals |
    | Значение    | Y |
    | Тип     | Текст |

    [![Создание группы устройств](./media/iot-accelerators-remote-monitoring-edge/createdevicegroup-inline.png)](./media/iot-accelerators-remote-monitoring-edge/createdevicegroup-expanded.png#lightbox)

1. Щелкните **Сохранить**.

Теперь устройство IoT Edge входит в группу **OilPumps**.

### <a name="install-the-edge-runtime"></a>Установка среды выполнения Edge

На пограничном устройстве необходимо установить среду выполнения Edge. В этом руководстве среда выполнения Edge устанавливается на виртуальной машине Azure под управлением Linux для тестирования сценария. На следующих шагах для установки и настройки виртуальной машины используется Azure Cloud Shell.

1. Чтобы создать виртуальную машину Linux в Azure, выполните указанные ниже команды. Вы можете указать ближайшее к вам расположение:

    ```azurecli-interactive
    az group create \
      --name IoTEdgeDevices \
      --location eastus
    az vm create \
      --resource-group IoTEdgeDevices \
      --name EdgeVM \
      --image microsoft_iot_edge:iot_edge_vm_ubuntu:ubuntu_1604_edgeruntimeonly:latest \
      --admin-username azureuser \
      --generate-ssh-keys \
      --size Standard_B1ms
    ```

1. Чтобы настроить среду выполнения Edge с использованием строки подключения устройства, выполните следующую команду, указав строку подключения устройства, которую вы записали ранее:

    ```azurecli-interactive
    az vm run-command invoke \
      --resource-group IoTEdgeDevices \
      --name EdgeVM \
      --command-id RunShellScript \
      --scripts 'sudo /etc/iotedge/configedge.sh "YOUR_DEVICE_CONNECTION_STRING"'
    ```

    Обязательно заключите строку подключения в двойные кавычки.

Вы только что установили и настроили среду выполнения IoT Edge на устройстве под управлением Linux. Далее в руководстве объясняется, как развернуть на этом устройстве модули IoT Edge с помощью решения для удаленного мониторинга.

## <a name="create-an-edge-manifest"></a>Создание манифеста Edge

Для имитации станка-качалки необходимо добавить на устройство Edge следующие модули:

* модуль моделирования температуры;
* модуль обнаружения аномалий Azure Stream Analytics.

Ниже показано, как создать манифест развертывания Edge, который включает в себя эти модули. Далее в этом руководстве вы импортируете этот манифест в виде пакета в акселератор решения для удаленного мониторинга.

### <a name="create-the-azure-stream-analytics-job"></a>Создание задания Azure Stream Analytics

Определите задание Stream Analytics на портале, прежде чем упаковывать его как модуль Edge.

1. На портале Azure создайте учетную запись хранения Azure с параметрами по умолчанию в группе ресурсов **IoTEdgeDevices**. Запишите выбранное имя.

1. На портале Azure создайте **задание Stream Analytics** в группе ресурсов **IoTEdgeDevices**. Используйте следующие значения конфигурации:

    | Параметр | Значение |
    | ------ | ----- |
    | Имя задания | EdgeDeviceJob |
    | Подписка | Ваша подписка Azure. |
    | Группа ресурсов | IoTEdgeDevices |
    | Расположение | Восточная часть США |
    | Среда размещения | Пограничный случай |
    | Единицы потоковой передачи | 1 |

1. На портале откройте задание Stream Analytics **EdgeDeviceJob**, щелкните "Входные данные" и добавьте потоковые входные данные **центра IoT Edge** под названием **telemetry**.

1. На портале откройте задание Stream Analytics **EdgeDeviceJob**, щелкните **Выходные данные** и добавьте выходные данные **центра IoT Edge** под названием **output**.

1. На портале откройте задание Stream Analytics **EdgeDeviceJob**, щелкните **Выходные данные** и добавьте еще одни выходные данные центра **IoT Edge** под названием **alert**.

1. В задании Stream Analytics **EdgeDeviceJob** на портале щелкните **Запрос** и добавьте следующую инструкцию **select**:

    ```sql
    SELECT  
    avg(machine.temperature) as temperature, 
    'F' as temperatureUnit 
    INTO output 
    FROM telemetry TIMESTAMP BY timeCreated 
    GROUP BY TumblingWindow(second, 5) 
    SELECT 'reset' as command 
    INTO alert 
    FROM telemetry TIMESTAMP BY timeCreated 
    GROUP BY TumblingWindow(second, 3) 
    HAVING avg(machine.temperature) > 400
    ```

1. В задании Stream Analytics **EdgeDeviceJob** на портале щелкните **Параметры учетной записи хранения**. Добавьте учетную запись хранения, которую вы добавили в группу ресурсов **IoTEdgeDevices** в начале этого раздела. Создайте контейнер с именем **edgeconfig**.

Сохраненное задание Stream Analytics показано на следующем снимке экрана:

[![Задание Stream Analytics](./media/iot-accelerators-remote-monitoring-edge/streamjob-inline.png)](./media/iot-accelerators-remote-monitoring-edge/streamjob-expanded.png#lightbox)

Вы определили задание Stream Analytics для запуска на пограничном устройстве. Задание вычисляет среднюю температуру за 5-секундный промежуток времени. Кроме того, задание отправляет предупреждение, если средняя температура за 3-секундный промежуток времени превышает значение 400.

### <a name="create-the-iot-edge-deployment"></a>Создание развертывания IoT Edge

Теперь создайте манифест развертывания IoT Edge, который определяет модули для запуска на устройстве Edge. В следующем разделе вы импортируете этот манифест в виде пакета в решение для удаленного мониторинга.

1. На портале Azure перейдите к центру Интернета вещей в решении для удаленного мониторинга. Центр Интернета вещей находится в группе ресурсов с таким же именем, как и у решения для удаленного мониторинга.

1. В центре Интернета вещей в разделе **Автоматическое управление устройствами** щелкните **IoT Edge**. Щелкните **Добавить развертывание IoT Edge**.

1. На странице **Создать развертывание > Имя и метка** введите имя **oil-pump-device**. Щелкните **Далее**.

1. На странице **Создать развертывание > Добавить модули** щелкните **+ Добавить**. Выберите **Модуль IoT Edge**.

1. На панели **IoT Edge Custom Modules** (Пользовательские модули IoT Edge) укажите имя **temperatureSensor** и URI образа **asaedgedockerhubtest/asa-edge-test-module:sensor-ad-linux-amd64**. Щелкните **Сохранить**.

1. На странице **Создать развертывание > Добавить модули** щелкните **+ Добавить**, чтобы добавить второй модуль. Выберите **Модуль Azure Stream Analytics**.

1. На панели **Развертывание Edge** выберите свою подписку и задание **EdgeDeviceJob**, созданное в предыдущем разделе. Щелкните **Сохранить**.

1. На странице **Создать развертывание > Добавить модули** щелкните **Далее**.

1. На странице **Создать развертывание > Укажите маршруты** добавьте следующий код:

    ```sql
    {
      "routes": { 
        "alertsToReset": "FROM /messages/modules/EdgeDeviceJob/outputs/alert INTO BrokeredEndpoint(\"/modules/temperatureSensor/inputs/control\")", 
        "telemetryToAsa": "FROM /messages/modules/temperatureSensor/* INTO BrokeredEndpoint(\"/modules/EdgeDeviceJob/inputs/telemetry\")", 
        "ASAToCloud": "FROM /messages/modules/EdgeDeviceJob/* INTO $upstream" 
      } 
    }
    ```

    Этот код направляет выходные данные из модуля Stream Analytics в правильное расположение.

    Щелкните **Далее**.

1. На странице **Создать развертывание > Укажите метрики** щелкните **Далее**.

1. На странице **Создать развертывание > Целевые устройства** в качестве приоритета укажите значение 10. Щелкните **Далее**.

1. На странице **Создать развертывание > Проверка развертывания** нажмите кнопку **Отправить**:

    [![Проверка развертывания](./media/iot-accelerators-remote-monitoring-edge/reviewdeployment-inline.png)](./media/iot-accelerators-remote-monitoring-edge/reviewdeployment-expanded.png#lightbox)

1. На главной странице **IoT Edge** щелкните **Развертывания IoT Edge**. В списке развертываний вы увидите развертывание **oil-pump-device**.

1. Выберите развертывание **oil-pump-device**, а затем щелкните **Скачать манифест IoT Edge**. Сохраните файл под именем **oil-pump-device.json** в подходящем расположении на локальном компьютере. Этот файл понадобится вам в следующем разделе этого руководства.

Вы создали манифест IoT Edge, который будет импортирован в виде пакета в решение удаленного мониторинга. Как правило, разработчик создает модули и файл манифеста IoT Edge.

## <a name="import-a-package"></a>Импорт пакета

В этом разделе вы импортируете манифест Edge в виде пакета в решение для удаленного мониторинга.

1. В веб-интерфейсе решения для удаленного мониторинга перейдите на страницу **Пакеты** и щелкните **+ New Package** (+ Новый пакет):

    [![Новый пакет](./media/iot-accelerators-remote-monitoring-edge/newpackage-inline.png)](./media/iot-accelerators-remote-monitoring-edge/newpackage-expanded.png#lightbox)

1. На панели **New Package**(Новый пакет) выберите тип пакета **Edge Manifest** (Манифест Edge), нажмите кнопку **Обзор**, найдите на локальном компьютере файл **oil-pump-device.json**, а затем нажмите кнопку **Отправить**:

    [![Отправка пакета](./media/iot-accelerators-remote-monitoring-edge/uploadpackage-inline.png)](./media/iot-accelerators-remote-monitoring-edge/uploadpackage-expanded.png#lightbox)

    В список пакетов теперь входит пакет **oil-pump-device.json**.

В следующем разделе вы создадите развертывание, в котором этот пакет применяется к устройству Edge.

## <a name="deploy-a-package"></a>Развертывание пакета

Теперь все готово к развертыванию пакета на вашем устройстве.

1. В веб-интерфейсе решения для удаленного мониторинга перейдите на страницу **Развертывания** и щелкните **+ Новое развертывание**:

    [![Новое развертывание](./media/iot-accelerators-remote-monitoring-edge/newdeployment-inline.png)](./media/iot-accelerators-remote-monitoring-edge/newdeployment-expanded.png#lightbox)

1. На панели **Новое развертывание** создайте развертывание со следующими параметрами:

    | Параметр | Значение |
    | ------ | ----- |
    | Имя   | OilPumpDevices |
    | Тип пакета | Edge Manifest (Манифест Edge) |
    | Пакет | oil-pump-device.json |
    | Группа устройств | OilPumps |
    | Приоритет | 10 |

    [![Создание развертывания](./media/iot-accelerators-remote-monitoring-edge/createdeployment-inline.png)](./media/iot-accelerators-remote-monitoring-edge/createdeployment-expanded.png#lightbox)

    Нажмите кнопку **Применить**.

Вам придется подождать несколько минут, пока пакет развернется на устройстве и с устройства начнут поступать данные телеметрии.

[![Развертывание активно](./media/iot-accelerators-remote-monitoring-edge/deploymentactive-inline.png)](./media/iot-accelerators-remote-monitoring-edge/deploymentactive-expanded.png#lightbox)

На странице **Развертывания** отображаются следующие метрики:

* **Целевой** — число устройств в группе устройств.
* **Применено** — число устройств, на которых применено содержимое развертывания.
* **Успешно** — число устройств Edge в развертывании, которые успешно запущены в клиентской среде выполнения IoT Edge.
* **Сбой** — число устройств Edge в развертывании, на которых произошел сбой в клиентской среде выполнения IoT Edge.

## <a name="monitor-the-device"></a>Мониторинг устройства

Данные телеметрии о температуре станка-качалки можно просматривать в веб-интерфейсе решения для удаленного мониторинга:

1. Перейдите на страницу **Device Explorer** и выберите устройство oil-pump.
1. В разделе **Телеметрия** панели **Сведения об устройстве** щелкните **Температура**:

    [![Просмотр телеметрии](./media/iot-accelerators-remote-monitoring-edge/viewtelemetry-inline.png)](./media/iot-accelerators-remote-monitoring-edge/viewtelemetry-expanded.png#lightbox)

Вы можете наблюдать за увеличением температуры до порогового значения. Модуль Edge Stream Analytics обнаруживает, когда температура достигает этого порогового значения, и отправляет на устройство команду для немедленного снижения температуры. Вся эта обработка данных происходит на устройстве без взаимодействия с облаком.

Если нужно уведомлять операторов о достижении порогового значения, можно создать правило в веб-интерфейсе решения для удаленного мониторинга:

1. Перейдите на страницу **Правила** и щелкните **+ Новое правило**.
1. Создайте правило со следующими параметрами:

    | Параметр | Значение |
    | ------ | ----- |
    | Имя правила | Oil pump temperature (Температура станка-качалки) |
    | Описание | Oil pump temperature exceeded 300 (Температура станка-качалки превысила значение 300) |
    | Группа устройств | OilPumps |
    | Вычисление | Сразу же |
    | Поле | Температура |
    | Оператор | > |
    | Значение | 300 |
    | Степень серьезности | Сведения |

    [![Создание правила](./media/iot-accelerators-remote-monitoring-edge/newrule-inline.png)](./media/iot-accelerators-remote-monitoring-edge/newrule-expanded.png#lightbox)

    Нажмите кнопку **Применить**.

1. Перейдите на страницу **Панель мониторинга**. Если температура устройства **oil-pump** превысит значение 300, на панели **Оповещения** появится соответствующее предупреждение.

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как добавить и настроить устройство IoT Edge в акселераторе решения для удаленного мониторинга. Дополнительные сведения о работе с пакетами IoT Edge в решении для удаленного мониторинга см. в следующем руководстве:

> [!div class="nextstepaction"]
> [Импорт пакета IoT Edge в акселератор решения для удаленного мониторинга](iot-accelerators-remote-monitoring-import-edge-package.md)

Дополнительные сведения об установке среды выполнения IoT Edge см. в статье [Установка среды выполнения Azure IoT Edge в Linux (x64)](../iot-edge/how-to-install-iot-edge-linux.md).

Дополнительные сведения об Azure Stream Analytics для пограничных устройств см. в статье [Руководство по развертыванию Azure Stream Analytics в качестве модуля IoT Edge (предварительная версия)](../iot-edge/tutorial-deploy-stream-analytics.md).
