---
title: Диагностика пропущенных уведомлений в центрах уведомлений Azure
description: Узнайте, как определить распространенные проблемы с пропущенными уведомлениями в Центрах уведомлений Azure.
services: notification-hubs
documentationcenter: Mobile
author: jwargo
manager: patniko
editor: spelluru
ms.assetid: b5c89a2a-63b8-46d2-bbed-924f5a4cce61
ms.service: notification-hubs
ms.workload: mobile
ms.tgt_pltfrm: NA
ms.devlang: multiple
ms.topic: article
ms.date: 04/04/2019
ms.author: jowargo
ms.openlocfilehash: eebf9ef63a8622c4cc431322b786fdf30f6352fe
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "64925821"
---
# <a name="diagnose-dropped-notifications-in-azure-notification-hubs"></a>Диагностика пропущенных уведомлений в центрах уведомлений Azure

Часто задаваемые вопросы о центрах уведомлений Azure — как исправить проблему после получения уведомлений из приложения не отображаются на клиентских устройствах. Клиенты хотят знать, где и почему уведомления были удалены и способы устранения проблемы. В этой статье мы рассмотрим, почему уведомления удаляются и не доходят до устройств. Также объясняется, как для определения основной причины.

Для начала очень важно понять, как Центры уведомлений отправляют уведомления на устройство.

![Архитектура Центров уведомлений][0]

В типичном потоке отправки уведомлений сообщение отправляется из *серверной части приложения* в Центры уведомлений. Концентраторы уведомлений обрабатывает все операции регистрации. Он учитывает настроенных тегов и выражений тегов для определения целевых объектов. Целями являются регистрации, которые должны получить Push-уведомления. Эти операции регистрации могут распространяться на любые из поддерживаемых нами платформ: Android, Baidu (устройства Android в Китае), iOS Fire ОС (Amazon), Windows и Windows Phone.

Определив цели, Центры уведомлений отправляют сообщения в *службу push-уведомлений* для платформы устройства. В качестве примера можно привести службу push-уведомлений Apple (APNs) для Apple и Firebase Cloud Messaging (FCM) для Google. Центры уведомлений отправляют сообщения, разделенные по нескольким пакетам регистраций. Выполняет проверку подлинности с помощью соответствующих служба Push-уведомлений, исходя из учетных данных на портале Azure в разделе задать **настройки центра уведомлений**. Затем служба push-уведомлений пересылает уведомления на соответствующие *клиентские устройства*.

Служба Push-уведомлений платформы и устройства — по последнему участку доставки уведомлений. Доставки уведомлений может завершиться ошибкой, ни на одном из четырех этапов в процессе уведомления, Push-уведомлений (клиент, серверная часть приложения, центры уведомлений и служба Push-уведомлений платформы). Дополнительные сведения об архитектуре Центров уведомлений см. в [Концентраторы уведомлений Azure].

Сбой доставки уведомлений может произойти во время начального этапа тестирования или промежуточной среде. что может указывать на проблему конфигурации. Если происходит сбой доставки уведомлений в рабочей среде, некоторые или все уведомления могут теряться. В этом случае указывается глубже приложения или обмена сообщениями проблема шаблон.

Следующем разделе рассматриваются сценарии, в которых уведомления могут быть удалены, начиная с распространенных для редко.

## <a name="notification-hubs-misconfiguration"></a>Неправильная настройка Центров уведомлений ##

Чтобы отправлять уведомления в соответствующую службу Push-уведомлений, центры уведомлений требуется подтвердить свою подлинность в контексте приложения. Необходимо создать учетную запись разработчика с использованием служб уведомлений целевой платформы (Microsoft, Apple, Google, и т.д.). Затем необходимо зарегистрировать приложение с операционной Системой, где получить маркер или ключ, используемый для работы с целевого PNS.

Учетные данные платформы необходимо добавить на портал Azure. Если уведомления не доходят до устройства, прежде всего, чтобы убедиться, что в центрах уведомлений настроены правильные учетные данные. Учетные данные должны соответствовать данным приложения, создаваемый под учетной записью разработчика для конкретной платформы.

Пошаговые инструкции для выполнения этого процесса см. в статье [Начало работы с Центрами уведомлений для приложений универсальной платформы Windows].

Ниже приведены некоторые распространенные сценарии неправильной настройки, которые следует проверить.

### <a name="notification-hub-name-location"></a>Расположение имя концентратора уведомлений

Убедитесь, что имя Центра уведомлений (без опечаток) одинаковое во всех следующих расположениях:
   * Где выполняется регистрация из клиента
   * Где вы отправляете уведомления из серверной части.
   * Когда вы настроили учетные данные службы Push-уведомлений уведомлений

Убедитесь, используются правильные настройки строки подписанных на стороне клиента и серверной частью приложения. Как правило, необходимо использовать **DefaultListenSharedAccessSignature** на стороне клиента и **DefaultFullSharedAccessSignature** в приложении серверной части. Это предоставляет разрешения для отправки уведомлений в центрах уведомлений.

### <a name="apn-configuration"></a>APN конфигурации ###

Необходимо использовать два разных центра: один для рабочей и другой для тестирования. Необходимо отправить сертификат, который используется в среде «песочницы», чтобы в отдельные центры сертификат/концентратора, которые будут использоваться в рабочей среде. Не отправляйте разные типы сертификатов в один и тот же центр. Это вызовет сбои уведомлений.

Если вы случайно отправили сертификаты разных типов и тот же центр, следует удалить центр и начать все заново с новым центром. Если для какой-либо причине не удается удалить центр, по крайней мере необходимо удалить все существующие регистрации от концентратора.

### <a name="fcm-configuration"></a>Конфигурация FCM ###

1. Убедитесь, что *ключ сервера* полученный из Firebase соответствий ключ сервера, зарегистрированных на портале Azure.

   ![Ключ сервера Firebase][3]

2. Убедитесь, что на клиенте настроен **идентификатор проекта**. Значение для **идентификатора проекта** можно получить на панели мониторинга Firebase.

   ![Идентификатор проекта Firebase][1]

## <a name="application-issues"></a>Проблемы с приложением ##

### <a name="tags-and-tag-expressions"></a>Теги и выражения тегов ###

При использовании тегов или выражений тегов для сегментирования аудитории возможна, что при отправке уведомления, цель не присутствует. Эта ошибка зависит от указанного тегов или выражений тегов в вызове отправки.

Просмотрите регистрации, чтобы убедиться, что теги совпадают, при отправке уведомления. После этого убедитесь, что уведомления отправляются только от клиентов с этими регистрациями.

Например предположим, что все ваши регистрации с помощью центров уведомлений с помощью тега «Политика». Если вы затем отправить уведомление с тегом «Спорт», уведомление не отправлено на любом устройстве. Сложный случай может включать выражения тегов, где зарегистрирован с помощью «Тег A» *или* «Тег Б». Однако целевые «Тег и тег б» Разделе советов по самостоятельной диагностике далее в этой статье показано, как просмотреть регистрации и их тегов.

### <a name="template-issues"></a>Проблемы с шаблонами ###

Если используются шаблоны, убедитесь, что вы следуете рекомендациям, приведенным в статье [Шаблоны].

### <a name="invalid-registrations"></a>Недопустимые регистрации ###

Если центр уведомлений настроен правильно и тегов или выражений тегов использовались правильно, будут обнаружены допустимые цели. которым необходимо отправить уведомления. Затем Центры уведомлений параллельно запускают несколько пакетов обработки. Каждый пакет отправляет сообщения набору регистраций.

> [!NOTE]
> Поскольку концентраторы уведомлений обрабатывает пакетов параллельно, порядок доставки уведомлений не гарантируется.

Центры уведомлений оптимизированы для модели доставки сообщений «-повторов». Мы пытаемся выполнить дедупликацию так, чтобы уведомления доставлялись на устройство по одному разу. Проверяются регистраций, чтобы убедиться, что это только одно сообщение отправляется на каждый идентификатор устройства, перед отправкой в службу Push-уведомлений.

Каждый пакет отправляется в службу Push-уведомлений, который в свою очередь принимает и проверяет регистрации. Во время этого процесса вполне возможно, что служба Push-уведомлений будет обнаружить ошибку одной или нескольких регистраций в пакете. Служба Push-уведомлений возвращает ошибку в центры уведомлений, и процесс останавливается. Служба push-уведомлений полностью удаляет такой пакет. Это касается в особенности APNs, который использует протокол потока TCP.

В этом случае проблемная регистрация удаляется из базы данных. Затем мы повторяем попытку доставки уведомлений для остальных устройств в этом пакете.

Чтобы получить дополнительные сведения об ошибке о неудачной попытке доставки для регистрации, можно использовать API REST центров уведомлений [Телеметрию по каждому сообщению: Получение уведомлений сообщение телеметрии](https://msdn.microsoft.com/library/azure/mt608135.aspx) и [отзывов службы PNS](https://msdn.microsoft.com/library/azure/mt705560.aspx). Пример кода приведен в [репозитории примеров для отправки с помощью REST](https://github.com/Azure/azure-notificationhubs-dotnet/tree/master/Samples/SendRestExample/).

## <a name="push-notification-service-issues"></a>Проблемы службы push-уведомлений

После того как служба Push-уведомлений получает уведомление, он посылает уведомление на устройство. На этом этапе центров уведомлений не может управлять за доставку уведомлений на устройство.

Так как службы уведомлений платформы надежны, уведомления, как правило, до устройства за несколько секунд. Если служба Push-уведомлений регулирует, центры уведомлений применяет стратегию экспоненциальной отсрочки. Если служба Push-уведомлений не недоступен в течение 30 минут, имеется политика в истечением срока действия и окончательным удалением сообщения.

Если служба Push-уведомлений пытается доставить уведомление, но устройство находится в автономном режиме, хранит уведомления служба Push-уведомлений. Сохраняется только на ограниченный период времени. Уведомление доставляется на устройство, когда оно становится доступным.

Каждое приложение хранит только одно последнее уведомление. Если передается несколько уведомлений, пока устройство находится в автономном режиме, каждого нового уведомления приводит последнее из них будут отброшены. Сохранение только последнего уведомления называется *объединения со значением* в APNs и *свертывание* в FCM. (FCM использует использованием ключа разъединения). Когда устройство находится в автономном режиме в течение длительного времени, уведомления, которые были сохранены для устройства, удаляются. Дополнительные сведения см. в разделе [Обзор APNs] и [Сведения о сообщениях FCM].

С помощью центров уведомлений вы можете передать ключ объединения через заголовок HTTP, используя универсальный API SendNotification. Например, для пакета SDK для .NET можете использовать `SendNotificationAsync`. SendNotification API также принимает заголовки HTTP, которые передаются как есть в соответствующую службу Push-уведомлений.

## <a name="self-diagnosis-tips"></a>Советы по самостоятельной диагностике

Ниже приведены способы диагностики первопричины пропущенных уведомлений в центрах уведомлений.

### <a name="verify-credentials"></a>Проверка учетных данных ###

#### <a name="push-notification-service-developer-portal"></a>Портале разработчика службы Push-уведомлений ####

Проверьте учетные данные на соответствующем портале разработчика службы push-уведомлений (APNs, FCM, служба уведомлений Windows и т. д.). Дополнительные сведения см. в статье [Руководство. отправке уведомлений в приложения универсальной платформы Windows с использованием Центров уведомлений Azure](https://docs.microsoft.com/azure/notification-hubs/notification-hubs-windows-store-dotnet-get-started-wns-push-notification).

#### <a name="azure-portal"></a>Портал Azure ####

Чтобы просмотреть и сопоставить учетные данные с полученными на портале разработчика службы уведомлений Push-уведомлений, перейдите к **политики доступа** вкладка на портале Azure.

![Вкладка "Политики доступа" на портале Azure][4]

### <a name="verify-registrations"></a>Проверка регистраций

#### <a name="visual-studio"></a>Visual Studio ####

В Visual Studio вы можете подключиться к Azure с помощью обозревателя серверов для просмотра и управления несколькими службами Azure, включая концентраторы уведомлений. Это сочетание клавиш используется преимущественно для среды разработки и тестирования.

![Обозреватель серверов в Visual Studio.][9]

Можно просматривать и управлять все регистрации в концентраторе. Регистрации можно классифицировать по платформе, машинный код или шаблон регистрации, тег, идентификатор службы уведомления Push-уведомлений, идентификатор регистрации и дату окончания срока действия. На этой странице можно также изменить регистрацию. Это особенно удобно для редактирования тегов.

Щелкните правой кнопкой мыши центра уведомлений **обозревателя серверов**и выберите **Диагностика**. 

![Обозреватель сервера Visual Studio: Диагностика меню](./media/notification-hubs-diagnosing/diagnose-menu.png)

Отобразится следующая страница:

![Visual Studio. Диагностика страницы](./media/notification-hubs-diagnosing/diagnose-page.png)

Переключиться в режим **регистрации устройств** страницы:

![Visual Studio. Регистрация устройств](./media/notification-hubs-diagnosing/VSRegistrations.png)

Можно использовать **Тестовая отправка** страницы для отправки тестового сообщения уведомления:

![Visual Studio. Тестовая отправка](./media/notification-hubs-diagnosing/test-send-vs.png)

> [!NOTE]
> Visual Studio можно используйте для изменения регистрации только во время разработки и тестирования, а также с помощью ограниченного числа регистраций. Если вам нужно редактирования регистраций в пакетном режиме, рассмотрите возможность использования экспорта и импорта регистраций, описанной в [How To: Экспорт и изменение регистраций в пакетном режиме](https://msdn.microsoft.com/library/dn790624.aspx).

#### <a name="service-bus-explorer"></a>Service Bus Explorer ####

Многие клиенты используют [Service Bus Explorer](https://github.com/paolosalvatori/ServiceBusExplorer) для просмотра и управления их центров уведомлений. который представляет собой проект с открытым кодом. 

### <a name="verify-message-notifications"></a>Проверка уведомлений о сообщениях

#### <a name="azure-portal"></a>Портал Azure ####

Чтобы отправить тестовые уведомления клиентам, не запуская серверную часть службы, в разделе **Поддержка и устранение неполадок** выберите **Тестовая отправка**.

![Функциональные возможности тестовой отправки в Azure][7]

#### <a name="visual-studio"></a>Visual Studio ####

Тестовые уведомления также можно отправлять с помощью Visual Studio.

![Функциональные возможности тестовой отправки в Visual Studio][10]

Дополнительные сведения об использовании Центров уведомлений с помощью обозревателя серверов в Visual Studio см. в следующих статьях:

* [Просмотр регистраций устройства в центры уведомлений](https://docs.microsoft.com/previous-versions/windows/apps/dn792122(v=win.10))
* [Deep Dive: Visual Studio 2013 Update 2 RC and Azure SDK 2.3] (Подробный обзор. Релиз-кандидат Visual Studio 2013 с обновлением 2 и пакет Azure SDK 2.3)
* [Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]

### <a name="debug-failed-notifications-and-review-notification-outcome"></a>Уведомления о сбоях отладки и просмотр результатов уведомлений

#### <a name="enabletestsend-property"></a>Свойство EnableTestSend ####

При отправке уведомления через центры уведомлений, уведомление изначально помещается в очередь. Центры уведомлений определяют правильные цели, а затем отправляют уведомление в службу push-уведомлений. Если вы используете REST API или любого клиентского пакета SDK, возвращение вызова отправки означает только сообщение помещается в очередь с помощью центров уведомлений. Это не дает понять, что происходит после центров уведомлений в конечном итоге отправил уведомление службу Push-уведомлений.

Если уведомление не поступает на клиентском устройстве, может произошла ошибка при попытке центров уведомлений доставить его в службу Push-уведомлений. Например, размер полезных данных может превышать максимально допустимый размер таких данных в службе push-уведомлений или настроенные в Центрах уведомлений учетные данные могут быть недоступными.

Информацию об ошибках службы push-уведомлений можно получить с помощью свойства [Сведения о свойстве EnableTestSend]. Оно автоматически включается при отправке тестового сообщения с портала или клиентского приложения Visual Studio Это свойство позволяет просматривать подробную отладочную информацию, а также через API-интерфейсы. Сейчас его можно использовать в пакете SDK для .NET. Оно будет добавляться ко всем пакетам SDK клиента со временем.

Чтобы использовать свойство `EnableTestSend` с вызовом REST, добавьте параметр строки запроса с именем *test* в конце вызова отправки. Например:

```text
https://mynamespace.servicebus.windows.net/mynotificationhub/messages?api-version=2013-10&test
```

#### <a name="net-sdk-example"></a>Пример пакета SDK для .NET ####

Ниже приведен пример отправки собственного всплывающего уведомления при использовании пакета SDK для .NET:

```csharp
NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName);
var result = await hub.SendWindowsNativeNotificationAsync(toast);
Console.WriteLine(result.State);
```

В конце выполнения `result.State` просто заявляет `Enqueued`. Результаты не будет предоставлена информация о том, что происходит в вашем Push-уведомлении.

Далее вы можете использовать логическое свойство `EnableTestSend`. С помощью свойства `EnableTestSend` во время инициализации `NotificationHubClient` можно получить подробные сведения об ошибках службы push-уведомлений, произошедших при отправке уведомления. Результат вызова отправки требуется дополнительное время, поскольку сначала ему центров уведомлений для доставки уведомления службу Push-уведомлений.

```csharp
    bool enableTestSend = true;
    NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName, enableTestSend);

    var outcome = await hub.SendWindowsNativeNotificationAsync(toast);
    Console.WriteLine(outcome.State);

    foreach (RegistrationResult result in outcome.Results)
    {
        Console.WriteLine(result.ApplicationPlatform + "\n" + result.RegistrationId + "\n" + result.Outcome);
    }
```

#### <a name="sample-output"></a>Пример выходных данных ####

```text
DetailedStateAvailable
windows
7619785862101227384-7840974832647865618-3
The Token obtained from the Token Provider is wrong
```

Это сообщение означает, что настроенные в центрах уведомлений учетные данные недействительны либо есть проблема с регистрацией в концентраторе. Удалить эту регистрацию и дать клиенту создать ее заново перед отправкой сообщения.

> [!NOTE]
> Использование свойства `EnableTestSend` строго регулируется. Используйте этот параметр только в среде разработки и тестирования, так и с ограниченным набором регистраций. Отладка уведомления отправляются только 10 устройств. Также есть ограничение на обрабатываемых уведомлений об отладке, в 10 в минуту.

### <a name="review-telemetry"></a>Просмотр телеметрии ###

#### <a name="azure-portal"></a>Портал Azure ####

На портале вы можете получить краткий обзор всех операций, выполняемых в Центре уведомлений.

1. На вкладке **Обзор** можно просмотреть объединенное представление регистраций, уведомлений и ошибок каждой платформы.

   ![Панель мониторинга "Обзор" в Центре уведомлений][5]

2. На вкладке **Монитор** можно добавить дополнительные метрики для конкретной платформы, чтобы получить подробные сведения о состоянии. Вы можете отдельно рассмотреть ошибки, которые возвращаются, когда центры уведомлений пытаются отправить уведомление в службу Push-уведомлений.

   ![Журнал действий на портале Azure][6]

3. Сначала просмотрите **входящие сообщения**, **операции регистрации** и **доставленные уведомления**. Затем перейдите на вкладку каждой платформы, чтобы просмотреть ошибки, связанные со службой push-уведомлений.

4. Если параметры проверки подлинности для Центра уведомлений неверные, будет получена ошибка **выполнения проверки подлинности PNS**. Он является хорошим признаком того, чтобы проверить учетные данные службы уведомлений Push-уведомлений.

#### <a name="programmatic-access"></a>Программный доступ ####

Дополнительные сведения о программном доступе см. в разделе [программный доступ](https://docs.microsoft.com/previous-versions/azure/azure-services/dn458823(v=azure.100)).

> [!NOTE]
> Некоторые функции, связанные с телеметрией, например экспорт и импорт данных регистраций и доступ к телеметрии с помощью API, доступны только на уровне служб "Стандартный". При попытке использовать эти функции бесплатный "или" базовый уровень обслуживания, вы получите сообщение об исключении, если вы используете пакет SDK. Если вы используете функции непосредственно из интерфейсов REST API, вы получите ошибку HTTP 403 (запрещено).
>
> Чтобы использовать функции, связанные с телеметрией, сначала убедитесь, на портале Azure вы используете категории "стандартный".  

<!-- IMAGES -->
[0]: ./media/notification-hubs-diagnosing/Architecture.png
[1]: ./media/notification-hubs-diagnosing/FCMConfigure.png
[3]: ./media/notification-hubs-diagnosing/FCMServerKey.png
[4]: ../../includes/media/notification-hubs-portal-create-new-hub/notification-hubs-connection-strings-portal.png
[5]: ./media/notification-hubs-diagnosing/PortalDashboard.png
[6]: ./media/notification-hubs-diagnosing/PortalAnalytics.png
[7]: ./media/notification-hubs-ios-get-started/notification-hubs-test-send.png
[8]: ./media/notification-hubs-diagnosing/VSRegistrations.png
[9]: ./media/notification-hubs-diagnosing/VSServerExplorer.png
[10]: ./media/notification-hubs-diagnosing/VSTestNotification.png

<!-- LINKS -->
[Концентраторы уведомлений Azure]: notification-hubs-push-notification-overview.md
[Начало работы с Центрами уведомлений для приложений универсальной платформы Windows]: notification-hubs-windows-store-dotnet-get-started-wns-push-notification.md
[Шаблоны]: https://msdn.microsoft.com/library/dn530748.aspx
[Обзор APNs]: https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html
[Сведения о сообщениях FCM]: https://firebase.google.com/docs/cloud-messaging/concept-options
[Export and modify registrations in bulk]: https://msdn.microsoft.com/library/dn790624.aspx
[Service Bus Explorer code]: https://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a
[View device registrations for notification hubs]: https://msdn.microsoft.com/library/windows/apps/xaml/dn792122.aspx
[Deep Dive: Visual Studio 2013 Update 2 RC and Azure SDK 2.3]: https://azure.microsoft.com/blog/2014/04/09/deep-dive-visual-studio-2013-update-2-rc-and-azure-sdk-2-3/#NotificationHubs (Подробный обзор. Релиз-кандидат Visual Studio 2013 с обновлением 2 и пакет Azure SDK 2.3)
[Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]: https://azure.microsoft.com/blog/2014/08/04/announcing-release-of-visual-studio-2013-update-3-and-azure-sdk-2-4/
[Сведения о свойстве EnableTestSend]: https://docs.microsoft.com/dotnet/api/microsoft.azure.notificationhubs.notificationhubclient.enabletestsend?view=azure-dotnet
[Programmatic telemetry access]: https://msdn.microsoft.com/library/azure/dn458823.aspx
