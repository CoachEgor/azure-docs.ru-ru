---
title: Диагностика отброшенных уведомлений в концентрах уведомлений Azure
description: Узнайте, как определить распространенные проблемы с пропущенными уведомлениями в Центрах уведомлений Azure.
services: notification-hubs
documentationcenter: Mobile
author: sethmanheim
manager: femila
editor: jwargo
ms.assetid: b5c89a2a-63b8-46d2-bbed-924f5a4cce61
ms.service: notification-hubs
ms.workload: mobile
ms.tgt_pltfrm: NA
ms.devlang: multiple
ms.topic: article
ms.date: 02/25/2020
ms.author: sethm
ms.reviewer: jowargo
ms.lastreviewed: 04/04/2019
ms.openlocfilehash: 1f3c16e6fe1855cf7882d83e620c70d15ce3cb92
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "77657589"
---
# <a name="diagnose-dropped-notifications-in-azure-notification-hubs"></a>Диагностика отброшенных уведомлений в концентрах уведомлений Azure

Общий вопрос о концентрах уведомлений Azure заключается в том, как устранить неполадки, когда уведомления из приложения не отображаются на устройствах клиентов. Клиенты хотят знать, где и почему уведомления были удалены, и как устранить проблему. В этой статье мы рассмотрим, почему уведомления удаляются и не доходят до устройств. Он также объясняет, как определить первопричину.

Для начала очень важно понять, как Центры уведомлений отправляют уведомления на устройство.

![Архитектура Центров уведомлений][0]

В типичном потоке отправки уведомлений сообщение отправляется из *серверной части приложения* в Центры уведомлений. Концентраторы уведомлений обрабатывает все регистрации. Он учитывает настроенные теги и выражения тегов для определения целей. Целями являются регистрации, которые должны получать push-уведомление. Эти регистрации могут охватывать любую из наших поддерживаемых платформ: Android, Baidu (Android устройства в Китае), Fire OS (Amazon) iOS, Windows и Windows Phone.

Определив цели, Центры уведомлений отправляют сообщения в *службу push-уведомлений* для платформы устройства. В качестве примеров можно привести сервис Apple Push Notification (APN) для iOS и macOS, а также облачные сообщения Firebase (FCM) для устройств Android. Центры уведомлений отправляют сообщения, разделенные по нескольким пакетам регистраций. Он проверяет подлинность с помощью соответствующей службы push-уведомлений, на основе учетных данных, установленных на портале Azure, под **концентратором настройки**уведомлений. Затем служба push-уведомлений пересылает уведомления на соответствующие *клиентские устройства*.

Заключительный этап доставки уведомлений находится между службой push-уведомлений платформы и устройством. Доставка уведомлений может вывести из строя на любом из четырех этапов процесса push-уведомления (клиент, задний конец приложения, концентраторы уведомлений и служба push-уведомлений платформы). Дополнительные сведения об архитектуре Центров уведомлений см. в [этой статье].

Невыполнение уведомлений может произойти на начальном этапе тестирования/постановки. что может указывать на проблему конфигурации. Если невыполнение уведомлений происходит в производственном объеме, некоторые или все уведомления могут быть удалены. В этом случае указывается более глубокая проблема шаблона приложения или обмена сообщениями.

В следующем разделе рассматриваются сценарии, в которых уведомления могут быть удалены, начиная от обычных до редких.

## <a name="notification-hubs-misconfiguration"></a>Неправильная настройка Центров уведомлений

Для отправки уведомлений в соответствующую службу push-уведомлений концентраторы уведомлений должны проверить подлинность в контексте приложения. Необходимо создать учетную запись разработчика с помощью службы уведомлений целевой платформы (Microsoft, Apple, Google и т.д.). Затем необходимо зарегистрировать приложение в ОС, где вы получаете токен или ключ, который вы используете для работы с целевой PNS.

Учетные данные платформы необходимо добавить на портал Azure. Если уведомления не доходят до устройства, первым шагом является настройка правильных учетных данных в концентрах уведомлений. Учетные данные должны соответствовать приложению, созданного в учетной записи разработчика, специфичном для платформы.

Пошаговые инструкции для выполнения этого процесса см. в статье [Начало работы с Центрами уведомлений для приложений универсальной платформы Windows].

Ниже приведены некоторые распространенные сценарии неправильной настройки, которые следует проверить.

### <a name="notification-hub-name-location"></a>Местоположение названия концентратора уведомлений

Убедитесь, что имя Центра уведомлений (без опечаток) одинаковое во всех следующих расположениях:

* Где вы регистрируетесь у клиента
* Где вы отправляете уведомления с задней части
* Где вы настроили учетные данные службы push-уведомлений

Убедитесь, что вы используете правильные строки конфигурации общей подписи доступа на клиенте и задней части приложения. Как правило, вы должны использовать **DefaultListenAccessSignature** на клиенте и **DefaultFullSharedAccessSignature** на задней части приложения. Это дает разрешения на отправку уведомлений кцентратам уведомлений.

### <a name="apn-configuration"></a>Конфигурация APN

Необходимо поддерживать два разных концентрата: один для производства, а другой для тестирования. Вы должны загрузить сертификат, который вы используете в среде песочницы, в отдельный концентратор, чем сертификат/концентратор, который вы будете использовать в производстве. Не отправляйте разные типы сертификатов в один и тот же центр. Это вызовет сбои уведомлений.

Если вы случайно загружаете различные типы сертификатов в один и тот же концентратор, следует удалить концентратор и начать все заново с новым концентратором. Если по какой-либо причине вы не можете удалить концентратор, необходимо, по крайней мере, удалить все существующие регистрации из концентратора.

### <a name="fcm-configuration"></a>Конфигурация FCM

1. Убедитесь, что *ключ сервера,* полученный от Firebase, соответствует ключу сервера, зарегистрированного на портале Azure.

   ![Ключ сервера Firebase][3]

2. Убедитесь, что на клиенте настроен **идентификатор проекта**. Значение для **идентификатора проекта** можно получить на панели мониторинга Firebase.

   ![Идентификатор проекта Firebase][1]

## <a name="application-issues"></a>Проблемы с приложением

### <a name="tags-and-tag-expressions"></a>Теги и выражения тегов

Если вы используете теги или выражения тегов для сегмента аудитории, возможно, что при отправке уведомления цель не найдена. Эта ошибка основана на указанных тегах или выражениях тегов в вашем вызове отправки.

Просмотрите свои регистрации, чтобы убедиться, что теги совпадают при отправке уведомления. Затем проверьте квитанцию об уведомлении только от клиентов, которые имеют эти регистрации.

Например, предположим, что все ваши регистрации с помощью концентраторов уведомлений используют тег "Политика". Если вы отправите уведомление с тегом "Спорт", уведомление не будет отправлено на любое устройство. Сложный случай может включать выражения тегов, когда вы зарегистрировались с помощью "Tag A" *или* "Tag B", но вы нацелились на "Tag A && Tag B". Самодиагностика советы раздел позже в статье показывает вам, как пересмотреть ваши регистрации и их теги.

### <a name="template-issues"></a>Проблемы с шаблонами

Если используются шаблоны, убедитесь, что вы следуете рекомендациям, приведенным в статье [Шаблоны].

### <a name="invalid-registrations"></a>Недопустимые регистрации

Если концентратор уведомлений был настроен правильно и были использованы правильные теги или выражения тегов, найдены допустимые цели. которым необходимо отправить уведомления. Затем Центры уведомлений параллельно запускают несколько пакетов обработки. Каждый пакет отправляет сообщения набору регистраций.

> [!NOTE]
> Поскольку концентраторы уведомлений параллельно обрабатывает пакеты, порядок доставки уведомлений не гарантируется.

Концентраторы уведомлений оптимизированы для модели доставки сообщений "наиболее один раз". Мы пытаемся выполнить дедупликацию так, чтобы уведомления доставлялись на устройство по одному разу. Регистрации проверяются, чтобы убедиться, что только одно сообщение отправляется на идентификатор устройства, прежде чем он отправляется в службу push-уведомлений.

Каждая партия отправляется в службу push-уведомлений, которая, в свою очередь, принимает и проверяет регистрацию. Во время этого процесса может быть обнаружена ошибка с одной или более регистрацией в партии. Затем служба push-уведомлений возвращает ошибку в концентраторы уведомлений, и процесс останавливается. Служба push-уведомлений полностью удаляет такой пакет. Это особенно верно в отношении APN, которые используют протокол потока TCP.

В этом случае регистрация неисправности удаляется из базы данных. Затем мы повторяем попытку доставки уведомлений для остальных устройств в этом пакете.

Чтобы получить больше информации об ошибках о неудачной попытке доставки в отношении регистрации, вы можете использовать apIs ApIs notification [Hubs per Message Telemetry: Get Notification message telemetry](https://docs.microsoft.com/rest/api/notificationhubs/get-notification-message-telemetry) и [PNS feedback.](https://msdn.microsoft.com/library/azure/mt705560.aspx) Пример кода приведен в [репозитории примеров для отправки с помощью REST](https://github.com/Azure/azure-notificationhubs-dotnet/tree/master/Samples/SendRestExample/).

## <a name="push-notification-service-issues"></a>Проблемы службы push-уведомлений

После того, как служба push-уведомлений получает уведомление, она доставляет уведомление устройству. На данный момент концентраторы уведомлений не контролируют доставку уведомления на устройство.

Поскольку службы уведомления платформы являются надежными, уведомления, как правило, достигают устройств в течение нескольких секунд. Если служба push-уведомлений регулируется, концентраторы уведомлений применяют экспоненциальную стратегию обратного отработки. Если служба push-уведомлений остается недоступной в течение 30 минут, срок действия политики истекает и отбрасывает сообщения навсегда.

Если служба push-уведомлений пытается доставить уведомление, но устройство находится в автономном режиме, уведомление хранится службой push-уведомлений. Он хранится в течение ограниченного периода времени. Уведомление доставляется на устройство, когда оно становится доступным.

Каждое приложение хранит только одно недавнее уведомление. Если несколько уведомлений отправляются в автономном режиме, каждое новое уведомление приводит к отбрасыванию последнего. Хранение только новейшего уведомления называется *объединением* в APN и *коллапсом* в FCM. (FCM использует рушится ключ.) Когда устройство остается в автономном режиме в течение длительного времени, уведомления, которые были сохранены для устройства, отбрасываются. Для получения дополнительной информации смотрите [обзор APNs] и [сообщения FCM].

С помощью концентраторов уведомлений можно передать ключ объединения через заголовок HTTP с помощью общего API SendNotification. Например, для пакета SDK для .NET можете использовать `SendNotificationAsync`. API SendNotification также принимает заголовки HTTP, которые передаются как в соответствующую службу push-уведомлений.

## <a name="self-diagnosis-tips"></a>Советы по самостоятельной диагностике

Ниже приведены пути диагностики основной причины отброшенных уведомлений в концентрах уведомлений.

### <a name="verify-credentials"></a>Проверка учетных данных

#### <a name="push-notification-service-developer-portal"></a>Портал разработчика службы push-уведомлений

Проверьте учетные данные на соответствующем портале разработчика службы push-уведомлений (APNs, FCM, служба уведомлений Windows и т. д.). Для получения дополнительной информации [см.](https://docs.microsoft.com/azure/notification-hubs/notification-hubs-windows-store-dotnet-get-started-wns-push-notification)

#### <a name="azure-portal"></a>Портал Azure

Чтобы просмотреть и сопоставить учетные данные с данными, полученными на портале разработчиков push-уведомлений, перейдите на вкладку **Политики доступа** на портале Azure.

![Вкладка "Политики доступа" на портале Azure][4]

### <a name="verify-registrations"></a>Проверка регистраций

#### <a name="visual-studio"></a>Visual Studio

В Visual Studio можно подключиться к Azure через Server Explorer для просмотра и управления несколькими службами Azure, включая концентраторы уведомлений. Этот ярлык в первую очередь полезен для среды разработки/тестирования.

![Обозреватель серверов в Visual Studio.][9]

![Обозреватель серверов](media/notification-hubs-push-notification-fixer/vsserverexplorer2.png)

Вы можете просматривать и управлять всеми регистрациями в вашем центре. Регистрации могут быть классифицированы по платформе, родной или шаблон регистрации, тег, push-уведомления службы идентификатора, регистрации ID, идентификатор, идентификатор, идентификатор, идентификатор. На этой странице можно также изменить регистрацию. Это особенно полезно для редактирования тегов.

Нажмите правой кнопкой мыши концентратор уведомлений в **Server Explorer**и выберите **Diagnose**. 

![Визуальный studio Server Explorer: Меню диагностики](./media/notification-hubs-push-notification-fixer/diagnose-menu.png)

Вы видите следующую страницу:

![Визуальная студия: Страница диагностики](./media/notification-hubs-push-notification-fixer/diagnose-page.png)

Переключитесь на страницу **регистрации устройств:**

![Визуальная студия: Регистрация устройств](./media/notification-hubs-push-notification-fixer/VSRegistrations.png)

Вы можете использовать страницу **Test Send** для отправки сообщения об ипомочном уведомлении теста:

![Визуальная студия: Тест Отправить](./media/notification-hubs-push-notification-fixer/test-send-vs.png)

> [!NOTE]
> Используйте Visual Studio для редектора регистраций только во время разработки/теста, а также с ограниченным числом регистраций. Если вам нужно отсеить регистрацию оптом, рассмотрите возможность использования функциональности регистрации экспорта и импорта, описанной в [Как: экспортировать и модифицировать регистрации в массовых.](https://msdn.microsoft.com/library/dn790624.aspx)

#### <a name="service-bus-explorer"></a>Service Bus Explorer

Многие клиенты используют [Service Bus Explorer](https://github.com/paolosalvatori/ServiceBusExplorer) для просмотра и управления концентраторами уведомлений. который представляет собой проект с открытым кодом. 

### <a name="verify-message-notifications"></a>Проверка уведомлений о сообщениях

#### <a name="azure-portal"></a>Портал Azure

Чтобы отправить тестовые уведомления клиентам, не запуская серверную часть службы, в разделе **Поддержка и устранение неполадок** выберите **Тестовая отправка**.

![Функциональные возможности тестовой отправки в Azure][7]

#### <a name="visual-studio"></a>Visual Studio

Тестовые уведомления также можно отправлять с помощью Visual Studio.

![Функциональные возможности тестовой отправки в Visual Studio][10]

Дополнительные сведения об использовании Центров уведомлений с помощью обозревателя серверов в Visual Studio см. в следующих статьях:

* [Как просмотреть регистрацию устройств для узлов уведомлений](https://docs.microsoft.com/previous-versions/windows/apps/dn792122(v=win.10))
* [Подробный обзор релиз-кандидата Visual Studio 2013 с обновлением 2 и пакета Azure SDK 2.3]
* [Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]

### <a name="debug-failed-notifications-and-review-notification-outcome"></a>Уведомления о сбоях отладки и просмотр результатов уведомлений

#### <a name="enabletestsend-property"></a>Свойство EnableTestSend

При отправке уведомления через концентраторы уведомлений уведомление первоначально стоит в очереди. Центры уведомлений определяют правильные цели, а затем отправляют уведомление в службу push-уведомлений. Если вы используете REST API или любой из SDK клиента, возврат вызова отправки означает только то, что сообщение стоит в очереди с концентраторами уведомлений. Он не дает представление о том, что произошло, когда концентраторы уведомлений в конечном итоге отправили уведомление в службу push-уведомлений.

Если ваше уведомление не поступает на клиентское устройство, может возникнуть ошибка, когда концентраторы уведомлений пытались доставить его в службу push-уведомлений. Например, размер полезных данных может превышать максимально допустимый размер таких данных в службе push-уведомлений или настроенные в Центрах уведомлений учетные данные могут быть недоступными.

Информацию об ошибках службы push-уведомлений можно получить с помощью свойства [EnableTestSend]. Оно автоматически включается при отправке тестового сообщения с портала или клиентского приложения Visual Studio Это свойство можно использовать для просмотра подробной информации об отладке, а также с помощью AA. Сейчас его можно использовать в пакете SDK для .NET. Он будет добавлен ко всем клиентским SDK в конечном итоге.

Чтобы использовать свойство `EnableTestSend` с вызовом REST, добавьте параметр строки запроса с именем *test* в конце вызова отправки. Пример:

```text
https://mynamespace.servicebus.windows.net/mynotificationhub/messages?api-version=2013-10&test
```

#### <a name="net-sdk-example"></a>Пример SDK .NET

Ниже приведен пример отправки собственного всплывающего уведомления при использовании пакета SDK для .NET:

```csharp
NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName);
var result = await hub.SendWindowsNativeNotificationAsync(toast);
Console.WriteLine(result.State);
```

В конце выполнения `result.State` просто заявляет `Enqueued`. Результаты не дают никакого представления о том, что произошло с вашим push-уведомлением.

Далее вы можете использовать логическое свойство `EnableTestSend`. С помощью свойства `EnableTestSend` во время инициализации `NotificationHubClient` можно получить подробные сведения об ошибках службы push-уведомлений, произошедших при отправке уведомления. Возврат вызова отправки занимает дополнительное время, поскольку для доставки уведомления сначала нужны концентраторы уведомлений.

```csharp
    bool enableTestSend = true;
    NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName, enableTestSend);

    var outcome = await hub.SendWindowsNativeNotificationAsync(toast);
    Console.WriteLine(outcome.State);

    foreach (RegistrationResult result in outcome.Results)
    {
        Console.WriteLine(result.ApplicationPlatform + "\n" + result.RegistrationId + "\n" + result.Outcome);
    }
```

#### <a name="sample-output"></a>Пример выходных данных

```text
DetailedStateAvailable
windows
7619785862101227384-7840974832647865618-3
The Token obtained from the Token Provider is wrong
```

Это сообщение указывает либо на то, что учетные данные, настроенные в концентрах уведомлений, являются недействительными, либо что в концентраторе есть проблема с регистрацией. Удалите эту регистрацию и позвольте клиенту воссоздать регистрацию перед отправкой сообщения.

> [!NOTE]
> Использование свойства `EnableTestSend` строго регулируется. Используйте эту опцию только в среде разработки/тестирования и с ограниченным набором регистраций. Уведомления от оделость отправляются только на 10 устройств. Там также ограничение на обработку отладки посылает, на 10 в минуту.

### <a name="review-telemetry"></a>Просмотр телеметрии

#### <a name="azure-portal"></a>Портал Azure

На портале вы можете получить краткий обзор всех операций, выполняемых в Центре уведомлений.

1. На вкладке **Обзор** можно просмотреть объединенное представление регистраций, уведомлений и ошибок каждой платформы.

   ![Панель мониторинга "Обзор" в Центре уведомлений][5]

2. На вкладке **Монитор** можно добавить дополнительные метрики для конкретной платформы, чтобы получить подробные сведения о состоянии. Вы можете посмотреть конкретно на ошибки, которые возвращаются, когда концентраторы уведомлений пытаются отправить уведомление в службу push-уведомлений.

   ![Журнал действий на портале Azure][6]

3. Сначала просмотрите **входящие сообщения**, **операции регистрации** и **доставленные уведомления**. Затем перейдите на вкладку каждой платформы, чтобы просмотреть ошибки, связанные со службой push-уведомлений.

4. Если параметры проверки подлинности для Центра уведомлений неверные, будет получена ошибка **выполнения проверки подлинности PNS**. Это хороший показатель для проверки учетных данных службы push-уведомлений.

#### <a name="programmatic-access"></a>Программный доступ

Для получения дополнительной информации о программном доступе [см.](https://docs.microsoft.com/previous-versions/azure/azure-services/dn458823(v=azure.100))

> [!NOTE]
> Некоторые функции, связанные с телеметрией, например экспорт и импорт данных регистраций и доступ к телеметрии с помощью API, доступны только на уровне служб "Стандартный". Если вы попытаетесь использовать эти функции из уровня бесплатных или базовых служб, вы получите сообщение об исключении, если вы используете SDK. Вы получите ошибку HTTP 403 (Запрещенная), если вы используете функции непосредственно из APIs REST.
>
> Чтобы использовать функции, связанные с телеметрией, сначала убедитесь на портале Azure, что вы используете уровень стандартных услуг.  

<!-- IMAGES -->
[0]: ./media/notification-hubs-push-notification-fixer/Architecture.png
[1]: ./media/notification-hubs-push-notification-fixer/FCMConfigure.png
[3]: ./media/notification-hubs-push-notification-fixer/FCMServerKey.png
[4]: ../../includes/media/notification-hubs-portal-create-new-hub/notification-hubs-connection-strings-portal.png
[5]: ./media/notification-hubs-push-notification-fixer/PortalDashboard.png
[6]: ./media/notification-hubs-push-notification-fixer/PortalAnalytics.png
[7]: ./media/notification-hubs-ios-get-started/notification-hubs-test-send.png
[8]: ./media/notification-hubs-push-notification-fixer/VSRegistrations.png
[9]: ./media/notification-hubs-push-notification-fixer/vsserverexplorer.png
[10]: ./media/notification-hubs-push-notification-fixer/VSTestNotification.png

<!-- LINKS -->
[Обзор концентратов уведомлений]: notification-hubs-push-notification-overview.md
[Начало работы с Центрами уведомлений для приложений универсальной платформы Windows]: notification-hubs-windows-store-dotnet-get-started-wns-push-notification.md
[Шаблоны]: https://msdn.microsoft.com/library/dn530748.aspx
[Обзор APNs]: https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html
[Сведения о сообщениях FCM]: https://firebase.google.com/docs/cloud-messaging/concept-options
[Export and modify registrations in bulk]: https://msdn.microsoft.com/library/dn790624.aspx
[Service Bus Explorer code]: https://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a
[View device registrations for notification hubs]: https://msdn.microsoft.com/library/windows/apps/xaml/dn792122.aspx
[Подробный обзор релиз-кандидата Visual Studio 2013 с обновлением 2 и пакета Azure SDK 2.3]: https://azure.microsoft.com/blog/2014/04/09/deep-dive-visual-studio-2013-update-2-rc-and-azure-sdk-2-3/#NotificationHubs
[Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]: https://azure.microsoft.com/blog/2014/08/04/announcing-release-of-visual-studio-2013-update-3-and-azure-sdk-2-4/
[Сведения о свойстве EnableTestSend]: https://docs.microsoft.com/dotnet/api/microsoft.azure.notificationhubs.notificationhubclient.enabletestsend?view=azure-dotnet
[Programmatic telemetry access]: https://msdn.microsoft.com/library/azure/dn458823.aspx
