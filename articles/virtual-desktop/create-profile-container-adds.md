---
title: Создание контейнера для профилей FSLogix, azure Files Active Directory Domain Services - Azure
description: В этой статье описывается, как создать контейнер профиля FSLogix с помощью файлов Azure и служб домена Active Directory.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 04/10/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: dd01b950435fadb96a961b6bb1c6b28ff436907a
ms.sourcegitcommit: 8dc84e8b04390f39a3c11e9b0eaf3264861fcafc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2020
ms.locfileid: "81265776"
---
# <a name="create-an-fslogix-profile-container-with-azure-files"></a>Создание контейнера профиля FSLogix с помощью файлов Azure

В этой статье будет показан способ создания контейнера профиля FSLogix с помощью файлов Azure и служб ы домена Active Directory (AD DS).

## <a name="prerequisites"></a>Предварительные требования

В этой статье предполагается, что вы уже создали экземпляр Azure AD DS. Если у вас его еще нет, следуйте инструкциям сначала в [«Создайте базовый управляемый домен»,](../active-directory-domain-services/tutorial-create-instance.md) а затем вернитесь сюда.

## <a name="add-azure-ad-ds-admins"></a>Добавить admins Azure AD DS

Чтобы добавить дополнительные админы, необходимо создать нового пользователя и предоставить им разрешения.

Чтобы добавить админ:

1. Выберите **Active Directory Azure** из боковой панели, затем выберите **всех пользователей,** а затем выберите **нового пользователя.**

2.  Введите сведения пользователя в поля.

3. В панели Active Directory Azure на левой стороне экрана выберите **группы.**

4. Выберите группу **администраторов AAD DC.**

5. В левой панели выберите **Участников,** затем выберите **Добавить участников** в основной панели. Это покажет список всех пользователей, доступных в Azure AD. Выберите имя только что созданного профиля пользователя.

## <a name="set-up-an-azure-storage-account"></a>Настройка учетной записи хранения Azure

Теперь пришло время включить проверку подлинности Azure AD DS через блок сообщений сервера (SMB). 

Для обеспечения аутентификации:

1. Если вы еще не сделали этого, навяжните и разместите учетную запись v2 Azure Storage общего назначения, следуя инструкциям в [создании учетной записи хранения Azure.](../storage/common/storage-account-create.md)

2. После того как вы закончите настройку учетной записи, выберите **Перейти к ресурсу.**

3. Выберите **конфигурацию** из панели на левой стороне экрана, а затем включите **проверку подлинности Active Directory Azure для файлов Azure** в главном стекле. Когда все будет готово, нажмите кнопку **Сохранить**.

4. Выберите **Обзор** в панели на левой стороне экрана, а затем выберите **файлы** в главном стекле.

5. Выберите **раздел файла** и введите **имя** и **квоту** в поля, которые отображаются на правой стороне экрана.

## <a name="assign-access-permissions-to-an-identity"></a>Назначение разрешений на доступ для удостоверения

Другим пользователям потребуются разрешения на доступ к вашей совместной сетой файлу. Для этого необходимо назначить каждому пользователю роль с соответствующими разрешениями доступа.

Для присвоения пользователям разрешений на доступ:

1. С портала Azure откройте созданный файл в [учетной записи Хранилища Azure.](#set-up-an-azure-storage-account)

2. Выберите **элемент управления доступом (IAM)**.

3. Выберите **Добавление назначения роли**.

4. Во вкладке **«Назначение роли добавить»** выберите соответствующую встроенную роль из списка ролей. Вам нужно будет, по крайней мере, выбрать **хранения файла данных SMB Доля Вкладчик** для учетной записи, чтобы получить соответствующие разрешения.

5. Для **присваивайте доступ к пользователю,** **группе или главному обслуживанию Azure Active Directory.**

6. Выберите имя или адрес электронной почты для целевой идентификации Azure Active Directory.

7. Щелкните **Сохранить**.

## <a name="get-the-storage-account-access-key"></a>Получите ключ доступа к учетной записи хранилища

Далее необходимо получить ключ доступа к учетной записи хранилища.

Чтобы получить ключ доступа к учетной записи хранилища:

1. На боковой панели портала Azure выберите **учетные записи хранилища.**

2. Из списка учетных записей хранилища выберите учетную запись, для которой вы включили AD Azure и создали пользовательские роли в вышеуказанных шагах.

3. Под **настройками**выберите **ключи доступа** и скопируйте ключ из **ключа1.**

4. Перейдите на вкладку **Virtual Machines** и найдите любой VM, который станет частью вашего пула.

5. Выберите название виртуальной машины (VM) под **виртуальными машинами (adVM)** и выберите **Connect**

    Это позволит скачать файл RDP, который позволит вам войти в VM с его собственными учетными данными.

    ![Скриншот вкладки RDP окна Connect to virtual machine.](media/rdp-tab.png)

6. При входе в VM запустите запрос команды в качестве администратора.

7. Выполните следующую команду:

     ```cmd
     net use <desired-drive-letter>: \\<storage-account-name>.file.core.windows.net\<share-name> <storage-account-key> /user:Azure\<storage-account-name>
     ```

    - Заменить `<desired-drive-letter>` дисковой буквой по вашему выбору (например, `y:`).
    - Замените все `<storage-account-name>` экземпляры с именем учетной записи хранилища, указанной ранее.
    - Замените `<share-name>` имя раньше созданной вами акции.
    - Замените `<storage-account-key>` ключ учетной записи хранилища из Azure.

    Пример:  
  
     ```cmd
     net use y: \\fsprofile.file.core.windows.net\share HDZQRoFP2BBmoYQ=(truncated)= /user:Azure\fsprofile)
     ```

8. Запустите следующую команду, чтобы предоставить пользователю полный доступ к совместной акции Azure Files.

     ```cmd
     icacls <mounted-drive-letter>: /grant <user-email>:(f)
     ```

    - Замените `<mounted-drive-letter>` букву диска, который вы хотите использовать.
    - Замените `<user-email>` UPN пользователя, который будет использовать этот профиль для доступа к VMs-ми-м хостам сессии.

    Пример:
     
     ```cmd
     icacls y: /grant john.doe@contoso.com:(f)
     ```

## <a name="create-a-profile-container"></a>Создание контейнера профилей

Теперь, когда ваши профили готовы к работе, давайте создадим контейнер профиля FSLogix.

Для настройки контейнера профиля FSLogix:

1. Войдите в в сессию хост VM вы настроены в начале этой статьи, а затем [скачать и установить агент FSLogix](/fslogix/install-ht/).

2. Unzip FSLogix агент файл вы скачали и перейти к **x64** > **релизы**, а затем открыть **FSLogixAppsSetup.exe**.

3. Как только установщик запускает, выберите **я согласен с условиями лицензии.** Если это применимо, предоставьте новый ключ.

4. Выберите пункт **Установить**.

5. Open **Drive C**, а затем перейти к программе **Файлов** > **FSLogix** > **Apps,** чтобы убедиться, что агент FSLogix был правильно установлен.

     >[!NOTE]
     > Если в пуле хостов имеется несколько вм: шаги должны повторяться от 1 до 5 для каждого VM.

6. Выполнить **редактор реестра** (RegEdit) в качестве администратора.

7. Перейдите > на компьютер > **но-HKEY_LOCAL_MACHINE** > **программное обеспечение****FSLogix**, правое нажатие на **FSLogix**, выберите **новый**, а затем выберите **ключ**. **Computer**

8. Создайте новый ключ под названием **Профили**.

9.  Нажмите на **профиль**справа, выберите **новое,** а затем выберите **значение DWORD (32-битного).** Назовите значение **Enabled** и установите значение **данных** до **1**.

    ![Скриншот ключа Профили. Выделено REG_DWORD файла и значение его данных установлено на 1.](media/dword-value.png)

10. Нажмите на **профили,** выберите **новое,** а затем выберите **Значение Multi-String.** Назовите значение **VHDLocations** и установите uri `\\fsprofile.file.core.windows.net\share` для общего использования файлов Azure в качестве значения данных.

    ![Скриншот ключа профилей, показывающий файл VHDLocations. Значение данных отображает URI для общего использования файлов Azure.](media/multi-string-value.png)

## <a name="assign-users-to-a-session-host"></a>Назначить пользователей хостам сеанса

Теперь вам нужно назначить пользователей хостам сеанса.

Для присвоения пользователям:

1. Запустите Windows PowerShell в качестве администратора, а затем запустите следующий cmdlet, чтобы войти в Windows Virtual Desktop с PowerShell:

   ```powershell
   Import-Module Microsoft.RdInfra.RdPowershell

   #Optional
   Install-Module Microsoft.RdInfra.RdPowershell

   $brokerurl = "https://rdbroker.wvd.microsoft.com"

   Add-RdsAccount -DeploymentUrl $brokerurl
   ```

   При запросе для учетных данных введите того же пользователя, который был предоставлен TenantCreator, владелец RDS, или RDS Роль на Windows Virtual Desktop арендатора.

2. Запустите следующие cmdlets, чтобы назначить пользователя в группу удаленного рабочего стола:

     ```powershell
     $tenant = "<your-wvd-tenant>"

     $pool1 = "<wvd-pool>"

     $appgroup = "Desktop Application Group"

     $user1 = "<user-principal>"

     Add-RdsAppGroupUser $tenant $pool1 $appgroup $user1
     ```

    Как и предыдущие cmdlets, `<your-wvd-tenant>`не `<wvd-pool>`забудьте заменить , и `<user-principal>` с соответствующими значениями.

    Пример:

     ```powershell
     $pool1 = "contoso"
     
     $tenant = "contoso"
     
     $appgroup = "Desktop Application Group"
     
     $user1 = "jane.doe@contoso.com"
     
     Add-RdsAppGroupUser $tenant $pool1 $appgroup $user1
     ```

## <a name="make-sure-your-profile-works"></a>Убедитесь, что ваш профиль работает

Теперь все, что вам нужно сделать, это убедиться, что профиль вы создали существует и работает по назначению.

Для проверки профиля:

1. Откройте браузер и перейдите к [веб-клиенту Windows Virtual Desktop.](https://rdweb.wvd.microsoft.com/webclient/index.html)

2. Войти на учетную запись пользователя, назначенную группе удаленного рабочего стола.

3. Как только сеанс пользователя был установлен, откройте портал Azure и вопийте с административным аккаунтом.

4. Из боковой панели выберите **учетные записи хранилища.**

5. Выберите учетную запись хранилища, настроенную в качестве раздела файла для пула хостов сеансов и включенную с помощью Azure AD DS.

6. Выберите значок **файлов,** а затем расширьте свою долю.

    Если все настроено правильно, вы должны увидеть **каталог** с именем, которое `<user SID>-<username>`отформатировано следующим образом: .

## <a name="next-steps"></a>Дальнейшие действия

Если вы ищете альтернативные способы создания контейнеров профиля FSLogix, ознакомьтесь со следующими статьями:

- [Создайте контейнер профиля для пула хоста, используя общую часть файлов.](create-host-pools-user-profile.md)
- [Создание контейнера профиля FSLogix для пула хоста с помощью файлов Azure NetApp](create-fslogix-profile-container.md)

Более подробную информацию о концепциях, связанных с контейнерами FSlogix для файлов Azure, можно найти в [контейнерах профиля FSLogix и файлах Azure.](fslogix-containers-azure-files.md)
