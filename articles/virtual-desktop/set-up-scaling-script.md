---
title: Автоматическое масштабирование узлов сеанса Апробация виртуального рабочего стола Windows - Azure
description: В этой статье описывается настройка автоматического масштабирования сценария для узлов сеанса Апробация виртуального рабочего стола Windows.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: how-to
ms.date: 03/21/2019
ms.author: helohr
ms.openlocfilehash: 7687abf5fc4af0eea9fa6aa210cfd6734cec2b36
ms.sourcegitcommit: 6f043a4da4454d5cb673377bb6c4ddd0ed30672d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2019
ms.locfileid: "65410570"
---
# <a name="automatically-scale-session-hosts"></a>Автоматическое масштабирование узлов сеанса

Для многих развертываний Апробация виртуального рабочего стола Windows в Azure затраты на виртуальные машины представляют значительную часть общую стоимость развертывания виртуального рабочего стола Windows. Чтобы снизить затраты, рекомендуется завершить работу и освободить сеанса размещения виртуальных машин (ВМ) во время пониженной нагрузки, а затем перезапустите их в часы пиковой нагрузки.

В этой статье используется простой сценарий масштабирования для автоматического масштабирования сеанса размещения виртуальных машин в среде виртуального рабочего стола Windows. Дополнительные сведения о том, как сценарий масштабирования, см. в разделе [принцип масштабирования сценарий](#how-the-scaling-script-works) раздел.

## <a name="prerequisites"></a>Технические условия

Среда, где выполняется сценарий необходимо иметь следующее:

- Клиент виртуального рабочего стола Windows и учетная запись или субъект-службу с разрешениями для запроса клиента (например, участник служб удаленных рабочих СТОЛОВ).
- Виртуальные машины пула узлов сеанса настройки и регистрации в службе виртуальный рабочий стол Windows.
- Дополнительная виртуальная машина, выполнение запланированной задачи с помощью планировщика заданий и имеет доступ к сети для узлов сеанса. Это будет, ссылающиеся позднее в этом документе как scaler виртуальной Машины.
- [Модуля Microsoft Azure Resource Manager PowerShell](https://docs.microsoft.com/powershell/azure/azurerm/install-azurerm-ps) установлен на виртуальной Машине, выполнение запланированной задачи.
- [Модуля PowerShell для виртуальных рабочих столов Windows](https://docs.microsoft.com/powershell/windows-virtual-desktop/overview) установлен на виртуальной Машине, выполнение запланированной задачи.

## <a name="recommendations-and-limitations"></a>Рекомендации и ограничения

При выполнения сценария масштабирования, имейте в виду следующее:

- Этот сценарий масштабирования может обрабатывать только один пул узлов для каждого экземпляра задания, на котором выполняется скрипт масштабирования.
- Задания, запускать сценарии масштабирования должна находиться на виртуальную Машину, которая всегда включен.
- Создайте отдельную папку для каждого экземпляра масштабирования сценария и его конфигурации.
- Этот сценарий не поддерживает вход от имени администратора к виртуальному рабочему столу Windows с учетными записями пользователей Azure AD, требующих многофакторной проверки подлинности. Мы рекомендуем использовать субъекты-службы для доступа к службе виртуального рабочего стола Windows и Azure. Выполните [учебником](create-service-principal-role-powershell.md) Создание субъекта-службы и назначение роли с помощью PowerShell.
- Для получения гарантии SLA Azure применяется только к виртуальным машинам в группе доступности. Текущая версия документа описывает среду с одной виртуальной Машины это масштабирования, который может не отвечать требованиям доступности.

## <a name="deploy-the-scaling-script"></a>Развертывание масштабирования сценарий

Следующие процедуры описывают, как выполнить развертывание масштабирования скрипт.

### <a name="prepare-your-environment-for-the-scaling-script"></a>Подготовка среды для масштабирования скрипта

Во-первых Подготовка среды для масштабирования скрипта:

1. Войдите на виртуальную машину (scaler виртуальной Машины), будет выполняться задание с учетной записью администратора домена.
2. Создайте папку на scaler виртуальной Машины, масштабирования сценарий и его конфигурации (например, **C:\\масштабирование HostPool1**).
3. Скачайте **basicScale.ps1**, **Config.xml**, и **функции PSStoredCredentials.ps1** файлы и **PowershellModules** папки с [масштабирование репозиторий сценариев](https://github.com/Azure/RDS-Templates/tree/master/wvd-sh/WVD%20scaling%20script) и скопируйте их в папку, созданную на шаге 2. Существует два основных способа получить файлы перед их копированием scaler виртуальной Машины:
    - Клонируйте репозиторий git на локальный компьютер.
    - Представление **Raw** версию каждого файла, скопируйте и вставьте содержимое каждого файла в текстовый редактор, а затем сохраните файлы с соответствующим именем файла и тип файла. 

### <a name="create-securely-stored-credentials"></a>Создание безопасного сохраненных учетных данных

Далее необходимо создать безопасно сохраненные учетные данные:

1. Откройте интегрированную среду Сценариев PowerShell с правами администратора.
2. Импортируйте модуль PowerShell для служб удаленных рабочих СТОЛОВ, выполнив следующий командлет:

    ```powershell
    Install-Module Microsoft.RdInfra.RdPowershell
    ```
    
3. Откройте область редактирования и загрузите **PSStoredCredentials.ps1 функция** файл.
4. Выполните следующий командлет:
    
    ```powershell
    Set-Variable -Name KeyPath -Scope Global -Value <LocalScalingScriptFolder>
    ```
    
    Например **Set-Variable - имя KeyPath-область глобального-значение «c:\\масштабирование HostPool1»**
5. Запустите **New StoredCredential - KeyPath \$KeyPath** командлета. При запросе введите свои учетные данные виртуальному рабочему столу Windows с разрешениями для запроса пула узла (узла пула указывается в **config.xml**).
    - Если вы используете отдельный субъект-службу или стандартной учетной записью, выполните **New StoredCredential - KeyPath \$KeyPath** командлета после для каждой учетной записи для создания локальных сохраненные учетные данные.
6. Запустите **Get StoredCredentials-список** для подтверждения того, учетные данные были успешно созданы.

### <a name="configure-the-configxml-file"></a>Настройка файла config.xml

Введите соответствующие значения в следующие поля, чтобы обновить параметры масштабирования скрипта в файле config.xml:

| Поле                     | Описание                    |
|-------------------------------|------------------------------------|
| AADTenantId                   | Идентификатор клиента AD Azure, связывающий подписки, где запускается узла сеансов виртуальных машин     |
| AADApplicationId              | Идентификатор приложения субъекта-службы                                                       |
| AADServicePrincipalSecret     | Это могут быть введены стадии тестирования, но хранится пустым после создания учетных данных с помощью **PSStoredCredentials.ps1 функции**    |
| currentAzureSubscriptionId    | Идентификатор подписки Azure, где запускается узла сеансов виртуальных машин                        |
| tenantName                    | Имя виртуального рабочего стола Windows клиента                                                    |
| hostPoolName                  | Имя пула узла виртуального рабочего стола Windows                                                 |
| RDBroker                      | URL-адрес службы WVD, по умолчанию значение https:\//rdbroker.wvd.microsoft.com             |
| Имя пользователя                      | Идентификатор приложения субъекта-службы (это может быть один субъект-службу, как показано в AADApplicationId) или обычного пользователя без многофакторной проверки подлинности |
| isServicePrincipal            | Принимаются значения **true** или **false**. Указывает, является ли второй набор учетных данных, используемых субъекта-службы или стандартной учетной записью. |
| BeginPeakTime                 | Когда начинается время пикового использования                                                            |
| EndPeakTime                   | Когда заканчивается время пикового использования                                                              |
| TimeDifferenceInHours         | Разница во времени между местным временем и временем UTC, в часах                                   |
| SessionThresholdPerCPU        | Максимальное количество сеансов на пороговое значение загрузки ЦП позволяет определить, когда виртуальная машина узла новый сеанс должна быть запущена в часы пик.  |
| MinimumNumberOfRDSH           | Минимальное количество узлов пула виртуальных машин, чтобы продолжать работать во время пониженной нагрузки             |
| LimitSecondsToForceLogOffUser | Количество секунд ожидания перед принуждает пользователей к выйдите из системы. Если значение равно 0, пользователям не приходилось выйдите из системы.  |
| LogOffMessageTitle            | Заголовок сообщения, отправленного пользователю, прежде чем они приходится выйти из системы                  |
| LogOffMessageBody             | Текст сообщения предупреждений, отправляемых пользователям до их выхода. Например «этот компьютер будет завершать процесс вниз по содержимому X минут. Сохраните работу и выйти из системы.» |

### <a name="configure-the-task-scheduler"></a>Настройка планировщика

После настройки XML-файл конфигурации, необходимо настроить планировщик задач для запуска файла basicScaler.ps1 через регулярные интервалы.

1. Запуск **планировщик задач**.
2. В **планировщик** выберите **создать задачу...**
3. В **создать задачу** диалоговом окне выберите **Общие** введите **имя** (например, «Динамический RDSH»), выберите **запуска ли пользователь вошел в систему, или не** и **выполнить с наивысшими правами**.
4. Перейдите к **триггеры** , а затем установите **New...**
5. В **новый триггер** диалогового окна в разделе **Дополнительные параметры**, проверьте **Повторять задачу каждые** и выберите соответствующий период и длительность (например, **15 минут** или **бесконечно**).
6. Выберите **действия** вкладку и **New...**
7. В **новое действие** диалоговом окне введите **powershell.exe** в **программы или сценария** поле, а затем введите **C:\\масштабирование\\ RDSScaler.ps1** в **добавить аргументы (необязательно)** поля.
8. Перейдите к **условия** и **параметры** вкладки и выберите **ОК** чтобы принять параметры по умолчанию для каждого.
9. Введите пароль для учетной записи администратора, в которых вы планируете запустить его масштабирования.

## <a name="how-the-scaling-script-works"></a>Как работает сценарий масштабирования

Этот сценарий масштабирования считывает параметры из файла config.xml, включая начала и окончания периода пиковой использования в течение дня.

Во время пикового использования сценарий проверяет текущее количество сеансов и масштабировании RDSH выполнения для каждого узла пула. Она вычисляет, если выполнение узла сеансов виртуальных машин имеют достаточную емкость для существующих сеансов на основе параметра SessionThresholdPerCPU, определенные в файле config.xml. Если нет, сценарий запускает дополнительный сеанс размещаются виртуальные машины в пуле узлов.

Во время пониженной нагрузки он определяет, какое размещение сеанса, виртуальные машины следует завершить работу на основе параметра MinimumNumberOfRDSH в файле config.xml. Сценарий установит сеанса размещения виртуальных машин, для утечки режим, чтобы новые сеансы, подключившись к узлам. Если задать **LimitSecondsToForceLogOffUser** параметр в файле config.xml положительное ненулевое значение, скрипт будет уведомлять любой момент выполнен вход пользователям сохранить работу, подождите заданного периода времени и затем принудительно Пользователи, чтобы выйти из системы. После всех сеансов пользователей подписания на узле сеанс виртуальной Машины, сценарий будет завершить работу сервера.

Если задать **LimitSecondsToForceLogOffUser** параметр в файле config.xml, равным нулю, сценарий позволит параметром конфигурации сеанса в узел свойства пула для обработки подписи завершение сеансов пользователей. Если на узле виртуальной Машины сеанса все сеансы, он оставит узла сеансов виртуальных Машин под управлением. Если нет всех сеансов, сценарий завершит работу виртуальной Машины узла сеанса.

Скрипт предназначен для периодического запуска на сервере scaler виртуальной Машины, с помощью планировщика заданий. Выберите соответствующий временной интервал, в зависимости от размера среды служб удаленных рабочих столов и помните, что запуск и завершение работы виртуальных машин может занять некоторое время. Мы рекомендуем выполнять масштабирование сценария каждые 15 минут.

## <a name="log-files"></a>Файлы журналов

Масштабирования скрипт создает два файла журнала, **WVDTenantScale.log** и **WVDTenantUsage.log**. **WVDTenantScale.log** файл, регистрируются события и ошибки (если таковые имеются) во время выполнения сценария масштабирования.

**WVDTenantUsage.log** файл записывается active количество ядер и числом активных виртуальных машин при каждом выполнении масштабирования скрипт. Эти сведения можно использовать для оценки фактического использования виртуальных машин Microsoft Azure и стоимость. Этот файл форматируется как значения с разделителями запятыми, с каждым элементом, который содержит следующую информацию:

>время, пула узла, ядер, виртуальных машин

Имя файла можно также изменить, чтобы иметь расширение CSV, загружаются в Microsoft Excel и анализа.
