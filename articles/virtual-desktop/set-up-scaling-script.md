---
title: Автоматическое масштабирование узлов сеансов виртуальных рабочих столов Windows — Azure
description: Описывает, как настроить скрипт автоматического масштабирования для узлов сеансов виртуальных рабочих столов Windows.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 10/02/2019
ms.author: helohr
ms.openlocfilehash: 932fbe6814df8ec324dd3360bcacfcbcf1c19b62
ms.sourcegitcommit: 15e3bfbde9d0d7ad00b5d186867ec933c60cebe6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2019
ms.locfileid: "71842772"
---
# <a name="scale-session-hosts-dynamically"></a>Динамическое масштабирование узлов сеансов

Для многих развертываний виртуальных рабочих столов Windows в Azure стоимость виртуальных машин представляет значительную часть общей стоимости развертывания виртуальных рабочих столов Windows. Чтобы снизить затраты, лучше завершить работу виртуальных машин узла сеансов (ВМ) в нерабочее время, а затем перезапустить их в течение пикового времени использования.

В этой статье используется простой скрипт масштабирования для автоматического масштабирования виртуальных машин узла сеансов в среде виртуальных рабочих столов Windows. Дополнительные сведения о том, как работает сценарий масштабирования, см. в разделе [как работает сценарий масштабирования](#how-the-scaling-script-works) .

## <a name="prerequisites"></a>Предварительные требования

Среда, в которой выполняется сценарий, должна иметь следующие особенности.

- Клиент и учетная запись виртуального рабочего стола Windows или субъект-служба с разрешениями на запрос этого клиента (например, участника RDS).
- Виртуальные машины пула узлов сеансов, настроенные и зарегистрированные в службе виртуальных рабочих столов Windows.
- Дополнительная виртуальная машина, которая запускает запланированную задачу через планировщик задач и имеет сетевой доступ к узлам сеансов. Это будет называться позже в документе как виртуальная машина для масштабирования.
- [Модуль PowerShell Microsoft Azure диспетчер ресурсов](https://docs.microsoft.com/powershell/azure/azurerm/install-azurerm-ps) , установленный на виртуальной машине, на которой выполняется запланированная задача.
- [Модуль PowerShell для виртуальных рабочих столов Windows](https://docs.microsoft.com/powershell/windows-virtual-desktop/overview) , установленный на виртуальной машине, на которой выполняется запланированная задача.

## <a name="recommendations-and-limitations"></a>Рекомендации и ограничения

При выполнении скрипта масштабирования учитывайте следующие моменты.

- Этот скрипт масштабирования может работать только с одним пулом узлов на один экземпляр запланированной задачи, выполняющей скрипт масштабирования.
- Запланированные задачи, выполняющие скрипты масштабирования, должны находиться на виртуальной машине, которая всегда включена.
- Создайте отдельную папку для каждого экземпляра скрипта масштабирования и его конфигурации.
- Этот сценарий не поддерживает вход в качестве администратора для виртуальных рабочих столов Windows с учетными записями пользователей Azure AD, для которых требуется многофакторная проверка подлинности. Для доступа к службе виртуальных рабочих столов Windows и Azure рекомендуется использовать субъекты-службы. Следуйте указаниям [этого руководства](create-service-principal-role-powershell.md) , чтобы создать субъект-службу и назначение роли с помощью PowerShell.
- Гарантия соглашения об уровне обслуживания Azure применяется только к виртуальным машинам в группе доступности. В текущей версии документа описывается среда с одной виртуальной машиной, выполняющей масштабирование, что может не соответствовать требованиям к доступности.

## <a name="deploy-the-scaling-script"></a>Развертывание скрипта масштабирования

В следующих процедурах будет показано, как развернуть скрипт масштабирования.

### <a name="prepare-your-environment-for-the-scaling-script"></a>Подготовка среды для сценария масштабирования

Сначала подготовьте среду для сценария масштабирования:

1. Войдите на ВИРТУАЛЬную машину (масштабируемая виртуальная машина), которая будет выполнять запланированную задачу с учетной записью администратора домена.
2. Создайте папку на виртуальной машине с масштабируемым классом для хранения скрипта масштабирования и его конфигурации (например, **C: \\scaling-HostPool1**).
3. Скачайте файлы **басикскале. ps1**, **config. XML**и **Функтионс-пссторедкредентиалс. ps1** и папку **повершеллмодулес** из [репозитория сценариев масштабирования](https://github.com/Azure/RDS-Templates/tree/master/wvd-sh/WVD%20scaling%20script) и скопируйте их в папку, созданную на шаге 2. Существует два основных способа получения файлов перед их копированием на виртуальную машину с масштабируемым классом:
    - Клонировать репозиторий Git на локальный компьютер.
    - Просмотрите **необработанную** версию каждого файла, скопируйте и вставьте содержимое каждого файла в текстовый редактор, а затем сохраните файлы с соответствующими именами и типами файлов. 

### <a name="create-securely-stored-credentials"></a>Создание надежно сохраненных учетных данных

Далее необходимо создать безопасные хранимые учетные данные:

1. Откройте интегрированную среду сценариев PowerShell от имени администратора.
2. Импортируйте модуль RDS PowerShell, выполнив следующий командлет:

    ```powershell
    Install-Module Microsoft.RdInfra.RdPowershell
    ```
    
3. Откройте панель редактирования и загрузите файл **функтион-пссторедкредентиалс. ps1** , а затем выполните весь сценарий (F5).
4. Выполните следующий командлет:
    
    ```powershell
    Set-Variable -Name KeyPath -Scope Global -Value <LocalScalingScriptFolder>
    ```
    
    Например, **Set-Variable-Name ключевое имя области действия Global-Value "c: \\scaling-HostPool1"**
5. Выполните командлет **New-сторедкредентиал-ключевой \$KeyPath** . При появлении запроса введите учетные данные виртуального рабочего стола Windows с разрешениями на запрос пула узлов (пул узлов указан в **файле config. XML**).
    - Если вы используете разные субъекты-службы или учетную запись Standard, выполните командлет **New сторедкредентиал-ключевой \$KeyPath** один раз для каждой учетной записи, чтобы создать локальные сохраненные учетные данные.
6. Выполните команду **Get-сторедкредентиал-List** , чтобы подтвердить, что учетные данные были успешно созданы.

### <a name="configure-the-configxml-file"></a>Настройка файла config. XML

Введите соответствующие значения в следующие поля, чтобы обновить параметры сценария масштабирования в файле config. XML:

| Поле                     | Описание                    |
|-------------------------------|------------------------------------|
| AADTenantId                   | Идентификатор клиента Azure AD, связывающий подписку, в которой выполняются виртуальные машины узла сеансов.     |
| аадаппликатионид              | Идентификатор приложения субъекта-службы                                                       |
| аадсервицепринЦипалсекрет     | Он может быть введен на этапе тестирования, но должен быть пустым после создания учетных данных с помощью **функтионс-пссторедкредентиалс. ps1.**    |
| куррентазуресубскриптионид    | Идентификатор подписки Azure, в которой выполняются виртуальные машины узла сеанса                        |
| tenantName                    | Имя клиента виртуальных рабочих столов Windows                                                    |
| хостпулнаме                  | Имя пула узлов виртуальных рабочих столов Windows                                                 |
| рдброкер                      | URL-адрес службы ВВД, значение по умолчанию HTTPS: \//рдброкер. ВВД. Microsoft. com             |
| Имя пользователя                      | Идентификатор приложения субъекта-службы (возможно, он имеет тот же субъект-службу, что и Аадаппликатионид), или Стандартный пользователь без многофакторной проверки подлинности |
| иссервицепринЦипал            | Допустимые значения: **true** или **false**. Указывает, является ли используемый второй набор учетных данных субъектом-службой или стандартной учетной записью. |
| бегинпеактиме                 | Время начала пикового использования                                                            |
| ендпеактиме                   | Время окончания пикового использования                                                              |
| тимедифференцеинхаурс         | Разница во времени между местным временем и временем в формате UTC (в часах)                                   |
| сессионсрешолдперкпу        | Максимальное количество сеансов на каждый ЦП, используемое для определения необходимости запуска новой виртуальной машины узла сеанса в часы пиковой нагрузки.  |
| минимумнумберофрдш           | Минимальное число виртуальных машин пула узлов, которые должны выполняться в течение непикового времени использования             |
| лимитсекондстофорцелогоффусер | Время ожидания в секундах перед выходом пользователей из использования. Если задано значение 0, то пользователи не будут вынуждены выйти из нее.  |
| логоффмессажетитле            | Заголовок сообщения, отправленного пользователю до того, как он закончит выход                  |
| логоффмессажебоди             | Текст предупреждающего сообщения, отправленного пользователям перед выходом из него. Например, "Этот компьютер завершит работу через X минут. Сохраните свою работу и выйдите из нее ". |

### <a name="configure-the-task-scheduler"></a>Настройка планировщик задач

После настройки файла Configuration. XML необходимо настроить планировщик задач для запуска файла Басикскалер. ps1 через равные промежутки времени.

1. Запустите **планировщик задач**.
2. В окне **планировщик задач** выберите **создать задачу...**
3. В диалоговом окне **Создание задачи** перейдите на вкладку **Общие** , введите **имя** (например, "динамический сеанс удаленных рабочих столов"), выберите пункт Запустить, если **пользователь вошел в систему или не** **работает с самыми высокими привилегиями**.
4. Перейдите на вкладку **триггеры** и выберите **создать...**
5. В диалоговом окне **новый триггер** в разделе **Дополнительные параметры**установите флажок **Повторять задачу каждые** и выберите соответствующий период и длительность (например, **15 минут** или **бессрочно**).
6. Выберите вкладку **действия** и **создать...**
7. В диалоговом окне **Создание действия** введите **PowerShell. exe** в поле **Program/Script** , а затем введите **C: \\Scaling @ no__t-5basicScale. ps1** в поле **Добавить аргументы (необязательно)** .
8. Перейдите на вкладки **условия** и **Параметры** и нажмите кнопку **ОК** , чтобы принять параметры по умолчанию для каждого из них.
9. Введите пароль учетной записи администратора, в которой планируется запустить скрипт масштабирования.

## <a name="how-the-scaling-script-works"></a>Принцип работы сценария масштабирования

Этот скрипт масштабирования считывает параметры из файла config. XML, включая начало и конец пикового периода использования в течение дня.

Во время пикового использования скрипт проверяет текущее число сеансов и текущее количество выполняемых ресурсов для каждого пула узлов. Он вычисляет, достаточно ли емкости работающих виртуальных машин узла сеансов для поддержки существующих сеансов на основе параметра Сессионсрешолдперкпу, определенного в файле config. XML. В противном случае скрипт запускает дополнительные виртуальные машины узла сеансов в пуле узлов.

Во время непикового использования Скрипт определяет, какие виртуальные машины узла сеансов должны завершить работу в соответствии с параметром Минимумнумберофрдш в файле config. XML. Сценарий установит для виртуальных машин узла сеанса режим стока, чтобы предотвратить подключение новых сеансов к узлам. Если для параметра **лимитсекондстофорцелогоффусер** в файле config. XML задано ненулевое положительное значение, то сценарий будет уведомлять всех пользователей, выполнивших вход в систему, сохранить работу, подождать настроенное время, а затем вынудить пользователей выйти из нее. После того как все пользовательские сеансы будут отключены на виртуальной машине узла сеансов, сценарий завершит работу сервера.

Если для параметра **лимитсекондстофорцелогоффусер** в файле config. XML задано значение 0, скрипт разрешит параметр конфигурации сеанса в свойствах пула узлов, чтобы выполнять выход из сеанса пользователя. Если на виртуальной машине узла сеансов находятся какие-либо сеансы, виртуальная машина узла сеансов будет оставлена работающей. Если сеансов нет, сценарий завершит работу виртуальной машины узла сеансов.

Скрипт предназначен для периодического запуска на сервере виртуальных машин с помощью планировщик задач. Выберите соответствующий интервал времени в зависимости от размера среды службы удаленных рабочих столов и помните, что запуск и завершение работы виртуальных машин может занять некоторое время. Рекомендуется запускать скрипт масштабирования каждые 15 минут.

## <a name="log-files"></a>Файлы журнала

Скрипт масштабирования создает два файла журнала: **ввдтенантскале. log** и **ввдтенантусаже. log**. В файле **ввдтенантскале. log** регистрируются события и ошибки (если они есть) при каждом выполнении скрипта масштабирования.

Файл **ввдтенантусаже. log** записывает активное количество ядер и число виртуальных машин при каждом выполнении скрипта масштабирования. Эти сведения можно использовать для оценки фактического использования Microsoft Azure виртуальных машин и затрат. Файл форматируется как значения с разделителями-запятыми, при этом каждый элемент содержит следующие сведения:

>время, пул узлов, ядра, виртуальные машины

Имя файла также можно изменить для расширения CSV, загрузки в Microsoft Excel и анализа.
