---
title: Создание пула узлов для предварительного просмотра виртуальных рабочих столов Windows с помощью PowerShell в Azure
description: Создание пула узлов в предварительной версии виртуальных рабочих столов Windows с помощью командлетов PowerShell.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 05/06/2019
ms.author: helohr
ms.openlocfilehash: 2fd8934f34b811c0a2532f27e32fc799c2c8186e
ms.sourcegitcommit: d200cd7f4de113291fbd57e573ada042a393e545
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/29/2019
ms.locfileid: "70141847"
---
# <a name="create-a-host-pool-with-powershell"></a>Создание пула узлов с помощью PowerShell

Пулы узлов — это коллекция, состоящая из одной или нескольких идентичных виртуальных машин в средах клиента предварительной версии Виртуального рабочего стола Windows. Каждый пул узлов может содержать группы приложений, с которыми пользователи могут взаимодействовать, как с физическим рабочим столом.

## <a name="use-your-powershell-client-to-create-a-host-pool"></a>Создание пула узлов с помощью клиента PowerShell

Сначала [скачайте и импортируйте модуль PowerShell для Виртуального рабочего стола Windows](https://docs.microsoft.com/powershell/windows-virtual-desktop/overview) для использования в сеансе PowerShell (если вы еще это не сделали).

Выполните следующий командлет, чтобы войти в среду виртуальных рабочих столов Windows

```powershell
Add-RdsAccount -DeploymentUrl https://rdbroker.wvd.microsoft.com
```

Затем выполните этот командлет, чтобы создать новый пул узлов в клиенте виртуальных рабочих столов Windows:

```powershell
New-RdsHostPool -TenantName <tenantname> -Name <hostpoolname>
```

Выполните следующий командлет, чтобы создать маркер регистрации для авторизации узла сеансов для приподключения к пулу узлов и сохранения его в новом файле на локальном компьютере. Можно указать срок действия маркера регистрации с помощью параметра-Експиратионхаурс.

```powershell
New-RdsRegistrationInfo -TenantName <tenantname> -HostPoolName <hostpoolname> -ExpirationHours <number of hours> | Select-Object -ExpandProperty Token > <PathToRegFile>
```

После этого выполните этот командлет, чтобы добавить Azure Active Directory пользователей в группу классических приложений по умолчанию для пула узлов.

```powershell
Add-RdsAppGroupUser -TenantName <tenantname> -HostPoolName <hostpoolname> -AppGroupName "Desktop Application Group" -UserPrincipalName <userupn>
```

Командлет **Add-рдсаппграупусер** не поддерживает добавление групп безопасности и добавляет только одного пользователя за раз в группу приложений. Если вы хотите добавить нескольких пользователей в группу приложений, перезапустите командлет с соответствующими именами субъектов-пользователей.

Выполните следующий командлет, чтобы экспортировать маркер регистрации в переменную, которая будет использоваться позже в Зарегистрируйте [виртуальные машины в пуле узлов виртуальных рабочих столов Windows](#register-the-virtual-machines-to-the-windows-virtual-desktop-preview-host-pool).

```powershell
$token = (Export-RdsRegistrationInfo -TenantName <tenantname> -HostPoolName <hostpoolname>).Token
```

## <a name="create-virtual-machines-for-the-host-pool"></a>Создание виртуальных машин для пула узлов

Теперь можно создать виртуальную машину Azure, которую можно присоединить к пулу узлов виртуальных рабочих столов Windows.

Создать виртуальную машину можно несколькими способами.

- [Создание виртуальной машины из образа из коллекции Azure](https://docs.microsoft.com/azure/virtual-machines/windows/quick-create-portal#create-virtual-machine)
- [Создание виртуальной машины из управляемого образа](https://docs.microsoft.com/azure/virtual-machines/windows/create-vm-generalized-managed)
- [Создание виртуальной машины из неуправляемого образа](https://github.com/Azure/azure-quickstart-templates/tree/master/101-vm-from-user-image)

После создания виртуальных машин узла сеансов [Примените лицензию Windows к виртуальной машине узла сеансов](./apply-windows-license.md#apply-a-windows-license-to-a-session-host-vm) , чтобы запустить виртуальные машины Windows или Windows Server, не обращаясь к другой лицензии. 

## <a name="prepare-the-virtual-machines-for-windows-virtual-desktop-preview-agent-installations"></a>Подготовка виртуальных машин для установки агента предварительного просмотра виртуальных рабочих столов Windows

Чтобы подготовить виртуальные машины к установке агентов виртуальных рабочих столов Windows и зарегистрировать виртуальные машины в пуле узлов Windows, необходимо выполнить следующие действия.

- Необходимо присоединить компьютер к домену. Благодаря этому входящие пользователи виртуальных рабочих столов Windows будут сопоставлены с учетной записью Azure Active Directory с их учетной записью Active Directory и успешно разрешили доступ к виртуальной машине.
- Если виртуальная машина работает под управлением ОС Windows Server, необходимо установить роль узла удаленный рабочий стол сеансов (узлов сеансов удаленных рабочих столов). Роль «удаленные рабочие столы» позволяет агентам виртуальных рабочих столов Windows правильно устанавливаться.

Чтобы успешно присоединиться к домену, выполните следующие действия на каждой виртуальной машине.

1. [Подключитесь к виртуальной машине](https://docs.microsoft.com/azure/virtual-machines/windows/quick-create-portal#connect-to-virtual-machine) с помощью учетных данных, указанных при создании виртуальной машины.
2. На виртуальной машине откройте **Панель управления** и выберите пункт **система**.
3. Выберите **имя компьютера**, щелкните **изменить параметры**, а затем выберите **изменить...**
4. Выберите **домен** , а затем введите домен Active Directory в виртуальной сети.
5. Проверка подлинности с учетной записью домена, имеющей права на присоединение к домену компьютеров.

    >[!NOTE]
    > Если вы присоединяете виртуальные машины к среде доменных служб Active Directory (Azure AD DS), убедитесь, что пользователь, который присоединяется к домену, также является участником [группы администраторов AAD DC](../active-directory-domain-services/tutorial-create-instance.md#configure-an-administrative-group).

## <a name="register-the-virtual-machines-to-the-windows-virtual-desktop-preview-host-pool"></a>Зарегистрируйте виртуальные машины в пуле узлов предварительного просмотра виртуальных рабочих столов Windows

Регистрация виртуальных машин в пуле узлов виртуальных рабочих столов Windows выполняется так же просто, как установка агентов виртуальных рабочих столов Windows.

Чтобы зарегистрировать агенты виртуальных рабочих столов Windows, выполните следующие действия на каждой виртуальной машине:

1. [Подключитесь к виртуальной машине](https://docs.microsoft.com/azure/virtual-machines/windows/quick-create-portal#connect-to-virtual-machine) с помощью учетных данных, указанных при создании виртуальной машины.
2. Скачайте и установите агент виртуальных рабочих столов Windows.
   - Скачайте [Агент виртуальных рабочих столов Windows](https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrmXv).
   - Щелкните правой кнопкой мыши скачанный установщик, выберите пункт **Свойства**, выберите **разблокировать**, а затем нажмите кнопку **ОК**. Это позволит системе доверять установщику.
   - Запустите установщик. Когда установщик запросит у вас маркер регистрации, введите значение, полученное в командлете **Export-рдсрегистратионинфо** .
3. Скачайте и установите загрузчик агента виртуальных рабочих столов Windows.
   - Скачайте [загрузчик агента виртуальных рабочих столов Windows](https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrxrH).
   - Щелкните правой кнопкой мыши скачанный установщик, выберите пункт **Свойства**, выберите **разблокировать**, а затем нажмите кнопку **ОК**. Это позволит системе доверять установщику.
   - Запустите установщик.

>[!IMPORTANT]
>Чтобы усилить защиту среды Виртуального рабочего стола Windows в Azure, мы рекомендуем не открывать входящий порт 3389 для виртуальных машин. Виртуальный рабочий стол Windows не требует открытия входящего порта 3389, чтобы пользователи могли получить доступ к виртуальным машинам пула узла. Если вам все же нужно открыть порт 3389 для устранения неполадок, мы рекомендуем использовать[JIT-доступ к виртуальным машинам](https://docs.microsoft.com/azure/security-center/security-center-just-in-time).

## <a name="next-steps"></a>Следующие шаги

Теперь, когда пул узлов создан, его можно заполнить удаленными приложениями. Дополнительные сведения о том, как управлять приложениями в Виртуальном рабочем столе Windows см. в руководстве по управлению группами приложений.

> [!div class="nextstepaction"]
> [Управление группами приложений](./manage-app-groups.md)
