---
title: Создание пула клиентов и узлов в виртуальном рабочем столе Windows — Azure
description: Устранение проблем при настройке виртуальной машины клиента и узла сеансов в среде виртуальных рабочих столов Windows.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: troubleshooting
ms.date: 07/10/2019
ms.author: helohr
ms.openlocfilehash: 0e32c81f37a8b81511cd009dfddbcc546aee1797
ms.sourcegitcommit: b3bad696c2b776d018d9f06b6e27bffaa3c0d9c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/21/2019
ms.locfileid: "69876746"
---
# <a name="tenant-and-host-pool-creation"></a>Создание пула узлов и клиента

Используйте эту статью для устранения неполадок, возникающих при настройке виртуальных машин узла сеансов виртуальных рабочих столов Windows.

## <a name="provide-feedback"></a>Оставить отзыв

В период предоставления предварительной версии Виртуального рабочего стола Windows мы не принимаем запросы в службу поддержки. Посетите [техническое сообщество Виртуального рабочего стола Windows](https://techcommunity.microsoft.com/t5/Windows-Virtual-Desktop/bd-p/WindowsVirtualDesktop), чтобы обсудить службу "Виртуальный рабочий стол Windows" с группой разработчиков и активными членами сообщества.

## <a name="vms-are-not-joined-to-the-domain"></a>Виртуальные машины не присоединены к домену

Если возникли проблемы при присоединении виртуальных машин к домену, следуйте этим инструкциям.

- Присоедините виртуальную машину вручную, используя процесс [присоединение виртуальной машины Windows Server к управляемому домену](https://docs.microsoft.com/azure/active-directory-domain-services/Active-directory-ds-admin-guide-join-windows-vm-portal) или использование шаблона присоединение к [домену](https://azure.microsoft.com/resources/templates/201-vm-domain-join-existing/).
- Попробуйте проверить связь с доменным именем из командной строки на виртуальной машине.
- Изучите список сообщений об ошибках присоединение к домену в [статье Устранение неполадок при присоединении к домену](https://social.technet.microsoft.com/wiki/contents/articles/1935.troubleshooting-domain-join-error-messages.aspx).

### <a name="error-incorrect-credentials"></a>Ошибка: Неверные учетные данные

**Причина.** При вводе учетных данных в Azure Resource Manager исправления интерфейса шаблона произошла опечатка.

**Исправно** Выполните эти инструкции, чтобы исправить учетные данные.

1. Вручную добавьте виртуальные машины в домен.
2. Повторное развертывание после подтверждения учетных данных. См. раздел [Создание пула узлов с помощью PowerShell](https://docs.microsoft.com/azure/virtual-desktop/create-host-pools-powershell).
3. Присоединение виртуальных машин к домену с помощью шаблона с присоединением [существующей виртуальной машины Windows к домену AD](https://azure.microsoft.com/resources/templates/201-vm-domain-join-existing/).

### <a name="error-timeout-waiting-for-user-input"></a>Ошибка: Истекло время ожидания ввода данных пользователем

**Причина.** Учетная запись, используемая для завершения присоединение к домену, может иметь многофакторную проверку подлинности (MFA).

**Исправно** Выполните эти инструкции, чтобы завершить присоединение к домену.

1. Временно удалите MFA для учетной записи.
2. Используйте учетную запись службы.

### <a name="error-the-account-used-during-provisioning-doesnt-have-permissions-to-complete-the-operation"></a>Ошибка: Учетная запись, используемая во время подготовки, не имеет разрешений на завершение операции

**Причина.** Используемая учетная запись не имеет разрешений на присоединение виртуальных машин к домену из-за соответствия требованиям и нормативам.

**Исправно** Выполните эти инструкции.

1. Используйте учетную запись, которая является членом группы администраторов.
2. Предоставьте необходимые разрешения для используемой учетной записи.

### <a name="error-domain-name-doesnt-resolve"></a>Ошибка: Доменное имя не разрешается

**Причина 1**. Виртуальные машины находятся в группе ресурсов, которая не связана с виртуальной сетью (VNET), в которой находится домен.

**Исправление 1:** Создайте пиринг виртуальных сетей между ВИРТУАЛЬНОЙ сетью, в которой были подготовлены виртуальные машины, и ВИРТУАЛЬНОЙ сетью, в которой работает контроллер домена. См. раздел [Создание пиринга виртуальной сети — диспетчер ресурсов, различных подписок](https://docs.microsoft.com/azure/virtual-network/create-peering-different-subscriptions).

**Причина 2.** При использовании Аадсервице (ААДС) записи DNS не были заданы.

**Исправление 2:** Сведения о настройке доменных служб см. в разделе [Включение доменных служб Azure Active Directory](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-getting-started-dns).

## <a name="windows-virtual-desktop-agent-and-windows-virtual-desktop-boot-loader-are-not-installed"></a>Агент виртуальных рабочих столов Windows и загрузчик виртуальных рабочих столов Windows не установлены

Рекомендуемый способ инициализации виртуальных машин — использовать шаблон **пула узлов виртуальных рабочих столов Windows Azure Resource Manager Создание и инициализация** . Шаблон автоматически устанавливает агент виртуальных рабочих столов Windows и загрузчик агента виртуальных рабочих столов Windows.

Выполните эти инструкции, чтобы убедиться, что компоненты установлены и проверяют наличие сообщений об ошибках.

1. Проверьте, установлены ли два компонента, установив флажок программы**и компоненты**в **панели** > управления**программы** > . Если **Агент виртуальных рабочих столов Windows** и **загрузчик агента виртуальных рабочих столов Windows** не отображаются, они не будут установлены на виртуальной машине.
2. Откройте **проводник** и перейдите по адресу **к:\виндовс\темп\скриптлогс.лог**. Если файл отсутствует, он указывает на то, что PowerShell DSC, который установил два компонента, не удалось запустить в предоставленном контексте безопасности.
3. Если файл **к:\виндовс\темп\скриптлогс.лог** имеется, откройте его и проверьте наличие сообщений об ошибках.

### <a name="error-windows-virtual-desktop-agent-and-windows-virtual-desktop-agent-boot-loader-are-missing-cwindowstempscriptlogslog-is-also-missing"></a>Ошибка: Отсутствует загрузчик агента виртуальных рабочих столов Windows и агента виртуальных рабочих столов Windows. К:\виндовс\темп\скриптлогс.лог также отсутствует

**Причина 1**. Учетные данные, предоставленные во время ввода для шаблона Azure Resource Manager, неверны, или недостаточно разрешений.

**Исправление 1:** Вручную добавьте недостающие компоненты на виртуальные машины, используя [Создание пула узлов с помощью PowerShell](https://docs.microsoft.com/azure/virtual-desktop/create-host-pools-powershell).

**Причина 2.** PowerShell DSC удалось запустить и выполнить, но его не удалось выполнить, так как он не может войти в виртуальный рабочий стол Windows и получить необходимые сведения.

**Исправление 2:** Подтвердите элементы в следующем списке.

- Убедитесь, что у учетной записи нет MFA.
- Убедитесь, что имя клиента является точным, а клиент существует в виртуальном рабочем столе Windows.
- Убедитесь, что учетная запись имеет по крайней мере разрешения участника RDS.

### <a name="error-authentication-failed-error-in-cwindowstempscriptlogslog"></a>Ошибка: Сбой проверки подлинности, ошибка в К:\виндовс\темп\скриптлогс.лог

**Причина.** PowerShell DSC удалось выполнить, но не смог подключиться к виртуальному рабочему столу Windows.

**Исправно** Подтвердите элементы в следующем списке.

- Вручную Зарегистрируйте виртуальные машины в службе виртуальных рабочих столов Windows.
- Убедитесь, что учетная запись, используемая для подключения к виртуальному рабочему столу Windows, имеет разрешения на клиенте для создания пулов узлов.
- Подтверждение того, что у учетной записи нет MFA.

## <a name="windows-virtual-desktop-agent-is-not-registering-with-the-windows-virtual-desktop-service"></a>Агент виртуальных рабочих столов Windows не регистрируется в службе виртуальных рабочих столов Windows

При первой установке агента виртуальных рабочих столов Windows на виртуальных машинах узла сеансов (вручную либо с помощью шаблона Azure Resource Manager и PowerShell DSC) он предоставляет маркер регистрации. В следующем разделе рассматриваются проблемы, связанные с агентом виртуальных рабочих столов и маркером Windows.

### <a name="error-the-status-filed-in-get-rdssessionhost-cmdlet-shows-status-as-unavailable"></a>Ошибка: Состояние, зарегистрированное в командлете Get-Рдссессионхост, показывает состояние как недоступное

![Командлет Get-Рдссессионхост отображает состояние недоступно.](media/23b8e5f525bb4e24494ab7f159fa6b62.png)

**Причина.** Агент не может обновить себя до новой версии.

**Исправно** Выполните эти инструкции, чтобы вручную обновить агент.

1. Скачайте новую версию агента на виртуальной машине узла сеансов.
2. Запустите диспетчер задач, а затем на вкладке Служба закройте службу Рдажентбутлоадер.
3. Запустите установщик для новой версии агента виртуальных рабочих столов Windows.
4. При появлении запроса на ввод маркера регистрации удалите запись INVALID_TOKEN и нажмите кнопку "Далее" (новый маркер не требуется).
5. Завершите работу мастера установки.
6. Откройте диспетчер задач и запустите службу Рдажентбутлоадер.

## <a name="error--windows-virtual-desktop-agent-registry-entry-isregistered-shows-a-value-of-0"></a>Ошибка:  Запись реестра агента виртуальных рабочих столов Windows содержит значение 0

**Причина.** Срок действия маркера регистрации истек или он был создан со значением срока действия 999999.

**Исправно** Выполните эти инструкции, чтобы исправить ошибку реестра агента.

1. Если маркер регистрации уже существует, удалите его с помощью Remove-Рдсрегистратионинфо.
2. Создайте новый токен с помощью RDS-Неврегистратионинфо.
3. Убедитесь, что параметр-Експриатионхаурс имеет значение 72 (максимальное значение — 99999).

### <a name="error-windows-virtual-desktop-agent-isnt-reporting-a-heartbeat-when-running-get-rdssessionhost"></a>Ошибка: Агент виртуальных рабочих столов Windows не сообщает о пульсе при выполнении команды Get-Рдссессионхост.

**Причина 1**. Служба Рдажентбутлоадер остановлена.

**Исправление 1:** Запустите диспетчер задач и, если вкладка служба сообщает о остановленном состоянии службы Рдажентбутлоадер, запустите службу.

**Причина 2.** Порт 443 может быть закрыт.

**Исправление 2:** Выполните эти инструкции, чтобы открыть порт 443.

1. Убедитесь, что порт 443 открыт, загрузив средство PSPing из [Sysinternal Tools](https://docs.microsoft.com/sysinternals/downloads/psping).
2. Установите PSPing на виртуальной машине узла сеансов, где работает агент.
3. Откройте командную строку от имени администратора и выполните следующую команду:

    ```cmd
    psping rdbroker.wvdselfhost.microsoft.com:443
    ```

4. Убедитесь, что PSPing получил сведения от Рдброкер:

    ```
    PsPing v2.10 - PsPing - ping, latency, bandwidth measurement utility
    Copyright (C) 2012-2016 Mark Russinovich
    Sysinternals - www.sysinternals.com
    TCP connect to 13.77.160.237:443:
    5 iterations (warmup 1) ping test:
    Connecting to 13.77.160.237:443 (warmup): from 172.20.17.140:60649: 2.00ms
    Connecting to 13.77.160.237:443: from 172.20.17.140:60650: 3.83ms
    Connecting to 13.77.160.237:443: from 172.20.17.140:60652: 2.21ms
    Connecting to 13.77.160.237:443: from 172.20.17.140:60653: 2.14ms
    Connecting to 13.77.160.237:443: from 172.20.17.140:60654: 2.12ms
    TCP connect statistics for 13.77.160.237:443:
    Sent = 4, Received = 4, Lost = 0 (0% loss),
    Minimum = 2.12ms, Maximum = 3.83ms, Average = 2.58ms
    ```

## <a name="troubleshooting-issues-with-the-windows-virtual-desktop-side-by-side-stack"></a>Устранение проблем с параллельным стеком виртуальных рабочих столов Windows

Параллельный стек виртуальных рабочих столов Windows автоматически устанавливается вместе с Windows Server 2019. Используйте установщик Microsoft (MSI) для установки параллельного стека на Microsoft Windows Server 2016 или Windows Server 2012 R2. Для Microsoft Windows 10 стек параллельных виртуальных рабочих столов Windows включен с **енаблесксстаккрс. ps1**.

Существует три основных способа установки или включения параллельного стека на виртуальных машинах пула узлов сеансов.

- С помощью Azure Resource Manager **Создание и инициализация нового пула узлов виртуальных рабочих столов Windows**
- Включение и включение на главном образе
- Установлено или включено вручную на каждой виртуальной машине (или с расширениями/PowerShell)

Если у вас возникли проблемы с параллельным стеком виртуальных рабочих столов Windows, введите команду **квинста** в командной строке, чтобы убедиться, что параллельный стек установлен или включен.

Выходные данные **квинста** будут выводить **RDP-SxS** в выходных данных, если параллельный стек установлен и включен.

![Параллельный стек установлен или включен с квинста, указанным в выходных данных как RDP-SxS.](media/23b8e5f525bb4e24494ab7f159fa6b62.png)

Проверьте указанные ниже записи реестра и убедитесь, что их значения совпадают. Если разделы реестра отсутствуют или несовпадающие значения, следуйте инструкциям в статье [Создание пула узлов с помощью PowerShell](https://docs.microsoft.com/azure/virtual-desktop/create-host-pools-powershell) для повторной установки параллельного стека.

```registry
    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal
    Server\WinStations\rds-sxs\"fEnableWinstation":DWORD=1

    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal
    Server\ClusterSettings\"SessionDirectoryListener":rdp-sxs
```

### <a name="error-o_reverse_connect_stack_failure"></a>Ошибка: O_REVERSE_CONNECT_STACK_FAILURE

![Код ошибки O_REVERSE_CONNECT_STACK_FAILURE.](media/23b8e5f525bb4e24494ab7f159fa6b62.png)

**Причина.** Параллельный стек не установлен на виртуальной машине узла сеансов.

**Исправно** Выполните эти инструкции, чтобы установить параллельный стек на виртуальной машине узла сеансов.

1. Используйте протокол удаленного рабочего стола (RDP) для непосредственного перехода на виртуальную машину узла сеансов в качестве локального администратора.
2. Скачайте и импортируйте [модуль PowerShell для виртуальных рабочих столов Windows](https://docs.microsoft.com/powershell/windows-virtual-desktop/overview) , который будет использоваться в сеансе PowerShell, если вы этого еще не сделали.
3. Установите параллельный стек, используя [Создание пула узлов с помощью PowerShell](https://docs.microsoft.com/azure/virtual-desktop/create-host-pools-powershell).

## <a name="how-to-fix-a-windows-virtual-desktop-side-by-side-stack-that-malfunctions"></a>Как исправить стек параллельных виртуальных рабочих столов Windows, который работает неверно

Существуют известные обстоятельства, которые могут привести к сбою параллельного стека:

- Не следует правильный порядок действий, чтобы включить параллельный стек
- Автоматическое обновление на Расширенный универсальный диск Windows 10 (ЕВД)
- Отсутствует роль узла удаленный рабочий стол сеансов (узлов сеансов удаленных рабочих столов)
- Многократное выполнение енаблескссстаккрк. ps1
- Запуск енаблескссстаккрк. ps1 в учетной записи без прав локального администратора

Инструкции, приведенные в этом разделе, помогут вам удалить стек параллельных виртуальных рабочих столов Windows. После удаления параллельного стека перейдите к разделу "Регистрация виртуальной машины с помощью пула узлов виртуальных рабочих столов Windows" раздела [Создание пула узлов с помощью PowerShell](https://docs.microsoft.com/azure/virtual-desktop/create-host-pools-powershell) для повторной установки стека параллельных приложений.

Виртуальная машина, используемая для выполнения исправления, должна находиться в той же подсети и домене, что и ВИРТУАЛЬная машина с неисправностью параллельного стека.

Выполните следующие инструкции, чтобы выполнить исправление из той же подсети и домена:

1. Подключитесь к виртуальной машине с помощью стандартного протокол удаленного рабочего стола (RDP), откуда будет установлено исправление.
2. Скачайте PsExec из https://docs.microsoft.com/sysinternals/downloads/psexec.
3. Распакуйте скачанный файл.
4. Запустите командную строку от имени локального администратора.
5. Перейдите к папке, в которой была распакована программа PsExec.
6. В командной строке введите следующую команду:

    ```cmd
            psexec.exe \\<VMname> cmd
    ```

    >[!Note]
    >VMname — это имя компьютера виртуальной машины с неработающим стеком параллельной работы.

7. Примите условия лицензионного соглашения на использование программы PsExec, нажав кнопку согласиться.

    ![Снимок экрана лицензионного соглашения на использование программного обеспечения.](media/SoftwareLicenseTerms.png)

    >[!Note]
    >Это диалоговое окно будет отображаться только при первом запуске программы PsExec.

8. После открытия сеанса командной строки на виртуальной машине с неработающей параллельной стеком запустите квинста и убедитесь, что доступна запись с именем RDP-SxS. Если нет, параллельный стек отсутствует на виртуальной машине, поэтому эта ошибка не связана с параллельным стеком.

    ![Командная строка администратора](media/AdministratorCommandPrompt.png)

9. Выполните следующую команду, которая выводит список компонентов Майкрософт, установленных на виртуальной машине, с неработающей параллельной стеком.

    ```cmd
        wmic product get name
    ```

10. Выполните приведенную ниже команду с именами продуктов из предыдущего шага.

    ```cmd
        wmic product where name="<Remote Desktop Services Infrastructure Agent>" call uninstall
    ```

11. Удалите все продукты, начинающиеся с "удаленный рабочий стол".

12. После удаления всех компонентов виртуальных рабочих столов Windows следуйте инструкциям для своей операционной системы.

13. Если операционной системой является Windows Server, перезапустите виртуальную машину с неработающей параллельной стеком (с портал Azure или с помощью средства PsExec).

Если ваша операционная система — Microsoft Windows 10, следуйте приведенным ниже инструкциям.

14. На виртуальной машине, где работает PsExec, откройте проводник и скопируйте файл дисаблескссстаккрк. ps1 на системный диск виртуальной машины с неработающей параллельной стеком.

    ```cmd
        \\<VMname>\c$\
    ```

    >[!NOTE]
    >VMname — это имя компьютера виртуальной машины с неработающим стеком параллельной работы.

15. Рекомендуемый процесс: в средстве PsExec запустите PowerShell и перейдите к папке из предыдущего шага и запустите дисаблескссстаккрк. ps1. Кроме того, можно выполнить следующие командлеты:

    ```PowerShell
    Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\ClusterSettings" -Name "SessionDirectoryListener" -Force
    Remove-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\rdp-sxs" -Recurse -Force
    Remove-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations" -Name "ReverseConnectionListener" -Force
    ```

16. После выполнения командлетов перезапустите виртуальную машину с неработающей параллельной стеком.

## <a name="remote-licensing-model-is-not-configured"></a>Модель удаленного лицензирования не настроена

При входе в многосеансовый режим Windows 10 Enterprise с помощью учетной записи администратора может появиться уведомление о том, что удаленный рабочий стол режима лицензирования не настроен, службы удаленных рабочих столов перестанет работать в течение X дней. На сервере посредника подключений используйте диспетчер сервера, чтобы указать режим лицензирования удаленный рабочий стол». Если вы видите это сообщение, это означает, что необходимо вручную настроить режим лицензирования " **на пользователя**".

Чтобы вручную настроить режим лицензирования, выполните следующие действия.  

1. Перейдите в поле поиска **меню "Пуск** ", а затем найдите и откройте **gpedit. msc** для доступа к локальному редактору групповая политика. 
2. Последовательно выберите **Конфигурация** > компьютера**Административные шаблоны** > **компоненты Windows службы удаленных рабочих столов**удаленный рабочий столУзелсеансов. >  >  >  **Лицензирование**. 
3. Выберите **задать режим лицензирования удаленный рабочий стол** и измените его на " **на пользователя**".

В настоящее время мы ищем проблемы с уведомлением и льготным периодом и планируем устранить их в будущем обновлении. 

## <a name="next-steps"></a>Следующие шаги

- Общие сведения об устранении неполадок с виртуальным рабочим столом Windows и сведениями о эскалации см. в разделе [Обзор устранения неполадок, обратная связь и поддержка](troubleshoot-set-up-overview.md).
- Сведения об устранении неполадок при создании клиента и пула узлов в среде виртуальных рабочих столов Windows см. в статье [Создание пула клиентов и узлов](troubleshoot-set-up-issues.md).
- Сведения об устранении неполадок при настройке виртуальной машины в виртуальном рабочем столе Windows см. в разделе [Конфигурация виртуальной машины узла сеанса](troubleshoot-vm-configuration.md).
- Сведения об устранении неполадок клиентских подключений Windows к виртуальным рабочим столам см. в разделе [Удаленный рабочий стол клиентские подключения](troubleshoot-client-connection.md).
- Сведения об устранении неполадок при использовании PowerShell с виртуальным рабочим столом Windows см. в статье [Windows Virtual Desktop PowerShell](troubleshoot-powershell.md).
- Дополнительные сведения о службе предварительной версии см. в разделе [Среда предварительной версии виртуальных рабочих столов Windows](https://docs.microsoft.com/azure/virtual-desktop/environment-setup).
- Сведения об устранении неполадок см. в статье [Tutorial: Устранение неполадок при](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-tutorial-troubleshoot)развертывании шаблонов диспетчер ресурсов.
- Сведения о действиях аудита см. в статье [Операции аудита с помощью Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-audit).
- Дополнительные сведения об определении ошибок во время развертывания см. в статье [Просмотр операций развертывания с помощью портала Azure](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-deployment-operations).