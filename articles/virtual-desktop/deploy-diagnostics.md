---
title: Развертывание инструмента диагностики для виртуального рабочего стола Windows - Azure
description: Как развернуть инструмент диагностики UX для Windows Virtual Desktop.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 03/20/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: 4eb63fe4bd8f8a8b0961aa6a7fccb8de9b7c2f16
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80123408"
---
# <a name="deploy-the-diagnostics-tool"></a>Развертывание средства диагностики

>[!IMPORTANT]
>По состоянию на 16 марта 2020 года мы временно отключили диагностические запросы, которые повлияли на взаимодействие пользователей из-за повышенного спроса на услуги. Это приведет к тому, что инструмент перестанет работать, поскольку он опирается на эти запросы для работы. Мы обновим эту статью, когда диагностические запросы будут доступны снова.
>
>До тех пор мы настоятельно рекомендуем вам [использовать Log Analytics](diagnostics-log-analytics.md) для постоянного мониторинга.

Вот что может сделать для вас инструмент диагностики для Windows Virtual Desktop:

- Ищите диагностические действия (управление, подключение или канал) для одного пользователя в течение одной недели.
- Соберите информацию о хосте сеанса для действий по подключению из рабочего пространства Log Analytics.
- Просмотрите детали производительности виртуальной машины (VM) для конкретного узла.
- Узнайте, какие пользователи входят в число хостов сеансов.
- Отправить сообщение активным пользователям на определенном хосте сеанса.
- Подпишите пользователей из хоста сеанса.

## <a name="prerequisites"></a>Предварительные требования

Для развертывания шаблона управления ресурсами Azure Для этого необходимо создать регистрацию приложений Active Directory Ис azure и рабочее пространство для анализа журналов. Для этого вам или администратору необходимы следующие разрешения:

- Владелец подписки Azure
- Разрешение на создание ресурсов в подписке Azure
- Разрешение на создание приложения Azure AD
- Права владельца или вкладчика RDS

Вам также нужно установить эти два модуля PowerShell, прежде чем приступить к работе:

- [модуль Azure PowerShell;](/powershell/azure/install-az-ps?view=azps-2.4.0/)
- [Модуль Azure AD](/powershell/azure/active-directory/install-adv2?view=azureadps-2.0/)

Убедитесь, что при вхводом в систему идентификатор подписки будет готов.

После того, как у вас все в порядке, вы можете создать регистрацию приложения Azure AD.

## <a name="create-an-azure-active-directory-app-registration"></a>Создание регистрации приложения Active Directory Azure

В этом разделе будет уотена возможность использования PowerShell для создания приложения Active Directory Azure с принципом службы и получения разрешений API на него.

>[!NOTE]
>Разрешения API: В приложение Active Directory Application добавлены разрешения API Windows Virtual Desktop, Log Analytics и Microsoft Graph API.

1. Откройте PowerShell от имени администратора.
2. Вопийте в Azure с учетной записью с разрешениями владельца или участника в подписке Azure, которую вы хотели бы использовать для инструмента диагностики:
   ```powershell
   Login-AzAccount
   ```
3. Войти на Azure AD с той же учетной записью:
   ```powershell
   Connect-AzureAD
   ```
4. Перейдите на [РЕпо RDS-Templates GitHub](https://github.com/Azure/RDS-Templates/tree/master/wvd-templates/diagnostics-sample/deploy/scripts) и запустите скрипт **CreateADAppRegistrationforDiagnostics.ps1** в PowerShell.
5.  Когда скрипт попросит вас назвать ваше приложение, введите уникальное имя приложения.


После успешного выполнения сценария, он должен показать следующие вещи в своем выходе:

-  Сообщение, подтверждая, что ваше приложение теперь имеет основное назначение ролей службы.
-  Ваш идентификатор клиента и секретный ключ клиента, который вам понадобится при развертывании инструмента диагностики.

Теперь, когда вы зарегистрировали приложение, пришло время настроить рабочее пространство Log Analytics.

## <a name="configure-your-log-analytics-workspace"></a>Настройка рабочего пространства анализа журналов

Для наилучшего опыта мы рекомендуем настроить рабочее пространство Log Analytics со следующими счетчиками производительности, которые позволяют получать операторы пользовательского опыта в удаленном сеансе. Для списка рекомендуемых счетчиков с предлагаемыми пороговыми значениями [см.](deploy-diagnostics.md#windows-performance-counter-thresholds)

### <a name="create-an-azure-log-analytics-workspace-using-powershell"></a>Создание рабочего пространства анализа журналов Azure с помощью PowerShell

Вы можете запустить скрипт PowerShell для создания рабочего пространства Log Analytics и настройки рекомендуемых счетчиков производительности Windows для мониторинга работы пользователей и производительности приложения.

>[!NOTE]
>Если у вас уже есть существующее рабочее пространство Log Analytics, которое вы сделали без скрипта PowerShell, которое вы хотите использовать, пройдите вперед, чтобы [проверить результаты скрипта на портале Azure.](#validate-the-script-results-in-the-azure-portal)

Для запуска сценария PowerShell:

1.  Откройте PowerShell от имени администратора.
2.  Перейдите на [репо RDS-Templates GitHub](https://github.com/Azure/RDS-Templates/tree/master/wvd-templates/diagnostics-sample/deploy/scripts) и запустите скрипт **CreateLogAnalyticsWorkforDiagnostics.ps1** в PowerShell.
3. Введите следующие значения параметров.

    - Для **ResourceGroupName**введите имя группы ресурсов.
    - Для **LogAnalyticsWorkspaceName**введите уникальное имя для рабочего пространства Log Analytics.
    - Для **определения местоположения**введите область Azure, используемую вами.
    - Введите **идентификатор подписки Azure,** который можно найти на портале Azure по **подписке.**

4. Введите учетные данные пользователя с делегированным доступом к амин.
5. Вопиюсь на портал Azure с учетными данными того же пользователя.
6. Запишите или запомните идентификатор LogAnalyticsWorkspace на более поздний срок.
7. Если вы настроили рабочее пространство Log Analytics со скриптом PowerShell, то счетчики производительности уже должны быть настроены, и вы можете пропустить проверку [результатов скрипта на портале Azure.](#validate-the-script-results-in-the-azure-portal) В противном случае, продолжить в следующем разделе.

### <a name="configure-windows-performance-counters-in-your-existing-log-analytics-workspace"></a>Настройка счетчиков производительности Windows в существующем рабочем пространстве Log Analytics

Этот раздел предназначен для пользователей, которые хотят использовать существующее рабочее пространство Analytics azure Log Analytics, созданное без сценария PowerShell в предыдущем разделе. Если вы не использовали скрипт, необходимо настроить рекомендуемые счетчики производительности Windows вручную.

Вот как вручную настроить рекомендуемые счетчики производительности:

1. Откройте свой интернет-браузер и вопийте на [портал Azure](https://portal.azure.com/) с помощью административной учетной записи.
2. Далее перейдите в **рабочие области log Analytics** для просмотра настроенных счетчиков производительности Windows.
3. В разделе **Настройки** выберите **Расширенные настройки.**
4. После этого перейдите на**счетчики производительности** **Windows и** > добавьте следующие счетчики:

    -   LogicalDisk\*()\\%Свободное пространство
    -   LogicalDisk (C:)\\Avg. Длина очереди диска
    -   \*Память()\\Доступные Мбайты
    -   Информация\*об\\процессоре () Время процессора
    -   Задержка ввода пользователя\*за\\сеанс () Задержка ввода Max

Узнайте больше о счетчиках производительности в [источниках данных о производительности Windows и Linux в Azure Monitor.](/azure/azure-monitor/platform/data-sources-performance-counters)

>[!NOTE]
>Любые дополнительные счетчики, которые вы настраиваете, не будут отображаться в самом инструменте диагностики. Чтобы он появился в инструменте диагностики, необходимо настроить файл конфигурации инструмента. Инструкции о том, как это сделать с расширенной администрации будут доступны в GitHub на более поздний срок.

## <a name="validate-the-script-results-in-the-azure-portal"></a>Проверка результатов скрипта на портале Azure

Прежде чем продолжить развертывание инструмента диагностики, мы рекомендуем вам убедиться, что приложение Azure Active Directory имеет разрешения API, а в рабочем пространстве Log Analytics есть предварительно настроенные счетчики производительности Windows.

### <a name="review-your-app-registration"></a>Просмотрите регистрацию приложения

Чтобы убедиться, что регистрация приложения имеет разрешения API:

1. Откройте браузер и подключитесь к [порталу Azure](https://portal.azure.com/) с помощью административной учетной записи.
2. Перейдите в **Azure Active Directory**.
3. Перейти к **регистрации приложений** и выбрать **все приложения**.
4. Ищите регистрацию приложения Azure AD с тем же именем приложения, которое вы ввели в шаг5 [регистрации приложения Active Directory.](deploy-diagnostics.md#create-an-azure-active-directory-app-registration)

### <a name="review-your-log-analytics-workspace"></a>Просмотрите рабочее пространство аналитики журналов

Чтобы убедиться, что в рабочем пространстве Log Analytics есть предварительно настроенные счетчики производительности Windows:

1. На [портале Azure](https://portal.azure.com/)перейдите в **рабочие области log Analytics** для просмотра настроенных счетчиков производительности Windows.
2. В **настройках**выберите **Расширенные настройки.**
3. После этого перейдите на **счетчики** > **производительности Windows.**
4. Убедитесь, что следующие счетчики настроены:

   - LogicalDisk\*()\\% Свободное пространство: Отображает количество свободного пространства общего пространства, пригодного для уплаты на диске, в процентах.
   - LogicalDisk (C:)\\Avg. Длина очереди диска: Длина запроса на передачу диска для вашего C-нада. Значение не должно превышать 2 в течение более короткого периода времени.
   - Память\*()\\Доступные Мбайты: Доступная память для системы в мегабайтах.
   - Информация\*об\\процессоре () Время процессора: процент прошедшего времени, затраченного процессором на выполнение непростае поток.
   - Задержка ввода пользователя\*за\\сеанс () Задержка ввода Max

### <a name="connect-to-vms-in-your-log-analytics-workspace"></a>Подключение к вм-чата в рабочей области Analytics журнала

Для просмотра работоспособности вс-чатов необходимо включить подключение к журналу Analytics. Выполните следующие действия, чтобы подключить ваши vMs:

1. Откройте браузер и вопийте на [портал Azure](https://portal.azure.com/) с помощью административной учетной записи.
2. Перейдите в рабочее пространство аналитики журнала.
3. В левой панели, под workspace Data Sources, выберите **виртуальные машины.**
4. Выберите имя VM, к которому вы хотите подключиться.
5. Выберите **Подключиться**.

## <a name="deploy-the-diagnostics-tool"></a>Развертывание средства диагностики

Развертывание шаблона управления ресурсами Azure для инструмента диагностики:

1.  Перейдите на [страницу GitHub Azure RDS-Templates](https://github.com/Azure/RDS-Templates/tree/master/wvd-templates/diagnostics-sample/deploy).
2.  Развернуть шаблон в Azure и следовать инструкциям в шаблоне. Убедитесь, что у вас есть следующая информация:

    -   Клиент-Id
    -   Клиент-секрет
    -   идентификатор рабочей области Log Analytics;

3.  После того, как параметры ввода предоставляются, примите условия и условия, а затем выберите **Покупка.**

Развертывание займет 2-3 минуты. После успешного развертывания перейдите в группу ресурсов и убедитесь, что веб-приложение и ресурсы плана обслуживания приложений есть.

После этого необходимо установить redirect URI.

### <a name="set-the-redirect-uri"></a>Установите перенаправление URI

Чтобы установить перенаправление URI:

1.  На [портале Azure](https://portal.azure.com/)перейдите в **службы приложений** и найдите созданное приложение.
2.  Перейдите на страницу обзора и скопируйте URL-адрес, который вы найдете там.
3.  Перейдите к **регистрации приложений** и выберите приложение, развертывание которых необходимо развернуть.
4.  В левой панели, под разделом Управления, выберите **аутентификацию.**
5.  Введите желаемое перенаправление URI в текстовый ящик **Redirect URI,** а затем выберите **Сохранить** в верхнем левом углу меню.
6. Выберите **Web** в меню выпадения вниз под типом.
7. Введите URL со страницы обзора приложения и добавьте **/security/signin-callback** до конца. Например: `https://<yourappname>.azurewebsites.net/security/signin-callback`.

   ![Перенаправление страницы URI](media/redirect-uri-page.png)

8. Теперь перейдите на ресурсы Azure, выберите ресурс Службы приложений Azure с именем, которое вы предоставили в шаблоне, и перейдите к URL-адресу, связанному с ним. (Например, если имя приложения, которое `contosoapp45`вы использовали в <https://contosoapp45.azurewebsites.net>шаблоне, было, то ваш связанный URL является).
9. Войдите в систему с помощью соответствующей учетной записи пользователя Azure Active Directory.
10.   Нажмите кнопку **Принять**.

## <a name="distribute-the-diagnostics-tool"></a>Распространение инструмента диагностики

Прежде чем сделать инструмент диагностики доступным для пользователей, убедитесь, что у них есть следующие разрешения:

- Пользователям нужен доступ к считыванию для анализа журналов. Для получения дополнительной информации см. [Get started с ролями, разрешениями и безопасностью с помощью Azure Monitor.](/azure/azure-monitor/platform/roles-permissions-security)
-  Пользователям также необходим доступ к считыванию для арендатора Windows Virtual Desktop (роль читателя RDS). Для получения дополнительной информации смотрите [Делегированный доступ в Windows Virtual Desktop](delegated-access-virtual-desktop.md).

Вы также должны предоставить пользователям следующую информацию:

- URL-адрес приложения
- Имена группы арендаторов отдельных арендаторов они могут получить доступ.

## <a name="use-the-diagnostics-tool"></a>Использование средства диагностики

После того, как вы зарегистрировались в своей учетной записи, используя информацию, полученную от организации, подготовьте UPN для пользователя, для запроса деятельности. Поиск даст вам все действия в соответствии с указанным типом активности, который произошел в течение последней недели.

### <a name="how-to-read-activity-search-results"></a>Как прочитать результаты поиска активности

Действия сортируются по метке времени, причем последняя деятельность в первую очередь. Если результаты возвращают ошибку, сначала проверьте, является ли это ошибкой службы. Для ошибок службы создайте билет поддержки с информацией о действиях, чтобы помочь нам отладить проблему. Все остальные типы ошибок обычно могут быть решены пользователем или администратором. Список наиболее распространенных сценариев ошибок и способы их [устранения см.](diagnostics-role-service.md#common-error-scenarios)

>[!NOTE]
>Ошибки службы в связанной документации называются «внешними ошибками». Это будет изменено при обновлении ссылки PowerShell.

Действия подключения могут иметь несколько ошибок. Вы можете расширить тип активности, чтобы увидеть любые другие ошибки, с которые пользователь сталкивался. Выберите название кода ошибки, чтобы открыть диалог, чтобы увидеть больше информации о нем.

### <a name="investigate-the-session-host"></a>Исследуйте хост сеанса 

В результатах поиска найдите и выберите хост сеанса, о которых вы хотите получить информацию.

Вы можете проанализировать здоровье хозяина сеанса:

- На основе заданного порога можно получить информацию о состоянии здоровья хоста сеанса, которую запрашивает журнал Analytics.
- Если нет активности или хост сеанса не подключен к журналу Analytics, информация будет недоступна.

Вы также можете взаимодействовать с пользователями на хосте сеанса:

- Вы можете зарегистрироваться или отправить сообщение подписным пользователям.
- Пользователь, который вы первоначально искали, выбран по умолчанию, но вы также можете выбрать дополнительных пользователей для отправки сообщений или регистрации нескольких пользователей одновременно.

### <a name="windows-performance-counter-thresholds"></a>Пороговые значения счетчика производительности Windows

- LogicalDisk\*()\\%Свободное пространство:

    - Отображает процент от общего пространства, применяемого к удочку, на свободном логическом диске.
    - Порог: Менее 20% помеченкак нездоровым.

- LogicalDisk (C:)\\Avg. Длина очереди диска:

    - Представляет условия системы хранения данных.
    - Порог: Выше 5 помечен как неработоспособный.

- \*Память()\\Доступные Мбайты:

    - Доступная память для системы.
    - Порог: Менее 500 мегабайт помечены как нездоровые.

- Информация\*об\\процессоре () Время процессора:

    - Порог: Более 80% помечено как неработоспособное.

- [Задержка ввода пользователя\*за\\сеанс() Максимальная задержка ввода:](/windows-server/remote/remote-desktop-services/rds-rdsh-performance-counters/)

    - Порог: Выше 2000 мс помечен как нездоровый.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как отслеживать журналы активности при [диагностике Use с помощью log Analytics.](diagnostics-log-analytics.md)
- Читайте о распространенных сценариях ошибок и о том, как их устранить при [выявлении и диагностике проблем.](diagnostics-role-service.md)
