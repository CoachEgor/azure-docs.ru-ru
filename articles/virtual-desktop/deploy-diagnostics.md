---
title: Развертывание средства диагностики для виртуальных рабочих столов Windows в Azure
description: Развертывание средства диагностики для виртуальных рабочих столов Windows.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 08/14/2019
ms.author: helohr
ms.openlocfilehash: 07a45f54eb7c00e20abcfb05979e24493e5b9604
ms.sourcegitcommit: 5f0f1accf4b03629fcb5a371d9355a99d54c5a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/30/2019
ms.locfileid: "71676656"
---
# <a name="deploy-the-diagnostics-tool"></a>Развертывание средства диагностики

Вот что может сделать средство диагностики для виртуальных рабочих столов Windows:

- Поиск диагностических действий (управление, подключение или веб-канал) для одного пользователя в течение одной недели.
- Сбор сведений об узле сеанса для действий подключения из рабочей области Log Analytics.
- Проверьте сведения о производительности для определенного узла в виртуальной машине.
- Узнайте, какие пользователи вошли в узел сеансов.
- Отправка сообщения активным пользователям на определенном узле сеансов.
- Подписывать пользователей из узла сеансов.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем можно будет развернуть шаблон Azure Resource Manager для средства, необходимо создать регистрацию приложения Azure Active Directory и рабочую область Log Analytics. Для этого вам или администратору требуются следующие разрешения:

- Владелец подписки Azure
- Разрешение на создание ресурсов в подписке Azure
- Разрешение на создание приложения Azure AD
- Права владельца или участника RDS

Кроме того, перед началом работы необходимо установить эти два модуля PowerShell:

- [Overview of Azure PowerShell](https://docs.microsoft.com/powershell/azure/install-az-ps?view=azps-2.4.0) (Общие сведения об Azure PowerShell)
- [Модуль Azure AD](https://docs.microsoft.com/powershell/azure/active-directory/install-adv2?view=azureadps-2.0)

Убедитесь, что ваш идентификатор подписки готов для входа в систему.

Когда все будет готово, вы можете создать регистрацию приложения Azure AD.

## <a name="create-an-azure-active-directory-app-registration"></a>Создание регистрации приложения Azure Active Directory

В этом разделе показано, как с помощью PowerShell создать приложение Azure Active Directory с субъектом-службой и получить для него разрешения API.

>[!NOTE]
>Разрешения API представляют собой виртуальные рабочие столы Windows, Log Analytics и Microsoft Graph разрешения API добавляются в приложение Azure Active Directory.

1. Откройте PowerShell с правами администратора.
2. Перейдите в [репозиторий GitHub RDS-Templates](https://github.com/Azure/RDS-Templates/tree/master/wvd-templates/diagnostics-sample/deploy/scripts) и запустите сценарий " **Создание регистрации приложения AD для диагностики. ps1** " в PowerShell.
3.  Когда сценарий запросит имя приложения, введите уникальное имя приложения.
4.  После этого скрипт попросит вас войти с помощью учетной записи администратора. Введите учетные данные пользователя с [делегированным административным доступом](delegated-access-virtual-desktop.md). Администратор должен иметь права владельца или участника RDS.

После успешного выполнения скрипта в выходных данных должны отобразиться следующие элементы:

-  Сообщение, которое подтверждает, что приложение теперь имеет назначение роли субъекта-службы.
-  Идентификатор клиента печати и секретный ключ клиента, которые понадобятся при развертывании средства диагностики.

Теперь, когда приложение зарегистрировано, пришло время настроить рабочую область Log Analytics.

## <a name="configure-your-log-analytics-workspace"></a>Настройка рабочей области Log Analytics

Для достижения наилучшего опыта рекомендуется настроить рабочую область Log Analytics со следующими счетчиками производительности, которые позволяют получить инструкции взаимодействия с пользователем в удаленном сеансе. Список рекомендуемых счетчиков с рекомендуемыми пороговыми значениями см. в разделе [пороговые значения счетчика производительности Windows](deploy-diagnostics.md#windows-performance-counter-thresholds).

### <a name="create-an-azure-log-analytics-workspace-using-powershell"></a>Создание рабочей области Azure Log Analytics с помощью PowerShell

Вы можете запустить сценарий PowerShell для создания Log Analytics рабочей области и настроить рекомендуемые счетчики производительности Windows, чтобы отслеживать взаимодействие с пользователем и производительность приложения.

>[!NOTE]
>Если у вас уже есть созданная Рабочая область Log Analytics без сценария PowerShell, которую вы хотите использовать, пропустите процедуру [проверки результатов скрипта в портал Azure](#validate-the-script-results-in-the-azure-portal).

Чтобы запустить сценарий PowerShell, выполните следующие действия.

1.  Откройте PowerShell с правами администратора.
2.  Перейдите в [репозиторий GitHub RDS-Templates](https://github.com/Azure/RDS-Templates/tree/master/wvd-templates/diagnostics-sample/deploy/scripts) и выполните сценарий **CREATE логаналитиксворкспаце для Diagnostics. ps1** в PowerShell.
3. Введите следующие значения параметров.

    - В поле **ResourceGroupName**введите имя группы ресурсов.
    - В качестве **LogAnalyticsWorkspaceName**введите уникальное имя для рабочей области log Analytics.
    - В поле **Расположение**введите регион Azure, который вы используете.
    - Введите **идентификатор подписки Azure**, который можно найти в портал Azure в разделе **подписки**.

4. Введите учетные данные пользователя с делегированным административным доступом.
5. Войдите в портал Azure с учетными данными того же пользователя.
6. Запишите или запомните идентификатор Логаналитиксворкспаце для последующего использования.
7. Если вы настроили рабочую область Log Analytics с помощью скрипта PowerShell, то счетчики производительности уже должны быть настроены и вы можете пропустить [проверку результатов скрипта в портал Azure](#validate-the-script-results-in-the-azure-portal). В противном случае перейдите к следующему разделу.

### <a name="configure-windows-performance-counters-in-your-existing-log-analytics-workspace"></a>Настройка счетчиков производительности Windows в существующей рабочей области Log Analytics

Этот раздел предназначен для пользователей, желающих использовать существующую рабочую область Azure Log Analytics, созданную без сценария PowerShell, в предыдущем разделе. Если сценарий не использовался, необходимо вручную настроить рекомендованные счетчики производительности Windows.

Ниже описана настройка рекомендуемых счетчиков производительности вручную.

1. Откройте веб браузер и войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи администратора.
2. Затем перейдите в раздел **log Analytics рабочие области** , чтобы проверить настроенные счетчики производительности Windows.
3. В разделе **Параметры** выберите **Дополнительные параметры**.
4. После этого перейдите в раздел **Data** > **счетчики производительности Windows** и добавьте следующие счетчики:

    -   Логический диск (\*) \|% свободного места
    -   Логический диск (C:) @no__t 0Avg. Длина очереди диска
    -   Память (\*) \\Available МБ
    -   Сведения о процессоре (\*) @no__t 1Processor Time
    -   Задержка ввода данных пользователем на сеанс (\*) \\Max входная задержка

Дополнительные сведения о счетчиках производительности в [источниках данных производительности Windows и Linux см. в Azure Monitor](/azure/azure-monitor/platform/data-sources-performance-counters).

>[!NOTE]
>Все дополнительные счетчики, которые вы настраиваете, не отображаются в средстве диагностики. Чтобы сделать его отображаемым в средстве диагностики, необходимо настроить файл конфигурации этого средства. Инструкции по выполнению этого действия с расширенным администрированием будут доступны в GitHub позже.

## <a name="validate-the-script-results-in-the-azure-portal"></a>Проверка результатов скрипта в портал Azure

Прежде чем продолжить развертывание средства диагностики, рекомендуется убедиться, что у приложения Azure Active Directory есть разрешения API, а в рабочей области Log Analytics есть предварительно настроенные счетчики производительности Windows.

### <a name="review-your-app-registration"></a>Проверка регистрации приложения

Чтобы убедиться, что регистрация приложения имеет разрешения API:

1. Откройте браузер и подключитесь к [портал Azure](https://portal.azure.com/) с помощью учетной записи администратора.
2. Перейдите в **Регистрация приложений** и найдите регистрацию Azure AD App.

      ![Страница разрешений API.](media/api-permissions-page.png)


### <a name="review-your-log-analytics-workspace"></a>Проверка рабочей области Log Analytics

Чтобы убедиться, что в рабочей области Log Analytics есть предварительно настроенные счетчики производительности Windows:

1. В [портал Azure](https://portal.azure.com/)перейдите в раздел **log Analytics рабочие области** , чтобы проверить настроенные счетчики производительности Windows.
2. В разделе **Параметры**выберите **Дополнительные параметры**.
3. После этого перейдите в раздел **Data** > **счетчики производительности Windows**.
4. Убедитесь, что следующие счетчики предварительно настроены:

   - Логический диск (\*) \|% свободного места: Отображает объем свободного пространства общего свободного места на диске в процентах.
   - Логический диск (C:) @no__t 0Avg. Длина очереди диска: Длина запроса на перемещение диска с диска C. Значение не должно превышать 2 в течение короткого периода времени.
   - Память (\*) \\Available МБ: Объем доступной памяти для системы в мегабайтах.
   - Сведения о процессоре (\*) \\Processor времени: процент времени, затраченного процессором на выполнение потока, не являющегося бездействующим.
   - Задержка ввода данных пользователем на сеанс (\*) \\Max входная задержка

### <a name="connect-to-vms-in-your-log-analytics-workspace"></a>Подключение к виртуальным машинам в рабочей области Log Analytics

Чтобы иметь возможность просматривать работоспособность виртуальных машин, необходимо включить подключение Log Analytics. Чтобы подключить виртуальные машины, выполните следующие действия.

1. Откройте браузер и войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи администратора.
2. Перейдите в рабочую область Log Analytics.
3. На левой панели в разделе источники данных рабочей области выберите **виртуальные машины**.
4. Выберите имя виртуальной машины, к которой необходимо подключиться.
5. Нажмите кнопку **Подключиться**.

## <a name="deploy-the-diagnostics-tool"></a>Развертывание средства диагностики

Чтобы развернуть шаблон управления ресурсами Azure для средства диагностики, выполните следующие действия.

1.  Перейдите на [страницу Azure RDS-Templates в GitHub](https://github.com/Azure/RDS-Templates/tree/master/wvd-templates/diagnostics-sample/deploy).
2.  Разверните шаблон в Azure и следуйте инструкциям в шаблоне. Убедитесь, что доступны следующие сведения:

    -   Идентификатор клиента
    -   Секрет клиента
    -   идентификатор рабочей области Log Analytics;

3.  После ввода входных параметров примите условия, а затем выберите **приобрести**.

Развертывание займет 2 – 3 минуты. После успешного развертывания перейдите в группу ресурсов и убедитесь в наличии ресурсов веб-приложения и плана службы приложений.

После этого необходимо задать URI перенаправления.

### <a name="set-the-redirect-uri"></a>Задание URI перенаправления

Чтобы задать URI перенаправления, сделайте следующее:

1.  В [портал Azure](https://portal.azure.com/)перейдите в раздел **службы приложений** и найдите созданное приложение.
2.  Перейдите на страницу обзора и скопируйте URL-адрес, который там находится.
3.  Перейдите к разделу **Регистрация приложений** и выберите приложение, которое требуется развернуть.
4.  На левой панели в разделе Управление выберите **Проверка подлинности**.
5.  Введите нужный URI перенаправления в текстовое поле **URI перенаправления** , а затем выберите **сохранить** в левом верхнем углу меню.
6. Выберите **веб-сайт** в раскрывающемся меню в разделе тип.
7. Введите URL-адрес на странице обзора приложения и добавьте **/секурити/сигнин-каллбакк** в конец. Например, `https://<yourappname>.azurewebsites.net/security/signin-callback`.

   ![Страница URI перенаправления](media/redirect-uri-page.png)

8. Теперь перейдите к ресурсам Azure, выберите ресурс служб приложений Azure с именем, указанным в шаблоне, и перейдите по URL-адресу, связанному с ним. (Например, если имя приложения, использованное в шаблоне, было `contosoapp45`, то связанный URL-адрес будет <https://contosoapp45.azurewebsites.net>).
9. Войдите в систему с помощью соответствующей учетной записи пользователя Azure Active Directory.
10.   Нажмите кнопку **Принять**.

## <a name="distribute-the-diagnostics-tool"></a>Распространение средства диагностики

Прежде чем сделать средство диагностики доступным для пользователей, убедитесь, что у них есть следующие разрешения:

- Пользователям требуется доступ на чтение для log Analytics. Дополнительные сведения см. в статье [Приступая к работе с ролями, разрешениями и безопасностью с помощью Azure Monitor](/articles/azure-monitor/platform/roles-permissions-security.md).
-  Пользователям также требуется доступ на чтение для клиента виртуальных рабочих столов Windows (роль RDS Reader). Дополнительные сведения см. [в статье делегированный доступ в виртуальном рабочем столе Windows](delegated-access-virtual-desktop.md).

Кроме того, необходимо предоставить пользователям следующие сведения:

- URL-адрес приложения
- Имена отдельных клиентов группы клиентов, к которым у них есть доступ.

## <a name="use-the-diagnostics-tool"></a>Использование средства диагностики

После входа в учетную запись с помощью сведений, полученных от Организации, необходимо подготовить UPN для пользователя, для которого нужно запросить действия. При поиске будут предоставлены все действия по указанному типу действий, произошедшие в течение прошлой недели.

### <a name="how-to-read-activity-search-results"></a>Чтение результатов поиска действий

Действия сортируются по метке времени с последним действием. Если результаты возвращают ошибку, сначала проверьте, не произошла ли ошибка службы. Для ошибок службы создайте запрос в службу поддержки со сведениями о действии, которые помогут нам в отладке проблемы. Все остальные типы ошибок обычно могут быть решены пользователем или администратором. Список наиболее распространенных сценариев ошибок и способов их устранения см. в разделе [Определение проблем с функцией диагностики](diagnostics-role-service.md#common-error-scenarios).

>[!NOTE]
>Ошибки службы называются «внешними ошибками» в связанной документации. Это будет изменено при обновлении Справочника по PowerShell.

Действия подключения могут иметь более одной ошибки. Вы можете развернуть тип действия, чтобы увидеть любые другие ошибки, которые поступают у пользователя. Выберите имя кода ошибки, чтобы открыть диалоговое окно для просмотра дополнительных сведений о нем.

### <a name="investigate-the-session-host"></a>Исследование узла сеансов 

В результатах поиска найдите и выберите узел сеансов, сведения о котором требуется получить.

Вы можете анализировать работоспособность узла сеанса:

- На основе предопределенного порогового значения можно получить сведения о работоспособности узла сеанса, Log Analytics запросы.
- Если нет активности или узел сеанса не подключен к Log Analytics, информация будет недоступна.

Вы также можете взаимодействовать с пользователями на узле сеансов:

- Вы можете выйти или отправить сообщение для пользователей, выполнивших вход.
- Первоначально искомый пользователь выбирается по умолчанию, но можно также выбрать дополнительных пользователей для отправки сообщений или выхода нескольких пользователей одновременно.

### <a name="windows-performance-counter-thresholds"></a>Пороговые значения счетчика производительности Windows

- Логический диск (\*) \|% свободного места:

    - Отображает процент общего свободного пространства на логическом диске, который может быть свободным.
    - "Пороговое значение" — Менее 20% помечены как неработоспособные.

- Логический диск (C:) @no__t 0Avg. Длина очереди диска:

    - Представляет условия системы хранения.
    - "Пороговое значение" — Выше 5 помечается как неработоспособное.

- Память (\*) \\Available МБ:

    - Доступная память для системы.
    - "Пороговое значение" — Менее 500 мегабайтов помечены как неработоспособные.

- Сведения о процессоре (\*) @no__t 1Processor Time:

    - "Пороговое значение" — Более 80% помечается как неработоспособное.

- [Задержка ввода данных пользователем на сеанс (\*) \\Max входная задержка](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-rdsh-performance-counters):

    - "Пороговое значение" — Более 2000 мс помечены как неработоспособные.
