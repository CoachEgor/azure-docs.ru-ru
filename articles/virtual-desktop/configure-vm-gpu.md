---
title: Настройка GPU для виртуальных рабочих столов Windows в Azure
description: Включение отрисовки и кодирования с ускорением GPU в виртуальном рабочем столе Windows.
services: virtual-desktop
author: gundarev
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 05/06/2019
ms.author: denisgun
ms.openlocfilehash: 8b675a78041b68210fa7583510582783c506c720
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81767043"
---
# <a name="configure-graphics-processing-unit-gpu-acceleration-for-windows-virtual-desktop"></a>Настройка ускорения графического процессора для виртуальных рабочих столов Windows

Виртуальные рабочие столы Windows поддерживают визуализацию и кодирование с ускорением GPU для повышения производительности и масштабируемости приложений. Ускорение GPU особенно важно для приложений, интенсивно использующих графику.

Следуйте инструкциям в этой статье, чтобы создать виртуальную машину Azure, оптимизированную для GPU, добавить ее в пул узлов и настроить для нее использование ускорения GPU для отрисовки и кодирования. В этой статье предполагается, что у вас уже есть настроенный клиент виртуальных рабочих столов Windows.

## <a name="select-a-gpu-optimized-azure-virtual-machine-size"></a>Выбор размера виртуальной машины Azure, оптимизированной для GPU

Azure предлагает несколько [размеров виртуальных машин, оптимизированных для GPU](/azure/virtual-machines/windows/sizes-gpu). Правильный выбор пула узлов зависит от ряда факторов, включая определенные рабочие нагрузки приложений, требуемое качество взаимодействия с пользователем и стоимость. Как правило, большие и более производительные GPU предлагают лучшую работу пользователя с заданной плотностью пользователей.

## <a name="create-a-host-pool-provision-your-virtual-machine-and-configure-an-app-group"></a>Создание пула узлов, предоставление виртуальной машины и настройка группы приложений

Создайте новый пул узлов, используя виртуальную машину выбранного размера. Инструкции см. в разделе [учебник. Создание пула узлов с помощью Azure Marketplace](/azure/virtual-desktop/create-host-pools-azure-marketplace).

Виртуальные рабочие столы Windows поддерживают визуализацию и кодирование с ускорителем GPU в следующих операционных системах:

* Windows 10 версии 1511 или более поздней
* Windows Server 2016 или поздней версии.

Кроме того, необходимо настроить группу приложений или использовать группу стандартных приложений по умолчанию ("Группа приложений рабочей среды"), которая автоматически создается при создании нового пула узлов. Инструкции см. в разделе [учебник. Управление группами приложений для виртуальных рабочих столов Windows](/azure/virtual-desktop/manage-app-groups).

## <a name="install-supported-graphics-drivers-in-your-virtual-machine"></a>Установка поддерживаемых графических драйверов на виртуальной машине

Чтобы воспользоваться возможностями GPU виртуальных машин Azure серии N в виртуальном рабочем столе Windows, необходимо установить соответствующие графические драйверы. Следуйте инструкциям в разделе [Поддерживаемые операционные системы и драйверы](/azure/virtual-machines/windows/sizes-gpu#supported-operating-systems-and-drivers) , чтобы установить драйверы от соответствующего поставщика графики: вручную или с помощью расширения виртуальной машины Azure.

Только драйверы, распространяемые Azure, поддерживаются для виртуальных рабочих столов Windows. Дополнительно для виртуальных рабочих столов Windows поддерживаются только [драйверы сетки NVIDIA](/azure/virtual-machines/windows/n-series-driver-setup#nvidia-grid-drivers) для виртуальных машин Azure с графическими процессорами NVIDIA.

После установки драйвера требуется перезагрузка виртуальной машины. Выполните действия по проверке, описанные выше, чтобы убедиться, что драйверы графики успешно установлены.

## <a name="configure-gpu-accelerated-app-rendering"></a>Настройка визуализации приложений с ускорением GPU

По умолчанию приложения и настольные компьютеры, работающие в конфигурациях с несколькими сеансами, подготавливаются к работе с ЦП и не используют доступные графические процессоры для отрисовки. Настройте групповая политика для узла сеансов, чтобы включить рендеринг с ускорением GPU:

1. Подключитесь к рабочему столу виртуальной машины, используя учетную запись с правами локального администратора.
2. Откройте меню "Пуск" и введите "gpedit. msc", чтобы открыть редактор групповая политика.
3. Перейдите к разделу **Конфигурация** > **Административные шаблоны** > **компоненты** > Windows**службы удаленных рабочих столов** > удаленный рабочий стол**Среда удаленного сеанса****узла** > сеансов.
4. Выберите политика **использовать аппаратный адаптер по умолчанию для всех сеансов службы удаленных рабочих столов** и установите для этой политики значение **включено** , чтобы включить визуализацию GPU в удаленном сеансе.

## <a name="configure-gpu-accelerated-frame-encoding"></a>Настройка кодирования кадров с ускорением GPU

Удаленный рабочий стол кодирует все графики, отображаемые приложениями и настольными системами (как при отображении с помощью GPU, так и при использовании ЦП) для передачи клиентам удаленный рабочий стол. По умолчанию удаленный рабочий стол не использует доступные GPU для этой кодировки. Настройте групповая политика для узла сеансов, чтобы включить кодирование кадров с ускорением GPU. Продолжение выполнения описанных выше действий.

1. Выберите параметр **приоритетная политика. графический режим h. 264/AVC 444 для подключений удаленный рабочий стол** и установите для этой политики значение **включено** , чтобы в удаленном сеансе был принудительно использовать кодек h. 264/AVC 444.
2. Выберите политика **настроить шифрование оборудования 264/AVC для подключений удаленный рабочий стол** и установите для этой политики значение **включено** , чтобы включить кодирование оборудования для AVC/H. 264 в удаленном сеансе.

    >[!NOTE]
    >В Windows Server 2016 установите параметр Option **предпочитать аппаратную кодировку AVC** , чтобы **всегда предпринимать попытки**.

3. Теперь, когда групповые политики были изменены, принудительно обновите групповую политику. Откройте командную строку и введите:

    ```batch
    gpupdate.exe /force
    ```

4. Выйдите из сеанса удаленный рабочий стол.

## <a name="verify-gpu-accelerated-app-rendering"></a>Проверка визуализации приложения с ускорением GPU

Чтобы убедиться, что приложения используют GPU для подготовки к просмотру, выполните одно из следующих действий.

* Для виртуальных машин Azure с графическим процессором NVIDIA `nvidia-smi` используйте программу, как описано в разделе [Проверка установки драйвера](/azure/virtual-machines/windows/n-series-driver-setup#verify-driver-installation) для проверки использования GPU при запуске приложений.
* В поддерживаемых версиях операционных систем можно использовать диспетчер задач для проверки использования GPU. Выберите GPU на вкладке "производительность", чтобы узнать, использует ли приложение GPU.

## <a name="verify-gpu-accelerated-frame-encoding"></a>Проверка кодирования кадров с ускорением GPU

Чтобы убедиться, что удаленный рабочий стол использует кодирование с ускорением GPU:

1. Подключитесь к рабочему столу виртуальной машины с помощью клиента виртуальных рабочих столов Windows.
2.  > Запустите Просмотр событий и перейдите к следующему узлу: **журналы приложений и служб****Microsoft** > **Windows** > **ремотедесктопсервицес-рдпкорекдв** > **работает**
3. Чтобы определить, используется ли кодирование с ускорением GPU, найдите событие с ИДЕНТИФИКАТОРом 170. Если вы видите "кодировщик оборудования AVC: 1", используется кодирование GPU.
4. Чтобы определить, используется ли режим AVC 444, найдите событие с кодом 162. Если вы видите "доступный AVC: 1 начальный профиль: 2048", то используется AVC 444.

## <a name="next-steps"></a>Дальнейшие шаги

Эти инструкции должны работать с ускорением GPU на одном узле сеансов (одна виртуальная машина). Некоторые дополнительные рекомендации по включению ускорения GPU в крупном пуле узлов.

* Рекомендуется использовать [расширение виртуальной машины](/azure/virtual-machines/extensions/overview) для упрощения установки и обновления драйверов на нескольких виртуальных машинах. Используйте [расширение драйвера GPU NVIDIA](/azure/virtual-machines/extensions/hpccompute-gpu-windows) для виртуальных машин с графическими процессорами NVIDIA и используйте расширение драйвера GPU AMD (ожидается в ближайшее время) для виртуальных машин с процессорами AMD GPU.
* Рассмотрите возможность использования Active Directory групповая политика для упрощения настройки групповой политики на нескольких виртуальных машинах. Сведения о развертывании групповая политика в домене Active Directory см. в разделе [Работа с объектами групповая политика](https://go.microsoft.com/fwlink/p/?LinkId=620889).
