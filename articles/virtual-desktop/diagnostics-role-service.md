---
title: Выявление проблем с функцией диагностики виртуальных рабочих столов Windows в Azure
description: Описание функции диагностики виртуальных рабочих столов Windows и ее использования.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 08/29/2019
ms.author: helohr
ms.openlocfilehash: 5401260921aee5fc54b50c1222188a6b244a0c5a
ms.sourcegitcommit: 15e3bfbde9d0d7ad00b5d186867ec933c60cebe6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2019
ms.locfileid: "71840142"
---
# <a name="identify-and-diagnose-issues"></a>Выявление и диагностика проблем

Виртуальный рабочий стол Windows предлагает функцию диагностики, которая позволяет администратору определять проблемы с помощью одного интерфейса. Роли виртуальных рабочих столов Windows заносить диагностические действия в журнал при каждом взаимодействии пользователя с системой. Каждый журнал содержит важную информацию, такую как роли виртуальных рабочих столов Windows, связанные с транзакцией, сообщения об ошибках, сведения о клиенте и сведения о пользователе. Диагностические действия создаются как конечными пользователями, так и административными действиями. их можно разделить на три основных сегмента:

* Действия подписки на веб-канал. конечный пользователь запускает эти действия при попытке подключения к каналу через Удаленный рабочий стол (Майкрософт) приложения.
* Действия подключения. конечный пользователь запускает эти действия при каждом подключении к рабочему столу или удаленному приложению RemoteApp через приложения Удаленный рабочий стол (Майкрософт).
* Действия управления. Администратор запускает эти действия каждый раз, когда они выполняют операции управления в системе, такие как создание пулов узлов, назначение пользователей группам приложений и создание назначений ролей.
  
Подключения, которые не достигают виртуальных рабочих столов Windows, не отображаются в результатах диагностики, так как сама служба роли диагностики является частью виртуального рабочего стола Windows. Проблемы с подключением к виртуальным рабочим столам Windows могут возникнуть, когда пользователь испытывает проблемы с сетевым подключением.

Чтобы приступить к работе, [скачайте и импортируйте модуль PowerShell для виртуальных рабочих столов Windows](https://docs.microsoft.com/powershell/windows-virtual-desktop/overview) для использования в сеансе PowerShell, если вы этого еще не сделали. После этого выполните следующий командлет, чтобы войти в учетную запись:

```powershell
Add-RdsAccount -DeploymentUrl "https://rdbroker.wvd.microsoft.com"
```

## <a name="diagnose-issues-with-powershell"></a>Диагностика проблем с помощью PowerShell

Диагностика виртуальных рабочих столов Windows использует только один командлет PowerShell, но содержит множество необязательных параметров, помогающих ограничить и изолировать проблемы. В следующих разделах перечислены командлеты, которые можно выполнить для диагностики проблем. Большинство фильтров можно применять вместе. Значения, указанные в квадратных скобках `<tenantName>`, такие как, должны быть заменены значениями, которые применяются к конкретной ситуации.

### <a name="retrieve-diagnostic-activities-in-your-tenant"></a>Получение диагностических действий в клиенте

Вы можете получить диагностические действия, введя командлет **Get-рдсдиагностикактивитиес** . Следующий пример командлета возвращает список диагностических действий, отсортированных от большинства к самым поздним.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName>
```

Как и другие командлеты PowerShell для виртуальных рабочих столов Windows, необходимо использовать параметр **-TenantName** , чтобы указать имя клиента, который будет использоваться для запроса. Имя клиента применимо почти для всех запросов действий диагностики.

### <a name="retrieve-detailed-diagnostic-activities"></a>Получение подробных диагностических действий

Параметр **-Detailed** предоставляет дополнительные сведения для каждого возвращаемого диагностического действия. Формат каждого действия зависит от типа действия. Параметр **-Detailed** можно добавить в любой запрос **Get-рдсдиагностикактивитиес** , как показано в следующем примере.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -Detailed
```

### <a name="retrieve-a-specific-diagnostic-activity-by-activity-id"></a>Получение определенного диагностического действия по ИДЕНТИФИКАТОРу действия

Параметр **-ActivityId** возвращает определенное диагностическое действие, если оно существует, как показано в следующем примере командлета.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityId <ActivityIdGuid>
```

### <a name="view-error-messages-for-a-failed-activity-by-activity-id"></a>Просмотр сообщений об ошибках для невыполненных действий по ИДЕНТИФИКАТОРу действия

Чтобы просмотреть сообщения об ошибках для невыполненных действий, необходимо выполнить командлет с параметром **-Detailed** . Список ошибок можно просмотреть, выполнив командлет **Select-Object** .

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantname> -ActivityId <ActivityGuid> -Detailed | Select-Object -ExpandProperty Errors
```

### <a name="filter-diagnostic-activities-by-user"></a>Фильтрация диагностических действий по пользователям

Параметр **-username** возвращает список диагностических действий, инициированных указанным пользователем, как показано в следующем примере командлета.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN>
```

Параметр **-username** можно также сочетать с другими необязательными параметрами фильтрации.

### <a name="filter-diagnostic-activities-by-time"></a>Фильтрация диагностических действий по времени

Вы можете отфильтровать возвращенный список диагностических действий с помощью параметров **-StartTime** и **-EndTime** . Параметр **-StartTime** возвратит список диагностических действий, начиная с определенной даты, как показано в следующем примере.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -StartTime "08/01/2018"
```

Параметр **-EndTime** можно добавить в командлет с параметром **-StartTime** , чтобы указать определенный период времени, в течение которого требуется получать результаты. Следующий пример командлета возвратит список диагностических действий с 1 августа по 10 августа.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -StartTime "08/01/2018" -EndTime "08/10/2018"
```

Параметры **-StartTime** и **-EndTime** можно также сочетать с другими необязательными параметрами фильтрации.

### <a name="filter-diagnostic-activities-by-activity-type"></a>Фильтрация диагностических действий по типу действия

Вы также можете фильтровать диагностические действия по типу действия с помощью параметра **-ActivityType** . Следующий командлет вернет список подключений пользователей:

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityType Connection
```

Следующий командлет вернет список задач управления администраторами:

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityType Management
```

Командлет **Get-рдсдиагностикактивитиес** в настоящее время не поддерживает указание Feed в качестве ActivityType.

### <a name="filter-diagnostic-activities-by-outcome"></a>Фильтровать диагностические действия по результату

Вы можете отфильтровать возвращенный список диагностических действий по результату с параметром **-результата** . Следующий пример командлета вернет список успешных диагностических действий.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -Outcome Success
```

Следующий пример командлета вернет список неудачных диагностических действий.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -Outcome Failure
```

Параметр **-результата** также можно сочетать с другими необязательными параметрами фильтрации.

## <a name="common-error-scenarios"></a>Распространенные сценарии ошибок

Сценарии ошибок классифицируются по внутренним компонентам службы и являются внешними для виртуальных рабочих столов Windows.

* Внутренняя проблема. указывает сценарии, которые не могут быть устранены администратором клиента и должны быть решены как проблемы с поддержкой. При предоставлении обратной связи с помощью [технического сообщества виртуальных рабочих столов Windows](https://techcommunity.microsoft.com/t5/Windows-Virtual-Desktop/bd-p/WindowsVirtualDesktop)включите идентификатор действия и приблизительный период времени возникновения проблемы.
* Внешняя ошибка. Свяжите с сценариями, которые могут быть устранены системным администратором. Они являются внешними для виртуальных рабочих столов Windows.

В следующей таблице перечислены распространенные ошибки, с которыми могут столкнуться администраторы.

>[!NOTE]
>В этом списке содержатся наиболее распространенные ошибки, которые обновляются с учетом постоянной ритмичности. Чтобы получить актуальные сведения, обязательно ознакомьтесь с этой статьей по крайней мере раз в месяц.

### <a name="external-management-error-codes"></a>Коды ошибок внешнего управления

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|3|унаусоризедакцесс|Пользователь, который пытался запустить командлет PowerShell с правами администратора, не имеет разрешений на это или неправильно настроил его имя пользователя.|
|1000|тенантнотфаунд|Введенное имя клиента не соответствует ни одному из существующих клиентов. Проверьте имя клиента на наличие опечаток и повторите попытку.|
|1006|тенантканнотберемоведхассессионхостпулс|Невозможно удалить клиент, если он содержит объекты. Сначала удалите пулы узлов сеансов, а затем повторите попытку.|
|2000|хостпулнотфаунд|Введенное имя пула узлов не соответствует ни одному из существующих пулов узлов. Проверьте имя пула узлов на наличие опечаток и повторите попытку.|
|2005|хостпулканнотберемоведхасаппликатионграупс|Пул узлов нельзя удалить, если он содержит объекты. Сначала удалите все группы приложений в пуле узлов.|
|2004|хостпулканнотберемоведхассессионхостс|Прежде чем удалять пул узлов сеансов, сначала удалите все узлы сеансов.|
|5001|сессионхостнотфаунд|Запрошенный узел сеансов может находиться в автономном режиме. Проверьте состояние пула узлов.|
|5008|сессионхостусерсессионсексист |Прежде чем выполнять предполагаемое действие управления, необходимо выйти с всех пользователей на узле сеансов.|
|6000|аппграупнотфаунд|Введенное имя группы приложений не соответствует ни одной из существующих групп приложений. Проверьте имя группы приложений на наличие опечаток и повторите попытку.|
|6022|ремотеаппнотфаунд|Указанное имя RemoteApp не соответствует ни одному из удаленных приложений RemoteApp. Проверьте имя удаленного приложения RemoteApp на наличие опечаток и повторите попытку.|
|6010|публишедитемсексист|Имя ресурса, который вы пытаетесь опубликовать, совпадает с именем уже существующего ресурса. Измените имя ресурса и повторите попытку.|
|7002|наменотвалидвхитеспаце|Не используйте пробелы в имени.|
|8000|инвалидаусоризатионролескопе|Введенное имя роли не соответствует ни одному из существующих имен ролей. Проверьте имя роли на наличие опечаток и повторите попытку. |
|8001|усернотфаунд |Введенное имя пользователя не соответствует ни одному из существующих имен пользователей. Проверьте имя для опечаток и повторите попытку.|
|8005|усернотфаундинаад |Введенное имя пользователя не соответствует ни одному из существующих имен пользователей. Проверьте имя для опечаток и повторите попытку.|
|8008|тенантконсентрекуиред|Следуйте приведенным [здесь](tenant-setup-azure-active-directory.md#grant-permissions-to-windows-virtual-desktop) инструкциям, чтобы предоставить согласие для вашего клиента.|

### <a name="external-connection-error-codes"></a>Коды ошибок внешних подключений

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|— 2147467259|коннектионфаиледадтрустедрелатионшипфаилуре|Узел сеансов неправильно присоединен к Active Directory.|
|— 2146233088|коннектионфаиледусерхасвалидсессионбутрдшисунхеалси|Не удалось выполнить соединения, так как узел сеансов недоступен. Проверьте работоспособность узла сеанса.|
|— 2146233088|коннектионфаиледклиентдисконнект|Если эта ошибка возникает часто, убедитесь, что компьютер пользователя подключен к сети.|
|— 2146233088|коннектионфаиледнохеалсирдшаваилабле|Сеанс, к которому пытался подключиться пользователь узла, неисправен. Отладить виртуальную машину.|
|— 2146233088|коннектионфаиледусернотаусоризед|У пользователя нет разрешения на доступ к опубликованному приложению или рабочему столу. Эта ошибка может появиться после удаления администратором опубликованных ресурсов. Попросите пользователя обновить веб-канал в удаленный рабочий стол приложении.|
|2|FileNotFound|Приложение, к которому пользователь пытался получить доступ, либо неправильно установлено, либо имеет неверный путь.|
|3|инвалидкредентиалс|Имя пользователя или пароль, введенные пользователем, не совпадают с существующими именами пользователей или паролями. Проверьте учетные данные для опечаток и повторите попытку.|
|8|коннектионброкен|Соединение между клиентом и шлюзом или сервером отброшено. Никаких действий не требуется, если это не происходит неожиданно.|
|14|унекспектеднетворкдисконнект|Подключение к сети разорвано. Попросите пользователя подключиться снова.|
|24|реверсеконнектфаилед|Виртуальная машина узла не имеет прямой информации о шлюзе удаленных рабочих столов. Убедитесь, что IP-адрес шлюза может быть разрешен.|

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о ролях в виртуальном рабочем столе Windows см. в разделе [Среда виртуальных рабочих столов Windows](environment-setup.md).

Список доступных командлетов PowerShell для виртуальных рабочих столов Windows см. в справочнике по [PowerShell](/powershell/windows-virtual-desktop/overview).
