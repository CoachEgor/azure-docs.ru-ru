---
title: Проблемы с диагностикой виртуального рабочего стола Windows - Azure
description: Как использовать функцию диагностики виртуального рабочего стола Windows для диагностики проблем.
services: virtual-desktop
author: Heidilohr
ms.service: virtual-desktop
ms.topic: conceptual
ms.date: 03/10/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: ce85fb70e1480ad285eee78fe20faa8d77b9a147
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79254265"
---
# <a name="identify-and-diagnose-issues"></a>Выявление и диагностика неполадок

Windows Virtual Desktop предлагает функцию диагностики, которая позволяет администратору выявлять проблемы с помощью одного интерфейса. Роли Windows Virtual Desktop регистрировать диагностическую деятельность всякий раз, когда пользователь взаимодействует с системой. Каждый журнал содержит соответствующую информацию, такую как роли Windows Virtual Desktop, участвующие в транзакции, сообщения об ошибках, информация о клиентах и пользовательская информация. Диагностические действия создаются как конечными, так и административными действиями и могут быть разделены на три основных ведра:

* Действия подписки на канал: конечный пользователь запускает эти действия всякий раз, когда он пытается подключиться к своей ленте через приложения Microsoft Remote Desktop.
* Действия подключения: конечный пользователь запускает эти действия всякий раз, когда они пытаются подключиться к рабочему столу или RemoteApp через приложения Microsoft Remote Desktop.
* Действия управления: администратор запускает эти действия всякий раз, когда они выполняют операции управления в системе, такие как создание пулов узла, назначение пользователей группам приложений и создание ролевых назначений.
  
Соединения, которые не достигают Windows Virtual Desktop, не отображаются в результатах диагностики, поскольку служба ролевых ролей диагностики сама по себе является частью Windows Virtual Desktop. Проблемы с подключением Windows Virtual Desktop могут возникать, когда конечный пользователь испытывает проблемы с подключением к сети.

Чтобы начать работу, [загрузите и импортируйте модуль Windows Virtual Desktop PowerShell](/powershell/windows-virtual-desktop/overview/) для использования в сеансе PowerShell, если вы еще не сделали этого. После этого выполните следующий командлет, чтобы войти в учетную запись:

```powershell
Add-RdsAccount -DeploymentUrl "https://rdbroker.wvd.microsoft.com"
```

## <a name="diagnose-issues-with-powershell"></a>Диагностика проблем с PowerShell

Windows Virtual Desktop Diagnostics использует только один cmdlet PowerShell, но содержит много дополнительных параметров, чтобы помочь сузить и изолировать проблемы. В следующих разделах перечисляют cmdlets, которые можно запустить для диагностики проблем. Большинство фильтров можно применять вместе. Значения, перечисленные в скобках, такие как `<tenantName>`, должны быть заменены значениями, которые применяются к вашей ситуации.

>[!IMPORTANT]
>Функция диагностики предназначена для устранения неполадок для одного пользователя. Все запросы с использованием PowerShell должны включать параметры *-UserName* или *-ActivityID.* Для возможностей мониторинга используйте Log Analytics. Дополнительную информацию о том, как отправлять данные о диагностике в рабочее пространство, можно просмотреть [функцию «Используйте журнал ную нить для диагностики».](diagnostics-log-analytics.md) 

### <a name="filter-diagnostic-activities-by-user"></a>Фильтр диагностические действия пользователя

Параметр **-UserName** возвращает список диагностических действий, инициированных указанным пользователем, как показано в следующем примере cmdlet.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN>
```

Параметр **-UserName** также может быть объединен с другими дополнительными параметрами фильтрации.

### <a name="filter-diagnostic-activities-by-time"></a>Фильтр диагностические мероприятия по времени

Вы можете отфильтровать список возвращенных диагностических действий с параметрами **-StartTime** и **-EndTime.** Параметр **StartTime** возвращает список диагностических действий, начиная с определенной даты, как показано в следующем примере.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -StartTime "08/01/2018"
```

Параметр **-EndTime** может быть добавлен к cmdlet с параметром **-StartTime,** чтобы указать определенный период времени, для получения результатов. В следующем примере cmdlet вернет список диагностических мероприятий с 1 по 10 августа.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -StartTime "08/01/2018" -EndTime "08/10/2018"
```

Параметры **-StartTime** и **-EndTime** также могут быть объединены с другими дополнительными параметрами фильтрации.

### <a name="filter-diagnostic-activities-by-activity-type"></a>Фильтр диагностические действия по типу активности

Можно также фильтровать диагностические действия по типу активности с параметром **-ActivityType.** Следующий cmdlet вернет список подключений конечных пользователей:

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -ActivityType Connection
```

Следующий cmdlet вернет список задач управления администратором:

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityType Management
```

Смдлет **Get-RdsDiagnosticActivities** в настоящее время не поддерживает указание канала как ActivityType.

### <a name="filter-diagnostic-activities-by-outcome"></a>Фильтр диагностические мероприятия по результатам

Вы можете фильтровать возвращенный список диагностических действий по результатам с параметром **-Outcome.** Следующий пример cmdlet вернет список успешных диагностических мероприятий.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -UserName <UserUPN> -Outcome Success
```

Следующий пример cmdlet вернет список неудачных диагностических мероприятий.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -Outcome Failure
```

Параметр **-Outcome** также может быть объединен с другими дополнительными параметрами фильтрации.

### <a name="retrieve-a-specific-diagnostic-activity-by-activity-id"></a>Извлекайте определенную диагностическую активность по идентификатору активности

Параметр **ActivityId** возвращает определенную диагностическую активность, если она существует, как показано в следующем примере cmdlet.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityId <ActivityIdGuid>
```

### <a name="view-error-messages-for-a-failed-activity-by-activity-id"></a>Просмотр сообщений об ошибках для сбой деятельности по идентификатору активности

Для просмотра сообщений об ошибках для сбой нойся деятельности необходимо запустить cmdlet с **помощью -Детального** параметра. Список ошибок можно просмотреть, запустив cmdlet **Select-Object.**

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantname> -ActivityId <ActivityGuid> -Detailed | Select-Object -ExpandProperty Errors
```

### <a name="retrieve-detailed-diagnostic-activities"></a>Извлечение детальной диагностической деятельности

**Детальный** параметр предоставляет дополнительные сведения для каждой возвращенной диагностической деятельности. Формат для каждого вида деятельности варьируется в зависимости от типа его деятельности. **Детальный** параметр может быть добавлен в любой запрос **Get-RdsDiagnosticActivities,** как показано в следующем примере.

```powershell
Get-RdsDiagnosticActivities -TenantName <tenantName> -ActivityId <ActivityGuid> -Detailed
```

## <a name="common-error-scenarios"></a>Распространенные сценарии ошибок

Сценарии ошибок классифицируются внутри службы и вне Windows Virtual Desktop.

* Внутренняя проблема: определяет сценарии, которые не могут быть смягчены администратором-арендатором и должны быть решены в качестве проблемы поддержки. При предоставлении обратной связи через [Windows Virtual Desktop Tech Community,](https://techcommunity.microsoft.com/t5/Windows-Virtual-Desktop/bd-p/WindowsVirtualDesktop)включите идентификатор активности и приблизительные сроки, когда возникла проблема.
* Внешняя проблема: относятся к сценариям, которые могут быть смягчены системным администратором. Они являются внешними для Windows Virtual Desktop.

В следующей таблице перечислены распространенные ошибки, с которыми могут столкнуться ваши админы.

>[!NOTE]
>Этот список включает в себя наиболее распространенные ошибки и обновляется на регулярной каденции. Чтобы убедиться, что у вас есть самая актуальная информация, не забудьте проверить обратно на эту статью по крайней мере один раз в месяц.

### <a name="external-management-error-codes"></a>Внешние коды ошибок управления

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|3|НесанкционированныйДоступ|Пользователь, который пытался запустить административный смдлет PowerShell, либо не имеет на это разрешений, либо неправильно вводит свое имя пользователя.|
|1000|АрендаторНенайдено|Имя клиента, которое вы ввели, не соответствует существующим арендаторам. Просмотрите имя клиента для опечатки и повторите попытку.|
|1006|TenantCannotBeRemovedHasSessionHostPools|Вы не можете удалить клиента до тех пор, пока он содержит объекты. Сначала удалите пулы хостай-сессий, а затем повторите попытку.|
|2000|HostPoolNotFound|Имя пула, которое вы ввели, не соответствует существующим пулам. Просмотрите название пула для опечатков и повторите попытку.|
|2005|HostpoolCannotberemovedhasapplicationGroups|Вы не можете удалить пул хоста до тех пор, пока он содержит объекты. Сначала удалите все группы приложений в пуле хоста.|
|2004|HostpoolCannotberemovedhasSessionhostshosts|Сначала удалите все хосты сеансов перед удалением пула хостов сеансов.|
|5001|SessionHostNotFound|Запрашиваемый хост сеанса может быть отключен. Проверьте состояние пула.|
|5008|SessionHostUserSessionsExist |Перед выполнением намеченной управленческой деятельности необходимо выписать всех пользователей на хосте сеанса.|
|6000|AppGroupNotFound|Имя группы приложений, которое вы ввели, не соответствует существующим группам приложений. Просмотрите название группы приложений для опечатки и повторите попытку.|
|6022|RemoteAppNotFound|Имя RemoteApp, которое вы ввели, не соответствует любым удаленным приложениям. Просмотрите имя RemoteApp для опечатков и повторите попытку.|
|6010|ОпубликованоItemsExist|Имя ресурса, которое вы пытаетесь опубликовать, такое же, как и уже существующий ресурс. Измените имя ресурса и повторите попытку.|
|7002|NameNotValidWhiteSpace|Не используйте белое пространство в названии.|
|8000|НедействительноеАвторизацияРоскоп|Имя роли, которое вы ввели, не соответствует существующим именам ролей. Просмотрите название роли для опечатков и повторите попытку. |
|8001|UserNotFound |Имя пользователя, которое вы ввели, не соответствует существующим именам пользователей. Просмотрите название опечатки и повторите попытку.|
|8005|UserNotfoundinAad |Имя пользователя, которое вы ввели, не соответствует существующим именам пользователей. Просмотрите название опечатки и повторите попытку.|
|8008|ТенттенСогласиеТребует|Следуйте инструкциям [здесь,](tenant-setup-azure-active-directory.md#grant-permissions-to-windows-virtual-desktop) чтобы предоставить согласие для вашего арендатора.|

### <a name="external-connection-error-codes"></a>Коды ошибок внешнего соединения

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|-2147467259|ПодключениеFailedAdTrustedОтношенияНеспособность|Хост сеанса неправильно соединен с Active Directory.|
|-2146233088|ПодключениеFailedUserHasValidSessionButButIsUnздоровый|Соединения сбой из-за недоступности узла сеанса. Проверьте состояние здоровья хозяина сеанса.|
|-2146233088|ПодключениеНеудалосьКлиентДисподключение|Если вы часто видите эту ошибку, убедитесь, что компьютер пользователя подключен к сети.|
|-2146233088|ПодключениеFailedNoHealthyRdsh|Сеанс, к который пытался подключиться пользователь-хоста, не является здоровым. Отладить виртуальную машину.|
|-2146233088|ПодключениеFailedUserНеавторизован|Пользователь не имеет разрешения на доступ к опубликованному приложению или рабочему столу. Ошибка может появиться после удаления эмищими по персоналу опубликованными ресурсами. Попросите пользователя обновить ленту в приложении Remote Desktop.|
|2|FileNotFound|Приложение, к которому пытался получить доступ пользователь, либо неправильно установлено, либо настроено на неправильный путь.|
|3|InvalidCredentials|Имя пользователя или пароль, введенный пользователем, не соответствует существующим именам пользователей или паролям. Просмотрите учетные данные для опечаток и повторите попытку.|
|8|ConnectionBroken|Связь между клиентом и шлюзом или сервером упала. Никакие действия не нужны, если это не произойдет неожиданно.|
|14|НеожиданныйСетевойДисконнект|Подключение к сети упало. Попросите пользователя подключиться снова.|
|24|ОбратныйconnectFailed|Виртуальная машина хозяина не имеет прямой видимости к RD Gateway. Убедитесь, что IP-адрес шлюза может быть решен.|

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать больше о роли [Windows Virtual Desktop environment](environment-setup.md)в Windows Virtual Desktop, см.

Чтобы увидеть список доступных смлетов PowerShell [PowerShell reference](/powershell/windows-virtual-desktop/overview)для Windows Virtual Desktop, см.
