---
title: Как работает шлюз приложений
description: Эта статья содержит сведения о том, как работает шлюз приложений
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 02/20/2019
ms.author: absha
ms.openlocfilehash: a16421182f533f5aa2ad4bcc2e58e910cc7e8ca6
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64702411"
---
# <a name="how-an-application-gateway-works"></a>Как работает шлюз приложений

В этой статье объясняется, как шлюз приложений принимает входящие запросы и направляет их в серверную часть.

![Как шлюз приложений принимает запрос](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-an-application-gateway-accepts-a-request"></a>Как шлюз приложений принимает запрос

1. Прежде чем клиент отправляет запрос в шлюз приложений, он разрешает доменное имя шлюза приложений с помощью сервера доменных имен (DNS). Запись DNS управляет Azure, так как все шлюзы приложений находятся в домене, сайте azure.com.

2. Azure DNS возвращает IP-адрес клиента, которая представляет IP-адрес внешнего интерфейса шлюза приложений.

3. Шлюз приложений принимает трафик, поступающий на один или несколько прослушивателей. Прослушиватель — это логическая сущность, которое проверяет наличие запросов на подключение. Он настраивается с внешний IP-адрес, протокол и номер порта для подключения от клиентов в шлюзе приложений.

4. Если используется брандмауэр веб-приложения (WAF), шлюз приложений проверяет заголовки запроса и текст, если он имеется, по правилам WAF. Это действие определяет, является ли запрос допустимым запросом или угрозы безопасности. Если запрос действителен, он направляется к серверной части. Если запрос является недопустимым, он блокируется как угрозу безопасности.

Шлюз приложений Azure можно использовать как подсистемы балансировки нагрузки внутреннего приложения или подсистемы балансировки нагрузки приложения для Интернета. Шлюз приложений для Интернета используются общедоступные IP-адреса. DNS-имя шлюза приложений для Интернета разрешимые его общедоступный IP-адрес. Таким образом шлюзов приложений для Интернета можно направлять запросы клиентов в Интернет.

Внутреннее приложение шлюзы используют только частные IP-адреса. DNS-имя шлюза приложений с внутренней разрешимые ее частный IP-адрес. Таким образом внутренней подсистемы балансировки нагрузки только может направлять запросы от клиентов с доступом к виртуальной сети для шлюза приложений.

Шлюзы с выходом в Интернет и внутренних приложений направлять запросы на внутренних серверах, с помощью частных IP-адресов. Внутренних серверов не требуется общедоступный IP-адреса для получения запросов из внутреннего или шлюза приложений для Интернета.

## <a name="how-an-application-gateway-routes-a-request"></a>Как и шлюз приложений направляет запросы

Если запрос является допустимым или не используется WAF, шлюз приложений оценивает запрос правила маршрутизации, связанной с прослушивателем. Это действие определяет, какой внутренний пул для маршрутизации запроса.

Правила обрабатываются в порядке, в котором они перечислены на портале. На основании правила маршрутизации запроса, шлюз приложений определяет, следует ли перенаправлять все запросы на прослушивателе определенном серверном пуле, запрашивает маршрут для разных серверных пулов на основе URL-адрес, или перенаправлять запросы на другой порт или внешний сайт.

Когда шлюз приложений выбирает пул серверной части, он отправляет запрос на один из серверов получается работоспособная серверная в пуле (y.y.y.y). Работоспособность сервера определяется пробу работоспособности. Если внутренний пул содержит несколько серверов, шлюз приложений использует алгоритм циклического для маршрутизации запросов между серверами работоспособное. Этот балансирует нагрузку запросов на серверах.

После шлюз приложения определяет внутренний сервер, он открывает новый сеанс TCP с внутреннего сервера, на основе параметров HTTP. Параметры HTTP определяют протокол, порт и другие параметры, связанные с маршрутизации, которые необходимо установить новый сеанс с внутреннего сервера.

Порт и протокол, используемый в параметрах HTTP определения шифруется (таким образом выполнение-сквозного режима связи SSL) или не шифруется трафик между сервером шлюза и серверной части приложения.

Когда шлюз приложений отправляет первоначальный запрос внутреннему серверу, будет поддерживать пользовательской настройки, внесенные в параметры HTTP, относящиеся к переопределение имени узла, путь и протокола. Это действие позволит оставить, соответствие сеансу на основе файлов cookie, выбор сток, имени узла подключения из серверной части и т. д.

Шлюз внутреннее приложение использует только частные IP-адреса. DNS-имя шлюза приложений с внутренней можно разрешить ее частный IP-адрес. В результате внутренней подсистемы балансировки нагрузки только может направлять запросы от клиентов с доступом к виртуальной сети для шлюза приложений.

 >[!NOTE]
 >Оба шлюза приложения с выходом в Интернет и внутренних направлять запросы на внутренних серверах с помощью частных IP-адресов. Это действие происходит, когда ресурс пула серверной части содержит частный IP-адрес, конфигурации сетевого Адаптера виртуальной Машины или внутренне разрешимыми адресами. Если серверный пул:
> - **— Это общедоступная конечная точка**, шлюз приложений использует общедоступным IP внешнего интерфейса получить доступ к серверу. Если общедоступный IP-адрес внешнего интерфейса, один назначается для исходящих внешних подключений.
> - **Содержит внутренним образом разрешить полное доменное имя или частный IP-адрес**, шлюз приложений направляет запрос внутреннему серверу с помощью его экземпляр частных IP-адресов.
> - **Содержит внешнюю конечную точку или возможностью внешнего разрешения полного доменного ИМЕНИ**, шлюз приложений направляет запрос внутреннему серверу с помощью общедоступного IP-адрес внешнего интерфейса. Разрешение DNS основан на частную зону DNS или пользовательский DNS-сервер, если настроен, или он использует значение по умолчанию DNS, предоставленной Azure. Если общедоступный IP-адрес внешнего интерфейса, один назначается для исходящих внешних подключений.

### <a name="modifications-to-the-request"></a>Изменения в запрос

Шлюз приложений вставляет четыре дополнительные заголовки для всех запросов, прежде чем он перенаправляет запросы в серверную часть. Эти заголовки x-forwarded-for, x-forwarded-proto, x-forwarded-port и x исходный host. Формат для заголовка x-forwarded-for является разделенный запятыми список IP: Port.

Допустимые значения для x-forwarded-proto — HTTP или HTTPS. X-forwarded-port указывает порт, где запрос подключение к шлюзу приложений. Заголовок X-исходный host содержит исходный заголовок узла, с которого поступил запрос. Этот заголовок удобно в интеграции веб-сайте Azure, где изменяется заголовок узла входящих данных, прежде чем трафик направляется к серверной части. При включенном сходстве сеансов свободен, он добавляет файл cookie сходства, управляемую шлюзом.

Можно настроить шлюз приложений, чтобы изменить заголовки с помощью [заголовки HTTP, перепишите](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers) или изменить путь URI с помощью параметра переопределение пути. Тем не менее если иное не настроено, чтобы сделать это, все входящие запросы передаются на внутренний сервер.

## <a name="next-steps"></a>Дальнейшие действия

[Дополнительные сведения о компонентах шлюза приложения](application-gateway-components.md)
