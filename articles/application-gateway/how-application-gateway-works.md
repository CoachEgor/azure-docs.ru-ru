---
title: Принцип работы шлюза приложений
description: В этой статье содержатся сведения о работе шлюза приложений.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 02/20/2019
ms.author: absha
ms.openlocfilehash: 5cb7473b309e1aefe6237671fac73c042b33f2cf
ms.sourcegitcommit: e9936171586b8d04b67457789ae7d530ec8deebe
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71326873"
---
# <a name="how-an-application-gateway-works"></a>Принцип работы шлюза приложений

В этой статье объясняется, как шлюз приложений принимает входящие запросы и направляет их в серверную часть.

![Как шлюз приложений принимает запрос](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-an-application-gateway-accepts-a-request"></a>Как шлюз приложений принимает запрос

1. Прежде чем клиент отправит запрос к шлюзу приложений, он разрешает доменное имя шлюза приложений с помощью сервера службы доменных имен (DNS). Azure управляет записью DNS, так как все шлюзы приложений находятся в домене azure.com.

2. Azure DNS возвращает IP-адрес клиенту, который является интерфейсным IP-адресом шлюза приложений.

3. Шлюз приложений принимает входящий трафик одного или нескольких прослушивателей. Прослушиватель — это логическая сущность, которая проверяет наличие запросов на подключение. Он настроен с использованием внешнего IP-адреса, протокола и номера порта для подключений клиентов к шлюзу приложений.

4. Если используется брандмауэр веб-приложения (WAF), шлюз приложений проверяет заголовки запросов и текст, если они есть, в соответствии с правилами WAF. Это действие определяет, является ли запрос допустимым запросом или угрозой безопасности. Если запрос является допустимым, он направляется в серверную часть. Если запрос является недопустимым и WAF находится в режиме предотвращения, он блокируется как угроза безопасности. Если он находится в режиме обнаружения, запрос оценивается и заносится в журнал, но по-прежнему пересылается на внутренний сервер.

Шлюз приложений Azure можно использовать как внутреннюю подсистему балансировки нагрузки приложений или как подсистему балансировки нагрузки приложений для Интернета. Шлюз приложений с выходом в Интернет использует общедоступные IP-адреса. DNS-имя шлюза приложений с выходом в Интернет разрешается в общедоступный IP-адрес. В результате шлюзы приложений с выходом в Интернет могут перенаправлять клиентские запросы в Интернет.

Внутренние шлюзы приложений используют только частные IP-адреса. Если вы используете настраиваемую или [Частная зона DNS зону](https://docs.microsoft.com/azure/dns/private-dns-overview), доменное имя должно быть разрешимо для частного IP-адреса шлюза приложений. Поэтому внутренние подсистемы балансировки нагрузки могут маршрутизировать запросы только от клиентов с доступом к виртуальной сети для шлюза приложений.

## <a name="how-an-application-gateway-routes-a-request"></a>Как шлюз приложений направляет запрос

Если запрос является допустимым и не заблокирован WAF, шлюз приложений оценивает правило маршрутизации запросов, связанное с прослушивателем. Это действие определяет, в какой серверный пул следует направить запрос.

На основе правила маршрутизации запросов шлюз приложений определяет, следует ли перенаправлять все запросы к прослушивателю на определенный серверный пул, маршрутизировать запросы к различным внутренним пулам на основе пути URL-адреса или перенаправлять запросы на другой порт или внешний сайт.
>[!NOTE]
>Правила обрабатываются в том порядке, в котором они указаны на портале для номера SKU v1. 

Когда шлюз приложений выбирает серверный пул, он отправляет запрос одному из работоспособных серверных серверов в пуле (y. y. y. y). Работоспособность сервера определяется пробой работоспособности. Если внутренний пул содержит несколько серверов, шлюз приложений использует алгоритм циклического перебора для маршрутизации запросов между работоспособными серверами. Эта нагрузка распределяет запросы на серверах.

После того как шлюз приложений определит внутренний сервер, он откроет новый сеанс TCP с внутренним сервером на основе параметров HTTP. Параметры HTTP указывают протокол, порт и другие параметры, связанные с маршрутизацией, необходимые для создания нового сеанса с внутренним сервером.

Порт и протокол, используемые в параметрах HTTP, определяют, шифруется ли трафик между шлюзом приложений и внутренними серверами (что обеспечивает сквозной доступ к протоколу SSL) или не шифруется.

Когда шлюз приложений отправляет исходный запрос на внутренний сервер, он учитывает все пользовательские настройки, внесенные в параметры HTTP, связанные с переопределением имени узла, пути и протокола. Это действие поддерживает сходство сеансов на основе файлов cookie, сток подключений, выбор имени узла из серверной части и т. д.

 >[!NOTE]
>Если серверный пул:
> - **Является общедоступной конечной точкой**, шлюз приложений использует его интерфейсный общедоступный IP-адрес для доступа к серверу. Если внешний IP-адрес внешнего интерфейса отсутствует, он назначается для исходящих внешних подключений.
> - **Содержит внутренне разрешаемое полное доменное имя или частный IP-адрес**. шлюз приложений направляет запрос на внутренний сервер с помощью его частных IP-адресов.
> - **Содержит внешнюю конечную точку или внешнее разрешаемое полное доменное имя**, шлюз приложений направляет запрос на внутренний сервер с помощью его внешнего общедоступного IP-адреса. Разрешение DNS основано на частной зоне DNS или пользовательском DNS-сервере, если он настроен, или использует DNS-сервер, предоставляемый Azure по умолчанию. Если внешний IP-адрес внешнего интерфейса отсутствует, он назначается для исходящих внешних подключений.

### <a name="modifications-to-the-request"></a>Изменения в запросе

Шлюз приложений вставляет четыре дополнительных заголовка во все запросы, прежде чем перенаправит запросы в серверную часть. Эти заголовки пересылаются по оси x, для, x-forwardd-, x-forwardd-Port и x-Original-Host. Формат заголовка x-forwardd-for представляет собой разделенный запятыми список IP: Port.

Допустимые значения для параметров x-Forwarded-имеет значение HTTP или HTTPS. X-forwardd-Port указывает порт, на котором запрос достигает шлюза приложений. Заголовок X-Original-host содержит исходный заголовок узла, с которым был получен запрос. Этот заголовок полезен в интеграции веб-сайтов Azure, где заголовок входящего узла изменяется до маршрутизации трафика в серверную часть. Если сходство сеансов включено в качестве варианта, то добавляется файл cookie сходства, управляемый шлюзом.

Шлюз приложений можно настроить для изменения заголовков с помощью [перезаписи заголовков HTTP](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers) или для изменения пути URI с помощью параметра переопределения пути. Тем не менее, если не настроить это, все входящие запросы будут перенаправлены в серверную часть.

## <a name="next-steps"></a>Следующие шаги

[Дополнительные сведения о компонентах шлюза приложений](application-gateway-components.md)
