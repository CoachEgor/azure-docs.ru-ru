---
title: Как работает шлюз приложения
description: В этой статье приводится информация о том, как шлюз приложения принимает входящие запросы и направляет их в бэкэнд.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 11/16/2019
ms.author: absha
ms.openlocfilehash: 84a7bdfb9f8f7c741140cbe2086149dff90db211
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80132982"
---
# <a name="how-an-application-gateway-works"></a>Как работает шлюз приложения

В этой статье объясняется, как шлюз приложения принимает входящие запросы и направляет их в бэкэнд.

![Как шлюз приложения принимает запрос](./media/how-application-gateway-works/how-application-gateway-works.png)

## <a name="how-an-application-gateway-accepts-a-request"></a>Как шлюз приложения принимает запрос

1. Перед тем, как клиент отправляет запрос на шлюз приложения, он разрешает доменное имя шлюза приложения с помощью сервера Domain Name System (DNS). Azure контролирует вход DNS, поскольку все шлюзы приложений находятся в домене azure.com.

2. Azure DNS возвращает клиенту IP-адрес, который является IP-адресом приложения.

3. Шлюз приложения принимает входящий трафик на одном или нескольких слушателях. Слушатель — это логическая сущность, которая проверяет запросы на подключение. Он настроен с IP-адресом, протоколом и номером порта для подключения клиентов к шлюзу приложения.

4. Если используется брандмауэр веб-приложений (WAF), шлюз приложения проверяет заголовки запросов и тело, если присутствует, на правила waF. Это действие определяет, является ли запрос действительным или угрозой безопасности. Если запрос действителен, он направляется в бэкэнд. Если запрос недействителен и WAF находится в режиме предотвращения, он блокируется как угроза безопасности. Если он находится в режиме Detection, запрос оценивается и регистрируется, но все равно переправляется на сервер бэкэнда.

Шлюз приложений Azure можно использовать как внутренний балансера нагрузки приложения или как балансер нагрузки приложения с интернетом. Интернет-шлюз приложений использует общедоступные IP-адреса. DNS-название интернет-шлюза приложения является общедоступным IP-адресом. В результате шлюзы приложений, находящихся в Интернете, могут направлять запросы клиентов в Интернет.

Внутренние шлюзы приложений используют только частные IP-адреса. Если вы используете [пользовательскую или частную зону DNS,](https://docs.microsoft.com/azure/dns/private-dns-overview)доменное имя должно быть внутренне разрешимо для частного IP-адреса шлюза приложения. Таким образом, внутренние балансоратели нагрузки могут направлять запросы от клиентов только с доступом к виртуальной сети для шлюза приложения.

## <a name="how-an-application-gateway-routes-a-request"></a>Как шлюз приложения направляет запрос

Если запрос действителен и не заблокирован WAF, шлюз приложения оценивает правило разгрома запроса, связанное с слушателем. Это действие определяет, к какому пулу бэкэнда следует направлять запрос.

На основе правила маршрутизации запросов шлюз приложения определяет, следует ли направлять все запросы на слушателя в определенный пул бэкэнда, запросы маршрутов в различные пулы бэкэнда на основе пути URL или перенаправлять запросы на другой порт или внешний сайт.
>[!NOTE]
>Правила обрабатываются в порядке, указанном на портале v1 SKU. 

Когда шлюз приложения выбирает пул бэкэнда, он отправляет запрос на один из здоровых серверов бэкэнда в пуле (y.y.y.y). Состояние сервера определяется зондом работоспособности. Если пул бэкэнда содержит несколько серверов, шлюз приложения использует алгоритм круговой маршрут для маршрутизании запросов между здоровыми серверами. Эта нагрузка уравновешивает запросы на серверах.

После того, как шлюз приложения определяет сервер бэкэнда, он открывает новую сессию TCP с сервером бэкэнда на основе настроек HTTP. В настройках HTTP указаны параметры протокола, портинга и другие настройки, связанные с реукторами, которые необходимы для создания нового сеанса с сервером бэкэнда.

Порт и протокол, используемые в настройках HTTP, определяют, шифруется ли трафик между шлюзом приложения и серверами бэкэнда (таким образом, выполняя сквозной TLS) или не зашифрован.

Когда шлюз приложения отправляет исходный запрос на сервер бэкэнда, он выполняет любую пользовательскую конфигурацию, выполненную в настройках HTTP, связанных с переопределением имени, пути и протокола. Это действие поддерживает сродство сеанса на основе файлов cookie, слив соединения, выбор имени хоста из бэкэнда и так далее.

 >[!NOTE]
>Если бэкэнд бассейн:
> - **Является общедоступной конечной точкой,** шлюз приложения использует свой передний общедоступный IP для достижения сервера. Если нет единого публичного IP-адреса, один назначается для исходящего внешнего подключения.
> - **Содержит внутренне разрешимый F-DN или частный IP-адрес,** шлюз приложения направляет запрос на сервер бэкэнда, используя его экземпляр частных IP-адресов.
> - **Содержит внешнюю конечную точку или внешне разрешимый F-DN,** шлюз приложения направляет запрос на сервер бэкэнда, используя свой общедоступный IP-адрес. Разрешение DNS основано на частной зоне DNS или пользовательском DNS-сервере, если он настроен, или он использует DNS, предоставленный Azure по умолчанию. Если нет единого публичного IP-адреса, один назначается для исходящего внешнего подключения.

### <a name="modifications-to-the-request"></a>Изменения в запросе

Шлюз приложения вставляет четыре дополнительных заголовка для всех запросов, прежде чем он перенаправляет запросы в бэкэнд. Эти заголовки x-forwarded-для, x-forwarded-proto, x-forwarded-port, и x-оригинальный-хозяин. Формат x-forwarded-for header представляет собой разделенный на запятую список IP:port.

Действительные значения для x-forwarded-proto являются HTTP или HTTPS. X-forwarded-port определяет порт, в котором запрос достиг шлюза приложения. Заголовок X-original-host содержит исходный заголовок хоста, с которым поступил запрос. Эта заголовок полезна для интеграции веб-сайта Azure, где входящий заголовок хоста изменяется до того, как трафик направляется в бэкэнд. Если сродство сеанса включено в качестве опции, то оно добавляет куки-печенье, управляемое шлюзом.

Вы можете настроить шлюз приложения для изменения заголовков с помощью [заголовков Rewrite HTTP](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers) или изменить путь URI с помощью параметра переопределения путей. Однако, если не настроить для этого, все входящие запросы проксики к бэкэнду.

## <a name="next-steps"></a>Дальнейшие действия

[Узнайте о компонентах шлюза приложений](application-gateway-components.md)
