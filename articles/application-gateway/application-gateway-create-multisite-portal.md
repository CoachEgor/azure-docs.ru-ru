---
title: Создание шлюза приложений с несколькими сайтами с помощью портала Azure | Документация Майкрософт
description: Узнайте, как создать шлюз приложений, на котором размещено несколько сайтов, с помощью портала Azure.
services: application-gateway
author: vhorne
manager: jpconnock
editor: tysonn
ms.service: application-gateway
ms.topic: article
ms.workload: infrastructure-services
ms.date: 01/26/2018
ms.author: victorh
ms.openlocfilehash: 85113a5007a171459b831684f584773ba4328b94
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "62122420"
---
# <a name="create-an-application-gateway-with-multiple-site-hosting-using-the-azure-portal"></a>Создание шлюза приложений с несколькими сайтами с помощью портала Azure

Чтобы настроить [размещение нескольких веб-сайтов](application-gateway-multi-site-overview.md) при создании [шлюза приложений](application-gateway-introduction.md), можно использовать портал Azure. В этом руководстве мы создадим внутренние пулы с использованием масштабируемых наборов виртуальных машин. Затем вы настроите прослушиватели и правила на основе принадлежащих вам доменов, чтобы обеспечить передачу веб-трафика на соответствующие серверы в пулах. В этом руководстве предполагается, что вам принадлежат несколько доменов. Для примера здесь используются домены *www\.contoso.com* и *www\.fabrikam.com*.

В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Создание шлюза приложений
> * создание виртуальных машин для внутренних серверов;
> * создание серверных пулов с внутренними серверами;
> * создание прослушивателей и правил маршрутизации;
> * создание записи CNAME в домене.

![Пример маршрутизации нескольких сайтов](./media/application-gateway-create-multisite-portal/scenario.png)

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com)

## <a name="create-an-application-gateway"></a>Создание шлюза приложений

Виртуальная сеть необходима для обмена данными между создаваемыми ресурсами. В этом примере создаются две подсети: одна для шлюза приложений, а другая — для внутренних серверов. Вы можете создать виртуальную сеть во время создания шлюза приложений.

1. Нажмите кнопку **Создать** в верхнем левом углу портала Azure.
2. Щелкните **Сети**, а затем в списке "Рекомендованные" выберите **Шлюз приложений**.
3. Введите следующие значения для шлюза приложений:

   - *myAppGateway* — для имени шлюза приложений.
   - *myResourceGroupAG* — для новой группы ресурсов.

     ![Создание шлюза приложений](./media/application-gateway-create-multisite-portal/application-gateway-create.png)

4. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **ОК**.
5. Щелкните **Выбрать виртуальную сеть**, выберите **Создать**, а затем введите следующие значения для виртуальной сети:

   - *myVNet* — имя виртуальной сети;
   - *10.0.0.0/16* — диапазон адресов виртуальной сети;
   - *myAGSubnet* — имя подсети;
   - *10.0.0.0/24* — диапазон адресов подсети.

     ![Создание виртуальной сети](./media/application-gateway-create-multisite-portal/application-gateway-vnet.png)

6. Нажмите кнопку **ОК**, чтобы создать виртуальную сеть и подсеть.
7. Щелкните **Выбрать общедоступный IP-адрес**, выберите **Создать**, а затем введите имя общедоступного IP-адреса. В этом примере общедоступный IP-адрес — *myAGPublicIPAddress*. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **ОК**.
8. Примите значения по умолчанию для конфигурации прослушивателя, оставьте брандмауэр веб-приложения отключенным и нажмите кнопку **ОК**.
9. Просмотрите параметры на странице сводки и нажмите кнопку **ОК**, чтобы создать сетевые ресурсы и шлюз приложений. Процесс создания шлюза приложений может занять несколько минут. Дождитесь успешного завершения развертывания, прежде чем переходить к следующему разделу.

### <a name="add-a-subnet"></a>Добавление подсети

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myVNet**.
2. Щелкните **Подсети**, а затем — **Подсеть**.

    ![Создание подсети](./media/application-gateway-create-multisite-portal/application-gateway-subnet.png)

3. Введите *myBackendSubnet* в качестве имени подсети и нажмите кнопку **ОК**.

## <a name="create-virtual-machines"></a>Создание виртуальных машин

В этом примере вы создадите две виртуальные машины, которые будут использоваться как внутренние серверы для шлюза приложений. Установите также сервер IIS на виртуальных машинах, чтобы проверить маршрутизацию трафика.

1. Нажмите кнопку **Создать**.
2. Щелкните **Вычисления**, а затем в списке "Рекомендованные" выберите **Windows Server 2016 Datacenter**.
3. Введите следующие значения для виртуальной машины:

    - *contosoVM* — имя виртуальной машины;
    - *azureuser* — для имени пользователя учетной записи администратора;
    - *Azure123456!* — пароль.
    - Щелкните **Use existing** (Использовать существующую), а затем выберите *myResourceGroupAG*.

4. Последовательно выберите **ОК**.
5. Выберите значение **DS1_V2** в качестве размера виртуальной машины и нажмите кнопку **Выбрать**.
6. Убедитесь, что выбрана виртуальная сеть **myVNet** и подсеть **myBackendSubnet**. 
7. Щелкните **Отключено**, чтобы отключить диагностику загрузки.
8. Нажмите кнопку **ОК**, просмотрите параметры на странице сводки и нажмите кнопку **Создать**.

### <a name="install-iis"></a>Установка служб IIS

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

1. Откройте интерактивную оболочку и убедитесь, что для нее задано значение **PowerShell**.

    ![Установка пользовательского расширения](./media/application-gateway-create-multisite-portal/application-gateway-extension.png)

2. Чтобы установить службы IIS, выполните на виртуальной машине следующие команды: 

    ```azurepowershell-interactive
    $publicSettings = @{ "fileUris" = (,"https://raw.githubusercontent.com/Azure/azure-docs-powershell-samples/master/application-gateway/iis/appgatewayurl.ps1");  "commandToExecute" = "powershell -ExecutionPolicy Unrestricted -File appgatewayurl.ps1" }
    Set-AzVMExtension `
      -ResourceGroupName myResourceGroupAG `
      -Location eastus `
      -ExtensionName IIS `
      -VMName contosoVM `
      -Publisher Microsoft.Compute `
      -ExtensionType CustomScriptExtension `
      -TypeHandlerVersion 1.4 `
      -Settings $publicSettings
    ```

3. Создайте вторую виртуальную машину и установите службы IIS, следуя только что выполненным инструкциям. Введите *fabrikamVM* в качестве имени и значения VMName в Set-AzVMExtension.

## <a name="create-backend-pools-with-the-virtual-machines"></a>Создание серверных пулов с виртуальными машинами

1. Выберите **Все ресурсы** и щелкните **myAppGateway**.
2. Выберите **Серверные пулы** и нажмите кнопку **Добавить**.
3. Введите имя *contosoPool* и добавьте цель *contosoVM* с помощью команды **Добавить цель**.

    ![Добавление внутренних серверов](./media/application-gateway-create-multisite-portal/application-gateway-multisite-backendpool.png)

4. Последовательно выберите **ОК**.
5. Выберите **Серверные пулы** и нажмите кнопку **Добавить**.
6. Создайте *fabrikamPool* для *fabrikamVM*, выполнив операции, перечисленные выше.

## <a name="create-listeners-and-routing-rules"></a>Создание прослушивателей и правил маршрутизации

1. Нажмите кнопку **Прослушиватели** и нажмите кнопку **Несколько сайтов**.
2. Введите следующие значения для прослушивателя:
    
   - *contosoListener* — имя прослушивателя.
   - *www\.contoso.com* -замените имя домена в этом примере имя узла.

3. Последовательно выберите **ОК**.
4. Создайте второй прослушиватель, используя имя *fabrikamListener*, и укажите второе доменное имя. В этом примере *www\.fabrikam.com* используется.

Правила обрабатываются в том порядке, в котором они указаны, а трафик направляется через первое подходящее правило, независимо от точности. Например, если для одного порта имеется правило с базовым прослушивателем и правило с многосайтовым прослушивателем, для обеспечения правильной работы правило с многосайтовым прослушивателем должно быть указано перед правилом с базовым прослушивателем. 

В этом примере создаются два новых правила и удаляется правило по умолчанию, которое было сгенерировано при создании шлюза приложений. 

1. Щелкните **Правила** и выберите **Базовые**.
2. Укажите *contosoRule* для имени.
3. Выберите *contosoListener* для прослушивателя.
4. Выберите *contosoPool* для внутреннего пула.

    ![Создание правила на основе пути](./media/application-gateway-create-multisite-portal/application-gateway-multisite-rule.png)

5. Последовательно выберите **ОК**.
6. Создайте второе правило, используя имена *fabrikamRule*, *fabrikamListener* и *fabrikamPool*.
7. Удалите правило по умолчанию с именем *rule1*, щелкнув его и выбрав команду **Удалить**.

## <a name="create-a-cname-record-in-your-domain"></a>Создание записи CNAME в домене

После создания шлюза приложений с общедоступным IP-адресом можно получить DNS-адрес и использовать его для создания записи CNAME в своем домене. Использовать записи A не рекомендуется, так как виртуальный IP-адрес может измениться после перезапуска шлюза приложений.

1. Выберите **Все ресурсы** и щелкните **myAGPublicIPAddress**.

    ![Запись DNS-адреса шлюза приложений](./media/application-gateway-create-multisite-portal/application-gateway-multisite-dns.png)

2. Скопируйте DNS-адрес и используйте его в качестве значения для новой записи CNAME в своем домене.

## <a name="test-the-application-gateway"></a>Тестирование шлюза приложений

1. В адресной строке браузера введите имя домена. Например, http://www.contoso.com.

    ![Проверка сайта contoso в шлюзе приложений](./media/application-gateway-create-multisite-portal/application-gateway-iistest.png)

2. Введите адрес другого домена. Результат должен быть примерно таким:

    ![Проверка сайта fabrikam в шлюзе приложений](./media/application-gateway-create-multisite-portal/application-gateway-iistest2.png)

## <a name="next-steps"></a>Дальнейшие действия

Из этой статьи вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание шлюза приложений
> * создание виртуальных машин для внутренних серверов;
> * создание серверных пулов с внутренними серверами;
> * создание прослушивателей и правил маршрутизации;
> * создание записи CNAME в домене.

> [!div class="nextstepaction"]
> [Дополнительные сведения о возможностях шлюза приложений](application-gateway-introduction.md)
