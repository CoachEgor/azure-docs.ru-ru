---
title: Завершение TLS с сертификатами Azure Key Vault
description: Узнайте, как интегрировать шлюз приложений Azure с Key Vault для сертификатов сервера, подключенных к прослушивателям с поддержкой HTTPS.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 4/25/2019
ms.author: victorh
ms.openlocfilehash: 934cf854b0c526ed994c7dc91763f65de64fd14b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81617510"
---
# <a name="tls-termination-with-key-vault-certificates"></a>Завершение TLS с сертификатами Key Vault

[Azure Key Vault](../key-vault/general/overview.md) — это хранилище секретов, управляемое платформой, которое можно использовать для защиты секретов, ключей и сертификатов TLS/SSL. Шлюз приложений Azure поддерживает интеграцию с Key Vault для сертификатов сервера, подключенных к прослушивателям с поддержкой HTTPS. Эта поддержка ограничена номером SKU шлюза приложений версии 2.

Интеграция Key Vault предлагает две модели для завершения TLS:

- Можно явно предоставить сертификаты TLS/SSL, подключенные к прослушивателю. Эта модель является традиционным способом передачи сертификатов TLS/SSL в шлюз приложений для завершения TLS.
- При создании прослушивателя с поддержкой HTTPS можно дополнительно указать ссылку на существующий Key Vault сертификат или секрет.

Интеграция шлюза приложений с Key Vault предлагает множество преимуществ, в том числе:

- Более высокий уровень безопасности, поскольку сертификаты TLS/SSL не обрабатываются группой разработчиков приложений напрямую. Интеграция позволяет отдельной группе безопасности:
  * Настройте шлюзы приложений.
  * Управление жизненным циклом шлюза приложений.
  * Предоставьте выбранным шлюзам приложений разрешения на доступ к сертификатам, хранящимся в хранилище ключей.
- Поддержка импорта существующих сертификатов в хранилище ключей. Или используйте Key Vault API для создания новых сертификатов и управления ими с любыми доверенными партнерами Key Vault.
- Поддержка автоматического продления сертификатов, хранящихся в хранилище ключей.

Сейчас шлюз приложений поддерживает только сертификаты, проверенные программным обеспечением. Аппаратный модуль безопасности (HSM) — проверенные сертификаты не поддерживаются. После того как шлюз приложений настроен для использования сертификатов Key Vault, его экземпляры получают сертификат из Key Vault и устанавливают их локально для завершения TLS. Кроме того, экземпляры опрашиваются Key Vault с интервалом в 24 часа, чтобы получить обновленную версию сертификата, если он существует. Если найден обновленный сертификат, то сертификат TLS/SSL, который сейчас связан с прослушивателем HTTPS, автоматически поворачивается.

> [!NOTE]
> Портал Azure поддерживает только сертификаты KeyVault, а не секреты. Шлюз приложений по-прежнему поддерживает ссылки на секреты из KeyVault, но только через ресурсы, не относящиеся к порталу, такие как PowerShell, CLI, API, шаблоны ARM и т. д. 

## <a name="how-integration-works"></a>Как работает интеграция

Для интеграции шлюза приложений с Key Vault требуется процесс настройки, сопоставленный с тремя шагами:

1. **Создание управляемого удостоверения, назначаемого пользователем**

   Вы создаете или повторно используете существующее назначенное пользователем управляемое удостоверение, которое шлюз приложений использует для получения сертификатов от Key Vault от вашего имени. Дополнительные сведения см. в статье [что такое управляемые удостоверения для ресурсов Azure?](../active-directory/managed-identities-azure-resources/overview.md). На этом шаге создается новое удостоверение в клиенте Azure Active Directory. Удостоверение является доверенным для подписки, которая используется для создания удостоверения.

1. **Настройка хранилища ключей**

   Затем импортируйте существующий сертификат или создайте новый в хранилище ключей. Сертификат будет использоваться приложениями, которые выполняются через шлюз приложений. На этом шаге можно также использовать секрет хранилища ключей, который хранится в виде PFX-файла в формате "без пароля", с основанием 64. Рекомендуется использовать тип сертификата из-за возможности автопродления, доступной для объектов типа сертификата в хранилище ключей. После создания сертификата или секрета вы определяете политики доступа в хранилище ключей, *чтобы предоставить удостоверению доступ к* секрету.
   
   > [!NOTE]
   > Если вы развертываете шлюз приложений с помощью шаблона ARM, используя Azure CLI или PowerShell или через приложение Azure, развернутое из портал Azure, SSL-сертификат, хранящийся в хранилище ключей в качестве PFX-файла в кодировке Base 64, **должен быть без пароля**. Кроме того, необходимо выполнить действия, описанные в разделе [использование Azure Key Vault для передачи безопасного значения параметра во время развертывания](../azure-resource-manager/templates/key-vault-parameter.md). Особенно важно установить для `enabledForTemplateDeployment` `true`значение.

1. **Настройка шлюза приложений**

   После выполнения двух предыдущих шагов можно настроить или изменить существующий шлюз приложений для использования управляемого удостоверения, назначенного пользователем. Можно также настроить SSL-сертификат прослушивателя HTTP, чтобы он указывал на полный URI Key Vault сертификата или секретного идентификатора.

   ![Сертификаты хранилища ключей](media/key-vault-certs/ag-kv.png)

## <a name="next-steps"></a>Дальнейшие шаги

[Настройка завершения TLS с использованием Key Vault сертификатов с помощью Azure PowerShell](configure-keyvault-ps.md)
