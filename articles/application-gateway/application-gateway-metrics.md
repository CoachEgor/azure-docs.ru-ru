---
title: Метрики Azure Monitor для шлюза приложений
description: Узнайте, как использовать метрики для мониторинга производительности шлюза приложений.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 8/29/2019
ms.author: absha
ms.openlocfilehash: 12759deb3e1775b5170d40cc609fe8c6226bf0d6
ms.sourcegitcommit: af6847f555841e838f245ff92c38ae512261426a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2020
ms.locfileid: "76704584"
---
# <a name="metrics-for-application-gateway"></a>Метрики для шлюза приложений

Шлюз приложений публикует точки данных, называемые метриками, для [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) производительности шлюзов приложений и серверных экземпляров. Эти метрики представляют собой числовые значения в упорядоченном наборе данных временных рядов, которые описывают некоторые аспекты шлюза приложений в определенный момент времени. При наличии запросов, передаваемых через шлюз приложений, он измеряет и отправляет его метрики через 60-секундный интервал. Если нет запросов, передаваемых через шлюз приложений, или нет данных для метрики, метрика не сообщается. Дополнительные сведения см. в статье [Обзор метрик в Microsoft Azure](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform-metrics).

## <a name="metrics-supported-by-application-gateway-v2-sku"></a>Метрики, поддерживаемые SKU шлюза приложений версии 2

### <a name="timing-metrics"></a>Метрики времени

Доступны следующие метрики, связанные с временем запроса и ответа. Анализируя эти метрики для конкретного прослушивателя, можно определить, замедление работы приложения в связи с глобальной сетью, шлюзом приложений, сетью между шлюзом приложений и внутренним приложением или производительностью серверных приложений.

> [!NOTE]
>
> Если в шлюзе приложений имеется более одного прослушивателя, то всегда фильтруйте по измерению *прослушивателя* , сравнивая различные метрики задержки, чтобы получить осмысленное определение.

- **Время соединения серверной части**

  Время, затраченное на установление соединения с серверным приложением. Сюда входит задержка сети, а также время, затраченное стеком TCP внутреннего сервера для установки новых соединений. В случае SSL также включает время, затраченное на подтверждение. 

- **Время ответа первого байта внутреннего сервера**

  Интервал времени между началом установления соединения с внутренним сервером и получения первого байта заголовка ответа. Это приблизительная сумма *времени соединения* и времени ответа серверной части приложения (время, затраченное сервером на создание содержимого, получение запросов к базе данных и начало передачи ответа обратно в шлюз приложений).

- **Время последнего ответа серверной части**

  Интервал времени между началом установления соединения с внутренним сервером и получения последнего байта текста ответа. Это приблизительно соответствует сумме времени *отклика первого байта* сервера и времени передачи данных (это значение может сильно различаться в зависимости от размера запрошенных объектов и задержки серверной сети).

- **Общее время шлюза приложений**

  Среднее время, затрачиваемое на обработку запроса и отправку ответа. Это значение вычисляется как среднее значение интервала с момента, когда шлюз приложений получает первый байт HTTP-запроса до момента завершения операции отправки ответа, что приблизительно соответствует сумме времени обработки шлюза приложений и *времени ответа последнего байта серверной части* .

- **RTT клиента**

  Среднее время кругового пути между клиентами и шлюзом приложений. Эта метрика указывает, сколько времени требуется для установления соединений и возврата подтверждений. 

Эти метрики можно использовать для определения того, является ли наблюдаемое снижение задолжением из-за использования шлюза приложений, сети и внутреннего сервера TCP-стека, производительности внутреннего приложения или большого размера файла.
Например, если имеется пиковое время ответа на первый байт, но время соединения серверной части является постоянным, то можно вывести, что шлюз приложений в серверную задержку, а также время, затраченное на установление соединения, будет стабильным, а пик будет вызван из-за n увеличение времени отклика серверной части приложения. Аналогично, если пиковое время ответа для первого байта сервера связано с соответствующим пик во время внутреннего соединения, то можно вывести, что сеть или серверный стек TCP перегружены. Если вы заметили пиковое время ответа на сервер за последний байт, но время ответа для первого байта внутреннего сервера равно константе, то наиболее вероятно, что пик из-за большого запрашиваемого файла. Аналогичным образом, если общее время для шлюза приложений превышает время последнего ответа серверной части, это может быть признаком узкого места производительности в шлюзе приложений.



### <a name="application-gateway-metrics"></a>Метрики шлюза приложений

Для шлюза приложений доступны следующие метрики:

- **Получено байт**

   Число байтов, полученных шлюзом приложений от клиентов

- **Отправлено байт**

   Число байтов, отправленных шлюзом приложений клиентам

- **Клиентский протокол TLS**

   Число запросов TLS и не-TLS, инициированных клиентом, который установил подключение к шлюзу приложений. Чтобы просмотреть распределение протокола TLS, отфильтруйте его по протоколу измерения TLS.

- **Текущие единицы мощности**

   Число потребленных единиц емкости. Единицы мощности измеряют стоимость на основе потребления, которая будет взиматься в дополнение к фиксированным затратам. Существует три определителями к единицам вычислений единицы измерения емкости, постоянным подключениям и пропускной способности. Каждая единица емкости состоит не более чем за 1 единицу вычислений или с пропускной способностью 2,22 2500 Мбит/с.

- **Текущие единицы вычислений**

   Количество потребленных ресурсов процессора. Факторы, влияющие на единицу вычислений, — это TLS-подключения/с, вычисление перезаписи URL-адресов и обработка правил WAF. 

- **Текущие соединения**

   Число текущих установленных подключений к шлюзу приложений

- **Невыполненные запросы**

   Число невыполненных запросов, обслуживаемых шлюзом приложений. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.


- **Состояние ответа**

   Состояние ответа HTTP, возвращенное шлюзом приложений. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Пропускная способность**

   Количество байтов в секунду, обрабатываемых шлюзом приложений

- **Всего запросов**

   Число успешных запросов, обслуживаемых шлюзом приложений. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.

- **Правила, соответствующие брандмауэру веб-приложения**

- **Правила, активируемые брандмауэром веб-приложения**

### <a name="backend-metrics"></a>Серверные метрики

Для шлюза приложений доступны следующие метрики:

- **Состояние ответа серверной части**

  Число кодов состояния HTTP-ответа, возвращаемых на концах. Сюда не входят коды ответов, созданные шлюзом приложений. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Количество работоспособных узлов**

  Число конечных элементов, которые определены работоспособными для проверки работоспособности. Можно выполнить фильтрацию по серверному пулу для отображения работоспособных и неработоспособных узлов в определенном серверном пуле.

- **Число неработоспособных узлов**

  Число последовательностей, которые определяются неработоспособностью пробы работоспособности. Для отображения неработоспособных узлов в определенном внутреннем пуле можно выполнить фильтрацию по отдельности для каждого внутреннего пула.

## <a name="metrics-supported-by-application-gateway-v1-sku"></a>Метрики, поддерживаемые SKU шлюза приложений версии 1

### <a name="application-gateway-metrics"></a>Метрики шлюза приложений

Для шлюза приложений доступны следующие метрики:

- **Загрузка ЦП**

  Показывает использование ЦП, выделенного для шлюза приложений.  При нормальных условиях загрузка ЦП не должна регулярно превышать 90%, так как это может привести к задержкам на веб-сайтах, размещенных за шлюзом приложений, и нарушить работу клиента. Можно косвенно управлять или повысить загрузку ЦП, изменив конфигурацию шлюза приложений, увеличив число экземпляров или переместив на больший размер SKU или выполнив оба этих действия.

- **Текущие соединения**

  Число текущих установленных подключений к шлюзу приложений

- **Невыполненные запросы**

  Число невыполненных запросов, обслуживаемых шлюзом приложений. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.

- **Состояние ответа**

  Состояние ответа HTTP, возвращенное шлюзом приложений. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Пропускная способность**

  Количество байтов в секунду, обрабатываемых шлюзом приложений

- **Всего запросов**

  Число успешных запросов, обслуживаемых шлюзом приложений. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.

- **Правила, соответствующие брандмауэру веб-приложения**

- **Правила, активируемые брандмауэром веб-приложения**

### <a name="backend-metrics"></a>Серверные метрики

Для шлюза приложений доступны следующие метрики:

- **Количество работоспособных узлов**

  Число конечных элементов, которые определены работоспособными для проверки работоспособности. Можно выполнить фильтрацию по серверному пулу для отображения работоспособных и неработоспособных узлов в определенном серверном пуле.

- **Число неработоспособных узлов**

  Число последовательностей, которые определяются неработоспособностью пробы работоспособности. Для отображения неработоспособных узлов в определенном внутреннем пуле можно выполнить фильтрацию по отдельности для каждого внутреннего пула.

## <a name="metrics-visualization"></a>Визуализация метрик

Перейдите к шлюзу приложений, в разделе **мониторинг** выберите **метрики**. Чтобы просмотреть доступные значения, выберите раскрывающийся список **Метрика**.

На следующем изображении приведен пример с тремя метриками, отображаемыми в течение последних 30 минут:

[![](media/application-gateway-diagnostics/figure5.png "Metric view")](media/application-gateway-diagnostics/figure5-lb.png#lightbox)

Текущий список метрик доступен на странице [Метрики, поддерживаемые Azure Monitor](../azure-monitor/platform/metrics-supported.md).

### <a name="alert-rules-on-metrics"></a>Правила генерации оповещений для метрик

Вы можете запустить правила генерации оповещений на основе метрик для ресурса. Например, оповещение может вызвать веб-перехватчик или отправить электронное сообщение администратору, если пропускная способность шлюза приложений будет больше или меньше порогового значения в указанный период времени либо равной этому значению.

Приведенный ниже пример поможет вам создать правило генерации оповещений, согласно которому администратору отправляется электронное сообщение в случае нарушения порога пропускной способности.

1. Щелкните **Добавить оповещение метрики** , чтобы открыть страницу **Добавление правила** . Эту страницу можно также получить на странице метрики.

   ![Кнопка "Добавить оповещение метрики"][6]

2. На странице **Добавление правила** заполните разделы имя, условие и уведомление и нажмите кнопку **ОК**.

   * С помощью селектора **Условие** выберите одно из четырех значений: **Больше**, **Больше или равно**, **Меньше** или **Меньше или равно**.

   * С помощью селектора **Период** выберите интервал от 5 минут до 6 часов.

   * Если установить флажок **Участники, читатели и владельцы электронной почты**, можно будет отправлять электронные сообщения в динамическом режиме пользователям, у которых есть доступ к этому ресурсу. В противном случае можно указать список пользователей с разделителями-запятыми в текстовом поле **Дополнительные адреса электронной почты администратора**.

   ![Страница "Добавление правила"][7]

При нарушении порога вы получите примерно такое электронное сообщение:

![Сообщение электронной почты о нарушении порога][8]

После создания оповещения метрики появится список оповещений. В нем содержатся все правила генерации оповещений.

![Список оповещений и правил][9]

Дополнительные сведения об уведомлениях для оповещений см. в статье [Что такое оповещения в Microsoft Azure?](../monitoring-and-diagnostics/insights-receive-alert-notifications.md)

Чтобы лучше понять, как действуют веб-перехватчики и как их использовать с оповещениями, см. статью [Настройка веб-перехватчиков для оповещений на основе метрик Azure](../azure-monitor/platform/alerts-webhooks.md).

## <a name="next-steps"></a>Дальнейшие действия

* См. сведения о визуализации журналов счетчиков и событий с помощью [журналов Azure Monitor](../azure-monitor/insights/azure-networking-analytics.md).
* Прочтите запись блога [Visualize your Azure Activity Log with Power BI](https://blogs.msdn.com/b/powerbi/archive/2015/09/30/monitor-azure-audit-logs-with-power-bi.aspx) (Визуализация журналов действий Azure с помощью Power BI).
* Прочтите запись блога [View and analyze Azure Audit Logs in Power BI and more](https://azure.microsoft.com/blog/analyze-azure-audit-logs-in-powerbi-more/) (Просмотр и анализ журналов аудита Azure с помощью Power BI и других средств).

[1]: ./media/application-gateway-diagnostics/figure1.png
[2]: ./media/application-gateway-diagnostics/figure2.png
[3]: ./media/application-gateway-diagnostics/figure3.png
[4]: ./media/application-gateway-diagnostics/figure4.png
[5]: ./media/application-gateway-diagnostics/figure5.png
[6]: ./media/application-gateway-diagnostics/figure6.png
[7]: ./media/application-gateway-diagnostics/figure7.png
[8]: ./media/application-gateway-diagnostics/figure8.png
[9]: ./media/application-gateway-diagnostics/figure9.png
[10]: ./media/application-gateway-diagnostics/figure10.png
