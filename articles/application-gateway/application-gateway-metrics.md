---
title: Метрики Azure Monitor для шлюза приложений
description: Узнайте, как использовать метрики для мониторинга производительности шлюза приложений
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 2/5/2019
ms.author: absha
ms.openlocfilehash: ebbdda39f019f374f8e5abe951d0180c0dd453f6
ms.sourcegitcommit: b55d7c87dc645d8e5eb1e8f05f5afa38d7574846
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81457881"
---
# <a name="metrics-for-application-gateway"></a>Метрики для шлюза приложений

Приложение Gateway публикует точки данных, называемые метриками, в [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) для производительности шлюза приложений и экземпляров бэкэнда. Эти метрики представляют собой числовые значения в упорядоченном наборе данных временных рядов, описывающие некоторые аспекты шлюза приложения в определенное время. Если есть запросы, протекающие через шлюз приложения, он измеряет и отправляет свои метрики через 60-секундные интервалы. Если нет запросов, протекающих через шлюз приложения или нет данных для метрики, метрика не сообщается. Для получения дополнительной информации смотрите [метрики Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/platform/data-platform-metrics).

## <a name="metrics-supported-by-application-gateway-v2-sku"></a>Метрики, поддерживаемые Application Gateway V2 SKU

### <a name="timing-metrics"></a>Метели сроков

Application Gateway предоставляет несколько встроенных метрик времени, связанных с запросом и ответом, которые измеряются в миллисекундах. 

![](./media/application-gateway-metrics/application-gateway-metrics.png)

> [!NOTE]
>
> Если в шлюзе приложения есть более одного слушателя, то всегда фильтруйте измерение *слушателя,* сравнивая различные метрики задержки, чтобы получить содержательный вывод.

- **Время бэкэнда подключения**

  Время, затраченное на установление связи с приложением бэкэнда. 

  Это включает в себя задержку сети, а также время, затравореное tCP стек сервера бэкэнда для создания новых соединений. В случае TLS, он также включает в себя время, проведенное на рукопожатие. 

- **Бэкэнд первый байт время отклика**

  Интервал времени между началом создания соединения с сервером бэкэнда и получением первого байта заголовка ответа. 

  Это приближает сяпь-кону сумму *времени подключения Backend,* время, затраеденное запросом на достижение бэкэнда из приложения Gateway, время, затраенное бэкэнд-приложением для ответа (время, затраедевавенное сервером на генерацию содержимого, потенциальное получение запросов базы данных) и время, затраенное первым байтом ответа на достижение шлюза приложения из бэкэнда.

- **Бэкэнд последний байт время отклика**

  Интервал времени между началом создания соединения с сервером бэкэнда и получением последнего байта тела отклика. 

  Это приближает сумму *времени отклика Backend first byte* и время передачи данных (это число может сильно варьироваться в зависимости от размера запрашиваемых объектов и задержки серверной сети).

- **Общее время применения шлюза**

  Среднее время, необходимое для получения, обработки запроса и отправки его ответа. 

  Это интервал с момента, когда шлюз приложения получает первый байт запроса HTTP до времени, когда последний байт был отправлен клиенту. Это включает в себя время обработки, затрагиваемые Gateway приложения, *Backend последний байт время ответа,* время, затраеваемые приложением шлюз для отправки всех ответов и *клиент RTT*.

- **Клиент RTT**

  Среднее время в пути между клиентами и шлюзом приложения.



Эти метрики могут быть использованы для определения того, связано ли наблюдаемое замедление с клиентской сетью, производительностью шлюза приложений, насыщением бэкэнд-сервера TCP и сервером TCP, производительностью бэкэнд-приложения или большим размером файла.

Например, если есть всплеск в *Бэкэнд первый байт время отклика тенденция,* но *Backend подключить время* тенденция стабильна, то можно сделать вывод, что шлюз приложения для задержки бэкэнда и время, задействовавшее, чтобы установить соединение является стабильным, и всплеск вызван из-за увеличения времени отклика бэкэнда приложения. С другой стороны, если всплеск времени *отклика Backend первого байта* связан с соответствующим всплеском *времени подключения Backend,* то можно сделать вывод, что либо сеть между шлюзом приложения и сервером бэкэнда, либо стек бэкэнда TCP насыщен. 

Если вы заметили всплеск в *Backend последний байт время отклика,* но *Backend первый байт время отклика* является стабильным, то можно сделать вывод, что всплеск из-за большего файла запрашивается.

Аналогичным образом, если *общее время полного времени шлюза приложения* имеет пик, но время *отклика Backend last byte* является стабильным, то это может быть либо признаком узкого места производительности в шлюзе приложения, либо узким местом в сети между клиентом и шлюзом приложения. Кроме того, если *клиент RTT* также имеет соответствующий всплеск, то это означает, что деградация происходит из-за сети между клиентом и шлюзом приложения.

### <a name="application-gateway-metrics"></a>Показатели шлюза приложений

Для шлюза приложений доступны следующие метрики:

- **Байты получены**

   Граф байтов, полученных Порталом Приложения от клиентов

- **Байты отправлены**

   Граф байтов, отправленных порталом приложения клиентам

- **Протокол клиента TLS**

   Количество запросов TLS и не-TLS, инициированных клиентом, установиввшим связь с шлюзом приложения. Для просмотра распределения протоколов TLS отфильтруйте по измерению протокола TLS.

- **Единицы текущей емкости**

   Количество единиц емкости, потребляемых для загрузки баланса трафика. Есть три детерминанта для блока емкости - вычислительный блок, постоянные соединения и пропускная способность. Каждая единица емкости состоит не более того: 1 вычислительный блок, или 2500 постоянных соединений, или пропускная способность 2,22 Мбит/с.

- **Текущие вычислительные единицы**

   Подсчет потребляемой емкости процессора. Факторами, влияющими на вычислительный блок, являются соединения TLS/sec, вычисления URL-переписок и обработка правил WAF. 

- **Текущие подключения**

   Общее количество одновременных подключений, активных от клиентов к шлюзу приложения
   
- **Расчетные единицы билльоспособности**

  С v2 SKU модель ценообразования определяется потреблением. Единицы емкости измеряют стоимость, основанную на потреблении, которая взимается в дополнение к фиксированной стоимости. *Расчетные единицы биллингового потенциала* указывают на количество единиц емкости, с помощью которых оценивается выставление счетов. Это рассчитывается как большее значение между *единицами текущей емкости* (единицы емкости, необходимые для загрузки баланса трафика) и *фиксированными единицами оплачиваемой емкости* (единицы минимальной емкости, сохраненные в резервировании).

- **Неудачные запросы**

  Количество запросов, которые приложение Шлюз служил с 5xx коды ошибок сервера. Это включает в себя 5xx коды, которые генерируются из шлюза приложения, а также 5xx коды, которые генерируются из бэкэнда. Количество запросов может быть дополнительно отфильтровано, чтобы показать количество на каждую/конкретную комбинацию настройки пула-http.
   
- **Фиксированные единицы платежеспособной емкости**

  Минимальное количество единиц емкости, сохраненное в настройках *единиц минимальной шкалы* (один экземпляр переводится как 10 единиц емкости) в конфигурации портала приложений.
   
 - **Новые соединения в секунду**

   Среднее количество новых подключений TCP в секунду, установленных от клиентов до шлюза приложения и от шлюза приложения до бэкэнда.


- **Состояние ответа.**

   Статус ответа HTTP возвращается шлюзом приложения. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Пропускная способность**

   Количество байтов в секунду, обрабатываемых шлюзом приложений

- **Всего запросов**

   Подсчитывайте успешные запросы, которые обслуживаются Прикладным шлюзом. Количество запросов может быть дополнительно отфильтровано, чтобы показать количество на каждую/конкретную комбинацию настройки пула-http.

### <a name="backend-metrics"></a>Показатели бэкэнда

Для шлюза приложений доступны следующие метрики:

- **Статус ответа бэкэнда**

  Количество кодов статусов ответов HTTP, возвращенных бэкэндами. Это не включает в себя коды ответов, генерируемые шлюзом приложения. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Количество работоспособных узлов**

  Количество бэкэндов, которые определяются здоровым зондом здоровья. Вы можете фильтровать на основе пула бэкэнда, чтобы показать количество здоровых хостов в определенном пуле бэкэнда.

- **Количество неработоспособных узлов**

  Количество бэкэндов, которые определяются нездоровым зондом здоровья. Вы можете отфильтровать на основе пула бэкэнда, чтобы показать количество нездоровых хостов в определенном пуле бэкэнда.
  
- **Запросы в минуту на здорового хозяина**

  Среднее количество запросов, полученных каждым здоровым членом в пуле бэкэнда за минуту. Необходимо указать пул бэкэнда, используя *измерение Backendpool HttpSettings.*  
  

## <a name="metrics-supported-by-application-gateway-v1-sku"></a>Метрики, поддерживаемые Application Gateway V1 SKU

### <a name="application-gateway-metrics"></a>Показатели шлюза приложений

Для шлюза приложений доступны следующие метрики:

- **Использование процессора**

  Отображает использование процессоров, выделенных на шлюз приложения.  При нормальных условиях использование процессора не должно регулярно превышать 90%, так как это может привести к задержке на веб-сайтах, размещенных за шлюзом приложения, и нарушить работу клиента. Можно косвенно контролировать или улучшать использование процессора, изменяя конфигурацию шлюза приложения, увеличивая количество экземпляров или перейдя к большему размеру SKU или делая и то, и другое.

- **Текущие подключения**

  Число текущих установленных подключений к шлюзу приложений

- **Неудачные запросы**

  Количество запросов, которые приложение Шлюз служил с 5xx коды ошибок сервера. Это включает в себя 5xx коды, которые генерируются из шлюза приложения, а также 5xx коды, которые генерируются из бэкэнда. Количество запросов может быть дополнительно отфильтровано, чтобы показать количество на каждую/конкретную комбинацию настройки пула-http.

- **Состояние ответа.**

  Статус ответа HTTP возвращается шлюзом приложения. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Пропускная способность**

  Количество байтов в секунду, обрабатываемых шлюзом приложений

- **Всего запросов**

  Подсчитывайте успешные запросы, которые обслуживаются Прикладным шлюзом. Количество запросов может быть дополнительно отфильтровано, чтобы показать количество на каждую/конкретную комбинацию настройки пула-http.

- **Веб-приложение Брандмауэр Заблокированные Запросы Отсчет**
- **Веб-приложение Firewall заблокирован ораспространении запросов**
- **Веб-приложение Firewall Полное распределение правил**

### <a name="backend-metrics"></a>Показатели бэкэнда

Для шлюза приложений доступны следующие метрики:

- **Количество работоспособных узлов**

  Количество бэкэндов, которые определяются здоровым зондом здоровья. Вы можете фильтровать на основе пула бэкэнда, чтобы показать количество здоровых хостов в определенном пуле бэкэнда.

- **Количество неработоспособных узлов**

  Количество бэкэндов, которые определяются нездоровым зондом здоровья. Вы можете отфильтровать на основе пула бэкэнда, чтобы показать количество нездоровых хостов в определенном пуле бэкэнда.

## <a name="metrics-visualization"></a>Визуализация метрик

Просмотр шлюза приложения под **мониторингом** выбора **метрики.** Чтобы просмотреть доступные значения, выберите раскрывающийся список **Метрика**.

На следующем изображении приведен пример с тремя метриками, отображаемыми в течение последних 30 минут:

[![](media/application-gateway-diagnostics/figure5.png "Metric view")](media/application-gateway-diagnostics/figure5-lb.png#lightbox)

Текущий список метрик доступен на странице [Метрики, поддерживаемые Azure Monitor](../azure-monitor/platform/metrics-supported.md).

### <a name="alert-rules-on-metrics"></a>Правила оповещения по метрикам

Вы можете запустить правила генерации оповещений на основе метрик для ресурса. Например, оповещение может вызвать веб-перехватчик или отправить электронное сообщение администратору, если пропускная способность шлюза приложений будет больше или меньше порогового значения в указанный период времени либо равной этому значению.

Приведенный ниже пример поможет вам создать правило генерации оповещений, согласно которому администратору отправляется электронное сообщение в случае нарушения порога пропускной способности.

1. Выберите **предупреждение метрики,** чтобы открыть страницу **правила Добавить.** Вы также можете выйти на эту страницу со страницы метрик.

   ![Кнопка "Добавить оповещение метрики"][6]

2. На странице **правила Добавить** заполните имя, состояние и уведомите разделы и выберите **OK.**

   * С помощью селектора **Условие** выберите одно из четырех значений: **Больше**, **Больше или равно**, **Меньше** или **Меньше или равно**.

   * С помощью селектора **Период** выберите интервал от 5 минут до 6 часов.

   * Если установить флажок **Участники, читатели и владельцы электронной почты**, можно будет отправлять электронные сообщения в динамическом режиме пользователям, у которых есть доступ к этому ресурсу. В противном случае можно указать список пользователей с разделителями-запятыми в текстовом поле **Дополнительные адреса электронной почты администратора**.

   ![Добавление страницы правил][7]

При нарушении порога вы получите примерно такое электронное сообщение:

![Сообщение электронной почты о нарушении порога][8]

После создания оповещения метрики появится список оповещений. В нем содержатся все правила генерации оповещений.

![Список оповещений и правил][9]

Дополнительные сведения об уведомлениях для оповещений см. в статье [Что такое оповещения в Microsoft Azure?](../monitoring-and-diagnostics/insights-receive-alert-notifications.md)

Чтобы лучше понять, как действуют веб-перехватчики и как их использовать с оповещениями, см. статью [Настройка веб-перехватчиков для оповещений на основе метрик Azure](../azure-monitor/platform/alerts-webhooks.md).

## <a name="next-steps"></a>Следующие шаги

* См. сведения о визуализации журналов счетчиков и событий с помощью [журналов Azure Monitor](../azure-monitor/insights/azure-networking-analytics.md).
* [Визуализируйте свой журнал активности Azure с](https://blogs.msdn.com/b/powerbi/archive/2015/09/30/monitor-azure-audit-logs-with-power-bi.aspx) помощью блога Power BI.
* Прочтите запись блога [View and analyze Azure Audit Logs in Power BI and more](https://azure.microsoft.com/blog/analyze-azure-audit-logs-in-powerbi-more/) (Просмотр и анализ журналов аудита Azure с помощью Power BI и других средств).

[1]: ./media/application-gateway-diagnostics/figure1.png
[2]: ./media/application-gateway-diagnostics/figure2.png
[3]: ./media/application-gateway-diagnostics/figure3.png
[4]: ./media/application-gateway-diagnostics/figure4.png
[5]: ./media/application-gateway-diagnostics/figure5.png
[6]: ./media/application-gateway-diagnostics/figure6.png
[7]: ./media/application-gateway-diagnostics/figure7.png
[8]: ./media/application-gateway-diagnostics/figure8.png
[9]: ./media/application-gateway-diagnostics/figure9.png
[10]: ./media/application-gateway-diagnostics/figure10.png
