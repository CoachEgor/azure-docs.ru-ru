---
title: Настраиваемые правила брандмауэра веб-приложения Azure (WAF) v2
description: В этой статье представлен обзор настраиваемых правил брандмауэра веб-приложения (WAF) версии 2 в шлюзе приложений Azure.
services: application-gateway
ms.topic: article
author: vhorne
ms.service: application-gateway
ms.date: 6/18/2019
ms.author: victorh
ms.openlocfilehash: 154317e558c2c9a22f569f569684cced467900d5
ms.sourcegitcommit: f2d9d5133ec616857fb5adfb223df01ff0c96d0a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2019
ms.locfileid: "71937464"
---
# <a name="custom-rules-for-web-application-firewall-v2"></a>Настраиваемые правила для брандмауэра веб-приложения версии 2

Брандмауэр веб-приложения шлюза приложений Azure (WAF) версии 2 поставляется с предварительно настроенным, управляемым платформой набором правил, который обеспечивает защиту от различных типов атак. Эти атаки включают межсайтовые сценарии, внедрение кода SQL и другие. Если вы являетесь администратором WAF, вам может потребоваться написать собственные правила, чтобы расширить правила набора правил (CR). Правила могут блокировать или разрешать запрошенный трафик на основе критериев сопоставления.

Настраиваемые правила позволяют создавать собственные правила, которые оцениваются для каждого запроса, который проходит через WAF. Эти правила содержат более высокий приоритет, чем остальные правила в наборах управляемых правил. Пользовательские правила содержат имя правила, приоритет правила и массив условий сопоставления. Если эти условия выполнены, предпринимается действие (для разрешения или блокировки).

Например, можно заблокировать все запросы с IP-адреса в диапазоне 192.168.5.4/24. В этом правиле оператором является *ипматч*, матчвалуес — диапазон IP-адресов (192.168.5.4/24), а действие — блокировать трафик. Вы также задаете имя и приоритет правила.

Настраиваемые правила поддерживают использование логики объединения для создания более сложных правил, которые удовлетворяют требованиям безопасности. Например, (условие 1 **и** условие 2) **или** условие 3).  Этот пример означает, что если условие 1 **и** условие 2 выполнены **или** условие 3 выполняется, WAF должен принять действие, указанное в настраиваемом правиле.

Разные условия сопоставления в рамках одного правила всегда составны с помощью **и**. Например, можно заблокировать трафик с определенного IP-адреса и только в том случае, если они используют определенный браузер.

Если требуется **или** два условия, два условия должны быть в разных правилах. Например, можно блокировать трафик с определенного IP-адреса или блокировать трафик, если они используют конкретный браузер.

> [!NOTE]
> Максимальное число настраиваемых правил WAF — 100. Дополнительные сведения об ограничениях шлюза приложений см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md#application-gateway-limits).

Регулярные выражения также поддерживаются в пользовательских правилах, как и в наборах правил CR. Примеры см. в примерах 3 и 5 в статье [Создание и использование настраиваемых правил брандмауэра веб-приложения](create-custom-waf-rules.md).

## <a name="allowing-vs-blocking"></a>Разрешение и блокировка

Разрешить и заблокировать трафик просто с помощью настраиваемых правил. Например, можно заблокировать весь трафик, поступающий из диапазона IP-адресов. Можно сделать еще одно правило, разрешающее трафик, если запрос поступает из конкретного браузера.

Чтобы разрешить что-либо, убедитесь, что параметр `-Action` имеет значение **allow**. Чтобы заблокировать что-либо, убедитесь, что параметр `-Action` имеет значение **Block**.

```azurepowershell
$AllowRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example1 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Allow

$BlockRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example2 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Block
```

Предыдущий `$BlockRule` сопоставляется со следующим пользовательским правилом в Azure Resource Manager:

```json
"customRules": [
      {
        "name": "blockEvilBot",
        "priority": 2,
        "ruleType": "MatchRule",
        "action": "Block",
        "matchConditions": [
          {
            "matchVariables": [
              {
                "variableName": "RequestHeaders",
                "selector": "User-Agent"
              }
            ],
            "operator": "Contains",
            "negationConditon": false,
            "matchValues": [
              "evilbot"
            ],
            "transforms": [
              "Lowercase"
            ]
          }
        ]
      }
    ], 
```

Это пользовательское правило содержит имя, приоритет, действие и массив условий соответствия, которые должны быть выполнены для выполнения действия. Более подробное описание этих полей см. в следующих описаниях полей. Примеры пользовательских правил см. в разделе [Создание и использование пользовательских правил брандмауэра веб-приложения](create-custom-waf-rules.md).

## <a name="fields-for-custom-rules"></a>Поля для настраиваемых правил

### <a name="name-optional"></a>Имя [необязательно]

Это имя правила. Это имя появится в журналах.

### <a name="priority-required"></a>Priority [обязательный]

- Определяет порядок, в котором оцениваются правила. Чем ниже значение, тем выше оценка правила. Допустимый диапазон — от 1-100. 
- Должно быть уникальным среди всех настраиваемых правил. Правило с приоритетом 40 будет оцениваться перед правилом с приоритетом 80.

### <a name="rule-type-required"></a>Тип правила [обязательный]

В настоящее время должен быть **матчруле**.

### <a name="match-variable-required"></a>Match, переменная [обязательный]

Должна быть одной из переменных:

- Ремотеаддр — IP-адрес или имя узла для подключения к удаленному компьютеру
- Рекуестмесод — метод запроса HTTP (GET, POST, WHERE, DELETE и т. д.).
- QueryString — переменная в URI
- I args — аргументы, отправляемые в теле сообщения POST. Пользовательские правила, использующие эту переменную соответствия, применяются только в том случае, если для заголовка Content-Type задано значение Application/x-www-Form-UrlEncoded ' и ' multipart/form-data '.
- RequestUri — URI запроса.
- RequestHeaders — заголовки запроса
- RequestBody — содержит весь текст запроса целиком. Пользовательские правила, использующие эту переменную соответствия, применяются только в том случае, если для заголовка Content-Type задано значение Application/x-www-Form-UrlEncoded. 
- Рекуесткукиес — файлы Cookie запроса;

### <a name="selector-optional"></a>Selector [необязательно]

Описывает поле коллекции Матчвариабле. Например, если Матчвариабле имеет значение RequestHeaders, то селектор может находиться в заголовке *User-Agent* .

### <a name="operator-required"></a>Operator [обязательный]

Должен быть одним из следующих операторов:

- Ипматч используется только в том случае, если переменная match имеет *ремотеаддр*
- Equals — входные данные совпадают с Матчвалуе
- Содержит
- LessThan;
- GreaterThan
- LessThanOrEqual;
- GreaterThanOrEqual;
- Начинается с
- endsWith
- Регулярное выражение

### <a name="negate-condition-optional"></a>Условие отрицания [необязательно]

Инвертирует текущее условие.

### <a name="transform-optional"></a>Преобразование [необязательно]

Список строк с именами преобразований, которые необходимо выполнить до попытки сопоставления. Это могут быть следующие преобразования:

- Нижний регистр
- Trim
- урлдекоде
- UrlEncode 
- ремовенуллс
- хтмлентитидекоде

### <a name="match-values-required"></a>Совпадение значений [обязательный]

Список значений для сопоставления, которые можно рассматривать как " *или*" ED. Например, это могут быть IP-адреса или другие строки. Формат значения зависит от оператора Previous.

### <a name="action-required"></a>Действие [обязательный]

- Разрешить — разрешает транзакцию, пропуская все последующие правила. Это означает, что указанный запрос добавляется в список разрешений и после сопоставления запрос прекращает дальнейшую оценку и отправляется во внутренний пул. Правила, которые находятся в списке разрешений, не оцениваются для дополнительных настраиваемых правил или управляемых правил.
- Block — блокирует транзакцию на основе *секдефаултактион* (режим обнаружения и предотвращения). Как и действие Allow, после вычисления запроса и добавления в список блокировок вычисление останавливается и запрос блокируется. Любой запрос, удовлетворяющий тем же условиям, не будет оцениваться и будет просто заблокирован. 
- Log — позволяет правилу записывать в журнал, но позволяет выполнять остальные правила для оценки. Последующие пользовательские правила оцениваются в порядке приоритета, за которыми следуют управляемые правила.

## <a name="next-steps"></a>Следующие шаги

После получения сведений о настраиваемых правилах [Создайте собственные настраиваемые правила](create-custom-waf-rules.md).
