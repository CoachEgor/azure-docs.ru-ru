---
title: Azure настраиваемых правил брандмауэра веб-приложения (WAF)
description: В этой статье Обзор брандмауэра веб-приложения (WAF) настраиваемых правил в шлюзе приложений Azure.
services: application-gateway
ms.topic: article
author: vhorne
ms.service: application-gateway
ms.date: 6/5/2019
ms.author: victorh
ms.openlocfilehash: 62259749e04d66d78206a0bba77ce88f2c08c82f
ms.sourcegitcommit: 6932af4f4222786476fdf62e1e0bf09295d723a1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/05/2019
ms.locfileid: "66689006"
---
# <a name="custom-rules-for-web-application-firewall"></a>Настраиваемые правила для брандмауэра веб-приложения

> [!IMPORTANT]
> Настраиваемые правила WAF шлюза приложений Azure в данный момент общедоступной предварительной версии. **Настраиваемые правила, доступны только для WAF_v2 SKU**.
> Эта общедоступная предварительная версия предоставляется без соглашения об уровне обслуживания и не должна использоваться в рабочей среде. Некоторые функции могут не поддерживаться, иметь ограничения и быть доступными не во всех расположениях Azure. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Брандмауэр веб-приложения шлюза приложений Azure (WAF) поставляется с предварительно настроенных, управляемых с помощью платформы набора правил, который обеспечивает защиту от многих различных типов атак. Такие атаки включают кросс-сценарии, внедрение кода SQL и другие. Если вы являетесь администратором WAF, можно писать собственные правила для дополнения основных правила набора правил (CRS). Правила можно заблокировать или разрешить запрошенный трафика в зависимости от условия соответствия.

Настраиваемые правила позволяют создавать собственные правила, которые вычисляются для каждого запроса, который проходит через брандмауэр веб-приложения. Эти правила хранения более высокий приоритет, чем остальные правила в наборы правил для управляемого кода. Настраиваемые правила содержат имя правила, приоритет правила и массив соответствующих условий. Если эти условия выполняются, действие выполняются (чтобы разрешить или запретить).

Например вы можете заблокировать все запросы от IP-адрес в диапазоне 192.168.5.4/24. В этом правиле является оператор *IPMatch*matchValues — это диапазон IP-адресов (192.168.5.4/24) и действие — заблокировать этот трафик. Можно также задать имя и приоритет правила.

Настраиваемые правила поддерживают использование объединения логику для создания более сложных правил этот адрес, требованиям к безопасности. Например (условие 1 **и** условие 2) **или** условие 3).  В этом примере означает, что если условие 1 **и** условие 2 выполняются, **или** если соблюдается условие 3, брандмауэр веб-приложения следует выполнить действие, заданное в настраиваемом правиле.

Разные условия сопоставления, в то же правило всегда актуальны и для с помощью **и**. Например, блокировать трафик с определенного IP-адреса, и только в том случае, если они используют обозреватель определенного.

Если вы хотите **или** два различных условия, два условия должны находиться в разные правила. Например блокировать трафик из определенных IP-адрес или блок трафика, если они используют конкретного браузера.

> [!NOTE]
> Максимальное число настраиваемых правил WAF — 100. Дополнительные сведения об ограничениях на шлюзе приложений см. в разделе [подписки Azure и ограничения служб, квоты и ограничения](../azure-subscription-service-limits.md#application-gateway-limits).

Регулярные выражения также поддерживаются в настраиваемые правила, так же, как в наборы правил CRS. Примеры из них см. в примерах 3 и 5 в [Создание и использование правил брандмауэра пользовательского веб-приложения](create-custom-waf-rules.md).

## <a name="allowing-vs-blocking"></a>Разрешение и блокировка

Разрешение и блокировка трафика упрощен благодаря настраиваемые правила. Например можно блокировать весь трафик, передаваемый из диапазона IP-адресов. Вы можете сделать еще одно правило, разрешающее трафик, если запрос поступает от конкретного браузера.

Чтобы разрешить что-нибудь, убедитесь, что `-Action` параметр имеет значение **Разрешить**. Чтобы запретить что-нибудь, убедитесь, что `-Action` параметр имеет значение **блок**.

```azurepowershell
$AllowRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example1 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Allow

$BlockRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example2 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Block
```

Предыдущий `$BlockRule` сопоставляется следующей настраиваемое правило в Azure Resource Manager:

```json
"customRules": [
      {
        "name": "blockEvilBot",
        "priority": 2,
        "ruleType": "MatchRule",
        "action": "Block",
        "matchConditions": [
          {
            "matchVariables": [
              {
                "variableName": "RequestHeaders",
                "selector": "User-Agent"
              }
            ],
            "operator": "Contains",
            "negationConditon": false,
            "matchValues": [
              "evilbot"
            ],
            "transforms": [
              "Lowercase"
            ]
          }
        ]
      }
    ], 
```

Этого настраиваемого правила содержит имя, приоритет, действие и массив соответствующих условий, которые должны быть выполнены для действия вступили в силу. Более подробное описание этих полей см. следующие описания полей. Пример настраиваемых правил см. в разделе [Создание и использование правил брандмауэра пользовательского веб-приложения](create-custom-waf-rules.md).

## <a name="fields-for-custom-rules"></a>Поля для настраиваемых правил

### <a name="name-optional"></a>Имя [необязательно]

Это имя правила. Это имя отображается в журналах.

### <a name="priority-required"></a>Приоритет [обязательный параметр]

- Определяет правила оцениваются в порядке. Чем ниже значение, тем раньше оценки правила.
— Должен быть уникальным среди всех настраиваемых правил. Правило с приоритетом 100 оценивается перед правилом с приоритетом 200.

### <a name="rule-type-required"></a>Тип правила [обязательный параметр]

В настоящее время должно быть **MatchRule**.

### <a name="match-variable-required"></a>Переменную сопоставления [обязательный параметр]

Должен быть одной из переменных:

- RemoteAddr – IP адрес или имя узла подключение к удаленному компьютеру
- RequestMethod — метод HTTP-запроса (GET, POST, PUT, DELETE и т. д.)
- Строка запроса — переменной в URI
- PostArgs — аргументы отправляются в тело запроса POST
- RequestUri — URI запроса
- RequestHeaders — заголовки запроса
- RequestBody — текст запроса
- RequestCookies — файлы cookie запроса

### <a name="selector-optional"></a>Селектор [необязательно]

Описывает поле matchVariable коллекции. Например, если matchVariable RequestHeaders, область выделения может быть на *User-Agent* заголовка.

### <a name="operator-required"></a>Оператор [обязательный параметр]

Должен быть одним из следующих операторов:

- IPMatch - используется, только если переменной совпадение является *RemoteAddr*
- Equals — ввода совпадает со значением MatchValue
- Содержит
- LessThan;
- GreaterThan
- LessThanOrEqual;
- GreaterThanOrEqual;
- Начинается с
- endsWith
- Регулярное выражение

### <a name="negate-condition-optional"></a>Инверсия условие [необязательно]

Инвертирует текущим состоянием.

### <a name="transform-optional"></a>Преобразования [необязательно]

Выполняется попытка список строк с именами преобразований для выполнения до соответствия. Это могут быть следующие преобразования:

- Нижний регистр
- Trim
- UrlDecode
- UrlEncode 
- RemoveNulls
- HtmlEntityDecode

### <a name="match-values-required"></a>Совпадают со значениями [обязательный параметр]

Список значений для сопоставления, который может рассматриваться как *или*"ed. Например возможно, IP-адреса или другие строки. Формат значения зависит от предыдущего оператора.

### <a name="action-required"></a>Действия [обязательный параметр]

- Разрешить — разрешает транзакции, пропуск всех последующих правил. Это означает, что указанный запрос добавляется в список разрешенных и после соответствия для дальнейшей оценки запроса останавливается и отправляется во внутренний пул. Правила, которые находятся в списке разрешений не оценила все дополнительные настраиваемые правила или управляемых правил.
- Блок — блокирует транзакции на основе *SecDefaultAction* (режим обнаружения/предотвращения). Так же, как действие "Разрешить" после оценки запроса, который добавляется в список блокировок, вычисление останавливается, а запрос заблокирован. Любой запрос после, удовлетворяющие условиям же не будет вычислено и просто будут заблокированы. 
- Журнал — позволяет записывать в журнал правила, а также позволяет остальные правила выполнения для оценки. Последующие настраиваемые правила оцениваются в порядке приоритета, следуют управляемого правила.

## <a name="next-steps"></a>Дальнейшие действия

Когда вы узнаете о настраиваемых правил [создать собственные настраиваемые правила](create-custom-waf-rules.md).
