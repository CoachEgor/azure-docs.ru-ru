---
title: Настраиваемые правила брандмауэра веб-приложения Azure (WAF) v2
description: В этой статье представлен обзор настраиваемых правил брандмауэра веб-приложения (WAF) версии 2 в шлюзе приложений Azure.
services: application-gateway
ms.topic: article
author: vhorne
ms.service: application-gateway
ms.date: 6/18/2019
ms.author: victorh
ms.openlocfilehash: 8ae5c9b6b52ea13e3d0981664e8c920cc5b47a01
ms.sourcegitcommit: b4665f444dcafccd74415fb6cc3d3b65746a1a31
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2019
ms.locfileid: "72263558"
---
# <a name="overview-custom-rules-for-web-application-firewall-v2"></a>Рассматриваемые действия: Настраиваемые правила для брандмауэра веб-приложения версии 2

Брандмауэр веб-приложения шлюза приложений Azure (WAF) версии 2 поставляется с предварительно настроенным набором правил, управляемым платформой, который обеспечивает защиту от различных типов атак. Эти атаки включают межсайтовые сценарии, внедрение кода SQL и другие. Если вы являетесь администратором WAF, вам может потребоваться написать собственные правила для расширения правил базового набора правил. Правила могут блокировать или разрешать запрошенный трафик на основе критериев сопоставления.

С помощью настраиваемых правил можно создавать собственные правила, которые оцениваются для каждого запроса, который проходит через WAF. Эти правила содержат более высокий приоритет, чем остальные правила в наборах управляемых правил. Пользовательские правила содержат имя правила, приоритет правила и массив условий сопоставления. Если эти условия выполнены, выполняется действие для разрешения или блокировки.

Например, можно создать правило для блокировки всех запросов с IP-адреса в диапазоне 192.168.5.4/24. В этом правиле оператором является *ипматч*, *матчвалуес* — диапазон IP-адресов (192.168.5.4/24), а *действие* — блокировать трафик. Вы также задаете имя и приоритет правила.

Настраиваемые правила поддерживают использование логики объединения для создания более сложных правил, которые удовлетворяют требованиям безопасности. Например, "(условие 1 *и* условие 2) *или* условие 3)" означает, что если условие 1 *и* условие 2 выполнены, *или* если условие 3 выполняется, WAF должен принять действие, указанное в настраиваемом правиле.

Разные условия сопоставления в рамках одного правила всегда составны с помощью *и*. Например, правило, которое использует *и* может затребовать блокировку трафика с определенного IP-адреса и только в том случае, если используется определенный браузер.

Если вы хотите использовать *или* для двух различных условий, два условия должны находиться в разных правилах. Например, правило, которое использует *или* может затребовать блокировку трафика с определенного IP-адреса или блокировать трафик, если используется определенный браузер.

> [!NOTE]
> Максимальное число настраиваемых правил WAF — 100. Дополнительные сведения об ограничениях шлюза приложений см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-subscription-service-limits.md#application-gateway-limits).

Регулярные выражения также поддерживаются в пользовательских правилах так же, как и в основных наборах правил. Примеры этих правил см. в разделе "Пример 3" и "Пример 5" раздела [Создание и использование настраиваемых правил брандмауэра веб-приложения](create-custom-waf-rules.md).

## <a name="allowing-or-blocking-traffic"></a>Разрешение или блокировка трафика

Разрешение или блокирование трафика осуществляется просто с помощью настраиваемых правил. Например, можно заблокировать весь трафик, поступающий из диапазона IP-адресов. Можно сделать еще одно правило, разрешающее трафик, если запрос поступает из определенного браузера.

Чтобы разрешить что-либо, убедитесь, что параметр `-Action` имеет значение **allow**. Чтобы заблокировать что-либо, убедитесь, что параметр `-Action` имеет значение **Block**, как показано в следующем коде:

```azurepowershell
$AllowRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example1 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Allow

$BlockRule = New-AzApplicationGatewayFirewallCustomRule `
   -Name example2 `
   -Priority 2 `
   -RuleType MatchRule `
   -MatchCondition $condition `
   -Action Block
```

Предыдущий `$BlockRule` сопоставляется со следующим пользовательским правилом в Azure Resource Manager:

```json
"customRules": [
      {
        "name": "blockEvilBot",
        "priority": 2,
        "ruleType": "MatchRule",
        "action": "Block",
        "matchConditions": [
          {
            "matchVariables": [
              {
                "variableName": "RequestHeaders",
                "selector": "User-Agent"
              }
            ],
            "operator": "Contains",
            "negationConditon": false,
            "matchValues": [
              "evilbot"
            ],
            "transforms": [
              "Lowercase"
            ]
          }
        ]
      }
    ], 
```

Это пользовательское правило содержит имя, приоритет, действие и массив условий соответствия, которые должны быть выполнены для выполнения действия. Описание полей настраиваемых правил см. в следующих разделах. Примеры настраиваемых правил см. в разделе [Создание и использование пользовательских правил брандмауэра веб-приложения](create-custom-waf-rules.md).

## <a name="custom-rule-fields"></a>Поля настраиваемых правил

### <a name="name-optional"></a>Имя (необязательно)

Это имя правила. Имя отображается в журналах.

### <a name="priority-required"></a>Приоритет (обязательно)

- Приоритет определяет порядок, в котором оцениваются правила. Чем ниже значение, тем выше оценка правила. Допустимый диапазон — от 1 до 100.
- Приоритет должен быть уникальным для всех настраиваемых правил. Правило с приоритетом 40 оценивается перед правилом с приоритетом 80.

### <a name="rule-type-required"></a>Тип правила (обязательно)

В настоящее время тип правила должен быть **матчруле**.

### <a name="match-variable-required"></a>Переменная Match (обязательная)

Переменная соответствия должна быть одной из следующих:

- Ремотеаддр: IP-адрес или имя узла подключения удаленного компьютера
- Рекуестмесод: Метод HTTP-запроса (GET, POST, WHERE, DELETE и т. д.).
- Строку Переменная в URI.
- I args: Аргументы, отправляемые в теле сообщения POST. Настраиваемые правила, использующие эту переменную соответствия, применяются только в том случае, если для заголовка Content-Type задано значение Application/x-www-Form-UrlEncoded и "multipart/form-data".
- RequestUri URI запроса.
- RequestHeaders Заголовки запроса.
- RequestBody Переменная, содержащая весь текст запроса в целом. Пользовательские правила, использующие эту переменную соответствия, применяются только в том случае, если для заголовка Content-Type задано значение Application/x-www-Form-UrlEncoded. 
- Рекуесткукиес: Файлы Cookie запроса.

### <a name="selector-optional"></a>Селектор (необязательно)

Селектор описывает поле коллекции Матчвариабле. Например, если Матчвариабле имеет значение "RequestHeaders", селектор может находиться в заголовке User-Agent.

### <a name="operator-required"></a>Оператор (обязательно)

Оператор должен быть одним из следующих:

- Ипматч: Этот оператор используется только в том случае, если переменная match имеет значение *ремотеаддр*.
- Прошлом Входные данные совпадают с Матчвалуе.
- Содержит
- LessThan;
- GreaterThan
- LessThanOrEqual;
- GreaterThanOrEqual;
- Начинается с
- EndsWith
- Регулярное выражение

### <a name="negate-condition-optional"></a>Условие отрицания (необязательно)

Инвертирует текущее условие.

### <a name="transform-optional"></a>Преобразование (необязательно)

Список строк с именами преобразований, которые должны быть выполнены до попытки сопоставления. К преобразованиям относятся:

- Нижний регистр
- Trim
- урлдекоде
- UrlEncode 
- ремовенуллс
- хтмлентитидекоде

### <a name="match-values-required"></a>Совпадение значений (обязательно)

Поле Матчвалуес представляет собой список значений, в соответствии с которыми можно считать *или*' Ed. Например, значения могут быть IP-адресами или другими строками. Формат значения зависит от оператора Previous.

### <a name="action-required"></a>Действие (обязательно)

Поле Action (действие) предоставляет следующие возможности. 

- Разрешить. Авторизует транзакцию и пропускает все последующие правила. Это означает, что указанный запрос добавляется в список разрешений и, после его сопоставления, запрос прекращает дальнейшую оценку и отправляется в пул серверной части. Правила, которые находятся в списке разрешений, не оцениваются для дальнейших настраиваемых правил или управляемых правил.

- Блокировать. Блокирует транзакцию на основе *секдефаултактион* (режим обнаружения и предотвращения). Как и действие разрешить, после вычисления запроса и добавления в список блокировок вычисление останавливается и запрос блокируется. Последующие запросы, соответствующие тем же условиям, не оцениваются. Они заблокированы. 

- Журналь Позволяет правилу записывать в журнал и позволяет выполнять оставшиеся правила для оценки. Последующие пользовательские правила оцениваются в порядке приоритета, за которыми следуют управляемые правила.

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали о настраиваемых правилах, вы можете [создавать собственные настраиваемые правила](create-custom-waf-rules.md).
