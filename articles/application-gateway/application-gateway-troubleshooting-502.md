---
title: Устранение проблем ные ошибки Bad Gateway - Шлюз приложений Azure
description: 'Узнайте, как устранить неполадки application Gateway Server Error: 502 - Веб-сервер получил недействительный ответ, действуя в качестве шлюза или прокси-сервера.'
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 11/16/2019
ms.author: amsriva
ms.openlocfilehash: 17bed17b536f6e88fc821fd83e09a1d6ea218bc3
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74130476"
---
# <a name="troubleshooting-bad-gateway-errors-in-application-gateway"></a>Устранение ошибок "Недопустимый шлюз" в шлюзе приложений

Узнайте, как устранить ошибки, обнаруженные при использовании Azure Application Gateway.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор

После настройки шлюза приложения, одна из ошибок, которые вы можете увидеть, это "Ошибка сервера: 502 - Веб-сервер получил недействительный ответ, действуя в качестве шлюза или прокси-сервера". Эта ошибка может произойти по следующим основным причинам:

* NSG, UDR или Custom DNS блокируют доступ к бэкэнд-пулу.
* Задние виртуальные вывМ или экземпляры виртуального набора шкалы машин не реагируют на зонд работоспособности по умолчанию.
* недопустимая или неправильная конфигурация пользовательских проб работоспособности;
* Пул [бэк-энда](#empty-backendaddresspool)Azure Application Gateway не настроен или пуст.
* в [наборе масштабирования виртуальных машин нет работоспособных](#unhealthy-instances-in-backendaddresspool) экземпляров или виртуальных машин;
* [Запрашивайте тайм-аут или проблемы с подключением](#request-time-out) с запросами пользователей.

## <a name="network-security-group-user-defined-route-or-custom-dns-issue"></a>Проблема группы безопасности сети, определенного пользователем маршрута или пользовательской службы DNS

### <a name="cause"></a>Причина

Если доступ к бэкэнду заблокирован из-за NSG, UDR или пользовательских DNS, экземпляры шлюза приложений не могут достичь пула бэкэнда. Это приводит к сбоям зонда, что приводит к 502 ошибкам.

NSG/UDR может присутствовать либо в подсети шлюза приложения, либо в подсети, где развертываются VMs-приложения.

Аналогичным образом, наличие пользовательского DNS в VNet также может вызвать проблемы. ФзНД, используемый для членов пула бэкэнда, может не решить сятверо пользователем, настроенным DNS-сервером для VNet.

### <a name="solution"></a>Решение

Проверьте конфигурацию NSG, UDR и DNS, сделав следующее:

* Проверьте НСК, связанные с подсетью шлюза приложения. Убедитесь, что связь с бэкэндом не заблокирована.
* Проверьте UDR, связанный с подсетью шлюза приложения. Убедитесь, что UDR не направляет трафик от подсети бэкэнда. Например, проверьте маршрутизирование на сетевые виртуальные приборы или маршруты по умолчанию, рекламируемые в подсети шлюза приложения через ExpressRoute/VPN.

```azurepowershell
$vnet = Get-AzVirtualNetwork -Name vnetName -ResourceGroupName rgName
Get-AzVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
```

* Проверьте действующую NSG и маршрут с серверной виртуальной машиной.

```azurepowershell
Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName nic1 -ResourceGroupName testrg
Get-AzEffectiveRouteTable -NetworkInterfaceName nic1 -ResourceGroupName testrg
```

* Проверьте наличие пользовательской службы DNS в виртуальной сети. Службу DNS можно проверить, просмотрев подробности свойств виртуальной сети в выходных данных.

```json
Get-AzVirtualNetwork -Name vnetName -ResourceGroupName rgName 
DhcpOptions            : {
                           "DnsServers": [
                             "x.x.x.x"
                           ]
                         }
```
При наличии, убедитесь, что dNS-сервер может решить f-DN участника пула бэкэнда правильно.

## <a name="problems-with-default-health-probe"></a>Проблемы со стандартной пробой работоспособности

### <a name="cause"></a>Причина

502 ошибки также могут быть частыми индикаторами того, что зонд работоспособности по умолчанию не может достичь задних VMs.

Когда экземпляр шлюза приложения подготовлен, он автоматически настраивает зонд работоспособности по умолчанию для каждого BackendAddressPool, используя свойства BackendHttpSetting. Пользователю ничего не нужно вводить для настройки этой пробы. В частности, при настройке правила балансировки нагрузки создается связь между BackendHttpSetting и BackendAddressPool. Для каждой из этих ассоциаций настроен зонд по умолчанию, и шлюз приложения запускает периодическое подключение проверки работоспособности к каждому экземпляру в BackendAddressPool в порту, указанном в элементе BackendHttpSetting. 

В следующей таблице перечислены значения, связанные с зондом работоспособности по умолчанию:

| Свойства проверки | Значение | Описание |
| --- | --- | --- |
| URL-адрес проверки |`http://127.0.0.1/` |URL-адрес |
| Интервал |30 |Интервал проверки в секундах |
| Время ожидания |30 |Время ожидания проверки в секундах |
| Пороговое значение сбоя |3 |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

* Убедитесь, что стандартный сайт настроен и ожидает передачи данных по адресу 127.0.0.1.
* Если в параметре BackendHttpSetting задан порт, отличный от 80, на стандартном сайте нужно настроить ожидание передачи данных через этот порт.
* Вызов к `http://127.0.0.1:port` должен вернуть код результата HTTP 200. Это должно быть возвращено в течение 30-секундного периода тайм-аута.
* Убедитесь, что настроенный порт открыт и что нет никаких правил брандмауэра или групп безопасности сети Azure, которые блокируют входящий или исходящий трафик в настроенном порту.
* Если классические вм- связи Azure или облачные службы используются с помощью F-DN или общедоступного IP-адреса, убедитесь, что соответствующая [конечная точка](../virtual-machines/windows/classic/setup-endpoints.md?toc=%2fazure%2fapplication-gateway%2ftoc.json) открыта.
* Если VM настроен через Azure Resource Manager и находится за пределами VNet, где развертывается шлюз приложения, необходимо настроить [группу сетевой безопасности,](../virtual-network/security-overview.md) чтобы обеспечить доступ к нужному порту.

## <a name="problems-with-custom-health-probe"></a>Проблемы с пользовательскими пробами работоспособности

### <a name="cause"></a>Причина

Пользовательские пробы работоспособности более гибкие по сравнению со стандартными. При использовании пользовательских зондов можно настроить интервал зонда, URL-адрес, путь для тестирования, а также количество неудачных ответов, которые можно принять до маркировки экземпляра пула бэк-энда как неработоспособного.

Добавлены следующие дополнительные свойства:

| Свойства проверки | Описание |
| --- | --- |
| name |Имя проверки. Это имя используется для указания проверки в параметрах HTTP внутреннего сервера |
| Протокол |Протокол, используемый для проверки. Проба использует протокол, определенный в параметрах HTTP серверной части. |
| Узел |Имя узла для проверки. Применяется только тогда, когда мультисайт настроен на шлюзе приложения. (То есть указывается не имя узла виртуальной машины.) |
| путь |Относительный путь проверки. Путь должен начинаться с "/". Проба отправляется по адресу \<протокол\>://\<узел\>:\<порт\>\<путь\>. |
| Интервал |Интервал проверки в секундах. Интервал времени между двумя последовательными проверками. |
| Время ожидания |Время ожидания проверки в секундах. Если действительный ответ не получен в течение этого периода тайм-аута, зонд помечается как неудавшийся. |
| Пороговое значение сбоя |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

Настройте пользовательскую пробу производительности правильно, как описано в таблице выше. Кроме действий по устранению неполадок, описанных выше, требуется соблюдение следующих условий:

* проба указана правильно, согласно [руководству](application-gateway-create-probe-ps.md);
* Если шлюз приложения настроен для одного сайта, по умолчанию `127.0.0.1`имя хоста должно быть указано как, если иное не настроено в пользовательском зонде.
* Убедитесь, что вызов к http://\<узел\>:\<порт\>\<путь\> возвращает HTTP-код результата 200.
* Убедитесь, что Интервал, Таймаут и UnhealtyThreshold находятся в пределах допустимых диапазонов.
* При использовании зонда HTTPS убедитесь, что внутренний сервер не требует SNI путем настройки резервного сертификата.

## <a name="request-time-out"></a>Время ожидания запроса

### <a name="cause"></a>Причина

При получении запроса пользователем шлюз приложения применяет настроенные правила к запросу и направляет его в экземпляр пула бэк-энда. Затем в течение указанного интервала он ожидает отклик от серверного экземпляра. По умолчанию этот интервал составляет **20** секунд. Если шлюз приложения не получает ответа от бэк-энда приложения в этом интервале, пользовательский запрос получает ошибку 502.

### <a name="solution"></a>Решение

Приложение Gateway позволяет настроить эту настройку через BackendHttpSetting, который затем может быть применен к различным пулам. Различные пулы бэк-энда могут иметь различные BackendHttpSetting и настроен другой тайм-аут запроса.

```azurepowershell
    New-AzApplicationGatewayBackendHttpSettings -Name 'Setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled -RequestTimeout 60
```

## <a name="empty-backendaddresspool"></a>Пустой серверный пул адресов

### <a name="cause"></a>Причина

Если шлюз приложения не имеет виртуальных вс-кодов или виртуального набора масштаба машины, настроенного в пуле адресов бэк-энда, он не может направить любой запрос клиента и отправляет плохую ошибку шлюза.

### <a name="solution"></a>Решение

Убедитесь, что пул адресов бэк-энда не пуст. Это можно сделать с помощью PowerShell, интерфейса командной строки или на портале.

```azurepowershell
Get-AzApplicationGateway -Name "SampleGateway" -ResourceGroupName "ExampleResourceGroup"
```

Выходные данные командлета, приведенного выше, должны содержать непустой серверный пул адресов. В следующем примере показаны два возвращенных пула, которые настроены с помощью F-DN или IP-адресов для бэкэнд-вм: Состояние подготовки серверного пула адресов должно быть "Выполнено".

BackendAddressPoolsText:

```json
[{
    "BackendAddresses": [{
        "ipAddress": "10.0.0.10",
        "ipAddress": "10.0.0.11"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool01",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool01"
}, {
    "BackendAddresses": [{
        "Fqdn": "xyx.cloudapp.net",
        "Fqdn": "abc.cloudapp.net"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool02",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool02"
}]
```

## <a name="unhealthy-instances-in-backendaddresspool"></a>Неработоспособные экземпляры в серверном пуле адресов

### <a name="cause"></a>Причина

Если все экземпляры BackendAddressPool неработоспособны, то шлюз приложения не имеет бэк-энда для запроса пользователя. Это также может быть в случае, когда бэк-энд экземпляры являются здоровыми, но не имеют необходимого приложения развернуты.

### <a name="solution"></a>Решение

Сделайте экземпляры работоспособными и правильно настройте приложение. Проверьте, могут ли бэк-энд-инстанции ответить на пинг от другого VM в том же VNet. Если настроен с общедоступной конечной точкой, убедитесь, что запрос браузера в веб-приложении является пригодным для обслуживания.

## <a name="next-steps"></a>Дальнейшие действия

Если предыдущие шаги не устранят проблему, откройте [билет поддержки.](https://azure.microsoft.com/support/options/)

