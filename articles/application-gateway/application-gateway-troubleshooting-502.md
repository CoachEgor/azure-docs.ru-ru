---
title: Устранение ошибок Azure Application Gateway Недопустимый шлюз (502)
description: Из этой статьи вы узнаете, как устранять ошибки 502 шлюза приложений.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 4/25/2019
ms.author: amsriva
ms.openlocfilehash: 2a1c7e480e896da6852949c9d765d17290e4e9ce
ms.sourcegitcommit: 44a85a2ed288f484cc3cdf71d9b51bc0be64cc33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64697162"
---
# <a name="troubleshooting-bad-gateway-errors-in-application-gateway"></a>Устранение ошибок "Недопустимый шлюз" в шлюзе приложений

Узнайте, как устранить ошибки Недопустимый шлюз (502), полученных при использовании шлюза приложений Azure.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор

После настройки шлюза приложений, одна из ошибок, может появиться — «ошибка сервера: 502: веб-сервером в качестве шлюза или прокси-сервера получен недопустимый ответ". Эта ошибка может возникать по следующим причинам основных:

* NSG, UDR или пользовательская служба DNS блокирует доступ к участникам серверного пула.
* Серверные виртуальные машины или экземпляры масштабируемого набора виртуальной машины не отвечает на пробу работоспособности по умолчанию.
* недопустимая или неправильная конфигурация пользовательских проб работоспособности;
* Azure Application Gateway [внутреннего пула не настроен или пуст](#empty-backendaddresspool).
* в [наборе масштабирования виртуальных машин нет работоспособных](#unhealthy-instances-in-backendaddresspool) экземпляров или виртуальных машин;
* для пользовательских запросов [истекло время ожидания или возникли проблемы с подключением](#request-time-out).

## <a name="network-security-group-user-defined-route-or-custom-dns-issue"></a>Проблема группы безопасности сети, определенного пользователем маршрута или пользовательской службы DNS

### <a name="cause"></a>Причина:

Если доступ к серверной части заблокирован из-за NSG, UDR или пользовательской службой DNS, экземпляры шлюза приложений не может подключиться к серверному пулу. Это приводит к ошибкам проверки, приводит к ошибки 502.

NSG/UDR может присутствовать либо в подсети шлюза приложений или подсети, где развернуты виртуальные машины приложения.

Аналогичным образом наличие пользовательской службы DNS в виртуальной сети может также вызывать проблемы. Полное доменное имя, используемый для членов внутреннего пула могут быть не разрешаться правильно настроенный пользователем DNS-сервером для виртуальной сети.

### <a name="solution"></a>Решение

Проверьте конфигурацию NSG, UDR и DNS, сделав следующее:

* Проверьте группы безопасности сети, связанную с подсетью шлюза приложений. Убедитесь, что для обмена данными с серверной части не заблокирован.
* Проверьте, определяемый пользователем Маршрут, связанный с подсети шлюза приложений. Убедитесь, что UDR не направляют трафик из внутренней подсети. Например проверьте маршрутизацию к виртуальным устройствам сети или маршруты по умолчанию, объявляемые для подсети шлюза приложений через ExpressRoute или VPN.

```azurepowershell
$vnet = Get-AzVirtualNetwork -Name vnetName -ResourceGroupName rgName
Get-AzVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
```

* Проверьте действующую NSG и маршрут с серверной виртуальной машиной.

```azurepowershell
Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName nic1 -ResourceGroupName testrg
Get-AzEffectiveRouteTable -NetworkInterfaceName nic1 -ResourceGroupName testrg
```

* Проверьте наличие пользовательской службы DNS в виртуальной сети. Службу DNS можно проверить, просмотрев подробности свойств виртуальной сети в выходных данных.

```json
Get-AzVirtualNetwork -Name vnetName -ResourceGroupName rgName 
DhcpOptions            : {
                           "DnsServers": [
                             "x.x.x.x"
                           ]
                         }
```
При ее наличии убедитесь, что DNS-сервер может разрешить полное доменное имя участника пула серверной части правильно.

## <a name="problems-with-default-health-probe"></a>Проблемы со стандартной пробой работоспособности

### <a name="cause"></a>Причина:

ошибки 502 также может быть часто указывают, что стандартную пробу работоспособности не удается связаться с внутренних виртуальных машин.

При подготовке экземпляра шлюза приложения, автоматически настраивает стандартную пробу работоспособности для каждого серверного пула адресов, с помощью свойства параметра BackendHttpSetting. Пользователю ничего не нужно вводить для настройки этой пробы. В частности при настройке правила балансировки нагрузки осуществляется связь между параметром BackendHttpSetting и параметр BackendAddressPool. Проба по умолчанию настраивается для каждого из этих связей и шлюз приложений запускает подключение Проверка работоспособности периодического каждого экземпляра в серверном порт, указанный в параметре backendhttpsetting. 

В следующей таблице перечислены значения, связанные со стандартной пробой работоспособности:

| Свойства проверки | Value | ОПИСАНИЕ |
| --- | --- | --- |
| URL-адрес проверки |`http://127.0.0.1/` |URL-адрес |
| Interval |30 |Интервал проверки в секундах |
| Время ожидания |30 |Время ожидания проверки в секундах |
| Пороговое значение сбоя |3 |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

* Убедитесь, что стандартный сайт настроен и ожидает передачи данных по адресу 127.0.0.1.
* Если в параметре BackendHttpSetting задан порт, отличный от 80, на стандартном сайте нужно настроить ожидание передачи данных через этот порт.
* Вызов к `http://127.0.0.1:port` должен вернуть код результата HTTP 200. Это должно быть возвращено в течение периода ожидания 30 секунд.
* Убедитесь, что открыт порт, настроенный и что правила брандмауэра и групп безопасности сети Azure, которое блокирует входящий и исходящий трафик через настроенный порт.
* Если полное доменное имя или общедоступный IP-адрес используется классических виртуальных машин Azure или облачной службы, убедитесь, что соответствующий [конечной точки](../virtual-machines/windows/classic/setup-endpoints.md?toc=%2fazure%2fapplication-gateway%2ftoc.json) открыт.
* Если виртуальная машина настроена с помощью Azure Resource Manager и находится за пределами виртуальной сети, в которой развернут шлюз приложений, [группы безопасности сети](../virtual-network/security-overview.md) должен быть настроен доступ через нужный порт.

## <a name="problems-with-custom-health-probe"></a>Проблемы с пользовательскими пробами работоспособности

### <a name="cause"></a>Причина:

Пользовательские пробы работоспособности более гибкие по сравнению со стандартными. При использовании пользовательских проб можно настроить интервал, URL-адрес, путь для тестирования и сколько неудачных откликов, прежде чем пометить экземпляр внутреннего пула считается неработоспособным.

Добавлены следующие дополнительные свойства:

| Свойства проверки | ОПИСАНИЕ |
| --- | --- |
| ИМЯ |Имя проверки. Это имя используется для указания проверки в параметрах HTTP внутреннего сервера |
| Protocol |Протокол, используемый для проверки. Проба использует протокол, определенный в параметрах HTTP серверной части. |
| Узел |Имя узла для проверки. Применимо только при настройке нескольких сайтов в шлюзе приложений. (То есть указывается не имя узла виртуальной машины.) |
| Путь |Относительный путь проверки. Путь должен начинаться с "/". Проба отправляется по адресу \<протокол\>://\<узел\>:\<порт\>\<путь\>. |
| Interval |Интервал проверки в секундах. Интервал времени между двумя последовательными проверками. |
| Время ожидания |Время ожидания проверки в секундах. Если допустимый ответ не получен в течение этого времени ожидания, пробы отмечен как непройденный. |
| Пороговое значение сбоя |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

Настройте пользовательскую пробу производительности правильно, как описано в таблице выше. Кроме действий по устранению неполадок, описанных выше, требуется соблюдение следующих условий:

* проба указана правильно, согласно [руководству](application-gateway-create-probe-ps.md);
* Если шлюз приложений настроен для одного узла, по умолчанию узел имя должно указываться как `127.0.0.1`, если не задано в пользовательской пробы.
* Убедитесь, что вызов к http://\<узел\>:\<порт\>\<путь\> возвращает HTTP-код результата 200.
* Убедитесь, что интервал времени ожидания и значения находятся в допустимом диапазоне.
* При использовании зонда HTTPS убедитесь, что внутренний сервер не требует SNI путем настройки резервного сертификата.

## <a name="request-time-out"></a>Время ожидания запроса

### <a name="cause"></a>Причина:

При получении запроса пользователя шлюз приложений применяет настроенные правила к запросу и направляет его экземпляру серверного пула. Затем в течение указанного интервала он ожидает отклик от серверного экземпляра. По умолчанию этот интервал составляет **20** секунд. Если шлюз приложений не получает ответ из серверной части приложения в этом интервале, пользовательский запрос возвращает ошибки 502.

### <a name="solution"></a>Решение

Шлюз приложений позволяет настроить этот параметр с помощью параметра BackendHttpSetting, который затем можно применить к разным пулам. Разным пулам серверной части могут иметь разные BackendHttpSetting и разное время ожидания запроса настроен.

```azurepowershell
    New-AzApplicationGatewayBackendHttpSettings -Name 'Setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled -RequestTimeout 60
```

## <a name="empty-backendaddresspool"></a>Пустой серверный пул адресов

### <a name="cause"></a>Причина:

Если шлюз приложений не имеет виртуальные машины или масштабируемого набора виртуальных машин в пуле внутренних адресов, она не может отправлять запросы клиентов и отправляет ошибку недопустимого шлюза.

### <a name="solution"></a>Решение

Убедитесь, что пул адресов серверной части не пуста. Это можно сделать с помощью PowerShell, интерфейса командной строки или на портале.

```azurepowershell
Get-AzApplicationGateway -Name "SampleGateway" -ResourceGroupName "ExampleResourceGroup"
```

Выходные данные командлета, приведенного выше, должны содержать непустой серверный пул адресов. В следующем примере показано два пула, возвращаемый которого должны быть настроены полное доменное имя или IP-адресов для виртуальных машин внутреннего пула. Состояние подготовки серверного пула адресов должно быть "Выполнено".

BackendAddressPoolsText:

```json
[{
    "BackendAddresses": [{
        "ipAddress": "10.0.0.10",
        "ipAddress": "10.0.0.11"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool01",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool01"
}, {
    "BackendAddresses": [{
        "Fqdn": "xyx.cloudapp.net",
        "Fqdn": "abc.cloudapp.net"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool02",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool02"
}]
```

## <a name="unhealthy-instances-in-backendaddresspool"></a>Неработоспособные экземпляры в серверном пуле адресов

### <a name="cause"></a>Причина:

Если все экземпляры серверного пула адресов находятся в неработоспособном состоянии, шлюз приложений не имеет любой серверной части запрос пользователя маршрута. Это также может быть так, когда серверные экземпляры работоспособны, но не развернуто требуемое приложение.

### <a name="solution"></a>Решение

Сделайте экземпляры работоспособными и правильно настройте приложение. Проверьте, серверные экземпляры может отвечать на запрос проверки связи с другой виртуальной Машины в той же виртуальной сети. Если настроена общая конечная точка, убедитесь, что запрос браузера к веб-приложению подлежит обслуживанию.

## <a name="next-steps"></a>Дальнейшие действия

Если описанные выше шаги не удалось решить проблему, откройте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).

