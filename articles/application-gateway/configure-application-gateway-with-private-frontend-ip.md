---
title: Настройка конечной точки внутренней подсистемы балансировки нагрузки (ILB)
titleSuffix: Azure Application Gateway
description: В этой статье содержатся сведения о настройке шлюза приложений с частным интерфейсным IP-адресом.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: how-to
ms.date: 04/16/2020
ms.author: victorh
ms.openlocfilehash: 64dfe284772faf2a345b7959f1a1bd6f474cd1bf
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "90562491"
---
# <a name="configure-an-application-gateway-with-an-internal-load-balancer-ilb-endpoint"></a>Настройка шлюза приложений с конечной точкой внутренней подсистемы балансировки нагрузки (ILB)

Шлюз приложений Azure можно настроить с помощью виртуального IP-адреса с выходом в Интернет или внутренней конечной точки, которая не доступна в Интернете. Внутренняя конечная точка использует частный IP-адрес для внешнего интерфейса, который также называется *конечной точкой внутренней подсистемы балансировки нагрузки (ilB)*.

Настройка шлюза с помощью частного IP-адреса внешнего интерфейса полезна для внутренних бизнес-приложений, которые не доступны в Интернете. Он также полезен для служб и уровней в многоуровневом приложении, которые находятся в границах безопасности, которые не доступны в Интернете, но по-прежнему нуждаются в распределении нагрузки с циклическим перебором, закреплениях сеансов или TLS, ранее известной как SSL (SSL).

В этой статье описано, как настроить шлюз приложений с использованием частного IP-адреса внешнего интерфейса с помощью портал Azure.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу <https://portal.azure.com>.

## <a name="create-an-application-gateway"></a>Создание шлюза приложений

В Azure для обмена между создаваемыми ресурсами необходима виртуальная сеть. Вы можете создать новую виртуальную сеть или использовать существующую. В этом примере мы создадим виртуальную сеть. Вы можете создать виртуальную сеть во время создания шлюза приложений. Экземпляры Шлюза приложений создаются в отдельных подсетях. В этом примере создаются две подсети: одна — для шлюза приложений, а вторая — для внутренних серверов.

1. Разверните меню портала и выберите **создать ресурс**.
2. Выберите **Сети**, а затем в списке Рекомендованные выберите **Шлюз приложений**.
3. Для имени шлюза приложений введите *myAppGateway*, а для новой группы ресурсов — *myResourceGroupAG*.
4. В качестве **региона**выберите **(США) Центральная область США**.
5. Для **уровня**выберите **стандартный**.
6. В разделе **Настройка виртуальной сети** выберите **создать**и введите следующие значения для виртуальной сети:
   - *myVNet* — имя виртуальной сети;
   - *10.0.0.0/16* — диапазон адресов виртуальной сети;
   - *myAGSubnet* — имя подсети;
   - *10.0.0.0/24* — диапазон адресов подсети.
   - *myBackendSubnet* — для имени подсети сервера.
   - *10.0.1.0/24* — адресное пространство внутренней подсети.

    ![Создание виртуальной сети](./media/configure-application-gateway-with-private-frontend-ip/private-frontendip-1.png)

6. Нажмите кнопку **ОК**, чтобы создать виртуальную сеть и подсеть.
7. Выберите **Далее:** внешние интерфейсы.
8. В качестве **типа внешнего IP-адреса**выберите **частный**.

   По умолчанию это назначение динамического IP-адреса. Первый доступный адрес настроенной подсети назначается в качестве внешнего IP-адреса.
   > [!NOTE]
   > После выделения тип IP-адреса (статический или динамический) нельзя изменить позже.
9. Нажмите кнопку **Далее: незавершенные**.
10. Выберите **добавить серверный пул**.
11. В качестве **имени**введите *appGatewayBackendPool*.
12. Для **добавления внутреннего пула без целевых объектов**выберите **Да**. Вы добавите целевые объекты позже.
13. Выберите **Добавить**.
14. Выберите **Далее: Конфигурация**.
15. В разделе **правила маршрутизации**выберите **Добавить правило**.
16. В качестве **имени правила**введите *рруле-01*.
17. В качестве **имени прослушивателя**введите *Listener-01*.
18. В качестве **интерфейсного IP-адреса**выберите **частный**.
19. Примите остальные значения по умолчанию и перейдите на вкладку **серверные целевые объекты** .
20. В качестве **типа целевого объекта**выберите **внутренний пул**, а затем выберите **appGatewayBackendPool**.
21. Для **параметра HTTP**выберите **создать**.
22. В качестве **имени параметра HTTP**введите *http-Setting-01*.
23. В качестве **серверного протокола**выберите **http**.
24. Для **внутреннего порта**введите *80*.
25. Примите остальные значения по умолчанию и нажмите кнопку **Добавить**.
26. На странице **Добавление правила маршрутизации** выберите **Добавить**.
27. По завершении выберите **Next: Теги**.
28. По завершении выберите **Next: Отзыв и создание**.
29. Просмотрите параметры на странице Сводка, а затем выберите **создать** , чтобы создать сетевые ресурсы и шлюз приложений. Создание шлюза приложений может занять несколько минут. Дождитесь успешного завершения развертывания перед переходом к следующему разделу.

## <a name="add-backend-pool"></a>Добавление внутреннего пула

Серверный пул используется для перенаправления запросов на внутренние серверы, на которых обслуживается запрос. Серверная часть может состоять из сетевых карт, масштабируемых наборов виртуальных машин, общедоступных IP-адресов, внутренних IP-адресов, полных доменных имен (FQDN) и многоклиентской серверной части, такой как служба приложений Azure. В этом примере мы будем использовать виртуальные машины в качестве целевых объектов серверной части. Вы можете использовать существующие виртуальные машины или создать новые. В этом примере вы создадите две виртуальные машины, которые будут использоваться в Azure как внутренние серверы для шлюза приложений.

Для этого необходимо сделать следующее:

1. Создайте две новые виртуальные машины, *myVM* и *myVM2*, которые используются в качестве внутренних серверов.
2. Установить службы IIS на виртуальных машинах, чтобы убедиться, что шлюз приложений успешно создан.
3. Добавить внутренние серверы к внутренним пулам.

### <a name="create-a-virtual-machine"></a>Создание виртуальной машины

1. Выберите **Создать ресурс**.
2. Нажмите **Вычисления**, а затем выберите вариант **Виртуальная машина**.
4. Введите следующие значения для виртуальной машины:
   - Выберите *myResourceGroupAG* для **группы ресурсов**.
   - *myVM* — для **имени виртуальной машины**.
   - Выберите **Windows Server 2019 Datacenter** для **образа**.
   - допустимое **имя пользователя**.
   - допустимый **пароль**.
5. Примите остальные значения по умолчанию и выберите **Далее: диски**.
6. Примите значения по умолчанию и выберите **Далее: сеть**.
7. Убедитесь, что выбрана виртуальная сеть **myVNet** и подсеть **myBackendSubnet**.
8. Примите остальные значения по умолчанию и выберите **Далее: Управление**.
9. Нажмите кнопку **Отключить**, чтобы выключить диагностику загрузки.
10. Примите остальные значения по умолчанию и нажмите кнопку **Далее: дополнительно**.
11. Выберите **Далее: Теги**.
12. Нажмите кнопку **Далее: Проверка и создание**.
13. Просмотрите параметры на странице сводки и нажмите кнопку **Создать**. Создание виртуальной машины может занять несколько минут. Дождитесь успешного завершения развертывания перед переходом к следующему разделу.

### <a name="install-iis"></a>Установка служб IIS

1. Откройте Cloud Shell и убедитесь, что для нее задано значение **PowerShell**.
    ![На снимке экрана показано открытое окно консоли Azure Cloud Shell, использующее PowerShell.](./media/configure-application-gateway-with-private-frontend-ip/private-frontendip-3.png)
2. Чтобы установить службы IIS, выполните на виртуальной машине следующие команды:

   ```azurepowershell
   Set-AzVMExtension `
   
     -ResourceGroupName myResourceGroupAG `
   
     -ExtensionName IIS `
   
     -VMName myVM `
   
     -Publisher Microsoft.Compute `
   
     -ExtensionType CustomScriptExtension `
   
     -TypeHandlerVersion 1.4 `

     -SettingString '{"commandToExecute":"powershell Add-WindowsFeature Web-Server; powershell Add-Content -Path \"C:\\inetpub\\wwwroot\\Default.htm\" -Value $($env:computername)"}' `

     -Location CentralUS `

   ```



3. Создайте вторую виртуальную машину и установите службы IIS, следуя только что выполненным инструкциям. Введите myVM2 в качестве имени виртуальной машины и значения параметра VMName в команде Set-AzVMExtension.

### <a name="add-backend-servers-to-backend-pool"></a>Добавление серверов во внутренние пулы

1. Выберите **Все ресурсы**, а затем — **myAppGateway**.
2. Выберите **Серверные пулы**. Выберите **appGatewayBackendPool**.
3. В разделе **тип целевого объекта** выберите **Виртуальная машина**  и в разделе **целевой объект**выберите vNIC, связанный с myVM.
4. Повторите, чтобы добавить MyVM2.
   ![Снимок экрана: панель изменения серверного пула с выделенными целевыми типами и целевыми объектами.](./media/configure-application-gateway-with-private-frontend-ip/private-frontendip-4.png)
5. Нажмите кнопку **Сохранить.**

## <a name="test-the-application-gateway"></a>Тестирование шлюза приложений

1. Проверьте назначенный интерфейсный IP-адрес, щелкнув страницу **конфигурации интерфейсных IP-** адресов на портале.
    ![На снимке экрана показана область внешних IP-конфигураций с выделенным закрытым типом.](./media/configure-application-gateway-with-private-frontend-ip/private-frontendip-5.png)
2. Скопируйте частный IP-адрес и вставьте его в адресную строку браузера на виртуальной машине в той же виртуальной сети или в локальной среде, которая имеет подключение к этой виртуальной сети, и попытайтесь получить доступ к шлюзу приложений.

## <a name="next-steps"></a>Дальнейшие шаги

Если вы хотите отслеживать работоспособность серверной части, см. раздел [журналы работоспособности и диагностики для шлюза приложений](application-gateway-diagnostics.md).
