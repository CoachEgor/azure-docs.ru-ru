---
title: Автоматическое масштабирование и Шлюз приложений, избыточный между зонами, версии 2
description: В этой статье описываются Standard_v2 приложений Azure и WAF_v2 SKU, в том числе функции автомасштабирования и избыточности в зонах.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 11/09/2019
ms.author: victorh
ms.openlocfilehash: 66978f313f5cb3881f8befc61289d7de0f4214cb
ms.sourcegitcommit: 3d4917ed58603ab59d1902c5d8388b954147fe50
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/02/2019
ms.locfileid: "74668149"
---
# <a name="autoscaling-and-zone-redundant-application-gateway-v2"></a>Автоматическое масштабирование и Шлюз приложений, избыточный между зонами, версии 2 

Шлюз приложений и брандмауэр веб-приложения (WAF) также доступны в Standard_v2 и WAF_v2 SKU. Номер SKU v2 обеспечивает повышение производительности и добавляет поддержку для важных новых функций, таких как автоматическое масштабирование, избыточность зоны и поддержка статических виртуальных IP-адресов. Существующие функции в стандартном и WAF SKU продолжают поддерживаться в новом номере SKU версии 2, с некоторыми исключениями, перечисленными в разделе [сравнения](#differences-with-v1-sku) .

Новый номер SKU v2 включает следующие улучшения:

- **Автоматическое масштабирование**: шлюз приложений или развертывания WAF в SKU автоматического масштабирования могут изменять масштаб в соответствии с изменениями в объеме трафика. Кроме того, автоматическое масштабирование позволяет не выбирать размер развертывания или количество экземпляров во время подготовки. Этот SKU обеспечивает истинную эластичность. В Standard_v2 и WAF_v2 SKU шлюз приложений может использовать как в фиксированной емкости (автоматическое масштабирование отключено), так и в режиме с включенным автомасштабированием. Режим фиксированной емкости подходит для сценариев с постоянной, предсказуемой рабочей нагрузкой. Режим автомасштабирования полезен в приложениях, которые видят дисперсию трафика приложения.
- **Избыточность зоны**. Развертывание шлюза приложений или WAF может охватывать несколько зоны доступности, что устраняет необходимость в подготовке отдельных экземпляров шлюза приложений в каждой зоне с помощью диспетчера трафика. Можно выбрать одну или несколько зон, в которых развертываются экземпляры шлюза приложений, что повышает устойчивость к сбоям зоны. Внутренний пул приложений можно аналогичным образом распределить по зонам доступности.

  Избыточность зоны доступна только в том случае, если доступны зоны Azure. В других регионах поддерживаются все остальные функции. Дополнительные сведения см. в статье [Что такое Зоны доступности в Azure?](../availability-zones/az-overview.md#services-support-by-region).
- **Статический виртуальный IP-адрес**. SKU шлюза приложений версии 2 поддерживает только тип статического виртуального IP-адреса. Это гарантирует, что виртуальный IP-адрес, связанный с шлюзом приложений, не изменится на жизненный цикл развертывания даже после перезапуска.  В версии 1 нет статического виртуального IP-адреса, поэтому для маршрутизации доменных имен в службы приложений через шлюз приложений необходимо использовать URL шлюза приложений, а не IP-адрес.
- **Перезапись заголовков**. шлюз приложений позволяет добавлять, удалять и обновлять заголовки HTTP-запросов и ответов с номером SKU v2. Дополнительные сведения см. в статье [Перезапись HTTP-заголовков с помощью шлюза приложений](rewrite-http-headers.md) .
- **Интеграция Key Vault (Предварительная версия)** . шлюз приложений версии 2 поддерживает интеграцию с key Vault (в общедоступной предварительной версии) для сертификатов сервера, подключенных к прослушивателям с поддержкой HTTPS. Дополнительные сведения см. [в разделе завершение SSL с помощью сертификатов Key Vault](key-vault-certs.md).
- **Контроллер входящего трафика службы Kubernetes Azure (Предварительная версия)** . контроллер входящего трафика шлюза приложений версии 2 позволяет использовать шлюз приложений Azure в качестве входящего трафика для службы Kubernetes Azure (AKS), известной как кластер AKS. Дополнительные сведения см. на [странице документации](https://azure.github.io/application-gateway-kubernetes-ingress/).
- **Улучшения производительности**. SKU v2 обеспечивает 5x лучшую производительность разгрузки SSL по сравнению с SKU Standard/WAF.
- **Более быстрое развертывание и время обновления** Номер SKU версии 2 обеспечивает более быстрое развертывание и обновление по сравнению с SKU Standard/WAF. Сюда также входят изменения конфигурации WAF.

![](./media/application-gateway-autoscaling-zone-redundant/application-gateway-autoscaling-zone-redundant.png)

## <a name="supported-regions"></a>Поддерживаемые регионы

Номер SKU Standard_v2 и WAF_v2 доступен в следующих регионах: Северо-центральный регион США, Юго-Центральный регион, Западная часть США, Запад США 2, восток США, Восточный часть США 2, Центральная часть США, Северная Европа, Западная Европа, Юго-Восточная Азия, Центральный регион, западная часть Соединенного Королевства, Восточная Япония, Западная Япония, Восточная Австралия , Юго-Восточная Австралия, Южная Бразилия, Центральная Канада, Восточная Канада, Восточная Азия, Центральная Корея, Южная Корея, южная часть Соединенного Королевства, Центральная Индия, Западная Индия, Южная Индия.

## <a name="pricing"></a>Стоимость

В версии v2 модель ценообразования определяется потреблением и больше не подключается к количеству или размерам экземпляров. Цена SKU v2 имеет два компонента:

- **Фиксированная цена** — это Почасовая (или частичная) Цена для предоставления шлюза Standard_v2 или WAF_v2. Обратите внимание, что 0 дополнительных экземпляров по-прежнему гарантирует высокий уровень доступности службы, которая всегда включается с фиксированной ценой.
- **Цена единицы мощности** — это стоимость на основе потребления, которая будет взиматься в дополнение к фиксированным затратам. Плата за единицы емкости начисляется за каждый час или за неполный час. В единице емкости учитывается три показателя: единица вычислений, постоянные подключения и пропускная способность. Единица вычислений — мера использованных ресурсов процессора. Факторы, влияющие на единицу вычислений, — это TLS-подключения/с, вычисление перезаписи URL-адресов и обработка правил WAF. Постоянное подключение — это мера установленных TCP-подключений к шлюзу приложений в течение заданного интервала выставления счетов. Средняя пропускная способность — среднее мегабит/с, обработанных системой за заданный интервал выставления счетов.  Выставление счетов выполняется на уровне единицы мощности, что превышает количество зарезервированных экземпляров.

Каждая единица емкости состоит не более чем за 1 единицу вычислений или с пропускной способностью 2,22 2500 Мбит/с.

Руководство по единицам вычислений:

- **Standard_v2** — каждая единица вычислений может иметь приблизительно 50 подключений в секунду с сертификатом TLS с 2048 RSA-битным ключом.
- **WAF_v2** — каждая единица вычислений может поддерживать примерно 10 одновременных запросов в секунду для 70-30% трафика с 70% запросов GET/POST и оставшихся выше. На производительность WAF в настоящее время не влияет размер ответа.

> [!NOTE]
> В настоящее время каждый экземпляр может поддерживать около 10 единиц емкости.
> Количество запросов, которые может обрабатывать единица вычислений, зависит от различных критериев, таких как размер ключа сертификата TLS, алгоритм обмена ключами, перезапись заголовка и в случае WAFного размера входящего запроса. Мы рекомендуем выполнять тесты приложений для определения частоты запросов на единицу вычислений. Единица мощности и единица вычислений будут доступны как метрика перед началом выставления счетов.

В следующей таблице показаны примеры цен и они предназначены только для иллюстрации.

**Цены на Восточная часть США**:

|              Имя SKU                             | Фиксированная цена ($/ч)  | Цена единицы мощности ($/ку-ХР)   |
| ------------------------------------------------- | ------------------- | ------------------------------- |
| Standard_v2                                       |    0,20             | 0,0080                          |
| WAF_v2                                            |    0,36             | 0,0144                          |

Дополнительные сведения о ценах см. на [странице с ценами](https://azure.microsoft.com/pricing/details/application-gateway/). Выставление счетов запланировано на 1 июля 2019 г.

**Пример 1**

Standard_v2 шлюза приложений подготавливается без автомасштабирования в режиме ручного масштабирования с фиксированной емкостью для пяти экземпляров.

Фиксированная цена = 744 (ч) * $0,20 = $148,8 <br>
Единицы мощности = 744 (в часах) * единица мощности на экземпляре (в секунду) * 5 экземпляров * $0,008 на единицу емкости за час = $297,6

Общая цена = $148,8 + $297,6 = $446,4

**Пример 2**

Standard_v2 шлюза приложений подготавливается в течение месяца, с нулевым количеством экземпляров, и в течение этого времени будет получено 25 новых SSL-подключений в секунду, среднее значение для передаваемых данных 8,88 Мбит/с. Если подключения имеют небольшой срок действия, Ваша цена будет:

Фиксированная цена = 744 (ч) * $0,20 = $148,8

Цена единицы емкости = 744 (ч) * максимум (25/50 единиц вычислений для подключений/с, единица мощности 8.88/22E для пропускной способности) * $0,008 = 744 * 4 * 0,008 = $23,81

Общая цена = $148.8 + 23.81 = $172,61

Как видите, счет выставляется только для четырех единиц емкости, а не для всего экземпляра. 

> [!NOTE]
> Функция max Возвращает наибольшее значение в паре значений.


**Пример 3**

Standard_v2 шлюза приложений подготавливается в течение месяца, не менее пяти экземпляров. Если нет времени существования трафика и соединений, Ваша цена будет:

Фиксированная цена = 744 (ч) * $0,20 = $148,8

Цена единицы емкости = 744 (ч) * максимум (0/50 единиц вычислений для подключений/с, единица мощности 0/22E для пропускной способности) * $0,008 = 744 * 50 * 0,008 = $297,60

Общая цена = $148.80 + 297.60 = $446,4

В этом случае вы оплачиваете все пять экземпляров, несмотря на отсутствие трафика.

**Пример 4**

Standard_v2 шлюза приложений подготавливается в течение месяца, в котором не менее пяти экземпляров, но на этот раз в среднем 125 Мбит/с и 25 подключений SSL в секунду. Если нет времени существования трафика и соединений, Ваша цена будет:

Фиксированная цена = 744 (ч) * $0,20 = $148,8

Цена единицы емкости = 744 (ч) * максимум (25/50 единиц вычислений для подключений/с, 125/22E единица мощности для пропускной способности) * $0,008 = 744 * 57 * 0,008 = $339,26

Общая цена = $148.80 + 339.26 = $488,06

В этом случае вам выставляются счета за все пять экземпляров, а также семь единиц емкости (7/10 экземпляра).  

**Пример 5**

WAF_v2 шлюза приложений подготавливается в течение месяца. В течение этого времени он получает 25 новых SSL-подключений/с, среднее значение для передаваемых данных 8,88 Мбит/с и 80 запросов в секунду. Если соединения имеют небольшой срок существования, а вычисление единиц вычислений для приложения поддерживает 10 RP на единицу вычислений, Ваша цена будет:

Фиксированная цена = 744 (ч) * $0,36 = $267,84

Цена единицы емкости = 744 (ч) * max (максимум единиц вычислений (25/50 для подключений/с, 80/10 WAF RPS), 8.88/22E единица мощности для пропускной способности) * $0,0144 = 744 * 8 * 0,0144 = $85,71

Общая цена = $267,84 + $85,71 = $353,55

> [!NOTE]
> Функция max Возвращает наибольшее значение в паре значений.

## <a name="scaling-application-gateway-and-waf-v2"></a>Масштабирование шлюза приложений и WAF v2

Шлюз приложений и WAF можно настроить для масштабирования в двух режимах:

- **Автоматическое масштабирование** . с включенным автомасштабированием шлюзы приложений и номера SKU WAF v2 масштабируются вверх или вниз в зависимости от требований к трафику приложений. Этот режим обеспечивает более высокую эластичность приложения и исключает необходимость угадать размер или число экземпляров шлюза приложений. Этот режим также позволяет экономить затраты, так как не требует от шлюза запуска в пиковую подготовленную емкость для ожидаемой максимальной нагрузки на трафик. Необходимо указать минимальное и необязательное максимальное число экземпляров. Минимальная емкость гарантирует, что шлюз приложений и WAF v2 не окажутся ниже указанного минимального числа экземпляров даже при отсутствии трафика. Каждый экземпляр подсчитывается как 10 дополнительных зарезервированных единиц емкости. Ноль означает отсутствие зарезервированной емкости и полностью масштабируется по сути. Обратите внимание, что нулевые дополнительные экземпляры по-прежнему обеспечивают высокий уровень доступности службы, которая всегда включается с фиксированной ценой. При необходимости можно также указать максимальное число экземпляров, которое гарантирует, что шлюз приложений не масштабируется за пределы указанного числа экземпляров. Вам будет взиматься плата за объем трафика, обслуживаемого шлюзом. Число экземпляров может находиться в диапазоне от 0 до 125. Значение по умолчанию для параметра Максимальное число экземпляров равно 20, если не указано.
- **Вручную** . можно также выбрать ручной режим, в котором шлюз не будет автоматически масштабироваться. В этом режиме, если существует больше трафика, чем может поддерживать шлюз приложений или WAF, это может привести к потери трафика. В ручном режиме указание количества экземпляров является обязательным. Число экземпляров может быть разным в диапазоне от 1 до 125.

## <a name="feature-comparison-between-v1-sku-and-v2-sku"></a>Сравнение характеристик SKU v1 и SKU v2

В следующей таблице сравниваются функции, доступные для каждого SKU.

|                                                   | номер SKU v1   | номер SKU v2   |
| ------------------------------------------------- | -------- | -------- |
| Автомасштабирование                                       |          | &#x2713; |
| Избыточность в пределах зоны                                   |          | &#x2713; |
| Статический виртуальный IP-адрес                                        |          | &#x2713; |
| Контроллер входящего трафика службы Azure Kubernetes Service (AKS) |          | &#x2713; |
| Интеграция с хранилищем ключей Azure                       |          | &#x2713; |
| Переписать заголовки HTTP (S)                           |          | &#x2713; |
| Маршрутизация на основе URL-адреса                                 | &#x2713; | &#x2713; |
| Размещение нескольких сайтов                             | &#x2713; | &#x2713; |
| Перенаправление трафика                               | &#x2713; | &#x2713; |
| Брандмауэр веб-приложения (WAF)                    | &#x2713; | &#x2713; |
| Настраиваемые правила WAF                                  |          | &#x2713; |
| Завершение запросов SSL            | &#x2713; | &#x2713; |
| Сквозное шифрование SSL                         | &#x2713; | &#x2713; |
| Сходство сеансов                                  | &#x2713; | &#x2713; |
| Пользовательские страницы ошибок                                | &#x2713; | &#x2713; |
| Поддержка WebSocket                                 | &#x2713; | &#x2713; |
| Поддержка HTTP/2                                    | &#x2713; | &#x2713; |
| фильтрация подключений;                               | &#x2713; | &#x2713; |

> [!NOTE]
> SKU автомасштабирования версии 2 теперь поддерживает [зонды работоспособности по умолчанию](application-gateway-probe-overview.md#default-health-probe) , чтобы автоматически отслеживать работоспособность всех ресурсов во внутреннем пуле и выделять внутренние элементы, которые считаются неработоспособными. Проба работоспособности по умолчанию автоматически настраивается на наличие нестандартных конфигураций зонда. Дополнительные сведения см. в разделе [зонды работоспособности в шлюзе приложений](application-gateway-probe-overview.md).

## <a name="differences-with-v1-sku"></a>Различия между SKU v1

|Разницы|Сведения|
|--|--|
|Сертификат аутентификации|Не поддерживается.<br>Дополнительные сведения см. в статье [Обзор сквозного режима связи SSL в Шлюзе приложений](ssl-overview.md#end-to-end-ssl-with-the-v2-sku).|
|Смешанное использование Standard_v2 и Шлюза приложений (цен. категория "Стандартный") в той же подсети|Не поддерживается|
|Маршрут, определяемый пользователем в подсети Шлюза приложений|Не поддерживается|
|NSG для диапазона портов входящего трафика| – 65200 до 65535 для SKU Standard_v2.<br>– 65503 до 65534 для SKU (цен. категория "Стандартный").<br>Дополнительные сведения см. в разделе [Часто задаваемые вопросы](application-gateway-faq.md#are-network-security-groups-supported-on-the-application-gateway-subnet).|
|Журналы производительности в системе диагностики Azure|Не поддерживается.<br>Следует использовать метрики Azure.|
|Выставление счетов|Выставление счетов запланировано на начало 1 июля 2019 г.|
|Режим FIPS|В настоящее время не поддерживаются.|
|Только режим ILB|В настоящее время это не поддерживается. Комбинация общедоступного режима и режима ILB не поддерживается.|
|Интеграция Наблюдателя за сетями|Не поддерживается.|
|Интеграция с центром безопасности Azure|Пока недоступно.

## <a name="migrate-from-v1-to-v2"></a>Миграция из версии 1 в версию 2

Скрипт Azure PowerShell доступен в коллекции PowerShell, который поможет выполнить миграцию из шлюза приложений v1 или WAF в SKU автомасштабирования v2. Этот сценарий помогает скопировать конфигурацию из шлюза v1. Миграция трафика по-прежнему отвечает за работу. Дополнительные сведения см. [в статье перенос шлюза приложений Azure с версии v1 на версию 2](migrate-v1-v2.md).

## <a name="next-steps"></a>Дальнейшие действия

- [Краткое руководство. прямой веб-трафик с помощью шлюза приложений Azure — портал Azure](quick-create-portal.md)
- [Создание автоматически масштабируемого, избыточного в пределах зоны шлюза приложений с зарезервированным виртуальным IP-адресом с помощью Azure PowerShell](tutorial-autoscale-ps.md)
- Дополнительные сведения о [шлюзе приложений](overview.md).
- Дополнительные сведения о [брандмауэре Azure](../firewall/overview.md).
