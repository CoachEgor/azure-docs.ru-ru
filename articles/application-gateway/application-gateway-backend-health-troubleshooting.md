---
title: Проблемы с устранением проблем с задним состоянием в шлюзе приложения Azure
description: Описывает, как устранить проблемы с задним состоянием для безопасности для Azure Application Gateway
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: article
ms.date: 08/30/2019
ms.author: surmb
ms.openlocfilehash: 71e1f8be2af5556d86996175e8a1ddbccc9c7de1
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "72001668"
---
<a name="troubleshoot-backend-health-issues-in-application-gateway"></a>Проблемы с устранением проблем с бэкэндом в шлюзе приложения
==================================================

<a name="overview"></a>Обзор
--------

По умолчанию Azure Application Gateway зондирует серверы бэкэнда, чтобы проверить их состояние работоспособности и проверить, готовы ли они обслуживать запросы. Пользователи также могут создавать пользовательские зонды для упоминания имени хоста, пути, который необходимо исследовать, и коды статуса, которые должны быть приняты как Здоровые. В каждом случае, если сервер бэкэнда не отвечает успешно, шлюз приложения отмечает сервер как неработоспособный и перестает пересылать запросы на сервер. После успешного реагирования сервера шлюз приложения возобновляет переадресировку запросов.

### <a name="how-to-check-backend-health"></a>Как проверить здоровье бэкэнда

Чтобы проверить работоспособность пула бэкэнда, вы можете использовать страницу **Backend Health** на портале Azure. Или вы можете использовать [Azure PowerShell,](https://docs.microsoft.com/powershell/module/az.network/get-azapplicationgatewaybackendhealth?view=azps-2.6.0) [CLI](https://docs.microsoft.com/cli/azure/network/application-gateway?view=azure-cli-latest#az-network-application-gateway-show-backend-health)или [REST API.](https://docs.microsoft.com/rest/api/application-gateway/applicationgateways/backendhealth)

Статус, полученный любым из этих методов, может быть любым из следующих:

- Healthy

- Unhealthy;

- Неизвестно

Если состояние работоспособности бэкэнда для сервера является здоровым, это означает, что шлюз приложения будет переадресовывать запросы на этот сервер. Но если работоспособность бэкэнда для всех серверов в пуле бэкэнда неработоспособна или неизвестна, при попытке получить доступ к приложениям могут возникнуть проблемы. В этой статье описаны симптомы, причина и разрешение каждой из показанных ошибок.

<a name="backend-health-status-unhealthy"></a>Состояние здоровья бэкэнда: нездоровый
-------------------------------

Если состояние здоровья бэкэнда является нездоровым, представление портала будет напоминать следующий скриншот:

![Здоровье бэкэнда прикладного приложения Gateway - Нездоровый](./media/application-gateway-backend-health-troubleshooting/appgwunhealthy.png)

Или, если вы используете aPi-запрос Azure PowerShell, CLI или Azure REST API, вы получите ответ, напоминающий следующее:
```azurepowershell
PS C:\Users\testuser\> Get-AzApplicationGatewayBackendHealth -Name "appgw1" -ResourceGroupName "rgOne"
BackendAddressPools :
{Microsoft.Azure.Commands.Network.Models.PSApplicationGatewayBackendHealthPool}
BackendAddressPoolsText : [
{
                              "BackendAddressPool": {
                                "Id": "/subscriptions/536d30b8-665b-40fc-bd7e-68c65f816365/resourceGroups/rgOne/providers/Microsoft.Network/applicationGateways/appgw1/b
                          ackendAddressPools/appGatewayBackendPool"
                              },
                              "BackendHttpSettingsCollection": [
                                {
                                  "BackendHttpSettings": {
                                    "TrustedRootCertificates": [],
                                    "Id": "/subscriptions/536d30b8-665b-40fc-bd7e-68c65f816365/resourceGroups/rgOne/providers/Microsoft.Network/applicationGateways/appg
                          w1/backendHttpSettingsCollection/appGatewayBackendHttpSettings"
                                  },
                                  "Servers": [
                                    {
                                      "Address": "10.0.0.5",
                                      "Health": "Healthy"
                                    },
                                    {
                                      "Address": "10.0.0.6",
                                      "Health": "Unhealthy"
                                    }
                                  ]
                                }
                              ]
                            }
                        ]
```
После получения нездорового статуса сервера бэкэнда для всех серверов в пуле бэкэнда запросы не перенаправляются на серверы, а шлюз приложения возвращает запросу клиенту ошибку "502 Bad Gateway". Чтобы устранить неполадки, проверьте колонку **«Подробности»** на вкладке **«Здоровье бэкэнда».**

Сообщение, отображаемые в колонке **Детали,** содержит более подробную информацию о проблеме, и на их основе можно приступить к устранению неполадок.

> [!NOTE]
> Запрос зонда по умолчанию \<отправляется в формате\>протокола ://127.0.0.1:\<port/.\> Например, http://127.0.0.1:80 для зонда http на порту 80. Только коды статуса HTTP от 200 до 399 считаются здоровыми. Протокол и порт назначения унаследованы от настроек HTTP. Если вы хотите, чтобы Application Gateway исследовал исследует другой протокол, имя узла или пути и распознавал другой код статуса как Здоровый, настроите пользовательский зонд и связайте его с настройками HTTP.

<a name="error-messages"></a>Сообщения об ошибках
------------------------
#### <a name="backend-server-timeout"></a>Тайм-аут сервера бэкэнда

**Сообщение:** Время, задейось бэкэндом, чтобы ответить на зонд здоровья шлюза\'приложения, больше, чем порог тайм-аута в настройках зонда.

**Причина:** После того, как Application Gateway отправляет запрос зонда HTTP(S на сервер бэкэнда, он ждет ответа от сервера бэкэнда в течение настроенного периода. Если сервер бэкэнда не отвечает в пределах настроенного периода (значение тайм-аута), он помечен как неработоспособный до тех пор, пока не начнет отвечать в течение набранного периода тайм-аута снова.

**Разрешение:** Проверьте, почему сервер или приложение бэкэнда не отвечает в установленный период тайм-аута, а также проверьте зависимости приложения. Например, проверьте, есть ли в базе данных проблемы, которые могут вызвать задержку в ответе. Если вы знаете о поведении приложения и оно должно реагировать только после значения тайм-аута, увеличьте значение тайм-аута из пользовательских настроек зонда. Вы должны иметь пользовательский зонд, чтобы изменить значение тайм-аута. Для получения информации о том, как настроить пользовательский зонд, [смотрите страницу документации](https://docs.microsoft.com/azure/application-gateway/application-gateway-create-probe-portal).

Чтобы увеличить значение тайм-аута, выполните следующие действия:

1.  Получите прямой доступ к серверу бэкэнда и проверьте время, задействовавное серверу для ответа на этой странице. Вы можете использовать любой инструмент для доступа к серверу бэкэнда, включая браузер с помощью инструментов разработчика.

1.  После того как вы выяснили время, задеймотое приложение для ответа, выберите вкладку **зондов работоспособности,** а затем выберите зонд, связанный с настройками HTTP.

1.  Введите любое значение тайм-аута, превышающее время отклика приложения, за считанные секунды.

1.  Сохраните пользовательские настройки зонда и проверьте, показывает ли здоровье бэкэнда как Здоровое сейчас.

#### <a name="dns-resolution-error"></a>Ошибка разрешения DNS

**Сообщение:** Приложение Gateway не может создать зонд для этого бэкэнда. Обычно это происходит, когда полное доменное имя внутренней службы введено неправильно. 

**Причина:** Если пул бэкэнда имеет IP-адрес типа/F-DN или Службу App, шлюз приложения разрешает сяритоге с IP-адресом F-DN, введенным через систему доменных имен (DNS) (пользовательское или Azure по умолчанию) и пытается подключиться к серверу в порту TCP, указанном в настройках HTTP. Но если это сообщение отображается, это говорит о том, что Application Gateway не смог успешно решить IP-адрес введенного F-DN.

**Решение.**

1.  Убедитесь, что F-DN, введенный в пул бэкэнда, является правильным и что он является общественным достоянием, а затем попытайтесь решить его с локальной машины.

1.  Если вы можете решить IP-адрес, может быть что-то не так с конфигурацией DNS в виртуальной сети.

1.  Проверьте, настроена ли виртуальная сеть с пользовательским DNS-сервером. Если это так, проверьте DNS-сервер о том, почему он не может решить на IP-адрес указанного F'DN.

1.  Если вы используете DNS по умолчанию Azure по умолчанию, обратитесь к регистратору доменных имен о том, была ли завершена соответствующая запись или отображение записи CNAME.

1.  Если домен является закрытым или внутренним, попробуйте решить его с VM в той же виртуальной сети. Если вы можете решить его, перезазапуск шлюза приложения и проверить еще раз. Чтобы перезапустить шлюз приложений, необходимо [остановиться](https://docs.microsoft.com/powershell/module/azurerm.network/stop-azurermapplicationgateway?view=azurermps-6.13.0) и [начать](https://docs.microsoft.com/powershell/module/azurerm.network/start-azurermapplicationgateway?view=azurermps-6.13.0) с помощью команд PowerShell, описанных в этих связанных ресурсах.

#### <a name="tcp-connect-error"></a>Ошибка подключения TCP

**Сообщение:** Приложение Gateway не может подключиться к бэкэнду.
Пожалуйста, проверьте, что бэкэнд отвечает на порт, используемый для зонда.
Также проверьте, блокирует ли какой-либо NSG/UDR/Firewall доступ к Ip и порту этого бэкэнда

**Причина:** После этапа разрешения DNS шлюз приложения пытается подключиться к серверу бэкэнда в порту TCP, настроенном в настройках HTTP. Если шлюз приложения не может установить сеанс TCP в указанном порту, зонд помечен как неработоспособный с этим сообщением.

**Решение:** Если вы получили эту ошибку, выполните следующие действия:

1.  Проверьте, можно ли подключиться к серверу бэкэнда в порту, указанном в настройках HTTP, с помощью браузера или PowerShell. Например, запустите следующую команду:`Test-NetConnection -ComputerName
    www.bing.com -Port 443`

1.  Если упомянутый порт не является нужным портом, введите правильный номер порта для шлюза приложения для подключения к серверу бэкэнда

1.  Если вы не можете подключиться в порту с локальной машины, а затем:

    а.  Проверьте настройки сетевой группы безопасности (NSG) сетевого адаптера и подсети сервера бэкэнда и допускаются ли входные соединения в настроенный порт. Если это не так, создайте новое правило, позволяющее соединениям. Чтобы узнать, как создать правила NSG, [смотрите страницу документации](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#create-security-rules).

    b.  Проверьте, позволяют ли настройки NSG подсети Application Gateway исходящих государственных и частных трафика, так что подключение может быть сделано. Проверьте страницу документа, которая представлена в шаге 3a, чтобы узнать больше о том, как создать правила NSG.
    ```azurepowershell
            $vnet = Get-AzVirtualNetwork -Name "vnetName" -ResourceGroupName "rgName"
            Get-AzVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
    ```

    c.  Проверьте параметры маршрутов, определяемых пользователем (UDR), шлюза приложения и подсети сервера бэкэнда, на наличие аномалий маршрутирования. Убедитесь, что UDR не направляет трафик от подсети бэкэнда. Например, проверьте маршруты для сетевой виртуальной техники или маршруты по умолчанию, рекламируемые в подсети Application Gateway через Azure ExpressRoute и/или VPN.

    d.  Чтобы проверить эффективные маршруты и правила сетевого адаптера, можно использовать следующие команды PowerShell:
    ```azurepowershell
            Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName "nic1" -ResourceGroupName "testrg"
            Get-AzEffectiveRouteTable -NetworkInterfaceName "nic1" -ResourceGroupName "testrg"
    ```
1.  Если вы не нашли проблем с NSG или UDR, проверьте сервер бэкэнда на наличие проблем, связанных с приложениями, которые мешают клиентам установить сеанс TCP в настроенных портах. Несколько вещей, чтобы проверить:

    а.  Откройте командный запрос (Win-R\> `netstat`- cmd), введите и выберите Enter.

    b.  Проверьте, слушает ли сервер настроен по порту. Пример:
    ```
            Proto Local Address Foreign Address State PID
            TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 4
    ```
    c.  Если он не слушается в настроенном порту, проверьте настройки веб-сервера. Например: привязки сайта в IIS, блок сервера в NGINX и виртуальный хост в Apache.

    d.  Проверьте настройки брандмауэра ОС, чтобы убедиться, что входящий трафик в порт разрешен.

#### <a name="http-status-code-mismatch"></a>Несоответствие кода состояния HTTP

**Сообщение:** Код статуса бэкэнда\'http не соответствовал настройкам зонда. Ожидаемое количество: «HTTPStatusCode0» получено: «HTTPStatusCode1».

**Причина:** После того, как соединение TCP было установлено и рукопожатие SSL сделано (если SSL включен), Шлюз приложения отправит зонд в качестве запроса HTTP GET на сервер бэкэнда. Как описано ранее, зонд \<по\>умолчанию будет протокол ://127.0.0.1:\<порт\>/, и он считает коды статуса ответа в ярости 200 до 399 как Здоровый. Если сервер возвращает любой другой код статуса, он будет помечен как неработоспособный с этим сообщением.

**Решение:** В зависимости от кода ответа сервера бэкэнда можно предпринять следующие шаги. Некоторые из общих кодов статуса перечислены здесь:

| **Ошибка** | **Действия** |
| --- | --- |
| Несоответствие кода состояния зонда: Получено 401 | Проверьте, требуется ли проверка подлинности сервера бэкэнда. Зонды Application Gateway не могут передавать учетные данные для проверки подлинности на данный момент. Либо \"разрешить HTTP\" 401 в коде статуса зонда совпадают или зонд на путь, где сервер не требует проверки подлинности. | |
| Несоответствие кода состояния зонда: Получено 403 | Доступ запрещен. Проверьте, разрешен ли доступ к пути на сервере бэкэнда. | |
| Несоответствие кода состояния зонда: Получено 404 | Страница не найдена. Проверьте, доступен ли путь имени хоста на сервере бэкэнда. Измените имя или параметр пути на доступное значение. | |
| Несоответствие кода состояния зонда: Получено 405 | Запросы зонда на шлюз приложений используют метод HTTP GET. Проверьте, позволяет ли ваш сервер этот метод. | |
| Несоответствие кода состояния зонда: Получено 500 | Внутренняя ошибка сервера. Проверьте работоспособность внутреннего сервера и убедитесь, что службы работают. | |
| Несоответствие кода состояния зонда: Получено 503 | Служба недоступна. Проверьте работоспособность внутреннего сервера и убедитесь, что службы работают. | |

Или, если вы считаете, что ответ является законным, и вы хотите, чтобы Application Gateway принял другие коды статуса, как Здоровый, вы можете создать пользовательский зонд. Этот подход полезен в ситуациях, когда бэкэнд-сайт нуждается в аутентификации. Поскольку запросы зонда не содержат учетных данных пользователей, они потерпят неудачу, и код состояния HTTP 401 будет возвращен сервером бэкэнда.

Чтобы создать пользовательский зонд, выполните [следующие шаги.](https://docs.microsoft.com/azure/application-gateway/application-gateway-create-probe-portal)

#### <a name="http-response-body-mismatch"></a>НЕсоответствие тела ответа HTTP

**Сообщение:** Тело бэкэнда\'s HTTP ответ не соответствует настройки зонда. Полученный ответный орган не содержит «строки».

**Причина:** При создании пользовательского зонда у вас есть возможность отметить сервер бэкэнда как Здоровый, сопоставив строку из тела ответа. Например, можно настроить шлюз приложения, чтобы принять "несанкционированное" в качестве строки для сопоставления. Если ответ сервера бэкэнда для запроса зонда содержит **несанкционированную**строку, он будет помечен как Здоровый. В противном случае, это будет помечено как неработоспособное с этим сообщением.

**Решение:** Чтобы решить эту проблему, выполните следующие действия:

1.  Доступ к серверу бэкэнда локально или с клиентской машины на пути зонда и проверьте тело ответа.

1.  Убедитесь, что тело ответа в конфигурации пользовательского зонда Application Gateway соответствует настройке.

1.  Если они не совпадают, измените конфигурацию зонда так, чтобы она соответствовала правильному значению строки для приема.

Узнайте больше о [соответствии зонда Application Gateway.](https://docs.microsoft.com/azure/application-gateway/application-gateway-probe-overview#probe-matching)

#### <a name="backend-server-certificate-invalid-ca"></a>Сертификат сервера бэкэнда недействителен CA

**Сообщение:** Сертификат сервера, используемый бэкэндом, не подписывается известным Сертификационным органом (CA). Белый список бэкэнда на шлюзе приложения, загрузив корневой сертификат сертификата сервера, используемого бэкэндом.

**Причина:** Сквозной SSL с Application Gateway v2 требует проверки сертификата сервера бэкэнда, чтобы считать сервер здоровым.
Для того, чтобы сертификатs SSL был доверен, этот сертификат сервера бэкэнда должен быть выдан ЦС, включенным в доверенный магазин Gateway приложений. Если сертификат не был выдан доверенным ЦС (например, если использовался сертификат самоподписанных), пользователи должны загрузить сертификат эмитента в шлюз приложения.

**Решение:** Выполните следующие действия, чтобы экспортировать и загрузить доверенный корневой сертификат в application Gateway. (Эти шаги для клиентов Windows.)

1.  Войти на машину, где размещается ваше приложение.

1.  Выберите кнопку «Вывиной» или «Правой щелкните кнопку **«Пуск»,** а затем выберите **«Выполнить».**

1.  Введите `certmgr.msc` и выберите Enter. Вы также можете найти менеджера сертификата в меню **«Пуск».**

1.  Найдите сертификат, `\Certificates - Current User\\Personal\\Certificates\`как правило, в, и открыть его.

1.  Выберите корневой сертификат, а затем выберите **Сертификат просмотра.**

1.  В свойствах Сертификата выберите вкладку **«Детали».**

1.  На вкладке **«Подробности»** выберите **опцию «Копия файла»** и сохраните файл в закодированном X.509 Базы 64 (. CER) формат.

1.  Откройте страницу **настроек портала** «Портал настройки приложения HTTP» на портале Azure.

1. Откройте настройки HTTP, выберите **Добавить сертификат**и найдите только что сохраненный файл сертификата.

1. Выберите **Сохранить,** чтобы сохранить настройки HTTP.

Кроме того, вы можете экспортировать корневой сертификат из клиентской машины, напрямую выходя на сервер (в обход шлюза приложения) через браузер и экспортируя корневой сертификат из браузера.

Для получения дополнительной информации о том, как извлечь и загрузить Доверенные корневые сертификаты в приложении Gateway, [см.](https://docs.microsoft.com/azure/application-gateway/certificates-for-backend-authentication#export-trusted-root-certificate-for-v2-sku)

#### <a name="trusted-root-certificate-mismatch"></a>Несоответствие надежного корневого сертификата

**Сообщение:** Корневой сертификат сервера, используемый бэкэндом, не соответствует доверенному корневому сертификату, добавленному в шлюз приложения. Убедитесь, что вы добавите правильный корневой сертификат в белый список бэкэнда

**Причина:** Сквозной SSL с Application Gateway v2 требует проверки сертификата сервера бэкэнда, чтобы считать сервер здоровым.
Для того чтобы сертификату SSL можно доверять, сертификат сервера бэкэнда должен быть выдан ЦС, включенным в доверенный магазин Шлюза приложения. Если сертификат не был выдан доверенным ЦС (например, использовался сертификат самоподписанных), пользователи должны загрузить сертификат эмитента в шлюз приложения.

Сертификат, загруженный в настройки Application Gateway HTTP, должен соответствовать корневому сертификату сервера бэкэнда.

**Решение:** Если вы получили это сообщение об ошибке, есть несоответствие между сертификатом, который был загружен в application Gateway и тот, который был загружен на сервер бэкэнда.

Следуйте шагам 1-11 в предыдущем методе, чтобы загрузить правильный доверенный корневой сертификат в шлюз приложения.

Для получения дополнительной информации о том, как извлечь и загрузить Доверенные корневые сертификаты в приложении Gateway, [см.](https://docs.microsoft.com/azure/application-gateway/certificates-for-backend-authentication#export-trusted-root-certificate-for-v2-sku)
> [!NOTE]
> Эта ошибка также может возникнуть, если сервер бэкэнда не обменивается полной цепочкой сертификата, включая Root > Intermediate (если это применимо) > Leaf во время рукопожатия TLS. Для проверки можно использовать команды OpenSSL от любого клиента и подключиться к серверу бэкэнда с помощью настроенных настроек в зонде Application Gateway.

Пример:
```
OpenSSL> s_client -connect 10.0.0.4:443 -servername www.example.com -showcerts
```
Если на выходе не показана полная цепочка возвращенного сертификата, вывешйте сертификат снова с полной цепочкой, включая корневой сертификат. Наверстуйте этот сертификат на сервере бэкэнда. 

```
  CONNECTED(00000188)\
  depth=0 OU = Domain Control Validated, CN = \*.example.com\
  verify error:num=20:unable to get local issuer certificate\
  verify return:1\
  depth=0 OU = Domain Control Validated, CN = \*.example.com\
  verify error:num=21:unable to verify the first certificate\
  verify return:1\
  \-\-\-\
  Certificate chain\
   0 s:/OU=Domain Control Validated/CN=*.example.com\
     i:/C=US/ST=Arizona/L=Scottsdale/O=GoDaddy.com, Inc./OU=http://certs.godaddy.com/repository//CN=Go Daddy Secure Certificate Authority - G2\
  \-----BEGIN CERTIFICATE-----\
  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\
  \-----END CERTIFICATE-----
```

#### <a name="backend-certificate-invalid-common-name-cn"></a>Сертификат бэкэнда недействительное общее имя (CN)

**Сообщение:** Общее имя (CN) сертификата бэкэнда не совпадает с заголовком зонда.

**Причина:** Приложение Gateway проверяет, соответствует ли имя хоста, указанное в настройках бэкэнда HTTP, значке CN, представленного SSL-сертификатом сервера бэкэнда. Это Standard_v2 и WAF_v2 поведение SKU. Индикатор имени сервера Стандарта и WAF SKU (SNI) устанавливается в качестве F-DN в адресе пула бэкэнда.

В v2 SKU, если есть зонд по умолчанию (не пользовательский зонд был настроен и связан), SNI будет установлен из имени хоста, указанного в настройках HTTP. Или, если "Выбрать имя хоста из бэкэнд-адреса" упоминается в настройках HTTP, где пул адресов бэкэнда содержит действительный F-DN, эта настройка будет применена.

Если есть пользовательский зонд, связанный с настройками HTTP, SNI будет установлен из имени хоста, указанного в пользовательской конфигурации зонда. Или, если **выбрать хост-имя из параметров бэкэнда HTTP** выбрано в пользовательском зонде, SNI будет установлен из имени хоста, указанного в настройках HTTP.

Если в настройках HTTP **установлено имя хоста, если pick hostname из бэкэнда** установлен в настройках HTTP, пул адресов бэкэнда должен содержать действительный F-DN.

Если вы получили это сообщение об ошибке, cn сертификата бэкэнда не соответствует имени хоста, настроенному в пользовательском зонде или настройках HTTP (если **выбрано имя хоста из бэкэнда HTTP).** Если вы используете зонд по умолчанию, имя хоста будет установлено как **127.0.0.1**. Если это не желаемое значение, следует создать пользовательский зонд и связать его с настройками HTTP.

**Решение:**

Устранить проблему можно так.

Для Windows:

1.  Войти на машину, где размещается ваше приложение.

1.  Выберите кнопку «Вывина» или «Правой щелкните кнопку **«Пуск»** и выберите **«Выполнить».**

1.  Введите **certmgr.msc** и выберите Enter. Вы также можете найти менеджера сертификата в меню **«Пуск».**

1.  Найдите сертификат (обычно в), `\Certificates - Current User\\Personal\\Certificates`и откройте сертификат.

1.  На вкладке **Детали** проверьте **тему**сертификата .

1.  Проверьте CN сертификата из деталей и введите то же самое в поле имени хоста пользовательского зонда или в настройках HTTP (если **выбрано имя хоста из бэкэнда HTTP).** Если это не нужное имя хоста для вашего веб-сайта, вы должны получить сертификат для этого домена или ввести правильное имя хоста в пользовательском зонде или конфигурации настройки HTTP.

Для Linux с помощью OpenSSL:

1.  Выполнить эту команду в OpenSSL:
    ```
    openssl x509 -in certificate.crt -text -noout
    ```

2.  Из отображаемых свойств найдите CN сертификата и введите то же самое в поле имени хоста настроек http. Если это не нужное имя хоста для вашего веб-сайта, вы должны получить сертификат для этого домена или ввести правильное имя хоста в пользовательском зонде или конфигурации настройки HTTP.

#### <a name="backend-certificate-is-invalid"></a>Сертификат бэкэнда недействителен

**Сообщение:** Сертификат бэкэнда является недействительным. Текущая дата не \"входит\" \"в\" допустимый и действительный до настоящего времени диапазон сертификата.

**Причина:** Каждый сертификат поставляется с диапазоном действительности, и соединение HTTPS не будет безопасным, если SSL-сертификат сервера не действителен. Текущие данные должны находиться в **пределах допустимого от** и **действительных до** диапазона. Если это не так, сертификат считается недействительным, и это создаст проблему безопасности, в которой шлюз приложения помечает сервер бэкэнда как неработоспособный.

**Решение:** Если срок действия SSL-сертификата истек, обновите сертификат с поставщиком и обновите настройки сервера новым сертификатом. Если это сертификат, подписанный самостоятельно, необходимо создать действительный сертификат и загрузить корневой сертификат в настройки Gateway ПРИЛОЖЕНИЯ HTTP. Для этого выполните следующие действия:

1.  Откройте настройки приложения Gateway HTTP на портале.

1.  Выберите параметр с просроченным сертификатом, выберите **Добавить сертификат**и откройте новый файл сертификата.

1.  Удалить старый сертификат, используя значок **Удалить** рядом с сертификатом, а затем выберите **Сохранить.**

#### <a name="certificate-verification-failed"></a>Проверка сертификата не удалась

**Сообщение:** Достоверность сертификата бэкэнда проверить не удалось. Чтобы выяснить причину, проверьте Open SSL-диагностику на сообщение, связанное с кодом ошибки (errorCode)

**Причина:** Эта ошибка возникает, когда шлюз приложения не может проверить достоверность сертификата.

**Решение:** Чтобы решить эту проблему, убедитесь, что сертификат на вашем сервере был создан должным образом. Например, можно использовать [OpenSSL](https://www.openssl.org/docs/man1.0.2/man1/verify.html) для проверки сертификата и его свойств, а затем попробовать перезагрузить сертификат в настройки Gateway ПРИЛОЖЕНИЯ HTTP.

<a name="backend-health-status-unknown"></a>Состояние здоровья бэкэнда: неизвестно
-------------------------------
Если состояние бэкэнда отображается как Неизвестное, представление портала будет напоминать следующий скриншот:

![Приложение Шлюз бэкэнд здоровья - Неизвестно](./media/application-gateway-backend-health-troubleshooting/appgwunknown.png)

Такое поведение может произойти по одной или более из следующих причин:

1.  NSG в подсети Application Gateway блокирует входящий доступ к портам 65503-65534 (v1 SKU) или 65200-65535 (v2 SKU) из "Интернета".
1.  UDR в подсети Application Gateway настроен на маршрут по умолчанию (0.0.0.0/0), а следующий переход не указан как "Интернет".
1.  Маршрут по умолчанию рекламируется с помощью подключения ExpressRoute/VPN к виртуальной сети через BGP.
1.  Пользовательский DNS-сервер настроен на виртуальную сеть, которая не может решить имена общественного достояния.
1.  Портал приложений находится в неработоспособном состоянии.

**Решение:**

1.  Проверьте, блокирует ли ваш NSG доступ к портам 65503-65534 (v1 SKU) или 65200-65535 (v2 SKU) из **Интернета:**

    а.  На вкладке **«Обзор** портала приложений» выберите ссылку **Virtual Network/Subnet.**

    b.  На **вкладке Subnets** вашей виртуальной сети выберите подсеть, в которой был развернут шлюз приложений.

    c.  Проверьте, настроена ли какая-либо NSG.

    d.  Если настроен абонент NSG, ищите ресурс NSG на вкладке **Поиск** или под **всеми ресурсами.**

    д)  В разделе **Входящие правила,** добавить входящий правило, чтобы диапазон порта назначения 65503-65534 для v1 SKU или 65200-65535 v2 SKU с **исходным** набором как **any** или **Интернет**.

    е)  Выберите **Сохранить** и проверить, что вы можете просмотреть бэкэнд как здоровый. Кроме того, вы можете сделать это через [PowerShell/ CLI](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group).

1.  Проверьте, есть ли у UDR маршрут по умолчанию (0.0.0.0/0) со следующим переходом, не установленным как **Интернет:**
    
    а.  Выполните шаги 1a и 1b, чтобы определить вашу подсеть.

    b.  Проверьте, есть ли UDR настроен. Если есть, ищите ресурс в панели поиска или под **всеми ресурсами.**

    c.  Проверьте, есть ли маршруты по умолчанию (0.0.0.0/0) со следующим хопом, не установленным как **Интернет.** Если параметр является **либо Virtual Appliance** или **Virtual Network Gateway,** вы должны убедиться, что ваш виртуальный прибор или устройство на месте может правильно маршрут пакет обратно в интернет назначения без изменения пакета.

    d.  В противном случае измените следующий переход на **Интернет,** выберите **Сохранить**и проверить работоспособность бэкэнда.

1.  Маршрут по умолчанию, рекламируемый подключением ExpressRoute/VPN к виртуальной сети через BGP:

    а.  Если у вас есть подключение ExpressRoute/VPN к виртуальной сети через BGP, и если вы рекламируете маршрут по умолчанию, вы должны убедиться, что пакет направляется обратно в интернет-пункт назначения, не изменяя его. Вы можете проверить, используя опцию **Connection Troubleshoot** на портале Портала Шлюзов приложений.

    b.  Выберите пункт назначения вручную, как любой интернет-routable IP-адрес, как 1.1.1.1. Установите порт назначения как что-либо, и проверить подключение.

    c.  Если следующий переход является виртуальным сетевым шлюзом, может быть маршрут по умолчанию, рекламируемый через ExpressRoute или VPN.

1.  Если в виртуальной сети настроен пользовательский DNS-сервер, убедитесь, что сервер (или серверы) может решать проблемы общественного достояния. Разрешение имени общественного достояния может потребоваться в сценариях, когда шлюз приложения должен выйти на внешние домены, такие как серверы OCSP, или проверить статус отзыва сертификата.

1.  Чтобы убедиться, что шлюз приложения является здоровым и работает, перейдите на опцию **«Здоровье ресурсов»** на портале и убедитесь, что состояние **является здоровым.** Если вы видите **нездоровое** или **деградировало** состояние, [обратитесь в службу поддержки.](https://azure.microsoft.com/support/options/)

<a name="next-steps"></a>Дальнейшие действия
----------

Узнайте больше о [диагностике и журнале Application Gateway.](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics)
