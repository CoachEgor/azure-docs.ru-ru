---
title: Устранение проблем работоспособности серверной части в шлюзе приложений Azure
description: В этой статье описывается устранение неполадок работоспособности серверной части для шлюза приложений Azure
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: article
ms.date: 08/30/2019
ms.author: surmb
ms.openlocfilehash: 1fd4e9156e29133b1db4fe9ab9a0825eb1aa3b55
ms.sourcegitcommit: cd70273f0845cd39b435bd5978ca0df4ac4d7b2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2019
ms.locfileid: "71097576"
---
<a name="troubleshoot-backend-health-issues-in-application-gateway"></a>Устранение проблем работоспособности серверной части в шлюзе приложений
==================================================

<a name="overview"></a>Обзор
--------

По умолчанию шлюз приложений проверяет состояние работоспособности внутренних серверов и, если они готовы обрабатывать запросы. Пользователи могут создавать пользовательские зонды, а также указывать имя узла, путь для проверки и коды состояния, которые должны приниматься как работоспособные. В обоих случаях, если внутренний сервер не отвечает, шлюз приложений помечает сервер как неработоспособный и не пересылает запрос на сервер. Как только сервер будет успешно реагировать на запросы, он возобновит обслуживание запросов.

### <a name="how-to-check-backend-health"></a>Проверка работоспособности серверной части

Чтобы проверить работоспособность серверного пула, можно использовать страницу "работоспособность серверной части" в портал Azure. Можно также использовать [Azure PowerShell](https://docs.microsoft.com/powershell/module/az.network/get-azapplicationgatewaybackendhealth?view=azps-2.6.0), [CLI](https://docs.microsoft.com/cli/azure/network/application-gateway?view=azure-cli-latest#az-network-application-gateway-show-backend-health)или [REST API](https://docs.microsoft.com/rest/api/application-gateway/applicationgateways/backendhealth) для получения сведений о состоянии работоспособности. Чтобы получить дополнительные сведения, ознакомьтесь со связанными статьями по каждому из методов.

Состояние, полученное любым из указанных выше методов, может иметь три типа:

1.  Работоспособна

2.  Неработоспособно

3.  Неизвестный

Если состояние работоспособности серверной части работоспособно, это означает, что шлюз приложений перенаправит запросы на этот сервер. Но если работоспособность серверной части для всех серверов в серверном пуле неработоспособна или неизвестна, могут возникнуть некоторые проблемы при доступе к приложению. В этом документе описывается симптом, причина и решение каждой ошибки, отображаемой, если внутренние серверы могут быть неработоспособными или неизвестными.

<a name="backend-health-status-unhealthy"></a>Состояние работоспособности серверной части неработоспособно
-------------------------------

Если состояние работоспособности серверной части отображается как неработоспособное, оно появится на портале, как показано ниже.

![Работоспособность серверной части шлюза приложений — неработоспособность](./media/application-gateway-backend-health-troubleshooting/appgwunhealthy.png)

Если вы используете Azure PowerShell, CLI или Azure REST API Query, вы увидите примерно такой ответ:
```azurepowershell
PS C:\Users\testuser\> Get-AzApplicationGatewayBackendHealth -Name "appgw1" -ResourceGroupName "rgOne"
BackendAddressPools :
{Microsoft.Azure.Commands.Network.Models.PSApplicationGatewayBackendHealthPool}
BackendAddressPoolsText : [
{
                              "BackendAddressPool": {
                                "Id": "/subscriptions/536d30b8-665b-40fc-bd7e-68c65f816365/resourceGroups/rgOne/providers/Microsoft.Network/applicationGateways/appgw1/b
                          ackendAddressPools/appGatewayBackendPool"
                              },
                              "BackendHttpSettingsCollection": [
                                {
                                  "BackendHttpSettings": {
                                    "TrustedRootCertificates": [],
                                    "Id": "/subscriptions/536d30b8-665b-40fc-bd7e-68c65f816365/resourceGroups/rgOne/providers/Microsoft.Network/applicationGateways/appg
                          w1/backendHttpSettingsCollection/appGatewayBackendHttpSettings"
                                  },
                                  "Servers": [
                                    {
                                      "Address": "10.0.0.5",
                                      "Health": "Healthy"
                                    },
                                    {
                                      "Address": "10.0.0.6",
                                      "Health": "Unhealthy"
                                    }
                                  ]
                                }
                              ]
                            }
                        ]
```
Когда состояние внутреннего сервера отображается как неработоспособное для всех серверов в серверном пуле, запросы не пересылаются в них, а шлюз приложений вернет ошибку 502 в случае неправильного шлюза запрашивающему клиенту. Чтобы устранить эту проблему, просмотрите столбец сведения на вкладке работоспособность серверной части.

Сообщение, отображаемое в столбце "сведения" на вкладке "работоспособность серверной части", позволяет получить более подробные сведения о данной неполадке и на их основе можно приступить к устранению проблемы.

> [!NOTE]
> Запрос проверки по умолчанию отправляется в формате \<протокола\>://127.0.0.1:\<Port\>/, например, <http://127.0.0.1/> для проверки HTTP на порте 80 и учитывает только ответ от кодов состояния HTTP 200-399. работоспособный ответ. Протокол и порт назначения наследуются от параметров HTTP. Если требуется, чтобы шлюз приложений проверит наличие другого протокола, имени узла или пути и принимал другой код состояния как работоспособный, настройте пользовательскую проверку и свяжите ее с параметрами HTTP.

<a name="error-messages"></a>Сообщения об ошибках
------------------------
#### <a name="backend-server-timeout"></a>Время ожидания внутреннего сервера

**Сообщение**. Время, затраченное серверной частью на реагирование\'на проверку работоспособности шлюза приложений, превышает пороговое значение времени ожидания в параметре проверки.

**Причина.** После того как шлюз приложений отправит запрос проверки HTTP (S) на внутренний сервер, он ждет, пока не будет настроен ответ от внутреннего сервера на определенный период времени. Если внутренний сервер не отвечает в течение времени ожидания, он помечается как неработоспособный, пока не начнет отвечать в течение времени ожидания.

**Способы устранения:** Проверьте на внутреннем сервере или приложении, почему он не отвечает в течение заданного времени ожидания, и проверьте зависимости приложения, например, если в базе данных имеются проблемы, которые могут привести к задержке в ответе. Если вам известно о поведении приложения и он должен отвечать только после истечения времени ожидания, увеличьте значение времени ожидания из пользовательских параметров проверки.
Чтобы изменить значение времени ожидания, необходимо иметь пользовательскую пробу. Если вы хотите узнать, как настроить пользовательскую проверку, [Ознакомьтесь со страницей документации](https://docs.microsoft.com/azure/application-gateway/application-gateway-create-probe-portal).

Чтобы увеличить время ожидания, выполните следующие действия:

1.  Непосредственное обращение к внутреннему серверу и проверка времени, затраченного на ответ сервера на эту страницу. Для доступа к, включая браузер с помощью средств разработчика, можно использовать любой инструмент.

2.  Определив время ответа приложения, перейдите на вкладку зонды работоспособности и выберите проверку, связанную с параметрами HTTP.

3.  Введите любое более позднее значение времени ожидания, чем время ответа приложения в секундах.

4.  Сохраните пользовательские параметры проверки и проверьте работоспособность серверной части, если она отображается в работоспособном состоянии.

#### <a name="dns-resolution-error"></a>Ошибка разрешения DNS

**Сообщение**. Шлюзу приложений не удалось создать зонд для этой серверной части. Обычно это происходит, когда полное доменное имя серверной части не было введено правильно. 

**Причина.** Если серверный пул имеет тип IP-адреса/FQDN или служба приложений, шлюз приложений разрешается в IP-адрес полного доменного имени, введенного с помощью DNS-сервера (настраиваемое или Azure Default), и пытается подключиться к серверу по порту TCP, упомянутому в параметрах HTTP. Но если это сообщение отображается, шлюзу приложений не удалось успешно разрешить IP-адрес указанного FQDN.

**Способы устранения:**

1.  Убедитесь, что полное доменное имя, указанное во внутреннем пуле, является правильным, и если это общедоступный домен, попробуйте разрешить его с локального компьютера.

2.  Если вы можете разрешить IP-адрес, возможно, в виртуальной сети возникли проблемы с конфигурацией DNS.

3.  Проверьте, настроен ли для виртуальной сети настраиваемый DNS-сервер. Если это так, проверьте наличие DNS-сервера, почему он не может быть разрешен по IP-адресу данного полного доменного имени.

4.  Если это DNS Azure по умолчанию, обратитесь к своему регистратору доменных имен, если выполнена правильная запись или сопоставление записи CNAME.

5.  Если домен является частным или внутренним, попробуйте разрешить его из виртуальной машины в той же виртуальной сети. Если вы можете разрешить эту проблему, перезапустите шлюз приложений и снова проверьте его. Чтобы перезапустить шлюз приложений, необходимо [приступить](https://docs.microsoft.com/powershell/module/azurerm.network/start-azurermapplicationgateway?view=azurermps-6.13.0) [к использованию](https://docs.microsoft.com/powershell/module/azurerm.network/stop-azurermapplicationgateway?view=azurermps-6.13.0) команд PowerShell, указанных в соответствующих ссылках на документы.

#### <a name="tcp-connect-error"></a>Ошибка TCP-подключения

**Сообщение**. Шлюзу приложений не удалось подключиться к серверной части.
Убедитесь, что серверная часть отвечает на порт, используемый для пробы.
Также проверьте, блокирует ли любой NSG/UDR/Firewall доступ к IP-адресу и порту этой серверной части.

**Причина.** После фазы разрешения DNS шлюз приложений пытается подключиться к внутреннему серверу через TCP-порт, настроенный в параметрах HTTP. Если шлюзу приложений не удается установить сеанс TCP на указанном порту, проба помечается как неработоспособное с этим сообщением.

**Решение.** Если вы видите эту ошибку, проверьте следующее:

1.  Проверьте, можно ли подключиться к внутреннему серверу на порте, указанном в параметрах HTTP, с помощью браузера или PowerShell, например, можно использовать команду: Test-NetConnection-ComputerName [www.bing.com](www.bing.com)-порт 443

2.  Если порт, который указан, не является нужным, введите правильный номер порта шлюза приложений для подключения к внутреннему серверу.

3.  Если вы не можете подключиться к порту с локального компьютера, выполните следующие действия.

    1\.  Проверьте параметры NSG сетевой карты и подсети внутреннего сервера и проверьте, разрешены ли входящие подключения к настроенному порту. Если они не разрешены, создайте новое правило, разрешающее подключения. Чтобы узнать, как создавать правила NSG, [посетите страницу документации](https://docs.microsoft.com/azure/virtual-network/tutorial-filter-network-traffic#create-security-rules).

    2\.  Проверьте параметры NSG подсети шлюза приложений, если разрешен исходящий общий и частный трафик, чтобы можно было установить соединение. Проверьте документ, связанный в (а), чтобы узнать больше о создании правил NSG.
    ```azurepowershell
            $vnet = Get-AzVirtualNetwork -Name "vnetName" -ResourceGroupName "rgName"
            Get-AzVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
    ```

    В.  Проверьте параметры UDR в подсети шлюза приложений и внутреннего сервера для всех аномалий маршрутизации. Убедитесь, что UDR не направляет трафик вне внутренней подсети. Например, проверьте маршруты к виртуальным сетевым устройствам или маршруты по умолчанию, объявляемые в подсети шлюза приложений через ExpressRoute или VPN.

    Г.  Чтобы проверить действующие маршруты и правила для сетевой карты, можно использовать следующие команды PowerShell.
    ```azurepowershell
            Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName "nic1" -ResourceGroupName "testrg"
            Get-AzEffectiveRouteTable -NetworkInterfaceName "nic1" -ResourceGroupName "testrg"
    ```
4.  Если проблем с NSG или UDR не обнаружено, проверьте наличие проблем, связанных с приложением, на внутреннем сервере, чтобы клиенты не могли установить сеанс TCP на настроенных портах. Необходимо проверить следующие моменты:

    Д.  Откройте командную строку (Win + R\> -cmd) и введите netstat и нажмите клавишу ВВОД.

    f.  Проверьте, прослушивает ли сервер порт, который настроен.
        Пример:
    ```
            Proto Local Address Foreign Address State PID
            TCP 0.0.0.0:80 0.0.0.0:0 LISTENING 4
    ```
    ж.  Если это не так, проверьте параметры веб-сервера, например привязки сайта в IIS, серверный блок в NGINX и виртуальный узел в Apache.

    h.  Проверьте параметры брандмауэра ОС, чтобы убедиться, что входящий трафик к порту разрешен.

#### <a name="http-status-code-mismatch"></a>Несоответствие кода состояния HTTP

**Сообщение**. Код состояния HTTP-ответа\'серверной части не соответствует параметру пробы. Ожидалось: {HTTPStatusCode0} получено: {HTTPStatusCode1}.

**Причина.** После установки подключения TCP и завершения подтверждения SSL (если включен протокол SSL) шлюз приложений отправит зонд в качестве HTTP-запроса GET на внутренний сервер. Как упоминалось выше, проба по умолчанию \<будет\>использоваться протокол://\<127.0.0.1\>: Port/и считает коды состояния ответа в Rage 200-399 в работоспособном состоянии. Если сервер возвращает любой другой код состояния, он будет помечен как неработоспособный с помощью этого сообщения.

**Решение.** В зависимости от кода ответа внутреннего сервера можно выполнить следующие действия. Ниже перечислены некоторые общие коды состояния.

| **Ошибка** | **Действия** |
| --- | --- |
| Несоответствие кода состояния зонда: Получено 401 | Проверьте, требует ли сервер фонового сервера проверки подлинности. На этом этапе зонды шлюза приложений не могут передавать учетные данные для проверки подлинности. Либо \"разрешите\" HTTP 401 в коде состояния зонда, либо выполнит проверку по пути, где сервер не требует проверки подлинности. | |
| Несоответствие кода состояния зонда: Получено 403 | Доступ запрещен. Проверьте, разрешен ли доступ к пути на внутреннем сервере. | |
| Несоответствие кода состояния зонда: Получено 404 | Страница не найдена. Проверьте путь к имени узла, если он доступен на внутреннем сервере. Измените параметр HostName или Path на доступное значение. | |
| Несоответствие кода состояния зонда: Получено 405 | Для пробных запросов шлюза приложений используется метод HTTP GET. Проверьте, разрешен ли сервер. | |
| Несоответствие кода состояния зонда: Получено 500 | Внутренняя ошибка сервера. Проверьте работоспособность внутреннего сервера и убедитесь, что службы работают. | |
| Несоответствие кода состояния зонда: Получено 503 | Служба недоступна. Проверьте работоспособность внутреннего сервера и убедитесь, что службы работают. | |

Или, если вы считаете, что ответ является приемлемым и вы хотите, чтобы шлюз приложений принимал другие коды состояния как работоспособные, можно создать пользовательскую проверку. Изменение этого кода будет полезно в ситуациях, когда веб-сайт внутреннего сервера нуждается в проверке подлинности, а поскольку запросы на пробу не содержат учетных данных пользователя, они завершатся ошибкой и код состояния HTTP 401 будет возвращен внутренним сервером.

Чтобы создать пользовательскую проверку, выполните действия, описанные [здесь](https://docs.microsoft.com/azure/application-gateway/application-gateway-create-probe-portal).

#### <a name="http-response-body-mismatch"></a>Несоответствие тела ответа HTTP

**Сообщение**. Текст HTTP-ответа\'серверной части не соответствует параметру зонда. Полученный текст ответа не содержит {String}.

**Причина.** При создании пользовательской пробы имеется возможность пометить сервер в работоспособном состоянии, сопоставляя строку из текста ответа. Например, можно настроить шлюз приложений таким образом, чтобы он принимал "несанкционированные" в качестве строки для сопоставления. Если ответ внутреннего сервера для запроса пробы содержит строку "несанкционированный", она будет помечена как работоспособная.
В противном случае оно будет отмечено как неработоспособное с помощью этого сообщения.

**Решение.** Эту проблему можно устранить, выполнив следующие действия:

1.  Получите доступ к внутреннему серверу локально или с клиентского компьютера на пути пробы и проверьте текст ответа.

2.  Проверьте конфигурацию пользовательской проверки шлюза приложений, чтобы убедиться, что текст ответа совпадает с настроенным.

3.  Если они не совпадают, измените конфигурацию пробы, указав правильное строковое значение для принятия.

Дополнительные сведения о сопоставлении проверки для шлюза приложений см. [здесь](https://docs.microsoft.com/azure/application-gateway/application-gateway-probe-overview#probe-matching).

#### <a name="backend-server-certificate-invalid-ca"></a>Недопустимый центр сертификации внутреннего сервера

**Сообщение**. Сертификат сервера, используемый серверной частью, не подписан известным центром сертификации (ЦС). Список разрешений серверную часть шлюза приложений, загружая корневой сертификат сертификата сервера, используемого серверной частью.

**Причина.** Сквозной протокол SSL с шлюзом приложений версии 2 требует проверки сертификата внутреннего сервера, чтобы он считался работоспособным сервером.
Чтобы SSL-сертификат был доверенным, этот сертификат должен быть выдан центром сертификации, который входит в доверенное хранилище шлюза приложений. Если сертификат не был выдан доверенным центром сертификации, например самозаверяющим сертификатами, пользователи должны передать сертификат поставщика в шлюз приложений.

**Решение.** Выполните следующие действия, чтобы экспортировать и передать доверенный корневой сертификат в шлюз приложений (указанные ниже действия предназначены для клиентов Windows).

1.  Войдите на компьютер, где размещено ваше приложение

2.  Откройте окно Запуск, нажав клавиши Win + R или щелкнув правой кнопкой мыши кнопку запустить и выбрав команду выполнить.

3.  Введите certmgr. msc и нажмите клавишу ВВОД. Также можно выполнить поиск диспетчера сертификатов в меню "Пуск".

4.  Определение местонахождения сертификата, обычно \'в сертификатах —\\текущих\\персональных\'сертификатов пользователя, и открытие сертификата

5.  В свойствах сертификата перейдите на вкладку путь сертификации.

6.  Выберите корневой сертификат и выберите параметр "Просмотреть сертификат".

7.  В свойствах сертификата перейдите на вкладку сведения.

8.  На вкладке сведения выберите параметр "Копировать в файл" и сохраните файл в кодировке Base-64 X. 509 (. CER) формат

9.  После сохранения откройте страницу параметров HTTP шлюза приложений в портал Azure

10. Откройте параметры HTTP и нажмите кнопку "добавить сертификат" и укажите файл сертификата, который мы недавно сохранили.

11. Нажмите кнопку Сохранить, чтобы сохранить параметры HTTP.

Кроме того, корневой сертификат можно экспортировать с клиентского компьютера путем прямого доступа к серверу (минуя шлюз приложений) с помощью браузера и экспорта корневого сертификата из браузера.

Подробные инструкции по извлечению и отправке доверенных корневых сертификатов в шлюзе приложений см. [здесь](https://docs.microsoft.com/azure/application-gateway/certificates-for-backend-authentication#export-trusted-root-certificate-for-v2-sku).

#### <a name="trusted-root-certificate-mismatch"></a>Несоответствие доверенного корневого сертификата

**Сообщение**. Корневой сертификат сертификата сервера, используемый серверной частью, не совпадает с доверенным корневым сертификатом, добавленным в шлюз приложений. Убедитесь, что вы добавили правильный корневой сертификат для список разрешений серверной части.

**Причина.** Сквозной протокол SSL с шлюзом приложений версии 2 требует проверки сертификата внутреннего сервера, чтобы он считался работоспособным сервером.
Чтобы SSL-сертификат был доверенным, этот сертификат должен быть выдан центром сертификации, который входит в доверенное хранилище шлюза приложений. Если сертификат не был выдан доверенным центром сертификации, например самозаверяющим сертификатами, пользователи должны передать сертификат поставщика в шлюз приложений.

Сертификат, который был отправлен в параметры HTTP шлюза приложений, должен соответствовать корневому сертификату сертификата внутреннего сервера.

**Решение.** Если отображается указанное выше сообщение об ошибке, это означает, что существует несоответствие между сертификатом, который был отправлен в шлюз приложений, и переданным на внутренний сервер.

Выполните шаги 1-11, упомянутые выше, чтобы отправить правильный доверенный корневой сертификат в шлюз приложений.

Подробные инструкции по извлечению и отправке доверенных корневых сертификатов в шлюзе приложений см. [здесь](https://docs.microsoft.com/azure/application-gateway/certificates-for-backend-authentication#export-trusted-root-certificate-for-v2-sku).
> [!NOTE]
> Упомянутая здесь ошибка также может возникать, если внутренний сервер не обменивается полной цепочкой сертификата, включая промежуточную > (если применимо), > конечную папку во время подтверждения TLS. Чтобы проверить, можно использовать команды OpenSSL с любого клиента и подключиться к внутреннему серверу с помощью настроенных параметров в зонде шлюза приложений.

Например, примененная к объекту директива
```
OpenSSL> s_client -connect 10.0.0.4:443 -servername www.example.com -showcerts
```
Если в выходных данных не отображается полная цепочка возвращаемого сертификата, экспортируйте сертификат еще раз с полной цепочкой, включая корневой сертификат, и настройте ее на внутреннем сервере. 

ПОДКЛЮЧЕНО (00000188) \
Глубина = 0 OU = проверенный элемент управления домена, \*CN =. example.com \
Ошибка проверки: num = 20: не удалось получить сертификат локального издателя \
Проверка возврата: 1 \
Глубина = 0 OU = проверенный элемент управления домена, \*CN =. example.com \
Ошибка проверки: num = 21: не удалось проверить первый сертификат \
Проверка возврата: 1 \
\-\-\-\
Цепочка сертификатов \
 0 s:/OU = проверенный элемент управления домена/CN = *. example. com \
   i:/C = US/St = ведение/L = Скоттсдейл/O = GoDaddy. com, Inc./ou =http://certs.godaddy.com/repository//CN=Go Daddy безопасный центр сертификации — G2 \
\-----НАЧАТЬ-----СЕРТИФИКАТА \
кскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскскс \
\----------КОНЕЧНОГО СЕРТИФИКАТА

#### <a name="backend-certificate-invalid-common-name-cn"></a>Неправильное общее имя сертификата внутреннего сервера (CN)

**Сообщение**. Общее имя (CN) внутреннего сертификата не соответствует заголовку узла зонда.

**Причина.** Шлюз приложений проверяет, совпадает ли имя узла, указанное в параметре HTTP серверной части, с общим именем (CN), представленным SSL-сертификатом внутреннего сервера. Это только поведение Standard_v2 и WAF_v2 SKU. В качестве полного доменного имени в адресе серверного пула задается параметр SNI для SKU Standard и WAF.

В SKU v2, если имеется проверка по умолчанию (без настроенных или связанных пользовательских зондов), SNI будет установлен из имени узла, указанного в параметрах HTTP, или если в параметрах HTTP указано "выбрать имя узла из внутреннего адреса", где серверный пул адресов содержит допустимое полное доменное имя.

При наличии пользовательской проверки, связанной с параметрами HTTP, SNI будет установлен из имени узла, упомянутого в пользовательской конфигурации зонда, или если в пользовательской зонде установлен флажок "выбрать имя узла из серверных параметров HTTP", он будет задан из имени узла, указанного в HTTP. Параметры.

Если в параметрах HTTP задано значение "выбрать имя узла из внутреннего адреса", серверный пул адресов должен содержать допустимое полное доменное имя.

Если отображается указанное выше сообщение об ошибке, это означает, что общее имя (CN) внутреннего сертификата не совпадает с именем узла, настроенным в пользовательской зонде, или с параметрами HTTP (в случае выбора параметра «Выбор имени узла из серверной части HTTP»). Если используется проверка по умолчанию, имя узла задается как "127.0.0.1". Если это не требуемое значение, следует создать пользовательскую пробу и связать ее с параметрами HTTP.

**Решение.**

Чтобы устранить эту проблему, выполните следующие действия:

Для Windows:

1.  Войдите на компьютер, где размещено ваше приложение

2.  Откройте окно Запуск, нажав клавиши Win + R или щелкнув правой кнопкой мыши кнопку запустить и выбрав команду выполнить.

3.  Введите certmgr. msc и нажмите клавишу ВВОД. Также можно выполнить поиск диспетчера сертификатов в меню "Пуск".

4.  Определение местонахождения сертификата, обычно \'в сертификатах —\\текущих\\персональных\'сертификатов пользователя, и открытие сертификата

5.  На вкладке сведения проверьте тему сертификата.

6.  Проверьте общее имя сертификата и введите его в поле hostname пользовательской пробы или параметров HTTP (если выбран параметр "выбрать имя узла из серверной части HTTP"). Если это не требуемое имя узла для веб-сайта, необходимо получить сертификат для этого домена или ввести правильное имя узла в конфигурации настраиваемой проверки или HTTP-параметров.

Для Linux с использованием OpenSSL

1.  Выполните эту команду в OpenSSL 
```
openssl x509 -in certificate.crt -text -noout
```

2.  В отображаемых свойствах найдите общее имя сертификата и введите его в поле hostname в параметрах HTTP. Если это не требуемое имя узла для веб-сайта, необходимо получить сертификат для этого домена или ввести правильное имя узла в конфигурации настраиваемой проверки или HTTP-параметров.

#### <a name="backend-certificate-is-invalid"></a>Недопустимый внутренний сертификат

**Сообщение**. Недопустимый внутренний сертификат. Текущая дата находится \"за пределами\" допустимого \"диапазона\" дат и срока действия сертификата.

**Причина.** Каждый сертификат имеет допустимое значение, и HTTPS-соединение не будет защищено, если сертификат SSL сервера не действителен.
Текущие данные должны находиться в пределах допустимого диапазона от до допустимого значения. В противном случае сертификат будет считаться недействительным, и это будет проблемой безопасности. На этом этапе шлюз приложений помечает внутренний сервер как неработоспособный.

**Решение.** Если срок действия SSL-сертификата истек, продлите сертификат у поставщика и обновите параметры сервера с помощью нового сертификата. Если это самозаверяющий сертификат, необходимо создать действительный сертификат и передать корневой сертификат в параметры HTTP шлюза приложений. Для этого выполните следующие действия:

1.  Откройте параметры HTTP шлюза приложений на портале.

2.  Выберите параметры HTTP с просроченным сертификатом, щелкните Добавить сертификат и откройте новый файл сертификата.

3.  Удалите старый сертификат с помощью значка удаления рядом с сертификатом и нажмите кнопку Сохранить.

#### <a name="certificate-verification-failed"></a>Проверка сертификата не пройдена

**Сообщение**. Не удалось проверить допустимость серверного сертификата. Чтобы узнать причину, установите флажок Открыть диагностику SSL для сообщения, связанного с кодом ошибки {errorCode}.

**Причина.** Эта ошибка возникает, когда шлюз приложений не может проверить допустимость сертификата.

**Решение.** Чтобы устранить эту проблему, проверьте сертификат на сервере, если он был создан правильно. Например, можно использовать [OpenSSL](https://www.openssl.org/docs/man1.0.2/man1/verify.html) для проверки сертификата и его свойств и попытаться повторно отправить сертификат в параметры HTTP шлюза приложений.

<a name="backend-health-status-unknown"></a>Неизвестное состояние работоспособности серверной части
-------------------------------
Если работоспособность серверной части отображается как неизвестная, она отобразится на портале, как показано на снимке экрана ниже:

![Работоспособность серверной части шлюза приложений — неизвестно](./media/application-gateway-backend-health-troubleshooting/appgwunknown.png)

Если работоспособность серверной части отображается как неизвестная, это может быть вызвано одной или несколькими из следующих причин.

1.  NSG в подсети шлюза приложений блокирует входящий доступ к портам 65503-65534 (номер SKU v1) или 65200-65535 (SKU v2) из Интернета.
2.  UDR в подсети шлюза приложений с маршрутом по умолчанию (0.0.0.0/0) со следующим прыжком, а не через Интернет
3.  Маршрут по умолчанию, объявленный с помощью ExpressRoute или VPN-подключения к виртуальной сети по протоколу BGP
4.  В виртуальной сети настроен настраиваемый DNS-сервер, который не может разрешать общедоступные доменные имена
5.  Шлюз приложений находится в неработоспособном состоянии

**Решение.**

1.  Проверьте, не блокирует ли NSG доступ к портам 65503-65534 (номер SKU v1) или 65200-65535 (SKU v2) из Интернета.

    1\.  На вкладке "Обзор" шлюза приложений выберите ссылку "Виртуальная сеть/подсеть".

    2\.  На вкладке подсети виртуальной сети выберите подсеть, в которой развернут шлюз приложений.

    В.  Проверьте, настроены ли какие-либо NSG

    Г.  Если таковой имеется, выполните поиск этого ресурса NSG на вкладке Поиск или в разделе все ресурсы.

    Д.  В разделе правила для входящих подключений добавьте правило для входящего трафика, разрешающее диапазон портов назначения 65503-65534 для SKU v1 или 65200-65535 v2 SKU с источником как любой или Интернет.

    f.  Щелкните Сохранить и убедитесь, что вы можете просмотреть работоспособность серверной части успешно.

    ж.  Кроме того, это можно сделать с помощью [PowerShell или CLI](https://docs.microsoft.com/azure/virtual-network/manage-network-security-group) .

2.  Проверьте, имеет ли UDR маршрут по умолчанию (0.0.0.0/0) со следующим прыжком, а не через Интернет.
    
    1\.  Выполните шаги 1. a и 1. b, чтобы определить подсеть.

    2\.  Проверьте, настроены ли UDR. Если таковой имеется, выполните поиск ресурса в строке поиска или в разделе все ресурсы.

    В.  Проверьте наличие маршрутов по умолчанию (0.0.0.0/0) со следующим прыжком, а не через Интернет. Если это виртуальное устройство или шлюз виртуальной сети, необходимо убедиться, что виртуальное устройство или локальное устройство смогут правильно направить пакет в Интернет-назначение, не изменяя пакет

    Г.  В противном случае измените следующий прыжок на Интернет, нажмите кнопку Сохранить и проверьте работоспособность серверной части.

3.  Маршрут по умолчанию, объявленный с помощью ExpressRoute или VPN-подключения к виртуальной сети по протоколу BGP

    1\.  При наличии подключения ExpressRoute или VPN к виртуальной сети по протоколу BGP и при объявлении маршрута по умолчанию необходимо убедиться, что пакет перенаправляется обратно в Интернет, не изменяя его

    2\.  Проверить можно с помощью параметра "Устранение неполадок подключения" на портале шлюза приложений.

    В.  Выберите назначение вручную как любой IP-адрес с маршрутизацией в Интернете, например "1.1.1.1" и порт назначения, и проверьте подключение.

    Г.  Если следующий прыжок является шлюзом виртуальной сети, то может существовать маршрут по умолчанию, объявленный через ExpressRoute или VPN.

4.  Если в виртуальной сети настроен настраиваемый DNS-сервер, проверьте, могут ли серверы разрешать общедоступные домены. Разрешение имени общедоступного домена может потребоваться в сценариях, где шлюз приложений должен быть доступен внешним доменам, например серверам OCSP, или для проверки состояния отзыва сертификата и т. д.

5.  Чтобы убедиться, что шлюз приложений работоспособен и работает, перейдите на Работоспособность ресурсов параметр на портале и проверьте, является ли он работоспособным. Если вы видите состояние неработоспособности или деградации, обратитесь в [службу поддержки](https://azure.microsoft.com/support/options/).

<a name="next-steps"></a>Следующие шаги
----------

Дополнительные сведения о диагностике и ведении журнала шлюза приложений см. [здесь](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics).
