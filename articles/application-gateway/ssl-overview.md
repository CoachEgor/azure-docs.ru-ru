---
title: Включение сквозного режима связи SSL в Шлюзе приложений Azure
description: В этой статье рассматривается поддержка сквозного режима связи SSL в Шлюзе приложений.
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: 64b90afd598b96604fc9c3ddc4bc10586e714363
ms.sourcegitcommit: 7b25c9981b52c385af77feb022825c1be6ff55bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2020
ms.locfileid: "79279108"
---
# <a name="overview-of-ssl-termination-and-end-to-end-ssl-with-application-gateway"></a>Общие сведения о завершении работы SSL и сквозном использовании SSL с помощью шлюза приложений

SSL (SSL) — это стандартная технология безопасности для установления зашифрованной связи между веб-сервером и браузером. Эта ссылка гарантирует, что все данные, передаваемые между веб-сервером и браузерами, остаются закрытыми и зашифрованными. Шлюз приложений поддерживает как прерывание SSL на шлюзе, так и сквозное шифрование SSL.

## <a name="ssl-termination"></a>Завершение SSL-запросов

Шлюз приложений поддерживает функции моста SSL, после применения которых трафик обычно передается в незашифрованном виде на внутренние серверы. Существует ряд преимуществ прерывания SSL на шлюзе приложений.

- **Улучшенная производительность** — первоначальное подтверждение производительности при расшифровке SSL является начальным. Для повышения производительности сервер, выполняющий расшифровку, кэширует идентификаторы сеансов SSL и управляет билетами сеанса TLS. Если это делается в шлюзе приложений, все запросы от одного клиента могут использовать кэшированные значения. Если они выполняются на внутренних серверах, то каждый раз, когда клиентские запросы поступают на другой сервер, он должен пройти повторную проверку подлинности. Использование билетов TLS может помочь устранить эту ошибку, но они не поддерживаются всеми клиентами и могут быть сложными в настройке и управлении.
- **Более эффективное использование внутренних серверов** — обработка SSL/TLS занимает много ресурсов ЦП и становится более ресурсоемким по мере увеличения размеров ключей. Удаление этой работы с внутренних серверов позволяет им сосредоточиться на том, что они наиболее эффективны, доставляя содержимое.
- **Интеллектуальная маршрутизация** — путем расшифровки трафика шлюз приложений имеет доступ к содержимому запроса, такому как заголовки, URI и т. д., и может использовать эти данные для маршрутизации запросов.
- **Управление сертификатами** — сертификаты должны быть приобретены и установлены только на шлюзе приложений, а не на всех внутренних серверах. Это экономит время и деньги.

Чтобы настроить завершение SSL, необходимо добавить в прослушиватель SSL-сертификат, чтобы шлюз приложений наследовал симметричный ключ в соответствии со спецификацией протокола SSL. Затем симметричный ключ используется для шифрования и расшифровки трафика, передаваемого шлюзу. SSL-сертификат должен быть в формате файла обмена личной информацией (PFX). Этот формат файла позволяет экспортировать закрытый ключ, необходимый шлюзу приложений для шифрования и расшифровки трафика.

> [!NOTE] 
>
> Шлюз приложений не предоставляет возможности создания нового сертификата или отправки запроса на сертификат в центр сертификации.

Чтобы SSL-соединение работало, необходимо убедиться, что SSL-сертификат соответствует следующим условиям.

- , Что текущая дата и время находятся в диапазоне дат "действителен с" и "действительно до" в сертификате.
- Общее имя сертификата соответствует заголовку узла в запросе. Например, если клиент запрашивает `https://www.contoso.com/`, то должно использоваться общее имя `www.contoso.com`.

### <a name="certificates-supported-for-ssl-termination"></a>Сертификаты, поддерживаемые для завершения SSL

Шлюз приложений поддерживает следующие типы сертификатов:

- Сертификат ЦС (центр сертификации). сертификат ЦС является цифровым сертификатом, выданным центром сертификации (ЦС).
- Сертификат EV (расширенная проверка). сертификат EV представляет собой стандартную отраслевые рекомендации по сертификатам. Это приведет к последующему включению панели локатора браузера и публикации названия компании.
- Шаблонный сертификат. Этот сертификат поддерживает любое количество поддоменов на основе *. site.com, где ваш поддомен заменит *. Однако он не поддерживает site.com, поэтому если пользователи обращаются к веб-сайту, не вводя в начале «www», то этот сертификат не будет охватываться.
- Самозаверяющие сертификаты. клиентские браузеры не доверяют этим сертификатам и предупреждают пользователя о том, что сертификат виртуальной службы не входит в цепочку доверия. Самозаверяющие сертификаты хорошо подходят для тестирования или сред, где администраторы управляют клиентами и могут безопасно обойти оповещения системы безопасности обозревателя. В производственных рабочих нагрузках никогда не следует использовать самозаверяющие сертификаты.

Дополнительные сведения см. в статье [Настройка завершения SSL с помощью шлюза приложений](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal).

### <a name="size-of-the-certificate"></a>Размер сертификата
Чтобы узнать максимальный поддерживаемый размер SSL-сертификата, проверьте раздел [ограничения шлюза приложений](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits) .

## <a name="end-to-end-ssl-encryption"></a>Сквозное шифрование SSL

Некоторые клиенты могут не пожеланиять незашифрованный обмен данными с внутренними серверами. Причина может заключаться в требованиях безопасности и соответствия или в том, что приложение может принимать только безопасные подключения. Теперь для таких приложений шлюз приложений поддерживает сквозное шифрование SSL.

Сквозное шифрование SSL позволяет безопасно передавать зашифрованные конфиденциальные данные в серверную часть, используя при этом обеспечиваемые шлюзом приложений преимущества балансировки нагрузки уровня 7. Сюда входит сходство сеансов на основе файлов cookie, маршрутизация на основе URL-адресов, поддержка маршрутизации на основе сайтов и возможность внедрения заголовков X-Forwarded-*.

Если на шлюзе приложений настроен сквозной режим связи SSL, он завершает сеансы SSL пользователей на шлюзе и расшифровывает пользовательский трафик. Затем он применяет настроенные правила и выбирает подходящий экземпляр внутреннего пула для передачи трафика в него. Затем шлюз приложений инициирует новое SSL-подключение ко внутреннему серверу и повторно шифрует данные с помощью сертификата открытого ключа внутреннего сервера, прежде чем передать запрос в серверную часть. Любой ответ веб-сервера проходит через тот же процесс на пути к пользователю. Сквозной протокол SSL включается путем установки параметра протокола в [параметре HTTP серверной части](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings) на HTTPS, который затем применяется к внутреннему пулу.

Политика SSL применяется как к внешнему, так и к серверному трафику. На внешнем интерфейсе шлюз приложений выступает в качестве сервера и применяет политику. В серверной части шлюз приложений выступает в качестве клиента и отправляет сведения о протоколе или шифре в качестве предпочтения во время подтверждения SSL.

Шлюз приложений взаимодействует с такими внутренними экземплярами, которые либо список разрешений свой сертификат с шлюзом приложений, либо сертификаты, подписанные хорошо известными центрами сертификации, где CN сертификата совпадает с именем узла в HTTP. параметры серверной части. К ним относятся Доверенные службы Azure, такие как веб-приложения службы приложений Azure и управление API Azure.

Если сертификаты элементов в внутреннем пуле не подписаны хорошо известными центрами сертификации, то для каждого экземпляра во внутреннем пуле с включенным сквозным протоколом SSL необходимо настроить сертификат, чтобы обеспечить безопасную связь. Это гарантирует, что шлюз приложений взаимодействует только с известными экземплярами серверной части, тем самым защищая сквозной обмен данными.

> [!NOTE] 
>
> Настройка сертификата проверки подлинности не требуется для доверенных служб Azure, таких как веб-приложения службы приложений Azure и управление API Azure.

> [!NOTE] 
>
> Сертификат, добавленный в **параметр HTTP серверной части** для проверки подлинности внутренних серверов, может совпадать с сертификатом, добавленным в **прослушиватель** для завершения SSL в шлюзе приложений, или другим для повышения безопасности.

![Сценарий сквозного шифрования SSL][1]

В этом примере запросы, в которых используется TLS1.2, направляются на внутренние серверы в пул 1 с помощью сквозного шифрования SSL.

## <a name="end-to-end-ssl-and-whitelisting-of-certificates"></a>Сквозное шифрование SSL и список разрешенных сертификатов

Шлюз приложений взаимодействует только с известными экземплярами серверной части, которые имеют сертификат из списка разрешений, определенного на шлюзе приложений. Чтобы включить список разрешенных сертификатов, необходимо передать открытый ключ сертификатов внутреннего сервера (а не корневой сертификат) в шлюз приложений. После этого будут разрешены подключения только к известным и включенным в разрешенный список серверам. Оставшиеся серверы будут выдавать ошибку шлюза. Самозаверяющие сертификаты предназначены только для тестирования и не рекомендуются для рабочих нагрузок в рабочей среде. Такие сертификаты нужно добавить в список разрешений с помощью шлюза приложений, как описано ранее, прежде чем их можно будет использовать.

> [!NOTE]
> Для надежных служб Azure, таких как служба приложений Azure, настраивать сертификат аутентификации не нужно.

## <a name="end-to-end-ssl-with-the-v2-sku"></a>Сквозное шифрование SSL в номере SKU версии 2

Сертификаты проверки подлинности устарели и заменены доверенными корневыми сертификатами в номере SKU Шлюза приложений версии 2. Они действуют идентично сертификатам проверки подлинности, за исключением нескольких ключевых различий:

- Сертификаты, подписанные хорошо известными ЦС, общие имена которых совпадают с именем узла в параметрах HTTP серверной части, не требуют никаких дополнительных действий для обеспечения работы сквозного шифрования SSL. 

   Например, если сертификаты серверной части выданы хорошо известным центром сертификации и имеют общее имя contoso.com, а в поле узла в параметрах HTTP внутреннего сервера также указано значение contoso.com, дополнительные действия не требуются. Для протокола в параметрах HTTP серверной части можно задать HTTPS. Таким образом, и для пробы работоспособности, и для пути данных будет включен SSL. Если вы используете службу приложений Azure или другие веб-службы Azure в качестве серверной части, они также являются неявно доверенными и для сквозного шифрования SSL не требуется никаких дополнительных действий.
   
> [!NOTE] 
>
> Чтобы сертификат SSL был доверенным, этот сертификат должен быть выдан центром сертификации, включенным в доверенное хранилище шлюза приложений. Если сертификат не был выдан доверенным центром сертификации, то шлюз приложений проверит чтобы узнать, выдан ли сертификат выдающего ЦС доверенным центром сертификации, и т. д. до тех пор, пока не обнаружится доверенный ЦС (после чего будет установлено доверенное безопасное подключение) или не удастся найти доверенный ЦС (в этом случае шлюз приложений пометит серверную часть неработоспособно). Поэтому рекомендуется, чтобы сертификат внутреннего сервера содержал как корневой, так и интермидиате ЦС.

- Если сертификат самозаверяющий или подписан неизвестными посредниками, тогда для включения сквозного шифрования SSL в номере SKU версии 2 необходимо определить доверенный корневой сертификат. Шлюз приложений будет взаимодействовать только с серверными частями, корневой сертификат сертификата сервера которых совпадает с одним из сертификатов из списка доверенных корневых сертификатов в параметре HTTP серверной части, который связан с пулом.

> [!NOTE] 
>
> Самозаверяющий сертификат должен быть частью цепочки сертификатов. Один самозаверяющий сертификат без цепочки не поддерживается в SKU v2.

- Помимо соответствия корневому сертификату Шлюз приложений также проверяет, соответствуют ли параметры узла, указанные в параметрах HTTP серверной части, обычному имени, представленному сертификатом SSL внутреннего сервера. При попытке установить SSL-подключение к серверной части Шлюз приложений задает расширение SNI узлу, указанному в параметрах HTTP серверной части.
- Если в параметре HTTP серверной части **выбрать имя узла из адреса серверной части** вместо поля узла, то заголовок SNI всегда будет со значением полного доменного имени узла серверной части. Общее имя в сертификате SSL внутреннего сервера должно соответствовать полному доменному имени. В этом сценарии не поддерживаются участники внутреннего пула с IP-адресами.
- Корневой сертификат — это закодированный в Base64 корневой сертификат из списка сертификатов внутреннего сервера.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомившись со сквозным шифрованием SSL, [настройте сквозное шифрование SSL в Шлюзе приложений с помощью PowerShell](application-gateway-end-to-end-ssl-powershell.md), чтобы создать шлюз приложений, использующий сквозное шифрование SSL.

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
