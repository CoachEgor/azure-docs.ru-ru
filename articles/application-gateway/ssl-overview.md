---
title: Включение конца в конец TLS на шлюзе приложений Azure
description: Эта статья представляет собой обзор до конца службы поддержки TLS для шлюза приложения.
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: ae80b49c3bfb40743665768622d3f4a8a6990c12
ms.sourcegitcommit: 7e04a51363de29322de08d2c5024d97506937a60
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81311851"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>Обзор прекращения TLS и от завершения TLS с помощью шлюза приложений

Transport Layer Security (TLS), ранее известная как Secure Sockets Layer (SSL), является стандартной технологией безопасности для установления зашифрованной связи между веб-сервером и браузером. Эта ссылка гарантирует, что все данные, передаваемые между веб-сервером и браузерами, остаются конфиденциальными и зашифрованными. Шлюз приложения поддерживает как прекращение TLS на шлюзе, так и от окончания шифрования TLS.

## <a name="tls-termination"></a>Прекращение TLS

Application Gateway поддерживает прекращение TLS на шлюзе, после чего трафик обычно течет незашифрованным к серверам бэкэнда. Существует ряд преимуществ завершения TLS на шлюзе приложения:

- **Улучшенная производительность** - Самый большой хит производительности при выполнении TLS расшифровки является первоначальное рукопожатие. Чтобы повысить производительность, сервер, выполняя разшивку кэша TLS, идентионирует идентиматологию сеансов TLS и управляет билетами на сеансы TLS. Если это делается на шлюзе приложения, все запросы одного и того же клиента могут использовать кэшированные значения. Если это делается на серверах бэкэнда, то каждый раз, когда запросы клиента переходят на другой сервер, клиент должен повторно аутентифицировать. Использование билетов TLS может помочь смягчить эту проблему, но они поддерживаются не всеми клиентами и могут быть трудно настроить и управлять.
- **Лучшее использование серверов бэкэнда** - SSL/TLS обработка очень интенсивно, и становится все более интенсивным, как ключевые размеры увеличиваются. Удаление этой работы с серверов бэкэнда позволяет им сосредоточиться на том, на чем они наиболее эффективны, обеспечивая предоставление контента.
- **Интеллектуальная маршрутизирующая -** Расшифровка трафика, шлюз приложения имеет доступ к содержимому запроса, например заголовки, URI и так далее, и может использовать эти данные для запросов маршрутов.
- **Управление сертификатами** - Сертификаты нужно только приобрести и установить на шлюзе приложения, а не на всех серверах бэкэнда. Это экономит время и деньги.

Для настройки прекращения TLS слушателю необходимо добавить сертификат TLS/SSL, чтобы шлюз приложения получил симметричный ключ в соответствии с спецификацией протокола TLS/SSL. Затем симметричный ключ используется для шифрования и расшифровки трафика, отправленного на шлюз. Сертификат TLS/SSL должен быть в формате Обмена личной информацией (PFX). Этот формат файла позволяет экспортировать закрытый ключ, необходимый шлюзу приложений для шифрования и расшифровки трафика.

> [!NOTE] 
>
> Шлюз приложения не предоставляет возможности для создания нового сертификата или отправки запроса на сертификацию.

Для работы подключения TLS необходимо убедиться, что сертификат TLS/SSL соответствует следующим условиям:

- Что текущая дата и время находятся в пределах диапазона дат "Valid from" и "Valid to" в сертификате.
- Общее имя сертификата соответствует заголовку узла в запросе. Например, если клиент запрашивает `https://www.contoso.com/`, то должно использоваться общее имя `www.contoso.com`.

### <a name="certificates-supported-for-tls-termination"></a>Сертификаты, поддерживаемые для прекращения TLS

Шлюз приложения поддерживает следующие типы сертификатов:

- Сертификат CA (Certificate Authority): Сертификат CA является цифровым сертификатом, выданным сертификационным органом (CA)
- Сертификат EV (Расширенная проверка): Сертификат EV является сертификатом, который соответствует отраслевым стандартам сертификата. Это превратит бар локатора браузера зеленый и опубликовать название компании, а также.
- Сертификат Wildcard: Этот сертификат поддерживает любое количество поддоменов на основе site.com, где ваш поддомен заменит q. Это, однако, не поддерживает site.com, так что в случае, если пользователи имеют доступ к вашему веб-сайту без ввода ведущих "www", подстановочный сертификат не будет охватывать это.
- Сертификаты самостоятельной подписи: Клиентские браузеры не доверяют этим сертификатам и предупреждают пользователя о том, что сертификат виртуального сервиса не является частью цепочки доверия. Сертификаты, подписанные самостоятельно, хороши для тестирования или сред, где администраторы контролируют клиентов и могут безопасно обойти оповещения браузера о безопасности. Производственные нагрузки никогда не должны использовать самоподписанные сертификаты.

Для получения дополнительной информации [см.](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal)

### <a name="size-of-the-certificate"></a>Размер сертификата
Проверьте раздел [ограничений gateway application,](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits) чтобы узнать максимальный размер сертификата TLS/SSL.

## <a name="end-to-end-tls-encryption"></a>От окончания до конца шифрования TLS

Некоторые клиенты могут не желать незашифрованной связи с серверами бэкэнда. Причина может заключаться в требованиях безопасности и соответствия или в том, что приложение может принимать только безопасные подключения. Для таких приложений шлюз приложения поддерживает конец до конца шифрования TLS.

От к конца TLS позволяет безопасно передавать конфиденциальные данные в зашифрованный бэкэнд, пользуясь преимуществами функций балансировки нагрузки уровня 7, которые предоставляет шлюз приложения. Сюда входит сходство сеансов на основе файлов cookie, маршрутизация на основе URL-адресов, поддержка маршрутизации на основе сайтов и возможность внедрения заголовков X-Forwarded-*.

При настройке с режимом связи от конца до конца TLS шлюз приложения прекращает сеансы TLS на шлюзе и расшифровывает пользовательский трафик. Затем он применяет настроенные правила и выбирает подходящий экземпляр внутреннего пула для передачи трафика в него. Затем шлюз приложения инициирует новое подключение TLS к серверу бэкэнда и повторно шифрует данные с помощью публичного ключевого сертификата сервера бэкэнда перед передачей запроса в бэкэнд. Любой ответ веб-сервера проходит через тот же процесс на пути к пользователю. От конца до конца TLS включен путем установки протокола в [настройке Backend HTTP](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings) к HTTPS, которая затем применяется к пулу бэкэнда.

Политика TLS применяется как к фронталью, так и к бэкэнд-трафику. На переднем конце, Application Gateway выступает в качестве сервера и обеспечивает соблюдение политики. На бэкэнде, Application Gateway выступает в качестве клиента и отправляет информацию о протоколе/шифре в качестве предпочтения во время рукопожатия TLS.

Шлюз приложения общается только с теми бэкэнд-экземплярами, которые либо в белом списке их сертификата с шлюзом приложения или чьи сертификаты подписаны хорошо известными органами CA, где сертификат CN соответствует имени хоста в настройках бэкэнда HTTP. К ним относятся надежные службы Azure, такие как веб-приложения службы приложений Azure и управление API Azure.

Если сертификаты членов в пуле бэкэнда не подписаны хорошо известными органами CA, то каждый экземпляр в пуле бэкэнда с включенным от конца до конца включенным TLS должен быть настроен с сертификатом, позволяющим обеспечить безопасную связь. Это гарантирует, что шлюз приложений взаимодействует только с известными экземплярами серверной части, тем самым защищая сквозной обмен данными.

> [!NOTE] 
>
> Настройка сертификата аутентификации не требуется для надежных служб Azure, таких как веб-приложения службы приложений Azure App и Управление API Azure.

> [!NOTE] 
>
> Сертификат, добавленный в **Backend HTTP Setting** для проверки подлинности серверов бэкэнда, может быть таким же, как и сертификат, добавленный **слушателю** для прекращения TLS в шлюзе приложения, или другой для повышения безопасности.

![от конца до конца tls сценарий][1]

В этом примере запросы с использованием TLS1.2 направляются на серверы бэкэнда в пуле1 с использованием от конца до конца TLS.

## <a name="end-to-end-tls-and-whitelisting-of-certificates"></a>Конец до конца TLS и белый список сертификатов

Шлюз приложений взаимодействует только с известными экземплярами серверной части, которые имеют сертификат из списка разрешений, определенного на шлюзе приложений. Чтобы включить список разрешенных сертификатов, необходимо передать открытый ключ сертификатов внутреннего сервера (а не корневой сертификат) в шлюз приложений. После этого будут разрешены подключения только к известным и включенным в разрешенный список серверам. Оставшиеся серверы будут выдавать ошибку шлюза. Самозаверяющие сертификаты предназначены только для тестирования и не рекомендуются для рабочих нагрузок в рабочей среде. Такие сертификаты нужно добавить в список разрешений с помощью шлюза приложений, как описано ранее, прежде чем их можно будет использовать.

> [!NOTE]
> Для надежных служб Azure, таких как служба приложений Azure, настраивать сертификат аутентификации не нужно.

## <a name="end-to-end-tls-with-the-v2-sku"></a>От конца до конца TLS с v2 SKU

Сертификаты проверки подлинности устарели и заменены доверенными корневыми сертификатами в номере SKU Шлюза приложений версии 2. Они действуют идентично сертификатам проверки подлинности, за исключением нескольких ключевых различий:

- Сертификаты, подписанные известными органами CA, чей CN соответствует имени хозяина в настройках бэкэнда HTTP, не требует каких-либо дополнительных шагов для работы tLS с окончанием до конца. 

   Например, если сертификаты серверной части выданы хорошо известным центром сертификации и имеют общее имя contoso.com, а в поле узла в параметрах HTTP внутреннего сервера также указано значение contoso.com, дополнительные действия не требуются. Можно настроить протокол настройки бэкэнда http на HTTPS, и как зонд работоспособности, так и путь данных будут включены TLS. Если вы используете службу приложений Azure или другие веб-сервисы Azure в качестве бэкэнда, то им также неявно доверяют, и для окончания TLS не требуются дальнейшие шаги.
   
> [!NOTE] 
>
> Для того, чтобы сертификату TLS/SSL доверяли, что сертификат сервера бэкэнда должен быть выдан CA, который включен в доверенный магазин приложения Gateway.If сертификат не был выдан доверенным CA, приложение шлюз будет проверять, чтобы увидеть, если сертификат выдачи CA был выдан доверенным CA, и так далее, пока либо доверенных CA найден (в этот момент доверенное, безопасное соединение будет установлено) или не доверенных CA может быть найден (в какой точке небудет. Поэтому рекомендуется, чтобы серверный сертификат бэкэнда содержал как корневые, так и промежуточные CA.

- Если сертификат подписан самостоятельно или подписан неизвестными посредниками, то для того, чтобы до конца TLS в v2 SKU, должен быть определен доверенный корневой сертификат. Шлюз приложений будет взаимодействовать только с серверными частями, корневой сертификат сертификата сервера которых совпадает с одним из сертификатов из списка доверенных корневых сертификатов в параметре HTTP серверной части, который связан с пулом.

> [!NOTE] 
>
> Самоподписанный сертификат должен быть частью цепочки сертификатов. В V2 SKU не поддерживается единый самоподписанный сертификат без цепочки.

- В дополнение к матчу корневого сертификата, Application Gateway также проверяет, соответствует ли параметр хоста, указанный в настройке бэкэнда http, атакжем катом общего имени (CN), представленного сертификатом TLS/SSL сервера бэкэнда. При попытке установить соединение TLS с бэкэндом шлюз приложения устанавливает расширение указания на имя сервера (SNI) на хост, указанный в настройке бэкэнда http.
- Если вместо поля хоста в бэкэнде выбрано **выбрать хост-поле,** то заголовок SNI всегда устанавливается в пул бэкэнда F'DN и CN на сервере бэкэнда TLS/SSL сертификат должен соответствовать его F-DN. В этом сценарии не поддерживаются члены пула бэкэнда с ИП.
- Корневой сертификат — это закодированный в Base64 корневой сертификат из списка сертификатов внутреннего сервера.

## <a name="next-steps"></a>Следующие шаги

Узнав о конце до конца TLS, перейдите к [настройке конца до конца TLS, используя шлюз приложений с PowerShell](application-gateway-end-to-end-ssl-powershell.md) для создания шлюза приложения, используя от конца до конца TLS.

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
