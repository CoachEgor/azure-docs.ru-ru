---
title: Включение сквозного режима связи SSL в Шлюзе приложений Azure
description: В этой статье рассматривается поддержка сквозного режима связи SSL в Шлюзе приложений.
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: 9c4e6124acdbb35233f8e829f43d2665fd4a5176
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80284812"
---
# <a name="overview-of-ssl-termination-and-end-to-end-ssl-with-application-gateway"></a>Обзор прекращения SSL и окончания SSL с помощью шлюза приложений

Безопасный слой розеток (SSL) является стандартной технологией безопасности для установления зашифрованной связи между веб-сервером и браузером. Эта ссылка гарантирует, что все данные, передаваемые между веб-сервером и браузерами, остаются конфиденциальными и зашифрованными. Шлюз приложения поддерживает как прекращение SSL на шлюзе, так и от окончания SSL-шифрования.

## <a name="ssl-termination"></a>Завершение SSL-запросов

Шлюз приложений поддерживает функции моста SSL, после применения которых трафик обычно передается в незашифрованном виде на внутренние серверы. Есть ряд преимуществ выполнения SSL-прекращения на шлюзе приложения:

- **Улучшенная производительность** - Самый большой хит производительности при выполнении SSL расшифровки является первоначальное рукопожатие. Чтобы повысить производительность, сервер, выполняя разшительные кэши SSL-идентипов идентионсы сеансов и управляет билетами на сеансЫ TLS. Если это делается на шлюзе приложения, все запросы одного и того же клиента могут использовать кэшированные значения. Если это делается на серверах бэкэнда, то каждый раз, когда запросы клиента переходят на другой сервер, клиент должен повторно аутентифицировать. Использование билетов TLS может помочь смягчить эту проблему, но они поддерживаются не всеми клиентами и могут быть трудно настроить и управлять.
- **Лучшее использование серверов бэкэнда** - SSL/TLS обработка очень интенсивно, и становится все более интенсивным, как ключевые размеры увеличиваются. Удаление этой работы с серверов бэкэнда позволяет им сосредоточиться на том, на чем они наиболее эффективны, обеспечивая предоставление контента.
- **Интеллектуальная маршрутизирующая -** Расшифровка трафика, шлюз приложения имеет доступ к содержимому запроса, например заголовки, URI и так далее, и может использовать эти данные для запросов маршрутов.
- **Управление сертификатами** - Сертификаты нужно только приобрести и установить на шлюзе приложения, а не на всех серверах бэкэнда. Это экономит время и деньги.

Для настройки sSL-прекращения слушателю требуется добавить сертификат SSL, чтобы шлюз приложения получил симметричный ключ в соответствии со спецификацией протокола SSL. Затем симметричный ключ используется для шифрования и расшифровки трафика, отправленного на шлюз. Сертификат SSL должен быть в формате Обмена личной информацией (PFX). Этот формат файла позволяет экспортировать закрытый ключ, необходимый шлюзу приложений для шифрования и расшифровки трафика.

> [!NOTE] 
>
> Шлюз приложения не предоставляет возможности для создания нового сертификата или отправки запроса на сертификацию.

Для работы SSL-соединения необходимо убедиться, что сертификат SSL соответствует следующим условиям:

- Что текущая дата и время находятся в пределах диапазона дат "Valid from" и "Valid to" в сертификате.
- Общее имя сертификата соответствует заголовку узла в запросе. Например, если клиент запрашивает `https://www.contoso.com/`, то должно использоваться общее имя `www.contoso.com`.

### <a name="certificates-supported-for-ssl-termination"></a>Сертификаты, поддерживаемые для прекращения SSL

Шлюз приложения поддерживает следующие типы сертификатов:

- Сертификат CA (Certificate Authority): Сертификат CA является цифровым сертификатом, выданным сертификационным органом (CA)
- Сертификат EV (Расширенная проверка): Сертификат EV является сертификатом, который соответствует отраслевым стандартам сертификата. Это превратит бар локатора браузера зеленый и опубликовать название компании, а также.
- Сертификат Wildcard: Этот сертификат поддерживает любое количество поддоменов на основе site.com, где ваш поддомен заменит q. Это, однако, не поддерживает site.com, так что в случае, если пользователи имеют доступ к вашему веб-сайту без ввода ведущих "www", подстановочный сертификат не будет охватывать это.
- Сертификаты самостоятельной подписи: Клиентские браузеры не доверяют этим сертификатам и предупреждают пользователя о том, что сертификат виртуального сервиса не является частью цепочки доверия. Сертификаты, подписанные самостоятельно, хороши для тестирования или сред, где администраторы контролируют клиентов и могут безопасно обойти оповещения браузера о безопасности. Производственные нагрузки никогда не должны использовать самоподписанные сертификаты.

Для получения дополнительной информации [см.](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal)

### <a name="size-of-the-certificate"></a>Размер сертификата
Проверьте раздел [ограничений gateway application,](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits) чтобы узнать максимальный размер сертификата SSL, поддерживаемый.

## <a name="end-to-end-ssl-encryption"></a>Конец до конца SSL шифрования

Некоторые клиенты могут не желать незашифрованной связи с серверами бэкэнда. Причина может заключаться в требованиях безопасности и соответствия или в том, что приложение может принимать только безопасные подключения. Теперь для таких приложений шлюз приложений поддерживает сквозное шифрование SSL.

Сквозное шифрование SSL позволяет безопасно передавать зашифрованные конфиденциальные данные в серверную часть, используя при этом обеспечиваемые шлюзом приложений преимущества балансировки нагрузки уровня 7. Сюда входит сходство сеансов на основе файлов cookie, маршрутизация на основе URL-адресов, поддержка маршрутизации на основе сайтов и возможность внедрения заголовков X-Forwarded-*.

Если на шлюзе приложений настроен сквозной режим связи SSL, он завершает сеансы SSL пользователей на шлюзе и расшифровывает пользовательский трафик. Затем он применяет настроенные правила и выбирает подходящий экземпляр внутреннего пула для передачи трафика в него. Затем шлюз приложений инициирует новое SSL-подключение ко внутреннему серверу и повторно шифрует данные с помощью сертификата открытого ключа внутреннего сервера, прежде чем передать запрос в серверную часть. Любой ответ веб-сервера проходит через тот же процесс на пути к пользователю. От конца до конца SSL включен путем установки протокола в [настройке Backend HTTP](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings) к HTTPS, которая затем применяется к пулу бэкэнда.

Политика SSL применяется как к фронтовому, так и к бэкэнд-трафику. На переднем конце, Application Gateway выступает в качестве сервера и обеспечивает соблюдение политики. На бэкэнде, Application Gateway выступает в качестве клиента и отправляет информацию о протоколе/шифре в качестве предпочтения во время рукопожатия SSL.

Шлюз приложения общается только с теми бэкэнд-экземплярами, которые либо изготавливали свой сертификат в белом списке с шлюзом приложения, либо сертификаты которых подписаны известными органами CA, где сертификат CN соответствует имени хозяина в HTTP настройки бэкэнда. К ним относятся надежные службы Azure, такие как веб-приложения службы приложений Azure и управление API Azure.

Если сертификаты членов в пуле бэкэнда не подписаны хорошо известными органами CA, то каждый экземпляр в пуле бэкэнда с включенным sSL от конца до конца должен быть настроен с сертификатом, позволяющим обеспечить безопасную связь. Это гарантирует, что шлюз приложений взаимодействует только с известными экземплярами серверной части, тем самым защищая сквозной обмен данными.

> [!NOTE] 
>
> Настройка сертификата аутентификации не требуется для надежных служб Azure, таких как веб-приложения службы приложений Azure App и Управление API Azure.

> [!NOTE] 
>
> Сертификат, добавленный в **Backend HTTP Setting** для проверки подлинности серверов бэкэнда, может быть таким же, как и сертификат, добавленный **слушателю** для прекращения SSL в шлюзе приложения, или другой для повышения безопасности.

![Сценарий сквозного шифрования SSL][1]

В этом примере запросы, в которых используется TLS1.2, направляются на внутренние серверы в пул 1 с помощью сквозного шифрования SSL.

## <a name="end-to-end-ssl-and-whitelisting-of-certificates"></a>Сквозное шифрование SSL и список разрешенных сертификатов

Шлюз приложений взаимодействует только с известными экземплярами серверной части, которые имеют сертификат из списка разрешений, определенного на шлюзе приложений. Чтобы включить список разрешенных сертификатов, необходимо передать открытый ключ сертификатов внутреннего сервера (а не корневой сертификат) в шлюз приложений. После этого будут разрешены подключения только к известным и включенным в разрешенный список серверам. Оставшиеся серверы будут выдавать ошибку шлюза. Самозаверяющие сертификаты предназначены только для тестирования и не рекомендуются для рабочих нагрузок в рабочей среде. Такие сертификаты нужно добавить в список разрешений с помощью шлюза приложений, как описано ранее, прежде чем их можно будет использовать.

> [!NOTE]
> Для надежных служб Azure, таких как служба приложений Azure, настраивать сертификат аутентификации не нужно.

## <a name="end-to-end-ssl-with-the-v2-sku"></a>Сквозное шифрование SSL в номере SKU версии 2

Сертификаты проверки подлинности устарели и заменены доверенными корневыми сертификатами в номере SKU Шлюза приложений версии 2. Они действуют идентично сертификатам проверки подлинности, за исключением нескольких ключевых различий:

- Сертификаты, подписанные хорошо известными ЦС, общие имена которых совпадают с именем узла в параметрах HTTP серверной части, не требуют никаких дополнительных действий для обеспечения работы сквозного шифрования SSL. 

   Например, если сертификаты серверной части выданы хорошо известным центром сертификации и имеют общее имя contoso.com, а в поле узла в параметрах HTTP внутреннего сервера также указано значение contoso.com, дополнительные действия не требуются. Для протокола в параметрах HTTP серверной части можно задать HTTPS. Таким образом, и для пробы работоспособности, и для пути данных будет включен SSL. Если вы используете службу приложений Azure или другие веб-сервисы Azure в качестве бэкэнда, то им также неявно доверяют, и для окончания SSL не требуются дальнейшие шаги.
   
> [!NOTE] 
>
> Для того, чтобы сертификатs SSL был доверен, этот сертификат сервера бэкэнда должен быть выдан CA, который включен в доверенный магазин Gateway Application.If сертификат не был выдан доверенным CA, шлюз приложения будет проверять чтобы увидеть, если сертификат выдачи CA был выдан доверенным CA, и так далее, пока либо доверенных CA найден (в этот момент доверенное, безопасное соединение будет установлено) или не доверенных CA может быть найден (в этот момент приложение шлюз будет отмечать бэкэнд нездоровый). Поэтому рекомендуется, чтобы серверный сертификат бэкэнда содержал как корневые, так и промежуточные CA.

- Если сертификат самозаверяющий или подписан неизвестными посредниками, тогда для включения сквозного шифрования SSL в номере SKU версии 2 необходимо определить доверенный корневой сертификат. Шлюз приложений будет взаимодействовать только с серверными частями, корневой сертификат сертификата сервера которых совпадает с одним из сертификатов из списка доверенных корневых сертификатов в параметре HTTP серверной части, который связан с пулом.

> [!NOTE] 
>
> Самоподписанный сертификат должен быть частью цепочки сертификатов. В V2 SKU не поддерживается единый самоподписанный сертификат без цепочки.

- Помимо соответствия корневому сертификату Шлюз приложений также проверяет, соответствуют ли параметры узла, указанные в параметрах HTTP серверной части, обычному имени, представленному сертификатом SSL внутреннего сервера. При попытке установить SSL-подключение к серверной части Шлюз приложений задает расширение SNI узлу, указанному в параметрах HTTP серверной части.
- Если в параметре HTTP серверной части **выбрать имя узла из адреса серверной части** вместо поля узла, то заголовок SNI всегда будет со значением полного доменного имени узла серверной части. Общее имя в сертификате SSL внутреннего сервера должно соответствовать полному доменному имени. В этом сценарии не поддерживаются члены пула бэкэнда с ИП.
- Корневой сертификат — это закодированный в Base64 корневой сертификат из списка сертификатов внутреннего сервера.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомившись со сквозным шифрованием SSL, [настройте сквозное шифрование SSL в Шлюзе приложений с помощью PowerShell](application-gateway-end-to-end-ssl-powershell.md), чтобы создать шлюз приложений, использующий сквозное шифрование SSL.

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
