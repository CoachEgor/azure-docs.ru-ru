---
title: Включение сквозного TLS в Шлюзе приложений Azure
description: В этой статье приводятся общие сведения о сквозной поддержке TLS в шлюзе приложений.
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: 286c9329be38055808571d8d32c724d27a61cbf3
ms.sourcegitcommit: c535228f0b77eb7592697556b23c4e436ec29f96
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2020
ms.locfileid: "82855876"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>Общие сведения о завершении работы TLS и сквозном TLS с помощью шлюза приложений

Протокол TLS, ранее известный как SSL (SSL), является стандартной технологией безопасности для установления зашифрованной связи между веб-сервером и браузером. Эта ссылка гарантирует, что все данные, передаваемые между веб-сервером и браузерами, остаются закрытыми и зашифрованными. Шлюз приложений поддерживает как завершение TLS в шлюзе, так и сквозное шифрование TLS.

## <a name="tls-termination"></a>Терминирование TLS

Шлюз приложений поддерживает завершение TLS на шлюзе, после чего трафик, как правило, передается в незашифрованном виде на внутренние серверы. Существует ряд преимуществ выполнения прерывания TLS на шлюзе приложений.

- **Повышенная производительность** . при расшифровке TLS наибольшее снижение производительности является начальным подтверждением. Для повышения производительности сервер, выполняющий расшифровку, кэширует идентификаторы сеанса TLS и управляет билетами сеанса TLS. Если это делается в шлюзе приложений, все запросы от одного клиента могут использовать кэшированные значения. Если они выполняются на внутренних серверах, то каждый раз, когда клиентские запросы переходят на другой сервер, клиент должен пройти повторную проверку подлинности. Использование билетов TLS может помочь устранить эту ошибку, но они не поддерживаются всеми клиентами и могут быть сложными в настройке и управлении.
- **Более эффективное использование внутренних серверов** — обработка SSL/TLS занимает много ресурсов ЦП и становится более ресурсоемким по мере увеличения размеров ключей. Удаление этой работы с внутренних серверов позволяет им сосредоточиться на том, что они наиболее эффективны, доставляя содержимое.
- **Интеллектуальная маршрутизация** — путем расшифровки трафика шлюз приложений имеет доступ к содержимому запроса, такому как заголовки, URI и т. д., и может использовать эти данные для маршрутизации запросов.
- **Управление сертификатами** — сертификаты должны быть приобретены и установлены только на шлюзе приложений, а не на всех внутренних серверах. Это экономит время и деньги.

Чтобы настроить завершение TLS, необходимо добавить в прослушиватель сертификат TLS/SSL, чтобы шлюз приложений наследовал симметричный ключ в соответствии со спецификацией протокола TLS/SSL. Затем симметричный ключ используется для шифрования и расшифровки трафика, передаваемого шлюзу. Сертификат TLS/SSL должен быть в формате обмена личной информацией (PFX). Этот формат файла позволяет экспортировать закрытый ключ, необходимый шлюзу приложений для шифрования и расшифровки трафика.

> [!IMPORTANT] 
> Обратите внимание, что сертификату для прослушивателя требуется, чтобы была отправлена вся цепочка сертификатов. 


> [!NOTE] 
>
> Шлюз приложений не предоставляет возможности создания нового сертификата или отправки запроса на сертификат в центр сертификации.

Чтобы TLS-подключение работало, необходимо убедиться, что сертификат TLS/SSL соответствует следующим условиям.

- , Что текущая дата и время находятся в диапазоне дат "действителен с" и "действительно до" в сертификате.
- Общее имя сертификата соответствует заголовку узла в запросе. Например, если клиент запрашивает `https://www.contoso.com/`, то должно использоваться общее имя `www.contoso.com`.

### <a name="certificates-supported-for-tls-termination"></a>Сертификаты, поддерживаемые для завершения TLS

Шлюз приложений поддерживает следующие типы сертификатов:

- Сертификат ЦС (центр сертификации). сертификат ЦС является цифровым сертификатом, выданным центром сертификации (ЦС).
- Сертификат EV (расширенная проверка). сертификат EV — это сертификат, который соответствует отраслевым рекомендациям по сертификатам. Это приведет к включению панели локатора браузера зеленым и публикации названия компании.
- Шаблонный сертификат. Этот сертификат поддерживает любое количество поддоменов на основе *. site.com, где ваш поддомен заменит *. Однако он не поддерживает site.com, поэтому если пользователи обращаются к веб-сайту, не вводя в начале «www», то этот сертификат не будет охватываться.
- Самозаверяющие сертификаты. клиентские браузеры не доверяют этим сертификатам и предупреждают пользователя о том, что сертификат виртуальной службы не входит в цепочку доверия. Самозаверяющие сертификаты хорошо подходят для тестирования или сред, где администраторы управляют клиентами и могут безопасно обойти оповещения системы безопасности обозревателя. В производственных рабочих нагрузках никогда не следует использовать самозаверяющие сертификаты.

Дополнительные сведения см. [в статье Настройка завершения TLS с помощью шлюза приложений](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal).

### <a name="size-of-the-certificate"></a>Размер сертификата
См. раздел [ограничения шлюза приложений](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits) , чтобы узнать максимальный поддерживаемый размер сертификата TLS/SSL.

## <a name="end-to-end-tls-encryption"></a>Сквозное шифрование TLS

Некоторые клиенты могут не пожеланиять незашифрованный обмен данными с внутренними серверами. Причина может заключаться в требованиях безопасности и соответствия или в том, что приложение может принимать только безопасные подключения. Для таких приложений шлюз приложений поддерживает сквозное шифрование TLS.

Комплексное шифрование TLS позволяет безопасно передавать конфиденциальные данные в серверную часть, используя преимущества функций балансировки нагрузки уровня 7, предоставляемых шлюзом приложений. Сюда входит сходство сеансов на основе файлов cookie, маршрутизация на основе URL-адресов, поддержка маршрутизации на основе сайтов и возможность внедрения заголовков X-Forwarded-*.

При настройке режима сквозной связи TLS шлюз приложений прерывает сеансы TLS на шлюзе и расшифровывает пользовательский трафик. Затем он применяет настроенные правила и выбирает подходящий экземпляр внутреннего пула для передачи трафика в него. Затем шлюз приложений инициирует новое TLS-подключение к внутреннему серверу и повторно шифрует данные с помощью сертификата открытого ключа внутреннего сервера, прежде чем передавать запрос в серверную часть. Любой ответ веб-сервера проходит через тот же процесс на пути к пользователю. Сквозной протокол TLS включается путем установки параметра протокола в [параметре HTTP серверной части](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings) на HTTPS, который затем применяется к внутреннему пулу.

Политика TLS применяется как для внешнего, так и для серверного трафика. На внешнем интерфейсе шлюз приложений выступает в качестве сервера и применяет политику. В серверной части шлюз приложений выступает в качестве клиента и отправляет сведения о протоколе или шифре в качестве предпочтения во время подтверждения TLS.

Шлюз приложений взаимодействует с такими внутренними экземплярами, которые либо список разрешений свой сертификат с шлюзом приложений, либо сертификаты, подписанные хорошо известными центрами сертификации, где CN сертификата совпадает с именем узла в параметрах серверной части HTTP. К ним относятся Доверенные службы Azure, такие как веб-приложения службы приложений Azure и управление API Azure.

Если сертификаты членов в внутреннем пуле не подписаны хорошо известными центрами сертификации, то для каждого экземпляра в серверном пуле с включенным сквозным протоколом TLS необходимо настроить сертификат, чтобы обеспечить безопасную связь. Это гарантирует, что шлюз приложений взаимодействует только с известными экземплярами серверной части, тем самым защищая сквозной обмен данными.

> [!NOTE] 
>
> Настройка сертификата проверки подлинности не требуется для доверенных служб Azure, таких как веб-приложения службы приложений Azure и управление API Azure.

> [!NOTE] 
>
> Сертификат, добавленный в **параметр HTTP серверной части** для проверки подлинности внутренних серверов, может совпадать с сертификатом, добавленным в **прослушиватель** для завершения TLS в шлюзе приложений, или другим для повышения безопасности.

![сквозной сценарий TLS][1]

В этом примере запросы, использующие TLS 1.2, направляются на внутренние серверы в Pool1 с использованием сквозного TLS.

## <a name="end-to-end-tls-and-whitelisting-of-certificates"></a>Сквозной TLS и список разрешений сертификатов

Шлюз приложений взаимодействует только с известными экземплярами серверной части, которые имеют сертификат из списка разрешений, определенного на шлюзе приложений. Чтобы включить список разрешенных сертификатов, необходимо передать открытый ключ сертификатов внутреннего сервера (а не корневой сертификат) в шлюз приложений. После этого будут разрешены подключения только к известным и включенным в разрешенный список серверам. Оставшиеся серверы будут выдавать ошибку шлюза. Самозаверяющие сертификаты предназначены только для тестирования и не рекомендуются для рабочих нагрузок в рабочей среде. Такие сертификаты нужно добавить в список разрешений с помощью шлюза приложений, как описано ранее, прежде чем их можно будет использовать.

> [!NOTE]
> Для надежных служб Azure, таких как служба приложений Azure, настраивать сертификат аутентификации не нужно.

## <a name="end-to-end-tls-with-the-v2-sku"></a>Сквозной TLS с номером SKU v2

Сертификаты проверки подлинности устарели и заменены доверенными корневыми сертификатами в номере SKU Шлюза приложений версии 2. Они действуют идентично сертификатам проверки подлинности, за исключением нескольких ключевых различий:

- Сертификаты, подписанные хорошо известными центрами сертификации, которым CN соответствует имени узла в параметрах серверной части HTTP, не требует дополнительного шага для работы сквозного TLS. 

   Например, если сертификаты серверной части выданы хорошо известным центром сертификации и имеют общее имя contoso.com, а в поле узла в параметрах HTTP внутреннего сервера также указано значение contoso.com, дополнительные действия не требуются. Можно задать для протокола HTTP-параметра серверной части значение HTTPS, а для проверки работоспособности и пути к данным будет включен протокол TLS. Если вы используете службу приложений Azure или другие веб-службы Azure в качестве серверной части, они также являются неявно доверенными и для сквозного TLS не требуется никаких дополнительных действий.
   
> [!NOTE] 
>
> Чтобы сертификат TLS/SSL был доверенным, этот сертификат должен быть выдан центром сертификации, включенным в доверенное хранилище шлюза приложений. Если сертификат не был выдан доверенным центром сертификации, затем шлюз приложений проверяет, выдавался ли сертификат выдающего ЦС доверенным центром сертификации и т. д. до тех пор, пока не будет найден доверенный центр сертификации (в этом случае устанавливается надежное безопасное подключение) или не будет найден доверенный ЦС (после чего шлюз приложений помечает серверную часть как неработоспособную). Поэтому рекомендуется, чтобы сертификат внутреннего сервера содержал как корневой, так и промежуточный ЦС.

- Если сертификат является самозаверяющим или подписан неизвестными посредниками, то чтобы включить сквозной протокол TLS в версии v2 SKU, необходимо определить доверенный корневой сертификат. Шлюз приложений будет взаимодействовать только с серверными частями, корневой сертификат сертификата сервера которых совпадает с одним из сертификатов из списка доверенных корневых сертификатов в параметре HTTP серверной части, который связан с пулом.

> [!NOTE] 
>
> Самозаверяющий сертификат должен быть частью цепочки сертификатов. Один самозаверяющий сертификат без цепочки не поддерживается в SKU v2.

- Помимо сопоставления корневого сертификата, шлюз приложений проверяет, совпадает ли параметр узла, указанный в параметре HTTP серверной части, с именем общего имени (CN), представленного сертификатом TLS/SSL внутреннего сервера. При попытке установить TLS-подключение к серверной части шлюз приложений устанавливает расширение указание имени сервера (SNI) на узел, указанный в параметре HTTP серверной части.
- Если вместо поля узел в параметре HTTP серверной части выбран вариант **выбрать имя узла из внутреннего адреса** , то в качестве заголовка SNI всегда будет ЗАДАНО полное доменное имя внутреннего пула, а на сертификате TLS/SSL внутреннего сервера должно совпадать полное доменное имя. В этом сценарии не поддерживаются участники внутреннего пула с IP-адресами.
- Корневой сертификат — это закодированный в Base64 корневой сертификат из списка сертификатов внутреннего сервера.

## <a name="next-steps"></a>Дальнейшие шаги

После изучения сквозного протокола TLS перейдите к разделу [Настройка сквозного TLS с помощью шлюза приложений с использованием PowerShell](application-gateway-end-to-end-ssl-powershell.md) для создания шлюза приложений с использованием сквозного TLS.

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
