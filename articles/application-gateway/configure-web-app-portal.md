---
title: Управление трафиком для мульти-арендаторов приложений с помощью портала
titleSuffix: Azure Application Gateway
description: В этой статье содержатся рекомендации о том, как настроить веб-приложения службы приложений Azure App в качестве участников в бэкэнд-пуле на существующем или новом шлюзе приложений.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 11/14/2019
ms.author: absha
ms.openlocfilehash: 0ec417b3c7a025d2d05bdd74ec683a2891c3b0de
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74075160"
---
# <a name="configure-app-service-with-application-gateway"></a>Настройка службы приложений с помощью шлюза приложений

Поскольку служба приложений является мультитенантным сервисом вместо развертывания, она использует заголовок хоста в входящий запрос для решения запроса в правильную конечную точку службы приложений. Как правило, DNS имя приложения, которое, в свою очередь, является dNS имя, связанное с приложением шлюз перед приложением службы, отличается от доменного имени бэкэнда службы приложения. Таким образом, заголовок хоста в первоначальном запросе, полученном шлюзом приложения, не совпадает с именем хоста службы бэкэнда. Из-за этого, если заголовок хоста в запросе от шлюза приложения к бэкэнду не будет изменен на имя хоста службы бэкэнда, запоры мультитенантов не смогут разрешить запрос до правильной конечной точки.

Application Gateway предоставляет `Pick host name from backend address` переключатель, который переопределяет заголовок хоста в запросе с именем хоста бэк-энда, когда запрос направляется из шлюза приложения в бэкэнд. Эта возможность позволяет поддерживать многотенантные задние концы, такие как служба приложений Azure и управление API. 

Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
>
> - Создайте пул бэкэнда и добавьте к нему службу приложений
> - Создание http Настройки и пользовательский зонд с "Pick Hostname" переключатели включен

## <a name="prerequisites"></a>Предварительные требования

- Шлюз приложения: Если у вас нет существующего шлюза приложения, посмотреть, как [создать шлюз приложения](https://docs.microsoft.com/azure/application-gateway/quick-create-portal)
- Служба приложения: Если у вас нет существующего [App service documentation](https://docs.microsoft.com/azure/app-service/)сервиса App, см.

## <a name="add-app-service-as-backend-pool"></a>Добавление службы App в качестве бэкэнд-пула

1. На портале Azure откройте представление конфигурации шлюза приложения.

2. Под **backend бассейны,** нажмите на **Добавить,** чтобы создать новый пул бэкэнда.

3. Предоставьте подходящее название бэкэнд бассейну. 

4. В соответствии с **целями,** нажмите на падение и выбрать **Службы App** в качестве опции.

5. Отобраскасразу сразу ниже выпадения **целей** появится, который будет содержать список ваших служб приложений. Из этого выпадения выберите службу app, которая вы хотите добавить в качестве бэкэнда, и нажмите «Добавить».

   ![Резервное приложение службы бэкэнд](./media/configure-web-app-portal/backendpool.png)
   
   > [!NOTE]
   > Выпадение будет заполнять только те службы приложений, которые находятся в той же подписке, что и ваш шлюз приложения. Если вы хотите использовать службу приложений, которая находится в другой подписке, чем та, в которой находится шлюз приложения, то вместо того, чтобы выбрать **Службы app** в выпадении **целей,** выберите **IP-адрес или** опцию хоста и введите хост-имя (пример. azurewebsites.net) службы приложений.

## <a name="create-http-settings-for-app-service"></a>Создание настроек HTTP для службы App

1. Под **настройками HTTP**нажмите **Кнопка Добавить** для создания нового параметра HTTP.

2. Ввешайте имя для настройки HTTP, и вы можете включить или отключить Cookie based Affinity в соответствии с вашим требованием.

3. Выберите протокол как HTTP или HTTPS в случае использования. 

   > [!NOTE]
   > Если вы выберете HTTPS, вам не нужно загружать сертификат аутентификации или доверенный корневой сертификат в белый список бэкэнда службы приложений, так как служба приложений является надежным сервисом Azure.

4. Проверьте поле для **использования для службы приложений** . Обратите внимание, `Create a probe with pick host name from backend address` что `Pick host name from backend address` коммутирует и автоматически включается.`Pick host name from backend address` переочернет заголовок узла в запросе с именем хоста бэк-энда, когда запрос будет перенаправлен из шлюза приложения в бэкэнд.  

   `Create a probe with pick host name from backend address`автоматически создаст зонд работоспособности и связать его с этой настройкой HTTP. Вам не нужно создавать какой-либо другой зонд работоспособности для этого параметра HTTP. Вы можете проверить, что новый зонд с именем <HTTP Setting name> <Unique GUID> был добавлен в список зондов здоровья, и он уже имеет переключатель. `Pick host name from backend http settings enabled`

   Если у вас уже есть один или несколько настроек HTTP, которые используются для службы App, и если эти параметры `Create a probe with pick host name from backend address` HTTP используют тот же протокол, что и тот, который вы используете в том, который вы создаете, то вместо переключателя, вы получите выпадение, чтобы выбрать один из пользовательских зондов. Это потому, что, поскольку уже существует http Настройка с приложением службы, поэтому, не было бы также существовать зонд здоровья, который имеет переключатель `Pick host name from backend http settings enabled` . Выберите этот пользовательский зонд из выпадения.

5. Нажмите **OK,** чтобы создать настройку HTTP.

   ![HTTP-установка1](./media/configure-web-app-portal/http-setting1.png)

   ![HTTP-установка2](./media/configure-web-app-portal/http-setting2.png)



## <a name="create-rule-to-tie-the-listener-backend-pool-and-http-setting"></a>Создайте правило, чтобы связать слушателя, Backend бассейн и настройка HTTP

1. В соответствии с **правилами,** нажмите **Basic,** чтобы создать новое базовое правило.

2. Предоставьте подходящее имя и выберите слушателя, который будет принимать входящие запросы на службу App.

3. В **backend пула** выпадения, выбрать бэкэнд бассейн вы создали выше.

4. В настройке **HTTP** выберите настройку HTTP, созданную выше.

5. Нажмите **OK,** чтобы сохранить это правило.

   ![Правило](./media/configure-web-app-portal/rule.png)

## <a name="additional-configuration-in-case-of-redirection-to-app-services-relative-path"></a>Дополнительная конфигурация в случае перенаправления на относительный путь службы приложения

Когда служба приложения отправляет клиенту ответ на перенаправление на относительный путь (например, перенаправление с contoso.azurewebsites.net/path1 на contoso.azurewebsites.net/path2), он использует то же имя хоста в заголовке местоположения своего ответа, как и запрос, полученный от шлюза приложения. Таким образом, клиент будет делать запрос непосредственно contoso.azurewebsites.net/path2 вместо того, чтобы пройти через шлюз приложения (contoso.com/path2). Обход шлюза приложения нежелателен.

Если в случае использования есть сценарии, в которых служба App должна будет отправить клиенту ответ на перенаправление, выполнить [дополнительные шаги для переписывания заголовка местоположения.](https://docs.microsoft.com/azure/application-gateway/troubleshoot-app-service-redirection-app-service-url#sample-configuration)

## <a name="restrict-access"></a>Ограничение доступа

Веб-приложения, развернутые в этих примерах, используют общедоступные IP-адреса, доступ к которым можно получить напрямую из Интернета. Это помогает устранить неполадки, когда вы знакомитесь с новыми функциями и пробуете новинки. Однако, если вы хотите развернуть функцию в производственной среде, необходимо добавить дополнительные ограничения.

Один из способов ограничения доступа к веб-приложению — использовать [ограничения статических IP-адресов в Службе приложений Azure](../app-service/app-service-ip-restrictions.md). Например, можно ограничить веб-приложение, чтобы получать трафик только из шлюза приложения. Используйте функцию ограничения IP-адреса для службы приложения, чтобы сделать виртуальный IP-адрес шлюза приложения единственным адресом с доступом.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать больше об службе App и другой [multi-tenant service support with application gateway](https://docs.microsoft.com/azure/application-gateway/application-gateway-web-app-overview)мультитенантной поддержке с помощью шлюза приложения, см.
