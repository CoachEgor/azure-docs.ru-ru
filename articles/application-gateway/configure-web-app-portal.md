---
title: Управление трафиком для приложений с несколькими клиентами с помощью портала
titleSuffix: Azure Application Gateway
description: В этой статье содержатся инструкции по настройке веб-приложений службы приложений Azure в качестве членов серверного пула в существующем или новом шлюзе приложений.
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 11/14/2019
ms.author: absha
ms.openlocfilehash: 0ec417b3c7a025d2d05bdd74ec683a2891c3b0de
ms.sourcegitcommit: a107430549622028fcd7730db84f61b0064bf52f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/14/2019
ms.locfileid: "74075160"
---
# <a name="configure-app-service-with-application-gateway"></a>Настройка службы приложений с помощью шлюза приложений

Так как служба приложений является многоклиентской службой, а не выделенным развертыванием, она использует заголовок узла во входящем запросе, чтобы разрешить запрос к правильной конечной точке службы приложений. Как правило, DNS-имя приложения, которое, в свою очередь, является DNS-именем, связанным с шлюзом приложений, которое находится за презвеном службы приложений, отличается от доменного имени службы серверных приложений. Таким образом, заголовок узла в исходном запросе, полученный шлюзом приложений, не совпадает с именем узла внутренней службы. По этой причине, если заголовок узла в запросе от шлюза приложений к серверной части не изменится на имя узла внутренней службы, серверные части с несколькими клиентами не смогут разрешить запрос в правильную конечную точку.

Шлюз приложений предоставляет переключатель с именем `Pick host name from backend address`, который переопределяет заголовок узла в запросе с именем узла серверной части, когда запрос направляется из шлюза приложений в серверную часть. Эта возможность позволяет поддерживать многоклиентские серверные возможности, такие как служба приложений Azure и управление API. 

В этой статье раскрываются следующие темы:

> [!div class="checklist"]
>
> - Создание внутреннего пула и добавление в него службы приложений
> - Создание параметров HTTP и пользовательской проверки с включенными коммутаторами "Выбор имени узла"

## <a name="prerequisites"></a>предварительным требованиям

- Шлюз приложений. Если у вас нет шлюза приложений, см. раздел [Создание шлюза](https://docs.microsoft.com/azure/application-gateway/quick-create-portal) приложений.
- Служба приложений. Если у вас нет существующей службы приложений, см. [документацию по службе приложений](https://docs.microsoft.com/azure/app-service/).

## <a name="add-app-service-as-backend-pool"></a>Добавить службу приложений в качестве серверного пула

1. В портал Azure откройте представление Конфигурация шлюза приложений.

2. В разделе **серверные пулы**щелкните **Добавить** , чтобы создать новый внутренний пул.

3. Укажите подходящее имя для внутреннего пула. 

4. В разделе **целевые объекты**щелкните раскрывающийся список и выберите **службы приложений** в качестве параметра.

5. Появится раскрывающееся меню под раскрывающимся списком **целевые объекты** , в котором будет содержаться список служб приложений. В этом раскрывающемся списке выберите службу приложений, которую нужно добавить в качестве члена внутреннего пула, и нажмите кнопку Добавить.

   ![Серверная часть службы приложений](./media/configure-web-app-portal/backendpool.png)
   
   > [!NOTE]
   > В раскрывающемся списке будут заполнены только те службы приложений, которые находятся в той же подписке, что и шлюз приложений. Если вы хотите использовать службу приложений, которая находится в другой подписке, чем та, в которой находится шлюз приложений, то вместо выбора **служб приложений** в раскрывающемся списке **целевые объекты** выберите параметр **IP-адрес или имя узла** и введите имя узла (например,. azurewebsites.net) службы приложений.

## <a name="create-http-settings-for-app-service"></a>Создание параметров HTTP для службы приложений

1. В разделе **Параметры HTTP**нажмите кнопку **Добавить** , чтобы создать новый параметр HTTP.

2. Введите имя для параметра HTTP, а также включите или отключите сопоставление на основе файлов cookie в соответствии с вашими требованиями.

3. Выберите протокол как HTTP или HTTPS в соответствии с вашим вариантом использования. 

   > [!NOTE]
   > Если выбран вариант HTTPS, вам не нужно отправлять сертификат проверки подлинности или доверенный корневой сертификат для список разрешений серверной части службы приложений, так как служба приложений является доверенной службой Azure.

4. Установите флажок **использовать для службы приложений** . Обратите внимание, что переключатели `Create a probe with pick host name from backend address` и `Pick host name from backend address` будут автоматически включены.`Pick host name from backend address` переопределит заголовок узла в запросе на имя узла серверной части, когда запрос направляется из шлюза приложений в серверную часть.  

   `Create a probe with pick host name from backend address` автоматически создаст зонд работоспособности и свяжет его с этим параметром HTTP. Для этого параметра HTTP не нужно создавать другие проверки работоспособности. Вы можете проверить, что новая проверка с именем <HTTP Setting name><Unique GUID> добавлена в список проб работоспособности, и в ней уже есть параметр `Pick host name from backend http settings enabled`.

   Если у вас уже есть один или несколько параметров HTTP, которые используются для службы приложений, и если эти параметры HTTP используют тот же протокол, что и тот, который вы используете, то вместо параметра `Create a probe with pick host name from backend address` вы получите раскрывающийся список для выбора одной из пользовательских проб. Это связано с тем, что, поскольку уже существует параметр HTTP со службой приложений, также существует проба работоспособности, имеющий `Pick host name from backend http settings enabled` коммутатора. Выберите пользовательскую проверку из раскрывающегося списка.

5. Нажмите кнопку **ОК** , чтобы создать параметр HTTP.

   ![HTTP-setting1](./media/configure-web-app-portal/http-setting1.png)

   ![HTTP-setting2](./media/configure-web-app-portal/http-setting2.png)



## <a name="create-rule-to-tie-the-listener-backend-pool-and-http-setting"></a>Создание правила для привязки прослушивателя, серверного пула и параметра HTTP

1. В разделе **правила**щелкните **базовый** , чтобы создать базовое правило.

2. Укажите подходящее имя и выберите прослушиватель, который будет принимать входящие запросы для службы приложений.

3. В раскрывающемся списке **серверный пул** выберите созданный ранее серверный пул.

4. В раскрывающемся списке **параметров HTTP** выберите созданный ранее параметр HTTP.

5. Нажмите кнопку **ОК** , чтобы сохранить это правило.

   ![Правило](./media/configure-web-app-portal/rule.png)

## <a name="additional-configuration-in-case-of-redirection-to-app-services-relative-path"></a>Дополнительная настройка в случае перенаправления в относительный путь службы приложений

Когда служба приложений отправляет клиенту ответ перенаправления для перенаправления на относительный путь (например, перенаправление от contoso.azurewebsites.net/path1 к contoso.azurewebsites.net/path2), он использует то же имя узла в заголовке Location своего ответа, как в запросе, полученном от шлюза приложений. Поэтому клиент сделает запрос напрямую contoso.azurewebsites.net/path2, а не через шлюз приложений (contoso.com/path2). Обход шлюза приложений нежелательно.

В случае использования в сценариях, где службе приложений потребуется отправить ответ перенаправления клиенту, выполните [Дополнительные действия для перезаписи заголовка Location](https://docs.microsoft.com/azure/application-gateway/troubleshoot-app-service-redirection-app-service-url#sample-configuration).

## <a name="restrict-access"></a>Ограничение доступа

Веб-приложения, развернутые в этих примерах, используют общедоступные IP-адреса, доступ к которым можно получить напрямую из Интернета. Это помогает устранить неполадки, когда вы знакомитесь с новыми функциями и пробуете новинки. Однако, если вы хотите развернуть функцию в производственной среде, необходимо добавить дополнительные ограничения.

Один из способов ограничения доступа к веб-приложению — использовать [ограничения статических IP-адресов в Службе приложений Azure](../app-service/app-service-ip-restrictions.md). Например, можно ограничить веб-приложение, чтобы получать трафик только из шлюза приложения. Используйте функцию ограничения IP-адреса для службы приложения, чтобы сделать виртуальный IP-адрес шлюза приложения единственным адресом с доступом.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о службе приложений и другой поддержке нескольких клиентов с помощью шлюза приложений см. в разделе [Поддержка службы с несколькими клиентами с помощью шлюза приложений](https://docs.microsoft.com/azure/application-gateway/application-gateway-web-app-overview).
