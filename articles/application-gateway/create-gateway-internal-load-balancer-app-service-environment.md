---
title: 'Устранение неполадок Шлюза приложений в Azure: ASE с внутренней подсистемой балансировки нагрузки | Документация Майкрософт'
description: Сведения об устранении неполадок Шлюза приложений с помощью внутренней подсистемы балансировки нагрузки и Среды службы приложений в Azure
services: vpn-gateway
documentationCenter: na
author: genlin
manager: cshepard
editor: ''
tags: ''
ms.service: vpn-gateway
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/06/2018
ms.author: genli
ms.openlocfilehash: baed2b23a321c53a614303d3085fbb3a4bf6ad0b
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60831101"
---
# <a name="back-end-server-certificate-is-not-whitelisted-for-an-application-gateway-using-an-internal-load-balancer-with-an-app-service-environment"></a>Отсутствие сертификата внутреннего сервера в списке разрешений для Шлюза приложений, использующего внутреннюю подсистему балансировки нагрузки и Среду службы приложений

В этой статье описано устранение следующей проблемы: сертификат не включен в список разрешений при создании Шлюза приложений с помощью внутренней подсистемы балансировки нагрузки (ILB) и Среды службы приложений (ASE) в серверной части при использовании сквозного шифрования SSL в Azure.

## <a name="symptoms"></a>Проблемы

При создании Шлюза приложений с помощью ILB и ASE в серверной части сервер может стать неработоспособным. Эта проблема возникает, если сертификат проверки подлинности Шлюза приложений не соответствует настроенному сертификату на внутреннем сервере. Давайте рассмотрим следующий сценарий в качестве примера:

**Конфигурация Шлюза приложений:**

- **Прослушиватель**. Многосайтовый
- **Port.** 443
- **Имя узла:** test.appgwtestase.com
- **SSL-сертификат:** CN=test.appgwtestase.com
- **Серверный пул:** IP-адрес или FQDN
- **IP-адрес:** 10.1.5.11
- **Настройки HTTP:** HTTPS
- **Порт:** 443
- **Пользовательская проверка:** имя узла — test.appgwtestase.com
- **Сертификат проверки подлинности:** CER-файл test.appgwtestase.com
- **Работоспособности серверной части:** состояние "Неработоспособно" (сертификат внутреннего сервера не включен в список разрешений с помощью Шлюза приложений).

**Конфигурация ASE:**

- **ILB IP:** 10.1.5.11
- **Доменное имя:** appgwtestase.com
- **Служба приложений:** test.appgwtestase.com
- **Привязка SSL:** SNI SSL – CN=test.appgwtestase.com

При получении доступа к Шлюзу приложений по причине неработоспособности внутреннего сервера отображается следующее сообщение об ошибке:

**502: веб-сервером в качестве шлюза или прокси-сервера получен недопустимый ответ.**

## <a name="solution"></a>Решение

Если вы не используете имя узла для доступа к веб-сайту HTTPS, внутренний сервер вернет настроенный сертификат на веб-сайт по умолчанию, если SNI отключено. Для ILB ASE сертификат по умолчанию поступает из сертификата ILB. Если для ILB нет настроенных сертификатов, сертификат поступает из сертификата приложения ASE.

При получении доступа к ILB с помощью полного доменного имени (FQDN) внутренний сервер вернет правильный сертификат, отправленный в параметры HTTP. В противном случае рекомендуем вам такие варианты действий:

- Использование FQDN во внутреннем пуле Шлюза приложений для указания на IP-адрес ILB. Этот вариант возможен только при наличии частной зоны DNS или настроенной службы DNS. В противном случае вам нужно создать запись "A" для общедоступной службы DNS.

- Использование загруженного сертификата в ILB или сертификата по умолчанию (ILB сертификата) в параметрах HTTP. Шлюз приложений получает сертификат при получении доступа к IP-адресу ILB для зонда.

- Используйте шаблон сертификата на ILB и на внутреннем сервере, чтобы все веб-сайты использовали один сертификат. Тем не менее, это решение подходит только для поддоменов и если все веб-сайты требуют разные имена узлов.

- Очистите параметр **Использовать для службы приложений** подсети Шлюза приложений, если вы используете IP-адрес ILB.

Для уменьшения издержек можно передать сертификат ILB в параметры HTTP, активировав путь пробы. (Этот шаг предназначен только для списка разрешений. Он не будет использоваться для SSL-подключения.) Вы можете извлечь сертификат ILB, получив доступ к ILB с помощью его IP-адреса с вашего браузера по HTTPS, затем экспортировав SSL-сертификат в формате CER с кодировкой Base-64 и отправив его в соответствующие параметры HTTP.

## <a name="need-help-contact-support"></a>Нужна помощь? Обращение в службу поддержки

Если вам все еще нужна помощь, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), которая поможет быстро устранить проблему.
