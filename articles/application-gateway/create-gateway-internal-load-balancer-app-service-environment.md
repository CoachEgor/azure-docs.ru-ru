---
title: 'Устранение неполадок Шлюза приложений в Azure: ASE с внутренней подсистемой балансировки нагрузки | Документация Майкрософт'
description: Сведения об устранении неполадок Шлюза приложений с помощью внутренней подсистемы балансировки нагрузки и Среды службы приложений в Azure
services: vpn-gateway
documentationCenter: na
author: genlin
manager: dcscontentpm
editor: ''
tags: ''
ms.service: vpn-gateway
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/06/2018
ms.author: genli
ms.openlocfilehash: 4edeea749ba22bef173c15f3a0855679b784ce33
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80668562"
---
# <a name="back-end-server-certificate-is-not-whitelisted-for-an-application-gateway-using-an-internal-load-balancer-with-an-app-service-environment"></a>Отсутствие сертификата внутреннего сервера в списке разрешений для Шлюза приложений, использующего внутреннюю подсистему балансировки нагрузки и Среду службы приложений

В этой статье устранены следующие проблемы. сертификат не список разрешений при создании шлюза приложений с помощью внутреннего Load Balancer (ILB) вместе с Среда службы приложений (ASE) в серверной части при использовании сквозного протокола TLS в Azure.

## <a name="symptoms"></a>Симптомы

При создании Шлюза приложений с помощью ILB и ASE в серверной части сервер может стать неработоспособным. Эта проблема возникает, если сертификат проверки подлинности Шлюза приложений не соответствует настроенному сертификату на внутреннем сервере. Давайте рассмотрим следующий сценарий в качестве примера:

**Конфигурация Шлюза приложений:**

- **Прослушиватель:** многосайтовый
- **Порт:** 443
- **Имя узла:** test.appgwtestase.com
- **SSL-сертификат:** CN=test.appgwtestase.com
- **Внутренний пул:** IP-адрес или полное доменное имя
- **IP-адрес:** 10.1.5.11
- **Параметры HTTP:** протокол HTTP
- **Порт:** 443
- **Пользовательский зонд:** имя узла — test.appgwtestase.com
- **Сертификат проверки подлинности:** CER-файл test.appgwtestase.com
- **Оценка работоспособности серверной части:** состояние "Неработоспособно" (сертификат внутреннего сервера не включен в список разрешений с помощью Шлюза приложений).

**Конфигурация ASE:**

- **IP-адрес ILB:** 10.1.5.11
- **Доменное имя:** appgwtestase.com
- **Служба приложений:** test.appgwtestase.com
- **Привязка SSL:** SSL на основе SNI — CN=test.appgwtestase.com

При получении доступа к Шлюзу приложений по причине неработоспособности внутреннего сервера отображается следующее сообщение об ошибке:

**502 — веб-сервер получил недопустимый ответ при выступающем в качестве шлюза или прокси-сервера.**

## <a name="solution"></a>Решение

Если вы не используете имя узла для доступа к веб-сайту HTTPS, внутренний сервер вернет настроенный сертификат на веб-сайт по умолчанию, если SNI отключено. Для ILB ASE сертификат по умолчанию поступает из сертификата ILB. Если для ILB нет настроенных сертификатов, сертификат поступает из сертификата приложения ASE.

При получении доступа к ILB с помощью полного доменного имени (FQDN) внутренний сервер вернет правильный сертификат, отправленный в параметры HTTP. В противном случае рекомендуем вам такие варианты действий:

- Использование FQDN во внутреннем пуле Шлюза приложений для указания на IP-адрес ILB. Этот вариант возможен только при наличии частной зоны DNS или настроенной службы DNS. В противном случае вам нужно создать запись "A" для общедоступной службы DNS.

- Использование загруженного сертификата в ILB или сертификата по умолчанию (ILB сертификата) в параметрах HTTP. Шлюз приложений получает сертификат при получении доступа к IP-адресу ILB для зонда.

- Используйте шаблон сертификата на ILB и на внутреннем сервере, чтобы все веб-сайты использовали один сертификат. Тем не менее, это решение подходит только для поддоменов и если все веб-сайты требуют разные имена узлов.

- Очистите параметр **Использовать для службы приложений** подсети Шлюза приложений, если вы используете IP-адрес ILB.

Для уменьшения издержек можно передать сертификат ILB в параметры HTTP, активировав путь пробы. (Этот шаг предназначен только для списка разрешений. Он не будет использоваться для обмена данными TLS.) Сертификат ILB можно получить, обратившись к ILB с его IP-адресом из браузера по протоколу HTTPS. затем экспортируйте сертификат TLS/SSL в формате CER с кодировкой Base-64 и загрузите сертификат в соответствующие параметры HTTP.

## <a name="need-help-contact-support"></a>Требуется помощь? Обращение в службу поддержки

Если вам все еще нужна помощь, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), которая поможет быстро устранить проблему.
