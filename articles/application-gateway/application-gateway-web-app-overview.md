---
title: Мультитенантные задние концы
titleSuffix: Azure Application Gateway
description: На этой странице предоставлен обзор поддержки мультитенантных серверных частей в шлюзе приложений.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 11/14/2019
ms.author: victorh
ms.openlocfilehash: efa2885ce0534c5d78bb08bbf24da59850f6ea22
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74075176"
---
# <a name="application-gateway-support-for-multi-tenant-back-ends-such-as-app-service"></a>Поддержка шлюза приложений для мультитенантных задних концов, таких как служба app

В многотенантных архитектурных проектах на веб-серверах несколько веб-сайтов работают на одном экземпляре веб-сервера. Имена хоста используются для различать различные приложения, которые размещаются. По умолчанию шлюз приложений не изменяет заголовок узла входящих данных HTTP от клиента и без изменений отправляет его на серверную часть. Это хорошо работает для бэкэнд ампула, таких как NICs, виртуальные наборы масштабов машин, общедоступные IP-адреса, внутренние IP-адреса и F-DN, поскольку они не полагаются на конкретный заголовок хоста или расширение SNI для решения правильной точки. Однако существует множество сервисов, таких как веб-приложения службы приложений Azure App и управление API Azure, которые носят многофункциональный характер и полагаются на определенный заголовок узла или расширение SNI для решения в нужной точке. Обычно DNS-имя приложения, которое, в свою очередь, является dNS-именем, связанным с шлюзом приложения, отличается от доменного имени службы бэкэнда. Таким образом, заголовок хоста в первоначальном запросе, полученном шлюзом приложения, не совпадает с именем хоста службы бэкэнда. Из-за этого, если заголовок хоста в запросе от шлюза приложения к бэкэнду не будет изменен на имя хоста службы бэкэнда, запоры мультитенантов не смогут разрешить запрос до правильной конечной точки. 

В Шлюзе приложений есть функция, которая позволяет пользователям переопределять заголовок узла HTTP в запросе в зависимости от имени узла серверной части. Эта функция обеспечивает поддержку мультитенантных серверных частей, например в веб-приложениях Службы приложений Azure и службе "Управление API". Эта возможность доступна для SKU "Стандартный" версий 1 и 2, а также SKU для WAF. 

![хост переопределить](./media/application-gateway-web-app-overview/host-override.png)

> [!NOTE]
> Это не применимо к среде службы приложений Azure (ASE), так как ASE является специализированным ресурсом в отличие от службы Azure App, которая является многотентивным ресурсом.

## <a name="override-host-header-in-the-request"></a>Переопределение заголовка узла в запросе

Возможность указать переопределение хоста определена в [настройках HTTP](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings) и может быть применена к любому пулу бэк-энда во время создания правил. Поддерживаются следующие два способа переопределения заголовка хоста и расширения SNI для мультитенантных задних концов:

- Возможность установить имя узла на фиксированное значение, явно введенное в настройках HTTP. Эта возможность гарантирует, что заголовок узла переопределяется к этому значению для всего трафика в пул бэк-энда, где применяются определенные параметры HTTP. При использовании сквозного шифрования SSL переопределенное имя узла используется в расширении SNI. Эта возможность позволяет использовать сценарии, в которых ферма серверных пулов ожидает заголовок узла, который отличается от входящего заголовка узла клиента.

- Возможность получать имя узла из IP-адреса или полного доменного имени участников серверного пула. Настройки HTTP также предоставляют возможность динамического выбора имени хоста из F-DN участника пула бэк-энда, если он настроен с возможностью получения имени хоста из отдельного участника пула бэк-энда. При использовании сквозного шифрования SSL имя узла извлекается из полного доменного имени и используется в расширении SNI. Эта возможность позволяет использовать сценарии, в которых серверный пул имеет несколько мультитенатных служб PaaS, таких как Веб-приложения Azure, а заголовок узла в запросе к каждому участнику содержит имя узла, извлеченное из полного доменного имени. Для реализации этого сценария мы используем переключатель в настройках HTTP под названием [Pick hostname из адреса бэкэнда,](https://docs.microsoft.com/azure/application-gateway/configuration-overview#pick-host-name-from-back-end-address) который динамически переопределить заголовок хоста в первоначальном запросе на тот, который упоминается в пуле бэкэнда.  Например, если пул бэкэнда F'DN содержит "contoso11.azurewebsites.net" и "contoso22.azurewebsites.net", то заголовок хоста исходного запроса, который contoso.com, будет отменен до contoso11.azurewebsites.net или contoso22.azurewebsites.net когда запрос отправляется на соответствующий сервер бэкэнда. 

  ![сценарий веб-приложения](./media/application-gateway-web-app-overview/scenario.png)

Благодаря этой возможности клиенты настраивают параметры HTTP и пользовательские пробы для соответствующей конфигурации. Этот параметр затем привязывается к прослушивателю и серверному пулу с помощью правила.

## <a name="special-considerations"></a>Специальные рекомендации

### <a name="ssl-termination-and-end-to-end-ssl-with-multi-tenant-services"></a>SSL прекращения и до конца SSL с несколькими тенантами услуг

Как прекращение SSL, так и окончание sSL-шифрования поддерживается мультитенантными службами. Для прекращения SSL в шлюзе приложения, SSL-сертификат по-прежнему требуется, чтобы быть добавлены к слушателю шлюза приложения. Однако в случае окончания SSL доверенные службы Azure, такие как веб-приложения службы Azure App, не требуют белого списка бэкэндов в шлюзе приложения. Поэтому нет необходимости добавлять сертификаты аутентификации. 

![от конца до конца SSL](./media/application-gateway-web-app-overview/end-to-end-ssl.png)

Обратите внимание, что на приведенном выше изображении нет необходимости добавлять сертификаты аутентификации при выборе службы App в качестве бэкэнда.

### <a name="health-probe"></a>Проверка работоспособности

Преодоление заголовка узла в **настройках HTTP** влияет только на запрос и его реукторанизм. это не влияет на поведение зонда здоровья. Для комплексной работы функции и пробы, и параметры HTTP необходимо изменить в соответствии с правильной конфигурацией. В дополнение к предоставлению возможности указать заголовок узла в конфигурации зонда, пользовательские зонды также поддерживают возможность получения заголовка хоста из настраиваемых в настоящее время параметров HTTP. Эту конфигурацию можно указать с помощью параметра `PickHostNameFromBackendHttpSettings` в конфигурации пробы.

### <a name="redirection-to-app-services-url-scenario"></a>Перенаправление на сценарий URL-адреса Службы app

Возможны сценарии, при которых хост-имя в ответе службы App может направить браузер конечного пользователя на azurewebsites.net хостимя вместо домена, связанного с шлюзом приложения. Эта проблема может возникнуть, когда:

- Перенаправление настроено на службу приложений. Перенаправление может быть так же просто, как добавление задней слэйс к запросу.
- У вас есть аутентификация Azure AD, которая вызывает перенаправление.

Для разрешения таких случаев см. [Перенаправление Проблемы на URL-проблему службы App.](https://docs.microsoft.com/azure/application-gateway/troubleshoot-app-service-redirection-app-service-url)

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как настроить шлюз приложения с помощью мультитенантного приложения, такого как веб-приложение Azure App в качестве бэк-энда, посетив [веб-приложения Configure App Service с помощью шлюза приложений](https://docs.microsoft.com/azure/application-gateway/configure-web-app-portal)
