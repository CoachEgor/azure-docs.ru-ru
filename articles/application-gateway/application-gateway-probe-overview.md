---
title: Обзор мониторинга работоспособности для шлюза приложений Azure
description: Шлюз приложений Azure отслеживает работоспособность всех ресурсов в своем пуле внутренних серверов и автоматически удаляет из пула все ресурсы, которые считаются неработоспособными.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 02/20/2020
ms.author: victorh
ms.openlocfilehash: e1afc389508eb75313d046b759bcc9c03a50daad
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83648409"
---
# <a name="application-gateway-health-monitoring-overview"></a>Обзор мониторинга работоспособности шлюза приложений

Шлюз приложений Azure по умолчанию отслеживает работоспособность всех ресурсов в своем пуле внутренних серверов и автоматически удаляет из пула все ресурсы, признанные неработоспособными. Шлюз приложений продолжает отслеживать неисправные экземпляры и добавляет их в пул внутренних серверов, как только они становятся доступными и начинают отвечать на проверку работоспособности. Шлюз приложений отправляет пробы работоспособности с помощью порта, который задан в параметрах HTTP серверной части. Благодаря этой конфигурации проверка тестирует тот же порт, с помощью которого клиенты подключаются к внутренней части. 

Исходный IP-адрес, используемый шлюзом приложений для проверки работоспособности, зависит от внутреннего пула:
 
- Если внутренний пул является общедоступной конечной точкой, то исходный адрес является общедоступным IP-адресом шлюза приложений.
- Если внутренний пул является частной конечной точкой, то исходный IP-адрес находится в пространстве частных IP-адресов подсети шлюза приложений.


![пример проверки работоспособности шлюза приложений][1]

Помимо проверки работоспособности по умолчанию проверку также можно настроить в соответствии с требованиями приложения. В этой статье рассматривается как проверка работоспособности по умолчанию, так и пользовательская проверка работоспособности.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="default-health-probe"></a>Проверка работоспособности по умолчанию

Если ни одной из пользовательских проверок работоспособности не настроено, шлюз приложений автоматически настраивает проверку работоспособности по умолчанию. Мониторинг осуществляется путем выполнения HTTP-запроса к IP-адресам пула внутренних серверов. Если выполняется стандартная проба и параметры HTTP серверной части настроены так, что используется протокол HTTPS, проба использует этот же протокол и для проверки работоспособности серверных систем.

Пример: Вы настроили шлюз приложений таким образом, что внутренние серверы A, B и C используются для получения сетевого трафика HTTP на порт 80. По умолчанию мониторинг работоспособности осуществляет проверку трех серверов каждые 30 секунд и ожидает получения HTTP-ответа, подтверждающего работоспособность. HTTP-ответ, подтверждающий работоспособность, имеет [код состояния](https://msdn.microsoft.com/library/aa287675.aspx) от 200 до 399.

Если проверка работоспособности по умолчанию для сервера А завершается неудачно, шлюз приложений удаляет его из внутреннего пула и сетевой трафик перестает поступать на этот сервер. Проверка работоспособности по умолчанию по-прежнему продолжает проверять сервер A каждые 30 секунд. Когда сервер A успешно отвечает на запрос проверки работоспособности по умолчанию, он возвращается в пул внутренних серверов, и передача трафика на этот сервер возобновляется.

### <a name="probe-matching"></a>Соответствие проб

По умолчанию ответ HTTP(S) с кодом состояния 200–399 указывает на работоспособность. Настраиваемые пробы работоспособности поддерживают два критерия соответствия. Критерий соответствия можно использовать, чтобы дополнительно изменить стандартную интерпретацию содержимого ответа, указывающего на работоспособность.

Эти критерии соответствия приведены ниже. 

- **Соответствие кода состояния ответа HTTP**. Критерий соответствия пробы для приема определенного пользователем отдельного кода ответа HTTP или их диапазонов. Поддерживаются отдельные коды состояния ответа, разделенные запятыми, и диапазоны кодов состояния.
- **Соответствие текста ответа HTTP**. Критерий соответствия пробы, позволяющий проверять текст ответа HTTP и сопоставлять его с указанной пользователем строкой. Возможен только поиск указанной пользователем строки в тексте ответа, но не полного регулярного выражения.

Критерий соответствия можно задать с помощью командлета `New-AzApplicationGatewayProbeHealthResponseMatch`.

Пример:

```azurepowershell
$match = New-AzApplicationGatewayProbeHealthResponseMatch -StatusCode 200-399
$match = New-AzApplicationGatewayProbeHealthResponseMatch -Body "Healthy"
```
После задания критерия соответствия его можно добавить в конфигурацию пробы с помощью параметра `-Match` в PowerShell.

### <a name="default-health-probe-settings"></a>Параметры проверки работоспособности по умолчанию

| Свойства проверки | Значение | Описание |
| --- | --- | --- |
| URL-адрес проверки |http://127.0.0.1:\<port\>/ |URL-адрес |
| Интервал |30 |Количество времени (в секундах) ожидания перед отправкой следующей пробы работоспособности.|
| Время ожидания |30 |Количество времени (в секундах), в течение которого Шлюз приложений ожидает ответа пробы, прежде чем пометить ее как неработоспособную. Если проба возвращается как работоспособная, соответствующая серверная часть сразу же обозначается как работоспособная.|
| Пороговое значение сбоя |3 |Управляет количеством проб, которые нужно отправить в случае сбоя стандартной пробы работоспособности. Эти дополнительные пробы работоспособности отправляются быстро и последовательно, чтобы быстро определить работоспособность серверной части, не дожидаясь интервала пробы. Такое поведение наблюдается только у номера SKU версии 1. В случае номера SKU версии 2 пробы работоспособности ожидают заданное количество времени. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

> [!NOTE]
> Порт совпадает с портом, указанным в параметрах HTTP серверной части.

Для определения состояния работоспособности проба по умолчанию использует только http:\//127.0.0.1:\<порт\>. Если необходимо настроить пробу работоспособности для перехода на настраиваемый URL-адрес или изменить любые другие параметры, используйте пользовательские пробы. Дополнительные сведения о пробах HTTP см. в разделе [Общие сведения о завершении TSL и сквозном подключении с помощью шлюза приложений](ssl-overview.md#for-probe-traffic).

### <a name="probe-intervals"></a>Интервалы пробы

Все экземпляры Шлюза приложений проверяют серверную часть независимо друг от друга. Такая же конфигурация пробы применяется к каждому экземпляру Шлюза приложений. Например, если конфигурация пробы предназначена для отправки проб работоспособности каждые 30 секунд, а Шлюз приложений содержит два экземпляра, то оба экземпляра отправляют пробу работоспособности каждые 30 секунд.

При наличии нескольких прослушивателей каждый прослушиватель проверяет серверную часть независимо друг от друга. Например, при наличии двух прослушивателей, указывающих на один и тот же серверный пул в двух разных портах (настроенных с помощью двух параметров HTTP серверной части), каждый прослушиватель самостоятельно проверяет одну серверную часть. В этом случае есть две пробы в каждом экземпляре Шлюза приложений для двух прослушивателей. Если в этом сценарии есть два экземпляра Шлюза приложений, серверная виртуальная машина получит четыре пробы в рамках заданного интервала пробы.

## <a name="custom-health-probe"></a>Пользовательская проверка работоспособности

Пользовательская проверка работоспособности позволяет добиться более детального контроля над мониторингом работоспособности. При использовании пользовательской проверки можно настроить интервал проверки, URL-адрес и путь проверки, а также количество неудачных попыток проверки, после которых экземпляр пула внутренних серверов должен считаться неработоспособным.

### <a name="custom-health-probe-settings"></a>Параметры пользовательской проверки работоспособности

В следующей таблице приведены описания свойств из пользовательской пробы работоспособности.

| Свойства проверки | Описание |
| --- | --- |
| Имя |Имя проверки. Это имя используется для указания проверки в параметрах HTTP внутреннего сервера |
| Протокол |Протокол, используемый для проверки. Проба использует протокол, определенный в параметрах HTTP серверной части. |
| Узел |Имя узла для проверки. Применяется только в случае, когда в шлюзе приложений настроено многосайтовое подключение. В противном случае используется значение 127.0.0.1. Это значение отличается от имени узла виртуальной машины. |
| путь |Относительный путь проверки. Путь должен начинаться с "/". |
| Интервал |Интервал проверки в секундах. Это значение означает интервал времени между двумя последовательными проверками. |
| Время ожидания |Время ожидания проверки в секундах. Если ответ о работоспособности не получен в течение этого времени ожидания, то проба считается неудачной.  |
| Пороговое значение сбоя |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

> [!IMPORTANT]
> если шлюз приложений настроен для одного сайта, нужно указать стандартное имя узла 127.0.0.1, если только другое имя не задано в пользовательской пробе;
> Для справки пользовательская проба отправляется по адресу \<протокол\>://\<узел\>:\<порт\>\<путь\>. Используемый порт совпадает с портом, указанным в параметрах HTTP серверной части.

## <a name="nsg-considerations"></a>Рекомендации по группам безопасности сети

Необходимо разрешить входящий трафик Интернета через TCP-порты 65503–65534 для номера SKU шлюза приложений версии 1, а также через TCP-порты 65200–65535 для номера SKU версии 2 с целевой подсетью **Любая** и источником **GatewayManager** (тег службы источника). Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure.

Кроме того, не должно блокироваться исходящее подключение к Интернету, а также необходимо разрешить входящий трафик из тега **AzureLoadBalancer**.

Дополнительные сведения см. в статье [Обзор конфигурации шлюза приложений](configuration-overview.md#network-security-groups-on-the-application-gateway-subnet).

## <a name="next-steps"></a>Дальнейшие действия
Ознакомившись со сведениями о мониторинге работоспособности шлюза приложений, можно настроить [пользовательскую проверку работоспособности](application-gateway-create-probe-portal.md) на портале Azure либо [пользовательскую проверку работоспособности](application-gateway-create-probe-ps.md) с использованием модели развертывания PowerShell или Azure Resource Manager.

[1]: ./media/application-gateway-probe-overview/appgatewayprobe.png
