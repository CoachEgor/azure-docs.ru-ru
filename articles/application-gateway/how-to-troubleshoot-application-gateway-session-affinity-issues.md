---
title: Проблемы сродства сеанса сродства
titleSuffix: Azure Application Gateway
description: В этой статье приводится информация о том, как устранить проблемы сродства сеансов в Azure Application Gateway
services: application-gateway
author: abshamsft
ms.service: application-gateway
ms.topic: article
ms.date: 11/14/2019
ms.author: absha
ms.openlocfilehash: aa3617b30fe1ef9b4d4a6c5fe5aac51bff95bb92
ms.sourcegitcommit: af1cbaaa4f0faa53f91fbde4d6009ffb7662f7eb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2020
ms.locfileid: "81866674"
---
# <a name="troubleshoot-azure-application-gateway-session-affinity-issues"></a>Проблемы устранения проблем в области сродства прикладного приложения Azure

Узнайте, как диагностировать и устранять проблемы сродства сеансов с помощью шлюза приложений Azure.


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор

Функция сходства сеансов на основе файлов cookie удобна, если нужно, чтобы сеанс пользователя выполнялся на одном и том же сервере. Используя управляемые шлюзом файлы cookie, шлюз приложений может направлять последующий трафик из сеанса пользователя на тот же сервер для обработки. Эта функция важна, когда состояние сеанса сохраняется локально на сервере для сеанса пользователя.

## <a name="possible-problem-causes"></a>Возможные причины проблем

Проблема в поддержании сродства сеанса на основе файлов cookie может возникнуть по следующим основным причинам:

- Настройка "Cookie-Affinity" не включена
- Приложение не может обрабатывать сродство на основе файлов cookie
- Приложение использует сродство на основе файлов cookie, но запросы по-прежнему подпрыгивают между серверами бэк-энда

### <a name="check-whether-the-cookie-based-affinity-setting-is-enabled"></a>Проверить, включен ли параметр "Cookie-Affinity"

Иногда проблемы сродства сеанса могут возникнуть, когда вы забываете включить настройки сродства на основе Cookie. Чтобы определить, включили ли вы настройку "Cookie based affinity" на вкладке ПАРАМЕТРЫ HTTP на портале Azure, следуйте инструкциям:

1. Войдите на [портал Azure](https://portal.azure.com/).

2. В **левом навигационном** стежке щелкните **все ресурсы.** Нажмите на имя шлюза приложения в лезвии Всех ресурсов. Если подписка, которую вы выбрали, уже имеет несколько ресурсов в ней, вы можете ввести имя шлюза приложения в **фильтре по имени...** чтобы быстро получить доступ к необходимому шлюзу приложений.

3. Выберите **вкладку параметров HTTP** под **SETTINGS.**

   ![устранение неполадок-сессия-аффинити-вопросы-1](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-1.png)

4. Нажмите **на приложениеGatewayBackendHttpSettings** на правой стороне, чтобы проверить, выбрали ли вы **enabled** для cookie на основе сродства.

   ![устранение неполадок-сессия-аффинити-вопросы-2](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-2.jpg)



Вы также можете проверить значение "**CookieBasedAffinity**" установлен *в Enabled*под "**backendHttpSettingsCollection**" с помощью одного из следующих методов:

- Выполнить [Get-AzApplicationGatewayBackendHttpSetting](https://docs.microsoft.com/powershell/module/az.network/get-azapplicationgatewaybackendhttpsetting) в PowerShell
- Просмотрите файл JSON с помощью шаблона менеджера ресурсов Azure

```
"cookieBasedAffinity": "Enabled", 
```

### <a name="the-application-cannot-handle-cookie-based-affinity"></a>Приложение не может обрабатывать сродство на основе файлов cookie

#### <a name="cause"></a>Причина:

Шлюз приложения может выполнять сродство на основе сеансов только с помощью файла cookie.

#### <a name="workaround"></a>Обходной путь

Если приложение не может справиться с сродством на основе файлов cookie, необходимо использовать внешний или внутренний балансеер лазурной нагрузки или другое стороннее решение.

### <a name="application-is-using-cookie-based-affinity-but-requests-still-bouncing-between-back-end-servers"></a>Приложение использует сродство на основе файлов cookie, но запросы по-прежнему подпрыгивают между серверами бэк-энда

#### <a name="symptom"></a>Симптом

Вы включили настройку Affinity на основе Cookie, когда вы получаете доступ к шлюзу приложения, используя URL-адрес с коротким именем в Internet Explorer, например: [http://website](http://website/) , запрос по-прежнему подпрыгивает между серверами бэк-энда.

Чтобы определить эту проблему, следуйте инструкциям:

1. Возьмите веб-отладчик след на "Клиент", который подключается к приложению за приложением шлюз (Мы используем Fiddler в этом примере).
    **Подсказка** Если вы не знаете, как использовать Скрипача, проверьте опцию "**Я хочу собрать сетевой трафик и проанализировать его с помощью веб-отладчика**" внизу.

2. Проверьте и проанализируйте журналы сеансов, чтобы определить, есть ли у файлов cookie, предоставленных клиентом, данные ARRAffinity. Если вы не найдете детали ARRAffinity, такие как «**ARRAffinity»** *ARRAffinityValue*« в наборе cookie, это означает, что клиент не отвечает файлами cookie ARRA, которые предоставляются Шлюзом приложения.
    Пример:

    ![устранение неполадок-сессия-аффинити-вопросы-3](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-3.png)

    ![устранение неполадок-сессия-аффинити-вопросы-4](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-4.png)

Приложение продолжает пытаться настроить файлы cookie на каждый запрос до тех пор, пока он не получит ответ.

#### <a name="cause"></a>Причина:

Эта проблема возникает из-за того, что Internet Explorer и другие браузеры не могут хранить или использовать файлы cookie с URL-адресом с коротким именем.

#### <a name="resolution"></a>Решение

Чтобы устранить эту проблему, для доступа к Шлюзу приложений следует использовать полное доменное имя. Например, [http://website.com](https://website.com/) использовать [http://appgw.website.com](http://website.com/) или .

## <a name="additional-logs-to-troubleshoot"></a>Дополнительные журналы для устранения неполадок

Вы можете собирать дополнительные журналы и анализировать их, чтобы устранить проблемы, связанные с сродством сеансов на основе файлов cookie

### <a name="analyze-application-gateway-logs"></a>Анализ журналов шлюзов приложений

Чтобы собрать журналы прикладного шлюза, следуйте инструкциям:

Включение ведения журнала на портале Azure

1. На [портале Azure](https://portal.azure.com/)найдите ресурс, а затем нажмите **«Диагностические журналы».**

   Для шлюза приложений доступны три журнала: журнал доступа, журнал производительности, журнал брандмауэра

2. Чтобы начать сбор данных, нажмите **«Включите диагностику».**

   ![устранение неполадок-сессия-аффинити-вопросы-5](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-5.png)

3. В колонке **Параметры диагностики** представлены параметры журналов диагностики. В этом примере для хранения журналов используется Log Analytics. Нажмите **Нанастройка** под **журналом Analytics,** чтобы настроить рабочее пространство. хранения журналов диагностики можно также использовать концентраторы событий и учетную запись хранения.

   ![устранение неполадок-сессия-аффинити-вопросы-6](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-6.png)

4. Подтвердите настройки, а затем нажмите **Сохранить**.

   ![устранение неполадок-сессия-аффинити-вопросы-7](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-7.png)

#### <a name="view-and-analyze-the-application-gateway-access-logs"></a>Просмотр и анализ журналов доступа к порталу приложений

1. На портале Azure под видом ресурса Application Gateway выберите **журналы диагностики** в разделе **MONITORING.**

   ![устранение неполадок-сессия-аффинити-вопросы-8](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-8.png)

2. На правой стороне выберите «**ApplicationGatewayAccessLog»** в списке выпадающих в **категориях журнала.**  

   ![устранение неполадок-сессия-аффинити-вопросы-9](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-9.png)

3. В списке журнала доступа к шлюзу приложения щелкните журнал, который вы хотите проанализировать и экспортировать, а затем экспортируйте файл JSON.

4. Преобразуйте файл JSON, экспортируемый в шаге 3, в файл CSV и просмотрите их в Excel, Power BI или любом другом инструменте визуализации данных.

5. Проверьте следующие данные:

- **ClientIP**- Это IP-адрес клиента от подключающего клиента.
- **ClientPort** - Это исходный порт от подключающего клиента для запроса.
- **Запрос -** Это указывает на сервер назначения, который получен запрос.
- **Сервер-Routed**: Экземпляр пула бэк-энда, который получен запрос.
- **X-AzureApplicationGateway-LOG-ID** — идентификатор корреляции, используемый для запроса. Он может использоваться для устранения неполадок с трафиком на внутренних серверах. Например: X-AzureApplicationGateway-CACHE-HIT-0&SERVER-ROUTED-10.0.2.4.

  - **SERVER-STATUS** — код отклика HTTP, полученный шлюзом приложений из серверной части.

  ![устранение неполадок-сессия-аффинити-вопросы-11](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-11.png)

Если вы видите два элемента из одного и того же Порта ClientIP и Client Port, и они отправляются на один и тот же сервер бэк-энда, это означает, что шлюз приложения настроен правильно.

Если вы видите два элемента, поступающих из одного и того же ClientIP и Клиентского порта, и они отправляются на различные серверы бэк-энда, это означает, что запрос подпрыгивает между серверами бэкэнда, выберите "**Приложение использует сродство на основе файлов cookie, но запросы все еще подпрыгивают между серверами бэк-энда**" в нижней части, чтобы устранить его.

### <a name="use-web-debugger-to-capture-and-analyze-the-http-or-https-traffics"></a>Используйте веб-отладчик для захвата и анализа трафика HTTP или HTTPS

Инструменты отладки веб- данных, такие как Fiddler, могут помочь вам отладить веб-приложения, захватив сетевой трафик между Интернетом и тестовыми компьютерами. Эти инструменты позволяют проверять входящие и исходящие данные по мере их получения/отправки браузером. В этом примере у Скрипача есть опция воспроизведения HTTP, которая может помочь вам устранить проблемы на стороне клиента с веб-приложениями, особенно для проверки подлинности.

Используйте веб-отладчик по вашему выбору. В этом примере мы будем использовать Fiddler для захвата и анализа http или https трафика, следуйте инструкциям:

1. Скачать инструмент Скрипач на <https://www.telerik.com/download/fiddler>.

    > [!NOTE]
    > Выберите Fiddler4, если захват компьютера имеет .NET 4 установлен. В противном случае выберите Fiddler2.

2. Право нажмите на установку исполняемой, и запустить в качестве администратора для установки.

    ![устранение неполадок-сессия-аффинити-вопросы-12](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-12.png)

3. При открытии Fiddler он должен автоматически начать захват трафика (обратите внимание на захват в левом нижнем углу). Нажмите F12, чтобы начать или остановить захват трафика.

    ![устранение неполадок-сессия-аффинити-вопросы-13](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-13.png)

4. Скорее всего, вас заинтересует расшифрованный трафик HTTPS, и вы сможете включить расшифровку HTTPS, выбрав **опции Инструменты** > **Скрипача**и проверьте поле « **Расшифровка httpS трафика**».

    ![устранение неполадок-сессия-аффинити-вопросы-14](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-14.png)

5. Вы можете удалить предыдущие несвязанные сеансы, прежде чем воспроизвести проблему, нажав **на X** (значок) > **Удалить все** как последующий скриншот: 

    ![устранение неполадок-сессия-аффинити-вопросы-15](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-15.png)

6. После воспроизведения проблемы сохраните файл для просмотра, выбрав **файл** > **Сохранить** > **все сессии..**. 

    ![устранение неполадок-сессия-аффинити-вопросы-16](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-16.png)

7. Проверьте и проанализируйте журналы сеансов, чтобы определить, в чем проблема.

    Примеры приведены ниже.

- **Пример A:** Вы находите журнал сеанса, что запрос отправляется от клиента, и он идет на общедоступный IP-адрес шлюза приложения, нажмите этот журнал, чтобы просмотреть детали.  С правой стороны данные в нижней коробке — это то, что возвращает сяритоге приложения клиенту. Выберите вкладку "RAW" и определите, получает ли клиент **"Set-Cookie: ARRAffinity"** *ARRAffinityValue".* Если нет файла cookie, сродство сеансов не устанавливается, или шлюз приложения не применяет куки обратно к клиенту.

   > [!NOTE]
   > Это значение ARRAffinity является файлом cookie-id, который наборы шлюза приложения для клиента отправляются на определенный сервер бэк-энда.

   ![устранение неполадок-сессия-аффинити-вопросы-17](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-17.png)

- **Пример B:** Следующим журналом сеанса, за которым следует предыдущий, является ответ клиента на шлюз приложения, который установил ARRAAFFINITY. Если ARRAffinity совпадает с файлами cookie-id, пакет должен быть отправлен на тот же сервер бэк-энда, который использовался ранее. Проверьте следующие несколько строк http-сообщения, чтобы увидеть, изменяется ли cookie-печенье ARRAffinity клиента.

   ![устранение неполадок-сессия-аффинити-вопросы-18](./media/how-to-troubleshoot-application-gateway-session-affinity-issues/troubleshoot-session-affinity-issues-18.png)

> [!NOTE]
> Для того же сеанса связи файлы cookie не должны меняться. Проверьте верхнюю коробку на правой стороне, выберите вкладку "Cookies", чтобы узнать, использует ли клиент cookie и отправляет его обратно в шлюз приложения. В противном случае клиентский браузер не хранит и не использует файлы cookie для разговоров. Иногда клиент может лгать.

 

## <a name="next-steps"></a>Дальнейшие действия

Если описанные выше шаги не устранят проблему, отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).
