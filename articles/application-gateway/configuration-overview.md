---
title: Обзор настройки шлюза приложений Azure
description: В этой статье описывается, как настроить компоненты шлюза приложений Azure.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: conceptual
ms.date: 07/30/2020
ms.author: absha
ms.openlocfilehash: 9315884db30c053d86c889ff3b45aaea17d48b17
ms.sourcegitcommit: 14bf4129a73de2b51a575c3a0a7a3b9c86387b2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2020
ms.locfileid: "87438918"
---
# <a name="application-gateway-configuration-overview"></a>Обзор настройки шлюза приложений

Шлюз приложений Azure состоит из нескольких компонентов, которые можно настроить различными способами для различных сценариев. В этой статье показано, как настроить каждый компонент.

![Потоковая диаграмма компонентов шлюза приложений](./media/configuration-overview/configuration-overview1.png)

На этом рисунке показано приложение с тремя прослушивателями. Первые два являются прослушивателями нескольких сайтов для `http://acme.com/*` и `http://fabrikam.com/*` соответственно. Прослушивать порт 80. Третий является базовым прослушивателем, который имеет сквозное завершение безопасности транспортного уровня (TLS), ранее известное как SSL (SSL).


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="prerequisites"></a>Предварительные требования

### <a name="azure-virtual-network-and-dedicated-subnet"></a>Виртуальная сеть Azure и выделенная подсеть

Шлюз приложений — это выделенное развертывание в виртуальной сети. В виртуальной сети для шлюза приложений требуется выделенная подсеть. В подсети может быть несколько экземпляров заданного развертывания шлюза приложений. Кроме того, в подсети можно развернуть другие шлюзы приложений. Но вы не можете развернуть другие ресурсы в подсети шлюза приложений.

> [!NOTE]
> Вы не можете смешивать Standard_v2 и стандартный шлюз приложений Azure в одной подсети.

#### <a name="size-of-the-subnet"></a>Размер подсети

Шлюз приложений использует по одному частному IP-адресу для каждого экземпляра, а другой частный IP-адрес — в случае настройки частного внешнего IP-адреса.

Azure также резервирует пять IP-адресов в каждой подсети для внутреннего использования: первые четыре и последние IP-адреса. Например, рассмотрим 15 экземпляров шлюза приложений без частного внешнего IP-адреса. Для этой подсети требуется по крайней мере 20 IP-адресов: пять для внутреннего использования и 15 для экземпляров шлюза приложений. Таким образом, размер подсети (/27) должен быть или больше.

Рассмотрим подсеть с 27 экземплярами шлюза приложений и IP-адресом частного IP-адреса внешнего интерфейса. В этом случае вам потребуется 33 IP-адресов: 27 для экземпляров шлюза приложений, один для частного внешнего интерфейса и пять для внутреннего использования. Таким образом, размер подсети (/26) должен быть или больше.

Рекомендуется использовать размер подсети не менее/28. Этот размер предоставляет 11 возможных IP-адресов. Если для загрузки приложения требуется более 10 экземпляров шлюза приложений, следует рассмотреть размер подсети/27 или/26.

#### <a name="network-security-groups-on-the-application-gateway-subnet"></a>Группы безопасности сети в подсети шлюза приложений

Группы безопасности сети (группы безопасности сети) поддерживаются в шлюзе приложений. Но существуют некоторые ограничения.

- Необходимо разрешить входящий трафик Интернета через TCP-порты 65503–65534 для номера SKU шлюза приложений версии 1, а также через TCP-порты 65200–65535 для номера SKU версии 2 с целевой подсетью **Любая** и источником **GatewayManager** (тег службы источника). Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Эти порты защищены (заблокированы) сертификатами Azure. Внешние сущности, включая клиентов этих шлюзов, не могут обмениваться данными с этими конечными точками.

- Исходящее подключение к Интернету не может быть заблокировано. Правила исходящего трафика по умолчанию в NSG разрешают подключение к Интернету. Примите во внимание следующие рекомендации.

  - Не удаляйте правила исходящего трафика по умолчанию.
  - Не создавайте другие правила исходящего трафика, которые запрещают исходящие подключения.

- **Должен быть** разрешен трафик из тега **AzureLoadBalancer** с конечной подсетью.

#### <a name="allow-application-gateway-access-to-a-few-source-ips"></a>Разрешить шлюзу приложений доступ к некоторым исходным IP-адресам

В этом сценарии используйте группы безопасности сети в подсети шлюза приложений. Установите следующие ограничения для подсети в следующем порядке приоритета:

1. Разрешите входящий трафик из исходного IP-адреса или диапазона IP-адресов с назначением в качестве целого диапазона адреса подсети шлюза приложений и порта назначения в качестве порта входящего доступа, например порт 80 для доступа по протоколу HTTP.
2. Разрешите входящие запросы от источника в качестве тега службы **гатевайманажер** и назначения в качестве **любых** портов назначения, а также порты назначений 65503-65534 для SKU шлюза приложений версии 1 и порты 65200-65535 для SKU v2 для [обмена данными о состоянии работоспособности серверной](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics)части. Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Эти порты защищены (заблокированы) сертификатами Azure. Без соответствующих сертификатов на месте внешние сущности не могут инициировать изменения на этих конечных точках.
3. Разрешите входящие проверки Azure Load Balancer (тег*AzureLoadBalancer* ) и входящий трафик виртуальной сети (тег*VirtualNetwork* ) в [группе безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview).
4. Блокировать весь остальной входящий трафик с помощью правила "запретить все".
5. Разрешите исходящий трафик в Интернет для всех назначений.

#### <a name="user-defined-routes-supported-on-the-application-gateway-subnet"></a>Определяемые пользователем маршруты, поддерживаемые в подсети Шлюза приложений.

> [!IMPORTANT]
> Использование определяемые пользователем маршруты в подсети шлюза приложений может привести к тому, что состояние работоспособности в [представлении работоспособности серверной](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics#back-end-health) части будет отображаться как **неизвестное**. Это также может привести к сбою при создании журналов и метрик шлюза приложений. Рекомендуется не использовать определяемые пользователем маршруты в подсети шлюза приложений, чтобы можно было просматривать сведения о работоспособности, журналах и метриках серверной части.

- **Версия 1**

   Для SKU версии 1 определяемые пользователем маршруты (определяемые пользователем маршруты) поддерживаются в подсети шлюза приложений, если они не меняют сквозную связь между запросами и ответами. Например, можно настроить UDR в подсети шлюза приложений, чтобы она указывала на устройство брандмауэра для проверки пакетов. Но необходимо убедиться, что пакет может достичь предполагаемого назначения после проверки. Несоблюдение этого действия может привести к неправильному поведению проверки работоспособности или маршрутизации трафика. Сюда входят полученные маршруты или маршруты 0.0.0.0/0 по умолчанию, распространяемые Azure ExpressRoute или VPN-шлюзы в виртуальной сети. Любой сценарий, в котором 0.0.0.0/0 должен перенаправляться локально (принудительное туннелирование), не поддерживается для v1.

- **Версия 2**

   Для SKU версии 2 поддерживаются и неподдерживаемые сценарии:

   **Поддерживаемые сценарии v2**
   > [!WARNING]
   > Неправильная конфигурация таблицы маршрутов может привести к появлению асимметричной маршрутизации в шлюзе приложений версии 2. Убедитесь, что весь трафик плоскости управления и управления отправляется непосредственно в Интернет, а не через виртуальное устройство. Также могут быть затронуты журналы и метрики.


  **Сценарий 1**. UDR. Отключение распространения маршрута протокол BGP (BGP) к подсети шлюза приложений

   Иногда маршрут шлюза по умолчанию (0.0.0.0/0) объявляется через шлюзы ExpressRoute или VPN, связанные с виртуальной сетью шлюза приложений. Это приводит к разрыву трафика плоскости управления, для которого требуется прямой путь к Интернету. В таких случаях для отключения распространения маршрутов BGP можно использовать UDR. 

   Чтобы отключить распространение маршрутов BGP, выполните следующие действия.

   1. Создайте ресурс таблицы маршрутов в Azure.
   2. Отключите параметр **распространения маршрута шлюза виртуальной сети** . 
   3. Свяжите таблицу маршрутов с соответствующей подсетью. 

   Включение UDR для этого сценария не должно привести к нарушению существующих настроек.

  **Сценарий 2**. UDR to Direct 0.0.0.0/0 в Интернете

   Вы можете создать UDR для отправки трафика 0.0.0.0/0 непосредственно в Интернет. 

  **Сценарий 3**. UDR для службы Kubernetes Azure с кубенет

  Если вы используете кубенет со службой Kubernetes Azure (AKS) и контроллером входящего трафика шлюза приложений (АГИК), вам потребуется Таблица маршрутов, чтобы разрешить маршрутизацию трафика, отправляемого в модули Pod из шлюза приложений, на правильный узел. Это не потребуется, если вы используете Azure CNI. 

  Чтобы использовать таблицу маршрутов для кубенет работы, выполните следующие действия:

  1. Перейдите к группе ресурсов, созданной с помощью AKS (имя группы ресурсов должно начинаться с "MC_").
  2. Найдите таблицу маршрутов, созданную с помощью AKS в этой группе ресурсов. Таблица маршрутов должна быть заполнена следующими сведениями:
     - Префикс адреса должен быть IP-диапазоном модулей Pod, которые вы хотите получить в AKS. 
     - Тип следующего прыжка должен быть виртуальным устройством. 
     - Адресом следующего прыжка должен быть IP-адрес узла, на котором размещаются модули.
  3. Свяжите эту таблицу маршрутов с подсетью шлюза приложений. 
    
  **версии 2 Неподдерживаемые сценарии**

  **Сценарий 1**. UDR для виртуальных устройств

  Любой сценарий, в котором 0.0.0.0/0 должен перенаправляться через любое виртуальное устройство, виртуальную сеть, периферийную или локальную (принудительное туннелирование), не поддерживается для версии 2.

## <a name="front-end-ip"></a>Интерфейсный IP-адрес

Для шлюза приложений можно настроить общедоступный IP-адрес, частный IP-адрес или и то, и другое. Общедоступный IP-адрес требуется при размещении серверной части, к которой клиенты должны получить доступ через Интернет через виртуальный IP-адрес (VIP) с выходом в Интернет.

> [!NOTE]
> В настоящее время Шлюз приложений версии 2 не поддерживает режим только частного IP-адреса. Он поддерживает следующие сочетания:
>* частный и общедоступный IP-адреса;
>* только общедоступный IP-адрес.
>
> Дополнительные сведения см. в разделе [часто задаваемые вопросы о шлюзе приложений](application-gateway-faq.md#how-do-i-use-application-gateway-v2-with-only-private-frontend-ip-address).


Общедоступный IP-адрес не требуется для внутренней конечной точки, которая не доступна в Интернете. Это называется внутренней конечной точкой *балансировщика нагрузки* (ilB) или частным интерфейсным IP-адресом. ILB шлюза приложений полезен для внутренних бизнес-приложений, которые не доступны в Интернете. Он также полезен для служб и уровней в многоуровневом приложении в пределах границы безопасности, которая не предоставляется в Интернете, но требует распределения нагрузки с циклическим перебором, прикрепления сеанса или завершения TLS.

Поддерживается только один общедоступный IP-адрес или один частный IP-адрес. При создании шлюза приложений вы выбираете IP-адрес внешнего интерфейса.

- Для общедоступного IP-адреса можно создать новый общедоступный IP-адрес или использовать существующий общедоступный IP в том же расположении, что и шлюз приложений. Дополнительные сведения см. в разделе [статический и динамический общедоступный IP-адрес](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#static-versus-dynamic-public-ip-address).

- Для частного IP-адреса можно указать частный IP-адрес из подсети, в которой создан шлюз приложений. Если его не указать, в подсети автоматически выбирается произвольный IP-адрес. Выбранный тип IP-адреса (статический или динамический) нельзя изменить позже. Дополнительные сведения см. в статье [Создание шлюза приложений с внутренней подсистемой балансировки нагрузки](https://docs.microsoft.com/azure/application-gateway/application-gateway-ilb-arm).

Интерфейсный IP-адрес связан с *прослушивателем*, который проверяет наличие входящих запросов на ИНТЕРФЕЙСНОЙ IP-части.

## <a name="listeners"></a>Прослушиватели

Прослушиватель — это логическая сущность, которая проверяет входящие запросы на подключение с помощью порта, протокола, узла и IP-адреса. При настройке прослушивателя необходимо ввести значения, соответствующие соответствующим значениям в входящем запросе на шлюзе.

При создании шлюза приложений с помощью портал Azure также создается прослушиватель по умолчанию, который выбирает протокол и порт для прослушивателя. Можно выбрать, следует ли включить поддержку HTTP2 для прослушивателя. После создания шлюза приложений можно изменить параметры этого прослушивателя по умолчанию (*appGatewayHttpListener*) или создать новые прослушиватели.

### <a name="listener-type"></a>Тип прослушивателя

При создании нового прослушивателя выбирается режим " [ *базовый* " и " *многосайтовый*](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#types-of-listeners)".

- Если требуется, чтобы все запросы (для любого домена) были приняты и переданы в серверные пулы, выберите базовый. Узнайте, [как создать шлюз приложений с базовым прослушивателем](https://docs.microsoft.com/azure/application-gateway/quick-create-portal).

- Если требуется перенаправить запросы к различным внутренним пулам на основе заголовка *узла* или имен узлов, выберите прослушиватель нескольких сайтов, где необходимо также указать имя узла, которое соответствует входящему запросу. Это связано с тем, что шлюз приложений использует заголовки узлов HTTP 1,1 для размещения нескольких веб-сайтов на одном и том же общедоступном IP-адресе и порте. Дополнительные сведения см. в разделе [Размещение нескольких сайтов с помощью шлюза приложений](multiple-site-overview.md).

#### <a name="order-of-processing-listeners"></a>Порядок обработки прослушивателей

Для номера SKU v1 запросы сопоставляются в соответствии с порядком правил и типом прослушивателя. Если правило с базовым прослушивателем сначала поступает в порядке, оно обрабатывается первым и принимает любой запрос на это сочетание порта и IP-адреса. Чтобы избежать этого, сначала настройте правила с многосайтовыми прослушивателями и отправьте правило с базовым прослушивателем в последнюю из списка.

Для SKU версии 2 многосайтовые прослушиватели обрабатываются перед основными прослушивателями.

### <a name="front-end-ip"></a>Интерфейсный IP-адрес

Выберите IP-адрес внешнего интерфейса, который планируется связать с этим прослушивателем. Прослушиватель будет прослушивать входящие запросы на этом IP-адресе.

### <a name="front-end-port"></a>Интерфейсный порт

Выберите интерфейсный порт. Выберите существующий порт или создайте новый. Выберите любое значение из [разрешенного диапазона портов](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#ports). Можно использовать не только хорошо известные порты, например 80 и 443, но и любой допустимый настраиваемый порт. Порт можно использовать для общедоступных прослушивателей или частных прослушивателей.

### <a name="protocol"></a>Протокол

Выберите HTTP или HTTPS:

- При выборе протокола HTTP трафик между клиентом и шлюзом приложений не шифруется.

- Выберите HTTPS, если вы хотите использовать [Завершение TLS](features.md#secure-sockets-layer-ssltls-termination) или [сквозное шифрование TLS](https://docs.microsoft.com/azure/application-gateway/ssl-overview). Трафик между клиентом и шлюзом приложений шифруется. И подключение TLS завершается на шлюзе приложений. Если требуется сквозное шифрование TLS, необходимо выбрать протокол HTTPS и настроить **серверный параметр HTTP** . Это гарантирует, что трафик будет повторно зашифрован при передаче из шлюза приложений в серверную.


Чтобы настроить завершение TLS и сквозное шифрование TLS, необходимо добавить сертификат в прослушиватель, чтобы шлюз приложений выдать симметричный ключ. Это определяется спецификацией протокола TLS. Симметричный ключ используется для шифрования и расшифровки трафика, отправляемого в шлюз. Сертификат шлюза должен быть в формате файла обмена личной информацией (PFX). Этот формат позволяет экспортировать закрытый ключ, используемый шлюзом для шифрования и расшифровки трафика.

#### <a name="supported-certificates"></a>Поддерживаемые сертификаты

См. раздел [сертификаты, поддерживаемые для завершения TLS](https://docs.microsoft.com/azure/application-gateway/ssl-overview#certificates-supported-for-ssl-termination).

### <a name="additional-protocol-support"></a>Поддержка дополнительных протоколов

#### <a name="http2-support"></a>Поддержка HTTP2

Поддержка протокола HTTP/2 доступна для клиентов, подключающихся только к прослушивателям шлюза приложений. Взаимодействие с пулами внутренних серверов осуществляется по протоколу HTTP/1.1. Поддержка HTTP/2 отключена по умолчанию. В следующем Azure PowerShell фрагменте кода показано, как включить это:

```azurepowershell
$gw = Get-AzApplicationGateway -Name test -ResourceGroupName hm

$gw.EnableHttp2 = $true

Set-AzApplicationGateway -ApplicationGateway $gw
```

#### <a name="websocket-support"></a>Поддержка WebSocket

Поддержка WebSocket включена по умолчанию. Настраиваемый пользователем параметр для включения или отключения не предусмотрен. WebSocket можно использовать с прослушивателями HTTP и HTTPS.

### <a name="custom-error-pages"></a>Пользовательские страницы ошибок

Пользовательскую ошибку можно определить на глобальном уровне или на уровне прослушивателя. Но создание настраиваемых страниц ошибок глобального уровня из портал Azure в настоящее время не поддерживается. Можно настроить настраиваемую страницу ошибки для ошибки брандмауэра веб-приложения 403 или страницы обслуживания 502 на уровне прослушивателя. Необходимо также указать общедоступный URL-адрес большого двоичного объекта для данного кода состояния ошибки. Дополнительные сведения см. в статье [Create Application Gateway custom error pages](https://docs.microsoft.com/azure/application-gateway/custom-error) (Создание пользовательских страниц ошибок с помощью Шлюза приложений).

![Коды ошибок службы "Шлюз приложений"](https://docs.microsoft.com/azure/application-gateway/media/custom-error/ag-error-codes.png)

Сведения о настройке глобальной настраиваемой страницы ошибки см. в разделе [Azure PowerShell Configuration](https://docs.microsoft.com/azure/application-gateway/custom-error#azure-powershell-configuration).

### <a name="tls-policy"></a>Политика TLS

Вы можете централизовать управление сертификатами TLS/SSL и снизить затраты на расшифровку шифрования для внутренней фермы серверов. Централизованная обработка TLS также позволяет указать централизованную политику TLS, которая подходит для требований безопасности. Можно выбрать *стандартную*, *предопределенную*или *настраиваемую* политику TLS.

Политика TLS настраивается для управления версиями протокола TLS. Вы можете настроить шлюз приложений для использования минимальной версии протокола для подтверждений TLS из TLS 1.0, TLS 1.1 и TLS 1.2. По умолчанию SSL 2,0 и 3,0 отключены и не могут быть настроены. Дополнительные сведения см. в статье [Общие сведения о политике TLS для шлюза приложений](https://docs.microsoft.com/azure/application-gateway/application-gateway-ssl-policy-overview).

После создания прослушивателя связывается с правилом маршрутизации запросов. Это правило определяет, как запросы, получаемые в прослушивателе, направляются в серверную систему.

## <a name="request-routing-rules"></a>Правила маршрутизации запросов

При создании шлюза приложений с помощью портал Azure создается правило по умолчанию (*Rule1*). Это правило связывает прослушиватель по умолчанию (*appGatewayHttpListener*) с внутренним пулом по умолчанию (*appGatewayBackendPool*) и параметрами HTTP серверной части по умолчанию (*appGatewayBackendHttpSettings*). После создания шлюза можно изменить параметры правила по умолчанию или создать новые правила.

### <a name="rule-type"></a>Тип правила

При создании правила выбирается между [ *базовым* и *основанным на пути*](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#request-routing-rules).

- Выберите базовый, если хотите перенаправить все запросы к связанному прослушивателю (например, *Blog <i></i> . contoso.com/ \* )* в один пул серверной части.
- Выберите путь на основе пути, если требуется направить запросы с конкретных URL-путей к конкретным внутренним пулам. Шаблон пути применяется только к пути URL-адреса, а не к его параметрам запроса.

#### <a name="order-of-processing-rules"></a>Порядок правил обработки

Для номеров SKU v1 и v2 шаблон сопоставления входящих запросов обрабатывается в том порядке, в котором пути указаны на карте URL-пути правила на основе пути. Если запрос соответствует шаблону в двух или более путях на карте пути, то сначала соответствует указанному пути. И запрос перенаправляется в серверную части, связанную с этим путем.

### <a name="associated-listener"></a>Связанный прослушиватель

Свяжите прослушиватель с правилом таким образом, чтобы *правило маршрутизации запросов* , связанное с прослушивателем, было оценено для определения серверного пула, направляющего запрос.

### <a name="associated-back-end-pool"></a>Связанный серверный пул

Свяжите с правилом серверный пул, содержащий серверные целевые объекты, которые обслуживают запросы, получаемые прослушивателем.

 - Для базового правила допускается только один серверный пул. Все запросы к связанному прослушивателю перенаправляются в этот пул серверной части.

 - Для правила на основе пути добавьте несколько внутренних пулов, соответствующих каждому пути URL-адреса. Запросы, которые соответствуют указанному URL-адресу, перенаправляются в соответствующий пул серверной части. Кроме того, добавьте пул серверной части по умолчанию. Запросы, которые не соответствуют ни одному из URL-пути в правиле, перенаправляются в этот пул.

### <a name="associated-back-end-http-setting"></a>Связанный параметр HTTP серверной части

Добавьте параметр HTTP серверной части для каждого правила. Запросы направляются из шлюза приложений на серверные цели с использованием номера порта, протокола и других сведений, указанных в этом параметре.

Для базового правила допускается только один параметр HTTP серверной части. Все запросы к связанному прослушивателю перенаправляются в соответствующие целевые серверные цели с помощью этого параметра HTTP.

Для правила на основе пути добавьте несколько внутренних параметров HTTP, соответствующих каждому пути URL-адреса. Запросы, соответствующие URL-адресу в этом параметре, перенаправляются в соответствующие целевые объекты, используя параметры HTTP, соответствующие каждому пути URL-адреса. Кроме того, добавьте параметр HTTP по умолчанию. Запросы, которые не соответствуют ни одному URL-адресу в этом правиле, перенаправляются в пул серверной части по умолчанию, используя параметр HTTP по умолчанию.

### <a name="redirection-setting"></a>Параметр перенаправления

Если перенаправление настроено для базового правила, все запросы к связанному прослушивателю перенаправляются на целевой объект. Это *глобальное* перенаправление. Если перенаправление настроено для правила на основе пути, перенаправляются только запросы в определенной области сайта. Примером является область корзины для покупок, обозначенная */карт/ \* *. Это перенаправление *на основе пути* .

Дополнительные сведения о перенаправлениях см. в статье [Обзор перенаправления шлюза приложений](redirect-overview.md).

#### <a name="redirection-type"></a>Тип перенаправления

Выберите тип нужного перенаправления: *Постоянный (301)*, *временный (307)*, *найденный (302*) или *другой (303)*.

#### <a name="redirection-target"></a>Цель перенаправления

Выберите другой прослушиватель или внешний сайт в качестве цели перенаправления.

##### <a name="listener"></a>Прослушиватель

Выберите прослушиватель в качестве цели перенаправления, чтобы перенаправить трафик от одного прослушивателя к другому на шлюзе. Этот параметр необходим, если требуется включить перенаправление HTTP в HTTPS. Он перенаправляет трафик от прослушивателя источника, который проверяет наличие входящих HTTP-запросов на прослушиватель назначения, который проверяет наличие входящих запросов HTTPS. Можно также включить строку запроса и путь из исходного запроса в запрос, перенаправляемый целевому объекту перенаправления.

![Диалоговое окно "компоненты шлюза приложений"](./media/configuration-overview/configure-redirection.png)

Дополнительные сведения о перенаправлении HTTP в HTTPS см. в следующих статьях:
- [Перенаправление HTTP-to-HTTPS с помощью портал Azure](redirect-http-to-https-portal.md)
- [Перенаправление HTTP в HTTPS с помощью PowerShell](redirect-http-to-https-powershell.md)
- [Перенаправление HTTP-to-HTTPS с помощью Azure CLI](redirect-http-to-https-cli.md)

##### <a name="external-site"></a>Внешний сайт

Выберите внешний сайт, если требуется перенаправить трафик прослушивателя, связанного с этим правилом, на внешний сайт. Можно выбрать включение строки запроса из исходного запроса в запрос, перенаправляемый цели перенаправления. Невозможно переадресовать путь к внешнему сайту, который был в исходном запросе.

Дополнительные сведения о перенаправлении см. в следующих статьях:
- [Перенаправление трафика на внешний сайт с помощью PowerShell](redirect-external-site-powershell.md)
- [Перенаправление трафика на внешний сайт с помощью интерфейса командной строки](redirect-external-site-cli.md)

### <a name="rewrite-http-headers-and-url"></a>Перезапись заголовков HTTP и URL-адреса

С помощью правил перезаписи можно добавлять, удалять или обновлять заголовки запросов и ответов HTTP (S), а также URL-пути и параметры строки запроса, так как пакеты запросов и ответов перемещаются между клиентом и серверным пулом через шлюз приложений.

Для заголовков и параметров URL-адреса можно задать статические значения или другие заголовки и серверные переменные. Это позволяет использовать важные варианты использования, такие как извлечение IP-адресов клиентов, удаление конфиденциальных сведений о серверной части, добавление дополнительной защиты и т. д.
Дополнительные сведения можно найти в разделе

 - [Перезапись заголовков HTTP и обзора URL-адресов](rewrite-http-headers-url.md)
 - [Настройка перезаписи HTTP-заголовка](rewrite-http-headers-portal.md)
 - [Настройка переопределения URL-адресов](rewrite-url-portal.md)

## <a name="http-settings"></a>Параметры HTTP

Шлюз приложений направляет трафик на серверы внутренних серверов с помощью указанной здесь конфигурации. После создания параметра HTTP необходимо связать его с одним или несколькими правилами маршрутизации запросов.

### <a name="cookie-based-affinity"></a>Сходство на основе файлов cookie,

Шлюз приложений Azure использует управляемые шлюзом файлы cookie для обслуживания пользовательских сеансов. Когда пользователь отправляет первый запрос в шлюз приложений, он устанавливает в ответе файл cookie сходства с хэш-значением, содержащим сведения о сеансе, чтобы последующие запросы, включающие файл cookie с сходством, направляются на тот же внутренний сервер для поддержания закрепления. 

Эта функция полезна, если необходимо сохранить сеанс пользователя на том же сервере и сохранить состояние сеанса локально на сервере для сеанса пользователя. Если приложение не может управлять сходством на основе файлов cookie, эту функцию использовать нельзя. Чтобы использовать его, убедитесь, что клиенты поддерживают файлы cookie.

[Обновление V80](https://chromiumdash.appspot.com/schedule) [браузера Chromium](https://www.chromium.org/Home) было предписано, где файлы cookie HTTP без атрибута [SameSite](https://tools.ietf.org/id/draft-ietf-httpbis-rfc6265bis-03.html#rfc.section.5.3.7) должны рассматриваться как SameSite = нестрогие. В случае запросов CORS (совместное использование ресурсов независимо от источника), если файл cookie должен быть отправлен в контексте стороннего разработчика, он должен использовать *SameSite = None; Безопасные* атрибуты и должны отправляться только по протоколу HTTPS. В противном случае в сценарии HTTP браузер не отправляет файлы cookie в контексте стороннего разработчика. Целью этого обновления из Chrome является повышение безопасности и предотвращение атак с подделкой межсайтовых запросов (CSRF). 

Для поддержки этого изменения, начиная с 17 2020 февраля, в дополнение к существующему *аппликатионгатевайаффинити* файлу cookie в шлюзе приложений (все типы SKU) будет добавлен другой файл cookie с именем *аппликатионгатевайаффинитикорс* . К файлу cookie *аппликатионгатевайаффинитикорс* добавлены еще два атрибута (*"SameSite = None; Безопасность "*), чтобы закрепленный сеанс поддерживался даже для запросов между источниками.

Обратите внимание, что имя файла cookie сходства по умолчанию — *аппликатионгатевайаффинити* , и его можно изменить. Если вы используете имя файла cookie для пользовательского сходства, в качестве суффикса CORS добавляется дополнительный файл cookie. Например, *кустомкукиенамекорс*.

> [!NOTE]
> Если атрибут *SameSite = None* установлен, он обязательно должен содержать флаг *Secure* , и его необходимо отправлять по протоколу HTTPS.  Если для CORS требуется сходство сеансов, необходимо перенести рабочую нагрузку в HTTPS. Ознакомьтесь с разгрузкой TLS и документацией по TLS для шлюза приложений. [Обзор](ssl-overview.md), [Настройка шлюза приложений с завершением tls с помощью портал Azure](create-ssl-portal.md), [Настройка сквозного протокола TLS с помощью шлюза приложений с порталом](end-to-end-ssl-portal.md).

### <a name="connection-draining"></a>фильтрация подключений;

Сток подключений помогает аккуратно удалить членов пула серверной части во время плановых обновлений службы. Вы можете применить этот параметр ко всем элементам пула серверной части, включив сток подключений для параметра HTTP. Это гарантирует, что все отменяющие регистрацию экземпляров серверного пула продолжают поддерживать существующие подключения и обслуживать запросы в течение настраиваемого времени ожидания и не получают новые запросы или соединения. Единственным исключением из этого являются запросы, связанные для отмены регистрации экземпляров из-за сходства сеанса, управляемого шлюзом, и будут по-прежнему перенаправлены в экземпляры отмены регистрации. Сток подключений применяется к внутренним экземплярам, которые явным образом удаляются из серверного пула.

### <a name="protocol"></a>Протокол

Шлюз приложений поддерживает протоколы HTTP и HTTPS для маршрутизации запросов к внутренним серверам. При выборе HTTP трафик к внутренним серверам не шифруется. Если обмен данными без шифрования неприемлем, выберите HTTPS.

Этот параметр в сочетании с протоколом HTTPS в прослушивателе поддерживает [сквозной протокол TLS](ssl-overview.md). Это позволяет безопасно передавать конфиденциальные данные, зашифрованные в серверной части. На каждом внутреннем сервере в пуле серверной части, для которого включен сквозной протокол TLS, необходимо настроить сертификат, чтобы обеспечить безопасную связь.

### <a name="port"></a>Port

Этот параметр указывает порт, на котором серверные серверы прослушивают трафик от шлюза приложений. Можно настроить порты в диапазоне от 1 до 65535.

### <a name="request-timeout"></a>Время ожидания запроса

Этот параметр определяет время в секундах, в течение которого шлюз приложений ожидает получения ответа от сервера внутренней стороны.

### <a name="override-back-end-path"></a>Переопределить путь к серверной части

Этот параметр позволяет настроить необязательный пользовательский путь перенаправления, который будет использоваться при пересылке запроса в серверную части. Любая часть входящего пути, соответствующая пользовательскому пути в поле " **Переопределение серверного пути** ", копируется в перенаправленный путь. В следующей таблице показано, как работает эта функция.

- Когда параметр HTTP прикрепляется к базовому правилу маршрутизации запросов:

  | Исходный запрос  | Переопределить путь к серверной части | Запрос перенаправлен на серверную части |
  | ----------------- | --------------------- | ---------------------------- |
  | /Home            | /override.            | /оверриде/хоме/              |
  | /хоме/секондхоме/ | /override.            | /оверриде/хоме/секондхоме/   |

- Когда параметр HTTP прикрепляется к правилу маршрутизации запросов на основе пути:

  | Исходный запрос           | Правило для пути       | Переопределить путь к серверной части | Запрос перенаправлен на серверную части |
  | -------------------------- | --------------- | --------------------- | ---------------------------- |
  | /пасруле/хоме/            | pathrule      | /override.            | /оверриде/хоме/              |
  | /пасруле/хоме/секондхоме/ | pathrule      | /override.            | /оверриде/хоме/секондхоме/   |
  | /Home                     | pathrule      | /override.            | /оверриде/хоме/              |
  | /хоме/секондхоме/          | pathrule      | /override.            | /оверриде/хоме/секондхоме/   |
  | /пасруле/хоме/            | /пасруле/Хоме * | /override.            | /override.                   |
  | /пасруле/хоме/секондхоме/ | /пасруле/Хоме * | /override.            | /оверриде/секондхоме/        |
  | pathrule                 | pathrule      | /override.            | /override.                   |

### <a name="use-for-app-service"></a>Использование для службы приложений

Это ярлык только для пользовательского интерфейса, который выбирает два обязательных параметра для серверной части службы приложений Azure. Он позволяет **выбрать имя узла на внутреннем адресе**и создает новую пользовательскую проверку, если у вас ее еще нет. (Дополнительные сведения см. в разделе [Выбор имени узла из параметра адрес внутренней](#pick) части этой статьи.) Будет создана новая проба, и заголовок зонда выбирается из адреса элемента серверной части.

### <a name="use-custom-probe"></a>Использовать пользовательскую проверку

Этот параметр связывает [пользовательскую проверку](application-gateway-probe-overview.md#custom-health-probe) с параметром HTTP. Вы можете связать только одну пользовательскую пробу с параметром HTTP. Если пользовательская пробная версия не связана явным образом, для наблюдения за работоспособностью серверной части используется [проба по умолчанию](application-gateway-probe-overview.md#default-health-probe-settings) . Рекомендуется создать пользовательскую проверку, чтобы лучше управлять мониторингом работоспособности Ваших серверных окончаний.

> [!NOTE]
> Пользовательская проба не отслеживает работоспособность пула серверной части, если соответствующий параметр HTTP явно не связан с прослушивателем.

### <a name="pick-host-name-from-back-end-address"></a><a name="pick"></a>Выберите имя узла на внутреннем адресе

Эта возможность динамически устанавливает заголовок *узла* в запросе на имя узла серверного пула. Он использует IP-адрес или полное доменное имя.

Эта функция помогает, когда доменное имя серверной части отличается от DNS-имени шлюза приложений, а Серверная часть полагается на конкретный заголовок узла для разрешения в правильную конечную точку.

Например, в качестве серверной части используется несколько служб клиента. Служба приложений — это служба с несколькими клиентами, использующая общее пространство с одним IP-адресом. Таким образом, доступ к службе приложений возможен только через имена узлов, настроенные в параметрах личного домена.

По умолчанию имя пользовательского домена — *example.azurewebsites.NET*. Чтобы получить доступ к службе приложений с помощью шлюза приложений через имя узла, которое не было явно зарегистрировано в службе приложений или через полное доменное имя шлюза приложений, необходимо переопределить имя узла в исходном запросе на имя узла службы приложений. Для этого включите параметр " **выбрать имя узла из серверного адреса** ".

Для личного домена, существующее пользовательское DNS-имя которого сопоставляется со службой приложений, вам не нужно включать этот параметр.

> [!NOTE]
> Этот параметр не является обязательным для Среда службы приложений, который является выделенным развертыванием.

### <a name="host-name-override"></a>Переопределение имени узла

Эта возможность заменяет заголовок *узла* во входящем запросе шлюза приложений на указанное имя узла.

Например, если в параметре **имени узла** указано *www.contoso.com* , то исходный запрос * `https://appgw.eastus.cloudapp.azure.com/path1` меняется на *, `https://www.contoso.com/path1` когда запрос перенаправляется на сервер фонового сервера.

## <a name="back-end-pool"></a>Внутренний пул

Серверный пул можно указать на четыре типа серверных членов: определенную виртуальную машину, масштабируемый набор виртуальных машин, IP-адрес или полное доменное имя или службу приложений. 

После создания пула серверной части необходимо связать его с одним или несколькими правилами маршрутизации запросов. Кроме того, необходимо настроить зонды работоспособности для каждого пула серверной части в шлюзе приложений. При выполнении условия правила маршрутизации запросов шлюз приложений перенаправляет трафик на работоспособные серверы (как определено зондами работоспособности) в соответствующем внутреннем пуле.

## <a name="health-probes"></a>Пробы работоспособности

Шлюз приложений по умолчанию отслеживает работоспособность всех ресурсов в его серверной части. Но настоятельно рекомендуется создать пользовательскую проверку для каждого параметра HTTP серверной части, чтобы получить больший контроль над мониторингом работоспособности. Сведения о настройке пользовательской пробы см. в разделе [Настраиваемые параметры проверки работоспособности](application-gateway-probe-overview.md#custom-health-probe-settings).

> [!NOTE]
> После создания пользовательской проверки работоспособности необходимо связать ее с параметром HTTP серверной части. Пользовательская проверка не будет отслеживать работоспособность серверного пула, если соответствующий параметр HTTP явно не связан с прослушивателем с помощью правила.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы знакомы с компонентами шлюза приложений, вы можете:

- [Создание шлюза приложений в портал Azure](quick-create-portal.md)
- [Создание шлюза приложений с помощью PowerShell](quick-create-powershell.md)
- [Создание шлюза приложений с помощью интерфейса командной строки Azure](quick-create-cli.md)
