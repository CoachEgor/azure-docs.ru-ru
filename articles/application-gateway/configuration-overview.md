---
title: Обзор конфигурации Azure Application Gateway
description: В этой статье описывается, как настроить компоненты шлюза приложений Azure
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 03/24/2020
ms.author: absha
ms.openlocfilehash: f31c24c96732ec3311ea904fc9c63344e2d14109
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "80371239"
---
# <a name="application-gateway-configuration-overview"></a>Обзор конфигурации приложения Gateway

Azure Application Gateway состоит из нескольких компонентов, которые можно настроить различными способами для различных сценариев. В этой статье показано, как настроить каждый компонент.

![Диаграмма потока компонентов приложения](./media/configuration-overview/configuration-overview1.png)

Это изображение иллюстрирует приложение, которое имеет трех слушателей. Первые два многоузловые `http://acme.com/*` слушатели для и, `http://fabrikam.com/*`соответственно. Оба слушают на порту 80. Третий — это основной слушатель, который имеет сквозное прекращение безопасности транспортного уровня (TLS), ранее известный как безопасный слой розеток (SSL).


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="prerequisites"></a>Предварительные требования

### <a name="azure-virtual-network-and-dedicated-subnet"></a>Виртуальная сеть Azure и специальная подсеть

Шлюз приложения — это специальное развертывание в виртуальной сети. В вашей виртуальной сети для шлюза приложения требуется специальная подсеть. В подсети может быть несколько экземпляров развертывания шлюза данного приложения. Вы также можете развернуть другие шлюзы приложений в подсети. Но вы не можете развернуть любой другой ресурс в подсети шлюза приложения.

> [!NOTE]
> Вы не можете смешивать Standard_v2 и стандартный шлюз приложений Azure в одной подсети.

#### <a name="size-of-the-subnet"></a>Размер подсети

Приложение Gateway использует один частный IP-адрес в каждом экземпляре, а также другой частный IP-адрес, если настроен частный фронт-энд IP.

Azure также резервирует пять IP-адресов в каждой подсети для внутреннего использования: первые четыре и последние IP-адреса. Например, рассмотрим 15 экземпляров шлюза приложений без частного фронт-энда IP. Для этой подсети требуется не менее 20 IP-адресов: пять для внутреннего использования и 15 для экземпляров шлюза приложения. Таким образом, вам нужно /27 размер подсети или больше.

Рассмотрим подсеть с 27 экземплярами шлюза приложений и IP-адресом для частного фронт-энда IP. В этом случае вам нужно 33 IP-адреса: 27 для экземпляров шлюза приложения, один для частного переднего конца и пять для внутреннего использования. Таким образом, вам нужно /26 размер подсети или больше.

Мы рекомендуем использовать подсеть размером не менее /28. Этот размер дает вам 11 годных к удорожанию IP-адресов. Если загрузка приложения требует более 10 экземпляров прикладного шлюза, обратите сью (27) или /26.

#### <a name="network-security-groups-on-the-application-gateway-subnet"></a>Группы сетевой безопасности в подсети Application Gateway

Группы сетевой безопасности (НСГ) поддерживаются на шлюзе приложений. Но есть некоторые ограничения:

- Вы должны разрешить входящий интернет-трафик на портах TCP 65503-65534 для приложения Шлюз v1 SKU, и TCP порты 65200-65535 для v2 SKU с направлением подсети, как **любой** и источник, как **GatewayManager** сервисный тег. Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Эти порты защищены (заблокированы) сертификатами Azure. Внешние сущности, включая клиентов этих шлюзов, не могут общаться на этих конечных точках.

- Исходящее подключение к Интернету не может быть заблокировано. Правила исходящего по умолчанию в NSG позволяют подключение к Интернету. Примите во внимание следующие рекомендации.

  - Не удаляйте правила исходящего по умолчанию.
  - Не создавайте другие правила исходящего, которые отрицают исходящие подключения.

- Трафик с тега **AzureLoadBalancer** должен быть разрешен.

#### <a name="allow-application-gateway-access-to-a-few-source-ips"></a>Разрешить доступ к порталу приложений к нескольким исходным иным иным

Для этого сценария используйте НСГ в подсети Application Gateway. Поместите следующие ограничения на подсеть в этом порядке приоритета:

1. Разрешить входящий трафик из исходного IP или ДИАПАЗОНА IP с назначением, как весь диапазон адресов адреса Application Gateway и порт назначения, как ваш входящий порт доступа, например, порт 80 для доступа HTTP.
2. Разрешить входящие запросы от источника, как **GatewayManager** сервисный тег и назначения, как **любой** и назначения портов как 65503-65534 для приложения шлюз v1 SKU, и порты 65200-65535 для v2 SKU для [бэк-энда состояние здоровья связи.](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics) Такой диапазон портов требуется для обмена данными в рамках инфраструктуры Azure. Эти порты защищены (заблокированы) сертификатами Azure. Без соответствующих сертификатов внешние объекты не могут инициировать изменения на этих конечных точках.
3. Разрешить входящие зонды Azure Load Balancer (тег*AzureLoadBalancer)* и входящий виртуальный сетевой трафик *(тег VirtualNetwork)* в [группе сетевой безопасности.](https://docs.microsoft.com/azure/virtual-network/security-overview)
4. Блокируйте весь другой входящий трафик, используя правило "все отрицания".
5. Разрешить исходящий трафик в Интернет для всех назначений.

#### <a name="user-defined-routes-supported-on-the-application-gateway-subnet"></a>Определяемые пользователем маршруты, поддерживаемые в подсети Шлюза приложений.

> [!IMPORTANT]
> Использование UDRs в подсети Application Gateway может привести к тому, что состояние работоспособности в [представлении работоспособности](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics#back-end-health) обратного конца будет отображаться как **неизвестное.** Это также может привести к сбою генерации журналов и метрик application Gateway. Мы рекомендуем не использовать UD-системы в подсети Application Gateway, чтобы можно было просматривать работоспособность, журналы и метрики бэк-энда.

- **Версия 1**

   Для v1 SKU маршруты, определяемые пользователями (UDRs), поддерживаются в подсети Application Gateway, если они не изменят сквозной запрос/ответ на общение. Например, можно настроить UDR в подсети Application Gateway, чтобы указать на прибор брандмауэра для проверки пакетов. Но вы должны убедиться, что пакет может достичь своего предназначения после осмотра. Невыполнение этого требования может привести к неправильному поведению зонда работоспособности или трафик-трафик. Это включает в себя изученные маршруты или маршруты по умолчанию 0.0.0.0/0, которые распространяются Azure ExpressRoute или VPN шлюзами в виртуальной сети.

- **v2**

   Для v2 SKU существуют поддерживаемые и неподдерживаемые сценарии:

   **v2 поддерживаемые сценарии**
   > [!WARNING]
   > Неверная конфигурация таблицы маршрутов может привести к асимметричной маршрутике в Application Gateway v2. Убедитесь, что весь трафик самолета управления/управления отправляется непосредственно в Интернет, а не через виртуальный прибор. Также могут быть затронуты журналирование и метрики.


  **Сценарий 1**: UDR для отторжения протокола пограничного шлюза (BGP) Распространение маршрута в подсеть Прикладных шлюзов

   Иногда маршрут шлюза по умолчанию (0.0.0.0/0) рекламируется через шлюзы ExpressRoute или VPN, связанные с виртуальной сетью Application Gateway. Это нарушает управление самолетом движения, что требует прямого пути к Интернету. В таких сценариях UDR может быть использован для отсрочения распространения маршрута BGP. 

   Чтобы отключить распространение маршрута BGP, используйте следующие действия:

   1. Создайте ресурс таблицы маршрутов в Azure.
   2. Отогнаните параметр **распространения маршрута маршрута виртуальной сети.** 
   3. Связать таблицу маршрутов с соответствующей подсетью. 

   Включение UDR для этого сценария не должно нарушать существующие настройки.

  **Сценарий 2**: UDR направить 0.0.0.0/0 к интернету

   Вы можете создать UDR для отправки трафика 0.0.0.0/0 непосредственно в Интернет. 

  **Сценарий 3**: UDR для Azure Kubernetes Службы kubenet

  Если вы используете kubenet с Azure Kubernetes Service (AKS) и контроллером входа в приложения (AGIC), вам необходимо настроить таблицу маршрутов, чтобы трафик, отправляемый в стручки, направлялся в правильный узел. Это не будет необходимо, если вы используете Azure CNI. 

   Чтобы настроить таблицу маршрутов, чтобы позволить kubenet работать, используйте следующие шаги:

  1. Создайте ресурс таблицы маршрутов в Azure. 
  2. Как только он будет создан, перейдите на страницу **Маршрутов.** 
  3. Добавить новый маршрут:
     - Адресная префикс должна быть IP-диапазоном стручков, которые вы хотите достичь в AKS. 
     - Следующим типом хмеля должен быть **Virtual Appliance.** 
     - Следующим адресом хмеля должен быть IP-адрес узла, вмещавававательства стручков в диапазоне IP, определяемого в поле адресной префикса. 
    
  **v2 неподдерживаемые сценарии**

  **Сценарий 1**: UDR для виртуальных приборов

  Любой сценарий, при котором 0.0.0.0/0 необходимо перенаправить через любой виртуальный прибор, виртуальную сеть концентратора/спица или на постойную (вынужденное туннелирование), не поддерживается для публичного предварительного просмотра v2. 

## <a name="front-end-ip"></a>Передний IP

Вы можете настроить шлюз приложения с публичным IP-адресом, личным IP-адресом или и тем, и другим. Общественный IP требуется, когда вы размещаете заднюю часть, что клиенты должны получить доступ через Интернет через Интернет лицом виртуального IP (VIP). 

Общественный IP не требуется для внутренней конечной точки, которая не подвергается воздействию Интернета. Это известно как *внутренняя конечная точка нагрузки-балансера* (ILB) или частный IP-адрес. Приложение шлюз ILB полезно для внутренних бизнес-приложений, которые не подвергаются воздействию Интернета. Это также полезно для служб и уровней в многоуровневом приложении в пределах границы безопасности, которые не подвергаются воздействию Интернета, но требуют кругового распределения нагрузки, липкости сеанса или прекращения TLS.

Поддерживается только один публичный IP-адрес или один частный IP-адрес. При создании шлюза приложения вы выбираете IP-адрес.

- Для публичного IP можно создать новый общедоступный IP-адрес или использовать существующий публичный IP-адрес в том же месте, что и шлюз приложения. Для получения дополнительной информации смотрите [статический и динамический публичный IP-адрес](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#static-versus-dynamic-public-ip-address).

- Для частного IP можно указать частный IP-адрес из подсети, где создается шлюз приложения. Если вы не указали один, произвольный IP-адрес автоматически выбирается из подсети. Выбранный тип IP-адреса (статический или динамический) не может быть изменен позже. Для получения дополнительной информации [см. Создать шлюз приложения с внутренним балансером нагрузки.](https://docs.microsoft.com/azure/application-gateway/application-gateway-ilb-arm)

Передний IP-адрес связан с *слушателем,* который проверяет входящие запросы на переднем IP.

## <a name="listeners"></a>Прослушиватели

Слушатель — это логическая сущность, которая проверяет входящие запросы на подключение с помощью порта, протокола, узла и IP-адреса. При настройке слушателя необходимо ввести значения для них, соответствующие значениям в входящего запросе на шлюзе.

При создании шлюза приложения с помощью портала Azure вы также создаете слушателя по умолчанию, выбирая протокол и порт для слушателя. Вы можете выбрать, включать ли поддержку HTTP2 на слушателя. После создания шлюза приложения можно отсеить настройки этого слушателя по умолчанию *(appGatewayHttpListener)* или создать новых слушателей.

### <a name="listener-type"></a>Тип слушателя

При создании нового слушателя вы выбираете между [ *базовым* и *мульти-сайтом.*](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#types-of-listeners)

- Если вы хотите, чтобы все ваши запросы (для любого домена) были приняты и перенаправлены в пулы бэкэндов, выберите базовый. [Узнайте, как создать шлюз приложения с помощью основного слушателя.](https://docs.microsoft.com/azure/application-gateway/quick-create-portal)

- Если вы хотите пересылать запросы в различные пулы бэкэндов на основе заголовка или имени *хоста,* выберите слушателя с несколькими сайтами, где необходимо также указать имя хоста, которое совпадает с входящим запросом. Это связано с тем, что Application Gateway опирается на заголовки хост HTTP 1.1 для размещения более одного веб-сайта на одном и том же общественном IP-адресе и порте.

#### <a name="order-of-processing-listeners"></a>Порядок обработки слушателей

Для v1 SKU запросы сопоставляются в соответствии с порядком правил и типом слушателя. Если правило с базовым слушателем стоит на первом месте в заказе, оно обрабатывается первым и принимает любой запрос на эту комбинацию порта и IP. Чтобы избежать этого, сначала настройте правила с многоузловыми слушателями и нажмите правило с основным слушателем до последнего в списке.

Для v2 SKU, многоузловые слушатели обрабатываются перед основными слушателями.

### <a name="front-end-ip"></a>Передний IP

Выберите адрес IP-адреса, который вы планируете связать с этим слушателем. Слушатель будет слушать входящие запросы на этом IP.

### <a name="front-end-port"></a>Передний порт

Выберите передний порт. Выберите существующий порт или создайте новый. Выберите любое значение из [допустимого диапазона портов.](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#ports) Вы можете использовать не только известные порты, такие как 80 и 443, но любой подходящий пользовательский порт. Порт может использоваться для публичных слушателей или частных слушателей.

### <a name="protocol"></a>Протокол

Выберите HTTP или HTTPS:

- Если вы выберете HTTP, трафик между клиентом и шлюзом приложения не зашифрован.

- Выберите HTTPS, если вы хотите [прекращения TLS](https://docs.microsoft.com/azure/application-gateway/overview#secure-sockets-layer-ssltls-termination) или [сквозного шифрования TLS.](https://docs.microsoft.com/azure/application-gateway/ssl-overview) Трафик между клиентом и шлюзом приложения зашифрован. И подключение TLS завершается на шлюзе приложения. Если вам требуется сквозное шифрование TLS, необходимо выбрать HTTPS и настроить настройку **http.00.** Это гарантирует, что трафик будет повторно зашифрован при его передвижении от шлюза приложения к задней части.

- Выберите HTTPS, если вы хотите [прекращения TLS](features.md#secure-sockets-layer-ssltls-termination) или [сквозного шифрования TLS.](https://docs.microsoft.com/azure/application-gateway/ssl-overview) Трафик между клиентом и шлюзом приложения зашифрован. И подключение TLS завершается на шлюзе приложения. Если вам требуется сквозное шифрование TLS, необходимо выбрать HTTPS и настроить настройку **http.00.** Это гарантирует, что трафик будет повторно зашифрован при его передвижении от шлюза приложения к задней части.


Чтобы настроить прекращение TLS и сквозное шифрование TLS, необходимо добавить сертификат слушателю, чтобы шлюз приложения получил симметричный ключ. Это продиктовано спецификацией протокола TLS. Симметричный ключ используется для шифрования и расшифровки трафика, отправленного на шлюз. Сертификат шлюза должен быть в формате Обмена личной информацией (PFX). Этот формат позволяет экспортировать личный ключ, который шлюз использует для шифрования и расшифровки трафика.

#### <a name="supported-certificates"></a>Поддерживаемые сертификаты

Смотрите [сертификаты, поддерживаемые для прекращения TLS.](https://docs.microsoft.com/azure/application-gateway/ssl-overview#certificates-supported-for-ssl-termination)

### <a name="additional-protocol-support"></a>Дополнительная поддержка протокола

#### <a name="http2-support"></a>Поддержка HTTP2

Поддержка протокола HTTP/2 доступна только для клиентов, которые подключаются к слушателям шлюза приложения. Связь с пулами серверов сервера составляет более HTTP/1.1. Поддержка HTTP/2 отключена по умолчанию. Следующий фрагмент кода Azure PowerShell показывает, как включить это:

```azurepowershell
$gw = Get-AzApplicationGateway -Name test -ResourceGroupName hm

$gw.EnableHttp2 = $true

Set-AzApplicationGateway -ApplicationGateway $gw
```

#### <a name="websocket-support"></a>Поддержка WebSocket

Поддержка WebSocket включена по умолчанию. Нет настраиваемой настройки пользователя, чтобы включить или отключить его. Вы можете использовать WebSockets как с http, так и с HTTPS слушателями.

### <a name="custom-error-pages"></a>Пользовательские страницы ошибок

Вы можете определить пользовательские ошибки на глобальном уровне или на уровне слушателя. Но создание пользовательских страниц ошибок глобального уровня с портала Azure в настоящее время не поддерживается. Можно настроить пользовательскую страницу ошибки для ошибки брандмауэра 403 веб-приложений или страницу обслуживания 502 на уровне слушателя. Вы также должны указать общедоступный URL-адрес blob для данного кода состояния ошибки. Дополнительные сведения см. в статье [Create Application Gateway custom error pages](https://docs.microsoft.com/azure/application-gateway/custom-error) (Создание пользовательских страниц ошибок с помощью Шлюза приложений).

![Коды ошибок службы "Шлюз приложений"](https://docs.microsoft.com/azure/application-gateway/media/custom-error/ag-error-codes.png)

Чтобы настроить глобальную пользовательскую [Azure PowerShell configuration](https://docs.microsoft.com/azure/application-gateway/custom-error#azure-powershell-configuration)страницу ошибки, см.

### <a name="tls-policy"></a>Политика TLS

Можно централизовать управление сертификатами TLS/SSL и уменьшить накладные расходы на шифрование для серверной фермы. Централизованная обработка TLS также позволяет указать центральную политику TLS, соответствующую вашим требованиям безопасности. Вы можете выбрать *по умолчанию,* *предопределенный,* или *пользовательские* политики TLS.

Вы настраиваете политику TLS для управления версиями протоколов TLS. Вы можете настроить шлюз приложения, чтобы использовать минимальную версию протокола для рукопожатий TLS от TLS1.0, TLS1.1 и TLS1.2. По умолчанию SSL 2.0 и 3.0 отключены и не настраиваются. Для получения дополнительной информации смотрите [обзор политики Application Gateway TLS](https://docs.microsoft.com/azure/application-gateway/application-gateway-ssl-policy-overview).

После создания слушателя вы связываете его с правилом разгрома запросов. Это правило определяет, как запросы, полученные на слушателя, направляются на задний конец.

## <a name="request-routing-rules"></a>Правила запроса на разгром

При создании шлюза приложения с помощью портала Azure создается правило по умолчанию *(правило1*). Это правило связывает слушателя по умолчанию *(appGatewayHttpListener*) с пулом бэк-энда по умолчанию *(appGatewayBackendPool*) и настройками http по умолчанию *(appGatewayBackendHttpSettings).* После создания шлюза можно отсеить настройки правила по умолчанию или создать новые правила.

### <a name="rule-type"></a>Тип правила

При создании правила вы выбираете между [ *базовым* и *основанным на пути*](https://docs.microsoft.com/azure/application-gateway/application-gateway-components#request-routing-rules).

- Выберите базовый, если вы хотите направить все запросы на связанного слушателя (например, *блог<i></i>.contoso.com/)\** в единый пул бэк-энда.
- Выберите маршрутную, если вы хотите направить запросы из определенных путей URL в определенные пулы бэк-энда. Шаблон пути применяется только к траектории URL, а не к параметрам запроса.

#### <a name="order-of-processing-rules"></a>Порядок обработки правил

Для v1 SKU сопоставление шаблонов входящих запросов обрабатывается в порядке, в котором пути перечислены на карте траектории URL правила на основе путей. Если запрос совпадает с шаблоном в двух или более путях на карте пути, то путь, указанный первым, совпадает. И запрос направляется на задний конец, связанный с этим путем.

Для v2 SKU точный совпадение является более высоким приоритетом, чем порядок пути на карте траектории URL. Если запрос соответствует шаблону в двух или более путях, запрос перенаправляется на заднюю часть, связанную с пути, который точно соответствует запросу. Если путь в входящего запроса точно не соответствует любому пути на карте, сопоставление шаблона запроса обрабатывается в списке заказов на карту пути для правила, основанного на пути.

### <a name="associated-listener"></a>Связанный слушатель

Связать слушателя с правилом таким образом, чтобы *правило маршрутизации запроса,* связанное с слушателем, оценивалось для определения пула бэк-энда для маршрутизации.

### <a name="associated-back-end-pool"></a>Связанный бэк-энд бассейн

Ассоциируется с правилом пулбэк-энда, содержащий конечные цели, которые обслуживают запросы, которые получает слушатель.

 - Для основного правила допускается только один пул бэк-энда. Все запросы на связанного слушателя направляются в пул бэк-энда.

 - Для правила, основанного на пути, добавьте несколько пулов бэк-энда, которые соответствуют каждому пути URL. Запросы, соответствующие вводому пути URL, препровождаются в соответствующий пул бэк-энда. Кроме того, добавьте пул бэк-энда по умолчанию. Запросы, не совпадающие с любым url-адресом в правиле, направляются в этот пул.

### <a name="associated-back-end-http-setting"></a>Связанные настройки бэк-энда HTTP

Добавьте настройку http для задней части для каждого правила. Запросы направляются от шлюза приложения к конечным целям с помощью номера порта, протокола и другой информации, указанной в этом параметре.

Для базового правила допускается только одна настройка HTTP. Все запросы на связанного слушателя направляются соответствующим конечным целям с помощью этой настройки HTTP.

Для правила, основанного на пути, добавьте несколько параметров http бэк-энда, которые соответствуют каждому пути URL. Запросы, соответствующие пути URL в этом параметре, направляются соответствующим конечным целям с помощью параметров HTTP, соответствующих каждому пути URL. Кроме того, добавьте настройку HTTP по умолчанию. Запросы, не совпадающие с любым url-адресом в этом правиле, направляются в пул бэк-энда по умолчанию с помощью настройки HTTP по умолчанию.

### <a name="redirection-setting"></a>Настройка перенаправления

Если перенаправление настроено для базового правила, все запросы связанного слушателя перенаправляются в цель. Это *глобальное* перенаправление. Если перенаправление настроено для правила, основанного на путях, перенаправляются только запросы в определенной области сайта. Примером может быть зона корзины, обозначенная */cart/\**. Это перенаправление *на основе путей.*

Для получения дополнительной информации о перенаправлениях смотрите [обзор перенаправления Application Gateway.](redirect-overview.md)

#### <a name="redirection-type"></a>Тип перенаправления

Выберите тип требуемого перенаправления: *Постоянный (301)*, *Временный (307)*, *Найдено (302)*, или *см. другие (303)*.

#### <a name="redirection-target"></a>Целевой показатель перенаправления

Выберите другого слушателя или внешний сайт в качестве цели перенаправления.

##### <a name="listener"></a>Прослушиватель

Выберите слушателя в качестве цели перенаправления, чтобы перенаправить трафик от одного слушателя к другому на шлюзе. Эта настройка необходима, когда требуется включить перенаправление HTTP-HTTPS. Он перенаправляет трафик от слушателя источника, который проверяет входящие запросы HTTP к слушателю назначения, который проверяет входящие запросы HTTPS. Вы также можете включить строку запроса и путь из исходного запроса в запрос, который переадресован целевому перенаправлению.

![Компоненты компонентов приложения диалоговая коробка](./media/configuration-overview/configure-redirection.png)

Для получения дополнительной информации о перенаправлении HTTP-HTTPS см.:
- [Перенаправление HTTP-TO-HTTPS с помощью портала Azure](redirect-http-to-https-portal.md)
- [ПЕРЕнаправление HTTP-TO-HTTPS с помощью PowerShell](redirect-http-to-https-powershell.md)
- [Перенаправление HTTP-TO-HTTPS с помощью Azure CLI](redirect-http-to-https-cli.md)

##### <a name="external-site"></a>Внешний сайт

Выберите внешний сайт, когда вы хотите перенаправить трафик на слушателя, который связан с этим правилом, на внешний сайт. Строку запроса можно включить в запрос, переадресованный целевому перенаправлению, можно включить строку запроса из исходного запроса. Вы не можете перенаправить путь на внешний сайт, который был в первоначальном запросе.

Для получения дополнительной информации о перенаправлении см.:
- [Перенаправить трафик на внешний сайт с помощью PowerShell](redirect-external-site-powershell.md)
- [Перенаправить трафик на внешний сайт с помощью CLI](redirect-external-site-cli.md)

#### <a name="rewrite-the-http-header-setting"></a>Переписать настройку заголовка HTTP

Эта настройка добавляет, удаляет или обновляет заголовки запросов и ответов HTTP, в то время как пакеты запросов и ответов перемещаются между пулами клиента и бэк-энда. Дополнительные сведения см. в разделе:

 - [Переписать обзор заголовков HTTP](rewrite-http-headers.md)
 - [Настройка перезаписи заголовка HTTP](rewrite-http-headers-portal.md)

## <a name="http-settings"></a>Параметры HTTP

Приложение шлюз маршрутов трафика на серверы бэк-энда с помощью конфигурации, которую вы укажете здесь. После создания параметра HTTP необходимо связать его с одним или одним из правил по разгрому запросов.

### <a name="cookie-based-affinity"></a>Сходство на основе файлов cookie,

Azure Application Gateway использует файлы cookie, управляемые шлюзом, для поддержания пользовательских сеансов. Когда пользователь отправляет первый запрос в Application Gateway, он устанавливает cookie-файлы сродства в ответе со значением хэша, содержащим сведения о сеансе, так что последующие запросы, несущие cookie-файлы сродства, будут направляться на тот же сервер бэкэнда для поддержание липкости. 

Эта функция полезна, когда требуется сохранить сеанс пользователя на том же сервере и когда состояние сеанса сохраняется локально на сервере для сеанса пользователя. Если приложение не может справиться с сродством на основе файлов cookie, эту функцию использовать не удается. Чтобы использовать его, убедитесь, что клиенты поддерживают файлы cookie.

[Chromium браузер](https://www.chromium.org/Home) [v80 обновление](https://chromiumdash.appspot.com/schedule) принес мандат, где HTTP печенье без [SameSite](https://tools.ietf.org/id/draft-ietf-httpbis-rfc6265bis-03.html#rfc.section.5.3.7) атрибут должен рассматриваться как SameSite-Lax. В случае запросов CORS (Cross-Origin Resource Sharing), если файл cookie должен быть отправлен в стороннем контексте, он должен использовать *SameSite-None; Безопасные* атрибуты и они должны быть отправлены только по HTTPS. В противном случае, в сценарии ТОЛЬКО http, браузер не отправляет файлы cookie в сторонним контекстом. Целью этого обновления от Chrome является повышение безопасности и предотвращение кросс-сайт Запрос подделки (CSRF) атак. 

Для поддержки этого изменения, начиная с 17 февраля 2020 года, Application Gateway (все типы SKU) будет вводить еще один файл cookie под названием *ApplicationGatewayAffinityCORS* в дополнение к существующему cookie *ApplicationGatewayAffinity.* *Cookie ApplicationGatewayAffinityCORS* имеет еще два атрибута, добавленных к нему *("SameSite-None; Безопасный"*), так что липкие сессии поддерживаются даже для кросс-происхождения запросов.

Обратите внимание, что имя cookie-файлов по умолчанию является *ApplicationGatewayAffinity,* и вы можете его изменить. В случае, если вы используете пользовательское имя cookie-файлов, дополнительное печенье добавляется с CORS в качестве суффикса. Например, *CustomCookieNameCORS*.

> [!NOTE]
> Если атрибут *SameSite-None* установлен, то файл cookie также содержит флаг *Secure* и должен быть отправлен по HTTPS.  Если по CORS требуется сродство сеанса, необходимо перенести рабочую нагрузку на HTTPS. Пожалуйста, обратитесь к TLS разгрузки и end-to-End TLS документации для приложения шлюз здесь - [Обзор](ssl-overview.md), [Настройка приложения шлюз с TLS прекращения с помощью портала Azure](create-ssl-portal.md), [Настроить сквозной TLS с помощью приложения шлюз с порталом](end-to-end-ssl-portal.md).

### <a name="connection-draining"></a>фильтрация подключений;

Соединение слив помогает изящно удалить бэк-энд членов пула во время запланированных обновлений службы. Вы можете применить эту настройку ко всем членам пула бэк-энда во время создания правил. Это гарантирует, что все случаи снятия с регистрации пула бэк-энда продолжают поддерживать существующие соединения и обслуживать постоянно едкие запросы на настраиваемый тайм-аут и не получают новых запросов или соединений. Единственным исключением из этого являются запросы, связанные с исключением экземпляров из-за сродства сеансов, управляемых шлюзом, и они будут по-прежнему препровождены в случаи, связанные с дерегистрингом. Слив соединения применяется к бэк-энда экземпляров, которые явно удалены из бэк-эндпула.

### <a name="protocol"></a>Протокол

Приложение Gateway поддерживает как HTTP, так и HTTPS для запросов на переподготовку на серверы бэк-энда. Если вы выберете HTTP, трафик на серверы бэк-энда не зашифрован. Если незашифрованная связь неприемлема, выберите HTTPS.

Эта настройка в сочетании с HTTPS в слушателе поддерживает [сквозной TLS.](ssl-overview.md) Это позволяет безопасно передавать конфиденциальные данные, зашифрованные на задней части. Каждый сервер бэк-энда в пуле бэк-энда с включенным сквозным TLS должен быть настроен с сертификатом, позволяющим обеспечить безопасную связь.

### <a name="port"></a>Порт

Эта настройка определяет порт, где серверы бэк-энда слушают трафик из шлюза приложения. Вы можете настроить порты от 1 до 65535.

### <a name="request-timeout"></a>Время ожидания запроса

Эта настройка — это количество секунд, которые шлюз приложения ждет, чтобы получить ответ от сервера бэк-энда.

### <a name="override-back-end-path"></a>Переопределение обратного пути

Эта настройка позволяет настроить дополнительный пользовательский путь пересылки для использования, когда запрос перенаправляется на задний конец. Любая часть входящего пути, которая соответствует пользовательскому пути в поле **переопределения бэкэнда,** скопирована на переадресованный путь. В следующей таблице показано, как работает эта функция:

- При присоединении параметра HTTP к основному правилу отслеживания запросов:

  | Исходный запрос  | Переопределение обратного пути | Запрос, переадресованный на задний конец |
  | ----------------- | --------------------- | ---------------------------- |
  | /дом/            | /переопределение/            | /переопределение/дом/              |
  | /дом/второй дом/ | /переопределение/            | /переопределение/дом/второй дом/   |

- При подключении параметра HTTP к правилу маршрутизания на основе маршрутов:

  | Исходный запрос           | Правило Пути       | Переопределение обратного пути | Запрос, переадресованный на задний конец |
  | -------------------------- | --------------- | --------------------- | ---------------------------- |
  | /pathrule/home/            | /патруле      | /переопределение/            | /переопределение/дом/              |
  | /pathrule/home/secondhome/ | /патруле      | /переопределение/            | /переопределение/дом/второй дом/   |
  | /дом/                     | /патруле      | /переопределение/            | /переопределение/дом/              |
  | /дом/второй дом/          | /патруле      | /переопределение/            | /переопределение/дом/второй дом/   |
  | /pathrule/home/            | /патруру/дом» | /переопределение/            | /переопределение/                   |
  | /pathrule/home/secondhome/ | /патруру/дом» | /переопределение/            | /переопределение/второй дом/        |
  | /pathrule/                 | /pathrule/      | /переопределение/            | /переопределение/                   |

### <a name="use-for-app-service"></a>Использование для обслуживания приложений

Это только ярлык для uI, который выбирает два необходимых параметра для задней части службы приложений Azure. Это позволяет **выбрать имя хоста из задней части адреса,** и он создает новый пользовательский зонд, если у вас нет одного уже. (Для получения дополнительной информации см. [название хоста Pick из](#pick) раздела настройки адреса в этой статье.) Создается новый зонд, и заголовок зонда подбирается с адреса бэк-энда участника.

### <a name="use-custom-probe"></a>Используйте пользовательский зонд

Эта настройка ассоциируетпользовательский [зонд](application-gateway-probe-overview.md#custom-health-probe) с параметром HTTP. Вы можете связать только один пользовательский зонд с настройкой HTTP. Если вы явно не ассоциируете пользовательский зонд, [зонд по умолчанию](application-gateway-probe-overview.md#default-health-probe-settings) используется для мониторинга работоспособности задней части. Мы рекомендуем вам создать пользовательский зонд для усиления контроля за здоровьем ваших задних концов.

> [!NOTE]
> Пользовательский зонд не отслеживает работоспособность пула бэк-энда, если соответствующие настройки HTTP явно не связаны со слушателем.

### <a name="pick-host-name-from-back-end-address"></a><a id="pick"/></a>Выберите имя хоста из задней части адреса

Эта возможность динамически устанавливает заголовок *хоста* в запросе на имя хоста пула бэк-энда. Он использует IP-адрес или F-DN.

Эта функция помогает, когда доменное имя задней части отличается от dNS имя шлюза приложения, и задний конец опирается на конкретный заголовок хоста для решения правильной конечной точки.

Примером является мультитенантные услуги в качестве задней части. Служба приложений — это мультитенантная служба, используюва общее пространство с одним IP-адресом. Таким образом, доступ к службе приложений можно получить только через имена хоста, настроенные в пользовательских настройках домена.

По умолчанию пользовательское доменное имя *example.azurewebsites.net*. Чтобы получить доступ к службе приложения, используя шлюз приложения через хост-имя, которое явно не зарегистрировано в службе приложения или через F-DN шлюза приложения, вы переопределить имя хоста в первоначальном запросе на имя хосля службы приложения. Для этого включите имя узла выбора из настройки **адреса бэкэнда.**

Для пользовательского домена, существующее пользовательское имя DNS отображается в службе приложения, вам не нужно включать эту настройку.

> [!NOTE]
> Эта настройка не требуется для среды службы приложений, которая является выделенным развертыванием.

### <a name="host-name-override"></a>Переопределение имени хозяина

Эта возможность заменяет заголовок *узла* во входящего запросе на шлюзе приложения на указанное имя хоста.

Например, если *www.contoso.com* указанва в настройке`https://appgw.eastus.cloudapp.azure.com/path1` имени **хоста,** исходный запрос изменяется на`https://www.contoso.com/path1` q, когда запрос перенаправляется на сервер бэк-энда.

## <a name="back-end-pool"></a>Внутренний пул

Вы можете указать пул бэкэнда на четыре типа бэкэнд-членов: конкретную виртуальную машину, набор виртуальной шкалы машин, IP-адрес/F-DN или службу приложений. 

После создания пула бэк-энда необходимо связать его с одним или одним из правил по вымыслу запросов. Необходимо также настроить зонды работоспособности для каждого пула бэк-энда на шлюзе приложения. При удовлетворении состояния правила отслеживания запроса шлюз приложения перенаправляет трафик на здоровые серверы (определяемые зондами работоспособности) в соответствующем пуле бэк-энда.

## <a name="health-probes"></a>Пробы работоспособности

Шлюз приложения отслеживает работоспособность всех ресурсов в задней части по умолчанию. Но мы настоятельно рекомендуем вам создать пользовательский зонд для каждого бэк-энда http настройки, чтобы получить больший контроль над мониторингом здоровья. Чтобы узнать, как настроить пользовательский зонд, смотрите [настройки пользовательского зонда здоровья.](application-gateway-probe-overview.md#custom-health-probe-settings)

> [!NOTE]
> После создания пользовательского зонда работоспособности необходимо связать его с настройками http.01. Пользовательский зонд не будет следить за работоспособностью пула бэк-энда, если соответствующая настройка HTTP явно не связана с слушателем с помощью правила.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы знаете о компонентах шлюза приложений, вы можете:

- [Создание шлюза приложения на портале Azure](quick-create-portal.md)
- [Создайте шлюз приложения с помощью PowerShell](quick-create-powershell.md)
- [Создание шлюза приложений с помощью интерфейса командной строки Azure](quick-create-cli.md)
