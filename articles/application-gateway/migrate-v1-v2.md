---
title: Перенос шлюза приложений Azure и брандмауэр веб-приложения с v1 на v2
description: В этой статье показано, как перенос шлюза приложений Azure и брандмауэр веб-приложения с v1 на v2
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 6/18/2019
ms.author: victorh
ms.openlocfilehash: 0fd605d7d502970dccd37da1f3f70fdadb1094a1
ms.sourcegitcommit: 978e1b8cac3da254f9d6309e0195c45b38c24eb5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/03/2019
ms.locfileid: "67550450"
---
# <a name="migrate-azure-application-gateway-and-web-application-firewall-from-v1-to-v2"></a>Перенос шлюза приложений Azure и брандмауэр веб-приложения с v1 на v2

[Шлюз приложений Azure и брандмауэра веб-приложения (WAF) версии 2](application-gateway-autoscaling-zone-redundant.md) теперь доступна, предлагают дополнительные возможности, такие как автоматическое масштабирование и зонами доступности избыточности. Тем не менее существующие шлюзы v1 не автоматически обновлены до версии 2. Если вы хотите перенести из версии 1 до версии 2, выполните действия, описанные в этой статье.

При миграции предусмотрено два этапа:

1. Миграция конфигурации
2. Перенос клиентского трафика

В этой статье рассматриваются миграции конфигурации. Трафика миграции клиентов зависит от конкретной среды. Тем не менее некоторые высокоуровневые Общие рекомендации по обеспечению [предоставляются](#migrate-client-traffic).

## <a name="migration-overview"></a>Общие сведения о процессе миграции

Сценарий Azure PowerShell доступен, делает следующее:

* Создает новый шлюз Standard_v2 или WAF_v2 в подсеть виртуальной сети, указанной вами.
* Полностью копирует конфигурации, связанной со шлюзом "стандартный" или WAF v1 в только что созданный Standard_V2 или WAF_V2 шлюз.

### <a name="caveatslimitations"></a>Caveats\Limitations

* Новый шлюз v2 имеет новые общедоступные и частные IP-адреса. Невозможно переместить IP-адреса, связанные с существующим шлюзом v1 без проблем до версии 2. Тем не менее можно распределить существующие (нераспределенного) общедоступных или частных IP-адресом в новый шлюз v2.
* Необходимо указать адресное пространство IP-адрес для другой подсети виртуальной сети, где расположен шлюз v1. Скрипт не удается создать шлюз v2 в существующей подсети, которые уже есть шлюз v1. Тем не менее если уже существующей подсети шлюза v2, вы по-прежнему работать при условии, что имеется достаточно пространства IP-адресов.
* Чтобы перенести конфигурацию SSL, необходимо указать все сертификаты SSL, используемый в шлюзе v1.
* Если режим FIPS включен для шлюза версии 1, его не перемещаются в новый шлюз v2. Режим FIPS не поддерживается в версии 2.
* версии 2 не поддерживает IPv6, поэтому шлюзы v1 включен протокол IPv6 не переносятся. Когда вы запускаете сценарий, он может завершиться.
* Если шлюз v1 частный IP-адрес, сценарий создает общедоступный IP-адрес и частный IP-адрес нового шлюза v2. в настоящее время шлюзы версии 2 не поддерживают только частные IP-адреса.

## <a name="download-the-script"></a>Скачайте сценарий

Скачайте сценарий миграции из [коллекции PowerShell](https://www.powershellgallery.com/packages/AzureAppGWMigration).

## <a name="use-the-script"></a>Используйте сценарий

Существует два варианта для вас в зависимости от вашей локальной установки среды PowerShell и параметры:

* Если вы не установлены модули Azure Az или не против Удаление модулей Azure Az, лучшим вариантом является использование `Install-Script` параметр, чтобы запустить скрипт.
* Если необходимо сохранить модули Azure Az, лучшим решением является скачать скрипт и запустите его напрямую.

Чтобы определить, если у вас есть Azure Az модулях, установленных, выполните `Get-InstalledModule -Name az`. Если вы не видите все установленные модули Az, то можете использовать `Install-Script` метод.

### <a name="install-using-the-install-script-method"></a>Установка с помощью Install-Script-метод

Чтобы использовать этот параметр, не должны Azure Az модулях, установленных на компьютере. Если они установлены, следующая команда отображает ошибку. Можно удалить модули Azure Az или использовать другой параметр, чтобы вручную скачать скрипт и запустите его.
  
Выполните следующую команду, чтобы запустить сценарий.

`Install-Script -Name AzureAppGWMigration`

Эта команда также устанавливает необходимые модули Az.  

### <a name="install-using-the-script-directly"></a>Установить напрямую с помощью скрипта

Если у некоторых Azure Az модули, установленные и их нельзя удалить (или не хотите удалить их), можно вручную загрузить этот скрипт с использованием **вручную** ссылка для скачивания скрипта на вкладке. Сценарий скачивается в формате raw nupkg. Для установки сценария из этого файла nupkg, см. в разделе [загрузка пакета вручную](https://docs.microsoft.com/powershell/gallery/how-to/working-with-packages/manual-download).

Выполните следующее, чтобы запустить этот сценарий.

1. Используйте `Connect-AzAccount` для подключения к Azure.

1. Используйте `Import-Module Az` для импорта модулей Az.

1. Запустите `Get-Help AzureAppGWMigration.ps1` для проверки обязательных параметров:

   ```
   AzureAppGwMigration.ps1
    -resourceId <v1 application gateway Resource ID>
    -subnetAddressRange <subnet space you want to use>
    -appgwName <string to use to append>
    -sslCertificates <comma-separated SSLCert objects as above>
    -trustedRootCertificates <comma-separated Trusted Root Cert objects as above>
    -privateIpAddress <private IP string>
    -publicIpResourceName <public IP name string>
    -validateMigration -enableAutoScale
   ```

   Параметры для данного сценария:
   * **resourceId: [String]: Требуется** — это идентификатор ресурса Azure для существующей стандартной версии 1 или шлюз v1 WAF. Чтобы найти это строковое значение, перейдите на портал Azure, выберите шлюз приложений или ресурсов WAF и нажмите **свойства** ссылку для шлюза. Идентификатор ресурса находится на этой странице.

     Можно также запустить следующие команды Azure PowerShell, чтобы получить идентификатор ресурса:

     ```azurepowershell
     $appgw = Get-AzApplicationGateway -Name <v1 gateway name> -ResourceGroupName <resource group Name> 
     $appgw.Id
     ```

   * **subnetAddressRange: [String]:  Требуется** — это диапазон IP-адресов, который вы выделили (или хотите выделить) для новой подсети, которая содержит новый шлюз v2. Это должен быть указан в нотации CIDR. Пример: 10.0.0.0/24. Не нужно заранее создавать эту подсеть. Скрипт создает его, если он не существует.
   * **appgwName: [String]: Необязательный**. Это строка, которую следует использовать в качестве имени нового Standard_v2 или WAF_v2 шлюза. Если этот параметр не задан, имя существующего шлюза v1 будет использоваться с суффиксом *_v2* добавляется.
   * **sslCertificates: [PSApplicationGatewaySslCertificate]: Необязательный**.  Разделенный запятыми список PSApplicationGatewaySslCertificate объекты, создаваемые для представления сертификатов SSL из шлюза v1 необходимо передать в новый шлюз v2. Для каждого из вашей сертификатов SSL, настроена для стандартной версии 1 или WAF шлюза версии 1, можно создать объект PSApplicationGatewaySslCertificate через `New-AzApplicationGatewaySslCertificate` команду, показанную ниже. Путь нужно файл SSL-сертификат и пароль.

       Этот параметр необязателен только в том случае, если у вас настроен для шлюза версии 1 или WAF HTTPS-прослушивателей. Если у вас есть по крайней мере одна процедура настройки прослушивателя HTTPS, необходимо указать этот параметр.

      ```azurepowershell  
      $password = ConvertTo-SecureString <cert-password> -AsPlainText -Force
      $mySslCert1 = New-AzApplicationGatewaySslCertificate -Name "Cert01" `
        -CertificateFile <Cert-File-Path-1> `
        -Password $password 
      $mySslCert2 = New-AzApplicationGatewaySslCertificate -Name "Cert02" `
        -CertificateFile <Cert-File-Path-2> `
        -Password $password
      ```

      Вы можете передать `$mySslCert1, $mySslCert2` (разделенных запятыми) в предыдущем примере в качестве значения для этого параметра в скрипте.
   * **trustedRootCertificates: [PSApplicationGatewayTrustedRootCertificate]: Необязательный**. Разделенный запятыми список PSApplicationGatewayTrustedRootCertificate объекты, создаваемые для представления [доверенных корневых сертификатов](ssl-overview.md) для проверки подлинности ваших экземпляров серверной части от шлюза v2.  

      Чтобы создать список объектов PSApplicationGatewayTrustedRootCertificate, см. в разделе [New AzApplicationGatewayTrustedRootCertificate](https://docs.microsoft.com/powershell/module/Az.Network/New-AzApplicationGatewayTrustedRootCertificate?view=azps-2.1.0&viewFallbackFrom=azps-2.0.0).
   * **privateIpAddress: [String]: Необязательный**. Определенные частный IP-адрес, необходимо связать на новый шлюз v2.  Это должен быть из той же виртуальной сети, выделить для нового шлюза v2. Если это не задано, скрипт выделяет частный IP-адрес для шлюза версии 2.
    * **publicIpResourceId: [String]: Необязательный**. ResourceId ресурс общедоступного IP-адреса (стандартные SKU) в подписке, необходимо выделить в новый шлюз v2. Если это не задано, скрипт выделяет новый общедоступный IP-адрес, в той же группе ресурсов. Имя является именем шлюза v2 с *- IP* добавляется.
   * **validateMigration: [переключения]: Необязательный**. Используйте этот параметр, если требуется, скрипт для выполнения проверки путем сравнения некоторые основные настройки после создания шлюза v2 и копии конфигурации. По умолчанию не проверяются.
   * **enableAutoScale: [переключения]: Необязательный**. Используйте этот параметр, если требуется, скрипт для включения автомасштабирования в новый шлюз версии 2, после его создания. По умолчанию отключено автоматическое масштабирование. Вы можете всегда вручную включить его позже шлюза только что созданный v2.

1. Запустите скрипт, используя соответствующие параметры. Может занять пяти до семи минут.

    **Пример**

   ```azurepowershell
   AzureAppGWMigration.ps1 `
      -resourceId /subscriptions/8b1d0fea-8d57-4975-adfb-308f1f4d12aa/resourceGroups/MyResourceGroup/providers/Microsoft.Network/applicationGateways/myv1appgateway `
      -subnetAddressRange 10.0.0.0/24 `
      -appgwname "MynewV2gw" `
      -sslCertificates $Certs `
      -trustedRootCertificates $trustedCert `
      -privateIpAddress "10.0.0.1" `
      -publicIpResourceId "MyPublicIP" `
      -validateMigration -enableAutoScale
   ```

## <a name="migrate-client-traffic"></a>Перенос клиентского трафика

Во-первых убедитесь, что скрипт успешно создал новый шлюз v2 с точной конфигурации будут перенесены из шлюза v1. Это можно проверить с помощью портала Azure.

Кроме того Отправка небольшой объем трафика через шлюз v2 в качестве ручного теста.
  
Ниже приведено несколько сценариев, где текущий шлюз приложений (стандартный) может получить трафик клиента и наши рекомендации для каждого из них.

* **Пользовательские зоны DNS (например, contoso.com), указывающий на внешний IP-адрес (с помощью записи A), связанные с v1 стандартный или WAF шлюза v1**.

    Можно обновить запись DNS, чтобы они указывали интерфейсный IP-адрес или DNS-метку, связанную с Standard_v2 шлюз приложений. В зависимости от срока ЖИЗНИ, настроенный на запись DNS может занять некоторое время перенести в новый шлюз v2 весь трафик клиентов.
* **Пользовательские зоны DNS (например, contoso.com), который указывает на DNS-метку (например: *myappgw.eastus.cloudapp.azure.com* с помощью записи CNAME) связанных со шлюзом v1**.

   У вас есть два варианта:

  * Если вы используете общедоступный IP-адресов на шлюзе приложений, можно сделать управляемой, детализированные миграции, с помощью профиля диспетчера трафика для постепенно передачи трафика (метода взвешенной маршрутизации трафика) в новый шлюз v2.

    Это можно сделать, добавив метки DNS v1 и v2 шлюзов приложений для [профиль диспетчера трафика](../traffic-manager/traffic-manager-routing-methods.md#weighted-traffic-routing-method)и CNAMEing домен диспетчера трафика (например, ваши пользовательские записи DNS (например, www.contoso.com) Contoso.trafficmanager.NET).
  * Также можно обновить запись DNS личного домена, чтобы он указывал на DNS-метку нового шлюза приложений версии 2. В зависимости от срока ЖИЗНИ, настроенный на запись DNS может занять некоторое время перенести в новый шлюз v2 весь трафик клиентов.
* **Клиенты подключаются к интерфейсной IP-адрес шлюза приложений**.

   Обновление клиентов для использования IP-адреса, связанные со шлюзом приложений только что созданный v2. Мы рекомендуем не использовать IP-адреса напрямую. Рассмотрите возможность использования метка DNS-имени (например, yourgateway.eastus.cloudapp.azure.com), связанные с вашим шлюзом приложений, вы можете CNAME для собственных пользовательских зоны DNS (например, contoso.com).

## <a name="common-questions"></a>Часто задаваемые вопросы

### <a name="are-there-any-limitations-with-the-azure-powershell-script-to-migrate-the-configuration-from-v1-to-v2"></a>Есть ли ограничения с помощью сценария Azure PowerShell для переноса конфигурации из версии 1 до версии 2?

Да. См. в разделе [предупреждения и ограничения](#caveatslimitations).

### <a name="is-this-article-and-the-azure-powershell-script-applicable-for-application-gateway-waf-product-as-well"></a>Применяется в этой статье и сценария Azure PowerShell для продукта, а также WAF шлюза приложений? 

Да.

### <a name="does-the-azure-powershell-script-also-switch-over-the-traffic-from-my-v1-gateway-to-the-newly-created-v2-gateway"></a>Сценария Azure PowerShell также переключиться трафик из шлюза v1 в только что созданный v2 шлюз?

№ Сценарий Azure PowerShell выполняет миграцию только конфигурацию. Отвечает за фактическое трафика миграции и в элементе управления.

### <a name="is-the-new-v2-gateway-created-by-the-azure-powershell-script-sized-appropriately-to-handle-all-of-the-traffic-that-is-currently-served-by-my-v1-gateway"></a>Новый шлюз v2, созданных с помощью скрипта Azure PowerShell размеры изменяются соответствующим образом для обработки всего трафика, который в настоящее время обслуживается v1 шлюза?

Сценарий Azure PowerShell создает новый шлюз v2 с соответствующего размера для обработки трафика на свой существующий шлюз v1. Автоматическое масштабирование отключено по умолчанию, но вы можете включить автоматическое масштабирование, при запуске сценария.

### <a name="i-configured-my-v1-gateway--to-send-logs-to-azure-storage-does-the-script-replicate-this-configuration-for-v2-as-well"></a>Я настроил v1 шлюза для отправки журналов в службу хранилища Azure. Скрипт реплицировать эту процедуру, а также версии 2?

№ Скрипт не реплицировать этой конфигурации для версии 2. Конфигурация журналов необходимо добавить отдельно шлюза перенесенной версии 2.

### <a name="i-ran-into-some-issues-with-using-this-script-how-can-i-get-help"></a>У меня возникла некоторые проблемы с помощью этого скрипта. Получение справки
  
Вы можете отправить электронное письмо для appgwmigrationsup@microsoft.com, откройте обращение в службу поддержки с помощью службы поддержки Azure или то, и другое.

## <a name="next-steps"></a>Дальнейшие действия

[Дополнительные сведения о приложении шлюза v2](application-gateway-autoscaling-zone-redundant.md)
