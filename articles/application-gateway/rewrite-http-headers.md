---
title: Перепишите заголовки HTTP с помощью шлюза приложения Azure (ru) Документы Майкрософт
description: В этой статье содержится обзор переписывания заголовков HTTP в шлюзе приложений Azure
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 08/08/2019
ms.author: absha
ms.openlocfilehash: d0b28770940f0e1adeec16aa89cd087299bd4abc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80132993"
---
# <a name="rewrite-http-headers-with-application-gateway"></a>Переписать заголовки HTTP с помощью шлюза приложений

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Заголовки HTTP позволяют клиенту и серверу передавать дополнительную информацию с запросом или ответом. Переписывая эти заголовки, можно выполнить важные задачи, такие как добавление полей заголовка, связанных с безопасностью, таких как HSTS/ X-XSS-Protection, удаление полей заголовка ответов, которые могут раскрыть конфиденциальную информацию, и удаление портовой информации из X-Forwarded-For заголовки.

Шлюз приложений поддерживает возможность добавления, удаления и обновления заголовков запросов и ответов HTTP, пока пакеты запросов и ответов перемещаются между клиентским и внутренним пулами. Он также позволяет добавить условия, чтобы указанные заголовки перезаписывались только в том случае, если соблюдены определенные условия.

Application Gateway также поддерживает несколько [переменных серверов,](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers#server-variables) которые помогают хранить дополнительную информацию о запросах и ответах. Это упрощает создание мощных правил переписывания.

> [!NOTE]
>
> Поддержка зазаголовка HTTP переписывается доступна только для [Standard_V2 и WAF_v2 SKU.](application-gateway-autoscaling-zone-redundant.md)

![Переписывание заголовков](media/rewrite-http-headers/rewrite-headers.png)

## <a name="supported-headers"></a>Поддерживаемые заголовки

Все заголовки можно переписать в запросах и ответах, за исключением заголовков host, Connection и Upgrade. Вы также можете использовать шлюз приложения для создания пользовательских заголовков и добавления их в запросы и ответы, направляемые через него.

## <a name="rewrite-conditions"></a>Переписать условия

Можно использовать условия переписывания для оценки содержания запросов и ответов HTTP(S) и выполнять заголовок, переписываемый только при выполнении одного или нескольких условий. Шлюз приложения использует эти типы переменных для оценки содержания запросов и ответов HTTP(S):

- Заголовки HTTP в запросе.
- Заголовки HTTP в ответе.
- Переменные сервера приложения Gateway.

Условие можно использовать для оценки наличия указанной переменной, соответствует ли указанная переменная определенному значению или же указанная переменная соответствует определенному шаблону. Для настройки регулярного шаблона выражения в условиях используется библиотека постоянных выражений [Perl Compatible Regular Expressions (PCRE).](https://www.pcre.org/) Чтобы узнать о регулярном синтаксисе выражения, смотрите [на главной странице постоянных выражений Perl.](https://perldoc.perl.org/perlre.html)

## <a name="rewrite-actions"></a>Переписать действия

Вы используете переписать действия, чтобы указать заголовки запросов и ответов, которые вы хотите переписать, и новое значение для заголовков. Можно либо создать новый заголовок, изменить значение существующего заголовка, либо удалить существующий заголовок. Значение нового заголовка или существующего заголовка может быть установлено для этих типов значений:

- Текст.
- Заголовок запроса. Чтобы указать заголовок запроса, необходимо использовать синтаксис «http_req_*заголовокName.*
- Заголовок ответа. Чтобы указать заголовок ответа, необходимо использовать синтаксис «http_resp_*заголовокName.*
- Переменная сервера. Чтобы указать переменную сервера, необходимо использовать синтаксис «var_*сервераПеременная».*
- Комбинация текста, заголовок запроса, заголовок ответа и переменная сервера.

## <a name="server-variables"></a>Переменные сервера

Приложение Gateway использует переменные сервера для хранения полезной информации о сервере, связи с клиентом и текущего запроса на подключение. Примеры сохраненной информации включают IP-адрес клиента и тип веб-браузера. Переменные сервера меняются динамически, например, при загрузке новой страницы или при размещении формы. Эти переменные можно использовать для оценки условий переписывания и переписывания заголовков.

Шлюз приложения поддерживает эти переменные сервера:

| Имя переменной | Описание                                                  |
| -------------------------- | :----------------------------------------------------------- |
| add_x_forwarded_for_proxy  | Поле заголовка запроса X-Forwarded-For `client_ip` клиента с переменной (см. объяснение позже в этой таблице) приложено к нему в формате IP1, IP2, IP3 и так далее. Если поле X-Forwarded-For не находится в заголовке `add_x_forwarded_for_proxy` запроса клиента, `$client_ip` переменная равна переменной. Эта переменная особенно полезна, если требуется переписать X-Forwarded-For заголовок, установленный Application Gateway, чтобы заголовок соповывал только IP-адрес без информации о порту. |
| ciphers_supported          | Список шифров, поддерживаемых клиентом.          |
| ciphers_used               | Строка шифров, используемых для установленного соединения TLS. |
| client_ip                  | IP-адрес клиента, с которого приложение получил запрос. Если перед шлюзом приложения и исходным клиентом есть обратный прокси, *client_ip* вернет IP-адрес обратного прокси-сервера. |
| client_port                | Порт клиента.                                                  |
| client_tcp_rtt             | Информация о клиенте TCP соединение. Доступно в системах, поддерживающих опцию TCP_INFO розетки. |
| client_user                | При использовании http-аутентификации имя пользователя подается для проверки подлинности. |
| host                       | В этом порядке приоритета: имя хоста из строки запроса, имя узла из поля заголовка host или имя сервера, соответствуя запросу. |
| cookie_*имя*              | *Название* печенья.                                            |
| http_method                | Метод, используемый для запроса URL-адреса. Например, GET или POST. |
| http_status                | Статус сеанса. Например, 200, 400 или 403.                       |
| http_version               | Протокол запроса. Обычно HTTP/1.0, HTTP/1.1 или HTTP/2.0. |
| query_string               | Список пар переменных/значений, следующих за "?" в запрашиваемом URL. |
| received_bytes             | Длина запроса (включая строку запроса, заголовок и тело запроса). |
| request_query              | Аргументы в строке запроса.                                |
| request_scheme             | Схема запроса: http или https.                            |
| request_uri                | Полный первоначальный запрос URI (с аргументами).                   |
| sent_bytes                 | Количество байтов, отправленных клиенту.                             |
| server_port                | Порт сервера, который принял запрос.                 |
| ssl_connection_protocol    | Протокол установленного соединения TLS.        |
| ssl_enabled                | "На", если соединение работает в режиме TLS. В противном случае, пустая строка. |

## <a name="rewrite-configuration"></a>Переписать конфигурацию

Чтобы настроить перезапись заголовка HTTP, необходимо выполнить эти шаги.

1. Создайте объекты, необходимые для перезаписи заголовка HTTP:

   - **Перепишите действие**: Используется для указания полей заголовка запроса и запроса, которые необходимо переписать, и нового значения для заголовков. Одно или несколько условий перезаписи можно связать с действием перезаписи.

   - **Перепишите условие**: Дополнительная конфигурация. Переписать условия оценки содержания запросов и ответов HTTP (S). Действие перезаписи будет происходить, если запрос или ответ HTTP(S соответствует состоянию перезаписи.

     Если вы связываете более одного состояния с действием, действие происходит только тогда, когда все условия выполнены. Другими словами, операция является логичной и операцией.

   - **Перепишите правило**: Содержит несколько действий переписать / переписать комбинации условий.

   - **Последовательность правил**: Помогает определить порядок выполнения правил переписывания. Эта конфигурация полезна, когда у вас есть несколько правил перезаписи в наборе перезаписи. Правило перезаписи с более низким значением последовательности правил выполняется первым. При свяжеской последовательности правил двум правилам переписывания порядок выполнения не является детерминированным.

   - **Перепишите набор:** Содержит несколько правил переписывания, которые будут связаны с правилом разгрома запроса.

2. Прикрепите набор перезаписей *(перепишитеRuleSet)* к правилу разгрома. Конфигурация перезаписи прикрепляется к исходному слушателю через правило разгрома. При использовании базового правила заголовка конфигурация перезаписи заголовка связана с слушателем исходного кода и является глобальным перезаписьм заголовка. При использовании правила маршрутирования на основе путей конфигурация перезаписи заголовка определяется на карте траектории URL. В этом случае это относится только к конкретной области пути сайта.
   > [!NOTE]
   > URL Перезапись изменить заголовки; он не изменяет URL для пути.

Вы можете создать несколько наборов заголовок HTTP и применить каждый набор перезаписи к нескольким слушателям. Но вы можете применить только один набор переписать к конкретному слушателю.

## <a name="common-scenarios"></a>Распространенные сценарии

Вот несколько распространенных сценариев для использования заголовок переписать.

### <a name="remove-port-information-from-the-x-forwarded-for-header"></a>Удалите информацию о порне из заголовка X-Forwarded-For

Приложение Шлюз вставляет X-Forwarded-For заголовок во все запросы, прежде чем он перенаправляет запросы в бэкэнд. Этот заголовок представляет собой запятый разделенный список IP-портов. Могут быть сценарии, в которых серверам бэк-энда нужны только заголовки для хранения IP-адресов. Переписать заголовок, чтобы удалить информацию о порнепорте из заголовка X-Forwarded-For. Один из способов сделать это заключается в том, чтобы установить заголовок для add_x_forwarded_for_proxy переменной сервера:

![Удалить порт](media/rewrite-http-headers/remove-port.png)

### <a name="modify-a-redirection-url"></a>Изменение URL-адреса перенаправления

Когда приложение бэк-энда отправляет ответ на перенаправление, может потребоваться перенаправить клиента на другой URL-адрес, чем тот, который указан в приложении бэк-энда. Например, это может потребоваться, когда служба приложения размещается за шлюзом приложения и требует от клиента перенаправления на относительный путь. (Например, перенаправление с contoso.azurewebsites.net/path1 на contoso.azurewebsites.net/path2.)

Поскольку Служба приложений является мультитенантной службой, она использует заголовок хоста в запросе для направления запроса в правильную конечную точку. Службы приложений имеют доменное имя по умолчанию azurewebsites.net (скажем, contoso.azurewebsites.net), которое отличается от доменного имени шлюза приложения (скажем, contoso.com). Поскольку первоначальный запрос клиента имеет доменное имя шлюза приложения (contoso.com) в качестве хоста, шлюз приложения меняет имя хоста на contoso.azurewebsites.net. Это изменение делается так, чтобы служба приложения спомощьна маршрутизирующая служба запроса в правильную конечную точку.

Когда служба приложения отправляет ответ на перенаправление, она использует то же имя хоста в заголовке местоположения своего ответа, что и запрос в запросе, который он получает от шлюза приложения. Таким образом, клиент будет делать запрос непосредственно contoso.azurewebsites.net/path2 вместо того, чтобы пройти через шлюз приложения (contoso.com/path2). Обход шлюза приложения нежелателен.

Эту проблему можно решить, установив имя хоста в заголовке местоположения на доменное имя шлюза приложения.

Вот шаги для замены хоста:

1. Создайте правило перезаписи с условием, которое оценивает, содержит ли заголовок местоположения в ответе azurewebsites.net. Введите `(https?):\/\/.*azurewebsites\.net(.*)$`шаблон.
1. Выполните действие, чтобы переписать заголовок местоположения таким образом, чтобы у него было хостовое имя шлюза приложения. Сделайте это, введя `{http_resp_Location_1}://contoso.com{http_resp_Location_2}` в качестве значения заголовка.

![Изменение заголовка местоположения](media/rewrite-http-headers/app-service-redirection.png)

### <a name="implement-security-http-headers-to-prevent-vulnerabilities"></a>Реализация заголовков безопасности HTTP для предотвращения уязвимостей

Можно исправить несколько уязвимостей безопасности, внедрив необходимые заголовки в ответ приложения. Эти заголовки безопасности включают X-XSS-Protection, Strict-Transport-Security и Content-Security-Policy. Вы можете использовать шлюз приложения для установки этих заголовков для всех ответов.

![Заголовок безопасности](media/rewrite-http-headers/security-header.png)

### <a name="delete-unwanted-headers"></a>Удаление нежелательных заголовков

Возможно, вы захотите удалить заголовки, раскрывающие конфиденциальную информацию из ответа HTTP. Например, можно удалить такие сведения, как имя сервера, операционная система или сведения библиотеки. Вы можете использовать шлюз приложения для удаления следующих заголовков:

![Удаляющий заголовок](media/rewrite-http-headers/remove-headers.png)

### <a name="check-for-the-presence-of-a-header"></a>Проверка на наличие заголовка

Вы можете оценить запрос HTTP или заголовок ответа на наличие заголовка или переменной сервера. Эта оценка полезна, если требуется переписать заголовок только при припойк определенного заголовка.

![Проверка наличия заголовка](media/rewrite-http-headers/check-presence.png)

## <a name="limitations"></a>Ограничения

- Если ответ имеет более одного заголовка с тем же именем, то переписывание значения одного из этих заголовков приведет к снижению других заголовков в ответе. Обычно это может произойти с заголовком Set-Cookie, так как в ответ может быть более одного заголовка Set-Cookie. Одним из таких сценариев является использование службы приложений с шлюзом приложения и настроены на основе куки сродство сеанса на шлюзе приложения. В этом случае ответ будет содержать два заголовка Set-Cookie: один, `Set-Cookie: ARRAffinity=ba127f1caf6ac822b2347cc18bba0364d699ca1ad44d20e0ec01ea80cda2a735;Path=/;HttpOnly;Domain=sitename.azurewebsites.net` например, используется службой приложений, а другой для сродства шлюза приложений, например, `Set-Cookie: ApplicationGatewayAffinity=c1a2bd51lfd396387f96bl9cc3d2c516; Path=/`. Переписывание одного из заголовков Set-Cookie в этом сценарии может привести к удалению другого заголовка Set-Cookie из ответа.

- Переписывание заголовков соединения, обновления и хоста в настоящее время не поддерживается.

- Имена заголовков могут содержать любые буквенно-цифровые символы и определенные символы, как это определено в [RFC 7230.](https://tools.ietf.org/html/rfc7230#page-27) В настоящее время мы не\_поддерживаем подчеркивание () особый символ в названиях заголовков.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать, как переписать заголовки HTTP, см.:

- [Переписать заголовки HTTP с помощью портала Azure](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers-portal)
- [Перепишите заголовки HTTP с помощью Azure PowerShell](add-http-header-rewrite-rule-powershell.md)
