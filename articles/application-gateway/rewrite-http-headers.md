---
title: Перепишите заголовки HTTP с помощью шлюза приложений Azure | Документация Майкрософт
description: В этой статье представлен обзор перезапись заголовков HTTP в шлюзе приложений Azure
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 04/29/2019
ms.author: absha
ms.openlocfilehash: ebb14d97273851585e491e3bcd36f776ec9b61b4
ms.sourcegitcommit: 13cba995d4538e099f7e670ddbe1d8b3a64a36fb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/22/2019
ms.locfileid: "66000971"
---
# <a name="rewrite-http-headers-with-application-gateway"></a>Перепишите заголовки HTTP с помощью шлюза приложений

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Заголовки HTTP позволяют клиентом и сервером для передачи дополнительных сведений с запросом или ответом. Переписывать эти заголовки, позволяет выполнять важные задачи, такие как добавление поля заголовка, связанные с безопасностью, как HSTS / X-XSS-Protection, удаление поля заголовка ответа, которые может раскрыть конфиденциальную информацию и удаление сведения о порте из Заголовки X-Forwarded-For.

Шлюз приложений позволяет добавить, удалить или обновить заголовки запроса и ответа HTTP, во время запроса и перемещение пакетов ответа между клиентом и внутренних пулов. И позволяет добавить условия, чтобы убедиться, что указанные заголовки перезаписываются только в том случае, если соблюдены определенные условия.

Шлюз приложений также поддерживает несколько [переменных сервера](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers#server-variables) , помогающие хранения дополнительной информации о запросах и ответах. Это упрощает создание мощных переопределения правила.

> [!NOTE]
>
> Поддержка переопределения заголовка HTTP доступна только для [Standard_V2 и WAF_v2 SKU](application-gateway-autoscaling-zone-redundant.md).

![Переопределения заголовков](media/rewrite-http-headers/rewrite-headers.png)

## <a name="supported-headers"></a>Поддерживаемые заголовки

Можно переписать все заголовки в запросах и ответах, за исключением заголовков узла, подключения и обновления. Шлюз приложений также можно создать пользовательские заголовки и добавить их в запросы и ответы, направляется через него.

## <a name="rewrite-conditions"></a>Перепишите условия

Вы можете использовать перезаписи условий для оценки содержимого HTTP (S) запросов и ответов и выполнить перезапись заголовка только в том случае, когда один или несколько условий. Шлюз приложений использует эти типы переменных для оценки содержимого HTTP (S) запросов и ответов:

- Заголовки HTTP в запросе.
- Заголовки HTTP в ответе.
- Переменные сервера шлюза приложения.

Условие можно использовать для определения соответствия указанной переменной присутствует, ли указанная переменная совпадает с конкретным значением или указанной переменной соответствует заданному шаблону. Использовании [Perl совместимый регулярных выражений () требуется библиотека PCRE](https://www.pcre.org/) для настройки сопоставления в условиях шаблона регулярного выражения. Дополнительные сведения о синтаксисе регулярных выражений, см. в разделе [главной странице регулярных выражений Perl](https://perldoc.perl.org/perlre.html).

## <a name="rewrite-actions"></a>Перепишите действия

Для указания заголовков запроса и ответа, которые вы хотите переписать и новое значение для заголовков используются rewrite действия. Можно создать новый заголовок, изменить значение существующего заголовка или удалить существующий заголовок. Значения этого типа может быть присвоено значение заголовок нового или существующего заголовка:

- Текст.
- Заголовок запроса. Чтобы указать в заголовке запроса, необходимо использовать синтаксис {http_req_*Имя_заголовка*}.
- Заголовок ответа. Чтобы указать заголовок ответа, необходимо использовать синтаксис {http_resp_*Имя_заголовка*}.
- Переменная сервера. Чтобы указать переменную сервера, необходимо использовать синтаксис {var_*serverVariable*}.
- Сочетание текста, в заголовке запроса, заголовок ответа и переменную сервера.

## <a name="server-variables"></a>Переменные сервера

Шлюз приложений использует серверные переменные для хранения полезные сведения о сервере, соединение с клиентом и текущий запрос на подключение. Данные примеры IP-адрес клиента и типом веб-браузера. Переменные сервера динамически изменяться, например, при загрузке новой страницы или при передаче формы. Эти переменные можно использовать для оценки условия перезаписи и переписывать заголовки.

Шлюз приложений поддерживает эти переменные сервера:

| Имя переменной | Описание                                                  |
| -------------------------- | :----------------------------------------------------------- |
| add_x_forwarded_for_proxy  | Поле заголовка запроса X-Forwarded-For клиента с `client_ip` переменной (см. описание далее в этой таблице) добавленным к нему в формате IP1, IP2, IP3 и т. д. Если поле X-Forwarded-For отсутствует в заголовке запроса клиента `add_x_forwarded_for_proxy` переменной равно `$client_ip` переменной. Эта переменная особенно полезна в случаях, когда требуется перезаписывает заголовок X-Forwarded-For, задайте шлюзом приложений, таким образом, чтобы заголовок содержит только IP-адрес без сведения о порте. |
| ciphers_supported          | Список шифров, поддерживаемые клиентом.          |
| ciphers_used               | Строка шифры, используемый для установленного соединения SSL. |
| client_ip                  | IP-адрес, по которому шлюз приложений получили запрос клиента. Если обратный прокси-сервер перед шлюза приложений и клиенту, *client_ip* возвращает IP-адрес обратного прокси-сервера. |
| client_port                | Порт клиента.                                                  |
| client_tcp_rtt             | Сведения о клиенте TCP-подключение. Доступно в системах, поддерживающих TCP_INFO параметра сокета. |
| client_user                | Если используется проверка подлинности HTTP, имя пользователя, переданный для проверки подлинности. |
| host                       | В следующем порядке: имя узла из строки запроса, имя узла из поле заголовка запроса узла или имя сервера, соответствия запроса. |
| cookie_*имя*              | *Имя* файла cookie.                                            |
| http_method                | метод, используемый для выполнения запроса URL-адрес. Например GET или POST. |
| http_status                | Состояние сеанса. Например 200, 400 или 403.                       |
| http_version               | Протокол запроса. Обычно HTTP/1.0, HTTP/1.1 или HTTP/2.0. |
| query_string               | Следующего списка пар переменная значение «?» в запрошенного URL-адреса. |
| received_bytes             | Длина запроса (включая строку запроса, заголовок и текст запроса). |
| request_query              | Аргументы в строке запроса.                                |
| request_scheme             | Схема запроса: http или https.                            |
| request_uri                | Полный исходный URI запроса (с аргументами).                   |
| sent_bytes                 | Число байтов, отправленных клиенту.                             |
| server_port                | Порт сервера, который принял запрос.                 |
| ssl_connection_protocol    | Протокол установленное подключение SSL.        |
| ssl_enabled                | «Вкл.» Если соединение работает в режиме SSL. В противном случае — пустая строка. |

## <a name="rewrite-configuration"></a>Перепишите конфигурации

Чтобы настроить перезапись заголовка HTTP, вам потребуется для выполнения этих действий.

1. Создайте объекты, которые требуются для переопределения заголовка HTTP:

   - **Перепишите действие**: Используется для указания запроса и полей заголовка запроса, которые вы хотите переписать и новое значение для заголовков. Может быть связано одно или несколько переписать условий с помощью действия переопределения.

   - **Перепишите условие**: Дополнительная настройка. Перезапись условия оценки содержимого HTTP (S) запросов и ответов. Действие переопределения произойдет в том случае, если запрос HTTP (S) или ответ соответствует условию перезаписи.

     Если более одного условия связывается с действием, действие происходит только в том случае, если выполнены все условия. Другими словами операция остается логическую операцию и.

   - **Правила переопределения**: Содержит несколько действий перезаписи / переписать сочетания условий.

   - **Правила последовательности**: Помогает определить порядок, в которой выполняются правила подстановки. Эта конфигурация полезно при наличии нескольких правила подстановки в наборе перезаписи. Правило переопределения, которое имеет меньшее значение последовательности правило выполняется первой. Если вы назначаете той же последовательности правило два правила переопределения, порядок выполнения является недетерминированным.

   - **Перепишите набора**: Содержит несколько правил переопределения, которые будут связаны с правило маршрутизации запроса.

2. Присоединить множество перезаписи (*rewriteRuleSet*) для правила маршрутизации. Параметры перезаписи, присоединяется к исходному прослушивателю посредством правила маршрутизации. При использовании базового правила маршрутизации, конфигурация переопределения заголовка связывается с исходным прослушивателем и перезапись глобального заголовка. При использовании правила маршрутизации на основе пути конфигурация переопределения заголовка задается для сопоставления URL-пути. В этом случае он применяется только к области конкретного пути узла.

Можно создать несколько наборов переопределения заголовка HTTP и применить каждой перезаписи присвоено несколько прослушивателей. Но вы можете применить только один переписать набора для конкретного прослушивателя.

## <a name="common-scenarios"></a>Распространенные сценарии

Ниже приведены некоторые распространенные сценарии использования переопределения заголовка.

### <a name="remove-port-information-from-the-x-forwarded-for-header"></a>Удалить сведения о порте из заголовка X-Forwarded-For

Шлюз приложений вставляет заголовок X-Forwarded-For в все запросы, прежде чем он перенаправляет запросы в серверную часть. Этот заголовок является разделенный запятыми список IP-портам. Возможны ситуации, в которых внутренних серверов требуется только заголовки, чтобы содержать IP-адреса. Чтобы удалить сведения о порте из заголовка X-Forwarded-For можно использовать переопределения заголовка. Для этого рекомендуется задать для переменной сервера add_x_forwarded_for_proxy заголовка:

![Удаление порта](media/rewrite-http-headers/remove-port.png)

### <a name="modify-a-redirection-url"></a>Изменить URL-адрес перенаправления

Если серверное приложение посылает ответ перенаправления, можно перенаправлять клиента на другой URL-адрес, отличный от указанного для серверной части приложения. Например может потребоваться сделать это, когда службу приложений размещается за шлюз приложений и требуется клиенту выполнить перенаправление относительный путь к каталогу. (Например, перенаправление из contoso.azurewebsites.net/path1 в contoso.azurewebsites.net/path2).

Так как служба приложений является многопользовательской, используется заголовок узла в запросе для маршрутизации запроса на правильную конечную точку. Службы приложений по по умолчанию присвоено имя домена *. azurewebsites.net (например, contoso.azurewebsites.net), который отличается от шлюза приложений доменное имя (например, contoso.com). Так как исходный запрос от клиента шлюза приложений доменного имени (contoso.com), имя узла, шлюз приложений изменяет имя узла для contoso.azurewebsites.net. Он делает это изменение, чтобы службы приложений может направлять запрос в правильную конечную точку.

Когда службы приложений отправляет ответ перенаправления, он использует же именем узла в заголовке location ответа, в запросе, получаемых от шлюза приложений. Поэтому клиент сделает запрос прямо на contoso.azurewebsites.net/path2 не будет выполнено через шлюз приложений (contoso.com/path2). Нежелательно, минуя шлюз приложений.

Устранить эту проблему можно, задав имя узла в заголовке location, чтобы доменное имя шлюза приложений.

Ниже приведены шаги по замене имени узла.

1. Создание правила переопределения с условием, которое возвращает, если под заголовком location в ответе содержит azurewebsites.net. Введите шаблон `(https?):\/\/.*azurewebsites\.net(.*)$`.
1. Выполните действие переписывать заголовок location, чтобы его имя узла шлюза приложений. Это можно сделать, введя `{http_resp_Location_1}://contoso.com{http_resp_Location_2}` как значение заголовка.

![Изменить заголовок location](media/rewrite-http-headers/app-service-redirection.png)

### <a name="implement-security-http-headers-to-prevent-vulnerabilities"></a>Реализовать заголовки безопасности HTTP для предотвращения появления уязвимостей

Вы можете исправить несколько уязвимостей безопасности, реализация необходимых заголовков в ответе приложения. Эти заголовки безопасности включают X-XSS-Protection Strict-Transport-Security и политике безопасности содержимого. Шлюз приложений можно использовать для установки этих заголовков всех ответов.

![Заголовок безопасности](media/rewrite-http-headers/security-header.png)

### <a name="delete-unwanted-headers"></a>Удаление нежелательных заголовки

Может потребоваться удалить заголовки, которые допускается раскрытие уязвимой информации из HTTP-ответа. Например может потребоваться удалить сведения, такие как имя сервера серверной части, операционной системы или сведения о библиотеке. Шлюз приложений можно использовать для удаления этих заголовков:

![Удалить заголовок](media/rewrite-http-headers/remove-headers.png)

### <a name="check-for-the-presence-of-a-header"></a>Проверяет наличие заголовка

Вы можете оценить заголовка запроса или ответа HTTP на наличие переменной заголовок или сервера. Эта оценка удобен для вы хотите выполнить перезапись заголовка только в том случае, если определенные заголовок присутствует.

![Проверка на присутствие заголовка](media/rewrite-http-headers/check-presence.png)

## <a name="limitations"></a>Ограничения

- Переопределения заголовков подключения, обновления и узла сейчас не поддерживается.

- Имена заголовков может содержать любые буквы, цифры и специальные символы, как определено в [RFC 7230](https://tools.ietf.org/html/rfc7230#page-27). Мы не поддерживаем символ подчеркивания (\_) специальный символ в имена заголовков.

- Если ответ содержит несколько заголовков с тем же именем, затем переопределения значение одного из этих заголовков приведет к удаление других заголовков в ответе.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать, как переписать заголовки HTTP, см. в разделе:

- [Перепишите заголовки HTTP, с помощью портала Azure](https://docs.microsoft.com/azure/application-gateway/rewrite-http-headers-portal)
- [Перепишите заголовки HTTP, с помощью Azure PowerShell](add-http-header-rewrite-rule-powershell.md)
