---
title: Перемещение виртуальных машин Azure в зоны доступности в другом регионе с помощью перемещения ресурсов Azure
description: Узнайте, как переместить виртуальные машины Azure в зоны доступности с помощью перемещения ресурсов Azure.
manager: evansma
author: rayne-wiselman
ms.service: resource-move
ms.topic: how-to
ms.date: 09/10/2020
ms.author: raynew
ms.openlocfilehash: fdd564618232ce7fde5a76fb9c37937113f179b2
ms.sourcegitcommit: 5d7f8c57eaae91f7d9cf1f4da059006521ed4f9f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2020
ms.locfileid: "89670871"
---
# <a name="move-azure-vms-to-an-availability-zone-in-another-region"></a>Перемещение виртуальных машин Azure в зону доступности в другом регионе

Из этой статьи вы узнаете, как перемещать виртуальные машины Azure (и связанные ресурсы сети или хранилища) в зону доступности в другом регионе Azure с помощью средства [перемещения ресурсов Azure](overview.md).

[Зоны доступности Azure](../availability-zones/az-overview.md#availability-zones) помогают защитить развертывание Azure от сбоев центра обработки данных. Каждая зона доступности состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Для обеспечения устойчивости существует как минимум три отдельные зоны во всех [включенных регионах](../availability-zones/az-region.md). С помощью перемещения ресурсов можно перемещаться:

- Виртуальная машина с одним экземпляром в зону доступности или группу доступности в целевом регионе.
- Виртуальная машина в группе доступности устанавливается в зону доступности или группу доступности в целевом регионе.
- Виртуальная машина в зоне доступности исходного региона для зоны доступности в целевом регионе.


> [!IMPORTANT]
> Сейчас для перемещения ресурсов Azure используется общедоступная Предварительная версия.

Если вы хотите переместить виртуальные машины в другую зону доступности в том же регионе, [Ознакомьтесь с этой статьей](../site-recovery/azure-to-azure-how-to-enable-zone-to-zone-disaster-recovery.md).

## <a name="prerequisites"></a>Предварительные требования

- Доступ *владельца* к подписке, в которой находятся ресурсы, которые требуется переместить.
    - При первом добавлении ресурса для определенного сопоставления источника и назначения в подписке Azure средство перемещения ресурсов создает [управляемое системой удостоверение](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types) (ранее известное как управляемая служба идентификации (MSI)), которому доверяет подписка.
    - Чтобы создать удостоверение и назначить ему требуемую роль (для участника или администратора доступа пользователей в исходной подписке), учетной записи, используемой для добавления ресурсов, требуются права *владельца* для подписки. Дополнительные [сведения](../role-based-access-control/rbac-and-directory-admin-roles.md#azure-roles) о ролях Azure.
- Подписке требуется достаточно квота для создания исходных ресурсов в целевом регионе. В противном случае запросите дополнительные ограничения. [Подробнее](/azure/azure-resource-manager/management/azure-subscription-service-limits).
- Проверьте цены и расходы, связанные с целевым регионом, в который вы перемещаете виртуальные машины. Используйте [Калькулятор цен](https://azure.microsoft.com/pricing/calculator/) , чтобы помочь вам.
    


## <a name="check-vm-requirements"></a>Проверка требований к виртуальной машине

1. Убедитесь, что виртуальные машины, которые требуется переместить, поддерживаются.

    - [Проверьте](support-matrix-move-region-azure-vm.md#windows-vm-support) Поддерживаемые виртуальные машины Windows.
    - [Проверьте](support-matrix-move-region-azure-vm.md#linux-vm-support) Поддерживаемые виртуальные машины Linux и версии ядра.
    - Проверьте поддерживаемые параметры [вычислений](support-matrix-move-region-azure-vm.md#supported-vm-compute-settings), [хранения](support-matrix-move-region-azure-vm.md#supported-vm-storage-settings)и [сети](support-matrix-move-region-azure-vm.md#supported-vm-networking-settings) .
2. Убедитесь, что виртуальные машины, которые требуется переместить, включены.
3. Убедитесь, что виртуальные машины имеют последние Доверенные корневые сертификаты и обновленный список отзыва сертификатов (CRL). 
    - На виртуальных машинах Azure под Windows установите последние обновления Windows.
    - На виртуальных машинах под управлением Linux следуйте указаниям по использованию распространителя Linux, чтобы убедиться, что на компьютере установлены последние сертификаты и список отзыва сертификатов. 
4. Разрешить исходящие подключения с виртуальных машин:
    - Если вы используете прокси-сервер брандмауэра на основе URL-адресов для управления исходящими подключениями, разрешите доступ к этим [URL-адресам](support-matrix-move-region-azure-vm.md#url-access) .
    - Если вы используете правила группы безопасности сети (NSG) для управления исходящими подключениями, создайте эти [правила тегов служб](support-matrix-move-region-azure-vm.md#nsg-rules).

## <a name="select-resources-to-move"></a>Выберите ресурсы для перемещения

Выберите ресурсы, которые требуется переместить.

- Вы можете выбрать любой поддерживаемый тип ресурсов в группах ресурсов в выбранном исходном регионе.
- Ресурсы перемещаются в целевой регион в подписке исходного региона. Если вы хотите изменить подписку, это можно сделать после перемещения ресурсов.

1. В портал Azure выполните поиск перемещения ресурсов. Затем в разделе " **службы**" выберите "перемещение **ресурсов Azure**".

    ![Поиск перемещения ресурсов](./media/move-region-availability-zone/search.png)

2. В разделе **Общие сведения**выберите начало **работы**.

    ![Кнопка для начала работы](./media/move-region-availability-zone/get-started.png)

3. В пункте **Перемещение ресурсов**  >  **источник + назначение**выберите исходную подписку и регион.
4. В поле **назначение**выберите регион, в который необходимо переместить виртуальные машины. 
5. В **области Метаданные**выберите место хранения метаданных о ресурсах, которые вы перемещаете. Группа ресурсов создается специально для этой цели. Затем нажмите кнопку **Далее**.

     ![Страница для заполнения исходной и целевой подписки или региона](./media/move-region-availability-zone/source-target.png)

6. В списке **ресурсы для перемещения**щелкните **выбрать ресурсы**.
7. В списке **выберите ресурсы**выберите виртуальную машину. Можно добавлять только ресурсы, поддерживаемые для перемещения. Затем нажмите кнопку **Готово**. В окне **перемещаемые ресурсы**нажмите кнопку **Далее**.

    ![Страница для выбора виртуальных машин для перемещения](./media/move-region-availability-zone/select-vm.png)
8. В окне " **Проверка и добавление**" Проверьте параметры источника и назначения.

    ![Страница для просмотра параметров и перехода к перемещению](./media/move-region-availability-zone/review.png)

9. Нажмите кнопку **продолжить**, чтобы начать добавление ресурсов.
10. После успешного завершения процесса добавления щелкните **Добавить ресурсы для перемещения** на значке уведомления.

    ![Сообщение в уведомлениях](./media/move-region-availability-zone/notification.png)

После щелчка на уведомлении ресурсы отображаются на странице **между регионами** .

> [!NOTE]
> После щелчка на уведомлении ресурсы отображаются на странице **между регионами** в состоянии " *Подготовка ожидается* ".
> - Если требуется удалить ресурс из коллекции перемещения, то метод выполнения зависит от того, где находится процесс перемещения. [Подробнее](remove-move-resources.md).

## <a name="resolve-dependencies"></a>Устранение ошибок, связанных с зависимостями

1. Если в столбце " **проблемы** " в поле "ресурсы" отображается сообщение *Проверка зависимостей* , нажмите кнопку **проверить зависимости** . Процесс проверки существ.
2. Если обнаружены зависимости, нажмите кнопку **добавить зависимости**. 
3. В окне **Добавление зависимостей**Выберите зависимые ресурсы, > **добавить зависимости**. Отслеживание хода выполнения в уведомлениях.

    ![Кнопка для добавления зависимостей](./media/move-region-availability-zone/add-dependencies.png)

3. При необходимости добавьте дополнительные зависимости и проверьте зависимости. 

    ![Страница для добавления дополнительных зависимостей](./media/move-region-availability-zone/add-additional-dependencies.png)

4. На странице **между регионами** убедитесь, что ресурсы теперь находятся в состоянии " *Подготовка ожидает подготовки* " без проблем.

    ![Страница, показывающая ресурсы в состоянии "Подготовка ожидается"](./media/move-region-availability-zone/prepare-pending.png)

## <a name="move-the-source-resource-group"></a>Перемещение исходной группы ресурсов 

Прежде чем можно будет подготовить и переместить виртуальные машины, исходная группа ресурсов должна присутствовать в целевом регионе. 

### <a name="prepare-to-move-the-source-resource-group"></a>Подготовка к перемещению исходной группы ресурсов

Подготовка выполняется следующим образом.

1. В **области в разных регионах**выберите исходную группу ресурсов > **подготовки**.
2. В окне **Подготовка ресурсов**нажмите кнопку **Подготовка**.

    ![Кнопка для подготовки исходной группы ресурсов](./media/move-region-availability-zone/prepare-resource-group.png)

    Во время подготовки перемещение ресурсов создает шаблоны Azure Resource Manager (ARM), используя параметры группы ресурсов. Ресурсы в группе ресурсов не затрагиваются.

> [!NOTE]
>  После подготовки группы ресурсов она находится в состоянии *Ожидание запуска перемещения* . 

![Состояние, показывающее состояние запуска "ожидание"](./media/move-region-availability-zone/initiate-resource-group-pending.png)

### <a name="move-the-source-resource-group"></a>Перемещение исходной группы ресурсов

Запустите перемещение следующим образом:

1. В **области в разных регионах**выберите группу ресурсов > **начать перемещение** .
2. LN **Move Resources**, щелкните **начать перемещение**. Группа ресурсов перемещается в состояние *начатого перемещения* .
3. После начала перемещения создается целевая группа ресурсов на основе созданного шаблона ARM. Исходная группа ресурсов перемещается в состояние *ожидания фиксации перемещения* .

![Состояние, показывающее перемещение фиксации](./media/move-region-availability-zone/commit-move-pending.png)

Чтобы зафиксировать и завершить процесс перемещения, сделайте следующее:

1. В **области в разных регионах**выберите группу ресурсов > **фиксация перемещения**
2. последовательно выберите **переместить ресурсы**и нажмите кнопку **зафиксировать**.

> [!NOTE]
> После фиксации перемещения исходная группа ресурсов находится в состоянии *ожидания удаления источника* .


## <a name="add-a-target-availability-zone"></a>Добавление целевой зоны доступности

Прежде чем переместить остальные ресурсы, мы установим целевую зону доступности для виртуальной машины.

1. На странице **между регионами** щелкните ссылку в столбце **Целевая конфигурация** виртуальной машины, которую вы перемещаете.

    ![Свойства виртуальной машины](./media/move-region-availability-zone/select-vm-settings.png)

3. В **параметрах конфигурации**укажите параметр для целевой виртуальной машины. Вы можете настроить виртуальную машину в целевом регионе следующим образом:
    -  Создайте новый эквивалентный ресурс в целевом регионе. За исключением указанных параметров, целевой ресурс создается с теми же параметрами, что и у источника.
    - Выберите существующую виртуальную машину в целевом регионе. 

4. В области **зоны**выберите зону, в которой необходимо разместить виртуальную машину при ее перемещении.

    Изменения вносятся только в изменяемый ресурс. Все зависимые ресурсы необходимо обновлять отдельно.

5. В поле **SKU**укажите [уровень Azure](..//virtual-machines/sizes.md) , который вы хотите назначить целевой виртуальной машине.
6. В **группе доступности**выберите группу доступности, если требуется, чтобы ЦЕЛЕВая виртуальная машина выполнялась в группе доступности в зоне доступности.
7. Щелкните **Save changes** (Сохранить изменения).

    ![Параметры виртуальной машины](./media/move-region-availability-zone/vm-settings.png)


## <a name="prepare-resources-to-move"></a>Подготовка ресурсов для перемещения

Теперь, когда исходная группа ресурсов перемещена, можно подготовиться к перемещению других ресурсов.

1. В **области в разных регионах**выберите ресурсы, которые необходимо подготовить. 

    ![Страница для выбора подготовки к другим ресурсам](./media/move-region-availability-zone/prepare-other.png)

2. Выберите **Подготовка**. 

> [!NOTE]
> - В процессе подготовки на виртуальных машинах для репликации устанавливается Azure Site Recovery агент мобильности.
> - Данные виртуальной машины периодически реплицируются в целевой регион. Это не влияет на исходную виртуальную машину.
> - При перемещении ресурсов создаются шаблоны ARM для других исходных ресурсов.
> - После подготовки ресурсов они находятся в состоянии *Ожидание запуска перемещения* .

![Страница, показывающая ресурсы в состоянии ожидания при запуске перемещения](./media/move-region-availability-zone/initiate-move-pending.png)

## <a name="initiate-the-move"></a>Начать перемещение

Теперь, когда ресурсы подготовлены, вы можете начать перемещение. 

1. В **области в разных регионах**выберите ресурсы с состоянием *Запуск перемещения ожидание*. Затем нажмите кнопку **начать перемещение** .
2. В меню **Перемещение ресурсов**выберите команду **начать перемещение**.

    ![Страница для инициации перемещения ресурсов](./media/move-region-availability-zone/initiate-move.png)

3. Отслеживать ход перемещения на панели уведомлений.


> [!NOTE]
> - Для виртуальных машин реплики виртуальных машин создаются в целевом регионе. Исходная виртуальная машина завершает работу, и происходит некоторое время простоя (обычно в минутах).
> - Перемещение ресурсов воссоздает другие ресурсы с помощью подготовленных шаблонов ARM. Обычно время простоя отсутствует.
> - После подготовки ресурсов они находятся в состоянии *ожидания фиксации перемещения* .


![Страница для отображения ресурсов в состоянии ожидания фиксации перемещения](./media/move-region-availability-zone/resources-commit-move-pending.png)

## <a name="discard-or-commit"></a>Отменить или зафиксировать?

После первоначального перемещения можно решить, следует ли зафиксировать перемещение или отменить его. 

- **Отменить**. Вы можете отменить перемещение, если тестируете, и вы не хотите переносить исходный ресурс. При отмене перемещения ресурс возвращается в состояние *Ожидание инициированного перемещения*.
- **Фиксация**: фиксация завершает перемещение в целевой регион. После фиксации исходный ресурс будет находиться в состоянии *Ожидание удаления источника*, и вы можете решить, хотите ли вы удалить его.

## <a name="discard-the-move"></a>Отменить перемещение 

Вы можете отменить перемещение следующим образом:

1. В **области в разных регионах**выберите ресурсы с состоянием *фиксации ожидания перемещения*и нажмите кнопку **отменить перемещение**.
2. В меню **отменить перемещение**нажмите кнопку **отменить**.
3. Отслеживать ход перемещения на панели уведомлений.
 

> [!NOTE]
> Для виртуальных машин после отмены ресурсов они находятся в состоянии " *Ожидание запуска перемещения* ".

## <a name="commit-the-move"></a>Фиксация перемещения

Если вы хотите завершить процесс перемещения, зафиксируйте перемещение. 

1. В **области в разных регионах**выберите ресурсы с *ожидающим перемещением*состояния и нажмите кнопку **фиксация перемещения**.
2. В окне **фиксация ресурсов**нажмите кнопку **зафиксировать**.

    ![Страница фиксации ресурсов для завершения перемещения](./media/move-region-availability-zone/commit-resources.png)

3. Отслеживать ход фиксации на панели уведомлений.

> [!NOTE]
> - После фиксации перемещения виртуальные машины останавливают репликацию. Фиксация не влияет на исходную виртуальную машину.
> - Фиксация не влияет на исходные сетевые ресурсы.
> - После фиксации перемещения ресурсы находятся в состоянии *ожидания удаления источника* .

![Страница, на которой показаны ресурсы в * состояние ожидания удаления источника *](./media/move-region-availability-zone/delete-source-pending.png)

## <a name="configure-settings-after-the-move"></a>Настройка параметров после перемещения

Служба Mobility Service не удаляется автоматически с виртуальных машин. Удалите его вручную или оставьте, если планируется повторное перемещение сервера.


## <a name="delete-source-resources-after-commit"></a>Удалить исходные ресурсы после фиксации

После перемещения можно при необходимости удалить ресурсы в исходном регионе.

1. В **области в разных регионах**щелкните имя каждого исходного ресурса, который необходимо удалить.
2. На странице свойства для каждого ресурса выберите **Удалить**.

## <a name="delete-additional-resources-created-for-move"></a>Удаление дополнительных ресурсов, созданных для перемещения

После перемещения можно вручную удалить коллекцию перемещения и Site Recovery созданные ресурсы.

- Коллекция перемещения по умолчанию скрыта. Чтобы увидеть его, необходимо включить скрытые ресурсы.
- Хранилище кэша имеет блокировку, которую необходимо удалить, прежде чем ее можно будет удалить.

Удалите следующим образом: 

1. Нахождение ресурсов в группе ресурсов ```RegionMoveRG-<sourceregion>-<target-region>``` .
2. Убедитесь, что все виртуальные машины и другие исходные ресурсы в исходном регионе были перемещены или удалены. Это гарантирует, что у вас нет ресурсов, ожидающих их использования.
2. Удалите ресурсы:

    - Имя коллекции перемещения — ```movecollection-<sourceregion>-<target-region>``` .
    - Имя учетной записи хранения кэша: ```resmovecache<guid>```
    - Имя хранилища — ```ResourceMove-<sourceregion>-<target-region>-GUID``` .

## <a name="next-steps"></a>Дальнейшие действия

[Сведения о](about-move-process.md) процессе перемещения.
