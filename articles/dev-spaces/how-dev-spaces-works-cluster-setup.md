---
title: Как работает настройка кластера для Azure Dev Spaces
services: azure-dev-spaces
ms.date: 03/24/2020
ms.topic: conceptual
description: Описание настройки кластера службы Kubernetes Azure для Azure Dev Spaces
keywords: Azure Dev Spaces, пространства разработки, Docker, Kubernetes, Azure, AKS, служба Kubernetes Azure, контейнеры
ms.openlocfilehash: 00f8262f3008ce9ba82726960f78d18395458a2a
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80241729"
---
# <a name="how-setting-up-a-cluster-for-azure-dev-spaces-works"></a>Как работает настройка кластера для Azure Dev Spaces

Azure Dev Spaces предоставляет несколько способов быстрого перебора и отладки Kubernetes приложений и совместной работы с командой в кластере службы Kubernetes Azure (AKS). Один из способов — включить Azure Dev Spaces в кластере AKS, чтобы службы можно было [запускать непосредственно в кластере][how-it-works-up] и использовать [Дополнительные возможности сети и маршрутизации][how-it-works-routing]. В этой статье описывается, что происходит при подготовке кластера и включении Azure Dev Spaces.

## <a name="prepare-your-aks-cluster"></a>Подготовка кластера AKS

Чтобы подготовить кластер AKS к пространствам разработки, убедитесь, что кластер AKS находится в регионе, [поддерживаемом Azure dev Spaces][supported-regions] и вы используете Kubernetes 1.10.3 или более поздней версии. Чтобы включить Azure Dev Spaces в кластере из портал Azure, перейдите к кластеру, щелкните *пространства разработки*, измените параметр *использовать пространства разработки* в *значение Да*и нажмите кнопку *сохранить*. Можно также включить Azure Dev Spaces из Azure CLI, выполнив `az aks use-dev-spaces`.

Пример настройки кластера AKS для пространств разработки см. в разделе [Краткое руководство по разработке групп][quickstart-team].

Если Azure Dev Spaces включен в кластере AKS, он устанавливает контроллер для кластера. Контроллер находится за пределами кластера AKS. Он управляет поведением и связью между клиентскими инструментами и кластером AKS. После его включения можно взаимодействовать с контроллером с помощью клиентских средств.

Контроллер выполняет следующие действия:

* Управляет созданием и выбором пространства разработки.
* Устанавливает диаграмму Helm приложения и создает объекты Kubernetes.
* Создает образ контейнера приложения.
* Развертывает приложение в AKS.
* Выполняет добавочные сборки и перезапускается при изменении исходного кода.
* Управляет журналами и трассировками HTTP.
* Перенаправляет stdout и stderr на клиентские средства.
* Настраивает маршрутизацию для приложений в пределах пространства, а также для родительских и дочерних пространств.

Контроллер является отдельным ресурсом Azure за пределами кластера и выполняет следующие действия для ресурсов в кластере:

* Создает или назначает пространство имен Kubernetes для использования в качестве пространства разработки.
* Удаляет любое пространство имен Kubernetes с именем *аздс*, если оно существует, и создает новое.
* Развертывает конфигурацию веб-перехватчика Kubernetes.
* Развертывает сервер допуска веб-перехватчика.

Он использует тот же субъект-службу, который используется кластером AKS для выполнения вызовов служб к другим компонентам Azure Dev Spaces.

![Azure Dev Spaces подготовить кластер](media/how-dev-spaces-works/prepare-cluster.svg)

Чтобы использовать Azure Dev Spaces, необходимо иметь по крайней мере одно пространство разработки. Azure Dev Spaces использует пространства имен Kubernetes в кластере AKS для пространств разработки. При установке контроллера будет предложено создать новое пространство имен Kubernetes или выбрать существующее пространство имен для использования в качестве первого пространства разработки. По умолчанию контроллер предлагает обновить существующее пространство имен Kubernetes *по умолчанию* до первого пространства разработки.

Если пространство имен обозначено как пространство разработки, контроллер добавляет метку *azds.IO/Space=true* в это пространство имен, чтобы обозначить ее как пространство разработки. Начальное пространство разработки, которое вы создаете или назначаете, выбирается по умолчанию после подготовки кластера. Если выбрано место, оно используется Azure Dev Spaces для создания новых рабочих нагрузок.

С помощью клиентских средств можно создавать новые пространства для разработки и удалять существующие пространства разработки. Из-за ограничения в Kubernetes не удается удалить пространство разработки *по умолчанию* . Контроллер также удаляет все существующие пространства имен Kubernetes с именем *аздс* , чтобы избежать конфликтов с `azds` командой, используемой клиентскими средствами.

Сервер допуска Kubernetes веб-перехватчика используется для вставки модулей Pod с тремя контейнерами во время развертывания для инструментирования: девспацес-proxy, контейнер девспацес-proxy-init и контейнер девспацес-Build. **Все три из этих контейнеров работают с корневым доступом к кластеру AKS.** Они также используют тот же субъект-службу, который используется кластером AKS для выполнения вызовов служб к другим компонентам Azure Dev Spaces.

![Azure Dev Spaces сервера допуска веб-перехватчика Kubernetes](media/how-dev-spaces-works/kubernetes-webhook-admission-server.svg)

Контейнер девспацес-Proxy — это контейнер расширения, который обрабатывает весь входящий и исходящий TCP-трафик контейнера приложения и помогает выполнять маршрутизацию. Контейнер девспацес-proxy перенаправляет сообщения HTTP, если используются определенные пробелы. Например, он может помочь маршрутизировать сообщения HTTP между приложениями в родительских и дочерних пространствах. Весь трафик, отличный от HTTP, проходит через девспацес-proxy без изменений. Контейнер девспацес-proxy также регистрирует все входящие и исходящие HTTP-сообщения и отправляет их в средства на стороне клиента в виде трассировок. Затем эти трассировки могут быть просмотрены разработчиком для проверки поведения приложения.

Контейнер девспацес-proxy-init — это [контейнер инициализации](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) , который добавляет дополнительные правила маршрутизации на основе иерархии пространства в контейнер приложения. Он добавляет правила маршрутизации, обновив файл */etc/resolv.conf* контейнера приложений и конфигурацию Iptables перед запуском. Обновления */etc/resolv.conf* РАЗРЕШАЮТ DNS-разрешение служб в родительских пространствах. Обновления конфигурации iptables гарантируют, что весь входящий и исходящий TCP-трафик в контейнер приложения направляется через девспацес прокси. Все обновления из девспацес-proxy-init происходят в дополнение к правилам, которые Kubernetes добавляет.

Контейнер девспацес-Build — это контейнер инициализации, который подключен к исходному коду проекта и сокету DOCKER. Исходный код проекта и доступ к DOCKER позволяют создавать контейнер приложения непосредственно модулем Pod.

> [!NOTE]
> Azure Dev Spaces использует тот же узел для создания контейнера приложения и его запуска. В результате Azure Dev Spaces не требуется внешний реестр контейнеров для сборки и запуска приложения.

Сервер допуска веб-перехватчиков Kubernetes прослушивает все новые Pod, созданные в кластере AKS. Если этот модуль будет развернут в любом пространстве имен с меткой *azds.IO/Space=true* , он внедряет этот модуль с дополнительными контейнерами. Контейнер девспацес-Build вставляется только в том случае, если контейнер приложения запускается с помощью клиентских средств на стороне клиента.

После подготовки кластера AKS можно использовать средства на стороне клиента для подготовки и выполнения кода в пространстве разработки.

## <a name="client-side-tooling"></a>Средства на стороне клиента

Средства на стороне клиента позволяют пользователю:
* Создайте Dockerfile, Helm диаграмму и файл конфигурации Azure Dev Spaces для приложения.
* Создайте родительские и дочерние пространства разработки.
* Сообщите контроллеру о необходимости создания и запуска приложения.

Пока приложение работает, клиентские средства также:
* Получает и отображает stdout и stderr из приложения, работающего в AKS.
* Использует [переадресацию через порт](https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/) , чтобы разрешить веб-доступ к приложению с\/помощью http:/ЛОКАЛХОСТ.
* Присоединяет отладчик к работающему приложению в AKS.
* Синхронизирует исходный код с пространством разработки при обнаружении изменений для добавочных сборок, что позволяет быстро выполнить итерацию.
* Позволяет подключать компьютер разработчика непосредственно к кластеру AKS.

Клиентские средства можно использовать из командной строки как часть `azds` команды. Клиентские средства также можно использовать с:

* Visual Studio Code с помощью [расширения Azure dev Spaces](https://marketplace.visualstudio.com/items?itemName=azuredevspaces.azds).
* Visual Studio с [средства Visual Studio для Kubernetes](https://aka.ms/get-vsk8stools).

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения об использовании клиентских средств для подготовки и выполнения кода в сфере разработки см. в статье [Подготовка проекта к работе в Azure dev Spaces][how-it-works-prep].

Чтобы приступить к работе с Azure Dev Spaces для коллективной разработки, ознакомьтесь с руководством по [разработке групп в Azure dev Spaces][quickstart-team] .

[how-it-works-prep]: how-dev-spaces-works-prep.md
[how-it-works-routing]: how-dev-spaces-works-routing.md
[how-it-works-up]: how-dev-spaces-works-up.md
[supported-regions]: https://azure.microsoft.com/global-infrastructure/services/?products=kubernetes-service
[quickstart-team]: quickstart-team-development.md