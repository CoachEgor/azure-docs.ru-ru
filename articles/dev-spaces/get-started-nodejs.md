---
title: Создание среды разработки Node.js на основе Kubernetes в облаке с помощью VS Code
titleSuffix: Azure Dev Spaces
services: azure-dev-spaces
ms.service: azure-dev-spaces
author: zr-msft
ms.author: zarhoads
ms.date: 09/26/2018
ms.topic: tutorial
description: Быстрая разработка в Kubernetes с использованием контейнеров и микрослужб в Azure
keywords: Docker, Kubernetes, Azure, AKS, Azure Kubernetes Service, containers, Helm, service mesh, service mesh routing, kubectl, k8s
ms.openlocfilehash: 30f912e9c1573b32247bb3c2a3f7d4026436748b
ms.sourcegitcommit: 837dfd2c84a810c75b009d5813ecb67237aaf6b8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2019
ms.locfileid: "67503021"
---
# <a name="get-started-on-azure-dev-spaces-with-nodejs"></a>Начало работы с Node.js в Azure Dev Spaces

Из этого руководства вы узнаете, как выполнить следующие задачи:

- создание в Azure оптимизированной для разработки среды на основе Kubernetes — _пространства разработки_;
- итеративная разработка кода в контейнерах с помощью VS Code и командной строки;
- эффективная разработка и тестирование кода в среде командной работы.

> [!Note]
> **Если на каком-то этапе у вас возникли трудности**, см. статью об [устранении неполадок](troubleshooting.md).

## <a name="install-the-azure-cli"></a>Установка Azure CLI
Для Azure Dev Spaces требуется минимальная настройка локального компьютера. Большая часть конфигурации среды разработки хранится в облаке и доступна для других пользователей. Начните со скачивания и запуска [Azure CLI](/cli/azure/install-azure-cli?view=azure-cli-latest).

### <a name="sign-in-to-azure-cli"></a>Вход в Azure CLI
Войдите в Azure. В окне терминала введите следующую команду:

```cmd
az login
```

> [!Note]
> Если у вас нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free).

#### <a name="if-you-have-multiple-azure-subscriptions"></a>Если у вас несколько подписок Azure...
Можно просматривать свои подписки, выполнив следующую команду: 

```cmd
az account list
```
Найдите подписку с `isDefault: true` в выходных данных JSON.
Если это не та подписка, которую нужно использовать, вы можете изменить подписку по умолчанию:

```cmd
az account set --subscription <subscription ID>
```

## <a name="create-a-kubernetes-cluster-enabled-for-azure-dev-spaces"></a>Создание и включение кластера Kubernetes для Azure Dev Spaces

В командной строке создайте группу ресурсов в [регионе, который поддерживает Azure Dev Spaces][supported-regions].

```cmd
az group create --name MyResourceGroup --location <region>
```

Чтобы создать кластер Kubernetes, выполните следующую команду:

```cmd
az aks create -g MyResourceGroup -n MyAKS --location <region> --disable-rbac --generate-ssh-keys
```

Создание кластера занимает несколько минут.

### <a name="configure-your-aks-cluster-to-use-azure-dev-spaces"></a>Настройка кластера AKS для использования Azure Dev Spaces

В окне командной строки Azure CLI введите приведенную ниже команду, используя группу ресурсов, в которую входит кластер AKS, и имя кластера AKS. Эта команда настраивает в кластере поддержку Azure Dev Spaces.

   ```cmd
   az aks use-dev-spaces -g MyResourceGroup -n MyAKS
   ```

> [!IMPORTANT]
> Процесс настройки Azure Dev Spaces удалит пространство имен `azds` в кластере, если оно существует.

## <a name="get-kubernetes-debugging-for-vs-code"></a>Получение функции отладки Kubernetes для VS Code
Для разработчиков .NET Core и Node.js, которые используют VS Code, доступны широкие возможности, такие как функция отладки Kubernetes.

1. Если у вас не установлен язык [VS Code](https://code.visualstudio.com/Download), установите его.
1. Скачайте и установите [ расширение VS Azure Dev Spaces](https://marketplace.visualstudio.com/items?itemName=azuredevspaces.azds). Один раз щелкните "Установить" на странице расширения в Marketplace и еще раз — в VS Code. 

## <a name="create-a-nodejs-container-in-kubernetes"></a>Создание контейнера Node.js в Kubernetes

В этом разделе вы создадите веб-приложение Node.js и запустите его в контейнере в Kubernetes.

### <a name="create-a-nodejs-web-app"></a>Создание веб-приложения Node.js
Скачайте код из GitHub, перейдя по ссылке https://github.com/Azure/dev-spaces, и выберите **Clone or Download** (Клонировать или скачать), чтобы скачать репозиторий GitHub в локальную среду. Код для этого руководства находится в папке `samples/nodejs/getting-started/webfrontend`.

## <a name="prepare-code-for-docker-and-kubernetes-development"></a>Подготовка кода для разработки в Docker и Kubernetes
На данный момент у вас есть базовое веб-приложение, которое можно запустить локально. Теперь вы упакуете его в контейнер, создав ресурсы, определяющие контейнер приложения и способ его развертывания в Kubernetes. Эту задачу легко выполнить с помощью Azure Dev Spaces: 

1. Запустите VS Code и откройте папку `webfrontend`. (Вы можете игнорировать любые запросы по умолчанию на добавление ресурсов отладки или восстановления проекта.)
1. Откройте встроенный терминал в VS Code (выберите **Представление > Интегрированный терминал**).
1. Запустите эту команду (убедитесь, что ваша текущая папка — **webfrontend**):

    ```cmd
    azds prep --public
    ```

Команда `azds prep` Azure CLI создает ресурсы Docker и Kubernetes с параметрами по умолчанию:
* `./Dockerfile` описывает образ контейнера приложения и способ создания и запуска исходного кода в контейнере.
* В [диаграмме Helm](https://docs.helm.sh) в разделе `./charts/webfrontend` описано, как развернуть контейнер в Kubernetes.

Сейчас изучать все содержимое этих файлов не требуется. Однако стоит отметить, что **те же ресурсы Kubernetes и Docker конфигурации как кода, могут использоваться для разработки и производства, обеспечивая тем самым лучшую согласованность в разных средах.**
 
С помощью команды `prep` также создается файл `./azds.yaml`. Он является файлом конфигурации для Azure Dev Spaces. Он предоставляет артефактам Docker и Kubernetes дополнительную конфигурацию, которая обеспечивает последовательную разработку в Azure.

## <a name="build-and-run-code-in-kubernetes"></a>Сборка и запуск кода в Kubernetes
Давайте запустим код! В окне терминала запустите следующую команду из **корневой папки кода**, webfrontend:

```cmd
azds up
```

Следите за выходными данными команды, и по мере ее выполнения вы заметите следующее:
- Исходный код синхронизируется в пространство разработки в Azure.
- Образ контейнера создается в Azure, как указано в ресурсах Docker в вашей папке кода.
- Создаются объекты Kubernetes, использующие образ контейнера в соответствии с диаграммой Helm в вашей папке кода.
- Отображаются сведения о конечной точке контейнера. В нашем случае нам необходим общедоступный URL-адрес HTTP.
- Если приведенные выше этапы выполнены успешно, после запуска контейнера должны отобразиться выходные данные `stdout` (и `stderr`).

> [!Note]
> При первом запуске команды `up` на выполнение этих шагов потребуется больше времени, но последующие запуски должны выполняться быстрее.

### <a name="test-the-web-app"></a>Тестирование веб-приложения
Просмотрите выходные данные консоли, чтобы найти сведения об общедоступном URL-адресе, который был создан командой `up`. Он будет выглядеть следующим образом: 

```
(pending registration) Service 'webfrontend' port 'http' will be available at <url>
Service 'webfrontend' port 'http' is available at http://webfrontend.1234567890abcdef1234.eus.azds.io/
Service 'webfrontend' port 80 (TCP) is available at 'http://localhost:<port>'
```

Определите общедоступный URL-адрес для службы в выходных данных команды `up`. Он заканчивается на `.azds.io`. В нашем примере используется такой общедоступный URL-адрес: `http://webfrontend.1234567890abcdef1234.eus.azds.io/`.

Чтобы просмотреть веб-приложение, откройте общедоступный URL-адрес в браузере. Кроме того, обратите внимание, что выходные данные `stdout` и `stderr` передаются потоком в окно терминала *azds trace* при взаимодействии с веб-приложением. Вы также увидите сведения об отслеживании HTTP-запросов при их прохождении в системе. Это упрощает отслеживание сложных вызовов к нескольким службам во время разработки. Инструментарий, добавленный в Dev Spaces, предоставляет эту возможность отслеживания запросов.

> [!Note]
> Кроме общедоступного URL-адреса можно использовать альтернативный URL-адрес `http://localhost:<portnumber>`, который отображается в выходных данных консоли. Если вы используете URL-адрес localhost, может показаться, что контейнер выполняется локально, но фактически он выполняется в Azure. В Azure Dev Spaces используется *перенаправление портов* Kubernetes для сопоставления порта localhost с контейнером, запущенным в AKS. Это облегчает работу со службой на локальном компьютере.

### <a name="update-a-content-file"></a>Обновление файла содержимого
Azure Dev Spaces — это не просто среда выполнения кода в Kubernetes. Она позволяет быстро и итеративно видеть, как изменения вашего кода вступают в силу в среде Kubernetes в облаке.

1. Найдите файл `./public/index.html` и внесите изменения в HTML. Например, можно изменить цвет фона страницы на оттенок синего цвета [в строке 15](https://github.com/Azure/dev-spaces/blob/master/samples/nodejs/getting-started/webfrontend/public/index.html#L15):

    ```html
    <body style="background-color: #95B9C7; margin-left:10px; margin-right:10px;">
    ```

1. Сохраните файл. Через несколько мгновений в окне терминала вы увидите сообщение о том, что файл в запущенном контейнере обновлен.
1. Вернитесь в браузер и обновите страницу. Вы увидите обновление цвета.

Что произошло? Изменение файлов содержимого, таких как HTML и CSS, не требует перезапуска процесса Node.js, поэтому активная команда `azds up` автоматически синхронизирует любые измененные файлы содержимого непосредственно в запущенный контейнер в Azure, тем самым обеспечивая быстрый способ проверки изменений содержимого.

### <a name="test-from-a-mobile-device"></a>Тестирование с мобильного устройства
Откройте веб-приложение на мобильном устройстве с помощью общедоступного URL-адреса для webfrontend. Чтобы не вводить длинный адрес, можно скопировать и отправить URL-адрес с рабочего стола на устройство. Когда веб-приложение загрузится на мобильном устройстве, вы заметите, что пользовательский интерфейс не отображается должным образом на устройстве небольшого размера.

Чтобы исправить проблему, добавьте мета-тег `viewport`:
1. Откройте файл `./public/index.html`.
1. Добавьте метатег `viewport` в имеющийся элемент `head`, который начинается [в строке 6](https://github.com/Azure/dev-spaces/blob/master/samples/nodejs/getting-started/webfrontend/public/index.html#L6):

    ```html
    <head>
        <!-- Add this line -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    ```

1. Сохраните файл.
1. Обновите браузер своего устройства. Теперь веб-приложение будет отображаться должным образом. 

Это пример того, что некоторые проблемы невозможно выявить, пока вы не протестируете приложение на устройствах, для которых оно предназначено. В Azure Dev Spaces вы можете быстро выполнять итерации кода и проверять любые изменения на целевых устройствах.

### <a name="update-a-code-file"></a>Обновление файла кода
Для обновления файлов кода на стороне сервера требуется немного больше работы, потому что приложение Node.js необходимо перезапустить.

1. В окне терминала нажмите клавишу `Ctrl+C` (чтобы остановить `azds up`).
1. Откройте файл кода с именем `server.js` и измените приветственное сообщение службы: 

    ```javascript
    res.send('Hello from webfrontend running in Azure!');
    ```

3. Сохраните файл.
1. Запустите `azds up` в окне терминала. 

Эта команда перестроит образ контейнера и повторно развернет диаграмму Helm. Перезагрузите страницу браузера, чтобы увидеть, как изменения вашего кода вступают в силу.

Но есть еще один *более быстрый метод* разработки кода, который вы рассмотрите в следующем разделе. 

## <a name="debug-a-container-in-kubernetes"></a>Отладка контейнера в Kubernetes

В этом разделе используется VS Code для прямой отладки контейнера, работающего в Azure. Также вы узнаете, как быстрее вносить изменения, выполнять тестирование и запуск.

![](media/common/edit-refresh-see.png)

> [!Note]
> **Если на каком-то этапе у вас возникли трудности**, см. статью [Устранение неполадок](troubleshooting.md) или оставьте комментарий на этой странице.

### <a name="initialize-debug-assets-with-the-vs-code-extension"></a>Инициализация ресурсов отладки с помощью расширения VS Code
Сначала необходимо настроить проект кода, чтобы редактор VS Code мог взаимодействовать со средой разработки в Azure. Расширение VS Code для Azure Dev Spaces содержит вспомогательную команду для настройки конфигурации отладки. 

Откройте **палитру команд** (с помощью меню **Вид | Палитра команд**), включите автоматическое завершение ввода и выберите эту команду: `Azure Dev Spaces: Prepare configuration files for Azure Dev Spaces`. 

В папку `.vscode` будет добавлена конфигурация отладки для Azure Dev Spaces. Не следует путать эту команду с командой `azds prep`, которая позволяет настроить проект для развертывания.

![](media/common/command-palette.png)

### <a name="select-the-azds-debug-configuration"></a>Выбор конфигурации отладки AZDS
1. Чтобы открыть представление отладки, щелкните значок "Отладка" на **панели действия** сбоку VS Code.
1. Выберите **Launch Program (AZDS)** (Запустить программу (AZDS)) как активную конфигурацию отладки.

![](media/get-started-node/debug-configuration-nodejs2.png)

> [!Note]
> Если вы не видите никаких команд Azure Dev Spaces на палитре команд, убедитесь, что вы [установили расширение VS Code для Azure Dev Spaces](get-started-nodejs.md#get-kubernetes-debugging-for-vs-code).

### <a name="debug-the-container-in-kubernetes"></a>Отладка контейнера в Kubernetes
Нажмите клавишу **F5**, чтобы отладить ваш код в Kubernetes.

Подобно команде `up`, код синхронизируется со средой разработки при запуске отладки, и выполняется сборка и развертывание контейнера в Kubernetes. На этот раз отладчик подключен к удаленному контейнеру.

> [!Tip]
> Строка состояния VS Code станет оранжевой. Это указывает на то, что отладчик подключен. Кроме того, появится интерактивный URL-адрес, который можно использовать для быстрого открытия сайта.

![](media/common/vscode-status-bar-url.png)

Установите точку останова в файле кода на стороне сервера, например в `app.get('/api'...` в [строке 13`server.js`](https://github.com/Azure/dev-spaces/blob/master/samples/nodejs/getting-started/webfrontend/server.js#L13). 

    ```javascript
    app.get('/api', function (req, res) {
        res.send('Hello from webfrontend');
    });
    ```

Обновите страницу браузера или нажмите кнопку *Say It Again* (Повторить это), и вы достигнете точки останова и сможете осуществить пошаговое выполнение кода.

У вас есть полный доступ к отладочной информации, как если бы код выполнялся локально, например к стеку вызовов, локальным переменным, информации об исключениях и т. д.

### <a name="edit-code-and-refresh-the-debug-session"></a>Изменение кода и обновление сеанса отладки
Измените код при активном отладчике. Например, еще раз измените приветствие в [строке 13`server.js`](https://github.com/Azure/dev-spaces/blob/master/samples/nodejs/getting-started/webfrontend/server.js#L13):

```javascript
app.get('/api', function (req, res) {
    res.send('**** Hello from webfrontend running in Azure! ****');
});
```

Сохраните файл и в области **действий отладки** нажмите кнопку **Restart** (Обновить). 

![](media/common/debug-action-refresh.png)

Вместо повторной сборки и развертывания нового образа контейнера при каждой правке кода, что часто занимает немало времени, Azure Dev Spaces перезапустит процесс Node.js между сеансами отладки, чтобы ускорить цикл правки и отладки.

Обновите веб-приложение в браузере или нажмите кнопку *Say It Again* (Повторить это). Вы должны увидеть настраиваемое сообщение в пользовательском интерфейсе.

### <a name="use-nodemon-to-develop-even-faster"></a>Использование NodeMon для ускоренной разработки
*Nodemon* — это популярное средство, которое разработчики Node.js используют для быстрой разработки. Вместо того чтобы вручную перезапускать процесс Node при каждой правке кода на стороне сервера, разработчики часто настраивают в проекте Node средство *nodemon*, которое отслеживает изменения файла и автоматически перезапускает процесс сервера. В таком режиме работы разработчик просто обновляет браузер после внесения изменений в код.

В Azure Dev Spaces вы можете использовать много тех же рабочих процессов разработки, которые вы используете при локальной разработке. Чтобы проиллюстрировать этот принцип, в примере проекта `webfrontend` используется *nodemon* (он настроен как зависимость разработки в `package.json`).

Попробуйте сделать следующее.
1. Остановите отладчик VS Code.
1. Щелкните значок "Отладка" в **строке действий** в боковой части VS Code. 
1. Выберите **Attach (AZDS)** (Присоединить (AZDS)) как активную конфигурацию отладки.
1. Нажмите клавишу F5.

В этой конфигурации контейнер настроен запускать *nodemon*. При внесении изменений в код сервера *nodemon* автоматически перезапускает процесс Node, как при локальной разработке. 
1. Измените сообщение hello снова на `server.js` и сохраните файл.
1. Обновите браузер или нажмите кнопку *​​Say It Again* (Повторить это), чтобы увидеть свои изменения.

**Теперь у вас есть метод быстрой итерации кода и отладки непосредственно в Kubernetes**. Далее вы узнаете, как создать и вызвать второй контейнер.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Узнайте больше о разработке с использованием нескольких служб](multi-service-nodejs.md)


[supported-regions]: about.md#supported-regions-and-configurations