---
title: Настройка удостоверения Azure Active Directory для Azure API для FHIR
description: Узнайте о принципах идентификации, проверки подлинности и авторизации для серверов Azure FHIR.
services: healthcare-apis
author: caitlinv39
ms.reviewer: matjazl
ms.service: healthcare-apis
ms.subservice: fhir
ms.topic: conceptual
ms.date: 02/19/2019
ms.author: cavoeg
ms.openlocfilehash: cdb73670996341e9219230bb277e087009266f32
ms.sourcegitcommit: 7fe8df79526a0067be4651ce6fa96fa9d4f21355
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2020
ms.locfileid: "87846026"
---
# <a name="azure-active-directory-identity-configuration-for-azure-api-for-fhir"></a>Настройка удостоверения Azure Active Directory для Azure API для FHIR

Важным элементом при работе с данными здравоохранения является обеспечение безопасности данных и недоступность неавторизованных пользователей или приложений. Серверы FHIR используют [OAuth 2,0](https://oauth.net/2/) для обеспечения безопасности данных. [API Azure для FHIR](https://azure.microsoft.com/services/azure-api-for-fhir/) защищен с помощью [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/), который является примером поставщика удостоверений OAuth 2,0. В этой статье представлен обзор авторизации сервера FHIR и действия, необходимые для получения маркера для доступа к серверу FHIR. Хотя эти действия применимы к любому FHIR серверу и любому поставщику удостоверений, мы рассмотрим API Azure для FHIR в качестве сервера FHIR и Azure AD в качестве поставщика удостоверений в этой статье.

## <a name="access-control-overview"></a>Общие сведения о контроле доступа

Чтобы клиентское приложение мог получить доступ к API Azure для FHIR, оно должно предоставить маркер доступа. Маркер доступа — это подписанный набор свойств (утверждений) в кодировке [Base64](https://en.wikipedia.org/wiki/Base64) , который передает сведения об удостоверении клиента, ролях и привилегиях, предоставленных клиенту.

Получить маркер можно несколькими способами, но API Azure для FHIR не волнует, как получен маркер, если он является соответствующим подписанным маркером с правильными утверждениями. 

Используя [поток кода авторизации](https://docs.microsoft.com/azure/active-directory/develop/v1-protocols-oauth-code) в качестве примера, доступ к серверу FHIR проходит через четыре следующих шага:

![Авторизация FHIR](media/azure-ad-hcapi/fhir-authorization.png)

1. Клиент отправляет запрос в `/authorize` конечную точку Azure AD. Azure AD перенаправит клиент на страницу входа, где пользователь будет проходить проверку подлинности, используя соответствующие учетные данные (например, имя пользователя и пароль или двухфакторная проверка подлинности). См. Дополнительные сведения о [получении кода авторизации](https://docs.microsoft.com/azure/active-directory/develop/v1-protocols-oauth-code#request-an-authorization-code). После успешной проверки подлинности клиенту возвращается *код авторизации* . Azure AD разрешит возврат этого кода авторизации только в зарегистрированный URL-адрес ответа, настроенный в регистрации клиентского приложения (см. ниже).
1. Клиентское приложение обменивается кодом авторизации для *маркера доступа* в `/token` КОНЕЧНОЙ точке Azure AD. При запросе маркера клиентскому приложению может потребоваться предоставить секрет клиента (пароль приложения). См. Дополнительные сведения о [получении маркера доступа](https://docs.microsoft.com/azure/active-directory/develop/v1-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token).
1. Клиент выполняет запрос к API Azure для FHIR, например `GET /Patient` для поиска всех пациентов. При выполнении запроса он включает маркер доступа в заголовке HTTP-запроса, например `Authorization: Bearer eyJ0e...` , где `eyJ0e...` представляет маркер доступа в кодировке Base64.
1. API Azure для FHIR проверяет, что маркер содержит соответствующие утверждения (свойства в токене). Если все проверяется, запрос завершается и возвращается пакет FHIR с результатами клиенту.

Важно отметить, что API Azure для FHIR не участвует в проверке учетных данных пользователя и не выдает маркер. Проверка подлинности и создание маркера выполняется Azure AD. API Azure для FHIR просто проверяет правильность подписи маркера (он подлинно) и наличие соответствующих утверждений.

## <a name="structure-of-an-access-token"></a>Структура маркера доступа

Разработка приложений FHIR часто включает в себя отладку проблем доступа. Если клиенту отказано в доступе к API Azure для FHIR, то полезно разобраться в структуре маркера доступа и о том, как ее можно декодировать для проверки содержимого (утверждений) маркера. 

Серверы FHIR обычно предполагают [JSON Web Token](https://en.wikipedia.org/wiki/JSON_Web_Token) (JWT, иногда произносится "кратко"). Он состоит из трех частей:

1. Заголовок, который может выглядеть следующим образом:
    ```json
    {
      "alg": "HS256",
      "typ": "JWT"
    }
    ```
1. Полезные данные (утверждения), например:
    ```json
    {
     "oid": "123",
     "iss": "https://issuerurl",
     "iat": 1422779638,
     "roles": [
        "admin"
      ]
    }
    ```
1. Сигнатура, которая вычисляется путем сцепления содержимого заголовка и полезных данных в кодировке Base64 и вычисления криптографического хэша для них на основе алгоритма ( `alg` ), указанного в заголовке. Сервер сможет получить открытые ключи от поставщика удостоверений и проверить, был ли этот маркер выдан конкретным поставщиком удостоверений и что он не был изменен.

Полный маркер состоит из версий этих трех сегментов в кодировке Base64 (на самом деле это URL-адрес в кодировке Base64). Три сегмента объединяются и разделяются символом `.` (точкой).

Пример маркера показан ниже:

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvaWQiOiIxMjMiLCAiaXNzIjoiaHR0cHM6Ly9pc3N1ZXJ1cmwiLCJpYXQiOjE0MjI3Nzk2MzgsInJvbGVzIjpbImFkbWluIl19.gzSraSYS8EXBxLN_oWnFSRgCzcmJmMjLiuyu5CSpyHI
```

Маркер можно декодировать и проанализировать с помощью таких средств, как [https://jwt.ms](https://jwt.ms) . Результат декодирования токена:

```json
{
  "alg": "HS256",
  "typ": "JWT"
}.{
  "oid": "123",
  "iss": "https://issuerurl",
  "iat": 1422779638,
  "roles": [
    "admin"
  ]
}.[Signature]
```

## <a name="obtaining-an-access-token"></a>Получение маркера доступа

Как упоминалось выше, существует несколько способов получить маркер из Azure AD. Они подробно описаны в [документации для разработчиков Azure AD](https://docs.microsoft.com/azure/active-directory/develop/).

В Azure AD есть две разные версии конечных точек OAuth 2,0, которые называются `v1.0` и `v2.0` . Обе эти версии являются конечными точками OAuth 2,0, `v1.0` а `v2.0` конструкции и соответствуют различиям в реализации этого стандарта в Azure AD. 

При использовании сервера FHIR можно использовать `v1.0` `v2.0` конечные точки или. Этот вариант может зависеть от библиотек проверки подлинности, которые используются в клиентском приложении.

Соответствующие разделы документации по Azure AD:

* Конечная точка `v1.0`:
    * [Поток кода авторизации](https://docs.microsoft.com/azure/active-directory/develop/v1-protocols-oauth-code).
    * [Поток учетных данных клиента](https://docs.microsoft.com/azure/active-directory/develop/v1-oauth2-client-creds-grant-flow).
* Конечная точка `v2.0`:
    * [Поток кода авторизации](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow).
    * [Поток учетных данных клиента](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow).

Существуют другие варианты (например, от имени потока) для получения маркера. Дополнительные сведения см. в документации по Azure AD. При использовании API Azure для FHIR также есть несколько сочетаний клавиш для получения маркера доступа (для отладки) [с помощью Azure CLI](get-healthcare-apis-access-token-cli.md).

## <a name="next-steps"></a>Дальнейшие шаги

В этом документе вы узнали некоторые основные понятия, связанные с обеспечением безопасности доступа к API Azure для FHIR с помощью Azure AD. Чтобы узнать, как развернуть экземпляр API Azure для FHIR, перейдите к краткому руководству по развертыванию.

>[!div class="nextstepaction"]
>[Развертывание Azure API для FHIR](fhir-paas-portal-quickstart.md)