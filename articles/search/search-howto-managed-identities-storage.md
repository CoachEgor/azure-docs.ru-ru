---
title: Настройка подключения к учетной записи хранения с использованием управляемого удостоверения (предварительная версия)
titleSuffix: Azure Cognitive Search
description: Сведения о том, как настроить подключение индексатора к учетной записи хранения Azure с использованием управляемого удостоверения (предварительная версия)
manager: luisca
author: markheff
ms.author: maheff
ms.devlang: rest-api
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 05/18/2020
ms.openlocfilehash: 1fa9581f1a7968a1bfd6df0fb82383dd45e70f54
ms.sourcegitcommit: fdec8e8bdbddcce5b7a0c4ffc6842154220c8b90
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2020
ms.locfileid: "83663182"
---
# <a name="set-up-a-connection-to-an-azure-storage-account-using-a-managed-identity-preview"></a>Настройка подключения к учетной записи хранения Azure с использованием управляемого удостоверения (предварительная версия)

> [!IMPORTANT] 
> Поддержка настройки подключения к источнику данных с использованием управляемого удостоверения в настоящее время предоставляется в общедоступной предварительной версии. Для предварительной версии функции соглашение об уровне обслуживания не предусмотрено. Мы не рекомендуем использовать ее в рабочей среде.
> Чтобы запросить доступ к предварительной версии этой функции, заполните [эту форму](https://aka.ms/azure-cognitive-search/mi-preview-request).

На этой странице описывается, как настроить подключение индексатора к учетной записи хранения Azure с использованием управляемого удостоверения вместо того, чтобы добавлять учетные данные в строку подключения к объекту источника данных.

Перед изучением этой функции желательно иметь представление о том, что такое индексатор и как настроить индексатор для источника данных. Дополнительные сведения см. в следующих статьях:
* [Обзор индексатора](search-indexer-overview.md)
* [Индексатор BLOB-объектов](search-howto-indexing-azure-blob-storage.md)
* [Индексатор Azure Data Lake Storage 2-го поколения](search-howto-index-azure-data-lake-storage.md)
* [Индексатор таблиц Azure](search-howto-indexing-azure-tables.md)

## <a name="set-up-the-connection"></a>Настройка подключения

### <a name="1---turn-on-system-assigned-managed-identity"></a>1\. Включение управляемого удостоверения, назначаемого системой

Если включено управляемое удостоверение, назначаемое системой, в Azure создастся удостоверение для службы поиска, которое можно использовать для проверки подлинности в других службах Azure для того же клиента и той же подписки. Это удостоверение вы можете использовать в назначениях для управления доступом на основе ролей (RBAC), чтобы разрешить доступ к данным на время индексирования.

![Включение управляемого удостоверения, назначаемого системой](./media/search-managed-identities/turn-on-system-assigned-identity.png "Включение управляемого удостоверения, назначаемого системой")

Нажав кнопку **Сохранить**, вы увидите идентификатор объекта, назначенный вашей службе поиска.

![Идентификатор объекта](./media/search-managed-identities/system-assigned-identity-object-id.png "Идентификатор объекта.")
 
### <a name="2---add-a-role-assignment"></a>2\. Добавление назначения роли

На этом шаге вы предоставите службе "Когнитивный поиск Azure" разрешение на чтение данных из учетной записи хранения.

1. На портале Azure перейдите к учетной записи хранения, которая содержит данные для индексирования.
2. Выберите **Управление доступом (IAM)**
3. Щелкните **Добавить** и **Добавить назначение роли**.

    ![Добавление назначения роли](./media/search-managed-identities/add-role-assignment-storage.png "Добавление назначения роли")

4. Выберите нужные роли в зависимости от типа учетной записи хранения, которую вы намерены индексировать.
    1. Для хранилища BLOB-объектов Azure службу поиска нужно добавить в роли для **чтения и доступа к данным** и **чтения данных BLOB-объекта хранилища**.
    1. Для Azure Data Lake Storage 2-го поколения службу поиска нужно добавить в роли для **чтения и доступа к данным** и **чтения данных BLOB-объекта хранилища**.
    1. Для хранилища таблиц службу поиска нужно добавить в роль для **чтения и доступа к данным**.
5.  В поле **Назначение доступа к** сохраните выбранное значение **Пользователь, группа или субъект-служба Azure AD**.
6.  Найдите службу поиска, выберите ее и щелкните **Сохранить**.

    ![Назначение роли для чтения и доступа к данным](./media/search-managed-identities/add-role-assignment-reader-and-data-access.png "Назначение роли для чтения и доступа к данным")

Обратите внимание, что при подключении к хранилищу BLOB-объектов Azure или Azure Data Lake Storage 2-го поколения необходимо назначить еще и роль для **чтения данных BLOB-объектов хранилища**.

![Назначение роли для чтения данных BLOB-объектов хранилища](./media/search-managed-identities/add-role-assignment-storage-blob-data-reader.png "Назначение роли для чтения данных BLOB-объектов хранилища")

### <a name="3---create-the-data-source"></a>3\. Создание источника данных

Если индексация выполняется по учетной записи хранения, источник данных должен иметь следующие обязательные свойства:

* Свойство **name** — уникальное имя источника данных в службе поиска.
* **type**
    * Хранилище BLOB-объектов Azure: `azureblob`.
    * Хранилище таблиц Azure: `azuretable`.
    * Azure Data Lake Storage 2-го поколения: **тип** предоставляется после регистрации на использование предварительной версии через [эту форму](https://aka.ms/azure-cognitive-search/mi-preview-request).
* **credentials**
    * Если для проверки подлинности используется управляемое удостоверение, формат **учетных данных** отличается от того, который используется без управляемого удостоверения. Здесь вы предоставите ResourceId без ключа учетной записи и пароля. ResourceId должен содержать идентификатор подписки для учетной записи хранения, группу ресурсов для учетной записи хранения и имя учетной записи хранения.
    * Формат управляемого удостоверения: 
        * *ResourceId=/subscriptions/**идентификатор_подписки**/resourceGroups/**имя_группы_ресурсов**/providers/Microsoft.Storage/storageAccounts/**имя_учетной_записи_хранения**/;* .
* Свойство **container** определяет контейнер или таблицу в учетной записи хранения. По умолчанию все большие двоичные объекты в контейнере доступны для извлечения. Если требуется индексирование больших двоичных объектов из определенного виртуального каталога, можно указать этот каталог с помощью дополнительного параметра **query**.

Пример для создания большого двоичного объекта в качестве источника данных с помощью [REST API](https://docs.microsoft.com/rest/api/searchservice/create-data-source):

```
POST https://[service name].search.windows.net/datasources?api-version=2019-05-06
Content-Type: application/json
api-key: [admin key]

{
    "name" : "blob-datasource",
    "type" : "azureblob",
    "credentials" : { "connectionString" : "ResourceId=/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/resource-group-name/providers/Microsoft.Storage/storageAccounts/storage-account-name/;" },
    "container" : { "name" : "my-container", "query" : "<optional-virtual-directory-name>" }
}   
```

Портал Azure и [пакет SDK для .NET](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.models.datasource?view=azure-dotnet) также поддерживают строку подключения с управляемым удостоверением. Для портала Azure требуется флаг компонента. Он будет предоставлен после регистрации на использование предварительной версии, которую можно выполнить по ссылке в начале этой страницы. 

### <a name="4---create-the-index"></a>4\. Создание индекса

Индекс задает поля в документе, атрибуты, и другие компоненты, которые определяют процедуру поиска.

Ниже описан процесс создания индекса с доступным для поиска полем `content` для хранения текста, извлеченного из больших двоичных объектов:   

    POST https://[service name].search.windows.net/indexes?api-version=2019-05-06
    Content-Type: application/json
    api-key: [admin key]

    {
          "name" : "my-target-index",
          "fields": [
            { "name": "id", "type": "Edm.String", "key": true, "searchable": false },
            { "name": "content", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": false, "facetable": false }
          ]
    }

Дополнительные сведения о создании индексов см. в статье [Create Index](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса).

### <a name="5---create-the-indexer"></a>5\. Создание индексатора

Индексатор соединяет источник данных с целевым индексом поиска и предоставляет расписание для автоматизации обновления данных.

Когда индекс и источник данных будут созданы, можно создать индексатор.

Пример определения индексатора для BLOB-объектов:

    POST https://[service name].search.windows.net/indexers?api-version=2019-05-06
    Content-Type: application/json
    api-key: [admin key]

    {
      "name" : "blob-indexer",
      "dataSourceName" : "blob-datasource",
      "targetIndexName" : "my-target-index",
      "schedule" : { "interval" : "PT2H" }
    }

Этот индексатор будет выполняться каждые два часа (интервал расписания имеет значение "PT2H"). Чтобы запускать индексатор каждые 30 минут, задайте интервал "PT30M". Самый короткий интервал, который можно задать, составляет 5 минут. Расписание является необязательным. Если оно не указано, то индексатор выполняется только один раз при его создании. Однако индексатор можно запустить по запросу в любое время.   

Дополнительные сведения об API создания индексатора см. в разделе [Создание индексатора](https://docs.microsoft.com/rest/api/searchservice/create-indexer).

Дополнительные сведения об определении расписания для индексаторов см. в статье [Планирование расписания для индексаторов службы "Когнитивный поиск Azure"](search-howto-schedule-indexers.md).

## <a name="see-also"></a>См. также раздел

Дополнительные сведения об индексаторах службы хранилища Azure:
* [Индексатор BLOB-объектов](search-howto-indexing-azure-blob-storage.md)
* [Индексатор Azure Data Lake Storage 2-го поколения](search-howto-index-azure-data-lake-storage.md)
* [Индексатор таблиц Azure](search-howto-indexing-azure-tables.md)
