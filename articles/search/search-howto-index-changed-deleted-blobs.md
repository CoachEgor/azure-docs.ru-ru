---
title: Измененные и удаленные BLOB-объекты
titleSuffix: Azure Cognitive Search
description: После создания исходного индекса поиска, который импортирует данные из хранилища BLOB-объектов Azure, последующее индексирование может занимать только те большие двоичные объекты, которые были изменены или удалены. В этой статье описываются подробные сведения.
manager: nitinme
author: MarkHeff
ms.author: maheff
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 09/25/2020
ms.openlocfilehash: 2e73039418233c97fc20242ed7af7df14c5b47ee
ms.sourcegitcommit: f5580dd1d1799de15646e195f0120b9f9255617b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91534783"
---
# <a name="how-to-set-up-change-and-deletion-detection-for-blobs-in-azure-cognitive-search-indexing"></a>Как настроить обнаружение изменений и удалений для больших двоичных объектов в Azure Когнитивный поиск индексирование

После создания исходного индекса поиска может потребоваться настроить последующие задания индексатора, чтобы отобрать только те документы, которые были созданы или удалены с момента начального запуска. Для поиска содержимого, полученного из хранилища BLOB-объектов Azure, обнаружение изменений происходит автоматически при использовании расписания для активации индексирования. По умолчанию служба переиндексирует только измененные большие двоичные объекты, как определено меткой времени большого двоичного объекта `LastModified` . В отличие от других источников данных, поддерживаемых индексаторами поиска, большие двоичные объекты всегда имеют метку времени, что устраняет необходимость ручной настройки политики обнаружения изменений.

Несмотря на то, что обнаружение изменений задано, обнаружение удаления не является. Если вы хотите обнаружить удаленные документы, обязательно используйте метод обратимого удаления. Если просто удалить большие двоичные объекты, соответствующие документы останутся в индексе поиска.

Существует два способа реализации подхода обратимого удаления. Ниже описаны оба варианта.

## <a name="native-blob-soft-delete-preview"></a>Нативная функция обратимого удаления большого двоичного объекта (предварительная версия)

> [!IMPORTANT]
> Поддержка обратимого удаления больших двоичных объектов доступна в предварительной версии. Для предварительной версии функции соглашение об уровне обслуживания не предусмотрено. Мы не рекомендуем использовать ее в рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). Эта функция доступна в [REST API версии 2020-06-30-Preview](./search-api-preview.md) . В настоящее время нет поддержки портала или пакета SDK для .NET.

> [!NOTE]
> При использовании политики обратимого удаления BLOB-объектов ключи документов для документов в индексе должны быть свойством большого двоичного объекта или метаданными большого двоичного объекта.

В этом методе будет использоваться [собственная функция обратимого удаления больших двоичных объектов](../storage/blobs/soft-delete-blob-overview.md) , предоставляемая хранилищем BLOB-объектов Azure. Если в вашей учетной записи хранения включено встроенное обратимое удаление BLOB-объектов, то в источнике данных будет установлена собственная политика обратимого удаления, и индексатор обнаружит большой двоичный объект, который был перенесен в обратимо Удаленное состояние, индексатор удалит этот документ из индекса. Политика обратимого удаления больших двоичных объектов не поддерживается при индексировании больших двоичных объектов из Azure Data Lake Storage 2-го поколения.

Выполните следующие шаги.

1. Включите [встроенное обратимое удаление для хранилища BLOB-объектов Azure](../storage/blobs/soft-delete-blob-overview.md). Рекомендуется задать для политики хранения значение, превышающее расписание интервала индексатора. Таким образом, если возникла проблема с индексатором или если имеется большое количество документов для индексирования, то в конечном итоге индексатор будет обрабатывать обратимо удаленные большие двоичные объекты. Индексаторы Когнитивный поиск Azure удаляют документ из индекса, только если он обрабатывает большой двоичный объект, когда он находится в обратимо удаленном состоянии.

1. Настройте собственную политику обнаружения обратимого удаления больших двоичных объектов в источнике данных. Ниже приведен пример такого файла. Так как эта функция находится на этапе предварительной версии, необходимо использовать предварительную версию REST API.

1. Запустите индексатор или задайте выполнение индексатора по расписанию. Когда индексатор запускается и обрабатывает большой двоичный объект, документ будет удален из индекса.

    ```http
    PUT https://[service name].search.windows.net/datasources/blob-datasource?api-version=2020-06-30-Preview
    Content-Type: application/json
    api-key: [admin key]
    {
        "name" : "blob-datasource",
        "type" : "azureblob",
        "credentials" : { "connectionString" : "<your storage connection string>" },
        "container" : { "name" : "my-container", "query" : null },
        "dataDeletionDetectionPolicy" : {
            "@odata.type" :"#Microsoft.Azure.Search.NativeBlobSoftDeleteDeletionDetectionPolicy"
        }
    }
    ```

### <a name="reindexing-un-deleted-blobs-using-native-soft-delete-policies"></a>Повторное индексирование неудаленных больших двоичных объектов (с использованием собственных политик обратимого удаления)

При удалении большого двоичного объекта из хранилища BLOB-объектов Azure с включенным встроенным обратимым удалением в вашей учетной записи хранения большой двоичный объект перейдет в обратимо Удаленное состояние, что позволит отменить удаление этого большого двоичного объекта в течение срока хранения. Если отменить удаление после его обработки индексатором, индексатор не всегда будет индексировать восстановленный большой двоичный объект. Это обусловлено тем, что индексатор определяет, какие большие двоичные объекты следует индексировать, на основе метки времени большого двоичного объекта `LastModified` . При отмене удаления обратимо удаляемого большого двоичного объекта его `LastModified` Метка времени не обновляется, поэтому, если индексатор уже обрабатывал большие двоичные объекты с более последними `LastModified` отметками времени, он не будет повторно индексировать неудаленный большой двоичный объект. 

Чтобы гарантировать повторное индексирование неудаленного большого двоичного объекта, необходимо обновить метку времени BLOB-объекта `LastModified` . Один из способов сделать это — повторное сохранение метаданных этого большого двоичного объекта. Вам не нужно изменять метаданные, но при повторном сохранении метаданных будет обновлена метка времени большого двоичного объекта, `LastModified` чтобы индексатор знал, что ему нужно переиндексировать этот большой двоичный объект.

## <a name="soft-delete-using-custom-metadata"></a>Обратимое удаление с помощью пользовательских метаданных

В этом методе вы будете использовать метаданные большого двоичного объекта, чтобы указать, когда документ должен быть удален из индекса поиска. Этот метод требует два отдельных действия: Удаление документа поиска из индекса, за которым следует удаление большого двоичного объекта в службе хранилища Azure.

Выполните следующие шаги.

1. Добавьте пару "ключ — значение" пользовательских метаданных в большой двоичный объект, чтобы указать Когнитивный поиск Azure логически удалена.

1. Настройте политику обнаружения столбцов обратимого удаления в источнике данных. Ниже приведен пример такого файла.

1. После того как индексатор обработал большой двоичный объект и удалил документ из индекса, можно удалить большой двоичный объект в хранилище BLOB-объектов Azure.

Например, в соответствии с приведенной ниже политикой большой двоичный объект считается удаленным, если у него есть свойство метаданных `IsDeleted` со значением `true`.

```http
    PUT https://[service name].search.windows.net/datasources/blob-datasource?api-version=2020-06-30
    Content-Type: application/json
    api-key: [admin key]

    {
        "name" : "blob-datasource",
        "type" : "azureblob",
        "credentials" : { "connectionString" : "<your storage connection string>" },
        "container" : { "name" : "my-container", "query" : null },
        "dataDeletionDetectionPolicy" : {
            "@odata.type" :"#Microsoft.Azure.Search.SoftDeleteColumnDeletionDetectionPolicy",
            "softDeleteColumnName" : "IsDeleted",
            "softDeleteMarkerValue" : "true"
        }
    }
```

### <a name="reindexing-un-deleted-blobs-using-custom-metadata"></a>Повторное индексирование неудаленных больших двоичных объектов (с помощью пользовательских метаданных)

После того как индексатор обрабатывает удаленный большой двоичный объект и удаляет соответствующий документ поиска из индекса, он не будет повторно посещать этот большой двоичный объект, если он будет восстановлен позже, если отметка времени большого двоичного объекта `LastModified` старше, чем последний запуск индексатора.

Если вы хотите переиндексировать этот документ, измените `"softDeleteMarkerValue" : "false"` для этого большого двоичного объекта и повторно запустите индексатор.

## <a name="help-us-make-azure-cognitive-search-better"></a>Помогите нам сделать Azure Когнитивный поиск лучше

Если вам нужна какая-либо функция или у вас есть идеи, которые можно было бы реализовать, сообщите об этом на [сайте UserVoice](https://feedback.azure.com/forums/263029-azure-search/). Если вам нужна помощь с использованием существующего компонента, опубликуйте свой вопрос на [Stack overflow](https://stackoverflow.microsoft.com/questions/tagged/18870).

## <a name="next-steps"></a>Дальнейшие действия

* [Indexers in Azure Cognitive Search](search-indexer-overview.md) (Индексаторы в службе "Когнитивный поиск Azure")
* [Настройка индексатора больших двоичных объектов](search-howto-indexing-azure-blob-storage.md)
* [Общие сведения об индексировании BLOB-объектов](search-blob-storage-integration.md)