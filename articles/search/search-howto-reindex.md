---
title: Перестроение индекса поиска
titleSuffix: Azure Cognitive Search
description: Добавьте новые элементы, обновите существующие элементы или документы или удалите устаревшие документы при полной пересборке или частичной индексации, чтобы обновить индекс Когнитивный поиск Azure.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: 18cfa3c6fde399ea61e09c5788c72ce20e5570e8
ms.sourcegitcommit: 380e3c893dfeed631b4d8f5983c02f978f3188bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2020
ms.locfileid: "75754391"
---
# <a name="how-to-rebuild-an-index-in-azure-cognitive-search"></a>Как перестроить индекс в Azure Когнитивный поиск

В этой статье объясняется, как перестроить индекс Azure Когнитивный поиск, обстоятельства, при которых требуется перестроение, и рекомендации по устранению последствий перестроения текущих запросов.

*Перестроение* — это удаление и повторное создание структур физических данных, связанных с индексом, включая все индексы, инвертированные на основе поля. В Когнитивный поиск Azure нельзя удалять и повторно создавать отдельные поля. Для перестроения индекса все хранилище полей необходимо удалить, создать заново на основе существующей или измененной схемы индексов, а затем повторно заполнить их данными, отправленными в индекс или полученными из внешних источников. Обычно индексы перестраиваются во время разработки, но иногда требуется перестроить индекс рабочего уровня в соответствии со структурными изменениями, например при добавлении сложных типов или полей в средства подбора.

В отличие от перестроения индекса в автономном режиме *обновление данных* выполняется как фоновая задача. Вы можете добавить, удалить и заменить документы с минимальными нарушениями рабочих нагрузок запросов, хотя запросы могут выполняться дольше. Дополнительные сведения об обновлении содержимого индекса см. в статье [Добавление, обновление и удаление документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents).

## <a name="rebuild-conditions"></a>Условия перестроения

| Условие | Description |
|-----------|-------------|
| Изменение определения поля | Если вы меняете имя поля, тип данных или определенные [атрибуты индекса](https://docs.microsoft.com/rest/api/searchservice/create-index) (с возможностью поиска, фильтрации, сортировки или поддержкой аспектов), требуется полная перестройка. |
| Присвоение полю анализатора | [Анализаторы](search-analyzers.md) определяются в индексе, а затем присваиваются полям. Вы можете добавить новое определение анализатора в индекс в любое время, но *присвоить* анализатор можно только при создании поля. Это касается обоих свойств: **analyzer** и **indexAnalyzer**. Свойство **searchAnalyzer** является исключением (его можно присвоить уже существующему полю). |
| Обновление или удаление определения анализатора в индексе | Удалить или изменить существующую конфигурацию анализатора (анализатор, создатель маркеров, фильтр маркеров или фильтр символов) можно, только перестроив весь индекс. |
| Добавление поля в средство подбора | Чтобы добавить уже существующее поле в конструкцию [средств подбора](index-add-suggesters.md), необходимо перестроить индекс. |
| Удаление поля | Чтобы физически удалить все следы поля, необходимо перестроить индекс. Если перестроить индекс сейчас неудобно, можно изменить код приложения, чтобы отключить доступ к удаленному полю. Физически определение и содержимое поля сохраняются в индексе до следующей перестройки с использованием схемы, в которой это поле отсутствует. |
| Смена уровня | Если требуется дополнительная емкость, обновление на месте в портал Azure отсутствует. Должна быть создана новая служба, и индексы должны быть построены с нуля на новой службе. Чтобы автоматизировать этот процесс, вы можете использовать пример кода с **индексом резервного копирования и восстановления** в этом [репозитории примера Azure когнитивный Поиск .NET](https://github.com/Azure-Samples/azure-search-dotnet-samples). Это приложение будет выполнять резервное копирование индекса в ряд JSON-файлов, а затем повторно создать индекс в указанной службе поиска.|

Любые другие изменения могут выполняться без влияния на существующие физические структуры. В частности, следующие изменения *не* требуют перестройки индекса.

+ Добавление нового поля
+ Задание атрибута **Доступный для получения** для существующего поля
+ Задание свойства **searchAnalyzer** для существующего поля
+ Добавление нового определения анализатора в индекс
+ Добавление, обновление или удаление профилей повышения
+ Добавление, обновление или удаление параметров CORS
+ Добавление, обновление или удаление synonymMaps

Когда вы добавляете новое поле, во всех существующих в индексе документах новому полю присваивается значение null. При обновлении данных в будущем значения из внешних исходных данных заменяются значениями NULL, добавленными Когнитивный поиск Azure. Дополнительные сведения об обновлении содержимого индекса см. в статье [Добавление, обновление и удаление документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents).

## <a name="partial-indexing"></a>Частичное индексирование

В Когнитивный поиск Azure вы не можете управлять индексацией для каждого поля, выбрав удаление или повторное создание конкретных полей. Аналогичным образом, нет встроенного механизма для [индексирования документов на основе критериев](https://stackoverflow.com/questions/40539019/azure-search-what-is-the-best-way-to-update-a-batch-of-documents). Любые требования к индексированию на основе критериев должны быть выполнены с помощью пользовательского кода.

Но вы можете легко *обновить документы* в индексе. Во многих решениях для поиска внешние исходные данные являются временными и синхронизация между исходными данными и индексом поиска — это распространенная практика. В коде вызовите операцию [Добавление, обновление и удаление документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) или [эквивалент для .NET](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.indexesoperationsextensions.createorupdate?view=azure-dotnet), чтобы обновить содержимое индекса или добавить значения для нового поля.

## <a name="partial-indexing-with-indexers"></a>Частичное индексирование с помощью индексаторов

[Индексаторы](search-indexer-overview.md) упрощают задачу обновления данных. Индексатор может проиндексировать только одну таблицу или представление во внешнем источнике данных. Чтобы проиндексировать несколько таблиц, проще всего создать представление, которое объединяет таблицы и проецирует столбцы, подлежащие индексированию. 

При использовании индексаторов, сканирующих внешние источники данных, проверьте столбец максимального использования в источнике данных. Если таковой существует, его можно использовать для обнаружения последовательных изменений путем выбора только строк с новым или измененным содержанием. Для [хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md#incremental-indexing-and-deletion-detection) используется поле `lastModified`. В [хранилище таблиц Azure](search-howto-indexing-azure-tables.md#incremental-indexing-and-deletion-detection) эти функции выполняет `timestamp`. В [индексаторе для Базы данных SQL Azure](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#capture-new-changed-and-deleted-rows) и [индексаторе для Azure Cosmos DB](search-howto-index-cosmosdb.md#indexing-changed-documents) также используются поля, обозначающие обновление строки. 

Дополнительную информацию об индексаторах см. в разделах [Обзор индексаторов](search-indexer-overview.md) и [REST API сброса индексатора](https://docs.microsoft.com/rest/api/searchservice/reset-indexer).

## <a name="how-to-rebuild-an-index"></a>Как перестроить индекс

Частое полное перестроение следует выполнять в период активной разработки, пока схемы индексов еще не полностью определены. Для приложений, которые уже находятся в рабочей среде, рекомендуется создать новый индекс, который выполняется параллельно существующему, чтобы избежать простоя запроса.

Для обновления индекса нужны разрешения на чтение и запись на уровне службы. 

Перестроить индекс на портале невозможно. На программном уровне вы можете вызвать [REST API для обновления индекса](https://docs.microsoft.com/rest/api/searchservice/update-index) или [эквивалентный API .NET](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.iindexesoperations.createorupdatewithhttpmessagesasync?view=azure-dotnet) для полной перестройки. Запрос на обновление индекса идентичен описанному для [REST API для создания индекса](https://docs.microsoft.com/rest/api/searchservice/create-index), но имеет другой контекст.

Описанный далее процесс используется для REST API, но его также можно использовать для пакета SDK для .NET.

1. При повторном использовании имени индекса [удалите существующий индекс](https://docs.microsoft.com/rest/api/searchservice/delete-index). 

   Все запросы, предназначенные для этого индекса, немедленно удаляются. Удаление индекса является необратимой операцией, при которой уничтожается физическое хранилище для коллекции полей и другие конструкции. Убедитесь, что понимаете последствия удаления индекса, прежде чем удалять его. 

2. Сформулируйте запрос на [обновление индекса](https://docs.microsoft.com/rest/api/searchservice/update-index), указав конечную точку службы, ключ API и [ключ администратора](https://docs.microsoft.com/azure/search/search-security-api-keys). Ключ администратора необходим для операций записи.

3. В тексте запроса предоставьте схему индекса с измененными определениями полей. Текст запроса содержит схему индекса, а также конструкции для профилей повышения, анализаторов, средств подбора и параметров CORS. Требования к схеме описаны в разделе [Создание индекса](https://docs.microsoft.com/rest/api/searchservice/create-index).

4. Отправьте запрос на [обновление индекса](https://docs.microsoft.com/rest/api/searchservice/update-index) , чтобы перестроить физическое выражение индекса в когнитивный Поиск Azure. 

5. [Загрузите индекс с документами](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) из внешнего источника.

При создании индекса физическое хранилище выделяется для каждого поля в схеме индекса, и для каждого поля с поддержкой поиска создается инвертированный индекс. Поля, не поддерживающие поиск, можно использовать в фильтрах или выражениях, но у них нет инвертированных индексов и они недоступны для поиска по полному тексту или нечеткому соответствию. При перестроении индекса эти инвертированные индексы удаляются и создаются снова на основе предоставленной схемы индекса.

Когда вы загружаете индекс, инвертированный индекс каждого поля заполняется всеми уникальными маркированными словами из каждого документа с сопоставлением по идентификаторам соответствующих документов. Например, при индексировании набора данных гостиницы инвертированный индекс для поля "Город" может содержать условия для значений "Сиэтл", "Портленд" и т. д. Для документов, содержащих "Сиэтл" или "Портленд" в поле "Город", будет указан идентификатор рядом с условием поиска. При любой операции [добавления, обновления или удаления](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents) условия поиска и список идентификаторов документов обновляются соответствующим образом.

> [!NOTE]
> Если у вас строгие требования к уровню обслуживания, подготовьте новую службу специально для этой работы, чтобы разработка и индексирование выполнялись в полной изоляции от индекса в рабочей среде. Это отдельная служба выполняется на своем оборудовании, устраняя возможное состязание ресурсов. По завершении разработки можно либо оставить новый индекс на месте, перенаправлять запросы в новую конечную точку и индекс, либо запустить готовый код для публикации измененного индекса в исходной службе Azure Когнитивный поиск. В настоящее время отсутствует механизм для перемещения готового индекса в другую службу.

## <a name="view-updates"></a>Просмотр обновлений

Вы можете отправлять запросы к индексу сразу после загрузки первого документа. Если вы знаете идентификатор документа, [API REST поиска по документу](https://docs.microsoft.com/rest/api/searchservice/lookup-document) возвращает определенный документ. Для более подробного тестирования подождите полной загрузки индекса, а затем используйте запросы, чтобы проверить контекст, который вы ожидаете увидеть.

## <a name="see-also"></a>См. также

+ [Обзор индексатора](search-indexer-overview.md)
+ [Индексирование с поддержкой горизонтального масштабирования в службе "Поиск Azure"](search-howto-large-index.md)
+ [Импорт данных в службу поиска Azure с помощью портала](search-import-data-portal.md)
+ [Индексатор Базы данных SQL Azure](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md)
+ [Индексатор Azure Cosmos DB](search-howto-index-cosmosdb.md)
+ [Индексатор хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md)
+ [Индексатор хранилища таблиц Azure](search-howto-indexing-azure-tables.md)
+ [Безопасность в Azure Когнитивный поиск](search-security-overview.md)