---
title: Настройка кэша и постепенного обогащения (предварительный просмотр)
titleSuffix: Azure Cognitive Search
description: Включите кэширование и сохраните состояние обогащенного контента для контролируемой обработки в когнитивном наборе навыков. Эта функция сейчас доступна в виде общедоступной предварительной версии.
author: vkurpad
manager: eladz
ms.author: vikurpad
ms.service: cognitive-search
ms.devlang: rest-api
ms.topic: conceptual
ms.date: 01/06/2020
ms.openlocfilehash: 66bac2a063a3257a2101ca2f30e5946264adb9ae
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "76989558"
---
# <a name="how-to-configure-caching-for-incremental-enrichment-in-azure-cognitive-search"></a>Как настроить кэширование для поэтапного обогащения в Azure Cognitive Search

> [!IMPORTANT] 
> Инкрементное обогащение в настоящее время находится в публичном предварительном просмотре. Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). Эта функция предоставляется в [версии REST API 2019-05-06-Preview](search-api-preview.md). В настоящее время нет портала или поддержки .NET SDK.

В этой статье показано, как добавить кэширование в конвейер обогащения, чтобы можно было постепенно изменять шаги без необходимости перестраиваться каждый раз. По умолчанию набор навыков является апостером, и изменение любой части его состава требует полного повтора индекса. При поэтапном обогащении индексатор может определить, какие части дерева документа необходимо обновлять на основе изменений, обнаруженных в определениях skillset или индекса. Существующие обработанные выходы сохраняются и используются повторно, где это возможно. 

Кэшированный контент размещается в хранилище Azure с использованием информации об учетной записи, которую вы предоставляете. Контейнер, названный, `ms-az-search-indexercache-<alpha-numerc-string>`создается при запуске индекса. Он должен считаться внутренним компонентом, управляемым поисковой службой, и не должен быть изменен.

Если вы не знакомы с настройкой индексеров, начните с [обзора индекса,](search-indexer-overview.md) а затем перейти к [skillsets,](cognitive-search-working-with-skillsets.md) чтобы узнать о конвейерах обогащения. Для получения дополнительной информации о ключевых концепциях, [см.](cognitive-search-incremental-indexing-conceptual.md)

## <a name="enable-caching-on-an-existing-indexer"></a>Включить кэширование на существующем индексаторе

Если у вас есть существующий индексер, который уже имеет набор навыков, выполните последующие действия в этом разделе, чтобы добавить кэширование. В качестве одноразовой операции необходимо сбросить и перезапустить индексатор в полном объеме, прежде чем инкрементная обработка может всрстать.

> [!TIP]
> В качестве доказательства концепции, вы можете запустить через этот [портал quickstart](cognitive-search-quickstart-blob.md) для создания необходимых объектов, а затем использовать Почтальон или портал, чтобы сделать обновления. Возможно, вы захотите прикрепить оплачиваемый ресурс Когнитивных Услуг. Запуск индекса несколько раз исчерпает бесплатное ежедневное распределение, прежде чем вы сможете завершить все шаги.

### <a name="step-1-get-the-indexer-definition"></a>Шаг 1: Получить определение индекса

Начните с действительного существующего индекса, который имеет эти компоненты: источник данных, набор навыков, индекс. Ваш индексатор должен быть запущенным. 

Используя клиент API, постройте [запрос GET Indexer,](https://docs.microsoft.com/rest/api/searchservice/get-indexer) чтобы получить текущую конфигурацию индекса. При использовании версии API предварительного просмотра `cache` для индекса GET к определениям добавляется набор свойств, чтобы свести к нулю.

```http
GET https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]?api-version=2019-05-06-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
```

Копируйте определение индексара из ответа.

### <a name="step-2-modify-the-cache-property-in-the-indexer-definition"></a>Шаг 2: Изменить свойство кэша в определении индекса

По умолчанию свойство `cache` является недействительным. Используйте клиент API для настройки конфигурации кэша (портал не поддерживает это обновление твердых частиц). 

Измените объект кэша, чтобы включить следующие необходимые и дополнительные свойства: 

+ Требуется строка `storageConnectionString` подключения к хранилищам Azure. 
+ Свойство `enableReprocessing` boolean неявляется (по`true` умолчанию), и это указывает на то, что дополнительное обогащение включено. При необходимости можно настроить `false` его на приостановку инкрементной обработки, в то время как другие `true` ресурсоемкие операции, такие как индексация новых документов, ведутся, а затем переворачивают ее на более поздний срок.

```json
{
    "name": "<YOUR-INDEXER-NAME>",
    "targetIndexName": "<YOUR-INDEX-NAME>",
    "dataSourceName": "<YOUR-DATASOURCE-NAME>",
    "skillsetName": "<YOUR-SKILLSET-NAME>",
    "cache" : {
        "storageConnectionString" : "<YOUR-STORAGE-ACCOUNT-CONNECTION-STRING>",
        "enableReprocessing": true
    },
    "fieldMappings" : [],
    "outputFieldMappings": [],
    "parameters": []
}
```

### <a name="step-3-reset-the-indexer"></a>Шаг 3: Сбросить индексер

Перезагрузка индекса требуется при настройке постепенного обогащения для существующих индексаторов, чтобы убедиться, что все документы находятся в постоянном состоянии. Для выполнения этой задачи можно использовать портал или клиент API и [API Reset Indexer REST.](https://docs.microsoft.com/rest/api/searchservice/reset-indexer)

```http
POST https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]/reset?api-version=2019-05-06-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
```

### <a name="step-4-save-the-updated-definition"></a>Шаг 4: Сохранить обновленное определение

[Обновление индекса](https://docs.microsoft.com/rest/api/searchservice/2019-05-06-preview/update-indexer) с помощью запроса PUT, тело запроса должно содержать обновленное определение индекса, которое имеет свойство кэша. Если вы получаете 400, проверьте определение индекса, чтобы убедиться, что все требования выполнены (источник данных, набор навыков, индекс).

```http
PUT https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]?api-version=2019-05-06-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
{
    "name" : "<YOUR-INDEXER-NAME>",
    ...
    "cache": {
        "storageConnectionString": "<YOUR-STORAGE-ACCOUNT-CONNECTION-STRING>",
        "enableReprocessing": true
    }
}
```

Если теперь вы выдали другой запрос GET на индексаторе, ответ службы будет включать свойство `ID` в объекте кэша. Строка alphanumeric придаёна к названию контейнера, содержащего все кэшированные результаты и промежуточное состояние каждого документа, обрабатываемого этим индексатором. Идентификатор будет использоваться для однозначного имени кэша в хранилище Blob.

    "cache": {
        "ID": "<ALPHA-NUMERIC STRING>",
        "enableReprocessing": true,
        "storageConnectionString": "DefaultEndpointsProtocol=https;AccountName=<YOUR-STORAGE-ACCOUNT>;AccountKey=<YOUR-STORAGE-KEY>;EndpointSuffix=core.windows.net"
    }

### <a name="step-5-run-the-indexer"></a>Шаг 5: Выполнить индексер

Для запуска индекса можно использовать портал или API. На портале из списка индексеров выберите индексатор и нажмите **Run**. Одним из преимуществ использования портала является то, что вы можете отслеживать состояние индекса, отмечать продолжительность задания и количество документов. Страницы портала обновляются каждые несколько минут.

Кроме того, можно использовать REST для [запуска индексатора:](https://docs.microsoft.com/rest/api/searchservice/run-indexer)

```http
POST https://[YOUR-SEARCH-SERVICE].search.windows.net/indexers/[YOUR-INDEXER-NAME]/run?api-version=2019-05-06-Preview
Content-Type: application/json
api-key: [YOUR-ADMIN-KEY]
```

После запуска индекса можно найти кэш в хранилище Azure Blob. Название контейнера находится в следующем формате:`ms-az-search-indexercache-<YOUR-CACHE-ID>`

> [!NOTE]
> Сбросить и перезапустить индексер приводит к полной перестройке, так что содержимое может быть кэшировано. Все когнитивные обогащения будут повторена на всех документах.
>

### <a name="step-6-modify-a-skillset-and-confirm-incremental-enrichment"></a>Шаг 6: Изменить набор навыков и подтвердить постепенное обогащение

Чтобы изменить набор навыков, можно использовать портал или API. Например, если вы используете текстовый перевод, `en` `es` достаточно простого встраиваемого изменения с другого языка или другого языка для проверки концепции поэтапного обогащения.

Запустите указатель снова. Обновляются только те части обогащенного дерева документов. Если вы использовали [быстрый запуск портала](cognitive-search-quickstart-blob.md) в качестве доказательства концепции, изменяя навыки перевода текста на 'es', вы заметите, что только 8 документов обновляются вместо исходных 14. Файлы изображений, не затронутые процессом перевода, повторно используются из кэша.

## <a name="enable-caching-on-new-indexers"></a>Включить кэширование на новых индексаторах

Чтобы настроить инкрементное обогащение для нового индекса, все, что вам нужно сделать, это включить `cache` свойство в полезную нагрузку определения индекса при [вызове Create Indexer (2019-05-06-Preview)](https://docs.microsoft.com/rest/api/searchservice/2019-05-06-preview/create-indexer). 


```json
{
    "name": "<YOUR-INDEXER-NAME>",
    "targetIndexName": "<YOUR-INDEX-NAME>",
    "dataSourceName": "<YOUR-DATASOURCE-NAME>",
    "skillsetName": "<YOUR-SKILLSET-NAME>",
    "cache" : {
        "storageConnectionString" : "<YOUR-STORAGE-ACCOUNT-CONNECTION-STRING>",
        "enableReprocessing": true
    },
    "fieldMappings" : [],
    "outputFieldMappings": [],
    "parameters": []
    }
}
```

## <a name="checking-for-cached-output"></a>Проверка кэшированного вывода

Кэш создается, используется и управляется индексатором, и его содержимое не представлено в формате, который читается человеком. Лучший способ определить, используется ли кэш, — это запустить индексатор и сравнить показатели до и после выполнения времени выполнения и количества документов. 

Например, предположим набор навыков, который начинается с анализа изображений и оптического распознавания символов (OCR) отсканированных документов, а затем ниже по течению анализа полученного текста. При изменении навыка текста ниже по течению указательный индекс может извлечь из кэша все ранее обработанное изображение и содержимое OCR, обновление и обработку только связанных с текстом изменений, указанных в ваших правках. Вы можете ожидать, чтобы увидеть меньше документов в документе рассчитывать (например, 8/8 по сравнению с 14/14 в первоначальном запуске), короче время выполнения, и меньше расходов на ваш счет.

## <a name="working-with-the-cache"></a>Работа с кэшем

После работы кэша индексы проверяют кэш при вызове [индекса Run Indexer,](https://docs.microsoft.com/rest/api/searchservice/run-indexer) чтобы увидеть, какие части существующего вывода можно использовать. 

В следующей таблице кратко излагается, как различные AAP относятся к кэшу:

| API           | Воздействие кэша     |
|---------------|------------------|
| [Создать индексер (2019-05-06-Preview)](https://docs.microsoft.com/rest/api/searchservice/2019-05-06-preview/create-indexer) | Создает и запускает индексер при первом использовании, включая создание кэша, если определение индекса определяет его. |
| [Запуск индексатора](https://docs.microsoft.com/rest/api/searchservice/run-indexer) | Выполняет конвейер обогащения по требованию. Этот API читается из кэша, если он существует, или создает кэш, если вы добавили кэширование в обновленное определение индекса. При запуске индекса, у которого включен кэширование, индексер опускает шаги, если можно использовать кэшированный выход. Вы можете использовать общедоступную или предварительный Просмотр API версии этого API.|
| [Сброс индексатора](https://docs.microsoft.com/rest/api/searchservice/reset-indexer)| Очищает индексатор любой инкрементной информации об индексации. Следующим запуском индекса (либо по требованию, либо по расписанию) является полная переработка с нуля, включая перезапуск всех навыков и восстановление кэша. Это функционально эквивалентно удалением индекса и его воссозданию. Вы можете использовать общедоступную или предварительный Просмотр API версии этого API.|
| [Навыки сработки (2019-05-06-Preview)](https://docs.microsoft.com/rest/api/searchservice/2019-05-06-preview/reset-skills) | Определяет, какие навыки необходимо перезапустить при следующем запуске индекса, даже если вы не изменили никаких навыков. Кэш обновляется соответствующим образом. Выходы, такие как хранилище знаний или индекс поиска, обновляются с использованием многоразовых данных из кэша плюс нового содержимого для обновленного навыка. |

Для получения дополнительной информации о контроле за тем, что происходит с кэшом, [см.](cognitive-search-incremental-indexing-conceptual.md#cache-management)

## <a name="next-steps"></a>Дальнейшие действия

Инкрементное обогащение применимо к индексам, которые содержат навыки. В качестве следующего шага, посетите skillset документации, чтобы понять концепции и состав. 

Кроме того, как только вы включите кэш, вы хотите знать о параметрах и AI, которые фактор в кэширование, в том числе о том, как переопределить или заставить частности поведения. Дополнительные сведения см. по следующим ссылкам.

+ [Концепции и композиция skillset](cognitive-search-working-with-skillsets.md)
+ [Как создать набор навыков](cognitive-search-defining-skillset.md)
+ [Введение в инкрементное обогащение и кэширование](cognitive-search-incremental-indexing-conceptual.md)
