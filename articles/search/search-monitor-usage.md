---
title: Мониторинг операций и действий
titleSuffix: Azure Cognitive Search
description: Включите ведение журнала, получите метрики действий запросов, использование ресурсов и другие системные данные из службы Когнитивный поиск Azure.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/15/2020
ms.openlocfilehash: 5846e9516548032595c1ce072d1dae8dcce9d39e
ms.sourcegitcommit: 6e87ddc3cc961945c2269b4c0c6edd39ea6a5414
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2020
ms.locfileid: "77443607"
---
# <a name="monitor-operations-and-activity-of-azure-cognitive-search"></a>Мониторинг операций и активности Когнитивный поиск Azure

В этой статье рассматривается наблюдение на уровне службы (ресурсов) на уровне рабочей нагрузки (запросы и индексирование) и предлагается платформа для мониторинга доступа пользователей.

В разных спектрах используется сочетание встроенной инфраструктуры и базовых служб, таких как Azure Monitor, а также API служб, которые возвращают статистику, счетчики и состояние. Понимание диапазона возможностей может помочь создать цикл обратной связи, чтобы можно было решить проблемы по мере их возникновения.

## <a name="use-azure-monitor"></a>Использование Azure Monitor

Многие службы, включая Когнитивный поиск Azure, используют [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/) для оповещений, метрик и ведения журнала диагностических данных. Для Когнитивный поиск Azure Встроенная инфраструктура мониторинга используется в основном для мониторинга уровня ресурсов (работоспособности службы) и [мониторинга запросов](search-monitor-queries.md).

На следующем снимке экрана показано, как можно выбрать компоненты Azure Monitor на портале.

+ Вкладка **мониторинг** , расположенная на главной странице Обзор, наглядно показывает основные метрики.
+ **Журнал действий**, представленный ниже в обзоре, содержит отчеты о действиях на уровне ресурсов: работоспособность службы и уведомления о запросах ключей API.
+ **Мониторинг**. Далее в списке приводятся настраиваемые оповещения, метрики и журналы диагностики. Создавайте их при необходимости. После сбора и сохранения данных можно запросить или визуализировать информацию для получения ценных сведений.

![Интеграция Azure Monitor в службу поиска](./media/search-monitor-usage/azure-monitor-search.png
 "Интеграция Azure Monitor в службу поиска")

### <a name="precision-of-reported-numbers"></a>Точность сообщаемых чисел

Страницы портала обновляются каждые несколько минут. Таким образом, числа, сообщаемые на портале, являются приблизительными, предоставляющих общее представление о том, насколько хорошо система обслуживает запросы. Фактические метрики, например запросы в секунду (QPS), могут быть выше или ниже числа, указанного на странице.

## <a name="activity-logs-and-service-health"></a>Журналы действий и работоспособность службы

[**Журнал действий**](https://docs.microsoft.com/azure/azure-monitor/platform/activity-log-view) собирает сведения из Azure Resource Manager и сообщает об изменениях в работоспособности службы. Журнал действий можно отслеживать для критических условий, ошибок и предупреждений, относящихся к работоспособности служб.

Для выполнения таких задач, как запросы, индексирование или создание объектов, вы увидите общие информационные уведомления, такие как *Получение ключа администратора* и *получение ключей запроса* для каждого запроса, но не само действие. Чтобы получить сведения об этом детализации, необходимо настроить ведение журнала диагностики.

Вы можете получить доступ к **журналу действий** из области навигации слева, с помощью уведомления на панели команд в верхнем окне или на странице **Диагностика и решение проблем**.

## <a name="monitor-storage"></a>Мониторинг хранилища

Страницы с вкладками, встроенные на страницу обзора, сообщают об использовании ресурсов. Эта информация становится доступной сразу после начала использования службы без какой-либо настройки и обновления страницы каждые несколько минут. 

Если вы принимаете решения о том, [какой уровень выбрать для производственных рабочих нагрузок](search-sku-tier.md), или о том, следует ли [изменить число активных реплик и секций](search-capacity-planning.md), эти метрики помогут вам, так как они показывают, насколько быстро используются ресурсы и насколько хорошо текущая конфигурация справляется с текущей нагрузкой.

Оповещения, связанные с хранилищем, в настоящее время недоступны; потребление хранилища не будет агрегировано или входить в таблицу **азуреметрикс** в Azure Monitor. Вам потребуется создать пользовательское решение, которое выдает уведомления, связанные с ресурсами, где код проверяет размер хранилища и обрабатывает ответ. Дополнительные сведения о метриках хранилища см. в статье [Получение статистики службы](https://docs.microsoft.com/rest/api/searchservice/get-service-statistics#response).

Для визуального мониторинга на портале на вкладке **Использование** отображаются сведения о доступности ресурсов относительно текущих [ограничений](search-limits-quotas-capacity.md) , накладываемых уровнем служб. 

На следующем рисунке показана служба ценовой категории "Бесплатный", которая ограничена 3 объектами каждого типа и 50 МБ памяти. Службы ценовых категории "Базовый" и "Стандартный" обеспечивают больше ресурсов, а при увеличении числа секций максимальный размер хранилища пропорционально возрастает.

![Состояние использования относительно ограничений уровня](./media/search-monitor-usage/usage-tab.png
 "Состояние использования относительно ограничений уровня")

## <a name="monitor-workloads"></a>Мониторинг рабочих нагрузок

Записанные в журнал события включают связанные с индексированием и запросами. Таблица **AzureDiagnostics** в log Analytics собирает операционные данные, связанные с запросами и индексацией.

Большая часть данных журнала предназначена для операций только для чтения. Для других операций создания, обновления и удаления, которые не фиксируются в журнале, можно запросить сведения о системе в службе поиска.

| OperationName | Description |
|---------------|-------------|
| сервицестатс | Эта операция является обычным вызовом для [получения статистики службы](https://docs.microsoft.com/rest/api/searchservice/get-service-statistics), которая вызывается напрямую или неявно для заполнения страницы обзора портала при ее загрузке или обновлении. |
| Запрос. Поиск |  Запросы к индексу см. в разделе [мониторинг запросов](search-monitor-queries.md) на наличие сведений о зарегистрированных запросах.|
| Индексирование. индекс  | Эта операция является вызовом для [добавления, обновления или удаления документов](https://docs.microsoft.com/rest/api/searchservice/addupdate-or-delete-documents). |
| индексирует. Эскиз | Это индекс, созданный мастером импорта данных. |
| Индексаторы. Create | Явное или неявное создание индексатора с помощью мастера импорта данных. |
| Индексаторы. Get | Возвращает имя индексатора при каждом запуске индексатора. |
| Индексаторы. состояние | Возвращает состояние индексатора при каждом запуске индексатора. |
| Источники данных. Get | Возвращает имя источника данных при каждом запуске индексатора.|
| Индексы. Get | Возвращает имя индекса при каждом запуске индексатора. |

### <a name="kusto-queries-about-workloads"></a>Kusto запросы о рабочих нагрузках

Если ведение журнала включено, можно запросить **AzureDiagnostics** , чтобы получить список операций, которые выполнялись в службе и в каких случаях. Можно также сопоставить действие для исследования изменений производительности.

#### <a name="example-list-operations"></a>Пример. Вывод списка операций 

Возвращает список операций и количество каждого из них.

```
AzureDiagnostics
| summarize count() by OperationName
```

#### <a name="example-correlate-operations"></a>Пример: корреляция операций

Сопоставьте запрос с операциями индексирования и визуализируйте точки данных на диаграмме времени, чтобы увидеть совпадающие операции.

```
AzureDiagnostics
| summarize OperationName, Count=count()
| where OperationName in ('Query.Search', 'Indexing.Index')
| summarize Count=count(), AvgLatency=avg(DurationMs) by bin(TimeGenerated, 1h), OperationName
| render timechart
```

### <a name="use-search-apis"></a>Использование API-интерфейсов поиска

Как REST API Когнитивный поиск Azure, так и пакет SDK для .NET предоставляют программный доступ к метрикам служб, индексам и сведениям о индексаторах и количестве документов.

+ [ПОЛУЧЕНИЕ статистики службы](/rest/api/searchservice/get-service-statistics)
+ [ПОЛУЧЕНИЕ статистики индекса](/rest/api/searchservice/get-index-statistics)
+ [Получение количества документов](/rest/api/searchservice/count-documents)
+ [ПОЛУЧЕНИЕ состояния индексатора](/rest/api/searchservice/get-indexer-status)

## <a name="monitor-user-access"></a>Мониторинг доступа пользователей

Поскольку индексы поиска являются компонентом более крупного клиентского приложения, нет встроенной методики для управления доступом к индексу для каждого пользователя или наблюдения за ним. Предполагается, что запросы поступают из клиентского приложения для запросов администратора или запроса. Административные операции чтения и записи включают создание, обновление и удаление объектов во всей службе. Операции только для чтения — это запросы к коллекции Documents, областью действия которых является один индекс. 

Таким образом, вы увидите в журналах действий ссылки на вызовы с помощью ключей администратора или ключей запросов. Соответствующий ключ включается в запросы, исходящие из клиентского кода. Служба не поддерживает обработку токенов идентификации или олицетворения.

При наличии бизнес-требований для авторизации на уровне пользователя рекомендация заключается в интеграции с Azure Active Directory. Можно использовать $filter и удостоверения пользователей, чтобы [обрезать результаты поиска](search-security-trimming-for-azure-search-with-aad.md) документов, которые не должны видеть пользователь. 

Не существует способа записи этой информации отдельно от строки запроса, включающей параметр $filter. Подробные сведения о строках запросов см. в разделе [мониторинг запросов](search-monitor-queries.md) .

## <a name="next-steps"></a>Дальнейшие действия

Владение с Azure Monitor важно для получения сведений о любой службе Azure, включая такие ресурсы, как Azure Когнитивный поиск. Если вы не знакомы с Azure Monitor, уделите время для просмотра статей, связанных с ресурсами. В дополнение к руководствам лучше всего начать с следующей статьи.

> [!div class="nextstepaction"]
> [Мониторинг ресурсов Azure с помощью Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/insights/monitor-azure-resource)
