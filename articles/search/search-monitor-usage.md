---
title: Мониторинг использования ресурсов и метрик запросов
titleSuffix: Azure Cognitive Search
description: Включите ведение журнала, получите метрики действий запросов, использование ресурсов и другие системные данные из службы Когнитивный поиск Azure.
manager: nitinme
author: HeidiSteen
ms.author: heidist
tags: azure-portal
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: 7ef868f156ac537cb066f293872f69135c4df25f
ms.sourcegitcommit: db2d402883035150f4f89d94ef79219b1604c5ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/07/2020
ms.locfileid: "77059660"
---
# <a name="monitor-resource-consumption-and-query-activity-in-azure-cognitive-search"></a>Мониторинг потребления ресурсов и действий запросов в Azure Когнитивный поиск

На странице Обзор службы Когнитивный поиск Azure можно просматривать системные данные об использовании ресурсов, метриках запросов и о том, сколько квот доступно для создания большего числа индексов, индексаторов и источников данных. Крое того, с помощью портала можно настроить Log Analytics или другой ресурс для постоянного хранения коллекции данных. 

Настройка журналов удобна для самостоятельной диагностики и сохранения журнала операций. На внутреннем уровне журналы существуют в серверной части короткое время, достаточное для наблюдения и анализа на случай обращения в службу поддержки. Если требуется контроль над данными журналов и доступ к ним, следует установить одно из решений, описанных в этой статье.

В этой статье вы узнаете о возможностях мониторинга, о том, как включить ведение журнала и хранилище журналов, а также о том, как просмотреть содержимое журнала.

## <a name="metrics-at-a-glance"></a>Краткий обзор метрик

В разделах **Использование** и **Мониторинг**, встроенных в страницу "Обзор", содержатся сведения об использовании ресурсов и метриках выполнения запросов. Эта информация становится доступной, как только вы начинаете использовать службу, и не требует каких-либо настроек. Эта страница обновляется каждые несколько минут. Если вы принимаете решения о том, [какой уровень выбрать для производственных рабочих нагрузок](search-sku-tier.md), или о том, следует ли [изменить число активных реплик и секций](search-capacity-planning.md), эти метрики помогут вам, так как они показывают, насколько быстро используются ресурсы и насколько хорошо текущая конфигурация справляется с текущей нагрузкой.

На вкладке **Использование** отображается доступность ресурсов в соответствии с текущими [ограничениями](search-limits-quotas-capacity.md). На следующем рисунке показана служба ценовой категории "Бесплатный", которая ограничена 3 объектами каждого типа и 50 МБ памяти. Службы ценовых категории "Базовый" и "Стандартный" обеспечивают больше ресурсов, а при увеличении числа секций максимальный размер хранилища пропорционально возрастает.

![Состояние использования относительно действующих ограничений](./media/search-monitor-usage/usage-tab.png
 "Состояние использования относительно действующих ограничений")

## <a name="queries-per-second-qps-and-other-metrics"></a>Число запросов в секунду (QPS) и другие метрики

На вкладке **Мониторинг** показаны значения скользящего среднего для метрик, например *числа запросов в секунду* (QPS) для поиска, объединенные по минутам. 
*Задержка поиска*: время, потребовавшееся службе поиска для обработки запросов поиска (данные объединяются по минутам). *Процент регулируемых поисковых запросов* (метрика не показана): процент отрегулированных запросов поиска (данные также объединяются по минутам).

Эти числа являются приблизительными и дают общее представление о том, насколько хорошо система обслуживает запросы. Фактическое значение QPS может быть выше или ниже, чем число, показанное на портале.

![Операций запросов в секунду](./media/search-monitor-usage/monitoring-tab.png "Операций запросов в секунду")

## <a name="activity-logs"></a>Журналы действий

В **журнал действий** записываются сведения из Azure Resource Manager. Например, в журнале действий можно найти сведения о создании или удалении службы, обновлении группы ресурсов, проверке доступности имени или получении ключа доступа к службе для обработки запроса. 

Вы можете получить доступ к **журналу действий** из области навигации слева, с помощью уведомления на панели команд в верхнем окне или на странице **Диагностика и решение проблем**.

Для внутренних задач службы, таких как создание индекса или удаление источника данных, для каждого запроса отображаются универсальные уведомления, например "Get Admin Key" (Получение ключа администратора), но не само действие. Чтобы получить сведения такого уровня, необходимо включить надстройку решения для мониторинга.

## <a name="add-on-monitoring-solutions"></a>Надстройки для мониторинга

Когнитивный поиск Azure не сохраняет данные за пределами объектов, которыми он управляет, а это означает, что данные журнала должны храниться извне. Если вы хотите хранить данные журнала, то можете настроить любой из приведенных ниже ресурсов. 

В следующей таблице сравниваются варианты хранения журналов и добавления глубокого мониторинга операций службы и рабочих нагрузок запросов с помощью Application Insights.

| Ресурс | Используется для |
|----------|----------|
| [Журналы Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/log-query/log-query-overview) | Зарегистрированные в журнале события и метрики запросов, основанные на приведенных ниже схемах. События записываются в рабочую область Log Analytics. Можно выполнять запросы к рабочей области, чтобы получить подробные сведения из журнала. Дополнительные сведения см. в статье [Приступая к работе с журналами Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-viewdata) . |
| [Хранилище BLOB-объектов](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-overview) | Зарегистрированные в журнале события и метрики запросов, основанные на приведенных ниже схемах. События записываются в контейнер больших двоичных объектов и хранятся в JSON-файлах. Используйте редактор JSON, чтобы просмотреть содержимое такого файла.|
| [Концентратор событий](https://docs.microsoft.com/azure/event-hubs/) | Зарегистрированные события и метрики запросов в соответствии со схемами, описанными в этой статье. Выберите этот вариант в качестве альтернативной службы сбора данных для очень больших журналов. |

И Azure Monitor журналы, и хранилище BLOB-объектов доступны в качестве бесплатной службы, чтобы вы могли испытать их бесплатно за время существования подписки Azure. Вы можете бесплатно зарегистрироваться в Application Insights и использовать это решение до тех пор, пока размер данных приложения находится в заданных пределах (чтобы узнать больше, перейдите на [страницу цен](https://azure.microsoft.com/pricing/details/monitor/)).

В следующем разделе описано, как включить и использовать хранилище BLOB-объектов Azure для получения и доступа к данным журнала, созданным операциями Azure Когнитивный поиск.

## <a name="enable-logging"></a>Включение ведения журналов

Ведение журнала для индексирования и рабочих нагрузок запросов по умолчанию отключено и зависит от установленных надстроек для инфраструктуры ведения журнала и долгосрочного внешнего хранилища. Сам по себе сохраняемые данные в Azure Когнитивный поиск — это объекты, которые он создает и управляет, поэтому журналы должны храниться в других местах.

В этом разделе вы узнаете, как использовать хранилище BLOB-объектов для хранения записанных в журнал событий и данных метрик.

1. Если у вас еще нет учетной записи хранения, [создайте ее](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account). Его можно поместить в ту же группу ресурсов, что и Когнитивный поиск Azure, чтобы упростить очистку, если вы хотите удалить все ресурсы, используемые в этом упражнении.

   Ваша учетная запись хранения должна находиться в том же регионе, что и Azure Когнитивный поиск.

2. Откройте страницу "Обзор" для службы поиска. В области навигации слева прокрутите вниз до пункта **мониторинг** и щелкните **параметры диагностики**.

   ![Параметры диагностики](./media/search-monitor-usage/diagnostic-settings.png "Параметры диагностики")

3. Выберите **Добавить параметр диагностики** .

4. Выберите данные, которые требуется экспортировать: журналы, метрики или и то и другое. Его можно скопировать в учетную запись хранения, отправить в концентратор событий или экспортировать в Azure Monitor журналы.

   Для архивации данных в хранилище BLOB-объектов должна существовать только учетная записи хранения. Контейнеры и большие двоичные объекты будут создаваться по мере необходимости при экспорте данных журнала.

   ![Настройка архива хранилища BLOB-объектов](./media/search-monitor-usage/configure-blob-storage-archive.png "Настройка архива хранилища BLOB-объектов")

5. Сохранение профиля

6. Протестируйте ведение журнала, создавая или удаляя объекты (при этом создаются события журнала) и отправляя запросы (они создают данные метрик). 

Ведение журнала будет включено после сохранения профиля. Контейнеры создаются только при наличии действия для записи в журнал или измерения. При копировании в учетную запись хранения данные представляются в формате JSON и размещаются в двух контейнерах:

* insights-logs-operationlogs: для поиска журналов трафика
* insights-metrics-pt1m: для метрик

**Это займет один час, прежде чем контейнеры будут отображаться в хранилище BLOB-объектов. В каждом контейнере имеется один большой двоичный объект (в час).**

Для просмотра этих файлов можно использовать [Visual Studio Code](#download-and-open-in-visual-studio-code) или другой редактор JSON. 

### <a name="example-path"></a>Пример пути

```
resourceId=/subscriptions/<subscriptionID>/resourcegroups/<resourceGroupName>/providers/microsoft.search/searchservices/<searchServiceName>/y=2018/m=12/d=25/h=01/m=00/name=PT1H.json
```

## <a name="log-schema"></a>Схема журнала
Структура больших двоичных объектов, содержащих журналы трафика службы поиска, описана в этом разделе. Каждый большой двоичный объект имеет один корневой объект под названием **records**, который содержит массив объектов журнала. Каждый большой двоичный объект содержит записи о всех операциях, которые выполнялась в течение одного часа.

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| time |DATETIME |"2018-12-07T00:00:43.6872559Z" |Метка времени операции |
| resourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/> MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор вашего ресурса |
| operationName |строка |"Query.Search" |Имя операции |
| operationVersion |строка |"2019-05-06" |Используемая версия API |
| категория |строка |"OperationLogs" |constant |
| resultType |строка |Success |Возможные значения: Success или Failure |
| resultSignature |INT |200 |Код результата HTTP |
| durationMS |INT |50 |Время выполнения операции в миллисекундах |
| properties |объект |См. следующую таблицу |Объект, содержащий данные об операции |

**Схема свойств**

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| Description |строка |"GET /indexes('content')/docs" |Конечная точка операции |
| Запрос |строка |"?search=AzureSearch&$count=true&api-version=2019-05-06" |Параметры запроса |
| Документы |INT |42 |Количество обработанных документов |
| IndexName |строка |"testindex" |Имя индекса, связанного с операцией |

## <a name="metrics-schema"></a>Схема метрик

Метрики записываются для запросов.

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| resourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/>MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор ресурса |
| metricName |строка |"Latency" |имя метрики |
| time |DATETIME |"2018-12-07T00:00:43.6872559Z" |метка времени операции |
| average |INT |64 |Среднее количество необработанных выборок в течение интервала времени метрики |
| minimum |INT |37 |Минимальное количество необработанных выборок в течение интервала времени метрики |
| maximum |INT |78 |Максимальное количество необработанных выборок в течение интервала времени метрики |
| total |INT |258 |Общее количество необработанных выборок в течение интервала времени метрики |
| count |INT |4 |Количество необработанных выборок, использованных для создания метрики |
| timegrain |строка |"PT1M" |Интервал времени в формате метрики ISO 8601 |

Все метрики передают данные с интервалом в одну минуту. Каждая метрика отражает минимальное, максимальное и среднее значения за минуту.

Для метрики SearchQueriesPerSecond минимальным является наименьшее значение числа поисковых запросов в секунду, которое было зарегистрировано за эту минуту. То же относится и к максимальному значению. Средним является совокупное значение за всю минуту.
Представьте такой сценарий: в течение одной минуты может быть одна секунда высокой загрузки, определяющая максимальное значение для SearchQueriesPerSecond, за которой следует 58 секунд средней загрузки, и наконец — одна секунда всего с одним запросом, который определяет минимальное значение.

Для ThrottledSearchQueriesPercentage минимальное, максимальное, среднее и общее значения одинаковы, так как это процент запросов поиска, которые были отрегулированы, от общего числа запросов поиска за одну минуту.

## <a name="download-and-open-in-visual-studio-code"></a>Скачивание и открытие в Visual Studio Code

Для просмотра файла журнала можно использовать любой редактор JSON. Если у вас его нет, мы рекомендуем [Visual Studio Code](https://code.visualstudio.com/download).

1. Откройте колонку "Учетная запись хранения" на портале Azure. 

2. В области навигации слева щелкните **Большие двоичные объекты**. Должны отобразиться контейнеры **insights-logs-operationlogs** и **insights-metrics-pt1m**. Эти контейнеры создаются Когнитивный поиск Azure при экспорте данных журнала в хранилище BLOB-объектов.

3. Разворачивайте иерархию папок, пока не достигнете JSON-файла.  Используйте контекстное меню для скачивания файла.

Откройте скачанный файл в редакторе JSON, чтобы просмотреть содержимое.

## <a name="use-system-apis"></a>Использование системных API
Как REST API Когнитивный поиск Azure, так и пакет SDK для .NET предоставляют программный доступ к метрикам служб, индексам и сведениям о индексаторах и количестве документов.

* [Получение статистики службы](/rest/api/searchservice/get-service-statistics)
* [Получение статистики индексов](/rest/api/searchservice/get-index-statistics)
* [Подсчет документов](/rest/api/searchservice/count-documents)
* [Получение состояния индексатора](/rest/api/searchservice/get-indexer-status)

Сведения о включении мониторинга с помощью PowerShell или Azure CLI см. в документации [здесь](https://docs.microsoft.com/azure/azure-monitor/platform/diagnostic-logs-overview).

## <a name="next-steps"></a>Дальнейшие действия

Более подробные сведения об администрировании службы поиска приведены в статье [Администрирование службы поиска Azure на портале Azure](search-manage.md), а рекомендации по настройке — в статье [Рекомендации по производительности и оптимизации Поиска Azure](search-performance-optimization.md).
