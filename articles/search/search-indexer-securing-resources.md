---
title: Безопасный доступ к ресурсам индексатора
titleSuffix: Azure Cognitive Search
description: Общие сведения о параметрах безопасности на уровне сети для доступа к данным Azure индексаторов в Azure Когнитивный поиск.
manager: nitinme
author: arv100kri
ms.author: arjagann
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 09/07/2020
ms.openlocfilehash: 5075c4858f9584cb19442e19d9009d46d0e00ff8
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "89463717"
---
# <a name="indexer-access-to-data-sources-using-azure-network-security-features"></a>Доступ индексатора к источникам данных с помощью функций сетевой безопасности Azure

Индексаторы Когнитивный поиск Azure могут выполнять исходящие вызовы различных ресурсов Azure во время выполнения. В этой статье объясняются принципы доступа индексатора к ресурсам, если эти ресурсы защищены брандмауэрами IP, частными конечными точками и другими механизмами безопасности на уровне сети. Возможные типы ресурсов, к которым может получить доступ индексатор в обычном запуске, перечислены в следующей таблице.

| Ресурс | Назначение в индексаторе выполнение |
| --- | --- |
| Служба хранилища Azure (большие двоичные объекты, таблицы, ADLS Gen 2) | Источник данных |
| Хранилище Azure (большие двоичные объекты, таблицы) | Навыков (кэширование обогащенных документов и сохранение проекций хранилища знаний) |
| Azure Cosmos DB (различные API) | Источник данных |
| База данных SQL Azure | Источник данных |
| SQL Server на виртуальных машинах IaaS в Azure | Источник данных |
| Управляемые экземпляры SQL | Источник данных |
| Функции Azure | Узел для настраиваемых навыков работы с веб-API |
| Службы Cognitive Services | Прикрепляется к набору навыков, который будет использоваться для выставления счетов за пределами 20 бесплатных документов |

> [!NOTE]
> Ресурс «обогащенная служба», присоединенный к набору навыков, используется для выставления счетов в зависимости от дополнений, выполненных и записанных в индекс поиска. Он не используется для доступа к API-интерфейсы Cognitive Services. Доступ из конвейера обогащения индексатора в API-интерфейсы Cognitive Services происходит через безопасный канал связи, где данные строго шифруются при передаче и никогда не хранятся в неактивных данных.

Клиенты могут защищать эти ресурсы с помощью нескольких механизмов сетевой изоляции, предлагаемых Azure. За исключением служебного ресурса, индексаторы имеют ограниченную возможность доступа ко всем остальным ресурсам, даже если они являются изолированными от сети, описанными в таблице ниже.

| Ресурс | Ограничение IP-адресов | Частная конечная точка |
| --- | --- | ---- |
| Служба хранилища Azure (большие двоичные объекты, таблицы, ADLS Gen 2) | Поддерживается, только если учетная запись хранения и служба поиска находятся в разных регионах. | Поддерживается |
| API Azure Cosmos DB-SQL | Поддерживается | Поддерживается |
| API Azure Cosmos DB-Cassandra, Mongo и Gremlin | Поддерживается | Не поддерживается |
| База данных SQL Azure | Поддерживается | Поддерживается |
| SQL Server на виртуальных машинах IaaS в Azure | Поддерживается | Недоступно |
| Управляемые экземпляры SQL | Поддерживается | Недоступно |
| Функции Azure | Поддерживается | Поддерживается, только для определенных SKU функций Azure |

> [!NOTE]
> Помимо перечисленных выше параметров для учетных записей хранения Azure, защищенных с помощью сети, клиенты могут использовать тот факт, что Azure Когнитивный поиск является [доверенной службой Майкрософт](https://docs.microsoft.com/azure/storage/common/storage-network-security#trusted-microsoft-services). Это означает, что конкретная служба поиска может обходить ограничения виртуальной сети или IP-адресов в учетной записи хранения и иметь доступ к данным в учетной записи хранения, если в учетной записи хранения включен соответствующий контроль доступа на основе ролей. Дополнительные сведения см. в разделе [руководство](search-indexer-howto-access-trusted-service-exception.md). Этот параметр можно использовать вместо маршрута ограничения IP-адресов, если учетная запись хранения или служба поиска не могут быть перемещены в другой регион.

При выборе механизма безопасного доступа, который должен использовать индексатор, учитывайте следующие ограничения.

- [Конечные точки службы](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview) не будут поддерживаться ни для одного ресурса Azure.
- Не удается подготовить службу поиска в определенной виртуальной сети. Эта функция не будет предложена Azure Когнитивный поиск.
- Если индексаторы используют закрытые конечные точки для доступа к ресурсам, может [взиматься дополнительная плата за использование частной связи](https://azure.microsoft.com/pricing/details/search/) .

## <a name="indexer-execution-environment"></a>Среда выполнения индексатора

Индексаторы Когнитивный поиск Azure способны эффективно извлекать содержимое из источников данных, добавлять дополнения к извлеченному содержимому, при необходимости создавая проекции перед записью результатов в индекс поиска. В зависимости от количества обязанностей, назначенных индексатору, оно может выполняться в одной из двух сред:

- Частная среда для определенной службы поиска. Индексаторы, работающие в таких средах, совместно используют ресурсы с другими рабочими нагрузками (например, при помощи индексирования или выполнения запросов к рабочей нагрузке). Обычно в этой среде выполняются только индексаторы, не требующие много ресурсов (например, не используйте набор навыков).
- Среда с несколькими клиентами, в которой размещены индексаторы, которые являются ресурсоемкими ресурсами, например с набором навыков. Ресурсы, требующие ресурсов, работают в этой среде, чтобы обеспечить оптимальную производительность, чтобы обеспечить доступность ресурсов службы поиска для других рабочих нагрузок. Эта многоклиентская среда управляется и защищается Когнитивный поиск Azure, но не требует дополнительных затрат на клиента.

Для любого выполнения индексатора Когнитивный поиск Azure определяет наилучшую среду, в которой будет выполняться индексатор.

## <a name="granting-access-to-indexer-ip-ranges"></a>Предоставление доступа к диапазонам IP-адресов индексатора

Если ресурс, к которому пытается обратиться индексатор, ограничен только определенным набором диапазонов IP-адресов, необходимо расширить набор, включив в него возможные диапазоны IP-адресов, из которых может поступать запрос индексатора. Как упоминалось выше, существуют две возможные среды, в которых индексаторы работают и откуда могут исходить запросы на доступ. Необходимо добавить IP-адреса __обеих__ сред для доступа индексатора к работе.

- Чтобы получить IP-адрес частного окружения службы поиска, `nslookup` (или) полное `ping` доменное имя (FQDN) службы поиска. Например, полное доменное имя службы поиска в общедоступном облаке — `<service-name>.search.windows.net` . Эти сведения доступны на портал Azure.
- IP-адреса для сред с несколькими клиентами доступны через `AzureCognitiveSearch` тег службы. [Теги служб Azure](https://docs.microsoft.com/azure/virtual-network/service-tags-overview) имеют опубликованный диапазон IP-адресов для каждой службы. он доступен через [API обнаружения (Предварительная версия)](https://docs.microsoft.com/azure/virtual-network/service-tags-overview#use-the-service-tag-discovery-api-public-preview) или [загружаемый файл JSON](https://docs.microsoft.com/azure/virtual-network/service-tags-overview#discover-service-tags-by-using-downloadable-json-files). В любом случае диапазоны IP-адресов разбиваются по регионам. Вы можете выбрать диапазоны IP-адресов, назначенные для региона, в котором была подготовлена служба поиска.

Для некоторых источников данных можно напрямую использовать тег службы вместо перечисления списка диапазонов IP-адресов (IP-адрес службы поиска по-прежнему должен использоваться явно). Эти источники данных ограничивают доступ посредством настройки [правила группы безопасности сети](https://docs.microsoft.com/azure/virtual-network/security-overview), которое изначально поддерживает добавление тега службы, в отличие от правил IP, таких как служба хранилища Azure, CosmosDB, Azure SQL и т. д., источники данных, которые поддерживают возможность `AzureCognitiveSearch` непосредственного использования тега службы в дополнение к IP-адресу службы поиска,:

- [SQL Server на виртуальных машинах IaaS](https://docs.microsoft.com/azure/search/search-howto-connecting-azure-sql-iaas-to-azure-search-using-indexers#restrict-access-to-the-azure-cognitive-search)

- [Управляемые экземпляры SQL](https://docs.microsoft.com/azure/search/search-howto-connecting-azure-sql-mi-to-azure-search-using-indexers#verify-nsg-rules)

Подробные сведения описаны в разделе [руководство](search-indexer-howto-access-ip-restricted.md).

## <a name="granting-access-via-private-endpoints"></a>Предоставление доступа через частные конечные точки

Индексаторы могут использовать [частные конечные точки](https://docs.microsoft.com/azure/private-link/private-endpoint-overview) для доступа к ресурсам, доступ к которым заблокирован либо для выбора виртуальных сетей, либо для отсутствия включенного общего доступа.
Эта функция доступна только для платных служб с ограничениями на количество создаваемых частных конечных точек. Сведения об ограничениях описаны на [странице ограничения поиска Azure](search-limits-quotas-capacity.md).

### <a name="step-1-create-a-private-endpoint-to-the-secure-resource"></a>Шаг 1. Создание частной конечной точки для защищенного ресурса

Клиенты должны вызвать операцию управления поиском, [создать или обновить *общий API ресурсов частной ссылки* ](https://docs.microsoft.com/rest/api/searchmanagement/sharedprivatelinkresources/createorupdate) , чтобы создать подключение к частной конечной точке к защищенному ресурсу (например, учетной записи хранения). Трафик, который проходит через это (исходящее) подключение к частной конечной точке, будет создан только из виртуальной сети, которая находится в среде выполнения индексатора "Private", зависящей от службы поиска.

Azure Когнитивный поиск проверит, что вызывающие объекты этого API имеют разрешения на утверждение закрытых запросов к защищенному ресурсу. Например, если вы запрашиваете подключение частной конечной точки к учетной записи хранения, к которой у вас нет доступа, этот вызов будет отклонен.

### <a name="step-2-approve-the-private-endpoint-connection"></a>Шаг 2. Утверждение подключения к частной конечной точке

Когда асинхронная операция, создающая общий ресурс закрытой ссылки, завершается, подключение к частной конечной точке будет создано в состоянии "ожидание". Трафик еще не проходит через подключение.
Затем клиент должен располагать этот запрос на своем защищенном ресурсе и одобрить его. Как правило, это можно сделать либо с помощью портала, либо с помощью [REST API](https://docs.microsoft.com/rest/api/virtualnetwork/privatelinkservices/updateprivateendpointconnection).

### <a name="step-3-force-indexers-to-run-in-the-private-environment"></a>Шаг 3. принудительное выполнение индексаторов в "частной" среде

Утвержденная частная конечная точка разрешает исходящие вызовы от службы поиска к ресурсу, который имеет некоторую форму ограничений доступа на уровне сети (например, источник данных учетной записи хранения, настроенный на доступ только из определенных виртуальных сетей) для выполнения.
Это означает, что любой индексатор, который может подключиться к такому источнику данных через закрытую конечную точку, будет выполнен.
Если частная конечная точка не утверждена или если индексатор не использует подключение к частной конечной точке, то выполнение индексатора будет завершено в `transientFailure` .

Чтобы разрешить индексаторам доступ к ресурсам через частные конечные точки, необходимо задать для `executionEnvironment` индексатора значение, `"Private"` чтобы гарантировать, что все запущенные индексаторы смогут использовать закрытую конечную точку. Это связано с тем, что частные конечные точки подготавливаются в среде с закрытой службой поиска.

```json
    {
      "name" : "myindexer",
      ... other indexer properties
      "parameters" : {
          ... other parameters
          "configuration" : {
            ... other configuration properties
            "executionEnvironment": "Private"
          }
        }
    }
```

Эти действия более подробно описаны в [руководстве](search-indexer-howto-access-private.md).
После получения утвержденной частной конечной точки для ресурса индексаторы, которые задаются как *частные* , пытаются получить доступ через подключение к частной конечной точке.

### <a name="limits"></a>Ограничения

Для обеспечения оптимальной производительности и стабильности службы поиска ограничения накладываются (SKU службы поиска) по следующим измерениям:

- Типы индексаторов, которые могут быть заданы как *закрытые*.
- Число общих ресурсов частной ссылки, которые могут быть созданы.
- Число уникальных типов ресурсов, для которых могут быть созданы общие ресурсы частной связи.

Эти ограничения описаны в статье [ограничения службы](search-limits-quotas-capacity.md).
