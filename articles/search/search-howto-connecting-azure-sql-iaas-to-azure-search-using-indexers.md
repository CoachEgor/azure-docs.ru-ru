---
title: Подключение Azure S'L VM для индексации поиска
titleSuffix: Azure Cognitive Search
description: Включить зашифрованные соединения и настроить брандмауэр, чтобы можно было подключение к серверу S'L на виртуальном компьютере Azure (VM) от индекса на Azure Cognitive Search.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: 1ab2b7860e8a75da5f8acef2fc4fa54d4b73a30d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80256969"
---
# <a name="configure-a-connection-from-an-azure-cognitive-search-indexer-to-sql-server-on-an-azure-vm"></a>Налажить соединение с индекса когнитивного поиска Azure на сервер S'L на VM Azure

Как отмечалось в [подключении базы данных Azure S'L к индексам Azure Cognitive Search,](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#faq)создание индексов на сервере **S'L на Azure VMs** **(или** на короткое время) поддерживается Azure Cognitive Search, но есть несколько предпосылок, связанных с безопасностью, которые необходимо позаботиться в первую очередь. 

Подключение от Azure Cognitive Search к серверу S'L на VM является общедоступным подключением к Интернету. Все меры безопасности, которые необходимо выполнить для этих подключений, также применяются здесь.

+ Получите сертификат от [поставщика Центра сертификации](https://en.wikipedia.org/wiki/Certificate_authority#Providers) для полного доменного имени экземпляра SQL Server на виртуальной машине Azure.
+ С помощью инструкций, указанных в этой статье, установите сертификат на виртуальную машину, а затем включите и настройте зашифрованные соединения.

## <a name="enable-encrypted-connections"></a>Активация зашифрованных подключений
Azure Cognitive Search требует зашифрованного канала для всех запросов индекса через общедоступное интернет-соединение. В данном разделе перечислены действия, необходимые для выполнения этого требования.

1. Проверьте свойства сертификата, чтобы убедиться, что имя субъекта является полным доменным именем (FQDN) виртуальной машины Azure. Чтобы просмотреть свойства, можно воспользоваться инструментом, таким как CertUtils, или оснасткой диспетчера сертификатов. Полное доменное имя можно найти на **портале Azure** в колонке служб виртуальных машин (в разделе "Основные сведения" в поле [Общедоступный IP-адрес/Метка DNS-имени](https://portal.azure.com/)).
   
   * Для виртуальных машин, созданных с помощью более нового шаблона **Resource Manager**, полное доменное имя имеет формат `<your-VM-name>.<region>.cloudapp.azure.com`.
   * Для более старых виртуальных машин, созданных как **классические** виртуальные машины, полное доменное имя имеет формат `<your-cloud-service-name.cloudapp.net>`.

2. С помощью редактора реестра (regedit) настройте SQL Server для использования сертификата. 
   
    Несмотря на то, что диспетчер конфигурации SQL Server часто используется для данной задачи, его нельзя использовать в этом сценарии. Он не найдет импортированный сертификат, так как полное доменное имя виртуальной машины в Azure не соответствует полному доменному имени, определенному виртуальной машиной (он определяет домен как локальный компьютер или как сетевой домен, к которому он присоединен). Если имена не совпадают, воспользуйтесь редактором реестра, чтобы указать сертификат.
   
   * В редакторе реестра перейдите к разделу реестра: `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\[MSSQL13.MSSQLSERVER]\MSSQLServer\SuperSocketNetLib\Certificate`.
     
     Часть `[MSSQL13.MSSQLSERVER]` зависит от версии и имени экземпляра. 
   * Установите значение ключа **сертификата** к **отпечатку пальца** сертификата TLS/SSL, импортированного в VM.
     
     Есть несколько способов получить это значение отпечатка, из которых некоторые удобнее других. Если скопировать его из оснастки **диспетчера сертификатов** в MMC, то вероятно вы также скопируете невидимый начальный знак, как описано в [этой справочной статье](https://support.microsoft.com/kb/2023869/), что приведет к ошибке при попытке подключения. Для этой проблемы существует несколько обходных решений. Самый простой способ — это стереть клавишей BACKSPACE, а затем повторно ввести первый знак отпечатка, чтобы удалить начальный знак в поле значения ключа в редакторе реестра. Также для копирования отпечатка можно воспользоваться другим инструментом.

3. Предоставьте разрешения учетной записи службы. 
   
    Убедитесь, что учетная запись службы S'L Server получила соответствующее разрешение на частный ключ сертификата TLS/SSL. Если пренебречь этим шагом, то SQL Server не запустится. Для выполнения этой задачи можно использовать оснастку **сертификатов** или инструмент **CertUtils**.
    
4. Перезапустите службу SQL Server.

## <a name="configure-sql-server-connectivity-in-the-vm"></a>Настройка подключения к SQL Server на виртуальной машине
После настройки зашифрованного соединения, необходимого для Azure Cognitive Search, на Azure VMs появляются дополнительные шаги конфигурации, присущие серверу S'L Server. Если это еще не было сделано, то следующий шаг позволит вам завершить настройку. Воспользуйтесь одной из следующих статей:

* Если вы используете виртуальную машину **Resource Manager** , то ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](../virtual-machines/windows/sql/virtual-machines-windows-sql-connect.md). 
* Если вы используете **классическую** виртуальную машину, см. статью [Подключение к виртуальной машине SQL Server в Azure (классическое развертывание)](../virtual-machines/windows/classic/sql-connect.md).

В частности, в каждой из этих статей ознакомьтесь с разделом "Подключение к SQL Server через Интернет".

## <a name="configure-the-network-security-group-nsg"></a>Настройка группы безопасности сети (NSG)
Обычной практикой является настройка группы безопасности сети и соответствующей конечной точки Azure или списка управления доступом (ACL) таким образом, чтобы виртуальная машина Azure стала доступной для других сторон. Есть вероятность, что вы уже выполнили эту настройку, чтобы разрешить логике своего приложения подключаться к виртуальной машине SQL Azure. Это ничем не отличается от подключения azure Cognitive Search к вашему VM S'L Azure. 

Приведенные ниже ссылки содержат инструкции по настройке групп безопасности сети для развертывания виртуальной машины. Используйте эти инструкции для ACL когнитивной точки поиска Azure на основе ее IP-адреса.

> [!NOTE]
> Основные сведения см. в статье [Группа безопасности сети](../virtual-network/security-overview.md).
> 
> 

* Если вы используете виртуальную машину **Resource Manager**, см. статью [Как управлять сетевыми группами безопасности с помощью портала предварительной версии](../virtual-network/tutorial-filter-network-traffic.md). 
* Если вы используете **классическую** виртуальную машину, см. статью [Как создать группы безопасности сети (классические) в PowerShell](../virtual-network/virtual-networks-create-nsg-classic-ps.md).

Назначение IP-адресов может создать некоторые сложности, но их можно легко преодолеть, если знать о проблеме и о возможных путях ее решения. В дальнейших разделах приводятся рекомендации по устранению проблем, связанных с IP-адресами в списке управления доступом.

#### <a name="restrict-access-to-the-azure-cognitive-search"></a>Ограничьте доступ к когнитивному поиску Azure
Мы настоятельно рекомендуем ограничить доступ к IP-адресу службы поиска и `AzureCognitiveSearch` [диапазону услуг](https://docs.microsoft.com/azure/virtual-network/service-tags-overview#available-service-tags) IP-адреса в ACL вместо того, чтобы сделать ваши vMs-адреса S'L Azure открытыми для всех запросов на подключение.

Вы можете узнать IP-адрес, повысив, `<your-search-service-name>.search.windows.net`например, f-DN вашего поискового сервиса.

Вы можете узнать диапазон `AzureCognitiveSearch` [IP-адресов сервисного тега,](https://docs.microsoft.com/azure/virtual-network/service-tags-overview#available-service-tags) используя [загружаемые файлы JSON](https://docs.microsoft.com/azure/virtual-network/service-tags-overview#discover-service-tags-by-using-downloadable-json-files) или через [Service Tag Discovery API.](https://docs.microsoft.com/azure/virtual-network/service-tags-overview#use-the-service-tag-discovery-api-public-preview) Диапазон IP-адресов обновляется еженедельно.

#### <a name="managing-ip-address-fluctuations"></a>Управление колебаниями IP-адреса
Если служба поиска имеет только одну единицу поиска (то есть одну реплику и одну секцию), то IP-адрес может меняться во время перезагрузки службы, аннулируя существующий список управления доступом с вашим IP-адресом службы поиска.

Одним из способов избежать последующей ошибки подключения является использование нескольких реплик и одной раздела в Azure Cognitive Search. Это увеличивает затраты, но решает проблему с IP-адресами. В Azure Cognitive Search IP-адреса не меняются, когда у вас есть несколько единиц поиска.

Второй подход заключается в том, чтобы позволить подключению завершиться сбоем, а затем перенастроить списки управления доступом в группе безопасности сети. Как правило, IP-адреса меняются раз в несколько недель. Для пользователей, которые нечасто выполняют управляемую индексацию, этот подход может быть эффективным.

Третьим эффективным (но не самым безопасным) подходом является указание диапазона IP-адресов в регионе Azure, в котором выполняется подготовка службы поиска. Список диапазонов IP-адресов, из которых общедоступные IP-адреса назначаются ресурсам Azure, опубликован в файле с [диапазонами IP-адресов центров обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653). 

#### <a name="include-the-azure-cognitive-search-portal-ip-addresses"></a>Включите IP-адреса портала Azure Cognitive Search
Если вы используете портал Azure для создания индекса, логике портала Azure Cognitive Search также необходим доступ к вашему VM S'L Azure во время создания. IP-адреса портала Azure Cognitive Search `stamp2.search.ext.azure.com`можно найти по pinging .

## <a name="next-steps"></a>Дальнейшие действия
Теперь, когда конфигурация не возможна, теперь можно указать сервер S'L на Azure VM в качестве источника данных для индекса когнитивного поиска Azure. Для получения дополнительной [информации см.](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md)

