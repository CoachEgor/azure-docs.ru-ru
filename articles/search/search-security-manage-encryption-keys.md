---
title: Шифрование при хранении с помощью управляемых клиентом ключей в хранилище ключей Azure (Предварительная версия) — службы поиска Azure
description: Шифрование на стороне сервера дополнительный компонент индексов и карт синонимов в службе поиска Azure с помощью ключей, создавать и управлять ими в Azure Key Vault.
author: NatiNimni
manager: jlembicz
ms.author: natinimn
services: search
ms.service: search
ms.topic: conceptual
ms.date: 05/02/2019
ms.custom: ''
ms.openlocfilehash: 567f32cba76aaf2d1657b2476c4d11596d44dec5
ms.sourcegitcommit: 45e4466eac6cfd6a30da9facd8fe6afba64f6f50
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/07/2019
ms.locfileid: "66753946"
---
# <a name="azure-search-encryption-using-customer-managed-keys-in-azure-key-vault"></a>Шифрование поиска Azure с помощью управляемых клиентом ключей в хранилище ключей Azure

> [!Note]
> Шифрование с помощью управляемых пользователем ключей находится в предварительной версии и не предназначена для использования в рабочей среде. Эта функция предоставляется в [версии REST API 2019-05-06-Preview](search-api-preview.md). Можно также использовать пакет SDK для .NET версии 8.0-preview.
>
> Эта функция недоступна для бесплатных служб Необходимо использовать в службе поиска оплачиваемых, созданной в течение или после 2019-01-01. Отсутствует поддержка портала в данный момент.

По умолчанию службы поиска Azure шифрует содержимое пользователя хранении с помощью [управляемых службой ключей](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest#data-encryption-models). Предоставляет уровень шифрования, используя ключи, создавать и управлять ими в Azure Key Vault можно дополнить шифрования по умолчанию. В этой статье рассматриваются шаги.

Шифрование на стороне сервера поддерживается за счет интеграции с [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-overview). Можно создавать собственные ключи шифрования и хранить их в хранилище ключей либо использовать API-интерфейсы Azure Key Vault для генерации этих ключей. С хранилищем ключей Azure можно проводить аудит использования ключей. 

Шифрование с помощью управляемых пользователем ключей настраивается на уровне индекса или синоним карты при создании этих объектов, а не на уровне службы поиска. Не удается зашифровать содержимое, которое уже существует. 

Можно использовать различные ключи из разных хранилищ ключей. Это означает, что отдельной службы поиска можно разместить несколько зашифрованных indexes\synonym карт, каждая зашифрован, возможно, используя другой ключ управляемых пользователем, наряду с indexes\synonym карт, которые не зашифрованы с помощью управляемых клиентом ключей. 

## <a name="prerequisites"></a>Технические условия

В этом примере используются следующие службы. 

+ [Создайте службу "Поиск Azure"](search-create-service-portal.md) или [найдите имеющуюся службу](https://ms.portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Search%2FsearchServices) в рамках текущей подписки. Вы можете использовать бесплатную службу для выполнения инструкций, описанных в этом учебнике.

+ [Создайте ресурс Azure Key Vault](https://docs.microsoft.com/azure/key-vault/quick-create-portal#create-a-vault) или найдите имеющееся хранилище в вашей подписке.

+ [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview) или [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli) используется для выполнения задач конфигурации.

+ [Postman](search-fiddler.md), [Azure PowerShell](search-create-index-rest-api.md) и [SDK для поиска Azure](https://aka.ms/search-sdk-preview) может использоваться для вызова REST API предварительной версии. Нет, портал или поддержка пакета SDK для .NET для шифрования, управляемых пользователем, в настоящее время.

## <a name="1---enable-key-recovery"></a>1 — включить восстановления ключей

Этот шаг является необязательным, но настоятельно рекомендуется. После создания ресурса хранилища ключей Azure, включить **обратимое удаление** и **очистить защиты** в выбранном Key vault, выполнив следующие команды PowerShell или интерфейса командной строки Azure:   

```powershell
$resource = Get-AzResource -ResourceId (Get-AzKeyVault -VaultName "<vault_name>").ResourceId

$resource.Properties | Add-Member -MemberType NoteProperty -Name "enableSoftDelete" -Value 'true'

$resource.Properties | Add-Member -MemberType NoteProperty -Name "enablePurgeProtection" -Value 'true'

Set-AzResource -resourceid $resource.ResourceId -Properties $resource.Properties
```

```azurecli-interactive
az keyvault update -n <vault_name> -g <resource_group> --enable-soft-delete --enable-purge-protection
```

>[!Note]
> Из-за самой природы шифрования с помощью управляемых клиентом ключей функции поиска Azure будет невозможно для извлечения данных в том случае, если удаляется вашего ключа Azure Key vault. Чтобы предотвратить потерю данных, из-за случайного удаления ключа Key Vault, настоятельно рекомендуется включить обратимое удаление и очистку защиты для выбранного хранилища ключей. Дополнительные сведения см. в разделе [обратимого удаления Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete).   

## <a name="2---create-a-new-key"></a>2 - Создание нового ключа

Если вы используете существующий ключ для шифрования содержимого службы поиска Azure, пропустите этот шаг.

1. [Войдите на портал Azure](https://portal.azure.com) и перейдите к панели мониторинга хранилища ключей.

1. Выберите **ключи** из левой области навигации и щелкните **+ Создание и импорт**.

1. В области **Создание ключа** откройте список **Параметры** и выберите метод создания ключа. Вы можете **создать** новый ключ, **отправить** существующий или **восстановить резервную копию** ключа.

1. Введите **имя** для ключа и при необходимости выберите другие ключевые свойства.

1. Щелкните **создать** кнопку, чтобы начать развертывание.

Запомните или запишите идентификатор ключа — это состоит из **значение Uri ключа**, **имя ключа**и **версия ключа**. Они потребуются для определения зашифрованных индекса в службе поиска Azure.
 
![Создание ключа хранилища ключей](./media/search-manage-encryption-keys/create-new-key-vault-key.png "Создание ключа хранилища ключей")

## <a name="3---create-a-service-identity"></a>3 - Создание удостоверения службы

Назначение удостоверения для службы поиска позволит предоставить разрешения хранилища ключей доступа к службе поиска. Служба поиска будет использовать удостоверения для проверки подлинности с помощью хранилища ключей Azure.

Поиск Azure поддерживает два способа для назначения идентификаторов: управляемое удостоверение или извне управляемые приложения Azure Active Directory. 

Если это возможно используйте управляемое удостоверение. Он является самым простым способом назначения удостоверения службы поиска и должны работать в большинстве сценариев. Если вы используете несколько ключей для индексов и карт синонимов, или если ваше решение расположено в распределенная архитектура, которая disqualifies проверки подлинности на основе удостоверений, используйте расширенный [извне управляемые Azure Active Directory подход](#aad-app)описана в конце этой статьи.

 Как правило управляемое удостоверение позволяет службе поиска для проверки подлинности в хранилище ключей Azure без сохранения учетных данных в коде. Жизненный цикл этого типа управляемого удостоверения привязывается к жизненного цикла службы поиска, которую может иметь только одно управляемое удостоверение. [Дополнительные сведения об управляемых удостоверениях](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview).

1. Для создания управляемого удостоверения, [войдите в портал toAzure](https://portal.azure.com) и откройте панель мониторинга службы поиска. 

1. Нажмите кнопку **удостоверений** в левой области навигации, измените его состояние **на**и нажмите кнопку **Сохранить**.

![Включить управляемое удостоверение](./media/search-enable-msi/enable-identity-portal.png "групповые идентификации")

## <a name="4---grant-key-access-permissions"></a>4 — Предоставление разрешений на доступ к ключу

Чтобы включить службу поиска на использование ключа Key Vault, вам потребуется предоставить поиска службы определенные разрешения на доступ.

Разрешения на доступ можно отменить в любой момент времени. После отозван, станут непригодными для использования любой поиска индекса или синоним схемы услуги, использующего хранилище ключей. Восстановление разрешений доступа хранилища ключей в дальнейшем будет восстановлена index\synonym карты доступа. Дополнительные сведения см. в разделе [безопасный доступ к хранилищу ключей](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault).

1. [Войдите на портал Azure](https://portal.azure.com) и откройте страницу Общие сведения о хранилище ключей. 

1. Выберите **политики доступа** из левой области навигации и щелкните **+ добавить новый**.

   ![Добавление новой политики доступа хранилища ключей](./media/search-manage-encryption-keys/add-new-key-vault-access-policy.png "Добавление новой политики доступа хранилища ключей")

1. Нажмите кнопку **Выбор субъекта** и выберите службу поиска Azure. Вы можете найти его по имени или по Идентификатору объекта, который был отображен после включения управляемого удостоверения.

   ![Участник политики доступа выберите хранилище ключей](./media/search-manage-encryption-keys/select-key-vault-access-policy-principal.png "субъект политики доступа выберите хранилище ключей")

1. Щелкните **разрешения ключей** и выберите *получить*, *распаковку ключа* и *Wrap Key*. Можно использовать *хранилище Azure Data Lake или хранилище Azure* шаблон, чтобы быстро выбрать необходимые разрешения.

   Поиск Azure должен обладать следующим [разрешения доступа](https://docs.microsoft.com/azure/key-vault/about-keys-secrets-and-certificates#key-operations):

   * *Получить* -позволяет службе поиска для получения открытых частей ключа в хранилище ключей
   * *Wrap Key* -позволяет использовать ключ для защиты ключа шифрования внутренней службы поиска
   * *Распаковки ключа* -позволяет службе поиска на использование ключа для распаковки внутреннего ключа

   ![Выберите разрешения ключей политики доступа хранилища ключей](./media/search-manage-encryption-keys/select-key-vault-access-policy-key-permissions.png "выберите разрешения ключей политики доступа хранилища ключей")

1. Нажмите кнопку **ОК** и **Сохранить** изменения политики доступа.

> [!Important]
> Зашифрованное содержимое в службе поиска Azure настроен на использование определенного ключа Azure Key Vault с определенным **версии**. При изменении ключа или версии, индекса или синоним карты необходимо обновить для использования нового key\version **перед** удаление предыдущих key\version. Невыполнение этого действия будет отображаться индекс или синоним сопоставить непригодным для использования, в вы не сможете расшифровать данные, как только теряется доступ к ключу.   

## <a name="5---encrypt-content"></a>5 - шифрование содержимого

Создание индекса или синоним карты, зашифрованных с помощью управляемых клиентом ключа еще невозможно с помощью портала Azure. Используйте API REST службы поиска Azure для создания карты такой индекс или синоним.

Индекс и синоним сопоставления поддерживают верхнего уровня **encryptionKey** свойство, используемое для указания ключа. 

С помощью **Uri хранилища ключей**, **имя ключа** и **версия ключа** из ключа Key vault, мы можем создать **encryptionKey** определение:

```json
{
  "encryptionKey": {
    "keyVaultUri": "https://demokeyvault.vault.azure.net",
    "keyVaultKeyName": "myEncryptionKey",
    "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660"
  }
}
```
> [!Note] 
> Ни один из этих сведений о хранилище ключей, считаются секрет и может легко получить, перейдя на соответствующую страницу ключа Azure Key Vault на портале Azure.

Если вы используете приложение AAD для проверки подлинности хранилища ключей, вместо использования управляемого удостоверения, добавить это приложение AAD **учетные данные для доступа** для ключа шифрования: 
```json
{
  "encryptionKey": {
    "keyVaultUri": "https://demokeyvault.vault.azure.net",
    "keyVaultKeyName": "myEncryptionKey",
    "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660",
    "accessCredentials": {
      "applicationId": "00000000-0000-0000-0000-000000000000",
      "applicationSecret": "myApplicationSecret"
    }
  }
}
```

## <a name="example-index-encryption"></a>Пример: Индекс шифрования
Сведения о создании нового индекса с помощью REST API по обнаружен [Create Index (API REST службы поиска Azure)](https://docs.microsoft.com/rest/api/searchservice/create-index), где единственная разница здесь задает сведения о ключе шифрования как часть определения индекса: 

```json
{
 "name": "hotels",  
 "fields": [
  {"name": "HotelId", "type": "Edm.String", "key": true, "filterable": true},
  {"name": "HotelName", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": true, "facetable": false},
  {"name": "Description", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": false, "facetable": false, "analyzer": "en.lucene"},
  {"name": "Description_fr", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": false, "facetable": false, "analyzer": "fr.lucene"},
  {"name": "Category", "type": "Edm.String", "searchable": true, "filterable": true, "sortable": true, "facetable": true},
  {"name": "Tags", "type": "Collection(Edm.String)", "searchable": true, "filterable": true, "sortable": false, "facetable": true},
  {"name": "ParkingIncluded", "type": "Edm.Boolean", "filterable": true, "sortable": true, "facetable": true},
  {"name": "LastRenovationDate", "type": "Edm.DateTimeOffset", "filterable": true, "sortable": true, "facetable": true},
  {"name": "Rating", "type": "Edm.Double", "filterable": true, "sortable": true, "facetable": true},
  {"name": "Location", "type": "Edm.GeographyPoint", "filterable": true, "sortable": true},
 ],
 "encryptionKey": {
   "keyVaultUri": "https://demokeyvault.vault.azure.net",
   "keyVaultKeyName": "myEncryptionKey",
   "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660"
 }
}
```
Теперь отправьте запрос на создание индекса и запустите обычным образом с помощью индекса.

## <a name="example-synonym-map-encryption"></a>Пример: Шифрование карты синонимов

Сведения о создании карту синонимов через REST API можно найти в [Создание карты синонимов (API REST службы поиска Azure)](https://docs.microsoft.com/rest/api/searchservice/create-synonym-map), где единственная разница здесь задает сведения о ключе шифрования как часть определения карты синонимов: 

```json
{   
  "name" : "synonymmap1",  
  "format" : "solr",  
  "synonyms" : "United States, United States of America, USA\n
  Washington, Wash. => WA",
  "encryptionKey": {
    "keyVaultUri": "https://demokeyvault.vault.azure.net",
    "keyVaultKeyName": "myEncryptionKey",
    "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660"
  }
}
```
Теперь отправить запрос на создание карты синонимов и затем начать его обычным образом.

>[!Important] 
> Хотя **encryptionKey** нельзя добавить в существующие индексы поиска Azure или карт синонимов, она может обновляться, предоставляя различные значения для любого из трех данные о key vault (например, обновление версии ключа). При изменении на новый ключ Key Vault или новой версии, любой службы поиска Azure карты индекса или синоним, который использует ключ сначала должны быть обновлены для использования новый key\version **перед** удаление предыдущих key\version. Невыполнение этого действия будет отображаться индекс или непригодным к использованию, так как он не сможет расшифровать доступа к содержимому после ключа карты синонимов потеряно.   
> Восстановление разрешений доступа хранилища ключей в дальнейшем будет восстановить доступ к содержимому.

## <a name="aad-app"></a> Дополнительно: Использование извне управляемого приложения Azure Active Directory

Когда управляемое удостоверение не поддерживается, созданием приложения Azure Active Directory с безопасностью участника для службы поиска Azure. В частности управляемое удостоверение не является приемлемым в этих условиях:

* Вы не можете предоставить непосредственно поиска службы разрешения на доступ к хранилищу ключей (например, если служба поиска находится в другом клиенте Active Directory, чем в хранилище ключей Azure).

* Отдельной службы поиска необходима для размещения нескольких карт зашифрованных indexes\synonym, используя другой ключ из другой Key vault, где необходимо использовать каждого хранилища ключей **другое удостоверение** для проверки подлинности. Если используется другое удостоверение для управления разных хранилищ ключей не требуется, рассмотрите возможность использования выше параметр управляемого удостоверения.  

Для размещения таких топологиях, поиск Azure поддерживает использование приложения Azure Active Directory (AAD) для проверки подлинности между службы поиска и Key Vault.    
Чтобы создать приложение AAD на портале:

1. [Создайте приложение Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal#create-an-azure-active-directory-application).

1. [Получение идентификатора приложения и проверка подлинности ключа](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in) , те, которые потребуются для создания зашифрованного индекса. Значения, необходимо будет предоставить включают **идентификатор приложения** и **ключ проверки подлинности**.

>[!Important]
> При определении использование приложения AAD для проверки подлинности вместо управляемого удостоверения учитывайте тот факт, что поиск Azure не авторизован для управления приложением AAD от вашего имени, и вы для управления приложением AAD, например периодической смены из ключ проверки подлинности приложения.
> При изменении приложения или его ключ проверки подлинности, любой службы поиска Azure индекс или синоним схему, использующий это приложение сначала должны быть обновлены для использования новое приложение ID\key **перед** удаления предыдущего приложения или его авторизации ключа и перед Отмена вашего хранилища ключей доступа к нему.
> Невыполнение этого действия будет отображаться индекс или непригодным к использованию, так как он не сможет расшифровать доступа к содержимому после ключа карты синонимов потеряно.   

## <a name="next-steps"></a>Дальнейшие действия

Если вы не знакомы с архитектурой безопасности Azure, просмотрите [документация по системе безопасности Azure](https://docs.microsoft.com/azure/security/)и в частности, в этой статье:

> [!div class="nextstepaction"]
> [Шифрование неактивных данных](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)
