---
title: Шифрование неактивных с помощью управляемых клиентом ключей (Предварительная версия)
titleSuffix: Azure Cognitive Search
description: Дополнительное шифрование на стороне сервера по индексам и картам синонимов в Azure Когнитивный поиск с помощью ключей, которые вы создаете и управляете в Azure Key Vault. Эта функция сейчас доступна в виде общедоступной предварительной версии.
manager: nitinme
author: NatiNimni
ms.author: natinimn
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 05/02/2019
ms.openlocfilehash: 4f78b4b7b38c6e67aa8aebf04e3a8ef0fdbd000f
ms.sourcegitcommit: 598c5a280a002036b1a76aa6712f79d30110b98d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2019
ms.locfileid: "74112938"
---
# <a name="encryption-at-rest-of-content-in-azure-cognitive-search-using-customer-managed-keys-in-azure-key-vault"></a>Шифрование неактивных содержимого в Azure Когнитивный поиск с помощью ключей, управляемых клиентом, в Azure Key Vault

> [!IMPORTANT] 
> Поддержка шифрования неактивных компонентов сейчас доступна в общедоступной предварительной версии. Для предварительной версии функции соглашение об уровне обслуживания не предусмотрено. Мы не рекомендуем использовать ее в рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). Эта функция доступна для [REST API версии 2019-05-06-Preview](search-api-preview.md) и [пакета SDK для .NET версии 8,0-Preview](search-dotnet-sdk-migration-version-9.md) . В настоящее время портал не поддерживается.

По умолчанию Azure Когнитивный поиск шифрует неактивных пользовательских данных с помощью [ключей, управляемых службой](https://docs.microsoft.com/azure/security/fundamentals/encryption-atrest#data-encryption-models). Шифрование по умолчанию можно расширить с помощью дополнительного уровня шифрования, используя ключи, которые вы создаете и управляете в Azure Key Vault. В этой статье описаны шаги.

Шифрование на стороне сервера поддерживается путем интеграции с [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-overview). Можно создавать собственные ключи шифрования и хранить их в хранилище ключей либо использовать API-интерфейсы Azure Key Vault для генерации этих ключей. С помощью Azure Key Vault можно также выполнять аудит использования ключа. 

Шифрование с помощью ключей, управляемых клиентом, настраивается на уровне индекса или на карте синонимов при создании этих объектов, а не на уровне службы поиска. Вы не можете зашифровать уже существующее содержимое. 

Вы можете использовать разные ключи из разных хранилищ ключей. Это означает, что одна служба поиска может размещать несколько зашифрованных карт индексес\синоним, каждая из которых может использовать другой ключ, управляемый клиентом, наряду с картами индексес\синоним, которые не шифруются с помощью управляемых клиентом ключей. 

## <a name="prerequisites"></a>предварительным требованиям

В этом примере используются следующие службы. 

+ [Создайте службу "Когнитивный поиск Azure"](search-create-service-portal.md) или [найдите имеющуюся службу](https://ms.portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Search%2FsearchServices) в рамках текущей подписки. Вы можете использовать бесплатную службу для выполнения инструкций, описанных в этом учебнике.

+ [Создайте Azure Key Vault ресурс](https://docs.microsoft.com/azure/key-vault/quick-create-portal#create-a-vault) или найдите существующее хранилище в подписке.

+ Для задач настройки используется [Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview) или [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli) .

+ [POST](search-get-started-postman.md), [Azure PowerShell](search-create-index-rest-api.md) и [Azure когнитивный Поиск SDK](https://aka.ms/search-sdk-preview) можно использовать для вызова предварительной версии REST API. В настоящее время отсутствует поддержка портала или пакета SDK для .NET для шифрования, управляемого клиентом.

## <a name="1---enable-key-recovery"></a>1\. Включение восстановления ключей

Этот шаг является необязательным, но настоятельно рекомендуется. После создания ресурса Azure Key Vault включите **обратимое удаление** и **очистку** в выбранном хранилище ключей, выполнив следующие команды PowerShell или Azure CLI:   

```powershell
$resource = Get-AzResource -ResourceId (Get-AzKeyVault -VaultName "<vault_name>").ResourceId

$resource.Properties | Add-Member -MemberType NoteProperty -Name "enableSoftDelete" -Value 'true'

$resource.Properties | Add-Member -MemberType NoteProperty -Name "enablePurgeProtection" -Value 'true'

Set-AzResource -resourceid $resource.ResourceId -Properties $resource.Properties
```

```azurecli-interactive
az keyvault update -n <vault_name> -g <resource_group> --enable-soft-delete --enable-purge-protection
```

>[!Note]
> Из-за особенностей шифрования с помощью функций, управляемых клиентом, Когнитивный поиск Azure не сможет получить данные, если ключ хранилища ключей Azure будет удален. Чтобы предотвратить потери данных, вызванные случайным удалением ключей Key Vault, настоятельно рекомендуется включить обратимое удаление и очистку для выбранного хранилища ключей. Дополнительные сведения см. в разделе [Azure Key Vault обратимого удаления](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete).   

## <a name="2---create-a-new-key"></a>2\. Создание нового ключа

Если вы используете существующий ключ для шифрования содержимого Когнитивный поиск Azure, пропустите этот шаг.

1. [Войдите в портал Azure](https://portal.azure.com) и перейдите на панель мониторинга хранилища ключей.

1. Выберите параметр **ключи** в левой области навигации и нажмите кнопку **+ создать/импортировать**.

1. В области **Создание ключа** откройте список **Параметры** и выберите метод создания ключа. Вы можете **создать** новый ключ, **отправить** существующий или **восстановить резервную копию** ключа.

1. Введите **имя** ключа и при необходимости выберите другие ключевые свойства.

1. Нажмите кнопку " **создать** ", чтобы запустить развертывание.

Запишите идентификатор ключа — он состоит из **URI значения ключа**, **имени ключа**и **версии ключа**. Эти данные понадобятся вам для определения зашифрованного индекса в Когнитивный поиск Azure.
 
![Создать новый ключ хранилища ключей](./media/search-manage-encryption-keys/create-new-key-vault-key.png "Создать новый ключ хранилища ключей")

## <a name="3---create-a-service-identity"></a>3\. Создание удостоверения службы

Назначение удостоверения для службы поиска позволяет предоставить Key Vault разрешения на доступ к службе поиска. Служба поиска будет использовать удостоверение для аутентификации в хранилище ключей Azure.

Когнитивный поиск Azure поддерживает два способа назначения удостоверения: управляемое удостоверение или внешнее управляемое приложение Azure Active Directory. 

По возможности используйте управляемое удостоверение. Это самый простой способ назначения удостоверения для службы поиска и должен работать в большинстве сценариев. Если вы используете несколько ключей для индексов и сопоставлений синонимов или если ваше решение находится в распределенной архитектуре, которая рассматривает проверку подлинности на основе удостоверений, используйте Расширенный [подход, управляемый извне Azure Active Directory](#aad-app) , описанный в конце этой статьи.

 Как правило, управляемое удостоверение позволяет службе поиска проходить проверку подлинности в Azure Key Vault без сохранения учетных данных в коде. Жизненный цикл этого типа управляемого удостоверения связан с жизненным циклом службы поиска, которая может иметь только одно управляемое удостоверение. [Дополнительные сведения об управляемых удостоверениях](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview).

1. Чтобы создать управляемое удостоверение, [Войдите на портал тоазуре](https://portal.azure.com) и откройте панель мониторинга службы поиска. 

1. Щелкните **удостоверение** в левой области навигации, измените его состояние на **вкл**. и нажмите кнопку **сохранить**.

![Включение управляемого удостоверения](./media/search-enable-msi/enable-identity-portal.png "Включение управляемого удостоверения")

## <a name="4---grant-key-access-permissions"></a>4\. Предоставление разрешений на доступ к ключам

Чтобы служба поиска использовала ключ Key Vault, необходимо предоставить службе поиска определенные разрешения на доступ.

Разрешения на доступ могут быть отменены в любое заданное время. После отзыва любой индекс службы поиска или карту синонимов, которая использует это хранилище ключей, станет непригодной для использования. Восстановление разрешений на доступ к хранилищу ключей в дальнейшем приведет к восстановлению доступа к карте индекс\синоним. Дополнительные сведения см. в статье [безопасный доступ к хранилищу ключей](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault).

1. [Войдите в портал Azure](https://portal.azure.com) и откройте страницу обзора хранилища ключей. 

1. Выберите параметр **политики доступа** в левой области навигации и щелкните **+ Добавить новый**.

   ![Добавление новой политики доступа к хранилищу ключей](./media/search-manage-encryption-keys/add-new-key-vault-access-policy.png "Добавление новой политики доступа к хранилищу ключей")

1. Щелкните **выбрать субъект** и выберите службу Azure когнитивный Поиск. Можно выполнить поиск по имени или по ИДЕНТИФИКАТОРу объекта, который отображался после включения управляемого удостоверения.

   ![Выбор субъекта политики доступа к хранилищу ключей](./media/search-manage-encryption-keys/select-key-vault-access-policy-principal.png "Выбор субъекта политики доступа к хранилищу ключей")

1. Щелкните **ключевые разрешения** и выберите *получить*, *расобернуть ключ* и *Ключ переноса*. Вы можете использовать *Azure Data Lake Storage или шаблон службы хранилища Azure* , чтобы быстро выбрать необходимые разрешения.

   Когнитивный поиск Azure должны быть предоставлены со следующими [разрешениями на доступ](https://docs.microsoft.com/azure/key-vault/about-keys-secrets-and-certificates#key-operations):

   * *Get* — позволяет службе поиска получать открытые части ключа в Key Vault
   * *Ключ переноса* . позволяет службе поиска использовать ключ для защиты внутреннего ключа шифрования.
   * *Распаковка ключа* — позволяет службе поиска использовать ваш ключ для распаковки внутреннего ключа шифрования.

   ![Выбор разрешений для ключа политики доступа к хранилищу ключей](./media/search-manage-encryption-keys/select-key-vault-access-policy-key-permissions.png "Выбор разрешений для ключа политики доступа к хранилищу ключей")

1. Нажмите кнопку **ОК** и **Сохраните** изменения политики доступа.

> [!Important]
> Зашифрованное содержимое в Когнитивный поиск Azure настроено для использования определенного ключа Azure Key Vault с определенной **версией**. При изменении ключа или версии необходимо обновить карту индекса или синонима, чтобы использовать новый кэй\версион **перед** удалением предыдущего кэй\версион. Если этого не сделать, то вы не сможете расшифровать содержимое после того, как теряется доступ к ключу.   

## <a name="5---encrypt-content"></a>5\. шифрование содержимого

Создание индекса или таблицы синонимов, зашифрованных с помощью ключа, управляемого клиентом, пока не поддерживается с помощью портал Azure. Используйте REST API Когнитивный поиск Azure, чтобы создать такой индекс или карту синонимов.

Как индекс, так и схема синонимов поддерживают новое свойство **encryptionKey** верхнего уровня, используемое для указания ключа. 

Используя **URI хранилища ключей**, **имя ключа** и **версию** ключа хранилища ключей, можно создать определение **encryptionKey** :

```json
{
  "encryptionKey": {
    "keyVaultUri": "https://demokeyvault.vault.azure.net",
    "keyVaultKeyName": "myEncryptionKey",
    "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660"
  }
}
```
> [!Note] 
> Ни одно из этих сведений о хранилище ключей не считается секретным, и его можно легко получить, перейдя к соответствующей странице Azure Key Vault ключа в портал Azure.

Если вы используете приложение AAD для проверки подлинности Key Vault вместо использования управляемого удостоверения, добавьте **учетные данные доступа к** приложению AAD в ключ шифрования: 
```json
{
  "encryptionKey": {
    "keyVaultUri": "https://demokeyvault.vault.azure.net",
    "keyVaultKeyName": "myEncryptionKey",
    "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660",
    "accessCredentials": {
      "applicationId": "00000000-0000-0000-0000-000000000000",
      "applicationSecret": "myApplicationSecret"
    }
  }
}
```

## <a name="example-index-encryption"></a>Пример. Шифрование индекса
Сведения о создании нового индекса с помощью REST API можно найти в статье [Создание индекса (Azure Когнитивный поиск REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index), где единственное отличие заключается в указании сведений о ключе шифрования в определении индекса: 

```json
{
 "name": "hotels",  
 "fields": [
  {"name": "HotelId", "type": "Edm.String", "key": true, "filterable": true},
  {"name": "HotelName", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": true, "facetable": false},
  {"name": "Description", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": false, "facetable": false, "analyzer": "en.lucene"},
  {"name": "Description_fr", "type": "Edm.String", "searchable": true, "filterable": false, "sortable": false, "facetable": false, "analyzer": "fr.lucene"},
  {"name": "Category", "type": "Edm.String", "searchable": true, "filterable": true, "sortable": true, "facetable": true},
  {"name": "Tags", "type": "Collection(Edm.String)", "searchable": true, "filterable": true, "sortable": false, "facetable": true},
  {"name": "ParkingIncluded", "type": "Edm.Boolean", "filterable": true, "sortable": true, "facetable": true},
  {"name": "LastRenovationDate", "type": "Edm.DateTimeOffset", "filterable": true, "sortable": true, "facetable": true},
  {"name": "Rating", "type": "Edm.Double", "filterable": true, "sortable": true, "facetable": true},
  {"name": "Location", "type": "Edm.GeographyPoint", "filterable": true, "sortable": true},
 ],
 "encryptionKey": {
   "keyVaultUri": "https://demokeyvault.vault.azure.net",
   "keyVaultKeyName": "myEncryptionKey",
   "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660"
 }
}
```
Теперь можно отправить запрос на создание индекса, а затем начать использовать индекс в обычном режиме.

## <a name="example-synonym-map-encryption"></a>Пример: шифрование с картой синонимов

Сведения о создании новой схемы синонимов с помощью REST API можно найти на странице [Создание сопоставления синонимов (Azure Когнитивный поиск REST API)](https://docs.microsoft.com/rest/api/searchservice/create-synonym-map), где единственное отличие заключается в указании сведений о ключе шифрования как части определения сопоставления синонимов: 

```json
{   
  "name" : "synonymmap1",  
  "format" : "solr",  
  "synonyms" : "United States, United States of America, USA\n
  Washington, Wash. => WA",
  "encryptionKey": {
    "keyVaultUri": "https://demokeyvault.vault.azure.net",
    "keyVaultKeyName": "myEncryptionKey",
    "keyVaultKeyVersion": "eaab6a663d59439ebb95ce2fe7d5f660"
  }
}
```
Теперь можно отправить запрос на создание сопоставлений синонимов, а затем начать использовать его в обычном режиме.

>[!Important] 
> Хотя **encryptionKey** нельзя добавить к существующим индексам когнитивный Поиск Azure или сопоставлениям синонимов, его можно обновить, предоставив разные значения для любого из трех сведений о хранилище ключей (например, обновление версии ключа). При переходе на новый ключ Key Vault или новую версию ключа необходимо сначала обновить любой индекс Azure Когнитивный поиск или карту синонимов, которая использует этот ключ, чтобы использовать новый кэй\версион **перед** удалением предыдущего кэй\версион. Если не выполнить это действие, будет отображена схема индекса или синонима, которую нельзя использовать, так как она не сможет расшифровать содержимое после потери доступа к ключу.   
> Восстановление разрешений на доступ к хранилищу ключей в дальнейшем приведет к восстановлению доступа к содержимому.

## <a name="aad-app"></a>Дополнительно: использование приложения, управляемого извне Azure Active Directory

Если управляемое удостоверение невозможно, можно создать приложение Azure Active Directory с субъектом безопасности для службы Когнитивный поиск Azure. В частности, управляемое удостоверение неприменимо в следующих условиях:

* Вы не можете напрямую предоставить службе поиска доступ к хранилищу ключей (например, если служба поиска находится в другом клиенте Active Directory, отличном от Azure Key Vault).

* Для размещения нескольких зашифрованных карт индексес\синоним требуется одна служба поиска, каждый из которых использует другой ключ из другого хранилища ключей, где каждое хранилище ключей должно использовать для проверки подлинности **другое удостоверение** . Если использовать другое удостоверение для управления разными хранилищами ключей не обязательно, рекомендуется использовать параметр управляемого удостоверения выше.  

Для поддержки таких топологий Azure Когнитивный поиск поддерживает использование приложений Azure Active Directory (AAD) для проверки подлинности между службой поиска и Key Vault.    
Чтобы создать приложение AAD на портале, выполните следующие действия.

1. [Создайте приложение Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal#create-an-azure-active-directory-application).

1. [Получите идентификатор приложения и ключ проверки подлинности](https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in) , так как они потребуются для создания зашифрованного индекса. Значения, которые потребуется указать, включают **идентификатор приложения** и **ключ проверки подлинности**.

>[!Important]
> При принятии решения об использовании приложения AAD с проверкой подлинности вместо управляемого удостоверения следует учитывать тот факт, что Azure Когнитивный поиск не имеет полномочий на управление приложением AAD от вашего имени, и вы можете управлять приложением AAD, например периодические операции. Поворот ключа проверки подлинности приложения.
> При изменении приложения AAD или его ключа проверки подлинности любой индекс Когнитивный поиск Azure или схема синонимов, которая использует это приложение, должна сначала быть обновлена для использования нового приложения Ид\кэй **перед** удалением предыдущего приложения или его авторизации. и перед отзывом Key Vault доступа к нему.
> Если не выполнить это действие, будет отображена схема индекса или синонима, которую нельзя использовать, так как она не сможет расшифровать содержимое после потери доступа к ключу.   

## <a name="next-steps"></a>Дополнительная информация

Если вы не знакомы с архитектурой безопасности Azure, ознакомьтесь с [документацией по безопасности Azure](https://docs.microsoft.com/azure/security/)и в частности, в этой статье:

> [!div class="nextstepaction"]
> [Шифрование неактивных данных](https://docs.microsoft.com/azure/security/fundamentals/encryption-atrest)
