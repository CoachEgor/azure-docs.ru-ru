---
title: Фильтрация по результатам поиска
titleSuffix: Azure Cognitive Search
description: Фильтрация по идентификатору безопасности пользователя, языку, географическому расположению или числовым значениям для сокращения результатов поиска по запросам в Когнитивный поиск Azure, размещенной облачной службе поиска на Microsoft Azure.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: 7f2eb7cff5d8fe77a56117a0be57f0edb86889a9
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85562298"
---
# <a name="filters-in-azure-cognitive-search"></a>Фильтры в Когнитивный поиск Azure 

*Фильтр* содержит критерии выбора документов, используемых в запросе Azure когнитивный Поиск. Неотфильтрованные результаты поиска содержат все документы в индексе. Фильтр ограничивает поисковой запрос подмножеством документов. Например, фильтр может ограничивать полнотекстовый поиск продуктами определенного бренда, цвета или ценового диапазона, превышающего определенное пороговое значение.

Некоторые поисковые запросы устанавливают требования к фильтрам как часть реализации, но вы можете использовать фильтры, когда требуется ограничить поиск с помощью критериев *на основе значений* (поиск с ограничением поиска по типу продукта "книги" для категории "не фантастика", издательства Simon & Schuster).

Если вместо этого требуется выполнить поиск по определенным *структурам* данных (поиск с ограничением по полю "отзывы клиентов"), существуют альтернативные методы, описанные ниже.

## <a name="when-to-use-a-filter"></a>Когда следует использовать фильтр

Фильтры основаны на нескольких поисковых функциях, включая функцию поиска соседних объектов, навигацию по аспектам и фильтры безопасности, которые показывают только разрешенные документы. При реализации любой из этих функций требуется фильтр. Это фильтр, прикрепленный к поисковому запросу, который предоставляет координаты геолокации, выбранную пользователем категорию аспекта или идентификатор безопасности запрашивающего.

Ниже приведены примеры сценариев:

1. Используйте фильтр для создания среза индекса на основе значений данных в индексе. Учитывая схему с городом, типом жилья и удобствами, вы можете создать фильтр, чтобы явно выбирать документы, которые удовлетворяют вашим критериям (в Сиэтле, кондоминиумы, набережная). 

   Полнотекстовый поиск в одних и тех же входных данных часто приводит к аналогичным результатам, а его точность зависит от совпадения термина фильтра с содержимым вашего индекса. 

2. Используйте фильтр, если он требуется для поиска.

   * [Навигация по аспектам](search-faceted-navigation.md) использует фильтр для возврата категории аспекта, выбранной пользователем.
   * Геопространственный поиск использует фильтр для передачи координат текущего местоположения в приложениях с возможностью поиска соседних объектов. 
   * Фильтры безопасности передают идентификаторы безопасности в качестве критериев фильтра, где совпадение в индексе служит в качестве прокси-сервера для получения прав доступа к документу.

3. Используйте фильтр, если вы хотите использовать критерии поиска в числовом поле. 

   Числовые поля можно получить в документе, а также они могут отображаться в результатах поиска, но индивидуально они недоступны для поиска (при условии полнотекстового поиска). Если вам нужны критерии выбора, основанные на числовых данных, используйте фильтр.

### <a name="alternative-methods-for-reducing-scope"></a>Альтернативные методы для сокращения области поиска

Если требуется сузить область поиска в результатах, можно использовать не только фильтры. Эти возможности могут быть более эффективными в зависимости от задачи:

 + Параметр запроса `searchFields` ограничивает поиск конкретными полями. Например, если в вашем индексе содержатся отдельные поля для описания на английском и испанском языках, вы можете использовать searchFields, чтобы указать конкретные поля для полнотекстового поиска. 

+ Параметр `$select` используется, чтобы указать поля, которые требуется включить в результирующий набор для эффективной обрезки ответа перед его отправкой вызывающему приложению. Этот параметр не позволяет уточнить запрос или сократить коллекцию документов, но если вы не отвечаете за более маленький ответ, этот параметр можно рассмотреть. 

Дополнительные сведения о параметрах запроса см. в подразделе ["Параметры запроса" раздела "Запрос" статьи Search Documents (Azure Search Service REST API)](/rest/api/searchservice/search-documents#query-parameters) (Поиск документов (REST API службы "Поиск" Azure)).


## <a name="how-filters-are-executed"></a>Как выполняются фильтры

Во время запроса средство синтаксического анализа фильтров принимает критерии в качестве входных данных, преобразует выражение в атомарные логические выражения, представленные в виде дерева, а затем вычисляет дерево фильтров по фильтруемым полям в индексе.

Фильтрация выполняется в сочетании с поиском, определяющим, какие документы следует включить в подчиненную обработку для получения документа и оценки релевантности. При связывании со строкой поиска фильтр эффективно сокращает набор отзывов последующей операции поиска. При использовании отдельно (например, когда строка запроса пуста, где `search=*`), критерием фильтра являются только входные данные. 

## <a name="defining-filters"></a>Определение фильтров
Фильтры — это выражения OData, сформулированные с помощью [подмножества синтаксиса OData версии 4, поддерживаемого в когнитивный Поиск Azure](https://docs.microsoft.com/rest/api/searchservice/odata-expression-syntax-for-azure-search). 

Можно указать один фильтр для каждой операции **поиска** , но сам фильтр может включать несколько полей, несколько условий, а при использовании функции **Match** — несколько выражений полнотекстового поиска. В выражении фильтра из нескольких частей можно указать предикаты в любом порядке (в соответствии с правилами приоритета операторов). Попытка поставить предикаты в определенной последовательности не даст значительного прироста производительности.

Одним из ограничений критерия фильтра является максимальный размер запроса. Весь запрос, включая функции фильтра, не может содержать более 16 МБ данных для POST или 8 КБ для GET. Кроме того, существует ограничение на количество предложений в выражении фильтра. Хорошее проверенное правило: если у вас есть сотни предложений, вы рискуете превысить лимит. Мы рекомендуем разрабатывать приложение таким образом, чтобы оно не создавало фильтры неограниченного размера.

Следующие примеры представляют собой прототипные определения фильтров в нескольких API.

```http
# Option 1:  Use $filter for GET
GET https://[service name].search.windows.net/indexes/hotels/docs?api-version=2020-06-30&search=*&$filter=Rooms/any(room: room/BaseRate lt 150.0)&$select=HotelId, HotelName, Rooms/Description, Rooms/BaseRate

# Option 2: Use filter for POST and pass it in the request body
POST https://[service name].search.windows.net/indexes/hotels/docs/search?api-version=2020-06-30
{
    "search": "*",
    "filter": "Rooms/any(room: room/BaseRate lt 150.0)",
    "select": "HotelId, HotelName, Rooms/Description, Rooms/BaseRate"
}
```

```csharp
    parameters =
        new SearchParameters()
        {
            Filter = "Rooms/any(room: room/BaseRate lt 150.0)",
            Select = new[] { "HotelId", "HotelName", "Rooms/Description" ,"Rooms/BaseRate"}
        };

    var results = searchIndexClient.Documents.Search("*", parameters);
```

## <a name="filter-usage-patterns"></a>Шаблоны использования фильтров

В следующих примерах показаны несколько шаблонов использования для сценариев фильтрации. Дополнительные примеры можно найти в разделе [Примеры OData](https://docs.microsoft.com/azure/search/search-query-odata-filter#examples).

+ Автономный параметр **$filter** без строки запроса полезен, когда выражение фильтра может полностью определить интересующие документы. Без строки запроса не выполняется лексический или лингвистический анализ, нет оценки и рейтинга. Обратите внимание, что строка поиска — это просто звездочка, что означает "сопоставить все документы".

   ```
   search=*&$filter=Rooms/any(room: room/BaseRate ge 60 and room/BaseRate lt 300) and Address/City eq 'Honolulu'
   ```

+ Сочетание строки запроса и **$filter**, где фильтр создает подмножество, а строка запроса предоставляет термины для полнотекстового поиска по отфильтрованному подмножеству. Добавление терминов («театров расстояний») приводит к получению оценок в результатах поиска, где документы, которые лучше соответствуют условиям, ранжированы выше. Использование фильтра с строкой запроса является наиболее распространенным шаблоном использования.

   ```
  search=walking distance theaters&$filter=Rooms/any(room: room/BaseRate ge 60 and room/BaseRate lt 300) and Address/City eq 'Seattle'&$count=true
   ```

+ Составные запросы, разделенные с помощью логического оператора or, каждый со своими критериями фильтра (например, beagles в категории dog или siamese в категории cat). Выражения, Объединенные с, `or` оцениваются по отдельности с объединением документов, соответствующих каждому выражению, отправляемому обратно в ответе. Этот шаблон использования достигается с помощью `search.ismatchscoring` функции. Можно также использовать версию без оценки `search.ismatch` .

   ```
   # Match on hostels rated higher than 4 OR 5-star motels.
   $filter=search.ismatchscoring('hostel') and Rating ge 4 or search.ismatchscoring('motel') and Rating eq 5

   # Match on 'luxury' or 'high-end' in the description field OR on category exactly equal to 'Luxury'.
   $filter=search.ismatchscoring('luxury | high-end', 'Description') or Category eq 'Luxury'&$count=true
   ```

  Можно также объединить полнотекстовый поиск `search.ismatchscoring` с фильтрами `and` , используя вместо `or` , но это функционально эквивалентно использованию `search` `$filter` параметров и в запросе поиска. Например, следующие два запроса дают одинаковый результат:

  ```
  $filter=search.ismatchscoring('pool') and Rating ge 4

  search=pool&$filter=Rating ge 4
  ```

Исчерпывающие сведения о конкретных вариантах использования см. в следующих статьях:

+ [Фильтры аспекта](search-filters-facets.md)
+ [Фильтры языка](search-filters-language.md)
+ [Фильтрация в соответствии с политикой безопасности](search-security-trimming-for-azure-search.md) 

## <a name="field-requirements-for-filtering"></a>Требования к полям для фильтрации

В REST API фильтрация по умолчанию включена *для* простых полей. Фильтруемые поля увеличивают размер индекса. Не забудьте установить `"filterable": false` для полей, которые вы не планируете фактически использовать в фильтре. Дополнительные сведения о параметрах для определения полей см. в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")).

В пакете SDK для .NET фильтруемые поля *отключены* по умолчанию. Можно сделать фильтр для поля, задав для свойства- [фильтра](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.models.field.isfilterable?view=azure-dotnet) соответствующего объекта [поля](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.models.field?view=azure-dotnet) значение `true` . Это также можно сделать декларативно с помощью атрибута с [фильтрацией](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.isfilterableattribute). В приведенном ниже примере атрибут задается для `BaseRate` Свойства класса Model, который сопоставляется с определением индекса.

```csharp
    [IsFilterable, IsSortable, IsFacetable]
    public double? BaseRate { get; set; }
```

### <a name="making-an-existing-field-filterable"></a>Обеспечение фильтрации существующего поля

Нельзя изменить существующие поля, чтобы сделать их фильтруемыми. Вместо этого необходимо добавить новое поле или перестроить индекс. Дополнительные сведения о перестроении индекса или повторном заполнении полей см. [в статье перестроение индекса Azure когнитивный Поиск](search-howto-reindex.md).

## <a name="text-filter-fundamentals"></a>Принципы работы текстовых фильтров

Текстовые фильтры соответствуют строковым полям строк литералов, которые вы задаюте в фильтре. В отличие от полнотекстового поиска, для текстовых фильтров не существует лексического анализа или разбиения слов, поэтому сравнения предназначены только для точных совпадений. Например, предположим, что поле *f* содержит "Sunny Day", `$filter=f eq 'Sunny'` не соответствует, но `$filter=f eq 'sunny day'` будет. 

Текстовые строки учитывают регистр. Отсутствует нижний регистр слов с прописными буквами: `$filter=f eq 'Sunny day'` не находит "Sunny Day".

### <a name="approaches-for-filtering-on-text"></a>Подходы к фильтрации по тексту

| Подход | Описание | Назначение |
|----------|-------------|-------------|
| [`search.in`](search-query-odata-search-in-function.md) | Функция, которая сопоставляет поле со списком строк с разделителями. | Рекомендуется для [фильтров безопасности](search-security-trimming-for-azure-search.md) и для любых фильтров, в которых несколько необработанных текстовых значений должны сопоставляться с строковым полем. Функция **Search.in** разработана для ускорения и намного быстрее, чем явно сравнивать поле с каждой строкой с помощью `eq` и `or` . | 
| [`search.ismatch`](search-query-odata-full-text-search-functions.md) | Функция, которая позволяет совместно использовать операции полнотекстового поиска вместе с операциями строго логического фильтра в одном выражении фильтра. | Используйте **Поиск. Match** (или его эквивалент, **Search. исматчскоринг**), если требуется несколько сочетаний фильтра поиска в одном запросе. Вы также можете использовать ее для фильтра *contains* (для фильтрации в частичной строке в контексте большей строки). |
| [`$filter=field operator string`](search-query-odata-comparison-operators.md) | Определенное пользователем выражение, состоящее из поля, операторов и значений. | Используйте этот параметр, если нужно найти точные соответствия между строковым и строковым значениями. |

## <a name="numeric-filter-fundamentals"></a>Основные компоненты числового фильтра

Числовые поля недоступны для поиска (`searchable`) в контексте полнотекстового поиска. Только строки подлежат полному текстовому поиску. Например, при вводе 99,99 в качестве поискового запроса вы не сможете найти товары по цене 99,99 доллара США. Вместо этого отображаются элементы, которые содержат строку поля документа с номером 99. Таким образом, если у вас есть числовые данные, предполагается, что вы будете использовать их для фильтров, включая диапазоны, аспекты, группы и т. д. 

Документы, содержащие числовые поля (цена, размер, SKU, идентификатор), предоставляют эти значения в результатах поиска, если поле отмечено `retrievable`. Суть в том, что полнотекстовый поиск не применим к числовым типам полей.

## <a name="next-steps"></a>Дальнейшие шаги

Сначала попробуйте использовать **обозреватель поиска** на портале, чтобы отправить запросы с параметрами **$filter**. [Пример индекса выборки недвижимости](search-get-started-portal.md) предоставляет полезные результаты для следующих отфильтрованных запросов при их вставке в строку поиска:

```
# Geo-filter returning documents within 5 kilometers of Redmond, Washington state
# Use $count=true to get a number of hits returned by the query
# Use $select to trim results, showing values for named fields only
# Use search=* for an empty query string. The filter is the sole input

search=*&$count=true&$select=description,city,postCode&$filter=geo.distance(location,geography'POINT(-122.121513 47.673988)') le 5

# Numeric filters use comparison like greater than (gt), less than (lt), not equal (ne)
# Include "and" to filter on multiple fields (baths and bed)
# Full text search is on John Leclerc, matching on John or Leclerc

search=John Leclerc&$count=true&$select=source,city,postCode,baths,beds&$filter=baths gt 3 and beds gt 4

# Text filters can also use comparison operators
# Wrap text in single or double quotes and use the correct case
# Full text search is on John Leclerc, matching on John or Leclerc

search=John Leclerc&$count=true&$select=source,city,postCode,baths,beds&$filter=city gt 'Seattle'
```

Дополнительные примеры можно найти в разделе [Примеры OData](https://docs.microsoft.com/azure/search/search-query-odata-filter#examples).

## <a name="see-also"></a>См. также

+ [How full text search works in Azure Cognitive Search](search-lucene-query-architecture.md) (Как выполняется полнотекстовый поиск в Когнитивном поиске Azure)
+ [Поиск документов REST API](https://docs.microsoft.com/rest/api/searchservice/search-documents)
+ [Простой синтаксис запросов](https://docs.microsoft.com/rest/api/searchservice/simple-query-syntax-in-azure-search)
+ [Синтаксис запросов Lucene](https://docs.microsoft.com/rest/api/searchservice/lucene-query-syntax-in-azure-search)
+ [Поддерживаемые типы данных](https://docs.microsoft.com/rest/api/searchservice/supported-data-types)
