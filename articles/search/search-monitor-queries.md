---
title: Мониторинг запросов
titleSuffix: Azure Cognitive Search
description: Мониторинг метрик запросов для производительности и пропускной способности. Сбор и анализ входов строки запроса в диагностических журналах.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/18/2020
ms.openlocfilehash: a3a313ef9cd74ba901f5a6a2d82a18e3c21145dc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77462533"
---
# <a name="monitor-query-requests-in-azure-cognitive-search"></a>Мониторинг запросов запросов в Azure Cognitive Search

В этой статье объясняется, как измерять производительность запроса и объем с помощью метрик и диагностических журналов. В нем также объясняется, как собирать входные термины, используемые в запросах - необходимую информацию, когда вам нужно оценить полезность и эффективность вашего корпуса поиска.

Исторические данные, которые появляются в метриках, сохраняются в течение 30 дней. Для более длительного хранения или отчета об оперативных данных и строках запроса не забудьте включить [диагностическую настройку,](search-monitor-logs.md) которая определяет опцию хранения для сохраняющихся зарегистрированных событий и метрик.

Условия, которые максимизируют целостность измерения данных, включают:

+ Используйте платежную услугу (услугу, созданную на базовом или стандартном уровне). Бесплатный сервис используется несколькими абонентами, что вводит определенное количество волатильности по мере смещения нагрузок.

+ Используйте одну реплику и раздел, если это возможно, для создания изолированной среды. При использовании нескольких реплик метрик усредненяется по нескольким узлам, что может снизить точность результатов. Аналогичным образом, несколько разделов означают, что данные разделены, с потенциалом того, что некоторые разделы могут иметь разные данные, если индексация также ведется. При настройке производительности запроса один узла и раздела обеспечивает более стабильную среду для тестирования.

> [!Tip]
> С помощью дополнительного кода на стороне клиента и приложений, вы также можете захватить кликовые данные для более глубокого понимания того, что привлекает интерес пользователей приложения. Дополнительные сведения см. в статье [Что такое аналитика поискового трафика?](search-traffic-analytics.md)

## <a name="query-volume-qps"></a>Объем запросов (КПС)

Объем измеряется как **поисковые запросы в секунду** (ЗПС), встроенная метрика, которая может быть сообщена как среднее, количество, минимум или максимальное значение запросов, выполняемых в течение одной минуты окна. В системе фиксируется одноминутные интервалы (TimeGrain - "PT1M") для метрик.

Обычно запросы выполняются в миллисекундах, поэтому в метриках отображаются только запросы, измеряющие сязание секунд.

| Тип статистической обработки | Описание |
|------------------|-------------|
| Среднее | Среднее количество секунд в течение минуты, в течение которой произошло выполнение запроса.|
| Count | Количество метрик, испускаемых журналу в течение одной минуты интервала. |
| Максимальная | Наибольшее количество поисковых запросов в секунду зарегистрировано в течение минуты. |
| Минимальные | Наименьшее количество поисковых запросов в секунду зарегистрировано в течение минуты.  |
| SUM | Сумма всех запросов, выполненных в течение минуты.  |

Например, в течение одной минуты у вас может быть такой шаблон: одна секунда высокой нагрузки, которая является максимальной для Search-a'eperSecond, а затем 58 секунд средней нагрузки, и, наконец, одна секунда только с одним запросом, который является минимальным.

Другой пример: если узла излучает 100 метрик, где значение каждой метрики 40, то "Граф" 100, "Сумма" 4000, "Средний" 40, а "Max" 40.

## <a name="query-performance"></a>Производительность запросов

Производительность запроса в масштабах всей службы измеряется как задержка поиска (сколько времени занимает выполнение запроса) и задушил запросы, которые были удалены в результате спора с ресурсами.

### <a name="search-latency"></a>Задержка поиска

| Тип статистической обработки | Задержка | 
|------------------|---------|
| Среднее | Средняя продолжительность запроса в миллисекундах. | 
| Count | Количество метрик, испускаемых журналу в течение одной минуты интервала. |
| Максимальная | Самый длинный запрос в образце. | 
| Минимальные | Самый короткий запрос в образце.  | 
| Итог | Общее время выполнения всех запросов в образце, выполнение в интервале (одна минута).  |

Рассмотрим следующий пример метрик иметрий **задержки поиска:** было отобрано 86 запросов, средняя продолжительность — 23,26 миллисекунды. Минимум 0 указывает на то, что некоторые запросы были удалены. Самый длинный запрос занял 1000 миллисекунд. Общее время выполнения составило 2 секунды.

![Агрегации задержки](./media/search-monitor-usage/metrics-latency.png "Агрегации задержки")

### <a name="throttled-queries"></a>Застывные запросы

Заминаемые запросы относятся к запросам, которые отброшены вместо процесса. В большинстве случаев регулирование является нормальной частью работы службы.  Это не обязательно признак того, что что-то не так.

Обработка происходит, когда количество обработанных запросов превышает имеющиеся ресурсы. Вы можете увидеть увеличение числа запросов, задушенные, когда реплика выведена из вращения или во время индексации. Запросы запросов и индексирования обрабатываются с помощью одного и того же набора ресурсов.

Служба определяет, следует ли отбросить запросы на основе потребления ресурсов. Процент ресурсов, потребляемых в памяти, процессоре и мокром диске, усредняются в течение определенного периода времени. Если этот процент превышает порог, все запросы в индекс замедляются до тех пор, пока объем запросов не будет уменьшен. 

В зависимости от вашего клиента, задушил запрос может быть указан таким образом:

+ Служба возвращает ошибку "Вы отправляете слишком много запросов. Повторите попытку позже". 
+ Служба возвращает код ошибки 503, указывающий на то, что служба в настоящее время недоступна. 
+ Если вы используете портал (например, Search Explorer), запрос отбрасывается молча, и вам нужно будет нажать Поиск снова.

Для подтверждения задушенные запросы используйте метрика **запросов с задушенной.** Вы можете изучить метрики на портале или создать метрику оповещения, описанную в этой статье. Для запросов, которые были удалены в интервале выборки, используйте *Total,* чтобы получить процент невыполненных запросов.

| Тип статистической обработки | Регулирование |
|------------------|-----------|
| Среднее | Процент запросов снизился в интервале. |
| Count | Количество метрик, испускаемых журналу в течение одной минуты интервала. |
| Максимальная | Процент запросов снизился в интервале.|
| Минимальные | Процент запросов снизился в интервале. |
| Итог | Процент запросов снизился в интервале. |

Для **заминаемых поисковых запросов Процент**, минимальный, максимальный, средний и общий, все имеют одинаковое значение: процент поисковых запросов, которые были задушен, от общего числа поисковых запросов в течение одной минуты.

На следующем скриншоте первым номером является количество (или количество метрик, отправленных в журнал). Дополнительные агрегаты, которые появляются в верхней части или при нависении над метрикой, включают средний, максимальный и общий объем. В этом примере запросы не были отклонены.

![Застывные агрегации](./media/search-monitor-usage/metrics-throttle.png "Застывные агрегации")

## <a name="explore-metrics-in-the-portal"></a>Изучение метрик на портале

Для быстрого просмотра текущих чисел, вкладка **Мониторинг** на странице обзор службы показывает три метрики **(Задержка поиска**, Поиск запросов в **секунду (на единицу поиска)**, **Throttled Поисковые запросы Процент**) за фиксированные интервалы измеряется в часы, дни и недели, с возможностью изменения типа агрегации.

Для более глубокого исследования, открытые метрики исследователь из меню **мониторинга,** так что вы можете слой, увеличить и визуализировать данные для изучения тенденций или аномалий. Узнайте больше об исследователе метрик, заполнив этот [учебник по созданию диаграммы метрик.](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-metrics-explorer)

1. В разделе Мониторинг выберите **метрики,** чтобы открыть исследователь метрик с областью, установленной для поисковой службы.

1. В рамках Metric выберите один из списка выпадающих и просмотрите список доступных агрегаций для предпочтительного типа. Агрегация определяет, как собранные значения будут отбираться в течение каждого интервала времени.

   ![Исследователь метрик для метрики ЗПС](./media/search-monitor-usage/metrics-explorer-qps.png "Исследователь метрик для метрики ЗПС")

1. В правом верхнем углу установите временной интервал.

1. Выберите визуализацию. По умолчанию это диаграмма строки.

1. Слой дополнительных агрегаций, выбрав **добавленную метрику** и выбрав различные агрегации.

1. Увеличьте масштаб в область интереса на линии диаграммы. Установите указатель мыши на начальную точку диапазона, щелкните и удерживайте левую кнопку мыши, перетащите указатель до противоположной стороны диапазона и отпустите кнопку. Масштаб диаграммы изменится так, чтобы она отображала выбранный диапазон времени.

## <a name="identify-strings-used-in-queries"></a>Определение строк, используемых в запросах

При включании системы диагностической регистрации система фиксирует запросы запросов в таблице **AzureDiagnostics.** В качестве предварительного условия необходимо уже включено [диагностическое ведение,](search-monitor-logs.md)указание рабочего пространства аналитики журналов или другой вариант хранения.

1. В разделе Мониторинг выберите **журналы,** чтобы открыть пустое окно запроса в журнале Analytics.

1. Выполнить следующее выражение для поиска операций query.Search, вернув табулярный набор результатов, состоящий из имени операции, строки запроса, запрошенного индекса и количества найденных документов. Последние две инструкции исключают строки запроса, состоящие из пустого или неопределенного поиска, по индексу образца, что сокращает шум в результатах.

   ```
   AzureDiagnostics
   | project OperationName, Query_s, IndexName_s, Documents_d
   | where OperationName == "Query.Search"
   | where Query_s != "?api-version=2019-05-06&search=*"
   | where IndexName_s != "realestate-us-sample-index"
   ```

1. Дополнительно установите фильтр колонки на *Query_s* для поиска по определенному синтаксису или строке. Например, можно отфильтровать, что `?api-version=2019-05-06&search=*&%24filter=HotelName` *равно).*

   ![Строки входа в журнал](./media/search-monitor-usage/log-query-strings.png "Строки входа в журнал")

В то время как этот метод работает для специального расследования, создание отчета позволяет консолидировать и представить строки запроса в макете, более благоприятном для анализа.

## <a name="identify-long-running-queries"></a>Определение долгосрочных запросов

Добавьте столбец продолжительности, чтобы получить номера для всех запросов, а не только те, которые подобраны в качестве метрики. Сортировка этих данных показывает, какие запросы занимают больше всего времени.

1. В разделе Мониторинг выберите **журналы** для запроса информации о журнале.

1. Выполнить следующий запрос для возврата запросов, отсортированных по продолжительности в миллисекундах. Самые длительные запросы находятся в верхней части.

   ```
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search"
   | sort by DurationMs
   ```

   ![Сортировать запросы по продолжительности](./media/search-monitor-usage/azurediagnostics-table-sortby-duration.png "Сортировать запросы по продолжительности")

## <a name="create-a-metric-alert"></a>Создание оповещения для метрики

Метрика оповещения устанавливает порог, при котором вы будете либо получать уведомления или вызвать корректирующие действия, которые вы определяете заранее. 

Для поисковой службы обычно создается метрическое оповещение о задержке поиска и задушенные запросы. Если вы знаете, когда запросы отброшены, вы можете искать средства правовой защиты, которые снижают нагрузку или увеличивают емкость. Например, если при индексации частота запросов увеличивается, можно отложить его до тех пор, пока действие запроса не утихнет.

При нажатии пределов определенной конфигурации раздела реплики также полезно настраивать оповещения для пороговых значений объема запросов (КПС).

1. В разделе Мониторинг выберите **оповещения,** а затем нажмите **кнопку «Новое правило оповещения».** Убедитесь, что служба поиска выбрана в качестве ресурса.

1. В соответствии с условием, нажмите **Добавить**.

1. Настройка логики сигнала. Для типа сигнала выберите **метрики,** а затем выберите сигнал.

1. После выбора сигнала можно использовать диаграмму для визуализации исторических данных для принятия обоснованного решения о том, как действовать с настройкой условий.

1. Далее прокрутите вниз до логики оповещения. Для проверки концепции можно указать искусственно низкое значение для целей тестирования.

   ![Логика оповещения](./media/search-monitor-usage/alert-logic-qps.png "Логика оповещения")

1. Затем укажите или создайте Группу действий. Это ответ на запрос при соблюдении порога. Это может быть push-уведомление или автоматический ответ.

1. Наконец, укажите сведения оповещения. Назовите и опишите оповещение, назначайте значение серьезности и укажите, следует ли создавать правило в включенном или отключенном состоянии.

   ![Сведения об оповещении](./media/search-monitor-usage/alert-details.png "Сведения об оповещении")

Если вы указали уведомление по электронной почте, вы получите электронное письмо от "Microsoft `<your rule name>`Azure" с строкой темы "Azure: Активированная серьезность: 3 ".

<!-- ## Report query data

Power BI is an analytical reporting tool useful for visualizing data, including log information. If you are collecting data in Blob storage, a Power BI template makes it easy to spot anomalies or trends. Use this link to download the template. -->

## <a name="next-steps"></a>Дальнейшие действия

Если вы еще не сделали этого, просмотрите основы мониторинга поисковых служб, чтобы узнать о полном спектре возможностей надзора.

> [!div class="nextstepaction"]
> [Мониторинг операций и действий в Azure Cognitive Search](search-monitor-usage.md)