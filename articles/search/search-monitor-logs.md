---
title: Получение данных журнала
titleSuffix: Azure Cognitive Search
description: Собирайте и анализируйте данные журнала, включив параметр диагностики, а затем используйте язык запросов Kusto для просмотра результатов.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/11/2020
ms.openlocfilehash: 2849dc94f1c45dda3da09120adebba6e004eb96b
ms.sourcegitcommit: 2823677304c10763c21bcb047df90f86339e476a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2020
ms.locfileid: "77211182"
---
# <a name="collect-and-analyze-log-data-for-azure-cognitive-search"></a>Собирайте и анализируйте данные журналов для Когнитивный поиск Azure

Журнал диагностики или операционные журналы предоставляют подробные сведения об операциях Azure Когнитивный поиск и полезны для мониторинга процессов обслуживания и рабочих нагрузок. На внутреннем уровне журналы существуют в серверной части короткое время, достаточное для наблюдения и анализа на случай обращения в службу поддержки. Однако, если требуется самостоятельное управление данными, следует настроить параметр диагностики, чтобы указать, где собираются данные журнала. 

Настройка журналов полезна для диагностики и сохранения журнала операций. После включения ведения журнала можно выполнять запросы или создавать отчеты для структурированного анализа.

В следующей таблице перечисляются параметры для сбора и сохранения данных.

| Ресурс | Используется для |
|----------|----------|
| [Отправить в Log Analytics рабочую область](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-resource-logs) | Зарегистрированные в журнале события и метрики запросов, основанные на приведенных ниже схемах. События записываются в рабочую область Log Analytics. С помощью Log Analytics можно выполнять запросы для получения подробных сведений. Дополнительные сведения см. в статье [Приступая к работе с журналами Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-viewdata) . |
| [Архив с хранилищем BLOB-объектов](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-overview) | Зарегистрированные в журнале события и метрики запросов, основанные на приведенных ниже схемах. События записываются в контейнер больших двоичных объектов и хранятся в JSON-файлах. Журналы могут быть достаточно детализированы (час в минуту), что полезно для повторного поиска конкретного инцидента, но не для исследования с открытым окончанием. Используйте редактор JSON для просмотра файла журнала.|
| [Поток в концентратор событий](https://docs.microsoft.com/azure/event-hubs/) | Зарегистрированные события и метрики запросов в соответствии со схемами, описанными в этой статье. Выберите этот вариант в качестве альтернативной службы сбора данных для очень больших журналов. |

И Azure Monitor журналы, и хранилище BLOB-объектов доступны в качестве бесплатной службы, чтобы вы могли испытать их бесплатно за время существования подписки Azure. Вы можете бесплатно зарегистрироваться в Application Insights и использовать это решение до тех пор, пока размер данных приложения находится в заданных пределах (чтобы узнать больше, перейдите на [страницу цен](https://azure.microsoft.com/pricing/details/monitor/)).

## <a name="prerequisites"></a>Предварительные требования

Если вы используете Log Analytics или службу хранилища Azure, вы можете создавать ресурсы заранее.

+ [Создание рабочей области log Analytics](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace)

+ [Создайте учетную запись хранения](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account) , если требуется Архив журналов.

## <a name="create-a-log"></a>Создание журнала

Параметры диагностики определяют сбор данных. Параметр указывает, как и что собирается. 

1. В разделе **Мониторинг** выберите **Параметры диагностики**.

   ![Параметры диагностики](./media/search-monitor-usage/diagnostic-settings.png "Параметры диагностики")

1. Выберите **+ Добавить параметр диагностики**

1. Выберите данные, которые требуется экспортировать: журналы, метрики или и то и другое. Вы можете получать данные в учетной записи хранения, рабочей области log Analytics или передавать их в концентратор событий.

   Рекомендуется использовать log Analytics, так как вы можете запросить рабочую область на портале.

   Если вы также используете хранилище BLOB-объектов, контейнеры и большие двоичные объекты будут создаваться по мере необходимости при экспорте данных журнала.

   ![Настройка сбора данных](./media/search-monitor-usage/configure-storage.png "Настройка сбора данных")

1. Сохраните параметр.

1. Протестируйте, создавая или удаляя объекты (создает события журнала) и отправляя запросы (создает метрики). 

В хранилище BLOB-объектов контейнеры создаются, только если имеется действие для записи в журнал или для меры. При копировании в учетную запись хранения данные представляются в формате JSON и размещаются в двух контейнерах:

* insights-logs-operationlogs: для поиска журналов трафика
* insights-metrics-pt1m: для метрик

**Это займет один час, прежде чем контейнеры будут отображаться в хранилище BLOB-объектов. В каждом контейнере имеется один большой двоичный объект (в час).**

Журналы архивируются каждый час, в котором происходит действие. Следующий путь является примером одного файла журнала, созданного на 12 2020 января в 9:00 утра. где каждый `/` является папкой: `resourceId=/subscriptions/<subscriptionID>/resourcegroups/<resourceGroupName>/providers/microsoft.search/searchservices/<searchServiceName>/y=2020/m=01/d=12/h=09/m=00/name=PT1H.json`

## <a name="log-schema"></a>Схема журнала

Структуры данных, содержащие данные журнала Когнитивный поиск Azure, соответствуют приведенной ниже схеме. 

Для хранилища BLOB-объектов у каждого большого двоичного объекта есть один корневой объект, именуемый **записями** , содержащими массив объектов журнала. Каждый большой двоичный объект содержит записи о всех операциях, которые выполнялась в течение одного часа.

В следующей таблице приведен неполный список полей, общих для ведения журнала диагностики.

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| timeGenerated |datetime |"2018-12-07T00:00:43.6872559Z" |Метка времени операции |
| resourceId |string |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/> MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор вашего ресурса |
| operationName |string |"Query.Search" |Имя операции |
| operationVersion |string |"2019-05-06" |Используемая версия API |
| category |string |"OperationLogs" |константа |
| resultType |string |Success |Возможные значения: Success или Failure |
| resultSignature |int |200 |Код результата HTTP |
| durationMS |int |50 |Время выполнения операции в миллисекундах |
| подключения |object |См. следующую таблицу |Объект, содержащий данные об операции |

### <a name="properties-schema"></a>Схема свойств

Ниже перечислены свойства, характерные для Azure Когнитивный поиск.

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| Description_s |string |"GET /indexes('content')/docs" |Конечная точка операции |
| Documents_d |int |42 |Количество обработанных документов |
| IndexName_s |string |"Test-index" |Имя индекса, связанного с операцией |
| Query_s |string |"?search=AzureSearch&$count=true&api-version=2019-05-06" |Параметры запроса |

## <a name="metrics-schema"></a>Схема метрик

Метрики записываются для запросов запросов и измеряются через одну минуту. Каждая метрика отражает минимальное, максимальное и среднее значения за минуту. Дополнительные сведения см. в разделе [мониторинг запросов запросов](search-monitor-queries.md).

| Имя | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| resourceId |string |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/>MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор ресурса |
| metricName |string |"Latency" |имя метрики |
| time |datetime |"2018-12-07T00:00:43.6872559Z" |метка времени операции |
| average |int |64 |Среднее значение необработанных выборок в интервале времени метрики, единицах в секундах или процентах, в зависимости от метрики. |
| минимум |int |37 |Минимальное значение необработанных выборок в интервале времени метрики, единицах в секундах. |
| максимум |int |78 |Максимальное значение необработанных выборок в интервале времени метрики, единицах в секундах.  |
| total |int |258 |Общее значение необработанных образцов в интервале времени метрики, единицах в секундах.  |
| count |int |4 |Количество метрик, выдаваемых из узла в журнал в течение интервала в одну минуту.  |
| timegrain |string |"PT1M" |Гран времени метрики в ISO 8601. |

Обычно запросы выполняются в миллисекундах, поэтому в метриках, таких как QPS, отображаются только запросы, измеряющие секунды.

Для метрики **поисковых запросов в секунду** минимальное значение является наименьшим значением для поисковых запросов в секунду, зарегистрированных в течение этой минуты. То же относится и к максимальному значению. Средним является совокупное значение за всю минуту. Например, в течение одной минуты у вас может быть один из следующих шаблонов: одна секунда высокой нагрузки, которая является максимальным значением для SearchQueriesPerSecond, за которой следует 58 секунд средней нагрузки и, наконец, одна секунда только с одним запросом, который является минимальным значением.

Для **регулируемых запросов поиска в процентах**, минимуме, максимуме, среднем и общем значении все имеют одинаковое значение: процент запросов поиска, которые были отрегулированы, от общего числа поисковых запросов в течение одной минуты.

## <a name="view-log-files"></a>Просмотр файлов журнала

Хранилище BLOB-объектов используется для архивирования файлов журналов. Для просмотра файла журнала можно использовать любой редактор JSON. Если у вас его нет, мы рекомендуем [Visual Studio Code](https://code.visualstudio.com/download).

1. Откройте колонку "Учетная запись хранения" на портале Azure. 

2. В области навигации слева щелкните **Большие двоичные объекты**. Должны отобразиться контейнеры **insights-logs-operationlogs** и **insights-metrics-pt1m**. Эти контейнеры создаются Когнитивный поиск Azure при экспорте данных журнала в хранилище BLOB-объектов.

3. Разворачивайте иерархию папок, пока не достигнете JSON-файла.  Используйте контекстное меню для скачивания файла.

Откройте скачанный файл в редакторе JSON, чтобы просмотреть содержимое.

## <a name="next-steps"></a>Следующие шаги

Если вы еще не сделали этого, ознакомьтесь с основами мониторинга службы поиска, чтобы узнать о полном диапазоне возможностей.

> [!div class="nextstepaction"]
> [Мониторинг операций и действий в Azure Когнитивный поиск](search-monitor-usage.md)