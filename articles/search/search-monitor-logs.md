---
title: Сбор данных журнала
titleSuffix: Azure Cognitive Search
description: Сбор и анализ данных журнала, включив диагностическую настройку, а затем используйте язык кюсто-запроса для изучения результатов.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/18/2020
ms.openlocfilehash: 86e869bc08552ea11728c508486a4784eccf4042
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77462376"
---
# <a name="collect-and-analyze-log-data-for-azure-cognitive-search"></a>Сбор и анализ данных журнала для когнитивного поиска Azure

Диагностические или эксплуатационные журналы дают представление о подробных операциях Azure Cognitive Search и полезны для мониторинга служб ы и процессов рабочей нагрузки. На внутреннем уровне журналы существуют в серверной части короткое время, достаточное для наблюдения и анализа на случай обращения в службу поддержки. Однако, если требуется самонаправление над оперативными данными, следует настроить диагностическую настройку, чтобы указать, где собирается информация о ходе регистрации.

Настройка журналов полезна для диагностики и сохранения эксплуатационного прошлого. После включения журнала можно запускать запросы или создавать отчеты для структурированного анализа.

В следующей таблице перечислены варианты сбора и сохранения данных.

| Ресурс | Используется для |
|----------|----------|
| [Отправка в рабочее пространство log Analytics](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-resource-logs) | События и метрики отправляются в рабочее пространство Log Analytics, которое может быть запрошено на портале для возврата подробной информации. Для введения [см.](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-viewdata) |
| [Архив с хранением Blob](https://docs.microsoft.com/azure/storage/blobs/storage-blobs-overview) | События и метрики архивируются в контейнере Blob и хранятся в файлах JSON. Логи могут быть довольно гранулированными (по часам/минуте), полезными для исследования конкретного инцидента, но не для открытого расследования. Используйте редактор JSON для просмотра необработанного файла журнала или Power BI для агрегирования и визуализации данных журнала.|
| [Поток в концентратор событий](https://docs.microsoft.com/azure/event-hubs/) | События и метрики передаются в службу концентраторов azure Event Hubs. Выберите этот вариант в качестве альтернативной службы сбора данных для очень больших журналов. |

Как журналы Azure Monitor, так и хранилище Blob доступны как бесплатная услуга, так что вы можете попробовать ее бесплатно в течение всего срока действия подписки Azure. Вы можете бесплатно зарегистрироваться в Application Insights и использовать это решение до тех пор, пока размер данных приложения находится в заданных пределах (чтобы узнать больше, перейдите на [страницу цен](https://azure.microsoft.com/pricing/details/monitor/)).

## <a name="prerequisites"></a>Предварительные требования

Если вы используете log Analytics или Хранилище Azure, вы можете создавать ресурсы заранее.

+ [Создание рабочего пространства аналитики журналов](https://docs.microsoft.com/azure/azure-monitor/learn/quick-create-workspace)

+ [Создание учетной записи хранилища](https://docs.microsoft.com/azure/storage/common/storage-quickstart-create-account)

## <a name="enable-data-collection"></a>Включение сбора данных

Диагностические настройки определяют порядок сбора зарегистрированных событий и метрик.

1. В разделе **Мониторинг** выберите **Параметры диагностики**.

   ![Диагностические настройки](./media/search-monitor-usage/diagnostic-settings.png "Параметры диагностики")

1. Выберите **и добавьте диагностическую настройку**

1. Проверьте **аналитику журнала,** выберите рабочее пространство и выберите **OperationLogs** и **AllMetrics.**

   ![Настройка сбора данных](./media/search-monitor-usage/configure-storage.png "Настройка сбора данных")

1. Сохранить настройки.

1. После включения журнала используйте службу поиска для начала генерации журналов и метрик. Это займет время, прежде чем зарегистрированные события и метрики становятся доступными.

Для журнала Analytics, это будет несколько минут, прежде чем данные доступны, после чего вы можете запустить kusto запросы для возвращения данных. Для получения дополнительной информации смотрите [запросы запросов Монитора](search-monitor-logs.md).

Для хранения Blob требуется один час, прежде чем контейнеры появятся в хранилище Blob. Для каждого часа и каждого контейнера создается один большой двоичный объект. Контейнеры создаются только при наличии действия для записи в журнал или измерения. При копировании в учетную запись хранения данные представляются в формате JSON и размещаются в двух контейнерах:

+ insights-logs-operationlogs: для поиска журналов трафика
+ insights-metrics-pt1m: для метрик

## <a name="query-log-information"></a>Информация о журнале запросов

В диагностических журналах две таблицы содержат журналы и метрики для когнитивного поиска Azure: **AzureDiagnostics** и **AzureMetrics.**

1. Под **мониторингом,** выберите **журналы**.

1. Введите **AzureMetrics** в окне запроса. Выполнить этот простой запрос, чтобы ознакомиться с данными, собранными в этой таблице. Прокрутите таблицу для просмотра метрик и значений. Обратите внимание на количество записей в верхней части, и если служба собирает метрики на некоторое время, вы можете настроить временной интервал, чтобы получить управляемый набор данных.

   ![Таблица AzureMetrics](./media/search-monitor-usage/azuremetrics-table.png "Таблица AzureMetrics")

1. Введите следующий запрос, чтобы вернуть табулярный набор результатов.

   ```
   AzureMetrics
    | project MetricName, Total, Count, Maximum, Minimum, Average
   ```

1. Повторите предыдущие шаги, начиная с **AzureDiagnostics,** чтобы вернуть все столбцы в информационных целях, а затем более избирательный запрос, который извлекает более интересную информацию.

   ```
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search" 
   ```

   ![Таблица AzureDiagnostics](./media/search-monitor-usage/azurediagnostics-table.png "Таблица AzureDiagnostics")

## <a name="log-schema"></a>Схема журнала

Структуры данных, содержащие данные журнала Azure Cognitive Search, соответствуют приведенной ниже схеме. 

Для хранения Blob каждый капля имеет один корневой объект, называемый **записями,** содержащими массив объектов журнала. Каждый большой двоичный объект содержит записи о всех операциях, которые выполнялась в течение одного часа.

Следующая таблица представляет собой частичный список полей, общих для диагностических журналов.

| name | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| timeGenerated |DATETIME |"2018-12-07T00:00:43.6872559Z" |Метка времени операции |
| resourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/>  MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор вашего ресурса |
| operationName |строка |"Query.Search" |Имя операции |
| operationVersion |строка |"2019-05-06" |Используемая версия API |
| категория |строка |"OperationLogs" |constant |
| resultType |строка |Success |Возможные значения: Success или Failure |
| resultSignature |INT |200 |Код результата HTTP |
| durationMS |INT |50 |Время выполнения операции в миллисекундах |
| properties |объект |См. следующую таблицу |Объект, содержащий данные об операции |

### <a name="properties-schema"></a>Схема свойств

Свойства ниже специфичны для когнитивного поиска Azure.

| name | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| Description_s |строка |"GET /indexes('content')/docs" |Конечная точка операции |
| Documents_d |INT |42 |Количество обработанных документов |
| IndexName_s |строка |"тест-индекс" |Имя индекса, связанного с операцией |
| Query_s |строка |"?поиск-AzureSearch&$count-истинный&api-версия-2019-05-06" |Параметры запроса |

## <a name="metrics-schema"></a>Схема метрик

Метрики фиксируются для запросов запросов и измеряются с интервалом в одну минуту. Каждая метрика отражает минимальное, максимальное и среднее значения за минуту. Для получения дополнительной информации смотрите [запросы запросов Монитора](search-monitor-queries.md).

| name | Тип | Пример | Примечания |
| --- | --- | --- | --- |
| resourceId |строка |"/SUBSCRIPTIONS/11111111-1111-1111-1111-111111111111/<br/>RESOURCEGROUPS/DEFAULT/PROVIDERS/<br/> MICROSOFT.SEARCH/SEARCHSERVICES/SEARCHSERVICE" |Идентификатор ресурса |
| metricName |строка |"Latency" |имя метрики |
| time |DATETIME |"2018-12-07T00:00:43.6872559Z" |метка времени операции |
| average |INT |64 |Среднее значение необработанных образцов в метрическом интервале времени, единицы в секундах или процентах, в зависимости от метрики. |
| minimum |INT |37 |Минимальное значение необработанных образцов в метрическом интервале времени, единицы в секундах. |
| maximum |INT |78 |Максимальное значение исходных образцов в метрическом интервале времени, единицы в секундах.  |
| total |INT |258 |Общая стоимость необработанных образцов в метрическом интервале времени, единицы в секундах.  |
| count |INT |4 |Количество метрик, испускаемых от узла к журналу в течение одной минуты интервала.  |
| timegrain |строка |"PT1M" |Временное зерно метрики в ISO 8601. |

Обычно запросы выполняются в миллисекундах, поэтому в метрике, как и в метрике, как кПС, отображаются только запросы, измеряющие ся в секундах.

Для **метрики поиска на вторую** метрику минимум является самым низким значением для поисковых запросов в секунду, которое было зарегистрировано в течение этой минуты. То же относится и к максимальному значению. Средним является совокупное значение за всю минуту. Например, в течение одной минуты у вас может быть такой шаблон: одна секунда высокой нагрузки, которая является максимальной для Search-a'eperSecond, а затем 58 секунд средней нагрузки, и, наконец, одна секунда только с одним запросом, который является минимальным.

Для **заминаемых поисковых запросов Процент**, минимальный, максимальный, средний и общий, все имеют одинаковое значение: процент поисковых запросов, которые были задушен, от общего числа поисковых запросов в течение одной минуты.

## <a name="view-raw-log-files"></a>Просмотр необработанных файлов журналов

Хранилище Blob используется для архивирования файлов журналов. Для просмотра файла журнала можно использовать любой редактор JSON. Если у вас его нет, мы рекомендуем [Visual Studio Code](https://code.visualstudio.com/download).

1. Откройте колонку "Учетная запись хранения" на портале Azure. 

2. В области навигации слева щелкните **Большие двоичные объекты**. Должны отобразиться контейнеры **insights-logs-operationlogs** и **insights-metrics-pt1m**. Эти контейнеры создаются Azure Cognitive Search при экспорте данных журнала в хранилище Blob.

3. Разворачивайте иерархию папок, пока не достигнете JSON-файла.  Используйте контекстное меню для скачивания файла.

Откройте скачанный файл в редакторе JSON, чтобы просмотреть содержимое.

## <a name="next-steps"></a>Дальнейшие действия

Если вы еще не сделали этого, просмотрите основы мониторинга поисковых служб, чтобы узнать о полном спектре возможностей надзора.

> [!div class="nextstepaction"]
> [Мониторинг операций и действий в Azure Cognitive Search](search-monitor-usage.md)