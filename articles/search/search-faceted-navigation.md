---
title: Добавить иерархию категорий навигации с аспектами
titleSuffix: Azure Cognitive Search
description: Добавление аспектной навигации для самостоятельной фильтрации в приложениях поиска, которые интегрируются с Azure Когнитивный поиск.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: 5f4435ca213584fff84f3ddad9bda6f7e06628a1
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79283164"
---
# <a name="how-to-implement-faceted-navigation-in-azure-cognitive-search"></a>Как реализовать аспектную навигацию в Azure Когнитивный поиск

Фасетная навигация представляет собой механизм фильтрации, обеспечивающий самоуправляемую детализированную навигацию в приложениях поиска. Термин "фасетная навигация" может быть неизвестен вам, но вы, вероятно, использовали этот механизм ранее. Как показано в следующем примере, фасетная навигации — это не что иное, как категории, с помощью которых фильтруются результаты.

 ![Демонстрация портала заданий Azure Когнитивный поиск](media/search-faceted-navigation/azure-search-faceting-example.png "Демонстрация портала заданий Azure Когнитивный поиск")

Фасетная навигация — это альтернативная точка входа в поиск. Ее можно использовать вместо того, чтобы вручную вводить сложные выражения поиска. С помощью аспектов можно найти то, что вы ищете, и не получать нулевые результаты. Как разработчик, аспекты позволяют предоставлять наиболее полезные условия поиска для навигации по индексу поиска. В онлайновых приложениях для розничной торговли многогранные навигации часто создаются с использованием торговых марок, отделов (обувьов детей), размера, цены, популярности и оценок. 

Способ реализации фасетной навигации зависит от технологии поиска. В Когнитивный поиск Azure многогранная Навигация строится во время запроса с использованием полей, которые ранее были заданы в схеме.

-   Создаваемые приложением запросы должны включать *параметры запроса фасета*, чтобы получить доступные значения фильтра фасетов для получаемого в результате набора документов.

-   Чтобы усечь результирующий набор документов, приложение должно также применить выражение `$filter`.

При разработке приложений основную часть работы составляет написание кода, который создает запросы. Многие функции, ожидаемые от фасетной навигации, реализуются в приложении с помощью службы, которая среди прочего обеспечивает встроенную поддержку определения диапазонов и получение количества результатов, полученных с использованием аспекта. Кроме того, служба включает понятные значения по умолчанию, которые помогают упростить структуру навигации. 

## <a name="sample-code-and-demo"></a>Пример кода и демонстрация
В этой статье в качестве примера используется портал поиска работы. Он реализован в виде приложения ASP.NET MVC.

- Просмотрите и протестируйте рабочую демонстрацию в Интернете на [портале заданий Azure когнитивный Поиск](https://aka.ms/azjobsdemo).

- Скачайте код из [репозитория примеров Azure на GitHub](https://github.com/Azure-Samples/search-dotnet-asp-net-mvc-jobs).

## <a name="get-started"></a>Начало работы
Если вы ранее не разрабатывали средства поиска, представьте, что фасетная навигация обеспечивает возможности самоуправляемого поиска. Это тип детального поиска, основанный на стандартных фильтрах, который позволяет быстро ограничивать результаты поиска с помощью действий «точка-щелчок». 

### <a name="interaction-model"></a>Модель взаимодействия

Поиск по аспектной навигации выполняется последовательно, поэтому давайте начнем с понимания его как последовательность запросов, unfold в ответ на действия пользователя.

Начальная точка — страница приложения, которая обеспечивает фасетную навигацию (возможности которой, как правило, представлены на периферии). Часто фасетная навигации представляет из себя древовидную структуру с флажками для каждого значения или текстом, который можно щелкнуть. 

1. Запрос, отправленный в Azure Когнитивный поиск задает структуру навигации с аспектами с помощью одного или нескольких параметров запроса аспекта. Например, запрос может включать элемент `facet=Rating` с необязательным параметром `:values` или `:sort`, дополнительно уточняющим представление данных.
2. Уровень представления данных прорисовывает страницу поиска с возможностями фасетной навигации, используя указанные в запросе фасеты.
3. Если структура фасетной навигации включает оценку, чтобы отобразить исключительно продукты с оценкой 4 или выше, вам нужно щелкнуть "4". 
4. В ответ приложение отправляет запрос, включающий `$filter=Rating ge 4` 
5. Уровень представления данных обновляет страницу, показывая сокращенный результирующий набор, который содержит только элементы, соответствующие новым условиям (в этом случае — продукты с оценкой 4 и выше).

Фасет — это параметр запроса. Однако его не следует путать с входными данными запроса. Он никогда не используется в качестве критериев выбора в запросе. Вместо этого рассматривайте параметры запроса фасета как входные данные в структуре переходов, возвращаемой в ответе. Для каждого предоставленного параметра запроса аспекта Azure Когнитивный поиск оценивает количество документов в частичных результатах для каждого значения аспекта.

Обратите внимание на выражение `$filter` в шаге 4. Этот фильтр является важным аспектом фасетной навигации. Хотя фасеты и фильтры являются независимыми в интерфейсе API, для реализации нужных возможностей вам понадобятся и те, и другие. 

### <a name="app-design-pattern"></a>Конструктивный шаблон приложения

В коде приложения шаблон состоит в использовании параметров запроса фасета для возврата структуры фасетной навигации вместе с результатами фасета, а также выражения $filter,  которое обрабатывает событие щелчка в значении фасета. Представьте выражение `$filter` кодом, который обеспечивает фактическое усечение результатов поиска, возвращаемых на уровень представления данных. Предположим, что у нас есть фасет Colors (Цвета). Если щелкнуть цвет Red (Красный), с помощью выражения `$filter` будут выбраны элементы исключительно красного цвета. 

### <a name="query-basics"></a>Основы запросов

В Когнитивный поиск Azure запрос задается через один или несколько параметров запроса (описание каждого из них см. в [документах поиска](https://docs.microsoft.com/rest/api/searchservice/Search-Documents) ). Ни один из параметров запроса не является обязательным, но при этом необходимо указать по крайней мере один параметр запроса.

Точность, которая рассматривается как возможность фильтровать ненужные совпадения, обеспечивается с помощью одного или обоих следующих выражений:

-   **Поиск =**  
    Значение этого параметра представляет из себя выражение поиска. Это может быть текстовый фрагмент или сложное выражение поиска, которое включает в себя несколько условий и операторов. На сервере выражение поиска используется для полнотекстового поиска. Оно запрашивает соответствующие условия в индексе в пределах полей, поддерживающих поиск, и возвращает результаты в порядке ранжирования. Если задать для выражения `search` значение NULL, запрос будет выполняться в пределах всего индекса (то есть `search=*`). В этом случае другие элементы запроса, такие как `$filter` или профиль оценки, будут основными факторами, определяющими возвращаемые документы (`($filter`) и порядок их возвращения (`scoringProfile` или `$orderby`).

-   **$filter =**  
     Фильтр — это мощный механизм ограничения количества результатов поиск а на основе значений атрибутов конкретных документов. Сначала оценивается выражение `$filter` , после чего логика по фасетному принципу создает допустимые значения и определяет количественные показатели каждого из них.

Сложные выражения поиска снижают производительность запроса. По возможности используйте правильно сформированные выражения фильтров, чтобы повысить точность и производительность запросов.

Чтобы лучше понять, как фильтр улучшает точность поиска, сравните сложное выражение поиска с выражением, которое включает в себя выражение фильтра.

-   `GET /indexes/hotel/docs?search=lodging budget +Seattle –motel +parking`
-   `GET /indexes/hotel/docs?search=lodging&$filter=City eq 'Seattle' and Parking and Type ne 'motel'`

Оба запроса являются допустимыми, но второй является старшим, если вы ищете не мотелей с стоянкой в Сиэтле.
-   В первом запросе используются конкретные слова, которые упоминаются или не упоминаются в полях строк, таких как Name (Имя) или Description (Описание), и других полях с данными, поддерживающими поиск.
-   Второй запрос выполняет поиск точных совпадений среди структурированных данных и, скорее всего, вернет гораздо более точные результаты.

В приложениях, содержащих фасетную навигацию, необходимо убедиться, что все действия, которые выполняет пользователь со структурой фасетной навигации, сопровождаются сужением результатов поиска. Чтобы сузить результаты, используйте выражение фильтра.

<a name="howtobuildit"></a>

## <a name="build-a-faceted-navigation-app"></a>Создание приложения с фасетной навигацией
Вы реализуете аспектную навигацию с помощью Когнитивный поиск Azure в коде приложения, который создает поисковый запрос. Фасетная навигация зависит от определенных ранее элементов схемы.

В индексе поиска предопределяются такие элементы, как атрибут индекса `Facetable [true|false]` , который задается для выбранных полей, чтобы включить или отключить их использование в структуре фасетной навигации. Если поле не содержит атрибута `"Facetable" = true`, его невозможно использовать в фасетной навигации.

Уровень представления данных в коде обеспечивает взаимодействие с пользователем. Он должен содержать составные части фасетной навигации, например метку, значения, флажки и счетчик. REST API Когнитивный поиск Azure не зависит от платформы, поэтому следует использовать любой язык и платформу. Важно включить элементы пользовательского интерфейса, поддерживающие добавочное обновление. При этом состояние пользовательского интерфейса должно обновляться при выборе каждого дополнительного фасета. 

Во время выполнения запроса код приложения создает запрос, который включает элемент `facet=[string]`— параметр запроса, указывающий поле для фасетной навигации. Запрос может содержать несколько фасетов, таких как `&facet=color&facet=category&facet=rating`, которые разделяются символов "амперсанд" (&).

Кроме того, код приложения также должен создать выражение `$filter` для обработки событий, выполняемых при щелчке, во время фасетной навигации. Выражение `$filter` сокращает количество результатов поиска, используя значение фасета в качестве условия фильтра.

Когнитивный поиск Azure возвращает результаты поиска на основе одного или нескольких введенных терминов вместе с обновлениями для структуры навигации с аспектом. В Когнитивный поиск Azure Аспектная Навигация является одноуровневой конструкцией с различными значениями аспекта и количеством найденных результатов для каждого из них.

В следующих разделах мы более подробно рассмотрим, как создать каждую из частей.

<a name="buildindex"></a>

## <a name="build-the-index"></a>Создание индекса
Поддержка фасетов включается для каждого поля в индексе по отдельности с помощью этого атрибута индекса: `"Facetable": true`.  
Для всех типов полей, которые можно использовать в фасетной навигации, по умолчанию устанавливается значение `Facetable` . К таким типам полей `Edm.String`относятся `Edm.DateTimeOffset`,, и все типы числовых полей (по сути, все типы полей являются аспектными `Edm.GeographyPoint`, за исключением, которые нельзя использовать в аспектной навигации). 

При создании индекса с помощью фасетной навигации рекомендуется явно отключить поддержку фасетов для полей, которые не должны использоваться в качестве фасетов.  В частности, для полей строк одноэлементных значений, таких как идентификатор или название продукта, следует задать значение `"Facetable": false` во избежание их случайного (и неэффективного) использования при фасетной навигации. При отключении аспекта, где он не нужен, размер индекса может быть небольшим и, как правило, улучшается производительность.

Ниже приведена часть схемы для примера приложения демоверсии портала поиска работы (некоторые атрибуты усечены, чтобы уменьшить размер):

```json
{
  ...
  "name": "nycjobs",
  "fields": [
    { "name": "id",                 "type": "Edm.String",              "searchable": false, "filterable": false, ... "facetable": false, ... },
    { "name": "job_id",             "type": "Edm.String",              "searchable": false, "filterable": false, ... "facetable": false, ... },
    { "name": "agency",              "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "posting_type",        "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "num_of_positions",    "type": "Edm.Int32",              "searchable": false, "filterable": true, ...  "facetable": true, ...  },
    { "name": "business_title",      "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "civil_service_title", "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "title_code_no",       "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "level",               "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "salary_range_from",   "type": "Edm.Int32",              "searchable": false, "filterable": true, ...  "facetable": true, ...  },
    { "name": "salary_range_to",     "type": "Edm.Int32",              "searchable": false, "filterable": true, ...  "facetable": true, ...  },
    { "name": "salary_frequency",    "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { "name": "work_location",       "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
…
    { "name": "geo_location",        "type": "Edm.GeographyPoint",     "searchable": false, "filterable": true, ...  "facetable": false, ... },
    { "name": "tags",                "type": "Collection(Edm.String)", "searchable": true,  "filterable": true, ...  "facetable": true, ...  }
  ],
…
}
```

Как видно в образце схемы, `Facetable` отключено для строковых полей, которые не должны использоваться в качестве аспектов, таких как значения идентификаторов. При отключении аспекта, где он не нужен, размер индекса может быть небольшим и, как правило, улучшается производительность.

> [!TIP]
> Для каждого поля рекомендуется включить полный набор атрибутов индекса. Хотя атрибут `Facetable` по умолчанию активируется для практически всех полей, в случае намеренной установки каждого атрибута вы можете продумать, как применить каждое решение схемы. 

<a name="checkdata"></a>

## <a name="check-the-data"></a>Проверка данных
Качество данных напрямую влияет на реализацию структуры фасетной навигации. От него также зависит создание фильтров для уменьшения размера результирующего набора.

Если вы хотите выполнять поиск по такому аспекту, как Brand (Торговая марка) или Price (Цена), то каждый документ должен содержать допустимые, согласованные и эффективные значения *BrandName* и *ProductPrice*, используемые для фильтрации.

Ниже перечислены несколько напоминаний о том, как повысить эффективность поиска:

* Определите, содержит ли каждое из полей, используемых в качестве фасетов, значения, которые можно использовать как фильтры при самоуправляемом поиске. Значения должны быть краткими, описательными и в достаточной мере отличительными для разграничения различных параметров.
* Опечатки или близкие значения. Если вы используете фасет Color (Цвет), а значения полей включают Orange (Оранжевый) и Ornage (опечатка), фасет, в основе которой лежит поле Color (Цвет), выберет оба значения.
* Использование текста, написанного прописными и строчными буквами, также может негативно отразиться на фасетной навигации, так как элементы orange и Orange будут считаться двумя разными значениями. 
* Если одно значение указано в единственном и множественном числе, для каждой формы будет создан отдельный фасет.

Как вы видите, тщательная подготовка данных обеспечивает максимальную эффективность фасетной навигации.

<a name="presentationlayer"></a>

## <a name="build-the-ui"></a>Создание пользовательского интерфейса
Уровень представления данных позволяет определить требования, которые в противном случае могли бы быть упущены. Кроме того, вы узнаете, какие возможности являются ключевыми для выполнения поиска.

С точки зрения фасетной навигации ваша веб-страница или страница приложения отображает структуру фасетной навигации, обнаруживает данные, которые пользователь ввел на странице, и вставляет измененные элементы. 

В веб-приложениях на уровне представления данных обычно используется технология AJAX, так как она позволяет обновлять добавочные изменения. Можно также использовать ASP.NET MVC или любую другую платформу визуализации, которая может подключаться к службе Когнитивный поиск Azure по протоколу HTTP. Пример приложения, упоминаемого в этой статье, — это ASP.NET приложение на **портале заданий когнитивный Поиск Azure** .

В этом примере фасетная навигация встроена в страницу результатов поиска. В следующем примере, взятом из файла `index.cshtml` примера приложения, показана статическая структура HTML для отображения фасетной навигации на странице результатов поиска. Список фасетов создается или повторно создается динамически при отправке условия запроса, выборе или очистке фасета.

```html
<div class="widget sidebar-widget jobs-filter-widget">
  <h5 class="widget-title">Filter Results</h5>
    <p id="filterReset"></p>
    <div class="widget-content">

      <h6 id="businessTitleFacetTitle">Business Title</h6>
      <ul class="filter-list" id="business_title_facets">
      </ul>

      <h6>Location</h6>
      <ul class="filter-list" id="posting_type_facets">
      </ul>

      <h6>Posting Type</h6>
      <ul class="filter-list" id="posting_type_facets"></ul>

      <h6>Minimum Salary</h6>
      <ul class="filter-list" id="salary_range_facets">
      </ul>

  </div>
</div>
```

В следующем фрагменте кода со страницы `index.cshtml` динамически создается HTML для отображения первого фасета — Business Title (Должность в компании). Аналогичные функции динамически создают HTML для других фасетов. Каждый фасет содержит метку и счетчик, отображающий число элементов, найденных для соответствующего результата фасета.

```js
function UpdateBusinessTitleFacets(data) {
  var facetResultsHTML = '';
  for (var i = 0; i < data.length; i++) {
    facetResultsHTML += '<li><a href="javascript:void(0)" onclick="ChooseBusinessTitleFacet(\'' + data[i].Value + '\');">' + data[i].Value + ' (' + data[i].Count + ')</span></a></li>';
  }

  $("#business_title_facets").html(facetResultsHTML);
}
```

> [!TIP]
> При разработке страницы результатов поиска не забудьте включить механизм очистки фасетов. Устанавливая флажки, можно легко понять, как очистить фильтры. Для других структур может понадобиться шаблон навигации или другой нестандартный элемент. Например, в примере приложения портала поиска работы можно щелкнуть `[X]` возле выбранного фасета, чтобы очистить его.

<a name="buildquery"></a>

## <a name="build-the-query"></a>Создание запроса
В коде, написанном для построения запросов, следует указать все компоненты допустимого запроса, включая выражения поиска, фасеты, фильтры и профили оценки, то есть все элементы, используемые для создания запроса. В этом разделе мы изучим роль фасетов в создании запроса и покажем, как использовать с ними фильтры для сокращения размера результирующего набора.

Обратите внимание, что фасеты являются неотъемлемой частью этого примера приложения. При поиске в демоверсии портала поиска работы используются фасетная навигация и фильтры. О важности фасетной навигации свидетельствует место, которое занимают ее элементы на странице. 

Лучше всего начать с примера. В следующем примере, взятом из файла `JobsSearch.cs`, создается запрос, применяемый для фасетной навигации с использованием фасетов Business Title (Должность в компании), Location (Расположение), Posting Type (Тип объявления) и Minimum Salary (Минимальная заработная плата). 

```cs
SearchParameters sp = new SearchParameters()
{
  ...
  // Add facets
  Facets = new List<String>() { "business_title", "posting_type", "level", "salary_range_from,interval:50000" },
};
```

Параметр запроса фасета задается для поля и (в зависимости от типа данных) может дополняться списком параметров, разделенных запятыми, таких как `count:<integer>`, `sort:<>`, `interval:<integer>` и `values:<list>`. Список значений, создаваемый при настройке диапазонов, поддерживает числовые данные. Подробные сведения об использовании см. в статье [Поиск документов (Azure КОГНИТИВНЫЙ Поиск API)](https://docs.microsoft.com/rest/api/searchservice/Search-Documents) .

Создаваемый с помощью приложения запрос должен включать, помимо фасетов, также и соответствующие фильтры, которые позволяют сузить набор документов на основе выбранного значения фасета. Предположим, что вы ищете велосипед в специализированном магазине. С помощью фасетной навигации вы можете узнать об *имеющихся в наличии велосипедах по цвету, производителю и типу*. Используя фильтрацию, вы можете найти, к примеру, *горные велосипеды красного цвета в указанном ценовом диапазоне*. Если вы щелкнете Red, чтобы отобразить только велосипеды красного цвета, отправляемый приложением запрос будет включать фрагмент `$filter=Color eq 'Red'`.

В следующем фрагменте кода со страницы `JobsSearch.cs` выбранная должность в компании добавляется в фильтр, если выбрать значение из фасета Business Title.

```cs
if (businessTitleFacet != "")
  filter = "business_title eq '" + businessTitleFacet + "'";
```

<a name="tips"></a> 

## <a name="tips-and-best-practices"></a>Советы и рекомендации

### <a name="indexing-tips"></a>Советы по индексированию
**Повышение эффективности индекса, если не используется поле поиска**

Если в приложении используется исключительно фасетная навигации (без поля поиска), то вы можете задать для поля атрибуты `searchable=false`, `facetable=true`, чтобы сократить размер индекса. Кроме того, индексируются только целые значения фасетов, а не фрагменты слов или компоненты многосложных значений.

**Определение полей, которые можно использовать в качестве аспектов**

Вспомним, что схема индекса определяет, какие поля можно использовать в качестве фасетов. Если поля поддерживают фасеты, в запросе указываются поля, по которым следует выполнять поиск с использованием фасетов. Поле, по которому выполняется поиск, предоставляет значения, которые отображаются под меткой. 

Значения, которые отображаются под каждой меткой, извлекаются из индекса. Например, если используется поле фасета *Color* (Цвет), дополнительная фильтрация будет выполняться по доступным значениям этого поля, таким как Red (Красный), Black (Черный) и так далее.

Для числовых значений, а также значений даты и времени можно явно задать значения поля фасета (например, `facet=Rating,values:1|2|3|4|5`). Поля этих типов поддерживают список значений, что позволяет упростить разделение целевых фасетов по смежным диапазонам (диапазонам на основе числовых значений или периодов времени). 

**По умолчанию можно использовать только один уровень фасетной навигации** 

Как уже упоминалось, фасеты невозможно непосредственно вкладывать в иерархию. По умолчанию при навигации с аспектами в Azure Когнитивный поиск поддерживается только один уровень фильтров. Однако это ограничение можно обойти. Вы можете кодировать иерархическую структуру фасета в `Collection(Edm.String)` с одной точкой входа для одной иерархии. Обход этого ограничения выходит за рамки данной статьи. 

### <a name="querying-tips"></a>Советы по выполнению запросов
**Проверка полей**

При динамическом создании списка фасетов на основе данных, введенных ненадежными пользователями, следует проверить допустимость имен полей фасетов или исключить имена при создании URL-адресов с помощью `Uri.EscapeDataString()` в .NET или его эквивалента в другой платформе.

### <a name="filtering-tips"></a>Советы по фильтрации
**Повышение точности поиска с помощью фильтров**

 Используйте фильтры. Если вы полагаетесь только на выражения поиска, извлечение корней может привести к возврату документа, который не имеет точного значения аспекта в любом из его полей.

**Повышение производительности поиска с помощью фильтров**

 Фильтры позволяют сузить набор документов для поиска и исключить их из ранжирования. Если у вас имеется большой набор документов, фасетная детализация с использованием выбранных фасетов часто повышает эффективность поиска.
  
**Фильтрация только фасетных полей**

Как правило, при детализации с использованием фасетов требуется включать только документы, содержащие значение фасета в конкретном (фасетном) поле, а не во всех полях, которые поддерживают поиск. Если добавить фильтр, поиск соответствующего значения будет выполнен только в поле фасета.

**Обрезание результатов аспекта с помощью дополнительных фильтров**

Фасеты позволяют отобразить в результатах поиска документы, соответствующие определенному фасету. В следующем примере результаты поиска фразы *cloud computing* (облачные вычисления) включают 254 элемента с типом содержимого *internal specification* (внутренняя спецификация). Элементы не обязательно взаимно исключают друг друга. Если элемент соответствует условиям обоих фильтров, он учитывается в каждом из них. Это дублирование возможно при фасетном поиске в полях `Collection(Edm.String)`, которые часто используются для обозначения документов тегами.

        Search term: "cloud computing"
        Content type
           Internal specification (254)
           Video (10) 

Как правило, если вам кажется, что при использовании фасета вы получаете слишком много результатов, мы рекомендуем добавить фильтры, чтобы пользователи могли сузить область поиска.

### <a name="tips-about-result-count"></a>Советы по числу результатов

**Ограничение числа элементов, используемых для фасетной навигации**

Для каждого поля фасета в дереве навигации по умолчанию можно задать не более 10 значений. Это упрощает структуру переходов, позволяя управлять списком значений. Вы можете переопределить это ограничение по умолчанию, указав соответствующее число.

* Параметр `&facet=city,count:5` указывает, что при применении фасета будут возвращены только первые 5 городов с наивысшим приоритетом. Рассмотрим пример запроса с условием поиска "Аэропорт" и 32 совпадений. Если при этом включить в запрос параметр `&facet=city,count:5`, то в результаты поиска, полученные при использовании фасета, будут включены только первые пять уникальных городов с наибольшим количеством документов.

Обратите внимание на различие между результатами применения фасета и результатами поиска. Результаты поиска — это все документы, которые удовлетворяют условиям запроса. Результаты фасета — это совпадения для каждого значения фасета. В этом примере результаты поиска будут включать названия городов, которые не входят в список классификации фасета (в этом случае — 5). Результаты, которые фильтруются посредством фасетной навигации, отображаются пользователям, когда они удаляют фасеты или выбирают другие фасеты помимо City (Город). 

> [!NOTE]
> Если имеются фасеты несколько типов, параметр `count` может привести к отображению различных данных. В следующей таблице приведены краткие сведения об использовании термина в Azure Когнитивный поиск API, образце кода и документации. 

* `@colorFacet.count`<br/>
   В коде представления данных фасет включает параметр количества, который используется для отображения числа результатов, полученных при использовании фасета. В результатах применения фасета параметр count указывает на число документов, соответствующих условию одного или диапазону нескольких фасетов.
* `&facet=City,count:12`<br/>
   В запросе фасета вы можете задать значение параметра count.  Значение по умолчанию — 10, но его можно изменить. Если задать значение `count:12` , результаты применения фасета будут включать 12 лучших совпадений по числу документов.
* "`@odata.count`"<br/>
   В ответе на запрос это значение указывает количество совпадений в результатах поиска. В среднем он больше, чем сумма всех результатов аспекта, в связи с наличием элементов, соответствующих условию поиска, но не имеющим значения аспекта.

**Получение числа результатов для аспекта**

При добавлении фильтра в фасетный запрос вам может потребоваться сохранить инструкцию аспекта (например, `facet=Rating&$filter=Rating ge 4`). Технически, аспект = оценка не требуется, но при этом она возвращает количество значений аспекта для оценок 4 и выше. Например, если вы щелкнете "4", а запрос включает фильтр для отображения оценок, начиная с "4", будут возвращены количественные показатели для каждой оценки от 4 и выше.  

**Обеспечение точного числа результатов для аспекта**

При определенных обстоятельствах может оказаться, что счетчики аспектов не соответствуют результирующим наборам (см. раздел [Навигация с аспектами в когнитивный Поиск Azure (публикация на форуме)](https://social.msdn.microsoft.com/Forums/azure/06461173-ea26-4e6a-9545-fbbd7ee61c8f/faceting-on-azure-search?forum=azuresearch)).

Такие неточности обусловлены особенностями архитектуры сегментирования. Каждый индекс поиска включает несколько сегментов, каждый из которых в свою очередь содержит сведения о числе наиболее соответствующих фасетов, которые затем объединяются в единый результат. Если некоторые сегменты включают много совпадающих значений, в то время как другие сегменты содержат меньше значений, некоторые значения фасетов могут отсутствовать или не учитываться в результатах.

Хотя такое поведение может измениться в любое время, если вы столкнулись с этим поведением сегодня, вы можете обойти ее, искусственно увеличив количество\<: число> к большому числу, чтобы обеспечить полную отчетность из каждого сегмента. Если значение параметра count: больше или равно количеству уникальных значений в поле, вы гарантировано получите точные результаты. Однако если имеется очень много документов, производительность снижается, поэтому выполняйте эти действия рассудительно.

### <a name="user-interface-tips"></a>Советы по пользовательскому интерфейсу
**Используя фасетную навигацию, добавляйте метки для всех полей.**

Метки обычно определяются в HTML-файле или форме (`index.cshtml` в примере приложения). В Azure Когнитивный поиск нет API для меток навигации по аспектам или других метаданных.

<a name="rangefacets"></a>

## <a name="filter-based-on-a-range"></a>Фильтрация по диапазону значений
В приложениях поиска часто используется фасетная навигация на основе диапазонов значений. Поддерживаются диапазоны числовых данных, а также значений даты и времени. Вы можете ознакомиться с дополнительными сведениями о каждом подходе в [документах поиска (Azure КОГНИТИВНЫЙ Поиск API)](https://docs.microsoft.com/rest/api/searchservice/Search-Documents).

Azure Когнитивный поиск упрощает создание диапазонов, предоставляя два подхода к вычислению диапазона. Для обоих подходов Azure Когнитивный поиск создает соответствующие диапазоны с учетом предоставленных входных данных. Например, если указать диапазон значений 10|20|30, будут автоматически созданы диапазоны 0–10, 10–20, 20–30–10, 10–20 и 20–30. Приложение может при необходимости удалить все пустые интервалы. 

**Способ 1. Использование параметра interval**  
Чтобы задать аспекты цены с шагом в 10 долл. США, следует указать: `&facet=price,interval:10`

**Способ 2. Использование списка значений**  
 Для числовых данных можно использовать список значений.  Рассмотрим следующий диапазон значений поля фасета `listPrice`:

  ![Пример списка значений](media/search-faceted-navigation/Facet-5-Prices.PNG "Пример списка значений")

Чтобы указать диапазон значений фасета, как показано на предыдущем снимке экрана, используйте список значений:

    facet=listPrice,values:10|25|100|500|1000|2500

Каждый диапазон создается с использованием отправной точки 0 и конечной точки, равной значению из списка. Затем из всего диапазона удаляется предыдущий диапазон, что позволяет создавать дискретные интервалы. Azure Когнитивный поиск выполняет эти действия как часть навигации с аспектами. Для создания каждого интервала не нужно писать код.

### <a name="build-a-filter-for-a-range"></a>Создание фильтра для диапазона
Чтобы фильтровать документы на основе выбранного диапазона значений, вы можете включить операторы фильтров `"ge"` и `"lt"` в двухкомпонентное выражение, которое определяет конечные точки диапазона значений. Например, если выбрать диапазон 10–25 для поля `listPrice`, будет применен фильтр `$filter=listPrice ge 10 and listPrice lt 25`. В примере кода для задания конечных точек в выражении фильтра используются параметры **priceFrom** и **priceTo**. 

  ![Запрос для диапазона значений](media/search-faceted-navigation/Facet-6-buildfilter.PNG "Запрос для диапазона значений")

<a name="geofacets"></a> 

## <a name="filter-based-on-distance"></a>Фильтрация по расстоянию
Обычно фильтры позволяют выбрать магазин, Ресторан или место назначения в зависимости от его расположения. Хотя этот тип фильтра может выглядеть как Аспектная Навигация, это просто фильтр. Этот вопрос упоминается здесь для пользователей, которым нужно решить проблему с реализацией этого компонента.

В Azure Когнитивный поиск, **Geo. Distance** и **Geo. intersects**есть две геопространственные функции.

* Функция **geo.distance** возвращает расстояние в километрах между двумя точками. Одна точка представляет собой поле, а другая — константу, переданную как часть фильтра. 
* Функция **geo.distance** возвращает значение true, если заданная точка находится в пределах указанного многоугольника. Точка представляет собой поле, а многоугольник указывается в качестве списка констант координат, переданных как часть фильтра.

Примеры фильтров можно найти в [синтаксисе выражений OData (когнитивный Поиск Azure)](query-odata-filter-orderby-syntax.md).

<a name="tryitout"></a>

## <a name="try-the-demo"></a>Пробное использование демоверсии
Демонстрационная версия портала заданий Azure Когнитивный поиск содержит примеры, упоминаемые в этой статье.

-   Просмотрите и протестируйте рабочую демонстрацию в Интернете на [портале заданий Azure когнитивный Поиск](https://aka.ms/azjobsdemo).

-   Скачайте код из [репозитория примеров Azure на GitHub](https://github.com/Azure-Samples/search-dotnet-asp-net-mvc-jobs).

При работе с результатами поиска понаблюдайте, как меняется URL-адрес при построении запроса. Когда вы выбираете фасеты, это приложение добавляет их к универсальному коду ресурса (URI).

1. Чтобы использовать функцию сопоставления демоверсии приложения, получите ключ для Карт Bing в [Центре разработки Карт Bing](https://www.bingmapsportal.com/). Вставьте его вместо существующего ключа на странице `index.cshtml`. Параметр `BingApiKey` в файле `Web.config` не используется. 

2. Запустите приложение. Можно просмотреть приложение или закрыть диалоговое окно.
   
3. Введите условие поиска, например "аналитика", и щелкните значок "Поиск". Будет быстро выполнен запрос.
   
   Вместе с результатами поиска будет также возвращена структура фасетной навигации. На странице результатов поиска структура фасетной навигации включает количественные показатели для каждого результата фасета. Фасеты не выбраны, поэтому возвращаются все соответствующие результаты.
   
   ![Результаты поиска до выбора фасетов](media/search-faceted-navigation/faceted-search-before-facets.png "Результаты поиска до выбора фасетов")

4. Щелкните фасеты Business Title (Должность в компании), Location (Расположение) или Minimum Salary (Минимальная заработная плата). При первоначальном поиске фасеты имеют значение NULL, но по мере того, как они принимают значения, из результатов поиска удаляются несоответствующие элементы.
   
   ![Результаты поиска после выбора фасетов](media/search-faceted-navigation/faceted-search-after-facets.png "Результаты поиска после выбора фасетов")

5. Вы можете по-разному очистить запрос, использующий фасеты, например щелкнуть `[X]` возле выбранного фасета, чтобы его очистить.
   
<a name="nextstep"></a>

## <a name="learn-more"></a>Дополнительные сведения
Просмотрите [когнитивный Поиск Azure](https://channel9.msdn.com/Events/TechEd/Europe/2014/DBI-B410). Начиная с 45:25, на этой видеозаписи демонстрируется, как реализовать фасеты.

Чтобы больше узнать о принципах разработки решений фасетной навигации, щелкните следующие ссылки.

* [Шаблоны разработки: фасетная навигация](https://alistapart.com/article/design-patterns-faceted-navigation)
* [Проблемы внешнего интерфейса при реализации аспектного поиска — часть 1](https://articles.uie.com/faceted_search2/)

