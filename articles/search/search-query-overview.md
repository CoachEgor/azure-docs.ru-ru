---
title: Типы запросов и составление запросов
titleSuffix: Azure Cognitive Search
description: Основные сведения о создании поискового запроса в Azure Когнитивный поиск с использованием параметров для фильтрации, выбора и сортировки результатов.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 10/22/2020
ms.openlocfilehash: 0c05db39e02a6bc2a7fa5d62b8b891626eb0d241
ms.sourcegitcommit: 4cb89d880be26a2a4531fedcc59317471fe729cd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2020
ms.locfileid: "92675797"
---
# <a name="query-types-and-composition-in-azure-cognitive-search"></a>Типы запросов и композиция в Azure Когнитивный поиск

В Azure Когнитивный поиск запрос представляет собой полную спецификацию операции приема-передачи. В запросе существуют параметры, которые предоставляют инструкции по выполнению для ядра, а также параметры, которые формируют ответ, поступающий обратно. Не указано ( `search=*` ), без критериев соответствия и использования параметров NULL или Default, запрос выполняется для всех полей с возможностью поиска в качестве операции полнотекстового поиска, возвращая неоцененный результирующий набор в произвольном порядке.

Следующий пример представляет собой репрезентативный запрос, созданный в [REST API](/rest/api/searchservice/search-documents). Этот пример предназначен для [демонстрационного индекса гостиниц](search-get-started-portal.md) и включает общие параметры, чтобы вы могли получить представление о том, как выглядит запрос.

```
{
    "queryType": "simple" 
    "search": "+New York +restaurant",
    "searchFields": "Description, Address/City, Tags",
    "select": "HotelId, HotelName, Description, Rating, Address/City, Tags",
    "top": "10",
    "count": "true",
    "orderby": "Rating desc"
}
```

+ **`queryType`** Задает средство синтаксического анализа, которое является либо [анализатором простого запроса по умолчанию](search-query-simple-examples.md) (оптимальным для полнотекстового поиска), либо [полным средством синтаксического анализа запросов Lucene](search-query-lucene-examples.md) , используемым для расширенных конструкций запросов, таких как регулярные выражения, поиск по сходству, нечеткий и поиск с подстановочными знаками.

+ **`search`** предоставляет критерии соответствия (обычно целые термины или фразы), но часто сопровождается логическими операторами. Запрос с одним самостоятельным термином называется запросом *термина* . Многокомпонентные запросы, заключенные в кавычки, — это запросы *фраз* . Поиск может быть неопределенным, как в **`search=*`** , но без критериев для сопоставления, результирующий набор состоит из произвольно выбранных документов.

+ **`searchFields`** ограничивает выполнение запросов конкретными полями. Для этого параметра доступно любое поле, которое является атрибутом, поддерживающим *Поиск* в схеме индекса.

Ответы также обрабатываются параметрами, включенными в запрос:

+ **`select`** Указывает, какие поля должны возвращаться в ответе. В инструкции SELECT можно использовать только те поля, которые помечены как доступные для *получения* индекса.

+ **`top`** Возвращает указанное число наиболее подходящих документов. В этом примере возвращаются только 10 обращений. Для страницы результатов можно использовать предложения TOP и Skip (не показано).

+ **`count`** Указывает, сколько документов во всем индексе соответствует общему числу, что может быть больше, чем возвращено. 

+ **`orderby`** используется, если требуется сортировать результаты по значению, например по рейтингу или расположению. В противном случае по умолчанию используется показатель релевантности для ранжирования результатов.

В Когнитивный поиск Azure выполнение запросов всегда выполняется по одному индексу, прошедшему проверку подлинности с помощью ключа API, предоставленного в запросе. В интерфейсах REST эти данные передаются в заголовках запроса.

### <a name="how-to-run-this-query"></a>Процесс выполнения запроса

Перед написанием кода можно использовать средства запросов для изучения синтаксиса и экспериментов с различными параметрами. Самый быстрый подход — встроенное средство портала, [Обозреватель поиска](search-explorer.md).

Если вы припустили это [Краткое руководство, чтобы создать демонстрационный индекс гостиниц](search-get-started-portal.md), можно вставить эту строку запроса в панель поиска обозревателя, чтобы выполнить первый запрос: `search=+"New York" +restaurant&searchFields=Description, Address/City, Tags&$select=HotelId, HotelName, Description, Rating, Address/City, Tags&$top=10&$orderby=Rating desc&$count=true`

## <a name="how-query-operations-are-enabled-by-the-index"></a>Как индекс влияет на операции запросов

Проектирование индексов и проектирование запросов тесно связаны в Azure Когнитивный поиск. Здесь важно сразу понять, что именно *схема индекса* с атрибутами для каждого поля определяет, какие типы запросов вы сможете создавать. 

Атрибуты индекса задают допустимые операции для набора полей в индексе, например возможность поиска ( *searchable* ), извлечения ( *retrievable* ), сортировки ( *sortable* ) и фильтрации ( *filterable* ). В примере строки запроса `"$orderby": "Rating"` работает только потому, что поле Рейтинг помечено как *сортируемый* в схеме индекса. 

![Определение индекса для примера отеля](./media/search-query-overview/hotel-sample-index-definition.png "Определение индекса для примера отеля")

Приведенный выше снимок экрана представляет собой частичный список атрибутов индекса для примера гостиниц. Полную схему индекса вы можете изучить на портале. Дополнительные сведения об атрибутах индекса см. в статье [Create Index (Azure Search Service REST API)](/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")).

> [!Note]
> Некоторые функции обработки запросов включаются на уровне всего индекса, а не для отдельных полей. К таким возможностям относятся: [карты синонимов](search-synonyms.md), [пользовательские анализаторы](index-add-custom-analyzers.md), конструкции средств подбора [(для автозаполнения и предлагаемых запросов)](index-add-suggesters.md), [логика оценки для ранжирования результатов](index-add-scoring-profiles.md).

## <a name="elements-of-a-query-request"></a>Элементы запроса

Запросы всегда направляются в один индекс. Невозможно объединить индексы или создать пользовательские или временные структуры данных и указать их в качестве цели запроса. 

Обязательные элементы в запросе перечислены ниже:

+ Конечная точка службы и коллекция документов индексов, выраженная в виде URL-адреса, содержащего фиксированные и определяемые пользователем компоненты: **`https://<your-service-name>.search.windows.net/indexes/<your-index-name>/docs`**
+ **`api-version`** (Только для остальных) требуется, так как в любое время доступна более чем одна версия API. 
+ **`api-key`** — ключ API запроса или администратора, который выполняет проверку подлинности запроса к службе.
+ **`queryType`** — простой или полный, который можно опустить при использовании встроенного простого синтаксиса по умолчанию.
+ **`search`** или **`filter`** предоставляет условие соответствия, которое можно не указывать, если необходимо выполнить пустой Поиск. Оба типа запросов рассматриваются на примере простого средства синтаксического анализа, но даже в сложных запросах используется параметр поиска для передачи сложных выражений запроса.

Все остальные параметры поиска являются необязательными. Полный список атрибутов приводится в статье [Create Index (Azure Search Service REST API)](/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")). Подробнее о том, как параметры используются во время обработки, см. [в статье работа полнотекстового поиска в Azure когнитивный Поиск](search-lucene-query-architecture.md).

## <a name="choose-apis-and-tools"></a>Выбор API и средств

В таблице ниже представлены интерфейсы API и методы на основе инструментов для отправки запросов.

| Методика | Описание |
|-------------|-------------|
| [Обозреватель поиска (портал)](search-explorer.md) | Предоставляет панель поиска и параметры для выбора индекса и значения api-version. Будут возвращены результаты в виде документов JSON. Рекомендуется для изучения, тестирования и проверки. <br/>[Подробнее.](search-get-started-portal.md#query-index) | 
| [POST или другие средства для отдыха](search-get-started-postman.md) | Веб-инструменты тестирования идеально подходят для формирования вызовов REST. REST API поддерживает все возможные операции в Когнитивный поиск Azure. Из этой статьи вы узнаете, как настроить заголовок HTTP-запроса и текст для отправки запросов в Когнитивный поиск Azure.  |
| [Сеарчклиент (.NET)](/dotnet/api/azure.search.documents.searchclient) | Клиент, который можно использовать для запроса индекса Когнитивный поиск Azure.  <br/>[Подробнее.](search-howto-dotnet-sdk.md)  |
| [Поиск по документам (REST API)](/rest/api/searchservice/search-documents) | Методы GET или POST для индекса, допускающие использование параметров запроса для ввода дополнительных данных.  |

## <a name="choose-a-parser-simple--full"></a>Выберите средство синтаксического анализа: simple (простое) или full (полное)

Когнитивный поиск Azure находится на основе Apache Lucene и предоставляет выбор между двумя анализаторами запросов для обработки типичных и специализированных запросов. Запросы для простого средства синтаксического анализа должны использовать [простой синтаксис запросов](query-simple-syntax.md). Этот вариант используется по умолчанию, так как обеспечивает высокую скорость и эффективность для запросов в свободной текстовой форме. Этот синтаксис поддерживает ряд общих операторов поиска, включая AND, OR, NOT, а также фразы, суффиксы и операторы приоритета.

[Полный синтаксис запросов Lucene](query-Lucene-syntax.md#bkmk_syntax), который включается при добавлении параметра `queryType=full` в запрос, позволяет применить широко распространенный и выразительный язык запросов, разработанный в составе библиотеки [Apache Lucene](https://lucene.apache.org/core/6_6_1/queryparser/org/apache/lucene/queryparser/classic/package-summary.html). Полный синтаксис расширяет простой синтаксис. Средство полного синтаксического анализа Lucene поймет любой запрос, созданный для простого средства синтаксического анализа. 

Этот аспект демонстрируется в следующих примерах: один и тот же запрос с разными значениями параметра queryType возвращает разные результаты. В первом запросе параметр `^3` After `historic` рассматривается как часть условия поиска. Итоговый результат для этого запроса — "Маркуис за & Suite", в его описание которого содержится *океан*

```
queryType=simple&search=ocean historic^3&searchFields=Description, Tags&$select=HotelId, HotelName, Tags, Description&$count=true
```

Тот же запрос, использующий полное средство синтаксического анализа Lucene, интерпретируется `^3` как повышение в поле. При переключении синтаксических анализаторов изменяется ранг, а результаты, содержащие термин с *предысторией* , перемещаются в начало.

```
queryType=full&search=ocean historic^3&searchFields=Description, Tags&$select=HotelId, HotelName, Tags, Description&$count=true
```

<a name="types-of-queries"></a>

## <a name="types-of-queries"></a>Типы запросов

Azure Когнитивный поиск поддерживает широкий спектр типов запросов. 

| Тип запроса | Использование | Дополнительные сведения и примеры |
|------------|--------|-------------------------------|
| Текстовый поиск со свободной формой записи | Параметр поиска и любое средство синтаксического анализа| Полнотекстовый поиск позволяет найти один или несколько терминов во всех полях индекса с меткой *searchable* , примерно так же, как поисковая система Google или Bing. В примере во введении представлен именно полнотекстовый поиск.<br/><br/>Полнотекстовый поиск проходит лексическую анализ с помощью стандартного анализатора Lucene (по умолчанию). чтобы опустить все термины, удалите такие слова, как «The». По умолчанию можно переопределить [анализаторы, отличные от английской](index-add-language-analyzers.md#language-analyzer-list) , или [специализированные анализаторы, не зависящие от языка](index-add-custom-analyzers.md#AnalyzerTable) , которые изменяют лексический анализ. Например, [keyword](https://lucene.apache.org/core/6_6_1/analyzers-common/org/apache/lucene/analysis/core/KeywordAnalyzer.html) позволяет использовать все содержимое поля как один токен. Это полезно для данных некоторых типов, таких как почтовые индексы, идентификаторы и названия продуктов. | 
| Поиск с фильтрацией | [Выражение фильтра OData](query-odata-filter-orderby-syntax.md) и любое средство синтаксического анализа | Запросы фильтрации оценивают логическое выражение по всем полям индекса с меткой *filterable* . В отличие от поиска, запрос фильтрации проверяет точное содержимое поля, в том числе учитывает регистр для строковых полей. Еще одно важное различие — запросы фильтрации выражаются в синтаксисе OData. <br/>[Пример поиска с фильтрацией](search-query-simple-examples.md#example-3-filter-queries) |
| Геопространственный поиск | [Тип Edm.GeographyPoint](/rest/api/searchservice/supported-data-types) для поля, выражение фильтра и любое средство синтаксического анализа | Координаты, хранящиеся в поле с типом Edm.GeographyPoint, используются для "поиска соседних объектов" и для элементов управления со встроенными картами. <br/>[Пример поиска геообъектов](search-query-simple-examples.md#example-5-geo-search)|
| Поиск по диапазону | Выражение фильтра и средство простого синтаксического анализа | В Когнитивный поиск Azure запросы к диапазону создаются с помощью параметра Filter. <br/>[Пример фильтра по диапазону](search-query-simple-examples.md#example-4-range-filters) | 
| [Поиск по полям](query-lucene-syntax.md#bkmk_fields) | Параметр поиска и средство полного синтаксического анализа | Создайте сложное выражение запроса, предназначенное для одного поля. <br/>[Пример поиска по полям](search-query-lucene-examples.md#example-2-fielded-search) |
| [нечеткий поиск](query-lucene-syntax.md#bkmk_fuzzy) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с терминами, которые имеют сходную конструкцию или орфографию. <br/>[Пример поиска нечетких соответствий](search-query-lucene-examples.md#example-3-fuzzy-search) |
| [поиск по сходству](query-lucene-syntax.md#bkmk_proximity) | Параметр поиска и средство полного синтаксического анализа | Находит термины, которые расположены в документе рядом друг с другом. <br/>[Пример поиска с учетом расположения](search-query-lucene-examples.md#example-4-proximity-search) |
| [повышение термина](query-lucene-syntax.md#bkmk_termboost) | Параметр поиска и средство полного синтаксического анализа | Присваивает более высокий приоритет документам, которые содержат определенный термин. <br/>[Пример повышения приоритета термина](search-query-lucene-examples.md#example-5-term-boosting) |
| [Поиск регулярных выражений](query-lucene-syntax.md#bkmk_regex) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения на основе содержимого регулярного выражения. <br/>[Пример поиска с использованием регулярного выражения](search-query-lucene-examples.md#example-6-regex) |
|  [Поиск с подстановочным знаком или префиксом](query-lucene-syntax.md#bkmk_wildcard) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с учетом префикса и символа тильды (`~`) или одного символа (`?`). <br/>[Пример поиска с использованием подстановочных знаков](search-query-lucene-examples.md#example-7-wildcard-search) |

## <a name="manage-search-results"></a>Управление результатами поиска 

Результаты запроса передаются потоком в виде документов JSON в API REST, хотя если вы используете интерфейсы API .NET, то функции сериализации будут встроенными. Используя параметры запроса, вы можете задать формат результатов и выбрать определенные поля для отображения в результатах.

Параметры запроса можно использовать для структурирования результирующего набора одним из следующих способов.

+ Ограничение числа документов или группирование определенного числа документов в результатах (50 по умолчанию).
+ Выбор полей для включения в результаты.
+ Установка порядка сортировки.
+ Выделение вхождений для привлечения внимания к найденным терминам в тексте результатов поиска.

### <a name="tips-for-unexpected-results"></a>Советы по непредвиденным результатам

В некоторых случаях непредвиденным является содержимое, а не структура результатов. Если результаты запроса не соответствует ожиданиям, можно попробовать изменить запрос и проверить, не улучшились ли результаты, как описано ниже.

+ Измените значение **`searchMode=any`** (по умолчанию) на, **`searchMode=all`** чтобы требовать совпадения по всем критериям, а не к любому из критериев. Это особенно важно, если запрос содержит логические операторы.

+ Измените логику запроса, если требуется анализ текста или лексический анализа, но тип запроса исключает лингвистическую обработку. В полнотекстовом поиске автокоррекции текста или лексического анализа для орфографических ошибок, одномодульных форм-слов и даже неровностей глаголов или существительных. Для некоторых запросов, таких как поиск нечетких или подстановочных знаков, лексический анализ не является частью конвейера синтаксического анализа запросов. Для некоторых сценариев в качестве временного решения используются регулярные выражения. 

### <a name="paging-results"></a>Разбиение результатов по страницам
Когнитивный поиск Azure упрощает реализацию разбиения на страницы результатов поиска. С помощью **`top`** параметров и **`skip`** можно без проблем выполнять поисковые запросы, позволяющие получать общий набор результатов поиска в управляемых, упорядоченных подмножествах, которые позволяют легко использовать оптимальные методы пользовательского интерфейса поиска. При получении этих маленьких подмножеств вы можете получать также сведения о количестве документов во всех результатах поиска.

Дополнительные сведения о разбиении на страницы см. в статье [как просмотреть результаты поиска на странице когнитивный Поиск Azure](search-pagination-page-layout.md).

### <a name="ordering-results"></a>Упорядочение результатов
При получении результатов для поискового запроса можно запросить, чтобы Когнитивный поиск Azure обслуживал результаты, упорядоченные по значениям в определенном поле. По умолчанию Azure Когнитивный поиск упорядочивает результаты поиска по рангу поиска каждого документа, который является производным от [TF-IDF](https://en.wikipedia.org/wiki/Tf%E2%80%93idf).

Если вы хотите, чтобы Когнитивный поиск Azure возвращали результаты, упорядоченные по значению, отличному от оценки поиска, можно использовать **`orderby`** параметр поиска. Можно указать значение **`orderby`** параметра, чтобы включить имена полей и вызовы [**`geo.distance()` функции**](query-odata-filter-orderby-syntax.md) для геопространственных значений. После каждого выражения можно `asc` указать, что результаты запрашиваются по возрастанию, и **`desc`** чтобы указать, что результаты запрашиваются в убывающем порядке. По умолчанию результаты сортируются по возрастанию.


### <a name="hit-highlighting"></a>Выделение совпадений
В Azure Когнитивный поиск с помощью **`highlight`** параметров, и можно легко подчеркнуть точную часть результатов поиска, соответствующую поисковому запросу **`highlightPreTag`** **`highlightPostTag`** . Можно указать, какие из полей с *возможностью поиска* должны быть выделены соответствующим текстом, а также указать точные Теги строк для добавления к началу и концу совпадающего текста, возвращаемого Azure когнитивный Поиск.

## <a name="see-also"></a>См. также статью

+ [Как работает полнотекстовый поиск в Когнитивный поиск Azure (архитектура анализа запросов)](search-lucene-query-architecture.md)
+ [Обозреватель поиска](search-explorer.md)
+ [Выполнение запроса в .NET](./search-get-started-dotnet.md)
+ [Выполнение запроса в REST](./search-get-started-powershell.md)