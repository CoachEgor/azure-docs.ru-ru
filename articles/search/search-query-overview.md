---
title: Типы запросов и составление запросов в службе "Поиск Azure"
description: Основы создания поисковых запросов в Поиске Azure с помощью параметров для фильтрации, выбора и сортировки результатов.
author: HeidiSteen
manager: nitinme
ms.author: heidist
services: search
ms.service: search
ms.topic: conceptual
ms.date: 09/20/2019
ms.openlocfilehash: 4646cb30ef7602da990e24f923c8eceada4debd0
ms.sourcegitcommit: e0e6663a2d6672a9d916d64d14d63633934d2952
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/21/2019
ms.locfileid: "71178020"
---
# <a name="query-types-and-composition-in-azure-search"></a>Типы запросов и составление запросов в Поиске Azure

Запрос в Поиске Azure содержит полную спецификацию операции приема-передачи данных. Параметры запроса предоставляют условия соответствия для поиска документов в индексе, включаемых или исключаемых полей, инструкций выполнения, переданных в подсистему, и директив для формирования ответа. Не указано (`search=*`), запрос выполняется для всех полей с возможностью поиска в качестве операции полнотекстового поиска, возвращая неоцененный результирующий набор в произвольном порядке.

Следующий пример представляет собой репрезентативный запрос, созданный в [REST API](https://docs.microsoft.com/rest/api/searchservice/search-documents). Этот пример предназначен для [демонстрационного индекса гостиниц](search-get-started-portal.md) и включает общие параметры.

```
{
    "queryType": "simple" 
    "search": "+New York +restaurant",
    "searchFields": "Description, Address/City, Tags",
    "select": "HotelId, HotelName, Description, Rating, Address/City, Tags",
    "top": "10",
    "count": "true",
    "orderby": "Rating desc"
}
```

+ **`queryType`** задает средство синтаксического анализа, которое является либо [анализатором простого запроса по умолчанию](search-query-simple-examples.md) (оптимальным для полнотекстового поиска), либо [полным средством синтаксического анализа запросов Lucene](search-query-lucene-examples.md) , используемым для расширенных конструкций запросов, таких как регулярные выражения, поиск по сходству, нечеткий и Поиск с использованием подстановочных знаков, чтобы присвоить несколько имен.

+ **`search`** содержит условия для поиска, обычно это искомый текст часто с дополнительными логическими операторами. Запрос с одним самостоятельным термином называется запросом *термина*. Запрос с несколькими частями, заключенными в кавычки, считается запросом *ключевой фразы*. Поиск может быть неопределенным, как например **`search=*`** , но чаще состоит из терминов, фраз и операторов, как в нашем примере.

+ **`searchFields`** ограничивает выполнение запросов конкретными полями. Для этого параметра доступно любое поле, которое является атрибутом, поддерживающим *Поиск* в схеме индекса.

Формат ответа также определяется параметрами, включенными в запрос. В этом примере результирующий набор включает поля, перечисленные в инструкции **`select`** . В инструкции $select можно использовать только поля, помеченные как доступные для *получения* . Кроме того, в этом запросе возвращаются только **`top`** 10 обращений, в то время как **`count`** сообщает, сколько документов соответствует общему количеству, что может быть больше, чем возвращено. В этом запросе строки сортируются по рейтингу в порядке убывания.

В Поиске Azure запрос всегда выполняется по одному индексу, доступ к которому предоставляется по включенному в запрос ключу api-key. В интерфейсах REST эти данные передаются в заголовках запроса.

### <a name="how-to-run-this-query"></a>Процесс выполнения запроса

Чтобы выполнить этот запрос, используйте [Обозреватель поиска и демонстрационный индекс гостиниц](search-get-started-portal.md). 

Строку запроса можно вставить прямо в панель поиска обозревателя: `search=+"New York" +restaurant&searchFields=Description, Address/City, Tags&$select=HotelId, HotelName, Description, Rating, Address/City, Tags&$top=10&$orderby=Rating desc&$count=true`

## <a name="how-query-operations-are-enabled-by-the-index"></a>Как индекс влияет на операции запросов

В Поиске Azure структура индекса тесно связана со структурой запросов. Здесь важно сразу понять, что именно *схема индекса* с атрибутами для каждого поля определяет, какие типы запросов вы сможете создавать. 

Атрибуты индекса задают допустимые операции для набора полей в индексе, например возможность поиска (*searchable*), извлечения (*retrievable*), сортировки (*sortable*) и фильтрации (*filterable*). В примере строки запроса `"$orderby": "Rating"` работает только потому, что поле Рейтинг помечено как *сортируемый* в схеме индекса. 

![Определение индекса для примера отеля](./media/search-query-overview/hotel-sample-index-definition.png "Определение индекса для примера отеля")

Приведенный выше снимок экрана представляет собой частичный список атрибутов индекса для примера гостиниц. Полную схему индекса вы можете изучить на портале. Дополнительные сведения об атрибутах индекса см. в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")).

> [!Note]
> Некоторые функции обработки запросов включаются на уровне всего индекса, а не для отдельных полей. К таким возможностям относятся: [карты синонимов](search-synonyms.md), [пользовательские анализаторы](index-add-custom-analyzers.md), конструкции средств подбора [(для автозаполнения и предлагаемых запросов)](index-add-suggesters.md), [логика оценки для ранжирования результатов](index-add-scoring-profiles.md).

## <a name="elements-of-a-query-request"></a>Элементы запроса

Запросы всегда направляются в один индекс. Невозможно объединить индексы или создать пользовательские или временные структуры данных и указать их в качестве цели запроса. 

Обязательные элементы в запросе перечислены ниже:

+ конечные точки службы и коллекция документов индекса, выраженные как URL-адрес с фиксированными и определенными пользователем компонентами: **`https://<your-service-name>.search.windows.net/indexes/<your-index-name>/docs`** ;
+ параметр **`api-version`** (только для REST) является обязательным, так как всегда доступно несколько версий API; 
+ параметр **`api-key`** с ключом API запроса или администратора, который проверяет подлинности запроса для доступа к службе;
+ параметр **`queryType`** со значением simple или full, который можно опустить, если нужно использовать простой встроенный синтаксис по умолчанию;
+ **`search`** или **`filter`** с условием поиска, который можно не указывать при поиске пустого значения. Оба типа запросов рассматриваются на примере простого средства синтаксического анализа, но даже в сложных запросах используется параметр поиска для передачи сложных выражений запроса.

Все остальные параметры поиска являются необязательными. Полный список атрибутов приводится в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")). Использование параметров во время обработки более подробно рассматривается в статье [Как работает полнотекстовый поиск в службе поиска Azure](search-lucene-query-architecture.md).

## <a name="choose-apis-and-tools"></a>Выбор API и средств

В таблице ниже представлены интерфейсы API и методы на основе инструментов для отправки запросов.

| Методика | Описание |
|-------------|-------------|
| [Обозреватель Поиска (портал)](search-explorer.md) | Предоставляет панель поиска и параметры для выбора индекса и значения api-version. Будут возвращены результаты в виде документов JSON. Рекомендуется для изучения, тестирования и проверки. <br/>[Подробнее.](search-get-started-portal.md#query-index) | 
| [POST или другие средства для отдыха](search-get-started-postman.md) | Веб-инструменты тестирования идеально подходят для формирования вызовов REST. REST API поддерживает все возможные операции в службе "Поиск Azure". В этой статье описывается, как настроить заголовки и текст HTTP-запроса для отправки запросов к службе "Поиск Azure".  |
| [SearchIndexClient (.NET)](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.searchindexclient?view=azure-dotnet) | Клиент, который может использоваться для отправки запроса к индексу Поиска Azure.  <br/>[Подробнее.](search-howto-dotnet-sdk.md#core-scenarios)  |
| [Поиск по документам (REST API)](https://docs.microsoft.com/rest/api/searchservice/search-documents) | Методы GET или POST для индекса, допускающие использование параметров запроса для ввода дополнительных данных.  |

## <a name="choose-a-parser-simple--full"></a>Выберите средство синтаксического анализа: simple (простое) или full (полное)

В основе Поиска Azure лежит платформа Apache Lucene, что позволяет выбрать между двумя средствами синтаксического анализа запросов для обработки типичных и специализированных запросов. Запросы для простого средства синтаксического анализа должны использовать [простой синтаксис запросов](query-simple-syntax.md). Этот вариант используется по умолчанию, так как обеспечивает высокую скорость и эффективность для запросов в свободной текстовой форме. Этот синтаксис поддерживает ряд общих операторов поиска, включая AND, OR, NOT, а также фразы, суффиксы и операторы приоритета.

[Полный синтаксис запросов Lucene](query-Lucene-syntax.md#bkmk_syntax), который включается при добавлении параметра `queryType=full` в запрос, позволяет применить широко распространенный и выразительный язык запросов, разработанный в составе библиотеки [Apache Lucene](https://lucene.apache.org/core/6_6_1/queryparser/org/apache/lucene/queryparser/classic/package-summary.html). Полный синтаксис расширяет простой синтаксис. Средство полного синтаксического анализа Lucene поймет любой запрос, созданный для простого средства синтаксического анализа. 

Этот аспект демонстрируется в следующих примерах: один и тот же запрос с разными значениями параметра queryType возвращает разные результаты. В первом запросе `^3` после `historic` рассматривается как часть условия поиска. Итоговый результат для этого запроса — "Маркуис за & Suite", в его описание которого содержится *океан*

```
queryType=simple&search=ocean historic^3&searchFields=Description, Tags&$select=HotelId, HotelName, Tags, Description&$count=true
```

Тот же запрос, использующий полное средство синтаксического анализа Lucene, интерпретирует `^3` как более производительное в поле. При переключении синтаксических анализаторов изменяется ранг, а результаты, содержащие термин с *предысторией* , перемещаются в начало.

```
queryType=full&search=ocean historic^3&searchFields=Description, Tags&$select=HotelId, HotelName, Tags, Description&$count=true
```

<a name="types-of-queries"></a>

## <a name="types-of-queries"></a>Типы запросов

Поиск Azure поддерживает широкий спектр типов запросов. 

| Тип запроса | Использование | Дополнительные сведения и примеры |
|------------|--------|-------------------------------|
| Текстовый поиск со свободной формой записи | Параметр поиска и любое средство синтаксического анализа| Полнотекстовый поиск позволяет найти один или несколько терминов во всех полях индекса с меткой *searchable*, примерно так же, как поисковая система Google или Bing. В примере во введении представлен именно полнотекстовый поиск.<br/><br/>Для полнотекстового поиска применяется анализ текста через стандартный анализатор Lucene (по умолчанию), с переводом всех терминов в нижний регистр и удалением стоп-слов (например, артиклей). Вместо этого анализатора по умолчанию вы можете использовать [анализаторы языков, отличных от английского,](index-add-language-analyzers.md#language-analyzer-list) или [специализированные анализаторы, независящие от языка](index-add-custom-analyzers.md#AnalyzerTable), которые применяют другие правила анализа текста. Например, [keyword](https://lucene.apache.org/core/6_6_1/analyzers-common/org/apache/lucene/analysis/core/KeywordAnalyzer.html) позволяет использовать все содержимое поля как один токен. Это полезно для данных некоторых типов, таких как почтовые индексы, идентификаторы и названия продуктов. | 
| Поиск с фильтрацией | [Выражение фильтра OData](query-odata-filter-orderby-syntax.md) и любое средство синтаксического анализа | Запросы фильтрации оценивают логическое выражение по всем полям индекса с меткой *filterable*. В отличие от поиска, запрос фильтрации проверяет точное содержимое поля, в том числе учитывает регистр для строковых полей. Еще одно важное различие — запросы фильтрации выражаются в синтаксисе OData. <br/>[Пример поиска с фильтрацией](search-query-simple-examples.md#example-3-filter-queries) |
| Геопространственный поиск | [Тип Edm.GeographyPoint](https://docs.microsoft.com/rest/api/searchservice/supported-data-types) для поля, выражение фильтра и любое средство синтаксического анализа | Координаты, хранящиеся в поле с типом Edm.GeographyPoint, используются для "поиска соседних объектов" и для элементов управления со встроенными картами. <br/>[Пример поиска геообъектов](search-query-simple-examples.md#example-5-geo-search)|
| Поиск по диапазону | Выражение фильтра и средство простого синтаксического анализа | В Поиске Azure запросы по диапазонам создаются на основе параметра фильтра. <br/>[Пример фильтра по диапазону](search-query-simple-examples.md#example-4-range-filters) | 
| [Поиск по полям](query-lucene-syntax.md#bkmk_fields) | Параметр поиска и средство полного синтаксического анализа | Создайте сложное выражение запроса, предназначенное для одного поля. <br/>[Пример поиска по полям](search-query-lucene-examples.md#example-2-fielded-search) |
| [поиск нечетких соответствий](query-lucene-syntax.md#bkmk_fuzzy); | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с терминами, которые имеют сходную конструкцию или орфографию. <br/>[Пример поиска нечетких соответствий](search-query-lucene-examples.md#example-3-fuzzy-search) |
| [поиск с учетом расположения](query-lucene-syntax.md#bkmk_proximity); | Параметр поиска и средство полного синтаксического анализа | Находит термины, которые расположены в документе рядом друг с другом. <br/>[Пример поиска с учетом расположения](search-query-lucene-examples.md#example-4-proximity-search) |
| [повышение приоритета терминов](query-lucene-syntax.md#bkmk_termboost); | Параметр поиска и средство полного синтаксического анализа | Присваивает более высокий приоритет документам, которые содержат определенный термин. <br/>[Пример повышения приоритета термина](search-query-lucene-examples.md#example-5-term-boosting) |
| [поиск с использованием регулярного выражения](query-lucene-syntax.md#bkmk_regex); | Параметр поиска и средство полного синтаксического анализа | Находит совпадения на основе содержимого регулярного выражения. <br/>[Пример поиска с использованием регулярного выражения](search-query-lucene-examples.md#example-6-regex) |
|  [Поиск с подстановочным знаком или префиксом](query-lucene-syntax.md#bkmk_wildcard) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с учетом префикса и символа тильды (`~`) или одного символа (`?`). <br/>[Пример поиска с использованием подстановочных знаков](search-query-lucene-examples.md#example-7-wildcard-search) |

## <a name="manage-search-results"></a>Управление результатами поиска 

Результаты запроса передаются потоком в виде документов JSON в API REST, хотя если вы используете интерфейсы API .NET, то функции сериализации будут встроенными. Используя параметры запроса, вы можете задать формат результатов и выбрать определенные поля для отображения в результатах.

Параметры запроса можно использовать для структурирования результирующего набора одним из следующих способов.

+ Ограничение числа документов или группирование определенного числа документов в результатах (50 по умолчанию).
+ Выбор полей для включения в результаты.
+ Установка порядка сортировки.
+ Выделение вхождений для привлечения внимания к найденным терминам в тексте результатов поиска.

### <a name="tips-for-unexpected-results"></a>Советы по непредвиденным результатам

В некоторых случаях непредвиденным является содержимое, а не структура результатов. Если результаты запроса не соответствует ожиданиям, можно попробовать изменить запрос и проверить, не улучшились ли результаты, как описано ниже.

+ Измените **`searchMode=any`** (по умолчанию) на **`searchMode=all`** , чтобы потребовать соответствие всем указанным условиям, а не любому из них. Это особенно важно, если запрос содержит логические операторы.

+ Измените логику запроса, если требуется анализ текста или лексический анализа, но тип запроса исключает лингвистическую обработку. В полнотекстовом поиске автокоррекции текста или лексического анализа для орфографических ошибок, одномодульных форм-слов и даже неровностей глаголов или существительных. Для некоторых запросов, таких как поиск нечетких соответствий или поиск с использованием подстановочных знаков, анализ текста не входит в конвейер анализа запроса. Для некоторых сценариев в качестве временного решения используются регулярные выражения. 

### <a name="paging-results"></a>Разбиение результатов по страницам
Служба поиска Azure позволяет легко разбить результаты поиска по страницам. С помощью параметров **`top`** и **`skip`** вы можете формировать такие поисковые запросы, результаты которых возвращаются в управляемых упорядоченных подмножествах. В них поиск можно выполнять проверенными способами с помощью пользовательского интерфейса. При получении этих маленьких подмножеств вы можете получать также сведения о количестве документов во всех результатах поиска.

Дополнительные сведения о разбивке результатов поиска на страницы см. в статье [Разбивка результатов поиска на страницы в службе поиска Azure](search-pagination-page-layout.md).

### <a name="ordering-results"></a>Упорядочение результатов
Вы можете запросить, чтобы служба поиска Azure упорядочила результаты поискового запроса по значениям в определенном поле. По умолчанию служба поиска Azure упорядочивает результаты поиска, руководствуясь важностью суммы поиска документа. Это значение вычисляется на основании меры [TF-IDF](https://en.wikipedia.org/wiki/Tf%E2%80%93idf).

Если нужно, чтобы служба "Поиск Azure" упорядочивала результаты не по значению оценки, а по другому значению, вы можете воспользоваться поисковым параметром **`orderby`** . Вы можете включить в значение параметра **`orderby`** имена полей и вызовов [**функции `geo.distance()`** ](query-odata-filter-orderby-syntax.md) для геопространственных значений. После каждого выражения можно поставить символ `asc`, чтобы указать, что результаты требуется представить по возрастанию, или символ **`desc`** , если результаты нужно упорядочить по убыванию. По умолчанию результаты сортируются по возрастанию.


### <a name="hit-highlighting"></a>Выделение совпадений
В службе "Поиск Azure" вы можете легко выделить конкретную часть результатов поиска, которые соответствуют поисковому запросу, используя параметры **`highlight`** , **`highlightPreTag`** и **`highlightPostTag`** . Вы можете указать, в каких *поддерживающих поиск* полях следует выделять вхождения. Кроме того, можно указать конкретные теги строк, которые нужно добавлять к началу и концу вхождений, которые возвращает служба поиска Azure.

## <a name="see-also"></a>Дополнительные материалы

+ [Как работает полнотекстовый поиск в службе поиска Azure (архитектура анализа запросов)](search-lucene-query-architecture.md)
+ [Обозреватель поиска](search-explorer.md)
+ [Выполнение запроса в .NET](search-query-dotnet.md)
+ [Выполнение запроса в REST](search-create-index-rest-api.md)
