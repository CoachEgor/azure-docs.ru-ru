---
title: Типы запросов и составление запросов
titleSuffix: Azure Cognitive Search
description: Основы создания поискового запроса в Azure Cognitive Search с использованием параметров для фильтрации, выбора и сортировки результатов.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 11/04/2019
ms.openlocfilehash: 902f3628235cc8a4524ddc4dd8a5327592fe47e7
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79282826"
---
# <a name="query-types-and-composition-in-azure-cognitive-search"></a>Типы запросов и состав в Azure Cognitive Search

В Azure Cognitive Search запрос представляет собой полную спецификацию операции туда и обратно. Параметры запроса обеспечивают соответствие критериям для поиска документов в индексе, какие поля включать или исключать, инструкции по исполнению, переданные в движок, и директивы для формирования ответа. Неопределенный`search=*`(), запрос выполняется против всех поисковых полей в качестве операции полного поиска текста, возвращая незачитанный результат, установленный в произвольном порядке.

Следующим примером является репрезентативный запрос, построенный в [API REST.](https://docs.microsoft.com/rest/api/searchservice/search-documents) Этот пример ориентирован на [демо-индекс отелей](search-get-started-portal.md) и включает общие параметры.

```
{
    "queryType": "simple" 
    "search": "+New York +restaurant",
    "searchFields": "Description, Address/City, Tags",
    "select": "HotelId, HotelName, Description, Rating, Address/City, Tags",
    "top": "10",
    "count": "true",
    "orderby": "Rating desc"
}
```

+ **`queryType`** устанавливает парсер, который является либо [простой парсер запроса по умолчанию](search-query-simple-examples.md) (оптимальный для полного поиска текста), или [полный Lucene запрос парсер,](search-query-lucene-examples.md) используемый для продвинутых конструкций запроса, как регулярные выражения, поиск близости, нечеткий и поиск подстановочных знаков, чтобы назвать несколько.

+ **`search`** обеспечивает соответствие критериям, как правило, текст, но часто сопровождается boolean операторов. Запрос с одним самостоятельным термином называется запросом *термина*. Запрос с несколькими частями, заключенными в кавычки, считается запросом *ключевой фразы*. Поиск может быть неопределенным, как в **`search=*`**, но, скорее всего, состоит из терминов, фраз и операторов, аналогичных тому, что появляется в примере.

+ **`searchFields`** ограничивает выполнение запроса для определенных полей. Любое поле, приписываемое как *доступное* для поиска в схеме индекса, является кандидатом для этого параметра.

Формат ответа также определяется параметрами, включенными в запрос. В примере набор результатов состоит из **`select`** полей, перечисленных в заявлении. В $select-выписке могут использоваться только поля, помеченные как *извлекаемые.* Кроме того, **`top`** в этом запросе возвращаются только **`count`** 10 хитов, в то время как вы показываете, сколько документов совпадает в целом, что может быть больше, чем возвращается. В этом запросе строки сортируются по рейтингу в порядке убывания.

В Azure Cognitive Search выполнение запроса всегда против одного индекса, проверенного с помощью api-ключа, предусмотренного в запросе. В интерфейсах REST эти данные передаются в заголовках запроса.

### <a name="how-to-run-this-query"></a>Процесс выполнения запроса

Для выполнения этого запроса используйте [Search Explorer и демо-индекс отелей.](search-get-started-portal.md) 

Строку запроса можно вставить прямо в панель поиска обозревателя: `search=+"New York" +restaurant&searchFields=Description, Address/City, Tags&$select=HotelId, HotelName, Description, Rating, Address/City, Tags&$top=10&$orderby=Rating desc&$count=true`

## <a name="how-query-operations-are-enabled-by-the-index"></a>Как индекс влияет на операции запросов

Дизайн индекса и дизайн запросов тесно связаны с Azure Cognitive Search. Здесь важно сразу понять, что именно *схема индекса* с атрибутами для каждого поля определяет, какие типы запросов вы сможете создавать. 

Атрибуты индекса задают допустимые операции для набора полей в индексе, например возможность поиска (*searchable*), извлечения (*retrievable*), сортировки (*sortable*) и фильтрации (*filterable*). В строке запроса `"$orderby": "Rating"` примера работает только потому, что поле рейтинга помечено как *сортируемое* в схеме индекса. 

![Определение индекса для выборки отеля](./media/search-query-overview/hotel-sample-index-definition.png "Определение индекса для выборки отеля")

Вышеприведенный скриншот представляет собой частичный список атрибутов индекса для образца отелей. Полную схему индекса вы можете изучить на портале. Дополнительные сведения об атрибутах индекса см. в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")).

> [!Note]
> Некоторые функции обработки запросов включаются на уровне всего индекса, а не для отдельных полей. Эти возможности включают в себя: [синоним карты](search-synonyms.md), [пользовательские анализаторы](index-add-custom-analyzers.md), [предлагатель конструкций (для автозаполнения и предлагаемых запросов)](index-add-suggesters.md), [скоринга логики для результатов ранжирования](index-add-scoring-profiles.md).

## <a name="elements-of-a-query-request"></a>Элементы запроса

Запросы всегда направляются в один индекс. Невозможно объединить индексы или создать пользовательские или временные структуры данных и указать их в качестве цели запроса. 

Обязательные элементы в запросе перечислены ниже:

+ Сбор конечных точек обслуживания и индексных документов, выраженный как URL-адрес, содержащий фиксированные и определенные компонентами:**`https://<your-service-name>.search.windows.net/indexes/<your-index-name>/docs`**
+ **`api-version`**(только REST) необходимо, потому что более чем одна версия API доступна в любое время. 
+ **`api-key`**, либо запрос, либо admin api-key, проверяет подлинность запроса в службу.
+ **`queryType`**, как простой, так и полный, который может быть опущен, если вы используете встроенный по умолчанию простой синтаксис.
+ **`search`** или **`filter`** предоставляет критерии соответствия, которые могут быть неопределенными, если вы хотите выполнить пустой поиск. Оба типа запросов рассматриваются на примере простого средства синтаксического анализа, но даже в сложных запросах используется параметр поиска для передачи сложных выражений запроса.

Все остальные параметры поиска являются необязательными. Полный список атрибутов приводится в статье [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индекса (REST API службы "Поиск Azure")). Более подробно ознакомиться с тем, как используются параметры при обработке, см., [как работает полнотекстовый поиск в Azure Cognitive Search.](search-lucene-query-architecture.md)

## <a name="choose-apis-and-tools"></a>Выберите AIS и инструменты

В таблице ниже представлены интерфейсы API и методы на основе инструментов для отправки запросов.

| Методика | Описание |
|-------------|-------------|
| [Исследователь поиска (портал)](search-explorer.md) | Предоставляет панель поиска и параметры для выбора индекса и значения api-version. Будут возвращены результаты в виде документов JSON. Рекомендуется для исследования, тестирования и проверки. <br/>[См. дополнительные сведения.](search-get-started-portal.md#query-index) | 
| [Почтальон или другие инструменты REST](search-get-started-postman.md) | Веб-инструменты тестирования идеально подходят для формирования вызовов REST. REST API поддерживает все возможные операции в Azure Cognitive Search. В этой статье узнайте, как настроить заголовок запроса HTTP и тело для отправки запросов в Azure Cognitive Search.  |
| [SearchIndexClient (.NET)](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.searchindexclient?view=azure-dotnet) | Клиент, который может быть использован для запроса индекса когнитивного поиска Azure.  <br/>[См. дополнительные сведения.](search-howto-dotnet-sdk.md#core-scenarios)  |
| [Поиск по документам (REST API)](https://docs.microsoft.com/rest/api/searchservice/search-documents) | Методы GET или POST для индекса, допускающие использование параметров запроса для ввода дополнительных данных.  |

## <a name="choose-a-parser-simple--full"></a>Выберите средство синтаксического анализа: simple (простое) или full (полное)

Azure Cognitive Search находится на вершине Apache Lucene и дает вам выбор между двумя паразами обработки запросов для обработки типичных и специализированных запросов. Запросы для простого средства синтаксического анализа должны использовать [простой синтаксис запросов](query-simple-syntax.md). Этот вариант используется по умолчанию, так как обеспечивает высокую скорость и эффективность для запросов в свободной текстовой форме. Этот синтаксис поддерживает ряд общих операторов поиска, включая AND, OR, NOT, а также фразы, суффиксы и операторы приоритета.

[Полный синтаксис запросов Lucene](query-Lucene-syntax.md#bkmk_syntax), который включается при добавлении параметра `queryType=full` в запрос, позволяет применить широко распространенный и выразительный язык запросов, разработанный в составе библиотеки [Apache Lucene](https://lucene.apache.org/core/6_6_1/queryparser/org/apache/lucene/queryparser/classic/package-summary.html). Полный синтаксис расширяет простой синтаксис. Средство полного синтаксического анализа Lucene поймет любой запрос, созданный для простого средства синтаксического анализа. 

Этот аспект демонстрируется в следующих примерах: один и тот же запрос с разными значениями параметра queryType возвращает разные результаты. В первом запросе `^3` после `historic` рассматривается как часть поискового термина. Топ-рейтинг результат для этого запроса "Маркиз Плаза & Suites", который имеет *океан* в своем описании

```
queryType=simple&search=ocean historic^3&searchFields=Description, Tags&$select=HotelId, HotelName, Tags, Description&$count=true
```

Тот же запрос с использованием полного `^3` Lucene parser интерпретируется как в поле срок руля. Переключение парзеров меняет ранг, результаты которых содержат термин *«исторический* переход к вершине».

```
queryType=full&search=ocean historic^3&searchFields=Description, Tags&$select=HotelId, HotelName, Tags, Description&$count=true
```

<a name="types-of-queries"></a>

## <a name="types-of-queries"></a>Типы запросов

Azure Cognitive Search поддерживает широкий спектр типов запросов. 

| Тип запроса | Использование | Дополнительные сведения и примеры |
|------------|--------|-------------------------------|
| Текстовый поиск со свободной формой записи | Параметр поиска и любое средство синтаксического анализа| Полнотекстовый поиск позволяет найти один или несколько терминов во всех полях индекса с меткой *searchable*, примерно так же, как поисковая система Google или Bing. В примере во введении представлен именно полнотекстовый поиск.<br/><br/>Для полнотекстового поиска применяется анализ текста через стандартный анализатор Lucene (по умолчанию), с переводом всех терминов в нижний регистр и удалением стоп-слов (например, артиклей). Вместо этого анализатора по умолчанию вы можете использовать [анализаторы языков, отличных от английского,](index-add-language-analyzers.md#language-analyzer-list) или [специализированные анализаторы, независящие от языка](index-add-custom-analyzers.md#AnalyzerTable), которые применяют другие правила анализа текста. Например, [keyword](https://lucene.apache.org/core/6_6_1/analyzers-common/org/apache/lucene/analysis/core/KeywordAnalyzer.html) позволяет использовать все содержимое поля как один токен. Это полезно для данных некоторых типов, таких как почтовые индексы, идентификаторы и названия продуктов. | 
| Поиск с фильтрацией | [Выражение фильтра OData](query-odata-filter-orderby-syntax.md) и любое средство синтаксического анализа | Запросы фильтрации оценивают логическое выражение по всем полям индекса с меткой *filterable*. В отличие от поиска, запрос фильтрации проверяет точное содержимое поля, в том числе учитывает регистр для строковых полей. Еще одно важное различие — запросы фильтрации выражаются в синтаксисе OData. <br/>[Пример поиска с фильтрацией](search-query-simple-examples.md#example-3-filter-queries) |
| Геопространственный поиск | [Тип Edm.GeographyPoint](https://docs.microsoft.com/rest/api/searchservice/supported-data-types) для поля, выражение фильтра и любое средство синтаксического анализа | Координаты, хранящиеся в поле с типом Edm.GeographyPoint, используются для "поиска соседних объектов" и для элементов управления со встроенными картами. <br/>[Пример поиска геообъектов](search-query-simple-examples.md#example-5-geo-search)|
| Поиск по диапазону | Выражение фильтра и средство простого синтаксического анализа | В Azure Cognitive Search запросы диапазона строятся с использованием параметра фильтра. <br/>[Пример фильтра по диапазону](search-query-simple-examples.md#example-4-range-filters) | 
| [Полевый поиск](query-lucene-syntax.md#bkmk_fields) | Параметр поиска и средство полного синтаксического анализа | Создайте сложное выражение запроса, предназначенное для одного поля. <br/>[Пример поиска на местах](search-query-lucene-examples.md#example-2-fielded-search) |
| [нечеткий поиск](query-lucene-syntax.md#bkmk_fuzzy) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с терминами, которые имеют сходную конструкцию или орфографию. <br/>[Пример поиска нечетких соответствий](search-query-lucene-examples.md#example-3-fuzzy-search) |
| [поиск по сходству](query-lucene-syntax.md#bkmk_proximity) | Параметр поиска и средство полного синтаксического анализа | Находит термины, которые расположены в документе рядом друг с другом. <br/>[Пример поиска с учетом расположения](search-query-lucene-examples.md#example-4-proximity-search) |
| [срок повышения](query-lucene-syntax.md#bkmk_termboost) | Параметр поиска и средство полного синтаксического анализа | Присваивает более высокий приоритет документам, которые содержат определенный термин. <br/>[Пример повышения приоритета термина](search-query-lucene-examples.md#example-5-term-boosting) |
| [регулярный поиск выражения](query-lucene-syntax.md#bkmk_regex) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения на основе содержимого регулярного выражения. <br/>[Пример поиска с использованием регулярного выражения](search-query-lucene-examples.md#example-6-regex) |
|  [Поиск с подстановочным знаком или префиксом](query-lucene-syntax.md#bkmk_wildcard) | Параметр поиска и средство полного синтаксического анализа | Находит совпадения с учетом префикса и символа тильды (`~`) или одного символа (`?`). <br/>[Пример поиска с использованием подстановочных знаков](search-query-lucene-examples.md#example-7-wildcard-search) |

## <a name="manage-search-results"></a>Управление результатами поиска 

Результаты запроса передаются потоком в виде документов JSON в API REST, хотя если вы используете интерфейсы API .NET, то функции сериализации будут встроенными. Используя параметры запроса, вы можете задать формат результатов и выбрать определенные поля для отображения в результатах.

Параметры запроса можно использовать для структурирования результирующего набора одним из следующих способов.

+ Ограничение числа документов или группирование определенного числа документов в результатах (50 по умолчанию).
+ Выбор полей для включения в результаты.
+ Установка порядка сортировки.
+ Выделение вхождений для привлечения внимания к найденным терминам в тексте результатов поиска.

### <a name="tips-for-unexpected-results"></a>Советы по непредвиденным результатам

В некоторых случаях непредвиденным является содержимое, а не структура результатов. Если результаты запроса не соответствует ожиданиям, можно попробовать изменить запрос и проверить, не улучшились ли результаты, как описано ниже.

+ Изменение **`searchMode=any`** (по **`searchMode=all`** умолчанию) для выполнения совпадений по всем критериям вместо любого из критериев. Это особенно важно, если запрос содержит логические операторы.

+ Измените логику запроса, если требуется анализ текста или лексический анализа, но тип запроса исключает лингвистическую обработку. В полном тексте поиска, текста или лексического анализа autocorrects для орфографических ошибок, сингулярно-множественные формы слова, и даже нерегулярные глаголы или существительные. Для некоторых запросов, таких как поиск нечетких соответствий или поиск с использованием подстановочных знаков, анализ текста не входит в конвейер анализа запроса. Для некоторых сценариев в качестве временного решения используются регулярные выражения. 

### <a name="paging-results"></a>Разбиение результатов по страницам
Azure Cognitive Search упрощает реализацию результатов поиска. Используя параметры **`top`** **`skip`** и параметры, вы можете плавно выдавать поисковые запросы, которые позволяют получать общий набор результатов поиска в управляемых, упорядоченных подмножеств, которые легко позволяют использовать хорошие методы поиска. При получении этих маленьких подмножеств вы можете получать также сведения о количестве документов во всех результатах поиска.

Подробнее о результатах поиска в статье [«Как найти результаты поиска в Azure Cognitive Search»](search-pagination-page-layout.md)вы можете узнать больше.

### <a name="ordering-results"></a>Упорядочение результатов
При получении результатов для поискового запроса можно запросить, чтобы Azure Cognitive Search обслуживал результаты, заказанные значениями в определенной области. По умолчанию Azure Cognitive Search заказывает результаты поиска на основе ранга оценки поиска каждого документа, полученной из [TF-IDF.](https://en.wikipedia.org/wiki/Tf%E2%80%93idf)

Если вы хотите, чтобы Azure Cognitive Search вернул результаты, заказанные **`orderby`** по цене, не превышающее оценку поиска, можно использовать параметр поиска. Можно указать значение **`orderby`** параметра для включения названий полей и вызовов в [** `geo.distance()` функцию**](query-odata-filter-orderby-syntax.md) для геопространственных значений. За каждым выражением `asc` можно следовать, чтобы указать, что **`desc`** результаты запрашиваются в порядке возрастания, и указать, что результаты запрашиваются в порядке убывания. По умолчанию результаты сортируются по возрастанию.


### <a name="hit-highlighting"></a>Выделение совпадений
В Azure Cognitive Search, подчеркивая точную часть результатов поиска, которые **`highlight`** соответствуют поисковому запросу, упрощается с помощью **`highlightPreTag`**, и **`highlightPostTag`** параметры. Можно указать, какие *поля поиска* должны подчеркивать их совпадающий текст, а также указать точные теги строки, чтобы прибовать к началу и концу совмещенного текста, который возвращает Azure Cognitive Search.

## <a name="see-also"></a>См. также

+ [Как работает полный поиск текста в Azure Cognitive Search (архитектура разбора запросов)](search-lucene-query-architecture.md)
+ [Исследователь поиска](search-explorer.md)
+ [Выполнение запроса в .NET](search-query-dotnet.md)
+ [Выполнение запроса в REST](search-create-index-rest-api.md)
