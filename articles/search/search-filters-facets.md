---
title: Фильтры аспекта для навигации поиска в приложениях в службе "Поиск Azure"
description: Условия фильтрации по удостоверениям безопасности, географическому расположению или числовым значениям для уменьшения результатов поиска в запросах в службе "Поиск Azure", размещенной облачной службе поиска в Microsoft Azure.
author: HeidiSteen
manager: cgronlun
services: search
ms.service: search
ms.topic: conceptual
ms.date: 5/13/2019
ms.author: heidist
ms.custom: seodec2018
ms.openlocfilehash: 88171487fd180931d4659390f0db3c8619fb2d62
ms.sourcegitcommit: cf438e4b4e351b64fd0320bf17cc02489e61406a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/08/2019
ms.locfileid: "67653451"
---
# <a name="how-to-build-a-facet-filter-in-azure-search"></a>Как создать фильтр аспекта в службе "Поиск Azure" 

Фасетная навигация используется для автоматической фильтрации результатов запроса в поисковом приложении, когда ваше приложение предлагает элементы пользовательского интерфейса для поиска с ограничением до групп документов (например, категорий или брендов), а служба "Поиск Azure" предоставляет структуру данных. В этой статье кратко рассматриваются основные шаги для создания структуры фасетной навигации с возможностями поиска, которые вы хотите предоставить. 

> [!div class="checklist"]
> * Выбор полей для фильтрации и фасетизации
> * Указание атрибутов поля
> * Построение индекса и загрузка данных
> * Добавление фильтров аспектов в запрос
> * Обработка результатов

Аспекты являются динамическими и возвращаются в запросе. В ответах поиска приводятся фасетные категории, используемые для навигации по результатам. Если вы не знакомы с аспектами, ниже приведен пример структуры фасетной навигации.

  ![](./media/search-filters-facets/facet-nav.png)

Хотите подробнее узнать о фасетной навигации? Ознакомьтесь со статьей [Как реализовать фасетную навигацию в службе поиска Azure](search-faceted-navigation.md).

## <a name="choose-fields"></a>Выбор полей

Аспекты могут быть вычислены для отдельных полей значений, а также для коллекций. Поля, которые лучше всего работают в фасетной навигации, имеют низкую кратность: небольшое количество различающихся значений, которые повторяются во всех документах в данных поиска (например, список цветов, стран или торговых марок). 

Поддержка фасетов включается для каждого поля, при создании индекса, задав `facetable` атрибут `true`. Обычно также следует задать `filterable` атрибут `true` для таких полей, чтобы приложение поиска можно фильтровать по этим полям, в зависимости от аспектов, которые конечный пользователь выберет. 

При создании индекса с помощью REST API, любое [тип поля](https://docs.microsoft.com/rest/api/searchservice/supported-data-types) , которые могут использоваться возможно в фасетной навигации помечается как `facetable` по умолчанию:

+ `Edm.String`
+ `Edm.DateTimeOffset`
+ `Edm.Boolean`
+ Типы числовых полей: `Edm.Int32`, `Edm.Int64`, `Edm.Double`
+ Коллекции из перечисленных выше типов (например, `Collection(Edm.String)` или `Collection(Edm.Double)`)

Нельзя использовать `Edm.GeographyPoint` или `Collection(Edm.GeographyPoint)` полей в фасетной навигации. Аспекты лучше всего работают на поля с небольшим количеством элементов. Из-за разрешения географических координат очень редко, что любые два набора координаты будет равно в заданном наборе данных. Таким образом аспекты не поддерживаются для географических координат. Вам понадобится поле города или региона для поиска по местоположению с использованием фасетизации.

## <a name="set-attributes"></a>Определение атрибутов

Атрибуты индекса, которые управляют использованием поля, добавляются к отдельным определениям полей в индексе. В следующем примере поля с низкой кратностью, полезные для фасетизации, состоят из: `category` (гостиницы, мотели, общежития), `tags`, и `rating`. Эти поля имеют `filterable` и `facetable` заданные явным образом в следующем примере атрибуты для иллюстративных целей. 

> [!Tip]
> Для оптимизации производительности и хранения отключите фасетизацию для полей, которые никогда не должны использоваться в качестве аспектов. В частности, для уникальных значений, таких как идентификатор или название продукта, полей строк должно быть присвоено `"facetable": false` во избежание их случайного (и неэффективного) использования при фасетной навигации.


```json
{
  "name": "hotels",  
  "fields": [
    { "name": "hotelId", "type": "Edm.String", "key": true, "searchable": false, "sortable": false, "facetable": false },
    { "name": "baseRate", "type": "Edm.Double" },
    { "name": "description", "type": "Edm.String", "filterable": false, "sortable": false, "facetable": false },
    { "name": "description_fr", "type": "Edm.String", "filterable": false, "sortable": false, "facetable": false, "analyzer": "fr.lucene" },
    { "name": "hotelName", "type": "Edm.String", "facetable": false },
    { "name": "category", "type": "Edm.String", "filterable": true, "facetable": true },
    { "name": "tags", "type": "Collection(Edm.String)", "filterable": true, "facetable": true },
    { "name": "parkingIncluded", "type": "Edm.Boolean",  "filterable": true, "facetable": true, "sortable": false },
    { "name": "smokingAllowed", "type": "Edm.Boolean", "filterable": true, "facetable": true, "sortable": false },
    { "name": "lastRenovationDate", "type": "Edm.DateTimeOffset" },
    { "name": "rating", "type": "Edm.Int32", "filterable": true, "facetable": true },
    { "name": "location", "type": "Edm.GeographyPoint" }
  ]
}
```

> [!Note]
> Это определение индекса можно скопировать в статье [Создание индекса службы поиска Azure с помощью REST API](https://docs.microsoft.com/azure/search/search-create-index-rest-api). Оно идентично, за исключением поверхностных различий в определениях полей. `filterable` И `facetable` атрибуты явно добавляются в `category`, `tags`, `parkingIncluded`, `smokingAllowed`, и `rating` поля. На практике `filterable` и `facetable` бы включить в эти поля по умолчанию при использовании REST API. При использовании пакета SDK для .NET, необходимо явно включить эти атрибуты.

## <a name="build-and-load-an-index"></a>Построение и загрузка индекса

Промежуточным (и, возможно, очевидным) шагом является [сборка и заполнение индекса](https://docs.microsoft.com/azure/search/search-get-started-dotnet#1---create-index) перед формулировкой запроса. Здесь мы упомянем этот шаг для полноты картины. Один из способов определить доступность индекса — это проверить список индексов на [портале](https://portal.azure.com).

## <a name="add-facet-filters-to-a-query"></a>Добавление фильтров аспектов в запрос

В коде приложения создайте запрос, который определяет все части допустимого запроса, включая выражения поиска, фасеты, фильтры, профили оценки — все, что используется для формулировки запроса. В следующем примере создается запрос, применяемый для фасетной навигации с использованием фасетов размещения, рейтинга и других удобств.

```csharp
var sp = new SearchParameters()
{
    ...
    // Add facets
    Facets = new[] { "category", "rating", "parkingIncluded", "smokingAllowed" }.ToList()
};
```

### <a name="return-filtered-results-on-click-events"></a>Возврат отфильтрованных результатов при событии щелчка

Когда конечный пользователь выбирает значение аспекта, обработчик для события щелчка следует использовать выражение фильтра для реализации намерения пользователя. Учитывая `category` аспекта, щелкнув категории «мотель» реализуется с помощью `$filter` выражение, которое выбирает размещения этого типа. Когда пользователь щелкает «motel», чтобы указать, что только мотели, далее приложение отправляет запрос включает `$filter=category eq 'motel'`.

Следующий фрагмент кода добавляет категорию в фильтр, если пользователь выбирает значение из фасета категории.

```csharp
if (!String.IsNullOrEmpty(categoryFacet))
    filter = $"category eq '{categoryFacet}'";
```

Если пользователь щелкает значение аспекта для поля коллекции как `tags`, например значение «пул», в приложении следует использовать следующий синтаксис фильтра: `$filter=tags/any(t: t eq 'pool')`

## <a name="tips-and-workarounds"></a>Советы и обходные решения

### <a name="initialize-a-page-with-facets-in-place"></a>Инициализация страницы с помощью фасетов

Если требуется инициализировать страницу с помощью фасетов, вы можете отправить запрос как часть инициализации страницы, чтобы заполнить страницу исходной структурой фасета.

### <a name="preserve-a-facet-navigation-structure-asynchronously-of-filtered-results"></a>Асинхронное сохранение структуры фасетной навигации отфильтрованных результатов

Одна из сложностей фасетной навигации в службе "Поиск Azure" заключается в том, что фасеты существуют только для текущих результатов. На практике обычно сохраняется статический набор фасетов, чтобы пользователь мог перемещаться в обратном направлении, проходя по поисковому содержимому для поиска альтернативных путей. 

Хотя это распространенный вариант использования, структура фасетной навигации в настоящее время не предоставляет этого изначально. Разработчики, которым требуются статические аспекты, обычно обходят ограничение, выполняя два отфильтрованных запроса: один в пределах результатов, а другой для создания статического списка аспектов для навигации.

## <a name="see-also"></a>См. также

+ [Фильтры в службе "Поиск Azure"](search-filters.md)
+ [Create Index (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/create-index) (Создание индексов (REST API службы "Поиск Azure")).
+ [Search Documents (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/search-documents) (Поиск по документам (REST API службы поиска Azure))
