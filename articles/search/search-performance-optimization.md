---
title: Стратегии развертывания и рекомендации по оптимизации производительности — Поиск Azure
description: Методики и рекомендации по настройке производительности Поиска Azure и выбору оптимального масштаба.
author: LiamCavanagh
manager: nitinme
services: search
ms.service: search
ms.devlang: rest-api
ms.topic: conceptual
ms.date: 03/02/2019
ms.author: liamca
ms.custom: seodec2018
ms.openlocfilehash: 566c208ef415f6fc9f3ada419e2f9e9244bc066d
ms.sourcegitcommit: 1d0b37e2e32aad35cc012ba36200389e65b75c21
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2019
ms.locfileid: "72333164"
---
# <a name="deployment-strategies-and-best-practices-for-optimizing-performance-on-azure-search"></a>Стратегии развертывания и рекомендации по оптимизации производительности в службе поиска Azure

В этой статье описываются рекомендации по расширенным сценариям с помощью сложных требований к масштабируемости и доступности. 

## <a name="develop-baseline-numbers"></a>Разработка базовых номеров
При оптимизации производительности поиска следует сосредоточиться на сокращении времени выполнения запроса. Для этого необходимо знать, как выглядит Обычная нагрузка запроса. Приведенные ниже рекомендации могут помочь при получении номеров базовых запросов.

1. Выберите целевую задержку (или максимальное количество времени), которая типична для выполнения запроса на поиск.
2. Создайте и протестируйте реальную рабочую нагрузку на своей службе поиска, используя правдоподобный набор данных, чтобы измерить эти показатели задержки.
3. Начните с небольшого количества запросов в секунду (QPS) и постепенно увеличивайте число, выполняемое в тесте, пока задержка запроса не станет меньше заданной целевой задержки. Это важный тест производительности, который поможет спланировать масштабирование приложения по мере того, как оно будет охватывать все больше пользователей.
4. По возможности повторно используйте подключения HTTP. Если используется пакет SDK для Поиска Azure для .NET, то это означает, что следует повторно использовать экземпляр или экземпляр [SearchIndexClient](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.searchindexclient) , а если используется REST API, то следует использовать один HttpClient.
5. Изменяйте вещество запросов запросов, чтобы поиск произносится по разным частям индекса. Вариант важен, поскольку если вы постоянно выполняете те же поисковые запросы, кэширование данных начнет повысить производительность, чем может быть более разнородным набором запросов.
6. Изменяйте структуру запросов запросов, чтобы получать различные типы запросов. Не все поисковые запросы выполняются на одном уровне. Например, Поиск документа или предложение поиска обычно выполняется быстрее, чем запрос с большим количеством аспектов и фильтров. Тестовая композиция должна включать различные запросы в примерно те же соотношения, что и в рабочей среде.  

При создании этих тестовых рабочих нагрузок следует помнить о некоторых характеристиках Поиска Azure.

+ Вы можете перегрузить службу, помещая слишком много поисковых запросов за один раз. В этом случае вы увидите коды ответов HTTP 503. Чтобы избежать 503 во время тестирования, начните с различных диапазонов запросов поиска, чтобы увидеть разницу в скорости задержки по мере добавления дополнительных запросов поиска.

+ Служба поиска Azure не выполняет задачи индексирования в фоновом режиме. Если служба обрабатывает рабочие нагрузки запросов и индексирования параллельно, примите это во внимание, поставляя задания индексирования в тесты запросов, или изучите варианты выполнения заданий индексации в часы пиковой нагрузки.

> [!NOTE]
> [Нагрузочное тестирование Visual Studio](https://www.visualstudio.com/docs/test/performance-testing/run-performance-tests-app-before-release) — очень удобный способ измерять производительность, так как оно позволяет выполнять HTTP-запросы точно так же, как выполняются запросы к Поиску Azure, и обеспечивает их параллельную обработку.
> 
> 

## <a name="scaling-for-high-query-volume-and-throttled-requests"></a>Масштабирование для большого объема запросов и регулируемых запросов
При получении слишком большого количества регулируемых запросов или превышении целевой частоты задержки при повышенной нагрузке запроса можно уменьшить частоту задержки одним из двух способов:

1. **Увеличьте число реплик**. Реплика — это как копия ваших данных, позволяющая Поиску Azure балансировать нагрузку запросов, распределяя их между несколькими копиями.  Всеми операциями балансировки нагрузки и репликации данных между репликами управляет Поиск Azure, и в любое время можно изменить число реплик, выделенных для вашей службы.  Можно выделить до 12 реплик для службы поиска уровня "Стандартный" и до 3 реплик для службы поиска уровня "Базовый". Реплики можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).
2. **Повысьте уровень поиска**. Поиск Azure поставляется на [нескольких уровнях](https://azure.microsoft.com/pricing/details/search/), и каждый из них предлагает различные уровни производительности.  В некоторых случаях у вас может быть столько запросов, что уровень, на котором вы настроили, не может обеспечить достаточно низкой частоты задержки, даже если реплики израсходован. В этом случае вы можете использовать один из более высоких уровней поиска, например уровень S3 поиска Azure, который хорошо подходит для сценариев с большим количеством документов и чрезвычайно большим числом рабочих нагрузок запросов.

## <a name="scaling-for-slow-individual-queries"></a>Масштабирование для отдельных запросов
Другая причина для высокой скорости задержки — выполнение одного запроса занимает слишком много времени. В этом случае добавление реплик не поможет. Ниже приведены два возможных параметра, которые могут оказаться полезными.

1. **Увеличьте число секций**. Секция представляет собой механизм разделения данных между дополнительными ресурсами. При добавлении второй секции данные разбиваются на две, третья секция разбивается на три и т. д. Один из положительных побочных эффектов заключается в том, что медленные запросы иногда выполняются быстрее из-за параллельных вычислений. Мы отметили параллелизм по запросам с низким уровнем избирательности, например запросам, которые соответствуют многим документам, или аспектам, предоставляющим подсчеты в большом количестве документов. Поскольку значительные вычисления необходимы для оценки релевантности документов или для подсчета количества документов, добавление дополнительных секций позволяет ускорить выполнение запросов.  
   
   Для службы поиска уровня "Стандартный" можно использовать до 12 секций, а для службы поиска уровня "Базовый" — только 1 секцию.  Секции можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

2. **Ограничить большие поля кратности:** Большое поле кратности состоит из поля с аспектом или фильтруемым полем, которое имеет значительное количество уникальных значений, и в результате потребляет значительные ресурсы при вычислении результатов. Например, задание идентификатора продукта или поля описания в качестве аспекта или фильтрации будет считаться большим количеством элементов, так как большинство значений из документа в документ являются уникальными. По возможности ограничивайте число полей с высокой кратностью.

3. **Повысьте уровень службы поиска**. Переход на более высокий уровень Поиска Azure также может повысить скорость обработки медленно выполняемых запросов. Каждый более высокий уровень обеспечивает более быстрые процессоры и больше памяти, что оказывает положительное воздействие на производительность запросов.

## <a name="scaling-for-availability"></a>Масштабирование для обеспечения доступности
Реплики не только уменьшают задержки при обработке запросов, но и могут обеспечить высокий уровень доступности. При использовании одной реплики следует ожидать периодических простоев из-за перезагрузки сервера после обновления программного обеспечения или других операций технического обслуживания.  Поэтому важно определить, требуется ли приложению высокий уровень доступности операций поиска (запросов) и записи (событий индексирования). Поиск Azure предлагает различные варианты соглашения об уровне обслуживания для всех платных предложений поиска со следующими атрибутами:

* 2 реплики для обеспечения высокой доступности рабочих нагрузок для чтения (запросов).
* 3 или более реплики для обеспечения высокой доступности рабочих нагрузок чтения и записи (запросов и индексирования).

Дополнительные сведения об этом см. в [соглашении об уровне обслуживания для Поиска Azure](https://azure.microsoft.com/support/legal/sla/search/v1_0/).

Так как реплики являются копиями ваших данных, наличие нескольких реплик позволяет службе поиска Azure выполнять перезагрузку и обслуживание компьютеров в одной реплике, одновременно позволяя продолжать выполнение запросов на других репликах. И наоборот, если вы принимаете реплики, вы получаете снижение производительности запросов, предполагая, что эти реплики были недостаточно загружены.

## <a name="scaling-for-geo-distributed-workloads-and-geo-redundancy"></a>Масштабирование для геораспределенных рабочих нагрузок и геоизбыточности
Для геораспределенных рабочих нагрузок пользователи, расположенные далеко от центра обработки данных, в котором размещается служба поиска Azure, будут иметь более высокую частоту задержки. Одним из способов устранения этой проблемы является предоставление нескольких служб поиска в регионах с более близкой стороной к этим пользователям. В настоящее время Поиск Azure не предоставляет автоматический метод георепликации индексов Поиска Azure между регионами, но доступны некоторые методы, с помощью которых легко реализовать этот процесс и управлять им. Они описаны в нескольких следующих разделах.

Целью геораспределенного набора служб поиска является наличие двух или более индексов, доступных в двух или более регионах, где пользователь направляется в службу поиска Azure, которая обеспечивает наименьшую задержку, как показано в этом примере:

   ![Перекрестные запросы к службам по региону][1]

### <a name="keeping-data-in-sync-across-multiple-azure-search-services"></a>Синхронизация данных между несколькими службами Поиска Azure
Существует два варианта обеспечить синхронизацию распределенных служб поиска: использовать [индексатор Поиска Azure](search-indexer-overview.md) или API Push (также называемый [REST API Поиска Azure](https://docs.microsoft.com/rest/api/searchservice/)).  

### <a name="use-indexers-for-updating-content-on-multiple-services"></a>Использование индексаторов для обновления содержимого в нескольких службах

Если вы уже используете индексатор в одной службе, можно настроить второй индексатор во второй службе для использования одного и того же объекта источника данных, получая данные из одного и того же расположения. Каждая служба в каждом регионе имеет собственный индексатор и целевой индекс (индекс поиска не является общим, а это означает, что данные дублируются), но каждый индексатор ссылается на один и тот же источник данных.

Ниже приведен высокоуровневый визуальный элемент того, как будет выглядеть архитектура.

   ![Один источник данных с сочетаниями распределенного индексатора и службы][2]

### <a name="use-rest-apis-for-pushing-content-updates-on-multiple-services"></a>Использование интерфейсов API RESTFUL для отправки обновлений содержимого в несколько служб
При использовании REST API поиска Azure для [отправки содержимого в индекс службы поиска Azure](https://docs.microsoft.com/rest/api/searchservice/update-index)можно синхронизировать различные службы поиска, отправляя изменения во все службы поиска каждый раз, когда требуется обновление. Убедитесь, что в коде выполняются ситуации, когда обновление одной службы поиска завершается сбоем, но для других служб поиска выполняется успешно.

## <a name="leverage-azure-traffic-manager"></a>Использование диспетчера трафика Azure
[Диспетчер трафика Azure](../traffic-manager/traffic-manager-overview.md) позволяет перенаправлять запросы на несколько расположенных в разных географических регионах веб-сайтов, которые поддерживаются несколькими службами Поиска Azure. Одним из преимуществ диспетчера трафика является то, что он может проверять доступность Поиска Azure и направлять пользователей к альтернативным службам поиска в случае сбоя. Кроме того, если маршрутизация запросов на поиск осуществляется через веб-сайты Azure, то диспетчер трафика Azure позволяет балансировать нагрузку в случаях, когда веб-сайт работает, а Поиск Azure — нет. Ниже приведен пример архитектуры, использующей диспетчер трафика.

   ![Перекрестные запросы к службам по региону с использованием диспетчера трафика][3]

## <a name="next-steps"></a>Дальнейшие действия
Чтобы больше узнать о ценовых категориях и лимитах служб, ознакомьтесь с разделом [Ограничения поиска Azure](search-limits-quotas-capacity.md).

Статья [Планирование ресурсов](search-capacity-planning.md) поможет больше узнать о различных сочетаниях секций и реплик.

Чтобы более детально ознакомиться с производительностью и увидеть, как можно реализовать оптимизации, описанные в этой статье, посмотрите следующее видео.

> [!VIDEO https://channel9.msdn.com/Events/Microsoft-Azure/AzureCon-2015/ACON319/player]
> 
> 

<!--Image references-->
[1]: ./media/search-performance-optimization/geo-redundancy.png
[2]: ./media/search-performance-optimization/scale-indexers.png
[3]: ./media/search-performance-optimization/geo-search-traffic-mgr.png
