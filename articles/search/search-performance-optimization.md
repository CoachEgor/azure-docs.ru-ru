---
title: Масштабирование для производительности
titleSuffix: Azure Cognitive Search
description: Изучите методы и рекомендации по настройке производительности Azure Cognitive Search и настройке оптимального масштаба.
manager: nitinme
author: LiamCavanagh
ms.author: liamca
ms.devlang: rest-api
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: 7c2857de0613be400f83544e1dabe079b7497bbd
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "77212391"
---
# <a name="scale-for-performance-on-azure-cognitive-search"></a>Масштабирование производительности в когнитивном поиске Azure

В этой статье описаны рекомендации по перспективным сценариям со сложными требованиями к масштабируемости и доступности.

## <a name="start-with-baseline-numbers"></a>Начните с базовых чисел

Прежде чем приложить больше усилий по развертыванию, убедитесь, что вы знаете, как выглядит типичная нагрузка запроса. Следующие рекомендации могут помочь вам прийти к базовым номерам запросов.

1. Выберите целевую задержку (или максимальное количество времени), которая типична для выполнения запроса на поиск.

1. Создайте и протестируйте реальную рабочую нагрузку в отношении службы поиска с помощью реалистичного набора данных для измерения этих показателей задержки.

1. Начните с небольшого количества запросов в секунду( а затем постепенно увеличивайте число, выполняемое в тесте, пока задержка запроса не упадет ниже заданной цели. Это важный тест производительности, который поможет спланировать масштабирование приложения по мере того, как оно будет охватывать все больше пользователей.

1. По возможности повторно используйте подключения HTTP. Если вы используете Azure Cognitive Search .NET SDK, это означает, что вы должны повторно использовать экземпляр или экземпляр [SearchIndexClient,](https://docs.microsoft.com/dotnet/api/microsoft.azure.search.searchindexclient) а если вы используете REST API, вы должны повторно использовать один httpClient.

1. Измените суть запросов, чтобы поиск происходил по разным частям индекса. Вариация важна, потому что если вы постоянно выполняете одни и те же поисковые запросы, кэширование данных начнет выглядеть лучше, чем при более разрозненных наборах запросов.

1. Изнаните структуру запросов, чтобы получить различные типы запросов. Не каждый поисковый запрос выполняется на одном уровне. Например, предложение поиска документов или поиска обычно происходит быстрее, чем запрос со значительным количеством граней и фильтров. Состав теста должен включать различные запросы, примерно в том же соотношении, что и в производстве.  

При создании этих тестовых рабочих нагрузок существует несколько характеристик Azure Cognitive Search, которые необходимо иметь в виду:

+ Возможно перегрузить службу, одновременно нажимая слишком много поисковых запросов. В этом случае вы увидите коды ответов HTTP 503. Чтобы избежать 503 во время тестирования, начните с различных диапазонов поисковых запросов, чтобы увидеть различия в темпах задержки при добавлении дополнительных поисковых запросов.

+ Azure Cognitive Search не выполняет задачи индексирования в фоновом режиме. Если служба одновременно обрабатывает рабочие нагрузки запросов и индексирования, примите это во внимание, введя задания индексирования в тесты запросов, либо изучая варианты выполнения заданий по индексации в часы пик.

> [!Tip]
> Можно смоделировать реалистичную нагрузку запроса с помощью инструментов тестирования нагрузки. Попробуйте [тестирование нагрузки с Azure DevOps](https://docs.microsoft.com/azure/devops/test/load-test/get-started-simple-cloud-load-test?view=azure-devops) или используйте одну из этих [альтернатив.](https://docs.microsoft.com/azure/devops/test/load-test/overview?view=azure-devops#alternatives)

## <a name="scale-for-high-query-volume"></a>Масштаб для высокого объема запросов

Служба перегружена, когда запросы занимают слишком много времени или когда служба начинает отбрасывать запросы. Если это произойдет, вы можете решить проблему одним из двух способов:

+ **Добавление реплик**  

  Каждая реплика является копией ваших данных, что позволяет службе загружать запросы баланса на несколько копий.  Вся балансировка нагрузки и репликация данных управляется Azure Cognitive Search, и вы можете изменить количество реплик, выделенных для службы в любое время. Можно выделить до 12 реплик для службы поиска уровня "Стандартный" и до 3 реплик для службы поиска уровня "Базовый". Реплики можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

+ **Создание новой службы на более высоком уровне**  

  Azure Cognitive Search поставляется в [нескольких уровнях,](https://azure.microsoft.com/pricing/details/search/) и каждый из них предлагает различные уровни производительности. В некоторых случаях у вас может быть так много запросов, что уровень, на который вы находитесь, не может обеспечить достаточный оборот, даже если реплики исчерпаны. В этом случае рассмотрите возможность перехода на более высокий уровень, такой как уровень Standard S3, предназначенный для сценариев с большим количеством документов и чрезвычайно высокими рабочими нагрузками запроса.

## <a name="scale-for-slow-individual-queries"></a>Масштаб для медленных индивидуальных запросов

Еще одной причиной высокой частоты задержки является один запрос занимает слишком много времени для завершения. В этом случае добавление реплик не поможет. Два возможных варианта, которые могут помочь, включают в себя следующие:

+ **Увеличение разделов**

  Раздел распределяет данные по дополнительным вычислительным ресурсам. Два раздела делят данные пополам, третий раздел разделяет их на третьи и так далее. Одним из положительных побочных эффектов является то, что более медленные запросы иногда выполняются быстрее из-за параллельных вычислений. Мы отметили параллелизацию по запросам низкой избирательности, таким как запросы, которые соответствуют многим документам, или аспекты, обеспечивающие подсчет по большому количеству документов. Поскольку для оценки релевантности документов или подсчета количества документов требуются значительные вычисления, добавление дополнительных разделов помогает быстрее выполнять запросы.  
   
  В сервисе поиска Standard может быть не более 12 разделов и 1 раздел в службе поиска Basic. Секции можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

+ **Ограничьте поля высокой кардиналити**

  Поле высокой кардинальности состоит из лицом или фильтруемое поле, которое имеет значительное количество уникальных значений и, как следствие, потребляет значительные ресурсы при вычислениях результатов. Например, установка поля идентификатора или описания продукта в качестве facetable/filterable будет считаться высокой кардинальностью, поскольку большинство значений от документа к документу уникальны. По возможности ограничивайте число полей с высокой кратностью.

+ **Увеличьте уровень поиска**  

  Переход на более высокий уровень когнитивного поиска Azure может быть еще одним способом повышения производительности медленных запросов. Каждый более высокий уровень обеспечивает более быстрые процессоры и больше памяти, оба из которых оказывают положительное влияние на производительность запроса.

## <a name="scale-for-availability"></a>Масштаб доступности

Реплики не только помогают уменьшить задержку запроса, но и обеспечивают высокую доступность. При использовании одной реплики следует ожидать периодических простоев из-за перезагрузки сервера после обновления программного обеспечения или других операций технического обслуживания. Поэтому важно определить, требуется ли приложению высокий уровень доступности операций поиска (запросов) и записи (событий индексирования). Azure Cognitive Search предлагает варианты SLA на всех платных поисковых предложениях со следующими атрибутами:

+ Две реплики для обеспечения высокой доступности рабочих нагрузок для чтения (запросов).

+ Три или более реплик для высокой доступности рабочих нагрузок считывания (запросы и индексация)

Для получения более подробной информации об этом, пожалуйста, посетите [соглашение об уровне когнитивного поиска Azure](https://azure.microsoft.com/support/legal/sla/search/v1_0/).

Поскольку реплики являются копиями данных, наличие нескольких реплик позволяет Azure Cognitive Search выполнять перезагрузки и техническое обслуживание машины против одной реплики, в то время как выполнение запроса продолжается на других репликах. И наоборот, если убрать реплики, вы будете понести снижение производительности запроса, предполагая, что эти реплики были недостаточно используемым ресурсом.

## <a name="scale-for-geo-distributed-workloads-and-geo-redundancy"></a>Масштаб для геораспределенных рабочих нагрузок и геоизбыточности

Для геораспределенных рабочих нагрузок пользователи, расположенные далеко от центра обработки данных, будут иметь более высокие показатели задержки. Одним из мер по смягчению последствий является предоставление нескольких поисковых услуг в регионах, непосредственно приближенных к этим пользователям.

Azure Cognitive Search в настоящее время не предоставляет автоматизированный метод георепликации индексов когнитивного поиска Azure в разных регионах, но есть некоторые методы, которые могут быть использованы, которые могут сделать этот процесс простым в реализации и управлении. Они описаны в нескольких следующих разделах.

Цель геораспределенного набора поисковых служб состоит в том, чтобы иметь два или более индексов, доступных в двух или более регионах, где пользователь направляется в службу когнитивного поиска Azure, которая обеспечивает самую низкую задержку, как видно в этом примере:

   ![Перекрестные запросы к службам по региону][1]

### <a name="keep-data-synchronized-across-multiple-services"></a>Сохраняйте синхронизацию данных в нескольких службах

Существует два варианта синхронизации распределенных поисковых служб, которые включают использование [индекса когнитивного поиска Azure](search-indexer-overview.md) или Push API (также именуемого [API Azure Cognitive Search REST).](https://docs.microsoft.com/rest/api/searchservice/)  

### <a name="use-indexers-for-updating-content-on-multiple-services"></a>Использование индексов для обновления содержимого в нескольких службах

Если вы уже используете индексер в одной службе, можно настроить второй индексатор на второй службе, чтобы использовать тот же объект источника данных, вытаскивая данные из того же места. Каждая служба в каждом регионе имеет свой собственный индексер и целевой индекс (ваш индекс поиска не является общим, что означает дублирование данных), но каждый индексер ссылается на один и тот же источник данных.

Вот на высоком уровне визуальный о том, что эта архитектура будет выглядеть.

   ![Один источник данных с сочетаниями распределенного индексатора и службы][2]

### <a name="use-rest-apis-for-pushing-content-updates-on-multiple-services"></a>Используйте REST AIS для нажатия обновлений контента на нескольких службах

Если вы используете API Azure Cognitive Search REST для [нажатия содержимого в индексе когнитивного поиска Azure,](https://docs.microsoft.com/rest/api/searchservice/update-index)вы можете синхронизировать различные поисковые службы, нажимая изменения во все поисковые службы всякий раз, когда требуется обновление. В коде убедитесь, что для обработки случаев, когда обновление одной поисковой службы не удается, но успешно для других поисковых служб.

## <a name="leverage-azure-traffic-manager"></a>Менеджер движения Azure

[Менеджер движения Azure](../traffic-manager/traffic-manager-overview.md) позволяет направлять запросы на несколько гео-расположенных веб-сайтов, которые затем поддерживаются несколькими поисковыми службами. Одним из преимуществ диспетчера трафика является то, что он может исследовать Azure Cognitive Search, чтобы убедиться, что он доступен и маршрут пользователей альтернативных поисковых служб в случае простоя. Кроме того, если вы переопределяете поисковые запросы через веб-сайты Azure, Azure Traffic Manager позволяет загружать балансовые случаи, когда веб-сайт работает, но не Azure Cognitive Search. Ниже приведен пример архитектуры, использующей диспетчер трафика.

   ![Перекрестные запросы к службам по региону с использованием диспетчера трафика][3]

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать больше о тарифных уровнях и [Service limits](search-limits-quotas-capacity.md)ограничениях услуг для каждого из них, см. [См. План возможностей](search-capacity-planning.md) для получения дополнительной информации о комбинациях разделов и реплик.

Для обсуждения производительности и демонстрации методов, обсуждаемых в этой статье, смотрите следующее видео:

> [!VIDEO https://channel9.msdn.com/Events/Microsoft-Azure/AzureCon-2015/ACON319/player]
> 

<!--Image references-->
[1]: ./media/search-performance-optimization/geo-redundancy.png
[2]: ./media/search-performance-optimization/scale-indexers.png
[3]: ./media/search-performance-optimization/geo-search-traffic-mgr.png
