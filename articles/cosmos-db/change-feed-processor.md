---
title: Работа с библиотекой обработчика для канала изменений в Azure Cosmos DB
description: Использование библиотеки обработчика для канала изменений Azure Cosmos DB.
author: rimman
ms.service: cosmos-db
ms.devlang: dotnet
ms.topic: conceptual
ms.date: 05/21/2019
ms.author: rimman
ms.reviewer: sngun
ms.openlocfilehash: 9cf9e1aabc0898ef025c7c2f517e631a812e67d7
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65969023"
---
# <a name="change-feed-processor-in-azure-cosmos-db"></a>Обработчик канала изменений в Azure Cosmos DB 

[Библиотека обработчика для канала изменений Azure Cosmos DB](sql-api-sdk-dotnet-changefeed.md) позволяет распределить обработку событий между несколькими объектами-получателями. Эта библиотека упрощает считывание изменений в секциях и нескольких потоках, работающих параллельно.

Основным преимуществом библиотеки обработчика для канала изменений является то, что вам не нужно управлять каждой секцией и маркером продолжения. Вам также не нужно опрашивать каждый контейнер вручную.

Эта библиотека упрощает считывание изменений в секциях и нескольких потоках в параллельном режиме. Она автоматически управляет считыванием изменений между секциями с помощью механизма аренды. Как видно на следующей схеме, если запустить два клиента, которые используют библиотеку обработчика для канала изменений, работа будет разделена между ними. По мере увеличения числа клиентов они будут точно так же разделять работу между собой.

![Использование библиотеки обработчика для канала изменений Azure Cosmos DB](./media/change-feed-processor/change-feed-output.png)

Сперва был запущен левый клиент, и он начал отслеживать все секции. Затем был запущен второй клиент, и первый передал ему некоторые аренды. Это эффективный способ распределения работы между разными компьютерами и клиентами.

При наличии двух бессерверных функций Azure, которые отслеживают один и тот же контейнер и используют одинаковую аренду, эти функции могут получить разные документы в зависимости от того, как библиотека обработчика решит обработать секции.

## <a name="implementing-the-change-feed-processor-library"></a>Реализация библиотеки обработчика для канала изменений

В реализации библиотеки обработчика канала изменений существует четыре основных компонента: 

1. **Отслеживаемый контейнер**. Контейнер с данными, из которых формируется канал изменений. Все операции вставки и изменения в отслеживаемом контейнере отражаются в канале изменений контейнера.

1. **Контейнер аренд**. Контейнер, который координирует обработку канала изменений для нескольких рабочих ролей. Отдельный контейнер используется для хранения аренд на каждую секцию. Этот контейнер аренд следует хранить в другой учетной записи, чтобы связанный с ней регион записи был ближе к расположению, в котором выполняется обработчик канала изменений. Объект аренды содержит следующие атрибуты:

   * Владелец. Определяет узел, которому принадлежит аренда.

   * Продолжение. Определяет положение (маркер продолжения) определенной секции в канале изменений.

   * Метка времени. Время последнего обновления аренды. Может использоваться для проверки истечения срока действия аренды.

1. **Узел обработчика событий**. Каждый узел определяет, сколько секций нужно обработать в зависимости от того, сколько других экземпляров узлов имеют активные аренды.

   * После запуска узла он получает аренды для распределения рабочей нагрузки по всем узлам. Узел периодически обновляет аренды, чтобы они оставалась активными.

   * Узел сопоставляет последний маркер продолжения с арендой перед каждой операцией чтения. Чтобы обеспечить безопасность параллелизма, узел проверяет значение ETag для каждого обновления аренды. Также поддерживаются другие стратегии контрольных точек.

   * После завершения работы узел отменяет все аренды, но сохраняет сведения о продолжении, чтобы иметь позже возможность возобновить чтение с сохраненной контрольной точки.

   В настоящее время количество узлов не может превышать количество секций (аренд).

1. **Потребители**. Объекты-получатели или рабочие роли являются потоками, которые выполняют обработку веб-канала изменений, инициированную каждым узлом. Каждый узел обработчика может иметь несколько объектов-получателей. Каждый объект-получатель считывает веб-канал изменений из секции, которой он присвоен, и уведомляет узел об изменениях и окончании срока действия аренд.

Чтобы лучше разобраться, как взаимодействуют эти четыре элемента обработчика для канала изменений, давайте рассмотрим пример, приведенный на схеме ниже. Отслеживаемая коллекция хранит документы и использует City в качестве ключа секции. Мы видим, что синяя секция содержит документы с полем City от A до E и т. д. Существует два узла, каждый с двумя объектами-получателями, которые выполняют операцию чтения из четырех секций в параллельном режиме. Стрелки показывают конкретные точки в веб-канале изменений, в которых объекты-получатели выполняют операцию чтения. В первой секции синим цветом представлены непрочитанные изменения, а голубым — уже прочитанные изменения в канале изменений. Узлы используют коллекцию аренд для хранения значения "продолжение", чтобы отслеживать текущую позицию чтения каждого объекта-получателя.

![Пример обработчика канала изменений](./media/change-feed-processor/changefeedprocessor.png)

### <a name="change-feed-and-provisioned-throughput"></a>Канал изменений и подготовленная пропускная способность

Вы оплачиваете единицы запросов, так как при перемещении данных в контейнеры Cosmos и из них всегда используются единицы запросов. Плата выставляется за число потребляемых ЕЗ контейнером аренды.

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Библиотека обработчика канал изменений Azure Cosmos DB](sql-api-sdk-dotnet-changefeed.md)
* [Пакет NuGet](https://www.nuget.org/packages/Microsoft.Azure.DocumentDB.ChangeFeedProcessor/)
* [Дополнительные примеры на GitHub](https://github.com/Azure/azure-documentdb-dotnet/tree/master/samples/ChangeFeedProcessor)

## <a name="next-steps"></a>Дальнейшие действия

Вы можете продолжить знакомство с каналом изменений, перейдя к следующим статьям:

* [Работа с поддержкой веб-канала изменений в Azure Cosmos DB](change-feed.md)
* [Чтение канала изменений Azure Cosmos DB](read-change-feed.md)
* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)
