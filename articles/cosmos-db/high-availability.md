---
title: Высокий уровень доступности в Azure Cosmos DB
description: В этой статье описывается, как Azure Cosmos DB обеспечивает высокий уровень доступности
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 09/30/2020
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: 3b9d1c8c6271d689b022a069de8e3392c0662dd6
ms.sourcegitcommit: d2222681e14700bdd65baef97de223fa91c22c55
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/07/2020
ms.locfileid: "91826884"
---
# <a name="how-does-azure-cosmos-db-provide-high-availability"></a>Как Azure Cosmos DB обеспечивает высокий уровень доступности? 

Azure Cosmos DB прозрачно реплицирует данные во всех регионах Azure, связанных с вашей учетной записью Azure Cosmos. Azure Cosmos DB использует несколько уровней избыточности для данных, как показано на следующем рисунке:

:::image type="content" source="./media/high-availability/cosmosdb-data-redundancy.png" alt-text="Физическое секционирование" border="false":::

- Данные в контейнерах Azure Cosmos [горизонтально секционированы](partitioning-overview.md).

- Набор секций — это коллекция из нескольких наборов реплик. Каждая секция в каждом регионе защищена с помощью набора реплик. При этом все записи реплицируются и надежно фиксируются большей частью реплик. Реплики распределены между 10–20 доменами сбоя.

- Все секции реплицируются во всех регионах. Каждый регион содержит все секции данных контейнера Azure Cosmos и может принимать записи и обслуживать операции чтения.  

Если ваша учетная запись Azure Cosmos распределена между *n* регионами Azure, будет существовать по крайней мере *n* копий всех данных. Как правило, учетная запись Azure Cosmos в более чем 2 регионах повышает доступность приложения и обеспечивает низкую задержку в связанных регионах. 

## <a name="slas-for-availability"></a>Соглашения об уровне обслуживания для доступности

В качестве глобально распределенной базы данных Azure Cosmos DB предоставляет комплексные соглашения об уровне обслуживания, которые охватывают пропускную способность, задержку на 99-м процентиль, согласованность и высокий уровень доступности. В таблице ниже приведены гарантии высокого уровня доступности, предоставляемые Azure Cosmos DB для учетных записей одного и нескольких регионов. Для обеспечения высокой доступности всегда настраивайте учетные записи Azure Cosmos для работы с несколькими регионами записи.

|Operation type (Тип операции)  | Один регион |Несколько регионов (один регион записи)|Несколько регионов (несколько регионов записи) |
|---------|---------|---------|-------|
|Запись    | 99,99    |99,99   |99,999|
|Операции чтения     | 99,99    |99,999  |99,999|

> [!NOTE]
> На практике фактическая доступность для записи ограниченного устаревания, сеанса, согласованного префикса и модели согласованности в конечном итоге значительно выше, чем опубликованные соглашения об уровне обслуживания. Фактическая доступность чтения для всех уровней согласованности значительно выше, чем в опубликованных Соглашениях об уровне обслуживания.

## <a name="high-availability-with-azure-cosmos-db-in-the-event-of-regional-outages"></a>Высокий уровень доступности с Azure Cosmos DB в случае региональных простоев

В редких случаях нестандартного сбоя Azure Cosmos DB гарантирует высокую доступность базы данных. В зависимости от конфигурации учетной записи Azure Cosmos в процессе сбоя захватывается следующее поведение Azure Cosmos DB.

- Если Azure Cosmos DB, то перед тем как операция записи будет подтверждена клиенту, данные надежно фиксируются кворумом реплик в пределах региона, принимающего операции записи.

- Учетные записи, связанные с несколькими регионами, настроенные на использование нескольких регионов записи, будут сохранять высокую доступность как для операций записи, так и для операций чтения. Региональные отработки отказа происходят мгновенно и не требуют изменений приложения.

- Учетные записи с одним регионом могут потерять доступность после регионального сбоя. Всегда рекомендуется настроить по крайней **мере два региона** (желательно, по крайней мере, два региона записи) с учетной записью Azure Cosmos, чтобы обеспечить высокий уровень доступности в любое время.

### <a name="multi-region-accounts-with-a-single-write-region-write-region-outage"></a>Учетные записи в нескольких регионах с одним регионом для записи (сбой области записи)

- Во время сбоя в регионе записи учетная запись Azure Cosmos автоматически сделает дополнительный регион новым основным регионом записи при **включении автоматической отработки отказа** в учетной записи Azure Cosmos. Если этот параметр включен, отработка отказа выполняется в другом регионе в порядке указанного приоритета региона.
- Когда ранее затронутый регион возвращается в режим «в сети», любые данные записи, которые не были реплицированы при сбое региона, становятся доступными через [канал конфликтов](how-to-manage-conflicts.md#read-from-conflict-feed). Приложения могут читать канал конфликтов, разрешать конфликты на основе логики конкретного приложения и записывать обновленные данные обратно в контейнер Azure Cosmos, если это необходимо.
- После восстановления ранее затронутый регион записи становится автоматически доступным как регион чтения. Вы можете вернуться к восстановленному региону в качестве региона записи. Регионы можно переключать с помощью [PowerShell, Azure CLI или портал Azure](how-to-manage-database-account.md#manual-failover). **Нет данных или потерь доступности** до, во время или после переключения региона записи, и ваше приложение по-своему постоянно доступно.

> [!IMPORTANT]
> Настоятельно рекомендуется настроить учетные записи Cosmos для Azure, используемые для рабочих нагрузок, чтобы **включить автоматический переход на другой ресурс**. Для отработки отказа вручную требуется подключение между дополнительным и основным регионами записи, чтобы выполнить проверку согласованности, чтобы гарантировать отсутствие потерь данных во время отработки отказа. Если основной регион недоступен, эта проверка согласованности не может быть завершена и переход на другой ресурс вручную не будет выполнен, что приведет к утрате доступности записи.

### <a name="multi-region-accounts-with-a-single-write-region-read-region-outage"></a>Учетные записи в нескольких регионах с одним регионом для записи (сбой области чтения)

- Во время сбоя в регионе чтения учетные записи Azure Cosmos, использующие любой уровень согласованности или строгую согласованность с тремя или более регионами чтения, будут оставаться в высокой доступности для операций чтения и записи.
- Учетные записи Cosmos Azure, использующие строгую согласованность с двумя или меньшими регионами чтения (включая область чтения & записи), потеряют доступность записи во время сбоя в области чтения.
- Затронутый регион автоматически отключается и будет помечен в автономном режиме. [Azure Cosmos DB пакеты SDK](sql-api-sdk-dotnet.md) будут перенаправлять вызовы чтения в следующий доступный регион в списке предпочтительных регионов.
- Если ни один из регионов в списке предпочтительных регионов не доступен, вызовы автоматически будут перенаправлены к текущему региону записи.
- Для обработки сбоя региона чтения изменения в коде приложения не требуются. Когда затронутый регион чтения возвращается в оперативный режим, он автоматически синхронизируется с текущим регионом записи и снова станет доступен для обслуживания запросов на чтение.
- Последующие операции чтения перенаправляются в восстановленный регион без каких-либо изменений в коде приложения. Во время отработки отказа и повторного присоединение к ранее неисправному региону проверки согласованности чтения продолжают обрабатываться Azure Cosmos DB.
- Даже в редких и тех случаях, когда регион Azure постоянно Неустранимая, нет потерь данных, если ваша учетная запись Azure Cosmos в нескольких регионах настроена со *строгой* согласованностью. В случае постоянного Неустранимая региона записи в многорегионовую учетную запись Azure Cosmos, настроенную с согласованностью по ограниченному возрасту, окно потенциальной потери данных ограничено окном устаревания (*k* или *t*), где K = 100000 обновлений и t = 5 минут. Для уровней согласованности в сеансах с согласованным префиксом и в конечном итоге размер окна потенциальной потери данных ограничен 15 минутами. Дополнительные сведения о целевых объектах RTO и RPO для Azure Cosmos DB см. в статье [уровни согласованности и устойчивость данных](consistency-levels-tradeoffs.md#rto) .

## <a name="availability-zone-support"></a>Поддержка зоны доступности

Помимо устойчивости между регионами теперь можно включить **избыточность зоны** при выборе региона, связанного с базой данных Azure Cosmos.

Благодаря поддержке зоны доступности Azure Cosmos DB гарантирует, что реплики будут помещены в несколько зон в пределах заданного региона, чтобы обеспечить высокий уровень доступности и устойчивость во время сбоев зональные. В этой конфигурации нет изменений в задержках и других соглашениях об уровне обслуживания. В случае сбоя одной зоны избыточность зоны обеспечивает полную устойчивость данных с RPO = 0 и доступ с RTO = 0.

Избыточность зоны — это *Дополнительная возможность* для [репликации в функции записи в несколько регионов](how-to-multi-master.md) . Для обеспечения устойчивости в региональной зоне нельзя использовать только избыточность зоны. Например, в случае региональных простоев или доступа с низкой задержкой в регионах рекомендуется использовать несколько регионов записи в дополнение к избыточности в пределах зоны.

При настройке операций записи в несколько регионов для учетной записи Azure Cosmos вы можете использовать избыточность зоны без дополнительных затрат. В противном случае ознакомьтесь с заметкой о ценах на поддержку избыточности зоны. Вы можете включить избыточность зоны в существующем регионе учетной записи Azure Cosmos, удалив регион и добавив ее обратно с включенной избыточностью зоны.

Эта функция доступна в: *Южная часть Соединенного Королевства, Юго-Восточная Азия, Восточная часть США 2, Центральная часть США, Западная Европа, Западная часть США 2, Восточная Япония, Северная Европа, Центральная Франция, Восточная Австралия, Восточная часть США 2 (euap)* regions.

В следующей таблице перечислены возможности высокой доступности различных конфигураций учетных записей.

|Ключевой показатель эффективности  |Один регион без Зоны доступности (не AZ)  |Один регион с Зоны доступности (AZ)  |Запись в несколько регионов с Зоны доступности (AZ, 2 региона) — рекомендуемый параметр |
|---------|---------|---------|---------|
|Соглашение об уровне обслуживания для доступности записи | 99,99 % | 99,99 % | 99,999 % |
|Соглашение об уровне обслуживания для чтения  | 99,99 % | 99,99 % | 99,999 % |
|Цена | Ставка выставления счетов по одному региону | Ставка выставления счетов для зоны доступности в одном регионе | Ставка выставления счетов в нескольких регионах |
|Ошибки зоны — потери данных | Потеря данных | Без потери данных | Без потери данных |
|Сбои зоны — доступность | Потери доступности | Без потерь доступности | Без потерь доступности |
|Задержка чтения | Перекрестная область | Перекрестная область | Низкий |
|Задержка записи | Перекрестная область | Перекрестная область | Низкий |
|Региональный сбой — потери данных | Потеря данных |  Потеря данных | Потеря данных <br/><br/> При использовании согласованности ограниченного устаревания с несколькими регионами записи и более чем одним регионом потери данных ограничены ограниченной устаревшей настройкой в вашей учетной записи. <br /><br />Можно избежать потери данных во время регионального сбоя, настроив строгую согласованность в нескольких регионах. Этот вариант поставляется с компромиссами, влияющими на доступность и производительность. Его можно настроить только для учетных записей, настроенных для операций записи в один регион. |
|Региональный сбой — доступность | Потери доступности | Потери доступности | Без потерь доступности |
|Пропускная способность | Подготовленная пропускная способность X единиц запросов/с | Подготовленная пропускная способность X единиц запросов/с * 1,25 | скорость подготовленной пропускной способности 2 единиц запросов в секунду <br/><br/> Этот режим конфигурации требует вдвое больше пропускной способности по сравнению с одним регионом с Зоны доступности, так как существует два региона. |

> [!NOTE]
> Чтобы включить поддержку зон доступности для учетной записи Azure Cosmos с несколькими регионами, в учетной записи должна быть включена запись в нескольких регионах.

При добавлении региона в новые или существующие учетные записи Cosmos Azure можно включить избыточность зоны. Чтобы включить избыточность зоны в учетной записи Azure Cosmos, установите `isZoneRedundant` флаг в `true` для определенного расположения. Этот флаг можно установить в свойстве Locations. Например, следующий фрагмент кода PowerShell включает избыточность зоны для региона "Юго-Восточная Азия":

```powershell
$locations = @(
    @{ "locationName"="Southeast Asia"; "failoverPriority"=0; "isZoneRedundant"= "true" },
    @{ "locationName"="East US"; "failoverPriority"=1; "isZoneRedundant"= "true" }
)
```

Следующая команда показывает, как включить избыточность зоны для регионов "EastUS" и "WestUS2":

```azurecli-interactive
az cosmosdb create \
  --name mycosmosdbaccount \
  --resource-group myResourceGroup \
  --kind GlobalDocumentDB \
  --default-consistency-level Session \
  --locations regionName=EastUS failoverPriority=0 isZoneRedundant=True \
  --locations regionName=WestUS2 failoverPriority=1 isZoneRedundant=True
```

Вы можете включить Зоны доступности с помощью портал Azure при создании учетной записи Azure Cosmos. При создании учетной записи обязательно включите **геоизбыточность**, **запись в несколько регионов**и выберите регион, в котором поддерживаются зоны доступности:

:::image type="content" source="./media/high-availability/enable-availability-zones-using-portal.png" alt-text="Физическое секционирование"::: 

## <a name="building-highly-available-applications"></a>Создание высокодоступных приложений

- Изучите ожидаемое [поведение пакетов SDK Azure Cosmos](troubleshoot-sdk-availability.md) во время этих событий и какие конфигурации влияют на нее.

- Чтобы обеспечить высокую доступность для записи и чтения, настройте учетную запись Azure Cosmos, чтобы она занимала как минимум два региона с несколькими регионами записи. Эта конфигурация обеспечит наивысшую доступность, наименьшую задержку и лучшую масштабируемость для операций чтения и записи по соглашениям об уровне обслуживания. Дополнительные сведения см. в статье [Настройка учетной записи Azure Cosmos с несколькими регионами записи](tutorial-global-distribution-sql-api.md).

- Для учетных записей Azure Cosmos с несколькими регионами, настроенных с помощью региона с одной записью, [включите автоматическую отработку отказа с помощью Azure CLI или портал Azure](how-to-manage-database-account.md#automatic-failover). При включенной автоматической отработке отказа в случае регионального сбоя Cosmos DB будет автоматически выполнять отработку отказа вашей учетной записи.  

- Даже если ваша учетная запись Azure Cosmos имеет высокую доступность, приложение может быть неправильно спроектировано для поддержания высокой доступности. Чтобы протестировать сквозную высокую доступность приложения, в ходе тестирования приложения или аварийного восстановления (DR) временно отключите автоматическую отработку отказа для учетной записи, запустите [отработку отказа вручную с помощью PowerShell, Azure CLI или портал Azure](how-to-manage-database-account.md#manual-failover), а затем Отслеживайте отработку отказа приложения. После завершения можно выполнить отработку отказа в основной регион и восстановить автоматическую отработку отказа для учетной записи.

- В глобально распределенной среде базы данных существует прямая связь между уровнем согласованности и устойчивостью данных в случае сбоя уровня региона. При разработке плана обеспечения непрерывности бизнес-процессов нужно понимать, какое максимальное время до полного восстановления приложения после аварийного события допустимо. Время, необходимое приложению для полного восстановления, называется целевым временем восстановления (RTO). Необходимо также понимать, потерю какого максимального периода последних обновлений данных приложение может допустить при восстановлении после аварийного события. Этот период обновлений является целевой точкой восстановления (RPO). Значения RPO и RTO для Azure Cosmos DB см. в разделе [Уровни согласованности и устойчивость данных](consistency-levels-tradeoffs.md#rto).

## <a name="next-steps"></a>Дальнейшие действия

См. подробнее:

- [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
- [Глобальное масштабирование подготовленной пропускной способности](scaling-throughput.md)
- [Глобальное распределение (взгляд изнутри)](global-dist-under-the-hood.md)
- [Уровни согласованности для Azure Cosmos DB](consistency-levels.md)
- [Настройка учетной записи Cosmos с несколькими регионами записи](how-to-multi-master.md)
- [Поведение пакета SDK в многорегионовых средах](troubleshoot-sdk-availability.md)
