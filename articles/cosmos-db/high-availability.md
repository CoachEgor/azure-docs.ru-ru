---
title: Высокий уровень доступности в Azure Cosmos DB
description: В этой статье описывается, как Azure Cosmos DB обеспечивает высокий уровень доступности путем прозрачной репликации данных во всех регионах, связанных с учетной записью Azure Cosmos.
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 12/02/2019
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: 1dab10592c8a34bc9df4425785e6dae95e44f219
ms.sourcegitcommit: 9405aad7e39efbd8fef6d0a3c8988c6bf8de94eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/05/2019
ms.locfileid: "74872100"
---
# <a name="high-availability-with-azure-cosmos-db"></a>Высокий уровень доступности при использовании Azure Cosmos DB

Azure Cosmos DB прозрачно реплицирует данные во всех регионах Azure, связанных с вашей учетной записью Cosmos. Cosmos DB реализует несколько уровней избыточности для данных, как показано на рисунке ниже.

![Физическое секционирование](./media/high-availability/cosmosdb-data-redundancy.png)

- Данные в контейнерах Cosmos [горизонтально секционированы](partitioning-overview.md).

- Каждая секция в каждом регионе защищена с помощью набора реплик. При этом все записи реплицируются и надежно фиксируются большей частью реплик. Реплики распределены между 10–20 доменами сбоя.

- Все секции реплицируются во всех регионах. Каждый регион содержит все секции данных контейнера Cosmos и может принимать записи и обслуживать операции чтения.  

Если ваша учетная запись Cosmos распределена по *n* регионам Azure, будет содержаться по крайней мере *n* копий всех данных. Помимо предоставления доступа к данным с низкой задержкой и масштабирование пропускной способности записи и чтения в регионах, связанных с вашей учетной записью Cosmos, наличие дополнительных регионов (более высокий уровень *N*) улучшает доступность.  

## <a name="slas-for-availability"></a>Соглашения об уровне обслуживания для доступности

Как глобально распределенная база данных Cosmos DB предоставляет исчерпывающие Соглашения об уровне обслуживания, включающие пропускную способность, задержки на уровне 99-го процентиля, согласованность и высокую доступность. В приведенной ниже таблице указаны гарантии высокой доступности, предоставляемые Cosmos DB для учетных записей в одном и нескольких регионах. Для обеспечения высокой доступности всегда настраивайте учетные записи Cosmos для работы с несколькими регионами записи.

|Operation type (Тип операции)  | Один регион |Несколько регионов (один регион записи)|Несколько регионов (несколько регионов записи) |
|---------|---------|---------|-------|
|Операции записи    | 99,99    |99,99   |99,999|
|Операции чтения     | 99,99    |99,999  |99,999|

> [!NOTE]
> На практике фактическая доступность для записи ограниченного устаревания, сеанса, согласованного префикса и модели согласованности в конечном итоге значительно выше, чем опубликованные соглашения об уровне обслуживания. Фактическая доступность чтения для всех уровней согласованности значительно выше, чем в опубликованных Соглашениях об уровне обслуживания.

## <a name="high-availability-with-cosmos-db-in-the-event-of-regional-outages"></a>Высокий уровень доступности с Cosmos DB в случае региональных простоев

Региональные сбои случаются нечасто, и Azure Cosmos DB гарантирует, что ваша база данных всегда высокодоступна. В зависимости от конфигурации учетной записи Cosmos во время сбоя заCosmos DB хватывается следующая информация:

- Когда используется Cosmos DB, до того как операция записи подтверждается для клиента, данные продолжительно фиксируются кворумом реплик в том регионе, в котором происходит запись.

- Учетные записи, связанные с несколькими регионами, настроенные на использование нескольких регионов записи, будут сохранять высокую доступность как для операций записи, так и для операций чтения. Региональные отработки отказа происходят мгновенно и не требуют изменений приложения.

- **Учетные записи в нескольких регионах с одним регионом для записи (сбой области записи):** 
  * будут сохранять высокий уровень доступности для операций чтения при сбое региона записи. Чтобы запросы на запись были выполнены, необходимо включить параметр **включить автоматический переход на другой ресурс** в учетной записи Azure Cosmos. При включении этого параметра затронутый регион будет отработкой отказа в другой регион в указанном порядке. 
  * Когда ранее затронутый регион возвращается в режим «в сети», любые данные записи, которые были нереплицированы при сбое региона, становятся доступными через [канал конфликтов](how-to-manage-conflicts.md#read-from-conflict-feed). Приложения могут читать канал конфликтов, разрешать конфликты на основе логики конкретного приложения и записывать обновленные данные обратно в контейнер Azure Cosmos, если это необходимо. 
  * После восстановления ранее затронутый регион записи становится автоматически доступным как регион чтения. Вы можете вернуться к восстановленному региону в качестве региона записи. Регионы можно переключать с помощью [Azure CLI или портал Azure](how-to-manage-database-account.md#manual-failover). **Нет данных или потерь доступности** до, во время или после переключения региона записи, и ваше приложение по-своему постоянно доступно. 

- **Учетные записи в нескольких регионах с одним регионом для записи (сбой в регионе чтения):** 
  * будут сохранять высокую доступность для операций чтения и записи при сбое региона чтения. 
  * Затронутый регион автоматически отсоединяется от региона записи и помечается как отключенный. [Azure Cosmos DB пакеты SDK](sql-api-sdk-dotnet.md) будут перенаправлять вызовы чтения в следующий доступный регион в списке предпочтительных регионов. 
  * Если ни один из регионов в списке предпочтительных регионов недоступен, вызовы автоматически будут перенаправлены к текущему региону записи. 
  * Для обработки сбоя региона чтения изменения в коде приложения не требуются. В конечном счете, когда работа затронутого региона восстанавливается, ранее затронутый регион чтения автоматически синхронизируется с текущим регионом записи и снова становится доступным для обслуживания операций чтения. 
  * Последующие операции чтения перенаправляются в восстановленный регион без каких-либо изменений в коде приложения. Во время отработки отказа и повторного присоединение к ранее неисправному региону проверки согласованности чтения продолжают обрабатываться Cosmos DB.

- Учетные записи с одним регионом могут потерять доступность после регионального сбоя. Всегда рекомендуется настроить по крайней **мере два региона** (желательно, по крайней мере, два региона записи) с учетной записью Cosmos, чтобы обеспечить высокий уровень доступности в любое время.

- Даже в редких и ненеустранимаяных событиях, когда регион Azure постоянно является безвозвратным, нет потерь данных, если учетная запись Cosmos в нескольких регионах настроена с уровнем согласованности по умолчанию *strong*. В случае постоянного Неустранимая региона записи для учетных записей Cosmos в нескольких регионах, для которых настроена согласованность с ограничением устаревания, окно потенциальной потери данных ограничено окном устаревания (*K* или *T*). для уровней согласованности сеансов и в конечном итоге размер окна потенциальной потери данных ограничен пятью секундами. 

## <a name="availability-zone-support"></a>Поддержка зоны доступности

Azure Cosmos DB — это глобально распределенная служба базы данных с несколькими хозяевами, которая обеспечивает высокий уровень доступности и устойчивость во время региональных сбоев. Помимо устойчивости между регионами теперь можно включить **избыточность зоны** при выборе региона, связанного с базой данных Azure Cosmos. 

Благодаря поддержке зоны доступности Azure Cosmos DB гарантирует, что реплики будут помещены в несколько зон в пределах заданного региона, чтобы обеспечить высокий уровень доступности и устойчивость во время сбоев зональные. В этой конфигурации нет изменений в задержках и других соглашениях об уровне обслуживания. В случае сбоя одной зоны избыточность зоны обеспечивает полную устойчивость данных с RPO = 0 и доступ с RTO = 0. 

Избыточность зоны — это *Дополнительная* функция [репликации с несколькими хозяевами](how-to-multi-master.md) . Избыточность в пределах зоны сама по себе не обеспечивает региональную устойчивость. Например, в случае региональных простоев или доступа с низкой задержкой в регионах рекомендуется использовать несколько регионов записи в дополнение к избыточности в пределах зоны. 

При настройке операций записи в несколько регионов для учетной записи Azure Cosmos вы можете использовать избыточность зоны без дополнительных затрат. В противном случае ознакомьтесь с заметкой о ценах на поддержку избыточности зоны. Вы можете включить избыточность в пределах зоны для существующего региона в учетной записи Azure Cosmos, удалив регион и добавив его с включенной избыточностью в пределах зоны.

Эта функция доступна в следующих регионах Azure:

* Южная часть Соединенного Королевства
* Юго-Восточная Азия 
* Восточная часть США
* Восточная часть США 2 
* Центральная часть США
* Западная Европа
* Западная часть США 2

> [!NOTE] 
> Включение Зоны доступности для учетной записи Azure Cosmos в одном регионе приведет к оплате, что эквивалентно добавлению дополнительного региона в учетную запись. Дополнительные сведения о ценах см. на [странице цен](https://azure.microsoft.com/pricing/details/cosmos-db/) и о [затратах на несколько регионов в Azure Cosmos DBных](optimize-cost-regions.md) статьях. 

В следующей таблице перечислены возможности высокой доступности различных конфигураций учетных записей. 

|Ключевой показатель эффективности  |Один регион без Зоны доступности (не AZ)  |Один регион с Зоны доступности (AZ)  |Запись в несколько регионов с Зоны доступности (AZ, 2 региона) — рекомендуемый параметр |
|---------|---------|---------|---------|
|Соглашение об уровне обслуживания для доступности записи     |   99,99 %      |    99,99 %     |  99,999 %  |
|Соглашение об уровне обслуживания для чтения   |   99,99 %      |   99,99 %      |  99,999 %       |
|Цена  |  Ставка выставления счетов по одному региону |  Ставка выставления счетов для зоны доступности в одном регионе |  Ставка выставления счетов в нескольких регионах       |
|Ошибки зоны — потери данных   |  Потери данных  |   Без потери данных |   Без потери данных  |
|Сбои зоны — доступность |  Потери доступности  | Без потерь доступности  |  Без потерь доступности  |
|Задержка чтения    |  Перекрестная область    |   Перекрестная область   |    Низкая  |
|Задержка записи    |   Перекрестная область   |  Перекрестная область    |   Низкая   |
|Региональный сбой — потери данных    |   Потери данных      |  Потери данных       |   Потери данных <br/><br/> При использовании согласованности с ограниченным сроком устаревания с несколькими главными и несколькими регионами потери данных ограничены ограниченной устаревшей настройкой в вашей учетной записи. <br/><br/> Потерю данных во время регионального сбоя можно избежать, настроив строгую согласованность в нескольких регионах. Этот вариант сопровождается компромиссами, влияющими на доступность и производительность.      |
|Региональный сбой — доступность  |  Потери доступности       |  Потери доступности       |  Без потерь доступности  |
|Пропускная способность    |  Подготовленная пропускная способность X единиц запросов/с      |  Подготовленная пропускная способность X единиц запросов/с       |  скорость подготовленной пропускной способности 2 единиц запросов в секунду <br/><br/> Этот режим конфигурации требует вдвое больше пропускной способности по сравнению с одним регионом с Зоны доступности, так как существует два региона.   |

> [!NOTE] 
> Чтобы включить поддержку зон доступности для учетной записи Azure Cosmos с несколькими регионами, в учетной записи должна быть включена поддержка записей с несколькими хозяевами.


При добавлении региона в новые или существующие учетные записи Cosmos Azure можно включить избыточность зоны. Чтобы включить избыточность зоны в учетной записи Azure Cosmos, установите флаг `isZoneRedundant` для `true` в определенном расположении. Этот флаг можно установить в свойстве Locations. Например, следующий фрагмент кода PowerShell включает избыточность зоны для региона "Юго-Восточная Азия":

```powershell
$locations = @( 
    @{ "locationName"="Southeast Asia"; "failoverPriority"=0; "isZoneRedundant"= "true" }, 
    @{ "locationName"="East US"; "failoverPriority"=1 } 
) 
```

Следующая команда показывает, как включить избыточность зоны для регионов "EastUS" и "WestUS2":

```azurecli-interactive
az cosmosdb create \
  --name mycosmosdbaccount \
  --resource-group myResourceGroup \
  --kind GlobalDocumentDB \
  --default-consistency-level Session \
  --locations regionName=EastUS failoverPriority=0 isZoneRedundant=True \
  --locations regionName=WestUS2 failoverPriority=1 isZoneRedundant=True \
  --enable-multiple-write-locations
```

Вы можете включить Зоны доступности с помощью портал Azure при создании учетной записи Azure Cosmos. При создании учетной записи обязательно включите **геоизбыточность**, **запись в несколько регионов**и выберите регион, в котором поддерживаются зоны доступности: 

![Включение Зоны доступности с помощью портал Azure](./media/high-availability/enable-availability-zones-using-portal.png) 

## <a name="building-highly-available-applications"></a>Создание высокодоступных приложений

- Чтобы обеспечить высокий уровень доступности операций записи и чтения, настройте учетную запись Cosmos на поддержку по крайней мере двух регионов с несколькими регионами записи. Эта конфигурация обеспечит наивысшую доступность, наименьшую задержку и лучшую масштабируемость для операций чтения и записи по соглашениям об уровне обслуживания. Дополнительные сведения см. в статье [Настройка глобального распределения Azure Cosmos DB с помощью API SQL](tutorial-global-distribution-sql-api.md).

- Для учетных записей Cosmos с несколькими регионами, для которых настроен один регион записи, см. раздел [Включение автоматического перехода на другой ресурс вручную для учетной записи Cosmos](how-to-manage-database-account.md#automatic-failover). При включенной автоматической отработке отказа в случае регионального сбоя Cosmos DB будет автоматически выполнять отработку отказа вашей учетной записи.  

- Даже если учетная запись Cosmos обеспечивает высокую доступность, из-за структуры приложение может не обеспечивать высокий уровень доступности. Чтобы протестировать сквозную высокую доступность приложения, периодически вызывайте [отработку отказа вручную, используя Azure CLI или портал Azure](how-to-manage-database-account.md#manual-failover), в рамках тестирования приложений или аварийного восстановления (Dr).

- В глобально распределенной среде базы данных существует прямая связь между уровнем согласованности и устойчивостью данных в случае сбоя уровня региона. При разработке плана обеспечения непрерывности бизнес-процессов нужно понимать, какое максимальное время до полного восстановления приложения после аварийного события допустимо. Время, необходимое приложению для полного восстановления, называется целевым временем восстановления (RTO). Необходимо также понимать, потерю какого максимального периода последних обновлений данных приложение может допустить при восстановлении после аварийного события. Этот период обновлений является целевой точкой восстановления (RPO). Значения RPO и RTO для Azure Cosmos DB см. в разделе [Уровни согласованности и устойчивость данных](consistency-levels-tradeoffs.md#rto).

## <a name="next-steps"></a>Дальнейшие действия

См. подробнее:

* [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
* [Масштабирование пропускной способности в Azure Cosmos DB](scaling-throughput.md)
* [Azure Cosmos DB global distribution - under the hood](global-dist-under-the-hood.md) (Глобальное распределение Azure Cosmos DB(взгляд изнутри))
* [Настраиваемые уровни согласованности данных в Azure Cosmos DB](consistency-levels.md)
* [Настройка учетной записи Cosmos с несколькими регионами записи](how-to-multi-master.md)
