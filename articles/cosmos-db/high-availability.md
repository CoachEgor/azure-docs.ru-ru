---
title: Высокий уровень доступности в Azure Cosmos DB
description: В этой статье описывается, как Azure Cosmos DB обеспечивает высокий уровень доступности
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 12/06/2019
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: 0f024bac535ed792d8480c991e470cf5d85932b8
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79247427"
---
# <a name="high-availability-with-azure-cosmos-db"></a>Высокий уровень доступности при использовании Azure Cosmos DB

Azure Cosmos DB прозрачно реплицирует данные во всех регионах Azure, связанных с вашей учетной записью Cosmos. Cosmos DB реализует несколько уровней избыточности для данных, как показано на рисунке ниже.

![Физическое секционирование](./media/high-availability/cosmosdb-data-redundancy.png)

- Данные в контейнерах Cosmos [горизонтально разделены.](partitioning-overview.md)

- Каждая секция в каждом регионе защищена с помощью набора реплик. При этом все записи реплицируются и надежно фиксируются большей частью реплик. Реплики распределены между 10–20 доменами сбоя.

- Все секции реплицируются во всех регионах. Каждый регион содержит все секции данных контейнера Cosmos и может принимать записи и обслуживать операции чтения.  

Если ваша учетная запись Cosmos распределена по регионам *N* Azure, будет не менее *N* x 4 копий всех ваших данных. В дополнение к обеспечению низкой задержки доступа к данным и масштабированию записи/чтения пропускной записи в регионах, связанных с вашей учетной записью Космос, наличие большего числа регионов (выше *N*) еще больше повышает доступность.  

## <a name="slas-for-availability"></a>Соглашения об уровне обслуживания для доступности

Как глобально распределенная база данных Cosmos DB предоставляет исчерпывающие Соглашения об уровне обслуживания, включающие пропускную способность, задержки на уровне 99-го процентиля, согласованность и высокую доступность. В приведенной ниже таблице указаны гарантии высокой доступности, предоставляемые Cosmos DB для учетных записей в одном и нескольких регионах. Для высокой доступности всегда настраивайте учетные записи Cosmos, чтобы иметь несколько регионов записи.

|Operation type (Тип операции)  | Один регион |Несколько регионов (один регион записи)|Несколько регионов (несколько регионов записи) |
|---------|---------|---------|-------|
|Запись    | 99,99    |99,99   |99,999|
|Операции чтения     | 99,99    |99,999  |99,999|

> [!NOTE]
> На практике фактическая доступность записи для ограниченной черствости, сессии, последовательной префикса и возможной согласованности моделей значительно выше, чем опубликованные SLAs. Фактическая доступность чтения для всех уровней согласованности значительно выше, чем в опубликованных Соглашениях об уровне обслуживания.

## <a name="high-availability-with-cosmos-db-in-the-event-of-regional-outages"></a>Высокий уровень доступности при использовании Cosmos DB в случае региональных сбоев

Региональные сбои случаются нечасто, и Azure Cosmos DB гарантирует, что ваша база данных всегда высокодоступна. Следующие детали отражают поведение Cosmos DB во время сбоа, в зависимости от конфигурации учетной записи Cosmos:

- Когда используется Cosmos DB, до того как операция записи подтверждается для клиента, данные продолжительно фиксируются кворумом реплик в том регионе, в котором происходит запись.

- Учетные записи, связанные с несколькими регионами, настроенные на использование нескольких регионов записи, будут сохранять высокую доступность как для операций записи, так и для операций чтения. Региональные отработки отказа происходят мгновенно и не требуют изменений приложения.

- Учетные записи с одним регионом могут потерять доступность после регионального сбоя. Всегда рекомендуется настроить по **крайней мере два региона** (желательно, по крайней мере, два региона записи) с вашей учетной записью Cosmos, чтобы обеспечить высокую доступность в любое время.

- **Многорегиональные учетные записи с одноязычным регионом (сбой в регионе записи):**
  - Во время сбоя в области записи учетная запись Cosmos автоматически будет способствовать тому, что второстепенный регион будет новым основным регионом записи, когда в учетной записи Azure Cosmos **настроенавтоматический сбой.** При включении сбой произойдет в другом регионе в указанном вами порядке региона.
  - Клиенты могут также использовать **ручной отказ** и контролировать их Космос написать конечную точку URL сами с помощью агента построен сами. Для клиентов со сложными и сложными потребностями мониторинга здоровья это может привести к снижению RTO в случае сбоя в регионе записи.
  - Когда ранее затронутый регион возвращается в онлайн, любые данные записи, которые были нереплицированы, когда регион не удалось, становится доступным через [конфликты корма](how-to-manage-conflicts.md#read-from-conflict-feed). Приложения могут читать ленту конфликтов, разрешать конфликты на основе конкретной логики приложения и записывать обновленные данные в контейнер Azure Cosmos по мере необходимости.
  - После восстановления ранее затронутый регион записи становится автоматически доступным как регион чтения. Вы можете вернуться в восстановленный регион в качестве региона записи. Переключать регионы можно с помощью [портала Azure CLI или Azure.](how-to-manage-database-account.md#manual-failover) Нет **потери данных или доступности** до, во время или после переключения региона записи, и ваше приложение продолжает быть очень доступным.

- **Многорегиональные учетные записи с однозначным регионом (читай- отключение региона):**
  - будут сохранять высокую доступность для операций чтения и записи при сбое региона чтения.
  - Затронутый регион автоматически отключается и будет помечен в автономном режиме. [SDK Azure Cosmos DB](sql-api-sdk-dotnet.md) перенаправят прочитанные звонки в следующий доступный регион в списке предпочтительных регионов.
  - Если ни один из регионов в списке предпочтительных регионов недоступен, вызовы автоматически будут перенаправлены к текущему региону записи.
  - Для обработки сбоя региона чтения изменения в коде приложения не требуются. В конечном счете, когда работа затронутого региона восстанавливается, ранее затронутый регион чтения автоматически синхронизируется с текущим регионом записи и снова становится доступным для обслуживания операций чтения.
  - Последующие операции чтения перенаправляются в восстановленный регион без каких-либо изменений в коде приложения. Во время как неудачи, так и воссоединения с ранее несостоявшимся регионом, гарантии согласованности прочитают, что космос DB продолжает соблюдать гарантии согласованности.

- Даже в редких и прискорбных случаях, когда область Azure постоянно невосполнима, потеря данных не происходит, если ваша многорайонная учетная запись Cosmos настроена с *сильной* согласованностью. В случае постоянно невосполнимой области записи, многорегионенный счет Космоса, настроенный с согласованной последовательностью потери данных, потенциальное окно потери данных ограничено окном устаревания *(K* или *T),* где обновления K'100,000 и T-5 минут. Для уровней последовательной префикса и возможной согласованности потенциального окна потери данных ограничено максимум 15 минутами. Для получения дополнительной информации о целевых показателях RTO [Consistency levels and data durability](consistency-levels-tradeoffs.md#rto) и RPO для Azure Cosmos DB см.

## <a name="availability-zone-support"></a>Поддержка зоны доступности

Помимо устойчивости перекрестного региона, теперь можно включить **избыточность зонпри** выборе региона для ассоциирования с базой данных Azure Cosmos.

При поддержке зоны доступности Azure Cosmos DB обеспечит размещение реплик в нескольких зонах в пределах данного региона, чтобы обеспечить высокую доступность и устойчивость во время зональных сбоев. В этой конфигурации нет никаких изменений в задержке и других SLA. В случае сбоя одной зоны избыточность зоны обеспечивает полную долговечность данных с RPO-0 и доступность с RTO-0.

Резервирование зоны является *дополнительной возможностью* для функции [репликации multi-master.](how-to-multi-master.md) Одной лишь избыточностью зон не может быть использована для достижения региональной устойчивости. Например, в случае региональных отключений или низкой задержки доступа в регионах рекомендуется иметь несколько регионов записи в дополнение к избыточности зон.

При настройке многорайонных записей для учетной записи Azure Cosmos вы можете выбрать резервирование зоны без дополнительной платы. В противном случае, пожалуйста, см ниже, что касается цен на поддержку резервирования зон. Вы можете включить избыточность зоны в существующем регионе учетной записи Azure Cosmos, удалив область и добавив его обратно с включенной зоной избыточности.

Эта функция доступна в следующих регионах Azure:

- южная часть Соединенного Королевства

- Юго-Восточная Азия

- Восточная часть США

- восточная часть США 2

- Центральная часть США

- Западная Европа

- западная часть США 2

> [!NOTE]
> Включение зон доступности для учетной записи Azure Cosmos в одном регионе приведет к расходам, которые эквивалентны добавлению дополнительного региона в вашу учетную запись. Подробнее о ценах можно узнать на [странице ценообразования](https://azure.microsoft.com/pricing/details/cosmos-db/) и мультирегионах в статьях [Azure Cosmos DB.](optimize-cost-regions.md)

В следующей таблице кратко излагается высокая доступность различных конфигураций учетных записей:

|Ключевой показатель эффективности  |Единый регион без зон доступности (не-АЗ)  |Единый регион с зонами доступности (АЗ)  |Мультирегион пишет с зонами доступности (АЗ, 2 региона) - Наиболее рекомендуемые настройки |
|---------|---------|---------|---------|
|Написать наличие SLA | 99,99 % | 99,99 % | 99,999 % |
|Читать доступность SLA  | 99,99 % | 99,99 % | 99,999 % |
|Price | Ставка биллинга в едином регионе | Ставка биллинга зоны единого региона | Многорегионная ставка биллинга |
|Сбои зоны - потеря данных | Потеря данных | Без потери данных | Без потери данных |
|Сбои зоны - доступность | Потеря доступности | Отсутствие потери доступности | Отсутствие потери доступности |
|Чтение задержки | Крест области | Крест области | Низкий |
|Запись задержки | Крест области | Крест области | Низкий |
|Региональный сбой - потеря данных | Потеря данных |  Потеря данных | Потеря данных <br/><br/> При использовании ограниченной консистенции застоя с несколькими мастерами и более чем в одном регионе потеря данных ограничивается ограниченной застойностью, настроенной на ваш счет <br /><br />Можно избежать потери данных во время регионального сбой, настроив сильную согласованность с несколькими регионами. Эта опция поставляется с компромиссами, которые влияют на доступность и производительность. Он может быть настроен только на учетные записи, настроенные для записей с одним регионом. |
|Региональный сбой - доступность | Потеря доступности | Потеря доступности | Отсутствие потери доступности |
|Пропускная способность | X RU/s просряженая пропускная вычисляемая пропускная вычисляемая пропускная | X RU/s просряженая пропускная вычисляемая пропускная вычисляемая пропускная | 2X RU/s просрлизм <br/><br/> Этот режим конфигурации требует в два раза больше пропускной связи по сравнению с одним регионом с зонами доступности, поскольку существует два региона. |

> [!NOTE]
> Для обеспечения поддержки зоны доступности для многорегиона учетной записи Azure Cosmos учетная запись должна иметь включенную многомастерскую запись.

Можно включить избыточность зонпри с добавлением региона в новые или существующие учетные записи Azure Cosmos. Чтобы включить избыточность зоны в учетной записи `isZoneRedundant` Azure `true` Cosmos, следует установить флаг для определенного местоположения. Вы можете установить этот флаг в свойстве расположения. Например, следующий фрагмент силовой оболочки позволяет резервить зоны для региона «юго-восточной Азии»:

```powershell
$locations = @(
    @{ "locationName"="Southeast Asia"; "failoverPriority"=0; "isZoneRedundant"= "true" },
    @{ "locationName"="East US"; "failoverPriority"=1 }
)
```

Следующая команда показывает, как включить избыточность зон для регионов "Восток" и "Запад2":

```azurecli-interactive
az cosmosdb create \
  --name mycosmosdbaccount \
  --resource-group myResourceGroup \
  --kind GlobalDocumentDB \
  --default-consistency-level Session \
  --locations regionName=EastUS failoverPriority=0 isZoneRedundant=True \
  --locations regionName=WestUS2 failoverPriority=1 isZoneRedundant=True
```

Зоны доступности можно включить с помощью портала Azure при создании учетной записи Azure Cosmos. При создании учетной записи убедитесь, что **включить гео-избыточность,** **Многорегиональные записи**и выбрать регион, где зоны доступности поддерживаются:

![Включить зоны доступности с помощью портала Azure](./media/high-availability/enable-availability-zones-using-portal.png) 

## <a name="building-highly-available-applications"></a>Создание высокодоступных приложений

- Чтобы обеспечить высокий уровень доступности операций записи и чтения, настройте учетную запись Cosmos на поддержку по крайней мере двух регионов с несколькими регионами записи. Эта конфигурация обеспечит максимальную доступность, низкую задержку и лучшую масштабируемость как для чтения, так и для записи при поддержке SL. Дополнительные сведения см. в статье [Настройка глобального распределения Azure Cosmos DB с помощью API SQL](tutorial-global-distribution-sql-api.md).

- Для учетных записей Cosmos с несколькими регионами, для которых настроен один регион записи, см. раздел [Включение автоматического перехода на другой ресурс вручную для учетной записи Cosmos](how-to-manage-database-account.md#automatic-failover). При включенной автоматической отработке отказа в случае регионального сбоя Cosmos DB будет автоматически выполнять отработку отказа вашей учетной записи.  

- Даже если учетная запись Cosmos обеспечивает высокую доступность, из-за структуры приложение может не обеспечивать высокий уровень доступности. Чтобы проверить сквозную высокую доступность приложения, как часть тестирования приложения или аварийно-восстановительных установок (DR), временно отключить автоматическое сбой для учетной записи, вызвать [руководство failover с помощью портала Azure CLI или Azure](how-to-manage-database-account.md#manual-failover), а затем контролировать сбой приложения. После завершения, вы можете выйти из строя обратно в основной области и восстановить автоматическое сбой для учетной записи.

- В глобально распределенной среде баз данных существует прямая связь между уровнем согласованности и долговечностью данных при наличии общерегионального простоя. При разработке плана обеспечения непрерывности бизнес-процессов нужно понимать, какое максимальное время до полного восстановления приложения после аварийного события допустимо. Время, необходимое приложению для полного восстановления, называется целевым временем восстановления (RTO). Необходимо также понимать, потерю какого максимального периода последних обновлений данных приложение может допустить при восстановлении после аварийного события. Этот период обновлений является целевой точкой восстановления (RPO). Значения RPO и RTO для Azure Cosmos DB см. в разделе [Уровни согласованности и устойчивость данных](consistency-levels-tradeoffs.md#rto).

## <a name="next-steps"></a>Дальнейшие действия

См. подробнее:

- [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
- [Глобальное масштабирование подготовленной пропускной способности](scaling-throughput.md)
- [Глобальное распределение (взгляд изнутри)](global-dist-under-the-hood.md)
- [Уровни согласованности в Azure Cosmos DB](consistency-levels.md)
- [Как настроить учетную запись Cosmos с несколькими регионами записи](how-to-multi-master.md)
