---
title: Как провести аудит операций самолета управления Самолетом Azure Cosmos DB
description: Узнайте, как провести аудит операций плоскости управления, такие как добавление региона, обновление пропускной перевалки, сбой в регионе, добавление VNet и т.д. в Azure Cosmos DB
author: SnehaGunda
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 03/16/2020
ms.author: sngun
ms.openlocfilehash: 64ad8e6b1101d8486268c857b3a7752e1801f52c
ms.sourcegitcommit: 7581df526837b1484de136cf6ae1560c21bf7e73
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2020
ms.locfileid: "80420296"
---
# <a name="how-to-audit-azure-cosmos-db-control-plane-operations"></a>Как провести аудит операций самолета управления Самолетом Azure Cosmos DB

Операции диспетчерской системы включают изменения в учетную запись Azure Cosmos или контейнер. Например, создать учетную запись Azure Cosmos, добавить область, обновить пропускную запись, переработать область, добавить VNet и т.д. некоторые из операций плоскости управления. В этой статье объясняется, как провести аудит операций самолета управления в Azure Cosmos DB.

## <a name="disable-key-based-metadata-write-access"></a>Отключить доступ метаданных на основе ключа
 
Перед аудитом операций диспетчерской в Azure Cosmos DB отключите метаданные на основе ключей, напишите доступ в свой аккаунт. Когда доступ к записи на основе ключевых метаданных отключен, клиенты, подключенные к учетной записи Azure Cosmos через ключи учетной записи, не получают доступа к учетной записи. Вы можете отключить доступ к `disableKeyBasedMetadataWriteAccess` записи, установив свойство на истину. После установки этого свойства изменения в любом ресурсе могут произойти от пользователя с надлежащей ролью управления доступом (RBAC) и только учетными данными. Чтобы узнать больше о том, как настроить это свойство, [см.](role-based-access-control.md#preventing-changes-from-cosmos-sdk)

 Рассмотрим следующие моменты при отключении доступа к записи метаданных:

* Оцените и убедитесь, что ваши приложения не делают метаданные вызовы, которые меняют вышеуказанные ресурсы (например, создать сбор, обновить пропускную запись, ...) с помощью SDK или ключей учетной записи.

* В настоящее время портал Azure использует ключи учетной записи для операций метаданных, и поэтому эти операции будут заблокированы. Кроме того, для выполнения таких операций используйте развертывания шаблонов Azure CLI, SDKs или resource Manager.

## <a name="enable-diagnostic-logs-for-control-plane-operations"></a>Включить диагностические журналы для управления операциями плоскости

Можно включить диагностические журналы для управления операциями плоскости с помощью портала Azure. Используйте следующие шаги, чтобы включить вход в систему управления операциями самолета:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к учетной записи Azure Cosmos.

1. Откройте панель **параметров диагностики,** предоставьте **название** для создания журналов.

1. Выберите **ControlPlaneRequests** для типа журнала и выберите опцию **Send to Log Analytics.**

Вы также можете хранить журналы в учетной записи хранилища или передавать их в концентратор событий. В этой статье показано, как отправлять журналы в журналы аналитики, а затем задать их запрос. После включения диагностических журналов требуется несколько минут. Все операции диспетчерской, выполняемые после этой точки, можно отследить. На следующем скриншоте показано, как включить журналы управления плоскостями:

![Включить запросы плоскости управления журналом](./media/audit-control-plane-logs/enable-control-plane-requests-logs.png)

## <a name="view-the-control-plane-operations"></a>Просмотр операций диспетчерской плоскости

После включанив журнал, используйте следующие шаги для отслеживания операций для определенной учетной записи:

1. Войти на [портал Azure](https://portal.azure.com).
1. Откройте вкладку **Monitor** из левой навигации, а затем выберите панель **журналов.** Он открывает uii, где можно легко запускать запросы с этой конкретной учетной записью в области. Выполнить следующий запрос для просмотра журналов управления плоскостью:

   ```kusto
   AzureDiagnostics
   | where ResourceProvider=="MICROSOFT.DOCUMENTDB" and Category=="ControlPlaneRequests"
   | where TimeGenerated >= ago(1h)
   ```

Следующие скриншоты фиксируют журналы при добавлении VNET в учетную запись Azure Cosmos:

![Управление журналами плоскости при добавлении VNet](./media/audit-control-plane-logs/add-ip-filter-logs.png)

Следующие скриншоты захватывают журналы при обновлении пропускной промедляя таблицы Cassandra:

![Управление журналами плоскости при обновлении пропускной всей вха.](./media/audit-control-plane-logs/throughput-update-logs.png)

## <a name="identify-the-identity-associated-to-a-specific-operation"></a>Определение идентификации, связанной с конкретной операцией

Если вы хотите отладить дальше, вы можете определить конкретную операцию в **журнале activity** с помощью идентификатора активности или по метке времени операции. Timestamp используется для некоторых клиентов Resource Manager, где идентификатор активности явно не пройден. В журнале Activity приводится подробная информация об идентификации, с которой была начата операция. На следующем скриншоте показано, как использовать идентификатор активности и найти операции, связанные с ним, в журнале activity:

![Идентификатор активности и найдите операции](./media/audit-control-plane-logs/find-operations-with-activity-id.png)

## <a name="next-steps"></a>Следующие шаги

* [Исследуйте монитор Azure для Azure Cosmos DB](../azure-monitor/insights/cosmosdb-insights-overview.md?toc=/azure/cosmos-db/toc.json&bc=/azure/cosmos-db/breadcrumb/toc.json)
* [Monitor and debug with metrics in Azure Cosmos DB](use-metrics.md) (Мониторинг и отладка с помощью метрик в Azure Cosmos DB)