---
title: Диагностика и устранение неполадок с доступностью пакетов SDK для Cosmos Azure в многорегионовых средах
description: Узнайте все о принципах доступности пакета SDK для Azure Cosmos при работе в разных регионах.
author: ealsur
ms.service: cosmos-db
ms.date: 09/16/2020
ms.author: maquaran
ms.subservice: cosmosdb-sql
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 0c717aca88095df05fc7927f3c3d6e2d481925d2
ms.sourcegitcommit: 7374b41bb1469f2e3ef119ffaf735f03f5fad484
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/16/2020
ms.locfileid: "90709113"
---
# <a name="diagnose-and-troubleshoot-the-availability-of-azure-cosmos-sdks-in-multiregional-environments"></a>Диагностика и устранение неполадок с доступностью пакетов SDK для Cosmos Azure в многорегионовых средах

В этой статье описывается поведение последней версии пакетов SDK для Azure Cosmos при возникновении проблем с подключением к определенному региону или при отработке отказа региона.

Все пакеты SDK для Azure Cosmos позволяют настроить региональные предпочтения. В разных пакетах SDK используются следующие свойства:

* Свойство [ConnectionPolicy. PreferredLocations](/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations) в пакете SDK для .NET v2.
* Свойства [космосклиентоптионс. аппликатионрегион](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion) или [космосклиентоптионс. аппликатионпреферредрегионс](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationpreferredregions) в пакете SDK для .NET v3.
* Метод [космосклиентбуилдер. преферредрегионс](/java/api/com.azure.cosmos.cosmosclientbuilder.preferredregions) в пакете SDK для Java v4.
* Параметр [космосклиент. preferred_locations](/python/api/azure-cosmos/azure.cosmos.cosmos_client.cosmosclient) в пакете SDK для Python.

Для учетных записей с одним регионом записи все операции записи всегда будут переключаться в регион записи, поэтому список предпочтительных регионов применим только к операциям чтения. Для нескольких учетных записей регионов записи список предпочтений влияет на операции чтения и записи.

Если не задать предпочитаемый регион, то порядок региональных предпочтений определяется по [порядку списка регионов Azure Cosmos DB](distribute-data-globally.md).

При выполнении любого из следующих сценариев клиент, использующий пакет SDK Azure Cosmos, предоставляет журналы и включает сведения о повторных попытках в составе **диагностической информации об операции**.

## <a name="removing-a-region-from-the-account"></a><a id="remove region"></a>Удаление региона из учетной записи

При удалении региона из учетной записи Azure Cosmos любой клиент SDK, который активно использует эту учетную запись, определит удаление региона с помощью кода ответа сервера. Затем клиент помечает региональную конечную точку как недоступную. Клиент повторяет текущую операцию, и все будущие операции окончательно направляются в следующий регион в порядке предпочтения.

## <a name="adding-a-region-to-an-account"></a>Добавление региона в учетную запись

Каждые 5 минут клиент Azure Cosmos SDK считывает конфигурацию учетной записи и обновляет регионы, о которых она знает.

Если вы удалите регион, а затем добавите его обратно в учетную запись, если добавленная область имеет более высокий приоритет, пакет SDK снова переключится на использование этого региона. После обнаружения добавленной области в нее направляются все будущие запросы.

Если настроить клиент так, чтобы он лучше подключаться к региону, который не имеет учетной записи Azure Cosmos, предпочтительный регион игнорируется. Если вы добавите этот регион позже, клиент обнаружит ее и вернется к этому региону без возможности восстановления.

## <a name="failover-the-write-region-in-a-single-write-region-account"></a><a id="manual-failover-single-region"></a>Отработка отказа региона записи в учетной записи с одним регионом записи

При запуске отработки отказа текущего региона записи следующий запрос на запись завершится ошибкой с известным ответом внутреннего сервера. При обнаружении этого ответа клиент запросит учетную запись, чтобы узнать новый регион записи, и продолжит выполнять текущую операцию и будет окончательно маршрутизировать все будущие операции записи в новый регион.

## <a name="regional-outage"></a>Региональный сбой

Если учетная запись является отдельным регионом записи и в ходе операции записи возникает региональный сбой, поведение аналогично [отработке отказа вручную](#manual-failover-single-region). Для запросов чтения или учетных записей с несколькими регионами записи поведение аналогично [удалению области](#remove region).

## <a name="session-consistency-guarantees"></a>Гарантии согласованности сеансов

При использовании [согласованности сеанса](consistency-levels.md#guarantees-associated-with-consistency-levels)клиент должен гарантировать, что он сможет считывать собственные записи. В учетных записях с одним регионом записи, где предпочтение в области чтения отличается от региона записи, возможны случаи, когда пользователь создает запись и при выполнении чтения из локального региона в локальной области еще не получена репликация данных (скорость необлегченного ограничения). В таких случаях пакет SDK обнаруживает конкретный сбой операции чтения и повторяет попытку чтения в центральном регионе для обеспечения согласованности сеанса.

## <a name="transient-connectivity-issues-on-tcp-protocol"></a>Проблемы с временным подключением по протоколу TCP

В сценариях, где клиент SDK Azure Cosmos настроен для использования протокола TCP, в данном запросе могут возникнуть ситуации, когда условия сети временно влияют на связь с определенной конечной точкой. Эти временные условия сети могут выслужить в качестве времени ожидания TCP. Клиент будет повторять запрос локально в той же конечной точке в течение нескольких секунд.

Если пользователь настроил предпочтительный список регионов с более чем одним регионом, а учетная запись Azure Cosmos — несколько регионов записи или отдельный регион записи, а операция является запросом на чтение, клиент повторит эту операцию в следующем регионе из списка предпочтений.

## <a name="next-steps"></a>Дальнейшие действия

* Использование последнего [пакета SDK для .NET](sql-api-sdk-dotnet-standard.md)
* Использование последнего [пакета SDK для Java](sql-api-sdk-java-v4.md)
* Использование последнего [пакета SDK для Python](sql-api-sdk-python.md)
* Использовать последний [пакет SDK для Node](sql-api-sdk-node.md)
