---
title: Политики индексирования в Azure Cosmos DB
description: Узнайте, как настроить и изменить политику индексирования по умолчанию для автоматического индексирования и повышения производительности в Azure Cosmos DB.
author: ThomasWeiss
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 07/23/2019
ms.author: thweiss
ms.openlocfilehash: 01e3e1f1c9bffee0604de1260e8e466f5b1d229d
ms.sourcegitcommit: c72ddb56b5657b2adeb3c4608c3d4c56e3421f2c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/24/2019
ms.locfileid: "68467879"
---
# <a name="indexing-policies-in-azure-cosmos-db"></a>Политики индексирования в Azure Cosmos DB

В Azure Cosmos DB каждый контейнер имеет политику индексирования, определяющую, как должны индексироваться элементы контейнера. Политика индексирования по умолчанию для вновь создаваемых контейнеров индексирует все свойства каждого элемента, принудительно заменяя индексы диапазона для любой строки или числа, а также пространственные индексы для любого объекта геообъектного формата JSON типа Point. Это позволяет получить высокую производительность запросов без необходимости думать об индексировании и управлении индексами.

В некоторых ситуациях может потребоваться переопределить это автоматическое поведение, чтобы лучше соответствовать вашим требованиям. Политику индексирования контейнера можно настроить, задав ее *режим индексирования*, а также включить или исключить *пути к свойствам*.

> [!NOTE]
> Метод обновления политик индексации, описанный в этой статье, применим только к API-интерфейсу SQL (Core) Azure Cosmos DB.

## <a name="indexing-mode"></a>Режим индексирования

Azure Cosmos DB поддерживает два режима индексирования:

- **Consistent** (Согласованный). Если политика индексирования контейнера имеет значение consistent, индекс обновляется синхронно по мере создания, обновления или удаления элементов. Это означает, что согласованность запросов чтения будет согласована, [настроенной для учетной записи](consistency-levels.md).

- **Нет** — Если для политики индексирования контейнера задано значение нет, индексирование в этом контейнере эффективно отключается. Это часто используется, когда контейнер используется в качестве чистого хранилища значений ключа без необходимости в вторичных индексах. Это также может помочь ускорить операции с массовыми вставками.

## <a name="including-and-excluding-property-paths"></a>Включение и исключение путей к свойствам

Пользовательская политика индексации может указывать пути к свойствам, которые явно включены или исключены из индексирования. Оптимизируя Количество индексируемых путей, можно уменьшить объем хранилища, используемого контейнером, и увеличить задержку операций записи. Эти пути определяются [методом, описанным в разделе Обзор индексирования](index-overview.md#from-trees-to-property-paths) со следующими дополнениями.

- путь, ведущий к скалярному значению (строке или номеру), заканчивается на`/?`
- элементы из массива обрабатываются вместе с помощью `/[]` нотации ( `/0`а не `/1` и т. д.).
- `/*` подстановочный знак можно использовать для сопоставления с любыми элементами, расположенными под узлом

Снова выполнив тот же пример:

    {
        "locations": [
            { "country": "Germany", "city": "Berlin" },
            { "country": "France", "city": "Paris" }
        ],
        "headquarters": { "country": "Belgium", "employees": 250 }
        "exports": [
            { "city": "Moscow" },
            { "city": "Athens" }
        ]
    }

- `headquarters`путь :`employees``/headquarters/employees/?`
- `locations`путь `country``/locations/[]/country/?`
- путь к любому элементу `headquarters` в разделе`/headquarters/*`

Если путь явно включен в политику индексирования, он также должен определять, какие типы индекса следует применить к этому пути и для каждого типа индекса, к типу данных, к которому применяется этот индекс:

| Тип индекса | Допустимые целевые типы данных |
| --- | --- |
| Диапазон | Строка или число |
| Пространственный | Point, LineString или Polygon |

`/headquarters/employees/?` Например, можно включить путь и указать `Range` , что к этому пути должен применяться индекс для обоих `String` значений и `Number` .

### <a name="includeexclude-strategy"></a>Стратегия включения и исключения

Любая политика индексации должна включать корневой путь `/*` как либо включенный, либо Исключенный путь.

- Включите корневой путь для выборочного исключения путей, которые не нужно индексировать. Это рекомендуемый подход, так как он позволяет Azure Cosmos DB заранее индексировать любое новое свойство, которое может быть добавлено в модель.
- Исключите корневой путь для выборочного включения путей, которые необходимо проиндексировать.

- Для путей с обычными символами, включающими буквенно-цифровые символы и символ _ (подчеркивание), не нужно заключать строку пути вокруг двойных кавычек (например, "/Пас/?"). Для путей с другими специальными символами необходимо экранировать строку пути, заключенную в двойные кавычки (например\", "/\"Path-ABC/?"). Если в пути предполагается наличие специальных символов, можно избежать последовательного переключения всех путей в целях безопасности. Функционально, это не имеет никакой разницы при экранировании всех путей и только тех, которые имеют специальные символы.

- Системное свойство "ETag" исключается из индексирования по умолчанию, если только ETag не добавлен в включаемый путь для индексирования.

Примеры политики индексации см. в [этом разделе](how-to-manage-indexing-policy.md#indexing-policy-examples) .

## <a name="composite-indexes"></a>Составные индексы

Запросы, `ORDER BY` для которых два или более свойств нуждаются в составном индексе. В настоящее время составные индексы используются только в `ORDER BY` нескольких запросах. По умолчанию составные индексы не определяются, поэтому при необходимости следует [добавлять составные индексы](how-to-manage-indexing-policy.md#composite-indexing-policy-examples) .

При определении составного индекса необходимо указать:

- Два или более пути свойств. Последовательность, в которой определяются пути к свойствам, имеет значение.
- Порядок (по возрастанию или по убыванию).

При использовании составных индексов используются следующие рекомендации.

- Если пути составного индекса не соответствуют последовательности свойств в предложении ORDER BY, составной индекс не поддерживает запрос.

- Порядок составных путей индекса (по возрастанию или по убыванию) должен также совпадать с порядком в предложении ORDER BY.

- Составной индекс также поддерживает предложение ORDER BY с противоположным порядком по всем путям.

Рассмотрим следующий пример, где составной индекс определяется для свойств a, b и c:

| **Составной индекс**     | **Образец `ORDER BY` запроса**      | **Поддерживается по индексу?** |
| ----------------------- | -------------------------------- | -------------- |
| ```(a asc, b asc)```         | ```ORDER BY  a asc, b asc```        | ```Yes```            |
| ```(a asc, b asc)```          | ```ORDER BY  b asc, a asc```        | ```No```             |
| ```(a asc, b asc)```          | ```ORDER BY  a desc, b desc```      | ```Yes```            |
| ```(a asc, b asc)```          | ```ORDER BY  a asc, b desc```       | ```No```             |
| ```(a asc, b asc, c asc)``` | ```ORDER BY  a asc, b asc, c asc``` | ```Yes```            |
| ```(a asc, b asc, c asc)``` | ```ORDER BY  a asc, b asc```        | ```No```            |

Необходимо настроить политику индексирования, чтобы можно было обслуживать все `ORDER BY` необходимые запросы.

## <a name="modifying-the-indexing-policy"></a>Изменение политики индексирования

Политику индексирования контейнера можно обновить в любое время с [помощью портал Azure или одного из поддерживаемых пакетов SDK](how-to-manage-indexing-policy.md). Обновление политики индексирования активирует преобразование старого индекса в новый, который выполняется в сети и на месте (поэтому дополнительное пространство для хранения данных во время операции не потребляется). Индекс старой политики эффективно преобразуется в новую политику, не влияя на доступность записи или пропускную способность, подготовленную в контейнере. Преобразование индекса — это асинхронная операция, а время, необходимое для выполнения, зависит от подготовленной пропускной способности, количества элементов и их размера. 

> [!NOTE]
> Во время повторного индексирования запросы могут не возвращать все совпадающие результаты и выполнять их без возврата ошибок. Это означает, что результаты запроса могут быть непостоянными до завершения преобразования индекса. Ход преобразования индекса можно отслеживать с [помощью одного из пакетов SDK](how-to-manage-indexing-policy.md).

Если для новой политики индексирования задан режим "целостный", другие изменения политики индексирования не могут быть применены во время преобразования индекса. Чтобы отменить выполнение преобразования индекса, можно задать для параметра режим политики индексирования значение нет (что приведет к немедленному удалению индекса).

## <a name="indexing-policies-and-ttl"></a>Политики индексирования и TTL

Для [функции срока жизни (TTL)](time-to-live.md) необходимо, чтобы индексация была активной в контейнере, в котором он включен. Это означает следующее.

- невозможно активировать TTL для контейнера, в котором для режима индексирования задано значение None,
- невозможно задать для режима индексирования значение None в контейнере, где активирован TTL.

В сценариях, где не требуется индексировать свойство, но требуется TTL, можно использовать политику индексации с:

- режим индексирования установлен в значение consistent, а
- Нет добавленных путей и
- `/*`только как исключающий путь.

## <a name="obsolete-attributes"></a>Устаревшие атрибуты

При работе с политиками индексации вы можете столкнуться со следующими атрибутами, которые теперь являются устаревшими:

- `automatic`Логическое значение, определенное в корне политики индексирования. Теперь он игнорируется и может иметь значение, `true`если для используемого инструмента это требуется.
- `precision`число, определенное на уровне индекса для включенных путей. Теперь он игнорируется и может иметь значение, `-1`если для используемого инструмента это требуется.
- `hash`— Это тип индекса, который теперь заменяется типом диапазона.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения об индексировании см. по следующим ссылкам:

- [Общие сведения об индексировании](index-overview.md)
- [Управление политикой индексирования](how-to-manage-indexing-policy.md)
