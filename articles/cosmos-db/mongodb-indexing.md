---
title: Управление индексацией в API Azure Cosmos DB для MongoDB
description: В этой статье представлен обзор возможностей индексирования DB Azure Cosmos с использованием API MongoDB.
ms.service: cosmos-db
ms.subservice: cosmosdb-mongo
ms.devlang: nodejs
ms.topic: conceptual
ms.date: 04/03/2020
author: timsander1
ms.author: tisande
ms.openlocfilehash: fd602f88acf26e821e57e0a844f543aac08dad0d
ms.sourcegitcommit: ffc6e4f37233a82fcb14deca0c47f67a7d79ce5c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81732708"
---
# <a name="manage-indexing-in-azure-cosmos-dbs-api-for-mongodb"></a>Управление индексацией в API Azure Cosmos DB для MongoDB

API-изапига Azure Cosmos DB для MongoDB использует основные возможности управления индексами Azure Cosmos DB. В этой статье основное внимание уделяется тому, как добавлять индексы с помощью API API Azure Cosmos DB для MongoDB. Вы также можете прочитать [обзор индексирования в Azure Cosmos DB,](index-overview.md) который актуален во всех AAP.

## <a name="indexing-for-mongodb-server-version-36"></a>Индексирование для версии сервера MongoDB 3.6

API API Azure Cosmos DB для серверной версии 3.6 MongoDB автоматически индексирует `_id` поле, которое не может быть удалено. Он автоматически обеспечивает уникальность `_id` поля на клавишу осколка.

Для индексирования дополнительных полей применяйте команды управления индексом MongoDB. Как и в MongoDB, API Azure Cosmos DB для `_id` MongoDB автоматически индексирует поле только. Эта политика индексирования по умолчанию отличается от API Azure Cosmos DB S'L, который индексирует все поля по умолчанию.

Чтобы применить сортировку к запросу, необходимо создать индекс на полях, используемых в операции сортировки.

## <a name="index-types"></a>Типы индексов

### <a name="single-field"></a>Одно поле

Вы можете создавать индексы на любом поле. Порядок типа единого индекса поля не имеет значения. Следующая команда создает индекс `name`на поле:

`db.coll.createIndex({name:1})`

В одном запросе используется несколько одиночных полевых индексов, где это возможно. Можно создать до 500 однополевых индексов на контейнер.

### <a name="compound-indexes-mongodb-server-version-36"></a>Составные индексы (версия сервера MongoDB 3.6)

API API Azure Cosmos DB для MongoDB поддерживает сложные индексы для учетных записей, которые используют протокол провода версии 3.6. В состав индекса можно включить до восьми полей. В отличие от MongoDB, необходимо создать сложный индекс только в том случае, если запрос должен эффективно сортироваться по нескольким полям одновременно. Для запросов с несколькими фильтрами, которые не нужно сортировать, создайте несколько одиночных индексов поля вместо одного индекса соединения.

Следующая команда создает сложный `name` индекс `age`на полях и:

`db.coll.createIndex({name:1,age:1})`

Сложные индексы можно использовать для эффективной сортировки на нескольких полях одновременно, как показано в следующем примере:

`db.coll.find().sort({name:1,age:1})`

Вы также можете использовать предыдущий индекс соединения для эффективного сортировки запроса с противоположным порядком сортировки на всех полях. Ниже приведен пример:

`db.coll.find().sort({name:-1,age:-1})`

Однако последовательность путей в индексе соединения должна точно соответствовать запросу. Вот пример запроса, который потребует дополнительного индекса соединения:

`db.coll.find().sort({age:1,name:1})`

### <a name="multikey-indexes"></a>Мультиключевые индексы

Azure Cosmos DB создает многоключевые индексы для индексирования содержимого, хранящегося в массивах. Если индексировать поле со значением массива, Azure Cosmos DB автоматически индексирует каждый элемент массива.

### <a name="geospatial-indexes"></a>Геопространственные индексы

Многие геопространственные операторы выиграют от геопространственных индексов. В настоящее время API API Azure Cosmos `2dsphere` DB для MongoDB поддерживает индексы. API пока не `2d` поддерживает индексы.

Вот пример создания геопространственного индекса на `location` поле:

`db.coll.createIndex({ location : "2dsphere" })`

### <a name="text-indexes"></a>Текстовые индексы

API API Azure Cosmos DB для MongoDB в настоящее время не поддерживает текстовые индексы. Для поиска текста на строках следует использовать интеграцию [Azure Cognitive Search](https://docs.microsoft.com/azure/search/search-howto-index-cosmosdb) с Azure Cosmos DB.

## <a name="index-properties"></a>Свойства индекса

Следующие операции являются общими для счетов, обслуживающих версию протокола провода 3.6, и учетные записи, обслуживающие более ранние версии. Вы можете узнать больше о [поддерживаемых индексах и индексированных свойствах.](mongodb-feature-support-36.md#indexes-and-index-properties)

### <a name="unique-indexes"></a>Уникальные индексы

[Уникальные индексы](unique-keys.md) полезны для обеспечения того, чтобы два или более документов не содержали одинакового значения для индексированных полей.

> [!IMPORTANT]
> Уникальные индексы могут быть созданы только тогда, когда коллекция пуста (не содержит документов).

Следующая команда создает уникальный `student_id`индекс на поле:

```shell
globaldb:PRIMARY> db.coll.createIndex( { "student_id" : 1 }, {unique:true} )
{
        "_t" : "CreateIndexesResponse",
        "ok" : 1,
        "createdCollectionAutomatically" : false,
        "numIndexesBefore" : 1,
        "numIndexesAfter" : 4
}
```

Для осколков коллекций необходимо предоставить ключ осколка (раздел) для создания уникального индекса. Иными словами, все уникальные индексы для сегментированной коллекции — это составные индексы, где одно из полей является ключом раздела.

Следующие команды создают осколок ```coll``` коллекции (клавиша ```university```осколка) `student_id` с `university`уникальным индексом на полях и :

```shell
globaldb:PRIMARY> db.runCommand({shardCollection: db.coll._fullName, key: { university: "hashed"}});
{
        "_t" : "ShardCollectionResponse",
        "ok" : 1,
        "collectionsharded" : "test.coll"
}
globaldb:PRIMARY> db.coll.createIndex( { "student_id" : 1, "university" : 1 }, {unique:true})
{
        "_t" : "CreateIndexesResponse",
        "ok" : 1,
        "createdCollectionAutomatically" : false,
        "numIndexesBefore" : 3,
        "numIndexesAfter" : 4
}
```

В предыдущем примере опущение оговорки ```"university":1``` возвращает ошибку со следующим сообщением:

```"cannot create unique index over {student_id : 1.0} with shard key pattern { university : 1.0 }"```

### <a name="ttl-indexes"></a>Индексы срока жизни

Для обеспечения истечения срока действия документа в определенной коллекции необходимо создать [индекс time-to-live (TTL).](../cosmos-db/time-to-live.md) Индекс TTL — это `_ts` индекс на `expireAfterSeconds` поле со значением.

Пример.

```JavaScript
globaldb:PRIMARY> db.coll.createIndex({"_ts":1}, {expireAfterSeconds: 10})
```

Предыдущая команда удаляет все ```db.coll``` документы в коллекции, которые не были изменены за последние 10 секунд.

> [!NOTE]
> Поле **_ts** специфична для Azure Cosmos DB и недоступно для клиентов MongoDB. Это зарезервированное (системное) свойство, содержащее отметку времени последней модификации документа.

## <a name="track-index-progress"></a>Отслеживайте прогресс индекса

Версия 3.6 API API Azure Cosmos DB для `currentOp()` MongoDB поддерживает команду для отслеживания прогресса индекса в экземпляре базы данных. Эта команда возвращает документ, содержащий информацию о незавершенных операциях в экземпляре базы данных. Вы используете `currentOp` команду для отслеживания всех незавершенных операций в родном MongoDB. В API API Azure Cosmos DB для MongoDB эта команда поддерживает только отслеживание работы индекса.

Вот несколько примеров, которые `currentOp` показывают, как использовать команду для отслеживания прогресса индекса:

* Получите прогресс индекса для коллекции:

   ```shell
   db.currentOp({"command.createIndexes": <collectionName>, "command.$db": <databaseName>})
   ```

* Получите прогресс индекса для всех коллекций в базе данных:

  ```shell
  db.currentOp({"command.$db": <databaseName>})
  ```

* Получите прогресс индекса для всех баз данных и коллекций в учетной записи Azure Cosmos:

  ```shell
  db.currentOp({"command.createIndexes": { $exists : true } })
  ```

### <a name="examples-of-index-progress-output"></a>Примеры вывода индексного прогресса

Детали прогресса индекса показывают процент прогресса для текущей операции индекса. Вот пример, который показывает формат вывода документа для различных стадий прогресса индекса:

- Операция индекса в базе данных "foo" и "бар", которая заполнена на 60 процентов, будет иметь следующий выводной документ. Поле `Inprog[0].progress.total` показывает 100 в качестве целевого процента завершения.

   ```json
   {
        "inprog" : [
        {
                ………………...
                "command" : {
                        "createIndexes" : foo
                        "indexes" :[ ],
                        "$db" : bar
                },
                "msg" : "Index Build (background) Index Build (background): 60 %",
                "progress" : {
                        "done" : 60,
                        "total" : 100
                },
                …………..…..
        }
        ],
        "ok" : 1
   }
   ```

- Если операция индекса только что началась в базе данных "foo" и "бар", выводной документ может отображать 0-процентный прогресс до тех пор, пока не достигнет измеримого уровня.

   ```json
   {
        "inprog" : [
        {
                ………………...
                "command" : {
                        "createIndexes" : foo
                        "indexes" :[ ],
                        "$db" : bar
                },
                "msg" : "Index Build (background) Index Build (background): 0 %",
                "progress" : {
                        "done" : 0,
                        "total" : 100
                },
                …………..…..
        }
        ],
       "ok" : 1
   }
   ```

- При завершении операции индекса в процессе `inprog` выполнения документ вывода показывает пустые операции.

   ```json
   {
      "inprog" : [],
      "ok" : 1
   }
   ```

### <a name="background-index-updates"></a>Обновления фоновых индексов

Независимо от значения, указанного для свойства **фонового** индекса, обновления индекса всегда выполняются в фоновом режиме. Поскольку обновления индексов потребляют единицы запроса (RUs) с более низким приоритетом, чем другие операции базы данных, изменения индекса не приведут к простою записей, обновлений или удалений.

При добавлении нового индекса запросы будут немедленно использовать индекс. Это означает, что запросы могут не возвращать все соответствующие результаты и будут делать это без возврата ошибок. По завершении преобразования индекса результаты запроса будут последовательными. Вы можете [отслеживать прогресс индекса.](#track-index-progress)

## <a name="migrate-collections-with-indexes"></a>Мигрировать коллекции с индексами

В настоящее время создавать уникальные индексы можно только тогда, когда коллекция не содержит документов. Популярные инструменты миграции MongoDB пытаются создать уникальные индексы после импорта данных. Чтобы обойти эту проблему, можно вручную создать соответствующие коллекции и уникальные индексы вместо того, чтобы пытаться инструмент миграции. (Вы можете достичь ```mongorestore``` этого поведения `--noIndexRestore` с помощью флага в командной строке.)

## <a name="indexing-for-mongodb-version-32"></a>Индексирование для версии MongoDB 3.2

Доступные функции индексации и значения по умолчанию отличаются для учетных записей Azure Cosmos, совместимых с версией 3.2 протокола проволоки MongoDB. Вы можете [проверить версию вашей учетной записи](mongodb-feature-support-36.md#protocol-support). Вы можете перейти на версию 3.6, подав [запрос на поддержку.](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade)

Если вы используете версию 3.2, в этом разделе изложены ключевые различия с версией 3.6.

### <a name="dropping-default-indexes-version-32"></a>Удаление индексов по умолчанию (версия 3.2)

В отличие от 3.6 версии API API Azure Cosmos DB для MongoDB, версия 3.2 индексирует каждое свойство по умолчанию. Вы можете использовать следующую команду, чтобы отказаться```coll```от этих индексов по умолчанию для коллекции ( ):

```JavaScript
> db.coll.dropIndexes()
{ "_t" : "DropIndexesResponse", "ok" : 1, "nIndexesWas" : 3 }
```

После снижения индексов по умолчанию можно добавить больше индексов, как в версии 3.6.

### <a name="compound-indexes-version-32"></a>Составные индексы (версия 3.2)

Составные индексы содержат ссылки на множество полей документа. Если вы хотите создать сложный индекс, переймите до версии 3.6, подав [запрос на поддержку.](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade)

## <a name="next-steps"></a>Следующие шаги

* [Индексирование в Azure Cosmos DB](../cosmos-db/index-policy.md)
* [Срок жизни для данных Azure Cosmos DB](../cosmos-db/time-to-live.md)
