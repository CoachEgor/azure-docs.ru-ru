---
title: Хранение ключей Azure Cosmos DB и получение доступа к ним в Key Vault
description: Хранение строк подключения, ключей и конечных точек Azure Cosmos DB, а также получение доступа к ним в Azure Key Vault.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.devlang: dotnet
ms.topic: conceptual
ms.date: 05/23/2019
ms.reviewer: sngun
ms.openlocfilehash: 225221635f978e3d70cec4ce7e9d78d6b100b4fd
ms.sourcegitcommit: bc738d2986f9d9601921baf9dded778853489b16
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2020
ms.locfileid: "80618759"
---
# <a name="secure-azure-cosmos-keys-using-azure-key-vault"></a>Защита ключей Azure Cosmos с помощью Azure Key Vault 

>[!IMPORTANT]
> Рекомендуемое решение для доступа к клавишам Azure Cosmos DB — использовать [управляемую итог, назначенную системой.](managed-identity-based-authentication.md) Если служба не может воспользоваться управляемыми идентификаторами, используйте [решение на основе сертификата.](certificate-based-authentication.md) Если и управляемое решение идентификационных данных, и решение на основе сертификата не отвечают вашим потребностям, пожалуйста, используйте решение хранилища ключей ниже.

При использовании Azure Cosmos DB для приложений можно получить доступ к базе данных, коллекциям, документам, используя конечную точку и ключ в файле конфигурации приложения.  Тем не менее, это не безопасно, чтобы положить ключи и URL непосредственно в код приложения, потому что они доступны в ясном текстовом формате для всех пользователей. Нужно гарантировать доступность конечной точки и ключей через защищенный механизм. Azure Key Vault может помочь в надежном хранении секретов приложения и в управлении ими.

Чтобы сохранить ключи доступа Azure Cosmos DB в Key Vault и читать их оттуда, требуются следующие шаги:

* Создание хранилища ключей  
* добавление ключей доступа Azure Cosmos DB в Key Vault;  
* создание веб-приложения Azure;  
* Регистрация приложения и предоставление ему разрешений на чтение из Key Vault  


## <a name="create-a-key-vault"></a>Создание хранилища ключей

1. Войти на [портал Azure](https://portal.azure.com/).  
2. Выберите **Создать ресурс > Безопасность > Key Vault**.  
3. В разделе **Создать Key Vault** введите приведенные ниже сведения.  
   * **Имя**. Укажите уникальное имя для Key Vault.  
   * **Подписка**. Выберите подписку, которую нужно использовать.  
   * В разделе **Группа ресурсов** выберите **Создать** и введите имя группы ресурсов.  
   * Выберите расположение в раскрывающемся меню "Расположение".  
   * Для других параметров оставьте значения по умолчанию.  
4. Указав приведенные выше сведения, выберите **Создать**.  

## <a name="add-azure-cosmos-db-access-keys-to-the-key-vault"></a>Добавление в Key Vault ключей доступа Azure Cosmos DB
1. Перейдите в хранилище Key Vault, созданное на предыдущем шаге, и откройте вкладку **Секреты**.  
2. Выберите **+ Создать или импортировать**. 

   * Выберите **Руководство** для **вариантов загрузки.**
   * Укажите **имя** для секрета.
   * Укажите строку подключения вашей учетной записи Cosmos DB в поле **Значение**. Затем нажмите кнопку **Создать**.

   ![Создание секрета](./media/access-secrets-from-keyvault/create-a-secret.png)

4. После того как секрет будет создан, откройте его и скопируйте **идентификатор секрета в следующем формате. Этот идентификатор понадобится вам в следующем разделе. 

   `https://<Key_Vault_Name>.vault.azure.net/secrets/<Secret _Name>/<ID>`

## <a name="create-an-azure-web-application"></a>создание веб-приложения Azure;

1. Создайте веб-приложение Azure или загрузите его из [репозитория GitHub](https://github.com/Azure/azure-cosmosdb-dotnet/tree/master/Demo/keyvaultdemo). Это простое приложение MVC.  

2. Распакуйте загруженное приложение и откройте файл **HomeController.cs**. Обновите идентификатор секрета в следующей строке:

   `var secret = await keyVaultClient.GetSecretAsync("<Your Key Vault’s secret identifier>")`

3. **Сохраните** файл и выполните **сборку** решения.  
4. Затем разверните приложение в Azure. Щелкните проект правой кнопкой мыши и выберите **Опубликовать**. Создайте новый профиль службы приложения (вы можете назвать приложение WebAppKeyVault1) и выберите **Опубликовать**.   

5. После этого приложение будет развернуто. На портале Azure перейдите к развернутому веб-приложению и включите **управляемое удостоверение службы** этого приложения.  

   ![Управляемое удостоверение службы](./media/access-secrets-from-keyvault/turn-on-managed-service-identity.png)

Если вы запустите приложение сейчас, отобразится следующая ошибка. Она возникает, потому что вы не предоставили этому приложению прав на использование Key Vault.

![Приложение развернуто без доступа](./media/access-secrets-from-keyvault/app-deployed-without-access.png)

## <a name="register-the-application--grant-permissions-to-read-the-key-vault"></a>Регистрация приложения и предоставление ему разрешений на чтение из Key Vault

В этом разделе вы регистрируете приложение в Azure Active Directory и предоставляете ему разрешения на чтение из Key Vault. 

1. Перейдите на портал Azure и откройте **Key Vault**, созданное в предыдущем разделе.  

2. Откройте **политики доступа**, выберите **+ Добавить**, найдите развернутое веб-приложение, выберите разрешения и нажмите кнопку **ОК**.  

   ![Добавление политики доступа](./media/access-secrets-from-keyvault/add-access-policy.png)

Теперь, запустив приложение, вы сможете прочитать секрет из Key Vault.

![Развернутое приложение, в котором отображается секрет](./media/access-secrets-from-keyvault/app-deployed-with-access.png)
 
Аналогичным образом вы можете предоставить пользователю доступ к Key Vault. Вам нужно добавить себя в Key Vault. Для этого выберите **Политики доступа**, а затем предоставьте все необходимые разрешения для запуска приложения из Visual Studio. Если это приложение запускается с вашего рабочего стола, оно использует ваш идентификатор.

## <a name="next-steps"></a>Следующие шаги

* Для настройки брандмауэра для Azure Cosmos DB смотрите статью [поддержки брандмауэра.](firewall-support.md)
* Чтобы настроить конечную точку службы для виртуальной сети, перейдите к статье [Безопасный доступ к учетной записи Azure Cosmos DB с использованием конечной точки службы для виртуальной сети Azure](vnet-service-endpoint.md).
