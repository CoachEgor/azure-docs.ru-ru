---
title: Работа с сохраненными процедурами, триггерами и UDF в Azure Cosmos DB
description: В этой статье вводятся такие концепции, как хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB.
author: markjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 08/01/2019
ms.author: mjbrown
ms.reviewer: sngun
ms.openlocfilehash: 23a14e7590eca6f63c92acdf6336ffaef8b54381
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80065895"
---
# <a name="stored-procedures-triggers-and-user-defined-functions"></a>Хранимые процедуры, триггеры и определяемые пользователем функции

Azure Cosmos DB обеспечивает транзакционное выполнение JavaScript с интегрированной средой для языка. При использовании API SQL в Azure Cosmos DB вы можете записать **хранимые процедуры**, **триггеры** и **определяемые пользователем функции (UDF)** на языке JavaScript. Вы можете написать свою логику на JavaScript, которую выполните в ядре СУБД. Вы можете создавать и выполнять триггеры, хранимые процедуры и определяемые пользователем функции с помощью [портала Azure](https://portal.azure.com/), [API запросов с интегрированным языком JavaScript в Azure Cosmos DB](javascript-query-api.md) или [клиентских пакетов SDK API SQL в Cosmos DB](how-to-use-stored-procedures-triggers-udfs.md).

## <a name="benefits-of-using-server-side-programming"></a>Преимущества использования программирования на стороне сервера

Написание хранимых процедур, триггеров и пользовательских функций (UDF) в JavaScript позволяет создавать многофункциональные приложения, которые обладают следующими преимуществами.

* **Процедурная логика:** JavaScript как язык программирования высокого уровня, который обеспечивает богатый и знакомый интерфейс для выражения бизнес-логики. Вы можете выполнять последовательность сложных операций с данными.

* **Атомные транзакции:** Azure Cosmos DB гарантирует, что операции базы данных, выполняемые в рамках одной сохраненной процедуры или триггера, являются атомными. Атомарные транзакции позволяют приложению объединить соответствующие операции в один пакет, который будет выполнен успешно полностью или не будет выполнен вовсе.

* **Производительность:** Данные JSON по своей сути отображались в системе типа языка JavaScript. Это сопоставление позволяет выполнить ряд оптимизаций, таких как отложенная материализация документов JSON в пуле буферов и их доступность по требованию для исполняемого кода. Существуют также другие преимущества производительности, связанные с доставкой бизнес-логики в базу данных:

   * *Пакетирование:* Вы можете группировать операции, как вставки и представить их навалом. При создании отдельных операций значительно сокращаются затраты на задержку сетевого трафика и накладные расходы для хранения.

   * *Предварительная компиляция:* Сохраненные процедуры, триггеры и UDF неявно предварительно компилируются в формате кода байта, чтобы избежать затрат на компиляцию во время каждого вызова скрипта. Благодаря предварительной компиляции скорость хранимой процедуры высокая, а занимаемая память небольшая.

   * *Секвенирование:* Иногда операции нуждаются в механизме запуска, который может выполнять одно или дополнительные обновления данных. Помимо атомарности, выполнение на стороне сервера также дает преимущество в отношении производительности.

* **Инкапсуляция:** Сохраненные процедуры могут быть использованы для группы логики в одном месте. Инкапсуляция добавляет уровень абстракции поверх данных, что позволяет вам развивать свои приложения независимо от данных. Этот уровень абстракции полезен, когда данные не содержат схем, и вам не нужно внедрять дополнительную логику непосредственно в ваше приложение. Абстракция позволяет вам сохранить свои данные в безопасности, упрощая доступ к ним из сценариев.

> [!TIP]
> Сохраненные процедуры лучше всего подходят для операций, которые являются записаны и требуют транзакции по ключевой стоимости раздела. При принятии решения об использовании сохраненных процедур оптимизируйте возможность инкапсулировать максимально возможное количество записок. Вообще говоря, сохраненные процедуры не являются наиболее эффективным средством выполнения большого количества операций чтения или запроса, поэтому использование сохраненных процедур для пакетов большого количества считывателей для возврата клиенту не даст желаемой выгоды. Для наилучшей производительности, эти чтения тяжелых операций должны быть сделаны на стороне клиента, используя Космос SDK. 

## <a name="transactions"></a>Транзакции

Транзакции в типичной базе данных могут быть определены как последовательность операций, выполняемых в одной логической единице работы. Каждая транзакция предоставляет **гарантию выполнения принципа ACID**. ACID является хорошо известной аббревиатурой, которая означает: **tomicity,** **C**onsistency, **I**solation, и **D**urability. 

* Атомарность гарантирует, что все операции, проделанные в транзакции, рассматриваются как единое целое и могут быть выполнены либо все, либо не выполнены вообще. 

* Согласованность гарантирует, что данные всегда находятся в допустимом состоянии между транзакциями. 

* Изолированность гарантирует, что никакие две транзакции не будут мешать друг другу. Много коммерческих систем обеспечивают несколько уровней изолированности, которые могут быть использованы в зависимости от потребностей приложений. 

* Устойчивость гарантирует, что любое изменение, которое совершено в базе данных, всегда будет присутствовать.

В Azure Cosmos DB среда выполнения JavaScript включена в ядро базы данных. Следовательно, запросы, хранимые процедуры и триггеры выполняются в том же пространстве, что и база данных. Эта возможность позволяет Azure Cosmos DB соблюдать принцип ACID для всех операций, которые являются частью хранимой процедуры или триггера. Примеры см. в статье [Транзакции в хранимых процедурах](how-to-write-stored-procedures-triggers-udfs.md#transactions).

### <a name="scope-of-a-transaction"></a>Область транзакции

Сохраненные процедуры связаны с контейнером Azure Cosmos, а выполнение сохраненной процедуры приобщено к логическому ключу раздела. Сохраненные процедуры должны включать логическое значение ключа раздела во время выполнения, определяющее логический раздел для объема транзакции. Дополнительные сведения см. в статье [Секционирование и горизонтальное масштабирование в Azure Cosmos DB](partition-data.md).

### <a name="commit-and-rollback"></a>Фиксация и откат транзакций

Транзакции изначально интегрированы в модель программирования JavaScript в Azure Cosmos DB. В функции JavaScript все операции автоматически встроены в одну транзакцию. Если логика JavaScript в хранимой процедуре завершается без каких-либо исключений, то все операции транзакции передаются в базу данных. Такие операторы как `BEGIN TRANSACTION` и `COMMIT TRANSACTION` (знакомые по реляционным базам данных) неявно присутствуют в Azure Cosmos DB. Если в сценарии есть исключения, среда выполнения JavaScript в Azure Cosmos DB откатит всю транзакцию. Таким образом, вызов исключения фактически эквивалентен `ROLLBACK TRANSACTION` в базе данных Azure Cosmos DB.

### <a name="data-consistency"></a>Согласованность данных

Хранимые процедуры и триггеры всегда выполняются на основной реплике контейнера Azure Cosmos. Эта возможность гарантирует, что операции чтения в хранимых процедурах обеспечивают [сильную согласованность](consistency-levels-tradeoffs.md). Запросы с использованием пользовательских функций могут выполняться на первичной либо на любой вторичной реплике. Хранимые процедуры и триггеры предназначены для поддержки транзакционных записей, в то время как логика только для чтения лучше всего реализована в виде логики на стороне приложения и запросов с использованием [пакетов SDK API SQL Azure Cosmos DB](sql-api-dotnet-samples.md), которые помогут вам насыщать пропускную способность базы данных. 

## <a name="bounded-execution"></a>Ограниченное выполнение

Все операции Azure Cosmos DB должны завершаться за определенный период времени. Это ограничение относится к функциям JavaScript: хранимым процедурам, триггерам и определяемым пользователем функциям. Если операция не завершается в течение этого периода времени, транзакция откатывается.

Вы можете или завершить функции JavaScript за определенный период времени или поддерживать модель продолжения работы для пакетной или поэтапной обработки. Для упрощения разработки хранимых процедур и триггеров и ограничения времени их выполнения все функции в соответствии с контейнером Azure Cosmos (например, для создания, чтения, обновления и удаления элементов) возвращают логическое значение, которое представляет, будет ли эта операция завершена. Если значение равно false, это указывает на то, что процедура должна завершить выполнение, поскольку сценарий потребляет больше времени или ресурсов, чем предусмотрено в настройках. Операции, предшествующие первой неакцептованной операции сохранения данных, помещаются в очередь и гарантированно будут завершены, если хранимая процедура завершается в срок и очередь пуста. Таким образом, операции должны формировать очередь, используя соглашение обратного вызова JavaScript для управления потоком выполнения скрипта. Поскольку сценарии выполняются в среде на стороне сервера, они строго регламентированы. Сценарии, которые неоднократно нарушают границы выполнения, могут получить метку о неактивности и не могут выполняться. Их необходимо создать заново для соблюдения границ выполнения.

Функции JavaScript также подлежат [выделенной пропускной способности](request-units.md). Функции JavaScript потенциально могут использовать большое количество блоков запросов в течение короткого времени и могут быть ограничены по скорости, если достигнут предела пропускной способности. Важно отметить, что сценарии используют пропускную способность в дополнение к пропускной способности, затрачиваемой на выполнение операций с базой данных, хотя эти операции с базами данных немного дешевле, чем выполнение тех же операций клиентом.

## <a name="triggers"></a>Триггеры

Azure Cosmos DB поддерживает два типа триггеров:

### <a name="pre-triggers"></a>Триггеры предварительного выполнения

Azure Cosmos DB предоставляет триггеры, которые можно вызвать путем выполнения операций с элементом Azure Cosmos DB. Например, при создании элемента можно указать триггер предварительного выполнения. В этом случае триггер предварительного выполнения будет выполнен еще до создания элемента. Триггеры со срабатыванием до наступления события не могут иметь никаких входных параметров. При необходимости объект запроса можно использовать для обновления основного текста документа по сравнению с исходным запросом. При регистрации триггеров пользователи могут указать операции, с которыми они запускаются. Если триггер создавался с помощью `TriggerOperation.Create`, то его запрещается использовать в операции замены. Примеры см. в статье [Как записать триггеры](how-to-write-stored-procedures-triggers-udfs.md#triggers).

### <a name="post-triggers"></a>Триггеры последующего выполнения

Как и в случае с предварительно триггерами, посттриггеры также связаны с операцией на элементе Azure Cosmos и не требуют каких-либо параметров ввода. Они выполняются *после* завершения операции и имеют доступ к сообщению ответа, которое отправляется клиенту. Примеры см. в статье [Как записать триггеры](how-to-write-stored-procedures-triggers-udfs.md#triggers).

> [!NOTE]
> Зарегистрированные триггеры не работают автоматически, когда их соответствующие операции (создание / удаление / замена / обновление) происходят. При выполнении этих операций их приходится вызывать явным образом. Чтобы узнать больше, посмотрите, [как запустить триггеры статьи.](how-to-use-stored-procedures-triggers-udfs.md#pre-triggers)

## <a name="user-defined-functions"></a><a id="udfs"></a>Функции, определяемые пользователем

Функции, определяемые пользователем (UDF), используются для расширения синтаксиса языка запросов API SQL и упрощенной реализации пользовательской бизнес-логики. Их можно вызвать только внутри запросов. Определяемые пользователем функции не имеют доступа к объектам контекста и предназначены для использования только в качестве вычислимых скриптов JavaScript. Таким образом, определяемые пользователем функции могут запускаться только на дополнительных репликах. Примеры см. в статье [Как записать определяемые пользователем функции](how-to-write-stored-procedures-triggers-udfs.md#udfs).

## <a name="javascript-language-integrated-query-api"></a><a id="jsqueryapi"></a>API запросов, интегрированный в язык JavaScript

Кроме выдачи запросов с использованием синтаксиса запросов API SQL, [серверный пакет SDK](https://azure.github.io/azure-cosmosdb-js-server) позволяет создавать запросы с помощью интерфейса JavaScript без знания языка SQL. API запросов JavaScript позволяет программно создавать запросы, передавая функции предикатов в последовательность вызовов функций. Запросы анализируются средой выполнения JavaScript и эффективно выполняются в Azure Cosmos DB. Дополнительные сведения о поддержке API запросов JavaScript см. в статье [Working with JavaScript language integrated query API](javascript-query-api.md) (Как работать с API запросов с интегрированным языком JavaScript). Примеры см. в статье [How to write stored procedures and triggers using Javascript Query API](how-to-write-javascript-query-api.md) (Как записывать хранимые процедуры и триггеры в Azure Cosmos DB с помощью API запросов JavaScript).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о том, как записать и использовать хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB, см. в этих статьях:

* [Как писать хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB](how-to-write-stored-procedures-triggers-udfs.md)

* [Как зарегистрировать и использовать хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB](how-to-use-stored-procedures-triggers-udfs.md)

* [Working with JavaScript language integrated query API](javascript-query-api.md) (Как работать с API запросов с интегрированным языком JavaScript)
