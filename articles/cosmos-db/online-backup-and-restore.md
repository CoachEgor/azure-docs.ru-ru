---
title: Автоматическое, оперативное резервное копирование и восстановление данных по запросу в Azure Cosmos DB
description: В этой статье мы расскажем, как работает автоматическое, оперативное резервное копирование и восстановление данных по запросу в Azure Cosmos DB.
author: kanshiG
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 11/15/2018
ms.author: govindk
ms.reviewer: sngun
ms.openlocfilehash: 6ed968b1613a96a2f4ab449c7b52488e066a38ab
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "60930248"
---
# <a name="online-backup-and-on-demand-data-restore-in-azure-cosmos-db"></a>Оперативное резервное копирование и восстановление данных по запросу в Azure Cosmos DB

Azure Cosmos DB автоматически копирует все ваши данные с регулярными интервалами. Автоматическое резервное копирование не влияет на производительность или доступность операций баз данных. Для обеспечения устойчивости в случае региональной аварии все резервные копии хранятся отдельно в службе хранилища, а также глобально реплицируются. Автоматические резервные копии позволяют восстановить данные при случайном удалении или обновлении учетной записи, базы данных или контейнера Azure Cosmos.

## <a name="automatic-and-online-backups"></a>Автоматическое и оперативное резервное копирование

Azure Cosmos DB обеспечивает высокую избыточность и устойчивость к региональным авариям не только ваших данных, но и их резервных копий. Ниже показано, как Azure Cosmos DB выполняет резервное копирование данных:

* Azure Cosmos DB автоматически выполняет резервное копирование базы данных каждые 4 часа, и в любой момент времени, сохраняются только последние 2 резервные копии. Однако при удалении контейнера или базы данных Azure Cosmos DB хранит существующие моментальные снимки в течение 30 дней.

* Azure Cosmos DB сохраняет эти резервные копии в хранилище BLOB-объектов Azure, в то время как сами данные хранятся локально в Azure Cosmos DB.

*  Чтобы гарантировать низкую задержку, моментальный снимок архивной копии хранятся в хранилище BLOB-объектов Azure в том же регионе, в текущий регион записи (или один из регионов, записи, в случае, если у вас есть конфигурацию с несколькими хозяевами) из вашего Cosmos Azure учетная запись базы данных. Чтобы можно было обеспечить устойчивость к региональным авариям, каждый моментальный снимок данных резервной копии в хранилище BLOB-объектов Azure повторно реплицируется в другой регион через геоизбыточное хранилище (GRS). Регион, в который реплицируется резервная копия, зависит от региона источника и региона, который составляет с ним пару. Чтобы узнать больше, ознакомьтесь со [списком геоизбыточных пар регионов Azure](../best-practices-availability-paired-regions.md). У вас нет прямого доступа к этой резервной копии. Azure Cosmos DB использует эту резервную копию только в случае инициации восстановления.

* Резервное копирование не влияет на производительность или доступность приложения. Azure Cosmos DB выполняет резервное копирование данных в фоновом режиме, не используя дополнительную пропускную способность (ЕЗ) и не снижая производительность и доступность базы данных.

* Если у вас случайно удалены или повреждены данные, следует обратиться к [поддержки Azure](https://azure.microsoft.com/support/options/) в течение 8 часов таким образом, команда Azure Cosmos DB может помочь вам восстановить данные из резервных копий.

Ниже показано, как контейнер Azure Cosmos со всеми тремя основными физическими разделами в регионе "западная часть США" копируется в удаленную учетную запись хранилища BLOB-объектов Azure в регионе "западная часть США", а затем реплицируется в регион "восточная часть США".

![Периодически выполняемая полная архивация всех сущностей Cosmos DB в геоизбыточное хранилище Azure](./media/online-backup-and-restore/automatic-backup.png)

## <a name="options-to-manage-your-own-backups"></a>Способы управления резервными копиями

Учетные записи API SQL Azure Cosmos DB предоставляют следующие способы управления резервными копиями:

* периодическое перемещение данных в собственное хранилище с помощью [Фабрики данных Azure](../data-factory/connector-azure-cosmos-db.md);

* периодическое считывание полных резервных копий, а также добавочных изменений с помощью [канала изменений](change-feed.md) Azure Cosmos DB и их сохранение в собственном хранилище.

## <a name="backup-retention-period"></a>Срок хранения моментального снимка

Azure Cosmos DB создает моментальные снимки данных каждые четыре часа. В любое время сохраняются только два последних моментальных снимка. Однако при удалении контейнера или базы данных Azure Cosmos DB хранит существующие моментальные снимки в течение 30 дней.

## <a name="restoring-data-from-online-backups"></a>Восстановление данных из оперативных резервных копий

Случайное удаление или изменение данных может произойти в одном из следующих сценариев:  

* удаление всей учетной записи Azure Cosmos;

* удаление одной или нескольких баз данных Azure Cosmos;

* удаление одного или нескольких контейнеров Azure Cosmos;

* удаление или изменение элементов (например, документов) Azure Cosmos в контейнере (повреждение данных);

* удаление или повреждение общей базы данных предложений или контейнеров в общей базе данных предложений.

Azure Cosmos DB может восстановить данные во всех указанных выше сценариях. Для хранения восстановленных данных всегда создается новая учетная запись Azure Cosmos. Имя новой учетной записи, если оно не указано, будет иметь формат `<Azure_Cosmos_account_original_name>-restored1`. Последняя цифра — порядковый номер попытки восстановления. Нельзя восстановить данные в уже созданную учетную запись Azure Cosmos.

Если имя удаленной учетной записи Azure Cosmos не используется, мы можем восстановить данные в учетную запись с тем же именем. В таких случаях рекомендуем не воссоздавать учетную запись, которая была удалена, так как это не только мешает восстановить данные с теми же именами, но и осложняет обнаружение восстанавливаемой учетной записи. 

Можно восстановить всю удаленную базу данных Azure Cosmos или отдельные контейнеры из этой базы данных. Кроме того, можно выбрать контейнеры из баз данных и восстановить их в новой учетной записи Azure Cosmos.

При случайном удалении или изменении одного или нескольких элементов в контейнере (случай повреждения данных) необходимо будет указать точку восстановления. В этом случае нельзя медлить. Так как контейнер активен, резервное копирование по-прежнему выполняется, поэтому по окончании периода хранения (по умолчанию — восемь часов) резервные копии будут перезаписаны. В случае удаления ваши данные не будут перезаписаны циклом резервного копирования, так как они больше не хранятся. Резервные копии удаленных баз данных или контейнеров хранятся в течение 30 дней.

Если пропускная способность подготовлена на уровне базы данных (то есть подготовленная пропускная способность является общей для набора контейнеров), процесс резервного копирования и восстановления происходит на уровне базы данных, а не на уровне отдельных контейнеров. В таких случаях нельзя выбрать отдельные контейнеры для восстановления.

## <a name="migrating-data-to-the-original-account"></a>Перенос данных в исходную учетную запись

Основная цель восстановления данных — восстановить случайно удаленные или измененные данные. Поэтому мы рекомендуем сначала проверить содержимое восстановленных данных. Затем перенесите данные обратно в основную учетную запись. Не рекомендуем использовать восстановленную учетную запись как активную учетную запись при наличии производственных рабочих нагрузок.  

Ниже приведены различные способы переноса данных в исходную учетную запись Azure Cosmos:

* использование [средства переноса данных Azure Cosmos DB](import-data.md);
* использование [Фабрики данных Azure]( ../data-factory/connector-azure-cosmos-db.md);
* использование [канала изменений](change-feed.md) в Azure Cosmos DB; 
* написание собственного кода.

Удалите восстановленные учетные записи, как только закончите миграцию, потому что за них будет взиматься регулярная плата.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как восстановить данные из учетной записи Azure Cosmos или перенести данные в учетную запись Azure Cosmos.

* [Запрос на восстановление можно отправить с портала Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade), обратившись в службу поддержки Azure.
* [Как восстановить данные из учетной записи Azure Cosmos](how-to-backup-and-restore.md)
* Перемещение данных в Azure Cosmos DB с помощью [канала изменений Cosmos DB](change-feed.md).
* Перемещение данных в Azure Cosmos DB с помощью [Фабрики данных Azure](../data-factory/connector-azure-cosmos-db.md).

