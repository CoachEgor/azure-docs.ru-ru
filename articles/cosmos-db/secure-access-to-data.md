---
title: Сведения о защите доступа к данным в Azure Cosmos DB
description: Основные понятия управления доступом в Azure Cosmos DB, включая главные ключи, ключи только для чтения, пользователей и разрешения.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/21/2019
ms.openlocfilehash: ec32dfbe9aac13a9b3c08922b73b9a23d668d744
ms.sourcegitcommit: 0b1a4101d575e28af0f0d161852b57d82c9b2a7e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73152273"
---
# <a name="secure-access-to-data-in-azure-cosmos-db"></a>Защита доступа к данным в Azure Cosmos DB

В этой статье приведены общие сведения о защите доступа к данным, хранящимся в [Microsoft Azure Cosmos DB](https://azure.microsoft.com/services/cosmos-db/).

Для проверки подлинности пользователей и предоставления доступа к своим данным и ресурсам Azure Cosmos DB использует два типа ключей. 

|Тип ключа|Ресурсы|
|---|---|
|[Главные ключи](#master-keys) |Используются для административных ресурсов: учетных записей базы данных, баз данных, пользователей и разрешений.|
|[Маркеры ресурсов](#resource-tokens)|Используются для ресурсов приложения: контейнеров, документов, вложений, хранимых процедур, триггеров и определяемых пользователем функций (UDF).|

<a id="master-keys"></a>

## <a name="master-keys"></a>Главные ключи 

Главные ключи предоставляют доступ ко всем административным ресурсам учетной записи базы данных. Главные ключи.  
- предоставляют доступ к учетным записям, базам данных, пользователям и разрешениям; 
- не могут использоваться для предоставления детального доступа к контейнерам и документам;
- создаются в процессе создания учетной записи;
- можно создать повторно в любое время.

Каждая учетная запись состоит из двух главных ключей: первичного и вторичного. Двойные ключи позволяют повторно создавать или сменять ключи, обеспечивая постоянный доступ к учетной записи и данным. 

Помимо двух главных ключей в учетной записи Cosmos DB существует еще два ключа только для чтения. Эти ключи разрешают только операции чтения в учетной записи. Ключи только для чтения не предоставляют доступ к ресурсам разрешений на чтение.

Главные ключи (первичные, вторичные, с доступом только для чтения и с доступом для чтения и записи) можно получить и повторно создать с помощью портала Azure. Дополнительные сведения см. в разделе [Просмотр, копирование и повторное создание ключей доступа](manage-with-cli.md#regenerate-account-key).

![Управление доступом (IAM) на портале Azure: демонстрация безопасности базы данных NoSQL](./media/secure-access-to-data/nosql-database-security-master-key-portal.png)

Процесс ротации главного ключа прост. Перейдите на портал Azure, чтобы получить вторичный ключ, затем замените первичный ключ вторичным ключом в приложении, а затем смените первичный ключ на портале Azure.

![Ротация главного ключа на портале Azure: демонстрация безопасности базы данных NoSQL](./media/secure-access-to-data/nosql-database-security-master-key-rotate-workflow.png)

### <a name="code-sample-to-use-a-master-key"></a>Пример кода для использования главного ключа

В следующем примере кода показано, как использовать конечную точку учетной записи Cosmos DB и главный ключ для создания экземпляра DocumentClient и построения базы данных. 

```csharp
//Read the Azure Cosmos DB endpointUrl and authorization keys from config.
//These values are available from the Azure portal on the Azure Cosmos DB account blade under "Keys".
//NB > Keep these values in a safe and secure location. Together they provide Administrative access to your DocDB account.

private static readonly string endpointUrl = ConfigurationManager.AppSettings["EndPointUrl"];
private static readonly string authorizationKey = ConfigurationManager.AppSettings["AuthorizationKey"];

client = new DocumentClient(new Uri(endpointUrl), authorizationKey);

// Create Database
Database database = await client.CreateDatabaseAsync(
    new Database
    {
        Id = databaseName
    });
```

<a id="resource-tokens"></a>

## <a name="resource-tokens"></a>Маркеры ресурсов

Маркеры ресурсов предоставляют доступ к ресурсам приложения в базе данных. Маркеры ресурсов.
- предоставляют доступ к определенным контейнерам, ключам секции, документам, вложениям, хранимым процедурам, триггерам и определяемым пользователем функциям (UDF);
- создаются, когда [пользователю](#users) предоставляются [разрешения](#permissions) на доступ к определенному ресурсу;
- создаются повторно, когда в отношении ресурса разрешения выполняется вызов POST, GET или PUT;
- используют хэш, который маркер ресурса специально создал для пользователя, ресурса и разрешения;
- имеют ограничение по времени (настраиваемый срок действия). Допустимый интервал времени по умолчанию составляет один час. Однако продолжительность действия маркера можно задать явным образом. Ее значение не должно превышать пять часов;
- обеспечивают безопасную альтернативу выдаче главного ключа; 
- позволяют клиентам читать, записывать и удалять ресурсы в учетной записи Cosmos DB в соответствии с предоставленными им разрешениями.

Маркер ресурсов можно использовать (создавая пользователей и разрешения Cosmos DB), если доступ к ресурсам в учетной записи Cosmos DB требуется предоставить клиенту, которому нельзя доверять.  

Маркеры ресурсов Cosmos DB — это безопасное альтернативное решение, которое позволяет клиентам читать, записывать и удалять ресурсы в учетной записи Cosmos DB согласно предоставленным разрешениям и без необходимости использовать главный ключ или ключ только для чтения.

Ниже приведена стандартная схема запроса, создания и отправки маркеров ресурсов клиентам.

1. Служба среднего уровня настроена для обслуживания мобильного приложения по обмену фотографиями. 
2. Служба среднего уровня обрабатывает главный ключ учетной записи Cosmos DB.
3. Приложение по обмену фотографиями устанавливается на мобильных устройствах конечных пользователей. 
4. При входе в систему приложение для обмена фотографиями идентифицирует пользователя службы. Механизм установления личности пользователя реализуется исключительно в приложении.
5. После установления личности служба среднего уровня запрашивает разрешения на основе удостоверения.
6. Служба среднего уровня отправляет маркер ресурса обратно в приложение для телефона.
7. Приложение может по-прежнему использовать маркер ресурса для прямого доступа к ресурсам Cosmos DB с разрешениями, определенными маркером, и в течение интервала времени, разрешенного этим маркером. 
8. По истечении срока действия маркера ресурса последующие запросы получают исключение: 401 — не авторизовано.  На этом этапе приложение для телефона повторно установит личность и запросит новый маркер ресурса.

    ![Рабочий процесс маркеров ресурсов Azure Cosmos DB](./media/secure-access-to-data/resourcekeyworkflow.png)

Создание маркеров ресурсов и управление ими осуществляется собственными клиентскими библиотеками Cosmos DB. Однако если используется REST, то необходимо создать заголовки запросов и проверки подлинности. Дополнительные сведения о создании заголовков проверки подлинности для REST см. в статье [Access control in the DocumentDB API](https://docs.microsoft.com/rest/api/cosmos-db/access-control-on-cosmosdb-resources) (Управление доступом в API DocumentDB) или в [репозитории исходного кода для наших пакетов SDK](https://github.com/Azure/azure-documentdb-node/blob/master/source/lib/auth.js).

Пример службы среднего уровня, используемой для создания маркеров ресурсов или в качестве брокера, см. в [репозитории приложения ResourceTokenBroker](https://github.com/Azure/azure-documentdb-dotnet/tree/master/samples/xamarin/UserItems/ResourceTokenBroker/ResourceTokenBroker/Controllers).

<a id="users"></a>

## <a name="users"></a>Пользователи
Cosmos DB пользователи связаны с базой данных Cosmos.  Каждая база данных может содержать несколько пользователей Cosmos DB или не содержать ни одного.  В следующем примере кода показано, как создать ресурс пользователя Cosmos DB.

```csharp
//Create a user.
User docUser = new User
{
    Id = "mobileuser"
};

docUser = await client.CreateUserAsync(UriFactory.CreateDatabaseUri("db"), docUser);
```

> [!NOTE]
> Каждый пользователь Cosmos DB обладает свойством PermissionsLink, которое можно использовать для получения списка [разрешений](#permissions), связанных с этим пользователем.
> 
> 

<a id="permissions"></a>

## <a name="permissions"></a>Разрешения
Ресурс разрешения Cosmos DB связан с пользователем Cosmos DB.  Каждый пользователь может иметь несколько разрешений Cosmos DB или не иметь ни одного.  Ресурс разрешения предоставляет доступ к маркеру безопасности, необходимому пользователю при попытке доступа к конкретному ресурсу приложения.
Существует два уровня доступа, предоставляемых ресурсом разрешения:

* Все. Пользователь имеет полный набор разрешений для ресурса.
* Чтение. Пользователь может только считывать содержимое ресурса, но не может выполнять на ресурсе операции записи, обновления или удаления.

> [!NOTE]
> Для выполнения хранимых процедур Cosmos DB пользователь должен иметь полные разрешения на использование контейнера, в котором будут выполняться хранимые процедуры.
> 
> 

### <a name="code-sample-to-create-permission"></a>Пример кода для создания разрешения

В следующем примере кода показано, как создать ресурс разрешения, прочесть его маркер и связать разрешения с созданным выше [пользователем](#users).

```csharp
// Create a permission.
Permission docPermission = new Permission
{
    PermissionMode = PermissionMode.Read,
    ResourceLink = UriFactory.CreateDocumentCollectionUri("db", "collection"),
    Id = "readperm"
};
  
docPermission = await client.CreatePermissionAsync(UriFactory.CreateUserUri("db", "user"), docPermission);
Console.WriteLine(docPermission.Id + " has token of: " + docPermission.Token);
```

Если вы указали ключ секции для коллекции, то разрешение для ресурсов коллекции, документа и вложения также должно включать ResourcePartitionKey наряду с ResourceLink.

### <a name="code-sample-to-read-permissions-for-user"></a>Пример кода для чтения разрешений пользователя

Чтобы получить все ресурсы разрешений, связанные с конкретным пользователем, Cosmos DB предоставляет каждому объекту пользователя доступ к каналу разрешений.  В следующем фрагменте кода показано, как получить разрешение, связанное с созданным выше пользователем, сформировать список разрешений и создать новый DocumentClient от имени пользователя.

```csharp
//Read a permission feed.
FeedResponse<Permission> permFeed = await client.ReadPermissionFeedAsync(
  UriFactory.CreateUserUri("db", "myUser"));
 List<Permission> permList = new List<Permission>();

foreach (Permission perm in permFeed)
{
    permList.Add(perm);
}

DocumentClient userClient = new DocumentClient(new Uri(endpointUrl), permList);
```

## <a name="add-users-and-assign-roles"></a>Добавление пользователей и назначение ролей

Чтобы добавить доступ с правами читателя учетной записи Azure Cosmos DB в пользовательскую учетную запись, владельцу подписки необходимо сделать следующее на портале Azure.

1. Откройте портал Azure и выберите учетную запись Azure Cosmos DB.
2. Щелкните вкладку **Управление доступом (IAM)** , а затем — **+ Добавить назначение ролей**.
3. На вкладке **Добавить назначение ролей** в поле **Роль** выберите **Роль читателя учетных записей Cosmos DB**.
4. В поле **Назначение доступа** выберите значение **Пользователь, группа или приложение Azure AD**.
5. В каталоге выберите пользователя, группу или приложение, которым нужно предоставить доступ.  Каталог можно искать по отображаемому имени, адресу электронной почты или идентификатору объектов.
    Выбранный пользователь, группа или приложение появятся в списке выбранных участников.
6. В нижней части страницы нажмите кнопку **Save**.

Теперь сущность может считывать ресурсы Azure Cosmos DB.

## <a name="delete-or-export-user-data"></a>Удаление и экспорт сведений о пользователях
Azure Cosmos DB позволяет искать, выбирать, изменять и удалять любые персональные данные, расположенные в базе данных или в коллекциях. Azure Cosmos DB предоставляет интерфейсы API для удаления персональных данных. Однако вы сами должны использовать эти интерфейсы API и определить логику, необходимую для удаления персональных данных. Каждый мультимодельный интерфейс API (SQL, MongoDB, Gremlin, Cassandra и API таблиц) предоставляет различные языковые пакеты SDK, содержащие методы для поиска и удаления персональных данных. Вы также можете включить функцию [срока жизни (TTL)](time-to-live.md) для автоматического удаления данных по истечении указанного периода времени без дополнительных затрат.

[!INCLUDE [GDPR-related guidance](../../includes/gdpr-dsr-and-stp-note.md)]

## <a name="next-steps"></a>Дальнейшие действия
* Дополнительные сведения о безопасности базы данных Cosmos см. в разделе [Cosmos DB: безопасность базы данных](database-security.md).
* Сведения о создании маркеров проверки подлинности Azure Cosmos DB см. в статье [Access control in the DocumentDB API](https://docs.microsoft.com/rest/api/cosmos-db/access-control-on-cosmosdb-resources) (Управление доступом в API DocumentDB).
