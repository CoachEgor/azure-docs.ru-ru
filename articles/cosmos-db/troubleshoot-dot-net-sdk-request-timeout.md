---
title: Устранение неполадок Azure Cosmos DB HTTP 408 или времени ожидания запроса с помощью пакета SDK для .NET
description: Как диагностировать и исправить исключение времени ожидания запроса пакета SDK для .NET
author: j82w
ms.service: cosmos-db
ms.date: 08/06/2020
ms.author: jawilley
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: a0469feed391025f8dd50a7f8b11b96265b0df29
ms.sourcegitcommit: 25bb515efe62bfb8a8377293b56c3163f46122bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87987415"
---
# <a name="diagnose-and-troubleshoot-azure-cosmos-db-net-sdk-request-timeout"></a>Диагностика и устранение неполадок Azure Cosmos DB время ожидания запроса пакета SDK для .NET
Ошибка HTTP 408 возникает, если пакету SDK не удалось выполнить запрос до наступления предельного времени ожидания.

## <a name="customizing-the-timeout-on-the-azure-cosmos-net-sdk"></a>Настройка времени ожидания в пакете SDK для .NET Cosmos для Azure

Пакет SDK имеет два разных варианта времени ожидания управления, каждый из которых имеет разную область.

### <a name="requesttimeout"></a>RequestTimeout

`CosmosClientOptions.RequestTimeout`Конфигурация (или `ConnectionPolicy.RequestTimeout` для пакета SDK версии 2) позволяет задать время ожидания, влияющее на каждый отдельный сетевой запрос.  Операция, запущенная пользователем, может охватывать несколько сетевых запросов (например, может потребоваться регулирование), и эта конфигурация будет применяться к каждому сетевому запросу при повторной попытке. Это не время ожидания запроса сквозной операции.

### <a name="cancellationtoken"></a>CancellationToken

Все асинхронные операции в пакете SDK имеют необязательный параметр CancellationToken. Эта [CancellationToken](https://docs.microsoft.com/dotnet/standard/threading/how-to-listen-for-cancellation-requests-by-polling) используется во всей операции по всем сетевым запросам. В пределах одного сетевого запроса CancellationToken может быть проверен, а операция отменяется, если истек срок действия связанного маркера. CancellationToken следует использовать для определения приблизительного ожидаемого времени ожидания в области действия операции.

> [!NOTE]
> CancellationToken — это механизм, при котором библиотека проверяет отмену, когда она [не вызывает недопустимого состояния](https://devblogs.microsoft.com/premier-developer/recommended-patterns-for-cancellationtoken/). Операция может не отменяться в точности, когда время, определенное в отмене, становится недоступным, но после того, как оно будет завершено, оно отменяется, когда это становится ненадежным.

## <a name="troubleshooting-steps"></a>Действия по устранению неполадок
Следующий список содержит известные причины и решения для исключений времени ожидания запроса.

### <a name="1-high-cpu-utilization-most-common-case"></a>1. Высокая загрузка ЦП (в большинстве случаев)
Для оптимальной задержки рекомендуется, чтобы загрузка ЦП составляла примерно 40%. Рекомендуется использовать 10 секунд в качестве интервала для наблюдения за максимальным (несредним) потреблением ресурсов ЦП. Пиковые нагрузки ЦП наиболее распространены с запросами между секциями, где они могут выполнять несколько подключений для одного запроса.

#### <a name="solution"></a>Решение:
Необходимо масштабировать клиентское приложение, использующее пакет SDK.

### <a name="2-socket--port-availability-might-be-low"></a>2. доступность сокета и порта может быть низкой
При работе в Azure клиенты, использующие пакет SDK для .NET, могут достичь нехватки портов Azure SNAT (PAT).

#### <a name="solution-1"></a>Решение 1.
Если вы используете виртуальные машины Azure, следуйте указаниям в разделе " [нехватка портов SNAT](troubleshoot-dot-net-sdk.md#snat)".

#### <a name="solution-2"></a>Решение 2.
Если вы используете службу приложений Azure, выполните [инструкции по устранению неполадок подключения](../app-service/troubleshoot-intermittent-outbound-connection-errors.md#cause) и [используйте диагностику службы приложений](https://azure.github.io/AppService/2018/03/01/Deep-Dive-into-TCP-Connections-in-App-Service-Diagnostics.html).

#### <a name="solution-3"></a>Решение 3.
При использовании прокси-сервера HTTP убедитесь, что он может поддерживать число подключений, указанное в свойстве `ConnectionPolicy` пакета SDK.
В противном случае возникнут проблемы с подключением.

### <a name="3-creating-multiple-client-instances"></a>3. Создание нескольких экземпляров клиента
Создание нескольких экземпляров клиента может привести к конфликтам соединений и времени ожидания.

#### <a name="solution"></a>Решение:
Следуйте [рекомендациям по повышению производительности](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage)и используйте один экземпляр космосклиент во всем процессе.

### <a name="4-hot-partition-key"></a>4. ключ горячей секции
Azure Cosmos DB распределяет общую пропускную способность равномерно по физическим секциям. При наличии критической секции один или несколько ключей логических секций в физическом разделе используют все единицы запросов к физическому разделу, в то время как единица запросов/с в других физических секциях не используется. В качестве симптома общее потребление единиц запросов в секунду будет меньше, чем общая подготовленная единица запросов/s в базе данных или контейнере, но вы по-прежнему увидите регулирование (429s) для запросов к ключу логической секции. Используйте [нормализованную метрику потребления на единицу](monitor-normalized-request-units.md) , чтобы определить, обнаруживается ли в рабочей нагрузке горячую секцию. 

#### <a name="solution"></a>Решение:
Выберите хороший ключ секции, который равномерно распределяет объем запросов и хранилище. Узнайте, как [изменить ключ секции](https://devblogs.microsoft.com/cosmosdb/how-to-change-your-partition-key/).

### <a name="5-high-degree-of-concurrency"></a>5. Высокая степень параллелизма
Приложение выполняет высокий уровень параллелизма, что может привести к состязанию в канале.

#### <a name="solution"></a>Решение:
Необходимо масштабировать клиентское приложение, использующее пакет SDK.

### <a name="6-large-requests-andor-responses"></a>6. большие запросы и ответы
Большие запросы или ответы могут привести к блокированию головного компьютера на основе усугубить, даже с относительно низкой степенью параллелизма.

#### <a name="solution"></a>Решение:
Необходимо масштабировать клиентское приложение, использующее пакет SDK.

### <a name="7-failure-rate-is-within-cosmos-db-sla"></a>7. Частота сбоев в рамках соглашения об уровне обслуживания Cosmos DB
Приложение должно иметь возможность обрабатывать временные сбои и при необходимости повторять попытку. 408. исключения не повторяются, так как при создании путей невозможно выяснить, создан ли элемент службой или нет. Повторная отправка одного и того же элемента для CREATE вызовет исключение конфликта. Бизнес-логика пользовательских приложений может иметь пользовательскую логику для обработки конфликтов, что приведет к нарушению неоднозначности существующего элемента и конфликта при повторном создании.

### <a name="8-failure-rate-is-violating-the-cosmos-db-sla"></a>8. Частота сбоев нарушает Cosmos DB соглашения об уровне обслуживания
Обратитесь в службу поддержки Azure.

## <a name="next-steps"></a>Дальнейшие действия
* [Диагностика и устранение неполадок](troubleshoot-dot-net-sdk.md) при использовании пакета SDK для Azure Cosmos DB .NET
* Сведения о рекомендациях по производительности для [.NET v3](performance-tips-dotnet-sdk-v3-sql.md) и [.NET v2](performance-tips.md)
