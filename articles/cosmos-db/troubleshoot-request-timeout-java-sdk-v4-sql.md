---
title: Устранение неполадок Azure Cosmos DB HTTP 408 или времени ожидания запроса с помощью пакета SDK для Java v4
description: Узнайте, как диагностировать и исправлять исключения времени ожидания запросов SDK для Java с помощью пакета SDK для Java версии 4.
author: kushagrathapar
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.date: 10/28/2020
ms.author: kuthapar
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 442d6638e88462b1dc87e9321dc631fe0a4f3a10
ms.sourcegitcommit: fa90cd55e341c8201e3789df4cd8bd6fe7c809a3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2020
ms.locfileid: "93340090"
---
# <a name="diagnose-and-troubleshoot-azure-cosmos-db-java-v4-sdk-request-timeout-exceptions"></a>Диагностика и устранение неполадок с Azure Cosmos DB исключениями времени ожидания запроса пакета SDK для Java версии 4
[!INCLUDE[appliesto-sql-api](includes/appliesto-sql-api.md)]

Ошибка HTTP 408 возникает, если пакету SDK не удалось выполнить запрос до наступления предельного времени ожидания.

## <a name="troubleshooting-steps"></a>Действия по устранению неполадок
Следующий список содержит известные причины и решения для исключений времени ожидания запроса.

### <a name="high-cpu-utilization"></a>Высокая загрузка ЦП
Высокая загрузка ЦП является наиболее распространенным вариантом. Для оптимальной задержки загрузка ЦП должна составлять примерно 40%. Используйте 10 секунд в качестве интервала для наблюдения за максимальным (несредним) потреблением ресурсов ЦП. Пиковые нагрузки ЦП наиболее распространены с запросами между секциями, где они могут выполнять несколько подключений для одного запроса.

#### <a name="solution"></a>Решение.
Клиентское приложение, использующее пакет SDK, должно быть увеличено или уменьшено.

### <a name="connection-throttling"></a>Регулирование подключения
Регулирование подключения может произойти из-за Ограничение числа подключений на узле или Нехватка портов SNAT (PAT) Azure.

### <a name="connection-limit-on-a-host-machine"></a>Ограничение числа подключений на узле
Некоторые системы Linux (например, Red Hat) имеют ограничение на общее число открытых файлов. Сокеты в Linux реализованы как файлы, поэтому это число также существенно ограничивает общее число подключений. Выполните следующую команду.

```bash
ulimit -a
```

#### <a name="solution"></a>Решение.
Максимально допустимое число открытых файлов, идентифицируемых как "нефайловая", должно быть не менее 10 000 или более. Дополнительные сведения см. в [советах по повышению производительности](performance-tips-java-sdk-v4-sql.md) для пакета SDK Java версии 4 для Azure Cosmos DB.

### <a name="socket-or-port-availability-might-be-low"></a>Доступность сокета или порта может быть низкой
При работе в Azure клиенты, использующие пакет SDK для Java, могут достичь нехватки портов Azure SNAT (PAT).

#### <a name="solution-1"></a>Решение 1.
Если вы используете виртуальные машины Azure, следуйте указаниям в разделе " [нехватка портов SNAT](troubleshoot-java-sdk-v4-sql.md#snat)".

#### <a name="solution-2"></a>Решение 2.
Если вы используете службу приложений Azure, выполните [инструкции по устранению неполадок подключения](../app-service/troubleshoot-intermittent-outbound-connection-errors.md#cause) и [используйте диагностику службы приложений](https://azure.github.io/AppService/2018/03/01/Deep-Dive-into-TCP-Connections-in-App-Service-Diagnostics.html).

#### <a name="solution-3"></a>Решение 3.
Если вы используете функции Azure, убедитесь, что вы отслеживаете [рекомендации Azure](../azure-functions/manage-connections.md#static-clients) по обслуживанию одноэлементных или статических клиентов для всех связанных служб (включая Azure Cosmos DB). Проверьте [ограничения службы](../azure-functions/functions-scale.md#service-limits) в зависимости от типа и размера размещения приложение-функция.

#### <a name="solution-4"></a>Решение 4.
При использовании прокси-сервера HTTP убедитесь, что он может поддерживать число подключений, указанное в свойстве `GatewayConnectionConfig` пакета SDK. В противном случае возникают проблемы с подключением.

### <a name="create-multiple-client-instances"></a>Создание нескольких экземпляров клиента
Создание нескольких экземпляров клиента может привести к конфликтам соединений и времени ожидания.

#### <a name="solution-1"></a>Решение 1.
Следуйте [рекомендациям по повышению производительности](performance-tips-java-sdk-v4-sql.md#sdk-usage)и используйте один экземпляр космосклиент для всего приложения.

#### <a name="solution-2"></a>Решение 2.
Если одноэлементное Космосклиент невозможно использовать в приложении, мы рекомендуем использовать общий доступ к подключению между несколькими клиентами Cosmos через этот API `connectionSharingAcrossClientsEnabled(true)` в космосклиент. При наличии нескольких экземпляров Cosmos Client в одном ВИРТУАЛЬНОЙ машины JAVAе, взаимодействующем с несколькими учетными записями Cosmos, включение этого параметра обеспечивает общий доступ к соединению в прямом режиме, если это возможно между экземплярами Cosmos Client. Обратите внимание, что при задании этого параметра Конфигурация подключения (например, Настройка времени ожидания сокета, Конфигурация времени ожидания простоя) для первого экземпляра клиента будет использоваться для всех остальных экземпляров клиента.

### <a name="hot-partition-key"></a>Ключ горячей секции
Azure Cosmos DB распределяет общую пропускную способность равномерно по физическим секциям. При наличии горячей секции один или несколько ключей логических секций в физическом разделе потребляют все единицы запросов физического раздела в секунду (единиц запроса/с). В то же время единицы запросов/s на других физических секциях будут недоступными. В качестве симптома общий объем занятых единиц запросов в секунду будет меньше, чем общая подготовленная единица запросов/s в базе данных или контейнере, но вы по-прежнему увидите регулирование (429s) в запросах к ключу горячей логической секции. Используйте [нормализованную метрику потребления на единицу](monitor-normalized-request-units.md) , чтобы определить, обнаруживается ли в рабочей нагрузке горячую секцию. 

#### <a name="solution"></a>Решение.
Выберите хороший ключ секции, который равномерно распределяет объем запросов и хранилище. Узнайте, как [изменить ключ секции](https://devblogs.microsoft.com/cosmosdb/how-to-change-your-partition-key/).

### <a name="high-degree-of-concurrency"></a>Высокая степень параллелизма
Приложение выполняет высокий уровень параллелизма, что может привести к состязанию в канале.

#### <a name="solution"></a>Решение.
Клиентское приложение, использующее пакет SDK, должно быть увеличено или уменьшено.

### <a name="large-requests-or-responses"></a>Большие запросы или ответы
Большие запросы или ответы могут привести к блокированию головного компьютера на основе усугубить, даже с относительно низкой степенью параллелизма.

#### <a name="solution"></a>Решение.
Клиентское приложение, использующее пакет SDK, должно быть увеличено или уменьшено.

### <a name="failure-rate-is-within-the-azure-cosmos-db-sla"></a>Частота сбоев в рамках соглашения об уровне обслуживания Azure Cosmos DB
Приложение должно иметь возможность обрабатывать временные сбои и при необходимости повторять попытку. Любые исключения 408 не повторяются, так как при создании путей невозможно определить, создан ли элемент службой. Повторная отправка одного и того же элемента для CREATE вызовет исключение конфликта. Бизнес-логика пользовательских приложений может иметь пользовательскую логику обработки конфликтов, что приведет к нарушению неоднозначности существующего элемента, а также конфликту при создании повторных попыток.

### <a name="failure-rate-violates-the-azure-cosmos-db-sla"></a>Частота сбоев нарушает Azure Cosmos DB соглашения об уровне обслуживания
Обратитесь в [службу поддержки Azure](https://aka.ms/azure-support).

## <a name="next-steps"></a>Дальнейшие шаги
* [Диагностика и устранение неполадок](troubleshoot-java-sdk-v4-sql.md) при использовании пакета SDK для Java версии 4 Azure Cosmos DB.
* Узнайте о рекомендациях по производительности для [Java v4](performance-tips-java-sdk-v4-sql.md).
