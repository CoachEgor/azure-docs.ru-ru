---
title: Глобальное распределение в Azure Cosmos DB — взгляд изнутри
description: Эта статья содержит технические сведения, относящиеся к глобальному распределению Azure Cosmos DB
author: dharmas-cosmos
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/23/2019
ms.author: dharmas
ms.reviewer: sngun
ms.openlocfilehash: c490657eb67a34e79c8dbaea31cb59b49cc6448e
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "66241094"
---
# <a name="global-data-distribution-with-azure-cosmos-db---under-the-hood"></a>Глобальное распределение данных в Azure Cosmos DB — взгляд изнутри

Azure Cosmos DB является базовой службы в Azure, поэтому оно развертывается во всех регионах Azure по всему миру, включая общедоступные, независимых, Министерства обороны (DoD) и облака для государственных организаций. В центре обработки данных мы развертываем службу Azure Cosmos DB и управляем ей на больших метках машин, каждая из которых имеет выделенное локальное хранилище. В центре обработки данных Azure Cosmos DB развертывается во многих кластерах, каждый из которых потенциально запускает несколько поколений оборудования. Машин в кластере обычно распределены 10 – 20 доменами сбоя для обеспечения высокой доступности в пределах региона. На следующем рисунке показана топология системы к использованию глобального распределения Cosmos DB.

![Топология системы](./media/global-dist-under-the-hood/distributed-system-topology.png)

**Комплексные возможности глобального распределения в Azure Cosmos DB —** В любое время, несколькими щелчками или программным способом с помощью одного вызова API можно добавить или удалить географических регионов, связанных с базой данных Cosmos. Базу данных Cosmos, в свою очередь, состоит из набора контейнеров Cosmos. В Cosmos DB контейнеры служат в качестве логических единиц распределения и масштабируемости. Коллекции, таблицы и диаграммы, которые вы создаете, являются (изнутри) просто контейнерами Cosmos. Контейнеры полностью без использования схем и указать область для запроса. Данные в контейнере Cosmos автоматически индексируются после приема. Автоматическое индексирование позволяет пользователям запрашивать данные без суеты, связанной с управлении схемами или индексами, особенно в глобально распределенной конфигурации.  

- В данном регионе, данные в контейнере распределяются с помощью ключа секции, которые обеспечивают и прозрачно управляет базовыми физическими секциями (*локальное распределение*).  

- Каждая физическая секция также реплицируется по географическим регионам (*Глобальное распределение*). 

Когда приложения с помощью Cosmos DB гибко масштабирует пропускную способность в контейнере Cosmos или потребляет больший объем хранилища, Cosmos DB прозрачно обрабатывает операции управления секциями (разделить, клонирование и удаление) во всех регионах. Независимо от масштабирования, распределения или ошибок, Cosmos DB предоставляет один образ системы данных в контейнерах, которые распределены по всему миру в любом количестве регионов.  

Как показано на следующем рисунке, данные в контейнере распределяются по двум измерениям — в пределах региона и регионах по всему миру:  

![Физические секции](./media/global-dist-under-the-hood/distribution-of-resource-partitions.png)

Физическая секция реализуется группу реплик, которые называются *набор реплик*. Каждая машина размещает сотни реплик, которые соответствуют различные физические секции в фиксированный набор процессов, как показано на рисунке выше. Реплики, соответствующие физическим секциям, динамически размещаются и распределяют нагрузки между машинами в кластере и центрах обработки данных в пределах региона.  

Реплика однозначно принадлежит клиенту Azure Cosmos DB. Каждая реплика содержит экземпляр [ядра СУБД](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf) Cosmos DB, который управляет ресурсами, а также соответствующими индексами. Ядро СУБД Cosmos DB работает на базе системы типов последовательности записей атомов (ARS). Подсистема не зависит от понятию схемы, размывая границу между значениями структуры и экземпляра записей. База данных Cosmos DB обеспечивает полную независимость от схемы, автоматически индексируя все при приеме эффективным образом, что позволяет пользователям запрашивать свои глобально распределенные данные без необходимости управлять схемой или индексом.

Ядро СУБД Cosmos состоит из компонентов, включая реализацию несколько примитивов координации, языковых сред выполнения, обработчик запросов и хранилища и индексации подсистем, отвечающим за хранение транзакций и индексирование данных, соответственно. Чтобы обеспечить устойчивость и высокую доступность, ядро СУБД сохраняет свои данные и индексы на дисках SSD и реплицирует их среди экземпляров ядра СУБД в наборах реплик соответственно. Больше клиентов соответствуют отличается более высокой масштабируемостью пропускной способности и хранилища и иметь либо больше или несколько реплик, или оба. Каждый компонент системы полностью асинхронен — ни один поток никогда не блокирует другой, и каждый поток работает кратковременно без каких-либо ненужных переключателей потоков. Ограничение скорости и обратной реакции передаются по всему стеку из контроля допуском на все каналы ввода-вывода. Ядро СУБД Cosmos предназначен для использования точного параллелизма и обеспечить высокую пропускную способность при работе в этом экономно расходовать объем системных ресурсов.

Глобальное распределение Cosmos DB использует две ключевые абстракции — *наборов реплик* и *наборы разделов*. Набор реплик представляет собой модульный блок "Лего" для координации, а набор секций — это динамическое наложение одного или нескольких географически распределенных физических секций. Чтобы понять, как работает глобальное распределение, необходимо понимать эти две ключевые абстракции. 

## <a name="replica-sets"></a>Наборы реплик

Физическая секция, которая материализуется как самоуправляемая и динамически сбалансированная по нагрузке группа реплик, распределенная между несколькими доменами сбоя, называется набором реплик. Этот набор совместно реализует протокол реплицированного состояния машины, чтобы сделать данные в физической секции доступными, устойчивыми и согласованными. Членство в наборе реплик *N* является динамическим — отслеживает подтверждающих *Nмин.* и *Nмакс.* на основе сбоев, административные операции и время не реплики, чтобы повторно создать ключ и восстановление. Исходя из изменений членства, протокол репликации также перенастраивает размер кворумов чтения и записи. Чтобы равномерно распределить пропускную способность, которой назначается данной физической секции, мы используем две идеи: 

- Во-первых затраты на обработку запросов записи на лидера больше, чем затраты на применение обновлений на следующим за блоком. Соответственно, лидеру предусмотрено больше системных ресурсов, чем подписчику. 

- Во-вторых, насколько это возможно, кворум чтения для заданного уровня согласованности состоит исключительно из реплик подписчиков. Мы избегаем контакта с лидером для выполнения операций чтения, если этого не требуется. Мы используем ряд идеи из исследований, проведенных в отношении объекта [нагрузка и производительность](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) в системах на основе кворума для [пять моделей согласованности](consistency-levels.md) , Cosmos DB поддерживает.  

## <a name="partition-sets"></a>Наборы секций

Для управления одинаковым набором ключей, реплицируются во всех регионах, настроенных состоит группы физических секций, по одной из каждого из настроенных с помощью области базы данных Cosmos. Вызывается этот выше примитив координации *набор секций* -географически динамического наложения физических секций, управление данного набора ключей. Во время данной физической секции (реплика), ограничено в кластере, наборе секций может охватывать несколько кластеров, центры обработки данных и географических регионов, как показано на рисунке ниже:  

![Наборы секций](./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png)

Набор секций можно считать географически распределенным "супернабором реплик", который состоит из нескольких наборов реплик, обладающих тем же набором ключей. Как и в наборе реплик, секции набора также является динамической — он изменяется в зависимости от операции управления неявное физической секции, добавлять и удалять новые секции, и из заданного набора разделов (например, если горизонтальное масштабирование пропускной способности контейнер, добавить или удалить регион, к базе данных Cosmos, или при сбоях). В силу наличия каждой секции (секции набор) управления членством в наборе секций в свой собственный набор реплик, членство — это полностью децентрализованной и высокой доступности. Во время перенастройки набора секций также устанавливается топология наложения между физическими секциями. Топология динамически выбирается на основе уровня согласованности, географического расстояния и доступную пропускную способность сети между источником и целевой физические секции.  

Служба позволяет настроить базы данных Cosmos либо с одним регистром записи, либо с несколькими регионами записи, и в зависимости от выбора наборы секций настроены так, чтобы принимать записи в только одном или во всех регионах. Система использует двухуровневый протокол на основе консенсуса — один уровень работает в репликах набора реплик физической секции, принимая записи, а другой работает на уровне набора секций, чтобы обеспечить полные гарантии упорядочения для всех зафиксированных записей в наборе секций. Этот многоуровневый вложенный консенсус имеет решающее значение для реализации наших строгих соглашений об уровне обслуживания для обеспечения высокой доступности, а также для реализации моделей согласованности, которые предлагает Cosmos DB своим клиентам.  

## <a name="conflict-resolution"></a>Разрешение конфликтов

Наша разработка для распространения обновлений, разрешения конфликтов и отслеживания причинности основана на предыдущей работе над [алгоритмами эпидемии](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) и системой [Bayou](https://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf). Хотя ядра идей сохранились и предоставляют удобную систему отсчета для создания структуры системы Cosmos DB, они также значительно изменились, когда их применяли к системе Cosmos DB. Это было необходимо, так как в предыдущих систем были разработаны с ресурсами, ни вместе со шкалой, по которому Cosmos DB требуется для работы, а также для обеспечения возможности (например, согласованность с ограниченным устареванием) и строгие и комплексные соглашения об уровне обслуживания, Cosmos DB предоставляет своим клиентам.  

Помните, что набор секций распределяется по нескольким регионам и следует за протоколом репликации Cosmos DB (с несколькими источниками) для репликации данных между физическими секциями, содержащими заданный набор секций. Каждая физическая секция (из набора секций) принимает записи и обычно служит для чтения клиентам из этого региона. Записи, принятые физической секцией в регионе, надежно зафиксированы и сделаны высокодоступными в пределах физической секции, прежде чем быть подтвержденными для клиента. Эти предварительные записи распространяются на другие физические секции в наборе секций с помощью канала защиты от энтропии. Клиенты могут запрашивать либо предварительные, либо зафиксированные записи путем передачи заголовка запроса. Распространение защиты от энтропии (включая частоту распространения) является динамическим, основанным на топологии набора секций, региональной близости физических секций и настроенном уровне согласованности. В наборе секций Cosmos DB следует первичной схеме фиксации с динамически выбранной секцией арбитра. Выбор арбитра динамический. Он является неотъемлемой частью перенастройки набора секций на основе топологии наложения. Заказы зафиксированных записей (включая многострочные или пакетные обновления) гарантируются. 

Мы используем закодированные векторные часы (содержащие идентификатор региона и логические часы, соответствующие каждому уровню консенсуса в наборе реплик и наборе секций соответственно) для отслеживания причинно-следственных связей и версий векторов, чтобы обнаружить и разрешить конфликты обновления. Топология и алгоритм выбора одноранговых узлов предназначены для обеспечения фиксированного и минимального хранения и минимальных нагрузок на сеть версий векторов. Алгоритм гарантирует строгое свойство конвергенции.  

Для баз данных Cosmos, настроенных с несколькими регионами записи, система предлагает ряд гибких политик автоматического разрешения конфликтов для разработчиков на выбор, включая следующие. 

- **Побеждает последний-записи (LWW)** , который, по умолчанию используется свойство системные метки времени (который основан на протоколе синхронизации времени часов). Cosmos DB также позволяет указать любое другое пользовательское числовое свойство, которое будет использоваться для разрешения конфликтов.  
- **Политика разрешения конфликтов определяемые приложением (пользовательский)** (выражена с помощью процедуры слиянием), разработанный для выверки семантики прикладного конфликтов. Эти процедуры вызываются при обнаружении конфликтов "запись — запись" во время обработки транзакции в базе данных на стороне сервера. Система предоставляет ровно один раз гарантирует для выполнения процедуры слияния как часть обязательства протокола. Существуют [несколько конфликтуют примеры разрешение](how-to-manage-conflicts.md) можно поиграть.  

## <a name="consistency-models"></a>Модели согласованности

Ли настройка базы данных Cosmos с помощью одного или нескольких регионах записи, можно выбрать из пяти четко определенных моделей согласованности. С использованием нескольких регионов записи ниже приведены некоторые важные аспекты уровней согласованности.  

Согласованность с ограниченным устареванием гарантирует, что все операции чтения будут в пределах *K* префиксы или *T* секунд из последней записи в любом из регионов. Кроме того операции чтения, согласованность с ограниченным устареванием гарантированно монотонными и гарантирует согласованность префиксов. Протокол защиты от энтропии работает с ограничением скорости и гарантирует, что префиксы не накапливаются и обратная реакция при записи не применяется. Гарантии согласованности сеанса монотонного чтения, монотонной записи чтения ваших собственных записей, записи выполняется чтение» и «согласованного префикса гарантии, по всему миру. Для баз данных, настроенных со строгой согласованностью преимущества нескольких регионах записи (записи низкой задержки, записи высокий уровень доступности) не применяется, из-за Синхронная репликация между регионами.

Семантика пятью моделями согласованности в Cosmos DB описаны [здесь](consistency-levels.md)и математически описываются с помощью высокого уровня спецификации TLA + [здесь](https://github.com/Azure/azure-cosmos-tla).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о том, как настроить политики глобального распределения, можно узнать в приведенных ниже статьях.

* [Добавление и удаление регионов из учетной записи базы данных](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [Configure clients for multi-homing](how-to-manage-database-account.md#configure-multiple-write-regions) (Настройка клиентов для поддержки нескольких веб-сайтов)
* [Как создать политику разрешения конфликтов](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy)
