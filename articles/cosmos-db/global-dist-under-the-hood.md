---
title: Глобальное распределение в Azure Cosmos DB — взгляд изнутри
description: Эта статья содержит технические сведения, относящиеся к глобальному распределению Azure Cosmos DB
author: SnehaGunda
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 12/02/2019
ms.author: sngun
ms.reviewer: sngun
ms.openlocfilehash: a46a69476a2ad6550bc7b3a533fd09565d461db3
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "74872134"
---
# <a name="global-data-distribution-with-azure-cosmos-db---under-the-hood"></a>Глобальное распределение данных в Azure Cosmos DB — взгляд изнутри

Azure Cosmos DB является фундаментальной службой в Azure, поэтому она развернута во всех регионах Azure по всему миру, включая публичные, суверенные, Министерство обороны (МО) и правительственные облака. В центре обработки данных мы развертываем службу Azure Cosmos DB и управляем ей на больших метках машин, каждая из которых имеет выделенное локальное хранилище. В центре обработки данных Azure Cosmos DB развертывается во многих кластерах, каждый из которых потенциально запускает несколько поколений оборудования. Машины в кластере обычно распределены по 10-20 доменотам неисправностей для высокой доступности в пределах региона. На следующем рисунке показана топология системы к использованию глобального распределения Cosmos DB.

![Топология системы](./media/global-dist-under-the-hood/distributed-system-topology.png)

**Глобальное распространение в Azure Cosmos DB является "под ключ":** В любое время, с помощью нескольких кликов или программно с помощью одного вызова API, вы можете добавить или удалить географические регионы, связанные с базой данных Cosmos. База данных «Космос», в свою очередь, состоит из набора контейнеров «Космос». В Cosmos DB контейнеры служат в качестве логических единиц распределения и масштабируемости. Коллекции, таблицы и диаграммы, которые вы создаете, являются (изнутри) просто контейнерами Cosmos. Контейнеры полностью схема-агностик и обеспечивают область возможности для запроса. Данные в контейнере Cosmos автоматически индексируются после приема. Автоматическая индексация позволяет пользователям задаваемые данные без проблем с схемой или управления индексом, особенно в глобально распределенной установке.  

- В данном регионе данные в контейнере распространяются с помощью ключа раздела, который вы предоставляете и прозрачно управляется базовыми физическими разделами *(местное распределение).*  

- Каждый физический раздел также реплицируется в географических регионах *(глобальное распределение).* 

Когда приложение с использованием Cosmos DB упруго масштабирует пропускную емкость в контейнере Cosmos или потребляет больше памяти, Cosmos DB прозрачно обрабатывает операции управления разделами (разделить, клонировать, удалить) во всех регионах. Независимо от масштабирования, распределения или ошибок, Cosmos DB предоставляет один образ системы данных в контейнерах, которые распределены по всему миру в любом количестве регионов.  

Как показано на следующем изображении, данные в контейнере распределяются по двум измерениям - в пределах региона и между регионами по всему миру:  

![Физические секции](./media/global-dist-under-the-hood/distribution-of-resource-partitions.png)

Физическая раздела реализуется группой реплик, называемой *набором реплики.* Каждая машина содержит сотни реплик, которые соответствуют различным физическим перегородок в рамках фиксированного набора процессов, как показано на изображении выше. Реплики, соответствующие физическим секциям, динамически размещаются и распределяют нагрузки между машинами в кластере и центрах обработки данных в пределах региона.  

Реплика однозначно принадлежит клиенту Azure Cosmos DB. Каждая реплика содержит экземпляр [ядра СУБД](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf) Cosmos DB, который управляет ресурсами, а также соответствующими индексами. Двигатель базы данных Cosmos работает на системе типа atom-record-sequence (ARS). Двигатель агностичен по понятию схемы, стирая границу между структурой и значениями экземпляра записей. База данных Cosmos DB обеспечивает полную независимость от схемы, автоматически индексируя все при приеме эффективным образом, что позволяет пользователям запрашивать свои глобально распределенные данные без необходимости управлять схемой или индексом.

Движок базы данных Cosmos состоит из компонентов, включая реализацию нескольких примитивов координации, время выполнения языка, процессор запроса, а также подсистемы хранения и индексирования, ответственные за транзакционное хранение и индексирование данных, Соответственно. Чтобы обеспечить устойчивость и высокую доступность, ядро СУБД сохраняет свои данные и индексы на дисках SSD и реплицирует их среди экземпляров ядра СУБД в наборах реплик соответственно. Большие арендаторы соответствуют более высокому масштабу пропускной памяти и хранения и имеют либо больше или больше реплик или обоих. Каждый компонент системы полностью асинхронен — ни один поток никогда не блокирует другой, и каждый поток работает кратковременно без каких-либо ненужных переключателей потоков. Ограничение скорости и обратной реакции передаются по всему стеку из контроля допуском на все каналы ввода-вывода. Двигатель базы данных Cosmos предназначен для использования мелкозернистой параллелизма и обеспечения высокой пропускной всей работы при работе в пределах скромных системных ресурсов.

Глобальное распределение Cosmos DB опирается на две ключевые абстракции - *наборы реплик* и *наборы разделов.* Набор реплик представляет собой модульный блок "Лего" для координации, а набор секций — это динамическое наложение одного или нескольких географически распределенных физических секций. Чтобы понять, как работает глобальное распределение, необходимо понимать эти две ключевые абстракции. 

## <a name="replica-sets"></a>Наборы реплик

Физическая секция, которая материализуется как самоуправляемая и динамически сбалансированная по нагрузке группа реплик, распределенная между несколькими доменами сбоя, называется набором реплик. Этот набор совместно реализует протокол реплицированного состояния машины, чтобы сделать данные в физической секции доступными, устойчивыми и согласованными. Членство в наборе реплики *n* является динамичным – оно продолжает колебаться между *NMin* и *NMax* на основе сбоев, административных операций и времени для неудачных реплик для регенерации/восстановления. Исходя из изменений членства, протокол репликации также перенастраивает размер кворумов чтения и записи. Для равномерного распределения пропускной перевалки, назначенной данному физическому разделу, мы используем две идеи: 

- Во-первых, стоимость обработки запросов на запись лидера выше, чем стоимость применения обновлений на последователя. Соответственно, лидеру предусмотрено больше системных ресурсов, чем подписчику. 

- Во-вторых, насколько это возможно, кворум чтения для заданного уровня согласованности состоит исключительно из реплик подписчиков. Мы избегаем контакта с лидером для выполнения операций чтения, если этого не требуется. Мы используем ряд идей из исследований, проведенных по взаимосвязи [нагрузки и емкости](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) в системах, основанных на кворуме, для [пяти моделей согласованности,](consistency-levels.md) которые поддерживает Cosmos DB.  

## <a name="partition-sets"></a>Наборы секций

Группа физических разделов, по одному из каждой из регионов базы данных Космоса, состоит для управления одним и тем же набором ключей, реплицированных во всех настроенных регионах. Эта более высокая координация примитивная называется *набором разделов* - географически распределенным динамическим наложением физических перегородок, управляющих данном набором ключей. В то время как данный физический раздел (набор реплик) приспозирован в кластере, набор разделов может охватывать кластеры, центры обработки данных и географические регионы, как показано на рисунке ниже:  

![Наборы секций](./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png)

Набор секций можно считать географически распределенным "супернабором реплик", который состоит из нескольких наборов реплик, обладающих тем же набором ключей. Как и в наборе реплик, членство в наборе разделов также является динамическим – он колеблется на основе неявных операций управления физическими перегородками для добавления/удаления новых разделов в/из заданного набора разделов (например, при масштабировании пропускной записи на контейнере, добавлении/удалении области в базу данных «Космос» или при возникновении сбоев). В силу того, что каждый из разделов (набор разделов) управляет членством в наборе разделов в рамках своего собственного набора реплик, членство полностью децентрализовано и весьма доступно. Во время перенастройки набора секций также устанавливается топология наложения между физическими секциями. Топология динамически подобрана на основе уровня согласованности, географического расстояния и доступной пропускной способности сети между источником и целевыми физическими перегородками.  

Служба позволяет настроить базы данных Cosmos либо с одним регистром записи, либо с несколькими регионами записи, и в зависимости от выбора наборы секций настроены так, чтобы принимать записи в только одном или во всех регионах. Система использует двухуровневый протокол на основе консенсуса — один уровень работает в репликах набора реплик физической секции, принимая записи, а другой работает на уровне набора секций, чтобы обеспечить полные гарантии упорядочения для всех зафиксированных записей в наборе секций. Этот многоуровневый вложенный консенсус имеет решающее значение для реализации наших строгих соглашений об уровне обслуживания для обеспечения высокой доступности, а также для реализации моделей согласованности, которые предлагает Cosmos DB своим клиентам.  

## <a name="conflict-resolution"></a>Устранение конфликтов

Наша разработка для распространения обновлений, разрешения конфликтов и отслеживания причинности основана на предыдущей работе над [алгоритмами эпидемии](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) и системой [Bayou](https://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf). Хотя ядра идей сохранились и предоставляют удобную систему отсчета для создания структуры системы Cosmos DB, они также значительно изменились, когда их применяли к системе Cosmos DB. Это было необходимо, потому что предыдущие системы не были разработаны ни с управлением ресурсами, ни с масштабами, в которых Космос DB должен работать, ни для обеспечения возможностей (например, ограниченной последовательности черствости) и строгие и комплексные SLAs, которые Cosmos DB поставляет своим клиентам.  

Помните, что набор секций распределяется по нескольким регионам и следует за протоколом репликации Cosmos DB (с несколькими источниками) для репликации данных между физическими секциями, содержащими заданный набор секций. Каждая физическая секция (из набора секций) принимает записи и обычно служит для чтения клиентам из этого региона. Записи, принятые физической секцией в регионе, надежно зафиксированы и сделаны высокодоступными в пределах физической секции, прежде чем быть подтвержденными для клиента. Эти предварительные записи распространяются на другие физические секции в наборе секций с помощью канала защиты от энтропии. Клиенты могут запрашивать либо предварительные, либо зафиксированные записи путем передачи заголовка запроса. Распространение защиты от энтропии (включая частоту распространения) является динамическим, основанным на топологии набора секций, региональной близости физических секций и настроенном уровне согласованности. В наборе секций Cosmos DB следует первичной схеме фиксации с динамически выбранной секцией арбитра. Выбор арбитра динамический. Он является неотъемлемой частью перенастройки набора секций на основе топологии наложения. Заказы зафиксированных записей (включая многострочные или пакетные обновления) гарантируются. 

Мы используем закодированные векторные часы (содержащие идентификатор региона и логические часы, соответствующие каждому уровню консенсуса в наборе реплик и наборе секций соответственно) для отслеживания причинно-следственных связей и версий векторов, чтобы обнаружить и разрешить конфликты обновления. Топология и алгоритм выбора одноранговых узлов предназначены для обеспечения фиксированного и минимального хранения и минимальных нагрузок на сеть версий векторов. Алгоритм гарантирует строгое свойство конвергенции.  

Для баз данных Cosmos, настроенных с несколькими регионами записи, система предлагает ряд гибких политик автоматического разрешения конфликтов для разработчиков на выбор, включая следующие. 

- **Last-Write-Wins (LWW),** который по умолчанию использует свойство временной метки, определяемое системой (основанное на протоколе синхронизации времени). Cosmos DB также позволяет указать любое другое пользовательское числовое свойство, которое будет использоваться для разрешения конфликтов.  
- **Политика разрешения конфликтов, определяемая приложением (Custom)** (выраженная с помощью процедур слияния), которая предназначена для семантики, определяемой приложениями, сверки конфликтов. Эти процедуры вызываются при обнаружении конфликтов "запись — запись" во время обработки транзакции в базе данных на стороне сервера. Система предоставляет ровно один раз гарантию выполнения процедуры слияния в рамках протокола обязательств. Есть [несколько образцов разрешения конфликтов](how-to-manage-conflicts.md) доступны для вас, чтобы играть.  

## <a name="consistency-models"></a>Модели согласованности

Настраиваемый ли вы базу данных Cosmos с помощью одного или нескольких регионов записи, можно выбрать из пяти четко определенных моделей согласованности. С несколькими регионами записи, ниже приведены некоторые заметные аспекты уровней согласованности:  

Ограниченная последовательность застоя гарантирует, что все считывания будут в пределах префиксов *K* или *T* секунд от последней записи в любом из регионов. Кроме того, считываемые с ограниченной постоянством согласованности гарантированно будут монотонные и с последовательными гарантиями префикса. Протокол защиты от энтропии работает с ограничением скорости и гарантирует, что префиксы не накапливаются и обратная реакция при записи не применяется. Последовательность сеанса гарантирует монотонные читать, монотонные писать, читать свои собственные письма, писать следует читать, и последовательные гарантии префикса, во всем мире. Для баз данных, настроенных с сильной согласованностью, преимущества (низкая задержка записи, высокая доступность записи) нескольких регионов записи не применяются из-за синхронной репликации в разных регионах.

Семантика пяти моделей согласованности в Cosmos DB описана [здесь](consistency-levels.md)и математически описана с использованием высокоуровневых [here](https://github.com/Azure/azure-cosmos-tla)спецификаций TLA.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о том, как настроить политики глобального распределения, можно узнать в приведенных ниже статьях.

* [Добавление и удаление регионов из учетной записи базы данных](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [Configure clients for multi-homing](how-to-manage-database-account.md#configure-multiple-write-regions) (Настройка клиентов для поддержки нескольких веб-сайтов)
* [Как создать пользовательскую политику разрешения конфликтов](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy)
