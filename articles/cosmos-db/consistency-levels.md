---
title: Уровни согласованности в Azure Cosmos DB
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/06/2020
ms.openlocfilehash: aa09b1ec1e3f73547d211fab0907c9e3388c008b
ms.sourcegitcommit: 3792cf7efc12e357f0e3b65638ea7673651db6e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91445328"
---
# <a name="what-are-consistency-levels-in-azure-cosmos-db"></a>Что такое уровни согласованности в Azure Cosmos DB?

Репликация распределенных баз данных для обеспечения высокого уровня их доступности и низкой задержки предполагает компромисс между согласованностью чтения и такими параметрами, как доступность, время задержки и пропускная способность. Большинство коммерческих доступных распределенных баз данных запрашивают от разработчиков выбор между двумя экстремальными моделями согласованности: *строгая* согласованность и *Окончательная* согласованность. Линеаризации модели строгой согласованности является золотым стандартом программирования данных. Но при этом добавляется цена более высокой задержки записи (в стабильном состоянии) и снижается доступность (во время сбоев). С другой стороны, окончательная согласованность обеспечивает более высокую доступность и лучшую производительность, но затрудняет программирование приложений.

В Azure Cosmos DB согласованность данных рассматривается как плавный спектр возможных вариантов, а не две крайности. Разработчики могут использовать эти параметры для обеспечения точного выбора и детального компромисса относительно высокого уровня доступности и производительности.

С помощью Azure Cosmos DB разработчики могут выбрать один из пяти четко определенных уровней согласованности для спектра согласованности. К этим уровням относятся *строгая*, *ограниченная устаревания*, *сеанс*, *согласованный префикс*и *Окончательная* согласованность. Уровни четко определены и понятны и могут использоваться для конкретных реальных сценариев. Каждый уровень предоставляет [компромиссы по доступности и производительности](consistency-levels-tradeoffs.md) , а также поддерживает соглашения об уровне обслуживания. На следующем рисунке показаны различные уровни согласованности в качестве спектра.

:::image type="content" source="./media/consistency-levels/five-consistency-levels.png" alt-text="Согласованность как спектр" border="false" :::

Уровни согласованности не зависят от региона и гарантированно выполняются для всех операций независимо от региона, из которого обслуживаются операции чтения и записи, число регионов, связанных с учетной записью Cosmos Azure, или для вашей учетной записи настроен один или несколько регионов записи.

## <a name="scope-of-the-read-consistency"></a>Область согласованности данных при чтении

Согласованность чтения применяется к одной операции чтения, ограниченной в пределах логической секции. Операции чтения могут выдаваться удаленным клиентом или хранимой процедурой.

## <a name="configure-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию

Уровень согласованности по умолчанию в учетной записи Azure Cosmos DB можно настроить в любое время. Уровень согласованности по умолчанию, настроенный для учетной записи, применяется ко всем базам данных и контейнерам Azure Cosmos в этой учетной записи. Все операции чтения и запросы к контейнеру или базе данных будут по умолчанию использовать указанный уровень согласованности. Дополнительные сведения см.в статье [о настройке уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level). Вы также можете переопределить уровень согласованности по умолчанию для конкретного запроса. Дополнительные сведения см. в разделе [Переопределение статьи уровня согласованности по умолчанию](how-to-manage-consistency.md?#override-the-default-consistency-level) .

## <a name="guarantees-associated-with-consistency-levels"></a>Гарантии, связанные с уровнями согласованности

Комплексные соглашения об уровне обслуживания, предоставляемые Azure Cosmos DB, гарантируют соблюдение гарантий согласованности выбранного уровня для 100 % запросов на чтение. Запрос на чтение соответствует соглашению об уровне обслуживания, если удовлетворяются гарантии согласованности, связанные с выбранным уровнем согласованности. Точные определения пяти уровней согласованности в Azure Cosmos DB, использующих язык спецификации TLA +, приведены в репозитории GitHub [Azure-Cosmos-TLA](https://github.com/Azure/azure-cosmos-tla) .

Ниже описана семантика этих пяти уровней согласованности.

- **Strong**: строгая согласованность обеспечивает гарантию линеаризации. Линеаризации означает одновременное обслуживание запросов. Все операции чтения гарантированно возвращают последнюю версию элемента. Клиент никогда не увидит не зафиксированную или частично измененную запись. Пользователь всегда гарантированно сможет прочесть последнюю зафиксированную запись.

  На следующем рисунке показана строгая согласованность с музыкальными примечаниями. После того как данные записываются в регион "Западная часть США 2", при чтении данных из других регионов вы получаете Последнее значение:

  :::image type="content" source="media/consistency-levels/strong-consistency.gif" alt-text="Согласованность как спектр":::

- **Ограниченное устаревание**: операции чтения гарантированно учитывают гарантию соответствия префиксов. Операции чтения могут отставать от операций записи по большинству версий *"K"* (то есть "обновления") элемента или по *"T"* интервалу времени, в зависимости от того, что достигнуто первым. Иными словами, при выборе ограниченного устаревания можно настроить «устаревания» двумя способами.

- Число версий элемента (*K*)
- Интервал времени (*T*), на который операции чтения могут отставать от записи

Ограниченная устаревшая версия предлагает общий глобальный порядок за пределами "окна устаревания". Если клиент выполняет операции чтения в регионе, который принимает записи, то гарантии, обеспечиваемые согласованностью ограниченного устаревания, идентичны этим гарантиям строгой согласованности.

В окне устаревания ограничения ограниченного устаревания обеспечивают следующие гарантии согласованности.

- Согласованность для клиентов в одном регионе для учетной записи с одним главным узлом = strong
- Согласованность для клиентов в разных регионах для одной учетной записи с одним главным узлом = согласованный префикс
- Согласованность для клиентов, записывающих в один регион для учетной записи с несколькими хозяевами = согласованный префикс
- Согласованность для клиентов, записывающих в разные регионы для учетной записи с несколькими хозяевами = в конечном итоге

  Ограниченное устаревание часто выбирается глобально распределенными приложениями, которые предполагают низкую задержку при записи, но нуждаются в общей гарантии глобального порядка. Ограниченное устаревание подходит для приложений, использующих совместную работу групп и совместного использования, биржевых котировок, публикации-подписки и очереди и т. д. На следующем рисунке показана согласованность ограниченного устаревания с музыкальными примечаниями. После того как данные записываются в регион "Западная часть США 2", регионы "Восточная часть США 2" и "Восточная Австралия" считывают записанное значение на основе заданного максимального времени запаздывания или максимального числа операций:

  :::image type="content" source="media/consistency-levels/bounded-staleness-consistency.gif" alt-text="Согласованность как спектр" или совместного использования маркера сеанса для нескольких модулей записи.

Клиенты за пределами сеанса, выполняющего операции записи, увидят следующие гарантии:

- Согласованность для клиентов в одном регионе для учетной записи с одним главным узлом = согласованный префикс
- Согласованность для клиентов в разных регионах для одной учетной записи с одним главным узлом = согласованный префикс
- Согласованность для клиентов, записывающих в один регион для учетной записи с несколькими хозяевами = согласованный префикс
- Согласованность для клиентов, записывающих в несколько регионов для учетной записи с несколькими хозяевами = в конечном итоге

  Согласованность сеансов — это наиболее широко используемый уровень согласованности как для одного региона, так и для глобально распределенных приложений. Она обеспечивает задержку записи, доступность и пропускную способность чтения, сравнимую с учетом окончательной согласованности, но также предоставляет гарантии согласованности, которые соответствуют потребностям приложений, написанных для работы в контексте пользователя. На следующем рисунке показана согласованность сеанса с музыкальными примечаниями. Модуль записи «Западная часть США 2» и модуль чтения «Западная часть США 2» используют один сеанс (сеанс а), чтобы они одновременно читали одни и те же данные. В то время как регион "Восточная Австралия" использует сеанс б, он получает данные позже, но в том же порядке, что и записи.

  :::image type="content" source="media/consistency-levels/session-consistency.gif" alt-text="Согласованность как спектр":::

- **Последовательный префикс**. возвращаемые обновления содержат некоторые префиксы всех обновлений без пробелов. Согласованность префиксного уровня согласованности гарантирует, что операции чтения никогда не увидят неупорядоченные операции записи.

Если операции записи выполнялись в указанном порядке `A, B, C` , то клиент видит либо, `A` `A,B` либо, `A,B,C` но не все неупорядоченные перестановки, такие как `A,C` или `B,A,C` . Последовательный префикс обеспечивает задержку записи, доступность и пропускную способность чтения, сравнимую с конечной согласованностью, но также предоставляет гарантии порядка, которые соответствуют потребностям сценариев, в которых важен порядок. 

Ниже приведены гарантии согласованности для согласованного префикса:

- Согласованность для клиентов в одном регионе для учетной записи с одним главным узлом = согласованный префикс
- Согласованность для клиентов в разных регионах для одной учетной записи с одним главным узлом = согласованный префикс
- Согласованность для клиентов, записывающих в один регион для учетной записи с несколькими хозяевами = согласованный префикс
- Согласованность для клиентов, записывающих в несколько регионов для учетной записи с несколькими хозяевами = в конечном итоге

На следующем рисунке показана согласованность префикса согласованности с музыкальными примечаниями. Во всех регионах операции чтения никогда не видят неупорядоченные записи:

  :::image type="content" source="media/consistency-levels/consistent-prefix.gif" alt-text="Согласованность как спектр" или несвязанные комментарии. На следующем рисунке показана окончательная согласованность с музыкальными примечаниями.

  :::image type="content" source="media/consistency-levels/eventual-consistency.gif" alt-text="Согласованность как спектр":::

## <a name="additional-reading"></a>Дополнительные материалы

Дополнительные сведения об основных понятиях согласованности можно найти в следующих статьях.

- [High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB](https://github.com/Azure/azure-cosmos-tla) (Высокоуровневые спецификации TLA+ для пяти уровней согласованности, предлагаемых Azure Cosmos DB)
- [Согласованность реплицируемых данных, объясненная через бейсбольную (видео) Дуг Терри](https://www.youtube.com/watch?v=gluIh8zd26I)
- [Согласованность реплицируемых данных, объясненная через бейсбольный (технический документ) с помощью Дуг Терри](https://www.microsoft.com/research/publication/replicated-data-consistency-explained-through-baseball/)
- [Session guarantees for weakly consistent replicated data](https://dl.acm.org/citation.cfm?id=383631) (Гарантии на уровне сеанса для слабо согласованных реплицированных данных)
- [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is only part of the story](https://www.computer.org/csdl/magazine/co/2012/02/mco2012020037/13rRUxjyX7k) (Компромиссы согласованности в современных распределенных системах проектирования баз данных: теорема CAP — это только начало)
- [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](https://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
- [Eventually Consistent - Revisited](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html) (Итоговая согласованность. Пересмотрено)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об уровнях согласованности в Azure Cosmos DB можно найти в следующих статьях.

- [Выбор правильного уровня согласованности для приложения](consistency-levels-choosing.md)
- [Уровни согласованности и API для Azure Cosmos DB](consistency-levels-across-apis.md)
- [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
- [Настройка уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level)
- [Переопределение уровня согласованности по умолчанию](how-to-manage-consistency.md#override-the-default-consistency-level)
