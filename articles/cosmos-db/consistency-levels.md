---
title: Уровни согласованности в Azure Cosmos DB
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 07/23/2019
ms.openlocfilehash: b5d9df7a0afa9b4270f0eff643e083e5bccfceb8
ms.sourcegitcommit: e6bce4b30486cb19a6b415e8b8442dd688ad4f92
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2020
ms.locfileid: "78933721"
---
# <a name="consistency-levels-in-azure-cosmos-db"></a>Уровни согласованности в Azure Cosmos DB

Репликация распределенных баз данных для обеспечения высокого уровня их доступности и низкой задержки предполагает компромисс между согласованностью чтения и такими параметрами, как доступность, время задержки и пропускная способность. Большинство коммерческих доступных распределенных баз данных запрашивают от разработчиков выбор между двумя экстремальными моделями согласованности: *строгая* согласованность и *Окончательная* согласованность. Линеаризации или модель строгой согласованности — Золотое стандартное программирование данных. Но он добавляет цену более высокой задержки (в стабильном состоянии) и снижает доступность (во время сбоев). С другой стороны, окончательная согласованность обеспечивает более высокую доступность и лучшую производительность, но затрудняет программирование приложений. 

В Azure Cosmos DB согласованность данных рассматривается как плавный спектр возможных вариантов, а не две крайности. Строгая согласованность и окончательная согласованность находятся на концах спектра, но существует множество вариантов согласованности по спектру. Разработчики могут использовать эти параметры для обеспечения точного выбора и детального компромисса относительно высокого уровня доступности и производительности. 

В Azure Cosmos DB разработчики могут выбрать любую из пяти четко определенных моделей согласованности, распределенных по спектру согласованности. С самого высокого до более ослабленные модели включают *строгие*, *ограниченные устаревания*, *сеанс*, *согласованный префикс*и *окончательную* согласованность. Модели четко определены и понятны и могут использоваться в конкретных реальных сценариях. Каждая модель предоставляет [компромиссы по доступности и производительности](consistency-levels-tradeoffs.md) , а также поддерживает соглашения об уровне обслуживания. На следующем рисунке показаны различные уровни согласованности в качестве спектра.

![Согласованность как спектр](./media/consistency-levels/five-consistency-levels.png)

Уровни согласованности не зависят от региона и гарантированно выполняются для всех операций независимо от региона, из которого обслуживаются операции чтения и записи, число регионов, связанных с вашей учетной записью Azure Cosmos, или настроена ли для вашей учетной записи одна или несколько регионов записи.

## <a name="scope-of-the-read-consistency"></a>Область согласованности данных при чтении

Согласованность данных при чтении применяется к одной операции чтения в пределах диапазона ключа секции или логического раздела. Операции чтения могут выдаваться удаленным клиентом или хранимой процедурой.

## <a name="configure-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию

Уровень согласованности по умолчанию в учетной записи Azure Cosmos DB можно настроить в любое время. Уровень согласованности по умолчанию, настроенный для учетной записи, применяется ко всем базам данных и контейнерам Azure Cosmos в этой учетной записи. Все операции чтения и запросы к контейнеру или базе данных будут по умолчанию использовать указанный уровень согласованности. Дополнительные сведения см.в статье [о настройке уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level).

## <a name="guarantees-associated-with-consistency-levels"></a>Гарантии, связанные с уровнями согласованности

Комплексные соглашения об уровне обслуживания, предоставляемые Azure Cosmos DB, гарантируют соблюдение гарантий согласованности выбранного уровня для 100 % запросов на чтение. Запрос на чтение соответствует соглашению об уровне обслуживания, если удовлетворяются гарантии согласованности, связанные с выбранным уровнем согласованности. Точные определения пяти уровней согласованности в Azure Cosmos DB, использующих язык спецификации TLA +, приведены в репозитории GitHub [Azure-Cosmos-TLA](https://github.com/Azure/azure-cosmos-tla) .

Ниже описана семантика этих пяти уровней согласованности.

- **Strong**: строгая согласованность обеспечивает гарантию линеаризации. Линеаризации означает одновременное обслуживание запросов. Все операции чтения гарантированно возвращают последнюю версию элемента. Клиент никогда не увидит не зафиксированную или частично измененную запись. Пользователь всегда гарантированно сможет прочесть последнюю зафиксированную запись.

  На следующем рисунке показана строгая согласованность с музыкальными примечаниями. После того как данные записываются в регион "Восточная часть США", при чтении данных из других регионов вы получаете Последнее значение:

  ![video](media/consistency-levels/strong-consistency.gif)

- **Ограниченное устаревание**: операции чтения гарантированно учитывают гарантию соответствия префиксов. Операции чтения могут отставать от операций записи по большинству версий *"K"* (то есть "обновления") элемента или по *"T"* интервалу времени. Иными словами, при выборе ограниченного устаревания можно настроить «устаревания» двумя способами. 

  * Число версий элемента (*K*)
  * Интервал времени (*T*), на который операции чтения могут отставать от записи 

  Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Гарантии для монотонных операций чтения в регионе соблюдаются как в пределах "окна устаревания", так и вне его. Строгая согласованность имеет ту же семантику, что и та, что обусловлена ограниченным устареваниями. но с нулевым "окном устаревания". Ограниченное устаревание также называется отложенной во времени линеаризацией. Если клиент выполняет операции чтения в регионе, который принимает записи, то гарантии, обеспечиваемые согласованностью ограниченного устаревания, идентичны этим гарантиям строгой согласованности.

  Ограниченное устаревание часто выбирается глобально распределенными приложениями, которые предполагают низкую задержку при записи, но нуждаются в общей гарантии глобального порядка. Ограниченное устаревание подходит для приложений, использующих совместную работу групп и совместного использования, биржевых котировок, публикации-подписки и очереди и т. д. На следующем рисунке показана согласованность ограниченного устаревания с музыкальными примечаниями. После того как данные записываются в регион "Восточная часть США", регионы "Западная часть США" и "Восточная Австралия" считывают записанное значение на основе заданного максимального времени запаздывания или максимального числа операций:

  ![video](media/consistency-levels/bounded-staleness-consistency.gif)

- **Сеанс**: в рамках одного сеанса клиента гарантируется соблюдение согласованного префикса (при условии, что используется один сеанс записи), монотонные операции чтения, монотонные операции записи, чтение-запись и операции чтения. Клиенты за пределами сеанса, выполняющего операции записи, увидят окончательную согласованность.

  Согласованность сеансов — это широко используемый уровень согласованности как для одного региона, так и для глобально распределенных приложений. Она обеспечивает задержку записи, доступность и пропускную способность чтения, сравнимую с учетом окончательной согласованности, но также предоставляет гарантии согласованности, которые соответствуют потребностям приложений, написанных для работы в контексте пользователя. На следующем рисунке показана согласованность сеанса с музыкальными примечаниями. Регион "Западная часть США" и регионы "Восточная часть США" используют один сеанс (сеанс а), чтобы они одновременно читали данные. В то время как регион "Восточная Австралия" использует сеанс б, он получает данные позже, а в том же порядке, что и записи.

  ![video](media/consistency-levels/session-consistency.gif)

- **Последовательный префикс**. возвращаемые обновления содержат некоторые префиксы всех обновлений без пробелов. Согласованность префиксного уровня согласованности гарантирует, что чтение никогда не будет видеть неупорядоченные операции записи.

  Если операции записи выполнялись в порядке `A, B, C`, то клиент видит `A`, `A,B` или `A,B,C`, но никогда не видит неупорядоченные операции `A,C` или `B,A,C`. Последовательный префикс обеспечивает задержку записи, доступность и пропускную способность чтения, сравнимую с конечной согласованностью, но также предоставляет гарантии порядка, которые соответствуют потребностям сценариев, в которых важен порядок. На следующем рисунке показана согласованность префикса согласованности с музыкальными примечаниями. Во всех регионах операции чтения никогда не видят неупорядоченные записи:

  ![video](media/consistency-levels/consistent-prefix.gif)

- В **конечном итоге**: нет гарантий по упорядочиванию для операций чтения. При отсутствии последующих операций записи все реплики в конечном счете сходятся.  
Окончательная согласованность — это слабая форма согласованности, так как клиент может считывать более старые значения, чем те, которые были считаны ранее. Окончательная согласованность идеально подходит для того, чтобы приложение не требовало никаких гарантий упорядочения. Примерами могут служить число ретвитов, разметки "нравится" или несвязанные комментарии. На следующем рисунке показана окончательная согласованность с музыкальными примечаниями.

  ![video](media/consistency-levels/eventual-consistency.gif)

## <a name="additional-reading"></a>Дополнительные материалы

Дополнительные сведения об основных понятиях согласованности можно найти в следующих статьях.

- [High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB](https://github.com/Azure/azure-cosmos-tla) (Высокоуровневые спецификации TLA+ для пяти уровней согласованности, предлагаемых Azure Cosmos DB)
- [Replicated Data Consistency Explained through Baseball (video) by Doug Terry](https://www.youtube.com/watch?v=gluIh8zd26I) (Видео. Объяснение согласованности реплицированных данных на примере бейсбола, автор Даг Терри)
- [Replicated Data Consistency Explained through Baseball (whitepaper) by Doug Terry](https://www.microsoft.com/en-us/research/publication/replicated-data-consistency-explained-through-baseball/?from=http%3A%2F%2Fresearch.microsoft.com%2Fpubs%2F157411%2Fconsistencyandbaseballreport.pdf) (Документ. Объяснение согласованности реплицированных данных на примере бейсбола, автор Даг Терри)
- [Session guarantees for weakly consistent replicated data](https://dl.acm.org/citation.cfm?id=383631) (Гарантии на уровне сеанса для слабо согласованных реплицированных данных)
- [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is only part of the story](https://www.computer.org/csdl/magazine/co/2012/02/mco2012020037/13rRUxjyX7k) (Компромиссы согласованности в современных распределенных системах проектирования баз данных: теорема CAP — это только начало)
- [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](https://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
- [Eventually Consistent - Revisited](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html) (Итоговая согласованность. Пересмотрено)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об уровнях согласованности в Azure Cosmos DB можно найти в следующих статьях.

* [Выбор правильного уровня согласованности для приложения](consistency-levels-choosing.md)
* [Уровни согласованности и API для Azure Cosmos DB](consistency-levels-across-apis.md)
* [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
* [Настройка уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level)
* [Переопределение уровня согласованности по умолчанию](how-to-manage-consistency.md#override-the-default-consistency-level)

