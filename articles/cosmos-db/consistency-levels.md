---
title: Уровни согласованности в Azure Cosmos DB
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 03/18/2020
ms.openlocfilehash: 4e3d29471064616039bf946bb2762c15ce67bf8d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79530263"
---
# <a name="consistency-levels-in-azure-cosmos-db"></a>Уровни согласованности в Azure Cosmos DB

Репликация распределенных баз данных для обеспечения высокого уровня их доступности и низкой задержки предполагает компромисс между согласованностью чтения и такими параметрами, как доступность, время задержки и пропускная способность. Большинство коммерчески доступных распределенных баз данных просят разработчиков выбирать между двумя крайними моделями согласованности: *сильной* согласованностью и *возможной* согласованностью. Линия или сильная модель согласованности является золотым стандартом программируемости данных. Но это добавляет цену более высокой задержки (в устойчивом состоянии) и снижение доступности (во время сбоев). С другой стороны, конечная согласованность обеспечивает более высокую доступность и более высокую производительность, но затрудняет программирование приложений. 

В Azure Cosmos DB согласованность данных рассматривается как плавный спектр возможных вариантов, а не две крайности. Сильная последовательность и конечная последовательность находятся на концах спектра, но есть много вариантов последовательности по всему спектру. Разработчики могут использовать эти опции для принятия точных решений и подробных компромиссов в отношении высокой доступности и производительности. 

В Azure Cosmos DB разработчики могут выбрать любую из пяти четко определенных моделей согласованности, распределенных по спектру согласованности. От сильнейших до более расслабленным, модели включают в себя *сильные,* *ограниченные черствость*, *сессия*, *последовательная префикс*, и *в конечном итоге* последовательность. Модели четко определены и интуитивно понятны и могут быть использованы для конкретных реальных сценариев. Каждая модель обеспечивает [доступность и производительность компромиссов](consistency-levels-tradeoffs.md) и опирается на SLAs. Следующее изображение показывает различные уровни согласованности в качестве спектра.

![Согласованность как спектр](./media/consistency-levels/five-consistency-levels.png)

Уровни согласованности являются регионастами и гарантированы для всех операций, независимо от региона, из которого обслуживаются считывания и записи, количества регионов, связанных с вашей учетной записью Azure Cosmos, или же ваша учетная запись настроена с одной или несколько регионов записи.

## <a name="scope-of-the-read-consistency"></a>Область согласованности данных при чтении

Согласованность данных при чтении применяется к одной операции чтения в пределах диапазона ключа секции или логического раздела. Операции чтения могут выдаваться удаленным клиентом или хранимой процедурой.

## <a name="configure-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию

Уровень согласованности по умолчанию в учетной записи Azure Cosmos DB можно настроить в любое время. Уровень согласованности по умолчанию, настроенный в вашей учетной записи, применяется ко всем базам данных Azure Cosmos и контейнерам, наданным в этой учетной записи. Все операции чтения и запросы к контейнеру или базе данных будут по умолчанию использовать указанный уровень согласованности. Дополнительные сведения см.в статье [о настройке уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level).

## <a name="guarantees-associated-with-consistency-levels"></a>Гарантии, связанные с уровнями согласованности

Комплексные соглашения об уровне обслуживания, предоставляемые Azure Cosmos DB, гарантируют соблюдение гарантий согласованности выбранного уровня для 100 % запросов на чтение. Запрос на чтение соответствует соглашению об уровне обслуживания, если удовлетворяются гарантии согласованности, связанные с выбранным уровнем согласованности. Точные определения пяти уровней согласованности в Azure Cosmos DB с использованием языка спецификации TLA, приведены в [репо Azure-cosmos-tla](https://github.com/Azure/azure-cosmos-tla) GitHub.

Ниже описана семантика этих пяти уровней согласованности.

- **Сильный**: Сильная последовательность предлагает гарантию linearizability. Linearizability относится к одновременному обслуживанию запросов. Все операции чтения гарантированно возвращают последнюю версию элемента. Клиент никогда не увидит не зафиксированную или частично измененную запись. Пользователь всегда гарантированно сможет прочесть последнюю зафиксированную запись.

  Следующий график иллюстрирует сильную согласованность с музыкальными нотами. После того, как данные будут записаны в регион "West US 2", при чтении данных из других регионов вы получаете последнее значение:

  ![video](media/consistency-levels/strong-consistency.gif)

- **Bounded staleness**: Чтения гарантированы в честь гарантии последовательной префикса. Чтения могут отставать от записей в большинстве *"K"* версии (т.е. "обновления") элемента или *"T"* интервал времени. Другими словами, когда вы выбираете ограниченность черствости, "застойность" может быть настроена двумя способами: 

  * Количество версий *(K*) элемента
  * Интервал времени (*T),* по которому считывания могут отставать от записей 

  Согласованность с ограниченным устареванием обеспечивает общий глобальный порядок в пределах "окна устаревания". Гарантии для монотонных операций чтения в регионе соблюдаются как в пределах "окна устаревания", так и вне его. Сильная консистенция имеет ту же семантику, что и та, которая предлагается ограниченной черствостью. но с нулевым "окном устаревания". Ограниченное устаревание также называется отложенной во времени линеаризацией. Когда клиент выполняет операции чтения в регионе, который принимает записи, гарантии, предоставляемые ограниченной последовательность застоя идентичны идентичны тем, что гарантирует сильную согласованность.

  Ограниченной устаревшей часто выбирают глобально распределенные приложения, которые ожидают низких просрлизмов, но требуют полной гарантии глобального порядка. Ограниченное устаревание отлично подходит для приложений, отличающихся групповым сотрудничеством и обменом, биржевым тикером, подпиской/очередями и т.д. Следующий график иллюстрирует ограниченную застойность консистенции с музыкальными нотами. После того, как данные будут записаны в регион «Запад США 2», регионы «Восток США 2» и «Австралия Восток» считывают письменное значение, основанное на настроенном максимальном времени задержки или максимальных операциях:

  ![video](media/consistency-levels/bounded-staleness-consistency.gif)

- **Сессия**: В рамках одной сессии клиента читает гарантированно соблюдать последовательной префикс (при условии одного "писатель" сессии), монотонные читает, монотонные пишет, читать-ваш-пишет, и писать-следует-читает гарантии. Клиенты вне сеанса, выполняющие записи, увидят конечную согласованность.

  Последовательность сеансов является широко используемым уровнем согласованности как для одного региона, так и для глобально распределенных приложений. Он обеспечивает просечение записи, доступность и пропускную способность чтения, сопоставимое с возможной согласованностью, но также обеспечивает гарантии согласованности, которые удовлетворяют потребностям приложений, написанных для работы в контексте пользователя. Следующий график иллюстрирует соответствие сеанса музыкальным нотам. Регионы «Западные США 2» и регионы «Восток США 2» используют одну и ту же сессию (сессия А), поэтому они оба читают данные одновременно. В то время как регион "Австралия Восток" использует "Сессия B", так, он получает данные позже, но в том же порядке, что и пишет.

  ![video](media/consistency-levels/session-consistency.gif)

- **Последовательная префикс**: Обновления, которые возвращаются содержат некоторые префиксы всех обновлений, без каких-либо пробелов. Последовательная префиксная согласованность гарантирует, что чтение никогда не видит вне порядка записывает.

  Если операции записи выполнялись в порядке `A, B, C`, то клиент видит `A`, `A,B` или `A,B,C`, но никогда не видит неупорядоченные операции `A,C` или `B,A,C`. Последовательная префикс обеспечивает просечения записи, доступность и пропускную способность чтения, сопоставимые с возможной согласованностью, а также обеспечивает гарантии заказа, которые соответствуют потребностям сценариев, где порядок важен. Следующий график иллюстрирует согласованность префикса согласованности с музыкальными нотами. Во всех регионах, читает никогда не видеть из строя пишет:

  ![video](media/consistency-levels/consistent-prefix.gif)

- **Eventual**: Нет гарантии заказа для чтения. При отсутствии последующих операций записи все реплики в конечном счете сходятся.  
Eventual consistency является самой слабой формой согласованности, поскольку клиент может читать значения, которые старше тех, которые он читал раньше. Eventual consistency идеально подходит там, где приложение не требует каких-либо гарантий заказа. Примеры включают количество ретвитов, отеков или комментариев без потока. Следующий график иллюстрирует окончательную согласованность с музыкальными нотами.

  ![video](media/consistency-levels/eventual-consistency.gif)

## <a name="additional-reading"></a>Дополнительные материалы

Дополнительные сведения об основных понятиях согласованности можно найти в следующих статьях.

- [High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB](https://github.com/Azure/azure-cosmos-tla) (Высокоуровневые спецификации TLA+ для пяти уровней согласованности, предлагаемых Azure Cosmos DB)
- [Репликация последовательность данных объясняется через бейсбол (видео) Дуг Терри](https://www.youtube.com/watch?v=gluIh8zd26I)
- [Репликация последовательность данных объясняется через бейсбол (белая бумага) Дуг Терри](https://www.microsoft.com/en-us/research/publication/replicated-data-consistency-explained-through-baseball/?from=http%3A%2F%2Fresearch.microsoft.com%2Fpubs%2F157411%2Fconsistencyandbaseballreport.pdf)
- [Session guarantees for weakly consistent replicated data](https://dl.acm.org/citation.cfm?id=383631) (Гарантии на уровне сеанса для слабо согласованных реплицированных данных)
- [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is only part of the story](https://www.computer.org/csdl/magazine/co/2012/02/mco2012020037/13rRUxjyX7k) (Компромиссы согласованности в современных распределенных системах проектирования баз данных: теорема CAP — это только начало)
- [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](https://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
- [Eventually Consistent - Revisited](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html) (Итоговая согласованность. Пересмотрено)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об уровнях согласованности в Azure Cosmos DB можно найти в следующих статьях.

* [Выбор правильного уровня согласованности для приложения](consistency-levels-choosing.md)
* [Уровни согласованности и API для Azure Cosmos DB](consistency-levels-across-apis.md)
* [Достижение компромисса между доступностью и быстродействием для разных уровней согласованности](consistency-levels-tradeoffs.md)
* [Настройка уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level)
* [Переопределение уровня согласованности по умолчанию](how-to-manage-consistency.md#override-the-default-consistency-level)

