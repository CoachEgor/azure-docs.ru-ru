---
title: Настройка брандмауэра IP-адресов для учетной записи Azure Cosmos DB
description: Узнайте, как настроить политики управления доступом на основе IP-адресов для включения поддержки брандмауэра в учетных записях базы данных Azure Cosmos DB.
author: markjbrown
ms.service: cosmos-db
ms.topic: sample
ms.date: 05/23/2019
ms.author: mjbrown
ms.openlocfilehash: 24ebc7eb4c9abc72a89419611e4b4b3fa2db88b4
ms.sourcegitcommit: 509e1583c3a3dde34c8090d2149d255cb92fe991
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2019
ms.locfileid: "66241963"
---
# <a name="configure-ip-firewall-in-azure-cosmos-db"></a>Настройка брандмауэра IP-адресов в Azure Cosmos DB

Вы можете защитить данные, хранимые в учетной записи Azure Cosmos DB, с помощью брандмауэров IP-адресов. Для фильтрации входящего трафика Azure Cosmos DB поддерживает политики управления доступом на основе IP-адресов. Брандмауэр IP-адресов можно настроить в учетной записи Azure Cosmos DB любым из следующих способов:

* на портале Azure;
* декларативно с помощью шаблона Azure Resource Manager;
* программным способом, изменив значение свойства **ipRangeFilter** с помощью Azure CLI или Azure PowerShell.

## <a id="configure-ip-policy"></a> Настройка брандмауэра IP-адресов с помощью портала Azure

Чтобы настроить политику контроля доступа на основе IP-адресов на портале Azure, перейдите на страницу учетной записи Azure Cosmos DB и выберите в меню навигации **Брандмауэр и виртуальные сети**. Измените значение параметра **Разрешить доступ из**, указав **Выбранные сети**, и нажмите **Сохранить**. 

![Снимок экрана, показывающий, как открыть страницу "Брандмауэр" на портале Azure](./media/how-to-configure-firewall/azure-portal-firewall.png)

При включенном контроле доступа на основе IP-адресов портал Azure предоставляет возможность указать IP-адреса, диапазоны IP-адресов и параметры. Параметры обеспечивают доступ к другим службам Azure и порталу Azure. Сведения об этих параметрах приведены в указанных ниже разделах.

> [!NOTE]
> После включения политики контроля доступа на основе IP-адресов для учетной записи Azure Cosmos DB отклоняются все запросы к этой учетной записи Azure Cosmos DB с компьютеров, IP-адреса которых не входят в список диапазонов разрешенных IP-адресов. В соответствии с этой политикой также блокируется возможность просмотра ресурсов Azure Cosmos DB на портале.

### <a name="allow-requests-from-the-azure-portal"></a>Разрешение запросов на портале Azure

Чтобы программным способом обеспечить доступ к порталу Azure при включении политики управления доступом на основе IP-адресов, необходимо добавить его IP-адрес к свойству **ipRangeFilter**. IP-адрес портала:

|Регион|IP-адрес|
|------|----------|
|Германия|51.4.229.218|
|Китай|139.217.8.252|
|Штат в США (для обслуживания государственных организаций США)|52.244.48.71|
|Все другие регионы|104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26|

Вы можете включить доступ к порталу Azure, установив флажок **Разрешить доступ с портала Azure**, как показано на следующем снимке экрана: 

![Снимок экрана, показывающий, как разрешить доступ к порталу Azure](./media/how-to-configure-firewall/enable-azure-portal.png)

### <a name="allow-requests-from-global-azure-datacenters-or-other-sources-within-azure"></a>Разрешение запросов от глобальных центров обработки данных Azure или других источников в пределах Azure

Если вы выполняете доступ к учетной записи Azure Cosmos DB из служб, которые не предоставляют статический IP-адрес (например, Azure Stream Analytics и "Функции Azure"), вы все равно можете использовать брандмауэр IP-адресов для ограничения доступа. Чтобы разрешить доступ к учетной записи Azure Cosmos DB из таких служб, добавьте IP-адрес 0.0.0.0 в список разрешенных IP-адресов. Адрес 0.0.0.0 разрешает запросы к учетной записи Azure Cosmos DB только из диапазона IP-адресов центров обработки данных Azure. Этот параметр неприменим для получения доступа к учетной записи Azure Cosmos DB из других диапазонов IP-адресов.

> [!NOTE]
> Этот параметр настраивает брандмауэр на разрешение всех запросов из Azure, в том числе из подписок других пользователей, развернутых в Azure. Этот параметр разрешает большой список IP-адресов, что существенно снижает эффективность политики брандмауэра. Его следует использовать, только если запросы будут поступать из расположений без статических IP-адресов или подсетей в виртуальных сетях. При выборе этого варианта автоматически разрешается доступ с портала Azure, так как сам портал Azure развернут в Azure.

Вы можете включить доступ к порталу Azure, установив флажок **Разрешить подключения из общедоступных центров обработки данных Azure**, как показано на следующем снимке экрана: 

![Снимок экрана, показывающий, как открыть страницу "Брандмауэр" на портале Azure](./media/how-to-configure-firewall/enable-azure-services.png)

### <a name="requests-from-your-current-ip"></a>Запросы с текущего IP-адреса

Для упрощения разработки портал Azure помогает определить и добавить IP-адрес клиентского компьютера в список разрешенных адресов. Приложения, работающие на вашем компьютере, смогут после этого получить доступ к учетной записи Azure Cosmos DB. 

Портал автоматически определяет IP-адрес клиента. Это может быть IP-адрес клиента вашего компьютера или сетевого шлюза. Удалите этот IP-адрес, прежде чем переносить рабочие нагрузки в рабочую среду. 

Чтобы добавить текущий IP-адрес в список IP-адресов, выберите **Добавить мой текущий IP-адрес**. Затем нажмите кнопку **Save** (Сохранить).

![Снимок экрана, показывающий, как настроить параметры брандмауэра текущего IP-адреса](./media/how-to-configure-firewall/enable-current-ip.png)

### <a name="requests-from-cloud-services"></a>Запросы из облачных служб

В Azure облачные службы — это стандартный способ размещения логики службы среднего уровня с помощью Azure Cosmos DB. Чтобы разрешить доступ к учетной записи Azure Cosmos DB из облачной службы, обязательно добавьте общедоступный IP-адрес этой службы в список разрешенных IP-адресов, связанных с используемой учетной записью Azure Cosmos DB. Для этого [настройте политику контроля доступа на основе IP-адресов](#configure-ip-policy). Так вы предоставите всем экземплярам ролей облачных служб доступ к учетной записи Azure Cosmos DB. 

IP-адреса для ваших облачных служб можно получить на портале Azure, как показано на следующем снимке экрана:

![Снимок экрана с общедоступным IP-адресом для облачной службы на портале Azure](./media/how-to-configure-firewall/public-ip-addresses.png)

При расширении облачной службы за счет добавления экземпляров ролей каждый новый экземпляр автоматически получит доступ к учетной записи Azure Cosmos DB, так как он входит в ту же облачную службу.

### <a name="requests-from-virtual-machines"></a>Запросы из виртуальных машин

Можно использовать также [виртуальные машины](https://azure.microsoft.com/services/virtual-machines/) или [масштабируемые наборы виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) для размещения служб среднего уровня с помощью Azure Cosmos DB. Чтобы настроить доступ к учетной записи Cosmos DB из виртуальных машин, включите общедоступные IP-адреса этих виртуальных машин и (или) масштабируемого набора виртуальных машин в список разрешенных IP-адресов для этой учетной записи. Для этого [настройте политику контроля доступа на основе IP-адресов](#configure-ip-policy). 

IP-адреса для виртуальных машин можно узнать на портале Azure, как показано на следующем снимке экрана:

![Снимок экрана с общедоступным IP-адресом для виртуальной машины на портале Azure](./media/how-to-configure-firewall/public-ip-addresses-dns.png)

Добавленные в группу экземпляры виртуальных машин автоматически получают доступ к учетной записи Azure Cosmos DB.

### <a name="requests-from-the-internet"></a>Запросы из Интернета

Если вы выполняете доступ к учетной записи Azure Cosmos DB с компьютера через Интернет, необходимо добавить IP-адрес или диапазон IP-адресов клиента этого компьютера в список разрешенных IP-адресов для этой учетной записи.

## <a id="configure-ip-firewall-arm"></a>Настройка брандмауэра IP-адресов с помощью шаблона Resource Manager

Чтобы настроить контроль доступа к учетной записи Azure Cosmos DB, обязательно укажите в шаблоне Resource Manager атрибут **ipRangeFilter** со списком диапазонов разрешеннных IP-адресов. Например, добавьте в шаблон следующий код JSON:

```json
   {
     "apiVersion": "2015-04-08",
     "type": "Microsoft.DocumentDB/databaseAccounts",
     "kind": "GlobalDocumentDB",
     "name": "[parameters('databaseAccountName')]",
     "location": "[resourceGroup().location]",
     "properties": {
       "databaseAccountOfferType": "Standard",
       "name": "[parameters('databaseAccountName')]",
       "ipRangeFilter":"183.240.196.255,104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26"
     }
   }
```

## <a id="configure-ip-firewall-cli"></a>Настройка политики контроля доступа на основе IP-адресов с помощью интерфейса командной строки Azure

Следующая команда демонстрирует, как создать учетную запись Azure Cosmos DB с использованием контроля доступа на основе IP-адресов: 

```azurecli-interactive

name="<Azure Cosmos DB account name>"
resourceGroupName="<Resource group name>"

az cosmosdb create \
  --name $name \
  --kind GlobalDocumentDB \
  --resource-group $resourceGroupName \
  --max-interval 10 \
  --max-staleness-prefix 200 \
  --ip-range-filter "183.240.196.255,104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26"
```

Чтобы изменить параметры брандмауэра для существующей учетной записи, выполните следующую команду:

```azurecli-interactive
az cosmosdb update \
      --name $name \
      --resource-group $resourceGroupName \
      --ip-range-filter "183.240.196.255,104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26"
```

## <a id="configure-ip-firewall-ps"></a>Настройка политики контроля доступа на основе IP-адресов с помощью PowerShell

Следующий сценарий демонстрирует, как создать учетную запись Azure Cosmos DB с использованием контроля доступа на основе IP-адресов:

```azurepowershell-interactive

$resourceGroupName = "myResourceGroup"
$accountName = "myaccountname"

$locations = @(
    @{ "locationName"="West US"; "failoverPriority"=0 },
    @{ "locationName"="East US"; "failoverPriority"=1 }
)

# Add local machine's IP address to firewall, InterfaceAlias is your Network Adapter's name
$ipRangeFilter = Get-NetIPConfiguration | Where-Object InterfaceAlias -eq "Ethernet 2" | Select-Object IPv4Address

$consistencyPolicy = @{ "defaultConsistencyLevel"="Session" }

$CosmosDBProperties = @{
    "databaseAccountOfferType"="Standard";
    "locations"=$locations;
    "consistencyPolicy"=$consistencyPolicy;
    "ipRangeFilter"=$ipRangeFilter
}

Set-AzResource -ResourceType "Microsoft.DocumentDb/databaseAccounts" `
    -ApiVersion "2015-04-08" -ResourceGroupName $resourceGroupName `
    -Name $accountName -PropertyObject $CosmosDBProperties
```

## <a id="troubleshoot-ip-firewall"></a>Устранение неполадок с политикой контроля доступа на основе IP-адресов

Для устранения неполадок с политикой контроля доступа на основе IP-адресов у вас есть следующие возможности и средства: 

### <a name="azure-portal"></a>Портал Azure 
Включив политику контроля доступа на основе IP-адресов для учетной записи Azure Cosmos DB, вы заблокируете все запросы к этой учетной записи с любых компьютеров, IP-адреса которых не входят в список диапазонов разрешенных IP-адресов. Чтобы разрешить операции плоскости данных на портале (например, просмотр контейнеров и запрашивание документов), следует явным образом разрешить доступ к порталу Azure на панели **Брандмауэр** портала.

### <a name="sdks"></a>Пакеты SDK 
Если доступ к ресурсам Azure Cosmos DB осуществляется с помощью пакетов SDK с компьютеров, не включенных в список разрешенных, возвращается общий отклик **403 Запрещено** без дополнительных сведений. Проверьте список разрешенных IP-адресов для учетной записи и убедитесь, что к учетной записи Azure Cosmos DB применяется правильная конфигурация политики. 

### <a name="source-ips-in-blocked-requests"></a>IP-адреса источника в заблокированных запросах
Включение журнала ведения диагностики для учетной записи Azure Cosmos DB. Эти журналы отображают все запросы и отклики. Сообщения, имеющие отношение к брандмауэру, помещаются в журнал с кодом ответа 403. Отфильтровав эти сообщения, вы получите список исходных IP-адресов для заблокированных запросов. См. дополнительные сведения о [журнале ведения диагностики Azure Cosmos DB](logging.md).

### <a name="requests-from-a-subnet-with-a-service-endpoint-for-azure-cosmos-db-enabled"></a>Запросы из подсети, в которой включена конечная точка службы для Azure Cosmos DB
Запросы из подсети виртуальной сети, в которой включена конечная точка службы для Azure Cosmos DB, передают в учетную запись Azure Cosmos DB идентификаторы виртуальной сети и подсети. Такие запросы не имеют общедоступного IP-адреса источника, поэтому они отклоняются фильтрами IP-адресов. Чтобы разрешить доступ из определенных подсетей в виртуальных сетях, добавьте список управления доступом, как описано в руководстве по [настройке доступа на основе подсети и виртуальной сети для учетной записи Azure Cosmos DB](how-to-configure-vnet-service-endpoint.md). Применение правил брандмауэра может занять до 15 минут после изменения.


## <a name="next-steps"></a>Дополнительная информация

Сведения о том, как настроить конечную точку службы для виртуальной сети для учетной записи Azure Cosmos DB, см. в следующих статьях:

* [Контроль доступа к учетной записи Azure Cosmos DB с использованием виртуальной сети и подсети](vnet-service-endpoint.md)
* [Настройка доступа на основе подсети и виртуальной сети для учетной записи Azure Cosmos DB](how-to-configure-vnet-service-endpoint.md)

