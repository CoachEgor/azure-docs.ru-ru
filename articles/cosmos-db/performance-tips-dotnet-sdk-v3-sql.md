---
title: Azure Cosmos DB советы по повышению производительности для пакета SDK для .NET v3
description: Сведения о параметрах конфигурации клиента для улучшения Azure Cosmos DB производительности пакета SDK для .NET v3.
author: j82w
ms.service: cosmos-db
ms.topic: how-to
ms.date: 06/16/2020
ms.author: jawilley
ms.openlocfilehash: 9816ea7dd9f5aef9dcdd62319f8cc4408eff3fd8
ms.sourcegitcommit: 25bb515efe62bfb8a8377293b56c3163f46122bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2020
ms.locfileid: "87987262"
---
# <a name="performance-tips-for-azure-cosmos-db-and-net"></a>Советы по повышению производительности для .NET в Azure Cosmos DB

> [!div class="op_single_selector"]
> * [Пакет SDK версии 3 для .NET](performance-tips-dotnet-sdk-v3-sql.md)
> * [Пакет SDK для .NET версии 2](performance-tips.md)
> * [Пакет SDK для Java версии 4](performance-tips-java-sdk-v4-sql.md)
> * [Пакет SDK для Async Java версии 2](performance-tips-async-java.md)
> * [Пакет SDK для Sync Java версии 2](performance-tips-java.md)

Azure Cosmos DB — быстрая и гибкая распределенная база данных, которая легко масштабируется с гарантированной задержкой и пропускной способностью. Вам не нужно вносить существенные изменения в архитектуру или писать сложный код для масштабирования базы данных с Azure Cosmos DB. Для увеличения или уменьшения масштаба достаточно выполнить один вызов API. Дополнительные сведения см. в разделах [о подготовке пропускной способности контейнера](how-to-provision-container-throughput.md) и [о подготовке пропускной способности базы данных](how-to-provision-database-throughput.md). Но поскольку доступ к Azure Cosmos DB осуществляется через сетевые вызовы, для достижения пиковой производительности при использовании [пакета SDK для SQL .NET](https://github.com/Azure/azure-cosmos-dotnet-v3)можно выполнять оптимизацию на стороне клиента.

Поэтому, если вы пытаетесь повысить производительность базы данных, рассмотрите следующие варианты:

## <a name="hosting-recommendations"></a>Рекомендации по размещению

**Для рабочих нагрузок с большим количеством запросов используйте Windows 64-bit, а не Windows 32-разрядная обработка узлов**

Для повышения производительности рекомендуется использовать Windows 64-разрядную обработку узлов. Пакет SDK для SQL содержит собственный файл ServiceInterop.dll для локального анализа и оптимизации запросов. ServiceInterop.dll поддерживается только на платформе Windows x64. Для Linux и других неподдерживаемых платформ, в которых ServiceInterop.dll недоступна, к шлюзу создается дополнительный сетевой вызов для получения оптимизированного запроса. В следующих типах приложений по умолчанию используется обработка на узле по 32 бит. Чтобы изменить обработку узла до 64-разрядной обработки, выполните следующие действия в зависимости от типа приложения:

- Для исполняемых приложений можно изменить обработку узла, задав для параметра [Целевая платформа](https://docs.microsoft.com/visualstudio/ide/how-to-configure-projects-to-target-platforms?view=vs-2019) значение **x64** в окне **Свойства проекта** на вкладке **Сборка** .

- Для тестовых проектов на основе VSTest можно изменить обработку узла **, выбрав в**  >  **Test Settings**  >  меню **тест** Visual Studio пункт Параметры тестирования**архитектура процессора по умолчанию как x64** .

- Для локально развернутых веб-приложений ASP.NET можно изменить обработку узла, выбрав **использовать 64-разрядную версию IIS Express для веб-сайтов и проектов** в разделе **Сервис**  >  **Параметры**  >  **проекты и решения**  >  **веб-проекты**.

- Для веб-приложений ASP.NET, развернутых в Azure, можно изменить обработку узла, выбрав **64-разрядную** платформу в **параметрах приложения** в портал Azure.

> [!NOTE] 
> По умолчанию для новых проектов Visual Studio задан **любой ЦП**. Рекомендуется задать для проекта версию **x64** , чтобы не переключиться на **x86**. Проект, настроенный на **любой ЦП** , может легко переключиться на **x86** , если добавляется зависимость только для x86.<br/>
> ServiceInterop.dll должны находиться в папке, из которой выполняется библиотека DLL пакета SDK. Это должно быть проблемой только в том случае, если вы вручную копируете библиотеки DLL или используете пользовательские системы сборки или развертывания.
    
**Включить сборку мусора на стороне сервера (GC)**

Уменьшение частоты сборки мусора может помочь в некоторых случаях. В .NET задайте для [gcServer](https://docs.microsoft.com/dotnet/core/run-time-config/garbage-collector#flavors-of-garbage-collection) значение `true` .

**Масштабирование рабочей нагрузки клиента**

Если вы тестируете на высоких уровнях пропускной способности (более 50 000 единиц запросов в секунду), клиентское приложение может стать узким местом из-за того, что компьютер выгружается при использовании ЦП или использования сети. Если вы достигли этой точки, то можете повысить производительность Azure Cosmos DB, развернув клиентские приложения на нескольких серверах.

> [!NOTE] 
> Высокая загрузка ЦП может привести к увеличению задержки и исключениям времени ожидания запроса.

## <a name="networking"></a>Сеть
<a id="direct-connection"></a>

**Политика подключения: использование режима прямого подключения**

Способ подключения клиента к Azure Cosmos DB имеет важное влияние на производительность, особенно для наблюдаемой задержки на стороне клиента. Для настройки политики клиентских подключений можно использовать два параметра конфигурации: *режим* соединения и *протокол*подключения.  DocumentDB предоставляет два режима подключения:

   * Режим Direct (по умолчанию)

     Режим прямого подключения поддерживает подключение по протоколу TCP и используется по умолчанию, если используется [пакет SDK Microsoft. Azure. Cosmos/. NET v3](https://github.com/Azure/azure-cosmos-dotnet-v3). Это обеспечивает лучшую производительность и требует меньшего количества прыжков сети, чем режим шлюза.

   * Режим шлюза
      
     Если приложение работает в корпоративной сети с ограниченными ограничениями брандмауэра, лучшим выбором является режим шлюза, так как он использует стандартный HTTPS-порт и одну конечную точку. Однако компромисс производительности заключается в том, что режим шлюза включает дополнительный прыжок по сети при каждом считывании или записи данных в Azure Cosmos DB. Поэтому прямой режим обеспечивает лучшую производительность, так как уменьшается число прыжков сети. Также рекомендуется использовать режим подключения шлюза при запуске приложений в средах с ограниченным числом подключений к сокету.

     При использовании пакета SDK в функциях Azure, особенно в [плане потребления](../azure-functions/functions-scale.md#consumption-plan), следует учитывать текущие [ограничения на подключения](../azure-functions/manage-connections.md). В этом случае режим шлюза может быть лучше, если вы также работаете с другими клиентами, основанными на HTTP, в приложении функций Azure.


В режиме шлюза Azure Cosmos DB использует порт 443 и порты 10250, 10255 и 10256, если вы используете Azure Cosmos DB API для MongoDB. Порт 10250 сопоставляется с экземпляром MongoDB по умолчанию без георепликации. Порты 10255 и 10256 сопоставляются с экземпляром MongoDB, который имеет георепликацию.
     
При использовании протокола TCP в режиме прямого доступа в дополнение к портам шлюза необходимо убедиться в том, что диапазон портов 10000 и 20000 открыт, так как Azure Cosmos DB использует динамические TCP-порты (при использовании прямого режима для [частных конечных точек](./how-to-configure-private-endpoints.md), должен быть открыт полный диапазон портов TCP — от 0 до 65535). По умолчанию порты открыты для стандартной конфигурации виртуальной машины Azure. Если эти порты не открыты и вы пытаетесь использовать протокол TCP, вы получаете сообщение об ошибке "служба 503 недоступна". В этой таблице показаны режимы подключения, доступные для различных интерфейсов API, а также порты службы, используемые для каждого API:

|Режим подключения  |Поддерживаемый протокол  |Поддерживаемые пакеты SDK  |API и порт службы  |
|---------|---------|---------|---------|
|Шлюз  |   HTTPS    |  Все пакеты SDK    |   SQL (443), MongoDB (10250, 10255, 10256), таблица (443), Cassandra (10350), Graph (443)    |
|Direct    |     TCP    |  Пакет SDK для .NET    | При использовании общедоступной конечной точки или конечных точек службы: порты в диапазоне от 10000 до 20000<br>При использовании частных конечных точек: порты в диапазоне от 0 до 65535 |

Azure Cosmos DB предлагает простую, открытую модель программирования RESTFUL по протоколу HTTPS. Кроме того, предлагается эффективный протокол TCP, который также является RESTful в своей коммуникационной модели и доступен через клиентский пакет SDK для .NET. Протокол TCP использует TLS для первоначальной проверки подлинности и шифрования трафика. Чтобы добиться лучшей производительности, рекомендуется по возможности использовать протокол TCP.

Для пакета SDK v3 режим соединения настраивается при создании `CosmosClient` экземпляра в `CosmosClientOptions` . Помните, что по умолчанию используется режим Direct.

```csharp
string connectionString = "<your-account-connection-string>";
CosmosClient client = new CosmosClient(connectionString,
new CosmosClientOptions
{
    ConnectionMode = ConnectionMode.Gateway // ConnectionMode.Direct is the default
});
```

Так как протокол TCP поддерживается только в режиме Direct, при использовании режима шлюза протокол HTTPS всегда используется для связи с шлюзом.

:::image type="content" source="./media/performance-tips/connection-policy.png" alt-text="Политика подключения Azure Cosmos DB" border="false":::

**Временная нехватка портов**

Если вы видите большой объем подключения или интенсивное использование портов на экземплярах, сначала убедитесь, что экземпляры клиента являются одноэлементными. Иными словами, экземпляры клиента должны быть уникальными в течение всего времени существования приложения.

При запуске по протоколу TCP клиент оптимизирует задержку, используя долгосрочные соединения, в отличие от протокола HTTPS, который прерывает подключения после 2 минут бездействия.

В сценариях с разреженным доступом и при увеличении числа подключений по сравнению с доступом к режиму шлюза можно выполнить следующие действия.

* Настройте свойство [космосклиентоптионс. портреусемоде](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.portreusemode) в значение `PrivatePortPool` (действительно с платформой версии>= 4.6.1 и .net Core версии >= 2,0). это свойство позволяет пакету SDK использовать небольшой пул временных портов для разных конечных точек Azure Cosmos DB.
* Настройте свойство [космосклиентоптионс. IdleConnectionTimeout](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.idletcpconnectiontimeout) должно быть больше или равно 10 минут. Рекомендуемые значения: от 20 минут до 24 часов.

<a id="same-region"></a>

**Для повышения производительности совместное размещение клиентов в одном регионе Azure**

По возможности разместите приложения, вызывающие Azure Cosmos DB, в том же регионе, что и база данных Azure Cosmos DB. Ниже приведено примерное сравнение: вызовы Azure Cosmos DB в пределах одного региона выполняются в течение 1 мс до 2 мс, но задержка между Западом и Восточная регионом США составляет более 50 мс. Эта задержка может отличаться от запроса к запросу в зависимости от маршрута, выполняемого запросом по мере его передачи от клиента к границе центра обработки данных Azure. Вы можете получить наименьшую возможную задержку, убедившись в том, что вызывающее приложение находится в том же регионе Azure, что и подготовленная Azure Cosmos DBная конечная точка. Список доступных регионов см. на странице с [регионами Azure](https://azure.microsoft.com/regions/#services).

:::image type="content" source="./media/performance-tips/same-region.png" alt-text="Политика подключения Azure Cosmos DB" border="false":::

   <a id="increase-threads"></a>

**Увеличение числа потоков и задач**

Поскольку вызовы Azure Cosmos DB выполняются по сети, может потребоваться изменить степень параллелизма запросов, чтобы клиентское приложение тратило минимальное время ожидания между запросами. Например, если вы используете [библиотеку параллельных задач](https://msdn.microsoft.com//library/dd460717.aspx).NET, создайте в порядке сотни задач, считывающих или записывающих Azure Cosmos DB.

**Включить ускоренную сеть**
 
 Для сокращения задержки и снижения производительности ЦП рекомендуется включить функцию ускорения сети на клиентских виртуальных машинах. См. статью [Создание виртуальной машины Windows с ускоренной сетью](../virtual-network/create-vm-accelerated-networking-powershell.md) или [Создание виртуальной машины Linux с ускоренной сетью](../virtual-network/create-vm-accelerated-networking-cli.md).

## <a name="sdk-usage"></a>Использование пакета SDK
**Установка последней версии пакета SDK**

Пакеты SDK для Azure Cosmos DB постоянно улучшаются, чтобы обеспечивать самую высокую производительность. Сведения об улучшениях в последней версии пакета SDK см. в статье о [пакете SDK для Azure Cosmos DB](https://github.com/Azure/azure-cosmos-dotnet-v3).

**Использование API-интерфейсов потока**

[Пакет SDK для .NET v3](https://github.com/Azure/azure-cosmos-dotnet-v3) содержит API-интерфейсы потока, которые могут получать и возвращать данные без сериализации. 

Приложения среднего уровня, которые не используют ответы непосредственно из пакета SDK, но ретранслировать их на другие уровни приложений, могут воспользоваться преимуществами API-интерфейсов потока. Примеры обработки потока см. в разделе примеры [управления элементами](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/master/Microsoft.Azure.Cosmos.Samples/Usage/ItemManagement) .

**Используйте один и тот же клиент Azure Cosmos DB в течение всего жизненного цикла приложения.**

Каждый `CosmosClient` экземпляр является потокобезопасным и выполняет эффективное управление подключениями и кэширование адресов при работе в режиме прямого взаимодействия. Чтобы обеспечить эффективное управление подключениями и повысить производительность клиента пакета SDK, рекомендуется использовать один экземпляр в `AppDomain` течение всего времени существования приложения.

При работе с функциями Azure экземпляры также должны следовать существующим [рекомендациям](../azure-functions/manage-connections.md#static-clients) и поддерживать один экземпляр.

<a id="max-connection"></a>

**Отключить ответ содержимого при операциях записи**

Для рабочих нагрузок, имеющих большие полезные данные, установите параметр запроса Енаблеконтентреспонсеонврите в значение false. Служба больше не будет возвращать созданный или обновленный ресурс пакету SDK. Обычно в приложении создается объект, поэтому служба не должна ее возвращать. Значения заголовков по-прежнему доступны, как и плата за запросы. Это может повысить производительность, поскольку пакету SDK больше не требуется выделять память или сериализовать текст ответа. Это также сокращает использование пропускной способности сети для дальнейшего повышения производительности.  

```csharp
ItemRequestOption requestOptions = new ItemRequestOptions() { EnableContentResponseOnWrite = false };
ItemResponse<Book> itemResponse = await this.container.CreateItemAsync<Book>(book, new PartitionKey(book.pk), requestOptions);
// Resource will be null
itemResponse.Resource
```

**Включение групповой поддержки для оптимизации пропускной способности вместо задержки** Включите этот параметр для сценариев, когда рабочей нагрузке требуется большой объем пропускной способности, а задержка не так важна. Дополнительные сведения о том, как включить функцию и в каких сценариях следует использовать, см. в статье [Введение](https://devblogs.microsoft.com/cosmosdb/introducing-bulk-support-in-the-net-sdk) .

**Увеличение System.Net MaxConnections на узле при использовании режима шлюза**

При использовании режима шлюза запросы Azure Cosmos DB выполняются по протоколу HTTPS/RESTFUL. К ним применяются ограничения на количество подключений по умолчанию для каждого имени узла или IP-адреса. Может потребоваться задать `MaxConnections` более высокое значение (от 100 до 1 000), чтобы клиентская библиотека могла использовать несколько одновременных подключений к Azure Cosmos DB. В пакете SDK для .NET 1.8.0 и более поздних версиях значение по умолчанию для [ServicePointManager. DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) равно 50. Чтобы изменить значение, можно задать для [Documents. Client. ConnectionPolicy. MaxConnectionLimit](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) более высокое значение.

**Настройка параллельных запросов для секционированных коллекций**

Пакет SDK для SQL .NET поддерживает параллельные запросы, которые позволяют параллельно запрашивать секционированный контейнер. Дополнительные сведения см. в [примерах кода](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/master/Microsoft.Azure.Cosmos.Samples/Usage/Queries/Program.cs) для работы с пакетами SDK. Параллельные запросы предназначены для обеспечения более высокой задержки и пропускной способности запросов, чем их последовательный аналог. Параллельные запросы предоставляют два параметра, которые можно настроить в соответствии с вашими требованиями. 
- `MaxConcurrency`управляет максимальным числом секций, к которым можно обращаться параллельно. 
- `MaxBufferedItemCount`управляет количеством предварительно выбранных результатов.

***Степень настройки параллелизма***

Параллельный запрос работает путем параллельного запроса нескольких секций. Но данные из отдельных секций извлекаться последовательно по отношению к запросу. Параметр `MaxConcurrency` в [пакете SDK v3](https://github.com/Azure/azure-cosmos-dotnet-v3) , равный количеству секций, имеет лучший шанс достижения наиболее возможного запроса, при условии, что все остальные системные условия остаются прежними. Если число секций неизвестно, можно задать высокое значение степени параллелизма. В качестве степени параллелизма система выберет минимальное значение (число секций, предоставленных пользователем входных данных).

Параллельные запросы обеспечивают наибольшее преимущество, если данные равномерно распределяются по всем секциям по отношению к запросу. Если секционированная коллекция секционирована таким образом, что все или большинство данных, возвращаемых запросом, Concentrated в нескольких секциях (в худшем случае это одна секция), эти секции приводят к снижению производительности запроса.

***Настройка MaxBufferedItemCount***
    
Параллельный запрос предназначен для предварительного получения результатов, пока текущий пакет результатов обрабатывается клиентом. Такая предварительная выборка помогает повысить общую задержку запроса. `MaxBufferedItemCount`Параметр ограничивает количество предварительно выбранных результатов. Задайте `MaxBufferedItemCount` ожидаемое число возвращаемых результатов (или большее число), чтобы запрос получал максимальную пользу от предварительной выборки.

Предварительная выборка работает так же, как независимо от степени параллелизма, и существует один буфер для данных из всех секций.  

**Реализация интервала задержки для RetryAfter**

Во время тестирования производительности следует увеличить нагрузку до тех пор, пока не будет отрегулировано небольшое количество запросов. Если запросы регулируемы, клиентское приложение должно отключить регулирование в течение заданного сервером интервала повтора. По отношению к переходу гарантируется минимальное количество времени, затрачиваемого на ожидание между повторными попытками. 

Дополнительные сведения см. в разделе [RetryAfter](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.cosmosexception.retryafter?view=azure-dotnet#Microsoft_Azure_Cosmos_CosmosException_RetryAfter).
    
Существует механизм записи дополнительных диагностических сведений и устранения проблем задержки, как показано в следующем примере. Вы можете зарегистрировать строку диагностики для запросов с высокой задержкой чтения. Захваченная диагностическая строка поможет понять, сколько раз было получено 429 ошибок для данного запроса.

```csharp
ItemResponse<Book> readItemResponse = await this.cosmosContainer.ReadItemAsync<Book>("ItemId", new PartitionKey("PartitionKeyValue"));
readItemResponse.Diagnostics.ToString(); 
```

**Увеличение числа потоков и задач**

См. раздел [увеличение числа потоков и задач](#increase-threads) в разделе "Сетевые подключения" этой статьи.

## <a name="indexing-policy"></a>Политика индексации
 
**Увеличение скорости выполнения операций записи посредством исключения неиспользуемых путей из индексирования**

Политика индексирования Azure Cosmos DB также позволяет указать, какие пути документов следует включить в индексирование или исключить из него с помощью путей индексирования (IndexingPolicy. IncludedPaths и IndexingPolicy. ExcludedPaths). Индексирование только нужных путей может повысить производительность операций записи, сократить число единиц запросов на операции записи и сократить объем хранилища индексов для сценариев, в которых эти шаблоны запросов известны заранее. Это обусловлено тем, что стоимость индексирования напрямую соотносится с количеством уникальных путей. Например, в этом коде показано, как исключить весь раздел документов (поддерево) из индексирования с помощью подстановочного знака "*":

```csharp
var containerProperties = new ContainerProperties(id: "excludedPathCollection", partitionKeyPath: "/pk" );
containerProperties.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
containerProperties.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*");
Container container = await this.cosmosDatabase.CreateContainerAsync(containerProperties);
```

Дополнительные сведения см. в статье [Политики индексации Azure Cosmos DB](index-policy.md).

## <a name="throughput"></a>Пропускная способность
<a id="measure-rus"></a>

**Измерение и настройка для более низких единиц запросов/секунд использования**

Azure Cosmos DB предлагает обширный набор операций с базами данных. Эти операции включают в себя реляционные и иерархические запросы с определяемыми пользователем функциями, хранимыми процедурами и триггерами, которые работают с документами в коллекции баз данных. Затраты, связанные с каждой из этих операций, зависят от ЦП, операций ввода-вывода и памяти, необходимой для выполнения операции. Вместо того, чтобы думать об аппаратных ресурсах и управлении ими, можно представить единицу запроса (RU) как единую меру для ресурсов, необходимых для выполнения различных операций с базами данных и обслуживания запросов приложений.

Пропускная способность подготавливается на основе числа [единиц запросов](request-units.md) , заданных для каждого контейнера. Потребление единиц запросов оценивается как ставка за секунду. Приложения, превышающие подготовленную частоту единиц запросов для контейнера, будут ограничены до тех пор, пока скорость не станет ниже подготовленного уровня для контейнера. Если приложению требуется более высокий уровень пропускной способности, можно увеличить пропускную способность, выполнив подготовку дополнительных единиц запросов.

Сложность запроса влияет на количество единиц запросов, потребляемых операцией. Количество предикатов, природа предикатов, число определяемых пользователем функций и размер исходного набора данных влияют на стоимость операций запроса.

Чтобы измерить издержки любой операции (создания, обновления или удаления), просмотрите заголовок [x-MS-Request-расход](/rest/api/cosmos-db/common-cosmosdb-rest-response-headers) (или эквивалентное `RequestCharge` свойство в `ResourceResponse\<T>` или `FeedResponse\<T>` в пакете SDK для .NET), чтобы определить количество единиц запросов, потребляемых операциями:

```csharp
// Measure the performance (Request Units) of writes
ItemResponse<Book> response = await container.CreateItemAsync<Book>(myBook, new PartitionKey(myBook.PkValue));
Console.WriteLine("Insert of item consumed {0} request units", response.RequestCharge);
// Measure the performance (Request Units) of queries
FeedIterator<Book> queryable = container.GetItemQueryIterator<ToDoActivity>(queryString);
while (queryable.HasMoreResults)
    {
        FeedResponse<Book> queryResponse = await queryable.ExecuteNextAsync<Book>();
        Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge);
    }
```             

Плата за запрос, возвращенная в этом заголовке, является долей подготовленной пропускной способности (то есть 2 000 в секунду). Например, если предыдущий запрос возвращает документы 1 000 1-KB, стоимость операции будет 1 000. Таким образом, в течение одной секунды сервер учитывает только два таких запроса до последующего запроса на ограничение скорости. Дополнительные сведения см. в разделе [единицы запроса](request-units.md) и [Калькулятор единиц запросов](https://www.documentdb.com/capacityplanner).
<a id="429"></a>

**Обработка ограничения скорости / слишком высокая частота запросов**

Когда клиент пытается превысить зарезервированную пропускную способность для учетной записи, на сервере нет снижения производительности и не будет использоваться пропускная способность, превышающая зарезервированный уровень. Сервер будет завершать запрос с помощью ошибкой requestratetoolarge (код состояния HTTP 429). Он вернет заголовок [x-MS-Retry-After-MS](/rest/api/cosmos-db/common-cosmosdb-rest-response-headers) , который указывает время ожидания (в миллисекундах), по истечении которого пользователь должен будет повторить попытку запроса.

```xml
    HTTP Status 429,
    Status Line: RequestRateTooLarge
    x-ms-retry-after-ms :100
```

Пакеты SDK перехватят этот ответ, обработают заголовок retry-after, указанный сервером, и отправят запрос повторно. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

При наличии более чем одного клиента, постоянно работающего над частотой запросов, количество повторных попыток по умолчанию, установленное на уровне 9, может оказаться недостаточным. В этом случае клиент выдает приложению исключение Космосексцептион с кодом состояния 429. 

Можно изменить число повторных попыток по умолчанию, задав `RetryOptions` для `CosmosClientOptions` экземпляра. По умолчанию Космосексцептион с кодом состояния 429 возвращается после совокупного времени ожидания 30 секунд, если запрос будет продолжать работать выше скорости запросов. Эта ошибка возвращается даже в том случае, если текущее число повторных попыток меньше максимального, независимо от того, является ли текущее значение значением по умолчанию 9 или значением, определенным пользователем.

Автоматическое поведение повторных попыток помогает повысить устойчивость и удобство использования для большинства приложений. Но это может не быть лучшим поведением при выполнении тестов производительности, особенно при измерении задержки. Если настройка производительности повлияла на регулирование сервера и стала причиной автоматической отправки запросов пакетом SDK, это может стать причиной появления пиков задержек на стороне клиента. Чтобы избежать пиков задержек во время настройки производительности, проверьте расход ресурсов на каждую операцию и убедитесь, что значение частоты запросов не превышено. Дополнительные сведения см. в разделе [единицы запроса](request-units.md).

**Для более высокой пропускной способности разрабатывать небольшие документы**

Плата за запрос (т. е. затраты на обработку запросов) данной операции напрямую соотносится с размером документа. Операции с большими документами изменяют больше операций с малыми документами.

## <a name="next-steps"></a>Дальнейшие действия
Пример приложения, который используется для оценки Azure Cosmos DB для высокопроизводительных сценариев на нескольких клиентских компьютерах, см. в статье [Тестирование производительности и масштабирования с помощью Azure Cosmos DB](performance-testing.md).

Дополнительные сведения о создании приложения с высокой масштабируемостью и производительностью см. в статье [Partitioning and scaling in Azure Cosmos DB](partition-data.md) (Секционирование и масштабирование в Azure Cosmos DB).
