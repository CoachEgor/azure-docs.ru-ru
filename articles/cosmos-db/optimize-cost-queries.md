---
title: Оптимизация единиц запроса и затрат на выполнение запросов в Azure Cosmos DB
description: Сведения о том, как оценить затраты на запрос в единицах запроса, а также оптимизировать производительность и стоимость запроса.
author: rimman
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 08/01/2019
ms.author: rimman
ms.openlocfilehash: bdf223e60015c4e5d96416f95c410854a057c02c
ms.sourcegitcommit: a52f17307cc36640426dac20b92136a163c799d0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/01/2019
ms.locfileid: "68717021"
---
# <a name="optimize-query-cost-in-azure-cosmos-db"></a>Оптимизация затрат на отправку запросов в Azure Cosmos DB

Azure Cosmos DB предлагает широкий набор операций с базой данных, включая реляционные и иерархические запросы к элементам в контейнере. Затраты, связанные с каждой из этих операций, зависят от типа процессора, операций ввода-вывода и памяти, необходимой для завершения операции. Вы можете не беспокоиться об управлении аппаратными ресурсами, а использовать унифицированную меру — единицы запроса — для всех ресурсов, необходимых для выполнения операций с базами данных и обслуживания запросов. В этой статье описано, как оценить затраты на запрос в единицах запроса, а также оптимизировать производительность и стоимость запроса. 

Запросы в Azure Cosmos DB ранжируются в порядке уменьшения скорости и эффективности выполнения следующим образом:  

* операции GET в пределах одного ключа секции и ключа элемента;

* запрос с предложением фильтра в пределах одного ключа секции;

* запрос без условий равенства или диапазона для любого свойства;

* запрос без фильтров.

Запросы, которые считывают данные из нескольких секций, приводят к более высоким задержкам и потребляют больше единиц запросов. Так как каждая секция использует автоматическое индексирование всех свойств, запрос будет эффективно обрабатываться с помощью индекса. Запросы, использующие несколько секций, можно ускорить путем применения параллелизма. Если вы хотите узнать больше о секционировании и ключах секций, ознакомьтесь со статьей [Секционирование и масштабирование в базе данных Azure Cosmos DB](partitioning-overview.md).

## <a name="evaluate-request-unit-charge-for-a-query"></a>Оценка затрат на запрос в единицах запроса

Сохранив некоторые данные в контейнерах Azure Cosmos, вы можете создавать и выполнять запросы к ним с помощью Data Explorer на портале Azure. С помощью Data Explorer также можно узнать стоимость этих запросов. Этот метод позволит вам оценить фактические затраты на стандартные запросы и операции, которые поддерживаются в вашей системе.

Сведения о стоимости запросов также можно получить программным способом с помощью пакетов SDK. Чтобы оценить накладные расходы на любую операцию (создание, обновление или удаление данных), проверьте заголовок `x-ms-request-charge` в ответе от REST API. Если вы используете .NET или пакет SDK для Java, `RequestCharge` свойство является эквивалентным свойством для получения платы за запрос, а это свойство содержится в ResourceResponse или FeedResponse.

```csharp
// Measure the performance (request units) of writes 
ResourceResponse<Document> response = await client.CreateDocumentAsync(collectionSelfLink, myDocument); 

Console.WriteLine("Insert of an item consumed {0} request units", response.RequestCharge); 

// Measure the performance (request units) of queries 
IDocumentQuery<dynamic> queryable = client.CreateDocumentQuery(collectionSelfLink, queryString).AsDocumentQuery(); 

while (queryable.HasMoreResults) 
     { 
          FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>(); 
          Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge); 
     }
```

## <a name="factors-influencing-request-unit-charge-for-a-query"></a>Факторы, которые влияют на стоимость запроса в единицах запроса

Количество единиц запроса, расходуемых на запрос, зависит от нескольких факторов. Например, число загруженных/возвращенных элементов Cosmos Azure, Количество уточняющих запросов по индексу, время компиляции запроса и т. д. подробные сведения. Azure Cosmos DB гарантирует, что один и тот же запрос к одним и тем же данным всегда будет иметь одинаковую стоимость в единицах запроса. Профиль запроса, полученный по метрикам выполнения запроса, дает хорошее представление о затратах единиц запроса.  

В некоторых случаях при постраничном выполнении запроса вы будете поочередно получать ответы 200 и 429 с разными затратами единиц запроса. Это связано с тем, что запросы всегда выполняются максимально быстро с учетом доступных единиц запроса. Вы можете заметить, что выполнение запроса предусматривает разбивку на несколько страниц или операций отправки и обработки данных между клиентом и сервером. Например, ответ, содержащий 10 000 элементов, может возвращаться на нескольких страницах, стоимость каждой из которых будет зависеть от объема вычислений, выполненных для этой страницы. Просуммировав стоимость таких страниц, вы получите точно такое же количество единиц запроса, как и при выполнении всего запроса сразу.  

## <a name="metrics-for-troubleshooting"></a>Метрики, используемые при устранении неполадок

Производительность и пропускная способность, потребляемые при выполнении запросов с определяемыми пользователем функциями, зависят в первую очередь от содержимого функции. Чтобы узнать, сколько времени и единиц запроса затрачивается на выполнение определяемой пользователем функции, проще всего включить метрики запросов. Если вы используете пакет SDK для .NET, ниже приведены примеры метрик запросов, возвращаемых пакетом SDK.

```bash
Retrieved Document Count                 :               1              
Retrieved Document Size                  :           9,963 bytes        
Output Document Count                    :               1              
Output Document Size                     :          10,012 bytes        
Index Utilization                        :          100.00 %            
Total Query Execution Time               :            0.48 milliseconds 
  Query Preparation Times 
    Query Compilation Time               :            0.07 milliseconds 
    Logical Plan Build Time              :            0.03 milliseconds 
    Physical Plan Build Time             :            0.05 milliseconds 
    Query Optimization Time              :            0.00 milliseconds 
  Index Lookup Time                      :            0.06 milliseconds 
  Document Load Time                     :            0.03 milliseconds 
  Runtime Execution Times 
    Query Engine Execution Time          :            0.03 milliseconds 
    System Function Execution Time       :            0.00 milliseconds 
    User-defined Function Execution Time :            0.00 milliseconds 
  Document Write Time                    :            0.00 milliseconds 
  Client Side Metrics 
    Retry Count                          :               1              
    Request Charge                       :            3.19 RUs  
```

## <a name="best-practices-to-cost-optimize-queries"></a>Рекомендации по оптимизации затрат на запросы 

При оптимизации стоимости запросов постарайтесь учесть следующие рекомендации:

* **Размещайте разные типы сущностей вместе**

   Постарайтесь разместить все разные типы сущностей в одном контейнере, или хотя бы уменьшить количество контейнеров. Этот метод позволяет не только снизить стоимость, но и ускорить выполнение запросов и транзакций. Запросы выполняются в пределах одного контейнера, а атомарные транзакции к многочисленным записям с использованием хранимых процедур и триггеров выполняются в пределах одного ключа секции в одном контейнере. Совместное размещение сущностей в одном контейнере позволяет снизить количество сетевых запросов для обработки связей между записями. Благодаря этому повышается общая производительность, поддерживаются атомарные транзакции к множеству записей в крупном наборе данных, и, соответственно, снижаются расходы. Если в вашем сценарии сложно разместить все типы сущностей в одном контейнере или снизить количество контейнеров, попробуйте повысить предоставляемую производительность на уровне базы данных. Чаще всего такая ситуация возникает при невозможности или нежелании вносить изменения в код при переносе существующего приложения.  

* **Измерение и настройка расхода единиц запроса/повторного использования**

   Сложность запроса влияет на количество единиц запроса, потребляемых операцией. Количество предикатов и их характер, количество определяемых пользователем функций и размер набора исходных данных. Все эти факторы влияют на стоимость операций запросов. 

   Стоимость запроса, возвращаемая в заголовке ответа, обозначает стоимость конкретного запроса. Например, если запрос возвращает 1000 элементов по 1 КБ, на эту операцию расходуется 1000 единиц запроса. Таким образом, перед ограничением частоты выполнения последующих запросов сервер за одну секунду выполняет только два таких запроса. Чтобы узнать больше, просмотрите статью о [единицах запроса](request-units.md) и ознакомьтесь с калькулятором единиц запроса. 

## <a name="next-steps"></a>Следующие шаги

Теперь вы можете перейти к изучению оптимизации затрат в Azure Cosmos DB в следующих статьях:

* Дополнительные сведения о [ценообразовании в Azure Cosmos DB](how-pricing-works.md)
* Дополнительные сведения об [оптимизации для разработки и тестирования](optimize-dev-test.md)
* Дополнительные сведения о [расшифровке счета Azure Cosmos DB](understand-your-bill.md)
* Дополнительные сведения об [оптимизации расходов на пропускную способность](optimize-cost-throughput.md)
* Дополнительные сведения об [оптимизации расходов на хранилище](optimize-cost-storage.md)
* Дополнительные сведения об [оптимизации расходов на операции чтения и записи](optimize-cost-reads-writes.md)
* Дополнительные сведения об [оптимизации расходов на учетные записи Cosmos Azure с поддержкой нескольких регионов](optimize-cost-regions.md)
* Дополнительные сведения [о резервной мощности Azure Cosmos DB](cosmos-db-reserved-capacity.md)

