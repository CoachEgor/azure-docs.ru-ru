---
title: Мониторинг и отладка с помощью метрик в Azure Cosmos DB
description: Сведения об отладке распространенных проблем и мониторинге базы данных с помощью метрик в Azure Cosmos DB.
author: kanshiG
ms.author: govindk
ms.reviewer: sngun
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 06/18/2019
ms.openlocfilehash: b65bc6097d4841c79a68d4313ac7a3f89f6d1dbb
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "80065933"
---
# <a name="monitor-and-debug-with-metrics-in-azure-cosmos-db"></a>Мониторинг и отладка с помощью метрик в Azure Cosmos DB

Azure Cosmos DB предоставляет метрики пропускной способности, хранилища, согласованности, доступности и задержки. На портале Azure отображается общее представление этих метрик. Кроме того, вы можете просматривать метрики Azure Cosmos DB из API Azure Monitor. Чтобы узнать о том, как просматривать метрики с монитора Azure, смотрите [метрики Get из](cosmos-db-azure-monitor-metrics.md) статьи Azure Monitor. 

В этой статье рассматриваются распространенные варианты использования Azure Cosmos DB, а также представлены сведения об анализе и отладке проблем в этой базе данных на основе метрик. Сбор метрик осуществляется каждые пять минут. Они хранятся в течение семи дней.

## <a name="view-metrics-from-azure-portal"></a>Просмотр метрик с портала Azure

1. Войдите на [портал Azure](https://portal.azure.com/).

1. Откройте панель **метрик.** По умолчанию панель метрик отображает метрики единиц хранения, индекса и запроса для всех баз данных в учетной записи Azure Cosmos. Эти показатели можно отфильтровать в базе данных, контейнере или регионе. Вы также можете фильтровать метрики в определенное время детализации. Более подробная информация о пропускной записи, хранении, доступности, задержке и показателях согласованности предоставляется на отдельных вкладках. 

   ![Показатели производительности Cosmos DB на портале Azure](./media/use-metrics/performance-metrics.png)

Следующие метрики доступны из панели **метрик:** 

* **Показатели пропускной способности** - Эта метрика показывает количество запросов, потребляемых или неудачных (429 код ответа), поскольку пропускная способность или емкость хранилища, подготовленная для контейнера, превышена.

* **Метрики хранения** - Эта метрика показывает размер данных и использование индекса.

* **Показатели доступности** - Эта метрика показывает процент успешных запросов по сравнению с общим количеством запросов в час. Коэффициент успешности определяется SL-развязками Azure Cosmos DB.

* **Метрики задержки** - Эта метрика показывает задержку чтения и записи, наблюдаемую Azure Cosmos DB в регионе, где работает ваша учетная запись. Вы можете визуализировать задержку в разных регионах для гео-реплицируемой учетной записи. Эта метрика не отражает задержку сквозного запроса.

* **Показатели согласованности** - Эта метрика показывает, насколько окончательная последовательность для модели согласованности вы выбираете. Для многорайонных учетных записей эта метрика также показывает задержку репликации между выбранными регионами.

* **Системные метрики** - Эта метрика показывает, сколько запросов метаданных обслуживается мастерским разделом. Это также помогает определить задушенные запросы.

В следующих разделах объясняются общие сценарии, в которых можно использовать метрики DB Azure Cosmos. 

## <a name="understand-how-many-requests-are-succeeding-or-causing-errors"></a>Сведения о количестве успешных запросов и запросов, приводящих к ошибкам

Чтобы приступить к работе, перейдите на [портал Azure](https://portal.azure.com) и откройте колонку **Метрики**. В лезвии найдите количество запросов, превышающего емкость за 1-минутную диаграмму. На этой диаграмме показано общее количество запросов за минуту, разбитых по коду состояния. Для получения дополнительной информации о кодах статуса HTTP смотрите [коды статусов HTTP для Azure Cosmos DB.](https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb)

Наиболее распространенный код состояния ошибки — 429 (ограничение скорости и регулирование). Эта ошибка означает, что запросы к Azure Cosmos DB превышают квоту подготовленной пропускной способности. Чтобы решить эту проблему, чаще всего следует [увеличить число единиц запроса](./set-throughput.md) определенной коллекции.

![Число запросов в минуту](media/use-metrics/metrics-12.png)

## <a name="determine-the-throughput-distribution-across-partitions"></a>Определение распределения пропускной способности по секциям

При использовании масштабируемого приложения важно иметь достаточное количество ключей секции. Чтобы определить распределение пропускной способности для любого секционированного контейнера, перейдите в колонку **Метрики** на [портале Azure](https://portal.azure.com). На вкладке **Пропускная способность** на диаграмме **Max consumed RU/second by each physical partition** (Максимальное число потребленных единиц запроса каждой физической секцией за секунду) отображаются показатели хранилища. На графике ниже приведен пример неравномерного распределения данных, о чем свидетельствует секция слева.

![Высокая интенсивность использования секции в 15:05](media/use-metrics/metrics-17.png)

Неравномерное распределение пропускной способности может привести к образованию секций с *высокой нагрузкой*, из-за чего могут возникать отрегулированные запросы и может потребоваться повторное секционирование. Дополнительные сведения о секционировании в Azure Cosmos DB см. в [этой статье](./partition-data.md).

## <a name="determine-the-storage-distribution-across-partitions"></a>Определение распределения ресурсов хранения по секциям

При использовании масштабируемого приложения важно иметь достаточное количество секций. Чтобы определить распределение ресурсов хранения для любого секционированного контейнера, перейдите в колонку "Метрики" на [портале Azure](https://portal.azure.com). На вкладке "Хранилище" сведения о ресурсах хранения отображаются в диаграмме "Объем хранилища данных и индекса, занятый ведущими ключами секций". На графике ниже приведено неравномерное распределение ресурсов хранения данных, о чем свидетельствует секция слева.

![Пример неравномерного распределения данных](media/use-metrics/metrics-07.png)

Чтобы определить, какой ключ секции искажает распределение, щелкните секцию на диаграмме.

![Ключ секции, искажающий распределение](media/use-metrics/metrics-05.png)

После определения ключа секции, искажающего распределение, вы можете повторно разбить контейнер с большим числом распределенных ключей секции. Дополнительные сведения о секционировании в Azure Cosmos DB см. в [этой статье](./partition-data.md).

## <a name="compare-data-size-against-index-size"></a>Сравнение размера данных и размера индекса

В базе данных Azure Cosmos DB общий использованный объем хранилища зависит от размера данных и размера индекса. Обычно размер индекса — это часть объема данных. В колонке "Метрики" [портала Azure](https://portal.azure.com) на вкладке "Хранилище" можно просмотреть сведения о потреблении хранилища на основе данных и индекса.

```csharp
// Measure the document size usage (which includes the index size)  
ResourceResponse<DocumentCollection> collectionInfo = await client.ReadDocumentCollectionAsync(UriFactory.CreateDocumentCollectionUri("db", "coll"));
 Console.WriteLine("Document size quota: {0}, usage: {1}", collectionInfo.DocumentQuota, collectionInfo.DocumentUsage);
```

Чтобы сэкономить пространство индекса, вы можете настроить [политику индексирования](index-policy.md).

## <a name="debug-why-queries-are-running-slow"></a>Устранение причины медленного выполнения запросов

В пакетах SDK для API SQL можно просмотреть статистику выполнения запросов в базе данных Azure Cosmos DB.

```csharp
IDocumentQuery<dynamic> query = client.CreateDocumentQuery(
 UriFactory.CreateDocumentCollectionUri(DatabaseName, CollectionName),
 "SELECT * FROM c WHERE c.city = 'Seattle'",
 new FeedOptions
 {
 PopulateQueryMetrics = true,
 MaxItemCount = -1,
 MaxDegreeOfParallelism = -1,
 EnableCrossPartitionQuery = true
 }).AsDocumentQuery();
FeedResponse<dynamic> result = await query.ExecuteNextAsync();

// Returns metrics by partition key range Id
IReadOnlyDictionary<string, QueryMetrics> metrics = result.QueryMetrics;
```

Свойство *QueryMetrics* предоставляет подробные сведения о длительности выполнения каждого компонента запроса. Основная первопричина медленного выполнения запросов — сканирования. Это означает, что запрос не может использовать индексы. Эту проблему можно устранить, настроив оптимальное условие фильтра.

## <a name="next-steps"></a>Дальнейшие действия

Теперь вы знаете, как отслеживать и отлаживать неполадки с помощью метрик, предоставленных на портале Azure. Узнать больше о повышении производительности базы данных можно из следующих статей:

* Чтобы узнать о том, как просматривать метрики с монитора Azure, смотрите [метрики Get из](cosmos-db-azure-monitor-metrics.md) статьи Azure Monitor. 
* [Проверка производительности и масштабирования с помощью Azure Cosmos DB](performance-testing.md)
* [Советы по повышению производительности для Azure Cosmos DB](performance-tips.md)
