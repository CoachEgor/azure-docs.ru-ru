---
title: Изменение шаблонов разработки веб-канала в Azure Cosmos DB
description: Обзор общих шаблонов разработки веб-каналов изменений
author: timsander1
ms.author: tisande
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/08/2020
ms.openlocfilehash: 012d27b44ecfbdd460adf241742df397880f78c6
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "81450357"
---
# <a name="change-feed-design-patterns-in-azure-cosmos-db"></a>Изменение шаблонов разработки веб-канала в Azure Cosmos DB

Веб-канал изменений Azure Cosmos DB позволяет эффективно обрабатывать большие наборы данных с большим объемом операций записи. Также канал изменений позволяет обойтись без запросов ко всему набору данных, когда нужно найти только изменившиеся данные. В этом документе рассматриваются распространенные шаблоны проектирования веб-каналов изменений, компромиссы разработки и ограничения веб-канала изменений.

Azure Cosmos DB используется для приложений Интернета вещей, розничной торговли, игр и приложений для ведения журнала операций. Для таких приложений часто используется одинаковый конструктивный шаблон, в котором изменения в данных активируют дополнительные действия, например:

* активирование уведомления или вызова API при вставке или изменении элемента;
* потоковая обработка в режиме реального времени (для Интернета вещей) или аналитическая обработка в режиме реального времени по рабочим данным;
* Перемещение данных, например синхронизация с кэшем, поисковой системой, хранилищем данных или холодным хранилищем.

Канал изменений в Azure Cosmos DB позволяет создавать эффективные и масштабируемые решения для каждого из этих шаблонов, как показано на следующем рисунке:

![Использование веб-канала изменений Azure Cosmos DB для аналитики в реальном времени и вычислений на основе событий](./media/change-feed/changefeedoverview.png)

## <a name="event-computing-and-notifications"></a>Вычисления и уведомления о событиях

Веб-канал изменений Azure Cosmos DB может упростить сценарии, требующие активации уведомления или вызова API на основе определенного события. [Библиотеку процессов изменений](change-feed-processor.md) можно использовать для автоматического опроса контейнера на наличие изменений и вызова внешнего API каждый раз при записи или обновлении.

Вы также можете выборочно активировать уведомление или отправить вызов API на основе определенного критерия. Например, при чтении из веб-канала изменений с помощью [функций Azure](change-feed-functions.md)можно поместить логику в функцию, чтобы отправить уведомление только при соблюдении определенного критерия. Хотя код функции Azure будет выполняться во время каждой операции записи и обновления, уведомление будет отправлено, только если были выполнены определенные условия.

## <a name="real-time-stream-processing"></a>Потоковая обработка в режиме реального времени

Веб-канал изменений Azure Cosmos DB может использоваться для потоковой обработки в режиме реального времени для обработки данных в Интернете IoT или в режиме реального времени.
Например, вы можете получить и сохранить данные событий с устройств, датчиков, инфраструктуры и приложений, а также обработать эти события в режиме реального времени с помощью [Spark](../hdinsight/spark/apache-spark-overview.md). На следующем рисунке показано, как можно реализовать лямбда-архитектуру с помощью Azure Cosmos DB через канал изменений:

![Лямбда-конвейер для приема и запроса на основе Azure Cosmos DB](./media/change-feed/lambda.png)

Во многих случаях реализации потоковой обработки сначала получают большой объем входящих данных во временную очередь сообщений, например в концентратор событий Azure или Apache Kafka. Веб-канал изменений — это отличная альтернатива в связи с возможностью Azure Cosmos DB поддерживать устойчивую высокую скорость приема данных с гарантированной низкой задержкой чтения и записи. К преимуществам веб-канала изменений Azure Cosmos DB в очереди сообщений относятся:

### <a name="data-persistence"></a>Сохраняемость данных

Данные, записанные в Azure Cosmos DB, будут отображаться в веб-канале изменений и сохранены до удаления. Обычно очереди сообщений имеют максимальный срок хранения. Например, [концентратор событий Azure](https://azure.microsoft.com/services/event-hubs/) предлагает максимальный срок хранения данных 90 дней.

### <a name="querying-ability"></a>Возможность запросов

Кроме чтения из веб-канала изменений контейнера Cosmos, можно также выполнять SQL-запросы к данным, хранящимся в Azure Cosmos DB. Веб-канал изменений не является дублированием данных, которые уже находятся в контейнере, а только другим механизмом чтения данных. Таким образом, при чтении данных из веб-канала изменений они всегда будут соответствовать запросам одного и того же контейнера Azure Cosmos DB.

### <a name="high-availability"></a>Высокий уровень доступности

Azure Cosmos DB обеспечивает доступность до 99,999% доступности для чтения и записи. В отличие от многих очередей сообщений, Azure Cosmos DB данные могут быть легко глобально распределены и настроены с параметром [RTO (целевое время восстановления)](consistency-levels-tradeoffs.md#rto) , равным нулю.

После обработки элементов в веб-канале изменений можно создать материализованный представление и сохранить агрегированные значения обратно в Azure Cosmos DB. При использовании Azure Cosmos DB для создания игр веб-канал изменений можно использовать, например, для создания списков лидеров в режиме реального времени на основе очков в завершенных играх.

## <a name="data-movement"></a>Перемещение данных

Можно также выполнить чтение из веб-канала изменений для перемещения данных в режиме реального времени.

Например, веб-канал изменений помогает выполнять следующие задачи эффективно:

* Обновление кэша, индекса поиска или хранилища данных с помощью данных, хранящихся в Azure Cosmos DB.

* выполнение миграции без простоя в другую учетную запись Azure Cosmos или другой контейнер Azure Cosmos с другим ключом логического раздела;

* Реализуйте многоуровневые и архивные данные на уровне приложения. Например, можно хранить "горячий" данные в Azure Cosmos DB и возрастать "холодные данные" в другие системы хранения, такие как [хранилище BLOB-объектов Azure](../storage/common/storage-introduction.md).

Если необходимо [денормализовать данные по секциям и контейнерам](how-to-model-partition-example.md#v2-introducing-denormalization-to-optimize-read-queries
), можно выполнить чтение из веб-канала изменений контейнера в качестве источника для этой репликации данных. Репликация данных в режиме реального времени с помощью веб-канала изменений может гарантировать только окончательную согласованность. Вы можете [отслеживать, насколько сильно отстает от](how-to-use-change-feed-estimator.md) обработки изменений в контейнере Cosmos обработчик веб-канала изменений.

## <a name="event-sourcing"></a>Источники событий

[Шаблон источников событий](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing) включает использование хранилища, доступного только для добавления, для записи полного набора действий с этими данными. Веб-канал изменений Azure Cosmos DB отлично подходит как центральное хранилище данных в архитектурах источников событий, где все приемы данных моделируются как операции записи (без обновлений и удалений). В этом случае каждая запись в Azure Cosmos DB является "событием", и у вас будет полная запись прошлых событий в веб-канале изменений. Типичные варианты использования событий, опубликованных центральным хранилищем событий, — для обслуживания материализованных представлений или для интеграции с внешними системами. Так как в веб-канале изменений нет предельного времени хранения, можно воспроизвести все предыдущие события, читая их из начала веб-канала изменений контейнера Cosmos.

Вы можете иметь [несколько потребителей веб-каналов изменений, подписанных на один и тот же канал изменений контейнера](how-to-create-multiple-cosmos-db-triggers.md#optimizing-containers-for-multiple-triggers). Помимо подготовленной пропускной способности [контейнера аренды](change-feed-processor.md#components-of-the-change-feed-processor) нет затрат на использование веб-канала изменений. Веб-канал изменений доступен в каждом контейнере, независимо от того, используется ли он.

Azure Cosmos DB — это отличное центральное хранилище данных, доступное только для добавления, в шаблоне источников событий, так как его сильные стороны в горизонтальной масштабируемости и высокой доступности. Кроме того, Библиотека обработчика веб-канала изменений предлагает гарантию ["хотя бы один раз"](change-feed-processor.md#error-handling) , гарантируя, что вы не будете обрабатывать какие-либо события.

## <a name="current-limitations"></a>Текущие ограничения

Веб-канал изменений имеет важные ограничения, которые следует понимать. Хотя элементы в контейнере Cosmos всегда остаются в веб-канале изменений, веб-канал изменений не является полным журналом операций. При проектировании приложения, использующего веб-канал изменений, необходимо учитывать важные аспекты.

### <a name="intermediate-updates"></a>Промежуточные обновления

В веб-канал изменений включается только самое Последнее изменение для данного элемента. При обработке изменений вы будете считать последнюю доступную версию элемента. При наличии нескольких обновлений одного и того же элемента в течение короткого периода времени можно пропустить обработку промежуточных обновлений. Если вы хотите относиться к обновлениям и воспроизводить предыдущие обновления элемента, рекомендуется моделировать эти обновления в виде серии записей.

### <a name="deletes"></a>Deletes

Веб-канал изменений не отслеживает удаления. При удалении элемента из контейнера он также удаляется из веб-канала изменений. Наиболее распространенным способом обработки этого является добавление мягкого маркера для удаляемых элементов. Можно добавить свойство с именем "удалено" и задать для него значение "true" во время удаления. Это обновление документа будет отображаться в веб-канале изменений. Для этого элемента можно задать TTL, чтобы его можно было автоматически удалить позже.

### <a name="guaranteed-order"></a>Гарантированный порядок

В канале изменений есть Гарантированный порядок в пределах значения ключа секции, но не для значений ключа секции. Необходимо выбрать ключ секции, который обеспечивает осмысленную гарантию порядка.

Например, рассмотрим розничное приложение, использующее шаблон проектирования источников событий. В этом приложении разные действия пользователя — это все события, которые моделируются как операции записи в Azure Cosmos DB. Представьте себе, что некоторые примеры событий произошли в следующей последовательности:

1. Клиент добавляет товар A в корзину для покупок
2. Клиент добавляет элемент B в корзину для покупок
3. Клиент удаляет элемент A из покупательской корзины
4. Клиент извлекает содержимое покупательской корзины.

Материализованные представления текущего содержимого покупательской корзины хранятся для каждого клиента. Это приложение должно обеспечить обработку этих событий в том порядке, в котором они происходят. Если, например, необходимо было обработать извлечение корзины до удаления элемента A, скорее всего, у клиента был товар A отгружен, а не нужный элемент б. Чтобы гарантировать обработку этих четырех событий в порядке их возникновения, они должны попадать в одно и то же значение ключа секции. Если выбрать **имя пользователя** (у каждого клиента есть уникальное имя пользователя) в качестве ключа секции, вы можете гарантировать, что эти события отображаются в веб-канале изменений в том же порядке, в котором они записываются в Azure Cosmos DB.

## <a name="examples"></a>Примеры

Ниже приведено несколько примеров кода веб-канала изменений, которые выходят за рамки примеров, приведенных в документах Майкрософт:

- [Общие сведения о веб-канале изменений](https://azurecosmosdb.github.io/labs/dotnet/labs/08-change_feed_with_azure_functions.html)
- [Вариант использования IoT в центре веб-канала изменений](https://github.com/AzureCosmosDB/scenario-based-labs)
- [Розничный вариант использования в центре веб-канала изменений](https://github.com/AzureCosmosDB/scenario-based-labs)

## <a name="next-steps"></a>Дальнейшие шаги

* [Общие сведения о канале изменений](change-feed.md)
* [Reading Azure Cosmos DB change feed](read-change-feed.md) (Чтение канала изменений Azure Cosmos DB)
* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)