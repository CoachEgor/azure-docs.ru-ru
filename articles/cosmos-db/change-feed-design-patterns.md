---
title: Изменение шаблонов проектирования кормов в Azure Cosmos DB
description: Обзор общих моделей проектирования кормов изменений
author: timsander1
ms.author: tisande
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/08/2020
ms.openlocfilehash: 7e6981fb57421846b491693bb6195ecef31a3773
ms.sourcegitcommit: 7d8158fcdcc25107dfda98a355bf4ee6343c0f5c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2020
ms.locfileid: "80986308"
---
# <a name="change-feed-design-patterns-in-azure-cosmos-db"></a>Изменение шаблонов проектирования кормов в Azure Cosmos DB

Подача изменения Azure Cosmos DB позволяет эффективно обрабатывать большие наборы данных с большим объемом записок. Также канал изменений позволяет обойтись без запросов ко всему набору данных, когда нужно найти только изменившиеся данные. В этом документе основное внимание уделяется общим шаблонам проектирования каналов изменений, компромиссам в области проектирования и изменению ограничений на корма.

Azure Cosmos DB используется для приложений Интернета вещей, розничной торговли, игр и приложений для ведения журнала операций. Для таких приложений часто используется одинаковый конструктивный шаблон, в котором изменения в данных активируют дополнительные действия, например:

* активирование уведомления или вызова API при вставке или изменении элемента;
* потоковая обработка в режиме реального времени (для Интернета вещей) или аналитическая обработка в режиме реального времени по рабочим данным;
* Перемещение данных, например синхронизация с кэшем, поисковой системой, хранилищем данных или холодильное хранилище.

Канал изменений в Azure Cosmos DB позволяет создавать эффективные и масштабируемые решения для каждого из этих шаблонов, как показано на следующем рисунке:

![Использование веб-канала изменений Azure Cosmos DB для аналитики в реальном времени и вычислений на основе событий](./media/change-feed/changefeedoverview.png)

## <a name="event-computing-and-notifications"></a>Вычисления и уведомления о событиях

Лента изменения DB Azure Cosmos может упростить сценарии, которые должны вызвать уведомление или вызов API на основе определенного события. Библиотеку [процесса изменения](change-feed-processor.md) ленты можно использовать для автоматического опроса контейнера на результаты и вызова внешнего API каждый раз, когда происходит запись или обновление.

Вы также можете выборочно инициировать уведомление или отправить вызов в API на основе определенных критериев. Например, если вы читаете из ленты изменений с помощью [функций Azure,](change-feed-functions.md)можно поместить логику в функцию, чтобы отправить уведомление только в том случае, если определенные критерии были выполнены. В то время как код функции Azure будет выполняться во время каждой записи и обновления, уведомление будет отправлено только в том случае, если были выполнены определенные критерии.

## <a name="real-time-stream-processing"></a>Обработка потока в режиме реального времени

Канал изменения DB Azure Cosmos может использоваться для обработки потоков в режиме реального времени для обработки IoT или аналитики в режиме реального времени на оперативных данных.
Например, вы можете получать и хранить данные о событиях с устройств, датчиков, инфраструктуры и приложений, а также обрабатывать эти события в режиме реального времени с помощью [Spark.](../hdinsight/spark/apache-spark-overview.md) На следующем изображении показано, как можно реализовать архитектуру лямбды с помощью Azure Cosmos DB с помощью канала изменений:

![Лямбда-конвейер для приема и запроса на основе Azure Cosmos DB](./media/change-feed/lambda.png)

Во многих случаях реализации обработки потоков сначала получают большой объем входящих данных во временную очередь сообщений, такую как Azure Event Hub или Apache Kafka. Подача изменений является отличной альтернативой благодаря способности Azure Cosmos DB поддерживать устойчивый высокий уровень приема данных с гарантированной низкой задержкой чтения и записи. Преимущества канала изменения DB Azure Cosmos над очередью сообщений:

### <a name="data-persistence"></a>Сохраняемость данных

Данные, записанные в Azure Cosmos DB, будут отображаться в ленте изменений и храниться до удаления. Очереди сообщений обычно имеют максимальный период хранения. Например, [Azure Event Hub](https://azure.microsoft.com/services/event-hubs/) предлагает максимальное хранение данных в 90 дней.

### <a name="querying-ability"></a>Способность запроса

В дополнение к чтению из канала изменения контейнера Cosmos, вы также можете запустить запросы на данные, хранящиеся в Azure Cosmos DB. Подача изменений не является дублированием данных, уже наданных в контейнере, а просто другим механизмом чтения данных. Поэтому, если вы читаете данные из ленты изменений, они всегда будут соответствовать запросам того же контейнера Azure Cosmos DB.

### <a name="high-availability"></a>Высокий уровень доступности

Azure Cosmos DB предлагает до 99,999% доступности чтения и записи. В отличие от многих очередей сообщений, данные Azure Cosmos DB могут быть легко распределены по всему миру и настроены с помощью [RTO (Цель времени восстановления)](consistency-levels-tradeoffs.md#rto) с нулем.

После обработки элементов в ленте изменений можно создать материализованное представление и сохранить агрегированные значения обратно в Azure Cosmos DB. При использовании Azure Cosmos DB для создания игр веб-канал изменений можно использовать, например, для создания списков лидеров в режиме реального времени на основе очков в завершенных играх.

## <a name="data-movement"></a>Перемещение данных

Вы также можете прочитать из ленты изменений для движения данных в режиме реального времени.

Например, лента изменений позволяет эффективно выполнять следующие задачи:

* Обновление кэша, индекса поиска или хранилища данных с данными, хранящимися в Azure Cosmos DB.

* выполнение миграции без простоя в другую учетную запись Azure Cosmos или другой контейнер Azure Cosmos с другим ключом логического раздела;

* Реализация уровня данных на уровне приложения и архивирование. Например, можно хранить "горячие данные" в Azure Cosmos DB и вычислять "холодные данные" в другие системы хранения данных, такие как [Хранилище Azure Blob.](../storage/common/storage-introduction.md)

Когда вам нужно [денормализовать данные через разделы и контейнеры,](how-to-model-partition-example.md#v2-introducing-denormalization-to-optimize-read-queries
)вы можете прочитать из канала изменения вашего контейнера в качестве источника для этой репликации данных. Репликация данных в режиме реального времени с помощью канала изменений может гарантировать только окончательную согласованность. Вы можете [контролировать, насколько процессор Change Feed отстает](how-to-use-change-feed-estimator.md) в обработке изменений в контейнере Cosmos.

## <a name="event-sourcing"></a>Поиск событий

[Шаблон поиска событий](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing) включает в себя использование магазина только для приложений для записи полной серии действий на этих данных. Лента изменения Azure Cosmos DB является отличным выбором в качестве центрального хранилища данных в архитектуре поиска событий, где все данные, проглатающиеся по образцу записей (без обновлений или удалений). В этом случае каждая запись в Azure Cosmos DB является «событием», и вы будете иметь полную запись прошлых событий в ленте изменений. Типичное использование событий, опубликованных центральным хранилищем событий, для поддержания материализованных представлений или для интеграции с внешними системами. Поскольку нет ограничений по времени для удержания в ленте изменений, вы можете воспроизвести все прошлые события, читая с самого начала канала изменения контейнера Cosmos.

Вы можете иметь [несколько изменений корма потребители подписаться на изменение одного и того же контейнера корма.](how-to-create-multiple-cosmos-db-triggers.md#optimizing-containers-for-multiple-triggers) Помимо [прокладки арендного контейнера,](change-feed-processor.md#components-of-the-change-feed-processor) использование корма для изменения не является затратами. Подача изменений доступна в каждом контейнере независимо от того, используется ли он.

Azure Cosmos DB — это отличный центральный постоянный хранилище данных только для приложений в шаблоне поиска событий из-за его сильных сторон в горизонтальной масштабируемости и высокой доступности. Кроме того, библиотека изменения Feed Processor предоставляет гарантию [«по крайней мере один раз»,](change-feed-processor.md#error-handling) гарантируя, что вы не пропустите обработку любых событий.

## <a name="current-limitations"></a>Текущие ограничения

Канал изменения имеет важные ограничения, которые вы должны понимать. В то время как элементы в контейнере Cosmos всегда остаются в ленте изменения, канал изменения не является полным журналом работы. Есть важные области, которые следует учитывать при проектировании приложения, использующей канал изменений.

### <a name="intermediate-updates"></a>Промежуточные обновления

В ленту изменений включено только самое последнее изменение для данного элемента. При обработке изменений вы будете читать последнюю доступную версию элемента. Если за короткий период времени есть несколько обновлений одного и того же элемента, можно пропустить обработку промежуточных обновлений. Если вы хотите отслеживать обновления и иметь возможность воспроизводить прошлые обновления элемента, мы рекомендуем моделирование этих обновлений в виде серии записей вместо этого.

### <a name="deletes"></a>Deletes

Лента изменения не захватывает удаляет. Если вы удалите элемент из контейнера, он также удаляется из ленты изменений. Наиболее распространенным методом обработки этого является добавление мягкого маркера на элементы, которые удаляются. Вы можете добавить свойство под названием "удалено" и установить его на "истинное" во время удаления. Это обновление документа будет отображаться в ленте изменений. Вы можете установить TTL на этом пункте, так что он может быть автоматически удален позже.

### <a name="guaranteed-order"></a>Гарантированный заказ

Гарантированный порядок в ленте изменения в пределах значения ключа раздела, но не между значениями ключевых разделов. Следует выбрать ключ раздела, который дает вам существенную гарантию заказа.

Например, рассмотрим розничное приложение с использованием шаблона проектирования поиска событий. В этом приложении различные действия пользователя являются «событиями», которые моделируются как записи в Azure Cosmos DB. Представьте себе, если некоторые события примера произошли в следующей последовательности:

1. Клиент добавляет пункт А в корзину
2. Клиент добавляет пункт B в корзину
3. Клиент добавляет удаляет пункт А из корзины
4. Клиент проверяет и содержимое корзины отправлены

Для каждого клиента сохраняется материализованное представление о текущем содержимом корзины для покупок. Это приложение должно гарантировать, что эти события обрабатываются в порядке, в котором они происходят. Если, например, касса тележки должна была быть обработана до удаления пункта А, вполне вероятно, что клиент был бы отправлен пункт А, в отличие от желаемого пункта B. Для того чтобы гарантировать, что эти четыре события обрабатываются в порядке их возникновения, они должны подпадать под одно и то же значение ключевого раздела. Если вы выберете **имя пользователя** (каждый клиент имеет уникальное имя пользователя) в качестве ключа раздела, вы можете гарантировать, что эти события отображаются в ленте изменений в том же порядке, в котором они записаны в Azure Cosmos DB.

## <a name="examples"></a>Примеры

Вот некоторые примеры кода кода из реальных изменений, которые выходят за рамки примеров, представленных в документах Майкрософт:

- [Введение в канал изменений](https://azurecosmosdb.github.io/labs/dotnet/labs/08-change_feed_with_azure_functions.html)
- [IoT использование случае сосредоточено вокруг изменения корма](https://github.com/AzureCosmosDB/scenario-based-labs)
- [Розничный случай использования сосредоточен вокруг канала изменения](https://github.com/AzureCosmosDB/scenario-based-labs)

## <a name="next-steps"></a>Дальнейшие действия

* [Общие сведения о канале изменений](change-feed.md)
* [Reading Azure Cosmos DB change feed](read-change-feed.md) (Чтение канала изменений Azure Cosmos DB)
* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)