---
title: Советы по повышению производительности Azure Cosmos DB и .NET
description: Узнайте о параметрах конфигурации клиента, чтобы повысить производительность Azure Cosmos DB.
author: SnehaGunda
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 01/15/2020
ms.author: sngun
ms.openlocfilehash: ee2743af2f8499aec04d8b6b733e1ba4c2a82083
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "80546076"
---
# <a name="performance-tips-for-azure-cosmos-db-and-net"></a>Советы по повышению производительности для .NET в Azure Cosmos DB

> [!div class="op_single_selector"]
> * [Async Java](performance-tips-async-java.md)
> * [Java](performance-tips-java.md)
> * [.NET](performance-tips.md)
> 

Azure Cosmos DB — быстрая и гибкая распределенная база данных, которая легко масштабируется с гарантированной задержкой и пропускной способностью. Вам не нужно вносить существенные изменения в архитектуру или писать сложный код для масштабирования базы данных с Azure Cosmos DB. Для увеличения или уменьшения масштаба достаточно выполнить один вызов API. Дополнительные сведения см. в разделах [о подготовке пропускной способности контейнера](how-to-provision-container-throughput.md) и [о подготовке пропускной способности базы данных](how-to-provision-database-throughput.md). Но поскольку доступ к Azure Cosmos DB осуществляется через сетевые вызовы, для достижения пиковой производительности при использовании [пакета SDK для SQL .NET](sql-api-sdk-dotnet-standard.md)можно выполнять оптимизацию на стороне клиента.

Поэтому, если вы пытаетесь повысить производительность базы данных, рассмотрите следующие варианты:

## <a name="hosting-recommendations"></a>Рекомендации по размещению

**Для рабочих нагрузок с большим количеством запросов используйте Windows 64-bit, а не Windows 32-разрядная обработка узлов**

Для повышения производительности рекомендуется использовать Windows 64-разрядную обработку узлов. Пакет SDK для SQL содержит собственную ServiceInterop. dll для локального анализа и оптимизации запросов. ServiceInterop. dll поддерживается только на платформе Windows x64. Для Linux и других неподдерживаемых платформ, где ServiceInterop. DLL недоступен, для получения оптимизированного запроса к шлюзу устанавливается дополнительный сетевой вызов. В следующих типах приложений по умолчанию используется обработка на узле по 32 бит. Чтобы изменить обработку узла до 64-разрядной обработки, выполните следующие действия в зависимости от типа приложения:

- Для исполняемых приложений можно изменить обработку узла, задав для параметра [Целевая платформа](https://docs.microsoft.com/visualstudio/ide/how-to-configure-projects-to-target-platforms?view=vs-2019) значение **x64** в окне **Свойства проекта** на вкладке **Сборка** .

- Для тестовых проектов на основе VSTest можно изменить обработку узла **, выбрав** > в меню **тест** Visual Studio пункт**Параметры** > тестирования**архитектура процессора по умолчанию как x64** .

- Для локально развернутых веб-приложений ASP.NET можно изменить обработку узла, выбрав **использовать 64-разрядную версию IIS Express для веб-сайтов и проектов** в разделе **Сервис** > **Параметры** > **проекты и решения** > **веб-проекты**.

- Для веб-приложений ASP.NET, развернутых в Azure, можно изменить обработку узла, выбрав **64-разрядную** платформу в **параметрах приложения** в портал Azure.

> [!NOTE] 
> По умолчанию для новых проектов Visual Studio задан **любой ЦП**. Рекомендуется задать для проекта версию **x64** , чтобы не переключиться на **x86**. Проект, настроенный на **любой ЦП** , может легко переключиться на **x86** , если добавляется зависимость только для x86.<br/>
> ServiceInterop. dll должно находиться в папке, из которой выполняется библиотека DLL пакета SDK. Это должно быть проблемой только в том случае, если вы вручную копируете библиотеки DLL или используете пользовательские системы сборки или развертывания.
    
**Включить сборку мусора на стороне сервера (GC)**

Уменьшение частоты сборки мусора может помочь в некоторых случаях. В .NET задайте `true`для [gcServer](https://msdn.microsoft.com/library/ms229357.aspx) значение.

**Масштабирование рабочей нагрузки клиента**

Если вы тестируете на высоких уровнях пропускной способности (более 50 000 единиц запросов в секунду), клиентское приложение может стать узким местом из-за того, что компьютер выгружается при использовании ЦП или использования сети. Если вы достигли этой точки, то можете повысить производительность Azure Cosmos DB, развернув клиентские приложения на нескольких серверах.

> [!NOTE] 
> Высокая загрузка ЦП может привести к увеличению задержки и исключениям времени ожидания запроса.

## <a name="networking"></a>Сеть
<a id="direct-connection"></a>

**Политика подключения: использование режима прямого подключения**

Способ подключения клиента к Azure Cosmos DB имеет важное влияние на производительность, особенно для наблюдаемой задержки на стороне клиента. Для настройки политики клиентских подключений можно использовать два параметра конфигурации: *режим* соединения и *протокол*подключения.  DocumentDB предоставляет два режима подключения:

   * Режим шлюза
      
     Режим шлюза поддерживается на всех платформах SDK и является настроенным по умолчанию для [пакета SDK Microsoft. Azure. DocumentDB](sql-api-sdk-dotnet.md). Если приложение работает в корпоративной сети с ограниченными ограничениями брандмауэра, лучшим выбором является режим шлюза, так как он использует стандартный HTTPS-порт и одну конечную точку. Однако компромисс производительности заключается в том, что режим шлюза включает дополнительный прыжок по сети при каждом считывании или записи данных в Azure Cosmos DB. Поэтому прямой режим обеспечивает лучшую производительность, так как уменьшается число прыжков сети. Также рекомендуется использовать режим подключения шлюза при запуске приложений в средах с ограниченным числом подключений к сокету.

     При использовании пакета SDK в функциях Azure, особенно в [плане потребления](../azure-functions/functions-scale.md#consumption-plan), следует учитывать текущие [ограничения на подключения](../azure-functions/manage-connections.md). В этом случае режим шлюза может быть лучше, если вы также работаете с другими клиентами, основанными на HTTP, в приложении функций Azure.

   * Прямой режим

     Режим прямого подключения поддерживает подключение по протоколу TCP и используется по умолчанию, если используется [пакет SDK Microsoft. Azure. Cosmos/. NET v3](sql-api-sdk-dotnet-standard.md).

В режиме шлюза Azure Cosmos DB использует порт 443 и порты 10250, 10255 и 10256, если вы используете Azure Cosmos DB API для MongoDB. Порт 10250 сопоставляется с экземпляром MongoDB по умолчанию без георепликации. Порты 10255 и 10256 сопоставляются с экземпляром MongoDB, который имеет георепликацию.
     
При использовании протокола TCP в режиме прямого доступа в дополнение к портам шлюза необходимо убедиться, что диапазон портов 10000 и 20000 открыт, так как Azure Cosmos DB использует динамические TCP-порты. Если эти порты не открыты и вы пытаетесь использовать протокол TCP, вы получаете сообщение об ошибке "служба 503 недоступна". В этой таблице показаны режимы подключения, доступные для различных интерфейсов API, а также порты службы, используемые для каждого API:

|Режим подключения  |Поддерживаемый протокол  |Поддерживаемые пакеты SDK  |API и порт службы  |
|---------|---------|---------|---------|
|Шлюз  |   HTTPS    |  Все пакеты SDK    |   SQL (443), MongoDB (10250, 10255, 10256), таблица (443), Cassandra (10350), Graph (443)    |
|Прямой доступ    |     TCP    |  Пакет SDK для .NET    | Порты в диапазоне от 10000 до 20000 |

Azure Cosmos DB предлагает простую, открытую модель программирования RESTFUL по протоколу HTTPS. Кроме того, предлагается эффективный протокол TCP, который также является RESTful в своей коммуникационной модели и доступен через клиентский пакет SDK для .NET. Протокол TCP использует TLS для первоначальной проверки подлинности и шифрования трафика. Чтобы добиться лучшей производительности, рекомендуется по возможности использовать протокол TCP.

Для пакета SDK v3 режим соединения настраивается при создании `CosmosClient` экземпляра в. `CosmosClientOptions` Помните, что по умолчанию используется режим Direct.

```csharp
var serviceEndpoint = new Uri("https://contoso.documents.net");
var authKey = "your authKey from the Azure portal";
CosmosClient client = new CosmosClient(serviceEndpoint, authKey,
new CosmosClientOptions
{
    ConnectionMode = ConnectionMode.Gateway // ConnectionMode.Direct is the default
});
```

Для пакета SDK Microsoft. Azure. DocumentDB настройте режим соединения во время создания `DocumentClient` экземпляра с помощью `ConnectionPolicy` параметра. При использовании прямого режима можно также задать `Protocol` `ConnectionPolicy` параметр с помощью параметра.

```csharp
var serviceEndpoint = new Uri("https://contoso.documents.net");
var authKey = "your authKey from the Azure portal";
DocumentClient client = new DocumentClient(serviceEndpoint, authKey,
new ConnectionPolicy
{
   ConnectionMode = ConnectionMode.Direct, // ConnectionMode.Gateway is the default
   ConnectionProtocol = Protocol.Tcp
});
```

Поскольку протокол TCP поддерживается только в режиме Direct, при использовании режима шлюза протокол HTTPS всегда используется для связи со шлюзом, а `Protocol` значение в `ConnectionPolicy` параметре игнорируется.

![Политика подключения Azure Cosmos DB](./media/performance-tips/connection-policy.png)

**Использование вызовов OpenAsync для избежания задержки при выполнении первого запроса**

По умолчанию первый запрос имеет более высокую задержку, так как ему необходимо получить таблицу маршрутизации адресов. При использовании [пакета SDK версии 2](sql-api-sdk-dotnet.md)вызывайте `OpenAsync()` один раз во время инициализации, чтобы избежать этой задержки запуска при первом запросе:

    await client.OpenAsync();

> [!NOTE] 
> `OpenAsync`создаст запросы на получение таблицы маршрутизации адресов для всех контейнеров в учетной записи. Для учетных записей, имеющих много контейнеров, у которых приложение обращается к подмножеству, `OpenAsync` создаст ненужный объем трафика, что сделает инициализацию слишком высокой. Поэтому использование `OpenAsync` в этом сценарии может оказаться нецелесообразным, поскольку замедляет запуск приложения.

   <a id="same-region"></a>
**Для повышения производительности совместное размещение клиентов в одном регионе Azure**

По возможности разместите приложения, вызывающие Azure Cosmos DB, в том же регионе, что и база данных Azure Cosmos DB. Ниже приведено примерное сравнение: вызовы Azure Cosmos DB в пределах одного региона выполняются в течение 1 мс до 2 мс, но задержка между Западом и Восточная регионом США составляет более 50 мс. Эта задержка может отличаться от запроса к запросу в зависимости от маршрута, выполняемого запросом по мере его передачи от клиента к границе центра обработки данных Azure. Вы можете получить наименьшую возможную задержку, убедившись в том, что вызывающее приложение находится в том же регионе Azure, что и подготовленная Azure Cosmos DBная конечная точка. Список доступных регионов см. в разделе [регионы Azure](https://azure.microsoft.com/regions/#services).

![Политика](./media/performance-tips/same-region.png) подключения Azure Cosmos DB<a id="increase-threads"></a>

**Увеличение числа потоков и задач**

Поскольку вызовы Azure Cosmos DB выполняются по сети, может потребоваться изменить степень параллелизма запросов, чтобы клиентское приложение тратило минимальное время ожидания между запросами. Например, если вы используете [библиотеку параллельных задач](https://msdn.microsoft.com//library/dd460717.aspx).NET, создайте в порядке сотни задач, считывающих или записывающих Azure Cosmos DB.

**Включить ускоренную сеть**
 
 Для сокращения задержки и снижения производительности ЦП рекомендуется включить функцию ускорения сети на клиентских виртуальных машинах. См. статью [Создание виртуальной машины Windows с ускоренной сетью](../virtual-network/create-vm-accelerated-networking-powershell.md) или [Создание виртуальной машины Linux с ускоренной сетью](../virtual-network/create-vm-accelerated-networking-cli.md).

## <a name="sdk-usage"></a>Использование пакета SDK
**Установка последней версии пакета SDK**

Пакеты SDK для Azure Cosmos DB постоянно улучшаются, чтобы обеспечивать самую высокую производительность. Сведения об улучшениях в последней версии пакета SDK см. в статье о [пакете SDK для Azure Cosmos DB](sql-api-sdk-dotnet-standard.md).

**Использование API-интерфейсов потока**

[Пакет SDK для .NET v3](sql-api-sdk-dotnet-standard.md) содержит API-интерфейсы потока, которые могут получать и возвращать данные без сериализации. 

Приложения среднего уровня, которые не используют ответы непосредственно из пакета SDK, но ретранслировать их на другие уровни приложений, могут воспользоваться преимуществами API-интерфейсов потока. Примеры обработки потока см. в разделе примеры [управления элементами](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/master/Microsoft.Azure.Cosmos.Samples/Usage/ItemManagement) .

**Использование одноэлементного Azure Cosmos DB клиента в течение времени существования приложения**

Каждый `DocumentClient` экземпляр `CosmosClient` и является потокобезопасным и выполняет эффективное управление подключениями и кэширование адресов при работе в режиме Direct. Чтобы обеспечить эффективное управление подключениями и повысить производительность клиента пакета SDK, рекомендуется использовать один экземпляр в `AppDomain` течение всего времени существования приложения.

   <a id="max-connection"></a>

**Увеличение System.Net MaxConnections на узле при использовании режима шлюза**

При использовании режима шлюза запросы Azure Cosmos DB выполняются по протоколу HTTPS/RESTFUL. К ним применяются ограничения на количество подключений по умолчанию для каждого имени узла или IP-адреса. Может потребоваться задать `MaxConnections` более высокое значение (от 100 до 1 000), чтобы клиентская библиотека могла использовать несколько одновременных подключений к Azure Cosmos DB. В пакете SDK для .NET 1.8.0 и более поздних версиях значение по умолчанию для [ServicePointManager. DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit.aspx) равно 50. Чтобы изменить значение, можно задать для [Documents. Client. ConnectionPolicy. MaxConnectionLimit](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.client.connectionpolicy.maxconnectionlimit.aspx) более высокое значение.

**Настройка параллельных запросов для секционированных коллекций**

Пакет SDK для SQL .NET 1.9.0 и более поздних версий поддерживает параллельные запросы, позволяющие параллельно запрашивать секционированную коллекцию. Дополнительные сведения см. в [примерах кода](https://github.com/Azure/azure-documentdb-dotnet/blob/master/samples/code-samples/Queries/Program.cs) для работы с пакетами SDK. Параллельные запросы предназначены для обеспечения более высокой задержки и пропускной способности запросов, чем их последовательный аналог. Параллельные запросы предоставляют два параметра, которые можно настроить в соответствии с вашими требованиями. 
- `MaxDegreeOfParallelism`управляет максимальным числом секций, к которым можно обращаться параллельно. 
- `MaxBufferedItemCount`управляет количеством предварительно выбранных результатов.

***Степень параллелизма***

Параллельный запрос работает путем параллельного запроса нескольких секций. Но данные из отдельных секций извлекаться последовательно по отношению к запросу. Параметр `MaxDegreeOfParallelism` в [пакете SDK версии 2](sql-api-sdk-dotnet.md) или `MaxConcurrency` в [пакете SDK v3](sql-api-sdk-dotnet-standard.md) , равный количеству секций, является лучшим шансом достичь наиболее производительного запроса, при условии, что все остальные системные условия остаются прежними. Если число секций неизвестно, можно задать высокое значение степени параллелизма. В качестве степени параллелизма система выберет минимальное значение (число секций, предоставленных пользователем входных данных).

Обратите внимание, что параллельные запросы дают наибольшее преимущество, если данные равномерно распределяются по всем секциям по отношению к запросу. Если секционированная коллекция секционирована таким образом, что все или большинство данных, возвращаемых запросом, Concentrated в нескольких секциях (в худшем случае это одна секция), эти секции приводят к снижению производительности запроса.

***Настройка MaxBufferedItemCount***
    
Параллельный запрос предназначен для предварительного выборки результатов, пока текущий пакет результатов обрабатывается клиентом. Такая предварительная выборка помогает повысить общую задержку запроса. `MaxBufferedItemCount` Параметр ограничивает количество предварительно выбранных результатов. Задайте `MaxBufferedItemCount` ожидаемое число возвращаемых результатов (или большее число), чтобы запрос получал максимальную пользу от предварительной выборки.

Предварительная выборка работает так же, как независимо от степени параллелизма, и существует один буфер для данных из всех секций.  

**Реализация интервала задержки для RetryAfter**

Во время тестирования производительности следует увеличить нагрузку до тех пор, пока не будет отрегулировано небольшое количество запросов. Если запросы регулируемы, клиентское приложение должно отключить регулирование в течение заданного сервером интервала повтора. По отношению к переходу гарантируется минимальное количество времени, затрачиваемого на ожидание между повторными попытками. 

Поддержка политики повтора включена в следующие пакеты SDK:
- Версия 1.8.0 и более поздней версии [пакета SDK для .NET для SQL](sql-api-sdk-dotnet.md) и [пакета SDK для Java для SQL](sql-api-sdk-java.md)
- Версия 1.9.0 и более поздние версии [пакета SDK Node. js для SQL](sql-api-sdk-node.md) и [пакета SDK Python для SQL](sql-api-sdk-python.md)
- Все поддерживаемые версии пакетов SDK для [.NET Core](sql-api-sdk-dotnet-core.md) 

Дополнительные сведения см. в разделе [RetryAfter](https://msdn.microsoft.com/library/microsoft.azure.documents.documentclientexception.retryafter.aspx).
    
В версии 1,19 и более поздних версиях пакета SDK для .NET существует механизм записи дополнительных диагностических сведений и устранения проблем задержки, как показано в следующем примере. Вы можете зарегистрировать строку диагностики для запросов с высокой задержкой чтения. Захваченная диагностическая строка поможет понять, сколько раз было получено 429 ошибок для данного запроса.

```csharp
ResourceResponse<Document> readDocument = await this.readClient.ReadDocumentAsync(oldDocuments[i].SelfLink);
readDocument.RequestDiagnosticsString 
```

**Кэширование URI документов для снижения задержки чтения**

Чтобы повысить производительность операций чтения, по возможности выполняйте кэширование URI документов. Необходимо определить логику для кэширования идентификатора ресурса при создании ресурса. Уточняющие запросы, основанные на идентификаторах ресурсов, выполняются быстрее, чем поиск на основе имен, поэтому кэширование этих значений повышает производительность.

   <a id="tune-page-size"></a>
**Настройка размера страницы для запросов и чтения каналов для повышения производительности**

При выполнении неполного считывания документов с помощью функции чтения канала (например, `ReadDocumentFeedAsync`) или при выполнении SQL-запроса результаты возвращаются в сегментированном виде, если результирующий набор слишком велик. По умолчанию результаты возвращаются в пакетах (не более 100 элементов и не более 1 МБ в каждом пакете).

Чтобы уменьшить количество круговых путей, необходимых для получения всех применимых результатов, можно увеличить размер страницы, используя [x-MS-Max-Item-Count](https://docs.microsoft.com/rest/api/cosmos-db/common-cosmosdb-rest-request-headers) , чтобы запросить столько же заголовков, сколько 1 000. Если требуется отобразить только несколько результатов, например, если пользовательский интерфейс или API приложения возвращают только 10 результатов за раз, можно также уменьшить размер страницы до 10, чтобы уменьшить пропускную способность, потребляемую для операций чтения и запросов.

> [!NOTE] 
> `maxItemCount` Свойство не должно использоваться только для разбиения на страницы. Его основное использование — повышение производительности запросов за счет уменьшения максимального числа элементов, возвращаемых на одной странице.  

Размер страницы также можно задать с помощью доступных пакетов SDK для Azure Cosmos DB. Свойство [макситемкаунт](/dotnet/api/microsoft.azure.documents.client.feedoptions.maxitemcount?view=azure-dotnet) в `FeedOptions` позволяет задать максимальное число элементов, возвращаемых операцией перечисления. Если `maxItemCount` параметр имеет значение-1, пакет SDK автоматически находит оптимальное значение в зависимости от размера документа. Пример:
    
```csharp
IQueryable<dynamic> authorResults = client.CreateDocumentQuery(documentCollection.SelfLink, "SELECT p.Author FROM Pages p WHERE p.Title = 'About Seattle'", new FeedOptions { MaxItemCount = 1000 });
```
    
При выполнении запроса полученные данные отправляются в пакете TCP. Если указано слишком маленькое значение для `maxItemCount`, то число поездок, необходимых для отправки данных в пакете TCP, является большим, что влияет на производительность. Поэтому, если вы не уверены, какое значение следует задать для `maxItemCount` свойства, лучше установить его в значение-1 и позволить пакету SDK выбрать значения по умолчанию.

**Увеличение числа потоков и задач**

См. раздел [увеличение числа потоков и задач](#increase-threads) в разделе "Сетевые подключения" этой статьи.

## <a name="indexing-policy"></a>Политика индексации
 
**Исключить неиспользуемые пути из индексирования для ускорения операций записи**

Политика индексирования Azure Cosmos DB также позволяет указать, какие пути документов следует включить в индексирование или исключить из него с помощью путей индексирования (IndexingPolicy. IncludedPaths и IndexingPolicy. ExcludedPaths). Индексация путей может повысить производительность операций записи и сократить объем хранилища индексов для сценариев, в которых шаблоны запросов известны заранее. Это обусловлено тем, что стоимость индексирования напрямую соотносится с количеством уникальных путей. Например, в этом коде показано, как исключить весь раздел документов (поддерево) из индексирования с помощью подстановочного знака "*":

```csharp
var collection = new DocumentCollection { Id = "excludedPathCollection" };
collection.IndexingPolicy.IncludedPaths.Add(new IncludedPath { Path = "/*" });
collection.IndexingPolicy.ExcludedPaths.Add(new ExcludedPath { Path = "/nonIndexedContent/*");
collection = await client.CreateDocumentCollectionAsync(UriFactory.CreateDatabaseUri("db"), excluded);
```

Дополнительные сведения см. в статье [Политики индексации Azure Cosmos DB](index-policy.md).

## <a name="throughput"></a>Пропускная способность
<a id="measure-rus"></a>

**Измерение и настройка для более низких единиц запросов/секунд использования**

Azure Cosmos DB предлагает обширный набор операций с базами данных. Эти операции включают в себя реляционные и иерархические запросы с определяемыми пользователем функциями, хранимыми процедурами и триггерами, которые работают с документами в коллекции баз данных. Затраты, связанные с каждой из этих операций, зависят от ЦП, операций ввода-вывода и памяти, необходимой для выполнения операции. Вместо того, чтобы думать об аппаратных ресурсах и управлении ими, можно представить единицу запроса (RU) как единую меру для ресурсов, необходимых для выполнения различных операций с базами данных и обслуживания запросов приложений.

Пропускная способность подготавливается на основе числа [единиц запросов](request-units.md) , заданных для каждого контейнера. Потребление единиц запросов оценивается как ставка за секунду. Приложения, превышающие подготовленную частоту единиц запросов для контейнера, будут ограничены до тех пор, пока скорость не станет ниже подготовленного уровня для контейнера. Если приложению требуется более высокий уровень пропускной способности, можно увеличить пропускную способность, выполнив подготовку дополнительных единиц запросов.

Сложность запроса влияет на количество единиц запросов, потребляемых операцией. Количество предикатов, природа предикатов, число определяемых пользователем функций и размер исходного набора данных влияют на стоимость операций запроса.

Чтобы измерить издержки любой операции (создания, обновления или удаления), просмотрите заголовок [x-MS-Request-расход](https://docs.microsoft.com/rest/api/cosmos-db/common-cosmosdb-rest-response-headers) (или `RequestCharge` эквивалентное свойство в `ResourceResponse\<T>` или `FeedResponse\<T>` в пакете SDK для .NET), чтобы определить количество единиц запросов, потребляемых операциями:

```csharp
// Measure the performance (Request Units) of writes
ResourceResponse<Document> response = await client.CreateDocumentAsync(collectionSelfLink, myDocument);
Console.WriteLine("Insert of document consumed {0} request units", response.RequestCharge);
// Measure the performance (Request Units) of queries
IDocumentQuery<dynamic> queryable = client.CreateDocumentQuery(collectionSelfLink, queryString).AsDocumentQuery();
while (queryable.HasMoreResults)
    {
        FeedResponse<dynamic> queryResponse = await queryable.ExecuteNextAsync<dynamic>();
        Console.WriteLine("Query batch consumed {0} request units", queryResponse.RequestCharge);
    }
```             

Плата за запрос, возвращенная в этом заголовке, является долей подготовленной пропускной способности (то есть 2 000 в секунду). Например, если предыдущий запрос возвращает документы 1 000 1-KB, стоимость операции будет 1 000. Таким образом, в течение одной секунды сервер учитывает только два таких запроса до последующего запроса на ограничение скорости. Дополнительные сведения см. в разделе [единицы запроса](request-units.md) и [Калькулятор единиц запросов](https://www.documentdb.com/capacityplanner).
<a id="429"></a>

**Обработка ограничения скорости / слишком высокая частота запросов**

Когда клиент пытается превысить зарезервированную пропускную способность для учетной записи, на сервере нет снижения производительности и не будет использоваться пропускная способность, превышающая зарезервированный уровень. Сервер будет завершать запрос с помощью ошибкой requestratetoolarge (код состояния HTTP 429). Он вернет заголовок [x-MS-Retry-After-MS](https://docs.microsoft.com/rest/api/cosmos-db/common-cosmosdb-rest-response-headers) , который указывает время ожидания (в миллисекундах), по истечении которого пользователь должен будет повторить попытку запроса.

    HTTP Status 429,
    Status Line: RequestRateTooLarge
    x-ms-retry-after-ms :100

Пакеты SDK перехватят этот ответ, обработают заголовок retry-after, указанный сервером, и отправят запрос повторно. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

При наличии более чем одного клиента, постоянно работающего над частотой запросов, количество повторных попыток по умолчанию, установленное на уровне 9, может оказаться недостаточным. В этом случае клиент выдает приложению исключение DocumentClientException с кодом состояния 429. 

Можно изменить число повторных попыток по умолчанию, `RetryOptions` задав для `ConnectionPolicy` экземпляра. По умолчанию в случае превышения заданного счетчика повторов исключение DocumentClientException с кодом состояния 429 возвращается через 30 секунд (совокупное время ожидания). Эта ошибка возвращается даже в том случае, если текущее число повторных попыток меньше максимального, независимо от того, является ли текущее значение значением по умолчанию 9 или значением, определенным пользователем.

Автоматическое поведение повторных попыток помогает повысить устойчивость и удобство использования для большинства приложений. Но это может не быть лучшим поведением при выполнении тестов производительности, особенно при измерении задержки. Если настройка производительности повлияла на регулирование сервера и стала причиной автоматической отправки запросов пакетом SDK, это может стать причиной появления пиков задержек на стороне клиента. Чтобы избежать пиков задержек во время настройки производительности, проверьте расход ресурсов на каждую операцию и убедитесь, что значение частоты запросов не превышено. Дополнительные сведения см. в разделе [единицы запроса](request-units.md).

**Для более высокой пропускной способности разрабатывать небольшие документы**

Плата за запрос (т. е. затраты на обработку запросов) данной операции напрямую соотносится с размером документа. Операции с большими документами изменяют больше операций с малыми документами.

## <a name="next-steps"></a>Дальнейшие шаги
Пример приложения, который используется для оценки Azure Cosmos DB для высокопроизводительных сценариев на нескольких клиентских компьютерах, см. в статье [Тестирование производительности и масштабирования с помощью Azure Cosmos DB](performance-testing.md).

Дополнительные сведения о создании приложения с высокой масштабируемостью и производительностью см. в статье [Partitioning and scaling in Azure Cosmos DB](partition-data.md) (Секционирование и масштабирование в Azure Cosmos DB).
