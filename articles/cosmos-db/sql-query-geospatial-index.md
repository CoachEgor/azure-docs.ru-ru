---
title: Индексирование геопространственных данных с помощью Azure Cosmos DB
description: Индексирование пространственных данных с помощью Azure Cosmos DB
author: timsander1
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 02/20/2020
ms.author: tisande
ms.openlocfilehash: eb0a2b2778b3217e185b9883def6eaa54674cc5b
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79137909"
---
# <a name="index-geospatial-data-with-azure-cosmos-db"></a>Индексирование геопространственных данных с помощью Azure Cosmos DB

Мы разработали ядро СУБД Azure Cosmos DB действительно независимым от схемы и предоставляющих первую поддержку для JSON. Оптимизированное для записи ядро СУБД Azure Cosmos DB изначально распознает пространственные данные, представленные в стандарте геоjson.

По сути, геометрия формируется путем проецирования геодезических координат на двумерную плоскость, которая затем постепенно разделяется на ячейки с помощью **дерева квадрантов**. Эти ячейки связываются с одномерным пространством на основе расположения ячейки на **кривой заполнения гильбертова пространства**, что позволяет сохранить расположение точек. Кроме того, при индексировании данных расположения ячейки проходят так называемый процесс **тесселяции**, то есть все ячейки, которые пересекают расположение, обнаруживаются и сохраняются в виде ключей в индексе Azure Cosmos DB. Во время обработки запроса такие аргументы, как точки и многоугольники, также тесселируются для извлечения диапазонов идентификаторов соответствующих ячеек, а затем используются для получения данных из индекса.

Если указать политику индексации, включающую пространственный индекс для/* (все пути), то все данные, найденные в контейнере, индексируются для эффективных пространственных запросов.

> [!NOTE]
> Azure Cosmos DB поддерживает индексирование точек, LineString, многоугольников и многомногоугольниковых элементов
>
>

## <a name="modifying-geospatial-data-type"></a>Изменение типа геопространственных данных

В контейнере `geospatialConfig` указывает, как будут индексироваться геопространственные данные. Необходимо указать по одному `geospatialConfig` контейнеру: geography или geometry. Если значение не указано, `geospatialConfig` по умолчанию будет выбран тип данных geography. При изменении `geospatialConfig`все существующие геопространственные данные в контейнере будут переиндексированы.

> [!NOTE]
> В настоящее время Azure Cosmos DB поддерживает изменения в Жеоспатиалконфиг в пакете SDK для .NET только в версиях 3,6 и выше.
>

Ниже приведен пример изменения типа геопространственных данных `geometry` путем установки `geospatialConfig` свойства и добавления **BoundingBox**:

```csharp
    //Retrieve the container's details
    ContainerResponse containerResponse = await client.GetContainer("db", "spatial").ReadContainerAsync();
    //Set GeospatialConfig to Geometry
    GeospatialConfig geospatialConfig = new GeospatialConfig(GeospatialType.Geometry);
    containerResponse.Resource.GeospatialConfig = geospatialConfig;
    // Add a spatial index including the required boundingBox
    SpatialPath spatialPath = new SpatialPath
            {  
                Path = "/locations/*",
                BoundingBox = new BoundingBoxProperties(){
                    Xmin = 0,
                    Ymin = 0,
                    Xmax = 10,
                    Ymax = 10
                }
            };
    spatialPath.SpatialTypes.Add(SpatialType.Point);
    spatialPath.SpatialTypes.Add(SpatialType.LineString);
    spatialPath.SpatialTypes.Add(SpatialType.Polygon);
    spatialPath.SpatialTypes.Add(SpatialType.MultiPolygon);

    containerResponse.Resource.IndexingPolicy.SpatialIndexes.Add(spatialPath);

    // Update container with changes
    await client.GetContainer("db", "spatial").ReplaceContainerAsync(containerResponse.Resource);
```

## <a name="geography-data-indexing-examples"></a>Примеры индексирования географических данных

В следующем фрагменте кода JSON показана политика индексации с включенным пространственным индексированием для типа данных **Geography** . Он допустим для пространственных данных с типом данных geography и индексирует все геообъектные точки, многоугольники, многомногоугольники или LineString, найденные в документах для пространственного запроса. При изменении политики индексирования с помощью портал Azure можно указать следующий JSON для политики индексирования, чтобы включить пространственное индексирование в контейнере:

**Политика индексирования контейнеров JSON с пространственным индексированием географии**

```json
    {
       "automatic":true,
       "indexingMode":"Consistent",
        "includedPaths": [
        {
            "path": "/*"
        }
        ],
        "spatialIndexes": [
        {
            "path": "/*",
            "types": [
                "Point",
                "Polygon",
                "MultiPolygon",
                "LineString"
            ]
        }
    ],
       "excludedPaths":[]
    }
```

> [!NOTE]
> Если значение расположения GeoJSON в документе сформировано неверно или является недействительным, оно не будет индексироваться для пространственных запросов. Проверить значение расположения можно с помощью ST_ISVALID и ST_ISVALIDDETAILED.

[Политику индексирования](how-to-manage-indexing-policy.md) также можно изменить с помощью Azure CLI, PowerShell или любого пакета SDK.

## <a name="geometry-data-indexing-examples"></a>Примеры индексирования геометрических данных

Для типа данных **Geometry** , аналогичного типу данных geography, необходимо указать соответствующие пути и типы для индексирования. Кроме того, необходимо также указать `boundingBox` в политике индексирования, чтобы указать, какая именно область будет индексироваться для конкретного пути. Для каждого геопространственного пути требуется`boundingBox`собственный.

Ограничивающий прямоугольник состоит из следующих свойств:

- **xmin**: минимальная индексированная Координата x
- **ymin**: минимальная индексированная координата y
- **xmax**: максимальная индексированная Координата x
- **ymax**: максимальная индексированная координата y.

Ограничивающий прямоугольник является обязательным, так как геометрические данные занимают плоскость, которая может быть бесконечна. Однако для пространственных индексов требуется конечное пространство. Для типа данных **Geography** земля является границей, и вам не нужно задавать ограничивающий прямоугольник.

Необходимо создать ограничивающий прямоугольник, который содержит все (или все) данные. Пространственный индекс может использовать только операции, вычисленные для объектов, полностью находящихся внутри ограничивающего прямоугольника. Не следует делать размер ограничивающего прямоугольника значительно больше, чем необходимо, так как это отрицательно повлияет на производительность запросов.

Ниже приведен пример политики индексации, которая индексирует **геометрические** данные с `geometry`помощью **жеоспатиалконфиг** , для которых задано значение:

```json
 {
    "indexingMode": "consistent",
    "automatic": true,
    "includedPaths": [
        {
            "path": "/*"
        }
    ],
    "excludedPaths": [
        {
            "path": "/\"_etag\"/?"
        }
    ],
    "spatialIndexes": [
        {
            "path": "/locations/*",
            "types": [
                "Point",
                "LineString",
                "Polygon",
                "MultiPolygon"
            ],
            "boundingBox": {
                "xmin": -10,
                "ymin": -20,
                "xmax": 10,
                "ymax": 20
            }
        }
    ]
}
```

Указанная выше политика индексирования имеет **BoundingBox** (-10, 10) для координат x и (-20, 20) для координат y. Контейнер с указанной выше политикой индексации будет индексировать все точки, многоугольники, многомногоугольники и LineString, которые полностью находятся в пределах этого региона.

> [!NOTE]
> Если вы попытаетесь добавить политику индексирования с **BoundingBox** в контейнер с `geography` типом данных, произойдет сбой. Перед добавлением BoundingBox необходимо изменить **жеоспатиалконфиг** контейнера. **boundingBox** `geometry` Вы можете добавить данные и изменить оставшуюся часть политики индексирования (например, пути и типы) до или после выбора геопространственного типа данных для контейнера.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы ознакомились с предварительными сведениями о поддержке геопространственных данных в Azure Cosmos DB, вы можете сделать следующее:

* Дополнительные сведения о запросах Azure Cosmos DB см. [здесь](sql-query-getting-started.md).
* Дополнительные сведения о [запросе пространственных данных с помощью Azure Cosmos DB](sql-query-geospatial-query.md)
* Дополнительные сведения о [геопространственных и географических данных расположения в Azure Cosmos DB](sql-query-geospatial-intro.md)