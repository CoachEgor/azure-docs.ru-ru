---
title: Индекс геопространственных данных с Azure Cosmos DB
description: Индекс пространственных данных с Azure Cosmos DB
author: timsander1
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 02/20/2020
ms.author: tisande
ms.openlocfilehash: eb0a2b2778b3217e185b9883def6eaa54674cc5b
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79137909"
---
# <a name="index-geospatial-data-with-azure-cosmos-db"></a>Индекс геопространственных данных с Azure Cosmos DB

Мы разработали движок базы данных Azure Cosmos DB, чтобы быть по-настоящему агностиком схемы и обеспечить первоклассную поддержку JSON. Оптимизированный механизм базы данных Azure Cosmos DB написать наместере понимает пространственные данные, представленные в стандарте GeoJSON.

По сути, геометрия формируется путем проецирования геодезических координат на двумерную плоскость, которая затем постепенно разделяется на ячейки с помощью **дерева квадрантов**. Эти ячейки связываются с одномерным пространством на основе расположения ячейки на **кривой заполнения гильбертова пространства**, что позволяет сохранить расположение точек. Кроме того, при индексировании данных расположения ячейки проходят так называемый процесс **тесселяции**, то есть все ячейки, которые пересекают расположение, обнаруживаются и сохраняются в виде ключей в индексе Azure Cosmos DB. Во время обработки запроса такие аргументы, как точки и многоугольники, также тесселируются для извлечения диапазонов идентификаторов соответствующих ячеек, а затем используются для получения данных из индекса.

Если вы указываете политику индексирования, которая включает пространственный индекс для /з (все пути), то все данные, найденные в контейнере, индексируются для эффективных пространственных запросов.

> [!NOTE]
> Azure Cosmos DB поддерживает индексацию точек, LineStrings, полигонов и мультипологонов
>
>

## <a name="modifying-geospatial-data-type"></a>Изменение типа геопространственных данных

В контейнере `geospatialConfig` указывается, как будут индексироваться геопространственные данные. Вы должны `geospatialConfig` указать один на контейнер: география или геометрия. Если не указано, `geospatialConfig` будет по умолчанию для типа данных географии. При изменении, `geospatialConfig`все существующие геопространственные данные в контейнере будут переиндексированы.

> [!NOTE]
> Azure Cosmos DB в настоящее время поддерживает модификации geospatialConfig в .NET SDK только в версиях 3.6 и выше.
>

Вот пример для изменения геопространственного типа `geometry` данных, `geospatialConfig` установив свойство и добавив **ограничивающийBox:**

```csharp
    //Retrieve the container's details
    ContainerResponse containerResponse = await client.GetContainer("db", "spatial").ReadContainerAsync();
    //Set GeospatialConfig to Geometry
    GeospatialConfig geospatialConfig = new GeospatialConfig(GeospatialType.Geometry);
    containerResponse.Resource.GeospatialConfig = geospatialConfig;
    // Add a spatial index including the required boundingBox
    SpatialPath spatialPath = new SpatialPath
            {  
                Path = "/locations/*",
                BoundingBox = new BoundingBoxProperties(){
                    Xmin = 0,
                    Ymin = 0,
                    Xmax = 10,
                    Ymax = 10
                }
            };
    spatialPath.SpatialTypes.Add(SpatialType.Point);
    spatialPath.SpatialTypes.Add(SpatialType.LineString);
    spatialPath.SpatialTypes.Add(SpatialType.Polygon);
    spatialPath.SpatialTypes.Add(SpatialType.MultiPolygon);

    containerResponse.Resource.IndexingPolicy.SpatialIndexes.Add(spatialPath);

    // Update container with changes
    await client.GetContainer("db", "spatial").ReplaceContainerAsync(containerResponse.Resource);
```

## <a name="geography-data-indexing-examples"></a>Примеры индексирования данных географии

Следующий фрагмент JSON показывает политику индексирования с пространственной индексацией, включенной для типа данных **географии.** Он действителен для пространственных данных с типом данных географии и будет индексировать любые гео-jSON Point, Polygon, MultiPolygon или LineString, найденные в документах для пространственного запроса. При изменении политики индексирования с помощью портала Azure можно указать следующую политику JSON для индексации для включения пространственной индексации в контейнере:

**Политика индексирования контейнеров JSON с географической пространственной индексацией**

```json
    {
       "automatic":true,
       "indexingMode":"Consistent",
        "includedPaths": [
        {
            "path": "/*"
        }
        ],
        "spatialIndexes": [
        {
            "path": "/*",
            "types": [
                "Point",
                "Polygon",
                "MultiPolygon",
                "LineString"
            ]
        }
    ],
       "excludedPaths":[]
    }
```

> [!NOTE]
> Если значение расположения GeoJSON в документе сформировано неверно или является недействительным, оно не будет индексироваться для пространственных запросов. Проверить значение расположения можно с помощью ST_ISVALID и ST_ISVALIDDETAILED.

Вы также можете [изменить политику индексирования](how-to-manage-indexing-policy.md) с помощью Azure CLI, PowerShell или любого SDK.

## <a name="geometry-data-indexing-examples"></a>Примеры индексирования данных геометрии

При типе данных **геометрии,** аналогичном типу данных географии, необходимо указать соответствующие пути и типы для индексации. Кроме того, необходимо также `boundingBox` указать в политике индексирования, чтобы указать нужную область, которая будет проиндексирована для конкретного пути. Каждый геопространственный путь`boundingBox`требует своего.

Коробка с ограниченной связи состоит из следующих свойств:

- **xmin**: минимальная проиндексированная x координата
- **ymin**: минимальный индексированный y координат
- **xmax**: максимальная проиндексированная x координата
- **ymax**: максимальная проиндексированная y координата

Коробка ограниченности необходима, потому что геометрические данные занимают плоскость, которая может быть бесконечной. Пространственные индексы, однако, требуют конечного пространства. Для типа данных **географии** Земля является границей, и вам не нужно устанавливать ограничивающую коробку.

Необходимо создать ограничивающий ящик, содержащий все (или большинство) ваших данных. Использовать пространственный индекс смогут только операции, вычисляемые на объектах, полностью находящихся внутри ящика для границ. Не следует делать ящик для ограниченности значительно больше, чем это необходимо, поскольку это негативно скажется на производительности запроса.

Вот пример политики индексирования, которая индексирует данные **геометрии** `geometry`с **geospatialConfig** набор:

```json
 {
    "indexingMode": "consistent",
    "automatic": true,
    "includedPaths": [
        {
            "path": "/*"
        }
    ],
    "excludedPaths": [
        {
            "path": "/\"_etag\"/?"
        }
    ],
    "spatialIndexes": [
        {
            "path": "/locations/*",
            "types": [
                "Point",
                "LineString",
                "Polygon",
                "MultiPolygon"
            ],
            "boundingBox": {
                "xmin": -10,
                "ymin": -20,
                "xmax": 10,
                "ymax": 20
            }
        }
    ]
}
```

Вышеупомянутая политика индексирования имеет **ограничивающийбокс** (-10, 10) для х координат и (-20, 20) для y координат. Контейнер с вышеуказанной политикой индексирования будет индексировать все точки, полигоны, multiPolygons и LineStrings, которые полностью находятся в пределах этого региона.

> [!NOTE]
> Если вы попытаетесь добавить политику индексирования с `geography` **ограничивающим box** в контейнер с типом данных, он выйдет из строя. Вы должны изменить **geospatialConfig** контейнера, чтобы быть `geometry` перед добавлением **boundingBox**. Можно добавлять данные и изменять оставшуюся часть политики индексирования (например, пути и типы) до или после выбора типа геопространственных данных для контейнера.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы ознакомились с предварительными сведениями о поддержке геопространственных данных в Azure Cosmos DB, вы можете сделать следующее:

* Дополнительные сведения о запросах Azure Cosmos DB см. [здесь](sql-query-getting-started.md).
* Узнайте больше о [запросе пространственных данных с помощью Azure Cosmos DB](sql-query-geospatial-query.md)
* Узнайте больше о [геопространственных данных и данных о местоположении GeoJSON в Azure Cosmos DB](sql-query-geospatial-intro.md)