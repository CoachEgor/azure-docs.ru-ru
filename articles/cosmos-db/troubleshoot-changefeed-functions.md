---
title: Диагностика и устранение неполадок при использовании триггера функций Azure для Cosmos DB
description: Распространенные проблемы, обходные пути и шаги диагностики при использовании триггера функций Azure для Cosmos DB
author: ealsur
ms.service: cosmos-db
ms.date: 07/17/2019
ms.author: maquaran
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: b90986e449df7e81f97f9ef86ce3cf69621c76d6
ms.sourcegitcommit: e9c866e9dad4588f3a361ca6e2888aeef208fc35
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/19/2019
ms.locfileid: "68335752"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-functions-trigger-for-cosmos-db"></a>Диагностика и устранение неполадок при использовании триггера функций Azure для Cosmos DB

В этой статье рассматриваются распространенные проблемы, способы их устранения и диагностические действия при использовании [триггера функций Azure для Cosmos DB](change-feed-functions.md).

## <a name="dependencies"></a>Зависимости

Триггеры и привязки функций Azure для Cosmos DB зависят от пакетов расширений в базовой среде выполнения функций Azure. Всегда обновляйте эти пакеты, так как они могут включать исправления и новые функции, которые могут помочь в решении любых потенциальных проблем.

* Сведения о функциях Azure версии 2 см. в разделе [Microsoft. Azure. веб-jobs. Extensions. CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB).
* Сведения о функциях Azure версии 1 см. в разделе [Microsoft. Azure. веб-задания. Extensions. DocumentDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.DocumentDB).

Эта статья всегда будет обращаться к функциям Azure версии 2 при каждом упоминании среды выполнения, если не указано явно.

## <a name="consume-the-azure-cosmos-db-sdk-independently"></a>Использование пакета SDK Azure Cosmos DB независимо

Ключевыми функциями пакета расширения являются предоставление поддержки триггера и привязок функций Azure для Cosmos DB. Он также включает [пакет SDK для .net Azure Cosmos DB](sql-api-sdk-dotnet-core.md), который полезен, если вы хотите взаимодействовать с Azure Cosmos DB программным способом без использования триггера и привязок.

Если вы хотите использовать пакет SDK для Azure Cosmos DB, убедитесь, что вы не добавили в проект ссылку на другой пакет NuGet. Вместо этого разрешите **ссылку на пакет SDK с помощью пакета расширения функций Azure**. Использование пакета SDK Azure Cosmos DB отдельно от триггера и привязок

Кроме того, если вы вручную создаете собственный экземпляр [клиента Azure Cosmos DB SDK](./sql-api-sdk-dotnet-core.md), следует следовать шаблону, который использует только один экземпляр клиента, [используя подход одноэлементного шаблона](../azure-functions/manage-connections.md#documentclient-code-example-c). Этот процесс позволит избежать потенциальных проблем с сокетами в операциях.

## <a name="common-scenarios-and-workarounds"></a>Распространенные сценарии и решения

### <a name="azure-function-fails-with-error-message-collection-doesnt-exist"></a>Функция Azure завершается с ошибкой, коллекция сообщений об ошибках не существует

Функция Azure завершается сбоем с сообщением об ошибке "либо исходная коллекция" Collection-Name "(в базе данных" Database-Name "), либо коллекция аренды" collection2-Name "(в базе данных" Database2-Name ") не существует. Перед запуском прослушивателя должны существовать обе коллекции. Чтобы автоматически создать коллекцию аренд, установите для "Креателеасеколлектионифнотексистс" значение "true".

Это означает, что один или оба контейнера Azure Cosmos, необходимые для работы триггера, не существуют или недоступны для функции Azure. **Сама ошибка сообщит, какая база данных и контейнеры Azure Cosmos являются триггером, который ищется** в зависимости от конфигурации.

1. Проверьте атрибут и то, что он **ссылается на параметр, существующий в приложение-функция Azure.** `ConnectionStringSetting` Значение этого атрибута не должно быть самой строкой подключения, а именем параметра конфигурации.
2. Убедитесь, что `databaseName` и `collectionName` существует в вашей учетной записи Azure Cosmos. Если вы используете автоматическую замену значений ( `%settingName%` с помощью шаблонов), убедитесь, что имя параметра существует в приложение-функцияе Azure.
3. Если не указать `LeaseCollectionName/leaseCollectionName`, по умолчанию используется значение "Аренда". Убедитесь, что такой контейнер существует. При необходимости можно задать `CreateLeaseCollectionIfNotExists` атрибуту `true` триггера значение для автоматического создания.
4. Проверьте [конфигурацию брандмауэра учетной записи Azure Cosmos](how-to-configure-firewall.md) , чтобы увидеть, что она не блокирует функцию Azure.

### <a name="azure-function-fails-to-start-with-shared-throughput-collection-should-have-a-partition-key"></a>Не удается запустить функцию Azure, так как "Общая пропускная способность должна иметь ключ секции"

Предыдущие версии расширения Azure Cosmos DB не поддерживали использование контейнера аренды, созданного в [базе данных с общей пропускной способностью](./set-throughput.md#set-throughput-on-a-database). Чтобы устранить эту проблему, обновите расширение [Microsoft. Azure. веб-задания. Extensions. CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB) , чтобы получить последнюю версию.

### <a name="azure-function-fails-to-start-with-the-lease-collection-if-partitioned-must-have-partition-key-equal-to-id"></a>Функция Azure не запускается с параметром "сбор аренд, если он секционирован, должен иметь ключ секции, равный идентификатору".

Эта ошибка означает, что текущий контейнер аренды секционирован, а путь ключа раздела — нет `/id`. Чтобы устранить эту проблему, необходимо повторно создать контейнер аренды с помощью `/id` ключа секции.

### <a name="you-see-a-value-cannot-be-null-parameter-name-o-in-your-azure-functions-logs-when-you-try-to-run-the-trigger"></a>Вы видите "значение не может быть null. Имя параметра: o "в журналах функций Azure при попытке запустить триггер

Эта проблема возникает, если вы используете портал Azure и пытаетесь нажать кнопку **выполнить** на экране при проверке функции Azure, которая использует триггер. Триггер не требует выбора запуска для запуска. он будет автоматически запускаться при развертывании функции Azure. Если вы хотите проверить поток журнала функции Azure на портал Azure, просто перейдите к отслеживаемому контейнеру и вставьте новые элементы, и вы автоматически увидите триггер, выполняемый.

### <a name="my-changes-take-too-long-be-received"></a>Изменения были получены слишком долго

Этот сценарий может иметь несколько причин, и все они должны быть проверены:

1. Развернута ли функция Azure в том же регионе, что и учетная запись Azure Cosmos? Чтобы обеспечить оптимальную задержку в сети, как функция Azure, так и учетная запись Azure Cosmos должны находиться в одном регионе Azure.
2. Будут ли изменения, происходящие в контейнере Azure Cosmos, непрерывными или постоянными?
Если это последнее, может быть задержка между сохранением изменений и подборкой функции Azure. Это происходит потому, что когда триггер проверяет наличие изменений в контейнере Azure Cosmos и не находит ожидающих считываний, он запустится в течение настраиваемого периода времени (по умолчанию 5 секунд), прежде чем проверять наличие новых изменений (во избежание высокой степени потребления единиц запросов). Это время сна можно настроить с помощью `FeedPollDelay/feedPollDelay` параметра в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration) триггера (значение должно быть в миллисекундах).
3. В контейнере Azure Cosmos может быть [ограничена скорость](./request-units.md).
4. Вы можете использовать `PreferredLocations` атрибут в триггере, чтобы указать список регионов Azure с разделителями-запятыми для определения предпочтительного порядка подключения.

### <a name="some-changes-are-missing-in-my-trigger"></a>Некоторые изменения отсутствуют в триггере

Если вы обнаружите, что некоторые изменения, произошедшие в контейнере Azure Cosmos, не выбираются функцией Azure, необходимо выполнить начальный этап исследования.

Когда функция Azure получает изменения, она часто обрабатывает их и при необходимости отправляет результат в другое место назначения. При изучении недостающих изменений необходимо определить, **какие изменения принимаются в точке приема** (при запуске функции Azure), а не в месте назначения.

Если в назначении отсутствуют некоторые изменения, это может означать, что во время выполнения функции Azure после получения изменений происходит ошибка.

В этом сценарии лучше всего добавить `try/catch blocks` в код и в циклах, которые могут обрабатывать изменения, обнаружить ошибки в конкретном подмножестве элементов и соответствующим образом обработать их (отправить в другое хранилище для дальнейшего использования). анализ или повторная попытка). 

> [!NOTE]
> Триггеры функций Azure для Cosmos DB по умолчанию не будут повторять пакет изменений, если во время выполнения кода возникло необработанное исключение. Это означает, что изменения не поступали в место назначения, так как не удается обработать их.

Если вы обнаружите, что некоторые изменения не были получены вашим триггером, наиболее распространенным сценарием является **выполнение другой функции Azure**. Это может быть другая функция Azure, развернутая в Azure, или функция Azure, которая выполняется локально на компьютере разработчика, который имеет такую **же конфигурацию (в** том же отслеживаемом и контейнере аренды), и эта функция Azure переносить подмножество изменений, которые вы Предполагается, что функция Azure будет обрабатываться.

Кроме того, сценарий можно проверить, если известно, сколько экземпляров Azure приложение-функция вы выполняли. Если вы просматриваете контейнер аренды и подсчитываете количество элементов аренды в, уникальные значения `Owner` свойства в них должны быть равны числу экземпляров приложение-функция. Если у вас больше владельцев, чем у известных экземпляров Azure приложение-функция, это означает, что эти дополнительные владельцы являются одним из «кражи» изменений.

Одним из простых способов решения этой проблемы является применение `LeaseCollectionPrefix/leaseCollectionPrefix` к функции с новым или другим значением или, Кроме того, тестирование с новым контейнером аренды.

### <a name="binding-can-only-be-done-with-ireadonlylistdocument-or-jarray"></a>Привязку можно выполнить только с помощью\<иреадонлилист документов > или жаррай

Эта ошибка возникает, если проект функций Azure (или любой проект, на который указывает ссылка) содержит ручную ссылку NuGet на Azure Cosmos DB SDK с версией, отличной от версии, предоставленной [Cosmos DB расширением функций Azure](./troubleshoot-changefeed-functions.md#dependencies).

Чтобы обойти эту ситуацию, удалите добавленную ссылку NuGet вручную и разрешите ссылку на Azure Cosmos DB SDK с помощью пакета расширения "функции Azure Cosmos DB".

## <a name="next-steps"></a>Следующие шаги

* [Включение мониторинга для функций Azure](../azure-functions/functions-monitoring.md)
* [Устранение неполадок пакета SDK для .NET Azure Cosmos DB](./troubleshoot-dot-net-sdk.md)
