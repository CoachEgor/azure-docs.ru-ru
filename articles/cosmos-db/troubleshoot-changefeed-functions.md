---
title: Проблемы устранения неполадок при использовании триггера Azure Functions для Cosmos DB
description: Общие проблемы, обходные пути и диагностические шаги при использовании триггера Azure Functions для Cosmos DB
author: ealsur
ms.service: cosmos-db
ms.date: 03/13/2020
ms.author: maquaran
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 7bf7d418e3f2680b32f61e42cffc76c921068508
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79365514"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-functions-trigger-for-cosmos-db"></a>Диагностика и устранение неполадок при использовании триггера Azure Functions для Cosmos DB

В этой статье рассматриваются общие проблемы, обходные пути и диагностические шаги при использовании [триггера Azure Functions для Cosmos DB.](change-feed-functions.md)

## <a name="dependencies"></a>Зависимости

Триггер и привязки функций Azure для Cosmos DB зависят от пакетов расширения в течение базового времени выполнения Azure Functions. Всегда обновляйте эти пакеты, так как они могут включать исправления и новые функции, которые могут решить любые потенциальные проблемы, с которыми вы можете столкнуться:

* Для функций Azure V2 [см.](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB)
* Для функций Azure V1 [см.](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.DocumentDB)

Эта статья всегда будет ссылаться на Azure Functions V2 всякий раз, когда упоминается время выполнения, если точно не указано.

## <a name="consume-the-azure-cosmos-db-sdk-independently"></a>Потребляйте Azure Cosmos DB SDK самостоятельно

Ключевая функциональность пакета расширений заключается в обеспечении поддержки триггеров и привязок функций Azure для Cosmos DB. Он также включает в себя [Azure Cosmos DB .NET SDK](sql-api-sdk-dotnet-core.md), что полезно, если вы хотите взаимодействовать с Azure Cosmos DB программно без использования триггера и привязок.

Если вы хотите использовать SDK Azure Cosmos DB, убедитесь, что вы не добавите в свой проект еще одну ссылку на пакет NuGet. Вместо этого **пусть ссылка SDK разрешится через пакет расширения Azure Functions.** Потребляйте Azure Cosmos DB SDK отдельно от триггера и привязок

Кроме того, если вы вручную создаете свой собственный экземпляр [клиента Azure Cosmos DB SDK,](./sql-api-sdk-dotnet-core.md)вы должны следовать шаблону наличия только одного экземпляра [клиента, используя шаблонный подход Singleton.](../azure-functions/manage-connections.md#documentclient-code-example-c) Этот процесс позволит избежать потенциальных проблем с розетками в ваших операциях.

## <a name="common-scenarios-and-workarounds"></a>Общие сценарии и обходные пути

### <a name="azure-function-fails-with-error-message-collection-doesnt-exist"></a>Функция Azure выходит из строя при сборе сообщений об ошибках

Функция Azure не справляется с сообщением об ошибке "Либо не существует "имя коллекции"-коллекции исходного кода (в базе данных 'имя базы данных)) или коллекция аренды 'collection2-name') (в базе данных 'database2-name'). Обе коллекции должны существовать до начала слушателя. Чтобы автоматически создать коллекцию аренды, установите 'CreateLeaseCollectionIfNotExists' на 'истинное'"

Это означает, что один или оба контейнера Azure Cosmos, необходимые для работы триггера, не существуют или недоступны для функции Azure. **Сама ошибка сообщит вам, какая база данных Azure Cosmos и контейнер является триггером, который ищется** в зависимости от вашей конфигурации.

1. Проверьте `ConnectionStringSetting` атрибут и **ссылки на параметр, который существует в приложении Функции Azure.** Значение этого атрибута должно быть не самой строкой соединения, а названием настройки конфигурации.
2. Убедитесь, `databaseName` `collectionName` что в вашей учетной записи Azure Cosmos существует и существует. Если вы используете автоматическую `%settingName%` замену значений (с использованием шаблонов), убедитесь, что имя настройки существует в приложении Azure Function App.
3. Если вы не указываете, `LeaseCollectionName/leaseCollectionName`по умолчанию является "аренда". Убедитесь, что такой контейнер существует. Дополнительно можно настроить `CreateLeaseCollectionIfNotExists` атрибут в триггере, чтобы `true` автоматически создать его.
4. Проверьте [конфигурацию брандмауэра учетной записи Azure Cosmos,](how-to-configure-firewall.md) чтобы убедиться, что это не блокирует функцию Azure.

### <a name="azure-function-fails-to-start-with-shared-throughput-collection-should-have-a-partition-key"></a>Функция Azure не начинается с "Общий сбор пропускной памяти должен иметь ключ раздела"

Предыдущие версии расширения Azure Cosmos DB не поддерживали использование контейнера аренды, созданного в [общей базе данных пропускной воды.](./set-throughput.md#set-throughput-on-a-database) Чтобы решить эту проблему, обновите расширение [Microsoft.Azure.WebJobs.Extensions.CosmosDB,](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB) чтобы получить последнюю версию.

### <a name="azure-function-fails-to-start-with-partitionkey-must-be-supplied-for-this-operation"></a>Функция Azure не начинается с "PartitionKey должна быть поставлена для этой операции".

Эта ошибка означает, что в настоящее время используется раздельная коллекция аренды со старой [зависимостью расширения.](#dependencies) Обновление до последней доступной версии. Если в настоящее время вы работаете на Azure Functions V1, вам необходимо перейти на Azure Functions V2.

### <a name="azure-function-fails-to-start-with-the-lease-collection-if-partitioned-must-have-partition-key-equal-to-id"></a>Функция Azure не начинается с "Сбор аренды, если он разделен, должен иметь ключ раздела, равный идентификатору".

Эта ошибка означает, что текущий контейнер аренды разделен, но путь `/id`ключа раздела не является. Чтобы решить эту проблему, необходимо воссоздать контейнер `/id` аренды с ключом раздела.

### <a name="you-see-a-value-cannot-be-null-parameter-name-o-in-your-azure-functions-logs-when-you-try-to-run-the-trigger"></a>Вы видите "Достоинство не может быть недействительным. Имя параметра: o" в журналах функций Azure при попытке запуска триггера

Эта проблема появляется, если вы используете портал Azure, и вы пытаетесь выбрать кнопку **Run** на экране при проверке функции Azure, использующей триггер. Спусковой крючок не требует для запуска Запуска, он автоматически запускается при развертывании функции Azure. Если вы хотите проверить поток журнала функции Azure на портале Azure, просто перейдите в контролируемый контейнер и вставьте несколько новых элементов, вы автоматически увидите выполнение триггера.

### <a name="my-changes-take-too-long-to-be-received"></a>Мои изменения занимают слишком много времени, чтобы быть получены

Этот сценарий может иметь несколько причин, и все они должны быть проверены:

1. Развернута ли ваша Функция Azure в том же регионе, что и ваша учетная запись Azure Cosmos? Для оптимальной задержки в сети Функция Azure и ваша учетная запись Azure Cosmos должны располагаться в одном регионе Azure.
2. Изменения происходят в вашем контейнере Azure Cosmos непрерывно или случайно?
Если случайно, может наблюдаться задержка между сохраняемыми изменениями и их получением Функцией Azure. Это связано с тем, что когда триггер проверяет изменения в контейнере Azure Cosmos и не находит ожидающих запросов на чтение, он будет пребывать в режиме ожидания в течение настраиваемого промежутка времени (5 секунд по умолчанию), прежде чем проверить наличие новых изменений (чтобы избежать высокого уровня потребления ЕЗ). Это время ожидания можно настроить с помощью параметра `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) триггера (значение следует указать в миллисекундах).
3. Контейнер Azure Cosmos может быть [ограничен по ставке.](./request-units.md)
4. Можно использовать `PreferredLocations` атрибут в триггере для указания разделенного списка регионов Azure, разделенного запятой, чтобы определить предпочтительный порядок подключения.

### <a name="some-changes-are-repeated-in-my-trigger"></a>Некоторые изменения повторяются в моем триггере

Понятие "изменение" - это операция над документом. Наиболее распространенными сценариями, в которых получаются события для одного и того же документа:
* Учетная запись использует согласованность Eventual. При потреблении канала изменения в уровне согласованности Eventual могут быть дублирующиеся события между последующими операциями чтения подачи на изменение (последнее событие одной операции чтения отображается как первое из следующих).
* Документ обновляется. Лента изменений может содержать несколько операций для одних и тех же документов, если этот документ получает обновления, он может подобрать несколько событий (по одному для каждого обновления). Один простой способ различать различные операции `_lsn` для одного и того же документа — отслеживать [свойство для каждого изменения.](change-feed.md#change-feed-and-_etag-_lsn-or-_ts) Если они не совпадают, это разные изменения по сравнению с тем же документом.
* Если вы идентифицируете `id`документы, помните, что уникальным `id` идентификатором документа является ключ и `id` его ключ раздела (может быть два документа с одинаковым, но разным ключом раздела).

### <a name="some-changes-are-missing-in-my-trigger"></a>Некоторые изменения отсутствуют в моем триггере

Если вы обнаружите, что некоторые изменения, произошедшими в контейнере Azure Cosmos, не подхватываются функцией Azure, необходимо провести начальный этап исследования.

Когда функция Azure получает изменения, она часто обрабатывает их и может по желанию отправить результат в другой пункт назначения. При исследовании отсутствующих изменений убедитесь, что вы **измеряете, какие изменения поступают в точке приема** (когда начинается функция Azure), а не в пункте назначения.

Если некоторые изменения отсутствуют в пункте назначения, это может означать, что при выполнении функции Azure после получения изменений происходит какая-то ошибка.

В этом сценарии лучшим курсом `try/catch` действий является добавление блоков в коде и внутри циклов, которые могут обрабатывать изменения, чтобы обнаружить любой сбой для определенного подмножества элементов и обрабатывать их соответствующим образом (отправить их в другое хранилище для дальнейшего анализа или повторной попытки). 

> [!NOTE]
> По умолчанию триггер Функций Azure для Cosmos DB не будет повторно запускать пакет изменений, если во время выполнения кода возникнет необработанное исключение. Это означает, что причиной того, что изменения не прибыли в пункт назначения, является то, что вы не в состоянии обработать их.

Если вы обнаружите, что некоторые изменения не были получены вообще вашим триггером, наиболее распространенным сценарием является то, что существует **еще одна функция Azure, работаяна**с помощью. Это может быть еще одна функция Azure, развернутая в Azure, или функция Azure, работаевая локально на машине разработчика, которая имеет **точно такую же конфигурацию** (такие же контролируемые и арендуемые контейнеры), и эта функция Azure крадет подмножество изменений, которые можно ожидать от функции Azure.

Кроме того, сценарий может быть проверен, если вы знаете, сколько экземпляров Azure Function App вы работаете. Если вы проверяете контейнер аренды и подсчитываете количество `Owner` элементов аренды внутри, отличительные значения имущества в них должны быть равны количеству экземпляров вашего функционального приложения. Если владельцев больше, чем известных экземпляров Azure Function App, это означает, что эти дополнительные владельцы являются теми, кто «крадет» изменения.

Один простой способ обойти эту ситуацию, заключается в том, `LeaseCollectionPrefix/leaseCollectionPrefix` чтобы применить к вашей функции с новой / различной стоимости или, в качестве альтернативы, тест с новым контейнером аренды.

### <a name="need-to-restart-and-reprocess-all-the-items-in-my-container-from-the-beginning"></a>Необходимо перезапустить и переработать все элементы в моем контейнере с самого начала 
Для переработки всех элементов в контейнере с самого начала:
1. Остановите функцию Azure, если она работает в настоящее время. 
1. Удалите документы в коллекции аренды (или удалить и воссоздать коллекцию аренды, чтобы она была пуста)
1. Установите атрибут [StartFromStarting](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) CosmosDBTrigger в своей функции на истину. 
1. Перезапустите функцию Azure. Теперь он будет читать и обрабатывать все изменения с самого начала. 

Установка [StartFromStart](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) в реальность позволит функции Azure начать чтение изменений с начала истории коллекции, а не текущего времени. Это работает только тогда, когда уже нет договоров аренды (то есть документов в коллекции аренды). Установка этого свойства на истину, когда уже созданы договоры аренды, не имеет никакого эффекта; в этом сценарии, когда функция остановлена и перезапущена, она начнет считывать с последнего контрольно-пропускного пункта, как это определено в сборе аренды. Чтобы переработать с самого начала, следуйте вышеуказанным шагам 1-4.  

### <a name="binding-can-only-be-done-with-ireadonlylistdocument-or-jarray"></a>Связывание может быть сделано\<только с IReadOnlyList документ> или JArray

Эта ошибка возникает, если проект Azure Functions (или любой упомянутый проект) содержит ручную ссылку NuGet на Azure Cosmos DB SDK с другой версией, чем та, которая предусмотрена [расширением Azure Functions Cosmos DB.](./troubleshoot-changefeed-functions.md#dependencies)

Чтобы обойти эту ситуацию, удалите добавленную ссылку NuGet и дайте ссылке Azure Cosmos DB SDK разрешаться через пакет Azure Functions Cosmos DB Extension.

### <a name="changing-azure-functions-polling-interval-for-the-detecting-changes"></a>Изменение интервала опроса функции Azure для обнаружения изменений

Как объяснялось ранее для [получения моих изменений,](./troubleshoot-changefeed-functions.md#my-changes-take-too-long-to-be-received)функция Azure будет спать в течение настраиваемого количества времени (5 секунд по умолчанию) перед проверкой новых изменений (чтобы избежать высокого потребления RU). Это время ожидания можно настроить с помощью параметра `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2-trigger.md#configuration) триггера (значение следует указать в миллисекундах).

## <a name="next-steps"></a>Дальнейшие действия

* [Включить мониторинг для ваших функций Azure](../azure-functions/functions-monitoring.md)
* [Azure Космос DB .NET SDK Устранение неполадок](./troubleshoot-dot-net-sdk.md)
