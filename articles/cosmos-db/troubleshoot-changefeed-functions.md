---
title: Устранение неполадок при использовании триггера функций Azure для Cosmos DB
description: Распространенные проблемы, обходные пути и шаги диагностики при использовании триггера функций Azure для Cosmos DB
author: ealsur
ms.service: cosmos-db
ms.date: 07/17/2019
ms.author: maquaran
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: f3af350c96d1dd9eaf4773db503acb10d8a08a8f
ms.sourcegitcommit: f4f626d6e92174086c530ed9bf3ccbe058639081
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75441117"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-functions-trigger-for-cosmos-db"></a>Диагностика и устранение неполадок при использовании триггера функций Azure для Cosmos DB

В этой статье рассматриваются распространенные проблемы, способы их устранения и диагностические действия при использовании [триггера функций Azure для Cosmos DB](change-feed-functions.md).

## <a name="dependencies"></a>Зависимости

Триггеры и привязки функций Azure для Cosmos DB зависят от пакетов расширений в базовой среде выполнения функций Azure. Всегда обновляйте эти пакеты, так как они могут включать исправления и новые функции, которые могут помочь в решении любых потенциальных проблем.

* Сведения о функциях Azure версии 2 см. в разделе [Microsoft. Azure. веб-jobs. Extensions. CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB).
* Сведения о функциях Azure версии 1 см. в разделе [Microsoft. Azure. веб-задания. Extensions. DocumentDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.DocumentDB).

Эта статья всегда будет обращаться к функциям Azure версии 2 при каждом упоминании среды выполнения, если не указано явно.

## <a name="consume-the-azure-cosmos-db-sdk-independently"></a>Использование пакета SDK Azure Cosmos DB независимо

Ключевыми функциями пакета расширения являются предоставление поддержки триггера и привязок функций Azure для Cosmos DB. Он также включает [пакет SDK для .net Azure Cosmos DB](sql-api-sdk-dotnet-core.md), который полезен, если вы хотите взаимодействовать с Azure Cosmos DB программным способом без использования триггера и привязок.

Если вы хотите использовать пакет SDK для Azure Cosmos DB, убедитесь, что вы не добавили в проект ссылку на другой пакет NuGet. Вместо этого разрешите **ссылку на пакет SDK с помощью пакета расширения функций Azure**. Использование пакета SDK Azure Cosmos DB отдельно от триггера и привязок

Кроме того, если вы вручную создаете собственный экземпляр [клиента Azure Cosmos DB SDK](./sql-api-sdk-dotnet-core.md), следует следовать шаблону, который использует только один экземпляр клиента, [используя подход одноэлементного шаблона](../azure-functions/manage-connections.md#documentclient-code-example-c). Этот процесс позволит избежать потенциальных проблем с сокетами в операциях.

## <a name="common-scenarios-and-workarounds"></a>Распространенные сценарии и решения

### <a name="azure-function-fails-with-error-message-collection-doesnt-exist"></a>Функция Azure завершается с ошибкой, коллекция сообщений об ошибках не существует

Функция Azure завершается сбоем с сообщением об ошибке "либо исходная коллекция" Collection-Name "(в базе данных" Database-Name "), либо коллекция аренды" collection2-Name "(в базе данных" Database2-Name ") не существует. Перед запуском прослушивателя должны существовать обе коллекции. Чтобы автоматически создать коллекцию аренд, установите для "Креателеасеколлектионифнотексистс" значение "true".

Это означает, что один или оба контейнера Azure Cosmos, необходимые для работы триггера, не существуют или недоступны для функции Azure. **Сама ошибка сообщит, какая база данных и контейнеры Azure Cosmos являются триггером, который ищется** в зависимости от конфигурации.

1. Проверьте атрибут `ConnectionStringSetting` и убедитесь, что он **ссылается на параметр, существующий в приложение-функция Azure**. Значение этого атрибута не должно быть самой строкой подключения, а именем параметра конфигурации.
2. Убедитесь, что `databaseName` и `collectionName` существуют в учетной записи Azure Cosmos. Если вы используете автоматическую замену значений (с помощью шаблонов `%settingName%`), убедитесь, что имя параметра существует в приложение-функция Azure.
3. Если не указать `LeaseCollectionName/leaseCollectionName`, по умолчанию используется значение "Аренда". Убедитесь, что такой контейнер существует. При необходимости можно задать атрибут `CreateLeaseCollectionIfNotExists` в триггере, чтобы `true` его автоматическое создание.
4. Проверьте [конфигурацию брандмауэра учетной записи Azure Cosmos](how-to-configure-firewall.md) , чтобы увидеть, что она не блокирует функцию Azure.

### <a name="azure-function-fails-to-start-with-shared-throughput-collection-should-have-a-partition-key"></a>Не удается запустить функцию Azure, так как "Общая пропускная способность должна иметь ключ секции"

Предыдущие версии расширения Azure Cosmos DB не поддерживали использование контейнера аренды, созданного в [базе данных с общей пропускной способностью](./set-throughput.md#set-throughput-on-a-database). Чтобы устранить эту проблему, обновите расширение [Microsoft. Azure. веб-задания. Extensions. CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB) , чтобы получить последнюю версию.

### <a name="azure-function-fails-to-start-with-the-lease-collection-if-partitioned-must-have-partition-key-equal-to-id"></a>Функция Azure не запускается с параметром "сбор аренд, если он секционирован, должен иметь ключ секции, равный идентификатору".

Эта ошибка означает, что текущий контейнер аренды секционирован, но путь ключа раздела не `/id`. Чтобы устранить эту проблему, необходимо повторно создать в качестве ключа секции контейнер аренды с `/id`.

### <a name="you-see-a-value-cannot-be-null-parameter-name-o-in-your-azure-functions-logs-when-you-try-to-run-the-trigger"></a>Вы видите "значение не может быть null. Имя параметра: o "в журналах функций Azure при попытке запустить триггер

Эта проблема возникает, если вы используете портал Azure и пытаетесь нажать кнопку **выполнить** на экране при проверке функции Azure, которая использует триггер. Триггер не требует выбора запуска для запуска. он будет автоматически запускаться при развертывании функции Azure. Если вы хотите проверить поток журнала функции Azure на портал Azure, просто перейдите к отслеживаемому контейнеру и вставьте новые элементы, и вы автоматически увидите триггер, выполняемый.

### <a name="my-changes-take-too-long-to-be-received"></a>Мои изменения занимают слишком много времени для получения

Этот сценарий может иметь несколько причин, и все они должны быть проверены:

1. Развернута ли ваша Функция Azure в том же регионе, что и ваша учетная запись Azure Cosmos? Для оптимальной задержки в сети Функция Azure и ваша учетная запись Azure Cosmos должны располагаться в одном регионе Azure.
2. Изменения происходят в вашем контейнере Azure Cosmos непрерывно или случайно?
Если случайно, может наблюдаться задержка между сохраняемыми изменениями и их получением Функцией Azure. Это связано с тем, что когда триггер проверяет изменения в контейнере Azure Cosmos и не находит ожидающих запросов на чтение, он будет пребывать в режиме ожидания в течение настраиваемого промежутка времени (5 секунд по умолчанию), прежде чем проверить наличие новых изменений (чтобы избежать высокого уровня потребления ЕЗ). Это время ожидания можно настроить с помощью параметра `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration) триггера (значение следует указать в миллисекундах).
3. В контейнере Azure Cosmos может быть [ограничена скорость](./request-units.md).
4. Можно использовать атрибут `PreferredLocations` в триггере, чтобы указать список регионов Azure с разделителями-запятыми для определения настраиваемого предпочтительного порядка подключения.

### <a name="some-changes-are-missing-in-my-trigger"></a>Некоторые изменения отсутствуют в триггере

Если вы обнаружите, что некоторые изменения, произошедшие в контейнере Azure Cosmos, не выбираются функцией Azure, необходимо выполнить начальный этап исследования.

Когда функция Azure получает изменения, она часто обрабатывает их и при необходимости отправляет результат в другое место назначения. При изучении недостающих изменений необходимо определить, **какие изменения принимаются в точке приема** (при запуске функции Azure), а не в месте назначения.

Если в назначении отсутствуют некоторые изменения, это может означать, что во время выполнения функции Azure после получения изменений происходит ошибка.

В этом сценарии лучшим способом является добавление блоков `try/catch` в код и в циклах, которые могут обрабатывать изменения, для обнаружения любых сбоев определенного подмножества элементов и их обработки соответствующим образом (отправка их в другое хранилище для дальнейшего анализа или повторного выполнения). 

> [!NOTE]
> Триггеры функций Azure для Cosmos DB по умолчанию не будут повторять пакет изменений, если во время выполнения кода возникло необработанное исключение. Это означает, что изменения не поступали в место назначения, так как не удается обработать их.

Если вы обнаружите, что некоторые изменения не были получены вашим триггером, наиболее распространенным сценарием является **выполнение другой функции Azure**. Это может быть другая функция Azure, развернутая в Azure, или функция Azure, которая выполняется локально на компьютере разработчика, который имеет такую **же конфигурацию (в** том же отслеживаемом и контейнере аренды), и эта функция Azure кража подмножества изменений, которые вы хотели бы обработать с помощью функции Azure.

Кроме того, сценарий можно проверить, если известно, сколько экземпляров Azure приложение-функция вы выполняли. Если вы просматриваете контейнер аренды и подсчитываете количество элементов аренды в, уникальные значения свойства `Owner` в них должны быть равны числу экземпляров приложение-функция. Если владельцев больше, чем известных экземпляров приложения-функции Azure, это означает, что именно эти дополнительные владельцы перехватывают изменения.

Одним из простых способов решения этой проблемы является применение `LeaseCollectionPrefix/leaseCollectionPrefix` к функции с новым или другим значением или, Кроме того, тестирование с новым контейнером аренды.

### <a name="need-to-restart-and-re-process-all-the-items-in-my-container-from-the-beginning"></a>Необходимо перезапустить и повторно обработать все элементы в контейнере с начала 
Чтобы повторно обработать все элементы в контейнере с начала:
1. Останавливает функцию Azure, если она выполняется в данный момент. 
1. Удалите документы из коллекции аренд (или удалите и повторно создайте коллекцию аренды, чтобы она была пустой).
1. Присвойте атрибуту CosmosDBTrigger [стартфромбегиннинг](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration) в функции значение true. 
1. Перезапустите функцию Azure. Теперь он будет считывать и обрабатывать все изменения с самого начала. 

Если задать для [стартфромбегиннинг](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration) значение true, функция Azure начнет считывать изменения с начала истории коллекции, а не текущего времени. Работает только при отсутствии уже созданных аренд (т. е. документов в коллекции аренд). Присвоение этому свойству значения true, если уже созданные аренды не оказывают никакого влияния; в этом случае, когда функция остановлена и перезапущена, она начинает чтение с последней контрольной точки, как определено в коллекции аренд. Для повторной обработки с самого начала выполните описанные выше шаги 1-4.  

### <a name="binding-can-only-be-done-with-ireadonlylistdocument-or-jarray"></a>Привязку можно выполнить только с помощью Иреадонлилист\<документов > или Жаррай

Эта ошибка возникает, если проект функций Azure (или любой проект, на который указывает ссылка) содержит ручную ссылку NuGet на Azure Cosmos DB SDK с версией, отличной от версии, предоставленной [Cosmos DB расширением функций Azure](./troubleshoot-changefeed-functions.md#dependencies).

Чтобы обойти эту ситуацию, удалите добавленную ссылку NuGet вручную и разрешите ссылку на Azure Cosmos DB SDK с помощью пакета расширения "функции Azure Cosmos DB".

### <a name="changing-azure-functions-polling-interval-for-the-detecting-changes"></a>Изменение интервала опроса функции Azure для обнаружения изменений

Как упоминалось ранее, для того [чтобы изменения вступили в силу слишком долго](./troubleshoot-changefeed-functions.md#my-changes-take-too-long-to-be-received), функция Azure будет в спящем режиме на настраиваемое время (по умолчанию 5 секунд), прежде чем проверять наличие новых изменений (чтобы избежать высокой степени потребления единиц запросов). Это время ожидания можно настроить с помощью параметра `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration) триггера (значение следует указать в миллисекундах).

## <a name="next-steps"></a>Дальнейшие действия

* [Включение мониторинга для функций Azure](../azure-functions/functions-monitoring.md)
* [Устранение неполадок пакета SDK для .NET Azure Cosmos DB](./troubleshoot-dot-net-sdk.md)
