---
title: Диагностика и устранение неполадок при использовании триггер Azure Cosmos DB в функциях Azure
description: Распространенные проблемы, возможные решения и диагностические действия, при использовании триггера Azure Cosmos DB с помощью функций Azure
author: ealsur
ms.service: cosmos-db
ms.date: 05/23/2019
ms.author: maquaran
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 66eff6ee603ced03a8f4d75d4569752e0b11a6e7
ms.sourcegitcommit: 509e1583c3a3dde34c8090d2149d255cb92fe991
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2019
ms.locfileid: "66242532"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-cosmos-db-trigger-in-azure-functions"></a>Диагностика и устранение неполадок при использовании триггер Azure Cosmos DB в функциях Azure

В этой статье рассматриваются распространенные проблемы, возможные решения и диагностические действия, при использовании [триггер Azure Cosmos DB](change-feed-functions.md) с помощью функций Azure.

## <a name="dependencies"></a>Зависимости

Триггер Azure Cosmos DB и привязки зависят пакеты расширений базовой среды выполнения функций Azure. Всегда сохраняйте эти пакеты обновления, так как они могут включать исправления и новые функции, которые может решить все возможные проблемы, которые могут возникнуть:

* Для функций Azure версии 2, см. в разделе [Microsoft.Azure.WebJobs.Extensions.CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB).
* Для функций Azure версии 1 см. в разделе [Microsoft.Azure.WebJobs.Extensions.DocumentDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.DocumentDB).

В этой статье всегда будет ссылаться на функции Azure V2 всякий раз, когда среда выполнения упоминалось, если не указано явным образом.

## <a name="consume-the-azure-cosmos-db-sdk-independently"></a>Использование пакета SDK для Azure Cosmos DB независимо друг от друга

Основные функциональные возможности пакета расширения является предоставление поддержки для триггера Azure Cosmos DB и привязки. Он также включает [пакета SDK .NET Azure Cosmos DB](sql-api-sdk-dotnet-core.md), что очень удобно, если вы хотите взаимодействовать с Azure Cosmos DB программным способом без использования триггеров и привязок.

Если нужно использовать пакет SDK для Azure Cosmos DB, убедитесь, что вы не добавлять в проект другой ссылки на пакет NuGet. Вместо этого **позволяют устранить через пакет расширения "функции Azure справочнике по SDK**. Использование пакета SDK Azure Cosmos DB отдельно от триггера и привязки

Кроме того Если вы вручную создаете собственный экземпляр [клиентского пакета SDK для Azure Cosmos DB](./sql-api-sdk-dotnet-core.md), должно соответствовать шаблону наличия только одного экземпляра клиента [принципу одноэлементный шаблон](../azure-functions/manage-connections.md#documentclient-code-example-c) . Этот процесс позволит избежать потенциальных проблем сокетов во время выполнения операций.

## <a name="common-scenarios-and-workarounds"></a>Распространенные сценарии и решения

### <a name="azure-function-fails-with-error-message-collection-doesnt-exist"></a>Azure завершится неудачно, функция коллекции ошибок сообщение не существует

Функции Azure завершается сбоем с сообщением об ошибке «либо исходной коллекции «коллекция name» (в базе данных «база данных name») или коллекцию аренд «collection2-name» (в базе данных «database2-name») не существует. Обе коллекции должны существовать до запуска прослушивателя. Чтобы автоматически создать коллекцию аренды, задайте «CreateLeaseCollectionIfNotExists» значение «true»»

Это означает, что один или оба контейнеры Azure Cosmos, необходимые для успешной работы триггера не существуют или недоступны для функции Azure. **Сама ошибка сообщит, какой базе данных Azure Cosmos и контейнеры — это триггер, ищете** в зависимости от конфигурации.

1. Проверьте `ConnectionStringSetting` атрибута, что он **ссылается на параметр, который существует в приложении-функции Azure**. Значение этого атрибута не должно быть саму строку, но имя параметра конфигурации.
2. Убедитесь, что `databaseName` и `collectionName` существует в вашей учетной записи Azure Cosmos. Если вы используете автоматическое значение замены (с помощью `%settingName%` шаблоны), убедитесь, что существует имя параметра в приложении-функции Azure.
3. Если вы не укажете `LeaseCollectionName/leaseCollectionName`, значение по умолчанию — «аренды». Убедитесь, что такой контейнер существует. При необходимости можно задать `CreateLeaseCollectionIfNotExists` атрибут в триггер, `true` для автоматического создания.
4. Проверьте ваш [конфигурации брандмауэра учетной записи Azure Cosmos](how-to-configure-firewall.md) позволили см. в разделе, что он не блокирует функции Azure.

### <a name="azure-function-fails-to-start-with-shared-throughput-collection-should-have-a-partition-key"></a>Функции Azure завершается сбоем со «Shared пропускной способности коллекции должны иметь ключ секции»

Не поддерживает предыдущие версии модуля Azure Cosmos DB с помощью контейнера аренды, который был создан в рамках [общей пропускной способности базы данных](./set-throughput.md#set-throughput-on-a-database). Чтобы устранить эту проблему, обновите [Microsoft.Azure.WebJobs.Extensions.CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB) расширения для получения последней версии.

### <a name="azure-function-fails-to-start-with-the-lease-collection-if-partitioned-must-have-partition-key-equal-to-id"></a>Функции Azure завершается сбоем со «коллекцию аренды, если секционирована, должны содержать ключ секции, равный идентификатору.»

Эта ошибка означает, что текущей аренды контейнера секционирована, но путь к ключу секции не `/id`. Чтобы устранить эту проблему, необходимо повторно создать контейнер аренды с `/id` как ключ раздела.

### <a name="you-see-a-value-cannot-be-null-parameter-name-o-in-your-azure-functions-logs-when-you-try-to-run-the-trigger"></a>Вы увидите «не может иметь значение null. Имя параметра: o» в журналах функций Azure при попытке запустить триггер

Эта проблема возникает, если вы используете портал Azure и попробуйте выбрать **запуска** кнопку на экране при проверке функции Azure, которая использует триггер. Триггер не требует выбора запуск для запуска, автоматически запускается при развертывании функции Azure. Если вы хотите проверить поток журнала функций Azure на портале Azure, просто перейдите в отслеживаемый контейнер и вставить несколько новых элементов, автоматически появится триггеров, выполняющихся.

### <a name="my-changes-take-too-long-be-received"></a>Получить мои изменения занимают слишком много времени

Этот сценарий может иметь несколько причин, и все они должны проверяться:

1. Функция Azure развертывается в одном регионе с вашей учетной записи Azure Cosmos? Для оптимальной задержи функции Azure и учетной записи Azure Cosmos должны совместно располагаться в одном регионе Azure.
2. Возникают ли в контейнере Azure Cosmos "постоянная" или случайные изменения?
Если это последний, возможна некоторая задержка между сохранением изменений и функцией Azure, что скрывается за их. Это обусловлено внутренним образом, когда триггер проверяет наличие изменений в контейнере Azure Cosmos и находит нет ожидающих для чтения, он будет спящий режим для настраиваемого периода времени (5 секунд по умолчанию) до проверки на наличие новых изменений (во избежание высокий уровень потребления ЕЗ). Можно настроить сейчас спящий режим через `FeedPollDelay/feedPollDelay` в [конфигурации](../azure-functions/functions-bindings-cosmosdb-v2.md#trigger---configuration) для триггера (значение должно представлять в миллисекундах).
3. Возможно, ваш контейнер Azure Cosmos [ограничен по частоте](./request-units.md).
4. Можно использовать `PreferredLocations` атрибут в триггер, укажите разделенный запятыми список регионах Azure, чтобы определить порядок предпочтительных подключения.

### <a name="some-changes-are-missing-in-my-trigger"></a>Некоторые изменения, отсутствуют в моей триггера

Если обнаружится, что некоторые изменения, которые произошли в контейнере Azure Cosmos не извлекаются с помощью функции Azure, это этап начальное исследование, которая должна выполняться.

Когда функция Azure получает изменения, он часто обрабатывает их и может при необходимости, отправить результат в другое место назначения. При изучении недостающие изменения, убедитесь, что вы **мер, какие изменения были приняты в точке приема** (при запуске функции Azure), не на сервере назначения.

Если на сервере назначения отсутствуют некоторые изменения, это означает, что это ошибка происходит во время выполнения функции Azure, после изменения были получены.

В этом случае оптимальным решением является добавление `try/catch blocks` в коде и в циклах, которые может обрабатывать изменения, чтобы обнаружить все ошибки для определенного подмножества элементов и обрабатывать их соответствующим образом (отправлять их в другом хранилище для дальнейшего Анализ или повторных попыток). 

> [!NOTE]
> Триггер Azure Cosmos DB, по умолчанию не повторить попытку пакет изменений в случае отсутствия необработанное исключение во время выполнения вашего кода. Это означает, что изменения не поступало в месте назначения, так как не удалось обработать их.

Если вам кажется, что некоторые изменения не были получены вообще, триггер, наиболее распространенным сценарием является то, что есть **запущено другое Azure функция**. Это может быть другая функция Azure, развернутых в Azure или имеет функцию Azure, запуск локально на компьютере разработчика, **точно такой же конфигурацией** (так же отслеживания и предоставлять в аренду контейнеров), и кражи эта функция Azure набор изменений, можно ожидать функцию Azure для обработки.

Кроме того, сценарий может быть проверен, если вы знаете, сколько экземпляров приложения-функции Azure у вас есть под управлением. Если проверить аренды контейнера и подсчета числа элементов аренды в различных значений `Owner` свойство в них должно быть равно числу экземпляров приложения-функции. При наличии нескольких владельцев, чем известных экземпляров приложения-функции Azure, она означает, эти лишние владельцев один «украсть» изменения.

Один простой способ обхода этой ситуации является применение `LeaseCollectionPrefix/leaseCollectionPrefix` функции со значением новую или другую или в качестве альтернативы тестирования с помощью новой аренды контейнера.

## <a name="next-steps"></a>Дальнейшие действия

* [Включить мониторинг для функций Azure](../azure-functions/functions-monitoring.md)
* [Azure Cosmos DB .NET SDK, устранение неполадок](./troubleshoot-dot-net-sdk.md)