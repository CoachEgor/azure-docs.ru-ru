---
title: Диагностика и устранение проблем с запросов, при использовании Azure Cosmos DB
description: Узнайте, как для определения, диагностирования и устранения неполадок запросов Azure Cosmos DB SQL.
author: ginamr
ms.service: cosmos-db
ms.topic: troubleshooting
ms.date: 07/10/2019
ms.author: girobins
ms.subservice: cosmosdb-sql
ms.reviewer: sngun
ms.openlocfilehash: 079e8677febfe6683d4f0e60a0e7ba6b06ea549d
ms.sourcegitcommit: 64798b4f722623ea2bb53b374fb95e8d2b679318
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67835836"
---
# <a name="troubleshoot-query-performance-for-azure-cosmos-db"></a>Устранение неполадок с производительностью запросов для Azure Cosmos DB
В этой статье описывается, как для определения, диагностирования и устранения неполадок запросов Azure Cosmos DB SQL. Для достижения оптимальной производительности запросов Azure Cosmos DB, выполните следующие действия по устранению неполадок. 

## <a name="collocate-clients-in-same-azure-region"></a>Совмещенное расположение клиентов в том же регионе Azure 
Минимальная возможная задержка достигается при размещении клиентского приложения в том же регионе Azure, в котором предоставляется конечная точка Azure Cosmos DB. Список доступных регионов см. в разделе [регионы Azure](https://azure.microsoft.com/global-infrastructure/regions/#services) статьи.

## <a name="check-consistency-level"></a>Проверьте уровень согласованности
[Уровень согласованности](consistency-levels.md) может повлиять на производительность и расходы. Убедитесь, что уровень согласованности подходит для данного сценария. Дополнительные сведения см. [Выбор уровня согласованности](consistency-levels-choosing.md).

## <a name="log-query-metrics"></a>Метрики журнала запросов
Используйте `QueryMetrics` для устранения неполадок медленно или ресурсоемкие запросы. 

  * Задайте `FeedOptions.PopulateQueryMetrics = true` иметь `QueryMetrics` в ответе.
  * `QueryMetrics` класс имеет перегруженный `.ToString()` функцию, которую можно вызвать для получения строкового представления `QueryMetrics`. 
  * Метрики могут использоваться для формирования следующие аналитические данные, помимо прочего: 
  
      * Ли любого конкретного компонента конвейера запросов со слишком долго до завершения (в порядке сотни и более миллисекунд). 

          * Рассмотрим `TotalExecutionTime`.
          * Если `TotalExecutionTime` может быть меньше времени выполнения сквозного запроса, а затем время тратится на стороне клиента или сети. Внимательно проверьте, что совместно размещены клиентом и регионом Azure.
      
      * Были ли ложных срабатываний в документах проанализировать (если число выходных данных документов намного меньше, чем число документов получить).  

          * Рассмотрим `Index Utilization`.
          * `Index Utilization` = (Число возвращенных документов или число загруженных документов)
          * Если количество возвращаемых документов намного меньше, чем номер загружен, ложных срабатываний анализируются.
          * Ограничьте число документов, извлекаемых с уже фильтрами.  

      * Удалось отдельных циклов приема-передачи (см. в разделе `Partition Execution Timeline` из строковым представлением `QueryMetrics`). 
      * Является ли запрос использовал высокой запросить оплату. 

Дополнительные сведения см. [как получить метрики выполнения запросов SQL](profile-sql-api-query.md) статьи.
      
## <a name="tune-query-feed-options-parameters"></a>Настройка параметров запроса параметры веб-канала 
Производительность запросов, можно оптимизировать с помощью запроса [параметры веб-канала](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.feedoptions?view=azure-dotnet) параметров. Попробуйте установить параметр приведенных ниже параметров:

  * Задайте `MaxDegreeOfParallelism` на-1, а затем сравните производительность для различных значений. 
  * Задайте `MaxBufferedItemCount` на-1, а затем сравните производительность для различных значений. 
  * Задайте `MaxItemCount` значение -1.

При сравнении производительности различных значений, попробуйте значения, такие как 2, 4, 8, 16 и другим пользователям.
 
## <a name="read-all-results-from-continuations"></a>Чтение всех результатов из продолжений
Если вы считаете, что вы не получаете все результаты, убедитесь, что полностью сток продолжение. Другими словами хранить, чтение результатов, маркер продолжения имеет дополнительные документы для получения.

Полностью Сток может осуществляться с любой из следующих шаблонов:

  * Продолжать выполняться результаты обработки продолжения не пуст.
  * Продолжайте обработку во время запрос выдает больше результатов. 

    ```csharp
    // using AsDocumentQuery you get access to whether or not the query HasMoreResults
    // If it does, just call ExecuteNextAsync until there are no more results
    // No need to supply a continuation token here as the server keeps track of progress
    var query = client.CreateDocumentQuery<Family>(collectionLink, options).AsDocumentQuery();
    while (query.HasMoreResults)
    {
        foreach (Family family in await query.ExecuteNextAsync())
        {
            families.Add(family);
        }
    }
    ```

## <a name="choose-system-functions-that-utilize-index"></a>Выбор функций системы, использующие индекс
Если выражение можно преобразовать в диапазон значений string, затем он может использовать индекс; в противном случае это невозможно. 

Ниже приведен список строковых функций, которые можно использовать индекс: 
    
  * STARTSWITH (str_expr, str_expr) 
  * LEFT(str_expr, num_expr) = str_expr 
  * SUBSTRING (str_expr, num_expr, num_expr) = str_expr, но только в том случае, если первый num_expr равно 0 
    
    Ниже приведены несколько примеров запросов. 
    
    ```sql

    -- If there is a range index on r.name, STARTSWITH will utilize the index while ENDSWITH won't 
    SELECT * 
    FROM c 
    WHERE STARTSWITH(c.name, 'J') AND ENDSWITH(c.name, 'n')

    ```
    
    ```sql

    -- LEFT will utilize the index while RIGHT won't 
    SELECT * 
    FROM c 
    WHERE LEFT(c.name, 2) = 'Jo' AND RIGHT(c.name, 2) = 'hn'

    ```

  * Избегайте системных функций в фильтре (или в предложении WHERE), не обрабатываются с помощью индекса. Некоторые примеры таких системных функций включают Contains, верхней, нижней.
  * По возможности запросы следует писать так, чтобы в них использовались фильтры для ключей секции.
  * Для достижения высокой производительностью запросов вызывайте ВЕРХНЕМ или нижнем РЕГИСТРЕ в фильтре. Вместо этого нормализовать регистр значений при вставке. Для каждого значения вставки значения без учета регистра нужный или вставки исходное значение и значение с требуемой регистром. 

    Пример:
    
    ```sql

    SELECT * FROM c WHERE UPPER(c.name) = "JOE"

    ```
    
    В этом случае хранилище «JOE» с прописной буквы или хранить «JOE» и «Joe» исходное значение. 
    
    Если регистр данных JSON нормализуется запрос выглядит следующим образом:
    
    ```sql

    SELECT * FROM c WHERE c.name = "JOE"

    ```

    Второй запрос будет более высокую производительность, так как он не требует выполнения преобразования на каждом из значений, чтобы сравнить значения для «JOE».

Системная функция, Дополнительные сведения см. в разделе [системные функции](sql-query-system-functions.md) статьи.

## <a name="check-indexing-policy"></a>Проверка политики индексирования
Чтобы убедиться, что текущий [политики индексации](index-policy.md) является оптимальным выбором:

  * Убедитесь, что все пути JSON, используемых в запросах, включенных в политики индексирования для ускорения операций чтения.
  * Исключите пути, не используется в запросах для более высокой производительностью операций записи.

Дополнительные сведения см. [как для управления политики индексации](how-to-manage-indexing-policy.md) статьи.

## <a name="spatial-data-check-ordering-of-points"></a>Пространственные данные: Проверьте порядок точек
Точки внутри многоугольника должны указываться в порядке против часовой стрелки. Если точки указаны в порядке по часовой стрелке, то многоугольник представляет регион, расположенный снаружи от него.

## <a name="optimize-join-expressions"></a>Оптимизация выражения СОЕДИНЕНИЯ
`JOIN` выражения можно развернуть в большие нескольких продуктов. Когда возможно, запрос к меньшего размера поиска пространство через фильтр более узкой.

Вложенные запросы с несколькими значениями можно оптимизировать `JOIN` выражений с помощью принудительной отправки предикаты, после каждого выражения select ко многим, а не после всех кросс соединений в `WHERE` предложение. Подробный пример см. в разделе [оптимизировать выражения соединения](https://docs.microsoft.com/azure/cosmos-db/sql-query-subquery#optimize-join-expressions) статьи.

## <a name="optimize-order-by-expressions"></a>Оптимизация выражения ORDER BY 
`ORDER BY` производительность запросов может снизиться, если поля являются разреженными или не включить в политику индекса.

  * Для разреженных полей, таких как время уменьшите максимально пространство поиска с фильтрами. 
  * Для одного свойства `ORDER BY`, включите свойство в политике индекса. 
  * Для нескольких свойства `ORDER BY` выражения, определяют [составной индекс](https://docs.microsoft.com/azure/cosmos-db/index-policy#composite-indexes) по полям выполняется сортировка.  

## <a name="many-large-documents-being-loaded-and-processed"></a>Загрузка и обработки большого количества документов
Время и единиц запросов, которые требуются в запросе не только зависят от размера ответа, они также зависят от работы, можно сделать, конвейер обработки запросов. Время и RUs пропорционально увеличить объем работы, выполненной конвейера обработки всего запроса. Для больших документов выполняется больше работы, таким образом, больше времени и RUs являются обязательными для загрузки и обработки больших документов.

## <a name="low-provisioned-throughput"></a>Низкой пропускной способностью
Убедитесь, что подготовленной пропускной способности может обрабатывать рабочую нагрузку. Увеличение бюджета единиц Запросов для затронутых коллекций.

## <a name="try-upgrading-to-the-latest-sdk-version"></a>Попробуйте обновить систему до последней версии пакета SDK
Чтобы определить последнюю SDK см. раздел [загрузки SDK и заметках о выпуске](sql-api-sdk-dotnet.md) статьи.

## <a name="next-steps"></a>Следующие шаги
См. в документах ниже о том, как измерение единиц запросов в запросе, получение статистики выполнения для настройки запросов и многое другое:

* [Получить метрики выполнения SQL-запросов с помощью пакета SDK для .NET](profile-sql-api-query.md)
* [Настройка производительности запросов в Azure Cosmos DB](sql-api-sql-query-metrics.md)
* [Советы по повышению производительности для пакета SDK для .NET](performance-tips.md)