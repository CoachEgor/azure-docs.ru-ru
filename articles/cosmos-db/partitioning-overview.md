---
title: Секционирование в базе данных Azure Cosmos DB
description: Сведения о секционировании в Azure Cosmos DB, рекомендации по выбору ключа секции и управлении логическими секциями
author: deborahc
ms.author: dech
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/06/2020
ms.openlocfilehash: aa7d67cd6bd1bd422bd257b75ac5bde3bd534d7e
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/02/2020
ms.locfileid: "85481839"
---
# <a name="partitioning-in-azure-cosmos-db"></a>Секционирование в базе данных Azure Cosmos DB

Azure Cosmos DB использует секционирование для масштабирования отдельных контейнеров в базе данных в соответствии с потребностями производительности приложения. При секционировании элементы в контейнере делятся на отдельные подмножества, называемые *логическими секциями*. Логические секции формируются на основе значения *ключа секции* , связанного с каждым элементом в контейнере. Все элементы в логической секции имеют одинаковое значение ключа секции.

Например, контейнер содержит элементы. Каждый элемент имеет уникальное значение для `UserID` Свойства. Если используется в `UserID` качестве ключа секции для элементов в контейнере и имеется 1 000 уникальных `UserID` значения, то для контейнера создаются 1 000 логических секции.

В дополнение к ключу секции, определяющему логическую секцию элемента, каждый элемент в контейнере имеет *идентификатор элемента* (уникальный в пределах логической секции). Сочетание ключа секции и *идентификатора элемента* создает *индекс*элемента, который однозначно определяет элемент.

[Выбор ключа секции](partitioning-overview.md#choose-partitionkey) — это важное решение, которое повлияет на производительность приложения.

## <a name="managing-logical-partitions"></a>Управление логическими секциями

Azure Cosmos DB прозрачно и автоматически управляет размещением логических секций в физических секциях для эффективного удовлетворения требований к масштабируемости и производительности контейнера. По мере увеличения требований к пропускной способности и хранению приложения Azure Cosmos DB перемещает логические секции, чтобы автоматически распределять нагрузку между большим количеством физических секций. Вы можете узнать больше о [физических секциях](partition-data.md#physical-partitions).

Azure Cosmos DB использует секционирование на основе хэша для распределения логических секций по физическим секциям. Azure Cosmos DB хэширует значение ключа секции элемента. Хэшированный результат определяет физическую секцию. Затем Azure Cosmos DB выделяет пространство ключей для хэшей ключей секций равномерно по физическим секциям.

Транзакции (в хранимых процедурах или триггерах) допускаются только для элементов в одном логическом разделе.

Дополнительные сведения о том, [как Azure Cosmos DB управляет секциями](partition-data.md), см. здесь. (Нет необходимости понимать внутренние сведения для сборки или запуска приложений, но это можно добавить для читателя.)

## <a name="choosing-a-partition-key"></a><a id="choose-partitionkey"></a>Выбор ключа секции

Ключ секции содержит два компонента: **путь к ключу раздела** и **значение ключа секции**. Например, рассмотрим элемент {"userId": "Эндрю", "Ворксфор": "Microsoft"} Если в качестве ключа раздела выбрано "userId", то ниже приведены два основных компонента раздела.

* Путь к ключу раздела (например, "/userId"). Путь к ключу секции принимает буквенно-цифровые и символы подчеркивания (_). Вложенные объекты также можно использовать с помощью стандартной нотации пути (/).

* Значение ключа секции (например, "Эндрю"). Значение ключа секции может быть строкой или числовым типом.

Дополнительные сведения об ограничениях пропускной способности, хранилища и длины ключа секции см. в статье [Azure Cosmos DB квоты службы](concepts-limits.md) .

Выбор ключа секции — это простой, но важный вариант проектирования в Azure Cosmos DB. После выбора ключа секции его нельзя изменить на месте. Если необходимо изменить ключ секции, необходимо переместить данные в новый контейнер с новым нужным ключом секции.

Для **всех** контейнеров ключ секции должен:

* Быть свойством со значением, которое не изменяется. Если свойство является ключом секции, обновление значения этого свойства невозможно.
* Имеет большое количество элементов. Иными словами, свойство должно иметь широкий диапазон возможных значений.
* Распределенное распределение единиц запросов (RU) и хранение данных равномерно по всем логическим секциям. Это обеспечивает даже потребление единиц запросов и распределение хранилища по физическим секциям.

Если в Azure Cosmos DB требуются [транзакции ACID с несколькими элементами](database-transactions-optimistic-concurrency.md#multi-item-transactions) , необходимо использовать [хранимые процедуры или триггеры](how-to-write-stored-procedures-triggers-udfs.md#stored-procedures). Все хранимые процедуры и триггеры на основе JavaScript ограничены одной логической секцией.

## <a name="partition-keys-for-read-heavy-containers"></a>Ключи разделов для контейнеров с высокой интенсивностью чтения

Для большинства контейнеров необходимо учитывать указанные выше критерии при выборе ключа секции. Однако для больших контейнеров с большим объемом чтения может потребоваться выбрать ключ секции, который часто встречается как фильтр в запросах. Запросы можно [эффективно маршрутизировать только к соответствующим физическим секциям](how-to-query-container.md#in-partition-query) , включая ключ секции в предикате фильтра.

Если большинство запросов рабочей нагрузки являются запросами, а большинство запросов имеют фильтр равенства для одного и того же свойства, это свойство может быть хорошим выбором ключа секции. Например, если часто выполняется запрос, который фильтруется по `UserID` , то при выборе в `UserID` качестве ключа секции будет уменьшено количество [запросов между секциями](how-to-query-container.md#avoiding-cross-partition-queries).

Тем не менее, если ваш контейнер невелик, возможно, у вас недостаточно физических секций, чтобы не беспокоиться о влиянии на производительность запросов между секциями. Большинству малых контейнеров в Azure Cosmos DB требуется только одна или две физические секции.

Если контейнер может увеличиваться до нескольких физических секций, следует убедиться, что выбран ключ секции, который уменьшает количество запросов между секциями. В вашем контейнере потребуется больше, чем несколько физических секций, если выполняется одно из следующих условий.

* В вашем контейнере будет выинициализировано более 30 000 единиц запросов.
* В вашем контейнере будет храниться свыше 100 ГБ данных.

## <a name="using-item-id-as-the-partition-key"></a>Использование идентификатора элемента в качестве ключа секции

Если у контейнера есть свойство, имеющее широкий диапазон возможных значений, скорее всего, это будет отличный вариант ключа секции. Одним из возможных примеров такого свойства является *идентификатор элемента*. Для небольших контейнеров с большой интенсивностью чтения или контейнеров с большой интенсивностью записи любого размера *идентификатор элемента* естественным образом подходит для ключа секции.

*Идентификатор элемента* системного свойства гарантированно существует в каждом элементе в контейнере Cosmos. У вас могут быть другие свойства, представляющие логический идентификатор элемента. Во многих случаях они также являются отличным выбором ключа секции по тем же причинам, что и *идентификатор элемента*.

*Идентификатор элемента* является отличным выбором ключа секции по следующим причинам:

* Существует широкий диапазон возможных значений (один уникальный *идентификатор элемента* для каждого элемента).
* Так как для каждого элемента существует уникальный *идентификатор* , *идентификатор элемента* выполняет отличное задание с равномерной балансировкой потребления единиц запросов и хранилища данных.
* Вы можете легко выполнять эффективные операции чтения точек, так как вы всегда узнаете ключ секции элемента, если известно его *идентификатор*.

При выборе *идентификатора элемента* в качестве ключа секции следует учитывать следующие моменты:

* Если *идентификатор элемента* является ключом секции, он станет уникальным идентификатором во всем контейнере. Вы не сможете иметь элементы с повторяющимися *идентификаторами элементов*.
* При наличии контейнера, интенсивно считывающего большое количество [физических секций](partition-data.md#physical-partitions), запросы будут более эффективны, если у них есть фильтр проверки на равенство с *идентификатором элемента*.
* Нельзя запускать хранимые процедуры или триггеры по нескольким логическим секциям.

## <a name="next-steps"></a>Дальнейшие шаги

* Дополнительные сведения о [секционировании и горизонтальном масштабировании в Azure Cosmos DB](partition-data.md).
* Дополнительные сведения о [подготовленной пропускной способности в Azure Cosmos DB](request-units.md).
* Сведения о [глобальном распределении в Azure Cosmos DB](distribute-data-globally.md).
