---
title: Diagnose and troubleshoot issues when using Azure Cosmos DB .NET SDK (Диагностика и устранение неполадок при использовании пакета SDK Azure Cosmos DB для .NET)
description: Используйте такие функции, как ведение журнала на стороне клиента и другие сторонние средства для выявления, диагностики и устранения Azure Cosmos DB проблем при использовании пакета SDK для .NET.
author: j82w
ms.service: cosmos-db
ms.date: 03/11/2020
ms.author: jawilley
ms.subservice: cosmosdb-sql
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 5f92d98630c6fb875babeb907f92732b0c24bb52
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79137960"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-cosmos-db-net-sdk"></a>Diagnose and troubleshoot issues when using Azure Cosmos DB .NET SDK (Диагностика и устранение неполадок при использовании пакета SDK Azure Cosmos DB для .NET)
В этой статье рассматриваются распространенные проблемы, обходные пути, шаги диагностики и средства при использовании [пакета SDK для .NET](sql-api-sdk-dotnet.md) с учетными ЗАПИСЯМИ SQL API Azure Cosmos DB.
Пакет SDK для .NET предоставляет логическое представление на стороне клиента для доступа к Azure Cosmos DB API SQL. В этой статье описываются средства и подходы, которые помогут вам, если вы столкнетесь с проблемами.

## <a name="checklist-for-troubleshooting-issues"></a>Контрольный список для устранения проблем:
Перед перемещением приложения в рабочую среду рассмотрите следующий контрольный список. Использование контрольного списка позволяет предотвратить несколько распространенных проблем, которые могут возникнуть. Кроме того, можно быстро диагностировать причины возникновения проблемы.

*    Используйте последнюю версию [пакета SDK](sql-api-sdk-dotnet-standard.md). Предварительные версии пакетов SDK не следует использовать для рабочей среды. Это предотвратит Устранение известных проблем, которые уже исправлены.
*    Просмотрите [советы по повышению производительности](performance-tips.md) и следуйте рекомендациям. Это поможет предотвратить масштабирование, задержку и другие проблемы с производительностью.
*    Включите ведение журнала пакета SDK, чтобы помочь устранить проблему. Включение ведения журнала может повлиять на производительность, поэтому рекомендуется включать его только при устранении неполадок. Можно включить следующие журналы:
    *    [Метрики журнала](monitor-accounts.md) с помощью портал Azure. Метрики портала отображают данные телеметрии Azure Cosmos DB, что позволяет определить, соответствует ли эта ошибка Azure Cosmos DB или если она находится на стороне клиента.
    *    Заносить [строку диагностики](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring) в пакет SDK v2 или [ДИАГНОСТИКУ](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics) в пакете SDK версии 3 из ответов операции Point.
    *    Регистрировать [метрики запросов SQL](sql-api-query-metrics.md) из всех ответов на запросы 
    *    Следуйте указаниям по настройке [ведения журнала пакета SDK]( https://github.com/Azure/azure-cosmos-dotnet-v2/blob/master/docs/documentdb-sdk_capture_etl.md)

Ознакомьте с разделом [Распространенные проблемы и их обходные решения](#common-issues-workarounds) в этой статье.

Просмотрите [раздел проблем GitHub](https://github.com/Azure/azure-cosmos-dotnet-v2/issues) , который активно отслеживается. Вы можете там найти уже готовое обходное решение похожей проблемы. Если вы не нашли решение, подайте ему вопрос GitHub. Можно открыть такт поддержки для срочных проблем.


## <a name="common-issues-and-workarounds"></a><a name="common-issues-workarounds"></a>Распространенные проблемы и обходные решения для них

### <a name="general-suggestions"></a>Общие рекомендации
* Если это возможно, запустите приложение в том же регионе Azure, что и учетная запись Azure Cosmos DB. 
* Вы можете столкнуться с проблемами подключения или доступности из-за недостатка ресурсов на клиентском компьютере. Мы рекомендуем отслеживать использование ЦП на узлах, на которых работает клиент Azure Cosmos DB, и масштабировать их, если они работают при высокой нагрузке.

### <a name="check-the-portal-metrics"></a>Проверка метрик портала
Проверка [метрик портала](monitor-accounts.md) поможет определить, является ли это проблемой на стороне клиента, или возникли проблемы со службой. Например, если метрики содержат высокую частоту запросов с ограниченным количеством записей (код состояния HTTP 429), то есть запрос регулируется, а затем проверяется [слишком большое значение частоты запросов] . 

### <a name="requests-timeouts"></a><a name="request-timeouts"></a>Время ожидания запросов
RequestTimeout обычно происходит при использовании Direct/TCP, но может произойти в режиме шлюза. Эти ошибки являются распространенными причинами и предложениями по устранению проблемы.

* Загрузка ЦП высока, что приведет к задержке и/или превышению времени ожидания запросов. Клиент может увеличить масштаб хоста, чтобы предоставить ему больше ресурсов, или можно распределить нагрузку между несколькими компьютерами.
* Доступность сокета или порта может быть низкой. При работе в Azure клиенты, использующие пакет SDK для .NET, могут достичь нехватки портов Azure SNAT (PAT). Чтобы снизить вероятность возникновения этой проблемы, используйте последнюю версию 2. x или 3. x пакета SDK для .NET. Это пример того, почему рекомендуется всегда запускать последнюю версию пакета SDK.
* Создание нескольких экземпляров DocumentClient может привести к конфликтам соединений и времени ожидания. Следуйте [рекомендациям по повышению производительности](performance-tips.md)и используйте один экземпляр DocumentClient во всем процессе.
* Иногда пользователи видят задержки с повышенными правами или время ожидания запросов, так как их коллекции подготавливаются недостаточно, серверное регулирование запрашивает, а клиент пытается выполнить внутреннюю попытку. Проверьте [метрики портала](monitor-accounts.md).
* Azure Cosmos DB распределяет общую пропускную способность равномерно по физическим секциям. Проверьте метрики портала, чтобы определить, обнаруживает ли Рабочая нагрузка ключ горячей [Секции](partition-data.md). Это приведет к тому, что общая потребляемая пропускная способность (единицы запросов в секунду) будет отображаться под подготовленным компонентом RUs, но пропускная способность одной секции будет превышать подготовленную пропускную способность. 
* Кроме того, пакет SDK 2,0 добавляет семантику канала к прямым или TCP-подключениям. Одно TCP-соединение используется одновременно для нескольких запросов. Это может привести к двум проблемам в конкретных случаях:
    * Высокая степень параллелизма может привести к состязанию за канал.
    * Большие запросы или ответы могут привести к блокированию головного компьютера на основе усугубить, даже с относительно низкой степенью параллелизма.
    * Если обращение относится к любой из этих двух категорий (или при наличии высокой нагрузки на ЦП), это может быть устранено:
        * Попробуйте масштабировать приложение.
        * Кроме того, журналы пакета SDK можно отслеживать с помощью [прослушивателя трассировки](https://github.com/Azure/azure-cosmosdb-dotnet/blob/master/docs/documentdb-sdk_capture_etl.md) для получения дополнительных сведений.

### <a name="high-network-latency"></a><a name="high-network-latency"></a>Высокая задержка сети
Высокую задержку сети можно определить с помощью [строки диагностики](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring?view=azure-dotnet) в пакете SDK v2 или [диагностики](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics?view=azure-dotnet#Microsoft_Azure_Cosmos_ResponseMessage_Diagnostics) в пакете SDK v3.

Если [время ожидания](#request-timeouts) отсутствует, и диагностика отображают отдельные запросы, где большая задержка очевидна по разности между `ResponseTime` и `RequestStartTime`, например (>300 миллисекунд в этом примере):

```bash
RequestStartTime: 2020-03-09T22:44:49.5373624Z, RequestEndTime: 2020-03-09T22:44:49.9279906Z,  Number of regions attempted:1
ResponseTime: 2020-03-09T22:44:49.9279906Z, StoreResult: StorePhysicalAddress: rntbd://..., ...
```

Эта задержка может быть вызвана несколькими причинами:

* Приложение не работает в том же регионе, что и учетная запись Azure Cosmos DB.
* Конфигурация [PreferredLocations](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations) или [аппликатионрегион](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion) неверна и пытается подключиться к другому региону, на котором выполняется приложение.
* В связи с высоким трафиком сетевой интерфейс может быть узким местом. Если приложение выполняется на виртуальных машинах Azure, возможны следующие обходные пути:
    * Рассмотрите возможность использования [виртуальной машины с включенной функцией ускорения сети](../virtual-network/create-vm-accelerated-networking-powershell.md).
    * Включить [ускоренную сеть на существующей виртуальной машине](../virtual-network/create-vm-accelerated-networking-powershell.md#enable-accelerated-networking-on-existing-vms).
    * Рассмотрите возможность использования [виртуальной машины более высокого уровня](../virtual-machines/windows/sizes.md).

### <a name="azure-snat-pat-port-exhaustion"></a><a name="snat"></a>Нехватка портов SNAT (PAT) Azure

Если приложение развертывается на [виртуальных машинах Azure без общедоступного IP-адреса](../load-balancer/load-balancer-outbound-connections.md#defaultsnat), [порты Azure SNAT](../load-balancer/load-balancer-outbound-connections.md#preallocatedports) по умолчанию устанавливают подключения к любой конечной точке за пределами виртуальной машины. Количество разрешенных подключений от виртуальной машины к конечной точке Azure Cosmos DB ограничивается [конфигурацией Azure SNAT](../load-balancer/load-balancer-outbound-connections.md#preallocatedports). Такая ситуация может привести к регулированию подключений, закрытию соединения или приведенным выше [таймаутам запросов](#request-timeouts).

 Порты Azure SNAT используются только в том случае, если виртуальная машина имеет частный IP-адрес, подключающийся к общедоступному IP-адресу. Существует два обходных решения для предотвращения ограничения Azure SNAT (при условии, что вы уже используете один экземпляр клиента во всем приложении):

* Добавьте конечную точку службы Azure Cosmos DB к подсети виртуальной сети для службы "Виртуальные машины Azure". Дополнительные сведения см. в статье [Конечные точки служб для виртуальной сети Azure](../virtual-network/virtual-network-service-endpoints-overview.md). 

    При включении конечной точки службы запросы больше не отправляются с общедоступного IP-адреса в Azure Cosmos DB. Вместо этого отправляются идентификаторы виртуальной сети и подсети. Это изменение может привести к сбою брандмауэра, если разрешены только общедоступные IP-адреса. Если вы используете брандмауэр, при включении конечной точки службы добавьте подсеть в брандмауэре с помощью [списков управления доступом для виртуальных сетей](../virtual-network/virtual-networks-acl.md).
* Назначьте [общедоступный IP-адрес виртуальной машине Azure](../load-balancer/load-balancer-outbound-connections.md#assignilpip).

### <a name="http-proxy"></a>Прокси-сервер HTTP
При использовании прокси-сервера HTTP убедитесь, что он может поддерживать число подключений, указанное в свойстве `ConnectionPolicy` пакета SDK.
В противном случае возникнут проблемы с подключением.

### <a name="request-rate-too-large"></a><a name="request-rate-too-large"></a>Высокая частота запросов
"Частота запросов слишком велика" или код ошибки 429 указывает на регулирование запросов, так как Потребляемая пропускная способность (единиц запросов/с) превысила [подготовленную пропускную способность](set-throughput.md). Пакет SDK будет автоматически повторять запросы в соответствии с указанной [политикой повтора](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.retryoptions?view=azure-dotnet). Если эта ошибка возникает часто, попробуйте увеличить пропускную способность коллекции. Проверьте [метрики портала](use-metrics.md) , чтобы узнать, не возникают ли ошибки 429. Проверьте [ключ раздела](partitioning-overview.md#choose-partitionkey) , чтобы обеспечить равномерное распределение хранилища и объема запросов. 

### <a name="slow-query-performance"></a>Медленная производительность запросов
[Метрики запроса](sql-api-query-metrics.md) помогут определить, где в большинстве случаев тратится запрос. С помощью метрик запроса можно увидеть, какая часть ИТ-операций выполняется на серверной части и на клиенте.
* Если серверный запрос возвращается быстро и тратит большое время на клиент, Проверьте нагрузку на компьютер. Скорее всего, недостаточно ресурсов, и пакет SDK ожидает, пока ресурсы будут доступны для обработки ответа.
* Если запрос серверной части замедлится, попробуйте [оптимизировать запрос](optimize-cost-queries.md) и просмотреть текущую [политику индексирования](index-overview.md) . 

 <!--Anchors-->
[Common issues and workarounds]: #common-issues-workarounds
[Enable client SDK logging]: #logging
[Высокая частота запросов]: #request-rate-too-large
[Request Timeouts]: #request-timeouts
[Azure SNAT (PAT) port exhaustion]: #snat
[Production check list]: #production-check-list


