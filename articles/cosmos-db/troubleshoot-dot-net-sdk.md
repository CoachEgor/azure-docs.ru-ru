---
title: Diagnose and troubleshoot issues when using Azure Cosmos DB .NET SDK (Диагностика и устранение неполадок при использовании пакета SDK Azure Cosmos DB для .NET)
description: Используйте такие функции, как журналирование на стороне клиента и другие сторонние инструменты для выявления, диагностики и устранения неполадок в Azure Cosmos DB при использовании .NET SDK.
author: j82w
ms.service: cosmos-db
ms.date: 03/11/2020
ms.author: jawilley
ms.subservice: cosmosdb-sql
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 5f92d98630c6fb875babeb907f92732b0c24bb52
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79137960"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-cosmos-db-net-sdk"></a>Diagnose and troubleshoot issues when using Azure Cosmos DB .NET SDK (Диагностика и устранение неполадок при использовании пакета SDK Azure Cosmos DB для .NET)
В этой статье рассматриваются общие проблемы, обходные пути, диагностические шаги и инструменты при использовании [SDK .NET](sql-api-sdk-dotnet.md) с учетными записями API Azure Cosmos DB S'L.
SDK .NET обеспечивает логическое представление о клиентской стороне для доступа к API Azure Cosmos DB S'L. В этой статье описываются средства и подходы, которые помогут вам, если вы столкнетесь с проблемами.

## <a name="checklist-for-troubleshooting-issues"></a>Контрольный список для устранения неполадок:
Рассмотрим следующий контрольный список, прежде чем перенести приложение в производство. Использование контрольного списка предотвратит несколько распространенных проблем, которые вы можете увидеть. Вы также можете быстро диагностировать, когда возникает проблема:

*    Используйте новейшие [SDK](sql-api-sdk-dotnet-standard.md). Предварительный просмотр SDK не должен использоваться для производства. Это предотвратит попадание известных проблем, которые уже исправлены.
*    Просмотрите [советы по повышению производительности](performance-tips.md) и следуйте рекомендациям. Это поможет предотвратить масштабирование, задержку и другие проблемы с производительностью.
*    Включить журнал SDK, чтобы помочь вам устранить проблему. Включение журнала может повлиять на производительность, поэтому лучше включить ее только при устранении неполадок. Вы можете включить следующие журналы:
    *    [Войти метрики](monitor-accounts.md) с помощью портала Azure. Показатели портала показывают телеметрию Azure Cosmos DB, которая полезна для определения соответствия проблемы DB Azure Cosmos или со стороны клиента.
    *    Зарегистрируй [строку диагностики](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring) в V2 SDK или [диагностику](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics) в V3 SDK из точечных ответов.
    *    Ввнедните [метрику запросов](sql-api-query-metrics.md) из всех ответов на запросы 
    *    Следите за настройками [для регистрации SDK]( https://github.com/Azure/azure-cosmos-dotnet-v2/blob/master/docs/documentdb-sdk_capture_etl.md)

Ознакомьте с разделом [Распространенные проблемы и их обходные решения](#common-issues-workarounds) в этой статье.

Проверьте [раздел gitHub,](https://github.com/Azure/azure-cosmos-dotnet-v2/issues) который активно контролируется. Вы можете там найти уже готовое обходное решение похожей проблемы. Если вы не нашли решение, подайте файл проблемы GitHub. Вы можете открыть галочку поддержки для неотложных вопросов.


## <a name="common-issues-and-workarounds"></a><a name="common-issues-workarounds"></a>Распространенные проблемы и обходные решения для них

### <a name="general-suggestions"></a>Общие рекомендации
* По возможности запустите приложение в том же регионе Azure, что и учетная запись Azure Cosmos DB. 
* Вы можете столкнуться с проблемами подключения/доступности из-за отсутствия ресурсов на клиентской машине. Мы рекомендуем следить за использованием процессора на узлах под управлением клиента Azure Cosmos DB и масштабировать/выходить, если они работают при высокой нагрузке.

### <a name="check-the-portal-metrics"></a>Проверьте метрики портала
Проверка [метрик портала](monitor-accounts.md) поможет определить, является ли это проблемой со стороны клиента или же есть проблема с службой. Например, если метрики содержат высокую частоту запросов с ограниченной скоростью (код статуса HTTP 429), что означает, что запрос задушен, то проверьте [слишком большой] раздел Запроса. 

### <a name="requests-timeouts"></a><a name="request-timeouts"></a>Запросы тайм-аутов
ЗапросTimeout обычно происходит при использовании Direct/TCP, но может произойти в режиме gateway. Эти ошибки являются общими известными причинами, и предложения о том, как исправить проблему.

* Использование процессора является высоким, что приведет к задержке и/или тайм-ауту запроса. Клиент может масштабировать машину-хоста, чтобы дать ей больше ресурсов, или нагрузка может быть распределена по большему объему машин.
* Доступность socket / Port может быть низкой. При запуске в Azure клиенты, использующие SDK .NET, могут вычеркнуть порт Azure SNAT (PAT). Чтобы уменьшить вероятность попадания в эту проблему, используйте последнюю версию 2.x или 3.x .NET SDK. Это пример того, почему рекомендуется всегда запускать последнюю версию SDK.
* Создание нескольких экземпляров DocumentClient может привести к проблеме с подключением и тайм-ауту. Следуйте [советам](performance-tips.md)по производительности и используйте один экземпляр DocumentClient на протяжении всего процесса.
* Пользователи иногда видят повышенную задержку или запрос тайм-аутов, потому что их коллекции подготовлены недостаточно, бэк-энд дроссели запросы, и клиент retries внутренне. Проверьте [метрики портала.](monitor-accounts.md)
* Azure Cosmos DB равномерно распределяет общую прокладку по физическим разперегородким. Проверьте метрики портала, чтобы узнать, сталкивается ли рабочая нагрузка с [горячим ключом раздела.](partition-data.md) Это приведет к тому, что совокупная потребляемая пропускная часть (RU/s) будет отображаться в соответствии с подготовленными RUs, но одна потребляемая пропускная часть раздела (RU/s) превысит предъезжающую пропускную стоимость. 
* Кроме того, 2.0 SDK добавляет семантику каналов к прямым/TCP соединениям. Одно соединение TCP используется для нескольких запросов одновременно. Это может привести к двум вопросам в конкретных случаях:
    * Высокая степень параллелизма может привести к раздору на канале.
    * Большие запросы или ответы могут привести к блокировке на канале и усугубить разногласия, даже при относительно низкой степени параллелизма.
    * Если случай относится к любой из этих двух категорий (или при подозрении на высокое использование процессора), это возможные меры по смягчению последствий:
        * Попробуйте масштабировать приложение вверх / из.
        * Кроме того, журналы SDK могут быть захвачены через [Trace Listener,](https://github.com/Azure/azure-cosmosdb-dotnet/blob/master/docs/documentdb-sdk_capture_etl.md) чтобы получить более подробную информацию.

### <a name="high-network-latency"></a><a name="high-network-latency"></a>Высокая задержка сети
Высокая задержка сети может быть определена с помощью [диагностической строки](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring?view=azure-dotnet) в V2 SDK или [диагностики](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics?view=azure-dotnet#Microsoft_Azure_Cosmos_ResponseMessage_Diagnostics) в V3 SDK.

Если [тайм-аутов](#request-timeouts) нет, а в диагностике показаны отдельные запросы, где высокая задержка очевидна на разнице между `ResponseTime` и, `RequestStartTime`как это (>300 миллисекунд в этом примере):

```bash
RequestStartTime: 2020-03-09T22:44:49.5373624Z, RequestEndTime: 2020-03-09T22:44:49.9279906Z,  Number of regions attempted:1
ResponseTime: 2020-03-09T22:44:49.9279906Z, StoreResult: StorePhysicalAddress: rntbd://..., ...
```

Эта задержка может иметь несколько причин:

* Приложение работает не в том же регионе, что и учетная запись Azure Cosmos DB.
* Конфигурация [PreferredLocations](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations) или [ApplicationRegion](https://docs.microsoft.com/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion) неверна и пытается подключиться к другой области, где в настоящее время работает приложение.
* В интерфейсе Сети может возникнуть узкое место из-за высокого трафика. Если приложение работает на Azure Virtual Machines, возможны обходные пути:
    * Рассмотрите возможность использования [виртуальной машины с включенной ускоренной сетью.](../virtual-network/create-vm-accelerated-networking-powershell.md)
    * Включить [ускоренную сеть на существующей виртуальной машине.](../virtual-network/create-vm-accelerated-networking-powershell.md#enable-accelerated-networking-on-existing-vms)
    * Рассмотрите возможность использования [виртуальной машины более высокого класса.](../virtual-machines/windows/sizes.md)

### <a name="azure-snat-pat-port-exhaustion"></a><a name="snat"></a>Нехватка портов SNAT (PAT) Azure

Если ваше приложение развернуто на [виртуальных машинах Azure без публичного IP-адреса,](../load-balancer/load-balancer-outbound-connections.md#defaultsnat)по умолчанию [порты Azure SNAT](../load-balancer/load-balancer-outbound-connections.md#preallocatedports) устанавливают соединения с любой конечной точкой за пределами вашего VM. Количество разрешенных подключений от виртуальной машины к конечной точке Azure Cosmos DB ограничивается [конфигурацией Azure SNAT](../load-balancer/load-balancer-outbound-connections.md#preallocatedports). Эта ситуация может привести к задушить соединение, замыкает соединение или вышеупомянутое [тайм-ауты Запроса.](#request-timeouts)

 Порты Azure SNAT используются только тогда, когда ваш VM имеет личный IP-адрес, подключающийся к общедоступному IP-адресу. Есть два обходных пути, чтобы избежать ограничения Azure SNAT (при условии, что вы уже используете один экземпляр клиента по всему приложению):

* Добавьте конечную точку службы Azure Cosmos DB к подсети виртуальной сети для службы "Виртуальные машины Azure". Дополнительные сведения см. в статье [Конечные точки служб для виртуальной сети Azure](../virtual-network/virtual-network-service-endpoints-overview.md). 

    При включении конечной точки службы запросы больше не отправляются с общедоступного IP-адреса в Azure Cosmos DB. Вместо этого отправляются идентификаторы виртуальной сети и подсети. Это изменение может привести к сбою брандмауэра, если разрешены только общедоступные IP-адреса. Если вы используете брандмауэр, при включении конечной точки службы добавьте подсеть в брандмауэре с помощью [списков управления доступом для виртуальных сетей](../virtual-network/virtual-networks-acl.md).
* Назначить [общедоступный IP вашему Azure VM.](../load-balancer/load-balancer-outbound-connections.md#assignilpip)

### <a name="http-proxy"></a>Прокси-сервер HTTP
При использовании прокси-сервера HTTP убедитесь, что он может поддерживать число подключений, указанное в свойстве `ConnectionPolicy` пакета SDK.
В противном случае возникнут проблемы с подключением.

### <a name="request-rate-too-large"></a><a name="request-rate-too-large"></a>Высокая частота запросов
"Запрос слишком большой" или код ошибки 429 указывает, что ваши запросы задушены, потому что потребляемая пропускная мощность (RU/s) превысила [просряженный пропускной результат.](set-throughput.md) SDK будет автоматически повторно делать повторную попытку на основе указанной [политики повтора.](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.retryoptions?view=azure-dotnet) Если вы часто получаете этот сбой, подумайте об увеличении пропускной способности коллекции. Проверьте [метрики портала,](use-metrics.md) чтобы увидеть, если вы получаете 429 ошибок. Просмотрите [ключ раздела,](partitioning-overview.md#choose-partitionkey) чтобы убедиться, что это приводит к равномерному распределению объема хранения и запросов. 

### <a name="slow-query-performance"></a>Медленная производительность запроса
[Метрики запроса](sql-api-query-metrics.md) помогут определить, где запрос проводит большую часть времени. Из метрик запроса можно увидеть, сколько из этого тратится на бэк-энд против клиента.
* Если запрос бэк-энда быстро возвращается и тратит большое время на клиента, проверяйте нагрузку на машину. Вполне вероятно, что ресурсов недостаточно, и SDK ждет, когда ресурсы будут доступны для обработки ответа.
* Если запрос бэк-энда медленный, попробуйте [оптимизировать запрос](optimize-cost-queries.md) и посмотреть текущую [политику индексирования](index-overview.md) 

 <!--Anchors-->
[Common issues and workarounds]: #common-issues-workarounds
[Enable client SDK logging]: #logging
[Высокая частота запросов]: #request-rate-too-large
[Request Timeouts]: #request-timeouts
[Azure SNAT (PAT) port exhaustion]: #snat
[Production check list]: #production-check-list


