---
title: Диагностика и устранение неполадок при использовании пакета SDK .NET Azure Cosmos DB
description: Используйте функции, такие как ведение журнала на стороне клиента и другие сторонние средства для определения, диагностирования и устранения неполадок Azure Cosmos DB в том случае, при использовании пакета SDK для .NET.
author: j82w
ms.service: cosmos-db
ms.date: 05/28/2019
ms.author: jawilley
ms.devlang: c#
ms.subservice: cosmosdb-sql
ms.topic: troubleshooting
ms.reviewer: sngun
ms.openlocfilehash: 7e48809537acc21edbcf12d299a333df486c258f
ms.sourcegitcommit: 25a60179840b30706429c397991157f27de9e886
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/28/2019
ms.locfileid: "66257159"
---
# <a name="diagnose-and-troubleshoot-issues-when-using-azure-cosmos-db-net-sdk"></a>Диагностика и устранение неполадок при использовании пакета SDK .NET Azure Cosmos DB
В этой статье рассматриваются распространенные проблемы, обходные пути, этапы диагностики и средств, при использовании [пакета SDK для .NET](sql-api-sdk-dotnet.md) с учетными записями Azure Cosmos DB SQL API.
Пакет SDK для .NET предоставляет клиентское логическое представление для доступа к Azure Cosmos DB SQL API. В этой статье описываются средства и подходы, которые помогут вам, если вы столкнетесь с проблемами.

## <a name="checklist-for-troubleshooting-issues"></a>Контрольный список для устранения неполадок.
Рассмотрим следующий контрольный список перед перемещением приложения в рабочей среде. С помощью контрольного списка не позволит ряд распространенных проблем, с которыми можно столкнуться. Кроме того, можно быстро диагностировать при возникновении неполадки:

*   Используйте последнюю версию [SDK](https://github.com/Azure/azure-cosmos-dotnet-v2/blob/master/changelog.md). Пакеты SDK предварительной версии не должен использоваться для рабочей среды. Это позволит избежать превышения известных проблем, которые уже были устранены.
*   Просмотрите [советы по повышению производительности](performance-tips.md) и следуйте рекомендациям. Это помогает предотвратить масштабирование, задержки и других проблем с производительностью.
*   Включите ведение журнала пакета SDK для устранения проблемы. Включение ведения журнала может повлиять на производительность, так что лучше включить, то только в том случае, при устранении неполадок. Вы можете включить следующие журналы:
    *   [Журнал метрик](monitor-accounts.md) с помощью портала Azure. Метрики портала показывают данные телеметрии Azure Cosmos DB, это может понадобиться определить проблему соответствует Azure Cosmos DB или в случае со стороны клиента.
    *   Журнал [строку диагностики](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring?view=azure-dotnet) из ответов операции точки.
    *   Журнал [метрики SQL-запросов](sql-api-query-metrics.md) из все ответы на запросы 
    *   Выполните настройку [ведение журнала пакета SDK]( https://github.com/Azure/azure-cosmos-dotnet-v2/blob/master/docs/documentdb-sdk_capture_etl.md)

Ознакомьте с разделом [Распространенные проблемы и их обходные решения](#common-issues-workarounds) в этой статье.

Проверьте [разделе проблем на GitHub](https://github.com/Azure/azure-cosmos-dotnet-v2/issues) , активно отслеживается. Вы можете там найти уже готовое обходное решение похожей проблемы. Если вы не нашли решение, затем файла на github. Вы можете открыть такт поддержки для срочных проблемах.


## <a name="common-issues-workarounds"></a>Распространенные проблемы и их обходные решения

### <a name="general-suggestions"></a>Общие рекомендации
* Запустите приложение в одном регионе Azure с учетной записью Azure Cosmos DB, когда это возможно. 
* Вы можете столкнуться проблемам подключения и доступности из-за нехватки ресурсов на клиентском компьютере. Рекомендуется отслеживать ЦП на узлах под управлением клиента Azure Cosmos DB и масштабирование вверх ввода-вывода, если они выполняются с повышенной нагрузкой.

### <a name="check-the-portal-metrics"></a>Проверьте метрики портала
Проверка [метрик портала](monitor-accounts.md) помогут определить, если это проблема на стороне клиента или если имеется проблема со службой. Например если метрики содержат большое число ограничение скорости выполнения запросов (код состояния HTTP 429) значит, запрос выполняется регулирование проверьте [слишком высокая частота запросов] раздел. 

### <a name="request-timeouts"></a>Время ожидания запросов
RequestTimeout обычно происходит при использовании Direct и TCP, но может произойти в режиме шлюза. Ниже приведены распространенные известные причины и предложения по устранению проблемы.

* Использования ЦП высок, который будет привести к задержке и/или время ожидания запроса. Клиента можно увеличить масштаб хост-компьютере, присвоить ей дополнительные ресурсы или нагрузку можно распределить между больше компьютеров.
* Сокет / доступности порта может быть низкой. При использовании пакетов SDK для .NET, выпущенных до версии 2.0, клиентов, работающих в Azure, может возникнуть [Нехватка портов SNAT (PAT) Azure]. Этот пример почему мы рекомендуем всегда запускать последнюю версию пакета SDK.
* Создание нескольких экземпляров DocumentClient может привести к конфликту подключения и проблемы с временем ожидания. Выполните [советы по повышению производительности](performance-tips.md), а затем используйте один экземпляр DocumentClient на весь процесс.
* Пользователи иногда см. в разделе повышенного времени ожидания задержки или запрос, так как их коллекций подготавливаются недостаточно, серверной части регулирует запросы и клиент будет повторять попытки не отображает это вызывающему объекту. Проверьте [метрик портала](monitor-accounts.md).
* Azure Cosmos DB равномерно распределяет общей подготовленной пропускной способности между физическими секциями. Проверьте метриках портала, см. в разделе, если рабочая нагрузка возникли горячих [ключ секции](partition-data.md). В результате суммарная потребляемого пропускная способность (ЕЗ/с), и отображаются в подготовленные ЕЗ, но одной секции используются еще и пропускную способность (ЕЗ/с) будет превышать подготовленную пропускную способность. 
* Кроме того пакет SDK 2.0 добавляет семантику канала direct и TCP-подключений. Одно TCP-подключение используется для нескольких запросов одновременно. Это может привести к двух проблем в определенных случаях:
    * Высокая степень параллелизма может привести к конкуренции в канале.
    * Большие запросы или ответы можно привести к блокировке head строки по каналу и ухудшить состязания, даже с относительно низкой степенью параллелизма.
    * Если так находится в любой из этих двух категорий (или подозревается высокая загрузка ЦП), ниже приведены возможные способы устранения:
        * Попробуйте выполнить масштабирование вверх/выходные данные приложения.
        * Кроме того, можно фиксировать журналы пакета SDK с помощью [прослушиватель трассировки](https://github.com/Azure/azure-cosmosdb-dotnet/blob/master/docs/documentdb-sdk_capture_etl.md) для получения дополнительных сведений.

### <a name="connection-throttling"></a>Регулирование подключения
Регулирование соединений может произойти из-за ограничение числа подключений на хост-компьютере. До 2.0, клиентов, работающих в Azure, может возникнуть [Нехватка портов SNAT (PAT) Azure].

### <a name="snat"></a>Нехватка портов SNAT (PAT) Azure

Если ваше приложение развернуто в службе "Виртуальные машины Azure" без общедоступного IP-адреса, по умолчанию [порты Azure SNAT](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-connections#preallocatedports) используются для установления подключений к любой конечной точке вне вашей виртуальной машины. Количество разрешенных подключений от виртуальной машины к конечной точке Azure Cosmos DB ограничивается [конфигурацией Azure SNAT](https://docs.microsoft.com/azure/load-balancer/load-balancer-outbound-connections#preallocatedports).

 Порты Azure SNAT используются, только если у виртуальной машины есть частный IP-адрес и процесс на виртуальной машине пытается установить подключение к общедоступному IP-адресу. Избежать ограничений Azure SNAT можно двумя способами:

* Добавьте конечную точку службы Azure Cosmos DB к подсети виртуальной сети для службы "Виртуальные машины Azure". Дополнительные сведения см. в статье [Конечные точки служб для виртуальной сети Azure](https://docs.microsoft.com/azure/virtual-network/virtual-network-service-endpoints-overview). 

    При включении конечной точки службы запросы больше не отправляются с общедоступного IP-адреса в Azure Cosmos DB. Вместо этого отправляются идентификаторы виртуальной сети и подсети. Это изменение может привести к сбою брандмауэра, если разрешены только общедоступные IP-адреса. Если вы используете брандмауэр, при включении конечной точки службы добавьте подсеть в брандмауэре с помощью [списков управления доступом для виртуальных сетей](https://docs.microsoft.com/azure/virtual-network/virtual-networks-acl).
* Назначьте общедоступный IP-адрес виртуальной машине Azure.

### <a name="http-proxy"></a>Прокси-сервер HTTP
При использовании прокси-сервера HTTP убедитесь, что он может поддерживать число подключений, указанное в свойстве `ConnectionPolicy` пакета SDK.
В противном случае возникнут проблемы с подключением.

### Слишком высокая частота запросов<a name="request-rate-too-large"></a>
«Запрос слишком высокая частота» или код ошибки 429 указывает, что выполняется регулировка ваших запросов, поскольку потребляемого пропускная способность (ЕЗ/с) превышает подготовленную пропускную способность. Пакет SDK автоматически повторит запросов на основе указанного [политика повтора](https://docs.microsoft.com/dotnet/api/microsoft.azure.documents.client.connectionpolicy.retryoptions?view=azure-dotnet). Если эта ошибка возникает часто, попробуйте увеличить пропускную способность для коллекции. Проверьте [метрик портала](use-metrics.md) для просмотра, при получении ошибки 429. Просмотрите ваши [ключ секции](https://docs.microsoft.com/azure/cosmos-db/partitioning-overview#choose-partitionkey) для обеспечения равномерного распределения объема хранилища и запрос приводит. 

### <a name="slow-query-performance"></a>Запрос работает медленно
[Запрос метрик](sql-api-query-metrics.md) помогут определить, где запрос тратит большую часть времени. На основе запроса метрик, можно увидеть, насколько они, затраченное на серверной части vs клиента.
* Если запрос серверной части возвращает быстро и проводит большое время на клиенте проверьте нагрузку на компьютер. Вполне вероятно, что не хватает ресурсов, и пакет SDK ожидает ресурсы были доступны для обработки ответа.
* Если серверной части запрос выполняется медленно, попробуйте [оптимизации запроса](optimize-cost-queries.md) и поиска в текущем [политика индексации](index-overview.md) 

 <!--Anchors-->
[Common issues and workarounds]: #common-issues-workarounds
[Enable client SDK logging]: #logging
[Слишком высокая частота запросов]: #request-rate-too-large
[Request Timeouts]: #request-timeouts
[Нехватка портов SNAT (PAT) Azure]: #snat
[Production check list]: #production-check-list


