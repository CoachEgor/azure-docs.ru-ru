---
title: Использование диспетчера данных блокчейна для обновления Azure Cosmos DB
description: Использование диспетчера данных блокчейна для отправки данных блокчейна в Azure Cosmos DB
services: azure-blockchain
author: PatAltimore
ms.author: patricka
ms.date: 11/04/2019
ms.topic: tutorial
ms.service: azure-blockchain
ms.reviewer: chroyal
ms.openlocfilehash: 3f2d0df2c094d8455aa29e79ad3c6acc0aa52dd4
ms.sourcegitcommit: f4d8f4e48c49bd3bc15ee7e5a77bee3164a5ae1b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2019
ms.locfileid: "73585710"
---
# <a name="tutorial-use-blockchain-data-manager-to-send-data-to-azure-cosmos-db"></a>Руководство по Использование диспетчера данных блокчейна для отправки данных в Azure Cosmos DB

Работая с этим руководством, вы примените диспетчер данных блокчейна в службе "Блокчейн Azure" для записи данных транзакций блокчейна в Azure Cosmos DB. Диспетчер данных блокчейна регистрирует, преобразует и доставляет данные реестров блокчейна в разделы Сетки событий Azure. В службе "Сетка событий Azure" вы можете создавать документы в базе данных Azure Cosmos DB с помощью соединителя приложений логики Azure. Завершив работу с руководством, вы сможете исследовать данные о транзакциях блокчейна через обозреватель данных Azure Cosmos DB.

[![Сведения о транзакциях блокчейна](./media/data-manager-cosmosdb/raw-msg.png)](./media/data-manager-cosmosdb/raw-msg.png#lightbox)

Изучив это руководство, вы:

> [!div class="checklist"]
> * Создадите экземпляр диспетчера данных блокчейна.
> * Добавите приложение блокчейна для декодирования свойств и событий транзакций.
> * Создадите учетную запись Azure Cosmos DB и базу данных для хранения данных о транзакциях
> * Создадите приложение логики Azure для подключения раздела Сетки событий Azure к Azure Cosmos DB
> * Отправите транзакцию в реестр блокчейна.
> * Просмотрите декодированные данные о транзакциях в Azure Cosmos DB.

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

* См. подробнее об [использовании созданию участника блокчейна на портале Azure](create-member.md) и [руководство по созданию участника блокчейна службы "Блокчейн Azure" с помощью Azure CLI](create-member-cli.md);
* См. подробнее об [использовании Подключитесь к сети консорциума службы "Блокчейн Azure" с помощью Visual Studio Code](connect-vscode.md). В этом кратком руководстве описывается, как установить [Пакет средств разработки Блокчейна Azure для Ethereum](https://marketplace.visualstudio.com/items?itemName=AzBlockchain.azure-blockchain) и настроить среду разработки блокчейна.
* Выполните инструкции из [руководства по созданию, сборке и развертыванию смарт-контрактов с помощью Visual Studio Code](send-transaction.md). В этом руководстве подробно рассматривается пример создания смарт-контракта.
* Создайте [раздел Сетки событий](../../event-grid/custom-event-quickstart-portal.md#create-a-custom-topic).
* Подробные сведения см. в статье об [обработчиках событий в службе "Сетка событий Azure"](../../event-grid/event-handlers.md).

## <a name="create-instance"></a>Создание экземпляра

Каждый экземпляр диспетчера данных блокчейна подключается к узлу транзакций службы "Блокчейн Azure" и отслеживает его. Экземпляр регистрирует все необработанные данные о блоках и транзакциях из узла транзакций. Исходящее подключение отправляет данные блокчейна в службу "Сетка событий Azure". При создании экземпляра вы настраиваете одно исходящее подключение.

1. Войдите на [портале Azure](https://portal.azure.com).
1. Перейдите к элементу службы "Блокчейн Azure", который вы создали с помощью [краткого руководства по созданию элемента блокчейна на портале Azure](create-member.md). Щелкните **Blockchain Data Manager** (Диспетчер данных блокчейна).
1. Выберите **Добавить**.

    ![Добавление диспетчера данных блокчейна](./media/data-manager-cosmosdb/add-instance.png)

    Введите следующие сведения:

    Параметр | Пример | ОПИСАНИЕ
    --------|---------|------------
    ИМЯ | mywatcher | Введите уникальное имя для подключенного диспетчера данных блокчейна.
    Узел транзакции | myblockchainmember | Перейдите к узлу транзакций по умолчанию в элементе службы "Блокчейн Azure", который вы создали на этапе выполнения обязательных требований.
    Имя подключения | cosmosdb | Введите уникальное имя исходящего подключения, в которое отправляются данные транзакций блокчейна.
    Конечная точка Сетки событий | myTopic | Выберите раздел Сетки событий, который вы создали на этапе выполнения обязательных требований. Примечание. Экземпляр диспетчера данных блокчейна и раздел сетки событий должны находиться в одной подписке.

1. Нажмите кнопку **ОК**.

    Создание экземпляра диспетчера данных блокчейна занимает менее минуты. Когда завершается развертывание экземпляра, он запускается автоматически. Выполняющийся экземпляр диспетчера данных блокчейна регистрирует события блокчейна из узла транзакций и отправляет эти данные в Сетку событий.

## <a name="add-application"></a>Добавить приложение

Добавьте приложение блокчейна **helloblockchain**, чтобы диспетчер данных блокчейна мог декодировать события и состояния свойств. Для добавления приложения диспетчеру данных блокчейна требуется ABI и файл байт-кода смарт-контракта.

### <a name="get-contract-abi-and-bytecode"></a>Получение ABI и байт-кода контракта

ABI контракта определяет интерфейсы смарт-контракта. В нем описывается взаимодействие со смарт-контрактом. ABI контракта можно скопировать в буфер обмена через [расширение Пакета средств разработки Блокчейна Azure для Ethereum](https://marketplace.visualstudio.com/items?itemName=AzBlockchain.azure-blockchain).

1. На панели обозревателя Visual Studio Code разверните папку **build/contracts** проекта Solidity **helloblockchain**, которую вы создали на этапе выполнения обязательных требований к [руководству по созданию, сборке и развертыванию смарт-контрактов с помощью Visual Studio Code](send-transaction.md).
1. Правой кнопкой мыши щелкните JSON-файл метаданных контракта. Имя файла — это имя смарт-контракта, за которым следует расширение **.json**.
1. Щелкните **Скопировать ABI контракта**.

    ![Панель Visual Studio Code, где выбрано действие "Скопировать ABI контракта"](./media/data-manager-cosmosdb/abi-devkit.png)

    ABI контракта скопируется в буфер обмена.

1. Сохраните массив **abi** в JSON-файл. Например, с именем *abi.json*. Он понадобится вам на одном из следующих шагов.

Диспетчеру данных блокчейна нужен развернутый байт-код для смарт-контракта. Развернутый байт-код отличается от байт-кода смарт-контракта. Развернутый байт-код можно получить из скомпилированного файла метаданных контракта.

1. Откройте файл метаданных контракта, содержащийся в папке **build/contracts** проекта Solidity. Имя файла — это имя смарт-контракта, за которым следует расширение **.json**.
1. Найдите элемент **deployedBytecode** в JSON-файле.
1. Скопируйте шестнадцатеричное значение без кавычек.

    ![Панель Visual Studio Code, где представлен байт-код в составе метаданных](./media/data-manager-portal/bytecode-metadata.png)

1. Сохраните **байт-код** в виде JSON-файла. Например, с именем *bytecode.json*. Он понадобится вам на одном из следующих шагов.

В следующем примере показаны файлы *abi.json* и *bytecode.json*, открытые в редакторе VS Code. Ваши файлы должны выглядеть примерно так же.

![Пример содержимого файлов abi.json и bytecode.json](./media/data-manager-cosmosdb/contract-files.png)

### <a name="create-contract-abi-and-bytecode-url"></a>Создание ABI и URL-адреса байт-кода контракта

Диспетчеру данных блокчейна при добавлении приложения нужно, чтобы файлы ABI и байт-кода для контракта были доступны по URL-адресу. Для предоставления частного URL-адреса можно использовать учетную запись хранения Azure.

#### <a name="create-storage-account"></a>Создание учетной записи хранения

[!INCLUDE [storage-create-account-portal-include](../../../includes/storage-create-account-portal-include.md)]

#### <a name="upload-contract-files"></a>Отправка файлов контракта

1. Создайте новый контейнер для учетной записи хранения. Выберите **Контейнеры > Контейнер**.

    ![Создание контейнера учетной записи хранения](./media/data-manager-cosmosdb/create-container.png)

    | Параметр | ОПИСАНИЕ |
    |---------|-------------|
    | ИМЯ  | Присвойте контейнеру имя, например *smartcontract*. |
    | Public access level (Уровень общего доступа) | Выберите *Private (no anonymous access)* (Частный (без анонимного доступа)). |

1. Нажмите кнопку **ОК**, чтобы создать контейнер.
1. Выберите контейнер и щелкните **Отправить**.
1. Выберите оба файла JSON, которые вы создали в разделе, посвященном [получению ABI и байт-кода контракта](#get-contract-abi-and-bytecode).

    ![Отправка большого двоичного объекта](./media/data-manager-cosmosdb/upload-blobs.png)

    Щелкните **Отправить**.

#### <a name="generate-url"></a>Создание URL-адреса

Создайте подписанный URL-адрес для каждого большого двоичного объекта.

1. Выберите большой двоичный объект с кодом JSON для ABI.
1. Щелкните **Создать SAS**.
1. Задайте требуемый срок действия подписи доступа, и щелкните **Создать маркер SAS BLOB-объекта и URL-адрес**.

    ![Создание маркера SAS](./media/data-manager-cosmosdb/generate-sas.png)

1. Создайте **URL-адрес SAS BLOB-объекта** и сохраните его для использования в следующем разделе.
1. Повторите шаги [по созданию URL-адреса](#generate-url) для большого двоичного объекта с кодом JSON для байт-кода.

### <a name="add-helloblockchain-application-to-instance"></a>Добавление приложения helloblockchain в экземпляр

1. Выберите экземпляр диспетчера данных блокчейна из списка экземпляров.
1. Выберите **Blockchain applications** (Приложения блокчейна).
1. Выберите **Добавить**.

    ![Добавление приложения блокчейна](./media/data-manager-cosmosdb/add-application.png)

    Введите имя приложения блокчейна и URL-адреса ABI и байт-кода для смарт-контракта.

    Параметр | ОПИСАНИЕ
    --------|------------
    ИМЯ | Введите уникальное имя приложения блокчейна, которое нужно отслеживать.
    Contract ABI (ABI контракта) | URL-адрес файла ABI контракта. Подробные сведения см. в разделе о [создании ABI и URL-адреса байт-кода контракта](#create-contract-abi-and-bytecode-url).
    Contract Bytecode (Байт-код контракта) | URL-путь к файлу байт-кода. Подробные сведения см. в разделе о [создании ABI и URL-адреса байт-кода контракта](#create-contract-abi-and-bytecode-url).

1. Нажмите кнопку **ОК**.

    Когда приложение будет создано, оно появится в списке приложений блокчейна.

    ![Список приложений блокчейна](./media/data-manager-cosmosdb/artifact-list.png)

Вы можете удалить учетную запись хранения Azure или использовать ее для настройки других приложений блокчейна. Если вы хотите удалить учетную запись хранения Azure, можно сразу удалить группу ресурсов. При этом удаляется связанная учетная запись хранения и другие ресурсы, связанные с этой группой ресурсов.

## <a name="create-azure-cosmos-db"></a>Создание Azure Cosmos DB

[!INCLUDE [cosmos-db-create-storage-account](../../../includes/cosmos-db-create-dbaccount.md)]

### <a name="add-a-database-and-container"></a>Добавление базы данных и контейнера

Создать базу данных и контейнер можно с помощью обозревателя данных на портале Azure.

1. Выберите **Обозреватель данных** в области навигации слева на странице учетной записи Azure Cosmos DB, а затем щелкните **Новый контейнер**.
1. На панели **Добавить контейнер** введите параметры для нового контейнера.

    ![Добавление параметров контейнера](./media/data-manager-cosmosdb/add-container.png)

    | Параметр | ОПИСАНИЕ
    |---------|-------------|
    | Идентификатор базы данных | Введите **blockchain-data** в качестве имени новой базы данных. |
    | Пропускная способность | Для пропускной способности сохраните значение в **400** единиц запроса в секунду. Чтобы сократить задержку, позже вы можете увеличить масштаб пропускной способности.|
    | Container ID (Идентификатор контейнера) | Введите **Messages** в качестве имени нового контейнера. |
    | Ключ секции | Укажите **/MessageType** в качестве ключа секции. |

1. Нажмите кнопку **ОК**. В обозревателе данных отображается новая база данных и контейнер, который вы создали.

## <a name="create-logic-app"></a>Создание приложения логики

С помощью Azure Logic Apps можно планировать, автоматизировать бизнес-процессы и рабочие процессы, когда необходимо интегрировать системы и службы. Вы можете использовать приложение логики для подключения Сетки событий к Azure Cosmos DB.

1. На [портале Azure](https://portal.azure.com) выберите **Создать ресурс** > **Интеграция** > **Приложение логики**.
1. Введите сведения о расположении для создания приложения логики. Когда все будет готово, выберите **Создать**.

    См. сведения о [создании автоматизированных рабочих процессов с использованием Azure Logic Apps](../../logic-apps/quickstart-create-first-logic-app-workflow.md).

1. После развертывания приложения в Azure выберите ресурс приложения логики.
1. В разделе **Шаблоны** конструктора Logic Apps щелкните **Пустое приложение логики**.

### <a name="add-event-grid-trigger"></a>Добавление триггера Сетки событий

Каждое приложение логики должно запускаться по триггеру, который активируется, когда происходит определенное событие или если выполняются заданные условия. При каждом срабатывании триггера обработчик Logic Apps создает экземпляр приложения логики, запускающий и выполняющий рабочий процесс. Используйте триггер службы "Сетка событий Azure" для отправки данных транзакций блокчейна из Сетки событий в Cosmos DB.

1. В конструкторе Logic Apps найдите и выберите соединитель **Сетка событий Azure**.
1. На вкладке **Триггеры** выберите **При возникновении события ресурса**.
1. Создайте подключение API к разделу Сетки событий.

    ![Параметры триггера Сетки событий](./media/data-manager-cosmosdb/event-grid-trigger.png)

    | Параметр | ОПИСАНИЕ
    |---------|-------------|
    | Subscription | Выберите подписку Azure, которая содержит раздел Сетки событий. |
    | Тип ресурса | Выберите **Microsoft.EventGrid.Topics**. |
    | Имя ресурса | Выберите имя раздела Сетки событий, в который диспетчер данных блокчейна отправляет сообщения с данными о транзакциях. |

### <a name="add-cosmos-db-action"></a>Добавление действия Cosmos DB

Добавьте действие, которое будет создавать в Cosmos DB документ для каждой транзакции. Укажите тип сообщения о транзакции в качестве ключа секции для классификации сообщений.

1. Выберите **Новый шаг**.
1. В разделе **Выберите действие**, найдите **Azure Cosmos DB**.
1. Выберите **Azure Cosmos DB > Действия > Создание или обновление документа**.
1. Создайте подключение API к базе данных Cosmos DB.

    ![Параметры подключения к Cosmos DB](./media/data-manager-cosmosdb/cosmosdb-connection.png)

    | Параметр | ОПИСАНИЕ
    |---------|-------------|
    | Имя подключения | Выберите подписку Azure, которая содержит раздел Сетки событий. |
    | Учетная запись DocumentDB | Выберите учетную запись DocumentDB, которую вы создали в разделе о [создании учетной записи Azure Cosmos DB](#create-azure-cosmos-db). |

1. Введите **идентификатор базы данных**  и **идентификатор коллекции** для экземпляра Azure Cosmos DB, который вы создали ранее в разделе о [добавлении базы данных и контейнера](#add-a-database-and-container).

1. Выберите параметр **Документ**. Во всплывающем окне *Добавить динамическое содержимое* выберите **Выражение**, затем скопируйте и вставьте следующее выражение:

    ```
    addProperty(triggerBody()?['data'], 'id', utcNow())
    ```

    Это выражение получает часть данных из сообщения и присваивает идентификатору значение метки времени.

1. Щелкните **Добавить параметр** и выберите **Значение ключа раздела**.
1. Для параметра **Значение ключа раздела** укажите значение `"@{triggerBody()['data']['MessageType']}"`. Это значение нужно заключить в двойные кавычки.

    ![Конструктор Logic Apps с параметрами Cosmos DB](./media/data-manager-cosmosdb/create-action.png)

    Это значение задает в качестве ключа секции тип сообщения транзакции.

1. Щелкните **Сохранить**.

Приложение логики отслеживает раздел Сетки событий. Когда диспетчер данных блокчейна отправляет новое сообщение о транзакции, приложение логики создает новый документ в Cosmos DB.

## <a name="send-a-transaction"></a>Отправка транзакции

Теперь отправьте транзакцию в реестр блокчейна, чтобы проверить созданное приложение. Используйте скрипт **sendrequest.js**, который вы создали при работе с [руководством по созданию, сборке и развертыванию смарт-контрактов с помощью Visual Studio Code](send-transaction.md).

В терминале VS Code используйте Truffle, чтобы выполнить скрипт для своей сети блокчейн-консорциума. В строке меню терминала выберите вкладку **Терминал**, а в раскрывающемся списке — **PowerShell**.

``` PowerShell
truffle exec sendrequest.js --network <blockchain network>
```

Замените \<blockchain network\> именем сети блокчейн, указанным в файле **truffle-config.js**.

![Отправка транзакции](./media/data-manager-cosmosdb/send-request.png)

## <a name="view-transaction-data"></a>Просмотр данных транзакций

Теперь, когда вы подключили диспетчер данных блокчейна к Azure Cosmos DB, можно просмотреть сообщения транзакций блокчейна в обозревателе данных Cosmos DB.

1. Откройте представление обозревателя данных Cosmos DB. Например, так: **cosmosdb-blockchain > Обозреватель данных > blockchain-data > Сообщения > Элементы**.

    ![Обозреватель данных Cosmos DB](./media/data-manager-cosmosdb/data-explorer.png)

    Обозреватель данных отображает список сообщений с данными блокчейна, которые были созданы в базе данных Cosmos DB.

1. Просмотрите эти сообщения. Выберите идентификатор элемента и найдите сообщение с совпадающим хэш-кодом транзакции.

    [![Сведения о транзакциях блокчейна](./media/data-manager-cosmosdb/raw-msg.png)](./media/data-manager-cosmosdb/raw-msg.png#lightbox)

    Необработанное сообщение транзакции содержит подробные сведения о транзакции. Но сведения о свойствах шифруются.

    Так как вы добавили смарт-контракт HelloBlockchain в экземпляр диспетчера данных блокчейна, отправляется еще и сообщение с типом **ContractProperties**, которое содержит декодированные сведения о свойствах.

1. Найдите сообщение **ContractProperties** для этой транзакции. Обычно это следующее сообщение в списке.

    [![Сведения о транзакции блокчейна](./media/data-manager-cosmosdb/properties-msg.png)](./media/data-manager-cosmosdb/properties-msg.png#lightbox)

    Массив **DecodedProperties** содержит свойства транзакции.

Поздравляем! Вы успешно создали обозреватель сообщений транзакций с помощью диспетчера данных блокчейна и Azure Cosmos DB.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если ресурсы и группа ресурсов, которые вы использовали во время работы с руководством, вам больше не требуются, их можно удалить. Чтобы удалить группу ресурсов:

1. На портале Azure перейдите к **группам ресурсов** в области навигации слева и выберите группу ресурсов, которую необходимо удалить.
1. Выберите **Удалить группу ресурсов**. Подтвердите удаление, введя имя группы ресурсов и выбрав **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об интеграции с реестрами блокчейна.

> [!div class="nextstepaction"]
> [Использование блокчейн-соединителя Ethereum с Azure Logic Apps](ethereum-logic-app.md)
