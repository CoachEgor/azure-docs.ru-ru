---
title: Развертывание шаблона решений консорциума Ethereum Proof-of-Authority на Azure
description: Используйте решение консорциума Ethereum Proof-of-Authority для развертывания и настройки сети ethereum с несколькими членами на Azure
ms.date: 12/18/2019
ms.topic: article
ms.reviewer: coborn
ms.openlocfilehash: 7e9af5c501b58f6828360ee280440ea85698bf16
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2020
ms.locfileid: "75387679"
---
# <a name="deploy-ethereum-proof-of-authority-consortium-solution-template-on-azure"></a>Развертывание шаблона решений для проверки ethereum в консорциуме на Azure

Для развертывания, настройки и управления сетью proof-of-authority Ethereum [Proof-of-Authority Consortium можно просмотреть шаблон решений Azure,](https://azuremarketplace.microsoft.com/marketplace/apps/microsoft-azure-blockchain.azure-blockchain-ethereum) чтобы развернуть, настроить и управлять сетью для проверки авторитета Ethereum с минимальными знаниями Azure и Ethereum.

Шаблон решения может быть использован каждым членом консорциума для обеспечения блокчейн-сети с помощью сервисов Microsoft Azure по вычислениям, сетям и хранилищам. Сетевой след каждого члена консорциума состоит из набора узлов, сбалансированных с нагрузкой, с которыми приложение или пользователь могут взаимодействовать для отправки транзакций Ethereum.

## <a name="choose-an-azure-blockchain-solution"></a>Выберите решение Azure Blockchain

Прежде чем использовать шаблон решения для проверки авторитета консорциума Ethereum, сравните сценарий с общими случаями использования доступных вариантов Azure Blockchain.

Параметр | Модель обслуживания | Общее использование случае
-------|---------------|-----------------
Шаблоны решений | IaaS | Шаблоны решений - это шаблоны Azure Resource Manager, которые можно использовать для обеспечения полностью настроенной топологии блокчейн-сетей. Шаблоны развертывают и настраивают службы вычислений, сетей и систем хранения данных Microsoft Azure для данного типа блокчейн-сетей.
[Служба Блокчейн Azure](../service/overview.md) | PaaS | Azure Blockchain Service Preview упрощает формирование, управление и управление сетей блокчейн консорциума. Используйте Azure Blockchain Service для решений, требующих PaaS, управления консорциумом или конфиденциальности контрактов и транзакций.
[Azure Blockchain Workbench](../workbench/overview.md) | IaaS и PaaS | Azure Blockchain Workbench (предварительная версия) — это совокупность служб и возможностей Azure, которые позволяют создавать и развертывать приложения блокчейн для совместного использования бизнес-процессов и данных с другими организациями. Используйте Azure Blockchain Workbench для прототипирования решения для блокчейна или доказательства концепции приложения блокчейн.

## <a name="solution-architecture"></a>Архитектура решения

Используя шаблон решения Ethereum, можно развернуть одну или многорегионатную сеть консорциумов ethereum, на основе нескольких членов.

![Архитектура развертывания](./media/ethereum-poa-deployment/deployment-architecture.png)

Каждое развертывание участника консорциума содержит:

* виртуальные машины для запуска проверяющих элементов управления PoA;
* Балансизатор загрузки Azure для распространения запросов RPC, пиринга и управления DApp
* Azure Key Vault для защиты удостоверений проверяющего элемента управления;
* служба хранилища Azure для размещения сведений о сети и координации аренды;
* Azure Monitor для объединения статистики производительности и журналов;
* шлюз виртуальной сети (необязательно) для разрешения VPN-подключений в виртуальных частных сетях.

По умолчанию доступ к конечным точкам RPC и пиринга можно получить через общедоступный IP-адрес, что позволяет упростить подключение между подписками и облаками. Для контроля уровня приложения можно использовать [контракты на разрешение Parity.](https://wiki.parity.io/Permissioning) Поддерживаются сети, развернутые за VPN, которые используют шлюзы VNet для кросс-подписки. Поскольку развертывание VPN и VNet является более сложным, при прототипе решения можно начать с общедоступной модели IP.

Докерконтейнеры используются для надежности и модульности. Реестр контейнеров Azure используется для размещения и обслуживания изображений версий в рамках каждого развертывания. Образы контейнеров состоят из следующих компонентов:

* Orchestrator - Генерирует удостоверения и контракты на управление. Хранит идентификаторы в хранилище идентификационных данных.
* Клиент Parity - Займает удостоверение личности из магазина идентификации. Обнаруживает и подключается к коллегам.
* Агент EthStats - собирает локальные журналы и статистику через RPC и передвигает информацию в Azure Monitor.
* Управление DApp - веб-интерфейс для взаимодействия с контрактами управления.

### <a name="validator-nodes"></a>Узлы валидатора

В протоколе PoA узлы проверяющего элемента управления заменяют традиционные узлы майнинга. Каждый валидатор имеет уникальную идентификатор Ethereum, позволяющую ему участвовать в процессе создания блока. Каждый участник консорциума может подготовить несколько узлов проверяющего элемента управления в пяти регионах, что позволит обеспечить геоизбыточность. Узлы проверяющего элемента управления взаимодействуют с другими узлами проверяющего элемента управления, чтобы координировать состояние базового распределенного реестра. Для обеспечения справедливого участия в сети каждому члену консорциума запрещается использовать больше валидаторов, чем первый участник сети. Например, если первый участник развертывает три валидатора, у каждого участника может быть до трех валидаторов.

### <a name="identity-store"></a>Хранилище удостоверений

Хранилище идентификационных данных развертывается в подписке каждого участника, которая надежно удерживает генерируемые идентификаторы Ethereum. Для каждого валидатора контейнер для оркестровки генерирует частный ключ Ethereum и хранит его в Хранилище ключей Azure.

## <a name="deploy-ethereum-consortium-network"></a>Развертывание сети консорциумов Ethereum

В этой прогулке, давайте предположим, что вы создаете многостороннюю сеть консорциума Ethereum. Следующий поток является примером многостороннего развертывания:

1. Три участника создают учетные записи Ethereum с помощью MetaMask.
1. *Член A* развертывает Ethereum PoA, предоставляя их публичный адрес Ethereum
1. *Участник А* предоставляет URL-адрес консорциума *участнику Б* и *участнику В*.
1. *Участник Б* и *участник В* развертывают сеть Ethereum PoA, предоставляя свои общедоступные адреса Ethereum и URL-адрес консорциума *участнику А*.
1. *Участник А* голосует, чтобы *участник Б* получил роль администратора.
1. *Участник А* и *участник Б* голосуют за присвоение роли администратора *участнику В*.

Следующие разделы показывают, как настроить след первого участника в сети.

### <a name="create-resource"></a>Создайте ресурс

На [портале Azure](https://portal.azure.com)выберите **Создайте ресурс** в верхнем левом углу.

Выберите **Blockchain** > **Ethereum Proof-of-Authority Consortium (предварительный просмотр).**

### <a name="basics"></a>Основы

В соответствии с **Basics**укажите значения стандартных параметров для любого развертывания.

![Основы](./media/ethereum-poa-deployment/basic-blade.png)

Параметр | Описание | Пример значения
----------|-------------|--------------
Создание новой сети или присоединение к существующей сети | Можно создать новую сеть консорциумов или присоединиться к уже существующей сети консорциумов. Присоединение к существующей сети требует дополнительных параметров. | Создание
Электронная почта | Вы получаете уведомление по электронной почте, когда развертывание завершается с информацией о развертывании. | Действительный адрес электронной почты
Имя пользователя виртуальной машины | Имя администратора для каждой развернутой виртуальной машины | 1-64 буквенно-цифровых символов
Authentication type (Тип проверки подлинности) | Метод аутентификации на виртуальной машине. | Пароль
Пароль | Пароль учетной записи администратора для каждой развернутой виртуальной машины. Все VMs изначально имеют один и тот же пароль. Вы можете изменить пароль после подготовки. | 12–72 символов 
Подписка | Подписка, для которой необходимо развернуть сеть консорциума |
Группа ресурсов| Группа ресурсов, куда будет развертываться сеть консорциума. | myResourceGroup
Расположение | Регион Azure для группы ресурсов. | западная часть США 2

Нажмите кнопку **ОК**.

### <a name="deployment-regions"></a>Регионы развертывания

В *регионах развертывания*укажите количество регионов и местоположений для каждого из них. Развертывание можно максимум в пяти регионах. Первый регион должен соответствовать местоположению группы ресурсов из *раздела Basics.* Для сетей разработки или тестирования можно использовать единый регион на одного участника. Для производства развертывайте в двух или более регионах с высокой доступностью.

![регионы развертывания](./media/ethereum-poa-deployment/deployment-regions.png)

Параметр | Описание | Пример значения
----------|-------------|--------------
Количество регионов|Количество регионов для развертывания сети консорциума| 2
Первый регион | Первый регион для развертывания сети консорциума | западная часть США 2
Второй регион | Второй регион для развертывания сети консорциума. Дополнительные регионы видны, когда количество регионов составляет два или больше. | восточная часть США 2

Нажмите кнопку **ОК**.

### <a name="network-size-and-performance"></a>Размер и производительность сети

При *размере сети и производительности*укажите входы для размера сети консорциума. Размер хранилища валидатора диктует потенциальный размер блокчейна. Размер может быть изменен после развертывания.

![Размер и производительность сети](./media/ethereum-poa-deployment/network-size-and-performance.png)

Параметр | Описание | Пример значения
----------|-------------|--------------
Number of load balanced validator nodes (Количество узлов проверяющих элементов управления с балансировкой нагрузки) | Количество узлов валидатора для обеспечения как части сети. | 2
Validator node storage performance (Производительность хранилища узлов проверяющих элементов управления) | Тип управляемого диска для каждого из развернутых узлов валидатора. Для получения подробной информации о ценах, [см.](https://azure.microsoft.com/pricing/details/managed-disks/) | SSD (цен. категория "Стандартный")
Validator node virtual machine size (Размер виртуальной машины узла проверяющего элемента управления) | Размер виртуальной машины, используемой для узлов проверяющих элементов управления. Для получения подробной информации о ценах, см [виртуальные цены машины](https://azure.microsoft.com/pricing/details/virtual-machines/windows/) | Стандартный D2 v3

Виртуальный уровень памяти и хранения данных влияют на производительность сети.  Используйте следующую таблицу, чтобы помочь выбрать эффективность затрат:

Номер SKU виртуальной машины|Уровень хранилища|Price|Пропускная способность|Задержка
---|---|---|---|---
F1|SSD (цен. категория "Стандартный")|low|low|high
D2_v3|SSD (цен. категория "Стандартный")|средняя|средняя|средняя
F16s|SSD (цен. категория "Премиум")|high|high|low

Нажмите кнопку **ОК**.

### <a name="ethereum-settings"></a>Параметры Ethereum

В *настройках конфигурации Ethereum*указано настройки конфигурации, связанные с Ethereum.

![Параметры Ethereum](./media/ethereum-poa-deployment/ethereum-settings.png)

Параметр | Описание | Пример значения
----------|-------------|--------------
Consortium Member ID (Идентификатор участника консорциума) | Идентификатор, связанный с каждым участником сети консорциума. Он используется для настройки пробелов IP-адресов, чтобы избежать столкновения. Для частной сети идентификатор участника должен быть уникальным в разных организациях одной сети.  Уникальный идентификатор участника необходим даже в том случае, когда та же организация развертывает участников в нескольких регионах. Обратите внимание на значение этого параметра, так как вам нужно поделиться им с другими членами соединения, чтобы убедиться, что нет столкновения. Допустимый диапазон от 0 до 255. | 0
Идентификатор сети | Идентификатор сети для сети Ethereum развертываемого консорциума. Каждая сеть Ethereum имеет свой собственный идентификатор сети, причем 1 соответствует идентификатору общедоступной сети. Действительный диапазон от 5 до 999 999 999 999 | 10101010
Admin Ethereum Address (Адрес администратора Ethereum) | Адрес учетной записи Ethereum, используемый для участия в управлении PoA. Для создания адреса Ethereum можно использовать MetaMask. |
Дополнительные параметры | Расширенные параметры Ethereum | Включить
Развертывание с помощью публичного IP-адреса | При выборе Private VNet сеть развертывается за шлюзом VNet и удаляет доступ к внимательным. Для private VNet все участники должны использовать vNet Gateway для совместимости соединения. | Общедоступный IP-адрес
Блок газа предел | Лимит газа стартового блока сети. | 50000000
Период возобновления блока (с) | Частота, при которой будут созданы пустые блоки, когда в сети нет транзакций. Более высокая частота будет способствовать более высокой скорости завершения с увеличенной стоимостью на хранение. | 15
Контракт на разрешение сделки | Байт-код контракта разрешения транзакций. Ограничивает развертывание и выполнение смарт-контрактов разрешенным списком учетных записей Ethereum. |

Нажмите кнопку **ОК**.

### <a name="monitoring"></a>Наблюдение

Мониторинг позволяет настроить ресурс журнала для вашей сети. Агент мониторинга собирает и всплывает полезные метрики и журналы из вашей сети, что дает возможность быстро проверить работоспособность сети или отладить проблемы.

![Azure Monitor](./media/ethereum-poa-deployment/azure-monitor.png)

Параметр | Описание | Пример значения
----------|-------------|--------------
Наблюдение | Вариант для обеспечения мониторинга | Включить
Подключение к существующим журналам Azure Monitor | Возможность создания нового экземпляра журналов Azure Monitor или присоединения к существующему экземпляру | Создание
Расположение | Регион, в котором развернут новый экземпляр | Восточная часть США
Существующий идентификатор рабочего пространства аналитики журнала (Подключение к существующим журналам Azure Monitor - Присоединиться к существующему)|Идентификатор рабочего пространства существующего экземпляра журналов Azure Monitor||Н/Д
Существующий основной ключ аналитики журналов (Подключение к существующим журналам Azure Monitor - Присоединиться к существующему)|Основной ключ, используемый для подключения к существующему экземпляру журналов Azure Monitor||Н/Д

Нажмите кнопку **ОК**.

### <a name="summary"></a>Сводка

Нажмите на резюме, чтобы просмотреть указанные входные данные и запустить базовую проверку перед развертыванием. Перед развертыванием можно загрузить шаблон и параметры.

Выберите **Создать** для развертывания.

Если развертывание включает шлюзы VNet, развертывание может занять от 45 до 50 минут.

## <a name="deployment-output"></a>Выходные данные развертывания

После завершения развертывания можно получить доступ к необходимым параметрам с помощью портала Azure.

### <a name="confirmation-email"></a>Подтверждающее сообщение электронной почты

Если вы предоставляете адрес электронной[почты (Основной раздел),](#basics)отправляется электронное письмо, включавввв в себя информацию о развертывании и ссылки на эту документацию.

![Письмо с данными о развертывании](./media/ethereum-poa-deployment/deployment-email.png)

### <a name="portal"></a>Портал

После успешного завершения развертывания и подготовки всех ресурсов можно просмотреть параметры вывода в группе ресурсов.

1. Перейдите к группе ресурсов на портале.
1. Выберите **Обзор > развертыванием.**

    ![Общие сведения о группе ресурсов](./media/ethereum-poa-deployment/resource-group-overview.png)

1. Выберите **развертывание Microsoft-azure-blockchain.azure-blockchain-blockchain-ether-....**
1. Выберите раздел **Выводы.**

    ![Выходы развертывания](./media/ethereum-poa-deployment/deployment-outputs.png)

## <a name="growing-the-consortium"></a>Расширение консорциума

Чтобы расширить свой консорциум, сначала необходимо подключиться к физической сети. При развертывании за VPN просрвинитесь в разделе [Подключение VNet Gateway](#connecting-vnet-gateways) к настройке сетевого соединения как части развертывания нового члена. Как только развертывание завершится, используйте [DApp Управления,](#governance-dapp) чтобы стать сетевым админом.

### <a name="new-member-deployment"></a>Развертывание нового участника

Предоставьте подключаемому участнику приведенные ниже сведения. Информация содержится в электронной почте после развертывания или в выводе развертывания портала.

* URL-адрес данных консорциума
* Количество развернутых узлов
* идентификатор ресурса шлюза виртуальной сети (если используется сеть VPN).

При развертывании участник должен использовать тот же шаблон решения консорциума Ethereum Proof-of-Authority при развертывании своего сетевого присутствия с помощью следующих указаний:

* выбрать параметр **Join Existing** (Присоединить имеющийся);
* Выберите такое же количество узлов валидатора, как и остальные участники сети, чтобы обеспечить справедливое представительство
* Используйте тот же адрес Admin Ethereum
* Используйте предоставленный *Консорциум данных Url* в *настройках Ethereum*
* Если остальная часть сети стоит за VPN, выберите **Private VNet** под расширенным разделом

### <a name="connecting-vnet-gateways"></a>Подключение шлюзов виртуальной сети

Этот раздел требуется только при развертывании с помощью частного VNet. Вы можете пропустить этот раздел, если вы используете общедоступные IP-адреса.

Для частной сети различные участники подключаются через соединения шлюза VNet. Прежде чем участник может присоединиться к сети и увидеть трафик транзакций, существующий участник должен сделать окончательную конфигурацию на своем VPN шлюзе, чтобы принять соединение. Узлы Ethereum присоединяющихся членов не будут работать до тех пор, пока соединение не будет установлено. Чтобы уменьшить вероятность возникновения одной точки сбоя, создайте избыточные сетевые соединения в консорциуме.

После развертывания сети новым участником имеющийся участник должен настроить двустороннее подключение, установив подключение к новому участнику через шлюз виртуальной сети. Существующий участник нуждается в:

* VNet шлюз ResourceID подключения члена. Просмотрите [выход развертывания.](#deployment-output)
* Общий ключ соединения.

Чтобы завершить подключение, имеющийся участник должен выполнить приведенный ниже сценарий PowerShell. Вы можете использовать Azure Cloud Shell, расположенную в верхнем правом баре навигации на портале.

![Cloud Shell](./media/ethereum-poa-deployment/cloud-shell.png)

```Powershell
$MyGatewayResourceId = "<EXISTING_MEMBER_RESOURCEID>"
$OtherGatewayResourceId = "<NEW_MEMBER_RESOURCEID]"
$ConnectionName = "Leader2Member"
$SharedKey = "<NEW_MEMBER_KEY>"

## $myGatewayResourceId tells me what subscription I am in, what ResourceGroup and the VNetGatewayName
$splitValue = $MyGatewayResourceId.Split('/')
$MySubscriptionid = $splitValue[2]
$MyResourceGroup = $splitValue[4]
$MyGatewayName = $splitValue[8]

## $otherGatewayResourceid tells me what the subscription and VNet GatewayName are
$OtherGatewayName = $OtherGatewayResourceId.Split('/')[8]
$Subscription=Select-AzSubscription -SubscriptionId $MySubscriptionid

## create a PSVirtualNetworkGateway instance for the gateway I want to connect to
$OtherGateway=New-Object Microsoft.Azure.Commands.Network.Models.PSVirtualNetworkGateway
$OtherGateway.Name = $OtherGatewayName
$OtherGateway.Id = $OtherGatewayResourceId
$OtherGateway.GatewayType = "Vpn"
$OtherGateway.VpnType = "RouteBased"

## get a PSVirtualNetworkGateway instance for my gateway
$MyGateway = Get-AzVirtualNetworkGateway -Name $MyGatewayName -ResourceGroupName $MyResourceGroup

## create the connection
New-AzVirtualNetworkGatewayConnection -Name $ConnectionName -ResourceGroupName $MyResourceGroup -VirtualNetworkGateway1 $MyGateway -VirtualNetworkGateway2 $OtherGateway -Location $MyGateway.Location -ConnectionType Vnet2Vnet -SharedKey $SharedKey -EnableBgp $True
```

## <a name="service-monitoring"></a>Мониторинг службы

Вы можете найти свой портал Azure Monitor либо, перейдя по ссылке в электронной почте развертывания, либо найдя параметр в выходе развертывания .OMS_PORTAL_URL.

На портале в первую очередь отображается общая статистика по сети и сведения об узле.

![Категории мониторов](./media/ethereum-poa-deployment/monitor-categories.png)

Выбор **обзора узлов** показывает статистику инфраструктуры для узла.

![Статистика узлов](./media/ethereum-poa-deployment/node-stats.png)

Выбор **сетевой статистики** показывает статистику сети Ethereum.

![Статистика сети](./media/ethereum-poa-deployment/network-stats.png)

### <a name="sample-kusto-queries"></a>Примеры запросов Кусто

Вы можете задать запрос журналов мониторинга для расследования сбоев или оповещений о пороге настройки. Следующие запросы являются примерами, которые можно запустить в инструменте *поиска журнала:*

Блоки списка, о которых сообщает несколько запросов валидатора, могут быть полезны для поиска цепных вилок.

```sql
MinedBlock_CL
| summarize DistinctMiners = dcount(BlockMiner_s) by BlockNumber_d, BlockMiner_s
| where DistinctMiners > 1
```

Получите средний подсчет сверстников для указанного узла валидатора, усредненное за 5-минутные ведра.

```sql
let PeerCountRegex = @"Syncing with peers: (\d+) active, (\d+) confirmed, (\d+)";
ParityLog_CL
| where Computer == "vl-devn3lgdm-reg1000001"
| project RawData, TimeGenerated
| where RawData matches regex PeerCountRegex
| extend ActivePeers = extract(PeerCountRegex, 1, RawData, typeof(int))
| summarize avg(ActivePeers) by bin(TimeGenerated, 5m)
```

## <a name="ssh-access"></a>Доступ по протоколу SSH

По умолчанию доступ к портам SSH запрещен правилом безопасности сетевой группы. Это сделано по соображениям безопасности. Чтобы получить доступ к экземплярам виртуальной машины в сети PoA, необходимо изменить следующую безопасность, чтобы *разрешить.*

1. Перейдите в раздел **«Обзор»** развернутой группы ресурсов на портале Azure.

    ![Обзор SSH](./media/ethereum-poa-deployment/ssh-overview.png)

1. Выберите **группу сетевой безопасности** для региона VM, к который вы хотите получить доступ.

    ![Группа безопасности сети SSH](./media/ethereum-poa-deployment/ssh-nsg.png)

1. Выберите правило **«разрешить-шш».**

    ![Правило ssh-allow](./media/ethereum-poa-deployment/ssh-allow.png)

1. Изменение **действий,** чтобы **позволить**

    ![Значение "Разрешить", активирующее протокол SSH](./media/ethereum-poa-deployment/ssh-enable-allow.png)

1. Нажмите кнопку **Сохранить**. Изменение может занять несколько минут.

Вы можете удаленно подключиться к виртуальным машинам для узлов валидатора через SSH с предоставленным вашим адресом пользователя и паролем/SSH ключом. Команда SSH для доступа к первому узлам валидатора указана в выходе развертывания шаблона. Пример:

``` bash
ssh -p 4000 poaadmin\@leader4vb.eastus.cloudapp.azure.com.
```

Чтобы попасть в дополнительные узлы транзакции, прибавите номер порта на один.

Если вы развернуты в нескольких регионах, измените команду на имя DNS или IP-адрес балансиста нагрузки в этом регионе. Чтобы найти имя DNS или IP-адрес других регионов, ** \* \* \* \* \*\# ** найдите ресурс с конвенцией именования -lbpip-reg и просмотрите его имя DNS и свойства IP-адресов.

## <a name="azure-traffic-manager-load-balancing"></a>Балансировка нагрузки диспетчера трафика Azure

Диспетчер трафика Azure позволяет сократить время простоя и улучшить скорость реакции сети PoA путем направления входящего трафика по множеству развертываний в разных регионах. Встроенные проверки работоспособности и автоматическое перенастроивание помогают обеспечить высокую доступность конечных точек RPC и DApp Управления. Это полезно в том случае, если вы развернули сеть в нескольких регионах и планируете использовать ее в рабочей среде.

Используйте диспетчер трафика для улучшения доступности сети PoA с автоматическим сбой. Вы также можете использовать диспетчер трафика для повышения оперативности действий сетей путем перехивания конечных пользователей в расположение Azure с наименьшей задержкой сети.

Если вы решите создать профиль диспетчера трафика, с помощью его DNS-имени можно получить доступ к сети. После добавления к сети других участников консорциума с помощью диспетчера трафика можно также балансировать нагрузку по их развернутым проверяющим элементам управления.

### <a name="creating-a-traffic-manager-profile"></a>Создание профиля диспетчера трафика

1. На [портале Azure](https://portal.azure.com)выберите **Создайте ресурс** в верхнем левом углу.
1. Поиск **профиля менеджера трафика**.

    ![Поиск менеджера трафика Azure](./media/ethereum-poa-deployment/traffic-manager-search.png)

    Дайте профилю уникальное имя и выберите группу ресурсов, которая использовалась для развертывания PoA.

1. Выберите **Создать** для развертывания.

    ![Создание диспетчера трафика](./media/ethereum-poa-deployment/traffic-manager-create.png)

1. После развертывания выберите экземпляр в группе ресурсов. Имя DNS для доступа к диспетчеру трафика можно найти во вкладке «Обзор».

    ![Поиск DNS диспетчера трафика](./media/ethereum-poa-deployment/traffic-manager-dns.png)

1. Выберите вкладку **Endpoints** и выберите кнопку **Добавить.**
1. Присвойте конечной точке уникальное имя.
1. Для **типа целевого ресурса**выберите **общедоступный IP-адрес.**
1. Выберите общедоступный IP-адрес балансируктора нагрузки первого региона.

    ![Маршрутизации диспетчера трафика](./media/ethereum-poa-deployment/traffic-manager-routing.png)

Повторите эти шаги для каждого региона в развернутой сети. После того, как конечные точки находятся в состоянии **включена,** они автоматически загружаются и уравновешиваются по имени Менеджера трафика DNS. Теперь вы можете использовать это имя DNS вместо параметра «CONSORTIUM_DATA_URL» в других шагах статьи.

## <a name="data-api"></a>API данных

Каждый участник консорциума размещает информацию, на основе которой выполняется подключение к сети. Чтобы обеспечить простоту подключения, каждый участник размещает набор информации о подключении в конечной точке API данных.

Существующий участник предоставляет «CONSORTIUM_DATA_URL» до развертывания участника. После развертывания присоединяемый участник получит сведения из интерфейса JSON на следующей конечной точке:

`<CONSORTIUM_DATA_URL>/networkinfo`

Ответ содержит информацию, полезную для присоединения к членам (блок Genesis, контракт Validator Set ABI, бутноды) и информацию, полезную для существующего участника (адреса валидаторов). Эту стандартизацию можно использовать для расширения консорциума между поставщиками облачных услуг. Этот API возвращает отформатированный JSON ответ со следующей структурой:

```json
{
  "$id": "",
  "type": "object",
  "definitions": {},
  "$schema": "https://json-schema.org/draft-07/schema#",
  "properties": {
    "majorVersion": {
      "$id": "/properties/majorVersion",
      "type": "integer",
      "title": "This schema’s major version",
      "default": 0,
      "examples": [
        0
      ]
    },
    "minorVersion": {
      "$id": "/properties/minorVersion",
      "type": "integer",
      "title": "This schema’s minor version",
      "default": 0,
      "examples": [
        0
      ]
    },
    "bootnodes": {
      "$id": "/properties/bootnodes",
      "type": "array",
      "items": {
        "$id": "/properties/bootnodes/items",
        "type": "string",
        "title": "This member’s bootnodes",
        "default": "",
        "examples": [
          "enode://a348586f0fb0516c19de75bf54ca930a08f1594b7202020810b72c5f8d90635189d72d8b96f306f08761d576836a6bfce112cfb6ae6a3330588260f79a3d0ecb@10.1.17.5:30300",
          "enode://2d8474289af0bb38e3600a7a481734b2ab19d4eaf719f698fe885fb239f5d33faf217a860b170e2763b67c2f18d91c41272de37ac67386f80d1de57a3d58ddf2@10.1.17.4:30300"
        ]
      }
    },
    "valSetContract": {
      "$id": "/properties/valSetContract",
      "type": "string",
      "title": "The ValidatorSet Contract Source",
      "default": "",
      "examples": [
        "pragma solidity 0.4.21;\n\nimport \"./SafeMath.sol\";\nimport \"./Utils.sol\";\n\ncontract ValidatorSet …"
      ]
    },
    "adminContract": {
      "$id": "/properties/adminContract",
      "type": "string",
      "title": "The AdminSet Contract Source",
      "default": "",
      "examples": [
        "pragma solidity 0.4.21;\nimport \"./SafeMath.sol\";\nimport \"./SimpleValidatorSet.sol\";\nimport \"./Admin.sol\";\n\ncontract AdminValidatorSet is SimpleValidatorSet { …"
      ]
    },
    "adminContractABI": {
      "$id": "/properties/adminContractABI",
      "type": "string",
      "title": "The Admin Contract ABI",
      "default": "",
      "examples": [
        "[{\"constant\":false,\"inputs\":[{\"name\":\"proposedAdminAddress\",\"type\":\"address\"},…"
      ]
    },
    "paritySpec": {
      "$id": "/properties/paritySpec",
      "type": "string",
      "title": "The Parity client spec file",
      "default": "",
      "examples": [
        "\n{\n \"name\": \"PoA\",\n \"engine\": {\n \"authorityRound\": {\n \"params\": {\n \"stepDuration\": \"2\",\n \"validators\" : {\n \"safeContract\": \"0x0000000000000000000000000000000000000006\"\n },\n \"gasLimitBoundDivisor\": \"0x400\",\n \"maximumExtraDataSize\": \"0x2A\",\n \"minGasLimit\": \"0x2FAF080\",\n \"networkID\" : \"0x9a2112\"\n }\n }\n },\n \"params\": {\n \"gasLimitBoundDivisor\": \"0x400\",\n \"maximumExtraDataSize\": \"0x2A\",\n \"minGasLimit\": \"0x2FAF080\",\n \"networkID\" : \"0x9a2112\",\n \"wasmActivationTransition\": \"0x0\"\n },\n \"genesis\": {\n \"seal\": {\n \"authorityRound\": {\n \"step\": \"0x0\",\n \"signature\": \"0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\"\n }\n },\n \"difficulty\": \"0x20000\",\n \"gasLimit\": \"0x2FAF080\"\n },\n \"accounts\": {\n \"0x0000000000000000000000000000000000000001\": { \"balance\": \"1\", \"builtin\": { \"name\": \"ecrecover\", \"pricing\": { \"linear\": { \"base\": 3000, \"word\": 0 } } } },\n \"0x0000000000000000000000000000000000000002\": { \"balance\": \"1\", \"builtin\": { \"name\": \"sha256\", \"pricing\": { \"linear\": { \"base\": 60, \"word\": 12 } } } },\n \"0x0000000000000000000000000000000000000003\": { \"balance\": \"1\", \"builtin\": { \"name\": \"ripemd160\", \"pricing\": { \"linear\": { \"base\": 600, \"word\": 120 } } } },\n \"0x0000000000000000000000000000000000000004\": { \"balance\": \"1\", \"builtin\": { \"name\": \"identity\", \"pricing\": { \"linear\": { \"base\": 15, \"word\": 3 } } } },\n \"0x0000000000000000000000000000000000000006\": { \"balance\": \"0\", \"constructor\" : \"…\" }\n }\n}"
      ]
    },
    "errorMessage": {
      "$id": "/properties/errorMessage",
      "type": "string",
      "title": "Error message",
      "default": "",
      "examples": [
        ""
      ]
    },
    "addressList": {
      "$id": "/properties/addressList",
      "type": "object",
      "properties": {
        "addresses": {
          "$id": "/properties/addressList/properties/addresses",
          "type": "array",
          "items": {
            "$id": "/properties/addressList/properties/addresses/items",
            "type": "string",
            "title": "This member’s validator addresses",
            "default": "",
            "examples": [
              "0x00a3cff0dccc0ecb6ae0461045e0e467cff4805f",
              "0x009ce13a7b2532cbd89b2d28cecd75f7cc8c0727"
            ]
          }
        }
      }
    }
  }
}

```

## <a name="governance-dapp"></a>Децентрализованное приложение системы управления

Основополагающую роль в механизме PoA играет децентрализованная система управления. Поскольку доказательство власти опирается на разрешенный список сетевых органов, чтобы сохранить сеть здоровой, важно обеспечить справедливый механизм для внесения изменений в этот список разрешений. Каждое развертывание поставляется с набором смарт-контрактов и портал для управления цепочкой этого разрешенного списка. Когда за предложенное изменение проголосует большинство участников консорциума, изменение задействуется. Голосование позволяет добавлять или скомпрометировать участников, которые будут удалены транспарентным образом, что поощряет честную сеть.

Управление DApp представляет собой набор предварительно развернутых [смарт-контрактов](https://github.com/Azure-Samples/blockchain/tree/master/ledger/template/ethereum-on-azure/permissioning-contracts) и веб-приложений, которые используются для управления органами власти в сети. Власти разбиты на удостоверения админа и узлы валидатора.
Админы имеют право делегировать консенсусное участие в набор узлах валидатора. Администраторы также могут голосовать за других администраторов в сети или вне ее.

![Децентрализованное приложение системы управления](./media/ethereum-poa-deployment/governance-dapp.png)

* **Децентрализованное управление:** Изменения в сетевых органах власти осуществляются путем голосования по цепочке избранными администраторами.
* **Делегация валидатора:** Власти могут управлять своими узлами валидатора, настроенных при каждом развертывании PoA.
* **Проверяемая история изменений:** Каждое изменение записывается на блокчейне, обеспечивая прозрачность и аудит.

### <a name="getting-started-with-governance"></a>Начало работы с системой управления

Для выполнения любых транзакций через DApp управления необходимо использовать кошелек Ethereum. Самый простой подход заключается в использовании в браузере бумажника, таких как [MetaMask;](https://metamask.io) однако, поскольку эти смарт-контракты развернуты в сети, вы также можете автоматизировать взаимодействие с контрактом управления.

После установки MetaMask перейдите в децентрализованное приложение системы управления в браузере.  URL можно найти через портал Azure в выводе развертывания.  Если у вас нет установленного кошелька в браузере, вы не сможете выполнять какие-либо действия; однако можно просмотреть состояние администратора.  

### <a name="becoming-an-admin"></a>Как стать администратором

Если вы первый участник, развернутый в сети, то вы автоматически становитесь админом, а узлы паритета указаны как валидаторы. Если вы присоединяетесь к сети, вам нужно, чтобы за вас проголосовали в качестве админа большинством (больше, чем 50%) существующего набора админ. Если вы решите не становиться аминтом, ваши узлы все равно синхронизируют сяит и проверяют блокчейн; однако они не участвуют в процессе создания блоков. Чтобы начать процесс голосования, чтобы стать админ, выберите **номинацию** и введите свой адрес Ethereum и псевдоним.

![Назначение](./media/ethereum-poa-deployment/governance-dapp-nominate.png)

### <a name="candidates"></a>Кандидаты

Выбор вкладки **"Кандидаты"** показывает текущий набор администраторов-кандидатов.  Как только кандидат получает большинство голосов нынешних админов, кандидат получает повышение до админа.  Чтобы проголосовать за кандидата, выберите строку и выберите **Проголосовать в**. Если вы передумаете голосовать, выберите кандидата и выберите **голосование за отмену.**

![Кандидаты](./media/ethereum-poa-deployment/governance-dapp-candidates.png)

### <a name="admins"></a>Администраторы

Вкладка **Admins** показывает текущий набор админинов и предоставляет вам возможность голосовать против.  Как только админ теряет более 50% поддержки, он удаляется в качестве админа в сети. Любые узлы валидатора, которыми владеет админ, теряют статус валидатора и становятся узлами транзакций в сети. Админ может быть удален по ряду причин; однако консорциум должен заранее согласовать политику.

![Администраторы](./media/ethereum-poa-deployment/governance-dapp-admins.png)

### <a name="validators"></a>Проверяющие элементы управления

При выборе вкладки **Валидаторы** отображаются текущие развернутые узлы паритета для экземпляра и их текущее состояние (тип узла). Каждый член консорциума имеет в этом списке свой набор валидаторов, поскольку это представление представляет текущего развернутого члена консорциума. Если экземпляр недавно развернут и вы не добавили валидаторы, вы получите возможность **добавить валидаторы.** Добавление валидаторов автоматически выбирает регионально сбалансированный набор узлов паритета и присваивает их набору валидаторов. Если у вас развернуто больше узлов, чем разрешенная емкость, оставшиеся узлы становятся узлами транзакций в сети.

Адрес каждого проверяющего элемента управления автоматически назначается с использованием [хранилища идентификаторов](#identity-store) в Azure.  Если узла происходит действие, он отказывается от своей идентичности, позволяя другому узлам в развертывании занять его место. Этот процесс гарантирует, что ваше участие в консенсусе является весьма доступным.

![Проверяющие элементы управления](./media/ethereum-poa-deployment/governance-dapp-validators.png)

### <a name="consortium-name"></a>Имя консорциума

Любой админ может обновить название консорциума.  Выберите значок передачи в левом верхнем верхнем месте, чтобы обновить название консорциума.

### <a name="account-menu"></a>Меню учетной записи

Справа справа находится ваш псевдоним и идентификатор учетной записи Ethereum.  Если вы являетесь админ, у вас есть возможность обновить свой псевдоним.

![Учетная запись](./media/ethereum-poa-deployment/governance-dapp-account.png)

## <a name="ethereum-development"></a>Развитие Ethereum<a id="tutorials"></a>

Для компиляции, развертывания и тестирования смарт-контрактов можно рассмотреть несколько вариантов разработки Ethereum:
* [Трюфель Suite](https://www.trufflesuite.com/docs/truffle/overview) - Клиентская среда разработки Ethereum
* [Ethereum Remix](https://remix-ide.readthedocs.io/en/latest/index.html ) - среда разработки на основе браузера и локальной среды разработки Ethereum

### <a name="compile-deploy-and-execute-smart-contract"></a>Составить, развернуть и выполнить смарт-контракт

В следующем примере вы создаете простой смарт-контракт. Вы используете Трюфель для компиляции и развертывания смарт-контракта в вашей блокчейн-сети. После развертывания вы звоните функции смарт-контракта через транзакцию.

#### <a name="prerequisites"></a>Предварительные требования

* Установите [Python 2.7.15](https://www.python.org/downloads/release/python-2715/). Python необходим для трюфеля и Web3. Выберите опцию установки, чтобы включить Python на вашем пути.
* Установить Трюфель v5.0.5 `npm install -g truffle@v5.0.5`. Для работы с Truffle нужно установить несколько инструментов, включая [Node.js](https://nodejs.org) и [Git](https://git-scm.com/). Для получения дополнительной информации, см [Трюфель документации](https://github.com/trufflesuite/truffle).

### <a name="create-truffle-project"></a>Создание проекта Truffle

Прежде чем собрать и развернуть смарт-контракт, необходимо создать проект Трюфеля.

1. Откройте окно командной строки или оболочку.
1. Создайте папку с именем `HelloWorld`.
1. Изменение каталога в `HelloWorld` новую папку.
1. Инициализируем новый `truffle init`проект Трюфеля с помощью команды .

    ![Создание нового проекта Трюфель](./media/ethereum-poa-deployment/create-truffle-project.png)

### <a name="add-a-smart-contract"></a>Добавить смарт-контракт

Создайте свои смарт-контракты в **субдиректорах вашего** проекта Трюфель.

1. Создайте файл в `postBox.sol` названном в **субдиректоре контрактов** вашего проекта Трюфеля.
1. Добавьте следующий код Solidity к **postBox.sol**.

    ```javascript
    pragma solidity ^0.5.0;
    
    contract postBox {
        string message;
        function postMsg(string memory text) public {
            message = text;
        }
        function getMsg() public view returns (string memory) {
            return message;
        }
    }
    ```

### <a name="deploy-smart-contract-using-truffle"></a>Развертывание смарт-контракт с помощью Трюфеля

Трюфельные проекты содержат файл конфигурации для деталей подключения к сети блокчейн. Измените файл конфигурации, чтобы включить информацию о подключении к вашей сети.

> [!WARNING]
> Никогда не отправляйте свой закрытый ключ Ethereum по сети. Сначала убедитесь, что каждая транзакция имеет локальную подпись, а затем их можно отправлять по сети.

1. Вам нужна мнемоническая фраза для [учетной записи athereum admin, используемой при развертывании вашей блокчейн-сети.](#ethereum-settings) Если вы использовали MetaMask для создания учетной записи, вы можете получить мнемоник из MetaMask. Выберите значок учетной записи администратора в правом верхнем виде расширения MetaMask и выберите **Настройки > безопасности & конфиденциальности > Показать слова семян.**
1. Замените содержимое `truffle-config.js` вашего проекта Трюфель со следующим содержанием. Замените конечную точку заполнителя и мнемонические значения.

    ```javascript
    const HDWalletProvider = require("truffle-hdwallet-provider");
    const rpc_endpoint = "<Ethereum RPC endpoint>";
    const mnemonic = "Twelve words you can find in MetaMask > Security & Privacy > Reveal Seed Words";

    module.exports = {
      networks: {
        development: {
          host: "localhost",
          port: 8545,
          network_id: "*" // Match any network id
        },
        poa: {
          provider: new HDWalletProvider(mnemonic, rpc_endpoint),
          network_id: 10101010,
          gasPrice : 0
        }
      }
    };
    ```

1. Так как мы используем поставщика Truffle HD Кошелек, установите модуль в вашем проекте с помощью команды. `npm install truffle-hdwallet-provider --save`

Трюфель использует миграционные скрипты для развертывания смарт-контрактов в блокчейн-сети. Для развертывания нового смарт-контракта необходим скрипт миграции.

1. Добавьте новую миграцию для развертывания нового контракта. Создайте `2_deploy_contracts.js` файл в субдиректоре **миграций** проекта Трюфель.

    ``` javascript
    var postBox = artifacts.require("postBox");
    
    module.exports = deployer => {
        deployer.deploy(postBox);
    };
    ```

1. Развертывание в сети PoA с помощью команды Truffle мигрировать. В командной подсказке в каталоге проекта Трюфель, запустите:

    ```javascript
    truffle migrate --network poa
    ```

### <a name="call-a-smart-contract-function"></a>Вызов функции смарт-контракта

Теперь, когда ваш смарт-контракт развернут, вы можете отправить транзакцию для вызова функции.

1. В каталоге проекта Трюфель создайте новый файл под названием `sendtransaction.js`.
1. Добавьте следующее содержимое для **отправкиtransaction.js.**

    ``` javascript
    var postBox = artifacts.require("postBox");
    
    module.exports = function(done) {
      console.log("Getting the deployed version of the postBox smart contract")
      postBox.deployed().then(function(instance) {
        console.log("Calling postMsg function for contract ", instance.address);
        return instance.postMsg("Hello, blockchain!");
      }).then(function(result) {
        console.log("Transaction hash: ", result.tx);
        console.log("Request complete");
        done();
      }).catch(function(e) {
        console.log(e);
        done();
      });
    };
    ```

1. Выполните скрипт с помощью команды Трюфеля.

    ```javascript
    truffle exec sendtransaction.js --network poa
    ```

    ![Выполнение скрипта для вызова функции через транзакцию](./media/ethereum-poa-deployment/send-transaction.png)

## <a name="webassembly-wasm-support"></a>Поддержка WebAssembly (WASM)

Поддержка WebAssembly по умолчанию реализована в развернутой сети PoA. Это позволяет разрабатывать смарт-контракты на любом языке, который компилируется в код Web-Assembly (Rust, C, C++). Для получения дополнительной информации см.: [Обзор паритета WebAssembly](https://wiki.parity.io/WebAssembly-Home) и [учебник от Parity Tech](https://github.com/paritytech/pwasm-tutorial)

## <a name="faq"></a>часто задаваемые вопросы

### <a name="i-notice-there-are-many-transactions-on-the-network-that-i-didnt-send-where-are-these-coming-from"></a>Я замечаю Есть много транзакций в сети, что я не посылал. Откуда они поступают?

Разблокировать [личный API](https://web3js.readthedocs.io/en/v1.2.0/web3-eth-personal.html) небезопасно. Боты прослушивают разблокированные учетные записи Ethereum в попытке кражи денежных средств. Бот предполагает, что эти учетные записи содержат эфир, и пытается первым перевести эти средства. Не включайте личные API в сети. Вместо этого предварительно подписать транзакции либо вручную с помощью кошелька, как MetaMask или программно.

### <a name="how-to-ssh-onto-a-vm"></a>Как подключиться по протоколу SSH к виртуальной машине?

По соображениям безопасности порт SSH не отображается. Сведения о том, как включить SSH-порт, см. в [этом руководстве](#ssh-access).

### <a name="how-do-i-set-up-an-audit-member-or-transaction-nodes"></a>Как настроить аудит узлов транзакций и участников?

Узлы транзакций представляют собой набор клиентов паритета, которые всматриваются в сеть, но не участвуют в консенсусе. С помощью этих узлов можно по-прежнему отправлять транзакции Ethereum и считывать состояние смарт-контрактов. Этот механизм работает для обеспечения аудита для неавторитетных членов консорциума в сети. Для достижения этой цели, следуйте шагам в [выращивании консорциума](#growing-the-consortium).

### <a name="why-are-metamask-transactions-taking-a-long-time"></a>Почему транзакции MetaMask занимают много времени?

Чтобы обеспечить правильный порядок получения транзакций, каждая из них отправляется с увеличивающимся номером nonce. Если вы использовали учетную запись в MetaMask в другой сети, необходимо сбросить значение nonce. Нажмите на значок настроек (три бара), Настройки, Учетная запись сброса. Журнал транзакции очистится, и вы сможете повторно отправить транзакцию.

### <a name="do-i-need-to-specify-gas-fee-in-metamask"></a>Нужно ли указывать сборы на газ в MetaMask?

Эфир не предназначен для этой цели в консорциуме PoA. Следовательно, нет необходимости указывать плату за газ при подаче сделок в MetaMask.

### <a name="what-should-i-do-if-my-deployment-fails-due-to-failure-to-provision-azure-oms"></a>Что делать, если развертывание завершается сбоем из-за невозможности подготовить Azure OMS?

Мониторинг — это дополнительная функция. В некоторых редких случаях, когда развертывание завершается неудачей из-за неспособности успешно предоставить ресурс Azure Monitor, можно перераспределить его без Azure Monitor.

### <a name="are-public-ip-deployments-compatible-with-private-network-deployments"></a>Совместимы ли развертывания с общедоступным IP-адресом с развертываниями с частной сетью?

Нет. Пиринг требует двусторонней связи, поэтому вся сеть должна быть либо публичной, либо частной.

### <a name="what-is-the-expected-transaction-throughput-of-proof-of-authority"></a>Какова ожидаемая пропускная способность транзакций PoA?

Пропускная способность транзакций будет значительно зависеть от типов транзакций и топологии сети. Протестировав простые транзакции, мы определили показатель в среднем в 400 транзакций в секунду для сети, развернутой в нескольких регионах.

### <a name="how-do-i-subscribe-to-smart-contract-events"></a>Как подписаться на события смарт-контрактов?

PoA Ethereum теперь поддерживает веб-сокеты.  Проверьте выход развертывания, чтобы найти URL-адрес веб-разъема и портпорт.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные решения Azure Blockchain можно найти в [документации Azure Blockchain.](https://docs.microsoft.com/azure/blockchain/)
