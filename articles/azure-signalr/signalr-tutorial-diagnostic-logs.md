---
title: Диагностические журналы для службы сигнального обслуживания Azure
description: Узнайте, как настроить диагностические журналы для службы Azure SignalR и как использовать их для самостоятельной работы.
author: wanlwanl
ms.service: signalr
ms.topic: conceptual
ms.date: 12/17/2019
ms.author: wanl
ms.openlocfilehash: 72f57ba4bbbbde07f6d26edc88c158f301ebe2f2
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79536740"
---
# <a name="diagnostic-logs-for-azure-signalr-service"></a>Диагностические журналы для службы сигнального обслуживания Azure

В этом учебнике рассказывается о диагностических журналах службы Azure SignalR, а также о том, как настроить диагностические журналы и как устранить неполадки с помощью диагностических журналов.

## <a name="prerequisites"></a>Предварительные требования
Для включения диагностических журналов необходимо где-то для хранения данных журнала. В этом учебнике используется аналитика данных по хранению и журналу Azure.

* [Хранилище Azure](../azure-monitor/platform/resource-logs-collect-storage.md) - Сохраняет диагностические журналы для аудита политики, статического анализа или резервного копирования.
* [Log Analytics](../azure-monitor/platform/resource-logs-collect-workspace.md) - гибкий инструмент поиска журналов и аналитики, позволяющий анализировать необработанные журналы, генерируемые ресурсом Azure.

## <a name="set-up-diagnostic-logs-for-an-azure-signalr-service"></a>Настройка диагностических журналов для службы Azure SignalR

Можно просмотреть диагностические журналы для службы Azure SignalR. Эти журналы обеспечивают более широкое представление о подключении к экземпляру службы Azure SignalR. Диагностические журналы предоставляют подробную информацию о каждом подключении. Например, базовая информация (идентификатор пользователя, идентификатор связи и тип транспорта и т.д.) и информация о событиях (подключение, отключение и прекращение события и т.д.) соединения. Диагностические журналы могут быть использованы для идентификации проблем, отслеживания связи и анализа.

### <a name="enable-diagnostic-logs"></a>Включение журналов диагностики

По умолчанию журналы диагностики отключены. Чтобы включить журналы диагностики, сделайте следующее:

1. На [портале Azure](https://portal.azure.com)под **мониторингом**нажмите **На настройки диагностики.**

    ![Панорамная навигация в диагностических настройках](./media/signalr-tutorial-diagnostic-logs/diagnostic-settings-menu-item.png)

1. Затем нажмите **Добавить диагностическую настройку**.

    ![Добавление диагностических журналов](./media/signalr-tutorial-diagnostic-logs/add-diagnostic-setting.png)

1. Установите цель архива, которую вы хотите. В настоящее время мы поддерживаем **Архив на учетную запись хранения** и отправить в журнал **Analytics**.

1. Выберите журналы, которые вы хотите архивировать.

    ![Панель параметров диагностики](./media/signalr-tutorial-diagnostic-logs/diagnostics-settings-pane.png)


1. Сохраните новые параметры диагностики.

Новые параметры вступят в силу в течение 10 минут. После этого журналы появятся в настроенной цели для архивирования на панели **Журналы диагностики**.

Дополнительные сведения о настройке системы диагностики доступны в [обзоре журналов диагностики Azure](../azure-monitor/platform/platform-logs-overview.md).

### <a name="diagnostic-logs-categories"></a>Категории журналов диагностики

Служба Azure SignalR фиксирует диагностические журналы в одной категории:

* **Все журналы:** Отслеживайте соединения, которые подключаются к службе Azure SignalR. В журналах предоставляется информация о подключении/отключении, аутентификации и задушении. Дополнительные сведения см. в следующем разделе.

### <a name="archive-to-a-storage-account"></a>"Архивировать в учетной записи хранения";

Записи хранятся в учетной записи хранилища, настроенной в панели **журналов Diagnostics.** Названный `insights-logs-alllogs` контейнер создается автоматически для хранения диагностических журналов. Внутри контейнера журналы хранятся `resourceId=/SUBSCRIPTIONS/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/RESOURCEGROUPS/XXXX/PROVIDERS/MICROSOFT.SIGNALRSERVICE/SIGNALR/XXX/y=YYYY/m=MM/d=DD/h=HH/m=00/PT1H.json`в файле. В основном, путь `resource ID` сочетается и `Date Time`. Файлы журнала разделены на `hour`. Таким образом, минут `m=00`всегда будет .

Все журналы хранятся в формате JSON (нотация объектов JavaScript). Каждая запись содержит строковые поля, использующие формат, описанный в следующих разделах.

Строки архивного журнала JSON содержат элементы, перечисленные в следующих таблицах:

**Формат**

name | Описание
------- | -------
time | Время событий входа
level | Уровень события входа
resourceId | Идентификатор ресурса службы Azure SignalR
location | Местоположение службы сигнала Azure
категория | Категория события журнала
operationName | Название операции события
callerIpAddress | IP-адрес вашего сервера/клиента
properties | Подробные свойства, связанные с этим событием журнала. Для получения более подробной информации смотрите таблицу свойств ниже

**Таблица свойств**

name | Описание
------- | -------
type | Тип события журнала. В настоящее время мы предоставляем информацию о подключении к службе Azure SignalR. Доступен только `ConnectivityLogs` тип
коллекция | Сбор события журнала. Разрешенные значения: `Connection` `Authorization``Throttling`
connectionId | Идентификация соединения
транспортТип | Транспортный тип соединения. Разрешенные значения: `Websockets` \| `ServerSentEvents` \|`LongPolling`
connectionType | Тип подключения. Допустимые значения: `Server` \| `Client`. `Server`: подключение со стороны сервера; `Client`: соединение со стороны клиента
userId | Идентификация пользователя
message | Подробное сообщение события журнала

Ниже приведен пример строки JSON журнала архивирования.

```json
{
    "properties": {
        "message": "Entered Serverless mode.",
        "type": "ConnectivityLogs",
        "collection": "Connection",
        "connectionId": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
        "userId": "User",
        "transportType": "WebSockets",
        "connectionType": "Client"
    },
    "operationName": "ServerlessModeEntered",
    "category": "AllLogs",
    "level": "Informational",
    "callerIpAddress": "xxx.xxx.xxx.xxx",
    "time": "2019-01-01T00:00:00Z",
    "resourceId": "/SUBSCRIPTIONS/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/RESOURCEGROUPS/XXXX/PROVIDERS/MICROSOFT.SIGNALRSERVICE/SIGNALR/XXX",
    "location": "xxxx"
}
```

### <a name="archive-logs-schema-for-log-analytics"></a>Схема архивных журналов для журнала Analytics

Чтобы просмотреть диагностические журналы, выполните следующие действия:

1. Нажмите `Logs` в целевой журнал Analytics.

    ![Пункт меню «Аналитика журнала»](./media/signalr-tutorial-diagnostic-logs/log-analytics-menu-item.png)

2. Введите `SignalRServiceDiagnosticLogs` и выберите временной диапазон для запроса диагностических журналов. Для расширенного запроса смотрите начало [с журналом Analytics в Azure Monitor](../azure-monitor/log-query/get-started-portal.md)

    ![Регистрация запросов в журнале Analytics](./media/signalr-tutorial-diagnostic-logs/query-log-in-log-analytics.png)

Колонки журналов архивов содержат элементы, перечисленные в следующей таблице:

name | Описание
------- | ------- 
TimeGenerated | Время событий входа
Collection | Сбор события журнала. Разрешенные значения: `Connection` `Authorization``Throttling`
OperationName | Название операции события
Расположение | Местоположение службы сигнала Azure
Level | Уровень события входа
CallerIpAddress | IP-адрес вашего сервера/клиента
Сообщение | Подробное сообщение события журнала
UserId | Идентификация пользователя
ConnectionId | Идентификация соединения
ConnectionType | Тип подключения. Допустимые значения: `Server` \| `Client`. `Server`: подключение со стороны сервера; `Client`: соединение со стороны клиента
TransportType | Транспортный тип соединения. Разрешенные значения: `Websockets` \| `ServerSentEvents` \|`LongPolling`

### <a name="troubleshooting-with-diagnostic-logs"></a>Устранение неполадок с помощью диагностических журналов

Для устранения неполадок для службы Azure SignalR можно включить журналы сторон сервера/клиента для фиксации сбоев. В настоящее время служба Azure SignalR предоставляет диагностические журналы, можно также включить журналы для обслуживания.

При возникновении связи неожиданнорастущей ситуации, вы можете воспользоваться диагностическими журналами для устранения неполадок.

Типичные проблемы часто связаны с неожиданными изменениями количества соединений, ограничениями соединения и сбоем авторизации. О знакомитесь с следующими разделами о том, как устранить неполадки.

#### <a name="unexpected-connection-number-changes"></a>Неожиданные изменения номера соединения

##### <a name="unexpected-connection-dropping"></a>Неожиданное падение соединения

Если вы столкнулись с неожиданным падением подключений, во-первых, включите журналы в обслуживании, сервере и клиентских сторонах.

Если соединение отключается, диагностические журналы записывают это отключение, `ConnectionEnded` `operationName`которое вы увидите `ConnectionAborted` или в .

Разница между `ConnectionAborted` `ConnectionEnded` и `ConnectionEnded` является то, что это ожидаемое отключение, которое вызвано клиентом или сервером стороны. В `ConnectionAborted` то время как это, как правило, неожиданное `message`соединение снижается событие, и прерывание причина будет предоставлена в .

Причины прерывания указаны в следующей таблице:

Причина | Описание
------- | ------- 
Количество подключений достигает предела | Количество подключений достигает предела текущего ценового уровня. Рассмотрите возможность расширения службы
Сервер приложения закрыл соединение | Сервер приложения запускает аборт. Его можно рассматривать как ожидаемый аборт
Подключение пинг тайм-аут | Обычно это вызвано проблемой сети. Рассмотрите возможность проверки доступности сервера вашего приложения в Интернете
Перезагрузка сервиса, повторное подключение | Служба СигналR Azure перезагружается. Azure SignalR поддерживает автоматическое подключение, можно подождать до повторного подключения или ручного подключения к службе Azure SignalR
Внутренняя переходная ошибка сервера | Переходная ошибка происходит в службе Azure SignalR, должна быть автоматической
Серверное соединение удалено | Подключение сервера падает с неизвестной ошибкой, сначала рассмотрите возможность устранения самопомощи с помощью журнала стороны обслуживания/сервера/клиента. Попробуйте исключить основные проблемы (например, проблема сети, проблема стороны сервера приложения и так далее). Если проблема не решена, свяжитесь с нами для получения дополнительной помощи. Для получения дополнительной информации пересмотрите раздел [«Получить справку».](#get-help) 

##### <a name="unexpected-connection-growing"></a>Неожиданный рост связи

Чтобы устранить неполадки о неожиданном росте соединения, первое, что вам нужно сделать, это отфильтровать дополнительные соединения. Вы можете добавить уникальный идентификатор пользователя теста в тестовое клиентское соединение. Затем проверьте его с помощью диагностических журналов, если вы видите, что более одного клиентских соединений имеют один и тот же идентификатор пользователя или IP- данный тест, то, скорее всего, клиентская сторона создает и устанавливает больше подключений, чем ожидания. Проверьте свою клиентскую сторону.

#### <a name="authorization-failure"></a>Сбой авторизации

Если вы получили 401 несанкционированное возврат для запросов клиентов, проверьте свои диагностические журналы. Если вы `Failed to validate audience. Expected Audiences: <valid audience>. Actual Audiences: <actual audience>`столкнулись, это означает, что все аудитории в маркере доступа являются недействительными. Попробуйте использовать допустимые аудитории, предложенные в журнале.


#### <a name="throttling"></a>Регулирование

Если вы обнаружите, что не можете установить подключение клиента SignalR к службе Azure SignalR, проверьте свои диагностические журналы. Если вы `Connection count reaches limit` столкнулись в диагностическом журнале, вы устанавливаете слишком много подключений к службе SignalR, которые достигают предела количества соединения. Рассмотрите возможность расширения службы SignalR. Если вы `Message count reaches limit` столкнулись в диагностическом журнале, это означает, что вы используете бесплатный уровень, и вы используете квоту сообщений. Если вы хотите отправить больше сообщений, подумайте об изменении службы SignalR на стандартный уровень для отправки дополнительных сообщений. Для получения дополнительной [Azure SignalR Service Pricing](https://azure.microsoft.com/pricing/details/signalr-service/)информации см.

### <a name="get-help"></a>Получить справку

Мы рекомендуем вам устранить неполадки самостоятельно в первую очередь. Большинство проблем вызваны проблемами сервера приложений или сети. Следуйте [руководство по устранению неполадок с диагностическим журналом](#troubleshooting-with-diagnostic-logs) и [основные проблемы съемки руководство,](https://github.com/Azure/azure-signalr/blob/dev/docs/tsg.md) чтобы найти первопричину.
Если проблема все еще не может быть решена, подумайте об открытии проблемы в GitHub или создайте билет на портале Azure.
Сделайте следующее:
1. Диапазон времени около 30 минут, когда возникает проблема
2. Идентификатор ресурса службы Azure SignalR
3. Выпуск сведений, как можно более конкретные: Например, appserver не отправляет сообщения, клиентское соединение падает и так далее
4. Логи, собранные со стороны сервера/клиента, и другие материалы, которые могут быть полезны
5. (Необязательно) Код репро

> [!NOTE]
> Если вы открываете проблему в GitHub, держите конфиденциальную информацию (например, идентификатор ресурсов, журналы серверов/клиентов) конфиденциальной, отправляйте их только членам организации Майкрософт в частном порядке.