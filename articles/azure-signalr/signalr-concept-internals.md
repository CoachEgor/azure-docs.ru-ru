---
title: Внутренние компоненты службы Azure SignalR
description: Сведения о внутренних компонентах службы Azure SignalR, архитектуре, подключениях и способах передачи данных.
author: sffamily
ms.service: signalr
ms.topic: conceptual
ms.date: 11/13/2019
ms.author: zhshang
ms.openlocfilehash: 62afa5ee6993aa1bb3c7b5926e5320ab1fa510a2
ms.sourcegitcommit: 28688c6ec606ddb7ae97f4d0ac0ec8e0cd622889
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2019
ms.locfileid: "74157593"
---
# <a name="azure-signalr-service-internals"></a>Внутренние компоненты службы Azure SignalR

Служба Azure SignalR создана на основе платформы ASP.NET Core SignalR. Она также поддерживает ASP.NET SignalR как предварительную версию функции.

> Чтобы поддерживать ASP.NET SignalR, служба Azure SignalR повторно реализует протокол ASP.NET SignalR на базе платформы ASP.NET Core.

Вы можете легко перенести локальный веб-узел ASP. NET Core SignalR для работы со Службой SignalR с минимальным изменением кода.

На схеме ниже описывается типичная архитектура для использования Службы SignalR с сервером приложений.

Кроме того, рассматриваются отличия от локального приложения ASP.NET Core SignalR.

![Архитектура](./media/signalr-concept-internals/arch.png)

## <a name="server-connections"></a>Подключения к серверу

Локальный сервер приложений ASP.NET Core SignalR прослушивает и подключает клиенты напрямую.

При использовании службы SignalR сервер приложений не принимает постоянных клиентских подключений.

1. Вместо этого конечная точка `negotiate` предоставляется пакетом SDK Службы Azure SignalR для каждого концентратора.
1. Эта конечная точка будет отвечать на запросы согласования клиента и перенаправлять клиентов в Службу SignalR
1. В конце концов клиенты будут подключены к Службе SignalR.

Дополнительные сведения см. в разделе о [подключениях клиентов](#client-connections).

После запуска сервера приложений: 
- Для ASP.NET Core SignalR пакет SDK Службы Azure SignalR открывает 5 подключений WebSocket на один концентратор Службы SignalR. 
- Для ASP.NET SignalR пакет SDK Службы Azure SignalR открывается 5 подключений WebSocket на один концентратор Службы SignalR и одно для подключения WebSocket приложения.

5 подключений WebSocket — это значение по умолчанию, которое можно изменить в [конфигурации](https://github.com/Azure/azure-signalr/blob/dev/docs/use-signalr-service.md#connectioncount).

Исходящие и входящие сообщения клиентов будут мультиплексироваться в эти подключениях.

Эти подключения к Службе SignalR будут постоянными. При отключении подключения к серверу из-за проблемы с сетью:
- все клиенты, обслуживаемые этим подключением к серверу, отключаются (дополнительные сведения см. в разделе [Передача данных между клиентом и сервером](#data-transmit-between-client-and-server));
- переподключение к серверу начинается автоматически.

## <a name="client-connections"></a>Клиентские подключения

При использовании Службы SignalR клиенты подключаются к службе вместо сервера приложений.
Существует два способа установки постоянных подключений между клиентом и Службой SignalR

1. Клиент отправляет запрос на согласование к серверу приложений. С помощью пакета SDK Службы Azure SignalR сервер приложений возвращает ответ перенаправления с URL-адресом Службы SignalR и маркер доступа.

- Для ASP.NET Core SignalR ответ перенаправления обычно выглядит так:
    ```
    {
        "url":"https://test.service.signalr.net/client/?hub=chat&...",
        "accessToken":"<a typical JWT token>"
    }
    ```
- Для ASP.NET SignalR ответ перенаправления обычно выглядит так:
    ```
    {
        "ProtocolVersion":"2.0",
        "RedirectUrl":"https://test.service.signalr.net/aspnetclient",
        "AccessToken":"<a typical JWT token>"
    }
    ```

1. После получения ответа на перенаправление клиент использует новый URL-адрес и маркер доступа для запуска обычного процесса подключения к службе SignalR.

Узнайте больше о [транспортных протоколах](https://github.com/aspnet/SignalR/blob/release/2.2/specs/TransportProtocols.md) ASP.NET Core SignalR.

## <a name="data-transmit-between-client-and-server"></a>Передача данных между клиентом и сервером

Когда клиент подключается к Службе SignalR, среда выполнения службы будет искать подключение к серверу для обслуживания этого клиента.
- Этот шаг выполняется только один раз и представляет собой сопоставление "один к одному" между подключениями клиента и сервера.
- Указанное сопоставление поддерживается в Службе SignalR, пока клиент или сервер не отключается.

На этом этапе сервер приложений получает события со сведениями от нового клиента. Логическое подключение к клиенту создается на сервере приложений. Канал данных от клиента к серверу приложения устанавливается с помощью Службы SignalR.

Служба SignalR передает данные от клиента к серверу связывания приложений. Данные с сервера приложений будут отправляться сопоставленным клиентам.

Как видно, служба Azure SignalR по сути является логическим транспортным уровнем между сервером приложений и клиентами. Все постоянные подключения выгружаются в Службу SignalR.
Сервер приложений обрабатывает только бизнес-логику в классе концентратора, не заботясь о клиентских подключениях.