---
title: Копирование базы данных
description: Создание транзакционно согласованной копии существующей базы данных SQL Azure на том же или на другом сервере.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sashan
ms.reviewer: carlrab
ms.date: 02/24/2020
ms.openlocfilehash: 7e4744627cfd08874e07bb126df048ea3e644f39
ms.sourcegitcommit: 849bb1729b89d075eed579aa36395bf4d29f3bd9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "79473750"
---
# <a name="copy-a-transactionally-consistent-copy-of-an-azure-sql-database"></a>Копирование транзакционно согласованной копии базы данных Azure SQL

База данных SQL Azure предоставляет несколько методов создания транзакционно согласованной копии существующей базы данных SQL Azure ([отдельной базы данных](sql-database-single-database.md)) на том же или на другом сервере. Базу данных SQL можно копировать с помощью портала Azure, PowerShell или T-SQL.

## <a name="overview"></a>Обзор

Копия базы данных представляет собой моментальный снимок исходной базы данных на момент запроса копирования. Можно выбрать один и тот же сервер или другой сервер. Кроме того, можно настроить уровень служб и размер вычислений либо использовать другой размер вычислений в пределах того же уровня служб (выпуска). После завершения копирования копия становится полностью работоспособной и независимой базой данных. На этом этапе можно перейти на использование любой более поздней или более ранней версии. Именами входа, пользователями и разрешениями можно управлять независимо. Копия создается с помощью технологии георепликации, и после завершения заполнения связь георепликации автоматически завершается. Все требования к использованию георепликации применяются к операции копирования базы данных. Дополнительные сведения см. в разделе [Общие сведения об активной георепликации](sql-database-active-geo-replication.md) .

> [!NOTE]
> [Автоматические резервные копии базы данных](sql-database-automated-backups.md) используются при создании копии базы данных.

## <a name="logins-in-the-database-copy"></a>Имена входа в копии базы данных

При копировании базы данных на тот же сервер Базы данных SQL можете использовать для обеих баз данных одинаковые имена входа. Субъект безопасности, используемый для копирования базы данных, становится владельцем новой базы данных. 

При копировании базы данных на другой сервер базы данных SQL участник безопасности, инициирующий операцию копирования на целевом сервере, станет владельцем новой базы данных. 

Независимо от целевого сервера все пользователи базы данных, их разрешения и идентификаторы безопасности (SID) копируются в копию базы данных. Использование [пользователей автономной базы данных](sql-database-manage-logins.md) для доступа к данным гарантирует, что скопированная база данных будет иметь те же учетные данные пользователя, поэтому после завершения копирования вы сможете немедленно получить к ней доступ с теми же учетными данными.

Если для доступа к данным и копирования базы данных на другой сервер используются имена для входа на уровне сервера, доступ на основе имени для входа может не работать. Это может произойти из-за того, что имена входа не существуют на целевом сервере или что пароли и идентификаторы безопасности (SID) отличаются. В статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md) описывается управление именами для входа при копировании базы данных на другой сервер Базы данных SQL. После выполнения операции копирования на другом сервере и до повторного сопоставления других пользователей только имя входа, связанное с владельцем базы данных, или администратор сервера может войти в скопированную базу данных. Сведения об устранении имен входа и установке доступа к данным после копирования см. в разделе [разрешение имен для входа](#resolve-logins).

## <a name="copy-a-database-by-using-the-azure-portal"></a>Копирование базы данных на портале Azure

Чтобы скопировать базу данных с помощью портала Azure, откройте страницу базы данных и щелкните **Копировать**.

   ![Копирование базы данных](./media/sql-database-copy/database-copy.png)

## <a name="copy-a-database-by-using-powershell-or-azure-cli"></a>Копирование базы данных с помощью PowerShell или Azure CLI

Чтобы скопировать базу данных, используйте следующие примеры.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Для PowerShell используйте командлет [New-азсклдатабасекопи](/powershell/module/az.sql/new-azsqldatabasecopy) .

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager (RM) по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Модуль AzureRM продолжит принимать исправления ошибок до 2020 декабря.  Аргументы для команд в модуле AZ и в модулях AzureRm существенно идентичны. Дополнительные сведения о совместимости см. [в разделе Введение в новый модуль Azure PowerShell AZ](/powershell/azure/new-azureps-module-az).

```powershell
New-AzSqlDatabaseCopy -ResourceGroupName "<resourceGroup>" -ServerName $sourceserver -DatabaseName "<databaseName>" `
    -CopyResourceGroupName "myResourceGroup" -CopyServerName $targetserver -CopyDatabaseName "CopyOfMySampleDatabase"
```

Копия базы данных является асинхронной операцией, но Целевая база данных создается сразу после принятия запроса. Если необходимо отменить операцию копирования, пока все еще выполняется, удалите целевую базу данных с помощью командлета [Remove-азсклдатабасе](/powershell/module/az.sql/new-azsqldatabase) .

Полный пример скрипта PowerShell см. в разделе [копирование базы данных на новый сервер](scripts/sql-database-copy-database-to-new-server-powershell.md).

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

```azurecli
az sql db copy --dest-name "CopyOfMySampleDatabase" --dest-resource-group "myResourceGroup" --dest-server $targetserver `
    --name "<databaseName>" --resource-group "<resourceGroup>" --server $sourceserver
```

Копия базы данных является асинхронной операцией, но Целевая база данных создается сразу после принятия запроса. Если необходимо отменить операцию копирования, пока все еще выполняется, удалите целевую базу данных с помощью команды [AZ SQL DB Delete](/cli/azure/sql/db#az-sql-db-delete) .

* * *

## <a name="rbac-roles-to-manage-database-copy"></a>Роли RBAC для управления копированием базы данных

Чтобы создать копию базы данных, необходимо быть в следующих ролях:

- владельца подписки или
- Роль участника SQL Server или
- Пользовательская роль в исходной и целевой базах данных со следующим разрешением:

   Microsoft. SQL/Servers/databases/Read Microsoft. SQL/Servers/databases/Write

Чтобы отменить копирование базы данных, необходимо иметь следующие роли.

- владельца подписки или
- Роль участника SQL Server или
- Пользовательская роль в исходной и целевой базах данных со следующим разрешением:

   Microsoft. SQL/Servers/databases/Read Microsoft. SQL/Servers/databases/Write

Для управления копированием базы данных с помощью портал Azure также необходимы следующие разрешения.

   Microsoft. Resources/Subscriptions/Resources/Read Microsoft. Resources/Subscriptions/Resources/Write Microsoft. Resources/deployments/Read Microsoft. Resources/deployments/Write Microsoft. Resources/deployments

Если вы хотите просмотреть операции в развертываниях в группе ресурсов на портале, операции с несколькими поставщиками ресурсов, включая операции SQL, понадобятся вам следующие дополнительные роли RBAC:

   Microsoft. Resources/Subscriptions/resourcegroups/deployments/Operations/Read Microsoft. Resources/Subscriptions/resourcegroups/deployments/оператионстатусес/Read

## <a name="copy-a-database-by-using-transact-sql"></a>Копирование базы данных с помощью Transact-SQL

Войдите в базу данных master с помощью имени входа администратора сервера или имени входа, создавшего базу данных, которую необходимо скопировать. Для успешности копирования базы данных имена входа, не являющиеся администраторами сервера, должны быть членами `dbmanager` роли. Дополнительные сведения об именах для входа и подключении к серверу см. в статье [Проверка подлинности и авторизация в базе данных SQL: предоставление доступа](sql-database-manage-logins.md).

Начало копирования базы данных источника с помощью [создания базы данных... В качестве копии](https://docs.microsoft.com/sql/t-sql/statements/create-database-transact-sql?view=azuresqldb-current#copy-a-database) инструкции. Инструкция T-SQL продолжит выполнение до тех пор, пока не будет завершена операция копирования базы данных.

> [!NOTE]
> Завершение выполнения инструкции T-SQL не приводит к завершению операции копирования базы данных. Чтобы завершить операцию, удалите целевую базу данных.
>

### <a name="copy-a-sql-database-to-the-same-server"></a>Копирование Базы данных SQL на тот же сервер

Войдите в базу данных master с помощью имени входа администратора сервера или имени входа, создавшего базу данных, которую необходимо скопировать. Для успешности копирования базы данных имена входа, не являющиеся администраторами сервера, должны быть членами `dbmanager` роли.

Эта команда копирует Database1 в новую базу данных с именем Database2 на том же сервере. Операция копирования может занять некоторое время в зависимости от размера базы данных.

   ```sql
   -- execute on the master database to start copying
   CREATE DATABASE Database2 AS COPY OF Database1;
   ```

### <a name="copy-a-sql-database-to-a-different-server"></a>Копирование Базы данных SQL на другой сервер

Войдите в базу данных master на целевом сервере, где должна быть создана новая база данных. Используйте имя входа с тем же именем и паролем, что и у владельца базы данных-источника на исходном сервере. Имя входа на целевом сервере также должно быть членом `dbmanager` роли или иметь имя входа администратора сервера.

Эта команда копирует Database1 на сервере server1 в новую базу данных с именем Database2 на сервере server2. Операция копирования может занять некоторое время в зависимости от размера базы данных.

```sql
-- Execute on the master database of the target server (server2) to start copying from Server1 to Server2
CREATE DATABASE Database2 AS COPY OF server1.Database1;
```

> [!IMPORTANT]
> Брандмауэры обоих серверов должны разрешать входящие подключения от IP-адреса клиента, выполняющего создание базы данных T-SQL... В качестве копии команды.

### <a name="copy-a-sql-database-to-a-different-subscription"></a>Копирование базы данных SQL в другую подписку

Вы можете выполнить инструкции из раздела [копирование базы данных SQL в другой сервер](#copy-a-sql-database-to-a-different-server) , чтобы скопировать базу данных на сервер базы данных SQL в другой подписке с помощью T-SQL. Убедитесь, что используется имя входа с тем же именем и паролем, что и у владельца базы данных-источника. Кроме того, имя входа должно быть членом `dbmanager` роли или администратора сервера на исходном и целевом серверах.

> [!NOTE]
> [Портал Azure](https://portal.azure.com), PowerShell и Azure CLI не поддерживают копирование базы данных в другую подписку.

### <a name="monitor-the-progress-of-the-copying-operation"></a>Отслеживание хода операции копирования

Отслеживайте процесс копирования, запрашивая представления [sys. databases](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-databases-transact-sql), [sys. dm_database_copies](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-database-copies-azure-sql-database)и [sys. dm_operation_status](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) . Во время копирования в столбце **state_desc** представления sys. databases для новой базы данных задается значение **копирование**.

* В случае сбоя копирования в столбце **state_desc** представления sys. databases для новой базы данных устанавливается значение **SUSPECT**. Выполните инструкцию DROP для новой базы данных и повторите попытку позднее.
* Если копирование выполняется, столбец **state_desc** в представлении sys. databases для новой базы данных устанавливается в состояние «в **сети**». Это означает, что копирование завершено и новая база данных является обычной базой данных, которую можно изменять независимо от исходной.

> [!NOTE]
> Чтобы отменить копирование до его завершения, выполните в новой базе данных инструкцию [DROP DATABASE](https://docs.microsoft.com/sql/t-sql/statements/drop-database-transact-sql).

> [!IMPORTANT]
> Если необходимо создать копию с целью существенно меньшей цели обслуживания, чем у источника, то Целевая база данных может не иметь достаточных ресурсов для завершения процесса заполнения, и это может привести к сбою в области Opera. В этом сценарии для создания копии на другом сервере и (или) другом регионе используется запрос географического восстановления. Дополнительные сведения см. в статье [Восстановление базы данных SQL Azure с помощью резервных копий базы данных](sql-database-recovery-using-backups.md#geo-restore) .

## <a name="resolve-logins"></a>Разрешение имен для входа

После того, как новая база данных будет подключена к сети на целевом сервере, используйте инструкцию [ALTER USER](https://docs.microsoft.com/sql/t-sql/statements/alter-user-transact-sql?view=azuresqldb-current) для повторного сопоставления пользователей из новой базы данных с именами входа на целевом сервере. Сведения о разрешении потерянных пользователей см. в разделе [Диагностика пользователей, утративших связь с учетной записью](https://docs.microsoft.com/sql/sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server). Ознакомьтесь также со статьей [Как управлять безопасностью базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Все пользователи в новой базе данных получают такие же разрешения, как и в исходной базе данных. Пользователь, инициировавший копирование базы данных, станет владельцем новой базы данных. После завершения копирования и повторного сопоставления других пользователей только владелец базы данных может войти в новую базу данных.

Дополнительные сведения об управлении пользователями и именами для входа при копировании базы данных на другой сервер Базы данных SQL см. в статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).

## <a name="database-copy-errors"></a>Ошибки копирования базы данных

При копировании базы данных в базе данных SQL Azure могут возникнуть следующие ошибки. Дополнительные сведения см. в статье [Копирование базы данных SQL Azure](sql-database-copy.md).

| Код ошибки | Severity | Описание |
| ---:| ---:|:--- |
| 40635 |16 |Клиент с IP-адресом %.&#x2a;ls временно отключен. |
| 40637 |16 |Возможность создания копии базы данных в настоящее время отключена. |
| 40561 |16 |Не удалось скопировать базу данных. Исходная или целевая база данных не существует. |
| 40562 |16 |Не удалось скопировать базу данных. Исходная база данных удалена. |
| 40563 |16 |Не удалось скопировать базу данных. Целевая база данных удалена. |
| 40564 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40565 |16 |Не удалось скопировать базу данных. Допускается не более одной одновременной операции копирования базы данных из одного источника. Удалите целевую базу данных и повторите попытку позднее. |
| 40566 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40567 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40568 |16 |Не удалось скопировать базу данных. Исходная база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40569 |16 |Не удалось скопировать базу данных. Целевая база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40570 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |
| 40571 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |

## <a name="next-steps"></a>Дальнейшие шаги

- Сведения об именах для входа см. в статьях [Предоставление доступа к базе данных и управление им](sql-database-manage-logins.md) и [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).
- Сведения о том, как экспортировать базу данных, см. в разделе [Экспорт базы данных в BACPAC-](sql-database-export.md)файл.
