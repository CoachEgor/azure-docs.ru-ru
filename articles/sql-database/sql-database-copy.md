---
title: Копирование базы данных
description: Создание транзакционно согласованной копии существующей базы данных SQL Azure на том же или на другом сервере.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sashan
ms.reviewer: carlrab
ms.date: 11/14/2019
ms.openlocfilehash: e1df345fb9a89972ad1857a937c22d6e10ad1fba
ms.sourcegitcommit: 7221918fbe5385ceccf39dff9dd5a3817a0bd807
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/21/2020
ms.locfileid: "76289413"
---
# <a name="copy-a-transactionally-consistent-copy-of-an-azure-sql-database"></a>Копирование транзакционно согласованной копии базы данных Azure SQL

База данных SQL Azure предоставляет несколько методов создания транзакционно согласованной копии существующей базы данных SQL Azure ([отдельной базы данных](sql-database-single-database.md)) на том же или на другом сервере. Базу данных SQL можно копировать с помощью портала Azure, PowerShell или T-SQL.

## <a name="overview"></a>Обзор

Копия базы данных представляет собой моментальный снимок исходной базы данных на момент запроса копирования. Можно выбрать один и тот же сервер или другой сервер. Кроме того, можно настроить уровень служб и размер вычислений либо использовать другой размер вычислений в пределах того же уровня служб (выпуска). После завершения копирования копия становится полностью работоспособной и независимой базой данных. На этом этапе можно перейти на использование любой более поздней или более ранней версии. Именами входа, пользователями и разрешениями можно управлять независимо. Копия создается с помощью технологии георепликации, и после завершения заполнения связь георепликации автоматически завершается. Все требования к использованию георепликации применяются к операции копирования базы данных. Дополнительные сведения см. в разделе [Общие сведения об активной георепликации](sql-database-active-geo-replication.md) .

> [!NOTE]
> [Создаваемые автоматически резервные копии базы данных](sql-database-automated-backups.md) используются при создании копии базы данных.

## <a name="logins-in-the-database-copy"></a>Имена входа в копии базы данных

При копировании базы данных на тот же сервер Базы данных SQL можете использовать для обеих баз данных одинаковые имена входа. Субъект безопасности, используемый для копирования базы данных, становится владельцем новой базы данных. В копируемую базу данных копируются все пользователи, их разрешения и идентификаторы безопасности (SID).  

При копировании базы данных на другой сервер Базы данных SQL субъект безопасности на новом сервере становится владельцем новой базы данных. Если вы используете [пользователей автономной базы данных](sql-database-manage-logins.md) для доступа к данным, это гарантирует, что база данных-источник и база данных-получатель всегда имеют одинаковые учетные данные пользователей, поэтому после завершения копирования к копии можно будет немедленно обратиться, используя прежние учетные данные.

Если вы используете [Azure Active Directory](../active-directory/fundamentals/active-directory-whatis.md), то можно полностью исключить потребность в управлении учетными данными в копии. Тем не менее при копировании базы данных на новый сервер доступ по имени для входа может перестать работать, так на новом сервере отсутствуют имена для входа. В статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md) описывается управление именами для входа при копировании базы данных на другой сервер Базы данных SQL.

С момента успешного завершения копирования и вплоть до сопоставления остальных пользователей войти в новую базу данных может только ее владелец, т. е. пользователь, инициировавший копирование. Сведения о разрешении имен для входа после завершения операции копирования см. в разделе [Копирование базы данных SQL Azure с помощью Transact-SQL](#resolve-logins).

## <a name="copy-a-database-by-using-the-azure-portal"></a>Копирование базы данных на портале Azure

Чтобы скопировать базу данных с помощью портала Azure, откройте страницу базы данных и щелкните **Копировать**.

   ![Копирование базы данных](./media/sql-database-copy/database-copy.png)

## <a name="copy-a-database-by-using-powershell"></a>Копирование базы данных с помощью PowerShell

Чтобы скопировать базу данных, используйте следующие примеры.

# <a name="powershelltabazure-powershell"></a>[PowerShell](#tab/azure-powershell)

Для PowerShell используйте командлет [New-азсклдатабасекопи](/powershell/module/az.sql/new-azsqldatabasecopy) .

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager (RM) по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Модуль AzureRM продолжит принимать исправления ошибок до 2020 декабря.  Аргументы для команд в модуле AZ и в модулях AzureRm существенно идентичны. Дополнительные сведения о совместимости см. [в разделе Введение в новый модуль Azure PowerShell AZ](/powershell/azure/new-azureps-module-az).

```powershell
New-AzSqlDatabaseCopy -ResourceGroupName "<resourceGroup>" -ServerName $sourceserver -DatabaseName "<databaseName>" `
    -CopyResourceGroupName "myResourceGroup" -CopyServerName $targetserver -CopyDatabaseName "CopyOfMySampleDatabase"
```

Копия базы данных является асинхронной операцией, но Целевая база данных создается сразу после принятия запроса. Если необходимо отменить операцию копирования, пока все еще выполняется, удалите целевую базу данных с помощью командлета [Remove-азсклдатабасе](/powershell/module/az.sql/new-azsqldatabase) .

# <a name="azure-clitabazure-cli"></a>[Azure CLI](#tab/azure-cli)

```azure-cli
az sql db copy --dest-name "CopyOfMySampleDatabase" --dest-resource-group "myResourceGroup" --dest-server $targetserver `
    --name "<databaseName>" --resource-group "<resourceGroup>" --server $sourceserver
```

Копия базы данных является асинхронной операцией, но Целевая база данных создается сразу после принятия запроса. Если необходимо отменить операцию копирования, пока все еще выполняется, удалите целевую базу данных с помощью команды [AZ SQL DB Delete](/cli/azure/sql/db#az-sql-db-delete) .

* * *

Полный пример сценария см. в статье [Копирование базы данных SQL на новый сервер с помощью PowerShell](scripts/sql-database-copy-database-to-new-server-powershell.md).

## <a name="rbac-roles-to-manage-database-copy"></a>Роли RBAC для управления копированием базы данных

Чтобы создать копию базы данных, необходимо быть в следующих ролях:

- владельца подписки или
- Роль участника SQL Server или
- Пользовательская роль в исходной и целевой базах данных со следующим разрешением:

   Microsoft. SQL/Servers/databases/Read Microsoft. SQL/Servers/databases/Write

Чтобы отменить копирование базы данных, необходимо иметь следующие роли.

- владельца подписки или
- Роль участника SQL Server или
- Пользовательская роль в исходной и целевой базах данных со следующим разрешением:

   Microsoft. SQL/Servers/databases/Read Microsoft. SQL/Servers/databases/Write

Для управления копированием базы данных с помощью портал Azure также необходимы следующие разрешения.

   Microsoft. Resources/Subscriptions/Resources/Read Microsoft. Resources/Subscriptions/Resources/Write Microsoft. Resources/deployments/Read Microsoft. Resources/deployments/Write Microsoft. Resources/deployments

Если вы хотите просмотреть операции в развертываниях в группе ресурсов на портале, операции с несколькими поставщиками ресурсов, включая операции SQL, понадобятся вам следующие дополнительные роли RBAC:

   Microsoft. Resources/Subscriptions/resourcegroups/deployments/Operations/Read Microsoft. Resources/Subscriptions/resourcegroups/deployments/оператионстатусес/Read

## <a name="copy-a-database-by-using-transact-sql"></a>Копирование базы данных с помощью Transact-SQL

Войдите в базу данных master под именем для входа субъекта на уровне сервера или под именем для входа, которое использовалось для создания копируемой базы данных. Для успешного копирования базы данных имена для входа, не принадлежащие субъектам уровня сервера, должны быть членами роли dbmanager. Дополнительные сведения об именах для входа и подключении к серверу см. в статье [Проверка подлинности и авторизация в базе данных SQL: предоставление доступа](sql-database-manage-logins.md).

Начните копирование исходной базы данных с помощью инструкции [CREATE DATABASE](https://msdn.microsoft.com/library/ms176061.aspx) . Данный оператор запускает процесс копирования базы данных. Так как копирование базы данных — процесс асинхронный, оператор CREATE DATABASE возвращается до завершения копирования базы данных.

### <a name="copy-a-sql-database-to-the-same-server"></a>Копирование Базы данных SQL на тот же сервер

Войдите в базу данных master под именем для входа субъекта на уровне сервера или под именем для входа, которое использовалось для создания копируемой базы данных. Для успешного копирования базы данных имена для входа, не принадлежащие субъектам уровня сервера, должны быть членами роли dbmanager.

Эта команда копирует Database1 в новую базу данных с именем Database2 на том же сервере. Операция копирования может занять некоторое время в зависимости от размера базы данных.

   ```sql
   -- execute on the master database to start copying
   CREATE DATABASE Database2 AS COPY OF Database1;
   ```

### <a name="copy-a-sql-database-to-a-different-server"></a>Копирование Базы данных SQL на другой сервер

Войдите в базу данных master на целевом сервере, т. е. на сервер Базы данных SQL, на котором необходимо создать базу данных. Для входа укажите имя пользователя и пароль владельца базы данных-источник на исходном сервере Базы данных SQL. Имя входа на целевом сервере также должно относиться к роли dbmanager или являться основным именем входа на уровне сервера.

Эта команда копирует Database1 на сервере server1 в новую базу данных с именем Database2 на сервере server2. Операция копирования может занять некоторое время в зависимости от размера базы данных.

```sql
-- Execute on the master database of the target server (server2) to start copying from Server1 to Server2
CREATE DATABASE Database2 AS COPY OF server1.Database1;
```

> [!IMPORTANT]
> Брандмауэры обоих серверов должны быть настроены на разрешение входящего подключения от IP-адреса клиента, выдающего команду T-SQL COPY.

### <a name="copy-a-sql-database-to-a-different-subscription"></a>Копирование базы данных SQL в другую подписку

Действия, описанные в предыдущем разделе, можно использовать для копирования базы данных на сервер базы данных SQL в другой подписке. Убедитесь, что используется имя входа с тем же именем и паролем, что и у владельца базы данных-источника, а оно является членом роли dbmanager или является именем входа участника уровня сервера. 

> [!NOTE]
> [Портал Azure](https://portal.azure.com) не поддерживает копирование в другую подписку, так как портал вызывает API ARM и использует сертификаты подписки для доступа к серверам, участвующим в георепликации.  

### <a name="monitor-the-progress-of-the-copying-operation"></a>Отслеживание хода операции копирования

Следить за ходом процесса копирования можно в представлениях sys.databases и sys.dm_database_copies. Во время копирования в столбце **state_desc** представления sys.databases для новой базы данных отображается значение **COPYING**.

* Если копирование завершается неудачей, в столбце **state_desc** представления sys.databases для новой базы данных отображается значение **SUSPECT**. Выполните инструкцию DROP для новой базы данных и повторите попытку позднее.
* Если копирование завершается успешно, в столбце **state_desc** представления sys.databases для новой базы данных отображается значение **ONLINE**. Это означает, что копирование завершено и новая база данных является обычной базой данных, которую можно изменять независимо от исходной.

> [!NOTE]
> Чтобы отменить копирование до его завершения, выполните в новой базе данных инструкцию [DROP DATABASE](https://msdn.microsoft.com/library/ms178613.aspx). Кроме того, процесс копирования отменяет также выполнение оператора DROP DATABASE в исходной базе данных.

> [!IMPORTANT]
> Если необходимо создать копию с существенно меньшим значением уровня обслуживания, чем у источника, то Целевая база данных может не иметь достаточных ресурсов для завершения процесса заполнения и может привести к сбою операции копирования. В этом сценарии для создания копии на другом сервере и (или) другом регионе используется запрос географического восстановления. Дополнительные сведения см. в статье [Восстановление базы данных SQL Azure с помощью резервных копий](sql-database-recovery-using-backups.md#geo-restore) .

## <a name="resolve-logins"></a>Разрешение имен для входа

После того как новая база данных на целевом сервере будет в сети, сопоставьте пользователей из новой базы данных с именами входа на целевом сервере с помощью оператора [ALTER USER](https://msdn.microsoft.com/library/ms176060.aspx). Сведения о разрешении потерянных пользователей см. в разделе [Диагностика пользователей, утративших связь с учетной записью](https://msdn.microsoft.com/library/ms175475.aspx). Ознакомьтесь также со статьей [Как управлять безопасностью базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Все пользователи в новой базе данных получают такие же разрешения, как и в исходной базе данных. Пользователь, инициировавший копирование базы данных, становится владельцем новой базы данных и получает новый идентификатор безопасности (SID). С момента успешного завершения копирования и вплоть до сопоставления остальных пользователей войти в новую базу данных может только ее владелец, т. е. пользователь, инициировавший копирование.

Дополнительные сведения об управлении пользователями и именами для входа при копировании базы данных на другой сервер Базы данных SQL см. в статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).

## <a name="database-copy-errors"></a>Ошибки копирования базы данных

При копировании базы данных в базе данных SQL Azure могут возникнуть следующие ошибки. Дополнительные сведения см. в статье [Копирование базы данных SQL Azure](sql-database-copy.md).

| Код ошибки | Серьезность | Description |
| ---:| ---:|:--- |
| 40635 |16 |Клиент с IP-адресом %.&#x2a;ls временно отключен. |
| 40637 |16 |Возможность создания копии базы данных в настоящее время отключена. |
| 40561 |16 |Не удалось скопировать базу данных. Исходная или целевая база данных не существует. |
| 40562 |16 |Не удалось скопировать базу данных. Исходная база данных удалена. |
| 40563 |16 |Не удалось скопировать базу данных. Целевая база данных удалена. |
| 40564 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40565 |16 |Не удалось скопировать базу данных. Допускается не более одной одновременной операции копирования базы данных из одного источника. Удалите целевую базу данных и повторите попытку позднее. |
| 40566 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40567 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40568 |16 |Не удалось скопировать базу данных. Исходная база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40569 |16 |Не удалось скопировать базу данных. Целевая база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40570 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |
| 40571 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об именах для входа см. в статьях [Предоставление доступа к базе данных и управление им](sql-database-manage-logins.md) и [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).
- Сведения об экспорте базы данных см. в статье [Экспорт базы данных SQL Azure или SQL Server в BACPAC-файл](sql-database-export.md).
