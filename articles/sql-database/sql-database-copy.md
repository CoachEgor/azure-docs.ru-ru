---
title: Копирование базы данных
description: Создание транзакционно согласованной копии существующей базы данных SQL Azure на том же или на другом сервере.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sashan
ms.reviewer: carlrab
ms.date: 02/24/2020
ms.openlocfilehash: 7e4744627cfd08874e07bb126df048ea3e644f39
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2020
ms.locfileid: "79473750"
---
# <a name="copy-a-transactionally-consistent-copy-of-an-azure-sql-database"></a>Копирование транзакционно согласованной копии базы данных Azure SQL

База данных Azure S'L предоставляет несколько методов для создания транзакционно согласованной копии существующей базы данных Azure S'L[(единая база данных)](sql-database-single-database.md)на одном и том же сервере или на другом сервере. Базу данных SQL можно копировать с помощью портала Azure, PowerShell или T-SQL.

## <a name="overview"></a>Обзор

Копия базы данных представляет собой моментальный снимок исходной базы данных на момент запроса копирования. Вы можете выбрать один и тот же сервер или другой сервер. Также вы можете сохранить уровень обслуживания и вычислить размер, или использовать другой размер вычисления в пределах одного и того же уровня обслуживания (издание). После завершения копирования копия становится полностью работоспособной и независимой базой данных. На этом этапе можно перейти на использование любой более поздней или более ранней версии. Именами входа, пользователями и разрешениями можно управлять независимо. Копия создается с использованием технологии георепликации, и после завершения посева ссылка георепликации автоматически прекращается. Все требования к использованию георепликации применяются к операции копирования базы данных. Для получения подробной информации смотрите [обзор Active geo-replication.](sql-database-active-geo-replication.md)

> [!NOTE]
> [Автоматизированные резервные копии базы данных](sql-database-automated-backups.md) используются при создании копии базы данных.

## <a name="logins-in-the-database-copy"></a>Имена входа в копии базы данных

При копировании базы данных на тот же сервер Базы данных SQL можете использовать для обеих баз данных одинаковые имена входа. Субъект безопасности, используемый для копирования базы данных, становится владельцем новой базы данных. 

При копировании базы данных на другой сервер базы данных S'L принцип безопасности, инициировавшего операцию копирования на целевом сервере, становится владельцем новой базы данных. 

Независимо от целевого сервера, все пользователи базы данных, их разрешения и идентификаторы безопасности (SID) копируются в копию базы данных. Использование [содержащихся пользователей базы данных](sql-database-manage-logins.md) для доступа к данным гарантирует, что скопированная база данных имеет те же учетные данные пользователей, так что после завершения копии вы можете немедленно получить к ней доступ с теми же учетными данными.

Если вы используете логины уровня сервера для доступа к данным и копируете базу данных на другой сервер, доступ на основе входа может не сработать. Это может произойти из-за того, что логины не существуют на целевом сервере, или потому, что их пароли и идентификаторы безопасности (SID) отличаются. В статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md) описывается управление именами для входа при копировании базы данных на другой сервер Базы данных SQL. После того, как операция копирования на другой сервер удавна, и до того, как другие пользователи будут перерегистрированы, только логин, связанный с владельцем базы данных, или администратор сервера могут войти в скопированную базу данных. Для устранения логинов и установления доступа к данным [Resolve logins](#resolve-logins)после завершения операции копирования см.

## <a name="copy-a-database-by-using-the-azure-portal"></a>Копирование базы данных на портале Azure

Чтобы скопировать базу данных с помощью портала Azure, откройте страницу базы данных и щелкните **Копировать**.

   ![Копирование базы данных](./media/sql-database-copy/database-copy.png)

## <a name="copy-a-database-by-using-powershell-or-azure-cli"></a>Копирование базы данных с помощью PowerShell или Azure CLI

Чтобы скопировать базу данных, используйте следующие примеры.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Для PowerShell используйте смдлет [New-AzSqlDatabaseCopy.](/powershell/module/az.sql/new-azsqldatabasecopy)

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager (RM) по-прежнему поддерживается базой данных Azure S'L, но все будущие разработки предназначены для модуля Az.Sql. Модуль AzureRM будет получать исправления ошибок по крайней мере до декабря 2020 года.  Аргументы для команд в модуле Az и в модулях Azrm существенно идентичны. Подробнее об их совместимости читайте [в новом модуле Azure PowerShell Az.](/powershell/azure/new-azureps-module-az)

```powershell
New-AzSqlDatabaseCopy -ResourceGroupName "<resourceGroup>" -ServerName $sourceserver -DatabaseName "<databaseName>" `
    -CopyResourceGroupName "myResourceGroup" -CopyServerName $targetserver -CopyDatabaseName "CopyOfMySampleDatabase"
```

Копия базы данных является асинхронной операцией, но целевая база данных создается сразу же после принятия запроса. Если вам необходимо отменить операцию копирования, пока еще не выполняется, отбросьте целевую базу данных с помощью cmdlet [Remove-AzSqlDatabase.](/powershell/module/az.sql/new-azsqldatabase)

Для полного образца сценария PowerShell [см.](scripts/sql-database-copy-database-to-new-server-powershell.md)

# <a name="azure-cli"></a>[Лазурный CLI](#tab/azure-cli)

```azurecli
az sql db copy --dest-name "CopyOfMySampleDatabase" --dest-resource-group "myResourceGroup" --dest-server $targetserver `
    --name "<databaseName>" --resource-group "<resourceGroup>" --server $sourceserver
```

Копия базы данных является асинхронной операцией, но целевая база данных создается сразу же после принятия запроса. Если вам необходимо отменить операцию копирования, пока она продолжается, отбросьте целевую базу данных с помощью команды [удаления az sql db.](/cli/azure/sql/db#az-sql-db-delete)

* * *

## <a name="rbac-roles-to-manage-database-copy"></a>Роли RBAC для управления копией базы данных

Чтобы создать копию базы данных, вам нужно будет находиться в следующих ролях

- владельца подписки или
- Роль вкладчика сервера S'L или
- Пользовательская роль в исходных и целевых базах данных со следующим разрешением:

   Microsoft.Sql/серверы/базы данных/читайMicrosoft.Sql/серверы/базы данных/записы

Чтобы отменить копию базы данных, вам нужно будет находиться в следующих ролях

- владельца подписки или
- Роль вкладчика сервера S'L или
- Пользовательская роль в исходных и целевых базах данных со следующим разрешением:

   Microsoft.Sql/серверы/базы данных/читайMicrosoft.Sql/серверы/базы данных/записы

Для управления копией базы данных с помощью портала Azure также потребуются следующие разрешения:

   Microsoft.Resources/subscriptions/resources/read Microsoft.Resources/subscriptions/resources/write Microsoft.Resources/deployments/read Microsoft.Resources/deployments/

Если вы хотите видеть операции, находимые в группе ресурсов на портале, операции между несколькими поставщиками ресурсов, включая операции S'L, вам понадобятся дополнительные роли RBAC:

   Microsoft.Resources/subscriptions/resourcegroups/deployments/operations/read Microsoft.Resources/subscriptions/resourcegroups/deployments/operationstatuses/read

## <a name="copy-a-database-by-using-transact-sql"></a>Копирование базы данных с помощью Transact-SQL

Войти в мастер-базу данных с логином администратора сервера или в журнале, который создал базу данных, которую вы хотите скопировать. Для успешной копирования базы данных логины, которые не `dbmanager` являются администратором сервера, должны быть членами роли. Дополнительные сведения об именах для входа и подключении к серверу см. в статье [Проверка подлинности и авторизация в базе данных SQL: предоставление доступа](sql-database-manage-logins.md).

Начните копировать исходную базу данных с [CREATE DATABASE ... Заявление AS COPY OF.](https://docs.microsoft.com/sql/t-sql/statements/create-database-transact-sql?view=azuresqldb-current#copy-a-database) Заявление T-S'L продолжает работать до завершения операции копирования базы данных.

> [!NOTE]
> Прекращение действия оператора T-S'L не прекращает работу копирования базы данных. Чтобы завершить операцию, отбросьте целевую базу данных.
>

### <a name="copy-a-sql-database-to-the-same-server"></a>Копирование Базы данных SQL на тот же сервер

Войти в мастер-базу данных с логином администратора сервера или в журнале, который создал базу данных, которую вы хотите скопировать. Для успешного копирования базы данных логины, которые не `dbmanager` являются администратором сервера, должны быть членами роли.

Эта команда копирует Database1 в новую базу данных с именем Database2 на том же сервере. Операция копирования может занять некоторое время в зависимости от размера базы данных.

   ```sql
   -- execute on the master database to start copying
   CREATE DATABASE Database2 AS COPY OF Database1;
   ```

### <a name="copy-a-sql-database-to-a-different-server"></a>Копирование Базы данных SQL на другой сервер

Войти в главную базу данных целевого сервера, где должна быть создана новая база данных. Используйте логин с тем же именем и паролем, что и владелец базы данных исходной базы данных на исходном сервере. Логин на целевом сервере также должен `dbmanager` быть участником роли или быть логином администратора сервера.

Эта команда копирует Database1 на сервере server1 в новую базу данных с именем Database2 на сервере server2. Операция копирования может занять некоторое время в зависимости от размера базы данных.

```sql
-- Execute on the master database of the target server (server2) to start copying from Server1 to Server2
CREATE DATABASE Database2 AS COPY OF server1.Database1;
```

> [!IMPORTANT]
> Брандмауэры обоих серверов должны быть настроены таким образом, чтобы входявое соединения с IP клиента, выдающего T-S'L CREATE DATABASE ... As COPY OF команда.

### <a name="copy-a-sql-database-to-a-different-subscription"></a>Копирование базы данных S'L на другую подписку

Вы можете использовать шаги в [базе данных Copy a S'L в другой](#copy-a-sql-database-to-a-different-server) раздел сервера, чтобы скопировать базу данных на сервер базы данных s'L в другой подписке с помощью T-S'L. Убедитесь, что вы используете логин с тем же именем и паролем, что и владелец базы данных исходной базы данных. Кроме того, логин должен быть `dbmanager` членом роли или администратором сервера, как на исходных, так и на целевых серверах.

> [!NOTE]
> [Портал Azure,](https://portal.azure.com)PowerShell и Azure CLI не поддерживают копию базы данных в другой подписке.

### <a name="monitor-the-progress-of-the-copying-operation"></a>Отслеживание хода операции копирования

Мониторинг процесса копирования, запрашивая [sys.databases,](https://docs.microsoft.com/sql/relational-databases/system-catalog-views/sys-databases-transact-sql) [sys.dm_database_copies](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-database-copies-azure-sql-database)и [sys.dm_operation_status](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) просмотров. Пока идет копирование, **state_desc** столбец представления sys.databases для новой базы данных настроен на **COPYING.**

* Если копирование не удается, **state_desc** столбец представления sys.databases для новой базы данных устанавливается **в SUSPECT**. Выполните инструкцию DROP для новой базы данных и повторите попытку позднее.
* Если копирование удается, **state_desc** столбец представления sys.databases для новой базы данных устанавливается **в ONLINE**. Это означает, что копирование завершено и новая база данных является обычной базой данных, которую можно изменять независимо от исходной.

> [!NOTE]
> Чтобы отменить копирование до его завершения, выполните в новой базе данных инструкцию [DROP DATABASE](https://docs.microsoft.com/sql/t-sql/statements/drop-database-transact-sql).

> [!IMPORTANT]
> Если вам нужно создать копию с значительно меньшей целью обслуживания, чем источник, целевая база данных может не иметь достаточных ресурсов для завершения процесса посева, и это может привести к сбою копирования. В этом сценарии используйте запрос на геовосстановление для создания копии на другом сервере и/или в другом регионе. Для получения дополнительной информации о [знаком с помощью резервного копирования данных](sql-database-recovery-using-backups.md#geo-restore) можно увидеть дополнительную информацию.

## <a name="resolve-logins"></a>Разрешение имен для входа

После того, как новая база данных будет работать на целевом сервере, используйте заявление [ALTER USER](https://docs.microsoft.com/sql/t-sql/statements/alter-user-transact-sql?view=azuresqldb-current) для перекарты пользователей из новой базы данных для входа в целевой сервер. Сведения о разрешении потерянных пользователей см. в разделе [Диагностика пользователей, утративших связь с учетной записью](https://docs.microsoft.com/sql/sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server). Ознакомьтесь также со статьей [Как управлять безопасностью базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

Все пользователи в новой базе данных получают такие же разрешения, как и в исходной базе данных. Пользователь, инициировавший копию базы данных, становится владельцем базы данных новой базы данных. После успеха копирования и до того, как другие пользователи будут уволены, только владелец базы данных может войти в новую базу данных.

Дополнительные сведения об управлении пользователями и именами для входа при копировании базы данных на другой сервер Базы данных SQL см. в статье [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).

## <a name="database-copy-errors"></a>Ошибки копирования базы данных

При копировании базы данных в базе данных SQL Azure могут возникнуть следующие ошибки. Дополнительные сведения см. в статье [Копирование базы данных SQL Azure](sql-database-copy.md).

| Код ошибки | Severity | Описание |
| ---:| ---:|:--- |
| 40635 |16 |Клиент с IP-адресом %.&#x2a;ls временно отключен. |
| 40637 |16 |Возможность создания копии базы данных в настоящее время отключена. |
| 40561 |16 |Не удалось скопировать базу данных. Исходная или целевая база данных не существует. |
| 40562 |16 |Не удалось скопировать базу данных. Исходная база данных удалена. |
| 40563 |16 |Не удалось скопировать базу данных. Целевая база данных удалена. |
| 40564 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40565 |16 |Не удалось скопировать базу данных. Допускается не более одной одновременной операции копирования базы данных из одного источника. Удалите целевую базу данных и повторите попытку позднее. |
| 40566 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40567 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку. |
| 40568 |16 |Не удалось скопировать базу данных. Исходная база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40569 |16 |Не удалось скопировать базу данных. Целевая база данных стала недоступна. Удалите целевую базу данных и повторите попытку. |
| 40570 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |
| 40571 |16 |Произошел сбой при копировании базы данных из-за внутренней ошибки. Удалите целевую базу данных и повторите попытку позднее. |

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об именах для входа см. в статьях [Предоставление доступа к базе данных и управление им](sql-database-manage-logins.md) и [Настройка безопасности базы данных SQL Azure и управление ею для геовосстановления или отработки отказа](sql-database-geo-replication-security-config.md).
- Для экспорта базы данных [см. Экспорт базы данных в BACPAC](sql-database-export.md).
