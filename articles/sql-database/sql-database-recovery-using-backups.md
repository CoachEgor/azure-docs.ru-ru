---
title: Восстановление базы данных SQL Azure из резервной копии | Документация Майкрософт
description: В этой статье описывается функция восстановления до точки во времени, позволяющая откатить базу данных SQL Azure до состояния на момент времени в прошлом (до 35 дней).
services: sql-database
ms.service: sql-database
ms.subservice: backup-restore
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
manager: craigg
ms.date: 04/30/2019
ms.openlocfilehash: 47bf59adb33f3685b31430c652b31880d383833e
ms.sourcegitcommit: d4dfbc34a1f03488e1b7bc5e711a11b72c717ada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/13/2019
ms.locfileid: "65232641"
---
# <a name="recover-an-azure-sql-database-using-automated-database-backups"></a>Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий

По умолчанию резервные копии базы данных SQL хранятся в геореплицированном хранилище BLOB-объектов (RA-GRS). При использовании функции [автоматически создаваемых резервных копий](sql-database-automated-backups.md) для восстановления базы данных, становятся доступны следующие параметры.

- Создание новой базы данных на том же сервере Базы данных SQL, восстановленной до указанной точки во времени в пределах срока хранения.
- Создание базы данных на том же сервере Базы данных SQL, восстановленной до момента удаления, если исходная база данных была удалена.
- Создание базы данных на любом сервере Базы данных SQL в том же регионе, восстановленной до точки во времени последней резервной копии.
- Создание базы данных на любом сервере Базы данных SQL в любом другом регионе, восстановленной до точки во времени последней реплицированной резервной копии.

Если вы настроили [резервной копии долгосрочного хранения](sql-database-long-term-retention.md), можно также создать новую базу данных из любой резервной копии LTR на любом сервере базы данных SQL.

> [!IMPORTANT]
> При восстановлении существующую базу данных невозможно перезаписать.

При использовании уровня служб Standard или Premium для восстановленной базы данных, взимается дополнительная оплата за хранилище при следующих условиях.

- Восстановление P11–P15 в S4–S12 или P1–P6, если максимальный размер базы данных превышает 500 ГБ.
- Восстановление P1–P6 в S4–S12, если максимальный размер базы данных превышает 250 ГБ.

Дополнительных затрат при icurred максимальный размер восстановленной базы данных превышает объем хранилища, включенных в целевую базу данных службы уровня и уровня производительности. Дополнительные хранилища, подготовленные сверх включенного объема, взимается дополнительная. Сведения о ценах на дополнительное хранилище см. на [странице цен на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/). Если фактический объем используемого пространства меньше, чем включенный объем хранилища, можно избежать этих дополнительных затрат, задав максимальный размер баз данных до включенного объема.

> [!NOTE]
> [Создаваемые автоматически резервные копии базы данных](sql-database-automated-backups.md) используются при создании [копии базы данных](sql-database-copy.md).

## <a name="recovery-time"></a>Время восстановления

На время восстановления базы данных с использованием создаваемых автоматически резервных копий влияет несколько факторов:

- размер базы данных;
- объем вычислительных ресурсов базы данных;
- число участвующих журналов транзакций;
- объем операций, которые требуется воспроизвести для восстановления до точки восстановления;
- пропускная способность сети, если выполняется восстановление в другой регион;
- количество одновременных запросов на восстановление, обрабатываемых в целевом регионе.

Большой и/или самые активные базы данных восстановление может занять несколько часов. В случае длительного простоя в регионе возможно появление большого количества запросов на геовосстановление, обрабатываемых другими регионами. Наличие большого числа запросов может увеличить время восстановления баз данных в соответствующем регионе. В большинстве случаев на восстановление базы данных требуется менее 12 часов.

Для одной подписки существуют ограничения на количество одновременных запросов на восстановление.  Эти ограничения применяются к любой комбинации моменту времени восстановления, географического восстановления и восстановления из копии долгосрочного хранения):

| | **Максимальное количество одновременно обрабатываемых запросов** | **Максимальное количество одновременно отправляемых запросов** |
| :--- | --: | --: |
|Отдельная база данных (на подписку)|10|60|
|Эластичный пул (на пул)|4\.|200|
||||

В настоящий момент отсутствует встроенный метод для восстановления всего сервера. Для примера выполнения этой задачи ознакомьтесь со скриптом в разделе [База данных SQL Azure: Полное восстановление сервера](https://gallery.technet.microsoft.com/Azure-SQL-Database-Full-82941666) сценарий является примером о выполнении этой задачи.

> [!IMPORTANT]
> Чтобы использовать восстановление с помощью автоматически создаваемых резервных копий, нужно быть участником роли "Участник SQL Server" в подписке или владельцем подписки. См. [RBAC для управления доступом на основе ролей в Azure](../role-based-access-control/built-in-roles.md). Выполнить восстановление можно с помощью портала Azure, PowerShell или REST API. Использовать для этого Transact-SQL невозможно.

## <a name="point-in-time-restore"></a>Восстановление до точки во времени

Можно восстановить отдельный пул, или экземпляр базы данных до предшествующей точки во времени с помощью портала Azure, [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase), или [REST API](https://docs.microsoft.com/rest/api/sql/databases). Запрос можно указать любой уровень служб или вычислить размер восстановленной базы данных. Убедитесь, что на сервере, в который выполняется восстановление базы данных, достаточно ресурсов. После завершения процесса новая база данных создается на том же сервере, где находится исходная база. Восстановленная база данных будет взиматься по обычным тарифам на основе его уровень служб и объем вычислений. Плата не взимается до завершения восстановления базы данных.

Обычно база данных восстанавливается до более ранней точки во времени. Можно рассматривать как замену исходной базы данных восстановленной базы данных или использовать его в качестве источника данных для обновления исходной базы данных.

- **Замена базы данных**

  Если Восстановленная база данных предназначена для замены исходной базы данных, следует указать объем вычислений базе orinal и уровень служб. Можно переименовать исходную базу данных и присвоить восстановленной базе данных исходное имя с помощью [ALTER DATABASE](/sql/t-sql/statements/alter-database-azure-sql-database) команду в T-SQL.

- **Восстановление данных**

  Если вы планируете извлечь данные из восстановленной базы данных для восстановления после ошибки пользователя или приложения, необходимо создать и выполнить сценарий восстановления данных, который извлекает данные из восстановленной базы данных и применяет к исходной базы данных. Несмотря на то, что операция восстановления может занять много времени, восстанавливаемая база данных будет отображаться в списке баз данных на протяжении всего процесса. При удалении базы данных во время восстановления, будут отменены операции восстановления, и вы не будет взиматься плата за которой не было завершено восстановление базы данных.

Чтобы восстановить отдельную базу данных, базу данных в составе пула или базу данных экземпляра до точки во времени с помощью портала Azure, откройте страницу для базы данных и щелкните **Восстановление** на панели инструментов.

![point-in-time-restore](./media/sql-database-recovery-using-backups/point-in-time-recovery.png)

> [!IMPORTANT]
> Чтобы восстановить базу данных из резервной копии программным образом, см. раздел [Программное восстановление с помощью создаваемых автоматически резервных копий](sql-database-recovery-using-backups.md#programmatically-performing-recovery-using-automated-backups).

## <a name="deleted-database-restore"></a>Восстановление удаленной базы данных

Можно восстановить удаленную базу данных к времени удаления или более ранней точки во времени на одном сервере базы данных SQL с помощью портала Azure, [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase), или [REST (createMode = Restore)](https://docs.microsoft.com/rest/api/sql/databases/createorupdate). Вы можете [восстановить удаленную базу данных в Управляемом экземпляре с помощью PowerShell](https://blogs.msdn.microsoft.com/sqlserverstorageengine/20../../recreate-dropped-database-on-azure-sql-managed-instance). 

> [!TIP]
> Пример сценария PowerShell, показывающий, как восстановить удаленную базу данных, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).
> [!IMPORTANT]
> При удалении экземпляра сервера Базы данных SQL Azure все базы данных, находившиеся на нем, также будут удалены без возможности восстановления. В настоящее время восстановление удаленного сервера не поддерживается.

### <a name="deleted-database-restore-using-the-azure-portal"></a>Восстановление удаленной базы данных на портале Azure

Чтобы восстановить удаленную базу данных с помощью портала Azure, откройте страницу сервера и области операций, нажмите кнопку **удаленных баз данных**.

![deleted-database-restore-1](./media/sql-database-recovery-using-backups/deleted-database-restore-1.png)

![deleted-database-restore-2](./media/sql-database-recovery-using-backups/deleted-database-restore-2.png)

> [!IMPORTANT]
> Чтобы восстановить удаленную базу данных программным образом, см. раздел [Программное восстановление с помощью создаваемых автоматически резервных копий](sql-database-recovery-using-backups.md#programmatically-performing-recovery-using-automated-backups).

## <a name="geo-restore"></a>Геовосстановление

Вы можете восстановить базу данных SQL на любой сервер в любом регионе Azure из последней геореплицированной резервной копии. Геовосстановление использует географически реплицированных резервную копию в качестве источника. Это можно выполнить, даже если база данных или центра обработки данных недоступны из-за сбоя.

Геовосстановление используется по умолчанию когда база данных недоступна из-за происшествия в регионе размещения. Можно восстановить базу данных на сервер в любом другом регионе. Между созданием резервной копии и ее георепликацией в большой двоичный объект Azure в другом регионе существует задержка. Таким образом Восстановленная база данных может быть до одного часа за orignal базы данных. На следующем рисунке показано восстановление базы данных из последней доступной резервной копии в другом регионе.

![Геовосстановление](./media/sql-database-geo-restore/geo-restore-2.png)

> [!TIP]
> Пример сценария PowerShell, показывающий, как выполнить геовосстановление, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).

Восстановление до точки во времени для базы данных-получателя геореплицируемых данных в настоящее время не поддерживается. Восстановление до точки во времени может выполняться только для базы данных-источника. Дополнительные сведения об использовании геовосстановления для восстановления после сбоя см. в статье [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](sql-database-disaster-recovery.md).

> [!IMPORTANT]
> Географическое восстановление — это самый простой решение аварийного восстановления в базе данных SQL. Он полагается на автоматически созданные геореплицированных резервных копий с RPO = 1 час и предполагаемое время восстановления до 12 часов. Он не гарантирует, что целевой регион будет иметь емкость для восстановления после регионального ourage к базам данных, поскольку резкие увеличения спроса будет скорее всего. Важные приложения не бизнеса, использовать относительно небольшие базы данных геовосстановление используется соответствующий аварийного восстановления. Для busniess важных приложений, использующих большие базы данных и необходимо обеспечить непрерывность бизнес-процессов, следует использовать [группы автоматической отработки отказа](sql-database-auto-failover-group.md). Он предлагает более низкие значения RPO и RTO, а емкость всегда гарантируется. Дополнительные сведения о непрерывности бизнес-процессов см. в [обзоре обеспечения непрерывности бизнес-процессов](sql-database-business-continuity.md).

### <a name="geo-restore-using-the-azure-portal"></a>Геовосстановление с помощью портала Azure

Чтобы выполнить геовосстановление базы данных в течение ее [срока хранения для модели на основе DTU](sql-database-service-tiers-dtu.md) или [срока хранения для модели на основе виртуальных ядер](sql-database-service-tiers-vcore.md) с помощью портала Azure, откройте страницу "Базы данных SQL" и щелкните **Добавить**. В текстовом поле **Выбрать источник** выберите **Резервная копия**. Укажите, из какой резервной копии будет выполняться восстановление в регионе и на сервере по своему усмотрению.

> [!Note]
> Геовосстановление с помощью портала Azure недоступна в управляемом экземпляре. Вместо этого используйте PowerShell.

## <a name="programmatically-performing-recovery-using-automated-backups"></a>Программное восстановление с помощью создаваемых автоматически резервных копий

Как уже говорилось ранее, в дополнение к порталу Azure восстановление базы данных можно выполнить программно, с помощью Azure PowerShell или REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но все будущие разработки — для модуля Az.Sql. Для этих командлетов см. в разделе [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле Az и в модуле AzureRm практически идентичны.

- Чтобы восстановить изолированном или из этих баз данных, см. в разделе [AzSqlDatabase восстановления](/powershell/module/az.sql/restore-azsqldatabase).

  | Командлет | ОПИСАНИЕ |
  | --- | --- |
  | [Get-AzSqlDatabase](/powershell/module/az.sql/get-azsqldatabase) |Получает одну или несколько баз данных. |
  | [Get-AzSqlDeletedDatabaseBackup](/powershell/module/az.sql/get-azsqldeleteddatabasebackup) | Получает удаленную базу данных, которую можно восстановить. |
  | [Get-AzSqlDatabaseGeoBackup](/powershell/module/az.sql/get-azsqldatabasegeobackup) |Получает геоизбыточную резервную копию базы данных. |
  | [Restore-AzSqlDatabase](/powershell/module/az.sql/restore-azsqldatabase) |Восстанавливает базу данных SQL. |

  > [!TIP]
  > Пример сценария PowerShell, показывающий, как выполнить восстановление базы данных до точки во времени, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).

- Чтобы восстановить управляемый экземпляр базы данных, см. в разделе [AzSqlInstanceDatabase восстановления](/powershell/module/az.sql/restore-azsqlinstancedatabase).

  | Командлет | ОПИСАНИЕ |
  | --- | --- |
  | [Get-AzSqlInstance](/powershell/module/az.sql/get-azsqlinstance) |Получает один или несколько управляемых экземпляров. |
  | [Get-AzSqlInstanceDatabase](/powershell/module/az.sql/get-azsqlinstancedatabase) | Получает экземпляр базы данных. |
  | [Restore-AzSqlInstanceDatabase](/powershell/module/az.sql/restore-azsqlinstancedatabase) |Восстановление базы данных экземпляра. |

### <a name="rest-api"></a>REST API

Восстановление отдельной базы данных или базы данных в пуле с помощью REST API:

| API | ОПИСАНИЕ |
| --- | --- |
| [REST (createMode=Recovery)](https://docs.microsoft.com/rest/api/sql/databases) |Восстанавливает базу данных. |
| [Получение, создание или обновление состояния базы данных](https://docs.microsoft.com/rest/api/sql/operations) |Возвращает состояние во время операции восстановления. |

### <a name="azure-cli"></a>Инфраструктура CLI Azure

- Для восстановления отдельной базы данных или базы данных в пуле с помощью Azure CLI см. описание команды [az sql db restore](/cli/azure/sql/db#az-sql-db-restore).
- Чтобы восстановить управляемого экземпляра с помощью Azure CLI, см. в разделе [восстановление midb az sql](/cli/azure/sql/midb#az-sql-midb-restore)

## <a name="summary"></a>Сводка

Создаваемые автоматически резервные копии позволяют защитить базы данных от ошибок пользователей и приложений, случайного удаления базы данных и длительных простоев. Эта встроенная возможность доступна для всех уровней служб и объемов вычислительных ресурсов.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).
- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь с разделом [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
- Дополнительные сведения см. в статье о [долгосрочном хранении](sql-database-long-term-retention.md).
- Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями об [активной георепликации](sql-database-active-geo-replication.md) и [группах автоматической отработки отказа](sql-database-auto-failover-group.md).
