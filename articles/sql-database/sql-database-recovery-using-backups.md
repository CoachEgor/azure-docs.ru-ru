---
title: Восстановление базы данных SQL Azure из резервной копии | Документация Майкрософт
description: В этой статье описывается функция восстановления до точки во времени, позволяющая откатить Базу данных Azure SQL до состояния на момент времени в прошлом (до 35 дней).
services: sql-database
ms.service: sql-database
ms.subservice: backup-restore
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
manager: craigg
ms.date: 03/12/2019
ms.openlocfilehash: ca54ae11390b388c3158bd220ee5c7829172a5c3
ms.sourcegitcommit: f8c592ebaad4a5fc45710dadc0e5c4480d122d6f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2019
ms.locfileid: "58620484"
---
# <a name="recover-an-azure-sql-database-using-automated-database-backups"></a>Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий

По умолчанию резервные копии базы данных SQL хранятся в геореплицированном хранилище BLOB-объектов (RA-GRS). При использовании функции [автоматически создаваемых резервных копий](sql-database-automated-backups.md) для восстановления базы данных, становятся доступны следующие параметры.

- Создание новой базы данных на том же сервере Базы данных SQL, восстановленной до указанной точки во времени в пределах срока хранения.
- Создание базы данных на том же сервере Базы данных SQL, восстановленной до момента удаления, если исходная база данных была удалена.
- Создание базы данных на любом сервере Базы данных SQL в том же регионе, восстановленной до точки во времени последней резервной копии.
- Создание базы данных на любом сервере Базы данных SQL в любом другом регионе, восстановленной до точки во времени последней реплицированной резервной копии.

После настройки [резервного копирования для длительного хранения](sql-database-long-term-retention.md) также можно использовать любую резервную копию LTR и любой сервер Базы данных SQL для создания новой базы данных в любом регионе.

> [!IMPORTANT]
> При восстановлении существующую базу данных невозможно перезаписать.

При использовании уровня служб Standard или Premium для восстановленной базы данных, взимается дополнительная оплата за хранилище при следующих условиях.

- Восстановление P11–P15 в S4–S12 или P1–P6, если максимальный размер базы данных превышает 500 ГБ.
- Восстановление P1–P6 в S4–S12, если максимальный размер базы данных превышает 250 ГБ.

Дополнительная плата связана с тем, что максимальный размер восстановленной базы данных превышает объем хранилища для объема вычислительных ресурсов. За все дополнительные ресурсы хранилища, подготовленные сверх включенного объема, взимается дополнительная плата. Сведения о ценах на дополнительное хранилище см. на [странице цен на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/). Если фактический объем пространства, которое используется, меньше, чем включенный объем хранилища, то этих дополнительных затрат можно избежать, уменьшив максимальный размер базы данных до включенного объема.

> [!NOTE]
> [Создаваемые автоматически резервные копии базы данных](sql-database-automated-backups.md) используются при создании [копии базы данных](sql-database-copy.md).

## <a name="recovery-time"></a>Время восстановления

На время восстановления базы данных с использованием создаваемых автоматически резервных копий влияет несколько факторов:

- размер базы данных;
- объем вычислительных ресурсов базы данных;
- число участвующих журналов транзакций;
- объем операций, которые требуется воспроизвести для восстановления до точки восстановления;
- пропускная способность сети, если выполняется восстановление в другой регион;
- количество одновременных запросов на восстановление, обрабатываемых в целевом регионе.

Восстановление очень большой и (или) активной базы данных может занять несколько часов. В случае длительного простоя в регионе возможно появление большого количества запросов на геовосстановление, обрабатываемых другими регионами. Наличие большого числа запросов может увеличить время восстановления баз данных в соответствующем регионе. В большинстве случаев на восстановление базы данных требуется менее 12 часов.

Для одной подписки действуют определенные ограничения на количество одновременных запросов на восстановление (восстановление до точки во времени, геовосстановление и восстановление из резервной копии долгосрочного хранения), которые могут быть отправлены и обработаны.

| | **Максимальное количество одновременно обрабатываемых запросов** | **Максимальное количество одновременно отправляемых запросов** |
| :--- | --: | --: |
|Отдельная база данных (на подписку)|10|60|
|Эластичный пул (на пул)|4.|200|
||||

Возможность массового восстановления встроенными средствами не предусмотрена. Для примера выполнения этой задачи ознакомьтесь со скриптом в разделе [База данных SQL Azure: полное восстановление сервера](https://gallery.technet.microsoft.com/Azure-SQL-Database-Full-82941666).

> [!IMPORTANT]
> Чтобы использовать восстановление с помощью автоматически создаваемых резервных копий, нужно быть участником роли "Участник SQL Server" в подписке или владельцем подписки. См. [RBAC для управления доступом на основе ролей в Azure](../role-based-access-control/built-in-roles.md). Выполнить восстановление можно с помощью портала Azure, PowerShell или REST API. Использовать для этого Transact-SQL невозможно.

## <a name="point-in-time-restore"></a>Восстановление до точки во времени

Вы можете восстановить автономную базу данных, базу данных в составе пула или базу данных экземпляра до предшествующей точки во времени как новую базу данных на том же сервере с помощью портала Azure, [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase) или [REST API](https://docs.microsoft.com/rest/api/sql/databases). Базу данных можно восстановить для любого уровня служб или объема вычислительных ресурсов. Убедитесь, что на сервере, в который выполняется восстановление базы данных, достаточно ресурсов. После завершения восстановленная вы получите обычную полностью доступную базу данных в сети. Использование восстановленной базы данных оплачивается по обычным тарифам на основе уровня служб и объема вычислительных ресурсов. Плата не взимается до завершения восстановления базы данных.

Обычно база данных восстанавливается до более ранней точки во времени. Таким образом восстановленную базу данных можно рассматривать как замену исходной базы данных или же использовать для извлечения данных, чтобы затем обновить исходную базу данных.

- **Замена базы данных**

  Если восстановленная база данных предназначена для замены исходной базы данных, то следует проверить, настроен ли для нее соответствующий объем вычислительных ресурсов и (или) уровень служб, и при необходимости масштабировать эту базу данных. Можно переименовать исходную базу данных, а затем присвоить восстановленной базе данных исходное имя с помощью команды [ALTER DATABASE](/sql/t-sql/statements/alter-database-azure-sql-database) в T-SQL.

- **Восстановление данных**

  Если вы планируете извлечь данные из восстановленной базы данных для восстановления после ошибки пользователя или приложения, то потребуется создать и выполнить сценарии восстановления данных, необходимые для извлечения данных из восстановленной базы данных в исходную. Несмотря на то, что операция восстановления может занять много времени, восстанавливаемая база данных будет отображаться в списке баз данных на протяжении всего процесса. Если удалить эту базу данных во время восстановления, то операция будет отменена и плата за базу данных, восстановление которой не было завершено, взиматься не будет.

Чтобы восстановить отдельную базу данных, базу данных в составе пула или базу данных экземпляра до точки во времени с помощью портала Azure, откройте страницу для базы данных и щелкните **Восстановление** на панели инструментов.

![point-in-time-restore](./media/sql-database-recovery-using-backups/point-in-time-recovery.png)

> [!IMPORTANT]
> Чтобы восстановить базу данных из резервной копии программным образом, см. раздел [Программное восстановление с помощью создаваемых автоматически резервных копий](sql-database-recovery-using-backups.md#programmatically-performing-recovery-using-automated-backups).

## <a name="deleted-database-restore"></a>Восстановление удаленной базы данных

Вы можете восстановить удаленную базу данных до момента удаления на том же сервере Базы данных SQL с помощью портала Azure, [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase) или [REST (createMode=Restore)](https://docs.microsoft.com/rest/api/sql/databases/createorupdate). Вы можете [восстановить удаленную базу данных в Управляемом экземпляре с помощью PowerShell](https://blogs.msdn.microsoft.com/sqlserverstorageengine/20../../recreate-dropped-database-on-azure-sql-managed-instance). Удаленную базу данных можно восстановить до предшествующей точки во времени при хранении с помощью [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase).

> [!TIP]
> Пример сценария PowerShell, показывающий, как восстановить удаленную базу данных, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).
> [!IMPORTANT]
> При удалении экземпляра сервера Базы данных SQL Azure все базы данных, находившиеся на нем, также будут удалены без возможности восстановления. В настоящее время восстановление удаленного сервера не поддерживается.

### <a name="deleted-database-restore-using-the-azure-portal"></a>Восстановление удаленной базы данных на портале Azure

Чтобы восстановить удаленную базу данных в течение [срока хранения для модели на основе DTU](sql-database-service-tiers-dtu.md) или [срока хранения для модели на основе виртуальных ядер](sql-database-service-tiers-vcore.md) с помощью портала Azure, откройте страницу сервера и в области операций щелкните **Удаленные базы данных**.

![deleted-database-restore-1](./media/sql-database-recovery-using-backups/deleted-database-restore-1.png)

![deleted-database-restore-2](./media/sql-database-recovery-using-backups/deleted-database-restore-2.png)

> [!IMPORTANT]
> Чтобы восстановить удаленную базу данных программным образом, см. раздел [Программное восстановление с помощью создаваемых автоматически резервных копий](sql-database-recovery-using-backups.md#programmatically-performing-recovery-using-automated-backups).

## <a name="geo-restore"></a>Геовосстановление

Вы можете восстановить базу данных SQL на любой сервер в любом регионе Azure из последней геореплицированной резервной копии. В качестве источника геовосстановление использует геоизбыточную резервную копию для восстановления базы данных, даже если она или центр обработки данных недоступны из-за сбоя.

Геовосстановление используется по умолчанию, когда база данных недоступна из-за происшествия в регионе, в котором она размещена. Если масштабная авария в регионе приведет к недоступности приложения базы данных, то базу данных можно будет восстановить из геореплицированных резервных копий на сервер в любом другом регионе. Между созданием резервной копии и ее георепликацией в большой двоичный объект Azure в другом регионе существует задержка. Эта задержка может длиться до часа, поэтому в случае аварии возможна потеря данных за час или менее. На следующем рисунке показано восстановление базы данных из последней доступной резервной копии в другом регионе.

![Геовосстановление](./media/sql-database-geo-restore/geo-restore-2.png)

> [!TIP]
> Пример сценария PowerShell, показывающий, как выполнить геовосстановление, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).

Восстановление до точки во времени для базы данных-получателя геореплицируемых данных в настоящее время не поддерживается. Восстановление до точки во времени может выполняться только для базы данных-источника. Дополнительные сведения об использовании геовосстановления для восстановления после сбоя см. в статье [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](sql-database-disaster-recovery.md).

> [!IMPORTANT]
> Восстановление из резервных копий — это наиболее простое из решений аварийного восстановления, доступных в Базе данных SQL, с наибольшими значениями целевой точки восстановления (RPO) и предполагаемого времени восстановления (ERT). Для решений с небольшими базами данных (например, на уровне служб "Базовый" или для небольших баз данных клиентов в эластичных пулах) часто целесообразным решением аварийного восстановления является геовосстановление с периодом ERT до 12 часов (обычно он значительно меньше). В решениях, использующих большие базы данных, и для которых нужно минимизировать время восстановления, мы рекомендуем использовать [активную георепликацию](sql-database-active-geo-replication.md) и [группы автоматической отработки отказа](sql-database-auto-failover-group.md). Активная георепликация обеспечивает более низкие значения RPO и ERT, так как требует только инициировать отработку отказа для перехода на непрерывно реплицируемую базу данных-получатель. Группы автоматической отработки отказа обеспечивают соответствующую отработку для группы баз данных. Дополнительные сведения о непрерывности бизнес-процессов см. в [обзоре обеспечения непрерывности бизнес-процессов](sql-database-business-continuity.md).

### <a name="geo-restore-using-the-azure-portal"></a>Геовосстановление с помощью портала Azure

Чтобы выполнить геовосстановление базы данных в течение ее [срока хранения для модели на основе DTU](sql-database-service-tiers-dtu.md) или [срока хранения для модели на основе виртуальных ядер](sql-database-service-tiers-vcore.md) с помощью портала Azure, откройте страницу "Базы данных SQL" и щелкните **Добавить**. В текстовом поле **Выбрать источник** выберите **Резервная копия**. Укажите, из какой резервной копии будет выполняться восстановление в регионе и на сервере по своему усмотрению.

> [!Note]
> Геовосстановление с помощью портала Azure недоступна в управляемом экземпляре. Вместо этого используйте PowerShell.

## <a name="programmatically-performing-recovery-using-automated-backups"></a>Программное восстановление с помощью создаваемых автоматически резервных копий

Как уже говорилось ранее, в дополнение к порталу Azure восстановление базы данных можно выполнить программно, с помощью Azure PowerShell или REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но все будущие разработки — для модуля Az.Sql. Для этих командлетов см. в разделе [AzureRM.Sql](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле Az и в модуле AzureRm практически идентичны.

- Чтобы восстановить изолированном или из этих баз данных, см. в разделе [AzSqlDatabase восстановления](/powershell/module/az.sql/restore-azsqldatabase).

  | Командлет | ОПИСАНИЕ |
  | --- | --- |
  | [Get-AzSqlDatabase](/powershell/module/az.sql/get-azsqldatabase) |Получает одну или несколько баз данных. |
  | [Get-AzSqlDeletedDatabaseBackup](/powershell/module/az.sql/get-azsqldeleteddatabasebackup) | Получает удаленную базу данных, которую можно восстановить. |
  | [Get-AzSqlDatabaseGeoBackup](/powershell/module/az.sql/get-azsqldatabasegeobackup) |Получает геоизбыточную резервную копию базы данных. |
  | [Restore-AzSqlDatabase](/powershell/module/az.sql/restore-azsqldatabase) |Восстанавливает базу данных SQL. |

  > [!TIP]
  > Пример сценария PowerShell, показывающий, как выполнить восстановление базы данных до точки во времени, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).

- Чтобы восстановить управляемый экземпляр базы данных, см. в разделе [AzSqlInstanceDatabase восстановления](/powershell/module/az.sql/restore-azsqlinstancedatabase).

  | Командлет | ОПИСАНИЕ |
  | --- | --- |
  | [Get-AzSqlInstance](/powershell/module/az.sql/get-azsqlinstance) |Получает один или несколько управляемых экземпляров. |
  | [Get-AzSqlInstanceDatabase](/powershell/module/az.sql/get-azsqlinstancedatabase) | Получает экземпляр базы данных. |
  | [Restore-AzSqlInstanceDatabase](/powershell/module/az.sql/restore-azsqlinstancedatabase) |Восстановление базы данных экземпляра. |

### <a name="rest-api"></a>REST API

Восстановление отдельной базы данных или базы данных в пуле с помощью REST API:

| API | ОПИСАНИЕ |
| --- | --- |
| [REST (createMode=Recovery)](https://docs.microsoft.com/rest/api/sql/databases) |Восстанавливает базу данных. |
| [Получение, создание или обновление состояния базы данных](https://docs.microsoft.com/rest/api/sql/operations) |Возвращает состояние во время операции восстановления. |

### <a name="azure-cli"></a>Инфраструктура CLI Azure

- Для восстановления отдельной базы данных или базы данных в пуле с помощью Azure CLI см. описание команды [az sql db restore](/cli/azure/sql/db#az-sql-db-restore).
- Чтобы восстановить управляемого экземпляра с помощью Azure CLI, см. в разделе [восстановление midb az sql](/cli/azure/sql/midb#az-sql-midb-restore)

## <a name="summary"></a>Сводка

Создаваемые автоматически резервные копии позволяют защитить базы данных от ошибок пользователей и приложений, случайного удаления базы данных и длительных простоев. Эта встроенная возможность доступна для всех уровней служб и объемов вычислительных ресурсов.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).
- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
- Дополнительные сведения см. в статье о [долгосрочном хранении](sql-database-long-term-retention.md).
- Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями об [активной георепликации](sql-database-active-geo-replication.md) и [группах автоматической отработки отказа](sql-database-auto-failover-group.md).
