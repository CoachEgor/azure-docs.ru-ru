---
title: Восстановление базы данных SQL Azure из резервной копии | Документация Майкрософт
description: В этой статье описывается функция восстановления до точки во времени, позволяющая откатить базу данных SQL Azure до состояния на момент времени в прошлом (до 35 дней).
services: sql-database
ms.service: sql-database
ms.subservice: backup-restore
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
ms.date: 08/27/2019
ms.openlocfilehash: ab0a622dcb72072621e6696d423a1d4d2917bedc
ms.sourcegitcommit: 83df2aed7cafb493b36d93b1699d24f36c1daa45
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2019
ms.locfileid: "71178368"
---
# <a name="recover-an-azure-sql-database-using-automated-database-backups"></a>Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий

По умолчанию резервные копии базы данных SQL хранятся в геореплицированном хранилище BLOB-объектов (RA-GRS). При использовании функции [автоматически создаваемых резервных копий](sql-database-automated-backups.md) для восстановления базы данных, становятся доступны следующие параметры.

- Создание новой базы данных на том же сервере Базы данных SQL, восстановленной до указанной точки во времени в пределах срока хранения.
- Создание базы данных на том же сервере Базы данных SQL, восстановленной до момента удаления, если исходная база данных была удалена.
- Создание базы данных на любом сервере Базы данных SQL в том же регионе, восстановленной до точки во времени последней резервной копии.
- Создание базы данных на любом сервере Базы данных SQL в любом другом регионе, восстановленной до точки во времени последней реплицированной резервной копии.

Если вы настроили [долгосрочное хранение резервных копий](sql-database-long-term-retention.md), можно также создать новую базу данных из любой резервной копии на основе LTR на любом сервере базы данных SQL.

> [!IMPORTANT]
> При восстановлении существующую базу данных невозможно перезаписать.

При использовании уровня служб Standard или Premium для восстановленной базы данных, взимается дополнительная оплата за хранилище при следующих условиях.

- Восстановление P11–P15 в S4–S12 или P1–P6, если максимальный размер базы данных превышает 500 ГБ.
- Восстановление P1–P6 в S4–S12, если максимальный размер базы данных превышает 250 ГБ.

Дополнительные затраты происходят, когда максимальный размер восстанавливаемой базы данных превышает объем хранилища, включенный в уровень служб и производительности целевой базы данных. Дополнительная память, подготовленная выше включенного объема, начислена бесплатно. Сведения о ценах на дополнительное хранилище см. на [странице цен на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/). Если фактический объем используемого пространства меньше, чем Включенный объем хранилища, можно избежать этой дополнительной платы, установив для максимального размера базы данных Включенный объем.

> [!NOTE]
> [Создаваемые автоматически резервные копии базы данных](sql-database-automated-backups.md) используются при создании [копии базы данных](sql-database-copy.md).

## <a name="recovery-time"></a>Время восстановления

На время восстановления базы данных с использованием создаваемых автоматически резервных копий влияет несколько факторов:

- размер базы данных;
- объем вычислительных ресурсов базы данных;
- число участвующих журналов транзакций;
- объем операций, которые требуется воспроизвести для восстановления до точки восстановления;
- пропускная способность сети, если выполняется восстановление в другой регион;
- количество одновременных запросов на восстановление, обрабатываемых в целевом регионе.

Для больших и очень активных баз данных восстановление может занять несколько часов. В случае длительного простоя в регионе возможно появление большого количества запросов на геовосстановление, обрабатываемых другими регионами. Наличие большого числа запросов может увеличить время восстановления баз данных в соответствующем регионе. В большинстве случаев на восстановление базы данных требуется менее 12 часов.

Для одной подписки существуют ограничения на количество одновременных запросов на восстановление.  Эти ограничения применяются к любому сочетанию восстановления на момент времени, георепликации и восстановления из резервной копии долгосрочного хранения.

| | **Максимальное количество одновременно обрабатываемых запросов** | **Максимальное количество одновременно отправляемых запросов** |
| :--- | --: | --: |
|Отдельная база данных (на подписку)|10|60|
|Эластичный пул (на пул)|4|200|
||||

В настоящее время нет встроенного метода для восстановления всего сервера. Для примера выполнения этой задачи ознакомьтесь со скриптом в разделе [База данных SQL Azure: Сценарий полного восстановления](https://gallery.technet.microsoft.com/Azure-SQL-Database-Full-82941666) сервера — это пример того, как можно выполнить эту задачу.

> [!IMPORTANT]
> Чтобы использовать восстановление с помощью автоматически создаваемых резервных копий, нужно быть участником роли "Участник SQL Server" в подписке или владельцем подписки. См. [RBAC для управления доступом на основе ролей в Azure](../role-based-access-control/built-in-roles.md). Можно выполнить восстановление с помощью портал Azure, PowerShell или REST API. Использовать для этого Transact-SQL невозможно.

## <a name="point-in-time-restore"></a>Восстановление до точки во времени

Вы можете восстановить автономную базу данных, в составе которой был создан пул или экземпляр, до более ранней точки во времени с помощью портал Azure, [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase)или [REST API](https://docs.microsoft.com/rest/api/sql/databases). Запрос может указывать любой уровень служб или размер вычислений для восстанавливаемой базы данных. Убедитесь, что на сервере, в который выполняется восстановление базы данных, достаточно ресурсов. После завершения будет создана новая база данных на том же сервере, что и исходная база данных. Стоимость восстановленной базы данных будет взиматься по нормальным тарифам в зависимости от уровня служб и размера вычислений. Плата не взимается до завершения восстановления базы данных.

Обычно база данных восстанавливается до более ранней точки во времени. Восстановленную базу данных можно считать заменой исходной базы данных или использовать ее в качестве источника данных для обновления исходной базы данных.

- **Замена базы данных**

  Если восстановленная база данных предназначена для замены исходной базы данных, следует указать размер вычислений и уровень служб исходной базы данных. Затем можно переименовать исходную базу данных и присвоить восстановленной базе данных исходное имя с помощью команды [ALTER DATABASE](/sql/t-sql/statements/alter-database-azure-sql-database) в T-SQL.

- **Восстановление данных**

  Если планируется получение данных из восстановленной базы данных для восстановления после ошибки пользователя или приложения, необходимо написать и выполнить сценарий восстановления данных, который извлекает данные из восстановленной базы данных и применяется к исходной базе данных. Несмотря на то, что операция восстановления может занять много времени, восстанавливаемая база данных будет отображаться в списке баз данных на протяжении всего процесса. Если удалить базу данных во время восстановления, операция восстановления будет отменена, и не будет взиматься дополнительная стоимость базы данных, которая не выполнила восстановление.

Чтобы восстановить отдельную базу данных с пулом или экземпляром на момент времени с помощью портал Azure, откройте страницу базы данных и нажмите кнопку **восстановить** на панели инструментов.

![point-in-time-restore](./media/sql-database-recovery-using-backups/point-in-time-recovery.png)

> [!IMPORTANT]
> Чтобы восстановить базу данных из резервной копии программным образом, см. раздел [Программное восстановление с помощью создаваемых автоматически резервных копий](sql-database-recovery-using-backups.md#programmatically-performing-recovery-using-automated-backups).

## <a name="deleted-database-restore"></a>Восстановление удаленной базы данных

Можно восстановить удаленную базу данных до времени удаления или более ранней точки во времени на том же сервере базы данных SQL, используя портал Azure, [PowerShell](https://docs.microsoft.com/powershell/module/az.sql/restore-azsqldatabase)или [остальные (CreateMode = Restore)](https://docs.microsoft.com/rest/api/sql/databases/createorupdate). Вы можете [восстановить удаленную базу данных в Управляемом экземпляре с помощью PowerShell](https://blogs.msdn.microsoft.com/sqlserverstorageengine/20../../recreate-dropped-database-on-azure-sql-managed-instance). 

> [!TIP]
> Пример сценария PowerShell, показывающий, как восстановить удаленную базу данных, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).
> [!IMPORTANT]
> При удалении экземпляра сервера Базы данных SQL Azure все базы данных, находившиеся на нем, также будут удалены без возможности восстановления. В настоящее время восстановление удаленного сервера не поддерживается.

### <a name="deleted-database-restore-using-the-azure-portal"></a>Восстановление удаленной базы данных на портале Azure

Чтобы восстановить удаленную базу данных с помощью портал Azure, откройте страницу сервера и в области операции щелкните **Удаленные базы данных**.

![deleted-database-restore-1](./media/sql-database-recovery-using-backups/deleted-database-restore-1.png)

![deleted-database-restore-2](./media/sql-database-recovery-using-backups/deleted-database-restore-2.png)

> [!IMPORTANT]
> Чтобы восстановить удаленную базу данных программным образом, см. раздел [Программное восстановление с помощью создаваемых автоматически резервных копий](sql-database-recovery-using-backups.md#programmatically-performing-recovery-using-automated-backups).

## <a name="geo-restore"></a>Геовосстановление

Вы можете восстановить базу данных SQL на любой сервер в любом регионе Azure из последней геореплицированной резервной копии. При геовосстановлении используется геореплицированная резервная копия в качестве источника. Его можно запросить даже в том случае, если база данных или Datacenter недоступны из-за сбоя.

Геовосстановление является параметром восстановления по умолчанию, если база данных недоступна из-за инцидента в регионе размещения. Базу данных можно восстановить на сервере в любом другом регионе. Между созданием резервной копии и ее георепликацией в большой двоичный объект Azure в другом регионе существует задержка. В результате восстановленная база данных может иметь один час за исходной базой данных. На следующем рисунке показано восстановление базы данных из последней доступной резервной копии в другом регионе.

![Геовосстановление](./media/sql-database-geo-restore/geo-restore-2.png)

### <a name="geo-restore-using-azure-portal"></a>Геовосстановление с помощью портал Azure

Общая концепция географического восстановления базы данных из портал Azure выполняется путем создания новой базы данных с одним или управляемым экземпляром и выбора доступной резервной копии геовосстановления на экране создания базы данных. Только что созданная база данных будет содержать данные геовосстановленной резервной копии.

#### <a name="single-azure-sql-database"></a>Отдельная база данных SQL Azure

Чтобы выполнить геовосстановление отдельной базы данных SQL Azure из портал Azure в выбранном регионе и сервере, выполните следующие действия.

1. Щелкните Добавить **+ Добавить** в Marketplace и выберите **создать базу данных SQL**, заполните необходимые сведения на **вкладке "основы"** .
2. Выберите вкладку **Дополнительные параметры** .
3. В разделе "использовать существующие данные" щелкните " **резервное копирование** "
4. Выберите резервную копию из раскрывающегося списка доступных резервных копий географического восстановления.

![географическое восстановление отдельной базы данных SQL Azure](./media/sql-database-recovery-using-backups/geo-restore-azure-sql-database-list-annotated.png)

Завершите процесс создания новой базы данных. После создания отдельной базы данных SQL Azure она будет содержать восстановленную резервную копию геовосстановления.

#### <a name="managed-instance-database"></a>База данных управляемого экземпляра

Для геовосстановления базы данных управляемого экземпляра из портал Azure в существующий управляемый экземпляр в выбранном регионе выберите управляемый экземпляр, на котором нужно восстановить базу данных, и выполните следующие действия.

1. Щелкните **+ Новая база данных** .
2. Введите имя нужной базы данных
3. В разделе использовать существующие данные выберите вариант **резервное копирование**
4. Выберите резервную копию из раскрывающегося списка доступных резервных копий географического восстановления.

![географическое восстановление базы данных управляемого экземпляра](./media/sql-database-recovery-using-backups/geo-restore-sql-managed-instance-list-annotated.png)

Завершите процесс создания новой базы данных. После создания базы данных экземпляра она будет содержать восстановленную резервную копию геовосстановления.

### <a name="geo-restore-using-powershell"></a>Геовосстановление с помощью PowerShell

#### <a name="single-azure-sql-database"></a>Отдельная база данных SQL Azure

Сведения о том, как выполнить геовосстановление для отдельной базы данных SQL Azure, см. в статье [Использование PowerShell для восстановления одной базы данных SQL Azure до более ранней точки во времени](scripts/sql-database-restore-database-powershell.md).

#### <a name="managed-instance-database"></a>База данных управляемого экземпляра

Сведения о том, как выполнить геовосстановление для базы данных управляемого экземпляра с помощью сценария PowerShell, см. в статье [Использование PowerShell для восстановления базы данных управляемый экземпляр в другом географическом регионе](scripts/sql-managed-instance-restore-geo-backup.md).

### <a name="geo-restore-considerations"></a>Рекомендации относительно географического восстановления

Восстановление до точки во времени для базы данных-получателя геореплицируемых данных в настоящее время не поддерживается. Восстановление до точки во времени может выполняться только для базы данных-источника. Дополнительные сведения об использовании геовосстановления для восстановления после сбоя см. в статье [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](sql-database-disaster-recovery.md).

> [!IMPORTANT]
> Геовосстановление — это базовое решение для аварийного восстановления, доступное в базе данных SQL. Он использует автоматически созданные геореплицированные резервные копии с RPO = 1 час и оценочное время восстановления до 12 часов. Это не гарантирует, что целевой регион будет иметь емкость для восстановления ваших баз данных после региональных аураже, так как, скорее всего, будет очень легко увеличить спрос. Для приложения, не являющегося критическим для бизнеса и использующих сравнительно небольшие базы данных, геовосстановление является подходящим решением для аварийного восстановления. Для критически важных для бизнеса приложений, использующих большие базы данных и обеспечивающих непрерывность бизнес-процессов, следует использовать [группы автоматической отработки отказа](sql-database-auto-failover-group.md). Он предлагает более низкие значения RPO и RTO, и емкость всегда гарантирована. Дополнительные сведения о непрерывности бизнес-процессов см. в [обзоре обеспечения непрерывности бизнес-процессов](sql-database-business-continuity.md).

## <a name="programmatically-performing-recovery-using-automated-backups"></a>Программное восстановление с помощью создаваемых автоматически резервных копий

Как уже говорилось, в дополнение к портал Azure восстановление базы данных можно выполнить программно с помощью Azure PowerShell или REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка предназначена для модуля AZ. SQL. Эти командлеты см. в разделе [AzureRM. SQL](https://docs.microsoft.com/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле AZ и в модулях AzureRm существенно идентичны.

- Сведения о восстановлении изолированной базы данных или в составе пула см. в разделе [RESTORE-азсклдатабасе](/powershell/module/az.sql/restore-azsqldatabase).

  | Командлет | Описание |
  | --- | --- |
  | [Get-AzSqlDatabase](/powershell/module/az.sql/get-azsqldatabase) |Получает одну или несколько баз данных. |
  | [Get-AzSqlDeletedDatabaseBackup](/powershell/module/az.sql/get-azsqldeleteddatabasebackup) | Получает удаленную базу данных, которую можно восстановить. |
  | [Get-AzSqlDatabaseGeoBackup](/powershell/module/az.sql/get-azsqldatabasegeobackup) |Получает геоизбыточную резервную копию базы данных. |
  | [Restore-AzSqlDatabase](/powershell/module/az.sql/restore-azsqldatabase) |Восстанавливает базу данных SQL. |

  > [!TIP]
  > Пример сценария PowerShell, показывающий, как выполнить восстановление базы данных до точки во времени, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).

- Сведения о восстановлении базы данных Управляемый экземпляр см. в разделе [RESTORE-азсклинстанцедатабасе](/powershell/module/az.sql/restore-azsqlinstancedatabase).

  | Командлет | Описание |
  | --- | --- |
  | [Get-AzSqlInstance](/powershell/module/az.sql/get-azsqlinstance) |Возвращает один или несколько управляемых экземпляров. |
  | [Get-Азсклинстанцедатабасе](/powershell/module/az.sql/get-azsqlinstancedatabase) | Возвращает базы данных экземпляра. |
  | [Restore-AzSqlInstanceDatabase](/powershell/module/az.sql/restore-azsqlinstancedatabase) |Восстанавливает базу данных экземпляра. |

### <a name="rest-api"></a>REST API

Восстановление отдельной базы данных или базы данных в пуле с помощью REST API:

| API | Описание |
| --- | --- |
| [REST (createMode=Recovery)](https://docs.microsoft.com/rest/api/sql/databases) |Восстанавливает базу данных. |
| [Получение, создание или обновление состояния базы данных](https://docs.microsoft.com/rest/api/sql/operations) |Возвращает состояние во время операции восстановления. |

### <a name="azure-cli"></a>Azure CLI

- Для восстановления отдельной базы данных или базы данных в пуле с помощью Azure CLI см. описание команды [az sql db restore](/cli/azure/sql/db#az-sql-db-restore).
- Инструкции по восстановлению управляемого экземпляра с помощью Azure CLI см. в разделе [AZ SQL функция MidB Restore](/cli/azure/sql/midb#az-sql-midb-restore)

## <a name="summary"></a>Сводка

Создаваемые автоматически резервные копии позволяют защитить базы данных от ошибок пользователей и приложений, случайного удаления базы данных и длительных простоев. Эта встроенная возможность доступна для всех уровней служб и объемов вычислительных ресурсов.

## <a name="next-steps"></a>Следующие шаги

- Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).
- Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь с разделом [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
- Дополнительные сведения см. в статье о [долгосрочном хранении](sql-database-long-term-retention.md).
- Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями об [активной георепликации](sql-database-active-geo-replication.md) и [группах автоматической отработки отказа](sql-database-auto-failover-group.md).
