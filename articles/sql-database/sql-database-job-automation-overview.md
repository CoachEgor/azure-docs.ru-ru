---
title: Служба автоматизации заданий SQL Azure | Документация Майкрософт
description: Запуск скриптов Transact-SQL (T-SQL) в наборе из одной или нескольких баз данных SQL Azure с помощью службы автоматизации заданий
services: sql-database
ms.service: sql-database
ms.custom: ''
ms.devlang: ''
ms.topic: overview
author: jovanpop-msft
ms.author: jovanpop
ms.reviewer: carlr
manager: craigg
ms.date: 01/25/2019
ms.openlocfilehash: 4e80bbc868376a41212d924bd31df6ac70a52ded
ms.sourcegitcommit: 5839af386c5a2ad46aaaeb90a13065ef94e61e74
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2019
ms.locfileid: "57901973"
---
# <a name="automate-management-tasks-using-database-jobs"></a>Автоматизация задач управления с помощью заданий базы данных

База данных SQL Azure позволяет создавать и добавлять в расписание задачи, которые могут периодически выполняться по отношению к одной или нескольким базам данных для выполнения запросов T-SQL и задач по обслуживанию. Каждое задание регистрирует состояние выполнения и автоматически пытается повторить выполнение операции при возникновении сбоев.
Вы можете определить целевую базу данных или группы баз данных SQL Azure, в которых будет выполняться задание, а также определить расписания для запуска задания.
Задание выполняет задачу входа в целевую базу данных. Вы также можете определять, поддерживать и сохранять сценарии Transact-SQL, которые могут выполняться в группе баз данных SQL Azure.

## <a name="when-to-use-automated-jobs"></a>Когда следует использовать автоматизированные задания

Существует несколько сценариев, в которых можно использовать задание службы автоматизации:

- Автоматизация задач управления и их добавление в расписание для запуска каждый рабочий день, в нерабочие часы и т. д.
  - Развертывание изменений схемы, учетных данных, сбора данных о производительности или телеметрии клиента.
  - Обновление эталонных данных (например, сведений о продукте, которые являются общими для всех баз данных), загрузка данных из хранилища BLOB-объектов Azure.
  - Перестроение индексов для повышения скорости обработки запросов. Настройка заданий для выполнения в коллекции баз данных на постоянной основе, например в часы наименьшей нагрузки.
  - Собирайте результаты запросов из набора баз данных в центральную таблицу на постоянной основе. Запросы производительности могут выполняться непрерывно и вызывать дополнительные задачи.
- Сбор данных для отчетов
  - Сбор данных из семейства баз данных SQL Azure в одну целевую таблицу.
  - Выполняйте запросы обработки данных с повышенным временем выполнения для большого набора баз данных, например коллекции телеметрии клиентов. Результаты собираются в одну целевую таблицу для дальнейшего анализа.
- Перемещения данных
  - Создание заданий, которые реплицируют изменения, внесенные в базах данных, в другие базы данных, или собирают обновления, выполняемые в удаленных базах данных, и применяют изменения в базе данных.
  - Создание заданий, загружающих данные в базы данных и обратно, с помощью SQL Server Integration Services (SSIS).

## <a name="overview"></a>Обзор

В Базе данных SQL Azure доступны следующие технологии планирования заданий.

- **Задания агента SQL** — классический и проверенный компонент планирования заданий SQL Server, доступный в Управляемом экземпляре. Задания агента SQL недоступны в отдельных базах данных.
- **Задания эластичной базы данных** — служба планирования заданий, выполняющая пользовательские задания для одной или нескольких Баз данных SQL Azure.

Стоит отметить пару различий между агентом SQL (доступным как локально, так и как часть Управляемого экземпляра Базы данных SQL) и агентом заданий обработки эластичных баз данных (доступным для отдельных баз данных в Базе данных SQL Azure и для баз данных в Хранилище данных SQL).

|  |Задания обработки эластичных баз данных  |Агент SQL |
|---------|---------|---------|
|Область     |  Любое количество баз данных Azure SQL и/или хранилищ данных в том же облаке Azure, где расположен агент заданий. Целевые базы данных могут находиться на разных серверах Базы данных SQL, в разных подписках и (или) регионах. <br><br>Целевые группы могут состоять из отдельных баз данных или хранилищ данных или всех баз данных на сервере, в пуле или shardmap (динамически перечисляемых во время выполнения задания). | Любая отдельная база данных в том же экземпляре SQL Server, что и агент SQL. |
|Поддерживаемые API-интерфейсы и средства     |  Портал, PowerShell, T-SQL, Azure Resource Manager      |   T-SQL, SQL Server Management Studio (SSMS)     |

## <a name="sql-agent-jobs"></a>Задания агента SQL

Задания агента SQL — указанный ряд сценариев T-SQL в базе данных. Используйте задания, чтобы определить задачу администрирования, которую можно запустить один или несколько раз и отслеживать ее успешное выполнение или сбой.
Задание может выполняться на одном локальном или на нескольких удаленных серверах. Задание агента SQL является внутренним компонентом ядра СУБД, выполняемым в службе Управляемого экземпляра.
В заданиях агента SQL существует несколько ключевых концепций:

- Набор **шагов задания**, состоящий из одного или нескольких шагов, которые должны выполняться в рамках задания. Для каждого шага задания вы можете определить стратегию повторов и действие, которое должно произойти, если шаг задания завершился успешно или с ошибкой.
- **Расписания** определяют, когда должно выполняться задание.
- **Уведомления** позволяют определять правила, которые будут использоваться для уведомления операторов через сообщения электронной почты по завершении задания.

### <a name="job-steps"></a>Шаги задания

Шаги задания агента SQL — это последовательности действий, которые должны выполняться агентом SQL. После каждого шага предусмотрен следующий шаг, который должен выполняться, если предыдущий шаг выполнен успешно или неуспешно, а также если было предпринято определенное количество попыток повторного выполнения в случае сбоя.
Агент SQL позволяет создавать различные типы шагов задания, например, шаг задания Transact-SQL, выполняющий один пакет Transact-SQL для базы данных, или шаги команды ОС или PowerShell, которые могут выполнять пользовательский сценарий ОС, шаги задания SSIS, позволяющие загружать данные с помощью среды выполнения SSIS, или шаги [репликации](sql-database-managed-instance-transactional-replication.md), которые могут публиковать изменения вашей базы данных в других базах данных.

[Репликация транзакций](sql-database-managed-instance-transactional-replication.md) является компонентом ядра СУБД, дающим возможность публиковать изменения, внесенные в одной или нескольких таблицах, в одной базе данных, и публиковать или передать их в набор баз данных подписчиков. Публикация изменений реализуется с помощью следующих типов шагов задания агента SQL:

- Читатель журнала транзакций.
- Моментальный снимок.
- Распространитель.

Другие типы шагов заданий пока не поддерживаются, включая:

- Шаг задания репликации слиянием не поддерживается.
- Читатель очереди пока не поддерживается.
- Analysis Services не поддерживаются.

### <a name="job-schedules"></a>Расписания заданий

Расписание определяет время выполнения задания. Несколько заданий могут выполняться по тому же расписанию, а несколько расписаний могут применяться для одного задания.
Расписание может определить следующие условия для времени выполнения задания:

- При каждом перезапуске экземпляра (или при запуске агента SQL Server). Задание активируется после каждой отработки отказа.
- Один раз в определенную дату и время, что удобно для некоторых заданий, выполнение которых необходимо отложить.
- Для повторяющегося расписания.

> [!Note]
> Сейчас Управляемый экземпляр не позволяет запустить задание, если экземпляр не выполняется.

### <a name="job-notifications"></a>Уведомления заданий

Задания агента SQL позволяют получать уведомления при успешном завершении задания и в случае возникновения ошибки. Вы можете получать уведомления в сообщениях электронной почты.

Во-первых, вам необходимо настроить учетную запись электронной почты, которая будет использоваться для отправки уведомлений в сообщениях электронной почты, и назначить учетную запись для профиля электронной почты с именем `AzureManagedInstance_dbmail_profile`, как показано в следующем примере:

```sql
-- Create a Database Mail account
EXECUTE msdb.dbo.sysmail_add_account_sp
    @account_name = 'SQL Agent Account',
    @description = 'Mail account for Azure SQL Managed Instance SQL Agent system.',
    @email_address = '$(loginEmail)',
    @display_name = 'SQL Agent Account',
    @mailserver_name = '$(mailserver)' ,
    @username = '$(loginEmail)' ,  
    @password = '$(password)' 

-- Create a Database Mail profile
EXECUTE msdb.dbo.sysmail_add_profile_sp
    @profile_name = 'AzureManagedInstance_dbmail_profile',
    @description = 'E-mail profile used for messages sent by Managed Instance SQL Agent.' ;

-- Add the account to the profile
EXECUTE msdb.dbo.sysmail_add_profileaccount_sp
    @profile_name = 'AzureManagedInstance_dbmail_profile',
    @account_name = 'SQL Agent Account',
    @sequence_number = 1;
```

Вам также необходимо включить функцию Database Mail в Управляемом экземпляре:

```sql
GO
EXEC sp_configure 'show advanced options', 1;  
GO  
RECONFIGURE;  
GO  
EXEC sp_configure 'Database Mail XPs', 1;  
GO  
RECONFIGURE 
```

Вы можете уведомить оператора, что с вашим заданием агента SQL что-то произошло. Оператор определяет контактные сведения о лице, ответственном за обслуживание одного или нескольких Управляемых экземпляров. Иногда обязанности оператора возлагаются на одно лицо.
В системах с несколькими Управляемыми экземплярами или серверами SQL Server обязанности оператора могут разделяться между несколькими лицами. Оператор не содержит сведений о безопасности и не определяет субъект безопасности.

Создать операторы можно с помощью SQL Server Management Studio или сценария Transact-SQL, показанного в следующем примере:

```sql
EXEC msdb.dbo.sp_add_operator 
    @name=N'Mihajlo Pupun', 
        @enabled=1, 
        @email_address=N'mihajlo.pupin@contoso.com'
```

Вы можете изменить любые задания и назначить оператор, который будет получать сообщения по электронной почте после завершения, сбоя или успешного завершения задания, с помощью SQL Server Management Studio или следующего сценария Transact-SQL:

```sql
EXEC msdb.dbo.sp_update_job @job_name=N'Load data using SSIS', 
        @notify_level_email=3,                        -- Options are: 1 on succeed, 2 on failure, 3 on complete
        @notify_email_operator_name=N'Mihajlo Pupun'
```

### <a name="sql-agent-job-limitations"></a>Ограничения задания агента SQL

Некоторые функции агента SQL Server, доступные в SQL Server, не поддерживаются в Управляемом экземпляре:
- Параметры агента SQL Server доступны только для чтения. Процедура `sp_set_agent_properties` не поддерживается в Управляемом экземпляре.
- Сейчас в Управляемом экземпляре не поддерживается включение или отключение агента. Агент SQL работает постоянно.
- Уведомления поддерживаются частично.
  - Пейджер не поддерживается.
  - NetSend не поддерживается.
  - Оповещения еще не поддерживаются.
- Прокси-серверы не поддерживаются.
- Eventlog не поддерживается.

Сведения об агенте SQL Server см. в статье [Агент SQL Server](https://docs.microsoft.com/sql/ssms/agent/sql-server-agent).

## <a name="elastic-database-jobs"></a>Задания обработки эластичных баз данных

**Задания эластичных баз данных** позволяют одновременно запускать один или несколько скриптов T-SQL в большом количестве баз данных по расписанию или по требованию.

**Запускайте задания в любой комбинации баз данных**: одной или нескольких отдельных базах данных, всех базах данных на сервере, всех базах данных в эластичном пуле или в shardmap с дополнительной гибкостью, позволяющей включить или исключить любую конкретную базу данных. **Задания могут выполняться на нескольких серверах, в нескольких пулах и даже в базах данных в разных подписках.** Серверы и пулы динамически перечисляются во время выполнения, поэтому задания выполняются во всех базах данных, имеющихся в целевой группе на момент выполнения.

На следующем изображении показан агент задания, выполняющий задания в разных типах целевых групп:

![Концептуальная модель агента заданий обработки эластичных баз данных](media/elastic-jobs-overview/conceptual-diagram.png)

### <a name="elastic-job-components"></a>Компоненты заданий обработки эластичных баз данных

|Компонент  | Описание (дополнительные сведения приведены после таблицы) |
|---------|---------|
|[**Агент заданий обработки эластичных баз данных**](#elastic-job-agent) |  Ресурс Azure, созданный для выполнения заданий и управления ими.   |
|[**База данных заданий**](#job-database)    |    База данных SQL Azure, которую агент заданий использует для хранения данных, связанных с заданиями, определений заданий и т. д.      |
|[**Целевая группа**](#target-group)      |  Набор серверов, пулов, баз данных и карт сегментов, в которых требуется выполнить задания.       |
|[**Задание**](#job)  |  Задание — это единица работы, состоящая из одного или нескольких [шагов](#job-step). Шаги задания указывают скрипт T-SQL для запуска, а также другие сведения, необходимые для выполнения скрипта.  |


#### <a name="elastic-job-agent"></a>Агент заданий обработки эластичных баз данных

Агент заданий обработки эластичных баз данных является ресурсом Azure для создания, запуска заданий и управления ими. Агент заданий обработки эластичных баз данных — это ресурс Azure, который вы создаете на портале ([PowerShell](elastic-jobs-powershell.md) и REST также поддерживаются). 

Для создания **агента заданий обработки эластичных баз данных** требуется наличие базы данных SQL. Агент настраивает эту существующую базу данных в качестве [*базы данных заданий*](#job-database).

Агент заданий обработки эластичных баз данных является бесплатным. Счета за использование базы данных заданий выставляются ​​так же, как и за использование любой базы данных SQL.

#### <a name="job-database"></a>База данных заданий

*База данных заданий* используется для определения заданий, а также отслеживания состояния и истории их выполнения. *База данных заданий* также используется для хранения метаданных агента, журналов, результатов, определений заданий, а также содержит множество полезных хранимых процедур и других объектов базы данных для создания, запуска заданий и управления ими с использованием T-SQL.

В текущей предварительной версии для создания агента заданий обработки эластичных баз данных требуется существующая база данных Azure SQL (S0 или выше).

*База данных заданий* не обязательно должна быть новой, но должна быть чистой, пустой и иметь уровень обслуживания S0 или выше. Рекомендуемый уровень служб для *базы данных заданий* — это S1 или выше, но на самом деле он зависит от уровня производительности, требуемого для заданий: количества шагов в задании и частоты выполнения заданий. Например, база данных S0 может быть достаточной для того, чтобы агент заданий выполнял несколько заданий в час, но запуск заданий каждую минуту может быть недостаточно эффективным, и лучше использовать более высокий уровень служб.


##### <a name="job-database-permissions"></a>Разрешения базы данных заданий

Во время создания агента заданий в *базе данных заданий* создаются схема, таблицы и роль *jobs_reader*. Роль создается со следующим разрешением и предназначена для предоставления администраторам более тонкого контроля доступа для мониторинга заданий:


|Имя роли  |Разрешения схемы jobs  |Разрешения схемы jobs_internal  |
|---------|---------|---------|
|**jobs_reader**     |    SELECT     |    Нет     |

> [!IMPORTANT]
> Рассмотрите возможные последствия с точки зрения безопасности перед тем, как предоставить доступ к *базе данных заданий* в качестве администратора базы данных. Злоумышленник с разрешениями на создание или редактирование заданий может создать или редактировать задание, которое использует сохраненные учетные данные для подключения к базе данных под контролем злоумышленника, что позволяет ему определять пароль учетных данных.



#### <a name="target-group"></a>Целевая группа

*Целевая группа* определяет набор баз данных, в которых будет выполняться шаг задания. Целевая группа может содержать любое количество следующих комбинаций:

- **Сервер Базы данных SQL** — если указан сервер, все базы данных, существующие на сервере во время выполнения задания, являются частью группы. Учетные данные главной базы данных должны быть предоставлены таким образом, чтобы группа могла быть перечислена и обновлена ​​до выполнения задания.
- **Эластичный пул** — если указан эластичный пул, все базы данных, находящиеся в нем во время выполнения задания, являются частью группы. Как и для сервера, учетные данные базы данных master должны быть предоставлены таким образом, чтобы группа могла быть обновлена ​​до выполнения задания.
- **Единственная база данных** — укажите одну или несколько отдельных баз данных, которые будут частью группы.
- **Shardmap** — базы данных shardmap.

> [!TIP]
> В момент выполнения задания *динамическое перечисление* повторно оценивает набор баз данных в целевых группах, включающих серверы или пулы. Динамическое перечисление гарантирует, что **задание выполняется во всех базах данных, существующих на сервере, или в пуле во время выполнения задания**. Повторная оценка списка баз данных во время выполнения особенно полезна для сценариев, в которых часто происходит изменение членства пула или сервера.

Пулы и отдельные базы данных могут быть указаны как включенные или исключенные из группы. Это позволяет создать целевую группу с любой комбинацией баз данных. Например, вы можете добавить сервер в целевую группу, но исключить конкретные базы данных в эластичном пуле (или исключить весь пул).

Целевая группа может содержать базы данных в нескольких подписках в разных регионах. Обратите внимание, что выполнение в разных регионах имеет более высокую задержку, чем выполнение в той же области.

В следующих примерах показано, как различные определения целевых групп динамически перечисляются в момент выполнения задания, чтобы определить, в каких базах данных будет запущено задание:

![Примеры целевых групп](media/elastic-jobs-overview/targetgroup-examples1.png)

В **примере 1** показана целевая группа, состоящая из списка отдельных баз данных. Когда шаг задания выполняется с использованием этой целевой группы, действие шага задания будет выполняться в каждой из этих баз данных.<br>
В **примере 2** показана целевая группа, которая содержит Azure SQL Server в качестве целевого объекта. Когда шаг задания выполняется с использованием этой целевой группы, осуществляется динамическое перечисление ресурсов сервера, чтобы определить список баз данных, которые в настоящее время находятся на нем. Действие шага задания будет выполнено в каждой из этих баз данных.<br>
В **примере 3** показана такая же целевая группа, как и в *примере 2*, но отдельная база данных специально исключена. Действие шага задания *не* будет выполнено в исключенной базе данных.<br>
В **примере 4** показана целевая группа, которая содержит эластичный пул в качестве целевого объекта. Как и в *примере 2*, во время выполнения задания осуществляется динамическое перечисление ресурсов пула, чтобы определить список баз данных в нем.
<br><br>


![Примеры целевых групп](media/elastic-jobs-overview/targetgroup-examples2.png)

В **примерах 5** и **6** показаны расширенные сценарии, в которых Azure SQL Server, эластичные пулы и базы данных могут быть объединены с использованием правил включения и исключения.<br>
В **примере 7** показано, что сегменты в карте сегментов также могут быть оценены во время выполнения задания.

#### <a name="job"></a>Задание

*Задание* — это единица работы, которая выполняется по расписанию или одноразово. Задание состоит из одного или нескольких *шагов*.

##### <a name="job-step"></a>Шаг задания

Каждый шаг задания определяет сценарий T-SQL для выполнения, одну или несколько целевых групп для запуска сценария T-SQL и учетные данные, которые агент заданий должен подключить к целевой базе данных. На каждом шаге задания настраиваются время ожидания и повторные политики, а также могут указываться выходные параметры.

#### <a name="job-output"></a>Выходные данные задания

Результаты выполнения шагов задания в каждой целевой базе данных подробно записываются, а выходные данные скрипта можно записать в указанную таблицу. Вы можете указать базу данных для сохранения любых данных, возвращаемых из задания.

#### <a name="job-history"></a>Журнал заданий

История выполнения задания хранится в *базе данных заданий*. Задание очистки системы очищает историю выполнения, которой больше 45 дней. Чтобы удалить историю, которой менее 45 дней, вызовите хранимую процедуру **​​sp_purge_history** в *базе данных заданий*.

### <a name="agent-performance-capacity-and-limitations"></a>Производительность, емкость и ограничения агента

В заданиях обработки эластичных баз данных используются минимальные вычислительные ресурсы при ожидании завершения длительных заданий.

В зависимости от размера целевой группы баз данных и требуемого времени выполнения задания (количество одновременных рабочих ролей) агенту требуется разные объемы вычислений и производительности *базы данных заданий* (чем больше целевых объектов и заданий, тем выше требуемый объем вычислений).

Эта предварительная версия ограничена 100 одновременными заданиями.

#### <a name="prevent-jobs-from-reducing-target-database-performance"></a>Предотвращение сокращения производительности заданий целевой базы данных

Чтобы ресурсы не перегружались при работе с базами данных в эластичном пуле SQL, задания можно настроить для ограничения количества баз данных, в которых может одновременно работать задание.

## <a name="next-steps"></a>Дополнительная информация

- [Агент SQL Server](https://docs.microsoft.com/sql/ssms/agent/sql-server-agent) 
- [Управление группами баз данных с помощью заданий эластичных баз данных](elastic-jobs-overview.md) 
- [Создание заданий обработки эластичных баз данных и управление ими с помощью PowerShell](elastic-jobs-powershell.md) 
- [Use Transact-SQL (T-SQL) to create and manage Elastic Database Jobs](elastic-jobs-tsql.md) (Создание заданий обработки эластичных БД и управление ими с использованием Transact-SQL (T-SQL)) 
